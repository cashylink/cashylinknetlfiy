import{aQ as $s,u as qs,m as zs,r as a,a6 as z,j as e,ah as j,ai as f,aj as g,ak as y,B as c,aV as N,y as h,I as u,ay as ms,W as xs,t as ke,a1 as Ys,$ as _s,af as Te,D as Gs,s as Ks,E as Js}from"./index-CgV0sHeM.js";import{S as Qs,a as Xs,b as Zs,c as et,d as oe}from"./select-Cjxh7T8L.js";import{C as st,V as tt}from"./VideoModal-3NrJTmLh.js";import{getLastTransactions as at}from"./functions-VHUwf-oY.js";const jt=({open:R,onOpenChange:Y})=>{var ns,cs,ds;const{shiftUser:i,isShiftActive:_,shiftStartAt:M,setShiftUser:P,startShift:Fe,endShift:Ae}=$s(),{userSubscription:D,user:l,signIn:lt,profile:rt,checkSubscriptionStatus:me}=qs(),{toast:b}=zs(),[U,Oe]=a.useState((i==null?void 0:i.name)||""),[L,We]=a.useState((i==null?void 0:i.username)||""),[V,Ie]=a.useState(""),[xe,G]=a.useState(!1),[k,K]=a.useState(null),[Ee,Be]=a.useState(""),[Re,J]=a.useState(""),[it,nt]=a.useState(!1),[C,he]=a.useState(null),[Me,ue]=a.useState(""),[Pe,H]=a.useState(""),[Ue,O]=a.useState(!1),[Q,X]=a.useState(!1),[Le,Z]=a.useState({totalTransfers:0,totalWithdrawals:0}),[ee,se]=a.useState(null),[Ve,ve]=a.useState(""),[W,He]=a.useState(""),[I,$e]=a.useState(0),[hs,ct]=a.useState({}),[E,us]=a.useState(0),[$,vs]=a.useState(0),[ps,dt]=a.useState({}),[pe,qe]=a.useState(""),[js,je]=a.useState(!1),[fs,ze]=a.useState(!1),[gs,ys]=a.useState(""),[Ns,bs]=a.useState(""),ws=(s,t)=>{ys(s),bs(t),ze(!0)};a.useEffect(()=>{R&&me&&me(!0)},[R,me]);const te=s=>{const t={"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9","۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9","٫":".","،":".","٬":"."," ":""};return s.split("").map(n=>t[n]??n).join("")},fe=()=>`cashierUsers_${(l==null?void 0:l.uid)||"default"}`,[w,B]=a.useState(()=>{try{let s=localStorage.getItem(fe());if(!s){const t=localStorage.getItem("cashierUsers");t&&(s=t)}return s?JSON.parse(s):[]}catch{return[]}}),[Ye,Ss]=a.useState(!1);a.useEffect(()=>{if(!(l!=null&&l.uid))return;(async()=>{let t=!1;try{const n=xs(ke,"profiles",l.uid,"cashierUsers","list"),d=await Ys(n);if(d.exists()){const v=d.data(),S=Array.isArray(v==null?void 0:v.users)?v.users:[];S.length>0&&(B(S),t=!0)}}catch(n){console.warn("Failed to fetch cashierUsers from Firestore:",n)}if(!t)try{const n=localStorage.getItem(fe()),d=n?JSON.parse(n):[];d.length>0?B(d):w.length>0&&B([])}catch{}Ss(!0)})()},[l==null?void 0:l.uid]);const ae=(ns=D==null?void 0:D.subscription)==null?void 0:ns.planType,_e=((cs=D==null?void 0:D.subscription)==null?void 0:cs.extraCashiers)||0,le=(ds=D==null?void 0:D.subscription)==null?void 0:ds.extraCashiersEndsAt;let Ge=!1;_e>0&&le&&(le.seconds?new Date(le.seconds*1e3):new Date(le))>new Date&&(Ge=!0);const F=(ae==="quarterly"||ae==="half_yearly"||ae==="yearly"||ae==="lifetime"?2:1)+(Ge?_e:0);a.useEffect(()=>{try{localStorage.setItem(fe(),JSON.stringify(w));try{localStorage.removeItem("cashierUsers")}catch{}}catch{}(async()=>{try{if(!(l!=null&&l.uid)||w.length===0&&!Ye)return;const t=xs(ke,"profiles",l.uid,"cashierUsers","list");await _s(t,{users:w},{merge:!0})}catch(t){console.warn("Failed to save cashierUsers to Cloud:",t)}})()},[w,Ye,l==null?void 0:l.uid]);const[Cs,re]=a.useState(!1),[Ke,ge]=a.useState(""),[T,Je]=a.useState(null),[Qe,ye]=a.useState([]),[Ne,be]=a.useState(!1),[m,Ds]=a.useState(null),[ks,we]=a.useState(!1),[Ts,q]=a.useState(!1),[Fs,ie]=a.useState(!1),[As,ne]=a.useState(!1),[Xe,Os]=a.useState("1"),[Ze,Ws]=a.useState(z.MONTHLY),Is=async()=>{if(l!=null&&l.uid)try{await Gs(Ks(ke,"cashierRequests"),{userId:l.uid,userName:l.displayName||l.email,userEmail:l.email,requestedCount:parseInt(Xe),planType:Ze,status:"pending",createdAt:Js()}),b({title:"تم إرسال الطلب بنجاح",description:"سيتم مراجعة طلبك من قبل الإدارة"}),ne(!1)}catch(s){console.error(s),b({title:"خطأ",description:"حدث خطأ أثناء إرسال الطلب",variant:"destructive"})}},[Es,Se]=a.useState(!1),[x,Ce]=a.useState(null),[Bs,ce]=a.useState(!1),[es,ss]=a.useState(""),[ts,de]=a.useState(""),Rs=s=>{Ce(s),ce(!0),ss(""),de("")},as=async()=>{if(!(l!=null&&l.uid)){de("خطأ في معرف المستخدم");return}try{if(!await ms.verifyMasterPin(es,l.uid)){de("الرقم السري الرئيسي غير صحيح");return}ce(!1),Se(!0)}catch{de("حدث خطأ أثناء التحقق")}},Ms=s=>{x&&(B(t=>t.map(n=>n.username===x.username?{...n,permissions:s}:n)),(i==null?void 0:i.username)===x.username&&P({...i,permissions:s}),Se(!1),Ce(null),b({title:"تم تحديث الصلاحيات بنجاح"}))},Ps=()=>{w.length>=F?ie(!0):q(!0)},Us=s=>{const t=(i==null?void 0:i.username)===s;let n=!1;try{n=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(t&&!(t&&!_&&(pe==="الأدمن الرئيسي"||n))){b({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const S=`هل أنت متأكد من حذف المستخدم ${s}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(S)&&(B(p=>p.filter(De=>De.username!==s)),t&&P(null),b({title:"تم حذف المستخدم",description:s}))},ls=()=>{if(!U.trim()||!L.trim()||!V.trim())return;if(w.length>=F){b({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(F)?F:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const s={name:U.trim(),username:L.trim(),password:V.trim()};B(t=>[s,...t]),Oe(""),We(""),Ie("")},Ls=()=>{G(!0),K(null),he(null),ue(""),H("")},rs=async()=>{try{let s=[];try{l!=null&&l.uid&&(s=await Te.getUserTransactions(l.uid))}catch{}if(!s||s.length===0)try{const r=await at({merchantUserId:l==null?void 0:l.uid,limit:200});s=(r==null?void 0:r.transactions)||[]}catch{}const t=M?new Date(M):null,n=new Date,d=r=>{const o=r.type,A=r.txnType;return o==="withdraw"||o==="withdrawal"||o==="receive"||A==="receive"},v=r=>{const o=r.type,A=r.txnType;return o==="send"||o==="transfer"||A==="send"},S=r=>{if(!r)return null;if(r instanceof Date)return r;try{const o=new Date(r);return Number.isNaN(o.getTime())?null:o}catch{return null}},p=r=>{const o=S(r.createdAt||r.created_at||r.timestamp);return!o||t&&o<t?!1:o<=n},De=r=>r==="completed"||r==="confirmed",os=s.filter(r=>De(r.status)&&p(r)),Hs=os.filter(r=>d(r)).reduce((r,o)=>{const A=o.withdrawnAmount??o.receivedAmount??o.amount??0;return r+(Number(A)||0)},0);return{totalTransfers:os.filter(r=>v(r)).reduce((r,o)=>{const A=o.sentAmount??o.transferredAmount??o.amount??0;return r+(Number(A)||0)},0),totalWithdrawals:Hs}}catch{return{totalTransfers:0,totalWithdrawals:0}}};a.useEffect(()=>{if(Q){try{const s=localStorage.getItem("shiftInitialReceivedDrawerFunds");s!==null&&He(s)}catch{}try{const s=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(s!==null){const t=parseFloat(s);$e(Number.isFinite(t)?t:0)}}catch{}}},[Q]),a.useEffect(()=>{xe&&(async()=>{try{const s=await rs();Z(s)}catch{}})()},[xe]),a.useEffect(()=>{if(!R&&!Ne)return;(async()=>{try{const n=((l!=null&&l.uid?await Te.getUserTransactions(l.uid):[])||[]).filter(d=>(d==null?void 0:d.type)==="report"||((d==null?void 0:d.title)||"").includes("إيصال تسليم وردية"));n.sort((d,v)=>{const S=new Date(d.createdAt||0).getTime();return new Date(v.createdAt||0).getTime()-S}),ye(n)}catch{ye([])}})()},[R,Q,Ne,l==null?void 0:l.uid]);const Vs=async(s,t,n)=>{try{let d=0,v=0;try{const p=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");d=Number.isFinite(p)?p:0}catch{}try{const p=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");v=Number.isFinite(p)?p:0}catch{}const S={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(i==null?void 0:i.username)||"cashier",receiverPhone:pe||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(i==null?void 0:i.name)||(i==null?void 0:i.username)||null,deficit:t,deficitAmount:t?n:0,shiftStartAt:M,receivedDrawerFunds:d,receivedWalletBalancesTotal:v,receivedWalletBalances:hs,deliveredDrawerFunds:E||0,deliveredWalletBalancesTotal:$||0,deliveredWalletBalances:ps,shiftProfit:Math.round(((E||0)+($||0)-(d+v))*100)/100};l!=null&&l.uid&&await Te.saveUserTransaction(l.uid,S),ye(p=>[S,...p||[]])}catch{}},is=w.slice(Math.max(0,w.length-F));return e.jsxs(e.Fragment,{children:[e.jsx(j,{open:R,onOpenChange:Y,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(y,{children:_?"تسليم الورديه والخروج":"إضافة مستخدم وردية"}),e.jsxs(c,{variant:"outline",size:"sm",onClick:()=>ws("https://www.youtube.com/watch?v=1SwXIN-xBeo","شرح الوردية (فيديو)"),className:"h-7 text-[10px] px-2 text-rose-600 border-rose-200 hover:bg-rose-50 dark:border-rose-900/30 dark:text-rose-400 dark:hover:bg-rose-900/20",children:[e.jsx(st,{className:"h-3 w-3 ml-1.5"}),"شرح الوردية (فيديو)"]})]})}),_?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[i==null?void 0:i.name," (",i==null?void 0:i.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),w.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:is.map((s,t)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:s.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(c,{size:"sm",className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>{Je(s),re(!0)},children:"دخول"}),e.jsx(c,{size:"sm",className:"w-full sm:w-auto",variant:"outline",onClick:()=>Rs(s),children:"الصلاحيات"}),e.jsx(c,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>Us(s.username),children:"حذف"})]})]},t))})]})]}),e.jsx(N,{className:"flex flex-wrap gap-2 justify-between",children:_?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(c,{className:"w-full sm:w-auto",variant:"destructive",onClick:Ls,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(c,{className:"w-full sm:w-auto bg-emerald-600 hover:bg-emerald-700 text-white",onClick:Ps,children:"إضافة مستخدم جديد"}),e.jsx(c,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>be(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(j,{open:Fs,onOpenChange:ie,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsxs(y,{className:"text-red-600 flex items-center gap-2",children:[e.jsx("span",{className:"text-xl",children:"⚠️"})," تنبيه: الحد الأقصى للمستخدمين"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("p",{className:"text-sm text-gray-700 leading-relaxed",children:["عفواً، لا يمكنك إضافة المزيد من مستخدمي الوردية. ",e.jsx("br",{}),"الحد المسموح به لباقة اشتراكك هو ",e.jsx("strong",{children:F})," ",F===1?"مستخدم":"مستخدمين","."]}),e.jsx("p",{className:"text-sm text-gray-600",children:"لزيادة عدد المستخدمين، يرجى التواصل مع خدمة العملاء لترقية الباقة أو طلب زيادة العدد."})]}),e.jsxs(N,{className:"flex flex-col sm:flex-row gap-2 justify-end",children:[e.jsx(c,{className:"w-full sm:w-auto",onClick:()=>ie(!1),variant:"secondary",children:"حسناً، فهمت"}),e.jsx(c,{className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>{ie(!1),ne(!0)},children:"طلب إضافة كاشير"})]})]})}),e.jsx(j,{open:As,onOpenChange:ne,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:"طلب زيادة عدد الكاشير"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"يمكنك طلب زيادة عدد الكاشير المسموح به. سيتم مراجعة الطلب من قبل الإدارة."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"عدد الكاشير المطلوب إضافتهم"}),e.jsx(u,{type:"number",min:"1",max:"10",value:Xe,onChange:s=>Os(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"نظام الاشتراك للكاشير الإضافي"}),e.jsxs(Qs,{value:Ze,onValueChange:s=>Ws(s),children:[e.jsx(Xs,{children:e.jsx(Zs,{placeholder:"اختر الباقة"})}),e.jsxs(et,{children:[e.jsx(oe,{value:z.MONTHLY,children:"شهري"}),e.jsx(oe,{value:z.QUARTERLY,children:"ربع سنوي"}),e.jsx(oe,{value:z.YEARLY,children:"سنوي"}),e.jsx(oe,{value:z.LIFETIME,children:"مدى الحياة"})]})]})]})]}),e.jsxs(N,{children:[e.jsx(c,{variant:"secondary",onClick:()=>ne(!1),children:"إلغاء"}),e.jsx(c,{className:"bg-blue-600 hover:bg-blue-700 text-white",onClick:Is,children:"إرسال الطلب"})]})]})}),e.jsx(j,{open:Ts,onOpenChange:q,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(h,{className:"mb-1 block",children:"الاسم"}),e.jsx(u,{value:U,onChange:s=>Oe(s.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(h,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(u,{value:L,onChange:s=>We(s.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(h,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(u,{type:"password",autoComplete:"new-password",value:V,onChange:s=>Ie(s.target.value),onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),U.trim()&&L.trim()&&V.trim()&&(ls(),q(!1)))},placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(N,{className:"flex gap-2 justify-between",children:[e.jsx(c,{variant:"secondary",onClick:()=>{q(!1)},children:"إلغاء"}),e.jsx(c,{onClick:()=>{!U.trim()||!L.trim()||!V.trim()||(ls(),q(!1))},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"حفظ المستخدم"})]})]})}),e.jsx(j,{open:Bs,onOpenChange:ce,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:"تأكيد هوية المدير"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"يرجى إدخال الرقم السري الرئيسي (كلمة مرور حسابك) لفتح إعدادات الصلاحيات."}),e.jsxs("div",{children:[e.jsx(h,{className:"mb-1 block",children:"كلمة المرور"}),e.jsx(u,{type:"password",value:es,onChange:s=>ss(s.target.value),onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),as())},placeholder:"أدخل كلمة المرور"}),ts&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:ts})]})]}),e.jsxs(N,{children:[e.jsx(c,{variant:"outline",onClick:()=>ce(!1),children:"إلغاء"}),e.jsx(c,{onClick:as,className:"bg-blue-600 hover:bg-blue-700 text-white",children:"تأكيد"})]})]})}),e.jsx(j,{open:Es,onOpenChange:Se,children:e.jsxs(f,{className:"sm:max-w-lg max-h-[90vh] overflow-y-auto",children:[e.jsx(g,{children:e.jsxs(y,{children:["صلاحيات المستخدم: ",x==null?void 0:x.name]})}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 py-4",children:[{key:"sales",label:"المبيعات"},{key:"debts",label:"الديون"},{key:"deficiencies",label:"النواقص"},{key:"cards",label:"البطاقات"},{key:"lines",label:"الخطوط"},{key:"myNumbers",label:"أرقامي"},{key:"installments",label:"تقسيط"},{key:"maintenance",label:"صيانة"},{key:"machines",label:"المكنة"},{key:"expenses",label:"المصروفات"},{key:"settings",label:"الإعدادات"},{key:"branches",label:"الفروع"},{key:"transfers",label:"التحويل"},{key:"withdrawals",label:"السحب"}].map(s=>{var n;const t=((n=x==null?void 0:x.permissions)==null?void 0:n[s.key])!==!1;return e.jsxs("div",{className:"flex items-center justify-between border p-3 rounded bg-gray-50 dark:bg-gray-800",children:[e.jsx(h,{htmlFor:`perm-${s.key}`,className:"cursor-pointer font-medium",children:s.label}),e.jsx(c,{id:`perm-${s.key}`,size:"sm",onClick:()=>{x&&Ce({...x,permissions:{...x.permissions,[s.key]:!t}})},className:`w-24 font-bold text-white transition-colors ${t?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:t?"مفعل":"معطل"})]},s.key)})}),e.jsx(N,{children:e.jsx(c,{onClick:()=>Ms(x==null?void 0:x.permissions),className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",children:"حفظ الصلاحيات"})})]})}),e.jsx(j,{open:Ne,onOpenChange:be,children:e.jsxs(f,{className:"sm:max-w-lg",children:[e.jsx(g,{children:e.jsx(y,{children:"إيصالات التسليم"})}),Qe.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:Qe.map(s=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{Ds(s),we(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(s.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",s.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",s.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",s.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",s.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",s.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",s.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",s.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",s.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",s.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(s.shiftProfit??(s.deliveredDrawerFunds??0)+(s.deliveredWalletBalancesTotal??0)-(s.receivedDrawerFunds??0)-(s.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",s.shiftProfit??(s.deliveredDrawerFunds??0)+(s.deliveredWalletBalancesTotal??0)-(s.receivedDrawerFunds??0)-(s.receivedWalletBalancesTotal??0)]})]}),s.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",s.deficitAmount??0]})]},s.id))}),e.jsx(N,{className:"flex gap-2 justify-between",children:e.jsx(c,{variant:"secondary",onClick:()=>be(!1),children:"إغلاق"})})]})}),e.jsx(j,{open:ks,onOpenChange:we,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:"إيصال تسليم وردية"})}),m?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(m.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",m.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",(m.receivedDrawerFunds??0).toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",(m.receivedWalletBalancesTotal??0).toLocaleString("en-US",{maximumFractionDigits:0})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",(m.deliveredDrawerFunds??0).toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",(m.deliveredWalletBalancesTotal??0).toLocaleString("en-US",{maximumFractionDigits:0})]})]})]}),m.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",(m.deficitAmount??0).toLocaleString("en-US",{maximumFractionDigits:0})]})]}),m.receivedWalletBalances&&Object.keys(m.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(m.receivedWalletBalances).map(([s,t])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:s}),e.jsx("span",{className:"font-semibold",children:t.toLocaleString("en-US",{maximumFractionDigits:0})})]},s))})]}),m.deliveredWalletBalances&&Object.keys(m.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(m.deliveredWalletBalances).map(([s,t])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:s}),e.jsx("span",{className:"font-semibold",children:t})]},s))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(N,{className:"flex gap-2 justify-between",children:e.jsx(c,{variant:"secondary",onClick:()=>we(!1),children:"إغلاق"})})]})}),e.jsx(j,{open:Cs,onOpenChange:re,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:T?`${T.name} (${T.username})`:""}),e.jsx(u,{type:"password",autoComplete:"off",value:Ke,onChange:s=>ge(s.target.value),onKeyDown:s=>{var t;s.key==="Enter"&&(s.preventDefault(),(t=document.getElementById("login-confirm-btn"))==null||t.click())},placeholder:"أدخل الرقم السري"})]}),e.jsxs(N,{className:"flex gap-2 justify-between",children:[e.jsx(c,{variant:"secondary",onClick:()=>{ge(""),Je(null),re(!1)},children:"إلغاء"}),e.jsx(c,{id:"login-confirm-btn",className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{if(T){if(Ke.trim()!==T.password){b({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}P({name:T.name,username:T.username,permissions:T.permissions}),ge(""),re(!1),Y(!1),Fe(),je(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(j,{open:js,onOpenChange:je,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(h,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(u,{type:"text",inputMode:"decimal",value:W,onChange:s=>He(te(s.target.value)),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(h,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(u,{type:"text",inputMode:"decimal",value:Number.isFinite(I)?I:0,onChange:s=>{const t=parseFloat(te(s.target.value));$e(Number.isFinite(t)?t:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(N,{className:"flex gap-2 justify-between",children:e.jsx(c,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{const s=parseFloat(W),t=I,n=Number.isFinite(s)&&s>=0,d=Number.isFinite(t)&&t>=0;if(!n||!d){b({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(s)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(t))}catch{}b({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),je(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(j,{open:xe,onOpenChange:s=>{s&&G(!0)},children:e.jsxs(f,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(g,{children:e.jsx(y,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{variant:k==="toUser"?"default":"secondary",onClick:()=>K("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(c,{variant:k==="toAdmin"?"default":"secondary",onClick:()=>K("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),k==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[w.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:is.map((s,t)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(C==null?void 0:C.username)===s.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>he(s),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:s.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},t))})]}),e.jsxs("div",{children:[e.jsx(h,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(u,{type:"password",autoComplete:"off",value:Me,onChange:s=>ue(s.target.value),placeholder:"أدخل كلمة السر"})]}),Pe&&e.jsx("div",{className:"text-xs text-red-600",children:Pe})]}),k==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(u,{type:"password",autoComplete:"off",value:Ee,onChange:s=>Be(s.target.value),placeholder:"كلمة المرور"}),Re&&e.jsx("div",{className:"text-xs text-red-600",children:Re})]})]}),e.jsx(N,{className:"flex gap-2 justify-between",children:e.jsx(c,{id:"handover-confirm-btn",disabled:Ue||!k,onClick:async()=>{if(k){O(!0);try{const s=Le;if(rs().then(Z).catch(()=>{}),k==="toUser"){if(!C){H("يرجى اختيار المستخدم أولاً"),O(!1);return}if(Me.trim()!==C.password){H("كلمة السر غير صحيحة"),O(!1);return}Ae(),P({name:C.name,username:C.username,permissions:C.permissions}),Fe(),qe(`${C.name} (${C.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}G(!1),K(null),he(null),ue(""),H(""),Y(!1),Z(s),se(null),ve(""),X(!0)}else if(k==="toAdmin"){if(J(""),!(l!=null&&l.uid)){J("خطأ في معرف المستخدم"),O(!1);return}if(!await ms.verifyMasterPin(Ee,l.uid)){J("الرقم السري الرئيسي غير صحيح"),O(!1);return}Ae(),P(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}Be(""),G(!1),Y(!1),qe("الأدمن الرئيسي"),Z(s),se(null),ve(""),X(!0)}}catch(s){console.error(s);const t="حدث خطأ أثناء التسليم، حاول مرة أخرى";k==="toAdmin"?J(t):H(t),b({title:"خطأ",description:t,variant:"destructive"})}finally{O(!1)}}},className:"bg-blue-600 hover:bg-blue-700 text-white",children:Ue?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري المعالجة..."]}):"تأكيد التسليم"})})]})}),e.jsx(j,{open:Q,onOpenChange:X,children:e.jsxs(f,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(g,{children:e.jsx(y,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:pe})]}),M&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(M).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(h,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(u,{type:"number",value:W,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(h,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(u,{type:"number",value:I,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(h,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(u,{type:"text",inputMode:"decimal",value:E,onChange:s=>{const t=parseFloat(te(s.target.value));us(Number.isFinite(t)?t:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(h,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(u,{type:"text",inputMode:"decimal",value:$,onChange:s=>{const t=parseFloat(te(s.target.value));vs(Number.isFinite(t)?t:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(E??0)+($??0)-((parseFloat(W||"0")||0)+(I??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((E??0)+($??0)-((parseFloat(W||"0")||0)+(I??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"}),e.jsx("div",{className:"mt-2 grid grid-cols-1 gap-2",children:e.jsxs("div",{className:"rounded border p-2 bg-gray-50",children:[e.jsx("div",{className:"text-xs text-gray-700",children:"مطلوب من الدرج (بدون أرباح)"}),e.jsx("div",{className:"text-sm font-semibold text-gray-900",children:Math.round(((E??0)-(parseFloat(W||"0")||0))*100)/100})]})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{variant:ee==="no"?"default":"secondary",onClick:()=>se("no"),children:"لا"}),e.jsx(c,{variant:ee==="yes"?"default":"secondary",onClick:()=>se("yes"),children:"نعم"})]}),ee==="yes"&&e.jsxs("div",{children:[e.jsx(h,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(u,{type:"number",value:Ve,onChange:s=>ve(s.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(N,{className:"flex gap-2 justify-between",children:e.jsx(c,{onClick:()=>{const s=ee==="yes",t=parseFloat(Ve)||0;(async()=>await Vs(Le,s,t))(),b({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),X(!1)},className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:"تأكيد وحفظ الإيصال"})})]})}),e.jsx(tt,{isOpen:fs,onClose:()=>ze(!1),videoUrl:gs,title:Ns})]})};export{jt as default};
//# sourceMappingURL=CashierShiftModal-DPV2__M_.js.map
