{"version":3,"file":"whatsappService-D7s14JCG.js","sources":["../../src/utils/whatsappService.ts"],"sourcesContent":["import { doc, getDoc, setDoc } from 'firebase/firestore';\nimport { db, auth } from '@/firebase';\n\n// نوع البيانات لإعدادات الواتساب\nexport interface WhatsAppSettings {\n  phoneNumber: string;\n  defaultMessage: string;\n  isEnabled: boolean;\n  lastUpdated: Date;\n}\n\n// الإعدادات الافتراضية\nconst DEFAULT_SETTINGS: WhatsAppSettings = {\n  phoneNumber: \"201000392539\",\n  defaultMessage: \"مرحباً، أريد الاستفسار عن خدماتكم\",\n  isEnabled: true,\n  lastUpdated: new Date()\n};\n\n// مرجع المستند في Firestore\nconst SETTINGS_DOC_ID = 'whatsapp-settings';\nconst SETTINGS_COLLECTION = 'app-settings';\nconst WHATSAPP_CACHE_KEY = 'whatsapp_settings_cache';\n\n/**\n * تحميل إعدادات الواتساب من Firestore\n */\nexport const loadWhatsAppSettings = async (): Promise<WhatsAppSettings> => {\n  try {\n    // إذا لم يكن المستخدم مسجلاً الدخول، تجنب قراءة Firestore العامة لتفادي أخطاء الصلاحيات\n    if (!auth.currentUser) {\n      try {\n        const cached = localStorage.getItem(WHATSAPP_CACHE_KEY);\n        if (cached) {\n          const parsed = JSON.parse(cached);\n          return {\n            phoneNumber: parsed.phoneNumber || DEFAULT_SETTINGS.phoneNumber,\n            defaultMessage: parsed.defaultMessage || DEFAULT_SETTINGS.defaultMessage,\n            isEnabled: parsed.isEnabled !== undefined ? parsed.isEnabled : DEFAULT_SETTINGS.isEnabled,\n            lastUpdated: parsed.lastUpdated ? new Date(parsed.lastUpdated) : DEFAULT_SETTINGS.lastUpdated\n          } as WhatsAppSettings;\n        }\n      } catch {}\n      // مستخدم عام بدون كاش: ارجع الإعدادات الافتراضية بصمت\n      return DEFAULT_SETTINGS;\n    }\n\n    const docRef = doc(db, SETTINGS_COLLECTION, SETTINGS_DOC_ID);\n    const docSnap = await getDoc(docRef);\n    \n    if (docSnap.exists()) {\n      const data = docSnap.data();\n      const settings: WhatsAppSettings = {\n        phoneNumber: data.phoneNumber || DEFAULT_SETTINGS.phoneNumber,\n        defaultMessage: data.defaultMessage || DEFAULT_SETTINGS.defaultMessage,\n        isEnabled: data.isEnabled !== undefined ? data.isEnabled : DEFAULT_SETTINGS.isEnabled,\n        lastUpdated: data.lastUpdated?.toDate() || DEFAULT_SETTINGS.lastUpdated\n      };\n      // خزن نسخة في التخزين المحلي لاستخدامها لزوار غير مسجلين\n      try { localStorage.setItem(WHATSAPP_CACHE_KEY, JSON.stringify(settings)); } catch {}\n      return settings;\n    } else {\n      // إذا لم توجد الإعدادات، احفظ الإعدادات الافتراضية\n      await saveWhatsAppSettings(DEFAULT_SETTINGS);\n      return DEFAULT_SETTINGS;\n    }\n  } catch (error) {\n    // في حال أخطاء الصلاحيات أو الشبكة، استخدم الكاش أو الافتراضي بدون إزعاج المستخدم العام\n    try {\n      const cached = localStorage.getItem(WHATSAPP_CACHE_KEY);\n      if (cached) {\n        const parsed = JSON.parse(cached);\n        return {\n          phoneNumber: parsed.phoneNumber || DEFAULT_SETTINGS.phoneNumber,\n          defaultMessage: parsed.defaultMessage || DEFAULT_SETTINGS.defaultMessage,\n          isEnabled: parsed.isEnabled !== undefined ? parsed.isEnabled : DEFAULT_SETTINGS.isEnabled,\n          lastUpdated: parsed.lastUpdated ? new Date(parsed.lastUpdated) : DEFAULT_SETTINGS.lastUpdated\n        } as WhatsAppSettings;\n      }\n    } catch {}\n    return DEFAULT_SETTINGS;\n  }\n};\n\n/**\n * حفظ إعدادات الواتساب في Firestore\n */\nexport const saveWhatsAppSettings = async (settings: Partial<WhatsAppSettings>): Promise<boolean> => {\n  try {\n    const docRef = doc(db, SETTINGS_COLLECTION, SETTINGS_DOC_ID);\n    \n    // تحديث الإعدادات مع الاحتفاظ بالقيم الموجودة\n    const updatedSettings = {\n      ...settings,\n      lastUpdated: new Date()\n    };\n    \n    await setDoc(docRef, updatedSettings, { merge: true });\n    // حدث الكاش المحلي بعد نجاح الحفظ\n    try { localStorage.setItem(WHATSAPP_CACHE_KEY, JSON.stringify(updatedSettings)); } catch {}\n    return true;\n  } catch (error) {\n    console.error('خطأ في حفظ إعدادات الواتساب:', error);\n    return false;\n  }\n};\n\n/**\n * تنسيق رقم الواتساب (إزالة الرموز غير المرغوب فيها)\n */\nexport const formatPhoneNumber = (phoneNumber: string): string => {\n  // إزالة جميع الرموز غير الرقمية\n  const cleanNumber = phoneNumber.replace(/\\D/g, '');\n  \n  // التأكد من وجود رقم صحيح\n  if (cleanNumber.length < 10) {\n    throw new Error('رقم الهاتف يجب أن يحتوي على 10 أرقام على الأقل');\n  }\n  \n  return cleanNumber;\n};\n\n/**\n * التحقق من صحة رقم الواتساب\n */\nexport const validatePhoneNumber = (phoneNumber: string): boolean => {\n  try {\n    const formatted = formatPhoneNumber(phoneNumber);\n    return formatted.length >= 10 && formatted.length <= 15;\n  } catch {\n    return false;\n  }\n};\n\n/**\n * إنشاء رابط الواتساب\n */\nexport const createWhatsAppLink = (phoneNumber: string, message: string): string => {\n  const formattedNumber = formatPhoneNumber(phoneNumber);\n  const encodedMessage = encodeURIComponent(message);\n  return `https://wa.me/${formattedNumber}?text=${encodedMessage}`;\n};\n\n/**\n * إنشاء رابط واتساب للاشتراك في باقة معينة\n */\nexport const createSubscriptionWhatsAppLink = async (\n  planName: string, \n  price: string, \n  features: string[]\n): Promise<string> => {\n  const settings = await loadWhatsAppSettings();\n  \n  const message = `مرحباً! أريد الاشتراك في باقة ${planName} بسعر ${price}\n\nالمميزات المشمولة:\n${features.map(feature => `✅ ${feature}`).join('\\n')}\n\nأرجو التواصل معي لإتمام عملية الاشتراك.`;\n\n  return createWhatsAppLink(settings.phoneNumber, message);\n};\n\n/**\n * إنشاء رابط واتساب للاستفسار العام\n */\nexport const createGeneralWhatsAppLink = async (): Promise<string> => {\n  const settings = await loadWhatsAppSettings();\n  \n  const message = `مرحباً! أريد الاستفسار عن خدمات CashyLink لإدارة المحافظ الإلكترونية.\n\nأرجو التواصل معي لمعرفة المزيد عن الباقات المتاحة وكيفية البدء.`;\n\n  return createWhatsAppLink(settings.phoneNumber, message);\n};\n\n// Hook لاستخدام إعدادات الواتساب في React\nexport const useWhatsAppSettings = () => {\n  const [settings, setSettings] = React.useState<WhatsAppSettings | null>(null);\n  const [loading, setLoading] = React.useState(true);\n  const [error, setError] = React.useState<string | null>(null);\n\n  React.useEffect(() => {\n    const loadSettings = async () => {\n      try {\n        setLoading(true);\n        const loadedSettings = await loadWhatsAppSettings();\n        setSettings(loadedSettings);\n        setError(null);\n      } catch (err) {\n        setError('فشل في تحميل إعدادات الواتساب');\n        console.error(err);\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    loadSettings();\n  }, []);\n\n  const updateSettings = async (newSettings: Partial<WhatsAppSettings>) => {\n    try {\n      setLoading(true);\n      const success = await saveWhatsAppSettings(newSettings);\n      if (success && settings) {\n        setSettings({ ...settings, ...newSettings, lastUpdated: new Date() });\n        setError(null);\n        return true;\n      } else {\n        setError('فشل في حفظ الإعدادات');\n        return false;\n      }\n    } catch (err) {\n      setError('خطأ في تحديث الإعدادات');\n      console.error(err);\n      return false;\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return {\n    settings,\n    loading,\n    error,\n    updateSettings,\n    refreshSettings: () => loadWhatsAppSettings().then(setSettings)\n  };\n};\n\n// إضافة import React في أعلى الملف\nimport React from 'react';"],"names":["DEFAULT_SETTINGS","SETTINGS_DOC_ID","SETTINGS_COLLECTION","WHATSAPP_CACHE_KEY","loadWhatsAppSettings","auth","cached","parsed","docRef","doc","db","docSnap","getDoc","data","settings","_a","saveWhatsAppSettings","updatedSettings","setDoc","error","formatPhoneNumber","phoneNumber","cleanNumber","validatePhoneNumber","formatted","createWhatsAppLink","message","formattedNumber","encodedMessage","useWhatsAppSettings","setSettings","React","loading","setLoading","setError","loadedSettings","err","newSettings"],"mappings":"2EAYA,MAAMA,EAAqC,CACzC,YAAa,eACb,eAAgB,oCAChB,UAAW,GACX,gBAAiB,IACnB,EAGMC,EAAkB,oBAClBC,EAAsB,eACtBC,EAAqB,0BAKdC,EAAuB,SAAuC,OACzE,GAAI,CAEF,GAAI,CAACC,EAAK,YAAa,CACrB,GAAI,CACF,MAAMC,EAAS,aAAa,QAAQH,CAAkB,EACtD,GAAIG,EAAQ,CACV,MAAMC,EAAS,KAAK,MAAMD,CAAM,EAChC,MAAO,CACL,YAAaC,EAAO,aAAeP,EAAiB,YACpD,eAAgBO,EAAO,gBAAkBP,EAAiB,eAC1D,UAAWO,EAAO,YAAc,OAAYA,EAAO,UAAYP,EAAiB,UAChF,YAAaO,EAAO,YAAc,IAAI,KAAKA,EAAO,WAAW,EAAIP,EAAiB,WAAA,CAEtF,CACF,MAAQ,CAAC,CAET,OAAOA,CACT,CAEA,MAAMQ,EAASC,EAAIC,EAAIR,EAAqBD,CAAe,EACrDU,EAAU,MAAMC,EAAOJ,CAAM,EAEnC,GAAIG,EAAQ,SAAU,CACpB,MAAME,EAAOF,EAAQ,KAAA,EACfG,EAA6B,CACjC,YAAaD,EAAK,aAAeb,EAAiB,YAClD,eAAgBa,EAAK,gBAAkBb,EAAiB,eACxD,UAAWa,EAAK,YAAc,OAAYA,EAAK,UAAYb,EAAiB,UAC5E,cAAae,EAAAF,EAAK,cAAL,YAAAE,EAAkB,WAAYf,EAAiB,WAAA,EAG9D,GAAI,CAAE,aAAa,QAAQG,EAAoB,KAAK,UAAUW,CAAQ,CAAC,CAAG,MAAQ,CAAC,CACnF,OAAOA,CACT,KAEE,cAAME,EAAqBhB,CAAgB,EACpCA,CAEX,MAAgB,CAEd,GAAI,CACF,MAAMM,EAAS,aAAa,QAAQH,CAAkB,EACtD,GAAIG,EAAQ,CACV,MAAMC,EAAS,KAAK,MAAMD,CAAM,EAChC,MAAO,CACL,YAAaC,EAAO,aAAeP,EAAiB,YACpD,eAAgBO,EAAO,gBAAkBP,EAAiB,eAC1D,UAAWO,EAAO,YAAc,OAAYA,EAAO,UAAYP,EAAiB,UAChF,YAAaO,EAAO,YAAc,IAAI,KAAKA,EAAO,WAAW,EAAIP,EAAiB,WAAA,CAEtF,CACF,MAAQ,CAAC,CACT,OAAOA,CACT,CACF,EAKagB,EAAuB,MAAOF,GAA0D,CACnG,GAAI,CACF,MAAMN,EAASC,EAAIC,EAAIR,EAAqBD,CAAe,EAGrDgB,EAAkB,CACtB,GAAGH,EACH,gBAAiB,IAAK,EAGxB,MAAMI,EAAOV,EAAQS,EAAiB,CAAE,MAAO,GAAM,EAErD,GAAI,CAAE,aAAa,QAAQd,EAAoB,KAAK,UAAUc,CAAe,CAAC,CAAG,MAAQ,CAAC,CAC1F,MAAO,EACT,OAASE,EAAO,CACd,eAAQ,MAAM,+BAAgCA,CAAK,EAC5C,EACT,CACF,EAKaC,EAAqBC,GAAgC,CAEhE,MAAMC,EAAcD,EAAY,QAAQ,MAAO,EAAE,EAGjD,GAAIC,EAAY,OAAS,GACvB,MAAM,IAAI,MAAM,gDAAgD,EAGlE,OAAOA,CACT,EAKaC,EAAuBF,GAAiC,CACnE,GAAI,CACF,MAAMG,EAAYJ,EAAkBC,CAAW,EAC/C,OAAOG,EAAU,QAAU,IAAMA,EAAU,QAAU,EACvD,MAAQ,CACN,MAAO,EACT,CACF,EAKaC,EAAqB,CAACJ,EAAqBK,IAA4B,CAClF,MAAMC,EAAkBP,EAAkBC,CAAW,EAC/CO,EAAiB,mBAAmBF,CAAO,EACjD,MAAO,iBAAiBC,CAAe,SAASC,CAAc,EAChE,EAoCaC,EAAsB,IAAM,CACvC,KAAM,CAACf,EAAUgB,CAAW,EAAIC,EAAM,SAAkC,IAAI,EACtE,CAACC,EAASC,CAAU,EAAIF,EAAM,SAAS,EAAI,EAC3C,CAACZ,EAAOe,CAAQ,EAAIH,EAAM,SAAwB,IAAI,EAE5D,OAAAA,EAAM,UAAU,IAAM,EACC,SAAY,CAC/B,GAAI,CACFE,EAAW,EAAI,EACf,MAAME,EAAiB,MAAM/B,EAAA,EAC7B0B,EAAYK,CAAc,EAC1BD,EAAS,IAAI,CACf,OAASE,EAAK,CACZF,EAAS,+BAA+B,EACxC,QAAQ,MAAME,CAAG,CACnB,QAAA,CACEH,EAAW,EAAK,CAClB,CACF,GAEA,CACF,EAAG,CAAA,CAAE,EAuBE,CACL,SAAAnB,EACA,QAAAkB,EACA,MAAAb,EACA,eAzBqB,MAAOkB,GAA2C,CACvE,GAAI,CAGF,OAFAJ,EAAW,EAAI,EACC,MAAMjB,EAAqBqB,CAAW,GACvCvB,GACbgB,EAAY,CAAE,GAAGhB,EAAU,GAAGuB,EAAa,YAAa,IAAI,KAAQ,EACpEH,EAAS,IAAI,EACN,KAEPA,EAAS,sBAAsB,EACxB,GAEX,OAASE,EAAK,CACZ,OAAAF,EAAS,wBAAwB,EACjC,QAAQ,MAAME,CAAG,EACV,EACT,QAAA,CACEH,EAAW,EAAK,CAClB,CACF,EAOE,gBAAiB,IAAM7B,IAAuB,KAAK0B,CAAW,CAAA,CAElE"}