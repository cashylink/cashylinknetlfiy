{"version":3,"file":"broadcastService-EdXZNKjP.js","sources":["../../node_modules/lucide-react/dist/esm/icons/external-link.js","../../src/utils/broadcastService.ts"],"sourcesContent":["/**\n * @license lucide-react v0.462.0 - ISC\n *\n * This source code is licensed under the ISC license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createLucideIcon from '../createLucideIcon.js';\n\nconst ExternalLink = createLucideIcon(\"ExternalLink\", [\n  [\"path\", { d: \"M15 3h6v6\", key: \"1q9fwt\" }],\n  [\"path\", { d: \"M10 14 21 3\", key: \"gplh6r\" }],\n  [\"path\", { d: \"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6\", key: \"a6xqqp\" }]\n]);\n\nexport { ExternalLink as default };\n//# sourceMappingURL=external-link.js.map\n","import { db } from '@/firebase';\r\nimport { addDoc, collection, onSnapshot, serverTimestamp, query, where, updateDoc, doc } from 'firebase/firestore';\r\n\r\nexport type Broadcast = {\r\n  id?: string;\r\n  title: string;\r\n  message: string;\r\n  audienceKey: string; // 'global' أو 'shop:<shopId>'\r\n  active: boolean;\r\n  createdAt?: any;\r\n  createdBy?: string;\r\n  linkUrl?: string;\r\n};\r\n\r\nexport async function publishBroadcast({ title, message, audienceKey, createdBy, linkUrl }: { title: string; message: string; audienceKey: string; createdBy?: string; linkUrl?: string; }) {\r\n  const payload: Broadcast = {\r\n    title,\r\n    message,\r\n    audienceKey,\r\n    active: true,\r\n    createdAt: serverTimestamp(),\r\n    createdBy: createdBy || null as any,\r\n    linkUrl: linkUrl || undefined,\r\n  };\r\n  const ref = await addDoc(collection(db, 'broadcasts'), payload as any);\r\n  return ref.id;\r\n}\r\n\r\nexport function subscribeToActiveBroadcasts(audienceKeys: string[], cb: (b: Broadcast | null) => void) {\r\n  // اشتراك مرن بدون حاجة لفهارس مركبة: نجلب لكل مفتاح جمهور منفصل ثم نختار أحدث بث نشط.\r\n  const docsMap = new Map<string, Broadcast>();\r\n  const unsubs = audienceKeys.map((key) => {\r\n    const q = query(collection(db, 'broadcasts'), where('audienceKey', '==', key));\r\n    return onSnapshot(\r\n      q,\r\n      (snap) => {\r\n        snap.docChanges().forEach((change) => {\r\n          const data = change.doc.data() as Broadcast;\r\n          const id = change.doc.id;\r\n          const item: Broadcast = { ...data, id };\r\n          if (change.type === 'removed') {\r\n            docsMap.delete(id);\r\n          } else {\r\n            docsMap.set(id, item);\r\n          }\r\n        });\r\n\r\n        const allActive = Array.from(docsMap.values()).filter((d) => d.active === true);\r\n        if (allActive.length === 0) {\r\n          cb(null);\r\n          return;\r\n        }\r\n        // ترتيب حسب createdAt إن توفر، وإلا نحتفظ بآخر إدخال كما هو\r\n        const sorted = allActive.sort((a, b) => {\r\n          const ta = typeof a.createdAt?.toMillis === 'function' ? a.createdAt.toMillis() : 0;\r\n          const tb = typeof b.createdAt?.toMillis === 'function' ? b.createdAt.toMillis() : 0;\r\n          return ta - tb;\r\n        });\r\n        cb(sorted[sorted.length - 1]);\r\n      },\r\n      (err) => {\r\n        console.error('subscribeToActiveBroadcasts error:', err);\r\n        // لا نُسقط الحالة الحالية عند الخطأ؛ نُعلم المستمع فقط بغياب التحديثات\r\n        cb(null);\r\n      }\r\n    );\r\n  });\r\n  return () => unsubs.forEach((u) => u());\r\n}\r\n\r\nexport function subscribeToActiveBroadcastsList(audienceKeys: string[], cb: (list: Broadcast[]) => void) {\r\n  // مشابه للدالة أعلاه لكن يُعيد كل العناصر النشطة مرتبة\r\n  const docsMap = new Map<string, Broadcast>();\r\n  const unsubs = audienceKeys.map((key) => {\r\n    const q = query(collection(db, 'broadcasts'), where('audienceKey', '==', key));\r\n    return onSnapshot(\r\n      q,\r\n      (snap) => {\r\n        snap.docChanges().forEach((change) => {\r\n          const data = change.doc.data() as Broadcast;\r\n          const id = change.doc.id;\r\n          const item: Broadcast = { ...data, id };\r\n          if (change.type === 'removed') {\r\n            docsMap.delete(id);\r\n          } else {\r\n            docsMap.set(id, item);\r\n          }\r\n        });\r\n\r\n        const allActive = Array.from(docsMap.values()).filter((d) => d.active === true);\r\n        const sorted = allActive.sort((a, b) => {\r\n          const ta = typeof a.createdAt?.toMillis === 'function' ? a.createdAt.toMillis() : 0;\r\n          const tb = typeof b.createdAt?.toMillis === 'function' ? b.createdAt.toMillis() : 0;\r\n          return tb - ta; // الأحدث أولاً\r\n        });\r\n        cb(sorted);\r\n      },\r\n      (err) => {\r\n        console.error('subscribeToActiveBroadcastsList error:', err);\r\n        cb([]);\r\n      }\r\n    );\r\n  });\r\n  return () => unsubs.forEach((u) => u());\r\n}\r\n\r\nexport async function deactivateBroadcast(id: string) {\r\n  await updateDoc(doc(db, 'broadcasts', id), { active: false });\r\n}"],"names":["ExternalLink","createLucideIcon","publishBroadcast","title","message","audienceKey","createdBy","linkUrl","payload","serverTimestamp","addDoc","collection","db","subscribeToActiveBroadcasts","audienceKeys","cb","docsMap","unsubs","key","q","query","where","onSnapshot","snap","change","data","id","item","allActive","d","sorted","a","b","ta","_a","tb","_b","err","u","subscribeToActiveBroadcastsList"],"mappings":"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","x_google_ignoreList":[0]}