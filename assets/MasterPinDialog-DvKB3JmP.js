import{s as O,K as oe,y as H,i as Y,Q as he,aw as fe,P as ue,c as I,r as c,j as e,Y as ee,Z as te,_ as se,$ as ae,aD as de,v as re,I as R,a0 as me,B as p,f as xe,aE as ge,aF as pe,u as ye,E as K,w as V}from"./index-5OsgE1a1.js";import{L as B}from"./label-CiKO8Eg3.js";import{S as ve}from"./shield-CXN8M3ci.js";import{C as we}from"./circle-alert-Be956GlJ.js";const J="master_pin",g=new Map;function P(i){return i?`${J}_${i}`:J}async function je(i){try{const t=await fe.getUserData(i),s=(t==null?void 0:t.security)&&t.security.masterPin||(t==null?void 0:t.masterPin)||null;return typeof s=="string"&&s.length>0?s:null}catch{try{const t=H(Y,"users",i),s=await ue(t);if(s.exists()){const a=s.data(),r=(a==null?void 0:a.security)&&a.security.masterPin||(a==null?void 0:a.masterPin)||null;return typeof r=="string"&&r.length>0?r:null}}catch{}return null}}function X(i){try{const t=localStorage.getItem(P(i));return t&&t.length>0?t:null}catch{return null}}async function $(i,t){try{const s={security:{masterPin:t||null,masterPinUpdatedAt:O()},updatedAt:O()};await oe(H(Y,"users",i),s,{merge:!0})}catch{try{await he(H(Y,"users",i),{security:{masterPin:t||null,masterPinUpdatedAt:O()},updatedAt:O()})}catch{}}}function M(i,t){try{const s=P(i);t?localStorage.setItem(s,t):localStorage.removeItem(s)}catch{}}class j{static async hasMasterPin(t){const s=P(t);if(g.has(s)){const r=g.get(s);return r!==""&&r!=null}const a=X(t);if(a)return g.set(s,a),!0;if(t){const r=X(void 0);if(r){g.set(s,r),M(t,r);try{M(void 0,null)}catch{}return await $(t,r),!0}}if(t){const r=await je(t);if(r){g.set(s,r),M(t,r);try{M(void 0,null)}catch{}return!0}}return!1}static async createMasterPin(t,s){try{if(!t||t.length<4)return!1;const a=btoa(t),r=P(s);return g.set(r,a),M(s,a),s&&await $(s,a),!0}catch(a){return console.error("Error creating master PIN:",a),!1}}static async verifyMasterPin(t,s){try{const a=P(s);if(!await this.hasMasterPin(s))return!1;const r=g.get(a);return r?atob(r)===t:!1}catch(a){return console.error("Error verifying master PIN:",a),!1}}static async changeMasterPin(t,s,a){try{return await this.verifyMasterPin(t,a)?await this.createMasterPin(s,a):!1}catch(r){return console.error("Error changing master PIN:",r),!1}}static async deleteMasterPin(t){try{const s=P(t);return g.delete(s),M(t,null),t&&await $(t,null),!0}catch(s){return console.error("Error deleting master PIN:",s),!1}}static async getMasterPin(t){try{const s=P(t);if(!await this.hasMasterPin(t))return null;const a=g.get(s);return a?atob(a):null}catch(s){return console.error("Error getting master PIN:",s),null}}}const Pe=({open:i,onOpenChange:t,title:s="تأكيد كلمة المرور",description:a="أدخل كلمة مرور تسجيل الدخول للمتابعة",onSuccess:r})=>{const{toast:n}=I(),[d,N]=c.useState(""),[o,y]=c.useState(!1),[b,m]=c.useState(null),E=async()=>{m(null);try{const l=xe.currentUser;if(!l||!l.email){m("لا يوجد مستخدم مسجل حالياً. يرجى تسجيل الدخول أولاً.");return}y(!0);const v=ge.credential(l.email,d);await pe(l,v),y(!1),N(""),n({title:"تم التأكيد",description:"تم التحقق من كلمة المرور بنجاح"}),r(),t&&t(!1)}catch(l){console.error("إعادة التحقق بكلمة المرور فشلت:",l),y(!1);const v=(l==null?void 0:l.code)||"";m(v==="auth/wrong-password"?"كلمة المرور غير صحيحة. حاول مرة أخرى.":v==="auth/too-many-requests"?"تمت محاولات كثيرة. يرجى الانتظار قليلاً ثم المحاولة.":"حدث خطأ أثناء التحقق. حاول مرة أخرى.")}},S=l=>{t&&t(l),l||(N(""),m(null),y(!1))};return e.jsx(ee,{open:i,onOpenChange:S,children:e.jsxs(te,{className:"sm:max-w-[400px]",dir:"rtl",children:[e.jsxs(se,{children:[e.jsx(ae,{className:"text-right",children:s}),e.jsx(de,{className:"text-right",children:a})]}),e.jsxs("div",{className:"grid gap-4 py-2",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-2",children:[e.jsx("label",{htmlFor:"password",className:"text-right col-span-1 text-sm",children:"كلمة المرور"}),e.jsxs("div",{className:"col-span-3 relative",children:[e.jsx(re,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(R,{id:"password",type:"password",value:d,onChange:l=>N(l.target.value),placeholder:"نفس كلمة مرور تسجيل الدخول",autoComplete:"off"})]})]}),b&&e.jsx("div",{className:"text-red-600 text-xs text-right",children:b})]}),e.jsxs(me,{className:"flex justify-end gap-2",children:[e.jsx(p,{variant:"outline",onClick:()=>S(!1),disabled:o,children:"إلغاء"}),e.jsx(p,{onClick:E,disabled:o||!d,className:"bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",children:o?"جاري التحقق...":"تأكيد"})]})]})})},Me=({open:i,onOpenChange:t,onSuccess:s,title:a="الرقم السري الرئيسي",description:r="رقم سري موحد لإدارة جميع عناصر الموقع",mode:n="verify"})=>{const[d,N]=c.useState(""),[o,y]=c.useState(""),[b,m]=c.useState(""),[E,S]=c.useState(!1),[l,v]=c.useState(!1),[T,q]=c.useState(!1),[Q,h]=c.useState(""),[W,f]=c.useState(!1),{toast:_}=I(),{user:z,profile:C}=ye(),x=z==null?void 0:z.uid,[w,ne]=c.useState(!1),[D,ie]=c.useState(!1),A=(C==null?void 0:C.role)==="admin"||(C==null?void 0:C.role)==="staff",[le,L]=c.useState(!1),[k,Z]=c.useState(!1);c.useEffect(()=>{let u=!0;return i&&(async()=>{try{const G=await j.hasMasterPin(x);u&&ne(G)}catch{}})(),()=>{u=!1}},[x,i]);const ce=async u=>{u.preventDefault(),h(""),f(!0);try{if(n==="verify"){if(!d){h("يرجى إدخال الرقم السري الرئيسي"),f(!1);return}if(!await j.verifyMasterPin(d,x)){h("الرقم السري غير صحيح"),f(!1);return}_({title:"تم التأكيد",description:"تم التحقق من الرقم السري بنجاح"}),s==null||s(),F()}else if(n==="create"){if(!o||o.length<4){h("يجب أن يكون الرقم السري الجديد 4 أرقام على الأقل"),f(!1);return}if(o!==b){h("الرقم السري الجديد وتأكيده غير متطابقين"),f(!1);return}if(!await j.createMasterPin(o,x)){h("تعذر إنشاء الرقم السري الرئيسي"),f(!1);return}_({title:"تم تعيين الرقم السري الرئيسي",description:"تم تعيين الرقم السري الرئيسي بنجاح"}),s==null||s(),F()}else if(n==="change"){if(!x){h("لا يمكن تغيير الرقم السري قبل تحميل حساب المستخدم. الرجاء إعادة المحاولة بعد تسجيل الدخول أو انتظار التحميل."),f(!1);return}if(w&&!D&&!k){if(!d){h("يرجى إدخال الرقم السري الحالي أو تأكيد كلمة الدخول"),f(!1);return}if(!await j.verifyMasterPin(d,x)){h("الرقم السري الحالي غير صحيح"),f(!1);return}}if(!o||o.length<4){h("يجب أن يكون الرقم السري الجديد 4 أرقام على الأقل"),f(!1);return}if(o!==b){h("الرقم السري الجديد وتأكيده غير متطابقين"),f(!1);return}if(!(w?D&&A||k?await j.createMasterPin(o,x):await j.changeMasterPin(d,o,x):await j.createMasterPin(o,x))){h("تعذر تغيير الرقم السري الرئيسي"),f(!1);return}_({title:w?D&&A||k?"تم إعادة تعيين الرقم السري الرئيسي":"تم تغيير الرقم السري الرئيسي":"تم تعيين الرقم السري الرئيسي",description:w?D&&A||k?"تمت إعادة التعيين بدون الحاجة للرقم الحالي":"تم تغيير الرقم السري الرئيسي بنجاح":"تم تعيين الرقم السري الرئيسي بنجاح"}),s==null||s(),F()}}catch{h("حدث خطأ أثناء معالجة الرقم السري")}finally{f(!1)}},F=()=>{N(""),y(""),m(""),h(""),S(!1),v(!1),q(!1),Z(!1),L(!1),t(!1)};return e.jsx(ee,{open:i,onOpenChange:F,children:e.jsxs(te,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(se,{children:e.jsxs(ae,{className:"flex items-center gap-2 text-center justify-center",children:[e.jsx(ve,{className:"h-5 w-5 text-blue-600"}),a]})}),e.jsx("div",{className:"text-center text-sm text-gray-600 mb-4",children:r}),e.jsxs("form",{onSubmit:ce,className:"space-y-4",children:[(n==="verify"||n==="change"&&w)&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"currentPin",className:"text-right block",children:n==="verify"?"الرقم السري الرئيسي":"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"currentPin",type:E?"text":"password",autoComplete:"off",value:d,onChange:u=>N(u.target.value),placeholder:n==="verify"?"أدخل الرقم السري الرئيسي":"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr",disabled:n==="change"&&k}),e.jsx(p,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>S(!E),children:E?e.jsx(K,{className:"h-4 w-4"}):e.jsx(V,{className:"h-4 w-4"})})]}),n==="change"&&w&&A&&e.jsxs("div",{className:"text-xs text-gray-600 mt-2 flex items-center justify-between",children:[e.jsx("span",{children:"نسيت الرقم السري؟"}),e.jsx(p,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2",onClick:()=>{ie(u=>!u)},children:D?"إلغاء إعادة التعيين الإدارية":"إعادة تعيين بدون الرقم الحالي"})]}),n==="change"&&w&&e.jsxs("div",{className:"text-xs text-gray-600 mt-2 flex items-center justify-between",children:[e.jsx("span",{children:"لا تعرف الرقم الحالي؟ يمكنك تأكيد بكلمة الدخول"}),e.jsx(p,{type:"button",variant:"secondary",size:"sm",className:"h-7 px-2",onClick:()=>L(!0),children:"تأكيد بكلمة الدخول"})]}),n==="change"&&k&&e.jsx("div",{className:"text-[11px] text-green-600",children:"تم التحقق من كلمة الدخول — يمكنك المتابعة بدون الرقم الحالي"})]}),(n==="create"||n==="change")&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"newPin",className:"text-right block",children:n==="create"?"الرقم السري الرئيسي الجديد":"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"newPin",type:l?"text":"password",autoComplete:"off",value:o,onChange:u=>y(u.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(p,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>v(!l),children:l?e.jsx(K,{className:"h-4 w-4"}):e.jsx(V,{className:"h-4 w-4"})})]})]}),(n==="create"||n==="change")&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"confirmPin",type:T?"text":"password",autoComplete:"off",value:b,onChange:u=>m(u.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(p,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>q(!T),children:T?e.jsx(K,{className:"h-4 w-4"}):e.jsx(V,{className:"h-4 w-4"})})]})]}),Q&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm bg-red-50 p-3 rounded-lg",children:[e.jsx(we,{className:"h-4 w-4"}),Q]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(p,{type:"button",variant:"outline",onClick:F,className:"flex-1",children:"إلغاء"}),e.jsx(p,{type:"submit",disabled:W,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:W?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري المعالجة..."]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),n==="verify"?"تحقق":n==="create"?"إنشاء":"تغيير"]})})]})]}),e.jsx(Pe,{open:le,onOpenChange:L,title:"تأكيد بكلمة دخول الحساب",description:"أدخل كلمة المرور المستخدمة لتسجيل الدخول للسماح بتغيير الرقم السري",onSuccess:()=>{Z(!0),L(!1),h("")}})]})})};export{Me as M,Pe as P,j as a};
