{"version":3,"file":"walletDailyLimitsService-DdjjL_Zn.js","sources":["../../src/utils/walletDailyLimitsService.ts"],"sourcesContent":["import { db, auth } from '@/firebase';\r\nimport { doc, setDoc, getDoc, serverTimestamp, Timestamp } from 'firebase/firestore';\r\n\r\n// ÙˆØ§Ø¬Ù‡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ÙˆØ§Ù„Ø´Ù‡Ø±ÙŠØ©\r\ninterface WalletDailyLimits {\r\n  walletId: string;\r\n  // Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©\r\n  dailyTransferLimit: number;    // 60,000 Ø¬Ù†ÙŠÙ‡\r\n  dailyWithdrawLimit: number;    // 100,000 Ø¬Ù†ÙŠÙ‡\r\n  dailyTransferUsed: number;     // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…\r\n  dailyWithdrawUsed: number;     // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„ÙŠÙˆÙ…\r\n  lastDailyReset: Timestamp | null;\r\n  \r\n  // Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©\r\n  monthlyTransferLimit: number;  // 200,000 Ø¬Ù†ÙŠÙ‡\r\n  monthlyWithdrawLimit: number;  // 200,000 Ø¬Ù†ÙŠÙ‡\r\n  monthlyTransferUsed: number;   // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±\r\n  monthlyWithdrawUsed: number;   // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø³Ø­Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±\r\n  lastMonthlyReset: Timestamp | null;\r\n  \r\n  updatedAt: Timestamp;\r\n}\r\n\r\n// Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯\r\ninterface LimitCheckResult {\r\n  canPerform: boolean;\r\n  message?: string;\r\n  dailyRemaining?: number;\r\n  monthlyRemaining?: number;\r\n  limitType?: 'daily' | 'monthly';\r\n}\r\n\r\n// Ø®Ø¯Ù…Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ÙˆØ§Ù„Ø´Ù‡Ø±ÙŠØ© Ù„Ù„Ù…Ø­Ø§ÙØ¸\r\nexport const walletDailyLimitsService = {\r\n  \r\n  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ\r\n  getCurrentDayId(): string {\r\n    const now = new Date();\r\n    return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;\r\n  },\r\n\r\n  // ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ… Ø§Ù„Ø­Ø¯ÙˆØ¯ (Ø§Ù„ÙŠÙˆÙ…ÙŠ/Ø§Ù„Ø´Ù‡Ø±ÙŠ) Ù„Ù„Ù…Ø­ÙØ¸Ø©\r\n  async setLimits(\r\n    walletId: string,\r\n    newLimits: {\r\n      dailyTransferLimit?: number;\r\n      dailyWithdrawLimit?: number;\r\n      monthlyTransferLimit?: number;\r\n      monthlyWithdrawLimit?: number;\r\n    }\r\n  ): Promise<WalletDailyLimits | null> {\r\n    try {\r\n      const limitsRef = doc(db, 'walletLimits', walletId);\r\n      const updateData: any = { updatedAt: serverTimestamp(), ownerId: auth.currentUser?.uid };\r\n\r\n      if (newLimits.dailyTransferLimit !== undefined) {\r\n        updateData.dailyTransferLimit = newLimits.dailyTransferLimit;\r\n      }\r\n      if (newLimits.dailyWithdrawLimit !== undefined) {\r\n        updateData.dailyWithdrawLimit = newLimits.dailyWithdrawLimit;\r\n      }\r\n      if (newLimits.monthlyTransferLimit !== undefined) {\r\n        updateData.monthlyTransferLimit = newLimits.monthlyTransferLimit;\r\n      }\r\n      if (newLimits.monthlyWithdrawLimit !== undefined) {\r\n        updateData.monthlyWithdrawLimit = newLimits.monthlyWithdrawLimit;\r\n      }\r\n\r\n      await setDoc(limitsRef, updateData, { merge: true });\r\n      return await this.getWalletLimits(walletId);\r\n    } catch (error) {\r\n      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø©:', error);\r\n      return null;\r\n    }\r\n  },\r\n\r\n  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ\r\n  getCurrentMonthId(): string {\r\n    const now = new Date();\r\n    return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;\r\n  },\r\n\r\n  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¶Ø±ÙˆØ±Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Ø¨Ø¹Ø¯ Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„)\r\n  shouldResetDailyLimits(lastReset: Timestamp | null): boolean {\r\n    if (!lastReset) return true;\r\n    \r\n    const now = new Date();\r\n    const lastResetDate = lastReset.toDate();\r\n    \r\n    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„ÙŠÙˆÙ…\r\n    return (\r\n      now.getDate() !== lastResetDate.getDate() ||\r\n      now.getMonth() !== lastResetDate.getMonth() ||\r\n      now.getFullYear() !== lastResetDate.getFullYear()\r\n    );\r\n  },\r\n\r\n  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¶Ø±ÙˆØ±Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø´Ù‡Ø±ÙŠØ© (Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø±)\r\n  shouldResetMonthlyLimits(lastReset: Timestamp | null): boolean {\r\n    const now = new Date();\r\n    const isFirstDay = now.getDate() === 1;\r\n    if (!lastReset) return isFirstDay;\r\n    const lastResetDate = lastReset.toDate();\r\n    return (\r\n      isFirstDay && (\r\n        now.getMonth() !== lastResetDate.getMonth() ||\r\n        now.getFullYear() !== lastResetDate.getFullYear()\r\n      )\r\n    );\r\n  },\r\n\r\n  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©\r\n  async getWalletLimits(walletId: string): Promise<WalletDailyLimits | null> {\r\n    try {\r\n      const limitsRef = doc(db, 'walletLimits', walletId);\r\n      try {\r\n        const limitsSnap = await getDoc(limitsRef);\r\n        if (limitsSnap.exists()) {\r\n          const data = limitsSnap.data();\r\n          return {\r\n            walletId,\r\n            dailyTransferLimit: data.dailyTransferLimit || 60000,\r\n            dailyWithdrawLimit: data.dailyWithdrawLimit || 100000,\r\n            dailyTransferUsed: data.dailyTransferUsed || 0,\r\n            dailyWithdrawUsed: data.dailyWithdrawUsed || 0,\r\n            lastDailyReset: data.lastDailyReset || null,\r\n            monthlyTransferLimit: data.monthlyTransferLimit || 200000,\r\n            monthlyWithdrawLimit: data.monthlyWithdrawLimit || 200000,\r\n            monthlyTransferUsed: data.monthlyTransferUsed || 0,\r\n            monthlyWithdrawUsed: data.monthlyWithdrawUsed || 0,\r\n            lastMonthlyReset: data.lastMonthlyReset || null,\r\n            updatedAt: data.updatedAt || Timestamp.now()\r\n          };\r\n        }\r\n      } catch {}\r\n      \r\n      // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©\r\n      const newLimits: WalletDailyLimits = {\r\n        walletId,\r\n        dailyTransferLimit: 60000,\r\n        dailyWithdrawLimit: 100000,\r\n        dailyTransferUsed: 0,\r\n        dailyWithdrawUsed: 0,\r\n        lastDailyReset: null,\r\n        monthlyTransferLimit: 200000,\r\n        monthlyWithdrawLimit: 200000,\r\n        monthlyTransferUsed: 0,\r\n        monthlyWithdrawUsed: 0,\r\n        lastMonthlyReset: null,\r\n        updatedAt: Timestamp.now()\r\n      };\r\n      \r\n      // Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯\r\n      await setDoc(limitsRef, {\r\n        dailyTransferLimit: 60000,\r\n        dailyWithdrawLimit: 100000,\r\n        dailyTransferUsed: 0,\r\n        dailyWithdrawUsed: 0,\r\n        lastDailyReset: null,\r\n        monthlyTransferLimit: 200000,\r\n        monthlyWithdrawLimit: 200000,\r\n        monthlyTransferUsed: 0,\r\n        monthlyWithdrawUsed: 0,\r\n        lastMonthlyReset: null,\r\n        updatedAt: serverTimestamp(),\r\n        ownerId: auth.currentUser?.uid\r\n      });\r\n      \r\n      return newLimits;\r\n    } catch (error) {\r\n      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø©:', error);\r\n      return null;\r\n    }\r\n  },\r\n\r\n  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©\r\n  async resetDailyLimits(walletId: string): Promise<boolean> {\r\n    try {\r\n      const limitsRef = doc(db, 'walletLimits', walletId);\r\n      \r\n      await setDoc(limitsRef, {\r\n        dailyTransferUsed: 0,\r\n        dailyWithdrawUsed: 0,\r\n        lastDailyReset: serverTimestamp(),\r\n        updatedAt: serverTimestamp(),\r\n        ownerId: auth.currentUser?.uid\r\n      }, { merge: true });\r\n      \r\n      console.log(`ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù„Ù„Ù…Ø­ÙØ¸Ø© ${walletId}`);\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©:', error);\r\n      return false;\r\n    }\r\n  },\r\n\r\n  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©\r\n  async resetMonthlyLimits(walletId: string): Promise<boolean> {\r\n    try {\r\n      const limitsRef = doc(db, 'walletLimits', walletId);\r\n      \r\n      await setDoc(limitsRef, {\r\n        monthlyTransferUsed: 0,\r\n        monthlyWithdrawUsed: 0,\r\n        lastMonthlyReset: serverTimestamp(),\r\n        updatedAt: serverTimestamp(),\r\n        ownerId: auth.currentUser?.uid\r\n      }, { merge: true });\r\n      \r\n      console.log(`ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ù„Ù„Ù…Ø­ÙØ¸Ø© ${walletId}`);\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©:', error);\r\n      return false;\r\n    }\r\n  },\r\n\r\n  // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±\r\n  async autoResetLimitsIfNeeded(walletId: string): Promise<WalletDailyLimits | null> {\r\n    try {\r\n      const limits = await this.getWalletLimits(walletId);\r\n      if (!limits) return null;\r\n      \r\n      let needsUpdate = false;\r\n      \r\n      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©\r\n      if (this.shouldResetDailyLimits(limits.lastDailyReset)) {\r\n        await this.resetDailyLimits(walletId);\r\n        needsUpdate = true;\r\n      }\r\n      \r\n      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©\r\n      if (this.shouldResetMonthlyLimits(limits.lastMonthlyReset)) {\r\n        await this.resetMonthlyLimits(walletId);\r\n        needsUpdate = true;\r\n      }\r\n      \r\n      // Ø¥Ø¹Ø§Ø¯Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«\r\n      if (needsUpdate) {\r\n        return await this.getWalletLimits(walletId);\r\n      }\r\n      \r\n      return limits;\r\n    } catch (error) {\r\n      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯:', error);\r\n      return null;\r\n    }\r\n  },\r\n\r\n  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©\r\n  async canPerformOperation(walletId: string, amount: number, type: 'transfer' | 'withdraw'): Promise<LimitCheckResult> {\r\n    try {\r\n      // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†\r\n      const limits = await this.autoResetLimitsIfNeeded(walletId);\r\n      if (!limits) {\r\n        return { canPerform: false, message: 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø©' };\r\n      }\r\n\r\n      if (type === 'transfer') {\r\n        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù„ØªØ­ÙˆÙŠÙ„\r\n        const dailyRemaining = limits.dailyTransferLimit - limits.dailyTransferUsed;\r\n        if (amount > dailyRemaining) {\r\n          return {\r\n            canPerform: false,\r\n            message: `ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù„ØªØ­ÙˆÙŠÙ„. Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${dailyRemaining.toLocaleString()} Ø¬.Ù… Ù…Ù† Ø£ØµÙ„ ${limits.dailyTransferLimit.toLocaleString()} Ø¬.Ù…`,\r\n            dailyRemaining,\r\n            limitType: 'daily'\r\n          };\r\n        }\r\n\r\n        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„Ù„ØªØ­ÙˆÙŠÙ„\r\n        const monthlyRemaining = limits.monthlyTransferLimit - limits.monthlyTransferUsed;\r\n        if (amount > monthlyRemaining) {\r\n          return {\r\n            canPerform: false,\r\n            message: `ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„Ù„ØªØ­ÙˆÙŠÙ„. Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${monthlyRemaining.toLocaleString()} Ø¬.Ù… Ù…Ù† Ø£ØµÙ„ ${limits.monthlyTransferLimit.toLocaleString()} Ø¬.Ù…`,\r\n            monthlyRemaining,\r\n            limitType: 'monthly'\r\n          };\r\n        }\r\n\r\n        return { \r\n          canPerform: true, \r\n          dailyRemaining: dailyRemaining - amount,\r\n          monthlyRemaining: monthlyRemaining - amount\r\n        };\r\n      }\r\n\r\n      if (type === 'withdraw') {\r\n        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù„Ø³Ø­Ø¨\r\n        const dailyRemaining = limits.dailyWithdrawLimit - limits.dailyWithdrawUsed;\r\n        if (amount > dailyRemaining) {\r\n          return {\r\n            canPerform: false,\r\n            message: `ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù„Ø³Ø­Ø¨. Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${dailyRemaining.toLocaleString()} Ø¬.Ù… Ù…Ù† Ø£ØµÙ„ ${limits.dailyWithdrawLimit.toLocaleString()} Ø¬.Ù…`,\r\n            dailyRemaining,\r\n            limitType: 'daily'\r\n          };\r\n        }\r\n\r\n        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„Ù„Ø³Ø­Ø¨\r\n        const monthlyRemaining = limits.monthlyWithdrawLimit - limits.monthlyWithdrawUsed;\r\n        if (amount > monthlyRemaining) {\r\n          return {\r\n            canPerform: false,\r\n            message: `ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„Ù„Ø³Ø­Ø¨. Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${monthlyRemaining.toLocaleString()} Ø¬.Ù… Ù…Ù† Ø£ØµÙ„ ${limits.monthlyWithdrawLimit.toLocaleString()} Ø¬.Ù…`,\r\n            monthlyRemaining,\r\n            limitType: 'monthly'\r\n          };\r\n        }\r\n\r\n        return { \r\n          canPerform: true, \r\n          dailyRemaining: dailyRemaining - amount,\r\n          monthlyRemaining: monthlyRemaining - amount\r\n        };\r\n      }\r\n\r\n      return { canPerform: false, message: 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­' };\r\n    } catch (error) {\r\n      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:', error);\r\n      return { canPerform: false, message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯' };\r\n    }\r\n  },\r\n\r\n  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø¹Ø¯ Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©\r\n  async updateUsage(walletId: string, amount: number, type: 'transfer' | 'withdraw'): Promise<WalletDailyLimits | null> {\r\n    try {\r\n      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹\r\n      const canPerform = await this.canPerformOperation(walletId, amount, type);\r\n      if (!canPerform.canPerform) {\r\n        throw new Error(canPerform.message || 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');\r\n      }\r\n\r\n      const limitsRef = doc(db, 'walletLimits', walletId);\r\n      const limits = await this.getWalletLimits(walletId);\r\n      if (!limits) {\r\n        throw new Error('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø©');\r\n      }\r\n\r\n      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…\r\n      const updateData: any = {\r\n        updatedAt: serverTimestamp()\r\n      };\r\n\r\n      if (type === 'transfer') {\r\n        updateData.dailyTransferUsed = limits.dailyTransferUsed + amount;\r\n        updateData.monthlyTransferUsed = limits.monthlyTransferUsed + amount;\r\n      } else if (type === 'withdraw') {\r\n        updateData.dailyWithdrawUsed = limits.dailyWithdrawUsed + amount;\r\n        updateData.monthlyWithdrawUsed = limits.monthlyWithdrawUsed + amount;\r\n      }\r\n\r\n      await setDoc(limitsRef, { ...updateData }, { merge: true });\r\n\r\n      // Ø¥Ø¹Ø§Ø¯Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©\r\n      return await this.getWalletLimits(walletId);\r\n    } catch (error) {\r\n      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©:', error);\r\n      throw error;\r\n    }\r\n  },\r\n\r\n  async rollbackUsage(walletId: string, amount: number, type: 'transfer' | 'withdraw'): Promise<WalletDailyLimits | null> {\r\n    try {\r\n      const limitsRef = doc(db, 'walletLimits', walletId);\r\n      const limits = await this.getWalletLimits(walletId);\r\n      if (!limits) {\r\n        throw new Error('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø©');\r\n      }\r\n\r\n      const updateData: any = {\r\n        updatedAt: serverTimestamp()\r\n      };\r\n\r\n      if (type === 'transfer') {\r\n        updateData.dailyTransferUsed = Math.max(0, (limits.dailyTransferUsed || 0) - amount);\r\n        updateData.monthlyTransferUsed = Math.max(0, (limits.monthlyTransferUsed || 0) - amount);\r\n      } else {\r\n        updateData.dailyWithdrawUsed = Math.max(0, (limits.dailyWithdrawUsed || 0) - amount);\r\n        updateData.monthlyWithdrawUsed = Math.max(0, (limits.monthlyWithdrawUsed || 0) - amount);\r\n      }\r\n\r\n      await setDoc(limitsRef, { ...updateData }, { merge: true });\r\n      return await this.getWalletLimits(walletId);\r\n    } catch (error) {\r\n      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø©:', error);\r\n      throw error;\r\n    }\r\n  },\r\n\r\n  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©\r\n  calculateRemaining(limits: WalletDailyLimits): {\r\n    dailyTransferRemaining: number;\r\n    dailyWithdrawRemaining: number;\r\n    monthlyTransferRemaining: number;\r\n    monthlyWithdrawRemaining: number;\r\n  } {\r\n    return {\r\n      dailyTransferRemaining: Math.max(0, limits.dailyTransferLimit - limits.dailyTransferUsed),\r\n      dailyWithdrawRemaining: Math.max(0, limits.dailyWithdrawLimit - limits.dailyWithdrawUsed),\r\n      monthlyTransferRemaining: Math.max(0, limits.monthlyTransferLimit - limits.monthlyTransferUsed),\r\n      monthlyWithdrawRemaining: Math.max(0, limits.monthlyWithdrawLimit - limits.monthlyWithdrawUsed)\r\n    };\r\n  },\r\n\r\n  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¯ÙˆØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹ (Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©)\r\n  async resetAllLimits(walletId: string): Promise<WalletDailyLimits | null> {\r\n    try {\r\n      const limitsRef = doc(db, 'walletLimits', walletId);\r\n      \r\n      await setDoc(limitsRef, {\r\n        dailyTransferUsed: 0,\r\n        dailyWithdrawUsed: 0,\r\n        monthlyTransferUsed: 0,\r\n        monthlyWithdrawUsed: 0,\r\n        lastDailyReset: serverTimestamp(),\r\n        lastMonthlyReset: serverTimestamp(),\r\n        updatedAt: serverTimestamp(),\r\n        ownerId: auth.currentUser?.uid\r\n      }, { merge: true });\r\n\r\n      console.log(`âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© ${walletId}`);\r\n      return await this.getWalletLimits(walletId);\r\n    } catch (error) {\r\n      console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¯ÙˆØ¯:', error);\r\n      return null;\r\n    }\r\n  }\r\n};\r\n\r\nexport default walletDailyLimitsService;\r\n"],"names":["walletDailyLimitsService","now","walletId","newLimits","limitsRef","doc","db","updateData","serverTimestamp","_a","auth","setDoc","error","lastReset","lastResetDate","isFirstDay","limitsSnap","getDoc","data","Timestamp","limits","needsUpdate","amount","type","dailyRemaining","monthlyRemaining","canPerform"],"mappings":"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"}