import{R as o,i as Se,a4 as je,u as Ne,j as e,a5 as G,a6 as H,a7 as J,a8 as Q,B as v,v as te,I as ae,q as M,n as k,o as x,as as g,t as F,a3 as I,Y as se,K as $,ah as ne}from"./index-CWTdLx7E.js";import{a as ce}from"./MasterPinDialog-BwapmE19.js";import{D as re}from"./dollar-sign-DFJExlvM.js";import{P as we}from"./package-CA60lHS4.js";import{A as De}from"./formatters-Bxe0AUcL.js";import"./circle-alert-NzwhoXxt.js";const ke=({open:S,onOpenChange:oe,userId:n,cashBalance:T,walletBalances:Ce,transactions:ie})=>{const[le,V]=o.useState(0),[E,N]=o.useState(0),[de,me]=o.useState(0),[P,A]=o.useState(0),[_,f]=o.useState(T||0),[he,B]=o.useState(!1),[W,q]=o.useState(null),{toast:p}=Se(),{shopId:d}=je()||{},{profile:r}=Ne(),[ue,O]=o.useState(!1),[U,L]=o.useState(""),[xe,z]=o.useState(!1),[ge,R]=o.useState(!1),[X,Y]=o.useState(""),w=()=>`cashBalance_${n||"default"}_${d||(r==null?void 0:r.shopId)||"main"}`,K=a=>`${new Intl.NumberFormat("ar-EG").format(Number(a||0))} جنيه`;o.useEffect(()=>{const a=async()=>{try{if(!n){V(0);return}const t=new Date,s=t.getFullYear(),D=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0"),b=`${s}-${D}-${l}`;let m;try{const u=M(k(x,"dailySales"),g("userId","==",n),...d?[g("shopId","==",d)]:[],g("date","==",b));m=await F(u)}catch{const u=M(k(x,"users",n,"dailySales"),...d?[g("shopId","==",d)]:[],g("date","==",b));m=await F(u)}let h=0;m.forEach(u=>{const y=u.data(),C=Number(y.sellingPrice??0),j=Number(y.quantity??0);C>0&&j>0&&(h+=C*j)}),V(h)}catch(t){console.warn("فشل تحميل مبيعات الإكسسوار لليوم:",t)}},i=async()=>{try{if(!n){setMaintenanceProfitToday(0);return}const t=new Date,s=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0,0),D=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59,999);let l;try{const m=M(k(x,"maintenance_items"),g("userId","==",n),g("status","==","completed"));l=await F(m)}catch{l=await F(M(k(x,"maintenance_items"),g("userId","==",n)))}let b=0;l.forEach(m=>{var y,C;const h=m.data();if((h.status||"in_progress")!=="completed")return;const u=(C=(y=h.completedAt)==null?void 0:y.toDate)==null?void 0:C.call(y);if(u&&u.getTime()>=s.getTime()&&u.getTime()<=D.getTime()){const j=Number(h.repairPrice||0);Number.isFinite(j)&&j>0&&(b+=j)}}),me(Math.max(0,b))}catch(t){console.warn("فشل تحميل إجمالي فلوس الصيانة لليوم:",t)}},c=async()=>{var t;try{if(!n){N(0);return}const s=await I.getUserData(n),D=new Date().toISOString().slice(0,10),l=(s==null?void 0:s.dailyReceipts)||{};l!=null&&l.date&&String(l.date).slice(0,10)===D?(N(Number(l.accessory||0)),A(Number(l.maintenance||0))):(N(0),A(0));try{const b=d||(r==null?void 0:r.shopId)||"main",m=await se($(x,"dashboardData",b));if(m.exists()){const h=Number(((t=m.data())==null?void 0:t.cashBalance)||0);f(h);try{localStorage.setItem(`cashBalance_${n}`,String(h)),localStorage.setItem(w(),String(h))}catch{}}else f(Number((s==null?void 0:s.cashBalance)||T||0))}catch{f(Number((s==null?void 0:s.cashBalance)||T||0))}}catch{N(0),A(0)}};S&&(a(),i(),c())},[S,n,ie,T,d]),o.useEffect(()=>{const a=i=>{var c;try{const t=Number((c=i==null?void 0:i.detail)==null?void 0:c.value);Number.isFinite(t)&&f(t)}catch{}};return window.addEventListener("cashBalanceChanged",a),()=>window.removeEventListener("cashBalanceChanged",a)},[S]),o.useEffect(()=>{if(!S||!n)return;const a=d||(r==null?void 0:r.shopId)||"main";return(async()=>{var c;try{const t=await se($(x,"dashboardData",a));if(t.exists()){const s=Number(((c=t.data())==null?void 0:c.cashBalance)||0);f(s);try{localStorage.setItem(`cashBalance_${n}`,String(s)),localStorage.setItem(w(),String(s))}catch{}}}catch(t){console.warn("Error fetching dashboard data:",t)}})(),()=>{}},[S,n,d]);const Z=Math.max(0,Number(le)-Number(E)),ee=Math.max(0,Number(de)-Number(P)),fe=async a=>{if(!n)return;const i=new Date().toISOString().slice(0,10);try{const c=a==="accessory"?Z:ee;if(c<=0){p({title:"لا يوجد مبلغ لتأكيد استلامه",variant:"default"});return}const t=Math.max(0,Number(_)-c);f(t),a==="accessory"?N(s=>s+c):A(s=>s+c),await I.updateUserData(n,{cashBalance:t,dailyReceipts:{date:i,accessory:a==="accessory"?E+c:E,maintenance:a==="maintenance"?P+c:P}});try{const s=d||(r==null?void 0:r.shopId)||"main";await ne($(x,"dashboardData",s),{cashBalance:t,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${n}`,String(t)),localStorage.setItem(w(),String(t))}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:t}}))}catch{}p({title:"تم الاستلام",description:`تم خصم ${c.toFixed(2)} من الدرج وتصفير بند ${a==="accessory"?"الإكسسوار":"الصيانة"}`})}catch{p({title:"خطأ",description:"تعذر تنفيذ عملية تم الاستلام",variant:"destructive"})}},pe=()=>{L(""),Y(""),O(!0)},be=()=>{if(!U.trim()){p({title:"سبب الخصم مطلوب",variant:"destructive"});return}O(!1),z(!0)},ye=()=>{z(!1),R(!0)},ve=async()=>{try{if(!n)return;const a=Math.max(0,Number(X||0));if(!Number.isFinite(a)||a<=0){p({title:"مبلغ غير صالح",description:"أدخل مبلغ خصم صحيح أكبر من الصفر",variant:"destructive"});return}const i=Math.max(0,Number(_)-a);f(i),await I.updateUserData(n,{cashBalance:i});try{const t=d||(r==null?void 0:r.shopId)||"main";await ne($(x,"dashboardData",t),{cashBalance:i,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${n}`,String(i))}catch{}try{const t=new Date().toISOString();localStorage.setItem(w(),String(i)),localStorage.setItem(w()+"_lastUpdated",t)}catch{}const c={title:"ايصال خصم من الفلوس النقديه",type:"cash_deduction",amount:a,status:"completed",createdAt:new Date,note:U,cashierName:"الحساب الرئيسي"};try{await I.saveUserTransaction(n,c)}catch{}p({title:"تم الخصم",description:`تم خصم ${a.toFixed(2)} من الدرج`}),R(!1),Y(""),L("")}catch{p({title:"فشل الخصم",description:"تعذر تنفيذ عملية الخصم",variant:"destructive"})}};return e.jsx(G,{open:S,onOpenChange:oe,children:e.jsxs(H,{className:"sm:max-w-lg animate-in fade-in-90 zoom-in-95 slide-in-from-top-4",dir:"rtl",children:[e.jsx(J,{children:e.jsxs(Q,{className:"flex items-center gap-2 text-right",children:[e.jsx(re,{className:"h-5 w-5 text-emerald-600"}),"تفاصيل الفلوس النقدية"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between bg-amber-50 border border-amber-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 font-bold text-sm",children:[e.jsx(re,{className:"h-4 w-4"}),"مجموع الفلوس النقدية (الدرج)"]}),e.jsx("div",{className:"text-amber-700 font-extrabold text-sm",children:K(_)})]}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 font-bold text-sm",children:[e.jsx(we,{className:"h-4 w-4"}),"فلوس الاكسسوار"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-blue-700 font-extrabold text-sm",children:K(Z)}),e.jsx(v,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800",onClick:()=>{q("accessory"),B(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-emerald-50 border border-emerald-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-800 font-bold text-sm",children:[e.jsx(De,{className:"h-4 w-4"}),"فلوس الصيانة"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-emerald-700 font-extrabold text-sm",children:K(ee)}),e.jsx(v,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800",onClick:()=>{q("maintenance"),B(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-red-800 font-bold text-sm",children:"خصم فلوس من الفلوس النقديه"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(v,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800",onClick:pe,children:"خصم"})})]})]}),e.jsx(ce,{open:he,onOpenChange:B,mode:"verify",title:"تأكيد الرقم السري لعملية تم الاستلام",description:"يرجى إدخال الرقم السري الرئيسي لتأكيد استلام المبلغ",onSuccess:()=>{W&&(fe(W),q(null)),B(!1)}}),e.jsx(G,{open:ue,onOpenChange:O,children:e.jsxs(H,{className:"sm:max-w-sm",children:[e.jsx(J,{children:e.jsx(Q,{children:"سبب الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"deduct-reason",children:"اكتب سبب الخصم"}),e.jsx(ae,{id:"deduct-reason",value:U,onChange:a=>L(a.target.value),placeholder:"سبب الخصم"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(v,{variant:"outline",onClick:()=>O(!1),children:"إلغاء"}),e.jsx(v,{onClick:be,className:"bg-red-600 hover:bg-red-700",children:"متابعة"})]})]})}),e.jsx(ce,{open:xe,onOpenChange:z,mode:"verify",title:"تأكيد الرقم السري لعملية الخصم",description:"يرجى إدخال الرقم السري الرئيسي لمتابعة الخصم",onSuccess:ye}),e.jsx(G,{open:ge,onOpenChange:R,children:e.jsxs(H,{className:"sm:max-w-sm",children:[e.jsx(J,{children:e.jsx(Q,{children:"مبلغ الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"deduct-amount",children:"أدخل مبلغ الخصم"}),e.jsx(ae,{id:"deduct-amount",type:"number",value:X,onChange:a=>Y(a.target.value),placeholder:"0.00"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(v,{variant:"outline",onClick:()=>R(!1),children:"إلغاء"}),e.jsx(v,{onClick:ve,className:"bg-red-600 hover:bg-red-700",children:"تأكيد الخصم"})]})]})})]})})};export{ke as CashSummaryDialog,ke as default};
//# sourceMappingURL=CashSummaryDialog-DR1rHn48.js.map
