const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-DKHjTn06.js","./index-VBQ-m3Jj.css","./dailyOperationCountService-9b-RCNij.js","./walletDailyLimitsService-DdjjL_Zn.js","./profitService-DRDD-Fph.js"])))=>i.map(i=>d[i]);
var Km=Object.defineProperty;var Ym=(i,p,d)=>p in i?Km(i,p,{enumerable:!0,configurable:!0,writable:!0,value:d}):i[p]=d;var ll=(i,p,d)=>Ym(i,typeof p!="symbol"?p+"":p,d);import{J as da,m as cc,n as dc,u as ja,r as n,c as Xs,j as e,W as ye,X as be,Y as ve,Z as we,B as h,aq as na,as as rn,bl as ii,ad as en,Q as Na,S as $s,a as mc,w as Ft,ar as vs,I as q,an as hc,av as uc,ae as Nt,bm as nn,U as ul,A as Hm,R as Ye,E as ps,v as rr,aJ as ar,y as Je,i as J,H as Qs,s as ct,f as jr,aa as tr,K as va,q as Ue,h as Ne,au as ie,k as Qe,$ as xc,z as Ls,bn as Gm,aC as us,_ as lt,ai as tn,p as Zs,ag as ln,aQ as li,a9 as Se,l as Kr,bo as sr,at as fl,O as Zt,aW as As,bp as pc,bq as Qm,br as Zm,a5 as gc,bs as Xm,a0 as eh,bt as th,a4 as sh,bu as ah,bv as rh,bw as nh,bx as fc,by as ih,bz as lh,T as nr,bA as yc,a8 as bs,aP as Qo,aV as bc,bB as oh,ah as ch,bC as Yr,F as dh,bD as Hr,am as mh,ak as Gr,aT as hh,aU as uh,bg as Zo,M as Xo,aS as Qr}from"./index-DKHjTn06.js";import{C as $t,a as ls,b as Ts,d as Wt}from"./card-CdZ89wHA.js";import{B as Gt}from"./badge-dOZ4uC2s.js";import{S as La,a as Wa,b as Fa,c as Ra,d as ra,C as sn,e as ei}from"./select-CNUPPz9r.js";import{L as X}from"./label-xK2gNCpt.js";import{M as xs,a as ws,P as xh}from"./MasterPinDialog-CZFMuEah.js";import{walletDailyLimitsService as Gs}from"./walletDailyLimitsService-DdjjL_Zn.js";import{W as ca}from"./wallet-CcB5ksMi.js";import{S as vc,a as ph}from"./star-Busk5wlQ.js";import{S as wc}from"./square-pen-DmKhyk8U.js";import{T as is,P as ec}from"./progress-CZUZSHBo.js";import{P as wa}from"./phone-Bfk7DEDM.js";import{A as Nc}from"./arrow-left-Dg0WTfXV.js";import{a as xl,S as gh}from"./separator-hqlx8nZp.js";import{calculateProfit as tc}from"./commissionCalculator-DbNVJv5a.js";import{C as Ua}from"./calendar-n6d7WDHa.js";import{C as si}from"./chart-column-u2WPvv2c.js";import{D as qt}from"./dollar-sign-CpfSiT3v.js";import{A as Xn,P as fh}from"./ProfileIcon-iQttrBlC.js";import{C as ir}from"./circle-alert--64_gie4.js";import{C as ai}from"./circle-x-DCthG7Az.js";import{C as za}from"./circle-check-big-zx-PzrIn.js";import{f as Ns,P as yh,C as jc,a as yl,A as ri,b as sc,I as bh,R as vh,c as wh,M as Nh}from"./MaintenanceDialog-BuCRnuhC.js";import{S as Sc}from"./store-CgAhD43e.js";import{R as jh,S as Sh}from"./switch-XqQIkNpM.js";import{a as Dh,E as Ch}from"./broadcastService-C3ebSkVb.js";import{B as ac,T as Ih}from"./textarea-BczUxm2s.js";import{D as Ah,a as Th,b as Ph,c as kh,d as _h}from"./dropdown-menu-C65evTPM.js";import{ProfitService as Ba}from"./profitService-DRDD-Fph.js";import{W as Oh}from"./WalletsManagement-BI1Chrrb.js";import{FreeTrialService as Eh}from"./freeTrialService-ntIHdrwZ.js";import{P as Mh,w as $h,b as rc,o as Lh,s as Wh}from"./walletSelectionPinService-CdDSQUNH.js";import{C as Fh}from"./crown-BorW8ZAE.js";import"./shield-BpPPeTvJ.js";import"./whatsappService-Ch9FyFNb.js";import"./download-C6bsx04M.js";import"./index-DyzQfDCv.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rh=da("Award",[["path",{d:"m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526",key:"1yiouv"}],["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nc=da("Banknote",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bh=da("BookOpen",[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Dc=da("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ni=da("IdCard",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pl=da("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ol=da("ListChecks",[["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}],["path",{d:"M13 6h8",key:"15sg57"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 18h8",key:"oe0vm4"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Uh=da("Notebook",[["path",{d:"M2 6h4",key:"aawbzj"}],["path",{d:"M2 10h4",key:"l0bgd4"}],["path",{d:"M2 14h4",key:"1gsvsf"}],["path",{d:"M2 18h4",key:"1bu2t1"}],["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["path",{d:"M16 2v20",key:"rotuqe"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xr=da("Package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["path",{d:"m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7",key:"yx3hmr"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ti=da("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),Cc=async(i={})=>{try{return(await cc(dc,"getLastTransactions")(i)).data}catch(p){throw console.error("Error getting last transactions:",p),p.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):p.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+p.message):p.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+p.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(p.message||"خطأ غير معروف"))}},zh=async i=>(await cc(dc,"sendTelegramMessage")(i)).data,qh=Object.freeze(Object.defineProperty({__proto__:null,getLastTransactions:Cc,sendTelegramMessage:zh},Symbol.toStringTag,{value:"Module"})),Vh=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Jh=({isOpen:i,onClose:p,onWalletSelect:d,onEditWallet:v,onDeleteWallet:N})=>{const{user:I}=ja(),[s,j]=n.useState([]),[B,C]=n.useState(!1),[L,M]=n.useState([]),[y,w]=n.useState(!1),{toast:O}=Xs(),G=async($,W)=>{const ge=new Date().getMonth(),De=new Date().getFullYear(),pe=W.filter(Ee=>{const He=new Date(Ee.createdAt);return He.getMonth()===ge&&He.getFullYear()===De&&(Ee.lineId===$||Ee.fromWallet===$)}),xe=Ee=>{const He=Ee.type;return Ee.txnType==="receive"||He==="withdraw"||He==="withdrawal"||He==="receive"},oe=Ee=>{const He=Ee.type;return Ee.txnType==="send"||He==="send"||He==="transfer"},We=pe.filter(xe).reduce((Ee,He)=>{const Ke=He.withdrawnAmount!==void 0?He.withdrawnAmount:He.amount;return Ee+(Ke||0)},0),Ve=pe.filter(oe).reduce((Ee,He)=>{const Ke=He.sentAmount!==void 0?He.sentAmount:He.amount;return Ee+(Ke||0)},0);return{withdrawalUsage:We,transferUsage:Ve}},R=$=>{const W=new Date().toISOString().split("T")[0],ge=$.lastResetDate;if(!ge)return{...$,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:W};const De=new Date(ge),pe=new Date;return De.getMonth()!==pe.getMonth()||De.getFullYear()!==pe.getFullYear()?{...$,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:W}:$};n.useEffect(()=>{if(!(I!=null&&I.uid)||!i)return;(async()=>{w(!0);try{const W=await na.getByMerchantId(I.uid),ge=await ii.getByUserId(I.uid),pe=(await Promise.all(W.map(async xe=>{const{withdrawalUsage:oe,transferUsage:We}=await G(xe.id,ge),Ve=await Gs.getWalletLimits(xe.id);return{id:xe.id,name:xe.label||"محفظة بدون اسم",phone:xe.msisdn,nationalId:xe.nationalId||"",isDefault:!1,isActive:xe.isActive===!0,monthlyWithdrawalLimit:(Ve==null?void 0:Ve.monthlyWithdrawLimit)??xe.withdrawLimit??2e5,monthlyTransferLimit:(Ve==null?void 0:Ve.monthlyTransferLimit)??xe.transferLimit??2e5,monthlyWithdrawalUsage:(Ve==null?void 0:Ve.monthlyWithdrawUsed)??oe??0,monthlyTransferUsage:(Ve==null?void 0:Ve.monthlyTransferUsed)??We??0,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:xe.walletProvider||""}}))).map(R);j(pe)}catch(W){console.error("Error loading wallets:",W),O({title:"فشل جلب بيانات المحافظ",description:"قد تكون المشكلة بسبب الصلاحيات أو الاتصال. سيتم عرض البيانات المحلية إن وُجدت. جرّب تسجيل الدخول مجددًا أو افتح صفحة اختبار المصادقة من القائمة.",variant:"destructive"})}finally{w(!1)}})()},[I==null?void 0:I.uid,i]);const Z=$=>Vh.find(W=>W.id===$),ae=($,W)=>W>0?Math.min($/W*100,100):0,de=$=>new Intl.NumberFormat("ar-EG").format($);return e.jsx(ye,{open:i,onOpenChange:p,children:e.jsxs(be,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ve,{className:"pb-4",children:[e.jsxs(we,{className:"flex items-center gap-2 text-lg",children:[e.jsx(ca,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(Gt,{variant:"secondary",className:"mr-2",children:[s.length," محفظة"]})]}),e.jsx("div",{className:"flex items-center gap-2 mt-2",children:B?e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",onClick:async()=>{try{if(!(I!=null&&I.uid))return;const $=s.map(W=>na.update(W.id,{isActive:L.includes(W.id)}));await Promise.all($),j(W=>W.map(ge=>({...ge,isActive:L.includes(ge.id)}))),C(!1),O({title:"تم تفعيل المحافظ",description:"فقط المحافظ المحددة ستظهر في الاختيار الخارجي"});try{window.dispatchEvent(new CustomEvent("wallets:activation-updated"))}catch{}}catch($){console.error("Error activating wallets:",$),O({title:"فشل التفعيل",description:"تعذر تفعيل المحافظ المحددة",variant:"destructive"})}},className:"h-7",children:"تفعيل المحافظ"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>{C(!1),M([])},className:"h-7",children:"إلغاء"})]}):e.jsx(h,{variant:"outline",size:"sm",onClick:()=>C(!0),className:"h-7",children:"تحديد المحافظ"})})]}),y?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):s.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ca,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:s.map($=>{const W=Z($.walletProvider||"");ae($.monthlyWithdrawalUsage||0,$.monthlyWithdrawalLimit),ae($.monthlyTransferUsage||0,$.monthlyTransferLimit);const ge=L.includes($.id),De=B?`cursor-pointer transition-shadow border-2 ${ge?"border-blue-500 shadow-lg":"hover:border-blue-300"}`:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300";return e.jsxs($t,{className:De,onClick:()=>{B?M(pe=>pe.includes($.id)?pe.filter(xe=>xe!==$.id):[...pe,$.id]):d($)},children:[e.jsx(ls,{className:"pb-3",children:e.jsxs(Ts,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(rn,{className:"h-4 w-4"}),e.jsx("span",{children:$.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[$.isActive&&e.jsx(Gt,{variant:"default",className:"text-xs",children:"نشطة"}),$.isDefault&&e.jsxs(Gt,{variant:"default",className:"text-xs",children:[e.jsx(vc,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(h,{variant:"ghost",size:"sm",onClick:pe=>{pe.stopPropagation(),v==null||v($)},className:"h-7 px-2",children:e.jsx(wc,{className:"h-4 w-4"})}),e.jsx(h,{variant:"ghost",size:"sm",onClick:pe=>{pe.stopPropagation(),N==null||N($.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(is,{className:"h-4 w-4"})})]})]})}),e.jsxs(Wt,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(wa,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:$.phone})]}),$.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ni,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:$.nationalId})]}),W&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Dc,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:W.name})]})]}),(()=>{const pe=$.monthlyWithdrawalLimit,xe=$.monthlyTransferLimit,oe=$.monthlyWithdrawalUsage||0,We=$.monthlyTransferUsage||0,Ve=Math.max(pe-oe,0),Ee=Math.max(xe-We,0);return e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{className:"text-xs text-gray-600 font-medium text-center",children:["الحدود الشهرية: ",(W==null?void 0:W.name)||$.walletProvider," - ",$.phone]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(oe/Math.max(pe,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(We/Math.max(xe,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",de(Ve)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",de(Ee)," جنيه"]})]})]})})(),e.jsx(h,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:pe=>{pe.stopPropagation(),d($)},children:"عرض التفاصيل الكاملة"})]})]},$.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(h,{onClick:p,variant:"outline",children:[e.jsx(Nc,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},Kh=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Yh=({wallet:i,isOpen:p,onClose:d,onBack:v})=>{const{user:N}=ja(),[I,s]=n.useState([]),[j,B]=n.useState(!1),[C,L]=n.useState("month"),{toast:M}=Xs();if(n.useEffect(()=>{if(!i||!(N!=null&&N.uid)||!p)return;(async()=>{B(!0);try{const st=(await ii.getByUserId(N.uid)).filter(le=>le.walletId===i.id).sort((le,Te)=>new Date(Te.createdAt).getTime()-new Date(le.createdAt).getTime());s(st)}catch(fe){console.error("Error loading transactions:",fe),M({title:"فشل جلب معاملات المحفظة",description:"قد تكون المشكلة بسبب صلاحيات Firestore أو الاتصال. تم عرض ما أمكن محليًا. جرّب تسجيل الدخول مجددًا أو صفحة اختبار المصادقة.",variant:"destructive"})}finally{B(!1)}})()},[i,N==null?void 0:N.uid,p]),!i)return null;const y=te=>Kh.find(fe=>fe.id===te),w=(te,fe)=>fe>0?Math.min(te/fe*100,100):0,O=te=>new Intl.NumberFormat("ar-EG").format(te),G=te=>new Date(te).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),Z=(()=>{const te=new Date;let fe;switch(C){case"week":fe=new Date(te.getTime()-7*24*60*60*1e3);break;case"month":fe=new Date(te.getFullYear(),te.getMonth(),1);break;default:return I}return I.filter(st=>new Date(st.createdAt)>=fe)})(),ae=te=>{const fe=te.type,st=te.txnType;return fe==="withdraw"||fe==="withdrawal"||fe==="receive"||st==="receive"},de=te=>{const fe=te.type,st=te.txnType;return fe==="send"||fe==="transfer"||st==="send"},$=Z.filter(te=>ae(te)&&te.status==="completed").reduce((te,fe)=>{const st=fe.withdrawnAmount!==void 0?fe.withdrawnAmount:fe.amount;return te+(st||0)},0),W=Z.filter(te=>de(te)&&te.status==="completed").reduce((te,fe)=>{const st=fe.sentAmount!==void 0?fe.sentAmount:fe.amount;return te+(st||0)},0),ge=Z.filter(te=>te.type==="deposit"&&te.status==="completed").reduce((te,fe)=>te+fe.amount,0),De=Z.filter(te=>te.status==="completed"),pe=De.length,xe=De.reduce((te,fe)=>{if(ae(fe)){const st=fe.withdrawnAmount??fe.receivedAmount??fe.amount??0;return te+tc(Number(st)||0,"receive")}if(de(fe)){const st=fe.sentAmount??fe.transferredAmount??fe.amount??0;return te+tc(Number(st)||0,"send")}return te},0),oe=y(i.walletProvider||""),We=w(i.monthlyWithdrawalUsage||0,i.monthlyWithdrawalLimit),Ve=w(i.monthlyTransferUsage||0,i.monthlyTransferLimit),Ee=te=>{switch(te){case"withdrawal":return e.jsx(ti,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(en,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx(qt,{className:"h-4 w-4 text-green-500"});default:return e.jsx(Xn,{className:"h-4 w-4 text-gray-500"})}},He=te=>{switch(te){case"completed":return e.jsx(za,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(Na,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(ai,{className:"h-4 w-4 text-red-500"});default:return e.jsx(ir,{className:"h-4 w-4 text-gray-500"})}},Ke=te=>{switch(te){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},dt=te=>{switch(te){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(ye,{open:p,onOpenChange:d,children:e.jsxs(be,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ve,{className:"pb-4",children:e.jsxs(we,{className:"flex items-center gap-2 text-lg",children:[e.jsx(rn,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",i.name,i.isDefault&&e.jsxs(Gt,{variant:"default",className:"mr-2",children:[e.jsx(vc,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs($t,{children:[e.jsx(ls,{children:e.jsxs(Ts,{className:"text-sm flex items-center gap-2",children:[e.jsx(ni,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(Wt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(wa,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.phone})]}),i.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ni,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.nationalId})]}),oe&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Dc,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:oe.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",oe.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",oe.nationalId]})]})]}),i.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ua,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(i.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs($t,{children:[e.jsx(ls,{children:e.jsxs(Ts,{className:"text-sm flex items-center gap-2",children:[e.jsx(si,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(Wt,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ti,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[O(i.monthlyWithdrawalUsage||0)," / ",O(i.monthlyWithdrawalLimit)]})]}),e.jsx(ec,{value:We,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",O(i.monthlyWithdrawalLimit-(i.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(xl,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(en,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[O(i.monthlyTransferUsage||0)," / ",O(i.monthlyTransferLimit)]})]}),e.jsx(ec,{value:Ve,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",O(i.monthlyTransferLimit-(i.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx($t,{children:e.jsxs(Wt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(ti,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:O($)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx($t,{children:e.jsxs(Wt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(en,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:O(W)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx($t,{children:e.jsxs(Wt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(qt,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:O(ge)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})}),e.jsx($t,{children:e.jsxs(Wt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(si,{className:"h-5 w-5 text-emerald-600"})}),e.jsx("div",{className:"text-lg font-bold",children:O(xe)}),e.jsx("div",{className:"text-xs text-gray-600",children:"أرباح الفترة"})]})}),e.jsx($t,{children:e.jsxs(Wt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Xn,{className:"h-5 w-5 text-purple-600"})}),e.jsx("div",{className:"text-lg font-bold",children:O(pe)}),e.jsx("div",{className:"text-xs text-gray-600",children:"عدد العمليات"})]})})]}),e.jsxs($t,{children:[e.jsx(ls,{children:e.jsxs(Ts,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Xn,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{size:"sm",variant:C==="week"?"default":"outline",onClick:()=>L("week"),className:"text-xs",children:"أسبوع"}),e.jsx(h,{size:"sm",variant:C==="month"?"default":"outline",onClick:()=>L("month"),className:"text-xs",children:"شهر"}),e.jsx(h,{size:"sm",variant:C==="all"?"default":"outline",onClick:()=>L("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(Wt,{children:j?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):Z.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Xn,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:Z.map(te=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[Ee(te.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[Ke(te.type)," - ",O(te.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:G(te.createdAt)}),te.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:te.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[He(te.status),e.jsx("span",{className:"text-xs",children:dt(te.status)})]})]},te.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(h,{onClick:v,variant:"outline",children:[e.jsx(Nc,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(h,{onClick:d,variant:"outline",children:"إغلاق"})]})]})})},cl=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Hh=({isOpen:i,onClose:p,onWalletUpdate:d,initialEditingWallet:v})=>{const{toast:N}=Xs(),{user:I,userSubscription:s}=ja();(()=>{var Pe,ft;const F=((Pe=s==null?void 0:s.subscription)==null?void 0:Pe.planType)??((ft=s==null?void 0:s.subscription)==null?void 0:ft.plan)??(s==null?void 0:s.planType)??(s==null?void 0:s.plan)??null,ue=typeof F=="string"?String(F).trim().toLowerCase():null;return F===$s.TAHWEELA||ue==="tahweela"||ue==="تحويله"})();const j=mc(),[B,C]=n.useState([]),[L,M]=n.useState(!1),[y,w]=n.useState(null),[O,G]=n.useState(""),[R,Z]=n.useState(""),[ae,de]=n.useState(""),[$,W]=n.useState(""),[ge,De]=n.useState("200000"),[pe,xe]=n.useState("200000"),[oe,We]=n.useState("100000"),[Ve,Ee]=n.useState("60000"),[He,Ke]=n.useState(!1),[dt,te]=n.useState(null),[fe,st]=n.useState(!1),[le,Te]=n.useState(!1),[xt,Vt]=n.useState(!1),[kt,Jt]=n.useState(null),Oe=()=>`wallets_${(I==null?void 0:I.uid)||"default"}`;n.useEffect(()=>{v&&(w(v),M(!0),G(v.name||""),Z(v.phone||""),de(v.nationalId||""),W(v.walletProvider||""),De((v.monthlyWithdrawalLimit||2e5).toString()),xe((v.monthlyTransferLimit||2e5).toString()),We((v.dailyWithdrawalLimit||1e5).toString()),Ee((v.dailyTransferLimit||6e4).toString()),Ke(!!v.isDefault))},[v]);const et=F=>{const ue=new Date,Pe=ue.getMonth(),ft=ue.getFullYear();if(!F.lastResetDate)return{...F,monthlyWithdrawalUsage:F.monthlyWithdrawalUsage||0,monthlyTransferUsage:F.monthlyTransferUsage||0,lastResetDate:ue.toISOString().split("T")[0]};const ot=new Date(F.lastResetDate),es=ot.getMonth(),os=ot.getFullYear();return Pe!==es||ft!==os?{...F,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:ue.toISOString().split("T")[0]}:F},mt=async(F,ue)=>{const Pe=new Date().getMonth(),ft=new Date().getFullYear(),ot=ue.filter(vt=>{const Ze=new Date(vt.createdAt);return Ze.getMonth()===Pe&&Ze.getFullYear()===ft&&vt.lineId===F}),es=ot.filter(vt=>vt.txnType==="receive").reduce((vt,Ze)=>vt+(Ze.amount||0),0),os=ot.filter(vt=>vt.txnType==="send").reduce((vt,Ze)=>vt+(Ze.amount||0),0);return{withdrawalUsage:es,transferUsage:os}},Ie=async(F,ue)=>{const Pe=new Date,ft=Pe.getDate(),ot=Pe.getMonth(),es=Pe.getFullYear(),os=ue.filter(Tt=>{const Lt=new Date(Tt.createdAt);return Lt.getDate()===ft&&Lt.getMonth()===ot&&Lt.getFullYear()===es&&Tt.lineId===F}),vt=os.filter(Tt=>Tt.txnType==="receive").reduce((Tt,Lt)=>Tt+(Lt.amount||0),0),Ze=os.filter(Tt=>Tt.txnType==="send").reduce((Tt,Lt)=>Tt+(Lt.amount||0),0);return{withdrawalUsage:vt,transferUsage:Ze}};n.useEffect(()=>{(async()=>{if(!(I!=null&&I.uid)){console.log("No user authenticated, skipping wallet loading"),st(!1);return}console.log("Loading wallets for user:",I.uid),st(!0);try{const{auth:ue}=await Nt(async()=>{const{auth:Ze}=await import("./index-DKHjTn06.js").then(Tt=>Tt.bI);return{auth:Ze}},__vite__mapDeps([0,1]),import.meta.url);let Pe=0;const ft=5;for(;!ue.currentUser&&Pe<ft;)console.log(`Waiting for auth state... attempt ${Pe+1}`),await new Promise(Ze=>setTimeout(Ze,1e3)),Pe++;if(!ue.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",ue.currentUser.uid),console.log("Context User:",I.uid),console.log("Fetching wallets from Firebase...");const ot=await na.getByMerchantId(I.uid);console.log("Fetched wallets:",ot),console.log("Fetching transactions from Firebase...");const es=await ii.getByUserId(I.uid);console.log("Fetched transactions:",es);const vt=(await Promise.all(ot.map(async Ze=>{const{withdrawalUsage:Tt,transferUsage:Lt}=await mt(Ze.id,es),{withdrawalUsage:ea,transferUsage:Rt}=await Ie(Ze.id,es);return{id:Ze.id,name:Ze.label||"محفظة بدون اسم",phone:Ze.msisdn,isDefault:!1,monthlyWithdrawalLimit:Ze.withdrawLimit||2e5,monthlyTransferLimit:Ze.transferLimit||2e5,dailyWithdrawalLimit:Ze.dailyWithdrawLimit||1e5,dailyTransferLimit:Ze.dailyTransferLimit||6e4,monthlyWithdrawalUsage:Tt,monthlyTransferUsage:Lt,dailyWithdrawalUsage:ea,dailyTransferUsage:Rt,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:Ze.defaultTransferCommission!=null?Number(Ze.defaultTransferCommission):null,defaultWithdrawCommission:Ze.defaultWithdrawCommission!=null?Number(Ze.defaultWithdrawCommission):null}}))).map(et);C(vt),console.log("Wallets loaded successfully:",vt)}catch(ue){console.error("Error loading wallets:",ue),C([])}finally{st(!1)}})()},[I==null?void 0:I.uid]);const ht=()=>{G(""),Z(""),de(""),W(""),De("200000"),xe("200000"),We("100000"),Ee("60000"),Ke(!1),w(null),M(!1)},D=async()=>{if(!O.trim()||!R.trim()||!$.trim()){N({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(I!=null&&I.uid)){N({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}st(!0);try{if(y){await na.update(y.id,{label:O.trim(),msisdn:R.trim(),withdrawLimit:parseInt(ge),transferLimit:parseInt(pe),dailyWithdrawLimit:parseInt(oe),dailyTransferLimit:parseInt(Ve)}),await Gs.setLimits(y.id,{dailyTransferLimit:parseInt(Ve||"0"),dailyWithdrawLimit:parseInt(oe||"0"),monthlyTransferLimit:parseInt(pe||"0"),monthlyWithdrawLimit:parseInt(ge||"0")});const F=B.map(ue=>ue.id===y.id?{...ue,name:O.trim(),phone:R.trim(),nationalId:ae.trim(),walletProvider:$,monthlyWithdrawalLimit:parseInt(ge),monthlyTransferLimit:parseInt(pe),dailyWithdrawalLimit:parseInt(oe),dailyTransferLimit:parseInt(Ve)}:ue);C(F),localStorage.setItem(Oe(),JSON.stringify(F)),N({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const F={merchantUserId:I.uid,provider:$,msisdn:R.trim(),label:O.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(ge),transferLimit:parseInt(pe),dailyTransferLimit:parseInt(Ve),dailyWithdrawLimit:parseInt(oe),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},ue=await na.create(F);await Gs.setLimits(ue,{dailyTransferLimit:parseInt(Ve||"0"),dailyWithdrawLimit:parseInt(oe||"0"),monthlyTransferLimit:parseInt(pe||"0"),monthlyWithdrawLimit:parseInt(ge||"0")});const Pe=new Date().toISOString().split("T")[0],ft={id:ue,name:O.trim(),phone:R.trim(),nationalId:ae.trim(),walletProvider:$,isDefault:He,monthlyWithdrawalLimit:parseInt(ge),monthlyTransferLimit:parseInt(pe),dailyWithdrawalLimit:parseInt(oe),dailyTransferLimit:parseInt(Ve),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:Pe,defaultTransferCommission:null,defaultWithdrawCommission:null},ot=[...B,ft];C(ot),localStorage.setItem(Oe(),JSON.stringify(ot)),N({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}d&&d(),ht(),M(!1),w(null)}catch(F){console.error("Error saving wallet:",F),N({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{st(!1)}},bt=F=>{w(F),G(F.name),Z(F.phone),de(F.nationalId||""),W(F.walletProvider||""),De(F.monthlyWithdrawalLimit.toString()),xe(F.monthlyTransferLimit.toString()),Ke(F.isDefault),M(!0)},_t=async F=>{const ue=B.find(Pe=>Pe.id===F);if(ue!=null&&ue.isDefault){N({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(I!=null&&I.uid)){N({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}st(!0);try{await na.delete(F);const Pe=B.filter(ft=>ft.id!==F);C(Pe),localStorage.setItem(Oe(),JSON.stringify(Pe)),d&&d(),N({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(Pe){console.error("Error deleting wallet:",Pe),N({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{st(!1)}},At=F=>{const ue=B.map(Pe=>({...Pe,isDefault:Pe.id===F}));C(ue),localStorage.setItem(Oe(),JSON.stringify(ue)),d&&d(),N({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(ye,{open:i,onOpenChange:p,children:[e.jsxs(be,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(ve,{className:"pb-2",children:e.jsxs(we,{className:"flex items-center gap-1 text-sm",children:[e.jsx(ca,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",B.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{onClick:()=>{Vt(!0)},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(Ft,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(h,{onClick:()=>{p(),j("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(vs,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),(L||y)&&e.jsxs($t,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx(ls,{className:"pb-1",children:e.jsx(Ts,{className:"text-sm",children:y?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(Wt,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(La,{value:$,onValueChange:W,children:[e.jsx(Wa,{className:"h-6 text-xs flex-1",children:e.jsx(Fa,{placeholder:"اختر شركة المحفظة"})}),e.jsx(Ra,{children:cl.map(F=>e.jsx(ra,{value:F.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:F.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:ue=>{ue.preventDefault(),ue.stopPropagation(),te(F.id)},children:e.jsx(pl,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},F.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx(q,{value:O,onChange:F=>G(F.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx(wa,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{value:R,onChange:F=>Z(F.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx(ni,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{value:ae,onChange:F=>de(F.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(qt,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{type:"number",value:ge,onChange:F=>De(F.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(qt,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{type:"number",value:pe,onChange:F=>xe(F.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(ti,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx(q,{type:"number",value:oe,onChange:F=>We(F.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(en,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx(q,{type:"number",value:Ve,onChange:F=>Ee(F.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:He,onChange:F=>Ke(F.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(hc,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(h,{onClick:D,className:"flex-1 h-6 text-xs",size:"sm",children:y?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(h,{variant:"outline",onClick:ht,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:B.map(F=>{var ue;return e.jsxs($t,{className:`${F.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx(ls,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ts,{className:"text-sm flex items-center gap-1",children:[e.jsx(ca,{className:"h-3 w-3"}),F.name]}),F.isDefault&&e.jsx(Gt,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(Wt,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(wa,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:F.phone})]}),F.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((ue=cl.find(Pe=>Pe.id===F.walletProvider))==null?void 0:ue.name)||F.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((F.monthlyWithdrawalUsage||0)/F.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((F.monthlyTransferUsage||0)/F.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(F.monthlyWithdrawalLimit-(F.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(F.monthlyTransferLimit-(F.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((F.dailyWithdrawalUsage||0)/F.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((F.dailyTransferUsage||0)/F.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify بين items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(F.dailyWithdrawalLimit-(F.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(F.dailyTransferLimit-(F.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(h,{size:"sm",variant:"outline",onClick:()=>bt(F),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(wc,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!F.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",variant:"outline",onClick:()=>At(F.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(h,{size:"sm",variant:"destructive",onClick:()=>_t(F.id),className:"h-5 px-1",children:e.jsx(is,{className:"h-2 w-2"})})]})]})]})]},F.id)})}),B.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),dt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>te(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(uc,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const F=cl.find(ue=>ue.id===dt);return F?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:F.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:F.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:F.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(pl,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(xs,{open:xt,onOpenChange:Vt,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Vt(!1),Te(!0)}}),e.jsx(Jh,{isOpen:le,onClose:()=>Te(!1),onWalletSelect:F=>{Jt(F),Te(!1)},onEditWallet:F=>{j(`/user/add-wallet?edit=1&id=${F.id}`),Te(!1)},onDeleteWallet:async F=>{try{if(await na.delete(F),C(ue=>{const Pe=ue.filter(ft=>ft.id!==F);try{localStorage.setItem(Oe(),JSON.stringify(Pe))}catch(ft){console.error("Failed to update localStorage wallets after delete:",ft)}return Pe}),d)try{await d()}catch(ue){console.error("onWalletUpdate callback failed:",ue)}}catch(ue){console.error("Error deleting wallet:",ue)}}}),e.jsx(Yh,{wallet:kt,isOpen:!!kt,onClose:()=>Jt(null),onBack:()=>{Jt(null),Te(!0)}})]})},Gh=({isOpen:i,onClose:p,transaction:d,onDelete:v})=>{if(!d)return null;const N=C=>{switch(C){case"completed":return e.jsx(za,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(Na,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(ai,{className:"h-5 w-5 text-red-500"});default:return e.jsx(Na,{className:"h-5 w-5 text-gray-500"})}},I=C=>{switch(C){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},s=C=>{switch(C){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},j=()=>{const C=!!d.senderNumber,L=!!d.senderName,M=C?"الرقم المرسل:":L?"الرقم الراسل:":"رقم المحفظة:",y=C?d.senderNumber:L?d.senderName:d.senderPhone,w=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${d.transactionReference||d.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${d.merchantShopName||d.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${s(d.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${d.status==="completed"?"#16a34a":d.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${I(d.status)}
            </span>
          </div>

          ${d!=null&&d.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${d.cashierName}</span>
            </div>
          `:""}
          
          ${d.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${M}</span>
              <span style="color: #1e293b;">${y}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${d.receiverNumber||d.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${Ns(d.transferredAmount||d.amount)} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${d.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${Ns(d.withdrawnAmountDetailed||d.withdrawnAmount||d.amount)} جنيه</span>
            </div>
          `}
          
          ${d.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${Ns(d.commission||0)} جنيه</span>
            </div>
          `:""}
          ${d.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الربح:</span>
              <span style="color: #16a34a; font-weight: 600;">${Ns(d.commission||0)} جنيه</span>
            </div>
          `:""}
          ${d!=null&&d.fee&&Number(d.fee)>0?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرسوم:</span>
              <span style="color: #64748b; font-weight: 600;">${Ns(d.fee||0)} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${d.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${d.type==="withdraw"?"-":""}${Ns(d.amount)} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,O=window.open("","_blank");O&&(O.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${d.transactionReference||d.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${w}
          </body>
        </html>
      `),O.document.close(),O.print())},B=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(v(d.id),p())};return e.jsx(ye,{open:i,onOpenChange:p,children:e.jsxs(be,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ve,{children:e.jsxs(we,{className:"flex items-center gap-2 text-xl",children:[e.jsx(nn,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx($t,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs(ls,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[N(d.status),e.jsx(Gt,{variant:d.status==="completed"?"default":"secondary",className:"text-sm",children:I(d.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[d.type==="withdraw"?"-":"",Ns(d.amount)," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",d.transactionReference||d.id]})]})}),e.jsxs($t,{children:[e.jsx(ls,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Sc,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(Wt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:d.merchantShopName||d.shopName||"غير محدد"})]}),(d==null?void 0:d.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:d.cashierName})]})]})]}),e.jsxs($t,{children:[e.jsx(ls,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(rn,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(Wt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(Gt,{variant:"outline",className:"bg-blue-100 text-blue-800",children:s(d.type)})]}),d.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const C=!!d.senderNumber,L=!!d.senderName,M=C?"الرقم المرسل:":L?"الرقم الراسل:":"رقم المحفظة:",y=C?d.senderNumber:L?d.senderName:d.senderPhone,w=C?ul:wa;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:M})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:y})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(Hm,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ul,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:d.receiverNumber||d.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qt,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[Ns(d.transferredAmount||d.amount)," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(wa,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:d.senderPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qt,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[Ns(d.withdrawnAmountDetailed||d.withdrawnAmount||d.amount)," جنيه"]})]})]}),d.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[d.commission," جنيه"]})]}),d.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-green-700",children:"الربح:"}),e.jsxs("span",{className:"text-green-900 font-semibold",children:[d.commission," جنيه"]})]}),(d==null?void 0:d.fee)&&Number(d.fee)>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الرسوم:"}),e.jsxs("span",{className:"text-gray-900 font-semibold",children:[d.fee," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ua,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:d.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(h,{onClick:j,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx(yh,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(h,{onClick:B,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(is,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(h,{onClick:p,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function ic({open:i,onOpenChange:p,onSuccess:d,title:v,description:N,currentBalance:I,balanceLabel:s,userId:j}){const[B,C]=n.useState(""),[L,M]=n.useState(I.toString()),[y,w]=n.useState(!1),[O,G]=n.useState(""),[R,Z]=n.useState(!1),ae=async $=>{$.preventDefault(),G(""),Z(!0);try{const W=parseFloat(L);if(isNaN(W)||W<0){G("يرجى إدخال مبلغ صحيح"),Z(!1);return}await ws.hasMasterPin(j)?await ws.verifyMasterPin(B,j)?(d(W),p(!1),C(""),M("")):G("الرقم السري غير صحيح"):G("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{G("حدث خطأ أثناء التحقق من الرقم السري")}finally{Z(!1)}},de=()=>{C(""),M(I.toString()),G(""),p(!1)};return Ye.useEffect(()=>{i&&M(I.toString())},[I,i]),e.jsx(ye,{open:i,onOpenChange:de,children:e.jsxs(be,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ve,{children:e.jsxs(we,{className:"flex items-center gap-2 text-right",children:[e.jsx(qt,{className:"h-5 w-5"}),v]})}),e.jsxs("form",{onSubmit:ae,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:N}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(X,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[I.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx(q,{id:"newAmount",type:"number",step:"0.01",min:"0",value:L,onChange:$=>M($.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"pin",type:y?"text":"password",value:B,onChange:$=>C($.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>w(!y),children:y?e.jsx(ps,{className:"h-4 w-4"}):e.jsx(Ft,{className:"h-4 w-4"})})]})]}),O&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(ir,{className:"h-4 w-4"}),O]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(h,{type:"button",variant:"outline",onClick:de,className:"flex-1",children:"إلغاء"}),e.jsx(h,{type:"submit",disabled:R||!B||!L,className:"flex-1",children:R?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(rr,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class an{static getSecretKey(p){return p?`${this.SECRET_KEY_BASE}_${p}`:this.SECRET_KEY_BASE}static setSecretPin(p,d){const v=btoa(p);this.secretCache.set(this.getSecretKey(d),v)}static hasSecretPin(p){return this.secretCache.has(this.getSecretKey(p))}static verifySecretPin(p,d){const v=this.secretCache.get(this.getSecretKey(d));if(!v)return!1;try{return atob(v)===p}catch{return!1}}static clearSecretPin(p){this.secretCache.delete(this.getSecretKey(p))}}ll(an,"SECRET_KEY_BASE","dashboard_secret_pin"),ll(an,"secretCache",new Map);function Qh({open:i,onOpenChange:p,userId:d}){const[v,N]=n.useState(""),[I,s]=n.useState(""),[j,B]=n.useState(""),[C,L]=n.useState(!1),[M,y]=n.useState(!1),[w,O]=n.useState(!1),[G,R]=n.useState(""),[Z,ae]=n.useState(!1),{toast:de}=Xs(),$=an.hasSecretPin(d),W=async De=>{De.preventDefault(),R(""),ae(!0);try{if(!I||I.length<4){R("يجب أن يكون الرقم السري 4 أرقام على الأقل"),ae(!1);return}if(I!==j){R("الرقم السري الجديد وتأكيده غير متطابقين"),ae(!1);return}if($){if(!v){R("يرجى إدخال الرقم السري الحالي"),ae(!1);return}if(!an.verifySecretPin(v,d)){R("الرقم السري الحالي غير صحيح"),ae(!1);return}}an.setSecretPin(I,d),de({title:$?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:$?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),ge()}catch{R("حدث خطأ أثناء حفظ الرقم السري")}finally{ae(!1)}},ge=()=>{N(""),s(""),B(""),R(""),L(!1),y(!1),O(!1),p(!1)};return e.jsx(ye,{open:i,onOpenChange:ge,children:e.jsxs(be,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ve,{children:e.jsxs(we,{className:"flex items-center gap-2 text-right",children:[e.jsx(hc,{className:"h-5 w-5"}),$?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:W,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:$?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),$&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"currentPin",type:C?"text":"password",autoComplete:"off",value:v,onChange:De=>N(De.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>L(!C),children:C?e.jsx(ps,{className:"h-4 w-4"}):e.jsx(Ft,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"newPin",type:M?"text":"password",autoComplete:"off",value:I,onChange:De=>s(De.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!M),children:M?e.jsx(ps,{className:"h-4 w-4"}):e.jsx(Ft,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:w?"text":"password",autoComplete:"off",value:j,onChange:De=>B(De.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>O(!w),children:w?e.jsx(ps,{className:"h-4 w-4"}):e.jsx(Ft,{className:"h-4 w-4"})})]})]}),G&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(ir,{className:"h-4 w-4"}),G]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:Z,className:"flex-1",children:[e.jsx(rr,{className:"h-4 w-4 mr-2"}),Z?"جاري الحفظ...":$?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(h,{type:"button",variant:"outline",onClick:ge,disabled:Z,children:"إلغاء"})]})]})]})})}const dl=new Map;function Zh({open:i,onOpenChange:p,userId:d}){const[v,N]=n.useState(""),[I,s]=n.useState(""),[j,B]=n.useState(""),[C,L]=n.useState(!1),[M,y]=n.useState(!1),[w,O]=n.useState(!1),[G,R]=n.useState(""),[Z,ae]=n.useState(!1),{toast:de}=Xs(),$=d?`cash_drawer_pin_${d}`:"cash_drawer_pin",W=()=>dl.has($),ge=oe=>{const We=dl.get($);if(!We)return!1;try{return atob(We)===oe}catch{return!1}},De=oe=>{const We=btoa(oe);dl.set($,We)},pe=async oe=>{oe.preventDefault(),R(""),ae(!0);try{if(!I||I.length<4){R("يجب أن يكون الرقم السري 4 أرقام على الأقل"),ae(!1);return}if(I!==j){R("الرقم السري الجديد وتأكيده غير متطابقين"),ae(!1);return}if(W()){if(!v){R("يرجى إدخال الرقم السري الحالي لدرج النقدية"),ae(!1);return}if(!ge(v)){R("الرقم السري الحالي لدرج النقدية غير صحيح"),ae(!1);return}}De(I),de({title:W()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:W()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),xe()}catch{R("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{ae(!1)}},xe=()=>{N(""),s(""),B(""),R(""),L(!1),y(!1),O(!1),p(!1)};return e.jsx(ye,{open:i,onOpenChange:xe,children:e.jsxs(be,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ve,{children:e.jsxs(we,{className:"flex items-center gap-2 text-right",children:[e.jsx(qt,{className:"h-5 w-5 text-green-600"}),W()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:pe,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:W()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),W()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"currentPin",type:C?"text":"password",autoComplete:"off",value:v,onChange:oe=>N(oe.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>L(!C),children:C?e.jsx(ps,{className:"h-4 w-4"}):e.jsx(Ft,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"newPin",type:M?"text":"password",autoComplete:"off",value:I,onChange:oe=>s(oe.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!M),children:M?e.jsx(ps,{className:"h-4 w-4"}):e.jsx(Ft,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:w?"text":"password",autoComplete:"off",value:j,onChange:oe=>B(oe.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>O(!w),children:w?e.jsx(ps,{className:"h-4 w-4"}):e.jsx(Ft,{className:"h-4 w-4"})})]})]}),G&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(ir,{className:"h-4 w-4"}),G]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:Z,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(rr,{className:"h-4 w-4 mr-2"}),Z?"جاري الحفظ...":W()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(h,{type:"button",variant:"outline",onClick:xe,disabled:Z,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}const ml=new Map;function Xh({open:i,onOpenChange:p,userId:d}){const[v,N]=n.useState(""),[I,s]=n.useState(""),[j,B]=n.useState(""),[C,L]=n.useState(!1),[M,y]=n.useState(!1),[w,O]=n.useState(!1),[G,R]=n.useState(""),[Z,ae]=n.useState(!1),{toast:de}=Xs(),$=d?`wallet_total_pin_${d}`:"wallet_total_pin",W=()=>ml.has($),ge=oe=>{const We=ml.get($);if(!We)return!1;try{return atob(We)===oe}catch{return!1}},De=oe=>{const We=btoa(oe);ml.set($,We)},pe=async oe=>{oe.preventDefault(),R(""),ae(!0);try{if(!I||I.length<4){R("يجب أن يكون الرقم السري 4 أرقام على الأقل"),ae(!1);return}if(I!==j){R("الرقم السري الجديد وتأكيده غير متطابقين"),ae(!1);return}if(W()){if(!v){R("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),ae(!1);return}if(!ge(v)){R("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),ae(!1);return}}De(I),de({title:W()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:W()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),xe()}catch{R("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{ae(!1)}},xe=()=>{N(""),s(""),B(""),R(""),L(!1),y(!1),O(!1),p(!1)};return e.jsx(ye,{open:i,onOpenChange:xe,children:e.jsxs(be,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ve,{children:e.jsxs(we,{className:"flex items-center gap-2 text-right",children:[e.jsx(ca,{className:"h-5 w-5 text-blue-600"}),W()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:pe,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:W()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),W()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"currentPin",type:C?"text":"password",autoComplete:"off",value:v,onChange:oe=>N(oe.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>L(!C),children:C?e.jsx(ps,{className:"h-4 w-4"}):e.jsx(Ft,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"newPin",type:M?"text":"password",autoComplete:"off",value:I,onChange:oe=>s(oe.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!M),children:M?e.jsx(ps,{className:"h-4 w-4"}):e.jsx(Ft,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:w?"text":"password",autoComplete:"off",value:j,onChange:oe=>B(oe.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>O(!w),children:w?e.jsx(ps,{className:"h-4 w-4"}):e.jsx(Ft,{className:"h-4 w-4"})})]})]}),G&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(ir,{className:"h-4 w-4"}),G]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:Z,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(rr,{className:"h-4 w-4 mr-2"}),Z?"جاري الحفظ...":W()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(h,{type:"button",variant:"outline",onClick:xe,disabled:Z,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function eu({open:i,onOpenChange:p,onSuccess:d,title:v,description:N,currentBalance:I,balanceLabel:s,userId:j}){const[B,C]=n.useState(""),[L,M]=n.useState(""),[y,w]=n.useState("add"),[O,G]=n.useState(!1),[R,Z]=n.useState(""),[ae,de]=n.useState(!1),[$,W]=n.useState(!1);n.useEffect(()=>{let xe=!0;return(async()=>{const oe=await ws.hasMasterPin(j);xe&&W(oe)})(),()=>{xe=!1}},[j,i]);const ge=async xe=>{xe.preventDefault(),Z(""),de(!0);try{const oe=parseFloat(L);if(isNaN(oe)||oe<=0){Z("يرجى إدخال مبلغ صحيح أكبر من صفر"),de(!1);return}if(y==="subtract"&&oe>I){Z("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),de(!1);return}if($)if(await ws.verifyMasterPin(B,j)){const Ve=y==="add"?oe:-oe;De(),d(Ve)}else Z("الرقم السري غير صحيح");else Z("لم يتم تعيين الرقم السري الرئيسي. يرجى تعيينه من إعدادات البروفيل أولاً")}catch{Z("حدث خطأ أثناء التحقق من الرقم السري")}finally{de(!1)}},De=()=>{C(""),M(""),w("add"),Z(""),p(!1)},pe=()=>{const xe=parseFloat(L)||0;return y==="add"?I+xe:I-xe};return e.jsx(ye,{open:i,onOpenChange:De,children:e.jsxs(be,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ve,{children:e.jsxs(we,{className:"flex items-center gap-2 text-right",children:[y==="add"?e.jsx(vs,{className:"h-5 w-5 text-green-600"}):e.jsx(ar,{className:"h-5 w-5 text-red-600"}),v]})}),e.jsxs("form",{onSubmit:ge,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:N}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(X,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[I.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{type:"button",variant:y==="add"?"default":"outline",onClick:()=>w("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(vs,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(h,{type:"button",variant:y==="subtract"?"default":"outline",onClick:()=>w("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(ar,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(X,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",y==="add"?"إضافته":"خصمه"]}),e.jsx(q,{id:"amount",type:"number",step:"0.01",min:"0.01",value:L,onChange:xe=>M(xe.target.value),placeholder:`أدخل المبلغ المراد ${y==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),L&&!isNaN(parseFloat(L))&&e.jsxs("div",{className:`p-3 rounded-lg ${y==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(X,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${y==="add"?"text-green-700":"text-red-700"}`,children:[pe().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"pin",type:O?"text":"password",autoComplete:"off",value:B,onChange:xe=>C(xe.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>G(!O),children:O?e.jsx(ps,{className:"h-4 w-4"}):e.jsx(Ft,{className:"h-4 w-4"})})]})]}),R&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(ir,{className:"h-4 w-4"}),R]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(h,{type:"button",variant:"outline",onClick:De,className:"flex-1",children:"إلغاء"}),e.jsx(h,{type:"submit",disabled:ae||!B||!L,className:`flex-1 ${y==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:ae?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(rr,{className:"h-4 w-4 mr-2"}),y==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}const lc={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_APP_VERSION:"0.0.0",VITE_DEV_MODE:"true",VITE_ENABLE_OFFLINE_PERSISTENCE:"false",VITE_FIREBASE_API_KEY:"AIzaSyA33RTf43u2QE2OsK1RepQHSKrSet9ZI0s",VITE_FIREBASE_APP_ID:"1:483702062341:web:b1ff06ad175cb7ae428b6c",VITE_FIREBASE_AUTH_DOMAIN:"voda-c6abd.firebaseapp.com",VITE_FIREBASE_AUTH_EMULATOR_URL:"http://localhost:9099",VITE_FIREBASE_FIRESTORE_EMULATOR_HOST:"localhost:8080",VITE_FIREBASE_FUNCTIONS_EMULATOR_HOST:"localhost:5001",VITE_FIREBASE_MEASUREMENT_ID:"G-CV6QGH7G7P",VITE_FIREBASE_MESSAGING_SENDER_ID:"483702062341",VITE_FIREBASE_PROJECT_ID:"voda-c6abd",VITE_FIREBASE_STORAGE_BUCKET:"voda-c6abd.appspot.com",VITE_FORCE_HASH_ROUTER:"true",VITE_SHOP_ID:"demo-shop-001",VITE_SHOP_NAME:"محل كاشي لينك التجريبي",VITE_SHOW_ENV_BANNER:"true",VITE_USE_EMULATORS:"false",VITE_USE_FIREBASE_EMULATOR:"false"},Ma=i=>typeof i=="string"&&i.trim().length>0,tu={getCurrentMonthId(){const i=new Date;return`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}`},async getWalletUsage(i){var p;try{if(!Ma(i))return console.error("Error getting wallet usage: invalid walletId",i),null;const d=Je(J,"walletLimits",i),v=await va(d);if(v.exists()){const I=v.data();return{walletId:i,used_transfer:I.monthlyTransferUsed??I.used_transfer??0,used_withdraw:I.monthlyWithdrawUsed??I.used_withdraw??0,monthly_limit:I.monthlyLimit??I.monthlyTransferLimit??I.monthlyWithdrawLimit??2e5,last_reset:I.lastMonthlyReset??I.last_reset??null,updatedAt:I.updatedAt||tr.now()}}const N={walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:tr.now()};return await Qs(d,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,monthlyTransferLimit:2e5,monthlyWithdrawLimit:2e5,lastMonthlyReset:null,updatedAt:ct(),ownerId:(p=jr.currentUser)==null?void 0:p.uid}),N}catch(d){return console.error("Error getting wallet usage:",d),{walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:tr.now()}}},shouldResetLimits(i){const p=new Date,d=p.getDate();if(!i)return d===1;if(d===1){const v=i.toDate(),N=p.getMonth(),I=p.getFullYear();return v.getMonth()!==N||v.getFullYear()!==I}return!1},async autoResetLimitsIfNeeded(i){try{if(!Ma(i))return console.error("خطأ في التصفير التلقائي للحدود: walletId غير صالح",i),!1;typeof import.meta<"u";const p=await this.getWalletUsage(i);return p&&this.shouldResetLimits(p.last_reset)?(console.log(`🔄 تصفير تلقائي للحدود للمحفظة ${i} - اليوم الأول من الشهر`),await this.resetWalletUsage(i)):!1}catch(p){return console.error("خطأ في التصفير التلقائي للحدود:",p),!1}},async resetWalletUsage(i){try{if(!Ma(i))return console.error("خطأ في تصفير استخدام المحفظة: walletId غير صالح",i),!1;const p=Je(J,"walletLimits",i);return await Qs(p,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:ct(),updatedAt:ct()},{merge:!0}),console.log(`🔄 تم تصفير استخدام المحفظة ${i} بنجاح`),!0}catch(p){return console.error("خطأ في تصفير استخدام المحفظة:",p),!1}},async calculateUsageFromTransactions(i){var p,d;try{if(!Ma(i))return console.error("خطأ في حساب الاستخدام من المعاملات: walletId غير صالح",i),{used_transfer:0,used_withdraw:0};const v=Je(J,"walletLimits",i),N=new Date;let I=tr.fromDate(new Date(N.getFullYear(),N.getMonth(),1));try{const L=await va(v);I=L.exists()?((p=L.data())==null?void 0:p.lastMonthlyReset)??((d=L.data())==null?void 0:d.last_reset)??I:I}catch{}const s=Ue(Ne(J,"tx"),ie("uid","==",i),...I?[ie("createdAt",">=",I)]:[]),j=await Qe(s);let B=0,C=0;return j.forEach(L=>{const M=L.data();M.status==="completed"&&(M.type==="transfer"?B+=M.amount:M.type==="withdraw"&&(C+=M.amount))}),{used_transfer:B,used_withdraw:C}}catch(v){return console.error("خطأ في حساب الاستخدام من المعاملات:",v),{used_transfer:0,used_withdraw:0}}},async getWalletUsageWithRefresh(i){var p,d;try{if(!Ma(i))return console.error("خطأ في الحصول على الاستخدام مع التحديث: walletId غير صالح",i),null;typeof import.meta<"u";const v=await this.getWalletUsage(i);if(!v){const I=await this.calculateUsageFromTransactions(i),s=Je(J,"walletLimits",i);try{await Qs(s,{monthlyTransferUsed:I.used_transfer,monthlyWithdrawUsed:I.used_withdraw,updatedAt:ct(),ownerId:(p=jr.currentUser)==null?void 0:p.uid},{merge:!0})}catch{}return{walletId:i,used_transfer:I.used_transfer,used_withdraw:I.used_withdraw,monthly_limit:2e5,last_reset:null,updatedAt:tr.now()}}const N=await this.calculateUsageFromTransactions(i);if(v.used_transfer!==N.used_transfer||v.used_withdraw!==N.used_withdraw){const I=Je(J,"walletLimits",i);try{await Qs(I,{monthlyTransferUsed:N.used_transfer,monthlyWithdrawUsed:N.used_withdraw,updatedAt:ct(),ownerId:(d=jr.currentUser)==null?void 0:d.uid},{merge:!0})}catch{}return await this.getWalletUsage(i)}return v}catch(v){return console.error("خطأ في الحصول على الاستخدام مع التحديث:",v),{walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:tr.now()}}},calculateRemaining(i){return{remainingTransfer:Math.max(0,i.monthly_limit-i.used_transfer),remainingWithdraw:Math.max(0,i.monthly_limit-i.used_withdraw)}},async canPerformOperation(i,p,d){try{if(!Ma(i))return console.error("Error checking operation limits: invalid walletId",i),{canPerform:!1,message:"walletId غير صالح"};const v=await this.getWalletUsageWithRefresh(i);if(!v)return{canPerform:!1,message:"لا يمكن العثور على بيانات الاستخدام للمحفظة"};const N=this.calculateRemaining(v);return d==="transfer"&&p>N.remainingTransfer?{canPerform:!1,message:`تجاوز حد التحويل المسموح. المتبقي: ${N.remainingTransfer.toLocaleString()} ج.م من أصل ${v.monthly_limit.toLocaleString()} ج.م`,remaining:N.remainingTransfer}:d==="withdraw"&&p>N.remainingWithdraw?{canPerform:!1,message:`تجاوز حد السحب المسموح. المتبقي: ${N.remainingWithdraw.toLocaleString()} ج.م من أصل ${v.monthly_limit.toLocaleString()} ج.م`,remaining:N.remainingWithdraw}:{canPerform:!0}}catch(v){return console.error("Error checking operation limits:",v),{canPerform:!1,message:"خطأ في التحقق من الحدود"}}},async updateUsage(i,p,d){var v;try{if(!Ma(i))throw new Error("walletId غير صالح");const N=await this.getWalletUsageWithRefresh(i);if(!N)throw new Error("لا يمكن العثور على بيانات الاستخدام للمحفظة");const I=await this.canPerformOperation(i,p,d);if(!I.canPerform)throw new Error(I.message||"لا يمكن إجراء العملية");const s=d==="transfer"?N.used_transfer+p:N.used_transfer,j=d==="withdraw"?N.used_withdraw+p:N.used_withdraw,B=Je(J,"walletLimits",N.walletId);try{await Qs(B,{monthlyTransferUsed:s,monthlyWithdrawUsed:j,updatedAt:ct(),ownerId:(v=jr.currentUser)==null?void 0:v.uid},{merge:!0})}catch{}let C=await this.getWalletUsageWithRefresh(i);return C||(C={walletId:i,used_transfer:s,used_withdraw:j,monthly_limit:N.monthly_limit,last_reset:N.last_reset,updatedAt:tr.now()}),C}catch(N){throw console.error("Error updating wallet usage:",N),N}},async resetWalletUsageManually(i){try{if(!Ma(i))throw new Error("walletId غير صالح");const p=Je(J,"walletLimits",i),d={walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:0,last_reset:null,updatedAt:new Date};return Qs(p,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:ct(),updatedAt:ct()},{merge:!0}).catch(v=>{console.error("خطأ في حفظ تصفير الاستخدام في Firebase:",v)}),console.log(`✅ تم تصفير استخدام المحفظة ${i} بنجاح`),d}catch(p){throw console.error("Error resetting wallet usage:",p),p}},async getAllWalletsUsage(i){try{const d=(await na.getByMerchantId(i)).map(N=>this.getWalletUsageWithRefresh(N.id));return(await Promise.all(d)).filter(N=>N!==null)}catch(p){return console.error("Error getting all wallets usage:",p),[]}}};function su(i){return i?`readBroadcastIds_${i}`:"readBroadcastIds_guest"}function au({className:i}){const{user:p,profile:d,isSubscriptionActive:v}=ja(),N=xc(),[I,s]=n.useState([]),[j,B]=n.useState(new Set),[C,L]=n.useState(!1),[M,y]=n.useState(""),[w,O]=n.useState(!1),[G,R]=n.useState(null),[Z,ae]=n.useState("none"),[de,$]=n.useState(null),[W,ge]=n.useState(!1);n.useRef(new Set),n.useRef(!1);const De=n.useRef(null),pe=n.useRef(null);n.useRef(null);const[xe,oe]=n.useState({position:"fixed",top:0,left:0,zIndex:1e4}),We=!1,Ve=n.useMemo(()=>{const le=["global"];return p!=null&&p.uid&&le.push(`user:${p.uid}`),d!=null&&d.shopId&&le.push(`shop:${d.shopId}`),le},[p==null?void 0:p.uid,d==null?void 0:d.shopId]),Ee=su(p==null?void 0:p.uid),He=n.useMemo(()=>{var xt;const le=(xt=N==null?void 0:N.pathname)==null?void 0:xt.includes("/user/pending-approval");return!!(p!=null&&p.uid)&&!le},[p==null?void 0:p.uid,N==null?void 0:N.pathname]);n.useEffect(()=>{try{const le=localStorage.getItem(Ee);if(le){const Te=JSON.parse(le);Array.isArray(Te)&&B(new Set(Te.filter(Boolean)))}else B(new Set)}catch(le){console.warn("Failed to load read ids",le),B(new Set)}},[Ee]),n.useEffect(()=>{if(!He){s([]);return}const le=Dh(Ve,Te=>{s(Te)});return()=>le()},[Ve,He]),n.useEffect(()=>{},[I]),n.useEffect(()=>()=>{De.current&&clearTimeout(De.current)},[]);const Ke=I.reduce((le,Te)=>le+(Te.id&&!j.has(Te.id)?1:0),0),dt=le=>{if(!le||j.has(le))return;const Te=new Set(j);Te.add(le),B(Te);try{localStorage.setItem(Ee,JSON.stringify(Array.from(Te)))}catch{}},te=()=>{const le=I.map(xt=>xt.id).filter(Boolean),Te=new Set(j);le.forEach(xt=>Te.add(xt)),B(Te);try{localStorage.setItem(Ee,JSON.stringify(Array.from(Te)))}catch{}},fe=(le,Te)=>{var xt;if(le)try{const Vt=((xt=tn)==null?void 0:xt.isNativePlatform)&&tn.getPlatform()==="android",kt=/\.apk(\?|$)/i.test(le);if(Vt&&kt){const Jt=`cashy://update?url=${encodeURIComponent(le)}`;window.location.href=Jt}else window.open(le,"_blank")}catch{try{window.open(le,"_blank")}catch{}}Te&&dt(Te)};n.useEffect(()=>{},[W]);const st=async()=>{if(!(p!=null&&p.uid)){alert("يرجى تسجيل الدخول لإرسال الطلب.");return}const le=M.trim();if(!le){alert("يرجى كتابة سبب طلب التحدث.");return}try{O(!0),R(null);const Te=d!=null&&d.fullName&&d.fullName.trim()?d.fullName.trim():p.email?p.email.split("@")[0]:"مستخدم",xt=(d==null?void 0:d.phone)||null;await Zs(Ne(J,"waiting_list"),{userId:p.uid,name:Te,phone:xt,reason:le,status:"pending",createdAt:ct()}),R("تم إرسال طلبك إلى قائمة الانتظار بنجاح ✅"),y(""),setTimeout(()=>L(!1),900)}catch(Te){console.error("فشل إرسال طلب قائمة الانتظار:",Te),alert("حدث خطأ أثناء إرسال الطلب. حاول مرة أخرى.")}finally{O(!1)}};return n.useEffect(()=>{if(!(p!=null&&p.uid)){ae("none");return}let le=null;try{const Te=Ue(Ne(J,"waiting_list"),ie("userId","==",p.uid));le=Ls(Te,xt=>{const Vt=xt.docs.map(Oe=>({id:Oe.id,...Oe.data()})).sort((Oe,et)=>{var ht,D,bt,_t,At,F;const mt=((D=(ht=Oe==null?void 0:Oe.createdAt)==null?void 0:ht.toMillis)==null?void 0:D.call(ht))??((bt=Oe==null?void 0:Oe.createdAt)==null?void 0:bt.seconds)*1e3??0;return(((At=(_t=et==null?void 0:et.createdAt)==null?void 0:_t.toMillis)==null?void 0:At.call(_t))??((F=et==null?void 0:et.createdAt)==null?void 0:F.seconds)*1e3??0)-mt});if(Vt.length===0){ae("none");return}const kt=Vt[0],Jt=(kt==null?void 0:kt.contacted)===!0||(kt==null?void 0:kt.status)==="contacted";ae(Jt?"contacted":"pending")})}catch(Te){console.warn("⚠️ فشل الاشتراك في waiting_list للمستخدم:",Te),ae("none")}return()=>{le&&le()}},[p==null?void 0:p.uid]),He?e.jsxs("div",{className:`relative inline-flex items-center gap-2 ${i||""}`,ref:pe,children:[e.jsxs(Ah,{onOpenChange:le=>{le&&Ke>0&&te()},children:[e.jsx(Th,{asChild:!0,children:e.jsx(h,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:e.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[e.jsx(ac,{className:"h-4 w-4 text-primary"}),Ke>0&&e.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:Ke})]})})}),e.jsxs(Ph,{className:"w-80",align:"end",forceMount:!0,children:[e.jsxs(kh,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"الإشعارات"}),I.length>0&&e.jsxs(h,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:te,children:[e.jsx(za,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),e.jsx(_h,{}),I.length===0?e.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):e.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:I.map(le=>{const Te=le.id?!j.has(le.id):!1;return e.jsx("div",{className:`px-2 py-2 rounded-md ${Te?"bg-primary/5":""}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(ac,{className:`h-4 w-4 ${Te?"text-primary":"text-muted-foreground"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium",children:le.title||"إشعار"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:le.message}),le.linkUrl&&e.jsxs(h,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>fe(le.linkUrl,le.id),children:["فتح الرابط ",e.jsx(Ch,{className:"h-3 w-3 ml-1"})]})]}),Te?e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>dt(le.id),title:"تمييز كمقروء",children:e.jsx(za,{className:"h-4 w-4 text-primary"})}):e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:e.jsx(za,{className:"h-4 w-4 text-muted-foreground"})})]})},le.id)})})]})]}),e.jsxs(ye,{open:C,onOpenChange:L,children:[e.jsx(Gm,{asChild:!0,children:e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full hover:bg-transparent focus:ring-1 focus:ring-primary/60 focus:ring-offset-1",title:"قائمة الانتظار",children:e.jsx(Na,{className:`h-4 w-4 ${Z==="pending"?"text-red-600":Z==="contacted"?"text-green-600":"text-muted-foreground"}`})})}),e.jsxs(be,{className:"max-w-md border border-purple-200/50 shadow-xl bg-gradient-to-br from-purple-50 to-blue-50",children:[e.jsxs(ve,{children:[e.jsx(we,{children:"طلب التحدث"}),e.jsx(us,{children:"يرجى كتابة سبب طلب التحدث ليصل للإدارة في قسم قائمة الانتظار."})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"سبب الطلب"}),e.jsx(Ih,{value:M,onChange:le=>y(le.target.value),placeholder:"اكتب سبب طلب التحدث هنا...",className:"min-h-[120px] text-right"}),G&&e.jsx("div",{className:"text-sm text-green-700 bg-green-50 border border-green-200 rounded-md p-2",children:G})]}),e.jsxs(lt,{children:[e.jsx(h,{variant:"outline",onClick:()=>L(!1),disabled:w,children:"إلغاء"}),e.jsx(h,{onClick:st,disabled:w,className:"bg-gradient-to-r from-green-600 to-emerald-600 text-white",children:w?"جارٍ الإرسال...":"إرسال"})]})]})]}),We]}):null}function ru({isOpen:i,onClose:p}){const[d,v]=n.useState("0"),[N,I]=n.useState(null),[s,j]=n.useState(null),[B,C]=n.useState(!1),L=$=>{B?(v($),C(!1)):v(d==="0"?$:d+$)},M=$=>{const W=parseFloat(d);if(N===null)I(W);else if(s){const De=y(N||0,W,s);v(String(De)),I(De)}C(!0),j($)},y=($,W,ge)=>{switch(ge){case"+":return $+W;case"-":return $-W;case"×":return $*W;case"÷":return W===0?0:$/W;case"=":return W;default:return W}},w=()=>{const $=parseFloat(d);if(N!==null&&s){const W=y(N,$,s);v(String(W)),I(null),j(null),C(!0)}},O=()=>{v("0"),I(null),j(null),C(!1)},G=()=>{v("0")},R=()=>{B?(v("0."),C(!1)):d.indexOf(".")===-1&&v(d+".")},Z=()=>{d!=="0"&&v(d.charAt(0)==="-"?d.slice(1):"-"+d)},ae=()=>{const $=parseFloat(d);v(String($/100))},de=$=>{const W=$.key;$.preventDefault(),W>="0"&&W<="9"?L(W):W==="+"?M("+"):W==="-"?M("-"):W==="*"?M("×"):W==="/"?M("÷"):W==="Enter"||W==="="?w():W==="Escape"||W==="c"||W==="C"?O():W==="Backspace"?G():W==="."?R():W==="%"&&ae()};return n.useEffect(()=>(i?document.addEventListener("keydown",de):document.removeEventListener("keydown",de),()=>{document.removeEventListener("keydown",de)}),[i,d,N,s,B]),e.jsx(ye,{open:i,onOpenChange:$=>!$&&p(),children:e.jsxs(be,{className:"sm:max-w-md",children:[e.jsx(ve,{children:e.jsxs(we,{className:"flex items-center gap-2 text-right",children:[e.jsx(jc,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:d})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:O,children:"AC"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:G,children:"CE"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:ae,children:"%"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>M("÷"),children:"÷"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>L("7"),children:"7"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>L("8"),children:"8"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>L("9"),children:"9"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>M("×"),children:"×"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>L("4"),children:"4"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>L("5"),children:"5"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>L("6"),children:"6"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>M("-"),children:"-"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>L("1"),children:"1"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>L("2"),children:"2"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>L("3"),children:"3"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>M("+"),children:"+"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>L("0"),children:"0"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:R,children:"."}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:w,children:"="})]}),e.jsx(h,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:Z,children:"+/-"})]})]})})}function nu({isOpen:i,onClose:p,initialBarcode:d}){const[v,N]=n.useState([]),[I,s]=n.useState({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),[j,B]=n.useState(!1),[C,L]=n.useState(null),{toast:M}=Xs(),{user:y,profile:w}=ja(),{isShiftActive:O,shiftUser:G}=ln(),{shopId:R}=li(),[Z,ae]=n.useState([]),[de,$]=n.useState({}),[W,ge]=n.useState({}),[De,pe]=n.useState({}),[xe,oe]=n.useState(""),[We,Ve]=n.useState(!1),[Ee,He]=n.useState({}),[Ke,dt]=n.useState(!1),[te,fe]=n.useState(!0),[st,le]=n.useState(!1),Te=Ye.useRef(""),xt=Ye.useRef(0),[Vt,kt]=n.useState(0),[Jt,Oe]=n.useState(0),[et,mt]=n.useState(!1),[Ie,ht]=n.useState(!0),[D,bt]=n.useState(!1),[_t,At]=n.useState(!1),[F,ue]=n.useState(!0),[Pe,ft]=n.useState(!0),[ot,es]=n.useState({}),[os,vt]=n.useState(!1),[Ze,Tt]=n.useState("التحقق قبل العملية"),[Lt,ea]=n.useState("أدخل الرقم السري الرئيسي للمتابعة"),Rt=Ye.useRef(null),js=(c,T,E)=>{Tt(c),ea(T),Rt.current=E,vt(!0)},[Ws,Fs]=n.useState([]),[Da,ts]=n.useState(!1),[_,ce]=n.useState(""),[me,Ae]=n.useState(""),[Le,yt]=n.useState(""),[rt,z]=n.useState(null);n.useEffect(()=>{(async()=>{try{if(!i||!(y!=null&&y.uid))return;const c=await Se.getUserData(y.uid),T=Array.isArray(c==null?void 0:c.customers)?c.customers.map(E=>({id:String(E.id||""),name:String(E.name||""),mobile:E.mobile||void 0})):[];Fs(T)}catch{}})()},[i,y==null?void 0:y.uid]);const[ke,K]=n.useState(!1),[pt,Ct]=n.useState(null),[Qt,ss]=n.useState(null),Ss=(c,T)=>{Ct(c),ss(T),K(!0)},[ia,Ys]=n.useState(""),ma=n.useMemo(()=>{const c=ia.trim().toLowerCase();return c?Z.filter(T=>T.name.toLowerCase().includes(c)):Z},[Z,ia]),Ca=()=>new Date().toISOString().split("T")[0];n.useEffect(()=>{i&&(y!=null&&y.uid)&&(gt(),Ie||zt())},[i,y==null?void 0:y.uid,Ie]),n.useEffect(()=>{if(!(!i||!(y!=null&&y.uid)))try{const c=Ca(),T=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date),E=V=>{try{const Ce=V.docs.map(Be=>{const he=Be.data();return{id:String(he.clientId||Be.id),productName:String(he.productName||""),price:Number(he.sellingPrice||0),wholesalePrice:typeof he.wholesalePrice=="number"?he.wholesalePrice:Number(he.wholesalePrice||0),quantity:Number(he.quantity||0),date:String(he.date||c),time:String(he.time||""),performedByType:he.performedByType||void 0,performedByName:he.performedByName||void 0,performedByUsername:he.performedByUsername||null,serialNumber:he.serialNumber||void 0,barcode:he.barcode||void 0,firestoreId:Be.id}}),ze=(v||[]).filter(Be=>!Be.firestoreId),_e={};[...Ce,...ze].forEach(Be=>{_e[Be.id]=Be});const Re=Object.values(_e);ut(Re)}catch{}};let Y;try{const V=R||(w==null?void 0:w.shopId)||null,Ce=Ue(Ne(J,"dailySales"),ie("userId","==",y.uid),...V?[ie("shopId","==",V)]:[]);Y=Ls(Ce,E,()=>{try{Y&&Y()}catch{}const ze=Ue(Ne(J,"users",y.uid,"dailySales"),...V?[ie("shopId","==",V)]:[]);Y=Ls(ze,E)})}catch{const V=R||(w==null?void 0:w.shopId)||null,Ce=Ue(Ne(J,"users",y.uid,"dailySales"),...V?[ie("shopId","==",V)]:[]);Y=Ls(Ce,E)}return()=>{try{Y&&Y()}catch{}}}catch{}},[i,y==null?void 0:y.uid]),n.useEffect(()=>{if(!i)return;const c=T=>{const E=Date.now();if(T.key==="Enter"){const Y=(Te.current||"").trim();Te.current="",Y&&Yt(Y);return}T.key.length===1&&(E-(xt.current||0)>100&&(Te.current=""),Te.current+=T.key,xt.current=E)};return window.addEventListener("keydown",c),()=>window.removeEventListener("keydown",c)},[i,Z]),n.useEffect(()=>{i&&d&&Yt(d)},[i,d]);const la=async()=>{if(y!=null&&y.uid)try{const c=w==null?void 0:w.shopId;let T,E=[];if(c){const Y=Ue(Ne(J,"products"),ie("shopId","==",c),ie("userId","==",y.uid));if(T=await Qe(Y),E=T.docs.map(V=>({id:V.id,name:String(V.data().name??""),sellingPrice:Number(V.data().sellingPrice??0),wholesalePrice:Number(V.data().wholesalePrice??0),quantity:Number(V.data().quantity??0),barcode:String(V.data().barcode??""),serialNumber:String(V.data().serialNumber??"")})),E.length===0){const V=Ue(Ne(J,"products"),ie("userId","==",y.uid)),ze=(await Qe(V)).docs.map(_e=>({id:_e.id,name:String(_e.data().name??""),sellingPrice:Number(_e.data().sellingPrice??0),wholesalePrice:Number(_e.data().wholesalePrice??0),quantity:Number(_e.data().quantity??0),barcode:String(_e.data().barcode??""),serialNumber:String(_e.data().serialNumber??"")}));ze.length>0&&(E=ze,M({title:"تم استرجاع المنتجات",description:"عثرنا على منتجات محفوظة لك خارج المتجر الحالي وقمنا بعرضها."}))}}else{const Y=Ue(Ne(J,"products"),ie("userId","==",y.uid));T=await Qe(Y),E=T.docs.map(V=>({id:V.id,name:String(V.data().name??""),sellingPrice:Number(V.data().sellingPrice??0),wholesalePrice:Number(V.data().wholesalePrice??0),quantity:Number(V.data().quantity??0),barcode:String(V.data().barcode??""),serialNumber:String(V.data().serialNumber??"")}))}if(ae(E),w!=null&&w.shopId&&E.length>0){const Y=E.filter(V=>{const Ce=((T==null?void 0:T.docs)||[]).find(_e=>_e.id===V.id);return!(!!Ce&&!!Ce.data().shopId)});if(Y.length>0)try{await Promise.all(Y.map(V=>Zt(Je(J,"products",V.id),{shopId:w.shopId,updatedAt:ct()}))),M({title:"تم ترتيب المنتجات",description:"تم ربط بعض المنتجات غير المربوطة بمتجرك الحالي تلقائياً."})}catch(V){console.warn("تعذّر ترحيل shopId لبعض المنتجات:",V)}}}catch(c){console.error("Error loading shop products:",c)}};n.useEffect(()=>{i&&(y!=null&&y.uid)&&(la(),zt(),gt(),Fe())},[i,y==null?void 0:y.uid,w==null?void 0:w.shopId]);const U=()=>{const c=new Date,T=c.getFullYear(),E=String(c.getMonth()+1).padStart(2,"0"),Y=String(c.getDate()).padStart(2,"0");return`${T}-${E}-${Y}`},je=c=>{const T=E=>{if(typeof E.createdAtMs=="number")return E.createdAtMs;const Y=parseInt(E.id,10);if(!isNaN(Y))return Y;const V=new Date(E.date);return isNaN(V.getTime())?0:V.getTime()};return[...c].sort((E,Y)=>T(Y)-T(E))},gt=()=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot load sales data");return}const c=R||(w==null?void 0:w.shopId)||"main",T=`salesData_all_${y.uid}_${c}`,E=localStorage.getItem(T);if(E)try{const Be=JSON.parse(E);N(Array.isArray(Be)?je(Be):[]);return}catch{}const Y=U(),V=`salesData_${y.uid}_${c}_${Y}`,Ce=localStorage.getItem(V);if(Ce){const Be=JSON.parse(Ce),he=Array.isArray(Be)?je(Be):[];N(he);try{localStorage.setItem(T,JSON.stringify(he))}catch{}return}const ze=new Date().toISOString().split("T")[0],_e=`salesData_${y.uid}_${c}_${ze}`,Re=localStorage.getItem(_e);if(Re){const Be=JSON.parse(Re),he=Array.isArray(Be)?je(Be):[];N(he);try{localStorage.setItem(V,JSON.stringify(he)),localStorage.setItem(T,JSON.stringify(he))}catch{}return}Ds()},ut=c=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot save sales data");return}const T=R||(w==null?void 0:w.shopId)||"main",E=U(),Y=`salesData_${y.uid}_${T}_${E}`,V=`salesData_all_${y.uid}_${T}`,Ce=je(c);localStorage.setItem(Y,JSON.stringify(Ce));try{const ze=localStorage.getItem(V),_e=ze?JSON.parse(ze):[],Re={};[...Array.isArray(_e)?_e:[],...Ce].forEach(jt=>{Re[jt.id]=jt});const Be=Object.values(Re),he=je(Be);localStorage.setItem(V,JSON.stringify(he))}catch{}N(Ce)},Kt=c=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot save sales data");return}const T=R||(w==null?void 0:w.shopId)||"main",E=`salesData_all_${y.uid}_${T}`;try{const V=localStorage.getItem(E),Ce=V?JSON.parse(V):[],ze={};[...Array.isArray(Ce)?Ce:[],...c].forEach(Be=>{ze[Be.id]=Be});const _e=Object.values(ze),Re=je(_e);localStorage.setItem(E,JSON.stringify(Re))}catch{}const Y=je(c);N(Y)},Ds=async()=>{if(y!=null&&y.uid)try{const c=R||(w==null?void 0:w.shopId)||null,T=new Date().toISOString().split("T")[0],E=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date);let Y,V;try{const Be=Ue(Ne(J,"dailySales"),ie("userId","==",y.uid),...c?[ie("shopId","==",c)]:[]);Y=await Qe(Be)}catch{}try{const Be=Ue(Ne(J,"users",y.uid,"dailySales"),...c?[ie("shopId","==",c)]:[]);V=await Qe(Be)}catch{}const ze=[...Y?Y.docs:[],...V?V.docs:[]].map(Be=>{var jt,Et;const he=Be.data();return{id:String(he.clientId||Be.id),firestoreId:Be.id,productName:String(he.productName||""),price:Number(he.sellingPrice||0),wholesalePrice:he.wholesalePrice!==void 0?Number(he.wholesalePrice):null,quantity:Number(he.quantity||0),date:String(he.date||T),time:String(he.time||""),serialNumber:he.serialNumber||void 0,barcode:he.barcode||void 0,performedByType:he.performedByType||void 0,performedByName:he.performedByName||void 0,performedByUsername:he.performedByUsername||void 0,isDeferred:!!he.isDeferred,customerName:he.customerName||void 0,customerMobile:he.customerMobile||void 0,customerId:he.customerId||void 0,createdAtMs:(Et=(jt=he==null?void 0:he.createdAt)==null?void 0:jt.toDate)!=null&&Et.call(jt)?he.createdAt.toDate().getTime():new Date(String(he.date||T)).getTime()}}),_e={};[...v,...ze].forEach(Be=>{_e[Be.id]=Be});const Re=Object.values(_e);Kt(Re)}catch{}},zt=async()=>{if(y!=null&&y.uid)try{const c=new Date,T=new Date(c.getFullYear(),c.getMonth(),1),E=new Date(c.getFullYear(),c.getMonth()+1,0),Y=he=>he.toISOString().split("T")[0],V=Y(T),Ce=Y(E),ze=R||(w==null?void 0:w.shopId)||null;let _e;try{const he=Ue(Ne(J,"dailySales"),ie("userId","==",y.uid),...ze?[ie("shopId","==",ze)]:[]);_e=await Qe(he)}catch{const he=Ue(Ne(J,"users",y.uid,"dailySales"),...ze?[ie("shopId","==",ze)]:[]);_e=await Qe(he)}let Re=0,Be=0;_e.forEach(he=>{const jt=he.data(),Et=String(jt.date??"").slice(0,10);if(!jt.isDeferred&&Et>=V&&Et<=Ce){const Bs=Number(jt.sellingPrice??0),sa=Number(jt.quantity??0),Ia=Number(jt.profit??(Number(jt.sellingPrice??0)-Number(jt.wholesalePrice??0))*sa);Re+=Bs*sa,Be+=Ia}}),kt(Re),Oe(Be)}catch(c){console.error("Error loading monthly stats:",c)}},ta=async c=>{if(!(y!=null&&y.uid))return null;try{const T=((c.price??0)-(c.wholesalePrice??0))*(c.quantity??0),E=O&&G?"cashier":"admin",Y=E==="cashier"?(G==null?void 0:G.name)||"كاشير":(w==null?void 0:w.fullName)||(y==null?void 0:y.displayName)||"الحساب الرئيسي",V=E==="cashier"&&(G==null?void 0:G.username)||null,Ce=await Zs(Ne(J,"dailySales"),{userId:y.uid,clientId:c.id,productName:c.productName,quantity:c.quantity,wholesalePrice:c.wholesalePrice??null,sellingPrice:c.price,profit:T,date:c.date,time:c.time,performedByType:E,performedByName:Y,performedByUsername:V,serialNumber:c.serialNumber??null,barcode:c.barcode??null,isDeferred:!!c.isDeferred,customerName:c.customerName||null,customerMobile:c.customerMobile||null,customerId:c.customerId||null,...w!=null&&w.shopId?{shopId:w.shopId}:R?{shopId:R}:{},createdAt:ct()});try{await Qs(Je(J,"users",y.uid,"dailySales",Ce.id),{userId:y.uid,clientId:c.id,productName:c.productName,quantity:c.quantity,wholesalePrice:c.wholesalePrice??null,sellingPrice:c.price,profit:T,date:c.date,time:c.time,performedByType:E,performedByName:Y,performedByUsername:V,serialNumber:c.serialNumber??null,barcode:c.barcode??null,isDeferred:!!c.isDeferred,customerName:c.customerName||null,customerMobile:c.customerMobile||null,customerId:c.customerId||null,...w!=null&&w.shopId?{shopId:w.shopId}:R?{shopId:R}:{},createdAt:ct()})}catch{}return Ce.id}catch{try{const T=await Zs(Ne(J,"users",y.uid,"dailySales"),{userId:y.uid,clientId:c.id,productName:c.productName,quantity:c.quantity,wholesalePrice:c.wholesalePrice??null,sellingPrice:c.price,profit,date:c.date,time:c.time,performedByType,performedByName,performedByUsername,serialNumber:c.serialNumber??null,barcode:c.barcode??null,isDeferred:!!c.isDeferred,customerName:c.customerName||null,customerMobile:c.customerMobile||null,customerId:c.customerId||null,...w!=null&&w.shopId?{shopId:w.shopId}:R?{shopId:R}:{},createdAt:ct()});try{await Qs(Je(J,"dailySales",T.id),{userId:y.uid,clientId:c.id,productName:c.productName,quantity:c.quantity,wholesalePrice:c.wholesalePrice??null,sellingPrice:c.price,profit,date:c.date,time:c.time,performedByType,performedByName,performedByUsername,serialNumber:c.serialNumber??null,barcode:c.barcode??null,isDeferred:!!c.isDeferred,customerName:c.customerName||null,customerMobile:c.customerMobile||null,customerId:c.customerId||null,...w!=null&&w.shopId?{shopId:w.shopId}:R?{shopId:R}:{},createdAt:ct()})}catch{}return T.id}catch(T){return console.error("Error saving sale:",T),null}}},qa=()=>{const c=R||(w==null?void 0:w.shopId)||"main";return`cashBalance_${(y==null?void 0:y.uid)||"default"}_${c}`},on=async(c,T)=>{if(y!=null&&y.uid)try{const E=Je(J,"dailySales",c);await Zt(E,T)}catch{try{const E=Je(J,"users",y.uid,"dailySales",c);await Zt(E,T)}catch(E){console.error("Error updating sale:",E)}}},Cr=async c=>{try{const T=c.firestoreId;if(T)await on(T,{isDeferred:!1});else try{const E=Ue(Ne(J,"dailySales"),ie("userId","==",(y==null?void 0:y.uid)||""),ie("date","==",c.date),ie("productName","==",c.productName),Kr(5)),V=(await Qe(E)).docs[0];V&&await Zt(V.ref,{isDeferred:!1})}catch{}N(E=>E.map(Y=>Y.id===c.id?{...Y,isDeferred:!1}:Y));try{await zt()}catch{}M({title:"تم التسديد",description:`تم تسديد أجل ${c.productName}`})}catch(T){console.error("Error marking deferred sale as paid:",T),M({title:"فشل التسديد",description:"تعذّر تحديث حالة البيع المؤجّل",variant:"destructive"})}},Fe=async()=>{if(!(y!=null&&y.uid))return;const c=v.filter(T=>!T.firestoreId);if(c.length!==0)for(const T of c)try{let E;try{const V=Ue(Ne(J,"dailySales"),ie("userId","==",y.uid),ie("clientId","==",T.id),Kr(1));E=await Qe(V)}catch{const V=Ue(Ne(J,"users",y.uid,"dailySales"),ie("clientId","==",T.id),Kr(1));E=await Qe(V)}if(!E.empty){const V=E.docs[0].id,Ce=v.map(ze=>ze.id===T.id?{...ze,firestoreId:V}:ze);ut(Ce);continue}const Y=await ta(T);if(Y){const V=v.map(Ce=>Ce.id===T.id?{...Ce,firestoreId:Y}:Ce);ut(V)}}catch{}},Ot=async c=>{try{if(y!=null&&y.uid)try{const Re=Ne(J,"deficiencies"),Be=await Zs(Re,{shopId:(w==null?void 0:w.shopId)||y.uid||"default-shop",name:c,quantity:1,status:"pending",createdAt:ct()});try{const he=`deficiencies_${(w==null?void 0:w.shopId)||(y==null?void 0:y.uid)||"default-shop"}`,jt=localStorage.getItem(he),Et=jt?JSON.parse(jt):[],Bs=Array.isArray(Et)?Et:[],sa=Bs.some(fs=>String((fs==null?void 0:fs.id)||"")===Be.id),Ia={id:Be.id,name:c,quantity:1,status:"pending",createdAt:new Date().toISOString()},Ka=sa?Bs:[...Bs,Ia];localStorage.setItem(he,JSON.stringify(Ka))}catch{}M({title:"تمت الإضافة للنواقص",description:`المنتج ${c} نفد من المخزون وتمت إضافته للنواقص`});return}catch(Re){console.warn("Failed to add deficiency to Firestore, falling back to local storage:",Re)}const T=`deficiencies_${(w==null?void 0:w.shopId)||(y==null?void 0:y.uid)||"default-shop"}`,E=localStorage.getItem(T),Y=E?JSON.parse(E):[],V=Array.isArray(Y)?Y:[];if(V.some(Re=>String((Re==null?void 0:Re.name)||"").trim()===c&&String((Re==null?void 0:Re.status)||"pending")==="pending"))return;const ze={id:Date.now().toString(),name:c,quantity:1,status:"pending",createdAt:new Date().toISOString()},_e=[...V,ze];localStorage.setItem(T,JSON.stringify(_e)),M({title:"تمت الإضافة للنواقص",description:`المنتج ${c} نفد من المخزون وتمت إضافته للنواقص`})}catch(T){console.error("Error adding deficiency for out-of-stock:",T)}},Rs=async(c,T=!1,E)=>{const Y=de[c.id]||"",V=parseInt(Y);if(isNaN(V)||V<=0){M({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(V>c.quantity){M({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const Ce=new Date,ze=O&&G?"cashier":"admin",_e=ze==="cashier"?(G==null?void 0:G.name)||"كاشير":(w==null?void 0:w.fullName)||(y==null?void 0:y.displayName)||"الحساب الرئيسي",Re=ze==="cashier"&&(G==null?void 0:G.username)||null,Be=(c.serialNumber||"").trim(),he=ot[c.id]||"",jt=parseFloat(he),Et=!isNaN(jt)&&jt>0?jt:c.sellingPrice,Bs={id:Date.now().toString(),productName:c.name,price:Et,wholesalePrice:c.wholesalePrice,quantity:V,date:Ce.toISOString().split("T")[0],time:Ce.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),createdAtMs:Ce.getTime(),performedByType:ze,performedByName:_e,performedByUsername:Re,serialNumber:Be||void 0,barcode:c.barcode,isDeferred:T,customerName:E==null?void 0:E.name,customerMobile:E==null?void 0:E.mobile,customerId:E==null?void 0:E.id};try{const sa=await ta(Bs),Ia=sa?{...Bs,firestoreId:sa}:Bs;ut([...v,Ia]);const Ka=c.quantity-V;if(await Zt(Je(J,"products",c.id),{quantity:Ka,updatedAt:ct()}),ae(fs=>fs.map(Aa=>Aa.id===c.id?{...Aa,quantity:Ka}:Aa)),$(fs=>({...fs,[c.id]:""})),es(fs=>({...fs,[c.id]:""})),Ka===0&&Ot(c.name),!T)try{const fs=Et*V,Aa=qa(),Ya=localStorage.getItem(Aa),or=(Ya?parseFloat(Ya):0)+fs;localStorage.setItem(Aa,or.toString());const dn=`userData_${y==null?void 0:y.uid}`,cr={cashBalance:or,lastUpdated:new Date().toISOString()};localStorage.setItem(dn,JSON.stringify(cr)),y!=null&&y.uid&&Se.updateUserData(y.uid,cr).catch(()=>{})}catch(fs){console.warn("تعذر تحديث رصيد الدرج النقدي بعد البيع:",fs)}M({title:"تم البيع",description:`تم بيع ${V} قطعة من ${c.name}`})}catch(sa){console.error("Error selling product:",sa),M({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},cn=async c=>{if(y!=null&&y.uid){if(O){M({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف إيصالات البيع أثناء الورديه",variant:"destructive"});return}js("تأكيد حذف إيصال بيع","أدخل الرقم السري الرئيسي لحذف الإيصال وعكس الآثار",async()=>{try{if(!c.isDeferred)try{const T=(c.price??0)*(c.quantity??0),E=qa(),Y=localStorage.getItem(E),Ce=(Y?parseFloat(Y):0)-T;localStorage.setItem(E,Ce.toString());const ze=`userData_${y==null?void 0:y.uid}`,_e={cashBalance:Ce,lastUpdated:new Date().toISOString()};localStorage.setItem(ze,JSON.stringify(_e)),y!=null&&y.uid&&Se.updateUserData(y.uid,_e).catch(()=>{})}catch(T){console.warn("تعذر عكس رصيد الدرج النقدي عند حذف الإيصال:",T)}try{const T=Z.find(E=>c.barcode&&E.barcode===c.barcode||E.name===c.productName);if(T){const E=(T.quantity||0)+(c.quantity||0);await Zt(Je(J,"products",T.id),{quantity:E,updatedAt:ct()}),ae(Y=>Y.map(V=>V.id===T.id?{...V,quantity:E}:V))}}catch(T){console.warn("تعذر عكس المخزون عند حذف الإيصال:",T)}try{if(c.firestoreId){try{await As(Je(J,"dailySales",c.firestoreId))}catch{}try{await As(Je(J,"users",y.uid,"dailySales",c.firestoreId))}catch{}}else{let T;try{const E=Ue(Ne(J,"dailySales"),ie("userId","==",y.uid),ie("date","==",c.date),ie("productName","==",c.productName),Kr(5));T=await Qe(E)}catch{const E=Ue(Ne(J,"users",y.uid,"dailySales"),ie("date","==",c.date),ie("productName","==",c.productName),Kr(5));T=await Qe(E)}if(!T.empty){const E=T.docs.find(Y=>{const V=Y.data();return Number((V==null?void 0:V.sellingPrice)??0)===Number(c.price??0)&&Number((V==null?void 0:V.quantity)??0)===Number(c.quantity??0)&&String((V==null?void 0:V.time)??"")===String(c.time??"")})||T.docs[0];E&&await As(E.ref)}}}catch(T){console.warn("تعذر حذف سجل البيع من Firestore:",T)}try{const T=U(),E=`salesData_${y.uid}_${T}`,Y=`salesData_all_${y.uid}`,V=v.filter(Re=>Re.id!==c.id);localStorage.setItem(E,JSON.stringify(V));const Ce=localStorage.getItem(Y),ze=Ce?JSON.parse(Ce):[],_e=(Array.isArray(ze)?ze:[]).filter(Re=>(Re==null?void 0:Re.id)!==c.id);localStorage.setItem(Y,JSON.stringify(_e)),N(V)}catch(T){console.warn("تعذر تحديث التخزين المحلي بعد الحذف:",T)}try{Ie||await zt()}catch{}M({title:"تم حذف الإيصال",description:`تم حذف إيصال بيع للمنتج ${c.productName} وتم عكس الآثار`})}catch(T){console.error("Error deleting sale:",T),M({title:"فشل حذف الإيصال",description:"تعذّر حذف إيصال البيع",variant:"destructive"})}})}},Ps=async c=>{try{$(T=>({...T,[c.id]:"1"})),await Rs(c)}catch(T){console.error("Error selling by barcode:",T)}},Va=async c=>{if(O){M({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة قطع أثناء الورديه",variant:"destructive"});return}const T=W[c.id]||"",E=parseInt(T);if(isNaN(E)||E<=0){M({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للإضافة",variant:"destructive"});return}js("تأكيد إضافة قطع","لا يمكن إضافة قطع إلا بإدخال الرقم السري الرئيسي",async()=>{try{const Y=c.quantity+E;await Zt(Je(J,"products",c.id),{quantity:Y,updatedAt:ct()}),ae(V=>V.map(Ce=>Ce.id===c.id?{...Ce,quantity:Y}:Ce)),ge(V=>({...V,[c.id]:""})),M({title:"تمت الإضافة",description:`تمت إضافة ${E} قطعة إلى ${c.name}`})}catch(Y){console.error("Error adding pieces:",Y),M({title:"فشل الإضافة",description:"تعذّر إضافة الكمية إلى المخزون",variant:"destructive"})}})},gs=async c=>{if(!(y!=null&&y.uid))return;if(O){M({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف المنتجات أثناء الورديه",variant:"destructive"});return}window.confirm(`هل تريد حذف المنتج "${c.name}"؟`)&&js("تأكيد حذف منتج","لا يمكن حذف المنتجات إلا بإدخال الرقم السري الرئيسي",async()=>{try{await As(Je(J,"products",c.id)),ae(E=>E.filter(Y=>Y.id!==c.id)),M({title:"تم الحذف",description:`تم حذف المنتج ${c.name}`})}catch(E){console.error("Error deleting product:",E),M({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}})},lr=async()=>{try{if(!(y!=null&&y.uid)){M({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}if(O){M({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتجات أثناء الورديه",variant:"destructive"});return}const c=I.productName.trim(),T=parseFloat(I.price),E=parseFloat(I.wholesalePrice||"0"),Y=parseInt(I.quantity);if(!c||isNaN(T)||isNaN(Y)){M({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const V={name:c,sellingPrice:T,wholesalePrice:isNaN(E)?0:E,quantity:isNaN(Y)?0:Y,userId:y.uid,createdAt:ct(),updatedAt:ct()},Ce=(I.barcode||"").trim();Ce&&(V.barcode=Ce);const ze=(I.serialNumber||"").trim();ze&&(V.serialNumber=ze),w!=null&&w.shopId&&(V.shopId=w.shopId);const _e=await Zs(Ne(J,"products"),V);ae(Re=>[{id:_e.id,name:c,sellingPrice:T,wholesalePrice:isNaN(E)?0:E,quantity:isNaN(Y)?0:Y,barcode:(I.barcode||"").trim()||"",serialNumber:(I.serialNumber||"").trim()||""},...Re]),s({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),M({title:"تمت الإضافة",description:`تم إضافة المنتج ${c} بنجاح`})}catch(c){console.error("createProduct error",c),M({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}},Yt=async c=>{const T=(c||"").trim();if(!T)return;const E=Z.find(Y=>(Y.barcode||"")===T);if(!E){M({title:"باركود غير معروف",description:"لم يتم العثور على منتج بهذا الباركود"});return}await Ps(E)},Ja=()=>{const c=Object.entries(Ee).map(([Re,Be])=>{const he=Number(Be),jt=Z.find(Et=>Et.id===Re);return!jt||!he||he<=0?null:{name:jt.name,qty:he,price:jt.sellingPrice,total:he*jt.sellingPrice}}).filter(Boolean);if(c.length===0){M({title:"لم يتم اختيار منتجات",description:"فعّل وضع الفاتورة واختر منتجات وكميات للطباعة"});return}const T=(w==null?void 0:w.shopName)||(y==null?void 0:y.displayName)||"المحل",E=(w==null?void 0:w.phone)||(y==null?void 0:y.phoneNumber)||"",Y=c.reduce((Re,Be)=>Re+Be.total,0),V=new Date().toLocaleString("ar-EG"),Ce=c.map(Re=>`
        <tr>
          <td style="border:1px solid #ddd;padding:6px">${Re.name}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${Re.qty}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${Ut(Re.price)}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center;font-weight:bold;color:#0a7">${Ut(Re.total)}</td>
        </tr>
      `).join(""),ze=`
      <html>
        <head>
          <meta charset="utf-8" />
          <title>فاتورة</title>
          <style>
            body { font-family: Tahoma, Arial, sans-serif; direction: rtl; }
            .header { text-align: center; margin-bottom: 12px; }
            .header h2 { margin: 0; }
            .meta { text-align: center; color: #555; margin-bottom: 8px; }
            table { width: 100%; border-collapse: collapse; }
            .total { text-align: left; font-weight: bold; margin-top: 10px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>${T}</h2>
            ${E?`<div class="meta">رقم التليفون: ${E}</div>`:""}
            <div class="meta">التاريخ: ${V}</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="border:1px solid #ddd;padding:6px">المنتج</th>
                <th style="border:1px solid #ddd;padding:6px">الكمية</th>
                <th style="border:1px solid #ddd;padding:6px">السعر</th>
                <th style="border:1px solid #ddd;padding:6px">الإجمالي</th>
              </tr>
            </thead>
            <tbody>
              ${Ce}
            </tbody>
          </table>
          <div class="total">الإجمالي الكلي: ${Ut(Y)}</div>
        </body>
      </html>
    `,_e=window.open("","_blank");_e&&(_e.document.write(ze),_e.document.close(),_e.focus(),_e.print(),_e.close())};return e.jsxs(ye,{open:i,onOpenChange:p,children:[e.jsxs(be,{className:"max-w-none w-[100vw] md:w-[100vw] lg:w-[100vw] max-h-[85vh] md:h-[100dvh] md:max-h-[100dvh] p-0 overflow-y-auto",children:[e.jsx(ve,{className:"px-3 md:px-6 py-3 md:py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-blue-100 rounded-lg",children:e.jsx(si,{className:"h-5 w-5 md:h-6 md:w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(we,{className:"text-lg md:text-xl font-bold text-gray-800",children:"📊 قسم المبيعات"}),e.jsx("p",{className:"text-xs md:text-sm text-gray-600 mt-1 hidden sm:block",children:"إدارة وتتبع المبيعات"})]})]}),e.jsxs("div",{className:"flex items-center gap-1 md:gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:()=>Fe(),className:"text-xs md:text-sm",children:"استرجاع الإيصالات"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:p,className:"h-8 w-8 md:h-9 md:w-9",children:e.jsx(uc,{className:"h-4 w-4"})})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row h-full",dir:"rtl",children:[e.jsxs("div",{className:"w-full md:w-72 lg:w-80 bg-white/50 border-r",children:[e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(qt,{className:"h-4 w-4 text-green-600"}),"ملخص المبيعات"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:gap-3",children:[e.jsxs("div",{className:"bg-blue-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-blue-600",children:Ut(v.filter(c=>!c.isDeferred).reduce((c,T)=>c+T.price*T.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-blue-600",children:"إجمالي المبيعات"})]}),e.jsxs("div",{className:"relative bg-green-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsxs("div",{className:te?"filter blur-sm pointer-events-none":"",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-green-600",children:Ut(v.filter(c=>!c.isDeferred).reduce((c,T)=>c+(T.price-(T.wholesalePrice??0))*T.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-green-600",children:"إجمالي الأرباح"})]}),te&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>le(!0),className:"bg-white/80 hover:bg-white text-green-700 border border-green-200",children:"عرض الأرباح"})})]}),e.jsxs("div",{className:"bg-yellow-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-yellow-600",children:$a(Z.length)}),e.jsx("div",{className:"text-xs md:text-sm text-yellow-600",children:"عدد المنتجات"})]}),e.jsxs("div",{className:"bg-purple-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-purple-600",children:$a(v.filter(c=>!c.isDeferred).length)}),e.jsx("div",{className:"text-xs md:text-sm text-purple-600",children:"عدد المبيعات"})]})]}),e.jsxs("div",{className:"relative mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1 md:gap-2 text-xs md:text-sm font-semibold text-indigo-700",children:[e.jsx(Ua,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx(si,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{children:"تقارير الشهر"})]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>bt(c=>!c),className:"h-6 w-6 p-0 rounded-full",title:D?"إظهار التقارير":"إخفاء التقارير",children:D?e.jsx(sn,{className:"h-4 w-4"}):e.jsx(ei,{className:"h-4 w-4"})})]}),e.jsx("div",{className:D?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]",children:e.jsxs("div",{className:Ie?"grid grid-cols-2 gap-2 md:gap-4 filter blur-sm pointer-events-none":"grid grid-cols-2 gap-2 md:gap-4",children:[e.jsxs("div",{className:"bg-indigo-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-indigo-600",children:Ut(Vt)}),e.jsx("div",{className:"text-xs md:text-sm text-indigo-600",children:"مبيعات الشهر"})]}),e.jsxs("div",{className:"bg-pink-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-pink-600",children:Ut(Jt)}),e.jsx("div",{className:"text-xs md:text-sm text-pink-600",children:"أرباح الشهر"})]})]})}),!D&&Ie&&e.jsx("div",{className:"absolute left-0 right-0 top-7 md:top-10 bottom-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:async()=>{try{if(await isZeroPlan()){M({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}mt(!0)},className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all btn-monthly-reports",title:"عرض تقارير الشهر",children:[e.jsx(Ft,{className:"h-5 w-5 md:h-7 md:w-7"}),e.jsx("span",{className:"text-xs md:text-sm",children:"عرض تقارير الشهر"})]})})]})]}),e.jsx("div",{className:"flex justify-end mb-3",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:()=>At(!0),className:"h-7 px-3 rounded-full bg-green-50 hover:bg-green-100 text-green-700",title:"إيصالات البيع",children:[e.jsx(nn,{className:"h-4 w-4 mr-1"}),"إيصالات البيع"]})}),e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(Xr,{className:"h-4 w-4 text-indigo-600"}),"إحصائيات المنتجات"]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>ue(c=>!c),className:"h-6 w-6 p-0 rounded-full",title:F?"إظهار القسم":"إخفاء القسم",children:F?e.jsx(sn,{className:"h-4 w-4"}):e.jsx(ei,{className:"h-4 w-4"})})]}),e.jsx("div",{className:F?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]}),e.jsxs("div",{className:"p-3 md:p-4 flex-1 hidden md:block",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(pl,{className:"h-4 w-4 text-blue-600"}),"نصائح للمبيعات"]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>ft(c=>!c),className:"h-6 w-6 p-0 rounded-full",title:Pe?"إظهار القسم":"إخفاء القسم",children:Pe?e.jsx(sn,{className:"h-4 w-4"}):e.jsx(ei,{className:"h-4 w-4"})})]}),e.jsx("div",{className:Pe?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-visible transition-all duration-300 ease-in-out",children:e.jsxs("div",{className:"p-3 md:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-2",children:[e.jsxs("h2",{className:"text-base md:text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Bh,{className:"h-4 w-4 md:h-5 md:w-5 text-blue-600"}),"سجل المبيعات (",v.filter(c=>!c.isDeferred).length," عنصر)"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm text-gray-600",children:[e.jsx(Ua,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(Na,{className:"h-3 w-3 md:h-4 md:w-4 ml-2"}),e.jsx("span",{children:new Date().toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 md:p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(vs,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج جديد"]}),e.jsxs(h,{size:"sm",variant:"ghost",className:"h-8",onClick:()=>{if(O){M({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتج أثناء الورديه",variant:"destructive"});return}js("فتح نموذج إضافة منتج","أدخل الرقم السري الرئيسي لفتح نموذج الإضافة",()=>B(!0))},children:[e.jsx(vs,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج"]})]}),j&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(X,{htmlFor:"new-product-name",className:"text-xs md:text-sm",children:"اسم المنتج"}),e.jsx(q,{id:"new-product-name",value:I.productName,onChange:c=>s(T=>({...T,productName:c.target.value})),placeholder:"أدخل اسم المنتج"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(X,{htmlFor:"new-product-price",className:"text-xs md:text-sm",children:"سعر البيع (ج.م)"}),e.jsx(q,{type:"number",id:"new-product-price",value:I.price,onChange:c=>s(T=>({...T,price:c.target.value})),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(X,{htmlFor:"new-product-wholesale",className:"text-xs md:text-sm",children:"سعر الجملة (ج.م)"}),e.jsx(q,{type:"number",id:"new-product-wholesale",value:I.wholesalePrice||"",onChange:c=>s(T=>({...T,wholesalePrice:c.target.value})),placeholder:"0.00"})]})]}),e.jsxs("div",{children:[e.jsx(X,{htmlFor:"new-product-qty",className:"text-xs md:text-sm",children:"الكمية"}),e.jsx(q,{type:"number",id:"new-product-qty",value:I.quantity,onChange:c=>s(T=>({...T,quantity:c.target.value})),placeholder:"1"})]}),e.jsxs("div",{children:[e.jsx(X,{htmlFor:"new-product-barcode",className:"text-xs md:text-sm",children:"باركود المنتج (اختياري)"}),e.jsx(q,{id:"new-product-barcode",value:I.barcode||"",onChange:c=>s(T=>({...T,barcode:c.target.value})),placeholder:"أدخل/امسح الباركود"})]}),e.jsxs("div",{children:[e.jsx(X,{htmlFor:"new-product-serial",className:"text-xs md:text-sm",children:"سيريال الجهاز (اختياري)"}),e.jsx(q,{id:"new-product-serial",value:I.serialNumber||"",onChange:c=>s(T=>({...T,serialNumber:c.target.value})),placeholder:"أدخل سيريال الجهاز"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(h,{className:"h-9 w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white",onClick:lr,children:"إضافة المنتج"}),e.jsx(h,{variant:"outline",className:"h-9 w-full md:w-auto",onClick:()=>B(!1),children:"إغلاق"})]})]})]}),e.jsx("div",{id:"shop-products-section",className:"bg-white rounded-lg border border-gray-200 overflow-hidden mb-4",children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 mb-2 flex items-center gap-2",children:[e.jsx(Xr,{className:"h-4 w-4 text-green-600"}),"منتجات المحل"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(h,{variant:We?"default":"outline",size:"sm",onClick:()=>Ve(c=>!c),children:We?"وضع الفاتورة: مفعل":"تفعيل وضع الفاتورة"}),e.jsx(h,{size:"sm",className:"bg-indigo-600 hover:bg-indigo-700 text-white",disabled:Object.keys(Ee).filter(c=>(Ee[c]||0)>0).length===0,onClick:Ja,children:"طباعة فاتورة"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(q,{value:ia,onChange:c=>Ys(c.target.value),placeholder:"ابحث عن منتج...",className:"h-9 w-full md:w-72 text-sm","aria-label":"البحث عن منتج من منتجات المحل"}),e.jsx(q,{value:xe,onChange:c=>oe(c.target.value),onKeyDown:async c=>{if(c.key!=="Enter")return;const T=xe.trim();T&&(await Yt(T),oe(""))},placeholder:"مرّر ماسح الباركود هنا (اختياري)",className:"h-9 w-full md:w-64 text-sm","aria-label":"مسح الباركود لإضافة المنتج تلقائياً"}),ia&&e.jsx(h,{variant:"ghost",size:"sm",className:"h-9",onClick:()=>Ys(""),children:"مسح"})]}),e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg hidden md:block",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>dt(c=>!c),"aria-label":Ke?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Ke?e.jsx(ps,{className:"h-4 w-4"}):e.jsx(Ft,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المتاح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"بيع"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:ma.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-3 py-3 text-center text-gray-500",children:Z.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"})}):ma.map(c=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:c.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Ut(c.sellingPrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:e.jsx("span",{className:Ke?"":"blur-sm select-none",children:Ut(c.wholesalePrice)})}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:$a(c.quantity)}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 flex-nowrap",children:[e.jsx(q,{value:de[c.id]||"",onChange:T=>$(E=>({...E,[c.id]:T.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-8 w-28 text-sm"}),e.jsx(q,{value:ot[c.id]||"",onChange:T=>es(E=>({...E,[c.id]:T.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-8 w-32 text-sm","aria-label":`سعر بيع اختياري لـ ${c.name}`}),e.jsx(h,{size:"sm",className:"h-8 min-w-[64px] bg-indigo-600 hover:bg-indigo-700 text-white",onClick:()=>Rs(c),children:"بيع"}),e.jsx(h,{size:"sm",className:"h-8 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>{z(c),ts(!0)},children:"بيع أجل"}),We&&e.jsx(q,{value:Ee[c.id]??"",onChange:T=>{const E=parseInt(T.target.value||"0");He(Y=>({...Y,[c.id]:isNaN(E)?0:E}))},type:"number",placeholder:"كمية للفاتورة",className:"h-8 w-24 text-sm"}),e.jsx(q,{value:W[c.id]||"",onChange:T=>ge(E=>({...E,[c.id]:T.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-8 w-28 text-sm",disabled:O}),e.jsxs("div",{className:"inline-flex items-center gap-2 flex-nowrap",children:[e.jsx(h,{size:"sm",variant:"outline",className:"h-8 whitespace-nowrap",onClick:()=>Va(c),disabled:O,title:O?"غير مسموح في وضع الكاشير":void 0,children:"إضافة قطع جديدة"}),e.jsx(h,{size:"sm",variant:"destructive",className:"h-8",onClick:()=>gs(c),title:"حذف المنتج",disabled:O,children:e.jsx(is,{className:"h-4 w-4"})})]})]})})]},c.id))})]})}),e.jsx("div",{className:"block md:hidden space-y-3",children:ma.length===0?e.jsx("div",{className:"text-center text-gray-500 text-sm",children:Z.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"}):ma.map(c=>e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm break-words",children:c.name}),e.jsx(h,{size:"sm",variant:"destructive",className:"h-8 min-w-[44px] touch-manipulation",onClick:()=>gs(c),title:"حذف المنتج",disabled:O,children:e.jsx(is,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-700",children:[e.jsx("div",{className:"text-gray-600",children:"سعر البيع"}),e.jsx("div",{className:"text-right font-medium",children:Ut(c.sellingPrice)}),e.jsxs("div",{className:"text-gray-600 inline-flex items-center gap-1",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>dt(T=>!T),"aria-label":Ke?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Ke?e.jsx(ps,{className:"h-4 w-4"}):e.jsx(Ft,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:Ke?"":"blur-sm select-none",children:Ut(c.wholesalePrice)})}),e.jsx("div",{className:"text-gray-600",children:"المتاح"}),e.jsx("div",{className:"text-right font-medium",children:$a(c.quantity)})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{value:de[c.id]||"",onChange:T=>$(E=>({...E,[c.id]:T.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للبيع لـ ${c.name}`}),e.jsx(q,{value:ot[c.id]||"",onChange:T=>es(E=>({...E,[c.id]:T.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-9 w-28 text-sm","aria-label":`سعر بيع اختياري لـ ${c.name}`}),e.jsx(h,{size:"sm",className:"h-9 min-w-[64px] bg-indigo-600 hover:bg-indigo-700 text-white",onClick:()=>Rs(c),children:"بيع"}),e.jsx(h,{size:"sm",className:"h-9 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>{z(c),ts(!0)},children:"بيع أجل"})]}),We&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(q,{value:Ee[c.id]??"",onChange:T=>{const E=parseInt(T.target.value||"0");He(Y=>({...Y,[c.id]:isNaN(E)?0:E}))},type:"number",placeholder:"كمية للفاتورة",className:"h-9 flex-1 text-sm","aria-label":`كمية للفاتورة لـ ${c.name}`})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{value:W[c.id]||"",onChange:T=>ge(E=>({...E,[c.id]:T.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للإضافة لـ ${c.name}`,disabled:O}),e.jsx(h,{size:"sm",variant:"outline",className:"h-9 min-w-[64px]",onClick:()=>Va(c),disabled:O,title:O?"غير مسموح في وضع الكاشير":void 0,children:"إضافة"})]})]})]},c.id))})]})}),v.length===0?e.jsxs("div",{className:"text-center py-8 md:py-12",children:[e.jsx("div",{className:"w-16 h-16 md:w-24 md:h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx(Xr,{className:"h-8 w-8 md:h-12 md:w-12 text-gray-400"})}),e.jsx("h3",{className:"text-base md:text-lg font-medium text-gray-900 mb-2",children:"لا توجد مبيعات اليوم"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ابدأ ببيع منتج من القائمة أعلاه"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"block md:hidden",children:e.jsx("div",{className:"max-h-[70vh] overflow-y-auto space-y-3 p-3",children:v.map(c=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-200 shadow-sm",children:[e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-base break-words",children:c.productName}),c.isDeferred&&e.jsx("span",{className:"px-2 py-0.5 rounded bg-amber-100 text-amber-700 text-[11px]",children:"مؤجّل"})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qt,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر البيع"})]}),e.jsx("div",{className:"text-right font-medium",children:Ut(c.price)}),typeof c.wholesalePrice=="number"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qt,{className:"h-4 w-4 text-indigo-600"}),e.jsxs("span",{className:"text-gray-600 inline-flex items-center gap-1",children:["سعر الجملة",e.jsx(h,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>dt(T=>!T),"aria-label":Ke?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Ke?e.jsx(ps,{className:"h-4 w-4"}):e.jsx(Ft,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:Ke?"":"blur-sm select-none",children:Ut(c.wholesalePrice)})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Xr,{className:"h-4 w-4 text-emerald-600"}),e.jsx("span",{className:"text-gray-600",children:"الكمية"})]}),e.jsx("div",{className:"text-right font-medium",children:$a(c.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(en,{className:"h-4 w-4 text-indigo-600"}),e.jsx("span",{className:"text-gray-600",children:"الربح"})]}),e.jsx("div",{className:"text-right font-semibold text-indigo-600",children:e.jsx("span",{className:Ke?"":"blur-sm select-none",children:Ut(((c.price??0)-(c.wholesalePrice??0))*(c.quantity??0))})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qt,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"الإجمالي"})]}),e.jsx("div",{className:"text-right font-bold text-green-700",children:Ut(c.price*c.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Rh,{className:"h-4 w-4 text-amber-600"}),e.jsx("span",{className:"text-gray-600",children:"المنفذ"})]}),e.jsx("div",{className:"text-right text-gray-700",children:c.performedByName??"-"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ua,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"التاريخ"})]}),e.jsx("div",{className:"text-right text-gray-600",children:hl(c.date)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Na,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"الوقت"})]}),e.jsx("div",{className:"text-right text-gray-600",children:c.time})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[c.isDeferred&&e.jsx(h,{size:"sm",className:"h-8 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>Cr(c),title:"تم التسديد",children:"تم التسديد"}),e.jsx(h,{size:"sm",variant:"outline",onClick:()=>Ss(c,"return"),disabled:O,title:O?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsxs(h,{size:"sm",variant:"destructive",onClick:()=>Ss(c,"delete"),disabled:O,title:O?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:[e.jsx(is,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-1",children:"حذف الإيصال"})]})]})]},c.id))})}),e.jsx("div",{className:"hidden md:block overflow-x-auto max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-green-300 scrollbar-track-green-100 hover:scrollbar-thumb-green-400",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر البيع (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة (ج.م)"}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>dt(c=>!c),"aria-label":Ke?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Ke?e.jsx(ps,{className:"h-4 w-4"}):e.jsx(Ft,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الإجمالي (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الربح (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الوقت"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنفذ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"إجراءات"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:v.map((c,T)=>e.jsxs("tr",{className:T%2===0?"bg-white":"bg-gray-50/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:e.jsxs("div",{className:"flex items-center gap-2 justify-end md:justify-start",children:[e.jsx("span",{children:c.productName}),c.isDeferred&&e.jsx("span",{className:"px-2 py-0.5 rounded bg-amber-100 text-amber-700 text-xs",children:"مؤجّل"})]})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Ut(c.price)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:typeof c.wholesalePrice=="number"?e.jsx("span",{className:Ke?"":"blur-sm select-none",children:Ut(c.wholesalePrice)}):"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:$a(c.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-green-600",children:Ut(c.price*c.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-indigo-600",children:e.jsx("span",{className:Ke?"":"blur-sm select-none",children:Ut(((c.price??0)-(c.wholesalePrice??0))*(c.quantity??0))})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:hl(c.date)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:c.time}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:c.performedByName??"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[c.isDeferred&&e.jsx(h,{size:"sm",className:"h-8 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>Cr(c),title:"تم التسديد",children:"تم التسديد"}),e.jsx(h,{size:"sm",variant:"outline",onClick:()=>Ss(c,"return"),disabled:O,title:O?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsx(h,{size:"sm",variant:"destructive",onClick:()=>Ss(c,"delete"),disabled:O,title:O?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:e.jsx(is,{className:"h-4 w-4"})})]})})]},c.id))})]})})]})]})})]})]}),e.jsx(ye,{open:Da,onOpenChange:ts,children:e.jsxs(be,{className:"max-w-sm mx-auto bg-white border border-gray-200 shadow-2xl rounded-2xl sm:max-w-md",children:[e.jsx(ve,{className:"text-center",children:e.jsx(we,{className:"text-base md:text-lg font-bold text-gray-900",children:"بيع أجل"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsx(X,{className:"text-sm",children:"اختيار عميل (اختياري)"}),e.jsxs("select",{className:"h-9 border rounded px-2 text-sm",value:_,onChange:c=>{const T=c.target.value;ce(T);const E=Ws.find(Y=>Y.id===T);E&&(Ae(E.name),yt(E.mobile||""))},children:[e.jsx("option",{value:"",children:"-- بدون اختيار --"}),Ws.map(c=>e.jsxs("option",{value:c.id,children:[c.name,c.mobile?` - ${c.mobile}`:""]},c.id))]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsx(X,{className:"text-sm",children:"اسم العميل"}),e.jsx(q,{value:me,onChange:c=>Ae(c.target.value),placeholder:"اسم العميل",className:"h-9 text-sm"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsx(X,{className:"text-sm",children:"رقم التليفون (اختياري)"}),e.jsx(q,{value:Le,onChange:c=>yt(c.target.value),placeholder:"رقم التليفون",className:"h-9 text-sm"})]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-3 mt-3",children:[e.jsx(h,{variant:"outline",className:"h-8 min-w-[80px]",onClick:()=>ts(!1),children:"إلغاء"}),e.jsx(h,{className:"h-8 min-w-[100px] bg-amber-600 hover:bg-amber-700 text-white",onClick:async()=>{try{const c=rt;if(!c){ts(!1);return}const T=me.trim(),E=Le.trim()||void 0,Y=_||void 0;if(!T){M({title:"بيانات مطلوبة",description:"أدخل اسم العميل",variant:"destructive"});return}await Rs(c,!0,{id:Y,name:T,mobile:E});try{if(y!=null&&y.uid){const V=c.sellingPrice*(parseInt(de[c.id]||"0")||0),Ce=await Se.getUserData(y.uid),ze=Array.isArray(Ce==null?void 0:Ce.debts)?Ce.debts:[],_e={id:Date.now().toString(),debtorName:T,customerId:Y||null,mobile:E||null,amount:V,reason:`بيع أجل للمنتج ${c.name}`,status:"pending",createdAt:new Date,partialPayments:[]},Re=[_e,...ze];await Se.updateUserData(y.uid,{debts:Re});try{await sr.send(y.uid,`تم إضافة دين على ${_e.debtorName} بمبلغ ${_e.amount} جنيه`)}catch{}}}catch{}ts(!1),z(null)}catch{}},children:"تأكيد البيع الآجل"})]})]})}),e.jsx(ye,{open:_t,onOpenChange:At,children:e.jsxs(be,{className:"sm:max-w-3xl",children:[e.jsx(ve,{children:e.jsx(we,{children:"إيصالات البيع"})}),v.filter(c=>!c.isDeferred).length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا توجد إيصالات بيع حتى الآن."}):e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg max-h-[70vh] overflow-y-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر الجملة"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الإجمالي"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الربح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الوقت"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنفذ"})]})}),e.jsx("tbody",{children:v.filter(c=>!c.isDeferred).map(c=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:c.productName}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Ut(c.price)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Ut(c.wholesalePrice??0)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:$a(c.quantity)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Ut((c.price??0)*(c.quantity??0))}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Ut(((c.price??0)-(c.wholesalePrice??0))*(c.quantity??0))}),e.jsx("td",{className:"px-3 py-2 text-gray-500",children:hl(c.date)}),e.jsx("td",{className:"px-3 py-2 text-gray-500",children:c.time}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:c.executedBy||"-"})]},c.id))})]})}),e.jsx("div",{className:"flex justify-end mt-3",children:e.jsx(h,{variant:"outline",onClick:()=>At(!1),children:"إغلاق"})})]})}),e.jsx(ye,{open:ke,onOpenChange:K,children:e.jsxs(be,{className:"max-w-sm mx-auto bg-white border border-gray-200 shadow-2xl rounded-2xl sm:max-w-md",children:[e.jsx(ve,{className:"text-center",children:e.jsx(we,{className:"text-base md:text-lg font-bold text-gray-900",children:Qt==="return"?"تأكيد المرتجع":"تأكيد حذف الإيصال"})}),e.jsxs("div",{className:"space-y-3 text-center px-2",children:[e.jsxs("p",{className:"text-sm text-gray-700",children:["هل تريد ",Qt==="return"?"عمل مرتجع":"حذف الإيصال"," للمنتج:",e.jsxs("span",{className:"font-semibold text-gray-900",children:[" ",pt==null?void 0:pt.productName," "]}),"بكمية",e.jsxs("span",{className:"font-semibold text-gray-900",children:[" ",$a((pt==null?void 0:pt.quantity)||0)," "]}),"؟"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"سيتم عكس المخزون والرصيد حسب الحالة."})]}),e.jsxs("div",{className:"flex items-center justify-center gap-3 mt-2",children:[e.jsx(h,{variant:"outline",className:"h-8 min-w-[80px]",onClick:()=>K(!1),children:"إلغاء"}),e.jsx(h,{className:"h-8 min-w-[100px] bg-red-600 hover:bg-red-700 text-white",onClick:()=>{const c=pt;K(!1),c&&cn(c)},children:"تأكيد"})]})]})}),e.jsx(xs,{open:st,onOpenChange:le,mode:"verify",title:"قفل إجمالي الأرباح",description:"أدخل الرقم السري الرئيسي لعرض إجمالي الأرباح",onSuccess:()=>{fe(!1),le(!1)}}),e.jsx(xs,{open:et,onOpenChange:mt,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const c=y==null?void 0:y.uid;if(c){const T=await fl(c),E=(T==null?void 0:T.planType)??(T==null?void 0:T.plan)??null,Y=typeof E=="string"?E.toLowerCase():null;if(E===$s.ZERO||Y==="zero"){M({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}ht(!1),mt(!1),zt()}}),e.jsx(xs,{open:os,onOpenChange:vt,mode:"verify",title:Ze,description:Lt,onSuccess:()=>{const c=Rt.current;Rt.current=null,vt(!1),c&&c()}})]})}const $a=i=>new Intl.NumberFormat("ar-EG").format(Number(i||0)),Ut=i=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(i||0))} ج.م`,hl=i=>{try{const p=new Date(i);return isNaN(p.getTime())?new Date(`${i}T00:00:00`).toLocaleDateString("ar-EG"):p.toLocaleDateString("ar-EG")}catch{return i}},iu=({open:i,onOpenChange:p,userId:d,cashBalance:v,walletBalances:N,transactions:I})=>{const[s,j]=Ye.useState(0),[B,C]=Ye.useState(0),[L,M]=Ye.useState(0),[y,w]=Ye.useState(0),[O,G]=Ye.useState(v||0),[R,Z]=Ye.useState(!1),[ae,de]=Ye.useState(null),{toast:$}=Xs(),{shopId:W}=li()||{},[ge,De]=Ye.useState(!1),[pe,xe]=Ye.useState(""),[oe,We]=Ye.useState(!1),[Ve,Ee]=Ye.useState(!1),[He,Ke]=Ye.useState(""),dt=()=>`cashBalance_${d||"default"}_${W||"main"}`,te=()=>`cashBalance_${d||"default"}`,fe=Oe=>`${new Intl.NumberFormat("ar-EG").format(Number(Oe||0))} جنيه`;Ye.useEffect(()=>{const Oe=async()=>{try{if(!d){j(0);return}const Ie=new Date,ht=Ie.getFullYear(),D=String(Ie.getMonth()+1).padStart(2,"0"),bt=String(Ie.getDate()).padStart(2,"0"),_t=`${ht}-${D}-${bt}`;let At;try{const ue=Ue(Ne(J,"dailySales"),ie("userId","==",d),...W?[ie("shopId","==",W)]:[],ie("date","==",_t));At=await Qe(ue)}catch{const ue=Ue(Ne(J,"users",d,"dailySales"),...W?[ie("shopId","==",W)]:[],ie("date","==",_t));At=await Qe(ue)}let F=0;At.forEach(ue=>{const Pe=ue.data(),ft=Number(Pe.sellingPrice??0),ot=Number(Pe.quantity??0);ft>0&&ot>0&&(F+=ft*ot)}),j(F)}catch(Ie){console.warn("فشل تحميل مبيعات الإكسسوار لليوم:",Ie)}},et=async()=>{try{if(!d){setMaintenanceProfitToday(0);return}const Ie=new Date,ht=new Date(Ie.getFullYear(),Ie.getMonth(),Ie.getDate(),0,0,0,0),D=new Date(Ie.getFullYear(),Ie.getMonth(),Ie.getDate(),23,59,59,999);let bt;try{const At=Ue(Ne(J,"maintenance_items"),ie("userId","==",d),ie("status","==","completed"));bt=await Qe(At)}catch{bt=await Qe(Ue(Ne(J,"maintenance_items"),ie("userId","==",d)))}let _t=0;bt.forEach(At=>{var Pe,ft;const F=At.data();if((F.status||"in_progress")!=="completed")return;const ue=(ft=(Pe=F.completedAt)==null?void 0:Pe.toDate)==null?void 0:ft.call(Pe);if(ue&&ue.getTime()>=ht.getTime()&&ue.getTime()<=D.getTime()){const ot=Number(F.repairPrice||0);Number.isFinite(ot)&&ot>0&&(_t+=ot)}}),M(Math.max(0,_t))}catch(Ie){console.warn("فشل تحميل إجمالي فلوس الصيانة لليوم:",Ie)}},mt=async()=>{try{if(!d){C(0);return}const Ie=await Se.getUserData(d),ht=new Date().toISOString().slice(0,10),D=(Ie==null?void 0:Ie.dailyReceipts)||{};D!=null&&D.date&&String(D.date).slice(0,10)===ht?(C(Number(D.accessory||0)),w(Number(D.maintenance||0))):(C(0),w(0));try{const bt=localStorage.getItem(te()),_t=localStorage.getItem(dt()),At=bt??_t;At!=null?G(Number(At)||0):G(Number((Ie==null?void 0:Ie.cashBalance)||v||0))}catch{G(Number((Ie==null?void 0:Ie.cashBalance)||v||0))}}catch{C(0),w(0)}};i&&(Oe(),et(),mt())},[i,d,I,v,W]),Ye.useEffect(()=>{const Oe=et=>{var mt;try{const Ie=Number((mt=et==null?void 0:et.detail)==null?void 0:mt.value);if(Number.isFinite(Ie))G(Ie);else{const ht=localStorage.getItem(te()),D=localStorage.getItem(dt()),bt=ht??D;bt!=null&&G(parseFloat(bt)||0)}}catch{const Ie=localStorage.getItem(te()),ht=localStorage.getItem(dt()),D=Ie??ht;D!=null&&G(parseFloat(D)||0)}};return window.addEventListener("cashBalanceChanged",Oe),()=>window.removeEventListener("cashBalanceChanged",Oe)},[i,d,W]);const st=Math.max(0,Number(s)-Number(B)),le=Math.max(0,Number(L)-Number(y)),Te=async Oe=>{if(!d)return;const et=new Date().toISOString().slice(0,10);try{const mt=Oe==="accessory"?st:le;if(mt<=0){$({title:"لا يوجد مبلغ لتأكيد استلامه",variant:"default"});return}const Ie=Math.max(0,Number(O)-mt);G(Ie),Oe==="accessory"?C(ht=>ht+mt):w(ht=>ht+mt),await Se.updateUserData(d,{cashBalance:Ie,dailyReceipts:{date:et,accessory:Oe==="accessory"?B+mt:B,maintenance:Oe==="maintenance"?y+mt:y}});try{localStorage.setItem(`cashBalance_${d}`,String(Ie)),localStorage.setItem(dt(),String(Ie))}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:Ie}}))}catch{}$({title:"تم الاستلام",description:`تم خصم ${mt.toFixed(2)} من الدرج وتصفير بند ${Oe==="accessory"?"الإكسسوار":"الصيانة"}`})}catch{$({title:"خطأ",description:"تعذر تنفيذ عملية تم الاستلام",variant:"destructive"})}},xt=()=>{xe(""),Ke(""),De(!0)},Vt=()=>{if(!pe.trim()){$({title:"سبب الخصم مطلوب",variant:"destructive"});return}De(!1),We(!0)},kt=()=>{We(!1),Ee(!0)},Jt=async()=>{try{if(!d)return;const Oe=Math.max(0,Number(He||0));if(!Number.isFinite(Oe)||Oe<=0){$({title:"مبلغ غير صالح",description:"أدخل مبلغ خصم صحيح أكبر من الصفر",variant:"destructive"});return}const et=Math.max(0,Number(O)-Oe);G(et),await Se.updateUserData(d,{cashBalance:et});try{localStorage.setItem(`cashBalance_${d}`,String(et))}catch{}try{localStorage.setItem(dt(),String(et))}catch{}const mt={title:"ايصال خصم من الفلوس النقديه",type:"cash_deduction",amount:Oe,status:"completed",createdAt:new Date,note:pe,cashierName:"الحساب الرئيسي"};try{await Se.saveUserTransaction(d,mt)}catch{}$({title:"تم الخصم",description:`تم خصم ${Oe.toFixed(2)} من الدرج`}),Ee(!1),Ke(""),xe("")}catch{$({title:"فشل الخصم",description:"تعذر تنفيذ عملية الخصم",variant:"destructive"})}};return e.jsx(ye,{open:i,onOpenChange:p,children:e.jsxs(be,{className:"sm:max-w-lg animate-in fade-in-90 zoom-in-95 slide-in-from-top-4",dir:"rtl",children:[e.jsx(ve,{children:e.jsxs(we,{className:"flex items-center gap-2 text-right",children:[e.jsx(qt,{className:"h-5 w-5 text-emerald-600"}),"تفاصيل الفلوس النقدية"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between bg-amber-50 border border-amber-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 font-bold text-sm",children:[e.jsx(qt,{className:"h-4 w-4"}),"مجموع الفلوس النقدية (الدرج)"]}),e.jsx("div",{className:"text-amber-700 font-extrabold text-sm",children:fe(O)})]}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 font-bold text-sm",children:[e.jsx(Xr,{className:"h-4 w-4"}),"فلوس الاكسسوار"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-blue-700 font-extrabold text-sm",children:fe(st)}),e.jsx(h,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800",onClick:()=>{de("accessory"),Z(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-emerald-50 border border-emerald-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-800 font-bold text-sm",children:[e.jsx(yl,{className:"h-4 w-4"}),"فلوس الصيانة"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-emerald-700 font-extrabold text-sm",children:fe(le)}),e.jsx(h,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800",onClick:()=>{de("maintenance"),Z(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-red-800 font-bold text-sm",children:"خصم فلوس من الفلوس النقديه"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800",onClick:xt,children:"خصم"})})]})]}),e.jsx(xs,{open:R,onOpenChange:Z,mode:"verify",title:"تأكيد الرقم السري لعملية تم الاستلام",description:"يرجى إدخال الرقم السري الرئيسي لتأكيد استلام المبلغ",onSuccess:()=>{ae&&(Te(ae),de(null)),Z(!1)}}),e.jsx(ye,{open:ge,onOpenChange:De,children:e.jsxs(be,{className:"sm:max-w-sm",children:[e.jsx(ve,{children:e.jsx(we,{children:"سبب الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"deduct-reason",children:"اكتب سبب الخصم"}),e.jsx(q,{id:"deduct-reason",value:pe,onChange:Oe=>xe(Oe.target.value),placeholder:"سبب الخصم"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(h,{variant:"outline",onClick:()=>De(!1),children:"إلغاء"}),e.jsx(h,{onClick:Vt,className:"bg-red-600 hover:bg-red-700",children:"متابعة"})]})]})}),e.jsx(xs,{open:oe,onOpenChange:We,mode:"verify",title:"تأكيد الرقم السري لعملية الخصم",description:"يرجى إدخال الرقم السري الرئيسي لمتابعة الخصم",onSuccess:kt}),e.jsx(ye,{open:Ve,onOpenChange:Ee,children:e.jsxs(be,{className:"sm:max-w-sm",children:[e.jsx(ve,{children:e.jsx(we,{children:"مبلغ الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"deduct-amount",children:"أدخل مبلغ الخصم"}),e.jsx(q,{id:"deduct-amount",type:"number",value:He,onChange:Oe=>Ke(Oe.target.value),placeholder:"0.00"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(h,{variant:"outline",onClick:()=>Ee(!1),children:"إلغاء"}),e.jsx(h,{onClick:Jt,className:"bg-red-600 hover:bg-red-700",children:"تأكيد الخصم"})]})]})})]})})};function Ic({size:i=24,className:p,...d}){return e.jsxs("svg",{width:i,height:i,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:p,...d,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}var Ac="AlertDialog",[lu]=eh(Ac,[pc]),Sa=pc(),Tc=i=>{const{__scopeAlertDialog:p,...d}=i,v=Sa(p);return e.jsx(Qm,{...v,...d,modal:!0})};Tc.displayName=Ac;var ou="AlertDialogTrigger",cu=n.forwardRef((i,p)=>{const{__scopeAlertDialog:d,...v}=i,N=Sa(d);return e.jsx(lh,{...N,...v,ref:p})});cu.displayName=ou;var du="AlertDialogPortal",Pc=i=>{const{__scopeAlertDialog:p,...d}=i,v=Sa(p);return e.jsx(Zm,{...v,...d})};Pc.displayName=du;var mu="AlertDialogOverlay",kc=n.forwardRef((i,p)=>{const{__scopeAlertDialog:d,...v}=i,N=Sa(d);return e.jsx(ih,{...N,...v,ref:p})});kc.displayName=mu;var Dr="AlertDialogContent",[hu,uu]=lu(Dr),xu=ah("AlertDialogContent"),_c=n.forwardRef((i,p)=>{const{__scopeAlertDialog:d,children:v,...N}=i,I=Sa(d),s=n.useRef(null),j=gc(p,s),B=n.useRef(null);return e.jsx(Xm,{contentName:Dr,titleName:Oc,docsSlug:"alert-dialog",children:e.jsx(hu,{scope:d,cancelRef:B,children:e.jsxs(th,{role:"alertdialog",...I,...N,ref:j,onOpenAutoFocus:sh(N.onOpenAutoFocus,C=>{var L;C.preventDefault(),(L=B.current)==null||L.focus({preventScroll:!0})}),onPointerDownOutside:C=>C.preventDefault(),onInteractOutside:C=>C.preventDefault(),children:[e.jsx(xu,{children:v}),e.jsx(gu,{contentRef:s})]})})})});_c.displayName=Dr;var Oc="AlertDialogTitle",Ec=n.forwardRef((i,p)=>{const{__scopeAlertDialog:d,...v}=i,N=Sa(d);return e.jsx(rh,{...N,...v,ref:p})});Ec.displayName=Oc;var Mc="AlertDialogDescription",$c=n.forwardRef((i,p)=>{const{__scopeAlertDialog:d,...v}=i,N=Sa(d);return e.jsx(nh,{...N,...v,ref:p})});$c.displayName=Mc;var pu="AlertDialogAction",Lc=n.forwardRef((i,p)=>{const{__scopeAlertDialog:d,...v}=i,N=Sa(d);return e.jsx(fc,{...N,...v,ref:p})});Lc.displayName=pu;var Wc="AlertDialogCancel",Fc=n.forwardRef((i,p)=>{const{__scopeAlertDialog:d,...v}=i,{cancelRef:N}=uu(Wc,d),I=Sa(d),s=gc(p,N);return e.jsx(fc,{...I,...v,ref:s})});Fc.displayName=Wc;var gu=({contentRef:i})=>{const p=`\`${Dr}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${Dr}\` by passing a \`${Mc}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${Dr}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return n.useEffect(()=>{var v;document.getElementById((v=i.current)==null?void 0:v.getAttribute("aria-describedby"))||console.warn(p)},[p,i]),null},fu=Tc,yu=Pc,Rc=kc,Bc=_c,Uc=Lc,zc=Fc,qc=Ec,Vc=$c;const bu=fu,vu=yu,Jc=n.forwardRef(({className:i,...p},d)=>e.jsx(Rc,{className:nr("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",i),...p,ref:d}));Jc.displayName=Rc.displayName;const Kc=n.forwardRef(({className:i,...p},d)=>e.jsxs(vu,{children:[e.jsx(Jc,{}),e.jsx(Bc,{ref:d,className:nr("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",i),...p})]}));Kc.displayName=Bc.displayName;const Yc=({className:i,...p})=>e.jsx("div",{className:nr("flex flex-col space-y-2 text-center sm:text-left",i),...p});Yc.displayName="AlertDialogHeader";const Hc=n.forwardRef(({className:i,...p},d)=>e.jsx(qc,{ref:d,className:nr("text-lg font-semibold",i),...p}));Hc.displayName=qc.displayName;const Gc=n.forwardRef(({className:i,...p},d)=>e.jsx(Vc,{ref:d,className:nr("text-sm text-muted-foreground",i),...p}));Gc.displayName=Vc.displayName;const gl=n.forwardRef(({className:i,...p},d)=>e.jsx(Uc,{ref:d,className:nr(yc(),i),...p}));gl.displayName=Uc.displayName;const Qc=n.forwardRef(({className:i,...p},d)=>e.jsx(zc,{ref:d,className:nr(yc({variant:"outline"}),"mt-2 sm:mt-0",i),...p}));Qc.displayName=zc.displayName;const Mt=i=>{try{return i.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(i)}},oc=i=>{try{return(i?new Date(i):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},ya="machine_daily_opening_values",ba="machine_daily_opening_snapshot";function wu({open:i,onOpenChange:p}){const{toast:d}=Xs(),{shiftUser:v}=ln(),{shopId:N,shopName:I}=li(),s=()=>{try{const _=Object.keys(localStorage||{}).filter(ce=>ce.startsWith("selectedShopId_"));for(const ce of _){const me=localStorage.getItem(ce);if(me)return me}return null}catch{return null}};n.useEffect(()=>{try{if(i){const _=document.body.style.overflow;document.body.setAttribute("data-prev-overflow",_),document.body.style.overflow="hidden"}else{const _=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=_,document.body.removeAttribute("data-prev-overflow")}}catch{}return()=>{try{const _=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=_,document.body.removeAttribute("data-prev-overflow")}catch{}}},[i]);const[j,B]=n.useState(""),[C,L]=n.useState(""),[M,y]=n.useState(""),[w,O]=n.useState(null),[G,R]=n.useState(null),[Z,ae]=n.useState(null),[de,$]=n.useState(null),[W,ge]=n.useState(!1),[De,pe]=n.useState(!1),[xe,oe]=n.useState(""),[We,Ve]=n.useState(""),[Ee,He]=n.useState(null),[Ke,dt]=n.useState([]),[te,fe]=n.useState([]),[st,le]=n.useState(!1),[Te,xt]=n.useState(""),[Vt,kt]=n.useState(""),[Jt,Oe]=n.useState(!1),[et,mt]=n.useState(null),[Ie,ht]=n.useState([]),[D,bt]=n.useState(null),[_t,At]=n.useState(""),[F,ue]=n.useState(!1),[Pe,ft]=n.useState(!1);n.useEffect(()=>{if(i)try{const _=D?`${ya}_${D}`:ya,ce=D?`${ba}_${D}`:ba,me=localStorage.getItem(_);if(me){const Le=JSON.parse(me);typeof(Le==null?void 0:Le.openingBase)=="number"&&O(Le.openingBase),typeof(Le==null?void 0:Le.openingAir)=="number"&&R(Le.openingAir),typeof(Le==null?void 0:Le.drawerCash)=="number"&&ae(Le.drawerCash)}else O(null),R(null),ae(null);const Ae=localStorage.getItem(ce);if(Ae){const Le=JSON.parse(Ae);typeof(Le==null?void 0:Le.openingBase)=="number"&&typeof(Le==null?void 0:Le.openingAir)=="number"?$({openingBase:Le.openingBase,openingAir:Le.openingAir,drawerCash:Le.drawerCash||0}):$(null)}else $(null)}catch{}},[i,D]),n.useEffect(()=>{(async()=>{try{const _=N||s();if(!i||!_)return;const{getDocs:ce}=await Nt(async()=>{const{getDocs:yt}=await import("./index-DKHjTn06.js").then(rt=>rt.bH);return{getDocs:yt}},__vite__mapDeps([0,1]),import.meta.url),me=Ne(J,"shops",_,"machines"),Le=(await ce(Ue(me))).docs.map(yt=>({id:yt.id,name:String(yt.data().name||"ماكينة")}));ht(Le);try{const yt=localStorage.getItem(`machineDaily_selected_${_}`);yt&&Le.some(z=>z.id===yt)?bt(yt):!D&&Le.length>0&&(bt(Le[0].id),localStorage.setItem(`machineDaily_selected_${_}`,Le[0].id))}catch{}}catch(_){console.error("Load machines error:",_)}})()},[i,N]);const ot=n.useMemo(()=>(v==null?void 0:v.displayName)||(v==null?void 0:v.name)||(v==null?void 0:v.username)||void 0,[v]),es=n.useMemo(()=>te.reduce((_,ce)=>_+(ce.profit||0),0),[te]),os=n.useMemo(()=>te.reduce((_,ce)=>_+(ce.wholesalePrice||0),0),[te]),vt=async()=>{try{const _=N||s();if(_&&D){const ce=Ne(J,"shops",_,"machines",D,"transfers"),me=await Qe(Ue(ce));await Promise.all(me.docs.map(Ae=>As(Ae.ref)));try{localStorage.setItem(`machineDaily_transfers_${_}_${D}`,JSON.stringify([]))}catch{}}}catch{}fe([]),d({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."})},Ze=async()=>{try{const _=N||s();if(_&&D){const ce=Ne(J,"shops",_,"machines",D,"deliveries"),me=await Qe(Ue(ce));await Promise.all(me.docs.map(Ae=>As(Ae.ref)));try{localStorage.setItem(`machineDaily_deliveries_${_}_${D}`,JSON.stringify([]))}catch{}}}catch{}dt([]),d({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."})},Tt=_=>{dt(ce=>ce.filter(me=>me.id!==_)),d({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},Lt=()=>{O(null),R(null),ae(null),$(null),B(""),L(""),y("");try{const _=D?`${ya}_${D}`:ya,ce=D?`${ba}_${D}`:ba;localStorage.removeItem(_),localStorage.removeItem(ce)}catch{}d({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},ea=async()=>{var Ae;const _=parseFloat(j||"0"),ce=parseFloat(C||"0"),me=parseFloat(M||"0");if(isNaN(_)||isNaN(ce)||isNaN(me)){d({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(_<0||ce<0||me<0){d({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}O(_),R(ce),ae(me);try{const Le=D?`${ya}_${D}`:ya,yt=D?`${ba}_${D}`:ba;localStorage.setItem(Le,JSON.stringify({openingBase:_,openingAir:ce,drawerCash:me})),localStorage.setItem(yt,JSON.stringify({openingBase:_,openingAir:ce,drawerCash:me})),$({openingBase:_,openingAir:ce,drawerCash:me});const rt=N||s();if(rt&&D){const z=Je(J,"shops",rt,"machines",D);await Qs(z,{name:((Ae=Ie.find(ke=>ke.id===D))==null?void 0:Ae.name)||"ماكينة",openingBase:_,openingAir:ce,drawerCash:me,cashierName:ot,shopName:I||null,updatedAt:ct()},{merge:!0})}}catch{}d({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${Mt(_)}، الهواء: ${Mt(ce)}، فلوس الدرج: ${Mt(me)}`})},Rt=()=>{if(w==null||G==null){d({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}pe(!0)},js=()=>{const _=parseFloat(xe||"0"),ce=parseFloat(We||"0");if(isNaN(_)||isNaN(ce)){d({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(_<0||ce<0){d({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const me=(de==null?void 0:de.openingBase)??(w||0),Ae=(de==null?void 0:de.openingAir)??(G||0),Le=me+Ae,rt=_+ce-Le;He(rt);const z={id:`${Date.now()}`,openingBase:me,openingAir:Ae,deliveryBase:_,deliveryAir:ce,netResult:rt,createdAt:new Date().toISOString(),cashierName:ot,requiredDrawerNoProfit:rt<0?Math.round(-rt*100)/100:0};(async()=>{try{const ke=N||s();ke&&D&&(await Zs(Ne(J,"shops",ke,"machines",D,"deliveries"),{cashierName:ot,openingBase:me,openingAir:Ae,deliveryBase:_,deliveryAir:ce,netResult:rt,createdAt:ct()}),await Qs(Je(J,"shops",ke,"machines",D),{lastDeliveryAt:ct(),updatedAt:ct()},{merge:!0}))}catch(ke){console.error("Persist delivery error:",ke)}})(),dt(ke=>[z,...ke]);try{const ke=N||s(),K=ke&&D?`machineDaily_deliveries_${ke}_${D}`:`machineDaily_deliveries_${D}`,pt=localStorage.getItem(K),Ct=pt?JSON.parse(pt):[],Qt=[z,...Array.isArray(Ct)?Ct:[]];localStorage.setItem(K,JSON.stringify(Qt))}catch{}d({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${Mt(rt)}`})},Ws=()=>{const _=parseFloat(Te||"0"),ce=parseFloat(Vt||"0");if(!Number.isFinite(_)||!Number.isFinite(ce)){d({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if(_<0||ce<0){d({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(w==null||G==null){d({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const me=Math.round((ce-_)*100)/100;mt({wholesalePrice:_,retailPrice:ce,profit:me}),Oe(!0)},Fs=async _=>{if(!et)return;const ce={id:`transfer_${Date.now()}`,wholesalePrice:et.wholesalePrice,retailPrice:et.retailPrice,profit:et.profit,createdAt:new Date().toISOString(),cashierName:ot,deductFrom:_},me=et.wholesalePrice,Ae=w??0,Le=G??0,yt=Z??0;if(me>(_==="base"?Ae:Le)){d({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const z=_==="base"?Math.round((Ae-me)*100)/100:Ae,ke=_==="air"?Math.round((Le-me)*100)/100:Le,K=et.retailPrice,pt=Math.round((yt+K)*100)/100;O(z),R(ke),ae(pt);try{const Ct=D?`${ya}_${D}`:ya,Qt=D?`${ba}_${D}`:ba;localStorage.setItem(Ct,JSON.stringify({openingBase:z,openingAir:ke,drawerCash:pt})),localStorage.setItem(Qt,JSON.stringify({openingBase:z,openingAir:ke,drawerCash:pt}));const ss=N||s();if(ss&&D){const Ss=Je(J,"shops",ss,"machines",D);await Qs(Ss,{openingBase:z,openingAir:ke,drawerCash:pt,cashierName:ot,updatedAt:ct()},{merge:!0}),await Zs(Ne(J,"shops",ss,"machines",D,"transfers"),{wholesalePrice:et.wholesalePrice,retailPrice:et.retailPrice,profit:et.profit,deductFrom:_,cashierName:ot,createdAt:ct()})}}catch{}fe(Ct=>[ce,...Ct]);try{const Ct=N||s(),Qt=Ct&&D?`machineDaily_transfers_${Ct}_${D}`:"machineDaily_transfers",ss=localStorage.getItem(Qt),Ss=ss?JSON.parse(ss):[],ia=[ce,...Array.isArray(Ss)?Ss:[]];localStorage.setItem(Qt,JSON.stringify(ia))}catch{}le(!1),xt(""),kt(""),mt(null),Oe(!1),d({title:"تم تسجيل تحويل",description:`الربح الفوري: ${Mt(ce.profit)} | خصم المخزون: -${Mt(me)} (${_==="base"?"الأساسي":"الهواء"}) | درج (المباع فقط): +${Mt(K)}`})},Da=()=>{B(""),L(""),pe(!1),oe(""),Ve(""),He(null)};n.useEffect(()=>{const _=N||s();if(!(!i||!_||!D))try{const ce=Ne(J,"shops",_,"machines",D,"transfers"),me=Ls(ce,async Ae=>{const yt=[...Ae.docs.map(rt=>{var pt,Ct;const z=rt.data(),ke=(Ct=(pt=z==null?void 0:z.createdAt)==null?void 0:pt.toDate)!=null&&Ct.call(pt)?z.createdAt.toDate():new Date,K=z==null?void 0:z.deductFrom;return{id:rt.id,wholesalePrice:Number((z==null?void 0:z.wholesalePrice)||0),retailPrice:Number((z==null?void 0:z.retailPrice)||0),profit:Number((z==null?void 0:z.profit)??(Number((z==null?void 0:z.retailPrice)||0)-Number((z==null?void 0:z.wholesalePrice)||0)||0)),createdAt:ke.toISOString(),cashierName:(z==null?void 0:z.cashierName)||void 0,deductFrom:K==="base"||K==="air"?K:void 0}})].sort((rt,z)=>{const ke=new Date(rt.createdAt).getTime();return new Date(z.createdAt).getTime()-ke});if(yt.length>0){fe(yt),ue(!0);try{localStorage.setItem(`machineDaily_transfers_${_}_${D}`,JSON.stringify(yt))}catch{}}else if(F){fe([]);try{localStorage.setItem(`machineDaily_transfers_${_}_${D}`,JSON.stringify([]))}catch{}}});return()=>{try{me()}catch{}}}catch{}},[i,N,D,F]),n.useEffect(()=>{const _=N||s();if(!(!i||!_||!D))try{const ce=Ne(J,"shops",_,"machines",D,"deliveries"),me=Ls(ce,Ae=>{const yt=[...Ae.docs.map(rt=>{var K,pt;const z=rt.data(),ke=(pt=(K=z==null?void 0:z.createdAt)==null?void 0:K.toDate)!=null&&pt.call(K)?z.createdAt.toDate():new Date;return{id:rt.id,openingBase:Number((z==null?void 0:z.openingBase)||0),openingAir:Number((z==null?void 0:z.openingAir)||0),deliveryBase:Number((z==null?void 0:z.deliveryBase)||0),deliveryAir:Number((z==null?void 0:z.deliveryAir)||0),netResult:typeof(z==null?void 0:z.netResult)=="number"?Number(z.netResult):Math.round((Number((z==null?void 0:z.deliveryBase)||0)+Number((z==null?void 0:z.deliveryAir)||0)-(Number((z==null?void 0:z.openingBase)||0)+Number((z==null?void 0:z.openingAir)||0)))*100)/100,createdAt:ke.toISOString(),cashierName:(z==null?void 0:z.cashierName)||void 0,requiredDrawerNoProfit:typeof(z==null?void 0:z.requiredDrawerNoProfit)=="number"?z.requiredDrawerNoProfit:void 0}})].sort((rt,z)=>new Date(z.createdAt).getTime()-new Date(rt.createdAt).getTime());if(yt.length>0){dt(yt),ft(!0);try{localStorage.setItem(`machineDaily_deliveries_${_}_${D}`,JSON.stringify(yt))}catch{}}else if(Pe){dt([]);try{localStorage.setItem(`machineDaily_deliveries_${_}_${D}`,JSON.stringify([]))}catch{}}});return()=>{try{me()}catch{}}}catch{}},[i,N,D,Pe]),n.useEffect(()=>{if(!(!i||!D))try{const _=N||s(),ce=_?`machineDaily_deliveries_${_}_${D}`:`machineDaily_deliveries_${D}`,me=localStorage.getItem(ce);if(me){const Ae=JSON.parse(me);Array.isArray(Ae)&&Ae.length>0&&dt(Ae)}(async()=>{try{const Ae=N||s();if(!Ae)return;const Le=Ne(J,"shops",Ae,"machines",D,"deliveries"),z=[...(await Qe(Ue(Le))).docs.map(ke=>{var Ct,Qt;const K=ke.data(),pt=(Qt=(Ct=K==null?void 0:K.createdAt)==null?void 0:Ct.toDate)!=null&&Qt.call(Ct)?K.createdAt.toDate():new Date;return{id:ke.id,openingBase:Number((K==null?void 0:K.openingBase)||0),openingAir:Number((K==null?void 0:K.openingAir)||0),deliveryBase:Number((K==null?void 0:K.deliveryBase)||0),deliveryAir:Number((K==null?void 0:K.deliveryAir)||0),netResult:typeof(K==null?void 0:K.netResult)=="number"?Number(K.netResult):Math.round((Number((K==null?void 0:K.deliveryBase)||0)+Number((K==null?void 0:K.deliveryAir)||0)-(Number((K==null?void 0:K.openingBase)||0)+Number((K==null?void 0:K.openingAir)||0)))*100)/100,createdAt:pt.toISOString(),cashierName:(K==null?void 0:K.cashierName)||void 0,requiredDrawerNoProfit:typeof(K==null?void 0:K.requiredDrawerNoProfit)=="number"?K.requiredDrawerNoProfit:void 0}})].sort((ke,K)=>new Date(K.createdAt).getTime()-new Date(ke.createdAt).getTime());if(z.length>0){dt(z);try{localStorage.setItem(`machineDaily_deliveries_${Ae}_${D}`,JSON.stringify(z))}catch{}}}catch{}})()}catch{}},[i,N,D]),n.useEffect(()=>{if(!(!i||!D))try{const _=N||s(),ce=_?`machineDaily_transfers_${_}_${D}`:`machineDaily_transfers_${D}`,me=localStorage.getItem(ce);if(me){const Ae=JSON.parse(me);Array.isArray(Ae)&&Ae.length>0&&fe(Ae)}(async()=>{try{const Ae=N||s();if(!Ae)return;const Le=Ne(J,"shops",Ae,"machines",D,"transfers"),z=[...(await Qe(Ue(Le))).docs.map(ke=>{var Qt,ss;const K=ke.data(),pt=(ss=(Qt=K==null?void 0:K.createdAt)==null?void 0:Qt.toDate)!=null&&ss.call(Qt)?K.createdAt.toDate():new Date,Ct=K==null?void 0:K.deductFrom;return{id:ke.id,wholesalePrice:Number((K==null?void 0:K.wholesalePrice)||0),retailPrice:Number((K==null?void 0:K.retailPrice)||0),profit:Number((K==null?void 0:K.profit)??(Number((K==null?void 0:K.retailPrice)||0)-Number((K==null?void 0:K.wholesalePrice)||0)||0)),createdAt:pt.toISOString(),cashierName:(K==null?void 0:K.cashierName)||void 0,deductFrom:Ct==="base"||Ct==="air"?Ct:void 0}})].sort((ke,K)=>new Date(K.createdAt).getTime()-new Date(ke.createdAt).getTime());if(z.length>0){fe(z);try{localStorage.setItem(`machineDaily_transfers_${Ae}_${D}`,JSON.stringify(z))}catch{}}}catch{}})()}catch{}},[i,N,D]);const ts=_=>{_||Da(),p(_)};return e.jsxs(ye,{open:i,onOpenChange:ts,children:[e.jsxs(be,{className:"w-screen h-[100vh] overflow-hidden rounded-none p-0 flex flex-col dark:bg-[#121212]",children:[e.jsxs(ve,{className:"sticky top-0 bg-white dark:bg-[#0F0F0F] z-20 border-b border-gray-200 dark:border-[#333] px-4 py-3",children:[e.jsx(we,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Ic,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(us,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"px-4 py-3 overflow-y-auto flex-1 grid grid-cols-1 gap-6",children:[e.jsxs($t,{children:[e.jsx(ls,{className:"pb-2",children:e.jsxs(Ts,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"اختيار ماكينة"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{variant:"destructive",onClick:async()=>{try{if(!N||!D)return;const _=Je(J,"shops",N,"machines",D);try{const me=await Qe(Ne(J,"shops",N,"machines",D,"transfers"));await Promise.all(me.docs.map(Ae=>As(Ae.ref)))}catch{}try{const me=await Qe(Ne(J,"shops",N,"machines",D,"deliveries"));await Promise.all(me.docs.map(Ae=>As(Ae.ref)))}catch{}await As(_),ht(me=>me.filter(Ae=>Ae.id!==D));const ce=Ie.find(me=>me.id!==D);bt(ce?ce.id:null);try{const me=`${ya}_${D}`,Ae=`${ba}_${D}`;localStorage.removeItem(me),localStorage.removeItem(Ae)}catch{}d({title:"تم حذف الماكينة",description:"تمت الإزالة نهائيًا."})}catch{d({title:"فشل الحذف",description:"تعذر حذف الماكينة.",variant:"destructive"})}},disabled:!D,title:"حذف الماكينة",children:e.jsx(is,{className:"h-4 w-4"})})})]})}),e.jsx(Wt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الماكينة الحالية"}),e.jsxs(La,{value:D??"",onValueChange:_=>{bt(_);try{const ce=N||s();ce&&localStorage.setItem(`machineDaily_selected_${ce}`,_)}catch{}},children:[e.jsx(Wa,{className:"text-right",children:e.jsx(Fa,{placeholder:"اختر ماكينة"})}),e.jsx(Ra,{children:Ie.map(_=>e.jsx(ra,{value:_.id,children:_.name},_.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"إنشاء ماكينة جديدة"}),e.jsx(q,{value:_t,onChange:_=>At(_.target.value),placeholder:"اسم الماكينة",className:"text-right"})]}),e.jsx("div",{className:"flex justify-end md:justify-start",children:e.jsx(h,{onClick:async()=>{try{if(!N){d({title:"لا يوجد محل",description:"يرجى التأكد من تحميل بيانات المحل.",variant:"destructive"});return}const _=(_t||"").trim();if(!_){d({title:"اسم الماكينة مطلوب",description:"أدخل اسم للماكينة الجديدة.",variant:"destructive"});return}const ce=await Zs(Ne(J,"shops",N,"machines"),{name:_,shopId:N,createdAt:ct(),updatedAt:ct(),isActive:!0}),me={id:ce.id,name:_};ht(Ae=>[me,...Ae]),bt(ce.id),At(""),d({title:"تم إنشاء ماكينة",description:`تمت إضافة ${_}`})}catch(_){console.error("Create machine error:",_),d({title:"خطأ في الإنشاء",description:"تعذر إنشاء الماكينة.",variant:"destructive"})}},className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})})]})]})})]}),e.jsxs($t,{children:[e.jsx(ls,{className:"pb-2",children:e.jsxs(Ts,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>ge(_=>!_),className:"flex items-center gap-1",children:e.jsx(sn,{className:`h-4 w-4 transition-transform ${W?"rotate-180":""}`})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{variant:"outline",onClick:()=>le(!0),disabled:w==null||G==null,className:"border-violet-300 text-violet-700",children:"تحويل"})}),w!=null&&G!=null&&e.jsxs(Gt,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",Mt(w)," | هواء ",Mt(G)," | درج ",Mt(Z??0)]})]}),e.jsxs(Wt,{className:`space-y-4 ${W?"":"hidden"}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:j,onChange:_=>B(_.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:C,onChange:_=>L(_.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:M,onChange:_=>y(_.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(h,{variant:"outline",className:"mr-2",onClick:Lt,children:"تصفير"}),e.jsx(h,{onClick:ea,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),e.jsxs($t,{children:[e.jsx(ls,{className:"pb-2",children:e.jsxs(Ts,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات تحويل"}),e.jsxs(Gt,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",Mt(es)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:vt,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(nn,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Wt,{className:"space-y-3",children:te.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-3 max-h-52 overflow-y-auto pr-1",children:te.map(_=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر الجملة"}),e.jsx("p",{className:"text-sm",children:Mt(_.wholesalePrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر التجزئة"}),e.jsx("p",{className:"text-sm",children:Mt(_.retailPrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الربح الفوري"}),e.jsx("p",{className:"text-sm text-green-700",children:Mt(_.profit)}),_.deductFrom&&e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"text-[11px] bg-violet-100 text-violet-700 border border-violet-200 rounded px-2 py-0.5",children:["الخصم من: ",_.deductFrom==="base"?"الأساسي":"الهواء"]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(Ua,{className:"h-3 w-3"}),e.jsx("span",{children:oc(_.createdAt)}),_.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(xl,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",_.cashierName]})]})]})]})]},_.id))})})]}),e.jsxs($t,{children:[e.jsx(ls,{className:"pb-2",children:e.jsx(Ts,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(Wt,{className:"space-y-4",children:De?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:xe,onChange:_=>oe(_.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:We,onChange:_=>Ve(_.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"secondary",onClick:()=>pe(!1),children:"إلغاء"}),e.jsx(h,{onClick:js,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),Ee!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(Gt,{className:Ee>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",Mt(Ee)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(Gt,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",Mt(parseFloat(xe||"0")+parseFloat(We||"0"))]}),e.jsxs(Gt,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",Mt(os)]})]})]})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{variant:"outline",onClick:Rt,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs($t,{children:[e.jsx(ls,{className:"pb-2",children:e.jsxs(Ts,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:Ze,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(nn,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Wt,{className:"space-y-3",children:Ke.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:Ke.map(_=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Mt(_.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Mt(_.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Mt(_.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Mt(_.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>Tt(_.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(is,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${_.netResult>=0?"text-green-700":"text-red-700"}`,children:Mt(_.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",Mt(_.deliveryBase+_.deliveryAir)]}),typeof _.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",Mt(_.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(Ua,{className:"h-3 w-3"}),e.jsx("span",{children:oc(_.createdAt)}),_.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(xl,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",_.cashierName]})]})]})]})]},_.id))})})]})]}),e.jsxs(lt,{className:"sticky bottom-0 bg-white dark:bg-[#0F0F0F] z-20 border-t border-gray-200 dark:border-[#333] px-4 py-3 flex items-center justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>ts(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(Na,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(ye,{open:st,onOpenChange:le,children:e.jsxs(be,{className:"sm:max-w-sm",children:[e.jsx(ve,{children:e.jsx(we,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Te,onChange:_=>xt(_.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Vt,onChange:_=>kt(_.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(Gt,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",Mt(parseFloat(Vt||"0")-parseFloat(Te||"0")||0)]})})]}),e.jsxs(lt,{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"secondary",onClick:()=>le(!1),children:"إلغاء"}),e.jsx(h,{onClick:Ws,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(bu,{open:Jt,onOpenChange:Oe,children:e.jsxs(Kc,{children:[e.jsxs(Yc,{children:[e.jsx(Hc,{children:"اختيار مصدر الخصم"}),e.jsx(Gc,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(Qc,{onClick:()=>Oe(!1),children:"رجوع"}),e.jsx(gl,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>Fs("base"),children:"خصم من الأساسي"}),e.jsx(gl,{className:"bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>Fs("air"),children:"خصم من الهواء"})]})]})})]})}function Nu(i,p=300){const[d,v]=Ye.useState(i);return Ye.useEffect(()=>{const N=setTimeout(()=>v(i),p);return()=>clearTimeout(N)},[i,p]),d}const ju=({userId:i,transactions:p})=>{const[d,v]=n.useState(!1),[N,I]=n.useState(!1),[s,j]=n.useState(!1),[B,C]=n.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:L}=ja();n.useEffect(()=>{i&&d&&s&&M()},[i,d,s]);const M=async()=>{if(i)try{if(Array.isArray(p)&&p.length>0){const Z=new Date,ae=Z.getMonth(),de=Z.getFullYear(),$=bs.filterVisibleTransactions(p,"monthly",i);let W=0,ge=0;$.forEach(De=>{const pe=new Date(De.createdAt),xe=String(De.status||"confirmed").toLowerCase();if(pe.getMonth()!==ae||pe.getFullYear()!==de||xe!=="completed"&&xe!=="confirmed")return;const oe=(De.type||De.txnType||"").toLowerCase(),We={type:oe==="withdrawal"?"withdraw":oe,amount:Number(De.amount||0),commission:De.commission};We.type==="withdraw"?W+=Ba.calculateProfitFromTransaction(We):(We.type==="send"||We.type==="receive"||We.type==="transfer")&&(ge+=Ba.calculateProfitFromTransaction(We))}),C({monthlyWithdrawalProfit:Math.round(W*100)/100,monthlyTransferProfit:Math.round(ge*100)/100,lastUpdated:new Date});return}const R=Ba.getWithdrawTransferProfits(i);C({monthlyWithdrawalProfit:R.monthlyWithdrawProfit||0,monthlyTransferProfit:R.monthlyTransferProfit||0,lastUpdated:new Date})}catch(R){console.error("Error loading profit data:",R)}},y=R=>`${R.toFixed(2)} ج.م`,w=async()=>{try{const R=(L==null?void 0:L.subscription)||null,Z=(R==null?void 0:R.planType)??(R==null?void 0:R.plan)??null,ae=typeof Z=="string"?Z.toLowerCase():null;if(Z===$s.ZERO||ae==="zero"||ae==="0"||Z===0)return!0}catch{}try{if(i){const R=await fl(i),Z=(R==null?void 0:R.planType)??(R==null?void 0:R.plan)??null,ae=typeof Z=="string"?Z.toLowerCase():null;if(Z===$s.ZERO||ae==="zero"||ae==="0"||Z===0)return!0}}catch{}return!1},O=async()=>{try{if(await w()){Qo({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}I(!0)},G=async()=>{try{if(await w()){Qo({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),I(!1);return}}catch{}j(!0),v(!0),I(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:O,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح الشهرية",children:e.jsx(Ft,{className:"h-1.5 w-1.5"})}),e.jsx(ye,{open:d,onOpenChange:v,children:e.jsxs(be,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ve,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:e.jsxs(we,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(Ua,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"شهري"]})}),e.jsx("div",{className:"py-0 sm:py-3",children:e.jsxs("div",{className:"rounded-xl border border-purple-300 bg-white overflow-hidden",children:[e.jsx("div",{className:"p-2 sm:p-3 bg-red-50 border-b border-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ri,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800 text-xs",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-2 py-0.5 rounded",children:y(B.monthlyWithdrawalProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-blue-50 border-b border-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(yl,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-blue-900 bg-white px-2 py-0.5 rounded",children:y(B.monthlyTransferProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(qt,{className:"h-3 w-3 text-purple-600"}),e.jsx("span",{className:"font-medium text-purple-800 text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"font-bold text-sm text-purple-900 bg-white px-2 py-0.5 rounded",children:y(B.monthlyWithdrawalProfit+B.monthlyTransferProfit)})]})})]})}),!s&&e.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>I(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:e.jsx(Ft,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:e.jsx(h,{onClick:()=>v(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),e.jsx(xs,{open:N,onOpenChange:I,onSuccess:G,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},Su=i=>e.jsx(ju,{...i});function Du({open:i,onOpenChange:p,onSuccess:d,userId:v}){const[N,I]=n.useState(""),[s,j]=n.useState(""),[B,C]=n.useState(!1),[L,M]=n.useState(!1),[y,w]=n.useState(""),[O,G]=n.useState(!1),[R,Z]=n.useState(!1),{toast:ae}=Xs();n.useEffect(()=>{let W=!0;return(async()=>{const ge=await ws.hasMasterPin(v);W&&Z(ge)})(),()=>{W=!1}},[v,i]);const de=()=>{I(""),j(""),w(""),C(!1),M(!1),p(!1)},$=async W=>{W.preventDefault(),w(""),G(!0);try{if(R){if(!await ws.verifyMasterPin(N,v)){w("الرقم السري غير صحيح"),G(!1);return}}else{if(N.length<4){w("يجب أن يكون الرقم السري 4 أرقام على الأقل"),G(!1);return}if(N!==s){w("الرقم السري غير متطابق"),G(!1);return}if(!await ws.createMasterPin(N,v)){w("تعذر إنشاء الرقم السري الرئيسي"),G(!1);return}}ae({title:"نجح العملية",description:R?"تم التحقق من الرقم السري الرئيسي بنجاح":"تم إنشاء الرقم السري الرئيسي بنجاح"}),d(),de()}catch{w("حدث خطأ أثناء معالجة الرقم السري")}finally{G(!1)}};return e.jsx(ye,{open:i,onOpenChange:p,children:e.jsxs(be,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ve,{children:e.jsxs(we,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(rr,{className:"h-5 w-5 text-green-600"}),R?"أدخل الرقم السري الرئيسي":"إنشاء الرقم السري الرئيسي"]})}),e.jsxs("form",{onSubmit:$,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:R?"أدخل الرقم السري الرئيسي لعرض بيانات الأرباح":"قم بإنشاء الرقم السري الرئيسي لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"pin",children:R?"الرقم السري الرئيسي":"الرقم السري الرئيسي الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"pin",type:B?"text":"password",value:N,onChange:W=>I(W.target.value),placeholder:R?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>C(!B),children:B?e.jsx(ps,{className:"h-4 w-4"}):e.jsx(Ft,{className:"h-4 w-4"})})]})]}),!R&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:L?"text":"password",value:s,onChange:W=>j(W.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>M(!L),children:L?e.jsx(ps,{className:"h-4 w-4"}):e.jsx(Ft,{className:"h-4 w-4"})})]})]}),y&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(ir,{className:"h-4 w-4"}),y]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:O,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(rr,{className:"h-4 w-4 mr-2"}),O?"جاري المعالجة...":R?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(h,{type:"button",variant:"outline",onClick:de,disabled:O,children:"إلغاء"})]})]})]})})}const Cu=({userId:i,transactions:p})=>{const[d,v]=n.useState(!1),[N,I]=n.useState(!1),[s,j]=n.useState(!1),[B,C]=n.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});n.useEffect(()=>{i&&d&&s&&L()},[i,d,s,p]);const L=async()=>{if(i)try{if(Array.isArray(p)&&p.length>0){const G=new Date,R=bs.filterVisibleTransactions(p,"daily",i);let Z=0,ae=0;R.forEach(de=>{const $=new Date(de.createdAt),W=String(de.status||"confirmed").toLowerCase();if($.toDateString()!==G.toDateString()||W!=="completed"&&W!=="confirmed"&&W!=="pending")return;const ge=(de.type||de.txnType||"").toLowerCase(),De=String(de.title||"");if(ge==="cash_addition"||De.includes("إيصال إضافة نقدية"))return;const pe={type:ge==="withdrawal"?"withdraw":ge,amount:Number(de.amount||0),commission:de.commission};pe.type==="withdraw"?Z+=Ba.calculateProfitFromTransaction(pe):(pe.type==="send"||pe.type==="receive"||pe.type==="transfer")&&(ae+=Ba.calculateProfitFromTransaction(pe))}),C({dailyWithdrawalProfit:Math.round(Z*100)/100,dailyTransferProfit:Math.round(ae*100)/100,lastUpdated:new Date});try{Ba.updateProfitsFromTransactions(p,i)}catch{}return}const O=Ba.getWithdrawTransferProfits(i);C({dailyWithdrawalProfit:O.dailyWithdrawProfit||0,dailyTransferProfit:O.dailyTransferProfit||0,lastUpdated:new Date})}catch(O){console.error("Error loading profit data:",O)}},M=O=>`${O.toFixed(2)} ج.م`,y=()=>{Ba.hasProfitPin(i),I(!0)},w=()=>{j(!0),v(!0),I(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:y,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح اليومية",children:e.jsx(Ft,{className:"h-1.5 w-1.5"})}),e.jsx(ye,{open:d,onOpenChange:v,children:e.jsxs(be,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-blue-50 sm:to-white sm:border-2 sm:border-blue-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ve,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-blue-200",children:e.jsxs(we,{className:"text-xs font-bold text-blue-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-sm sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(qt,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),"يومي"]})}),e.jsx("div",{className:"py-0 sm:py-3",children:e.jsxs("div",{className:"rounded-xl border border-blue-300 bg-white overflow-hidden",children:[e.jsx("div",{className:"p-2 sm:p-3 bg-red-50 border-b border-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ri,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800 text-xs",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-2 py-0.5 rounded",children:M(B.dailyWithdrawalProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-green-50 border-b border-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(yl,{className:"h-3 w-3 text-green-600"}),e.jsx("span",{className:"font-medium text-green-800 text-xs",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-green-900 bg-white px-2 py-0.5 rounded",children:M(B.dailyTransferProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-blue-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(qt,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"font-bold text-sm text-blue-900 bg-white px-2 py-0.5 rounded",children:M(B.dailyWithdrawalProfit+B.dailyTransferProfit)})]})})]})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-blue-200",children:e.jsx(h,{onClick:()=>v(!1),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-blue-600 sm:to-blue-700 sm:hover:from-blue-700 sm:hover:to-blue-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300 sm:text-xs",children:"إغلاق"})})]})}),e.jsx(Du,{open:N,onOpenChange:I,onSuccess:w,userId:i})]})},Iu=i=>e.jsx(Cu,{...i}),Au=({open:i,onOpenChange:p})=>{var la;const{shiftUser:d,isShiftActive:v,shiftStartAt:N,setShiftUser:I,startShift:s,endShift:j}=ln(),{userSubscription:B,user:C,signIn:L,profile:M}=ja(),{toast:y}=Xs(),[w,O]=n.useState((d==null?void 0:d.name)||""),[G,R]=n.useState((d==null?void 0:d.username)||""),[Z,ae]=n.useState(""),[de,$]=n.useState(!1),[W,ge]=n.useState(null),[De,pe]=n.useState(""),[xe,oe]=n.useState(""),[We,Ve]=n.useState(!1),[Ee,He]=n.useState(null),[Ke,dt]=n.useState(""),[te,fe]=n.useState(""),[st,le]=n.useState(!1),[Te,xt]=n.useState(!1),[Vt,kt]=n.useState({totalTransfers:0,totalWithdrawals:0}),[Jt,Oe]=n.useState(null),[et,mt]=n.useState(""),[Ie,ht]=n.useState(""),[D,bt]=n.useState(0),[_t,At]=n.useState({}),[F,ue]=n.useState(0),[Pe,ft]=n.useState(0),[ot,es]=n.useState({}),[os,vt]=n.useState(""),[Ze,Tt]=n.useState(!1),Lt=U=>{const je={"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9","۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9","٫":".","،":".","٬":"."," ":""};return U.split("").map(gt=>je[gt]??gt).join("")},ea=()=>`cashierUsers_${(C==null?void 0:C.uid)||"default"}`,[Rt,js]=n.useState(()=>{try{let U=localStorage.getItem(ea());if(!U){const je=localStorage.getItem("cashierUsers");je&&(U=je)}return U?JSON.parse(U):[]}catch{return[]}});n.useEffect(()=>{(async()=>{try{if(!(C!=null&&C.uid))return;const U=Je(J,"profiles",C.uid,"cashierUsers","list"),je=await va(U);if(je.exists()){const gt=je.data(),ut=Array.isArray(gt==null?void 0:gt.users)?gt.users:[];ut&&ut.length>0&&js(ut)}}catch{}})()},[C==null?void 0:C.uid]),n.useEffect(()=>{if(!(C!=null&&C.uid))return;const U=Je(J,"profiles",C.uid,"cashierUsers","list"),je=Ls(U,gt=>{try{if(gt.exists()){const ut=gt.data(),Kt=Array.isArray(ut==null?void 0:ut.users)?ut.users:[];if(Kt&&Kt.length>0)js(Kt);else try{const Ds=localStorage.getItem(ea()),zt=Ds?JSON.parse(Ds):[];js(zt)}catch{js([])}}}catch{}},gt=>{console.warn("cashierUsers realtime subscription error:",gt)});return()=>je()},[C==null?void 0:C.uid]);const Ws=(la=B==null?void 0:B.subscription)==null?void 0:la.planType,Fs=Ws==="yearly"?2:Ws==="lifetime"?4:Number.POSITIVE_INFINITY;n.useEffect(()=>{try{localStorage.setItem(ea(),JSON.stringify(Rt));try{localStorage.removeItem("cashierUsers")}catch{}}catch{}(async()=>{try{if(!(C!=null&&C.uid))return;const U=Je(J,"profiles",C.uid,"cashierUsers","list");await Qs(U,{users:Rt},{merge:!0})}catch{}})()},[Rt]);const[Da,ts]=n.useState(!1),[_,ce]=n.useState(""),[me,Ae]=n.useState(null),[Le,yt]=n.useState([]),[rt,z]=n.useState(!1),[ke,K]=n.useState(null),[pt,Ct]=n.useState(!1),[Qt,ss]=n.useState(!1),Ss=U=>{const je=(d==null?void 0:d.username)===U;let gt=!1;try{gt=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(je&&!(je&&!v&&(os==="الأدمن الرئيسي"||gt))){y({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const Ds=`هل أنت متأكد من حذف المستخدم ${U}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(Ds)&&(js(zt=>zt.filter(ta=>ta.username!==U)),je&&I(null),y({title:"تم حذف المستخدم",description:U}))},ia=()=>{if(!w.trim()||!G.trim()||!Z.trim())return;if(Rt.length>=Fs){y({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(Fs)?Fs:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const U={name:w.trim(),username:G.trim(),password:Z.trim()};js(je=>[U,...je]),O(""),R(""),ae("")},Ys=()=>{$(!0),ge(null),He(null),dt(""),fe("")},ma=async()=>{try{let U=[];try{C!=null&&C.uid&&(U=await Se.getUserTransactions(C.uid))}catch{}if(!U||U.length===0)try{const Fe=await Cc({merchantUserId:C==null?void 0:C.uid,limit:200});U=(Fe==null?void 0:Fe.transactions)||[]}catch{}const je=N?new Date(N):null,gt=new Date,ut=Fe=>{const Ot=Fe.type,Rs=Fe.txnType;return Ot==="withdraw"||Ot==="withdrawal"||Ot==="receive"||Rs==="receive"},Kt=Fe=>{const Ot=Fe.type,Rs=Fe.txnType;return Ot==="send"||Ot==="transfer"||Rs==="send"},Ds=Fe=>{if(!Fe)return null;if(Fe instanceof Date)return Fe;try{const Ot=new Date(Fe);return Number.isNaN(Ot.getTime())?null:Ot}catch{return null}},zt=Fe=>{const Ot=Ds(Fe.createdAt||Fe.created_at||Fe.timestamp);return!Ot||je&&Ot<je?!1:Ot<=gt},ta=Fe=>Fe==="completed"||Fe==="confirmed",qa=U.filter(Fe=>ta(Fe.status)&&zt(Fe)),on=qa.filter(Fe=>ut(Fe)).reduce((Fe,Ot)=>{const Rs=Ot.withdrawnAmount??Ot.receivedAmount??Ot.amount??0;return Fe+(Number(Rs)||0)},0);return{totalTransfers:qa.filter(Fe=>Kt(Fe)).reduce((Fe,Ot)=>{const Rs=Ot.sentAmount??Ot.transferredAmount??Ot.amount??0;return Fe+(Number(Rs)||0)},0),totalWithdrawals:on}}catch{return{totalTransfers:0,totalWithdrawals:0}}};n.useEffect(()=>{if(Te){try{const U=localStorage.getItem("shiftInitialReceivedDrawerFunds");U!==null&&ht(U)}catch{}try{const U=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(U!==null){const je=parseFloat(U);bt(Number.isFinite(je)?je:0)}}catch{}}},[Te]),n.useEffect(()=>{de&&(async()=>{try{const U=await ma();kt(U)}catch{}})()},[de]),n.useEffect(()=>{if(!i&&!rt)return;(async()=>{try{const gt=((C!=null&&C.uid?await Se.getUserTransactions(C.uid):[])||[]).filter(ut=>(ut==null?void 0:ut.type)==="report"||((ut==null?void 0:ut.title)||"").includes("إيصال تسليم وردية"));gt.sort((ut,Kt)=>{const Ds=new Date(ut.createdAt||0).getTime();return new Date(Kt.createdAt||0).getTime()-Ds}),yt(gt)}catch{yt([])}})()},[i,Te,rt,C==null?void 0:C.uid]);const Ca=async(U,je,gt)=>{try{let ut=0,Kt=0;try{const zt=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");ut=Number.isFinite(zt)?zt:0}catch{}try{const zt=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");Kt=Number.isFinite(zt)?zt:0}catch{}const Ds={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(d==null?void 0:d.username)||"cashier",receiverPhone:os||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(d==null?void 0:d.name)||(d==null?void 0:d.username)||null,deficit:je,deficitAmount:je?gt:0,shiftStartAt:N,receivedDrawerFunds:ut,receivedWalletBalancesTotal:Kt,receivedWalletBalances:_t,deliveredDrawerFunds:F||0,deliveredWalletBalancesTotal:Pe||0,deliveredWalletBalances:ot,shiftProfit:Math.round(((F||0)+(Pe||0)-(ut+Kt))*100)/100};C!=null&&C.uid&&await Se.saveUserTransaction(C.uid,Ds),yt(zt=>[Ds,...zt||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(ye,{open:i,onOpenChange:p,children:e.jsxs(be,{className:"sm:max-w-md",children:[e.jsx(ve,{children:e.jsx(we,{children:v?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),v?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[d==null?void 0:d.name," (",d==null?void 0:d.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),Rt.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:Rt.map((U,je)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:U.name}),e.jsx("div",{className:"text-xs text-gray-500",children:U.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(h,{size:"sm",className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>{Ae(U),ts(!0)},children:"دخول"}),e.jsx(h,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>Ss(U.username),children:"حذف"})]})]},je))})]})]}),e.jsx(lt,{className:"flex flex-wrap gap-2 justify-between",children:v?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(h,{className:"w-full sm:w-auto",variant:"destructive",onClick:Ys,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(h,{className:"w-full sm:w-auto bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>ss(!0),children:"إضافة مستخدم جديد"}),e.jsx(h,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>z(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(ye,{open:Qt,onOpenChange:ss,children:e.jsxs(be,{className:"sm:max-w-md",children:[e.jsx(ve,{children:e.jsx(we,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(X,{className:"mb-1 block",children:"الاسم"}),e.jsx(q,{value:w,onChange:U=>O(U.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(X,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(q,{value:G,onChange:U=>R(U.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(X,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(q,{type:"password",autoComplete:"new-password",value:Z,onChange:U=>ae(U.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(lt,{className:"flex gap-2 justify-between",children:[e.jsx(h,{variant:"secondary",onClick:()=>{ss(!1)},children:"إلغاء"}),e.jsx(h,{onClick:()=>{!w.trim()||!G.trim()||!Z.trim()||(ia(),ss(!1))},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"حفظ المستخدم"})]})]})}),e.jsx(ye,{open:rt,onOpenChange:z,children:e.jsxs(be,{className:"sm:max-w-lg",children:[e.jsx(ve,{children:e.jsx(we,{children:"إيصالات التسليم"})}),Le.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:Le.map(U=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{K(U),Ct(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(U.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",U.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",U.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",U.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",U.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",U.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",U.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",U.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",U.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",U.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(U.shiftProfit??(U.deliveredDrawerFunds??0)+(U.deliveredWalletBalancesTotal??0)-(U.receivedDrawerFunds??0)-(U.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",U.shiftProfit??(U.deliveredDrawerFunds??0)+(U.deliveredWalletBalancesTotal??0)-(U.receivedDrawerFunds??0)-(U.receivedWalletBalancesTotal??0)]})]}),U.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",U.deficitAmount??0]})]},U.id))}),e.jsx(lt,{className:"flex gap-2 justify-between",children:e.jsx(h,{variant:"secondary",onClick:()=>z(!1),children:"إغلاق"})})]})}),e.jsx(ye,{open:pt,onOpenChange:Ct,children:e.jsxs(be,{className:"sm:max-w-md",children:[e.jsx(ve,{children:e.jsx(we,{children:"إيصال تسليم وردية"})}),ke?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(ke.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",ke.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",ke.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",ke.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",ke.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",ke.deliveredWalletBalancesTotal??0]})]})]}),ke.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",ke.deficitAmount??0]})]}),ke.receivedWalletBalances&&Object.keys(ke.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(ke.receivedWalletBalances).map(([U,je])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:U}),e.jsx("span",{className:"font-semibold",children:je})]},U))})]}),ke.deliveredWalletBalances&&Object.keys(ke.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(ke.deliveredWalletBalances).map(([U,je])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:U}),e.jsx("span",{className:"font-semibold",children:je})]},U))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(lt,{className:"flex gap-2 justify-between",children:e.jsx(h,{variant:"secondary",onClick:()=>Ct(!1),children:"إغلاق"})})]})}),e.jsx(ye,{open:Da,onOpenChange:ts,children:e.jsxs(be,{className:"sm:max-w-md",children:[e.jsx(ve,{children:e.jsx(we,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:me?`${me.name} (${me.username})`:""}),e.jsx(q,{type:"password",autoComplete:"off",value:_,onChange:U=>ce(U.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(lt,{className:"flex gap-2 justify-between",children:[e.jsx(h,{variant:"secondary",onClick:()=>{ce(""),Ae(null),ts(!1)},children:"إلغاء"}),e.jsx(h,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{if(me){if(_.trim()!==me.password){y({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}I({name:me.name,username:me.username}),ce(""),ts(!1),p(!1),s(),Tt(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(ye,{open:Ze,onOpenChange:Tt,children:e.jsxs(be,{className:"sm:max-w-md",children:[e.jsx(ve,{children:e.jsx(we,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(X,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(q,{type:"text",inputMode:"decimal",value:Ie,onChange:U=>ht(Lt(U.target.value)),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(X,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(q,{type:"text",inputMode:"decimal",value:Number.isFinite(D)?D:0,onChange:U=>{const je=parseFloat(Lt(U.target.value));bt(Number.isFinite(je)?je:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(lt,{className:"flex gap-2 justify-between",children:e.jsx(h,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{const U=parseFloat(Ie),je=D,gt=Number.isFinite(U)&&U>=0,ut=Number.isFinite(je)&&je>=0;if(!gt||!ut){y({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(U)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(je))}catch{}y({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),Tt(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(ye,{open:de,onOpenChange:U=>{U&&$(!0)},children:e.jsxs(be,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ve,{children:e.jsx(we,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:W==="toUser"?"default":"secondary",onClick:()=>ge("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(h,{variant:W==="toAdmin"?"default":"secondary",onClick:()=>ge("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),W==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[Rt.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:Rt.map((U,je)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(Ee==null?void 0:Ee.username)===U.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>He(U),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:U.name}),e.jsx("div",{className:"text-xs text-gray-500",children:U.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},je))})]}),e.jsxs("div",{children:[e.jsx(X,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(q,{type:"password",autoComplete:"off",value:Ke,onChange:U=>dt(U.target.value),placeholder:"أدخل كلمة السر"})]}),te&&e.jsx("div",{className:"text-xs text-red-600",children:te})]}),W==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(q,{type:"password",autoComplete:"off",value:De,onChange:U=>pe(U.target.value),placeholder:"كلمة المرور"}),xe&&e.jsx("div",{className:"text-xs text-red-600",children:xe})]})]}),e.jsx(lt,{className:"flex gap-2 justify-between",children:e.jsx(h,{disabled:st||!W,onClick:async()=>{if(W){le(!0);try{const U=Vt;if(ma().then(kt).catch(()=>{}),W==="toUser"){if(!Ee){fe("يرجى اختيار المستخدم أولاً"),le(!1);return}if(Ke.trim()!==Ee.password){fe("كلمة السر غير صحيحة"),le(!1);return}j(),I({name:Ee.name,username:Ee.username}),s(),vt(`${Ee.name} (${Ee.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}$(!1),ge(null),He(null),dt(""),fe(""),p(!1),kt(U),Oe(null),mt(""),xt(!0)}else if(W==="toAdmin"){oe("");const je=(C==null?void 0:C.email)||"";if(!je){oe("لا يوجد بريد للمستخدم الرئيسي للتحقق"),le(!1);return}const{error:gt}=await L(je,De);if(gt){oe("كلمة المرور غير صحيحة"),le(!1);return}j(),I(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}pe(""),$(!1),p(!1),vt("الأدمن الرئيسي"),kt(U),Oe(null),mt(""),xt(!0)}}catch{fe("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{le(!1)}}},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"تأكيد التسليم"})})]})}),e.jsx(ye,{open:Te,onOpenChange:xt,children:e.jsxs(be,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ve,{children:e.jsx(we,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:os})]}),N&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(N).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(X,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(q,{type:"number",value:Ie,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(X,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(q,{type:"number",value:D,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(X,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(q,{type:"text",inputMode:"decimal",value:F,onChange:U=>{const je=parseFloat(Lt(U.target.value));ue(Number.isFinite(je)?je:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(X,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(q,{type:"text",inputMode:"decimal",value:Pe,onChange:U=>{const je=parseFloat(Lt(U.target.value));ft(Number.isFinite(je)?je:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(F??0)+(Pe??0)-((parseFloat(Ie||"0")||0)+(D??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((F??0)+(Pe??0)-((parseFloat(Ie||"0")||0)+(D??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"}),e.jsx("div",{className:"mt-2 grid grid-cols-1 gap-2",children:e.jsxs("div",{className:"rounded border p-2 bg-gray-50",children:[e.jsx("div",{className:"text-xs text-gray-700",children:"مطلوب من الدرج (بدون أرباح)"}),e.jsx("div",{className:"text-sm font-semibold text-gray-900",children:Math.round(((F??0)-(parseFloat(Ie||"0")||0))*100)/100})]})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:Jt==="no"?"default":"secondary",onClick:()=>Oe("no"),children:"لا"}),e.jsx(h,{variant:Jt==="yes"?"default":"secondary",onClick:()=>Oe("yes"),children:"نعم"})]}),Jt==="yes"&&e.jsxs("div",{children:[e.jsx(X,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(q,{type:"number",value:et,onChange:U=>mt(U.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(lt,{className:"flex gap-2 justify-between",children:e.jsx(h,{onClick:()=>{const U=Jt==="yes",je=parseFloat(et)||0;(async()=>await Ca(Vt,U,je))(),y({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),xt(!1)},className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:"تأكيد وحفظ الإيصال"})})]})})]})},Tu=({open:i,onOpenChange:p})=>{const{shiftUser:d,endShift:v,setShiftUser:N}=ln(),[I,s]=n.useState(""),[j,B]=n.useState(""),[C,L]=n.useState([]),{user:M}=ja();n.useEffect(()=>{(async()=>{try{if(M!=null&&M.uid){const w=Je(J,"profiles",M.uid,"cashierUsers","list"),O=await va(w);if(O.exists()){const G=O.data(),R=Array.isArray(G==null?void 0:G.users)?G.users:[];if(R&&R.length>0){L(R);return}}}}catch{}try{const w=`cashierUsers_${(M==null?void 0:M.uid)||"default"}`;let O=localStorage.getItem(w);if(!O){const G=localStorage.getItem("cashierUsers");G&&(O=G)}L(O?JSON.parse(O):[])}catch{L([])}})()},[i,M==null?void 0:M.uid]),n.useEffect(()=>{if(!i||!(M!=null&&M.uid))return;const w=Je(J,"profiles",M.uid,"cashierUsers","list"),O=Ls(w,G=>{if(G.exists()){const R=G.data(),Z=Array.isArray(R==null?void 0:R.users)?R.users:[];if(Z&&Z.length>0)L(Z);else try{const ae=`cashierUsers_${(M==null?void 0:M.uid)||"default"}`;let de=localStorage.getItem(ae);if(!de){const $=localStorage.getItem("cashierUsers");$&&(de=$)}L(de?JSON.parse(de):[])}catch{L([])}}},G=>{console.warn("ShiftProfileDialog cashierUsers snapshot error:",G)});return()=>O()},[i,M==null?void 0:M.uid]);const y=async()=>{if(B(""),!d)return;const w=C.find(O=>O.username===d.username);if(!w){B("لا يوجد مستخدم مطابق لهذه الوردية");return}if(I.trim()!==w.password){B("الرقم السري غير صحيح");return}v(),N(null),s(""),p(!1)};return e.jsx(ye,{open:i,onOpenChange:w=>{s(""),B(""),p(w)},children:e.jsxs(be,{className:"sm:max-w-md",children:[e.jsx(ve,{children:e.jsx(we,{children:"بروفيل الوردية"})}),d?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:d.name}),e.jsx("div",{className:"text-xs text-gray-600",children:d.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx(q,{type:"password",value:I,onChange:w=>s(w.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),j&&e.jsx("div",{className:"text-red-600 text-xs",children:j})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(lt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>p(!1),children:"إغلاق"}),e.jsx(h,{onClick:y,disabled:!d,children:"تسليم الوردية"})]})]})})},Pu=({open:i,onOpenChange:p})=>e.jsx(ye,{open:i,onOpenChange:p,children:e.jsxs(be,{className:"sm:max-w-lg rounded-2xl",children:[e.jsxs(ve,{children:[e.jsxs(we,{className:"text-right flex items-center gap-2 justify-end",children:[e.jsx(ol,{className:"w-5 h-5"}),"سجل التغييرات الأخيرة"]}),e.jsx(us,{className:"text-right",children:"هذه أبرز التحسينات التي تمت مؤخرًا في الواجهة."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(bc,{className:"w-5 h-5 text-amber-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحسين نافذة تعديل المديونية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"استبدال نافذة الإدخال القديمة (prompt) بحوار أنيق لإدخال المبلغ مع تأكيد."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ph,{className:"w-5 h-5 text-violet-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحديث شاشة التحميل"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:'تغيير النص إلى "صلي علي النبي" مع خط عربي جميل ونبض لطيف.'})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ol,{className:"w-5 h-5 text-green-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"بطاقات الأرباح وعدد العمليات"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"إضافة بطاقات عرض أرباح الفترة الحالية وعدد العمليات في تفاصيل المحفظة."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ol,{className:"w-5 h-5 text-blue-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"إصلاح تمرير نافذة اليومية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"منع تمرير الصفحة الخلفية عند فتح نافذة اليومية لراحة الاستخدام."})]})]})]}),e.jsx("div",{className:"flex justify-end gap-2 mt-6",children:e.jsx(h,{variant:"secondary",onClick:()=>p(!1),children:"إغلاق"})})]})});class Sr{static async processTransfer(p){const{amount:d,currentCashBalance:v,currentWalletBalances:N,wallets:I,selectedWalletId:s}=p;if(d<=0)return{success:!1,newCashBalance:v,newWalletBalances:N,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!p.skipRemoteLimitsCheck)try{const L=await Gs.canPerformOperation(s,d,"transfer");if(!L.canPerform)return{success:!1,newCashBalance:v,newWalletBalances:N,message:L.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(L){return console.error("خطأ في التحقق من حدود التحويل:",L),{success:!1,newCashBalance:v,newWalletBalances:N,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(d<=0)return{success:!1,newCashBalance:v,newWalletBalances:N,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s){const L=Math.max(N[s]||0,0);if(L<d){const M=I.find(y=>y.id===s);return{success:!1,newCashBalance:v,newWalletBalances:N,message:`رصيد غير كافي في المحفظة${M?` ${M.name}`:""}. المتاح: ${L} جنيه، المطلوب: ${d} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const L=Sr.calculateTotalWalletBalance(N);if(L<d)return{success:!1,newCashBalance:v,newWalletBalances:N,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${L} جنيه، المبلغ المطلوب: ${d} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const j={...N};if(s){const L=j[s]||0;j[s]=L-d}else{let L=d;for(const M of I){if(L<=0)break;const y=Math.max(j[M.id]||0,0),w=Math.min(y,L);w>0&&(j[M.id]=(j[M.id]||0)-w,L-=w)}}const B=v+d;let C="تم التحويل بنجاح";if(s){const L=j[s]||0;L<0&&(C=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${s} أصبح ${L} جنيه.`)}return{success:!0,newCashBalance:B,newWalletBalances:j,message:C}}static processDeposit(p){const{amount:d,currentCashBalance:v,currentWalletBalances:N,wallets:I}=p;if(d<=0)return{success:!1,newCashBalance:v,newWalletBalances:N,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const s=this.calculateTotalWalletBalance(N);if(s<d)return{success:!1,newCashBalance:v,newWalletBalances:N,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${s} جنيه، المبلغ المطلوب: ${d} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const j=v+d,B={...N};let C=d;const L=I.find(y=>y.isDefault);if(L&&B[L.id]>=C)B[L.id]-=C,C=0;else for(const y of I){if(C<=0)break;const w=B[y.id]||0;if(w>0){const O=Math.min(w,C);B[y.id]=w-O,C-=O}}const M=C>0?`تم الإيداع جزئياً. تم إيداع ${d-C} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${d} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:j,newWalletBalances:B,message:M}}static async processWithdraw(p){const{amount:d,currentCashBalance:v,currentWalletBalances:N,wallets:I,selectedWalletId:s}=p;if(d<=0)return{success:!1,newCashBalance:v,newWalletBalances:N,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!p.skipRemoteLimitsCheck)try{const L=await Gs.canPerformOperation(s,d,"withdraw");if(!L.canPerform)return{success:!1,newCashBalance:v,newWalletBalances:N,message:L.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(L){return console.error("خطأ في التحقق من حدود السحب:",L),{success:!1,newCashBalance:v,newWalletBalances:N,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(v<d)return{success:!1,newCashBalance:v,newWalletBalances:N,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${v} جنيه، المبلغ المطلوب: ${d} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const j=v-d,B={...N},C=s?I.find(L=>L.id===s):I.find(L=>L.isDefault)||I[0];if(C){const L=B[C.id]||0;B[C.id]=L+d}else return{success:!1,newCashBalance:v,newWalletBalances:N,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};return{success:!0,newCashBalance:j,newWalletBalances:B,message:`تم السحب بنجاح. تم إضافة ${d} جنيه إلى محفظة ${(C==null?void 0:C.name)||""}`}}static validateOperation(p,d){return p<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!d||d.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(p){return Object.values(p).reduce((d,v)=>d+Math.max(v,0),0)}static deductFromWalletsAddToCash(p,d,v,N){return this.processTransfer({amount:p,currentCashBalance:d,currentWalletBalances:v,wallets:N})}static deductFromWalletsAddToCashDeposit(p,d,v,N){return this.processDeposit({amount:p,currentCashBalance:d,currentWalletBalances:v,wallets:N})}static deductFromCashAddToWallets(p,d,v,N){return this.processWithdraw({amount:p,currentCashBalance:d,currentWalletBalances:v,wallets:N})}static applyTransactionResult(p,d,v){p.success&&(d(p.newCashBalance),v(p.newWalletBalances))}static validateTransaction(p,d,v,N){if(p<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(d==="transfer"){const I=this.calculateTotalWalletBalance(N);if(I<p)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${I} جنيه) غير كافي للمبلغ المطلوب (${p} جنيه)`}}else if(d==="withdraw"){if(v<p)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${v} جنيه) غير كافي للمبلغ المطلوب (${p} جنيه)`}}else if(d==="deposit"){const I=this.calculateTotalWalletBalance(N);if(I<p)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${I} جنيه) غير كافي للمبلغ المطلوب (${p} جنيه)`}}return{isValid:!0}}static getDeductionPreview(p,d,v){const N=[];let I=p;for(const s of v){if(I<=0)break;const j=d[s.id]||0,B=Math.min(Math.max(j,0),I);B>0&&(N.push({walletId:s.id,walletName:s.name,currentBalance:j,deductedAmount:B,newBalance:j-B}),I-=B)}return N}}let Zr=null;function ku(){const i=window;if(!Zr){const p=i.AudioContext||i.webkitAudioContext;Zr=new p}return Zr.state==="suspended"&&Zr.resume(),Zr}function _u(i,p,d){const v=d/1e3,N=Math.floor(i.sampleRate*v),I=i.createBuffer(1,N,i.sampleRate),s=I.getChannelData(0);for(let L=0;L<N;L++)s[L]=(Math.random()*2-1)*.6;const j=i.createBufferSource();j.buffer=I;const B=i.createBiquadFilter();B.type="highpass",B.frequency.value=1500,B.Q.value=.7;const C=i.createGain();C.gain.setValueAtTime(1e-4,p),C.gain.exponentialRampToValueAtTime(.4,p+.015),C.gain.exponentialRampToValueAtTime(1e-4,p+v),j.connect(B),B.connect(C),C.connect(i.destination),j.start(p),j.stop(p+v+.01)}function Ou(i,p,d,v,N,I="triangle"){const s=i.createOscillator(),j=i.createGain();s.type=I;const B=N/1e3;s.frequency.setValueAtTime(d,p),s.frequency.linearRampToValueAtTime(v,p+B),j.gain.setValueAtTime(1e-4,p),j.gain.exponentialRampToValueAtTime(.25,p+.02),j.gain.exponentialRampToValueAtTime(1e-4,p+B),s.connect(j),j.connect(i.destination),s.start(p),s.stop(p+B+.02)}function Eu(){try{const i=ku(),p=i.currentTime;_u(i,p,90),Ou(i,p+.12,1900,1100,180,"sawtooth")}catch{}}function Mu(i){if(!i)return!1;const d=i.replace(/[^0-9٠-٩]/g,"").replace(/[٠-٩]/g,v=>"0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(v)]);return/^(010|011|012|015)[0-9]{8}$/.test(d)}function $u({userId:i}){const[p,d]=Ye.useState(null),[v,N]=Ye.useState("");return null}const Lx=()=>{var qo,Vo,Jo,Ko,Yo,Ho;console.log("🔥 UserDashboardPage component is loading...");const{toast:i}=Xs(),p=n.useRef(null),[d,v]=n.useState(0),N=async()=>{var r,l,o;const t="alkaptin678678@gmail.com",a=(l=(r=jr.currentUser)==null?void 0:r.email)==null?void 0:l.toLowerCase();if(!a||a!==t){i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}if(!En||!Mn||!$n){i({title:"بيانات ناقصة",description:"أدخل رقم الموبايل، الشركة والمبلغ",variant:"destructive"});return}try{wo(!0);const m=await((o=jr.currentUser)==null?void 0:o.getIdToken()),u=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...m?{Authorization:`Bearer ${m}`}:{}},body:JSON.stringify({phone:En,countryCode:"EG",operator:Mn,amount:Number($n),useLocalAmount:!0})}),g=await u.json().catch(()=>({}));u.ok&&(g!=null&&g.success)?(i({title:"تم الشحن",description:(g==null?void 0:g.message)||"تم تنفيذ عملية الشحن بنجاح"}),Vi(!1),fo(""),yo(""),bo("")):i({title:"فشل الشحن",description:(g==null?void 0:g.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(m){console.error("Topup request error:",m),i({title:"خطأ غير متوقع",description:"تعذّر تنفيذ عملية الشحن. حاول لاحقاً.",variant:"destructive"})}finally{wo(!1)}},{signOut:I,user:s,profile:j}=ja(),B=((s==null?void 0:s.email)||"").toLowerCase()==="vodafonecash00@gmail.com",C=xc(),L=mc(),M=oh(),{isShiftActive:y,shiftUser:w}=ln(),{shopId:O,shopName:G}=li(),R=ch();(()=>{try{return!!window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:"}catch{return!1}})();const[Z,ae]=n.useState(!1),[de,$]=n.useState(!1),[W,ge]=n.useState(!1),[De,pe]=n.useState(!1),[xe,oe]=n.useState([]),[We,Ve]=n.useState(""),[Ee,He]=n.useState(""),[Ke,dt]=n.useState(""),[te,fe]=n.useState(""),[st,le]=n.useState(!1),[Te,xt]=n.useState(!1),[Vt,kt]=n.useState(null),[Jt,Oe]=n.useState(""),[et,mt]=n.useState(""),[Ie,ht]=n.useState(!1),[D,bt]=n.useState("");n.useEffect(()=>{const t=M==null?void 0:M.shopId;if(t&&(s!=null&&s.uid))try{const a=`selectedShopId_${s.uid}`;localStorage.setItem(a,String(t)),window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}},[M==null?void 0:M.shopId,s==null?void 0:s.uid]);const[_t,At]=n.useState([]),[F,ue]=n.useState(()=>{try{return localStorage.getItem("cashySelectedDevice")||null}catch{return null}});n.useEffect(()=>{(()=>{if(tn.isNativePlatform()){const a=()=>{var r,l;if((l=(r=window.cordova)==null?void 0:r.plugins)!=null&&l.permissions){const o=window.cordova.plugins.permissions,m=[o.RECEIVE_SMS];o.checkPermission(m,u=>{u.hasPermission?console.log("SMS permissions already granted"):o.requestPermissions(m,g=>{g.hasPermission?console.log("SMS permissions granted"):(console.warn("SMS permissions denied"),i({title:"تنبيه",description:"يرجى منح صلاحيات الرسائل لعمل التطبيق بشكل صحيح",variant:"destructive"}))},()=>{console.error("Error requesting SMS permissions")})},null)}else console.warn("Cordova permissions plugin not found yet, retrying..."),setTimeout(a,1e3)};document.addEventListener("deviceready",a,!1),a()}})()},[]),n.useEffect(()=>{(async()=>{if(D)try{await Hr.set({key:"selected_wallet_id",value:D}),console.log("📱 Synced selected_wallet_id to Native:",D)}catch(a){console.error("Failed to sync wallet to native:",a)}else await Hr.remove({key:"selected_wallet_id"})})()},[D]),n.useEffect(()=>{(async()=>{if(O)try{await Hr.set({key:"shopId",value:O}),console.log("📱 Synced shopId to Native:",O)}catch(a){console.error("Failed to sync shopId to native:",a)}})()},[O]);const Pe=t=>!!(t&&_t.some(a=>a.id===t));async function ft(){const t=window.electronAPI,a=F||"";if(!t||typeof t.sendUssd!="function")return null;if(!a)return i({title:"الجهاز غير محدد",description:"اتصل بالموبايل أولاً ثم اختر الجهاز من القائمة",variant:"destructive"}),null;if(Pe(a))return a;try{const m=_t.find(u=>u&&u.id&&!String(u.id).includes(":"));if(m&&m.id)return ue(m.id),m.id}catch{}const r=a.includes(":")?a.split(":").slice(0,2).join(":"):"";if(r&&typeof t.connectWifi=="function"){try{await t.connectWifi(r)}catch{}if(await new Promise(m=>setTimeout(m,250)),Pe(a))return a}const l=a.split(":")[0],o=_t.find(m=>(m.id.startsWith(l)||m.id.includes(l))&&m.id.includes(":"));if(o!=null&&o.id){const m=o.id.split(":").slice(0,2).join(":");if(!Pe(o.id)&&typeof t.connectWifi=="function"){try{await t.connectWifi(m)}catch{}await new Promise(u=>setTimeout(u,250))}if(Pe(o.id))return ue(o.id),o.id}return i({title:"الجهاز غير متصل",description:"فعّل Wireless debugging أو استخدم اتصال Wi‑Fi ثم أعد المحاولة",variant:"destructive"}),null}n.useEffect(()=>{const t=window.electronAPI;t&&typeof t.onAdbDevices=="function"&&t.onAdbDevices(a=>{var o;const r=Array.isArray(a)?a:[];At(r);const l=(()=>{try{return localStorage.getItem("cashySelectedDevice")||""}catch{return""}})();l&&r.some(m=>m.id===l)?ue(l):(o=r[0])!=null&&o.id?ue(m=>m||r[0].id):ue(null)})},[]);function ot(t,a){try{const r=as==null?void 0:as(),l=(r==null?void 0:r.phone)||"";if(!l){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"});return}Wh(l,t,a),i({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),Ha(!1),hr(!1)}catch(r){const l=(r==null?void 0:r.message)||"تعذر إرسال الكود — تحقق من البيانات";throw i({title:"فشل الإرسال",description:l,variant:"destructive"}),r}}const es=async()=>{var r;if(!ks||!ks.receiver||!ks.amount){i({title:"بيانات غير مكتملة",description:"تأكد من إدخال رقم المستقبل والمبلغ قبل الإرسال",variant:"destructive"});return}const t=String(ks.receiver),a=Math.round(Number(ks.amount));Ga(!0);try{if((r=tn)!=null&&r.isNativePlatform&&tn.getPlatform()==="android"){const o=as==null?void 0:as(),m=(o==null?void 0:o.phone)||"";if(!m){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),Ga(!1);return}const u=rc(m,t,a);if(!u){i({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),Ga(!1);return}Lh(u),i({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),Ha(!1),hr(!1);return}const l=window.electronAPI;if(l&&typeof l.sendUssd=="function"&&F){const o=as==null?void 0:as(),m=(o==null?void 0:o.phone)||"";if(!m){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),Ga(!1);return}const u=await ft();if(!u){Ga(!1);return}const g=rc(m,t,a);if(!g){i({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),Ga(!1);return}try{const S=typeof l.pickSimAutomatically=="function"?await l.pickSimAutomatically(u,m):{deviceId:u,slot:0},x=`${S.deviceId}:sim${S.slot}`;vd(x),await l.sendUssd(x,g)}catch{try{await l.sendUssd(u,g)}catch(x){const f=u.includes(":")?u.split(":").slice(0,2).join(":"):"";if(f&&typeof l.connectWifi=="function")await l.connectWifi(f),await l.sendUssd(u,g);else throw x}}i({title:"تم إرسال كود التحويل",description:"تم التنفيذ بنجاح"}),Ha(!1),hr(!0)}else ot(t,a)}catch(l){const o=l&&l.message?l.message:"حدث خطأ غير متوقع أثناء الإرسال";i({title:"خطأ أثناء الإرسال",description:`الجهاز: ${Wl||F||"غير معروف"} — ${o}`,variant:"destructive"})}finally{Ga(!1)}},os=async(t,a)=>{const r=window.electronAPI;try{if(r&&typeof r.enterPin=="function"&&t){await r.enterPin(t,a),hr(!1);return}const l=String((j==null?void 0:j.bridgeLink)||"").trim(),o=String((j==null?void 0:j.bridgeDeviceId)||"").trim()||void 0;if(!l){i({title:"الرابط غير مُعدّ",description:"احفظ رابط الجسر أولاً",variant:"destructive"});return}const m=String((ks==null?void 0:ks.receiver)||gs||"").replace(/\D/g,""),u=Math.max(1,Math.round(Number((ks==null?void 0:ks.amount)||Yt||0))||0),g=String(a||"").replace(/\D/g,""),x=(f=>{let A=(f||"").trim();return A=A.replace(/\/+$/,""),/^https?:\/\//i.test(A)||(A=`https://${A}`),A})(l);hr(!1)}catch(l){const o=(l==null?void 0:l.message)||"حدث خطأ أثناء إدخال الرقم السري";i({title:"فشل الإدخال",description:o,variant:"destructive"})}};console.log("🔥 UserDashboardPage - user:",s?"exists":"null");const[vt,Ze]=n.useState(!0),[Tt,Lt]=n.useState(!0),[ea,Rt]=n.useState(!1),[js,Ws]=n.useState(!1),[Fs,Da]=n.useState(""),[ts,_]=n.useState(""),[ce,me]=n.useState(""),[Ae,Le]=n.useState([]),[yt,rt]=n.useState(!1),[z,ke]=n.useState(null),[K,pt]=n.useState(""),[Ct,Qt]=n.useState(!1),[ss,Ss]=n.useState(!1),[ia,Ys]=n.useState(!1),[ma,Ca]=n.useState(!1),[la,U]=n.useState(""),[je,gt]=n.useState(""),[ut,Kt]=n.useState([]),[Ds,zt]=n.useState(!1),[ta,qa]=n.useState(0),[on,Cr]=n.useState(!1),[Fe,Ot]=n.useState(null),[Rs,cn]=n.useState(!1),[Ps,Va]=n.useState(""),[gs,lr]=n.useState(""),[Yt,Ja]=n.useState(""),[c,T]=n.useState(""),[E,Y]=n.useState(!1),[V,Ce]=n.useState(""),[ze,_e]=n.useState(""),[Re,Be]=n.useState(""),[he,jt]=n.useState(""),[Et,Bs]=n.useState(null),[sa,Ia]=n.useState(!1),[Ka,fs]=n.useState(!1),[Aa,Ya]=n.useState(!1),[bl,or]=n.useState(!1),[dn,cr]=n.useState(null),[cs,oi]=n.useState(""),[ds,ci]=n.useState(""),[vl,Zc]=n.useState(""),[Xc,mn]=n.useState(!1),[Lu,Wu]=n.useState(null),[Hs,wl]=n.useState(null),hn=t=>{const a="٠١٢٣٤٥٦٧٨٩",r="۰۱۲۳۴۵۶۷۸۹";return(t||"").split("").map(l=>{const o=a.indexOf(l);if(o>-1)return String(o);const m=r.indexOf(l);return m>-1?String(m):l}).join("")},[wt,di]=n.useState(()=>{try{const t=localStorage.getItem("commissionMode")||localStorage.getItem("commissionMode_default");return t?t==="add":!0}catch{return!0}}),[re,Nl]=n.useState("transfer"),[Ge,ha]=n.useState([]),[ua,mi]=n.useState("all"),[St,ms]=n.useState([]);n.useEffect(()=>{try{if(localStorage.setItem("commissionMode",wt?"add":"deduct"),s!=null&&s.uid){const t=`commissionMode_${s.uid}`;localStorage.setItem(t,wt?"add":"deduct")}}catch{}},[wt,s==null?void 0:s.uid]),n.useEffect(()=>{try{const t=new Set((Ge||[]).filter(l=>String((l==null?void 0:l.status)||"")==="completed"&&(l==null?void 0:l.linkedDebtId)).map(l=>String(l.linkedDebtId)));if(t.size===0)return;const a=St.map(l=>{if(t.has(String(l.id))){const o=Number(l.amount||0),m=Number(l.paidAmount||0);if(l.status!=="paid"||m<o)return{...l,status:"paid",paidAmount:o}}return l});if(a.some((l,o)=>l!==St[o])){ms(a),(async()=>await qs(a))();try{s!=null&&s.uid&&a.filter((o,m)=>o!==St[m]&&o.status==="paid").forEach(o=>{try{sr.send(s.uid,`تم سداد الدين بالكامل للعميل ${o.debtorName}: المدفوع ${Number(o.paidAmount||o.amount||0)} جنيه`)}catch{}})}catch{}}}catch{}},[Ge,St,s==null?void 0:s.uid]),n.useEffect(()=>{try{const t=s!=null&&s.uid?localStorage.getItem(`commissionMode_${s.uid}`):null,a=localStorage.getItem("commissionMode"),r=localStorage.getItem("commissionMode_default"),l=t??a??r;l&&di(l==="add")}catch{}},[s==null?void 0:s.uid]);const[hi,Ir]=n.useState(!1),[ed,td]=n.useState(null),un=Ye.useRef(""),jl=Ye.useRef(0);n.useEffect(()=>{const t=a=>{var l;if(hi)return;try{const o=document.activeElement;if(o){const m=(l=o.tagName)==null?void 0:l.toLowerCase();if(m==="input"||m==="textarea"||m==="select"||m==="button"||o.isContentEditable===!0)return}}catch{}const r=Date.now();if(a.key==="Enter"){const o=(un.current||"").trim();un.current="",o&&(td(o),Ir(!0));return}a.key.length===1&&(r-(jl.current||0)>100&&(un.current=""),un.current+=a.key,jl.current=r)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[hi]);const[sd,ad]=n.useState(!1),[rd,Fu]=n.useState(null);n.useEffect(()=>{if(!E)return;const t=as(),a=parseFloat(Yt||"0")||0;let r=0;if(re==="transfer"){if((t==null?void 0:t.defaultTransferCommission)!=null){const o=Number(t.defaultTransferCommission)||0;r=Math.round(o*a/1e3*100)/100}else{const o=ds&&ds.trim()!==""?parseFloat(ds):0;r=Math.max(0,o)}const l=a+r;_e((l||0).toString())}else{if((t==null?void 0:t.defaultWithdrawCommission)!=null){const o=Number(t.defaultWithdrawCommission)||0;r=Math.round(o*a/1e3*100)/100}else{const o=cs&&cs.trim()!==""?parseFloat(cs):Math.round(a*.01*100)/100;r=Math.max(0,o)}const l=wt?a:Math.max(0,Math.round((a-r)*100)/100);_e((l||0).toString())}},[E,Yt,ds,cs,D,wt,re]);const as=()=>{var a,r;let t=qe.find(l=>l.id===D);if(!t)try{const l=localStorage.getItem(Zi());if(l){const o=JSON.parse(l);if(Array.isArray(o)&&o.length>0){const u=localStorage.getItem($r())||((a=o.find(g=>g.isDefault))==null?void 0:a.id)||((r=o[0])==null?void 0:r.id);t=o.find(g=>g.id===u)}}}catch{}return t};n.useLayoutEffect(()=>{try{const t=`wallets_${(s==null?void 0:s.uid)||"default"}`;let a=localStorage.getItem(t);if(!a){const r=Object.keys(localStorage).find(l=>l.startsWith("wallets_"));r&&(a=localStorage.getItem(r)||null)}if(a){const r=JSON.parse(a);if(Array.isArray(r)&&r.length>0){Ar(r);const l=localStorage.getItem($r()),o=l&&r.find(m=>m.id===l)||r.find(m=>m.isDefault)||r[0];o&&(bt(o.id),Va(o.phone))}}}catch(t){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",t)}},[]),n.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",D)},[D]),n.useEffect(()=>{Co()},[s==null?void 0:s.uid]),n.useEffect(()=>{um()},[]);const[qe,Ar]=n.useState(()=>{try{const t=Object.keys(localStorage).find(r=>r.startsWith("wallets_")),a=t?localStorage.getItem(t):null;if(a){const r=JSON.parse(a);if(Array.isArray(r))return r}}catch{}return[]}),[Sl,nd]=n.useState(""),Dl=(()=>{const t=Sl.replace(/\D/g,"");return t?qe.filter(a=>(a.phone||"").replace(/\D/g,"").includes(t)):qe})(),[id,Ru]=n.useState(null),[ld,Cl]=n.useState(!1),[od,xn]=n.useState(!1),[cd,dd]=n.useState(null),[Bu,md]=n.useState([]),[Uu,zu]=n.useState([]),[hd,Tr]=n.useState(!1),[ui,Il]=n.useState("daily"),[pn,dr]=n.useState([]),[Al,ud]=n.useState(!1),Ta=Ye.useRef(new Set),Tl=Ye.useRef(new Set),Pl=Ye.useRef([]);n.useEffect(()=>{Pl.current=Ge},[Ge]);const kl=async t=>{try{if(!s)return;const a=Os(),r=Cs(),l=localStorage.getItem(a),o=localStorage.getItem(r);let m=l?parseFloat(l):Pt,u=o?JSON.parse(o):{...at};const g=Number(t.withdrawnAmount??t.sentAmount??t.transferredAmount??t.amount??0);if(t.type==="send"&&(t.fromWallet||D)){m-=g;const f=t.fromWallet||D;u[f]=(u[f]||0)+g}else if(t.type==="withdraw"&&(t.fromWallet||D)){m+=g;const f=t.fromWallet||D;u[f]=Math.max(0,(u[f]||0)-g)}Ht(m),ns(u),localStorage.setItem(a,m.toString()),localStorage.setItem(r,JSON.stringify(u));const S={cashBalance:m,walletBalances:u,lastUpdated:new Date().toISOString()},x=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(x,JSON.stringify(S));try{await Se.updateUserData(s.uid,S),localStorage.removeItem(x),Xe(!1)}catch(f){console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف (مزامنة تلقائية):",f),Xe(!0)}try{const f=t.fromWallet||D,A=await Gs.getWalletLimits(s.uid,f);if(A){const P={...A};t.type==="send"?(P.dailyTransferUsed=Math.max(0,(A.dailyTransferUsed||0)-g),P.monthlyTransferUsed=Math.max(0,(A.monthlyTransferUsed||0)-g)):(P.dailyWithdrawUsed=Math.max(0,(A.dailyWithdrawUsed||0)-g),P.monthlyWithdrawUsed=Math.max(0,(A.monthlyWithdrawUsed||0)-g)),await Gs.updateWalletLimits(s.uid,f,P)}}catch(f){console.warn("تعذر تحديث حدود المحفظة بعد الحذف (مزامنة):",f)}try{bs.removeTransactionEffects(t,s.uid)}catch(f){console.warn("تعذر تحديث التقارير بعد الحذف (مزامنة):",f)}}catch(a){console.warn("خطأ أثناء تطبيق تأثيرات الحذف محليًا:",a)}},xd=async t=>{try{const a=Ge.find(u=>u.id===t);if(!a||!s)return;const r=String(t),l=String((a==null?void 0:a.transactionId)||(a==null?void 0:a.reference)||""),o=Ta.current.has(r)||l&&Ta.current.has(l),m=Ge.filter(u=>u.id!==t);ha(m);try{await Se.removeUserTransaction(s.uid,t),await Qr.permanentlyDeleteTransaction(t,s.uid)}catch(u){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",u)}if(!o){Ta.current.add(r),l&&Ta.current.add(l),await kl(a);try{s!=null&&s.uid&&Se.removeLocalReceiptById(s.uid,t)}catch{}}i({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),xn(!1)}catch(a){console.error("خطأ أثناء حذف الإيصال:",a),i({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},pd=async t=>{var a;try{const r=Ge.find(l=>l.id===t);if(!r||!s)return;try{const l=(a=Fe==null?void 0:Fe.subscription)==null?void 0:a.planType;if(l===$s.ZERO){const{dailyOperationCountService:o}=await Nt(async()=>{const{dailyOperationCountService:g}=await import("./dailyOperationCountService-9b-RCNij.js");return{dailyOperationCountService:g}},__vite__mapDeps([2,0,1]),import.meta.url),m=r.type==="send"?"transfer":"withdraw";if(!(await o.checkAndIncrement(s.uid,m,5)).allowed){i({title:"تم بلوغ حد باقة الزيرو",description:"مسموح بحد أقصى 5 تأكيدات يوميًا للتحويل/السحب. جرّب غدًا أو قم بالترقية.",variant:"destructive"});return}}else if(l===$s.TAHWEELA){const{dailyOperationCountService:o}=await Nt(async()=>{const{dailyOperationCountService:g}=await import("./dailyOperationCountService-9b-RCNij.js");return{dailyOperationCountService:g}},__vite__mapDeps([2,0,1]),import.meta.url),m=r.type==="send"?"transfer":"withdraw";if(!(await o.checkAndIncrementCombined(s.uid,m,40)).allowed){i({title:"تم بلوغ حد باقة تحويله",description:"هذه الباقة تسمح بحد أقصى 40 عملية تحويل/سحب يومياً.",variant:"destructive"});return}}}catch(l){console.warn("تعذر التحقق من حد التأكيد اليومي:",l)}await Zt(Je(J,"userTransactions",t),{status:"completed",confirmedAt:new Date}),ha(l=>l.map(o=>o.id===t?{...o,status:"completed"}:o)),i({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),xn(!1)}catch(r){console.error("خطأ أثناء إكمال الإيصال:",r),i({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}};n.useEffect(()=>{if(s)try{const t=Ue(Ne(J,"deletedTransactions"),ie("userId","==",s.uid)),a=Ls(t,r=>{r.docChanges().forEach(l=>{if(l.type!=="added")return;const o=l.doc.data(),m=String((o==null?void 0:o.originalTransactionId)||""),u=String((o==null?void 0:o.transactionId)||""),g=String((o==null?void 0:o.reference)||""),S=m||u||g||String(l.doc.id);S&&(Ta.current.has(S)||(Ta.current.add(S),ha(x=>{const f=x.find(P=>P.id===m);return f?((async()=>await kl(f))(),x.filter(P=>P.id!==m)):x})))})},r=>{console.warn("فشل الاشتراك في deletedTransactions:",r)});return()=>a()}catch(t){console.warn("تعذر إنشاء مستمع deletedTransactions:",t)}},[s==null?void 0:s.uid]),n.useEffect(()=>{if(s)try{const t=Je(J,"users",s.uid),a=Ls(t,async r=>{if(!r.exists())return;const l=r.data();if(l!=null&&l.reportsData)try{await bs.syncReportsDataFromFirebase(s.uid),md(Vr())}catch(o){console.warn("تعذر مزامنة reportsData من السحابة:",o)}},r=>{console.warn("فشل الاشتراك في users.reportsData:",r)});return()=>a()}catch(t){console.warn("تعذر إنشاء مستمع users.reportsData:",t)}},[s==null?void 0:s.uid]);const[_l,gd]=n.useState(""),Ol=Nu(_l,300),[gn,El]=n.useState(""),[fn,Ml]=n.useState(""),[xa,qu]=n.useState(""),[xi,mr]=n.useState(!1),[$l,Pr]=n.useState(!1),[fd,Ha]=n.useState(!1),[rs,pi]=n.useState(null),[ks,yd]=n.useState(null),[Ll,Ga]=n.useState(!1),[bd,hr]=n.useState(!1),[Wl,vd]=n.useState(""),[wd,gi]=n.useState(!1),Fl=!1,[Nd,yn]=n.useState(!1),[jd,Rl]=n.useState(!1),[Sd,bn]=n.useState(!1),[Dd,vn]=n.useState(!1),[Cd,wn]=n.useState(!1),[Id,Bl]=n.useState(!0),[kr,Ad]=n.useState(!1),[Td,Nn]=n.useState(!1),[Pd,Ul]=n.useState(!1),[jn,kd]=n.useState(""),[zl,_d]=n.useState(!1),[Od,fi]=n.useState(!1),[Ed,ql]=n.useState(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[Md,yi]=n.useState(!1);n.useEffect(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled",a=localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled");ql(a==="true")}catch{}},[s==null?void 0:s.uid]);const[$d,ur]=n.useState(!1),[Ld,bi]=n.useState(!1),[Wd,Vl]=n.useState(()=>{try{const t=s==null?void 0:s.uid,a=t?`debtsPinRequired_${t}`:"debtsPinRequired";return(localStorage.getItem(a)??localStorage.getItem("debtsPinRequired"))==="true"}catch{return!1}}),[Fd,Jl]=n.useState(!1),[Kl,Rd]=n.useState(null),[vi,Yl]=n.useState(""),[wi,Hl]=n.useState(""),[Ni,Gl]=n.useState(""),[ne,Qa]=n.useState(null),[Bd,Pa]=n.useState(!1),[Ud,_r]=n.useState(!1),[Za,Ql]=n.useState(null),[Zl,ji]=n.useState(""),[Sn,Xl]=n.useState(null),[Vu,Ju]=n.useState(!1),[zd,Si]=n.useState(!1),[eo,Di]=n.useState(""),[Ci,xr]=n.useState(!1),[to,Ii]=n.useState(1),qd=R?10:20,Ai=Ye.useMemo(()=>St.slice(0,to*qd),[St,to]);n.useEffect(()=>{Ci&&Ii(1)},[Ci]);const Ti=async()=>{if(Dt){i({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}try{const t=await ws.hasMasterPin(s==null?void 0:s.uid);Wd&&t?bi(!0):ur(!0)}catch{ur(!0)}};n.useEffect(()=>{try{const t=s==null?void 0:s.uid,a=t?`debtsPinRequired_${t}`:"debtsPinRequired",r=localStorage.getItem(a)??localStorage.getItem("debtsPinRequired");(r==="true"||r==="false")&&Vl(r==="true")}catch{}},[s==null?void 0:s.uid]);const[Vd,Pi]=n.useState(!1),[Us,ki]=n.useState([]),[_i,so]=n.useState(""),[Oi,ao]=n.useState(""),[Dn,ro]=n.useState(""),[no,Jd]=n.useState(""),[Kd,Cn]=n.useState(!1),[Yd,io]=n.useState(""),[lo,Ei]=n.useState(""),[oo,Mi]=n.useState(""),[Hd,In]=n.useState(!1),[Gd,$i]=n.useState(""),[co,Li]=n.useState(""),[Qd,pr]=n.useState(!1),[ka,An]=n.useState(null),[_s,Or]=n.useState(null),[Tn,Wi]=n.useState(""),[Zd,gr]=n.useState(!1),[mo,Pn]=n.useState(0),[zs,_a]=n.useState(null),[Xa,Fi]=n.useState(""),[tt,Ri]=n.useState(null),[ho,uo]=n.useState(""),qs=async t=>{try{const a=JSON.stringify(t);localStorage.setItem(Mr(),a);try{localStorage.setItem(So(),a)}catch{}try{localStorage.setItem(Do(),Date.now().toString())}catch{}s!=null&&s.uid&&Se.updateUserData(s.uid,{debts:t}).then(()=>{try{localStorage.removeItem(`debts_unsynced_${s.uid}`)}catch{}}).catch(()=>{Xe(!0);try{localStorage.setItem(`debts_unsynced_${s.uid}`,"true")}catch{}})}catch(a){console.error("خطأ في حفظ الديون:",a)}},Xd=async()=>{try{const t=Mr(),a=So(),r=Do(),l=localStorage.getItem(t),o=localStorage.getItem(a),m=localStorage.getItem(r),u=m?Number(m):0,g=x=>{if(!x)return null;try{const f=JSON.parse(x);return Array.isArray(f)?f.map(A=>{var P;return{...A,createdAt:(P=A.createdAt)!=null&&P.toDate?A.createdAt.toDate():new Date(A.createdAt),partialPayments:Array.isArray(A.partialPayments)?A.partialPayments.map(k=>{var H;return{amount:Number(k.amount)||0,paidAt:(H=k.paidAt)!=null&&H.toDate?k.paidAt.toDate():new Date(k.paidAt)}}):[]}}):[]}catch(f){return console.warn("فشل في تحليل ديون localStorage:",f),null}};let S=g(l);if(!S||S.length===0){const x=g(o);if(x&&x.length>0){S=x,ms(x);try{localStorage.setItem(Mr(),JSON.stringify(x)),localStorage.removeItem(a)}catch(f){console.warn("تعذر ترحيل الديون محلياً من المفتاح الافتراضي:",f)}}}if(S&&S.length>0&&ms(S),s!=null&&s.uid)try{const x=`debts_unsynced_${s.uid}`,f=localStorage.getItem(x)==="true",A=await va(Je(J,"users",s.uid));if(A.exists()){const P=A.data(),k=P.debts&&Array.isArray(P.debts)?P.debts.map(Q=>{var ee;return{...Q,amount:Number(Q.amount||0),paidAmount:Number(Q.paidAmount||0),createdAt:(ee=Q.createdAt)!=null&&ee.toDate?Q.createdAt.toDate():new Date(Q.createdAt),partialPayments:Array.isArray(Q.partialPayments)?Q.partialPayments.map(se=>{var hs;return{amount:Number(se.amount)||0,paidAt:(hs=se.paidAt)!=null&&hs.toDate?se.paidAt.toDate():new Date(se.paidAt)}}):[]}}):[];if(!!P.debtsDeletedAt){ms([]);try{localStorage.setItem(t,JSON.stringify([])),localStorage.setItem(a,JSON.stringify([]))}catch{}return}if(((k==null?void 0:k.length)||0)>0){ms(k);try{localStorage.setItem(t,JSON.stringify(k))}catch{}}}else S&&S.length>0}catch(x){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",x)}}catch(t){console.error("خطأ في تحميل الديون:",t)}};n.useEffect(()=>{try{window.exportDebts=()=>{try{return JSON.stringify(St||[])}catch{return"[]"}},window.importDebts=async t=>{try{const a=JSON.parse(t);if(!Array.isArray(a))throw new Error("صيغة غير صحيحة — يجب أن تكون مصفوفة");return await qs(a),{ok:!0,count:a.length}}catch(a){return console.error("فشل استيراد الديون:",a),{ok:!1,error:String(a)}}},window.fixWalletsForCurrentUser=async t=>{try{if(!(s!=null&&s.uid))throw new Error("يجب تسجيل الدخول أولاً");return await(await Nt(async()=>{const{merchantWalletService:r}=await import("./index-DKHjTn06.js").then(l=>l.bJ);return{merchantWalletService:r}},__vite__mapDeps([0,1]),import.meta.url)).merchantWalletService.reassignByMsisdns(t,s.uid)}catch(a){return console.error("فشل إصلاح المحافظ للمستخدم الحالي:",a),{updated:0,failed:(t==null?void 0:t.length)||0,error:String(a)}}}}catch{}},[St,s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;const t=Je(J,"users",s.uid),a=Ls(t,r=>{if(!r.exists())return;const l=r.data(),o=Array.isArray(l==null?void 0:l.debts)?l.debts:[];try{const m=o.map(u=>{var g;return{...u,createdAt:(g=u.createdAt)!=null&&g.toDate?u.createdAt.toDate():new Date(u.createdAt),partialPayments:Array.isArray(u.partialPayments)?u.partialPayments.map(S=>{var x;return{amount:Number(S.amount)||0,paidAt:(x=S.paidAt)!=null&&x.toDate?S.paidAt.toDate():new Date(S.paidAt)}}):[]}});ms(m);try{localStorage.setItem(Mr(),JSON.stringify(m))}catch{}}catch(m){console.warn("تعذر تحليل الديون من التحديثات الحية:",m)}},r=>{console.warn("خطأ في الاشتراك الحي لديون المستخدم:",r)});return()=>a()},[s==null?void 0:s.uid]);const em=async()=>{if(s!=null&&s.uid)try{cn(!0);const t=await fl(s.uid);Ot(t)}catch(t){console.error("خطأ في جلب بيانات الاشتراك:",t)}finally{cn(!1)}},[Ku,Yu]=n.useState(!1),[tm,Bi]=n.useState(!1),[Pt,Ht]=n.useState(0),[at,ns]=n.useState({}),[sm,xo]=n.useState(!1),[am,po]=n.useState(!1),[rm,Ui]=n.useState(!1),[nm,kn]=n.useState(!1),[go,zi]=n.useState(""),[im,Er]=n.useState(!1),[lm,_n]=n.useState(!1),[qi,On]=n.useState(""),[om,Vi]=n.useState(!1),[En,fo]=n.useState(""),[Mn,yo]=n.useState(""),[$n,bo]=n.useState(""),[vo,wo]=n.useState(!1),[Ji,Ki]=n.useState(!1),[cm,No]=n.useState(!1),[jo,dm]=n.useState([]);n.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid)||!Ji)return;try{await Yr.trimToMaxCount(s.uid,30)}catch{}const t=await Yr.getByUser(s.uid,30);dm(t)}catch{}})()},[s==null?void 0:s.uid,Ji]);const Cs=()=>{const t=O||(j==null?void 0:j.shopId)||"main";return`walletBalances_${(s==null?void 0:s.uid)||"default"}_${t}`},Os=()=>{const t=O||(j==null?void 0:j.shopId)||"main";return`cashBalance_${(s==null?void 0:s.uid)||"default"}_${t}`},Mr=()=>{const t=O||(j==null?void 0:j.shopId)||"main";return`debts_${(s==null?void 0:s.uid)||"default"}_${t}`},mm=()=>{const t=O||(j==null?void 0:j.shopId)||"main";return`customers_${(s==null?void 0:s.uid)||"default"}_${t}`},So=()=>`debts_default_${O||(j==null?void 0:j.shopId)||"main"}`,Do=()=>{const t=O||(j==null?void 0:j.shopId)||"main";return`debts_last_write_${(s==null?void 0:s.uid)||"default"}_${t}`},Yi=()=>`shopExpenses_${O||(j==null?void 0:j.shopId)||(s==null?void 0:s.uid)||"default"}`,Co=()=>{try{const t=localStorage.getItem(Yi());if(t){const a=JSON.parse(t);Le(a.map(r=>({...r,createdAt:new Date(r.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",t)}},Io=async t=>{try{localStorage.setItem(Yi(),JSON.stringify(t)),Le(t)}catch(a){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",a)}},hm=async t=>{try{const a=Ae.filter(r=>r.id!==t);await Io(a);try{if(s!=null&&s.uid&&t){const{doc:r,deleteDoc:l}=await Nt(async()=>{const{doc:u,deleteDoc:g}=await import("./index-DKHjTn06.js").then(S=>S.bH);return{doc:u,deleteDoc:g}},__vite__mapDeps([0,1]),import.meta.url),{db:o}=await Nt(async()=>{const{db:u}=await import("./index-DKHjTn06.js").then(g=>g.bI);return{db:u}},__vite__mapDeps([0,1]),import.meta.url),m=r(o,"shop_expenses",t);await l(m)}}catch(r){console.warn("تعذر حذف المصروف من السحابة الآن، تم الحذف محليًا وسيبقى مخزّنًا دون هذا الإيصال:",r)}i({title:"تم الحذف",description:"تم حذف إيصال المصروف نهائيًا."})}catch(a){console.error("خطأ أثناء الحذف النهائي لإيصال المصروف:",a),i({title:"فشل الحذف",description:"تعذر حذف الإيصال. حاول مرة أخرى.",variant:"destructive"})}};Ye.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid)){Co();return}const{collection:a,query:r,where:l,onSnapshot:o}=await Nt(async()=>{const{collection:S,query:x,where:f,onSnapshot:A}=await import("./index-DKHjTn06.js").then(P=>P.bH);return{collection:S,query:x,where:f,onSnapshot:A}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await Nt(async()=>{const{db:S}=await import("./index-DKHjTn06.js").then(x=>x.bI);return{db:S}},__vite__mapDeps([0,1]),import.meta.url),u=O||(j==null?void 0:j.shopId),g=u?r(a(m,"shop_expenses"),l("shopId","==",u)):r(a(m,"shop_expenses"),l("userId","==",s.uid));t=o(g,async S=>{const f=S.docs.map(A=>{var H;const P=A.data(),k=(H=P.createdAt)!=null&&H.toDate?P.createdAt.toDate():P.createdAt?new Date(P.createdAt):new Date;return{id:A.id,name:String(P.name||""),amount:Number(P.amount||0),notes:P.notes?String(P.notes):void 0,source:P.source==="wallet"?"wallet":"cash",walletId:P.walletId?String(P.walletId):void 0,createdAt:k}}).sort((A,P)=>P.createdAt.getTime()-A.createdAt.getTime());Le(f);try{localStorage.setItem(Yi(),JSON.stringify(f))}catch{}})}catch(a){console.error("خطأ في مزامنة مصروفات المحل من Firestore:",a)}})(),()=>t==null?void 0:t()},[s==null?void 0:s.uid,j==null?void 0:j.shopId,O]);const Ln=()=>`deficiencies_${O||(j==null?void 0:j.shopId)||(s==null?void 0:s.uid)||"default-shop"}`,um=()=>{try{const t=Ln(),a=`deficiencies_${(s==null?void 0:s.uid)||"default"}`;if(a!==t){const l=localStorage.getItem(a),o=localStorage.getItem(t);if(l)try{const m=JSON.parse(l)||[],u=o?JSON.parse(o):[],g=Array.isArray(u)?[...u]:[],S=(x,f)=>x.some(A=>(A==null?void 0:A.id)&&(f==null?void 0:f.id)&&String(A.id)===String(f.id)||String((A==null?void 0:A.name)||"")===String((f==null?void 0:f.name)||"")&&String((A==null?void 0:A.status)||"pending")===String((f==null?void 0:f.status)||"pending"));if(Array.isArray(m))for(const x of m)S(g,x)||g.push(x);localStorage.setItem(t,JSON.stringify(g));try{localStorage.removeItem(a)}catch{}}catch{}}const r=localStorage.getItem(t);if(r){const l=JSON.parse(r);Kt(l.map(o=>({...o,createdAt:new Date(o.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل النواقص من التخزين:",t)}},Hi=async t=>{try{localStorage.setItem(Ln(),JSON.stringify(t)),Kt(t)}catch(a){console.error("خطأ أثناء حفظ النواقص في التخزين:",a)}};Ye.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid))return;const{collection:a,query:r,where:l,orderBy:o,onSnapshot:m}=await Nt(async()=>{const{collection:x,query:f,where:A,orderBy:P,onSnapshot:k}=await import("./index-DKHjTn06.js").then(H=>H.bH);return{collection:x,query:f,where:A,orderBy:P,onSnapshot:k}},__vite__mapDeps([0,1]),import.meta.url),{db:u}=await Nt(async()=>{const{db:x}=await import("./index-DKHjTn06.js").then(f=>f.bI);return{db:x}},__vite__mapDeps([0,1]),import.meta.url),g=O||(j==null?void 0:j.shopId)||s.uid||"default-shop",S=r(a(u,"deficiencies"),l("shopId","==",g),o("createdAt","desc"));t=m(S,async x=>{const f=x.docs.map(A=>{var H;const P=A.data(),k=(H=P.createdAt)!=null&&H.toDate?P.createdAt.toDate():P.createdAt?new Date(P.createdAt):new Date;return{id:A.id,name:String(P.name||""),quantity:Number(P.quantity||1),status:P.status==="purchased"?"purchased":"pending",createdAt:k}});Kt(f);try{localStorage.setItem(Ln(),JSON.stringify(f))}catch{}},x=>{console.warn("فشل الاشتراك في النواقص من Firestore:",x)})}catch(a){console.warn("فشل إعداد مزامنة النواقص من Firestore:",a)}})(),()=>{try{t&&t()}catch{}}},[s==null?void 0:s.uid,j==null?void 0:j.shopId,O]);const Gi=async t=>{try{localStorage.setItem(mm(),JSON.stringify(t)),ki(t),s!=null&&s.uid&&await Se.updateUserData(s.uid,{customers:t})}catch(a){console.error("خطأ أثناء حفظ العملاء في التخزين:",a)}},xm=async()=>{try{if(s!=null&&s.uid){const t=await va(Je(J,"users",s.uid));if(t.exists()){const a=t.data();if(a.customers&&Array.isArray(a.customers)){const r=a.customers.map(l=>{var o;return{...l,createdAt:(o=l.createdAt)!=null&&o.toDate?l.createdAt.toDate():new Date(l.createdAt)}});ki(r);return}}}ki([])}catch(t){console.error("خطأ أثناء تحميل العملاء من Firestore:",t)}},Qi=()=>{const t=O||(j==null?void 0:j.shopId)||"main";return`transactions_${(s==null?void 0:s.uid)||"default"}_${t}`},Zi=()=>{const t=O||(j==null?void 0:j.shopId)||"main";return`wallets_${(s==null?void 0:s.uid)||"default"}_${t}`},$r=()=>{const t=O||(j==null?void 0:j.shopId)||"main";return`selectedWallet_${(s==null?void 0:s.uid)||"default"}_${t}`};n.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid))return;const{collection:a,query:r,where:l,orderBy:o,limit:m,onSnapshot:u}=await Nt(async()=>{const{collection:x,query:f,where:A,orderBy:P,limit:k,onSnapshot:H}=await import("./index-DKHjTn06.js").then($e=>$e.bH);return{collection:x,query:f,where:A,orderBy:P,limit:k,onSnapshot:H}},__vite__mapDeps([0,1]),import.meta.url),{db:g}=await Nt(async()=>{const{db:x}=await import("./index-DKHjTn06.js").then(f=>f.bI);return{db:x}},__vite__mapDeps([0,1]),import.meta.url),S=r(a(g,"userTransactions"),l("userId","==",s.uid),o("createdAt","desc"),m(100));t=u(S,x=>{Al||ud(!0);const A=x.docs.map(ee=>{var ga;const se=ee.data(),hs=(ga=se.createdAt)!=null&&ga.toDate?se.createdAt.toDate():new Date(se.createdAt),Vs=se.txnType==="send"?"send":se.txnType==="receive"?"withdraw":se.type||"withdraw",Js=se.status==="confirmed"?"completed":se.status||"completed",yr=se.senderMsisdn||se.senderPhone||"",br=se.receiverMsisdn||se.receiverPhone||"",Oa=Number(se.amount??se.transferredAmount??se.withdrawnAmount??0);return{id:ee.id,...se,type:Vs,status:Js,senderPhone:yr,receiverPhone:br,amount:Oa,createdAt:hs}}).filter(ee=>!((ee==null?void 0:ee.type)==="report"||String((ee==null?void 0:ee.title)||"").includes("إيصال تسليم وردية"))),P=new Set((pn||[]).map(ee=>String(ee.id||ee.originalTransactionId||""))),k=A.filter(ee=>!P.has(String(ee.id||""))),H=ee=>{var se;return String(ee.transactionId||ee.id||ee.reference||((se=ee.receipt)==null?void 0:se.reference)||`${new Date(ee.createdAt).getTime()}`)},$e=new Set,Q=[];for(const ee of k){const se=H(ee);$e.has(se)||($e.add(se),Q.push(ee))}ha(Q)})}catch{}})(),()=>{try{t&&t()}catch{}}},[s==null?void 0:s.uid,pn.length]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;let t=null;return(async()=>{try{const{collection:a,query:r,where:l,onSnapshot:o}=await Nt(async()=>{const{collection:g,query:S,where:x,onSnapshot:f}=await import("./index-DKHjTn06.js").then(A=>A.bH);return{collection:g,query:S,where:x,onSnapshot:f}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await Nt(async()=>{const{db:g}=await import("./index-DKHjTn06.js").then(S=>S.bI);return{db:g}},__vite__mapDeps([0,1]),import.meta.url),u=r(a(m,"deletedTransactions"),l("userId","==",s.uid));t=o(u,g=>{try{g.docChanges().forEach(x=>{const f=x.doc.data(),A=[f.originalTransactionId,f.transactionId,f.reference,x.doc.id].filter(Boolean).map(H=>String(H));if(A.find(H=>Tl.current.has(H)))return;const k=Pl.current.find(H=>{const $e=String(H.id||""),Q=String(H.transactionId||""),ee=String(H.reference||"");return A.includes($e)||A.includes(Q)||A.includes(ee)});if(k){const H=k.fromWallet||D||"",$e=Number(k.withdrawnAmount??k.sentAmount??k.amount??0),Q=k.type==="send"?"transfer":"withdraw";H&&$e>0&&(Gs.rollbackUsage(H,$e,Q).catch(()=>{}),A.forEach(ee=>Tl.current.add(ee)))}});const S=g.docs.map(x=>{var P;const f=x.data(),A=(P=f.createdAt)!=null&&P.toDate?f.createdAt.toDate():new Date(f.createdAt||Date.now());return{id:x.id,...f,createdAt:A}});dr(S),(async()=>{try{const x=O||(j==null?void 0:j.shopId);if(!x)return;const f=Je(m,"dashboardData",x),A=await va(f);if(A.exists()){const P=A.data();typeof P.cashBalance=="number"&&Ht(Number(P.cashBalance||0)),P.walletBalances&&typeof P.walletBalances=="object"&&ns(P.walletBalances||{})}}catch{}})()}catch{}},g=>{console.warn("deletedTransactions subscription error (Dashboard):",g)})}catch{}})(),()=>{try{t&&t()}catch{}}},[s==null?void 0:s.uid]);const[Xi,Wn]=n.useState(""),[Es,Ao]=n.useState(""),oa=Ye.useMemo(()=>{const t=Fe;if(!t)return!1;const a=dh(t),r=t.planType??t.plan??null,l=typeof r=="string"?r.toLowerCase():null,o=l==="monthly"||l==="quarterly"||l==="yearly"||l==="lifetime"||r===$s.MONTHLY||r===$s.QUARTERLY||r===$s.YEARLY||r===$s.LIFETIME;return a&&o},[Fe]),Dt=Ye.useMemo(()=>{var l,o;const t=Fe;if(!t)return!1;const a=((l=t.subscription)==null?void 0:l.planType)??((o=t.subscription)==null?void 0:o.plan)??t.planType??t.plan??null,r=typeof a=="string"?a.toLowerCase():null;return a===$s.ZERO||r==="zero"},[Fe]),Bt=Ye.useMemo(()=>{var l,o;const t=Fe;if(!t)return!1;const a=((l=t.subscription)==null?void 0:l.planType)??((o=t.subscription)==null?void 0:o.plan)??t.planType??t.plan??null,r=typeof a=="string"?String(a).trim().toLowerCase():null;return a===$s.TAHWEELA||r==="tahweela"||r==="تحويله"},[Fe]),pm=()=>{if(!oa){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}ae(!0)},[Hu,Gu]=n.useState(!1),[gm,fm]=n.useState(!1),[ym,bm]=n.useState(!1),[vm,wm]=n.useState(!1),[Nm,Lr]=n.useState(!1),[er,Fn]=n.useState(""),[Wr,Rn]=n.useState(""),[To,Bn]=n.useState(!1),[Fr,Rr]=n.useState(null),[el,Un]=n.useState(""),[jm,Po]=n.useState(!1),[Qu,Zu]=n.useState(!1),[Sm,zn]=n.useState(!1),[ko,tl]=n.useState(""),[_o,sl]=n.useState(""),[Oo,Eo]=n.useState(!1),Mo=async()=>{var t;if(s!=null&&s.uid)try{const a=`userData_${s.uid}`,r=localStorage.getItem(a),l=`debts_unsynced_${s.uid}`,o=localStorage.getItem(Mr()),m=localStorage.getItem(l)==="true";if(r){const u=JSON.parse(r);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",u);const g={lastSynced:new Date().toISOString()};typeof u.cashBalance=="number"&&(g.cashBalance=u.cashBalance),u.walletBalances&&typeof u.walletBalances=="object"&&(g.walletBalances=u.walletBalances),await Se.updateUserData(s.uid,g),localStorage.removeItem(a),Xe(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة");if(m&&o)try{const u=JSON.parse(o)||[],g=Q=>Q instanceof Date?Q:typeof(Q==null?void 0:Q.toDate)=="function"?Q.toDate():Q?new Date(String(Q)):new Date,S=Q=>(Array.isArray(Q)?Q:[]).map(ee=>({...ee,amount:Number(ee.amount||0),paidAmount:Number(ee.paidAmount||0),createdAt:g(ee.createdAt),partialPayments:Array.isArray(ee.partialPayments)?ee.partialPayments.map(se=>({amount:Number(se.amount||0),paidAt:g(se.paidAt)})):[]})),x=await va(Je(J,"users",s.uid)),f=x.exists()?((t=x.data())==null?void 0:t.debts)||[]:[],A=S(f),P=S(u),k={};for(const Q of A)k[String(Q.id||"")]=Q;const H=[],$e=new Set;for(const Q of P){const ee=String(Q.id||""),se=k[ee];if(se){const hs=Number(se.paidAmount||0)+(Array.isArray(se.partialPayments)?se.partialPayments.reduce((Oa,ga)=>Oa+Number(ga.amount||0),0):0),Vs=Number(Q.paidAmount||0)+(Array.isArray(Q.partialPayments)?Q.partialPayments.reduce((Oa,ga)=>Oa+Number(ga.amount||0),0):0),Js=String(se.status||"pending"),yr=String(Q.status||"pending"),br=Js==="paid"||hs>=Number(se.amount||0)?se:yr==="paid"?{...se,paidAmount:Number(Q.paidAmount||0),partialPayments:Q.partialPayments,status:"paid"}:Vs>hs?{...se,paidAmount:Number(Q.paidAmount||0),partialPayments:Q.partialPayments,status:Vs>=Number(se.amount||0)?"paid":"pending"}:se;H.push(br),$e.add(ee)}else H.push(Q),$e.add(ee)}for(const Q of A){const ee=String(Q.id||"");$e.has(ee)||H.push(Q)}await Se.updateUserData(s.uid,{debts:H});try{localStorage.removeItem(l)}catch{}Xe(!1)}catch{Xe(!0)}}catch(a){console.error("❌ فشل في مزامنة البيانات:",a),i({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},[fr,qn]=n.useState({keepLastCount:30,intervalDays:7,lastResetAt:null});n.useEffect(()=>{(async()=>{if(s!=null&&s.uid)try{const a=await Se.getUserData(s.uid),r=(a==null?void 0:a.recentReset)||{},l=Number(r==null?void 0:r.keepLastCount)>0?Number(r.keepLastCount):30,o=Number(r==null?void 0:r.intervalDays)>0?Number(r.intervalDays):7,m=x=>x instanceof Date?x:typeof(x==null?void 0:x.toDate)=="function"?x.toDate():x?new Date(String(x)):null,u=r!=null&&r.lastResetAt?m(r.lastResetAt):null,g=new Date;!u||g.getTime()-u.getTime()>=o*24*60*60*1e3?(await Se.updateUserData(s.uid,{recentReset:{keepLastCount:l,intervalDays:o,lastResetAt:g}}),qn({keepLastCount:l,intervalDays:o,lastResetAt:g})):qn({keepLastCount:l,intervalDays:o,lastResetAt:u})}catch{qn({keepLastCount:30,intervalDays:7,lastResetAt:null})}})()},[s==null?void 0:s.uid]);const $o=Ye.useMemo(()=>{const t=Ge||[],a=fr.keepLastCount??30;return[...t].sort((l,o)=>{const m=u=>u instanceof Date?u:typeof(u==null?void 0:u.toDate)=="function"?u.toDate():new Date(String(u));return m(o.createdAt).getTime()-m(l.createdAt).getTime()}).slice(0,a)},[Ge,fr.keepLastCount]),Dm=Ye.useMemo(()=>Math.max(0,((Ge==null?void 0:Ge.length)||0)-(fr.keepLastCount||30)),[Ge==null?void 0:Ge.length,fr.keepLastCount]),Vn=Ye.useMemo(()=>{const t=new Date,a=new Date(t.getFullYear(),t.getMonth(),1),r=new Date(t.getFullYear(),t.getMonth()+1,1),l={};for(const m of Ge){const u=new Date(m.createdAt||0);if(!(u>=a&&u<r))continue;const g=String(m.type||m.txnType||"").toLowerCase();if(!(g==="send"||g==="withdraw"||g==="transfer"))continue;const S=String(m.receiverPhone||m.senderPhone||"").trim();if(!S)continue;const x=Ns(S),f=Number(m.amount||m.withdrawnAmount||m.sentAmount||0)||0;l[x]||(l[x]={phone:x,count:0,total:0}),l[x].count+=1,l[x].total+=f}return Object.values(l).sort((m,u)=>u.count!==m.count?u.count-m.count:u.total-m.total).slice(0,10)},[Ge]),Cm=t=>{const a=Ns(String(t));return a.startsWith("+20")?"20"+a.slice(3):a.startsWith("0")?"20"+a.slice(1):a.replace(/[^0-9]/g,"")},Im=t=>{const a=Cm(t.phone),r=`عميل VIP هذا الشهر
عدد العمليات: ${t.count}
الإجمالي: ${t.total} جنيه`,l=`https://wa.me/${a}?text=${encodeURIComponent(r)}`;try{window.open(l,"_blank")}catch{}};n.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid))return;const t=`${new Date().getFullYear()}-${new Date().getMonth()+1}`;await Se.updateUserData(s.uid,{vipTop10:Vn,vipMonthTag:t})}catch{}})()},[s==null?void 0:s.uid,Vn]);async function Am(){const t=new Date,a=new Intl.DateTimeFormat("ar-EG",{timeZone:"Africa/Cairo",year:"numeric",month:"2-digit",day:"2-digit"}).format(t),r=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0,0),l=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59,999),o=(Ge||[]).filter(k=>{const H=new Date(k.createdAt||0);return H>=r&&H<=l}),m=o.length,u=o.filter(k=>String(k.type||k.txnType||"").toLowerCase()==="withdraw"||String(k.type||"").toLowerCase()==="receive").reduce((k,H)=>k+(H.withdrawnAmount!=null?Number(H.withdrawnAmount):Number(H.amount||0)),0),g=o.filter(k=>String(k.type||k.txnType||"").toLowerCase()==="send"||String(k.type||"").toLowerCase()==="transfer").reduce((k,H)=>k+(H.sentAmount!=null?Number(H.sentAmount):Number(H.amount||0)),0);let S=0;try{S=o.reduce((k,H)=>k+bs.calculateTransactionProfit(H),0)}catch{}let x=0;try{const k=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(t),H=Ue(Ne(J,"dailySales"),ie("userId","==",(s==null?void 0:s.uid)||""));x=(await Qe(H)).docs.map(ee=>ee.data()).filter(ee=>String(ee.date||k)===k).reduce((ee,se)=>ee+Number(se.sellingPrice||se.price||0)*Number(se.quantity||1),0)}catch{}let f=0;try{f=(St||[]).filter(H=>String(H.status||"")==="pending").reduce((H,$e)=>{const Q=Number($e.paidAmount||0)+(Array.isArray($e.partialPayments)?$e.partialPayments:[]).reduce((ee,se)=>ee+Number(se.amount||0),0);return H+Math.max(0,Number($e.amount||0)-Q)},0)}catch{}let A="";try{const k=O||(j==null?void 0:j.shopId)||null,H=k?Ue(Ne(J,"deficiencies"),ie("shopId","==",k)):Ue(Ne(J,"deficiencies"),ie("userId","==",(s==null?void 0:s.uid)||""));A=(await Qe(H)).docs.map(se=>se.data()).filter(se=>String(se.status||"pending")==="pending").slice(0,10).map((se,hs)=>`${hs+1}- ${String(se.name||se.productName||"عنصر")} × ${Number(se.quantity||se.qty||0)}`).join(`
`)}catch{}return[`تقرير يومي - ${a}`,`عدد العمليات: ${m}`,`إجمالي المسحوبات: ${u} جنيه`,`إجمالي الإرسال: ${g} جنيه`,`الأرباح: ${S} جنيه`,`إجمالي مبيعات الاكسسوار: ${x} جنيه`,`إجمالي الديون: ${f} جنيه`,"نواقص الاكسسوار:",A||"لا توجد عناصر مسجلة"].join(`
`)}const Lo=Ye.useCallback(()=>{let t=$o;const a=Ol.trim();if(a&&(t=t.filter(r=>{const l=r;return String(l.type||"").toLowerCase()==="cash_addition"||String(l.txnType||"").toLowerCase()==="cash_addition"||String(l.title||"").includes("إيصال إضافة نقدية")?!0:r.senderPhone&&r.senderPhone.includes(a)||r.receiverPhone&&r.receiverPhone.includes(a)})),gn){const r=new Date(gn);t=t.filter(l=>{const o=new Date(l.createdAt);if(fn){const[m,u]=fn.split(":"),g=new Date(r);g.setHours(parseInt(m),parseInt(u),0,0);const S=new Date(g);return S.setHours(S.getHours()+1),o>=g&&o<S}else return o.toDateString()===r.toDateString()})}try{t=[...t].sort((r,l)=>{const o=new Date(r.createdAt||0).getTime();return new Date(l.createdAt||0).getTime()-o})}catch{}return t},[$o,Ol,gn,fn]),[Tm,Jn]=n.useState(!1),[Wo,Kn]=n.useState(""),[Pm,Yn]=n.useState(!1),[al,rl]=n.useState(""),[km,Xe]=n.useState(!1),Br=async(t,a=2,r=700)=>{let l;for(let o=0;o<=a;o++)try{return await t()}catch(m){if(l=m,o===a)break;await new Promise(u=>setTimeout(u,r*Math.pow(2,o)))}throw l};qe.reduce((t,a)=>t+(at[a.id]||0),0);const _m=async t=>await ws.verifyMasterPin(t,s==null?void 0:s.uid),Hn=async t=>await ws.verifyMasterPin(t,s==null?void 0:s.uid);n.useEffect(()=>{if(s!=null&&s.uid){try{const t=Cs(),a=`walletBalances_${s.uid}`,r=localStorage.getItem(t)??localStorage.getItem(a);if(r){const l=JSON.parse(r);ns(l&&typeof l=="object"?l:{});try{localStorage.setItem(t,JSON.stringify(l||{}))}catch{}}}catch{}try{const t=Os(),a=`cashBalance_${s.uid}`,r=`userCashBalance_${s.uid}`;let l=localStorage.getItem(t)??localStorage.getItem(a)??localStorage.getItem(r);if(l!=null){const o=parseFloat(l);Ht(Number.isFinite(o)?o:0);try{localStorage.setItem(t,String(Number.isFinite(o)?o:0)),localStorage.removeItem(a),localStorage.removeItem(r)}catch{}}}catch{}}},[s==null?void 0:s.uid,O,j==null?void 0:j.shopId]),n.useEffect(()=>{const t=a=>{var r;try{const l=Number((r=a==null?void 0:a.detail)==null?void 0:r.value);if(Number.isFinite(l))Ht(l);else{const o=localStorage.getItem(Os());o!=null&&Ht(parseFloat(o)||0)}}catch{const l=localStorage.getItem(Os());l!=null&&Ht(parseFloat(l)||0)}};return window.addEventListener("cashBalanceChanged",t),()=>window.removeEventListener("cashBalanceChanged",t)},[s==null?void 0:s.uid,O,j==null?void 0:j.shopId]),n.useEffect(()=>{try{if(!(s!=null&&s.uid))return;const t=O||(j==null?void 0:j.shopId);if(!t)return;const a=Je(J,"dashboardData",t);let r=null;return r=Ls(a,l=>{if(!l.exists())return;const o=l.data(),m=Number((o==null?void 0:o.cashBalance)||0),u=o!=null&&o.walletBalances&&typeof o.walletBalances=="object"?o.walletBalances:{};Ht(m),ns(u);try{localStorage.setItem(Os(),String(m)),localStorage.setItem(Cs(),JSON.stringify(u))}catch{}},l=>{console.warn("dashboardData subscription error:",l)}),()=>{try{r&&r()}catch{}}}catch{}},[s==null?void 0:s.uid,O,j==null?void 0:j.shopId]);const Fo=t=>`walletLimits_${(s==null?void 0:s.uid)||"default"}_${t||"none"}`;n.useEffect(()=>{if(!D)return;try{const r=Fo(D),l=localStorage.getItem(r);if(l){const o=JSON.parse(l);Ri(o)}}catch{}const t=Je(J,"walletLimits",String(D));let a=null;try{a=Ls(t,r=>{if(!r.exists())return;const l=r.data(),o={walletId:D,dailyTransferLimit:l.dailyTransferLimit??6e4,dailyWithdrawLimit:l.dailyWithdrawLimit??1e5,dailyTransferUsed:l.dailyTransferUsed??0,dailyWithdrawUsed:l.dailyWithdrawUsed??0,monthlyTransferLimit:l.monthlyTransferLimit??2e5,monthlyWithdrawLimit:l.monthlyWithdrawLimit??2e5,monthlyTransferUsed:l.monthlyTransferUsed??0,monthlyWithdrawUsed:l.monthlyWithdrawUsed??0};Ri(o);try{localStorage.setItem(Fo(D),JSON.stringify(o))}catch{}})}catch{}return()=>{a&&a()}},[D]),n.useEffect(()=>{if(!D)return;const t=qe.find(a=>a.id===D);if(t!=null&&t.name){uo(String(t.name));try{localStorage.setItem(`walletName_${(s==null?void 0:s.uid)||"default"}_${D}`,String(t.name))}catch{}return}try{const a=localStorage.getItem(`walletName_${(s==null?void 0:s.uid)||"default"}_${D}`);a&&uo(String(a))}catch{}},[D,qe]);const nl=async()=>{try{if(!D)return;const t=await Gs.autoResetLimitsIfNeeded(D);Ri(t)}catch(t){console.error("خطأ في جلب حدود المحفظة المختارة:",t)}};n.useEffect(()=>{nl()},[D]),n.useEffect(()=>{const t=a=>{var r;(r=a==null?void 0:a.detail)!=null&&r.walletId&&a.detail.walletId===D&&nl()};return window.addEventListener("walletLimitsUpdated",t),()=>window.removeEventListener("walletLimitsUpdated",t)},[D]),n.useEffect(()=>{if(C.state){if(console.log("Location state:",C.state),C.state.openDebtDialog&&(Ti(),window.history.replaceState({},document.title)),C.state.openSalesDialog&&(Dt||Bt?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ir(!0),window.history.replaceState({},document.title)),C.state.openMaintenanceDialog&&(Dt||Bt?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):vn(!0),window.history.replaceState({},document.title)),C.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),Dt||Bt?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):bn(!0),window.history.replaceState({},document.title)),C.state.openShopExpensesDialog&&(Dt||Bt?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ws.hasMasterPin()?Ws(!0):Rt(!0),window.history.replaceState({},document.title)),C.state.openDeficienciesDialog&&(Dt||Bt?i({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ca(!0),window.history.replaceState({},document.title)),C.state.openInstallment&&(Dt||Bt?i({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"}):yn(!0),window.history.replaceState({},document.title)),C.state.openTransactionSection){const t=document.getElementById("transaction-section");t&&t.scrollIntoView({behavior:"smooth"}),C.state.transactionType&&Nl(C.state.transactionType),C.state.startNewTransaction&&(lr(""),Ja(""),oi(""),ci(""),console.log("🔒 Starting new transaction without changing wallet selection")),C.state.focusWalletSelection&&setTimeout(()=>{const a=document.querySelector('[data-testid="wallet-select"]');a&&a.focus()},500),window.history.replaceState({},document.title)}C.state.openCashierShiftModal&&(!oa||Bt?i({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):ae(!0),window.history.replaceState({},document.title)),C.state.openMachineDailyDialog&&(!oa||Bt?i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):wn(!0),window.history.replaceState({},document.title))}},[C.state,qe,Bt]),n.useEffect(()=>{C.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),Ur(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",C.pathname)},[C.pathname,s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;console.log("🔥 Setting up real-time user activation listener for:",s.uid);const t=Je(J,"users",s.uid),a=Ls(t,r=>{if(r.exists()){const l=r.data(),o=l.isActive===!0;console.log("🔥 Real-time user status update:",{userId:s.uid,isActive:o,subscription:l.subscription}),o&&!vt?(console.log("🎉 User activated! Redirecting to dashboard..."),Ze(!0),Ys(!1),Lt(!1)):!o&&vt&&(console.log("❌ User deactivated! Showing activation modal..."),Ze(!1),Ys(!0))}},r=>{console.error("❌ Error in real-time user listener:",r)});return()=>{console.log("🔥 Cleaning up real-time user listener"),a()}},[s==null?void 0:s.uid,vt]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;const t=r=>{const{userId:l}=r.detail;l===s.uid&&(console.log("🎉 Subscription activation event received for current user!"),Ze(!0),Ys(!1),Lt(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},a=r=>{const{userId:l,isActive:o}=r.detail;l===s.uid&&(console.log("🔄 User subscription update event received:",{userId:l,isActive:o}),o&&!vt&&(Ze(!0),Ys(!1),Lt(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",t),window.addEventListener("userSubscriptionUpdated",a),()=>{window.removeEventListener("subscriptionActivated",t),window.removeEventListener("userSubscriptionUpdated",a)}},[s==null?void 0:s.uid,vt]),n.useEffect(()=>{const t=a=>{var m;const r=a.target,l=(m=r==null?void 0:r.tagName)==null?void 0:m.toLowerCase();if(!(l==="input"||l==="textarea"||l==="select"||((r==null?void 0:r.isContentEditable)??!1))&&!(a.ctrlKey||a.altKey||a.metaKey)&&!a.repeat){if((Dt||Bt)&&a.key>="1"&&a.key<="9"){a.preventDefault();return}switch(a.key){case"1":break;case"2":gi(!0);break;case"3":Dt||Bt?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):bn(!0);break;case"4":oa?ae(!0):i({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"5":Dt||Bt?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ir(!0);break;case"6":Ti();break;case"7":Dt||Bt?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):vn(!0);break;case"8":oa?wn(!0):i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"9":Dt||Bt?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ws.hasMasterPin()?Ws(!0):Rt(!0);break}}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[Dt,Bt,oa]),n.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:s==null?void 0:s.uid,isCheckingActivation:Tt}),(async()=>{try{if(!(s!=null&&s.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),Lt(!1);return}try{const m=await va(Je(J,"users",s.uid));if(m.exists()){const g=m.data().isActive===!0,S=await Eh.checkTrialValidity(s.uid),x=S.isValid&&!S.isExpired;Ze(g||x),zt(x),qa(S.hoursRemaining),Cr(S.hasUsedTrial),Ys(!g&&!x),console.log("📊 حالة المستخدم:",{isActive:g,isOnTrial:x,hoursRemaining:S.hoursRemaining,hasUsedTrial:S.hasUsedTrial})}else Ze(!1),Ys(!0)}catch(m){console.error("خطأ في فحص حالة تفعيل المستخدم:",m),Ze(!1),Ys(!0)}finally{Lt(!1)}if(console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:s==null?void 0:s.uid}),s!=null&&s.uid){const m=await Br(()=>Se.getUserData(s.uid));if(m){const u=(m==null?void 0:m.walletBalances)||{};ns(u),(m==null?void 0:m.cashBalance)!==void 0&&Ht(m.cashBalance);try{const g=s!=null&&s.uid?await Br(()=>Qr.getDeletedTransactionsByUser(s.uid)):[];dr(g||[])}catch{dr([])}}else{ns({});try{const u=s!=null&&s.uid?await Qr.getDeletedTransactionsByUser(s.uid):[];dr(u||[])}catch{dr([])}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const m=await Br(()=>na.getByMerchantId((s==null?void 0:s.uid)||""));if(m&&m.length>0){console.log("✅ تم العثور على محافظ في Firebase:",m.length);const g=m.filter(f=>f.isActive===!0).map(f=>({id:f.id,name:f.label||"محفظة بدون اسم",phone:f.msisdn,isDefault:!1,monthlyWithdrawalLimit:f.monthlyWithdrawalLimit??f.withdrawLimit??2e5,monthlyTransferLimit:f.monthlyTransferLimit??f.transferLimit??2e5,defaultTransferCommission:f.defaultTransferCommission!=null?Number(f.defaultTransferCommission):null,defaultWithdrawCommission:f.defaultWithdrawCommission!=null?Number(f.defaultWithdrawCommission):null}));Ar(g);const S=localStorage.getItem($r());let x=null;S&&g.find(f=>f.id===S)?x=g.find(f=>f.id===S):x=g[0],x&&(bt(x.id),Va(x.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else console.log("⚠️ لا توجد محافظ في Firebase. سيتم عرض قائمة فارغة بدون أي استرجاع محلي."),Ar([])}catch(m){console.error("خطأ في تحميل المحافظ من Firebase:",m),Ar([])}const o=s!=null&&s.uid?await Br(()=>Se.getUserTransactions(s.uid)):[];if(o&&o.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",o.length);const m=o.map(f=>({...f,createdAt:new Date(f.createdAt),senderPhone:f.senderMsisdn||f.senderPhone||"",receiverPhone:f.receiverMsisdn||f.receiverPhone||"",type:f.txnType==="send"?"send":f.txnType==="receive"?"withdraw":f.type||"withdraw",status:f.status==="confirmed"?"completed":f.status||"completed"})),u=pn.map(f=>f.id||f.originalTransactionId);let g=[];try{const f=Ue(Ne(J,"deletedTransactions"),ie("userId","==",(s==null?void 0:s.uid)||""),ie("permanent","==",!0));g=(await Qe(f)).docs.map(P=>{const k=P.data();return String(k.originalTransactionId||k.transactionId||P.id||"")}).filter(Boolean)}catch{}const S=new Set(g),x=m.filter(f=>{var Q;const A=String(f.id||""),P=String(f.transactionId||""),k=String(f.reference||f.transactionReference||((Q=f.receipt)==null?void 0:Q.reference)||""),H=u.includes(A),$e=S.has(A)||P&&S.has(P);return!H&&!$e});console.log("✅ تم فلترة المعاملات المحذوفة:",{total:o.length,deleted:u.length,active:x.length});{const f=k=>{var H;return String((k==null?void 0:k.transactionId)||(k==null?void 0:k.id)||`${(k==null?void 0:k.transactionReference)||((H=k==null?void 0:k.receipt)==null?void 0:H.reference)||"ref"}-${new Date((k==null?void 0:k.createdAt)||0).getTime()}`)},A=new Set,P=[];for(const k of x){const H=f(k);A.has(H)||(A.add(H),P.push(k))}Al||ha(P)}}await Mo()}catch(o){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",o)}})().then(async()=>{await l(),await a(),await r()});const a=async()=>{try{if(!(s!=null&&s.uid))return;const o=await na.getByMerchantId(s.uid);await Promise.all(o.map(m=>tu.autoResetLimitsIfNeeded(m.id)))}catch(o){console.error("خطأ في التصفير التلقائي للحدود:",o)}},r=async()=>{try{await bs.syncReportsDataFromFirebase(s==null?void 0:s.uid);const o=bs.getReportsData(s==null?void 0:s.uid);if((o.lastDailyResetDate?bs.shouldResetDailyReports(o.lastDailyResetDate):!1)&&(s!=null&&s.uid)&&o.lastDailyResetDate){const g=new Date(o.lastDailyResetDate),S=g.toDateString(),x=Ge.filter(Q=>new Date(Q.createdAt).toDateString()===S&&Q.status==="completed"),f=x.length,A=x.reduce((Q,ee)=>Q+ee.amount,0),P=x.filter(zr).reduce((Q,ee)=>{const se=ee.withdrawnAmount!==void 0?ee.withdrawnAmount:ee.amount;return Q+se},0),k=x.filter(qr).reduce((Q,ee)=>{const se=ee.sentAmount!==void 0?ee.sentAmount:ee.amount;return Q+se},0),H=x.reduce((Q,ee)=>Q+bs.calculateTransactionProfit(ee),0),$e=new Date(g).toISOString().slice(0,10);await Yr.add({userId:s.uid,reportDate:$e,totalTransactions:f,totalAmount:Number(A.toFixed(2)),totalWithdrawn:Number(P.toFixed(2)),totalSent:Number(k.toFixed(2)),profit:Number(H.toFixed(2)),walletId:null})}const u=bs.autoResetReportsIfNeeded(s==null?void 0:s.uid);(u.dailyReset||u.monthlyReset)&&console.log("تم التصفير التلقائي:",u)}catch(o){console.error("خطأ في التصفير التلقائي للتقارير:",o)}},l=async()=>{try{if(!(s!=null&&s.uid))return;const o=new Date;if(o.getDate()!==1)return;const m=`${o.getFullYear()}-${o.getMonth()+1}`,u=`lastMonthlyDbCleanup:${s.uid}`;if(localStorage.getItem(u)===m)return;const S=new Date(o.getFullYear(),o.getMonth(),1,0,0,0,0),x=P=>P instanceof Date?P:typeof(P==null?void 0:P.toDate)=="function"?P.toDate():new Date(String(P));let f=[];try{const P=Ue(Ne(J,"userTransactions"),ie("userId","==",s.uid),ie("createdAt","<",S));f=(await Qe(P)).docs}catch{const P=Ue(Ne(J,"userTransactions"),ie("userId","==",s.uid));f=(await Qe(P)).docs.filter(H=>{var $e;return x(($e=H.data())==null?void 0:$e.createdAt)<S})}await Promise.allSettled(f.map(P=>As(P.ref)));let A=[];try{const P=Ue(Ne(J,"transactions"),ie("userId","==",s.uid),ie("createdAt","<",S));A=(await Qe(P)).docs}catch{const P=Ue(Ne(J,"transactions"),ie("userId","==",s.uid));A=(await Qe(P)).docs.filter(H=>{var $e;return x(($e=H.data())==null?void 0:$e.createdAt)<S})}await Promise.allSettled(A.map(P=>As(P.ref)));try{localStorage.setItem(u,m)}catch{}console.log("✅ تم تنظيف قاعدة البيانات شهريًا (Firebase فقط):",{userTransactionsDeleted:f.length,globalTransactionsDeleted:A.length,monthStart:S})}catch(o){console.error("فشل التنظيف الشهري التلقائي لقاعدة البيانات:",o)}};em(),Xd(),xm(),console.log("🔥 useEffect loadUserData completed")},[s==null?void 0:s.uid]);const Ur=async()=>{var t;if(s!=null&&s.uid)try{const a=await Br(()=>na.getByMerchantId(s.uid));if(a&&a.length>0){const l=a.filter(o=>o.isActive===!0).map(o=>({id:o.id,name:o.label||"محفظة بدون اسم",phone:o.msisdn,isDefault:!1,monthlyWithdrawalLimit:o.monthlyWithdrawalLimit??o.withdrawLimit??2e5,monthlyTransferLimit:o.monthlyTransferLimit??o.transferLimit??2e5,defaultTransferCommission:o.defaultTransferCommission!=null?Number(o.defaultTransferCommission):void 0,defaultWithdrawCommission:o.defaultWithdrawCommission!=null?Number(o.defaultWithdrawCommission):void 0}));if(Ar(l),s!=null&&s.uid){const o=localStorage.getItem($r());if(!!(D&&l.find(u=>u.id===D)))console.log("🔒 Preserving current wallet selection:",D);else{const g=(o&&l.find(S=>S.id===o)?o:null)||((t=l[0])==null?void 0:t.id);g&&(console.log("🔄 Fixing invalid wallet selection:",g),Gn(g))}}console.log("🔄 تم تحديث المحافظ من Firebase:",l.length)}}catch(a){console.error("خطأ في تحميل المحافظ من Firebase:",a)}};n.useEffect(()=>{const t=C.pathname;sessionStorage.getItem("previousPath")==="/user/add-wallet"&&t==="/user/dashboard"&&(console.log("🔄 Returning from add wallet page - reloading wallets"),console.log("🔒 Current wallet before add-wallet return reload:",D),Ur(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",t)},[C.pathname,s==null?void 0:s.uid]),n.useEffect(()=>{const t=()=>{console.log("🔄 Window focused - reloading wallets"),console.log("🔒 Current wallet before focus reload:",D),Ur().then(()=>{console.log("🔒 Wallet preserved after focus reload:",D)})};return window.addEventListener("focus",t),()=>{window.removeEventListener("focus",t)}},[s==null?void 0:s.uid,D,qe]);const Gn=async(t,a="unknown")=>{console.log(`🎯 setWalletSelection called from ${a} with walletId:`,t),console.log("🔍 Previous selectedWallet:",D),bt(t);const r=qe.find(l=>l.id===t);if(r&&(Va(r.phone),console.log("✅ Wallet set successfully:",t,"Phone:",r.phone)),s!=null&&s.uid){localStorage.setItem($r(),t),console.log("💾 Saved wallet to localStorage:",t);try{await Hr.set({key:"selected_wallet_id",value:t}),await Hr.set({key:"current_user_id",value:s.uid}),console.log("📱 Saved wallet and user ID to Capacitor Preferences:",t,s.uid)}catch(l){console.error("❌ Failed to save to Capacitor Preferences:",l)}}};n.useEffect(()=>{const t=()=>{Ur()};try{window.addEventListener("wallets:activation-updated",t)}catch{}return()=>{try{window.removeEventListener("wallets:activation-updated",t)}catch{}}},[s==null?void 0:s.uid]);const Om=t=>{if(t==="__add_wallet"){L("/user/add-wallet");return}if(t==="__view_wallets"){Ya(!0);return}$h.isEnabled(s==null?void 0:s.uid)?(cr(t),or(!0)):Gn(t,"walletSelectionNoPin")},Qn=t=>{console.log("🔄 handleTransactionTypeChange called with type:",t),console.log("🔍 Current selectedWallet before change:",D),console.log("🔍 Available wallets count:",qe.length),Nl(t),lr(""),Ja(""),oi(""),ci(""),console.log("✅ Transaction type changed to:",t,"- Wallet selection preserved:",D),setTimeout(()=>{const a=document.getElementById("transaction-section");a&&a.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)};n.useEffect(()=>{const t=a=>{const r=a.target;if(!!r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"||r.tagName==="SELECT"||r.isContentEditable)||(a.key==="ArrowLeft"?(a.preventDefault(),Qn("withdraw")):a.key==="ArrowRight"&&(a.preventDefault(),Qn("transfer"))),a.key==="Enter"){const o=re==="transfer"?"transferSubmitButton":"withdrawSubmitButton",m=document.getElementById(o);m&&!m.disabled&&(a.preventDefault(),m.click())}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[re]);const Ro=t=>{dd((r=>({id:r.id,type:r.type==="send"?"transfer":"withdraw",sender_msisdn:r.senderPhone,receiver_msisdn:r.receiverPhone,amount:r.amount,commission:r.commission||0,fee:(r==null?void 0:r.fee)??0,status:r.status==="failed"?"failed":r.status==="completed"?"completed":"pending",createdAt:new Date(r.createdAt).toISOString(),updatedAt:new Date(r.createdAt).toISOString(),shopName:G??(j==null?void 0:j.shopName)??(s==null?void 0:s.displayName)??"المحل",cashierName:(r==null?void 0:r.cashierName)??null,commissionMode:(r==null?void 0:r.commissionMode)??(r.type==="send"||wt?"add":"deduct"),totalCharged:(r==null?void 0:r.totalCharged)??(r.type==="send"?Number(r.amount||0)+Number(r.commission||0)+Number((r==null?void 0:r.fee)||0):wt?Number(r.amount||0)+Number(r.commission||0):Number(r.amount||0)),note:(r==null?void 0:r.note)??(r==null?void 0:r.notes)??void 0}))(t)),xn(!0)},Em=async t=>{var o;if(!(s!=null&&s.uid)){i({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const a=Ge.find(m=>m.id===t);if(!a){i({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}const r=String(t),l=String((a==null?void 0:a.transactionId)||(a==null?void 0:a.reference)||"");Ta.current.add(r),l&&Ta.current.add(l);try{console.log("🗑️ بدء عملية حذف المعاملة:",t),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:a.id,userId:s.uid,transactionData:a}),await Se.removeUserTransaction(s.uid,a.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await Qr.saveDeletedTransaction({...a,userId:s.uid,originalTransactionId:a.id,transactionId:a.transactionId||a.id,reference:a.reference||a.transactionReference||((o=a.receipt)==null?void 0:o.reference),deletedAt:new Date().toISOString(),permanent:!0}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(g){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",g)}try{await Qr.permanentlyDeleteTransaction(a.id,s.uid)}catch(g){console.warn("⚠️ فشل وسم الحذف النهائي أو التنظيف الإضافي:",g)}const m=[...pn,a],u=Ge.filter(g=>g.id!==t);dr(m),ha(u),Cl(!1),console.log("✅ تم تحديث الحالة بعد الحذف من Firebase (بدون نسخ محلية)");try{const g=a.fromWallet;if(g){const{walletDailyLimitsService:S}=await Nt(async()=>{const{walletDailyLimitsService:f}=await import("./walletDailyLimitsService-DdjjL_Zn.js");return{walletDailyLimitsService:f}},__vite__mapDeps([3,0,1]),import.meta.url),x=await S.getWalletLimits(g);if(x){const f=a.type==="send",A={updatedAt:(await Nt(async()=>{const{serverTimestamp:Q}=await import("./index-DKHjTn06.js").then(ee=>ee.bH);return{serverTimestamp:Q}},__vite__mapDeps([0,1]),import.meta.url)).serverTimestamp()};f?(A.dailyTransferUsed=Math.max(0,(x.dailyTransferUsed||0)-a.amount),A.monthlyTransferUsed=Math.max(0,(x.monthlyTransferUsed||0)-a.amount)):(A.dailyWithdrawUsed=Math.max(0,(x.dailyWithdrawUsed||0)-a.amount),A.monthlyWithdrawUsed=Math.max(0,(x.monthlyWithdrawUsed||0)-a.amount));const{doc:P,setDoc:k}=await Nt(async()=>{const{doc:Q,setDoc:ee}=await import("./index-DKHjTn06.js").then(se=>se.bH);return{doc:Q,setDoc:ee}},__vite__mapDeps([0,1]),import.meta.url),{db:H}=await Nt(async()=>{const{db:Q}=await import("./index-DKHjTn06.js").then(ee=>ee.bI);return{db:Q}},__vite__mapDeps([0,1]),import.meta.url),$e=P(H,"walletLimits",g);await k($e,A,{merge:!0})}}}catch(g){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",g)}try{const{ProfitService:g}=await Nt(async()=>{const{ProfitService:P}=await import("./profitService-DRDD-Fph.js");return{ProfitService:P}},__vite__mapDeps([4,0,1]),import.meta.url),{ReportsService:S}=await Nt(async()=>{const{ReportsService:P}=await import("./index-DKHjTn06.js").then(k=>k.bL);return{ReportsService:P}},__vite__mapDeps([0,1]),import.meta.url),f={txnType:a.type==="send"?"send":"receive",amount:a.amount,commission:a.commission||0,createdAt:a.createdAt,status:"confirmed"},A=g.calculateProfitFromTransaction(f);A>0&&g.addProfit(-A,s.uid);try{S.removeTransactionEffects(a,s.uid)}catch{}}catch(g){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",g)}i({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(m){console.error("❌ خطأ في حذف المعاملة من Firebase:",m);let u="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";m instanceof Error&&(m.message.includes("network")||m.message.includes("offline")?u="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":m.message.includes("permission")||m.message.includes("unauthorized")?u="ليس لديك صلاحية لحذف هذه المعاملة":m.message.includes("not-found")&&(u="المعاملة غير موجودة أو تم حذفها مسبقاً")),i({title:"خطأ في الحذف",description:u,variant:"destructive"})}},zr=t=>{const a=t.type,r=t.txnType;return a==="withdraw"||a==="withdrawal"||a==="receive"||r==="receive"},qr=t=>{const a=t.type,r=t.txnType;return a==="send"||a==="transfer"||r==="send"},Vr=(t,a)=>{const r=new Date().toDateString();let l=Ge.filter(x=>{const f=new Date(x.createdAt).toDateString()===r,A=String(x.status||"").toLowerCase();return f&&(A==="completed"||A==="confirmed"||A==="pending")});xa&&xa.trim()!==""&&(l=l.filter(x=>x.senderPhone&&x.senderPhone.includes(xa)||x.receiverPhone&&x.receiverPhone.includes(xa)));const o=bs.filterVisibleTransactions(l,"daily",s==null?void 0:s.uid),m=o.length,u=o.reduce((x,f)=>x+f.amount,0),g=o.filter(zr).reduce((x,f)=>{const A=f.withdrawnAmount!==void 0?f.withdrawnAmount:f.amount;return x+A},0),S=o.filter(qr).reduce((x,f)=>{const A=f.sentAmount!==void 0?f.sentAmount:f.amount;return x+A},0);return{totalTransactions:m,totalAmount:u,totalWithdrawn:g,totalSent:S}},Jr=t=>{const a=new Date().getMonth(),r=new Date().getFullYear();let l=Ge.filter(x=>{const f=new Date(x.createdAt);return f.getMonth()===a&&f.getFullYear()===r&&x.status==="completed"});xa&&xa.trim()!==""&&(l=l.filter(x=>x.senderPhone&&x.senderPhone.includes(xa)||x.receiverPhone&&x.receiverPhone.includes(xa)));const o=bs.filterVisibleTransactions(l,"monthly",s==null?void 0:s.uid),m=o.length,u=o.reduce((x,f)=>x+f.amount,0),g=o.filter(zr).reduce((x,f)=>{const A=f.withdrawnAmount!==void 0?f.withdrawnAmount:f.amount;return x+A},0),S=o.filter(qr).reduce((x,f)=>{const A=f.sentAmount!==void 0?f.sentAmount:f.amount;return x+A},0);return{totalTransactions:m,totalAmount:u,totalWithdrawn:g,totalSent:S}},Mm=t=>{const a=new Date().getMonth(),r=new Date().getFullYear(),l=Ge.filter(u=>{const g=new Date(u.createdAt);return g.getMonth()===a&&g.getFullYear()===r&&u.status==="completed"&&u.fromWallet===t}),o=l.filter(zr).reduce((u,g)=>{const S=g.withdrawnAmount||g.amount;return u+S},0),m=l.filter(qr).reduce((u,g)=>{const S=g.sentAmount||g.amount;return u+S},0);return{totalWithdrawn:o,totalTransferred:m}},$m=t=>{const a=new Date,r=a.getDate(),l=a.getMonth(),o=a.getFullYear(),m=Ge.filter(S=>{const x=new Date(S.createdAt);return x.getDate()===r&&x.getMonth()===l&&x.getFullYear()===o&&S.status==="completed"&&S.fromWallet===t}),u=m.filter(zr).reduce((S,x)=>{const f=x.withdrawnAmount||x.amount;return S+f},0),g=m.filter(qr).reduce((S,x)=>{const f=x.sentAmount||x.amount;return S+f},0);return{totalWithdrawn:u,totalTransferred:g}},Bo=Ye.useMemo(()=>Jr(),[Ge,D,xa]);Bo.totalWithdrawn,Bo.totalSent;const pa=Ye.useMemo(()=>Mm(D),[Ge,D]);n.useEffect(()=>{try{if(!D||qe.length===0)return;const t=qe.find(k=>k.id===D);if(!t)return;const a=(tt==null?void 0:tt.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,r=(tt==null?void 0:tt.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,l=parseFloat(Yt||"0")||0,o=(pa==null?void 0:pa.totalWithdrawn)??(tt==null?void 0:tt.monthlyWithdrawUsed)??0,m=(pa==null?void 0:pa.totalTransferred)??(tt==null?void 0:tt.monthlyTransferUsed)??0,u=o+(re==="withdraw"?l:0),g=m+(re==="transfer"?l:0),S=.85,x=Math.floor(Math.max(a,1)*S),f=Math.floor(Math.max(r,1)*S),A=(()=>{const k=new Date;return`${k.getFullYear()}-${String(k.getMonth()+1).padStart(2,"0")}`})(),P=`monthlyLimitWarnShown:${D}:${A}`;if(u>=x){const k=`${P}:withdraw`;if(!(localStorage.getItem(k)==="true")){wl({type:"withdraw",used:u,limit:a,walletName:t.name}),mn(!0);try{localStorage.setItem(k,"true")}catch{}return}}if(g>=f){const k=`${P}:transfer`;if(!(localStorage.getItem(k)==="true")){wl({type:"transfer",used:g,limit:r,walletName:t.name}),mn(!0);try{localStorage.setItem(k,"true")}catch{}return}}}catch{}},[D,qe,tt,pa,re,Yt]);const Uo=async()=>{var br,Oa,ga,Go;Eu(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:Ps,receiverPhone:gs,amount:Yt,transactionType:re});const t=()=>{re==="transfer"?mr(!0):Pr(!0)},a=()=>{re==="transfer"?mr(!1):Pr(!1)};if(t(),!Ps||!Yt){console.log("❌ خطأ: بيانات ناقصة"),i({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),a();return}if(re==="transfer"&&!gs&&!B){console.log("❌ خطأ: رقم المستقبل مفقود"),i({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),a();return}if(re==="transfer"&&!B&&!Mu(gs)){i({title:"رقم المستقبل غير صالح",description:"اكتب رقم صحيح مكون من 11 رقم ويبدأ بـ 015 أو 010 أو 012 أو 011",variant:"destructive"}),a();return}const r=parseFloat(Yt);if(console.log("💰 المبلغ المحول:",r),r<=0){console.log("❌ خطأ: مبلغ غير صحيح"),i({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),a();return}if(Dt)try{const Me=new Date,nt=Me.getFullYear(),It=String(Me.getMonth()+1).padStart(2,"0"),Xt=String(Me.getDate()).padStart(2,"0"),Ms=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${nt}-${It}-${Xt}`,Is=localStorage.getItem(Ms);if((Is&&parseInt(Is,10)||0)>=10){i({title:"حد التأكيد اليومي",description:"باقة زيرو تسمح بـ 10 تأكيدات تحويل/سحب يومياً فقط.",variant:"destructive"}),a();return}}catch(Me){console.warn("فشل قراءة عداد تأكيدات باقة زيرو من التخزين المحلي:",Me)}const l=qe.find(Me=>Me.id===D);if(!l){i({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),a();return}const o=pa;if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:D,walletName:l.name,currentWithdrawn:o.totalWithdrawn,currentTransferred:o.totalTransferred,withdrawalLimit:l.monthlyWithdrawalLimit,transferLimit:l.monthlyTransferLimit}),re==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${o.totalWithdrawn}, المبلغ الجديد: ${r}, الحد الأقصى: ${l.monthlyWithdrawalLimit}`),o.totalWithdrawn+r>l.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),i({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${l.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${o.totalTransferred}, المبلغ الجديد: ${r}, الحد الأقصى: ${l.monthlyTransferLimit}`),o.totalTransferred+r>l.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),i({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${l.monthlyTransferLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}const m=(j==null?void 0:j.shopName)||(s==null?void 0:s.displayName)||"محل كاشي لينك",u={id:Date.now().toString(),type:re==="transfer"?"send":re==="deposit"?"deposit":"withdraw",senderPhone:Ps,receiverPhone:re==="transfer"?gs:Ps,amount:r,status:"completed",createdAt:new Date,withdrawnAmount:re==="withdraw"?r:void 0,sentAmount:re==="transfer"?r:void 0,depositedAmount:void 0,fromWallet:D,senderNumber:Ps,senderName:Ps,shopName:(l==null?void 0:l.name)||"المحفظة الرئيسية",transferredAmount:re==="transfer"?r:void 0,receiverNumber:re==="transfer"?gs:void 0,withdrawnAmountDetailed:re==="withdraw"?r:void 0,depositedAmountDetailed:void 0,merchantShopName:m,transactionReference:`TXN-${Date.now()}`,commission:0,notes:re==="transfer"?void 0:c&&c.trim()!==""?c.trim():void 0};y&&(w!=null&&w.name||w!=null&&w.username)&&(u.cashierName=(w==null?void 0:w.name)||(w==null?void 0:w.username));const g=Sr.validateTransaction(r,re,Pt,at);if(!g.isValid){i({title:"خطأ في العملية",description:g.error,variant:"destructive"}),a();return}g.warning&&i({title:"تحذير",description:g.warning,variant:"destructive"});let S;if(re==="transfer")if((l==null?void 0:l.defaultTransferCommission)!=null){const Me=Number(l.defaultTransferCommission)||0;S=Math.round(Me*r/1e3*100)/100}else ds&&ds.trim()!==""?S=Math.max(0,parseFloat(ds)):S=0;else if((l==null?void 0:l.defaultWithdrawCommission)!=null){const Me=Number(l.defaultWithdrawCommission)||0;S=Math.round(Me*r/1e3*100)/100}else cs&&cs.trim()!==""?S=Math.max(0,parseFloat(cs)):S=Math.round(r*.01*100)/100;if(u.commission=S,re!=="transfer"&&!wt&&S>=r){i({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),a();return}const x=re==="transfer"||wt?r:Math.round((r-S)*100)/100;u.amount=x,u.withdrawnAmount=re==="withdraw"?x:void 0,u.sentAmount=re==="transfer"?x:void 0,u.transferredAmount=re==="transfer"?x:void 0,u.withdrawnAmountDetailed=re==="withdraw"?x:void 0;let f;const A=re==="transfer"&&!!Et,P=re==="withdraw"&&!!Et,k=A||P;let H=null;const $e=hn(Ps||"").replace(/\D/g,""),Q=hn(gs||"").replace(/\D/g,""),ee=re==="transfer"&&($e.startsWith("010")&&(Q.startsWith("011")||Q.startsWith("012")||Q.startsWith("015"))||$e.startsWith("012")&&Q.startsWith("010")||$e.startsWith("011")&&Q.startsWith("010")||$e.startsWith("015")&&Q.startsWith("010")),se=ee?Math.max(0,parseFloat(vl||"0")):0,hs=Math.round(S*100)/100;if(u.commission=hs,u.fee=se,u.totalCharged=re==="transfer"?Number(x)+Number(hs)+Number(se):wt?Number(x)+Number(hs):Number(x),ee&&!k&&se<=0){i({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"}),a();return}if(re==="transfer"&&!k){const Me=Number(at[D]||0),nt=Number(x)+Number(se);if(Me<nt){i({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${Me} لا يكفي لخصم ${nt}`,variant:"destructive"}),a();return}}if(k)if(A){const Me=Sr.validateTransaction(x,"transfer",Pt,at);if(!Me.isValid)f={success:!1,newCashBalance:Pt,newWalletBalances:at,message:Me.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"};else{const nt=D||((br=qe.find(it=>it.isDefault))==null?void 0:br.id)||((Oa=qe[0])==null?void 0:Oa.id),It=tt??await Gs.getWalletLimits(nt),Xt=new Date().toDateString(),Ms=Ge.filter(it=>it.type==="send"&&String(it.status||"").toLowerCase()==="pending"&&it.fromWallet===nt&&new Date(it.createdAt).toDateString()===Xt).reduce((it,ys)=>it+Number(ys.sentAmount??ys.transferredAmount??ys.amount??0),0),Is=Number((It==null?void 0:It.dailyTransferLimit)??6e4),Ks=Number((It==null?void 0:It.dailyTransferUsed)??0);if(Ks+Ms+Number(x)>Is){i({title:"تجاوز الحد اليومي للتحويل",description:`المتبقي اليوم: ${(Is-Ks-Ms).toLocaleString()} ج.م`,variant:"destructive"}),a();return}const aa=new Date,Ea=Ge.filter(it=>it.type==="send"&&String(it.status||"").toLowerCase()==="pending"&&it.fromWallet===nt&&new Date(it.createdAt).getMonth()===aa.getMonth()&&new Date(it.createdAt).getFullYear()===aa.getFullYear()).reduce((it,ys)=>it+Number(ys.sentAmount??ys.transferredAmount??ys.amount??0),0),fa=Number((It==null?void 0:It.monthlyTransferLimit)??2e5),vr=Number((It==null?void 0:It.monthlyTransferUsed)??0);if(vr+Ea+Number(x)>fa){i({title:"تجاوز الحد الشهري للتحويل",description:`المتبقي هذا الشهر: ${(fa-vr-Ea).toLocaleString()} ج.م`,variant:"destructive"}),a();return}f={success:!0,newCashBalance:Pt,newWalletBalances:at}}}else{const Me=D||((ga=qe.find(it=>it.isDefault))==null?void 0:ga.id)||((Go=qe[0])==null?void 0:Go.id),nt=tt??await Gs.getWalletLimits(Me),It=new Date().toDateString(),Xt=Ge.filter(it=>it.type==="withdraw"&&String(it.status||"").toLowerCase()==="pending"&&it.fromWallet===Me&&new Date(it.createdAt).toDateString()===It).reduce((it,ys)=>it+Number(ys.withdrawnAmount??ys.amount??0),0),Ms=Number((nt==null?void 0:nt.dailyWithdrawLimit)??1e5),Is=Number((nt==null?void 0:nt.dailyWithdrawUsed)??0);if(Is+Xt+Number(x)>Ms){i({title:"تجاوز الحد اليومي للسحب",description:`المتبقي اليوم: ${(Ms-Is-Xt).toLocaleString()} ج.م`,variant:"destructive"}),a();return}const Ks=new Date,aa=Ge.filter(it=>it.type==="withdraw"&&String(it.status||"").toLowerCase()==="pending"&&it.fromWallet===Me&&new Date(it.createdAt).getMonth()===Ks.getMonth()&&new Date(it.createdAt).getFullYear()===Ks.getFullYear()).reduce((it,ys)=>it+Number(ys.withdrawnAmount??ys.amount??0),0),Ea=Number((nt==null?void 0:nt.monthlyWithdrawLimit)??2e5),fa=Number((nt==null?void 0:nt.monthlyWithdrawUsed)??0);if(fa+aa+Number(x)>Ea){i({title:"تجاوز الحد الشهري للسحب",description:`المتبقي هذا الشهر: ${(Ea-fa-aa).toLocaleString()} ج.م`,variant:"destructive"}),a();return}f={success:!0,newCashBalance:Math.round((Number(Pt)-Number(x))*100)/100,newWalletBalances:at}}else re==="transfer"?f=await Sr.processTransfer({amount:x,currentCashBalance:Pt,currentWalletBalances:at,wallets:qe,selectedWalletId:D,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0}):f=await Sr.processWithdraw({amount:x,currentCashBalance:Pt,currentWalletBalances:at,wallets:qe,selectedWalletId:D,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0});if(!f.success){i({title:"فشل في العملية",description:f.error||f.message,variant:"destructive"}),a();return}let Vs=k?P?f.newCashBalance:Pt:f.newCashBalance,Js=k?at:f.newWalletBalances;if(!k&&re==="transfer"&&se>0){const Me=Number(Js[D]||0);Js={...Js,[D]:Math.round((Me-Number(se))*100)/100}}if(k&&A){const Me=qe.find(Xt=>Xt.id===D)??qe.find(Xt=>Xt.isDefault)??qe[0],nt=(Me==null?void 0:Me.id)||D;if(nt!==D)try{Gn(nt)}catch{}const It=Number(at[nt]||0);Js={...at,[nt]:Math.round((It-Number(x)-Number(se))*100)/100}}if((A||P)&&Et&&!sa){const Me={id:`DEBT-${Date.now()}`,debtorName:Et.debtorName,amount:Et.amount,reason:Et.notes||"",customerId:Et.customerId,mobile:Et.mobile,status:"pending",createdAt:new Date};H=Me.id;const nt=[Me,...St];ms(nt);try{await qs(nt)}catch(It){console.error("⚠️ فشل حفظ الدين المؤجل محلياً:",It)}i({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}if(!k){const Me=Math.max(0,Number(S))+Math.max(0,Number(se));Me>0&&(Vs=Math.round((Vs+Me)*100)/100,console.log(`💰 تم إضافة عمولة/رسوم ${Me} جنيه لدرج النقدية`))}console.log("⚡ تحديث الواجهة فوراً بدون حجب باستخدام startTransition...");const yr=[u,...Ge];Ye.startTransition(()=>{Ht(Vs),ns(Js),k&&(u.status="pending"),ha(yr)});try{setTimeout(()=>{try{localStorage.setItem(Qi(),JSON.stringify(yr))}catch{}},0)}catch{}if(Dt)try{const Me=new Date,nt=Me.getFullYear(),It=String(Me.getMonth()+1).padStart(2,"0"),Xt=String(Me.getDate()).padStart(2,"0"),Ms=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${nt}-${It}-${Xt}`,Is=localStorage.getItem(Ms),Ks=Is&&parseInt(Is,10)||0;localStorage.setItem(Ms,String(Ks+1))}catch{}setTimeout(()=>{try{localStorage.setItem(Os(),Vs.toString()),localStorage.setItem(Cs(),JSON.stringify(Js))}catch{}},0);try{if(s!=null&&s.uid){const Me=qe.find(wr=>wr.id===D)??qe.find(wr=>wr.isDefault)??qe[0],nt=(Me==null?void 0:Me.id)||D,It=Number(Js[nt]||0),Xt=String((Me==null?void 0:Me.phone)||Ps||"").trim(),Ms=String(gs||"").trim(),Is=Number(se)>0,Ks=re==="transfer"?"🟢":"🔴",aa=Number(hs)>0?`${Number(hs)} جنيه`:"0 جنيه",Ea=Is?` و رسوم ${Number(se)} جنيه`:"",fa=re==="transfer"?`${Ks} تم تحويل مبلغ ${Number(x)} جنيه من رقم المحفظة ${Xt} إلى رقم المحفظة ${Ms} وتم أخذ عمولة ${aa}${Ea}. الرصيد المتبقي في المحفظة: ${It} جنيه. الفلوس النقدية المتبقية: ${Number(Vs)} جنيه.`:`${Ks} تم السحب مبلغ ${Number(x)} جنيه من الدرج إلى رقم المحفظة ${Xt} وتم أخذ عمولة ${aa}${Ea}. الرصيد المتبقي في المحفظة: ${It} جنيه. الفلوس النقدية المتبقية: ${Number(Vs)} جنيه.`,vr=s!=null&&s.uid?`tg_last_msg_${s.uid}`:"tg_last_msg",it=Date.now();let ys=!0;try{const wr=localStorage.getItem(vr);if(wr){const Nr=JSON.parse(wr),Vm=String((Nr==null?void 0:Nr.text)||""),Jm=Number((Nr==null?void 0:Nr.at)||0);Vm===fa&&it-Jm<5e3&&(ys=!1)}}catch{}if(ys){await sr.send(s.uid,fa);try{localStorage.setItem(vr,JSON.stringify({text:fa,at:it}))}catch{}}}}catch{}if((async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const Me={shopId:O||(j==null?void 0:j.shopId)||(s==null?void 0:s.uid)||"default-shop",lineId:D||"default-line",walletId:D||void 0,merchantUserId:(s==null?void 0:s.uid)||null,provider:"vodafone_cash",txnType:re==="transfer"?"send":"receive",originType:re==="transfer"?"transfer":"withdraw",amount:x,commission:hs,fee:se,profit:0,senderMsisdn:Ps,receiverMsisdn:re==="transfer"?gs:Ps,note:re==="transfer"?void 0:c&&c.trim()!==""?c.trim():void 0,status:k?"pending":"confirmed",linkedDebtId:H||void 0,createdBy:(s==null?void 0:s.uid)||null,walletEffectAppliedOnCreation:!1,cashEffectAppliedOnCreation:!!(k&&P),limitsReservedOnCreation:!!k,limitReservedType:re==="transfer"?"transfer":"withdraw"},nt={...Me,status:k?"pending":"completed",commissionMode:re==="transfer"||wt?"add":"deduct",totalCharged:re==="transfer"?x+hs+se:wt?x+S:x,walletEffectAppliedOnCreation:!1,cashEffectAppliedOnCreation:!!(k&&P),limitsReservedOnCreation:!!k,limitReservedType:re==="transfer"?"transfer":"withdraw",sentAmount:re==="transfer"?x:void 0,transferredAmount:re==="transfer"?x:void 0,withdrawnAmount:re==="withdraw"?x:void 0,createdAt:new Date},{ProfitService:It}=await Nt(async()=>{const{ProfitService:aa}=await import("./profitService-DRDD-Fph.js");return{ProfitService:aa}},__vite__mapDeps([4,0,1]),import.meta.url),Xt=It.calculateProfitFromTransaction(nt);!k&&Xt>0&&(It.addProfit(Xt,s==null?void 0:s.uid),console.log("✅ تم إضافة الربح:",Xt,"جنيه"));const Ms=await ii.create(Me);if(D)try{await Gs.updateUsage(D,x,re==="transfer"?"transfer":"withdraw");try{window.dispatchEvent(new CustomEvent("walletLimitsUpdated",{detail:{walletId:D}}))}catch{}try{await nl()}catch{}}catch{}await Promise.all([...s!=null&&s.uid?[Se.updateUserData(s.uid,{cashBalance:Vs,walletBalances:Js,lastUpdated:new Date().toISOString()})]:[],...s!=null&&s.uid?[Se.saveUserTransaction(s.uid,{...nt,transactionType:re,fromWallet:D,toWallet:re==="transfer"?A?null:"cash":null,cashierName:y&&((w==null?void 0:w.name)||(w==null?void 0:w.username))||"الحساب الرئيسي",linkedDebtId:H||void 0,transactionId:Ms,description:`${re==="transfer"?"تحويل":"سحب"} ${x} من ${D} ${re==="transfer"?A?"":"إلى الدرج النقدي":""} — عمولة: ${S} (${re==="transfer"||wt?"مضافة":"مخصومة"})${se>0?` — رسوم: ${se}`:""}${k?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");const Is=`userData_${s==null?void 0:s.uid}`,Ks={cashBalance:Vs,walletBalances:Js,lastUpdated:new Date().toISOString()};localStorage.setItem(Is,JSON.stringify(Ks))}catch(Me){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",Me);try{s!=null&&s.uid&&Se.saveLocalReceipt(s.uid,{...transactionDataForUser,transactionType:re,fromWallet:D,toWallet:re==="transfer"?A?null:"cash":null,cashierName:y&&((w==null?void 0:w.name)||(w==null?void 0:w.username))||"الحساب الرئيسي",linkedDebtId:H||void 0,description:`${re==="transfer"?"تحويل":"سحب"} ${x} من ${D} ${re==="transfer"?A?"":"إلى الدرج النقدي":""} — عمولة: ${S} (${re==="transfer"||wt?"مضافة":"مخصومة"})${se>0?` — رسوم: ${se}`:""}${k?" — دين مؤجل (قيد المراجعة)":""}`})}catch{}i({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),re==="transfer"){mr(!0);const Me=Number(r)+Number(S)+Math.max(0,Number(se));pi({type:"transfer",amount:Math.max(0,Math.round(Me*100)/100)}),yd({receiver:gs,amount:r}),Ha(!0),setTimeout(()=>{mr(!1)},2e3)}else{Pr(!0);const Me=wt?Number(r):Math.max(0,Math.round((Number(r)-Number(S))*100)/100);pi({type:"withdraw",amount:Math.max(0,Math.round(Me*100)/100)}),Ha(!0),setTimeout(()=>{Pr(!1)},2e3)}lr(""),Ja(""),T(""),Bs(null),Ce(""),_e(""),Be(""),Ia(!1)},Zn=Ye.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),zo=Ye.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),Lm=Ye.useMemo(()=>{try{return St.reduce((t,a)=>{const r=Number(a.paidAmount||0),l=Math.max(0,Number(a.amount||0)-r);return t+l},0)}catch{return 0}},[St]),il=Ye.useMemo(()=>Lo().filter(a=>ua==="all"?!0:ua==="send"?a.type==="send":ua==="receive"?a.type==="receive":ua==="withdraw"?a.type==="withdraw":ua!=="deleted"),[Lo,ua]),Wm=()=>{if(ui==="daily"){const t=bs.resetReportsManually("daily",Ge,s==null?void 0:s.uid);Tr(!1),i({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${t.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const t=bs.resetReportsManually("monthly",Ge,s==null?void 0:s.uid);Tr(!1),i({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${t.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},Fm=()=>ui==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",Rm=()=>ui==="daily"?"أدخل الرقم السري الرئيسي لتصفير جميع معاملات اليوم":"أدخل الرقم السري الرئيسي لتصفير جميع معاملات الشهر",Bm=t=>{Ao(t),Ui(!0)},Um=t=>{const a=Pt,r=Number(t)-Number(a);Ht(t),localStorage.setItem(Os(),t.toString()),xo(!1);const l={cashBalance:t,lastUpdated:new Date().toISOString()},o=`userData_${s==null?void 0:s.uid}`;try{localStorage.setItem(o,JSON.stringify(l))}catch{}const m=[];if(s!=null&&s.uid){m.push(Se.updateUserData(s.uid,l).then(()=>{try{localStorage.removeItem(o)}catch{}}).catch(()=>{}));const u=`${r>0?"CASHADD":"CASHDEDUCT"}-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`,g=r>0?{txnType:"cash_addition",type:"cash_addition",amount:r,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:u,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(j==null?void 0:j.shopId)||void 0}:r<0?{amount:Math.abs(r),status:"completed",title:"ايصال خصم من الفلوس النقديه",merchantUserId:s.uid,createdBy:s.uid,shopId:(j==null?void 0:j.shopId)||void 0}:null;g&&m.push(Se.saveUserTransaction(s.uid,g));const S=j==null?void 0:j.shopId;if(S){const x=Je(J,"dashboardData",S);m.push(Zt(x,{cashBalance:t}))}}Promise.allSettled(m).then(()=>{}).catch(()=>{}),i({title:r>0?"تم إضافة نقدية":r<0?"تم خصم نقدية":"تم تحديث الرصيد النقدي",description:r!==0?`التغيير: ${Math.abs(r)} جنيه، الرصيد الجديد: ${t} جنيه`:`تم تحديث الرصيد النقدي إلى ${t} جنيه`})},zm=async t=>{var u;if(!Es){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const a={...at,[Es]:t};ns(a);const r=new Date().toISOString(),l={walletBalances:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;try{localStorage.setItem(o,JSON.stringify(l)),localStorage.setItem(Cs(),JSON.stringify(a)),localStorage.setItem(`walletBalances_backup_${r}`,JSON.stringify(a))}catch{}try{s!=null&&s.uid&&await Se.updateUserData(s.uid,l)}catch(g){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",g)}po(!1);const m=((u=qe.find(g=>g.id===Es))==null?void 0:u.name)||"المحفظة";i({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${m} إلى ${t.toLocaleString()} جنيه`})},qm=async t=>{var a;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",Es),console.log("💵 المبلغ المضاف/المخصوم:",t),Es){const r=at[Es]||0;console.log("💰 الرصيد الحالي:",r);const l=r+t;console.log("💰 الرصيد الجديد:",l);const o={...at,[Es]:l};console.log("📊 الأرصدة المحدثة:",o),ns(o);const m=new Date().toISOString(),u={walletBalances:o,lastUpdated:m},g=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(g,JSON.stringify(u)),localStorage.setItem(Cs(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${m}`,JSON.stringify(o));try{if(s!=null&&s.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await Se.updateUserData(s.uid,u),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(g),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(A){console.error("❌ فشل في حفظ البيانات في Firebase:",A),Xe(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(Cs(),JSON.stringify(o));const S=((a=qe.find(A=>A.id===Es))==null?void 0:a.name)||"المحفظة",x=t>0?"إضافة":"خصم",f=Math.abs(t);i({title:`تم ${x} مبلغ ${x==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${x} ${f} جنيه ${x==="إضافة"?"إلى":"من"} رصيد ${S}. الرصيد الجديد: ${l.toLocaleString()} جنيه`})}catch(S){if(console.error("❌ فشل في حفظ البيانات في Firebase:",S),localStorage.setItem(Cs(),JSON.stringify(o)),s!=null&&s.uid){const x=`userData_${s.uid}`,f={walletBalances:o,lastUpdated:new Date().toISOString()};localStorage.setItem(x,JSON.stringify(f)),Xe(!0)}i({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const l=Object.keys(localStorage).filter(o=>o.startsWith("walletBalances_backup_")).sort();l.length>5&&l.slice(0,l.length-5).forEach(m=>{localStorage.removeItem(m),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",m)})},5e3),Ui(!1),Ao("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:Tt,isUserActive:vt,showActivationModal:ia}),Tt?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx(mh,{})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"user-dashboard min-h-screen px-2 sm:px-4 py-2 sm:py-4 relative bg-gray-50 bg-[radial-gradient(140%_140%_at_10%_10%,#f3f4f6_0%,#e5e7eb_45%,#d1d5db_100%)]",children:[e.jsx($u,{userId:s==null?void 0:s.uid}),e.jsxs("div",{className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!kr&&e.jsxs($t,{className:"monthly-stats-card bg-gradient-to-br from-purple-50 via-purple-25 to-white border border-purple-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-500/5 to-purple-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-purple-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(ls,{className:"monthly-stats-header pb-2 sm:pb-1 lg:pb-1 px-3 sm:px-3 lg:px-2 pt-3 sm:pt-2 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ts,{className:"text-xs font-bold text-purple-800 flex items-center gap-1.5 sm:gap-1",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-2 h-2.5 sm:h-2 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-2 h-2.5 sm:h-2 bg-purple-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1",children:[e.jsx("div",{className:"hidden"}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>{Il("monthly"),Tr(!0)},className:"monthly-stat-action h-7 w-7 sm:h-6 sm:w-6 p-0 bg-white/60 backdrop-blur-md border border-white/50 text-purple-700 hover:bg-white hover:text-purple-900 rounded-xl transition-all duration-300 hover:scale-110 shadow-[0_8px_16px_-6px_rgba(124,58,237,0.35)] ring-1 ring-purple-200",title:"تصفير معاملات الشهر",children:e.jsx(is,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5"})}),e.jsx("div",{className:"monthly-stat-action p-1.5 sm:p-1 bg-gradient-to-br from-purple-500/20 to-pink-500/20 border border-white/50 backdrop-blur-md rounded-xl shadow-[0_8px_16px_-6px_rgba(236,72,153,0.35)]",children:e.jsx(Gr,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5 text-purple-700"})})]})]})}),!kr&&e.jsxs(Wt,{className:"space-y-0.5 sm:space-y-1 lg:space-y-0 pt-0 px-2 sm:px-3 lg:px-2 pb-1.5 sm:pb-2 lg:pb-1 relative z-10",children:[e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Jr().totalTransactions})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Jr().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"المسحوب:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Jr().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"المرسل:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Jr().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"الأرباح:"}),e.jsx(Su,{userId:s==null?void 0:s.uid,transactions:Ge})]})]}),Id&&e.jsx("div",{className:"monthly-overlay absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:async()=>{if(Dt){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}Nn(!0)},className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-black hover:from-yellow-600 hover:to-yellow-700 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(Ft,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(xs,{open:Td,onOpenChange:Nn,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(Dt){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),Nn(!1),Bl(!0);return}Bl(!1),Nn(!1)},userId:s==null?void 0:s.uid}),((qo=Fe==null?void 0:Fe.subscription)==null?void 0:qo.planType)!==$s.TAHWEELA&&e.jsxs($t,{className:"daily-stats-card bg-gradient-to-br from-blue-50 via-blue-25 to-white border border-blue-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 to-blue-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-blue-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(ls,{className:"daily-stats-header pb-2 sm:pb-3 lg:pb-1 px-3 sm:px-4 lg:px-2 pt-3 sm:pt-4 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ts,{className:"text-sm sm:text-base font-bold text-blue-800 flex items-center gap-1.5 sm:gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-3 h-2.5 sm:h-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-3 h-2.5 sm:h-3 bg-blue-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs sm:text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5",children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>{Il("daily"),Tr(!0)},className:"daily-stat-action h-7 w-7 sm:h-8 sm:w-8 p-0 bg-white/60 backdrop-blur-md border border-white/50 text-blue-700 hover:bg-white hover:text-blue-900 rounded-xl transition-all duration-300 hover:scale-110 shadow-[0_8px_16px_-6px_rgba(59,130,246,0.35)] ring-1 ring-blue-200",title:"تصفير معاملات اليوم",children:e.jsx(is,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>Ad(t=>!t),className:"daily-stat-action h-7 w-7 sm:h-8 sm:w-8 p-0 bg-white/60 backdrop-blur-md border border-white/50 text-blue-700 hover:bg-white hover:text-blue-900 rounded-xl transition-all duration-300 hover:scale-110 shadow-[0_8px_16px_-6px_rgba(59,130,246,0.35)] ring-1 ring-blue-200",title:kr?"توسيع اليوم والشهر":"طي اليوم والشهر",children:kr?e.jsx(sn,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"}):e.jsx(ei,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-br from-blue-500/20 to-emerald-500/20 border border-white/50 backdrop-blur-md rounded-xl shadow-[0_8px_16px_-6px_rgba(16,185,129,0.35)]",children:e.jsx(Gr,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-blue-700"})})]})]})}),!kr&&e.jsxs(Wt,{className:"space-y-0 pt-0 px-2 pb-1 relative z-10",children:[e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Vr().totalTransactions})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Vr().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"المسحوب:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Vr().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from_gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"المرسل:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Vr().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"الأرباح:"}),e.jsx(Iu,{userId:s==null?void 0:s.uid,transactions:Ge})]})]}),Ed&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:()=>yi(!0),className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير اليوم (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير اليوم"}),e.jsx(Ft,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(xs,{open:Md,onOpenChange:yi,mode:"verify",title:"الرقم السري لفتح تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{ql(!1),yi(!1)},userId:s==null?void 0:s.uid})]}),e.jsxs($t,{className:"balance-bar bg-white border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(Wt,{className:"p-3 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-emerald-50 border-2 border-emerald-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/cash relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx(qt,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-emerald-800",children:"الفلوس النقدية"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-emerald-700 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Pt.toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Lr(!0),children:e.jsx(vs,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Po(!0),title:"تفاصيل الفلوس النقدية",children:e.jsx(nc,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>Yn(!0),children:e.jsx(is,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/wallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(ca,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-blue-800",children:"الأرصدة علي المحافظ"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-blue-700 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Object.values(at).reduce((t,a)=>t+a,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>zn(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(vs,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{Jn(!0),Kn("")},title:"تصفير إجمالي المحفظة",children:e.jsx(is,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-indigo-50 border-2 border-indigo-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/selwallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(ca,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-indigo-800",children:"رصيد المحفظه"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-indigo-700 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm",children:[(D&&at[D]||0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>{if(!D){i({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}Bm(D)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(vs,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{if(!D){i({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}kn(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(is,{className:"h-2 w-2"})})]})]})]})]})})]}),e.jsxs($t,{className:"bg-gradient-to-br from-gray-50 via-white to-slate-50 border border-gray-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-500/5 to-slate-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsxs(ls,{className:`pb-2 px-4 pt-4 relative z-10 ${R?"sticky top-0 z-20 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/60":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ts,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[!R&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-gray-100 to-slate-200 rounded-lg",children:e.jsx(Gr,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-600"})}),e.jsx("span",{className:"bg-gradient-to-r from-gray-600 to-slate-600 bg-clip-text text-transparent",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!R&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(gh,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx(q,{placeholder:"بحث...",value:_l,onChange:t=>gd(t.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!R&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"تقسيط"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{if(Dt||Bt){i({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"});return}yn(!0)},title:"إدارة التقسيط",children:e.jsx(hh,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-green-600 mb-1",children:"شحن"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 ring-3 ring-green-300 transition-all duration-200 hover:scale-105 active:bg-green-600 active:text-white active:border-green-600",onClick:()=>{i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."})},title:"شحن الرصيد",children:e.jsx(rn,{className:"h-5 w-5 text-green-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>gi(!0),title:"آلة حاسبة",children:e.jsx(jc,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{Dt||Bt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):bn(!0)},title:"كروت الائتمان",children:e.jsx(rn,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"تقاريرك"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:()=>{if(Dt||Bt){i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"});return}No(!0)},title:"تقاريرك",children:e.jsx(Uh,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:pm,title:y&&(w!=null&&w.name||w!=null&&w.username)?`بروفيل الوردية: ${(w==null?void 0:w.name)||(w==null?void 0:w.username)}`:"وردية الكاشير",children:e.jsx(ul,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{Dt||Bt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Ir(!0)},title:"بيانات المبيعات",children:e.jsx(sc,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),St.filter(t=>t.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:St.filter(t=>t.status==="pending").length})]}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{Ti()},title:"الديون",children:e.jsx(uh,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105 active:bg-amber-600 active:text-white active:border-amber-600",onClick:()=>{Dt||Bt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):vn(!0)},title:"الصيانة",children:e.jsx(bc,{className:"h-5 w-5 text-amber-700"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-50 text-violet-700 hover:bg-violet-100 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105 active:bg-violet-700 active:text-white active:border-violet-700",onClick:()=>{!oa||Bt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):wn(!0)},title:"يومية المكنة",children:e.jsx(Ic,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105 active:bg-orange-600 active:text-white active:border-orange-600",onClick:()=>{Dt||Bt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):ws.hasMasterPin()?Ws(!0):Rt(!0)},title:"مصروفات المحل",children:e.jsx(nn,{className:"h-5 w-5 text-orange-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-rose-600 mb-1",children:"النواقص"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-rose-50 text-rose-600 hover:bg-rose-100 border border-rose-200 ring-3 ring-rose-300 transition-all duration-200 hover:scale-105 active:bg-rose-600 active:text-white active:border-rose-600",onClick:()=>{Dt||Bt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Ca(!0)},title:"النواقص",children:e.jsx(Zo,{className:"h-5 w-5 text-rose-600"})})]})]})]})]}),!R&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"filters-bar flex items-center justify-center gap-3 bg-gray-50 rounded-md p-3 border border-gray-200",children:[e.jsx(h,{variant:"ghost",size:"sm",className:`btn-filter-send h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${ua==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>mi("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(h,{variant:"ghost",size:"sm",className:`btn-filter-withdraw h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${ua==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-50"}`,onClick:()=>mi("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(h,{variant:"ghost",size:"sm",className:`btn-filter-all h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${ua==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>mi("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(h,{variant:"ghost",size:"sm",className:"h-8 px-3 text-[12px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>Er(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(is,{className:"h-3.5 w-3.5 mr-1"}),"تصفير"]}),Dm>0&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),e.jsx(xs,{open:Nd,onOpenChange:yn,mode:"verify",title:"فتح إدارة التقسيط",description:"أدخل الرقم السري الرئيسي للوصول إلى إدارة التقسيط",onSuccess:()=>{yn(!1),Rl(!0)}}),e.jsx(bh,{open:jd,onOpenChange:Rl}),Fl,e.jsxs(Wt,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:[il.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Gr,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):R?e.jsx("div",{className:"overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[310px]",children:e.jsx("div",{className:"space-y-2 pr-2",children:il.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all duration-200",onClick:()=>Ro(t),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(za,{className:`h-4 w-4 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(Na,{className:"h-4 w-4 text-yellow-500"}),t.status==="failed"&&e.jsx(ai,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`font-medium text-sm ${r||l?"text-gray-800":t.type==="send"?"text-green-700":"text-red-700"}`,children:r?"إيصال تسليم وردية":l?`إيصال إضافة نقدية - ${Ns(t.amount)} جنيه`:(t.type==="send"?"تحويل":"سحب")+` - ${Ns(t.amount)} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(t==null?void 0:t.cashierName)??"الحساب الرئيسي"]}),(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية"),o=(a==null?void 0:a.note)||(a==null?void 0:a.notes)||"";return e.jsx("p",{className:`text-xs ${r||l?"text-gray-500":t.type==="send"?"text-green-600":"text-red-500"}`,children:r?`تم التسليم إلى: ${t.receiverPhone}`:l?o?`ملاحظة: ${o}`:"تمت إضافة نقدية للدرج":`من ${t.senderPhone}${t.type==="send"?` إلى ${t.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[Zn.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",zo.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]})]}),e.jsx(Gt,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",className:`text-xs ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700 border-red-300":t.type==="send"?"bg-green-100 text-green-700 border-green-300":"":""}`,children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})}):e.jsx("div",{className:"overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[calc(100dvh-300px)]",children:e.jsx("div",{className:"space-y-2 pr-2",children:il.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all duration-200",onClick:()=>Ro(t),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(za,{className:`h-4 w-4 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(Na,{className:"h-4 w-4 text-yellow-500"}),t.status==="failed"&&e.jsx(ai,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`font-medium text-sm ${r||l?"text-gray-800":t.type==="send"?"text-green-700":"text-red-700"}`,children:r?"إيصال تسليم وردية":l?`إيصال إضافة نقدية - ${Ns(t.amount)} جنيه`:(t.type==="send"?"تحويل":"سحب")+` - ${Ns(t.amount)} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(t==null?void 0:t.cashierName)??"الحساب الرئيسي"]}),(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية"),o=(a==null?void 0:a.note)||(a==null?void 0:a.notes)||"";return e.jsx("p",{className:`text-xs ${r||l?"text-gray-500":t.type==="send"?"text-green-600":"text-red-500"}`,children:r?`تم التسليم إلى: ${t.receiverPhone}`:l?o?`ملاحظة: ${o}`:"تمت إضافة نقدية للدرج":`من ${t.senderPhone}${t.type==="send"?` إلى ${t.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[Zn.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",zo.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]})]}),e.jsx(Gt,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",className:`text-xs ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700 border-red-300":t.type==="send"?"bg-green-100 text-green-700 border-green-300":"":""}`,children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})}),R&&e.jsxs("div",{className:"mt-2 flex justify-end",children:[e.jsxs(h,{variant:"ghost",size:"sm",className:"h-7 px-2 text-[11px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>Er(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(is,{className:"h-3 w-3 mr-1"}),"تصفير"]}),(s==null?void 0:s.uid)&&localStorage.getItem(`recentTransactionsResetAt:${s.uid}`)&&e.jsx("span",{className:"inline-block h-1.5 w-1.5 rounded-full bg-red-500 ml-1 align-middle"})]})]})]})]}),e.jsx(vh,{isOpen:od,onClose:()=>xn(!1),transaction:cd,onPrint:()=>window.print(),onDelete:xd,onComplete:pd}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full lg:w-[92%] xl:w-[95%] mx-auto",children:[e.jsxs($t,{id:"transaction-section",className:"bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/50 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx(ls,{className:"sticky top-0 z-20 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ts,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(za,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[Ds&&e.jsx("div",{className:"hidden md:flex items-center gap-1 bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 border border-emerald-200 text-emerald-800 text-sm transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:e.jsxs("span",{className:"text-sm font-semibold whitespace-nowrap",children:["تجربة: ",ta," ",ta>=3&&ta<=10?"ساعات":ta===2?"ساعتين":"ساعة"]})}),e.jsxs("div",{className:"top-icons-bar hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:[e.jsx(au,{}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"VIP",onClick:()=>fi(!0),children:e.jsx(Fh,{className:"h-5 w-5 text-yellow-500"})}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"إدارة الفروع",onClick:()=>{i({title:"قيد التطوير",description:"إدارة الفرع قيد التطوير حالياً"})},children:e.jsx(Sc,{className:"h-5 w-5"})}),e.jsx(fh,{})]})]}),km&&e.jsxs(h,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:Mo,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx(jh,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsx(ye,{open:Od,onOpenChange:fi,children:e.jsxs(be,{className:"sm:max-w-md",children:[e.jsx(ve,{children:e.jsx(we,{children:"أفضل 10 عملاء هذا الشهر"})}),e.jsx("div",{className:"space-y-2",children:Vn.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا توجد بيانات لهذا الشهر"}):Vn.map((t,a)=>e.jsxs("div",{className:`flex items-center justify-between border rounded-md px-3 py-2 bg-white ${a===0?"bg-yellow-50 border-yellow-300":""}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Gt,{variant:"outline",className:`min-w-[28px] justify-center ${a===0?"border-yellow-300 text-yellow-700 bg-yellow-50":""}`,children:a+1}),e.jsx("span",{className:`font-semibold ${a===0?"text-yellow-700":""}`,children:t.phone})]}),e.jsxs("div",{className:"text-sm text-gray-700 flex items-center gap-3",children:[e.jsxs("span",{children:["عدد: ",t.count]}),e.jsxs("span",{children:["إجمالي: ",t.total]}),e.jsx(h,{variant:"outline",size:"sm",className:"h-8",onClick:()=>Im(t),title:"إرسال واتساب",children:e.jsx(Xo,{className:"h-4 w-4"})})]})]},t.phone+a))}),e.jsx(lt,{children:e.jsx(h,{onClick:()=>fi(!1),children:"إغلاق"})})]})}),e.jsx(ye,{open:Pd,onOpenChange:Ul,children:e.jsxs(be,{className:"sm:max-w-md",children:[e.jsx(ve,{children:e.jsx(we,{children:"ربط بوت التلجرام"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{children:"Telegram Chat ID"}),e.jsx(q,{value:jn,onChange:t=>kd(t.target.value),placeholder:"اكتب رقم المحادثة"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(X,{children:"إرسال يومي 12 صباحاً"}),e.jsx(Sh,{checked:zl,onCheckedChange:t=>_d(!!t)})]})]}),e.jsxs(lt,{children:[e.jsx(h,{variant:"outline",onClick:()=>Ul(!1),children:"إغلاق"}),e.jsx(h,{onClick:async()=>{s!=null&&s.uid&&(await Se.updateUserData(s.uid,{telegramChatId:jn,telegramDailyEnabled:zl}),i({title:"تم الحفظ"}))},children:"حفظ"}),e.jsx(h,{onClick:async()=>{if(!(s!=null&&s.uid)||!jn){i({title:"أدخل Chat ID"});return}const t=await Am();try{const{sendTelegramMessage:a}=await Nt(async()=>{const{sendTelegramMessage:r}=await Promise.resolve().then(()=>qh);return{sendTelegramMessage:r}},void 0,import.meta.url);await a({chatId:jn,text:t}),i({title:"تم الإرسال"})}catch{i({title:"تعذر الإرسال",description:"تحقق من ربط البوت",variant:"destructive"})}},children:"إرسال الآن"})]})]})}),e.jsx(ye,{open:De,onOpenChange:pe,children:e.jsxs(be,{className:"sm:max-w-lg",children:[e.jsxs(ve,{children:[e.jsx(we,{children:"إدارة الفروع"}),e.jsx(us,{children:"أضف فروع جديدة وأدِر الدخول لكل فرع"}),e.jsx("div",{className:"flex items-center justify-end gap-2 mt-2",children:e.jsx(h,{variant:"outline",size:"sm",onClick:()=>{try{const t=s!=null&&s.uid?`selectedShopId_${s.uid}`:"selectedShopId";localStorage.removeItem(t);try{window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}i({title:"تم الخروج من الفرع"}),L(`/branch/${String(b.shopId)}/dashboard`)}catch{}},children:"الخروج من الفرع"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(X,{children:"اسم المدير"}),e.jsx(q,{value:We,onChange:t=>Ve(t.target.value),placeholder:"اكتب اسم المدير"})]}),e.jsxs("div",{children:[e.jsx(X,{children:"اسم الفرع"}),e.jsx(q,{value:Ee,onChange:t=>He(t.target.value),placeholder:"اكتب اسم الفرع"})]}),e.jsxs("div",{children:[e.jsx(X,{children:"اسم المستخدم للدخول"}),e.jsx(q,{value:Ke,onChange:t=>dt(t.target.value),placeholder:"مثال: branch1"})]}),e.jsxs("div",{children:[e.jsx(X,{children:"كلمة السر"}),e.jsx(q,{type:"password",value:te,onChange:t=>fe(t.target.value),placeholder:"••••••"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Ve(""),He(""),dt(""),fe("")},children:"مسح"}),e.jsx(h,{className:"bg-indigo-600 hover:bg-indigo-700",disabled:st,onClick:async()=>{if(!(s!=null&&s.uid))return;const t=We.trim(),a=Ee.trim(),r=Ke.trim(),l=te.trim();if(!t||!a||!r||!l){i({title:"يرجى ملء جميع الحقول"});return}if(xe.length>=3){i({title:"عفواً",description:"لقد وصلت للحد الأقصى من الفروع (3 فروع)",variant:"destructive"});return}try{le(!0);let o="";try{o=(await Zs(Ne(J,"shops"),{name:a,ownerId:s.uid,createdAt:ct(),updatedAt:ct(),isActive:!0})).id}catch{o=(await Zs(Ne(J,"users",s.uid,"shops"),{name:a,ownerId:s.uid,createdAt:ct(),updatedAt:ct(),isActive:!0})).id}const m=u=>{try{return btoa(unescape(encodeURIComponent(u)))}catch{return btoa(u)}};try{await Zs(Ne(J,"branches"),{ownerId:s.uid,shopId:o,branchName:a,managerName:t,loginUsername:r,passwordEncoded:m(l),createdAt:ct()})}catch{await Zs(Ne(J,"users",s.uid,"branches"),{ownerId:s.uid,shopId:o,branchName:a,managerName:t,loginUsername:r,passwordEncoded:m(l),createdAt:ct()})}try{const u=Ue(Ne(J,"branches"),ie("ownerId","==",s.uid));let S=(await Qe(u)).docs.map(x=>({id:x.id,...x.data()}));if(S.length===0){const x=Ue(Ne(J,"users",s.uid,"branches"));S=(await Qe(x)).docs.map(A=>({id:A.id,...A.data()}))}oe(S)}catch{try{const u=Ue(Ne(J,"users",s.uid,"branches")),S=(await Qe(u)).docs.map(x=>({id:x.id,...x.data()}));oe(S)}catch{}}Ve(""),He(""),dt(""),fe(""),i({title:"تم إضافة الفرع بنجاح"})}catch{i({title:"تعذّر إضافة الفرع"})}finally{le(!1)}},children:"إضافة فرع"})]}),e.jsxs("div",{className:"border-t pt-3",children:[e.jsx("h4",{className:"text-sm font-semibold mb-2",children:"الفروع الحالية"}),st?e.jsx("div",{className:"text-sm text-gray-500",children:"جارٍ التحميل..."}):xe.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"لا يوجد فروع بعد"}):e.jsx("div",{className:"space-y-2",children:xe.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-lg bg-white",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:t.branchName}),e.jsxs("div",{className:"text-gray-600",children:["مدير: ",t.managerName]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{size:"sm",className:"bg-blue-600 hover:bg-blue-700",onClick:()=>{kt(t),Oe(String(t.loginUsername||"")),mt(""),xt(!0)},children:"دخول الفرع"}),e.jsx(h,{size:"sm",variant:"destructive",onClick:async()=>{if(confirm("هل أنت متأكد من حذف الفرع؟ سيتم حذف بيانات الفرع المرتبطة."))try{try{await As(Je(J,"branches",t.id))}catch{}try{await As(Je(J,"users",(s==null?void 0:s.uid)||"","branches",t.id))}catch{}if(t.shopId){try{await As(Je(J,"shops",String(t.shopId)))}catch{}try{await As(Je(J,"users",(s==null?void 0:s.uid)||"","shops",String(t.shopId)))}catch{}}oe(a=>a.filter(r=>r.id!==t.id)),i({title:"تم حذف الفرع"})}catch{i({title:"تعذّر حذف الفرع"})}},children:"حذف الفرع"})]})]},t.id))})]})]})]})}),e.jsx(ye,{open:Te,onOpenChange:xt,children:e.jsxs(be,{className:"sm:max-w-md",children:[e.jsxs(ve,{children:[e.jsx(we,{children:"دخول الفرع"}),e.jsx(us,{children:"أدخل بيانات الدخول للفرع المحدد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(X,{children:"اسم المستخدم"}),e.jsx(q,{value:Jt,onChange:t=>Oe(t.target.value),placeholder:"اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(X,{children:"كلمة السر"}),e.jsx(q,{type:"password",value:et,onChange:t=>mt(t.target.value),placeholder:"••••••"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Oe(""),mt("")},children:"مسح"}),e.jsx(h,{className:"bg-blue-600 hover:bg-blue-700",disabled:Ie,onClick:async()=>{const t=Vt;if(!t){xt(!1);return}const a=String(t.loginUsername||"");let r="";try{const m=String(t.passwordEncoded||"");r=m?decodeURIComponent(escape(atob(m))):""}catch{try{r=t.passwordEncoded?atob(String(t.passwordEncoded)):""}catch{r=""}}const l=Jt.trim(),o=et.trim();if(!l||!o){i({title:"يرجى إدخال اسم المستخدم وكلمة السر"});return}if(l!==a||o!==r){i({title:"بيانات الدخول غير صحيحة",variant:"destructive"});return}try{ht(!0);const m=s!=null&&s.uid?`selectedShopId_${s.uid}`:"selectedShopId";localStorage.setItem(m,String(t.shopId)),i({title:"تم الدخول إلى الفرع",description:String(t.branchName||"")}),xt(!1),pe(!1),L("/user/dashboard")}catch{}ht(!1)},children:"دخول"})]})]})]})}),e.jsxs(Wt,{ref:p,className:"space-y-1 px-2 pb-2 relative z-10 transition-transform duration-200 ease-out will-change-transform",style:{transform:d?`translateY(${d}px)`:void 0},onFocusCapture:t=>{const a=t.target;if(!((a==null?void 0:a.id)==="transferExtraFeeInput")){v(0);return}const l=document.getElementById("transferSubmitButton");if(l){const o=l.getBoundingClientRect(),m=window.innerHeight;if(o.bottom>m){const u=o.bottom-m,g=Math.min(u,220);v(-g)}else v(0)}else v(0)},onBlurCapture:t=>{t.currentTarget.contains(t.relatedTarget)||v(0)},children:[e.jsxs("div",{className:"transaction-type-tabs grid grid-cols-2 gap-0.5 p-0.5 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-200/50 fade-in-up w-full lg:w-[92%] xl:w-[95%] mx-auto ",children:[e.jsxs(h,{variant:re==="transfer"?"default":"ghost",onClick:()=>Qn("transfer"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${re==="transfer"?"bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg hover:shadow-md hover:from-blue-600 hover:to-indigo-700":"text-gray-600 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-700 hover:border-blue-200"}`,children:[e.jsx(Gr,{className:"h-1 w-1 mr-1"}),"تحويل"]}),e.jsxs(h,{variant:re==="withdraw"?"default":"ghost",onClick:()=>Qn("withdraw"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${re==="withdraw"?"bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-lg hover:shadow-md hover:from-emerald-600 hover:to-green-700":"text-gray-600 hover:bg-gradient-to-r hover:from-emerald-50 hover:to-green-50 hover:text-emerald-700 hover:border-emerald-200"}`,children:[e.jsx(ri,{className:"h-1 w-1 mr-1"}),"سحب"]})]}),e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(ca,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(h,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>L("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(vs,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(h,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>{Ya(!0)},title:"المحافظ",children:[e.jsx(ca,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),qe.length>0?e.jsxs(La,{value:D,onValueChange:Om,children:[e.jsx(Wa,{"data-testid":"wallet-select",className:"selected-number-card w-full h-12 text-sm bg-gradient-to-r from-white to-gray-50 border-2 border-gray-200 hover:border-blue-400 focus:border-blue-500 rounded-xl transition-all duration-300 hover:shadow-md focus:shadow-lg",children:e.jsx(Fa,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-600"})}),e.jsxs(Ra,{className:"rounded-xl border-2 border-gray-200 shadow-md z-[9999]",children:[e.jsx("div",{"data-fixed-header":"true",className:"sticky top-0 z-10 bg-white p-2 border-b border-gray-200",children:e.jsx(q,{value:Sl,onChange:t=>nd(t.target.value),placeholder:"ابحث برقم المحفظة",className:"h-6 text-xs"})}),e.jsx("div",{className:"pr-1",children:Dl.length===0?e.jsx("div",{className:"text-xs text-gray-500 p-2",children:"لا توجد نتائج مطابقة"}):Dl.map(t=>e.jsx(ra,{value:t.id,className:"rounded-lg hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200",children:e.jsxs("div",{className:"flex items-center gap-1 py-1 w-full justify-between",children:[e.jsx("div",{className:"p-1 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg",children:e.jsx(ca,{className:"h-1 w-1 text-blue-600"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-800",children:t.name}),e.jsxs("span",{className:"text-sm font-semibold text-red-600",children:["(",t.phone,")"]})]}),t.isDefault&&e.jsx(Gt,{variant:"secondary",className:"text-[10px] bg-gradient-to-r from-emerald-100 to-green-100 text-emerald-700 border-emerald-200",children:"افتراضي"})]}),e.jsx("div",{className:"ml-auto flex flex-col items-end gap-1"})]})},t.id))})]})]}):e.jsx("div",{className:"rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 px-3 py-3 text-xs text-gray-600",children:"لا توجد محافظ حتى الآن. اضغط “إضافة محفظة” لإضافة أول محفظة."})]}),e.jsx(ye,{open:Ka,onOpenChange:fs,children:e.jsxs(be,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(ve,{children:e.jsx(we,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(Oh,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),e.jsx(xs,{open:Aa,onOpenChange:Ya,mode:"verify",title:"الرقم السري لفتح المحافظ",description:"أدخل الرقم السري الرئيسي لعرض وإدارة المحافظ",onSuccess:()=>{Ya(!1),fs(!0)},userId:s==null?void 0:s.uid}),e.jsx(xs,{open:bl,onOpenChange:t=>{or(t),t||cr(null)},mode:"verify",title:"تأكيد تغيير المحفظة",description:"أدخل الرقم السري الرئيسي لتغيير المحفظة المختارة",onSuccess:()=>{dn&&(Gn(dn,"walletSelectionPin"),cr(null)),or(!1)},userId:s==null?void 0:s.uid}),e.jsx(ye,{open:Xc,onOpenChange:mn,children:e.jsxs(be,{className:"sm:max-w-md",children:[e.jsx(ve,{children:e.jsxs(we,{className:"flex items-center gap-2 text-red-700",children:[e.jsx(Zo,{className:"h-5 w-5 text-red-600"}),"تحذير حد شهري للمحفظة"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded-md border bg-red-50 border-red-200",children:[e.jsxs("p",{className:"text-sm text-red-800",children:["المحفظة: ",e.jsx("span",{className:"font-semibold",children:(Hs==null?void 0:Hs.walletName)||""})]}),e.jsxs("p",{className:"text-sm text-red-800",children:["الاستخدام الشهري (",(Hs==null?void 0:Hs.type)==="withdraw"?"سحب":"تحويل","):",e.jsxs("span",{className:"font-mono",children:[" ",Number((Hs==null?void 0:Hs.used)||0).toLocaleString("en-US")," "]})," جنيه"]}),e.jsxs("p",{className:"text-sm text-red-800",children:["الحد الشهري: ",e.jsx("span",{className:"font-mono",children:Number((Hs==null?void 0:Hs.limit)||0).toLocaleString("en-US")})," جنيه"]}),e.jsx("p",{className:"text-sm font-semibold text-red-900 mt-1",children:"تم الوصول إلى 85% من الحد الشهري — يرجى الحذر قبل الاستمرار."})]}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsx(h,{variant:"outline",onClick:()=>mn(!1),children:"حسناً"})})]})]})}),D&&qe.length>0&&(()=>{var ee;const t=qe.find(se=>se.id===D),a=pa,r=$m(D),l=(tt==null?void 0:tt.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,o=(tt==null?void 0:tt.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,m=(tt==null?void 0:tt.monthlyWithdrawUsed)??a.totalWithdrawn??0,u=(tt==null?void 0:tt.monthlyTransferUsed)??a.totalTransferred??0,g=((ee=Fe==null?void 0:Fe.subscription)==null?void 0:ee.planType)===$s.TAHWEELA,S=g?0:(tt==null?void 0:tt.dailyWithdrawLimit)??1e5,x=g?0:(tt==null?void 0:tt.dailyTransferLimit)??6e4,f=g?0:(tt==null?void 0:tt.dailyWithdrawUsed)??r.totalWithdrawn??0,A=g?0:(tt==null?void 0:tt.dailyTransferUsed)??r.totalTransferred??0,P=parseFloat(Yt||"0")||0,k=m+(re==="withdraw"?P:0),H=u+(re==="transfer"?P:0),$e=f+(re==="withdraw"?P:0),Q=A+(re==="transfer"?P:0);return t?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود الشهرية: ",ho||(t==null?void 0:t.name)||"المحفظة المختارة"]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(k/Math.max(l,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(H/Math.max(o,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-red-600 font-medium",children:["متبقي سحب: ",Math.max(l-k,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(o-H,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود اليومية: ",ho||(t==null?void 0:t.name)||"المحفظة المختارة"]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min($e/Math.max(S,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Q/Math.max(x,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(S-$e,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(x-Q,0).toLocaleString("en-US")," جنيه"]})]})]})]}):null})(),re==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative",children:[e.jsx(wa,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(q,{value:Ps,onChange:t=>Va(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("receiverPhoneInput");if(a)a.focus();else{const r=document.getElementById("amountInput");r==null||r.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),!B&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(wa,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(q,{id:"receiverPhoneInput",value:gs,onChange:t=>{lr(t.target.value),xi&&mr(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("amountInput");a==null||a.focus()}},inputMode:"numeric",maxLength:11,placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(wa,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(q,{value:D&&((Vo=qe.find(t=>t.id===D))==null?void 0:Vo.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base bg-gray-50 transition-all duration-300"})]})]}),re==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(qt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(q,{id:"amountInput",value:Yt,onChange:t=>{Ja(t.target.value),xi&&mr(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("transferCommissionInput");if(a)a.focus();else{const r=document.getElementById("quickDebtButton");r==null||r.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),Et?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",Et.debtorName," بمبلغ ",Et.amount," جنيه"]}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>Bs(null),children:"إلغاء"})]}):null]}),(()=>{if(B)return null;const t=as();return t&&t.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",t==null?void 0:t.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(h,{id:"quickDebtButton",type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=as(),l=(r==null?void 0:r.defaultTransferCommission)!=null?Number(r.defaultTransferCommission):0,o=parseFloat(Yt||"0")||0,m=Math.round((l||0)*o/1e3*100)/100,u=o+m;_e((u||0).toString()),Dt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Y(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",className:"hidden",title:wt?"العمولة تُضاف":"العمولة تُخصم",children:wt?e.jsx(vs,{className:"h-4 w-4 text-green-600"}):e.jsx(ar,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:wt?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(qt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(q,{id:"transferCommissionInput",value:ds,onChange:r=>ci(r.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=as(),l=parseFloat(Yt||"0")||0;let o=0;if((r==null?void 0:r.defaultTransferCommission)!=null){const u=Number(r.defaultTransferCommission)||0;o=Math.round(u*l/1e3*100)/100}else{const u=ds&&ds.trim()!==""?parseFloat(ds):0;o=Math.max(0,u)}const m=l+o;_e((m||0).toString()),Dt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Y(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",className:"hidden",title:wt?"العمولة تُضاف":"العمولة تُخصم",children:wt?e.jsx(vs,{className:"h-4 w-4 text-green-600"}):e.jsx(ar,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:wt?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),(()=>{const t=hn(Ps||"").replace(/\D/g,""),a=hn(gs||"").replace(/\D/g,"");return re==="transfer"&&(t.startsWith("010")&&(a.startsWith("011")||a.startsWith("012")||a.startsWith("015"))||t.startsWith("012")&&a.startsWith("010")||t.startsWith("011")&&a.startsWith("010")||t.startsWith("015")&&a.startsWith("010"))?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رسوم التحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(qt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(q,{id:"transferExtraFeeInput",value:vl,onChange:l=>Zc(l.target.value),placeholder:"أدخل رسوم التحويل",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"hidden",children:"تُخصم من المحفظة وتضاف للدرج — لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010"})]}):null})(),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(h,{id:"transferSubmitButton",onClick:Uo,className:"btn-transfer-confirm w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 text-white",children:xi?"تم التحويل بنجاح":"تأكيد التحويل"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(ri,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-green-500"}),e.jsx(q,{id:"amountInput",value:Yt,onChange:t=>{Ja(t.target.value),$l&&Pr(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("manualWithdrawCommissionInput");if(a)a.focus();else{const r=document.getElementById("withdrawSubmitButton");r==null||r.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),(()=>{const t=as();return t&&t.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",t==null?void 0:t.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=as(),l=parseFloat(Yt||"0")||0,o=(r==null?void 0:r.defaultWithdrawCommission)!=null&&Number(r.defaultWithdrawCommission)||0,m=Math.round(o*l/1e3*100)/100,u=wt?l+m:l;_e((u||0).toString()),Dt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Y(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>di(r=>!r),title:wt?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:wt?e.jsx(vs,{className:"h-4 w-4"}):e.jsx(ar,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:wt?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(qt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(q,{id:"manualWithdrawCommissionInput",value:cs,onChange:r=>oi(r.target.value),onKeyDown:r=>{if(r.key==="Enter"){const l=document.getElementById("withdrawSubmitButton");l==null||l.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=as(),l=parseFloat(Yt||"0")||0;let o=0;if((r==null?void 0:r.defaultWithdrawCommission)!=null){const u=Number(r.defaultWithdrawCommission)||0;o=Math.round(u*l/1e3*100)/100}else{const u=cs&&cs.trim()!==""?parseFloat(cs):Math.round(l*.01*100)/100;o=Math.max(0,u)}const m=wt?l+o:l;_e((m||0).toString()),Dt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Y(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",title:wt?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>di(r=>!r),children:wt?e.jsx(vs,{className:"h-4 w-4 text-green-600"}):e.jsx(ar,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:wt?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),(j==null?void 0:j.showWithdrawNote)&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"ملاحظة السحب (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Xo,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(q,{id:"withdrawNoteInput",value:c,onChange:t=>T(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("withdrawSubmitButton");a==null||a.focus()}},placeholder:"أدخل ملاحظة للسحب (اختياري)",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(h,{id:"withdrawSubmitButton",onClick:Uo,className:"w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:$l?"تم السحب بنجاح":"تأكيد السحب"})})]}),e.jsx(ye,{open:E,onOpenChange:Y,children:e.jsxs(be,{children:[e.jsxs(ve,{children:[e.jsx(we,{children:"تحويل مؤجل"}),e.jsx(us,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[Us&&Us.length>0?e.jsxs("div",{children:[e.jsx(X,{children:"اختيار عميل"}),e.jsxs(La,{value:he,onValueChange:t=>{jt(t);const a=Us.find(r=>r.id===t);a&&Ce(a.name)},children:[e.jsx(Wa,{className:"w-full",children:e.jsx(Fa,{placeholder:"اختر عميل"})}),e.jsx(Ra,{children:Us.map(t=>e.jsxs(ra,{value:t.id,children:[t.name,t.mobile?` — ${t.mobile}`:""]},t.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(X,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx(q,{id:"quickDebtName",value:V,onChange:t=>Ce(t.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(X,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx(q,{id:"quickDebtAmount",type:"number",value:ze,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(X,{htmlFor:"quickDebtCommission",children:"العمولة (محسوبة تلقائياً)"}),e.jsx(q,{id:"quickDebtCommission",type:"number",value:function(){const t=as(),a=parseFloat((Yt||"0").toString())||0;let r=0;if(re==="transfer")if((t==null?void 0:t.defaultTransferCommission)!=null){const l=Number(t.defaultTransferCommission)||0;r=Math.round(l*a/1e3*100)/100}else{const l=ds&&ds.trim()!==""?parseFloat(ds):0;r=Math.max(0,l)}else if((t==null?void 0:t.defaultWithdrawCommission)!=null){const l=Number(t.defaultWithdrawCommission)||0;r=Math.round(l*a/1e3*100)/100}else{const l=cs&&cs.trim()!==""?parseFloat(cs):Math.round(a*.01*100)/100;r=Math.max(0,l)}return String(r||0)}(),readOnly:!0,placeholder:"قيمة العمولة"})]}),e.jsxs("div",{children:[e.jsx(X,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx(q,{id:"quickDebtNotes",value:Re,onChange:t=>Be(t.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(lt,{children:e.jsx(h,{type:"button",variant:"default",className:"bg-green-600 text-white hover:bg-green-700",onClick:()=>{const t=as(),a=parseFloat((Yt||"").toString())||0;let r=0;if(re==="transfer")if((t==null?void 0:t.defaultTransferCommission)!=null){const m=Number(t.defaultTransferCommission)||0;r=Math.round(m*a/1e3*100)/100}else{const m=ds&&ds.trim()!==""?parseFloat(ds):0;r=Math.max(0,m)}else if((t==null?void 0:t.defaultWithdrawCommission)!=null){const m=Number(t.defaultWithdrawCommission)||0;r=Math.round(m*a/1e3*100)/100}else{const m=cs&&cs.trim()!==""?parseFloat(cs):Math.round(a*.01*100)/100;r=Math.max(0,m)}let l=0;if(re==="withdraw"?l=wt?a:Math.max(0,Math.round((a-r)*100)/100):l=Math.max(0,Math.round((a+r)*100)/100),!V||isNaN(l)||l<=0){i({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const o=Us.find(m=>m.id===he);Bs({debtorName:V,amount:l,notes:Re,customerId:he||void 0,mobile:o==null?void 0:o.mobile}),Ia(!1),Y(!1),i({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx($t,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(Wt,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(Hh,{isOpen:sd,onClose:()=>ad(!1),initialEditingWallet:rd,onWalletUpdate:async()=>{try{await Ur()}catch(t){console.error("Error reloading wallets after update:",t)}}}),e.jsx(Gh,{isOpen:ld,onClose:()=>Cl(!1),transaction:id,onDelete:Em}),e.jsx(xs,{open:hd,onOpenChange:Tr,onSuccess:Wm,title:Fm(),description:Rm(),mode:"verify"}),e.jsx(ic,{open:sm,onOpenChange:xo,onSuccess:Um,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:Pt,balanceLabel:"الرصيد النقدي",userId:s==null?void 0:s.uid}),e.jsx(ic,{open:am,onOpenChange:po,onSuccess:zm,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:Es&&at[Es]||0,balanceLabel:`رصيد ${((Jo=qe.find(t=>t.id===Es))==null?void 0:Jo.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(eu,{open:rm,onOpenChange:Ui,onSuccess:qm,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:Es&&at[Es]||0,balanceLabel:`رصيد ${((Ko=qe.find(t=>t.id===Es))==null?void 0:Ko.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(Qh,{open:gm,onOpenChange:fm,userId:s==null?void 0:s.uid}),e.jsx(Zh,{open:ym,onOpenChange:bm,userId:s==null?void 0:s.uid}),e.jsx(Xh,{open:vm,onOpenChange:wm}),e.jsx(ye,{open:lm,onOpenChange:_n,children:e.jsxs(be,{className:"sm:max-w-md",children:[e.jsx(ve,{children:e.jsx(we,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(q,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:qi,onChange:t=>On(t.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:async()=>{if(!await Hn(Xi)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(qi);if(isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Pt+t;Ht(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?Se.updateUserData(s.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),Xe(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),Xe(!0)}):Xe(!0),i({title:"تم بنجاح",description:`تم إضافة ${t} جنيه إلى الدرج النقدية وحفظه في السحابة`}),_n(!1),On(""),Wn("")},children:[e.jsx(vs,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(h,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:async()=>{if(!await Hn(Xi)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(qi);if(isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Pt-t;Ht(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?Se.updateUserData(s.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),Xe(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),Xe(!0)}):Xe(!0),i({title:"تم بنجاح",description:`تم خصم ${t} جنيه من الدرج النقدية وحفظه في السحابة`}),_n(!1),On(""),Wn("")},children:[e.jsx(ar,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",Pt.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx(q,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:Xi,onChange:t=>Wn(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(lt,{className:"flex gap-2",children:e.jsx(h,{variant:"outline",onClick:()=>{_n(!1),On(""),Wn("")},children:"إلغاء"})})]})}),e.jsx(ye,{open:Tm,onOpenChange:Jn,children:e.jsxs(be,{className:"sm:max-w-md",children:[e.jsx(ve,{children:e.jsx(we,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(at).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(q,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل الرقم السري الرئيسي",value:Wo,onChange:t=>Kn(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(lt,{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Jn(!1),Kn("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",onClick:async()=>{if(!await ws.verifyMasterPin(Wo,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const a={};Object.keys(at).forEach(m=>{a[m]=0}),ns(a),localStorage.setItem(Cs(),JSON.stringify(a)),Jn(!1),Kn("");const r=new Date().toISOString(),l={walletBalances:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(o,JSON.stringify(l)),s!=null&&s.uid?Se.updateUserData(s.uid,l).then(()=>{localStorage.removeItem(o),Xe(!1)}).catch(m=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",m),Xe(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):Xe(!0),setTimeout(()=>{ns({...a})},100)}catch(a){console.error("خطأ في تصفير أرصدة المحافظ:",a),i({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(ye,{open:nm,onOpenChange:kn,children:e.jsxs(be,{className:"sm:max-w-md",children:[e.jsx(ve,{children:e.jsx(we,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((Yo=qe.find(t=>t.id===D))==null?void 0:Yo.name)||D]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(D&&at[D]?at[D]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(q,{id:"resetSelectedWalletPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:go,onChange:t=>zi(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(lt,{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{kn(!1),zi("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",onClick:async()=>{var a;if(!D){i({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await ws.verifyMasterPin(go,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const r={...at};r[D]=0,ns(r),localStorage.setItem(Cs(),JSON.stringify(r)),kn(!1),zi("");const l=new Date().toISOString(),o={walletBalances:r,lastUpdated:l},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(o)),s!=null&&s.uid?Se.updateUserData(s.uid,o).then(()=>{localStorage.removeItem(m),Xe(!1)}).catch(u=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",u),Xe(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):Xe(!0),i({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((a=qe.find(u=>u.id===D))==null?void 0:a.name)||D}`})}catch(r){console.error("خطأ في تصفير رصيد المحفظة المختارة:",r),i({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(ye,{open:Sm,onOpenChange:zn,children:e.jsxs(be,{className:"sm:max-w-md",children:[e.jsx(ve,{children:e.jsxs(we,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(vs,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(at).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx(q,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:ko,onChange:t=>tl(t.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx(q,{id:"addWalletTotalPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري",value:_o,onChange:t=>sl(t.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(lt,{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{zn(!1),tl(""),sl("")},children:"إلغاء"}),e.jsx(h,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:Oo,onClick:async()=>{const t=parseFloat(ko);if(!t||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!await _m(_o)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}Eo(!0);try{const a=Object.values(at).reduce((r,l)=>r+l,0);if(a===0){const r=Object.keys(at),l=t/r.length,o={};r.forEach(m=>{o[m]=l}),ns(o),localStorage.setItem(Cs(),JSON.stringify(o)),s!=null&&s.uid?await Se.updateUserData(s.uid,{walletBalances:o,lastUpdated:new Date().toISOString()}):Xe(!0)}else{const r={};Object.entries(at).forEach(([l,o])=>{const m=o/a,u=t*m;r[l]=o+u}),ns(r),localStorage.setItem(Cs(),JSON.stringify(r)),s!=null&&s.uid?await Se.updateUserData(s.uid,{walletBalances:r,lastUpdated:new Date().toISOString()}):Xe(!0)}setTimeout(()=>{ns(r=>({...r}))},100),zn(!1),tl(""),sl("")}catch(a){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",a),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{Eo(!1)}},children:Oo?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(ye,{open:Pm,onOpenChange:Yn,children:e.jsxs(be,{className:"sm:max-w-[425px]",children:[e.jsx(ve,{children:e.jsxs(we,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(is,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{htmlFor:"resetCashPin",children:"الرقم السري الرئيسي"}),e.jsx(q,{id:"resetCashPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:al,onChange:t=>rl(t.target.value)})]})]}),e.jsxs(lt,{children:[e.jsx(h,{variant:"outline",onClick:()=>{Yn(!1),rl("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",onClick:async()=>{if(!al){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await ws.verifyMasterPin(al,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{Ht(0),Yn(!1),rl("");const a={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem(Os(),"0");const r=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(r,JSON.stringify(a)),s!=null&&s.uid?Se.updateUserData(s.uid,a).then(()=>{localStorage.removeItem(r),Xe(!1)}).catch(l=>{console.error("خطأ في حفظ الرصيد في Firebase:",l),Xe(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):Xe(!0)}catch(a){console.error("خطأ في تصفير الرصيد النقدي:",a),i({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(iu,{open:jm,onOpenChange:Po,userId:s==null?void 0:s.uid,cashBalance:Pt,walletBalances:at,transactions:Ge}),e.jsx(ye,{open:Nm,onOpenChange:Lr,children:e.jsxs(be,{className:"sm:max-w-[425px]",children:[e.jsx(ve,{children:e.jsxs(we,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(vs,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx(q,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:er,onChange:t=>Fn(t.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{className:"text-right",children:"هل تريد إضافة ملاحظة؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{type:"button",variant:Fr==="yes"?"default":"outline",onClick:()=>Rr("yes"),className:"flex-1",children:"نعم"}),e.jsx(h,{type:"button",variant:Fr==="no"?"default":"outline",onClick:async()=>{if(Rr("no"),!er||parseFloat(er)<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!Wr){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await Hn(Wr)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}Bn(!0);try{const t=parseFloat(er),a=Pt+t;Ht(a),localStorage.setItem(Os(),a.toString());const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r));const o=`CASHADD-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`;Lr(!1),Fn(""),Rn(""),Rr(null),Un("");const m=[];if(s!=null&&s.uid){m.push(Se.updateUserData(s.uid,r).then(()=>{localStorage.removeItem(l),Xe(!1)}).catch(()=>{Xe(!0)}));const u={txnType:"cash_addition",type:"cash_addition",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:o,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(j==null?void 0:j.shopId)||void 0};m.push(Se.saveUserTransaction(s.uid,u));const g=j==null?void 0:j.shopId;if(g){const S=Je(J,"dashboardData",g);m.push(Zt(S,{cashBalance:a}))}}Promise.allSettled(m).then(()=>{}).catch(()=>{})}catch{Ht(Pt),localStorage.setItem("cashBalance",Pt.toString()),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{Bn(!1)}},className:"flex-1",children:"لا"})]})]}),Fr==="yes"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"addCashNote",children:"الملاحظة"}),e.jsx(q,{id:"addCashNote",type:"text",placeholder:"اكتب الملاحظة",value:el,onChange:t=>Un(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx(q,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:Wr,onChange:t=>Rn(t.target.value)})]})]}),e.jsxs(lt,{children:[e.jsx(h,{variant:"outline",onClick:()=>{Lr(!1),Fn(""),Rn(""),Rr(null),Un("")},children:"إلغاء"}),e.jsx(h,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:To,onClick:async()=>{if(!er||parseFloat(er)<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!Wr){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await Hn(Wr)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}if(Fr==="yes"&&el.trim().length===0){i({title:"تنبيه",description:"أدخل الملاحظة أو اختر لا",variant:"destructive"});return}Bn(!0);try{const t=parseFloat(er),a=Pt+t;Ht(a),localStorage.setItem(Os(),a.toString());const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r));const o=`CASHADD-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`;Lr(!1),Fn(""),Rn(""),Rr(null),Un("");const m=[];if(s!=null&&s.uid){m.push(Se.updateUserData(s.uid,r).then(()=>{localStorage.removeItem(l),Xe(!1)}).catch(()=>{Xe(!0)}));const u={txnType:"cash_addition",type:"cash_addition",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:o,note:Fr==="yes"?el.trim():void 0,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(j==null?void 0:j.shopId)||void 0};m.push(Se.saveUserTransaction(s.uid,u));const g=j==null?void 0:j.shopId;if(g){const S=Je(J,"dashboardData",g);m.push(Zt(S,{cashBalance:a}))}}Promise.allSettled(m).then(()=>{}).catch(()=>{})}catch{Ht(Pt),localStorage.setItem("cashBalance",Pt.toString()),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{Bn(!1)}},children:To?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(ye,{open:tm,onOpenChange:Bi,children:e.jsxs(be,{className:"sm:max-w-md",children:[e.jsx(ve,{children:e.jsx(we,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx(q,{id:"search-date",type:"date",value:gn,onChange:t=>El(t.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx(q,{id:"search-time",type:"time",value:fn,onChange:t=>Ml(t.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(lt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>{El(""),Ml(""),Bi(!1)},children:"مسح"}),e.jsx(h,{onClick:()=>Bi(!1),children:"تطبيق"})]})]})}),e.jsx(ru,{isOpen:wd,onClose:()=>gi(!1)}),e.jsx(nu,{isOpen:hi,onClose:()=>Ir(!1),initialBarcode:ed}),e.jsx(wh,{isOpen:Sd,onClose:()=>bn(!1)}),e.jsx(Nh,{open:Dd,onOpenChange:vn}),e.jsx(wu,{open:Cd,onOpenChange:t=>{if(t&&!oa){i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}wn(t)}}),e.jsx(Au,{open:Z,onOpenChange:t=>{if(t&&!oa){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}ae(t)}}),e.jsx(Tu,{open:de,onOpenChange:t=>{if(t&&!oa){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}$(t)}}),e.jsx(xs,{open:cm,onOpenChange:No,onSuccess:()=>Ki(!0),title:"تقاريرك",description:"أدخل الرقم السري الرئيسي للوصول إلى تقاريرك",mode:"verify"}),e.jsx(ye,{open:Ji,onOpenChange:Ki,children:e.jsxs(be,{className:"sm:max-w-xl",children:[e.jsxs(ve,{children:[e.jsxs(we,{className:"flex items-center gap-2",children:[e.jsx(sc,{className:"h-4 w-4 text-blue-600"}),"تقارير اليوم"]}),e.jsx(us,{children:"ملخص معاملات اليوم محفوظ لآخر 30 يومًا مع أرشفة في السحابة"})]}),e.jsxs("div",{className:"space-y-4",children:[(()=>{const t=new Date().toDateString(),a=Ge.filter(g=>{const S=new Date(g.createdAt).toDateString(),x=String(g.status||"completed").toLowerCase();return S===t&&(x==="completed"||x==="confirmed")}),r=a.length,l=a.reduce((g,S)=>g+Number(S.amount||0),0),o=a.filter(g=>g.type==="withdraw").reduce((g,S)=>g+Number(S.amount||0),0),m=a.filter(g=>g.type==="send").reduce((g,S)=>g+Number(S.amount||0),0),u=a.reduce((g,S)=>g+Number(bs.calculateTransactionProfit(S)||0),0);return e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-blue-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-blue-700",children:"عدد المعاملات"}),e.jsx("div",{className:"text-lg font-bold text-blue-800",children:r})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-indigo-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-indigo-700",children:"إجمالي المبالغ"}),e.jsx("div",{className:"text-lg font-bold text-indigo-800",children:Number(l).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-red-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-red-700",children:"المبالغ المسحوبة"}),e.jsx("div",{className:"text-lg font-bold text-red-800",children:Number(o).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-green-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-green-700",children:"المبالغ المرسلة"}),e.jsx("div",{className:"text-lg font-bold text-green-800",children:Number(m).toFixed(2)})]}),e.jsxs("div",{className:"col-span-2 rounded-lg p-3 bg-gradient-to-r from-amber-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-amber-700",children:"الأرباح"}),e.jsx("div",{className:"text-lg font-bold text-amber-800",children:Number(u).toFixed(2)})]})]})})(),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(h,{variant:"default",onClick:async()=>{try{if(!(s!=null&&s.uid))return;const t=new Date,a=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0"),o=`${a}-${r}-${l}`,m=t.toDateString(),u=Ge.filter(P=>{const k=new Date(P.createdAt).toDateString(),H=String(P.status||"completed").toLowerCase();return k===m&&(H==="completed"||H==="confirmed")}),g=u.length,S=u.reduce((P,k)=>P+Number(k.amount||0),0),x=u.filter(P=>P.type==="withdraw").reduce((P,k)=>P+Number(k.amount||0),0),f=u.filter(P=>P.type==="send").reduce((P,k)=>P+Number(k.amount||0),0),A=u.reduce((P,k)=>P+Number(bs.calculateTransactionProfit(k)||0),0);await Yr.add({userId:s.uid,reportDate:o,totalTransactions:g,totalAmount:Number(S.toFixed(2)),totalWithdrawn:Number(x.toFixed(2)),totalSent:Number(f.toFixed(2)),profit:Number(A.toFixed(2)),walletId:null});try{await Yr.trimToMaxCount(s.uid,30)}catch{}i({title:"تم الأرشفة",description:`تم حفظ تقرير ${o}`})}catch{i({title:"فشل الأرشفة",description:"تعذر حفظ التقرير",variant:"destructive"})}},children:"أرشفة اليوم"}),e.jsx(h,{variant:"outline",onClick:()=>Ki(!1),children:"إغلاق"})]}),e.jsx("div",{className:"mt-2 border-t pt-2",children:e.jsx("div",{className:"space-y-2 max-h-[40vh] overflow-auto",children:jo.length===0?e.jsx("div",{className:"text-xs text-muted-foreground",children:"لا توجد تقارير محفوظة"}):jo.map(t=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:t.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",t.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalAmount).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalWithdrawn).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalSent).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:Number(t.profit??0).toFixed(2)})]})]})]},t.id||`${t.userId}-${t.reportDate}`))})})]})]})}),e.jsx(ye,{open:om,onOpenChange:t=>{if(t){i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}Vi(!1)},children:e.jsxs(be,{dir:"rtl",className:"sm:max-w-md w-[95vw] sm:w-auto rounded-2xl border border-emerald-200 shadow-xl bg-gradient-to-br from-white via-green-50 to-emerald-50 backdrop-blur-md data-[state=open]:animate-in data-[state=open]:fade-in-0 data-[state=open]:zoom-in-90 data-[state=open]:slide-in-from-bottom-8 duration-300",children:[e.jsxs(ve,{children:[e.jsx(we,{className:"text-right text-green-700",children:"شحن رصيد الموبايل"}),e.jsx(us,{className:"text-right text-gray-600",children:"أدخل البيانات ثم اضغط تأكيد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(X,{htmlFor:"topupPhone",className:"text-right block",children:"رقم الموبايل"}),e.jsx(q,{id:"topupPhone",value:En,onChange:t=>fo(t.target.value),placeholder:"010xxxxxxx",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx(X,{className:"text-right block",children:"شركة التشغيل"}),e.jsxs(La,{value:Mn,onValueChange:yo,children:[e.jsx(Wa,{className:"text-right",children:e.jsx(Fa,{placeholder:"اختر الشركة"})}),e.jsxs(Ra,{children:[e.jsx(ra,{value:"vodafone",children:"فودافون"}),e.jsx(ra,{value:"orange",children:"أورنج"}),e.jsx(ra,{value:"etisalat",children:"اتصالات"}),e.jsx(ra,{value:"we",children:"WE"})]})]})]}),e.jsxs("div",{children:[e.jsx(X,{htmlFor:"topupAmount",className:"text-right block",children:"المبلغ بالجنيه"}),e.jsx(q,{id:"topupAmount",type:"number",value:$n,onChange:t=>bo(t.target.value?Number(t.target.value):""),placeholder:"50",className:"text-right"})]})]}),e.jsxs(lt,{className:"flex gap-2 justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>Vi(!1),className:"border-gray-300",children:"إلغاء"}),e.jsx(h,{onClick:N,disabled:vo||!En||!Mn||!$n,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:vo?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})}),e.jsx(xs,{open:Ld,onOpenChange:bi,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{bi(!1),ur(!0)}}),e.jsx(xs,{open:Fd,onOpenChange:Jl,mode:"verify",title:"تأكيد تغيير طلب الرقم السري للديون",description:"أدخل الرقم السري الرئيسي لتفعيل أو إلغاء طلب الرقم السري عند فتح الديون",onSuccess:async()=>{if(Kl!==null){const t=Kl;Vl(t);try{const a=s==null?void 0:s.uid,r=a?`debtsPinRequired_${a}`:"debtsPinRequired";localStorage.setItem(r,String(t)),a&&await Se.updateUserData(a,{debtsPinRequired:t})}catch{}i({title:t?"تم تفعيل طلب الرقم السري للديون":"تم إلغاء طلب الرقم السري للديون",description:t?"سيُطلب الرقم السري الرئيسي عند فتح نافذة الديون.":"يمكن فتح نافذة الديون بدون طلب الرقم السري."})}Rd(null),Jl(!1)}}),e.jsx(xh,{open:im,onOpenChange:Er,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"سيتم حذف كل المعاملات السابقة نهائيًا من حسابك وFirebase.",onSuccess:async()=>{try{if(!(s!=null&&s.uid)){Er(!1);return}const t=new Date,a=l=>l instanceof Date?l:typeof(l==null?void 0:l.toDate)=="function"?l.toDate():new Date(String(l)),r=Ge.filter(l=>a(l.createdAt)<t);await Se.updateUserData(s.uid,{recentReset:{keepLastCount:fr.keepLastCount??30,intervalDays:fr.intervalDays??7,lastResetAt:t}}),qn(l=>({...l,lastResetAt:t})),i({title:"تم إخفاء المعاملات السابقة",description:"تم إخفاء كل الإيصالات الأقدم من وقت التصفير من العرض بدون التأثير على تقارير اليوم/الشهر أو الحدود."})}catch(t){console.error("فشل تنفيذ التصفير النهائي:",t),i({title:"فشل التصفير",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}finally{Er(!1)}}}),e.jsx(xs,{open:js,onOpenChange:Ws,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{Ws(!1),Rt(!0)}}),e.jsx(ye,{open:$d,onOpenChange:ur,children:e.jsxs(be,{className:"sm:max-w-[425px]",children:[e.jsxs(ve,{className:"flex items-center justify-between",children:[e.jsx(we,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx(nc,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[Lm," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"debtorName",className:"text-right col-span-1",children:"اسم المديون"}),e.jsx(q,{id:"debtorName",value:vi,onChange:t=>Yl(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل اسم المديون"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(q,{id:"debtAmount",type:"number",value:wi,onChange:t=>Hl(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx(q,{id:"debtReason",value:Ni,onChange:t=>Gl(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]}),e.jsx(lt,{children:e.jsx(h,{onClick:()=>{if(vi&&wi&&Ni){const t={id:Date.now().toString(),debtorName:vi,amount:parseFloat(wi),reason:Ni,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};An(t),pr(!0)}else i({title:"بيانات غير مكتملة",description:"يرجى إدخال الاسم والمبلغ والسبب",variant:"destructive"})},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(h,{variant:"outline",className:"w-full",onClick:()=>xr(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(h,{variant:"outline",className:"w-full",onClick:()=>Pi(!0),children:"إضافة عميل"})})]})}),e.jsx(ye,{open:Ci,onOpenChange:xr,children:e.jsxs(be,{className:"sm:max-w-[520px]",children:[e.jsxs(ve,{children:[e.jsx(we,{className:"text-right",children:"إيصالات الديون"}),e.jsx(us,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),St.length>0?e.jsxs("div",{className:"max-h-64 overflow-y-auto space-y-2",onScroll:t=>{const a=t.currentTarget;Ai.length<St.length&&a.scrollTop+a.clientHeight>=a.scrollHeight-50&&Ii(r=>r+1)},children:[Ai.map(t=>e.jsx("div",{onClick:()=>{Qa(t),Pa(!0),xr(!1),ur(!1)},className:"p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium",children:t.debtorName}),e.jsx("p",{className:"text-sm text-gray-600",children:t.reason}),e.jsx("p",{className:"text-sm text-gray-500",children:Zn.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-lg",children:[t.amount," جنيه"]}),e.jsx(Gt,{variant:t.status==="paid"?"default":"secondary",className:t.status==="paid"?"bg-green-500":"bg-yellow-500",children:t.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},t.id)),Ai.length<St.length&&e.jsx("div",{className:"flex justify-center pt-1",children:e.jsx(h,{variant:"outline",size:"sm",onClick:()=>Ii(t=>t+1),children:"تحميل المزيد"})})]}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"}),e.jsxs(lt,{className:"flex justify-between mt-3",children:[e.jsx(h,{variant:"destructive",onClick:async()=>{try{if(!St||St.length===0){i({title:"لا توجد ديون",description:"القائمة فارغة بالفعل."});return}if(!window.confirm("هل تريد حذف كل إيصالات الديون؟ هذا الإجراء لا يمكن التراجع عنه."))return;const a=[];if(ms(a),Qa(null),await qs(a),s!=null&&s.uid)try{await Se.updateUserData(s.uid,{debts:[],debtsDeletedAt:ct()});try{localStorage.removeItem(`debts_unsynced_${s.uid}`)}catch{}}catch(r){console.error("تعذر حذف الديون من Firebase:",r),i({title:"فشل الحذف من السحابة",description:"تعذر حذف الإيصالات من Firebase، حاول مرة أخرى.",variant:"destructive"});return}i({title:"تم حذف كل إيصالات الديون",description:"تم تفريغ القائمة بالكامل."}),xr(!1)}catch(t){console.error("تعذر حذف كل إيصالات الديون:",t),i({title:"فشل الحذف",description:"حدث خطأ أثناء الحذف، حاول مرة أخرى.",variant:"destructive"})}},children:"حذف كل الإيصالات"}),e.jsx(h,{variant:"outline",onClick:()=>xr(!1),children:"إغلاق"})]})]})}),e.jsx(ye,{open:Vd,onOpenChange:Pi,children:e.jsxs(be,{className:"sm:max-w-[480px]",children:[e.jsxs(ve,{children:[e.jsx(we,{className:"text-right",children:"إضافة عميل"}),e.jsx(us,{className:"text-right",children:"أدخل بيانات العميل ثم يمكنك تسجيل مبلغ دين عليه"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"customerName",className:"text-right col-span-1",children:"اسم العميل"}),e.jsx(q,{id:"customerName",value:_i,onChange:t=>so(t.target.value),className:"col-span-3 text-right",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"customerMobile",className:"text-right col-span-1",children:"رقم الموبايل"}),e.jsx(q,{id:"customerMobile",value:Oi,onChange:t=>ao(t.target.value),className:"col-span-3 text-right",placeholder:"اكتب رقم الموبايل"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!_i||!Oi){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const t={id:Date.now().toString(),name:_i.trim(),mobile:Oi.trim(),createdAt:new Date},a=[t,...Us];await Gi(a),so(""),ao(""),i({title:"تمت إضافة العميل",description:`تم إضافة ${t.name}`})},children:"إضافة"})}),e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx(X,{className:"text-right block",children:"إضافة مبلغ على عميل"}),Us.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(La,{value:Dn,onValueChange:ro,children:[e.jsx(Wa,{className:"w-full",children:e.jsx(Fa,{placeholder:"اختر عميل"})}),e.jsx(Ra,{children:Us.map(t=>e.jsxs(ra,{value:t.id,children:[t.name," — ",t.mobile]},t.id))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"customerDebtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(q,{id:"customerDebtAmount",type:"number",value:no,onChange:t=>Jd(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{className:"bg-orange-600 hover:bg-orange-700",onClick:async()=>{const t=parseFloat(no);if(!Dn){i({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(t)||t<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Us.find(l=>l.id===Dn);if(!a)return;const r={id:Date.now().toString(),debtorName:a.name,customerId:a.id,mobile:a.mobile,amount:Number(t.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};An(r),pr(!0)},children:"إضافة المبلغ"})})]}):e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد عملاء مسجلين. أضف عميلًا أولاً."})]}),e.jsxs("div",{className:"border-t pt-4 space-y-2",children:[e.jsx(X,{className:"text-right block",children:"إدارة العملاء"}),Us.length>0?e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:Us.map(t=>e.jsxs("div",{className:"p-2 border rounded-md flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium text-sm",children:t.name}),e.jsx("div",{className:"text-xs text-gray-600",children:t.mobile})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:()=>{io(t.id),Ei(t.name||""),Mi(t.mobile||""),Cn(!0)},children:"تعديل"}),e.jsx(h,{variant:"destructive",size:"sm",onClick:()=>{$i(t.id),Li(t.name||""),In(!0)},children:"حذف نهائي"})]})]},t.id))}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً."})]})]}),e.jsx(lt,{className:"flex justify-end",children:e.jsx(h,{variant:"outline",onClick:()=>Pi(!1),children:"إغلاق"})})]})}),e.jsx(ye,{open:Hd,onOpenChange:In,children:e.jsxs(be,{hideClose:!0,className:"sm:max-w-[420px] rounded-2xl bg-gradient-to-br from-white via-rose-50 to-red-50 shadow-2xl border border-red-100 text-center",children:[e.jsxs(ve,{children:[e.jsx(we,{className:"text-center text-xl font-bold text-red-700",children:"تأكيد حذف العميل"}),e.jsxs(us,{className:"text-center text-gray-600",children:["سيتم حذف العميل نهائيًا: ",co]})]}),e.jsx("div",{className:"py-2 text-sm text-gray-700",children:"لا يمكن التراجع عن هذا الإجراء."}),e.jsxs(lt,{className:"flex justify-center gap-3",children:[e.jsx(h,{variant:"outline",onClick:()=>{In(!1),$i(""),Li("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",className:"bg-red-600 hover:bg-red-700",onClick:async()=>{const t=Gd,a=Us.filter(r=>r.id!==t);await Gi(a),Dn===t&&ro(""),In(!1),$i(""),Li(""),i({title:"تم حذف العميل",description:co})},children:"حذف نهائي"})]})]})}),e.jsx(ye,{open:Kd,onOpenChange:Cn,children:e.jsxs(be,{className:"sm:max-w-[420px]",children:[e.jsx(ve,{children:e.jsx(we,{className:"text-right",children:"تعديل بيانات العميل"})}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"editCustomerName",className:"text-right col-span-1",children:"الاسم"}),e.jsx(q,{id:"editCustomerName",value:lo,onChange:t=>Ei(t.target.value),className:"col-span-3 text-right"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"editCustomerMobile",className:"text-right col-span-1",children:"الموبايل"}),e.jsx(q,{id:"editCustomerMobile",value:oo,onChange:t=>Mi(t.target.value),className:"col-span-3 text-right"})]})]}),e.jsxs(lt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>Cn(!1),children:"إلغاء"}),e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=Yd,a=lo.trim(),r=oo.trim();if(!t||!a||!r){i({title:"بيانات غير مكتملة",description:"أدخل الاسم ورقم الموبايل",variant:"destructive"});return}const l=Us.map(m=>m.id===t?{...m,name:a,mobile:r}:m);await Gi(l);const o=St.map(m=>m.customerId===t?{...m,debtorName:a,mobile:r}:m);o!==St&&(ms(o),await qs(o)),Cn(!1),io(""),Ei(""),Mi(""),i({title:"تم تحديث العميل",description:a})},children:"حفظ"})]})]})}),e.jsx(ye,{open:ea,onOpenChange:Rt,children:e.jsxs(be,{className:"sm:max-w-[520px]",children:[e.jsxs(ve,{children:[e.jsx(we,{className:"text-right",children:"مصروفات المحل"}),e.jsx(us,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx(q,{id:"expenseName",value:Fs,onChange:t=>Da(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx(q,{id:"expenseAmount",type:"number",value:ts,onChange:t=>_(t.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx(q,{id:"expenseNotes",value:ce,onChange:t=>me(t.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(lt,{className:"flex justify-between",children:[e.jsx(h,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!Fs||!ts){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}rt(!0)},children:"إضافة مصروف"}),e.jsx(h,{variant:"outline",onClick:()=>Ss(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(ye,{open:ss,onOpenChange:Ss,children:e.jsxs(be,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(ve,{children:[e.jsx(we,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(us,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),Ae.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:Ae.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:t.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left flex items-start gap-2",children:[e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[t.amount," جنيه"]}),e.jsx(Gt,{variant:"secondary",className:t.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:t.source==="cash"?"من النقدية":`من المحفظة${t.walletId?` (${t.walletId})`:""}`})]}),e.jsxs(h,{variant:"destructive",size:"sm",className:"shrink-0",onClick:()=>hm(t.id),title:"حذف نهائي",children:[e.jsx(is,{className:"w-4 h-4 ml-1"}),"حذف"]})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(ye,{open:yt,onOpenChange:rt,children:e.jsxs(be,{className:"sm:max-w-[480px]",children:[e.jsx(ve,{children:e.jsx(we,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(h,{variant:z==="cash"?"default":"outline",className:z==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>ke("cash"),children:"الفلوس النقدية"}),e.jsx(h,{variant:z==="wallet"?"default":"outline",className:z==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>ke("wallet"),children:"أرصدة المحافظ"}),e.jsx(h,{variant:z==="fawry"?"default":"outline",className:z==="fawry"?"bg-amber-600 hover:bg-amber-700 text-white":"",onClick:()=>ke("fawry"),children:"فوري"})]}),z==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(La,{value:K,onValueChange:pt,children:[e.jsx(Wa,{className:"w-full",children:e.jsx(Fa,{placeholder:"اختر محفظة"})}),e.jsx(Ra,{children:qe.map(t=>e.jsx(ra,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(lt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>{rt(!1),ke(null),pt("")},children:"إلغاء"}),e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=Number(ts);if(isNaN(t)||t<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!z){i({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(z==="cash"){const o=Number((Pt-t).toFixed(2));Ht(o),localStorage.setItem(Os(),o.toString());const m={cashBalance:o,lastUpdated:new Date().toISOString()},u=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(u,JSON.stringify(m)),s!=null&&s.uid?(await Se.updateUserData(s.uid,m),localStorage.removeItem(u),Xe(!1)):Xe(!0)}else if(z==="wallet"){if(!K){i({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const o=at[K]||0,m=Number((o-t).toFixed(2)),u={...at,[K]:m};ns(u);const g=new Date().toISOString(),S={walletBalances:u,lastUpdated:g},x=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(x,JSON.stringify(S)),localStorage.setItem(Cs(),JSON.stringify(u)),localStorage.setItem(`walletBalances_backup_${g}`,JSON.stringify(u)),s!=null&&s.uid&&await Se.updateUserData(s.uid,S)}}catch(o){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",o)}let a=Date.now().toString();try{if(s!=null&&s.uid){const{addDoc:o,collection:m,serverTimestamp:u}=await Nt(async()=>{const{addDoc:x,collection:f,serverTimestamp:A}=await import("./index-DKHjTn06.js").then(P=>P.bH);return{addDoc:x,collection:f,serverTimestamp:A}},__vite__mapDeps([0,1]),import.meta.url),{db:g}=await Nt(async()=>{const{db:x}=await import("./index-DKHjTn06.js").then(f=>f.bI);return{db:x}},__vite__mapDeps([0,1]),import.meta.url);a=(await o(m(g,"shop_expenses"),{userId:s.uid,shopId:O||(j==null?void 0:j.shopId)||s.uid||"default-shop",name:Fs,amount:t,notes:ce||"",source:z,walletId:z==="wallet"?K:null,createdAt:u()})).id}}catch(o){console.error("خطأ أثناء حفظ المصروف في Firestore:",o)}const r={id:a,name:Fs,amount:t,notes:ce,source:z,walletId:z==="wallet"?K:void 0,createdAt:new Date},l=[...Ae,r];await Io(l),Da(""),_(""),me(""),ke(null),pt(""),rt(!1),Rt(!0),Ss(!0),i({title:"تم إضافة المصروف",description:z==="cash"?"تم الخصم من النقدية":z==="wallet"?"تم الخصم من أرصدة المحافظ":"تم تسجيل الدفع عبر فوري"})},children:"تأكيد الخصم"})]})]})}),e.jsx(ye,{open:ma,onOpenChange:Ca,children:e.jsxs(be,{className:"sm:max-w-[520px]",children:[e.jsxs(ve,{children:[e.jsx(we,{className:"text-right",children:"النواقص"}),e.jsx(us,{className:"text-right",children:"سجل العناصر الناقصة التي تحتاج شراء وتابع حالتها."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"deficiencyName",className:"text-right col-span-1",children:"اسم العنصر"}),e.jsx(q,{id:"deficiencyName",value:la,onChange:t=>U(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: سكر، زيت، مناديل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"deficiencyQuantity",className:"text-right col-span-1",children:"الكمية"}),e.jsx(q,{id:"deficiencyQuantity",type:"number",value:je,onChange:t=>gt(t.target.value),className:"col-span-3 text-right",placeholder:"1"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{className:"bg-rose-600 hover:bg-rose-700",onClick:()=>{if(Dt){i({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}const t=parseInt(je||"1",10);if(!la){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العنصر",variant:"destructive"});return}if(isNaN(t)||t<=0){i({title:"كمية غير صحيحة",description:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}(async()=>{if(s!=null&&s.uid)try{const{collection:r,addDoc:l,serverTimestamp:o}=await Nt(async()=>{const{collection:g,addDoc:S,serverTimestamp:x}=await import("./index-DKHjTn06.js").then(f=>f.bH);return{collection:g,addDoc:S,serverTimestamp:x}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await Nt(async()=>{const{db:g}=await import("./index-DKHjTn06.js").then(S=>S.bI);return{db:g}},__vite__mapDeps([0,1]),import.meta.url),u=await l(r(m,"deficiencies"),{userId:s.uid,shopId:O||(j==null?void 0:j.shopId)||s.uid||"default-shop",name:la,quantity:t,status:"pending",createdAt:o()});try{const g=Ln(),S=localStorage.getItem(g),x=S?JSON.parse(S):[],f=Array.isArray(x)?x:[],A=f.some(H=>String((H==null?void 0:H.id)||"")===u.id),P={id:u.id,name:la,quantity:t,status:"pending",createdAt:new Date().toISOString()},k=A?f:[...f,P];localStorage.setItem(g,JSON.stringify(k))}catch{}U(""),gt(""),i({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"});return}catch(r){console.warn("فشل حفظ النواقص إلى Firestore، سيُستخدم التخزين المحلي:",r)}const a={id:Date.now().toString(),name:la,quantity:t,status:"pending",createdAt:new Date};Kt(r=>{const l=[...r,a];return Hi(l),l}),U(""),gt(""),i({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"})})()},children:"إضافة للنواقص"})}),ut.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:ut.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["الكمية: ",t.quantity]}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Gt,{variant:"secondary",className:t.status==="pending"?"bg-rose-100 text-rose-700":"bg-green-100 text-green-700",children:t.status==="pending"?"قيد الشراء":"تم الشراء"}),e.jsx(h,{variant:"outline",className:t.status==="pending"?"text-green-700 border-green-300 hover:bg-green-50":"text-rose-700 border-rose-300 hover:bg-rose-50",onClick:()=>{(async()=>{const a=t.status==="pending"?"purchased":"pending";if(s!=null&&s.uid)try{const{doc:r,updateDoc:l,serverTimestamp:o}=await Nt(async()=>{const{doc:u,updateDoc:g,serverTimestamp:S}=await import("./index-DKHjTn06.js").then(x=>x.bH);return{doc:u,updateDoc:g,serverTimestamp:S}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await Nt(async()=>{const{db:u}=await import("./index-DKHjTn06.js").then(g=>g.bI);return{db:u}},__vite__mapDeps([0,1]),import.meta.url);await l(r(m,"deficiencies",t.id),{status:a,updatedAt:o()});return}catch(r){console.warn("فشل تحديث حالة النواقص على Firestore، استخدام التخزين المحلي:",r)}Kt(r=>{const l=r.map(o=>o.id===t.id?{...o,status:a}:o);return Hi(l),l})})()},title:t.status==="pending"?"تم الشراء":"إلغاء الشراء",children:t.status==="pending"?"تم الشراء":"إلغاء الشراء"}),e.jsx(h,{variant:"outline",className:"text-red-700 border-red-300 hover:bg-red-50",onClick:()=>{(async()=>{if(s!=null&&s.uid)try{const{doc:a,deleteDoc:r}=await Nt(async()=>{const{doc:o,deleteDoc:m}=await import("./index-DKHjTn06.js").then(u=>u.bH);return{doc:o,deleteDoc:m}},__vite__mapDeps([0,1]),import.meta.url),{db:l}=await Nt(async()=>{const{db:o}=await import("./index-DKHjTn06.js").then(m=>m.bI);return{db:o}},__vite__mapDeps([0,1]),import.meta.url);await r(a(l,"deficiencies",t.id));return}catch(a){console.warn("فشل حذف عنصر النواقص من Firestore، استخدام التخزين المحلي:",a)}Kt(a=>{const r=a.filter(l=>l.id!==t.id);return Hi(r),r})})()},title:"حذف",children:"حذف"})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد عناصر مسجلة في النواقص"})]}),e.jsx(lt,{className:"flex justify-end",children:e.jsx(h,{variant:"outline",onClick:()=>Ca(!1),children:"إغلاق"})})]})}),e.jsx(ye,{open:Qd,onOpenChange:pr,children:e.jsxs(be,{className:"sm:max-w-[480px]",children:[e.jsx(ve,{children:e.jsx(we,{className:"text-right",children:"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(h,{variant:_s==="cash"?"default":"outline",className:_s==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>Or("cash"),children:"الفلوس النقدية"}),e.jsx(h,{variant:_s==="wallet"?"default":"outline",className:_s==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>Or("wallet"),children:"أرصدة المحافظ"}),e.jsx(h,{variant:_s==="none"?"default":"outline",className:_s==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>Or("none"),children:"بدون خصم"})]}),_s==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(La,{value:Tn,onValueChange:Wi,children:[e.jsx(Wa,{className:"w-full",children:e.jsx(Fa,{placeholder:"اختر محفظة"})}),e.jsx(Ra,{children:qe.map(t=>e.jsx(ra,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(lt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>{pr(!1),An(null),Or(null),Wi("")},children:"إلغاء"}),e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=!!Sn&&!ka,a=Number(t?Sn.delta:(ka==null?void 0:ka.amount)||0);if(!_s){i({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(_s==="cash"){const r=Number((Pt-a).toFixed(2));Ht(r),localStorage.setItem(Os(),r.toString());const l=new Date().toISOString(),o={cashBalance:r,lastUpdated:l},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(o)),s!=null&&s.uid?await Se.updateUserData(s.uid,o).then(()=>{localStorage.removeItem(m),Xe(!1)}).catch(()=>{Xe(!0)}):Xe(!0)}else if(_s==="wallet"){if(!Tn){i({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const r=at[Tn]||0,l=Number((r-a).toFixed(2)),o={...at,[Tn]:l};ns(o);const m=new Date().toISOString(),u={walletBalances:o,lastUpdated:m},g=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(g,JSON.stringify(u)),localStorage.setItem(Cs(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${m}`,JSON.stringify(o)),s!=null&&s.uid&&await Se.updateUserData(s.uid,u)}}catch(r){console.error("خطأ أثناء تحديث الأرصدة عند حفظ/تعديل الدين:",r)}if(t){if(!ne)return;const r=Number(ne.amount||0),l=Number(ne.paidAmount||0),o=Number(Sn.delta||0);if(Sn.type==="decrease"){const m=Number((r-o).toFixed(2)),u=l>=m,g={...ne,amount:m,status:u?"paid":"pending"},S=St.map(x=>x.id===ne.id?g:x);ms(S),Qa(g),await qs(S);try{u&&(s!=null&&s.uid)&&(async()=>{const x=Ue(Ne(J,"userTransactions"),ie("userId","==",s.uid),ie("linkedDebtId","==",ne.id),ie("status","==","pending")),f=await Qe(x);await Promise.allSettled(f.docs.map($e=>Zt($e.ref,{status:"completed",confirmedAt:new Date})));try{const $e=f.docs.map(Q=>{var ee;return String(((ee=Q.data())==null?void 0:ee.transactionId)||"")});s!=null&&s.uid&&$e.forEach(Q=>Q&&Se.removeLocalReceiptById(s.uid,Q))}catch{}const A=Ue(Ne(J,"transactions"),ie("userId","==",s.uid),ie("linkedDebtId","==",ne.id),ie("status","==","pending")),P=await Qe(A);await Promise.allSettled(P.docs.map($e=>Zt($e.ref,{status:"completed",confirmedAt:new Date})));try{const $e=P.docs.map(Q=>{var ee;return String(Q.id||((ee=Q.data())==null?void 0:ee.transactionId)||"")});s!=null&&s.uid&&$e.forEach(Q=>Q&&Se.removeLocalReceiptById(s.uid,Q))}catch{}const k=Ue(Ne(J,"transactions"),ie("merchantUserId","==",s.uid),ie("linkedDebtId","==",ne.id),ie("status","==","pending")),H=await Qe(k);await Promise.allSettled(H.docs.map($e=>Zt($e.ref,{status:"completed",confirmedAt:new Date})));try{const $e=H.docs.map(Q=>{var ee;return String(Q.id||((ee=Q.data())==null?void 0:ee.transactionId)||"")});s!=null&&s.uid&&$e.forEach(Q=>Q&&Se.removeLocalReceiptById(s.uid,Q))}catch{}})().catch(x=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين بعد الإنقاص:",x),i({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(x){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة بعد الإنقاص:",x)}i({title:"تم إنقاص المبلغ",description:`المبلغ الجديد: ${m} جنيه`})}else{const m=r+o,u=l>=m,g={...ne,amount:Number(m.toFixed(2)),status:u?"paid":"pending"},S=St.map(x=>x.id===ne.id?g:x);ms(S),Qa(g),await qs(S),i({title:"تم زيادة المبلغ",description:`المبلغ الجديد: ${m} جنيه`})}}else if(ka){const r=[...St,ka];ms(r),await qs(r);try{s!=null&&s.uid&&await sr.send(s.uid,`تم إضافة دين على ${ka.debtorName} بمبلغ ${ka.amount} جنيه`)}catch{}}Yl(""),Hl(""),Gl(""),ur(!1),pr(!1),An(null),Xl(null),Or(null),Wi(""),i({title:t?"تم تطبيق الخصم وتعديل الدين":_s==="none"?"تم حفظ الدين بدون خصم":"تم حفظ الدين وخصم المبلغ",description:_s==="none"?"لم يتم الخصم من الدرج أو المحافظ":_s==="cash"?`تم خصم ${a} من الرصيد النقدي`:`تم خصم ${a} من رصيد المحفظة`})},children:"تأكيد الخصم"})]})]})}),e.jsx(ye,{open:Bd,onOpenChange:Pa,children:e.jsxs(be,{className:"sm:max-w-[425px]",children:[e.jsx(ve,{children:e.jsx(we,{className:"text-right",children:"إيصال الدين"})}),ne&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:Zn.format(ne.createdAt instanceof Date?ne.createdAt:new Date(ne.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:ne.debtorName})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",className:"h-8 w-8 p-0","aria-label":"إنقاص الدين",onClick:()=>{Ql("decrease"),ji(""),Pa(!1),_r(!0)},children:"−"}),e.jsxs("span",{className:"font-bold text-lg",children:[ne.amount," جنيه"]}),e.jsx(h,{variant:"outline",className:"h-8 w-8 p-0","aria-label":"زيادة الدين",onClick:()=>{Ql("increase"),ji(""),Pa(!1),_r(!0)},children:"+"})]})]}),(()=>{try{const t=(Ge||[]).filter(a=>String((a==null?void 0:a.linkedDebtId)||"")===String(ne.id)).reduce((a,r)=>a+Math.max(0,Number((r==null?void 0:r.commission)||0)),0);return t>0?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الربح:"}),e.jsxs("span",{className:"text-green-700 font-semibold",children:[t," جنيه"]})]}):null}catch{return null}})(),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:ne.reason})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(Gt,{variant:ne.status==="paid"?"default":"secondary",className:ne.status==="paid"?"bg-green-500":"bg-yellow-500",children:ne.status==="paid"?"مدفوع":"مؤجل"})]}),(()=>{try{const t=(Ge||[]).filter(S=>String((S==null?void 0:S.linkedDebtId)||"")===String(ne.id)),a=t.reduce((S,x)=>S+Math.max(0,Number((x==null?void 0:x.commission)||0)),0),r=t.reduce((S,x)=>S+Math.max(0,Number(((x==null?void 0:x.sentAmount)??(x==null?void 0:x.transferredAmount)??(x==null?void 0:x.withdrawnAmount)??(x==null?void 0:x.amount))||0)),0),l=Number(ne.amount||0),o=Number(ne.paidAmount||0),u=l<r+a?l+a:l,g=Math.max(0,Number(u)-o);return e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[g," جنيه"]})]})}catch{return e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[Number(ne.amount||0)-Number(ne.paidAmount||0)," جنيه"]})]})}})(),ne.paidAmount?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[ne.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-3 border rounded-lg bg-gray-50",children:[zd?e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx(q,{id:"partialAmount",type:"number",value:eo,onChange:t=>Di(t.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Si(!1),Di("")},children:"إلغاء"}),e.jsx(h,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const t=parseFloat(eo);if(!ne||isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Math.max(0,Number(ne.amount||0)-Number(ne.paidAmount||0));if(t>a){i({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const r=Number(((ne.paidAmount||0)+t).toFixed(2)),l=r>=Number(ne.amount||0),o={...ne,amount:Number(ne.amount||0),paidAmount:r,status:l?"paid":"pending",partialPayments:[...ne.partialPayments||[],{amount:t,paidAt:new Date}]},m=St.map(u=>u.id===ne.id?o:u);ms(m),Qa(o),await qs(m);try{if(s!=null&&s.uid){const u=Math.max(0,Number(o.amount||0)-Number(o.paidAmount||0));await sr.send(s.uid,`تم سداد جزء من دين ${o.debtorName}: المدفوع ${t} جنيه، المتبقي ${u} جنيه`)}}catch{}try{o.status==="paid"&&(s!=null&&s.uid)&&(async()=>{const u=Ue(Ne(J,"userTransactions"),ie("userId","==",s.uid),ie("linkedDebtId","==",ne.id),ie("status","==","pending")),g=await Qe(u);await Promise.allSettled(g.docs.map(P=>Zt(P.ref,{status:"completed",confirmedAt:new Date})));try{const P=g.docs.map(k=>{var H;return String(((H=k.data())==null?void 0:H.transactionId)||"")});s!=null&&s.uid&&P.forEach(k=>k&&Se.removeLocalReceiptById(s.uid,k))}catch{}const S=Ue(Ne(J,"transactions"),ie("userId","==",s.uid),ie("linkedDebtId","==",ne.id),ie("status","==","pending")),x=await Qe(S);await Promise.allSettled(x.docs.map(P=>Zt(P.ref,{status:"completed",confirmedAt:new Date})));try{const P=x.docs.map(k=>{var H;return String(k.id||((H=k.data())==null?void 0:H.transactionId)||"")});s!=null&&s.uid&&P.forEach(k=>k&&Se.removeLocalReceiptById(s.uid,k))}catch{}const f=Ue(Ne(J,"transactions"),ie("merchantUserId","==",s.uid),ie("linkedDebtId","==",ne.id),ie("status","==","pending")),A=await Qe(f);await Promise.allSettled(A.docs.map(P=>Zt(P.ref,{status:"completed",confirmedAt:new Date})));try{const P=A.docs.map(k=>{var H;return String(k.id||((H=k.data())==null?void 0:H.transactionId)||"")});s!=null&&s.uid&&P.forEach(k=>k&&Se.removeLocalReceiptById(s.uid,k))}catch{}})().catch(u=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",u),i({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(u){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",u)}try{const u=Qi(),g=localStorage.getItem(u);if(g){const x=(JSON.parse(g)||[]).map(f=>(f==null?void 0:f.linkedDebtId)===ne.id&&(f==null?void 0:f.status)==="pending"?{...f,status:"completed",confirmedAt:new Date}:f);localStorage.setItem(u,JSON.stringify(x)),ha(f=>f.map(A=>(A==null?void 0:A.linkedDebtId)===ne.id&&(A==null?void 0:A.status)==="pending"?{...A,status:"completed",confirmedAt:new Date}:A))}}catch(u){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",u)}Pn(t),_a("none"),gr(!0),Si(!1),Di(""),i({title:"تم تسجيل دفع جزء",description:`تم دفع ${t} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(h,{variant:"outline",className:"w-full",onClick:()=>Si(!0),children:"دفع جزء"}),ne.partialPayments&&ne.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-24 overflow-y-auto",children:ne.partialPayments.map((t,a)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["دفع: ",t.amount," جنيه"]}),e.jsx("span",{children:new Date(t.paidAt).toLocaleString("ar-EG")})]},a))})]})]})]})]}),e.jsxs(lt,{className:"flex gap-2 justify-center",children:[e.jsx(h,{onClick:async()=>{if(ne){const t=St.map(a=>a.id===ne.id?{...a,status:"pending"}:a);ms(t),await qs(t);try{if(s!=null&&s.uid){const a=computedRemaining;await sr.send(s.uid,`تم سداد الدين بالكامل للعميل ${ne.debtorName}: المدفوع ${a} جنيه`)}}catch{}Pa(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(h,{onClick:async()=>{if(ne){const t=Number(ne.amount||0),a=Number(ne.paidAmount||0);let r=Math.max(0,t-a);try{const m=(Ge||[]).filter(f=>String((f==null?void 0:f.linkedDebtId)||"")===String(ne.id)),u=m.reduce((f,A)=>f+Math.max(0,Number((A==null?void 0:A.commission)||0)),0),g=m.reduce((f,A)=>f+Math.max(0,Number(((A==null?void 0:A.sentAmount)??(A==null?void 0:A.transferredAmount)??(A==null?void 0:A.withdrawnAmount)??(A==null?void 0:A.amount))||0)),0),x=t<g+u?t+u:t;r=Math.max(0,Number(x)-a)}catch{}const l=r,o=St.map(m=>{if(m.id!==ne.id)return m;const u=Number(m.amount||0),g=Number(m.paidAmount||0),S=Number((g+l).toFixed(2)),x=S>=u;return{...m,amount:u,paidAmount:x?u:S,status:"paid",partialPayments:[...m.partialPayments||[],...l>0?[{amount:l,paidAt:new Date}]:[]]}});ms(o);try{Qa(o.find(m=>m.id===ne.id)||null)}catch{}Pn(l),_a("none"),gr(!0),await qs(o);try{s!=null&&s.uid&&(ne!=null&&ne.id)&&(async()=>{const m=Ue(Ne(J,"userTransactions"),ie("userId","==",s.uid),ie("linkedDebtId","==",ne.id),ie("status","==","pending")),u=await Qe(m);await Promise.allSettled(u.docs.map(A=>Zt(A.ref,{status:"completed",confirmedAt:new Date})));try{const A=u.docs.map(P=>{var k;return String(((k=P.data())==null?void 0:k.transactionId)||"")});s!=null&&s.uid&&A.forEach(P=>P&&Se.removeLocalReceiptById(s.uid,P))}catch{}const g=Ue(Ne(J,"transactions"),ie("userId","==",s.uid),ie("linkedDebtId","==",ne.id),ie("status","==","pending")),S=await Qe(g);await Promise.allSettled(S.docs.map(A=>Zt(A.ref,{status:"completed",confirmedAt:new Date})));try{const A=S.docs.map(P=>{var k;return String(P.id||((k=P.data())==null?void 0:k.transactionId)||"")});s!=null&&s.uid&&A.forEach(P=>P&&Se.removeLocalReceiptById(s.uid,P))}catch{}const x=Ue(Ne(J,"transactions"),ie("merchantUserId","==",s.uid),ie("linkedDebtId","==",ne.id),ie("status","==","pending")),f=await Qe(x);await Promise.allSettled(f.docs.map(A=>Zt(A.ref,{status:"completed",confirmedAt:new Date})));try{const A=f.docs.map(P=>{var k;return String(P.id||((k=P.data())==null?void 0:k.transactionId)||"")});s!=null&&s.uid&&A.forEach(P=>P&&Se.removeLocalReceiptById(s.uid,P))}catch{}})().catch(m=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",m),i({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(m){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",m)}try{const m=Qi(),u=localStorage.getItem(m);if(u){const S=(JSON.parse(u)||[]).map(x=>(x==null?void 0:x.linkedDebtId)===ne.id&&(x==null?void 0:x.status)==="pending"?{...x,status:"completed",confirmedAt:new Date}:x);localStorage.setItem(m,JSON.stringify(S)),ha(x=>x.map(f=>(f==null?void 0:f.linkedDebtId)===ne.id&&(f==null?void 0:f.status)==="pending"?{...f,status:"completed",confirmedAt:new Date}:f))}}catch(m){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",m)}Pa(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(h,{onClick:async()=>{if(ne){const t=St.filter(a=>a.id!==ne.id);ms(t),await qs(t),Pa(!1),i({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(ye,{open:Ud,onOpenChange:_r,children:e.jsxs(be,{className:"sm:max-w-md rounded-2xl shadow-elegant border border-gray-200",children:[e.jsxs(ve,{children:[e.jsx(we,{className:`text-right ${Za==="decrease"?"text-red-600":"text-green-600"}`,children:Za==="decrease"?"إنقاص مبلغ الدين":Za==="increase"?"زيادة مبلغ الدين":"تعديل مبلغ الدين"}),e.jsxs(us,{className:"text-right",children:["أدخل المبلغ ثم اضغط تأكيد لإتمام ",Za==="decrease"?"الإنقاص":"الزيادة","."]})]}),e.jsxs("div",{className:"grid gap-4 py-2",children:[e.jsx(X,{htmlFor:"debtAdjustAmount",className:"text-right",children:"المبلغ (جنيه)"}),e.jsx(q,{id:"debtAdjustAmount",type:"number",placeholder:"0.00",value:Zl,onChange:t=>ji(t.target.value)}),ne&&e.jsxs("div",{className:"text-right text-sm text-muted-foreground",children:["المبلغ الحالي: ",e.jsx("span",{className:"font-semibold",children:Number(ne.amount||0).toFixed(2)})," جنيه"]})]}),e.jsxs(lt,{className:"flex gap-2",children:[e.jsx(h,{variant:"secondary",onClick:()=>{_r(!1),Pa(!0)},children:"إلغاء"}),e.jsx(h,{className:Za==="decrease"?"bg-red-600 hover:bg-red-700":"bg-green-600 hover:bg-green-700",onClick:async()=>{try{if(!ne||!Za)return;const t=Number(parseFloat(Zl||"0").toFixed(2));if(!t||isNaN(t)||t<=0){i({title:"قيمة غير صالحة",description:"يرجى إدخال مبلغ أكبر من صفر",variant:"destructive"});return}Xl({debtId:ne.id,delta:t,type:Za}),_r(!1),pr(!0)}catch(t){console.error("فشل تجهيز تعديل مبلغ الدين:",t),i({title:"خطأ",description:"تعذّر تجهيز تعديل مبلغ الدين",variant:"destructive"})}},children:"تأكيد"})]})]})}),e.jsx(ye,{open:Zd,onOpenChange:gr,children:e.jsxs(be,{className:"sm:max-w-[480px]",children:[e.jsxs(ve,{children:[e.jsx(we,{className:"text-right",children:"اختيار إضافة مبلغ السداد"}),e.jsx(us,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 justify-center",children:[e.jsx(h,{variant:zs==="cash"?"default":"outline",className:zs==="cash"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>_a("cash"),children:"الفلوس النقدية"}),e.jsx(h,{variant:zs==="wallet"?"default":"outline",className:zs==="wallet"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>_a("wallet"),children:"أرصدة المحافظ"}),e.jsx(h,{variant:zs==="fawry"?"default":"outline",className:zs==="fawry"?"bg-amber-600 text-white":"",size:"sm",onClick:()=>_a("fawry"),children:"فوري"}),e.jsx(h,{variant:zs==="none"?"default":"outline",className:zs==="none"?"bg-gray-600 text-white":"",size:"sm",onClick:()=>_a("none"),children:"بدون إضافة"})]}),zs==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:Xa,onChange:t=>Fi(t.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),qe&&qe.length>0?qe.map(t=>e.jsx("option",{value:t.id,children:t.phone||t.name||t.id},t.id)):Object.keys(at||{}).map(t=>{var a,r,l,o,m,u;return e.jsx("option",{value:t,children:((a=qe.find(g=>g.id===t))==null?void 0:a.phone)||((l=(r=JSON.parse(localStorage.getItem(Zi())||"[]"))==null?void 0:r.find(g=>g.id===t))==null?void 0:l.phone)||((m=(o=JSON.parse(localStorage.getItem(Zi())||"[]"))==null?void 0:o.find(g=>g.id===t))==null?void 0:m.name)||((u=qe.find(g=>g.id===t))==null?void 0:u.name)||t},t)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[mo," جنيه"]})]})]}),e.jsxs(lt,{className:"flex flex-wrap justify-between gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{gr(!1),Pn(0),_a(null),Fi("")},children:"إلغاء"}),e.jsx(h,{onClick:async()=>{var t,a;try{const r=mo;if(!r||r<=0){gr(!1);return}if(zs==="cash"){const l=Pt+r;Ht(l),localStorage.setItem(Os(),l.toString());const o={cashBalance:l,lastUpdated:new Date().toISOString()},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(o)),s!=null&&s.uid?(Se.updateUserData(s.uid,o).catch(()=>Xe(!0)),localStorage.removeItem(m),Xe(!1)):Xe(!0),i({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى الفلوس النقدية`})}else if(zs==="wallet"){if(!Xa){i({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const l={...at,[Xa]:(at[Xa]||0)+r};ns(l);const o=(Pt||0)-r;Ht(o),localStorage.setItem(Os(),o.toString());const m=new Date().toISOString(),u={walletBalances:l,cashBalance:o,lastUpdated:m},g=`userData_${s==null?void 0:s.uid}`;if(localStorage.setItem(g,JSON.stringify(u)),localStorage.setItem(Cs(),JSON.stringify(l)),localStorage.setItem(`walletBalances_backup_${m}`,JSON.stringify(l)),s!=null&&s.uid){Se.updateUserData(s.uid,u).catch(()=>Xe(!0));try{localStorage.removeItem(g)}catch{}Xe(!1)}else Xe(!0);i({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى المحفظة ${((t=qe.find(S=>S.id===Xa))==null?void 0:t.phone)||((a=qe.find(S=>S.id===Xa))==null?void 0:a.name)||Xa} وتم خصم نفس المبلغ من درج النقدية`})}else if(zs==="none"){i({title:"تم تسجيل السداد",description:`تم تسجيل ${r} جنيه بدون تعديل الأرصدة`});try{if(ne){const l=St.map(o=>o.id===ne.id?{...o,status:"paid",paidAmount:Math.max(Number(o.paidAmount||0),Number(o.amount||0))}:o);ms(l);try{Qa(l.find(o=>o.id===ne.id)||null)}catch{}try{await qs(l)}catch{}}}catch{}}else if(zs==="fawry")i({title:"تم تسجيل سداد عبر فوري",description:`تم تسجيل ${r} جنيه كسداد عبر فوري بدون تعديل الأرصدة`});else{i({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}try{const l=r>0?r:Number((ne==null?void 0:ne.amount)||0);s!=null&&s.uid&&ne&&await sr.send(s.uid,`تم سداد الدين بالكامل للعميل ${ne.debtorName}: المدفوع ${l} جنيه`)}catch{}}catch(r){console.error("خطأ أثناء إضافة مبلغ السداد:",r),i({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{gr(!1),Pn(0),_a(null),Fi("");try{xr(!0)}catch{}}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(ye,{open:fd,onOpenChange:Ha,children:e.jsxs(be,{hideClose:!0,className:"post-confirm-card sm:max-w-[420px] w-[90vw] rounded-2xl bg-gradient-to-br from-white via-indigo-50 to-blue-50 shadow-2xl border border-indigo-100",children:[e.jsxs(ve,{children:[e.jsx(we,{className:"text-right text-2xl font-bold",children:(rs==null?void 0:rs.type)==="transfer"?"مبلغ يجب استلامه":"مبلغ يجب تسليمه"}),e.jsx(us,{className:"text-right text-gray-600",children:(rs==null?void 0:rs.type)==="transfer"?"هذا هو المبلغ الواجب استلامه من العميل بعد التأكيد.":"هذا هو المبلغ الواجب تسليمه للعميل بعد التأكيد."})]}),e.jsxs("div",{className:"py-3 flex flex-col items-center gap-1.5",children:[e.jsxs("div",{className:"text-xl sm:text-2xl font-bold text-blue-700 tracking-wide",children:[Ns((rs==null?void 0:rs.amount)||0)," جنيه"]}),e.jsx("div",{className:"text-sm text-gray-500 text-right w-full",children:(rs==null?void 0:rs.type)==="transfer"?"المبلغ المعروض شامل عمولة التحويل.":wt?"العمولة مضافة ولا تؤثر على قيمة التسليم.":"العمولة مخصومة من المبلغ المسلّم للعميل."})]}),e.jsxs(lt,{className:"flex justify-end gap-2",children:[(rs==null?void 0:rs.type)==="transfer"&&e.jsx(h,{variant:"outline",id:"sendCodeBtn",onClick:es,disabled:Ll,className:"btn-transfer-confirm",children:Ll?"جارٍ الإرسال...":"إرسال كود التحويل"}),e.jsx(h,{onClick:()=>{Ha(!1),pi(null)},className:"bg-green-600 hover:bg-green-700 text-white",children:(rs==null?void 0:rs.type)==="transfer"?"تم الاستلام":"تم التسليم"})]})]})}),e.jsx(Mh,{open:bd,onClose:()=>hr(!1),onSubmit:os,deviceId:Wl||F||"",recipientMsisdn:String(re==="transfer"?(ks==null?void 0:ks.receiver)||gs||"":((Ho=qe.find(t=>t.id===D))==null?void 0:Ho.phone)||"").replace(/\D/g,"")}),e.jsx(Pu,{open:W,onOpenChange:ge}),Fl]}))};export{Lx as default};
//# sourceMappingURL=UserDashboardPage-B-nZi7Q8.js.map
