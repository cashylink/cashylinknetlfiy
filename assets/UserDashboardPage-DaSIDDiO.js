const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-DA5EGBVC.js","./index-C-FbHbUs.css","./dailyOperationCountService-OwwPy0KH.js","./profitService-CQSlHJ0c.js"])))=>i.map(i=>d[i]);
var nu=Object.defineProperty;var Kc=r=>{throw TypeError(r)};var iu=(r,m,o)=>m in r?nu(r,m,{enumerable:!0,configurable:!0,writable:!0,value:o}):r[m]=o;var Ul=(r,m,o)=>iu(r,typeof m!="symbol"?m+"":m,o),zl=(r,m,o)=>m.has(r)||Kc("Cannot "+o);var de=(r,m,o)=>(zl(r,m,"read from private field"),o?o.call(r):m.get(r)),Ts=(r,m,o)=>m.has(r)?Kc("Cannot add the same private member more than once"):m instanceof WeakSet?m.add(r):m.set(r,o),Jt=(r,m,o,f)=>(zl(r,m,"write to private field"),f?f.call(r,o):m.set(r,o),o),ls=(r,m,o)=>(zl(r,m,"access private method"),o);import{H as ua,bm as lu,bn as Yc,bo as ya,bp as Hl,bq as In,br as Ql,bs as Gl,bt as Hc,bu as ou,bv as Si,bw as cu,bx as du,by as Qc,bz as gd,r as i,bA as mu,bB as fd,m as yd,n as bd,u as Ca,c as xa,j as e,V as Te,W as Pe,X as ke,Y as _e,B as x,aq as ba,as as _n,bC as Oi,au as ma,bD as Gc,ac as An,P as Fa,z as ea,a as vd,v as Ht,ar as gs,I as V,an as wd,aw as Ti,_ as wt,bE as yr,U as Tn,A as hu,R as He,E as _s,t as br,aW as xr,G as ze,i as q,F as ia,s as bt,f as Wr,bF as ur,J as Sa,q as Ye,h as je,av as he,k as et,$ as Nd,ak as zs,bG as uu,ay as Ps,Z as xt,ag as Pi,p as ha,ae as Mn,b2 as Ei,a1 as Ce,l as bn,bH as Za,at as co,K as Yt,bj as qs,bI as jd,bJ as xu,bK as pu,a7 as Sd,bL as gu,a2 as fu,bM as yu,a6 as bu,bN as vu,bO as wu,bP as Nu,bQ as Dd,bR as ju,bS as Su,Q as vr,bT as Cd,a0 as Ls,b1 as Zc,b7 as Id,bU as Du,af as Cu,bV as vn,x as Iu,bW as wn,am as Au,ai as Nn,b5 as Tu,b6 as Pu,bf as Xc,aS as Di,be as ed,bX as ku,b4 as jn,bY as td,b0 as _u,bZ as Ou}from"./index-DA5EGBVC.js";import{C as Ut,a as vs,b as Vs,d as qt}from"./card-BDAHS7kE.js";import{B as bs}from"./badge-C7RoQRV3.js";import{S as Xa,a as er,b as tr,c as sr,d as fa,C as Pn,e as Ii}from"./select-D-ueobad.js";import{L as se}from"./label-DGcgSfhx.js";import{M as fs,a as ks,P as Eu}from"./MasterPinDialog-BLejEjf9.js";import{W as Da}from"./wallet-FJyN6gHk.js";import{a as Ad,C as ki,S as Mu}from"./star-Ck9eli2r.js";import{S as Td}from"./square-pen-BlBi0wqZ.js";import{T as ys,P as sd}from"./progress-DQPJPvXg.js";import{P as $a}from"./phone-BPnjQDX1.js";import{A as Pd}from"./arrow-left-DthGIAIu.js";import{C as ir,a as Zl,S as Ru}from"./separator-DidRjMgH.js";import{D as es,A as Br}from"./dollar-sign-B2riGpcX.js";import{A as Ci,P as Lu}from"./ProfileIcon-B58wAJLW.js";import{C as wr}from"./circle-alert-CRivym9p.js";import{C as kd}from"./circle-x-7MF1caut.js";import{C as zr}from"./circle-check-big-HJ3q8vm4.js";import{f as ta,P as $u,C as _d,A as mo,a as ad,I as Fu,b as rd,R as Wu,c as Bu,M as Uu}from"./MaintenanceDialog-OCrzmwZQ.js";import{S as Od}from"./store-B6E9c70J.js";import{S as zu}from"./switch-CtqW1fNM.js";import{a as qu,E as Vu}from"./broadcastService--y5MBKLO.js";import{B as nd,T as Ju}from"./textarea-Cq06RRRe.js";import{D as Ku,a as Yu,b as Hu,c as Qu,d as Gu}from"./dropdown-menu-D24DgyTC.js";import{ProfitService as ar}from"./profitService-CQSlHJ0c.js";import{W as Zu}from"./WalletsManagement-boHxi1vH.js";import{FreeTrialService as Xu}from"./freeTrialService-C0LuPwO4.js";import{P as ex,w as tx}from"./walletSelectionPinService-BWin8Wb1.js";import{C as sx}from"./crown-CqXB_1jY.js";import{R as ax}from"./refresh-cw-Cl57Ej0r.js";import"./whatsappService-DQcCuiwn.js";import"./download-BSxes68N.js";import"./index-CPuDqvZm.js";/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rx=[["path",{d:"m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526",key:"1yiouv"}],["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}]],nx=ua("award",rx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ix=[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]],id=ua("banknote",ix);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lx=[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]],ox=ua("book-open",lx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cx=[["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M9 22v-3a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3",key:"cabbwy"}],["rect",{x:"4",y:"2",width:"16",height:"20",rx:"2",key:"1uxh74"}]],Ed=ua("building",cx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const dx=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]],ld=ua("calendar-days",dx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mx=[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]],_i=ua("id-card",mx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hx=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],Xl=ua("info",hx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ux=[["path",{d:"M13 5h8",key:"a7qcls"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 19h8",key:"c3s6r1"}],["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}]],ql=ua("list-checks",ux);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xx=[["path",{d:"M2 6h4",key:"aawbzj"}],["path",{d:"M2 10h4",key:"l0bgd4"}],["path",{d:"M2 14h4",key:"1gsvsf"}],["path",{d:"M2 18h4",key:"1bu2t1"}],["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["path",{d:"M16 2v20",key:"rotuqe"}]],px=ua("notebook",xx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gx=[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["polyline",{points:"3.29 7 12 12 20.71 7",key:"ousv84"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]],Dn=ua("package",gx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fx=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],yx=ua("send",fx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bx=[["path",{d:"M16 17h6v-6",key:"t6n2it"}],["path",{d:"m22 17-8.5-8.5-5 5L2 7",key:"x473p"}]],Ai=ua("trending-down",bx);var Xs,yt,On,Us,pr,Vr,La,rr,En,Jr,Kr,gr,fr,nr,Yr,_t,Cn,eo,to,so,ao,ro,no,io,Md,pd,vx=(pd=class extends lu{constructor(m,o){super();Ts(this,_t);Ts(this,Xs);Ts(this,yt);Ts(this,On);Ts(this,Us);Ts(this,pr);Ts(this,Vr);Ts(this,La);Ts(this,rr);Ts(this,En);Ts(this,Jr);Ts(this,Kr);Ts(this,gr);Ts(this,fr);Ts(this,nr);Ts(this,Yr,new Set);this.options=o,Jt(this,Xs,m),Jt(this,rr,null),Jt(this,La,Yc()),this.bindMethods(),this.setOptions(o)}bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(de(this,yt).addObserver(this),od(de(this,yt),this.options)?ls(this,_t,Cn).call(this):this.updateResult(),ls(this,_t,ao).call(this))}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return lo(de(this,yt),this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return lo(de(this,yt),this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,ls(this,_t,ro).call(this),ls(this,_t,no).call(this),de(this,yt).removeObserver(this)}setOptions(m){const o=this.options,f=de(this,yt);if(this.options=de(this,Xs).defaultQueryOptions(m),this.options.enabled!==void 0&&typeof this.options.enabled!="boolean"&&typeof this.options.enabled!="function"&&typeof ya(this.options.enabled,de(this,yt))!="boolean")throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");ls(this,_t,io).call(this),de(this,yt).setOptions(this.options),o._defaulted&&!Hl(this.options,o)&&de(this,Xs).getQueryCache().notify({type:"observerOptionsUpdated",query:de(this,yt),observer:this});const N=this.hasListeners();N&&cd(de(this,yt),f,this.options,o)&&ls(this,_t,Cn).call(this),this.updateResult(),N&&(de(this,yt)!==f||ya(this.options.enabled,de(this,yt))!==ya(o.enabled,de(this,yt))||In(this.options.staleTime,de(this,yt))!==In(o.staleTime,de(this,yt)))&&ls(this,_t,eo).call(this);const D=ls(this,_t,to).call(this);N&&(de(this,yt)!==f||ya(this.options.enabled,de(this,yt))!==ya(o.enabled,de(this,yt))||D!==de(this,nr))&&ls(this,_t,so).call(this,D)}getOptimisticResult(m){const o=de(this,Xs).getQueryCache().build(de(this,Xs),m),f=this.createResult(o,m);return Nx(this,f)&&(Jt(this,Us,f),Jt(this,Vr,this.options),Jt(this,pr,de(this,yt).state)),f}getCurrentResult(){return de(this,Us)}trackResult(m,o){return new Proxy(m,{get:(f,N)=>(this.trackProp(N),o==null||o(N),N==="promise"&&(this.trackProp("data"),!this.options.experimental_prefetchInRender&&de(this,La).status==="pending"&&de(this,La).reject(new Error("experimental_prefetchInRender feature flag is not enabled"))),Reflect.get(f,N))})}trackProp(m){de(this,Yr).add(m)}getCurrentQuery(){return de(this,yt)}refetch({...m}={}){return this.fetch({...m})}fetchOptimistic(m){const o=de(this,Xs).defaultQueryOptions(m),f=de(this,Xs).getQueryCache().build(de(this,Xs),o);return f.fetch().then(()=>this.createResult(f,o))}fetch(m){return ls(this,_t,Cn).call(this,{...m,cancelRefetch:m.cancelRefetch??!0}).then(()=>(this.updateResult(),de(this,Us)))}createResult(m,o){var ve;const f=de(this,yt),N=this.options,D=de(this,Us),t=de(this,pr),S=de(this,Vr),C=m!==f?m.state:de(this,On),{state:L}=m;let k={...L},y=!1,w;if(o._optimisticResults){const ae=this.hasListeners(),Be=!ae&&od(m,o),qe=ae&&cd(m,f,o,N);(Be||qe)&&(k={...k,...du(L.data,m.options)}),o._optimisticResults==="isRestoring"&&(k.fetchStatus="idle")}let{error:_,errorUpdatedAt:Q,status:E}=k;w=k.data;let Y=!1;if(o.placeholderData!==void 0&&w===void 0&&E==="pending"){let ae;D!=null&&D.isPlaceholderData&&o.placeholderData===(S==null?void 0:S.placeholderData)?(ae=D.data,Y=!0):ae=typeof o.placeholderData=="function"?o.placeholderData((ve=de(this,Kr))==null?void 0:ve.state.data,de(this,Kr)):o.placeholderData,ae!==void 0&&(E="success",w=Qc(D==null?void 0:D.data,ae,o),y=!0)}if(o.select&&w!==void 0&&!Y)if(D&&w===(t==null?void 0:t.data)&&o.select===de(this,En))w=de(this,Jr);else try{Jt(this,En,o.select),w=o.select(w),w=Qc(D==null?void 0:D.data,w,o),Jt(this,Jr,w),Jt(this,rr,null)}catch(ae){Jt(this,rr,ae)}de(this,rr)&&(_=de(this,rr),w=de(this,Jr),Q=Date.now(),E="error");const ie=k.fetchStatus==="fetching",me=E==="pending",M=E==="error",F=me&&ie,le=w!==void 0,ue={status:E,fetchStatus:k.fetchStatus,isPending:me,isSuccess:E==="success",isError:M,isInitialLoading:F,isLoading:F,data:w,dataUpdatedAt:k.dataUpdatedAt,error:_,errorUpdatedAt:Q,failureCount:k.fetchFailureCount,failureReason:k.fetchFailureReason,errorUpdateCount:k.errorUpdateCount,isFetched:k.dataUpdateCount>0||k.errorUpdateCount>0,isFetchedAfterMount:k.dataUpdateCount>C.dataUpdateCount||k.errorUpdateCount>C.errorUpdateCount,isFetching:ie,isRefetching:ie&&!me,isLoadingError:M&&!le,isPaused:k.fetchStatus==="paused",isPlaceholderData:y,isRefetchError:M&&le,isStale:ho(m,o),refetch:this.refetch,promise:de(this,La),isEnabled:ya(o.enabled,m)!==!1};if(this.options.experimental_prefetchInRender){const ae=$e=>{ue.status==="error"?$e.reject(ue.error):ue.data!==void 0&&$e.resolve(ue.data)},Be=()=>{const $e=Jt(this,La,ue.promise=Yc());ae($e)},qe=de(this,La);switch(qe.status){case"pending":m.queryHash===f.queryHash&&ae(qe);break;case"fulfilled":(ue.status==="error"||ue.data!==qe.value)&&Be();break;case"rejected":(ue.status!=="error"||ue.error!==qe.reason)&&Be();break}}return ue}updateResult(){const m=de(this,Us),o=this.createResult(de(this,yt),this.options);if(Jt(this,pr,de(this,yt).state),Jt(this,Vr,this.options),de(this,pr).data!==void 0&&Jt(this,Kr,de(this,yt)),Hl(o,m))return;Jt(this,Us,o);const f=()=>{if(!m)return!0;const{notifyOnChangeProps:N}=this.options,D=typeof N=="function"?N():N;if(D==="all"||!D&&!de(this,Yr).size)return!0;const t=new Set(D??de(this,Yr));return this.options.throwOnError&&t.add("error"),Object.keys(de(this,Us)).some(S=>{const R=S;return de(this,Us)[R]!==m[R]&&t.has(R)})};ls(this,_t,Md).call(this,{listeners:f()})}onQueryUpdate(){this.updateResult(),this.hasListeners()&&ls(this,_t,ao).call(this)}},Xs=new WeakMap,yt=new WeakMap,On=new WeakMap,Us=new WeakMap,pr=new WeakMap,Vr=new WeakMap,La=new WeakMap,rr=new WeakMap,En=new WeakMap,Jr=new WeakMap,Kr=new WeakMap,gr=new WeakMap,fr=new WeakMap,nr=new WeakMap,Yr=new WeakMap,_t=new WeakSet,Cn=function(m){ls(this,_t,io).call(this);let o=de(this,yt).fetch(this.options,m);return m!=null&&m.throwOnError||(o=o.catch(Ql)),o},eo=function(){ls(this,_t,ro).call(this);const m=In(this.options.staleTime,de(this,yt));if(Gl||de(this,Us).isStale||!Hc(m))return;const f=ou(de(this,Us).dataUpdatedAt,m)+1;Jt(this,gr,Si.setTimeout(()=>{de(this,Us).isStale||this.updateResult()},f))},to=function(){return(typeof this.options.refetchInterval=="function"?this.options.refetchInterval(de(this,yt)):this.options.refetchInterval)??!1},so=function(m){ls(this,_t,no).call(this),Jt(this,nr,m),!(Gl||ya(this.options.enabled,de(this,yt))===!1||!Hc(de(this,nr))||de(this,nr)===0)&&Jt(this,fr,Si.setInterval(()=>{(this.options.refetchIntervalInBackground||cu.isFocused())&&ls(this,_t,Cn).call(this)},de(this,nr)))},ao=function(){ls(this,_t,eo).call(this),ls(this,_t,so).call(this,ls(this,_t,to).call(this))},ro=function(){de(this,gr)&&(Si.clearTimeout(de(this,gr)),Jt(this,gr,void 0))},no=function(){de(this,fr)&&(Si.clearInterval(de(this,fr)),Jt(this,fr,void 0))},io=function(){const m=de(this,Xs).getQueryCache().build(de(this,Xs),this.options);if(m===de(this,yt))return;const o=de(this,yt);Jt(this,yt,m),Jt(this,On,m.state),this.hasListeners()&&(o==null||o.removeObserver(this),m.addObserver(this))},Md=function(m){gd.batch(()=>{m.listeners&&this.listeners.forEach(o=>{o(de(this,Us))}),de(this,Xs).getQueryCache().notify({query:de(this,yt),type:"observerResultsUpdated"})})},pd);function wx(r,m){return ya(m.enabled,r)!==!1&&r.state.data===void 0&&!(r.state.status==="error"&&m.retryOnMount===!1)}function od(r,m){return wx(r,m)||r.state.data!==void 0&&lo(r,m,m.refetchOnMount)}function lo(r,m,o){if(ya(m.enabled,r)!==!1&&In(m.staleTime,r)!=="static"){const f=typeof o=="function"?o(r):o;return f==="always"||f!==!1&&ho(r,m)}return!1}function cd(r,m,o,f){return(r!==m||ya(f.enabled,r)===!1)&&(!o.suspense||r.state.status!=="error")&&ho(r,o)}function ho(r,m){return ya(m.enabled,r)!==!1&&r.isStaleByTime(In(m.staleTime,r))}function Nx(r,m){return!Hl(r.getCurrentResult(),m)}var Rd=i.createContext(!1),jx=()=>i.useContext(Rd);Rd.Provider;function Sx(){let r=!1;return{clearReset:()=>{r=!1},reset:()=>{r=!0},isReset:()=>r}}var Dx=i.createContext(Sx()),Cx=()=>i.useContext(Dx),Ix=(r,m)=>{(r.suspense||r.throwOnError||r.experimental_prefetchInRender)&&(m.isReset()||(r.retryOnMount=!1))},Ax=r=>{i.useEffect(()=>{r.clearReset()},[r])},Tx=({result:r,errorResetBoundary:m,throwOnError:o,query:f,suspense:N})=>r.isError&&!m.isReset()&&!r.isFetching&&f&&(N&&r.data===void 0||mu(o,[r.error,f])),Px=r=>{if(r.suspense){const o=N=>N==="static"?N:Math.max(N??1e3,1e3),f=r.staleTime;r.staleTime=typeof f=="function"?(...N)=>o(f(...N)):o(f),typeof r.gcTime=="number"&&(r.gcTime=Math.max(r.gcTime,1e3))}},kx=(r,m)=>r.isLoading&&r.isFetching&&!m,_x=(r,m)=>(r==null?void 0:r.suspense)&&m.isPending,dd=(r,m,o)=>m.fetchOptimistic(r).catch(()=>{o.clearReset()});function Ox(r,m,o){var k,y,w,_,Q;const f=jx(),N=Cx(),D=fd(),t=D.defaultQueryOptions(r);(y=(k=D.getDefaultOptions().queries)==null?void 0:k._experimental_beforeQuery)==null||y.call(k,t),t._optimisticResults=f?"isRestoring":"optimistic",Px(t),Ix(t,N),Ax(N);const S=!D.getQueryCache().get(t.queryHash),[R]=i.useState(()=>new m(D,t)),C=R.getOptimisticResult(t),L=!f&&r.subscribed!==!1;if(i.useSyncExternalStore(i.useCallback(E=>{const Y=L?R.subscribe(gd.batchCalls(E)):Ql;return R.updateResult(),Y},[R,L]),()=>R.getCurrentResult(),()=>R.getCurrentResult()),i.useEffect(()=>{R.setOptions(t)},[t,R]),_x(t,C))throw dd(t,R,N);if(Tx({result:C,errorResetBoundary:N,throwOnError:t.throwOnError,query:D.getQueryCache().get(t.queryHash),suspense:t.suspense}))throw C.error;if((_=(w=D.getDefaultOptions().queries)==null?void 0:w._experimental_afterQuery)==null||_.call(w,t,C),t.experimental_prefetchInRender&&!Gl&&kx(C,f)){const E=S?dd(t,R,N):(Q=D.getQueryCache().get(t.queryHash))==null?void 0:Q.promise;E==null||E.catch(Ql).finally(()=>{R.updateResult()})}return t.notifyOnChangeProps?C:R.trackResult(C)}function md(r,m){return Ox(r,vx)}const Ld=async(r={})=>{try{return(await yd(bd,"getLastTransactions")(r)).data}catch(m){throw console.error("Error getting last transactions:",m),m.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):m.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+m.message):m.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+m.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(m.message||"خطأ غير معروف"))}},Ex=async r=>(await yd(bd,"sendTelegramMessage")(r)).data,Mx=Object.freeze(Object.defineProperty({__proto__:null,getLastTransactions:Ld,sendTelegramMessage:Ex},Symbol.toStringTag,{value:"Module"})),Rx=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Lx=({isOpen:r,onClose:m,onWalletSelect:o,onEditWallet:f,onDeleteWallet:N})=>{const{user:D}=Ca(),[t,S]=i.useState([]),[R,C]=i.useState(!1),[L,k]=i.useState([]),[y,w]=i.useState(!1),{toast:_}=xa(),Q=async(M,F)=>{const le=new Date().getMonth(),Ee=new Date().getFullYear(),ue=F.filter($e=>{const Qe=new Date($e.createdAt);return Qe.getMonth()===le&&Qe.getFullYear()===Ee&&($e.lineId===M||$e.fromWallet===M)}),ve=$e=>{const Qe=$e.type;return $e.txnType==="receive"||Qe==="withdraw"||Qe==="withdrawal"||Qe==="receive"},ae=$e=>{const Qe=$e.type;return $e.txnType==="send"||Qe==="send"||Qe==="transfer"},Be=ue.filter(ve).reduce(($e,Qe)=>{const Ge=Qe.withdrawnAmount!==void 0?Qe.withdrawnAmount:Qe.amount;return $e+(Ge||0)},0),qe=ue.filter(ae).reduce(($e,Qe)=>{const Ge=Qe.sentAmount!==void 0?Qe.sentAmount:Qe.amount;return $e+(Ge||0)},0);return{withdrawalUsage:Be,transferUsage:qe}},E=M=>{const F=new Date().toISOString().split("T")[0],le=M.lastResetDate;if(!le)return{...M,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:F};const Ee=new Date(le),ue=new Date;return Ee.getMonth()!==ue.getMonth()||Ee.getFullYear()!==ue.getFullYear()?{...M,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:F}:M};i.useEffect(()=>{if(!(D!=null&&D.uid)||!r)return;(async()=>{w(!0);try{const F=await ba.getByMerchantId(D.uid),le=await Oi.getByUserId(D.uid),ue=(await Promise.all(F.map(async ve=>{const{withdrawalUsage:ae,transferUsage:Be}=await Q(ve.id,le),qe=await ma.getWalletLimits(ve.id);return{id:ve.id,name:ve.label||"محفظة بدون اسم",phone:ve.msisdn,nationalId:ve.nationalId||"",isDefault:!1,isActive:ve.isActive===!0,monthlyWithdrawalLimit:(qe==null?void 0:qe.monthlyWithdrawLimit)??ve.withdrawLimit??2e5,monthlyTransferLimit:(qe==null?void 0:qe.monthlyTransferLimit)??ve.transferLimit??2e5,monthlyWithdrawalUsage:(qe==null?void 0:qe.monthlyWithdrawUsed)??ae??0,monthlyTransferUsage:(qe==null?void 0:qe.monthlyTransferUsed)??Be??0,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:ve.walletProvider||""}}))).map(E);S(ue)}catch(F){console.error("Error loading wallets:",F),_({title:"فشل جلب بيانات المحافظ",description:"قد تكون المشكلة بسبب الصلاحيات أو الاتصال. سيتم عرض البيانات المحلية إن وُجدت. جرّب تسجيل الدخول مجددًا أو افتح صفحة اختبار المصادقة من القائمة.",variant:"destructive"})}finally{w(!1)}})()},[D==null?void 0:D.uid,r]);const Y=M=>Rx.find(F=>F.id===M),ie=(M,F)=>F>0?Math.min(M/F*100,100):0,me=M=>new Intl.NumberFormat("ar-EG").format(M);return e.jsx(Te,{open:r,onOpenChange:m,children:e.jsxs(Pe,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ke,{className:"pb-4",children:[e.jsxs(_e,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Da,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(bs,{variant:"secondary",className:"mr-2",children:[t.length," محفظة"]})]}),e.jsx("div",{className:"flex items-center gap-2 mt-2",children:R?e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",onClick:async()=>{try{if(!(D!=null&&D.uid))return;const M=t.map(F=>ba.update(F.id,{isActive:L.includes(F.id)}));await Promise.all(M),S(F=>F.map(le=>({...le,isActive:L.includes(le.id)}))),C(!1),_({title:"تم تفعيل المحافظ",description:"فقط المحافظ المحددة ستظهر في الاختيار الخارجي"});try{window.dispatchEvent(new CustomEvent("wallets:activation-updated"))}catch{}}catch(M){console.error("Error activating wallets:",M),_({title:"فشل التفعيل",description:"تعذر تفعيل المحافظ المحددة",variant:"destructive"})}},className:"h-7",children:"تفعيل المحافظ"}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>{C(!1),k([])},className:"h-7",children:"إلغاء"})]}):e.jsx(x,{variant:"outline",size:"sm",onClick:()=>C(!0),className:"h-7",children:"تحديد المحافظ"})})]}),y?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):t.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Da,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:t.map(M=>{const F=Y(M.walletProvider||"");ie(M.monthlyWithdrawalUsage||0,M.monthlyWithdrawalLimit),ie(M.monthlyTransferUsage||0,M.monthlyTransferLimit);const le=L.includes(M.id),Ee=R?`cursor-pointer transition-shadow border-2 ${le?"border-blue-500 shadow-lg":"hover:border-blue-300"}`:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300";return e.jsxs(Ut,{className:Ee,onClick:()=>{R?k(ue=>ue.includes(M.id)?ue.filter(ve=>ve!==M.id):[...ue,M.id]):o(M)},children:[e.jsx(vs,{className:"pb-3",children:e.jsxs(Vs,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_n,{className:"h-4 w-4"}),e.jsx("span",{children:M.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[M.isActive&&e.jsx(bs,{variant:"default",className:"text-xs",children:"نشطة"}),M.isDefault&&e.jsxs(bs,{variant:"default",className:"text-xs",children:[e.jsx(Ad,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(x,{variant:"ghost",size:"sm",onClick:ue=>{ue.stopPropagation(),f==null||f(M)},className:"h-7 px-2",children:e.jsx(Td,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",onClick:ue=>{ue.stopPropagation(),N==null||N(M.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(ys,{className:"h-4 w-4"})})]})]})}),e.jsxs(qt,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx($a,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:M.phone})]}),M.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(_i,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:M.nationalId})]}),F&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ed,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:F.name})]})]}),(()=>{const ue=M.monthlyWithdrawalLimit,ve=M.monthlyTransferLimit,ae=M.monthlyWithdrawalUsage||0,Be=M.monthlyTransferUsage||0,qe=Math.max(ue-ae,0),$e=Math.max(ve-Be,0);return e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{className:"text-xs text-gray-600 font-medium text-center",children:["الحدود الشهرية: ",(F==null?void 0:F.name)||M.walletProvider," - ",M.phone]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(ae/Math.max(ue,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Be/Math.max(ve,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",me(qe)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",me($e)," جنيه"]})]})]})})(),e.jsx(x,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:ue=>{ue.stopPropagation(),o(M)},children:"عرض التفاصيل الكاملة"})]})]},M.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(x,{onClick:m,variant:"outline",children:[e.jsx(Pd,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},$x=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Fx=({wallet:r,isOpen:m,onClose:o,onBack:f})=>{const{user:N}=Ca(),[D,t]=i.useState([]),[S,R]=i.useState(!1),[C,L]=i.useState("month"),{toast:k}=xa();if(i.useEffect(()=>{if(!r||!(N!=null&&N.uid)||!m)return;(async()=>{R(!0);try{const tt=(await Oi.getByUserId(N.uid)).filter(xe=>xe.walletId===r.id).sort((xe,Me)=>new Date(Me.createdAt).getTime()-new Date(xe.createdAt).getTime());t(tt)}catch(Ie){console.error("Error loading transactions:",Ie),k({title:"فشل جلب معاملات المحفظة",description:"قد تكون المشكلة بسبب صلاحيات Firestore أو الاتصال. تم عرض ما أمكن محليًا. جرّب تسجيل الدخول مجددًا أو صفحة اختبار المصادقة.",variant:"destructive"})}finally{R(!1)}})()},[r,N==null?void 0:N.uid,m]),!r)return null;const y=ne=>$x.find(Ie=>Ie.id===ne),w=(ne,Ie)=>Ie>0?Math.min(ne/Ie*100,100):0,_=ne=>new Intl.NumberFormat("ar-EG").format(ne),Q=ne=>new Date(ne).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),Y=(()=>{const ne=new Date;let Ie;switch(C){case"week":Ie=new Date(ne.getTime()-7*24*60*60*1e3);break;case"month":Ie=new Date(ne.getFullYear(),ne.getMonth(),1);break;default:return D}return D.filter(tt=>new Date(tt.createdAt)>=Ie)})(),ie=ne=>{const Ie=ne.type,tt=ne.txnType;return Ie==="withdraw"||Ie==="withdrawal"||Ie==="receive"||tt==="receive"},me=ne=>{const Ie=ne.type,tt=ne.txnType;return Ie==="send"||Ie==="transfer"||tt==="send"},M=Y.filter(ne=>ie(ne)&&ne.status==="completed").reduce((ne,Ie)=>{const tt=Ie.withdrawnAmount!==void 0?Ie.withdrawnAmount:Ie.amount;return ne+(tt||0)},0),F=Y.filter(ne=>me(ne)&&ne.status==="completed").reduce((ne,Ie)=>{const tt=Ie.sentAmount!==void 0?Ie.sentAmount:Ie.amount;return ne+(tt||0)},0),le=Y.filter(ne=>ne.type==="deposit"&&ne.status==="completed").reduce((ne,Ie)=>ne+Ie.amount,0),Ee=Y.filter(ne=>ne.status==="completed"),ue=Ee.length,ve=Ee.reduce((ne,Ie)=>{if(ie(Ie)){const tt=Ie.withdrawnAmount??Ie.receivedAmount??Ie.amount??0;return ne+Gc(Number(tt)||0,"receive")}if(me(Ie)){const tt=Ie.sentAmount??Ie.transferredAmount??Ie.amount??0;return ne+Gc(Number(tt)||0,"send")}return ne},0),ae=y(r.walletProvider||""),Be=w(r.monthlyWithdrawalUsage||0,r.monthlyWithdrawalLimit),qe=w(r.monthlyTransferUsage||0,r.monthlyTransferLimit),$e=ne=>{switch(ne){case"withdrawal":return e.jsx(Ai,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(An,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx(es,{className:"h-4 w-4 text-green-500"});default:return e.jsx(Ci,{className:"h-4 w-4 text-gray-500"})}},Qe=ne=>{switch(ne){case"completed":return e.jsx(zr,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(Fa,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(kd,{className:"h-4 w-4 text-red-500"});default:return e.jsx(wr,{className:"h-4 w-4 text-gray-500"})}},Ge=ne=>{switch(ne){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},Ct=ne=>{switch(ne){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(Te,{open:m,onOpenChange:o,children:e.jsxs(Pe,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ke,{className:"pb-4",children:e.jsxs(_e,{className:"flex items-center gap-2 text-lg",children:[e.jsx(_n,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",r.name,r.isDefault&&e.jsxs(bs,{variant:"default",className:"mr-2",children:[e.jsx(Ad,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(Ut,{children:[e.jsx(vs,{children:e.jsxs(Vs,{className:"text-sm flex items-center gap-2",children:[e.jsx(_i,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(qt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx($a,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:r.phone})]}),r.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(_i,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:r.nationalId})]}),ae&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ed,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:ae.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",ae.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",ae.nationalId]})]})]}),r.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ir,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(r.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs(Ut,{children:[e.jsx(vs,{children:e.jsxs(Vs,{className:"text-sm flex items-center gap-2",children:[e.jsx(ki,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(qt,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Ai,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[_(r.monthlyWithdrawalUsage||0)," / ",_(r.monthlyWithdrawalLimit)]})]}),e.jsx(sd,{value:Be,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",_(r.monthlyWithdrawalLimit-(r.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(Zl,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(An,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[_(r.monthlyTransferUsage||0)," / ",_(r.monthlyTransferLimit)]})]}),e.jsx(sd,{value:qe,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",_(r.monthlyTransferLimit-(r.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(Ut,{children:e.jsxs(qt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Ai,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:_(M)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx(Ut,{children:e.jsxs(qt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(An,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:_(F)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx(Ut,{children:e.jsxs(qt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(es,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:_(le)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})}),e.jsx(Ut,{children:e.jsxs(qt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(ki,{className:"h-5 w-5 text-emerald-600"})}),e.jsx("div",{className:"text-lg font-bold",children:_(ve)}),e.jsx("div",{className:"text-xs text-gray-600",children:"أرباح الفترة"})]})}),e.jsx(Ut,{children:e.jsxs(qt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Ci,{className:"h-5 w-5 text-purple-600"})}),e.jsx("div",{className:"text-lg font-bold",children:_(ue)}),e.jsx("div",{className:"text-xs text-gray-600",children:"عدد العمليات"})]})})]}),e.jsxs(Ut,{children:[e.jsx(vs,{children:e.jsxs(Vs,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Ci,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{size:"sm",variant:C==="week"?"default":"outline",onClick:()=>L("week"),className:"text-xs",children:"أسبوع"}),e.jsx(x,{size:"sm",variant:C==="month"?"default":"outline",onClick:()=>L("month"),className:"text-xs",children:"شهر"}),e.jsx(x,{size:"sm",variant:C==="all"?"default":"outline",onClick:()=>L("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(qt,{children:S?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):Y.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ci,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:Y.map(ne=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[$e(ne.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[Ge(ne.type)," - ",_(ne.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:Q(ne.createdAt)}),ne.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:ne.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[Qe(ne.status),e.jsx("span",{className:"text-xs",children:Ct(ne.status)})]})]},ne.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(x,{onClick:f,variant:"outline",children:[e.jsx(Pd,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(x,{onClick:o,variant:"outline",children:"إغلاق"})]})]})})},Vl=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Wx=({isOpen:r,onClose:m,onWalletUpdate:o,initialEditingWallet:f})=>{const{toast:N}=xa(),{user:D,userSubscription:t}=Ca();(()=>{var Le,pt;const W=((Le=t==null?void 0:t.subscription)==null?void 0:Le.planType)??((pt=t==null?void 0:t.subscription)==null?void 0:pt.plan)??(t==null?void 0:t.planType)??(t==null?void 0:t.plan)??null,we=typeof W=="string"?String(W).trim().toLowerCase():null;return W===ea.TAHWEELA||we==="tahweela"||we==="تحويله"})();const S=vd(),[R,C]=i.useState([]),[L,k]=i.useState(!1),[y,w]=i.useState(null),[_,Q]=i.useState(""),[E,Y]=i.useState(""),[ie,me]=i.useState(""),[M,F]=i.useState(""),[le,Ee]=i.useState("200000"),[ue,ve]=i.useState("200000"),[ae,Be]=i.useState("100000"),[qe,$e]=i.useState("60000"),[Qe,Ge]=i.useState(!1),[Ct,ne]=i.useState(null),[Ie,tt]=i.useState(!1),[xe,Me]=i.useState(!1),[Pt,zt]=i.useState(!1),[$t,ts]=i.useState(null),We=()=>`wallets_${(D==null?void 0:D.uid)||"default"}`;i.useEffect(()=>{f&&(w(f),k(!0),Q(f.name||""),Y(f.phone||""),me(f.nationalId||""),F(f.walletProvider||""),Ee((f.monthlyWithdrawalLimit||2e5).toString()),ve((f.monthlyTransferLimit||2e5).toString()),Be((f.dailyWithdrawalLimit||1e5).toString()),$e((f.dailyTransferLimit||6e4).toString()),Ge(!!f.isDefault))},[f]);const Je=W=>{const we=new Date,Le=we.getMonth(),pt=we.getFullYear();if(!W.lastResetDate)return{...W,monthlyWithdrawalUsage:W.monthlyWithdrawalUsage||0,monthlyTransferUsage:W.monthlyTransferUsage||0,lastResetDate:we.toISOString().split("T")[0]};const gt=new Date(W.lastResetDate),ms=gt.getMonth(),os=gt.getFullYear();return Le!==ms||pt!==os?{...W,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:we.toISOString().split("T")[0]}:W},mt=async(W,we)=>{const Le=new Date().getMonth(),pt=new Date().getFullYear(),gt=we.filter(Lt=>{const nt=new Date(Lt.createdAt);return nt.getMonth()===Le&&nt.getFullYear()===pt&&Lt.lineId===W}),ms=gt.filter(Lt=>Lt.txnType==="receive").reduce((Lt,nt)=>Lt+(nt.amount||0),0),os=gt.filter(Lt=>Lt.txnType==="send").reduce((Lt,nt)=>Lt+(nt.amount||0),0);return{withdrawalUsage:ms,transferUsage:os}},Re=async(W,we)=>{const Le=new Date,pt=Le.getDate(),gt=Le.getMonth(),ms=Le.getFullYear(),os=we.filter(kt=>{const Qt=new Date(kt.createdAt);return Qt.getDate()===pt&&Qt.getMonth()===gt&&Qt.getFullYear()===ms&&kt.lineId===W}),Lt=os.filter(kt=>kt.txnType==="receive").reduce((kt,Qt)=>kt+(Qt.amount||0),0),nt=os.filter(kt=>kt.txnType==="send").reduce((kt,Qt)=>kt+(Qt.amount||0),0);return{withdrawalUsage:Lt,transferUsage:nt}};i.useEffect(()=>{(async()=>{if(!(D!=null&&D.uid)){console.log("No user authenticated, skipping wallet loading"),tt(!1);return}console.log("Loading wallets for user:",D.uid),tt(!0);try{const{auth:we}=await wt(async()=>{const{auth:nt}=await import("./index-DA5EGBVC.js").then(kt=>kt.c5);return{auth:nt}},__vite__mapDeps([0,1]),import.meta.url);let Le=0;const pt=5;for(;!we.currentUser&&Le<pt;)console.log(`Waiting for auth state... attempt ${Le+1}`),await new Promise(nt=>setTimeout(nt,1e3)),Le++;if(!we.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",we.currentUser.uid),console.log("Context User:",D.uid),console.log("Fetching wallets from Firebase...");const gt=await ba.getByMerchantId(D.uid);console.log("Fetched wallets:",gt),console.log("Fetching transactions from Firebase...");const ms=await Oi.getByUserId(D.uid);console.log("Fetched transactions:",ms);const Lt=(await Promise.all(gt.map(async nt=>{const{withdrawalUsage:kt,transferUsage:Qt}=await mt(nt.id,ms),{withdrawalUsage:$s,transferUsage:hs}=await Re(nt.id,ms);return{id:nt.id,name:nt.label||"محفظة بدون اسم",phone:nt.msisdn,isDefault:!1,monthlyWithdrawalLimit:nt.withdrawLimit||2e5,monthlyTransferLimit:nt.transferLimit||2e5,dailyWithdrawalLimit:nt.dailyWithdrawLimit||1e5,dailyTransferLimit:nt.dailyTransferLimit||6e4,monthlyWithdrawalUsage:kt,monthlyTransferUsage:Qt,dailyWithdrawalUsage:$s,dailyTransferUsage:hs,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:nt.defaultTransferCommission!=null?Number(nt.defaultTransferCommission):null,defaultWithdrawCommission:nt.defaultWithdrawCommission!=null?Number(nt.defaultWithdrawCommission):null}}))).map(Je);C(Lt),console.log("Wallets loaded successfully:",Lt)}catch(we){console.error("Error loading wallets:",we),C([])}finally{tt(!1)}})()},[D==null?void 0:D.uid]);const Xe=()=>{Q(""),Y(""),me(""),F(""),Ee("200000"),ve("200000"),Be("100000"),$e("60000"),Ge(!1),w(null),k(!1)},X=async()=>{if(!_.trim()||!E.trim()||!M.trim()){N({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(D!=null&&D.uid)){N({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}tt(!0);try{if(y){await ba.update(y.id,{label:_.trim(),msisdn:E.trim(),withdrawLimit:parseInt(le),transferLimit:parseInt(ue),dailyWithdrawLimit:parseInt(ae),dailyTransferLimit:parseInt(qe)}),await ma.setLimits(y.id,{dailyTransferLimit:parseInt(qe||"0"),dailyWithdrawLimit:parseInt(ae||"0"),monthlyTransferLimit:parseInt(ue||"0"),monthlyWithdrawLimit:parseInt(le||"0")});const W=R.map(we=>we.id===y.id?{...we,name:_.trim(),phone:E.trim(),nationalId:ie.trim(),walletProvider:M,monthlyWithdrawalLimit:parseInt(le),monthlyTransferLimit:parseInt(ue),dailyWithdrawalLimit:parseInt(ae),dailyTransferLimit:parseInt(qe)}:we);C(W),localStorage.setItem(We(),JSON.stringify(W)),N({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const W={merchantUserId:D.uid,provider:M,msisdn:E.trim(),label:_.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(le),transferLimit:parseInt(ue),dailyTransferLimit:parseInt(qe),dailyWithdrawLimit:parseInt(ae),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},we=await ba.create(W);await ma.setLimits(we,{dailyTransferLimit:parseInt(qe||"0"),dailyWithdrawLimit:parseInt(ae||"0"),monthlyTransferLimit:parseInt(ue||"0"),monthlyWithdrawLimit:parseInt(le||"0")});const Le=new Date().toISOString().split("T")[0],pt={id:we,name:_.trim(),phone:E.trim(),nationalId:ie.trim(),walletProvider:M,isDefault:Qe,monthlyWithdrawalLimit:parseInt(le),monthlyTransferLimit:parseInt(ue),dailyWithdrawalLimit:parseInt(ae),dailyTransferLimit:parseInt(qe),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:Le,defaultTransferCommission:null,defaultWithdrawCommission:null},gt=[...R,pt];C(gt),localStorage.setItem(We(),JSON.stringify(gt)),N({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}o&&o(),Xe(),k(!1),w(null)}catch(W){console.error("Error saving wallet:",W),N({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{tt(!1)}},U=W=>{w(W),Q(W.name),Y(W.phone),me(W.nationalId||""),F(W.walletProvider||""),Ee(W.monthlyWithdrawalLimit.toString()),ve(W.monthlyTransferLimit.toString()),Ge(W.isDefault),k(!0)},Rt=async W=>{const we=R.find(Le=>Le.id===W);if(we!=null&&we.isDefault){N({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(D!=null&&D.uid)){N({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}tt(!0);try{await ba.delete(W);const Le=R.filter(pt=>pt.id!==W);C(Le),localStorage.setItem(We(),JSON.stringify(Le)),o&&o(),N({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(Le){console.error("Error deleting wallet:",Le),N({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{tt(!1)}},Ot=W=>{const we=R.map(Le=>({...Le,isDefault:Le.id===W}));C(we),localStorage.setItem(We(),JSON.stringify(we)),o&&o(),N({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(Te,{open:r,onOpenChange:m,children:[e.jsxs(Pe,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(ke,{className:"pb-2",children:e.jsxs(_e,{className:"flex items-center gap-1 text-sm",children:[e.jsx(Da,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",R.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(x,{onClick:()=>{zt(!0)},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(Ht,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(x,{onClick:()=>{m(),S("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(gs,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),(L||y)&&e.jsxs(Ut,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx(vs,{className:"pb-1",children:e.jsx(Vs,{className:"text-sm",children:y?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(qt,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(Xa,{value:M,onValueChange:F,children:[e.jsx(er,{className:"h-6 text-xs flex-1",children:e.jsx(tr,{placeholder:"اختر شركة المحفظة"})}),e.jsx(sr,{children:Vl.map(W=>e.jsx(fa,{value:W.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:W.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:we=>{we.preventDefault(),we.stopPropagation(),ne(W.id)},children:e.jsx(Xl,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},W.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx(V,{value:_,onChange:W=>Q(W.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx($a,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(V,{value:E,onChange:W=>Y(W.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx(_i,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(V,{value:ie,onChange:W=>me(W.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(es,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(V,{type:"number",value:le,onChange:W=>Ee(W.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(es,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(V,{type:"number",value:ue,onChange:W=>ve(W.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ai,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx(V,{type:"number",value:ae,onChange:W=>Be(W.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(An,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx(V,{type:"number",value:qe,onChange:W=>$e(W.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:Qe,onChange:W=>Ge(W.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(wd,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(x,{onClick:X,className:"flex-1 h-6 text-xs",size:"sm",children:y?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(x,{variant:"outline",onClick:Xe,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:R.map(W=>{var we;return e.jsxs(Ut,{className:`${W.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx(vs,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Vs,{className:"text-sm flex items-center gap-1",children:[e.jsx(Da,{className:"h-3 w-3"}),W.name]}),W.isDefault&&e.jsx(bs,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(qt,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx($a,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:W.phone})]}),W.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((we=Vl.find(Le=>Le.id===W.walletProvider))==null?void 0:we.name)||W.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.monthlyWithdrawalUsage||0)/W.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.monthlyTransferUsage||0)/W.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(W.monthlyWithdrawalLimit-(W.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(W.monthlyTransferLimit-(W.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.dailyWithdrawalUsage||0)/W.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.dailyTransferUsage||0)/W.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify بين items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(W.dailyWithdrawalLimit-(W.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(W.dailyTransferLimit-(W.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(x,{size:"sm",variant:"outline",onClick:()=>U(W),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(Td,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!W.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",variant:"outline",onClick:()=>Ot(W.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(x,{size:"sm",variant:"destructive",onClick:()=>Rt(W.id),className:"h-5 px-1",children:e.jsx(ys,{className:"h-2 w-2"})})]})]})]})]},W.id)})}),R.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),Ct&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>ne(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(Ti,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const W=Vl.find(we=>we.id===Ct);return W?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:W.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:W.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:W.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(Xl,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(fs,{open:Pt,onOpenChange:zt,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{zt(!1),Me(!0)}}),e.jsx(Lx,{isOpen:xe,onClose:()=>Me(!1),onWalletSelect:W=>{ts(W),Me(!1)},onEditWallet:W=>{S(`/user/add-wallet?edit=1&id=${W.id}`),Me(!1)},onDeleteWallet:async W=>{try{if(await ba.delete(W),C(we=>{const Le=we.filter(pt=>pt.id!==W);try{localStorage.setItem(We(),JSON.stringify(Le))}catch(pt){console.error("Failed to update localStorage wallets after delete:",pt)}return Le}),o)try{await o()}catch(we){console.error("onWalletUpdate callback failed:",we)}}catch(we){console.error("Error deleting wallet:",we)}}}),e.jsx(Fx,{wallet:$t,isOpen:!!$t,onClose:()=>ts(null),onBack:()=>{ts(null),Me(!0)}})]})},Bx=({isOpen:r,onClose:m,transaction:o,onDelete:f})=>{if(!o)return null;const N=C=>{switch(C){case"completed":return e.jsx(zr,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(Fa,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(kd,{className:"h-5 w-5 text-red-500"});default:return e.jsx(Fa,{className:"h-5 w-5 text-gray-500"})}},D=C=>{switch(C){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},t=C=>{switch(C){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},S=()=>{const C=!!o.senderNumber,L=!!o.senderName,k=C?"الرقم المرسل:":L?"الرقم الراسل:":"رقم المحفظة:",y=C?o.senderNumber:L?o.senderName:o.senderPhone,w=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${o.transactionReference||o.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${o.merchantShopName||o.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${t(o.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${o.status==="completed"?"#16a34a":o.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${D(o.status)}
            </span>
          </div>

          ${o!=null&&o.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${o.cashierName}</span>
            </div>
          `:""}
          
          ${o.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${k}</span>
              <span style="color: #1e293b;">${y}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${o.receiverNumber||o.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${ta(o.transferredAmount||o.amount)} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${o.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${ta(o.withdrawnAmountDetailed||o.withdrawnAmount||o.amount)} جنيه</span>
            </div>
          `}
          
          ${o.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${ta(o.commission||0)} جنيه</span>
            </div>
          `:""}
          ${o.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الربح:</span>
              <span style="color: #16a34a; font-weight: 600;">${ta(o.commission||0)} جنيه</span>
            </div>
          `:""}
          ${o!=null&&o.fee&&Number(o.fee)>0?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرسوم:</span>
              <span style="color: #64748b; font-weight: 600;">${ta(o.fee||0)} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${o.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${o.type==="withdraw"?"-":""}${ta(o.amount)} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,_=window.open("","_blank");_&&(_.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${o.transactionReference||o.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${w}
          </body>
        </html>
      `),_.document.close(),_.print())},R=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(f(o.id),m())};return e.jsx(Te,{open:r,onOpenChange:m,children:e.jsxs(Pe,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ke,{children:e.jsxs(_e,{className:"flex items-center gap-2 text-xl",children:[e.jsx(yr,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ut,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs(vs,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[N(o.status),e.jsx(bs,{variant:o.status==="completed"?"default":"secondary",className:"text-sm",children:D(o.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[o.type==="withdraw"?"-":"",ta(o.amount)," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",o.transactionReference||o.id]})]})}),e.jsxs(Ut,{children:[e.jsx(vs,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Od,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(qt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:o.merchantShopName||o.shopName||"غير محدد"})]}),(o==null?void 0:o.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:o.cashierName})]})]})]}),e.jsxs(Ut,{children:[e.jsx(vs,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_n,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(qt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(bs,{variant:"outline",className:"bg-blue-100 text-blue-800",children:t(o.type)})]}),o.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const C=!!o.senderNumber,L=!!o.senderName,k=C?"الرقم المرسل:":L?"الرقم الراسل:":"رقم المحفظة:",y=C?o.senderNumber:L?o.senderName:o.senderPhone,w=C?Tn:$a;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:k})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:y})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(hu,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Tn,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:o.receiverNumber||o.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(es,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[ta(o.transferredAmount||o.amount)," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($a,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:o.senderPhone})]}),(o==null?void 0:o.senderName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Tn,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("span",{className:"text-gray-900",children:o.senderName})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(es,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[ta(o.withdrawnAmountDetailed||o.withdrawnAmount||o.amount)," جنيه"]})]})]}),o.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[o.commission," جنيه"]})]}),o.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-green-700",children:"الربح:"}),e.jsxs("span",{className:"text-green-900 font-semibold",children:[o.commission," جنيه"]})]}),(o==null?void 0:o.fee)&&Number(o.fee)>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الرسوم:"}),e.jsxs("span",{className:"text-gray-900 font-semibold",children:[o.fee," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ir,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:o.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(x,{onClick:S,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx($u,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(x,{onClick:R,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(ys,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(x,{onClick:m,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function hd({open:r,onOpenChange:m,onSuccess:o,title:f,description:N,currentBalance:D,balanceLabel:t,userId:S}){const[R,C]=i.useState(""),[L,k]=i.useState(D.toString()),[y,w]=i.useState(!1),[_,Q]=i.useState(""),[E,Y]=i.useState(!1),ie=async M=>{M.preventDefault(),Q(""),Y(!0);try{const F=parseFloat(L);if(isNaN(F)||F<0){Q("يرجى إدخال مبلغ صحيح"),Y(!1);return}await ks.hasMasterPin(S)?await ks.verifyMasterPin(R,S)?(o(F),m(!1),C(""),k("")):Q("الرقم السري غير صحيح"):Q("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{Q("حدث خطأ أثناء التحقق من الرقم السري")}finally{Y(!1)}},me=()=>{C(""),k(D.toString()),Q(""),m(!1)};return He.useEffect(()=>{r&&k(D.toString())},[D,r]),e.jsx(Te,{open:r,onOpenChange:me,children:e.jsxs(Pe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ke,{children:e.jsxs(_e,{className:"flex items-center gap-2 text-right",children:[e.jsx(es,{className:"h-5 w-5"}),f]})}),e.jsxs("form",{onSubmit:ie,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:N}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(se,{className:"text-sm font-medium text-gray-700",children:[t," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[D.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx(V,{id:"newAmount",type:"number",step:"0.01",min:"0",value:L,onChange:M=>k(M.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(V,{id:"pin",type:y?"text":"password",value:R,onChange:M=>C(M.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>w(!y),children:y?e.jsx(_s,{className:"h-4 w-4"}):e.jsx(Ht,{className:"h-4 w-4"})})]})]}),_&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(wr,{className:"h-4 w-4"}),_]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(x,{type:"button",variant:"outline",onClick:me,className:"flex-1",children:"إلغاء"}),e.jsx(x,{type:"submit",disabled:E||!R||!L,className:"flex-1",children:E?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(br,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class kn{static getSecretKey(m){return m?`${this.SECRET_KEY_BASE}_${m}`:this.SECRET_KEY_BASE}static setSecretPin(m,o){const f=btoa(m);this.secretCache.set(this.getSecretKey(o),f)}static hasSecretPin(m){return this.secretCache.has(this.getSecretKey(m))}static verifySecretPin(m,o){const f=this.secretCache.get(this.getSecretKey(o));if(!f)return!1;try{return atob(f)===m}catch{return!1}}static clearSecretPin(m){this.secretCache.delete(this.getSecretKey(m))}}Ul(kn,"SECRET_KEY_BASE","dashboard_secret_pin"),Ul(kn,"secretCache",new Map);function Ux({open:r,onOpenChange:m,userId:o}){const[f,N]=i.useState(""),[D,t]=i.useState(""),[S,R]=i.useState(""),[C,L]=i.useState(!1),[k,y]=i.useState(!1),[w,_]=i.useState(!1),[Q,E]=i.useState(""),[Y,ie]=i.useState(!1),{toast:me}=xa(),M=kn.hasSecretPin(o),F=async Ee=>{Ee.preventDefault(),E(""),ie(!0);try{if(!D||D.length<4){E("يجب أن يكون الرقم السري 4 أرقام على الأقل"),ie(!1);return}if(D!==S){E("الرقم السري الجديد وتأكيده غير متطابقين"),ie(!1);return}if(M){if(!f){E("يرجى إدخال الرقم السري الحالي"),ie(!1);return}if(!kn.verifySecretPin(f,o)){E("الرقم السري الحالي غير صحيح"),ie(!1);return}}kn.setSecretPin(D,o),me({title:M?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:M?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),le()}catch{E("حدث خطأ أثناء حفظ الرقم السري")}finally{ie(!1)}},le=()=>{N(""),t(""),R(""),E(""),L(!1),y(!1),_(!1),m(!1)};return e.jsx(Te,{open:r,onOpenChange:le,children:e.jsxs(Pe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ke,{children:e.jsxs(_e,{className:"flex items-center gap-2 text-right",children:[e.jsx(wd,{className:"h-5 w-5"}),M?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:F,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:M?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),M&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(V,{id:"currentPin",type:C?"text":"password",autoComplete:"off",value:f,onChange:Ee=>N(Ee.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>L(!C),children:C?e.jsx(_s,{className:"h-4 w-4"}):e.jsx(Ht,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(V,{id:"newPin",type:k?"text":"password",autoComplete:"off",value:D,onChange:Ee=>t(Ee.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!k),children:k?e.jsx(_s,{className:"h-4 w-4"}):e.jsx(Ht,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(V,{id:"confirmPin",type:w?"text":"password",autoComplete:"off",value:S,onChange:Ee=>R(Ee.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>_(!w),children:w?e.jsx(_s,{className:"h-4 w-4"}):e.jsx(Ht,{className:"h-4 w-4"})})]})]}),Q&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(wr,{className:"h-4 w-4"}),Q]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:Y,className:"flex-1",children:[e.jsx(br,{className:"h-4 w-4 mr-2"}),Y?"جاري الحفظ...":M?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(x,{type:"button",variant:"outline",onClick:le,disabled:Y,children:"إلغاء"})]})]})]})})}const Jl=new Map;function zx({open:r,onOpenChange:m,userId:o}){const[f,N]=i.useState(""),[D,t]=i.useState(""),[S,R]=i.useState(""),[C,L]=i.useState(!1),[k,y]=i.useState(!1),[w,_]=i.useState(!1),[Q,E]=i.useState(""),[Y,ie]=i.useState(!1),{toast:me}=xa(),M=o?`cash_drawer_pin_${o}`:"cash_drawer_pin",F=()=>Jl.has(M),le=ae=>{const Be=Jl.get(M);if(!Be)return!1;try{return atob(Be)===ae}catch{return!1}},Ee=ae=>{const Be=btoa(ae);Jl.set(M,Be)},ue=async ae=>{ae.preventDefault(),E(""),ie(!0);try{if(!D||D.length<4){E("يجب أن يكون الرقم السري 4 أرقام على الأقل"),ie(!1);return}if(D!==S){E("الرقم السري الجديد وتأكيده غير متطابقين"),ie(!1);return}if(F()){if(!f){E("يرجى إدخال الرقم السري الحالي لدرج النقدية"),ie(!1);return}if(!le(f)){E("الرقم السري الحالي لدرج النقدية غير صحيح"),ie(!1);return}}Ee(D),me({title:F()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:F()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),ve()}catch{E("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{ie(!1)}},ve=()=>{N(""),t(""),R(""),E(""),L(!1),y(!1),_(!1),m(!1)};return e.jsx(Te,{open:r,onOpenChange:ve,children:e.jsxs(Pe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ke,{children:e.jsxs(_e,{className:"flex items-center gap-2 text-right",children:[e.jsx(es,{className:"h-5 w-5 text-green-600"}),F()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:ue,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:F()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),F()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(V,{id:"currentPin",type:C?"text":"password",autoComplete:"off",value:f,onChange:ae=>N(ae.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>L(!C),children:C?e.jsx(_s,{className:"h-4 w-4"}):e.jsx(Ht,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(V,{id:"newPin",type:k?"text":"password",autoComplete:"off",value:D,onChange:ae=>t(ae.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!k),children:k?e.jsx(_s,{className:"h-4 w-4"}):e.jsx(Ht,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(V,{id:"confirmPin",type:w?"text":"password",autoComplete:"off",value:S,onChange:ae=>R(ae.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>_(!w),children:w?e.jsx(_s,{className:"h-4 w-4"}):e.jsx(Ht,{className:"h-4 w-4"})})]})]}),Q&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(wr,{className:"h-4 w-4"}),Q]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:Y,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(br,{className:"h-4 w-4 mr-2"}),Y?"جاري الحفظ...":F()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(x,{type:"button",variant:"outline",onClick:ve,disabled:Y,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}const Kl=new Map;function qx({open:r,onOpenChange:m,userId:o}){const[f,N]=i.useState(""),[D,t]=i.useState(""),[S,R]=i.useState(""),[C,L]=i.useState(!1),[k,y]=i.useState(!1),[w,_]=i.useState(!1),[Q,E]=i.useState(""),[Y,ie]=i.useState(!1),{toast:me}=xa(),M=o?`wallet_total_pin_${o}`:"wallet_total_pin",F=()=>Kl.has(M),le=ae=>{const Be=Kl.get(M);if(!Be)return!1;try{return atob(Be)===ae}catch{return!1}},Ee=ae=>{const Be=btoa(ae);Kl.set(M,Be)},ue=async ae=>{ae.preventDefault(),E(""),ie(!0);try{if(!D||D.length<4){E("يجب أن يكون الرقم السري 4 أرقام على الأقل"),ie(!1);return}if(D!==S){E("الرقم السري الجديد وتأكيده غير متطابقين"),ie(!1);return}if(F()){if(!f){E("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),ie(!1);return}if(!le(f)){E("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),ie(!1);return}}Ee(D),me({title:F()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:F()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),ve()}catch{E("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{ie(!1)}},ve=()=>{N(""),t(""),R(""),E(""),L(!1),y(!1),_(!1),m(!1)};return e.jsx(Te,{open:r,onOpenChange:ve,children:e.jsxs(Pe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ke,{children:e.jsxs(_e,{className:"flex items-center gap-2 text-right",children:[e.jsx(Da,{className:"h-5 w-5 text-blue-600"}),F()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:ue,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:F()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),F()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(V,{id:"currentPin",type:C?"text":"password",autoComplete:"off",value:f,onChange:ae=>N(ae.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>L(!C),children:C?e.jsx(_s,{className:"h-4 w-4"}):e.jsx(Ht,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(V,{id:"newPin",type:k?"text":"password",autoComplete:"off",value:D,onChange:ae=>t(ae.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!k),children:k?e.jsx(_s,{className:"h-4 w-4"}):e.jsx(Ht,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(V,{id:"confirmPin",type:w?"text":"password",autoComplete:"off",value:S,onChange:ae=>R(ae.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>_(!w),children:w?e.jsx(_s,{className:"h-4 w-4"}):e.jsx(Ht,{className:"h-4 w-4"})})]})]}),Q&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(wr,{className:"h-4 w-4"}),Q]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:Y,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(br,{className:"h-4 w-4 mr-2"}),Y?"جاري الحفظ...":F()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(x,{type:"button",variant:"outline",onClick:ve,disabled:Y,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function Vx({open:r,onOpenChange:m,onSuccess:o,title:f,description:N,currentBalance:D,balanceLabel:t,userId:S}){const[R,C]=i.useState(""),[L,k]=i.useState(""),[y,w]=i.useState("add"),[_,Q]=i.useState(!1),[E,Y]=i.useState(""),[ie,me]=i.useState(!1),[M,F]=i.useState(!1);i.useEffect(()=>{let ve=!0;return(async()=>{const ae=await ks.hasMasterPin(S);ve&&F(ae)})(),()=>{ve=!1}},[S,r]);const le=async ve=>{ve.preventDefault(),Y(""),me(!0);try{const ae=parseFloat(L);if(isNaN(ae)||ae<=0){Y("يرجى إدخال مبلغ صحيح أكبر من صفر"),me(!1);return}if(y==="subtract"&&ae>D){Y("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),me(!1);return}if(M)if(await ks.verifyMasterPin(R,S)){const qe=y==="add"?ae:-ae;Ee(),o(qe)}else Y("الرقم السري غير صحيح");else Y("لم يتم تعيين الرقم السري الرئيسي. يرجى تعيينه من إعدادات البروفيل أولاً")}catch{Y("حدث خطأ أثناء التحقق من الرقم السري")}finally{me(!1)}},Ee=()=>{C(""),k(""),w("add"),Y(""),m(!1)},ue=()=>{const ve=parseFloat(L)||0;return y==="add"?D+ve:D-ve};return e.jsx(Te,{open:r,onOpenChange:Ee,children:e.jsxs(Pe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ke,{children:e.jsxs(_e,{className:"flex items-center gap-2 text-right",children:[y==="add"?e.jsx(gs,{className:"h-5 w-5 text-green-600"}):e.jsx(xr,{className:"h-5 w-5 text-red-600"}),f]})}),e.jsxs("form",{onSubmit:le,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:N}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(se,{className:"text-sm font-medium text-gray-700",children:[t," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[D.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(x,{type:"button",variant:y==="add"?"default":"outline",onClick:()=>w("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(gs,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(x,{type:"button",variant:y==="subtract"?"default":"outline",onClick:()=>w("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(xr,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(se,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",y==="add"?"إضافته":"خصمه"]}),e.jsx(V,{id:"amount",type:"number",step:"0.01",min:"0.01",value:L,onChange:ve=>k(ve.target.value),placeholder:`أدخل المبلغ المراد ${y==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),L&&!isNaN(parseFloat(L))&&e.jsxs("div",{className:`p-3 rounded-lg ${y==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(se,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${y==="add"?"text-green-700":"text-red-700"}`,children:[ue().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(V,{id:"pin",type:_?"text":"password",autoComplete:"off",value:R,onChange:ve=>C(ve.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>Q(!_),children:_?e.jsx(_s,{className:"h-4 w-4"}):e.jsx(Ht,{className:"h-4 w-4"})})]})]}),E&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(wr,{className:"h-4 w-4"}),E]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(x,{type:"button",variant:"outline",onClick:Ee,className:"flex-1",children:"إلغاء"}),e.jsx(x,{type:"submit",disabled:ie||!R||!L,className:`flex-1 ${y==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:ie?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(br,{className:"h-4 w-4 mr-2"}),y==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}const ud={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_APP_VERSION:"0.0.0",VITE_DEV_MODE:"true",VITE_ENABLE_OFFLINE_PERSISTENCE:"false",VITE_FIREBASE_API_KEY:["AI","za","SyA33RTf43u2QE2OsK1RepQHSKrSet9ZI0s"].join(""),VITE_FIREBASE_APP_ID:"1:483702062341:web:b1ff06ad175cb7ae428b6c",VITE_FIREBASE_AUTH_DOMAIN:"voda-c6abd.firebaseapp.com",VITE_FIREBASE_AUTH_EMULATOR_URL:"http://localhost:9099",VITE_FIREBASE_FIRESTORE_EMULATOR_HOST:"localhost:8080",VITE_FIREBASE_FUNCTIONS_EMULATOR_HOST:"localhost:5001",VITE_FIREBASE_MEASUREMENT_ID:"G-CV6QGH7G7P",VITE_FIREBASE_MESSAGING_SENDER_ID:"483702062341",VITE_FIREBASE_PROJECT_ID:"voda-c6abd",VITE_FIREBASE_STORAGE_BUCKET:"voda-c6abd.appspot.com",VITE_FORCE_HASH_ROUTER:"true",VITE_SHOP_ID:"demo-shop-001",VITE_SHOP_NAME:"محل كاشي لينك التجريبي",VITE_SHOW_ENV_BANNER:"true",VITE_USE_EMULATORS:"false",VITE_USE_FIREBASE_EMULATOR:"false"},Qa=r=>typeof r=="string"&&r.trim().length>0,Jx={getCurrentMonthId(){const r=new Date;return`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`},async getWalletUsage(r){var m;try{if(!Qa(r))return console.error("Error getting wallet usage: invalid walletId",r),null;const o=ze(q,"walletLimits",r),f=await Sa(o);if(f.exists()){const D=f.data();return{walletId:r,used_transfer:D.monthlyTransferUsed??D.used_transfer??0,used_withdraw:D.monthlyWithdrawUsed??D.used_withdraw??0,monthly_limit:D.monthlyLimit??D.monthlyTransferLimit??D.monthlyWithdrawLimit??2e5,last_reset:D.lastMonthlyReset??D.last_reset??null,updatedAt:D.updatedAt||ur.now()}}const N={walletId:r,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:ur.now()};return await ia(o,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,monthlyTransferLimit:2e5,monthlyWithdrawLimit:2e5,lastMonthlyReset:null,updatedAt:bt(),ownerId:(m=Wr.currentUser)==null?void 0:m.uid}),N}catch(o){return console.error("Error getting wallet usage:",o),{walletId:r,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:ur.now()}}},shouldResetLimits(r){const m=new Date,o=m.getDate();if(!r)return o===1;if(o===1){const f=r.toDate(),N=m.getMonth(),D=m.getFullYear();return f.getMonth()!==N||f.getFullYear()!==D}return!1},async autoResetLimitsIfNeeded(r){try{if(!Qa(r))return console.error("خطأ في التصفير التلقائي للحدود: walletId غير صالح",r),!1;typeof import.meta<"u";const m=await this.getWalletUsage(r);return m&&this.shouldResetLimits(m.last_reset)?(console.log(`🔄 تصفير تلقائي للحدود للمحفظة ${r} - اليوم الأول من الشهر`),await this.resetWalletUsage(r)):!1}catch(m){return console.error("خطأ في التصفير التلقائي للحدود:",m),!1}},async resetWalletUsage(r){try{if(!Qa(r))return console.error("خطأ في تصفير استخدام المحفظة: walletId غير صالح",r),!1;const m=ze(q,"walletLimits",r);return await ia(m,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:bt(),updatedAt:bt()},{merge:!0}),console.log(`🔄 تم تصفير استخدام المحفظة ${r} بنجاح`),!0}catch(m){return console.error("خطأ في تصفير استخدام المحفظة:",m),!1}},async calculateUsageFromTransactions(r){var m,o;try{if(!Qa(r))return console.error("خطأ في حساب الاستخدام من المعاملات: walletId غير صالح",r),{used_transfer:0,used_withdraw:0};const f=ze(q,"walletLimits",r),N=new Date;let D=ur.fromDate(new Date(N.getFullYear(),N.getMonth(),1));try{const L=await Sa(f);D=L.exists()?((m=L.data())==null?void 0:m.lastMonthlyReset)??((o=L.data())==null?void 0:o.last_reset)??D:D}catch{}const t=Ye(je(q,"tx"),he("uid","==",r),...D?[he("createdAt",">=",D)]:[]),S=await et(t);let R=0,C=0;return S.forEach(L=>{const k=L.data();k.status==="completed"&&(k.type==="transfer"?R+=k.amount:k.type==="withdraw"&&(C+=k.amount))}),{used_transfer:R,used_withdraw:C}}catch(f){return console.error("خطأ في حساب الاستخدام من المعاملات:",f),{used_transfer:0,used_withdraw:0}}},async getWalletUsageWithRefresh(r){var m,o;try{if(!Qa(r))return console.error("خطأ في الحصول على الاستخدام مع التحديث: walletId غير صالح",r),null;typeof import.meta<"u";const f=await this.getWalletUsage(r);if(!f){const D=await this.calculateUsageFromTransactions(r),t=ze(q,"walletLimits",r);try{await ia(t,{monthlyTransferUsed:D.used_transfer,monthlyWithdrawUsed:D.used_withdraw,updatedAt:bt(),ownerId:(m=Wr.currentUser)==null?void 0:m.uid},{merge:!0})}catch{}return{walletId:r,used_transfer:D.used_transfer,used_withdraw:D.used_withdraw,monthly_limit:2e5,last_reset:null,updatedAt:ur.now()}}const N=await this.calculateUsageFromTransactions(r);if(f.used_transfer!==N.used_transfer||f.used_withdraw!==N.used_withdraw){const D=ze(q,"walletLimits",r);try{await ia(D,{monthlyTransferUsed:N.used_transfer,monthlyWithdrawUsed:N.used_withdraw,updatedAt:bt(),ownerId:(o=Wr.currentUser)==null?void 0:o.uid},{merge:!0})}catch{}return await this.getWalletUsage(r)}return f}catch(f){return console.error("خطأ في الحصول على الاستخدام مع التحديث:",f),{walletId:r,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:ur.now()}}},calculateRemaining(r){return{remainingTransfer:Math.max(0,r.monthly_limit-r.used_transfer),remainingWithdraw:Math.max(0,r.monthly_limit-r.used_withdraw)}},async canPerformOperation(r,m,o){try{if(!Qa(r))return console.error("Error checking operation limits: invalid walletId",r),{canPerform:!1,message:"walletId غير صالح"};const f=await this.getWalletUsageWithRefresh(r);if(!f)return{canPerform:!1,message:"لا يمكن العثور على بيانات الاستخدام للمحفظة"};const N=this.calculateRemaining(f);return o==="transfer"&&m>N.remainingTransfer?{canPerform:!1,message:`تجاوز حد التحويل المسموح. المتبقي: ${N.remainingTransfer.toLocaleString()} ج.م من أصل ${f.monthly_limit.toLocaleString()} ج.م`,remaining:N.remainingTransfer}:o==="withdraw"&&m>N.remainingWithdraw?{canPerform:!1,message:`تجاوز حد السحب المسموح. المتبقي: ${N.remainingWithdraw.toLocaleString()} ج.م من أصل ${f.monthly_limit.toLocaleString()} ج.م`,remaining:N.remainingWithdraw}:{canPerform:!0}}catch(f){return console.error("Error checking operation limits:",f),{canPerform:!1,message:"خطأ في التحقق من الحدود"}}},async updateUsage(r,m,o){var f;try{if(!Qa(r))throw new Error("walletId غير صالح");const N=await this.getWalletUsageWithRefresh(r);if(!N)throw new Error("لا يمكن العثور على بيانات الاستخدام للمحفظة");const D=await this.canPerformOperation(r,m,o);if(!D.canPerform)throw new Error(D.message||"لا يمكن إجراء العملية");const t=o==="transfer"?N.used_transfer+m:N.used_transfer,S=o==="withdraw"?N.used_withdraw+m:N.used_withdraw,R=ze(q,"walletLimits",N.walletId);try{await ia(R,{monthlyTransferUsed:t,monthlyWithdrawUsed:S,updatedAt:bt(),ownerId:(f=Wr.currentUser)==null?void 0:f.uid},{merge:!0})}catch{}let C=await this.getWalletUsageWithRefresh(r);return C||(C={walletId:r,used_transfer:t,used_withdraw:S,monthly_limit:N.monthly_limit,last_reset:N.last_reset,updatedAt:ur.now()}),C}catch(N){throw console.error("Error updating wallet usage:",N),N}},async resetWalletUsageManually(r){try{if(!Qa(r))throw new Error("walletId غير صالح");const m=ze(q,"walletLimits",r),o={walletId:r,used_transfer:0,used_withdraw:0,monthly_limit:0,last_reset:null,updatedAt:new Date};return ia(m,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:bt(),updatedAt:bt()},{merge:!0}).catch(f=>{console.error("خطأ في حفظ تصفير الاستخدام في Firebase:",f)}),console.log(`✅ تم تصفير استخدام المحفظة ${r} بنجاح`),o}catch(m){throw console.error("Error resetting wallet usage:",m),m}},async getAllWalletsUsage(r){try{const o=(await ba.getByMerchantId(r)).map(N=>this.getWalletUsageWithRefresh(N.id));return(await Promise.all(o)).filter(N=>N!==null)}catch(m){return console.error("Error getting all wallets usage:",m),[]}}};function Kx(r){return r?`readBroadcastIds_${r}`:"readBroadcastIds_guest"}function Yx({className:r}){const{user:m,profile:o,isSubscriptionActive:f}=Ca(),N=Nd(),[D,t]=i.useState([]),[S,R]=i.useState(new Set),[C,L]=i.useState(!1),[k,y]=i.useState(""),[w,_]=i.useState(!1),[Q,E]=i.useState(null),[Y,ie]=i.useState("none"),[me,M]=i.useState(null),[F,le]=i.useState(!1);i.useRef(new Set),i.useRef(!1);const Ee=i.useRef(null),ue=i.useRef(null);i.useRef(null);const[ve,ae]=i.useState({position:"fixed",top:0,left:0,zIndex:1e4}),Be=!1,qe=i.useMemo(()=>{const xe=["global"];return m!=null&&m.uid&&xe.push(`user:${m.uid}`),o!=null&&o.shopId&&xe.push(`shop:${o.shopId}`),xe},[m==null?void 0:m.uid,o==null?void 0:o.shopId]),$e=Kx(m==null?void 0:m.uid),Qe=i.useMemo(()=>{var Pt;const xe=(Pt=N==null?void 0:N.pathname)==null?void 0:Pt.includes("/user/pending-approval");return!!(m!=null&&m.uid)&&!xe},[m==null?void 0:m.uid,N==null?void 0:N.pathname]);i.useEffect(()=>{try{const xe=localStorage.getItem($e);if(xe){const Me=JSON.parse(xe);Array.isArray(Me)&&R(new Set(Me.filter(Boolean)))}else R(new Set)}catch(xe){console.warn("Failed to load read ids",xe),R(new Set)}},[$e]),i.useEffect(()=>{if(!Qe){t([]);return}const xe=qu(qe,Me=>{t(Me)});return()=>xe()},[qe,Qe]),i.useEffect(()=>{},[D]),i.useEffect(()=>()=>{Ee.current&&clearTimeout(Ee.current)},[]);const Ge=D.reduce((xe,Me)=>xe+(Me.id&&!S.has(Me.id)?1:0),0),Ct=xe=>{if(!xe||S.has(xe))return;const Me=new Set(S);Me.add(xe),R(Me);try{localStorage.setItem($e,JSON.stringify(Array.from(Me)))}catch{}},ne=()=>{const xe=D.map(Pt=>Pt.id).filter(Boolean),Me=new Set(S);xe.forEach(Pt=>Me.add(Pt)),R(Me);try{localStorage.setItem($e,JSON.stringify(Array.from(Me)))}catch{}},Ie=(xe,Me)=>{var Pt;if(xe)try{const zt=((Pt=Pi)==null?void 0:Pt.isNativePlatform)&&Pi.getPlatform()==="android",$t=/\.apk(\?|$)/i.test(xe);if(zt&&$t){const ts=`cashy://update?url=${encodeURIComponent(xe)}`;window.location.href=ts}else window.open(xe,"_blank")}catch{try{window.open(xe,"_blank")}catch{}}Me&&Ct(Me)};i.useEffect(()=>{},[F]);const tt=async()=>{if(!(m!=null&&m.uid)){alert("يرجى تسجيل الدخول لإرسال الطلب.");return}const xe=k.trim();if(!xe){alert("يرجى كتابة سبب طلب التحدث.");return}try{_(!0),E(null);const Me=o!=null&&o.fullName&&o.fullName.trim()?o.fullName.trim():m.email?m.email.split("@")[0]:"مستخدم",Pt=(o==null?void 0:o.phone)||null;await ha(je(q,"waiting_list"),{userId:m.uid,name:Me,phone:Pt,reason:xe,status:"pending",createdAt:bt()}),E("تم إرسال طلبك إلى قائمة الانتظار بنجاح ✅"),y(""),setTimeout(()=>L(!1),900)}catch(Me){console.error("فشل إرسال طلب قائمة الانتظار:",Me),alert("حدث خطأ أثناء إرسال الطلب. حاول مرة أخرى.")}finally{_(!1)}};return i.useEffect(()=>{if(!(m!=null&&m.uid)){ie("none");return}let xe=null;try{const Me=Ye(je(q,"waiting_list"),he("userId","==",m.uid));xe=zs(Me,Pt=>{const zt=Pt.docs.map(We=>({id:We.id,...We.data()})).sort((We,Je)=>{var Xe,X,U,Rt,Ot,W;const mt=((X=(Xe=We==null?void 0:We.createdAt)==null?void 0:Xe.toMillis)==null?void 0:X.call(Xe))??((U=We==null?void 0:We.createdAt)==null?void 0:U.seconds)*1e3??0;return(((Ot=(Rt=Je==null?void 0:Je.createdAt)==null?void 0:Rt.toMillis)==null?void 0:Ot.call(Rt))??((W=Je==null?void 0:Je.createdAt)==null?void 0:W.seconds)*1e3??0)-mt});if(zt.length===0){ie("none");return}const $t=zt[0],ts=($t==null?void 0:$t.contacted)===!0||($t==null?void 0:$t.status)==="contacted";ie(ts?"contacted":"pending")})}catch(Me){console.warn("⚠️ فشل الاشتراك في waiting_list للمستخدم:",Me),ie("none")}return()=>{xe&&xe()}},[m==null?void 0:m.uid]),Qe?e.jsxs("div",{className:`relative inline-flex items-center gap-2 ${r||""}`,ref:ue,children:[e.jsxs(Ku,{onOpenChange:xe=>{xe&&Ge>0&&ne()},children:[e.jsx(Yu,{asChild:!0,children:e.jsx(x,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:e.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[e.jsx(nd,{className:"h-4 w-4 text-primary"}),Ge>0&&e.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:Ge})]})})}),e.jsxs(Hu,{className:"w-80",align:"end",forceMount:!0,children:[e.jsxs(Qu,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"الإشعارات"}),D.length>0&&e.jsxs(x,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:ne,children:[e.jsx(zr,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),e.jsx(Gu,{}),D.length===0?e.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):e.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:D.map(xe=>{const Me=xe.id?!S.has(xe.id):!1;return e.jsx("div",{className:`px-2 py-2 rounded-md ${Me?"bg-primary/5":""}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(nd,{className:`h-4 w-4 ${Me?"text-primary":"text-muted-foreground"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium",children:xe.title||"إشعار"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:xe.message}),xe.linkUrl&&e.jsxs(x,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>Ie(xe.linkUrl,xe.id),children:["فتح الرابط ",e.jsx(Vu,{className:"h-3 w-3 ml-1"})]})]}),Me?e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Ct(xe.id),title:"تمييز كمقروء",children:e.jsx(zr,{className:"h-4 w-4 text-primary"})}):e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:e.jsx(zr,{className:"h-4 w-4 text-muted-foreground"})})]})},xe.id)})})]})]}),e.jsxs(Te,{open:C,onOpenChange:L,children:[e.jsx(uu,{asChild:!0,children:e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full hover:bg-transparent focus:ring-1 focus:ring-primary/60 focus:ring-offset-1",title:"قائمة الانتظار",children:e.jsx(Fa,{className:`h-4 w-4 ${Y==="pending"?"text-red-600":Y==="contacted"?"text-green-600":"text-muted-foreground"}`})})}),e.jsxs(Pe,{className:"max-w-md border border-purple-200/50 shadow-xl bg-gradient-to-br from-purple-50 to-blue-50",children:[e.jsxs(ke,{children:[e.jsx(_e,{children:"طلب التحدث"}),e.jsx(Ps,{children:"يرجى كتابة سبب طلب التحدث ليصل للإدارة في قسم قائمة الانتظار."})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"سبب الطلب"}),e.jsx(Ju,{value:k,onChange:xe=>y(xe.target.value),placeholder:"اكتب سبب طلب التحدث هنا...",className:"min-h-[120px] text-right"}),Q&&e.jsx("div",{className:"text-sm text-green-700 bg-green-50 border border-green-200 rounded-md p-2",children:Q})]}),e.jsxs(xt,{children:[e.jsx(x,{variant:"outline",onClick:()=>L(!1),disabled:w,children:"إلغاء"}),e.jsx(x,{onClick:tt,disabled:w,className:"bg-gradient-to-r from-green-600 to-emerald-600 text-white",children:w?"جارٍ الإرسال...":"إرسال"})]})]})]}),Be]}):null}function Hx({isOpen:r,onClose:m}){const[o,f]=i.useState("0"),[N,D]=i.useState(null),[t,S]=i.useState(null),[R,C]=i.useState(!1),L=M=>{R?(f(M),C(!1)):f(o==="0"?M:o+M)},k=M=>{const F=parseFloat(o);if(N===null)D(F);else if(t){const Ee=y(N||0,F,t);f(String(Ee)),D(Ee)}C(!0),S(M)},y=(M,F,le)=>{switch(le){case"+":return M+F;case"-":return M-F;case"×":return M*F;case"÷":return F===0?0:M/F;case"=":return F;default:return F}},w=()=>{const M=parseFloat(o);if(N!==null&&t){const F=y(N,M,t);f(String(F)),D(null),S(null),C(!0)}},_=()=>{f("0"),D(null),S(null),C(!1)},Q=()=>{f("0")},E=()=>{R?(f("0."),C(!1)):o.indexOf(".")===-1&&f(o+".")},Y=()=>{o!=="0"&&f(o.charAt(0)==="-"?o.slice(1):"-"+o)},ie=()=>{const M=parseFloat(o);f(String(M/100))},me=M=>{const F=M.key;M.preventDefault(),F>="0"&&F<="9"?L(F):F==="+"?k("+"):F==="-"?k("-"):F==="*"?k("×"):F==="/"?k("÷"):F==="Enter"||F==="="?w():F==="Escape"||F==="c"||F==="C"?_():F==="Backspace"?Q():F==="."?E():F==="%"&&ie()};return i.useEffect(()=>(r?document.addEventListener("keydown",me):document.removeEventListener("keydown",me),()=>{document.removeEventListener("keydown",me)}),[r,o,N,t,R]),e.jsx(Te,{open:r,onOpenChange:M=>!M&&m(),children:e.jsxs(Pe,{className:"sm:max-w-md",children:[e.jsx(ke,{children:e.jsxs(_e,{className:"flex items-center gap-2 text-right",children:[e.jsx(_d,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:o})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:_,children:"AC"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:Q,children:"CE"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:ie,children:"%"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>k("÷"),children:"÷"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>L("7"),children:"7"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>L("8"),children:"8"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>L("9"),children:"9"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>k("×"),children:"×"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>L("4"),children:"4"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>L("5"),children:"5"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>L("6"),children:"6"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>k("-"),children:"-"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>L("1"),children:"1"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>L("2"),children:"2"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>L("3"),children:"3"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>k("+"),children:"+"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>L("0"),children:"0"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:E,children:"."}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:w,children:"="})]}),e.jsx(x,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:Y,children:"+/-"})]})]})})}function Qx({isOpen:r,onClose:m,initialBarcode:o}){const[f,N]=i.useState([]),[D,t]=i.useState({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),[S,R]=i.useState(!1),[C,L]=i.useState(null),{toast:k}=xa(),{user:y,profile:w}=Ca(),{isShiftActive:_,shiftUser:Q}=Mn(),{shopId:E}=Ei(),[Y,ie]=i.useState([]),[me,M]=i.useState({}),[F,le]=i.useState({}),[Ee,ue]=i.useState({}),[ve,ae]=i.useState(""),[Be,qe]=i.useState(!1),[$e,Qe]=i.useState({}),[Ge,Ct]=i.useState(!1),[ne,Ie]=i.useState(!0),[tt,xe]=i.useState(!1),Me=He.useRef(""),Pt=He.useRef(0),[zt,$t]=i.useState(0),[ts,We]=i.useState(0),[Je,mt]=i.useState(!1),[Re,Xe]=i.useState(!0),[X,U]=i.useState(!1),[Rt,Ot]=i.useState(!1),[W,we]=i.useState(!0),[Le,pt]=i.useState(!0),[gt,ms]=i.useState({}),[os,Lt]=i.useState(!1),[nt,kt]=i.useState("التحقق قبل العملية"),[Qt,$s]=i.useState("أدخل الرقم السري الرئيسي للمتابعة"),hs=He.useRef(null),ss=(d,P,B)=>{kt(d),$s(P),hs.current=B,Lt(!0)},[Ia,Js]=i.useState([]),[va,ws]=i.useState(!1),[O,fe]=i.useState(""),[ge,Fe]=i.useState(""),[Ve,vt]=i.useState(""),[Nt,H]=i.useState(null);i.useEffect(()=>{(async()=>{try{if(!r||!(y!=null&&y.uid))return;const d=await Ce.getUserData(y.uid),P=Array.isArray(d==null?void 0:d.customers)?d.customers.map(B=>({id:String(B.id||""),name:String(B.name||""),mobile:B.mobile||void 0})):[];Js(P)}catch{}})()},[r,y==null?void 0:y.uid]);const[ye,G]=i.useState(!1),[ht,It]=i.useState(null),[as,Ns]=i.useState(null),sa=(d,P)=>{It(d),Ns(P),G(!0)},[la,Nr]=i.useState(""),Fs=i.useMemo(()=>{const d=la.trim().toLowerCase();return d?Y.filter(P=>P.name.toLowerCase().includes(d)):Y},[Y,la]),Hr=()=>new Date().toISOString().split("T")[0];i.useEffect(()=>{r&&(y!=null&&y.uid)&&(jt(),Re||Gt())},[r,y==null?void 0:y.uid,Re]),i.useEffect(()=>{if(!(!r||!(y!=null&&y.uid)))try{const d=Hr(),P=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date),B=Z=>{try{const Ne=Z.docs.map(Ae=>{const re=Ae.data();return{id:String(re.clientId||Ae.id),productName:String(re.productName||""),price:Number(re.sellingPrice||0),wholesalePrice:typeof re.wholesalePrice=="number"?re.wholesalePrice:Number(re.wholesalePrice||0),quantity:Number(re.quantity||0),date:String(re.date||d),time:String(re.time||""),performedByType:re.performedByType||void 0,performedByName:re.performedByName||void 0,performedByUsername:re.performedByUsername||null,serialNumber:re.serialNumber||void 0,barcode:re.barcode||void 0,firestoreId:Ae.id}}),pe=(f||[]).filter(Ae=>!Ae.firestoreId),be={};[...Ne,...pe].forEach(Ae=>{be[Ae.id]=Ae});const Oe=Object.values(be);ft(Oe)}catch{}};let ee;try{const Z=E||(w==null?void 0:w.shopId)||null,Ne=Ye(je(q,"dailySales"),he("userId","==",y.uid),...Z?[he("shopId","==",Z)]:[]);ee=zs(Ne,B,()=>{try{ee&&ee()}catch{}const pe=Ye(je(q,"users",y.uid,"dailySales"),...Z?[he("shopId","==",Z)]:[]);ee=zs(pe,B)})}catch{const Z=E||(w==null?void 0:w.shopId)||null,Ne=Ye(je(q,"users",y.uid,"dailySales"),...Z?[he("shopId","==",Z)]:[]);ee=zs(Ne,B)}return()=>{try{ee&&ee()}catch{}}}catch{}},[r,y==null?void 0:y.uid]),i.useEffect(()=>{if(!r)return;const d=P=>{var pe;const B=P.target,ee=(pe=B==null?void 0:B.tagName)==null?void 0:pe.toLowerCase();if(ee==="input"||ee==="textarea"||!!(B&&B.isContentEditable)||os||Je||tt)return;const Ne=Date.now();if(P.key==="Enter"){const be=(Me.current||"").trim();Me.current="",be&&za(be);return}P.key.length===1&&(Ne-(Pt.current||0)>100&&(Me.current=""),Me.current+=P.key,Pt.current=Ne)};return window.addEventListener("keydown",d),()=>window.removeEventListener("keydown",d)},[r,Y,os,Je,tt]),i.useEffect(()=>{r&&o&&za(o)},[r,o]);const Aa=async()=>{if(y!=null&&y.uid)try{const d=w==null?void 0:w.shopId;let P,B=[];if(d){const ee=Ye(je(q,"products"),he("shopId","==",d),he("userId","==",y.uid));if(P=await et(ee),B=P.docs.map(Z=>({id:Z.id,name:String(Z.data().name??""),sellingPrice:Number(Z.data().sellingPrice??0),wholesalePrice:Number(Z.data().wholesalePrice??0),quantity:Number(Z.data().quantity??0),barcode:String(Z.data().barcode??""),serialNumber:String(Z.data().serialNumber??"")})),B.length===0){const Z=Ye(je(q,"products"),he("userId","==",y.uid)),pe=(await et(Z)).docs.map(be=>({id:be.id,name:String(be.data().name??""),sellingPrice:Number(be.data().sellingPrice??0),wholesalePrice:Number(be.data().wholesalePrice??0),quantity:Number(be.data().quantity??0),barcode:String(be.data().barcode??""),serialNumber:String(be.data().serialNumber??"")}));pe.length>0&&(B=pe,k({title:"تم استرجاع المنتجات",description:"عثرنا على منتجات محفوظة لك خارج المتجر الحالي وقمنا بعرضها."}))}}else{const ee=Ye(je(q,"products"),he("userId","==",y.uid));P=await et(ee),B=P.docs.map(Z=>({id:Z.id,name:String(Z.data().name??""),sellingPrice:Number(Z.data().sellingPrice??0),wholesalePrice:Number(Z.data().wholesalePrice??0),quantity:Number(Z.data().quantity??0),barcode:String(Z.data().barcode??""),serialNumber:String(Z.data().serialNumber??"")}))}if(ie(B),w!=null&&w.shopId&&B.length>0){const ee=B.filter(Z=>{const Ne=((P==null?void 0:P.docs)||[]).find(be=>be.id===Z.id);return!(!!Ne&&!!Ne.data().shopId)});if(ee.length>0)try{await Promise.all(ee.map(Z=>Yt(ze(q,"products",Z.id),{shopId:w.shopId,updatedAt:bt()}))),k({title:"تم ترتيب المنتجات",description:"تم ربط بعض المنتجات غير المربوطة بمتجرك الحالي تلقائياً."})}catch(Z){console.warn("تعذّر ترحيل shopId لبعض المنتجات:",Z)}}}catch(d){console.error("Error loading shop products:",d)}};i.useEffect(()=>{r&&(y!=null&&y.uid)&&(Aa(),Gt(),jt(),dt())},[r,y==null?void 0:y.uid,w==null?void 0:w.shopId]);const z=()=>{const d=new Date,P=d.getFullYear(),B=String(d.getMonth()+1).padStart(2,"0"),ee=String(d.getDate()).padStart(2,"0");return`${P}-${B}-${ee}`},Se=d=>{const P=B=>{if(typeof B.createdAtMs=="number")return B.createdAtMs;const ee=parseInt(B.id,10);if(!isNaN(ee))return ee;const Z=new Date(B.date);return isNaN(Z.getTime())?0:Z.getTime()};return[...d].sort((B,ee)=>P(ee)-P(B))},jt=()=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot load sales data");return}const d=E||(w==null?void 0:w.shopId)||"main",P=`salesData_all_${y.uid}_${d}`,B=localStorage.getItem(P);if(B)try{const Ae=JSON.parse(B);N(Array.isArray(Ae)?Se(Ae):[]);return}catch{}const ee=z(),Z=`salesData_${y.uid}_${d}_${ee}`,Ne=localStorage.getItem(Z);if(Ne){const Ae=JSON.parse(Ne),re=Array.isArray(Ae)?Se(Ae):[];N(re);try{localStorage.setItem(P,JSON.stringify(re))}catch{}return}const pe=new Date().toISOString().split("T")[0],be=`salesData_${y.uid}_${d}_${pe}`,Oe=localStorage.getItem(be);if(Oe){const Ae=JSON.parse(Oe),re=Array.isArray(Ae)?Se(Ae):[];N(re);try{localStorage.setItem(Z,JSON.stringify(re)),localStorage.setItem(P,JSON.stringify(re))}catch{}return}rs()},ft=d=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot save sales data");return}const P=E||(w==null?void 0:w.shopId)||"main",B=z(),ee=`salesData_${y.uid}_${P}_${B}`,Z=`salesData_all_${y.uid}_${P}`,Ne=Se(d);localStorage.setItem(ee,JSON.stringify(Ne));try{const pe=localStorage.getItem(Z),be=pe?JSON.parse(pe):[],Oe={};[...Array.isArray(be)?be:[],...Ne].forEach(St=>{Oe[St.id]=St});const Ae=Object.values(Oe),re=Se(Ae);localStorage.setItem(Z,JSON.stringify(re))}catch{}N(Ne)},js=d=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot save sales data");return}const P=E||(w==null?void 0:w.shopId)||"main",B=`salesData_all_${y.uid}_${P}`;try{const Z=localStorage.getItem(B),Ne=Z?JSON.parse(Z):[],pe={};[...Array.isArray(Ne)?Ne:[],...d].forEach(Ae=>{pe[Ae.id]=Ae});const be=Object.values(pe),Oe=Se(be);localStorage.setItem(B,JSON.stringify(Oe))}catch{}const ee=Se(d);N(ee)},rs=async()=>{if(y!=null&&y.uid)try{const d=E||(w==null?void 0:w.shopId)||null,P=new Date().toISOString().split("T")[0],B=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date);let ee,Z;try{const Ae=Ye(je(q,"dailySales"),he("userId","==",y.uid),...d?[he("shopId","==",d)]:[]);ee=await et(Ae)}catch{}try{const Ae=Ye(je(q,"users",y.uid,"dailySales"),...d?[he("shopId","==",d)]:[]);Z=await et(Ae)}catch{}const pe=[...ee?ee.docs:[],...Z?Z.docs:[]].map(Ae=>{var St,ds;const re=Ae.data();return{id:String(re.clientId||Ae.id),firestoreId:Ae.id,productName:String(re.productName||""),price:Number(re.sellingPrice||0),wholesalePrice:re.wholesalePrice!==void 0?Number(re.wholesalePrice):null,quantity:Number(re.quantity||0),date:String(re.date||P),time:String(re.time||""),serialNumber:re.serialNumber||void 0,barcode:re.barcode||void 0,performedByType:re.performedByType||void 0,performedByName:re.performedByName||void 0,performedByUsername:re.performedByUsername||void 0,isDeferred:!!re.isDeferred,customerName:re.customerName||void 0,customerMobile:re.customerMobile||void 0,customerId:re.customerId||void 0,createdAtMs:(ds=(St=re==null?void 0:re.createdAt)==null?void 0:St.toDate)!=null&&ds.call(St)?re.createdAt.toDate().getTime():new Date(String(re.date||P)).getTime()}}),be={};[...f,...pe].forEach(Ae=>{be[Ae.id]=Ae});const Oe=Object.values(be);js(Oe)}catch{}},Gt=async()=>{if(y!=null&&y.uid)try{const d=new Date,P=new Date(d.getFullYear(),d.getMonth(),1),B=new Date(d.getFullYear(),d.getMonth()+1,0),ee=re=>re.toISOString().split("T")[0],Z=ee(P),Ne=ee(B),pe=E||(w==null?void 0:w.shopId)||null;let be;try{const re=Ye(je(q,"dailySales"),he("userId","==",y.uid),...pe?[he("shopId","==",pe)]:[]);be=await et(re)}catch{const re=Ye(je(q,"users",y.uid,"dailySales"),...pe?[he("shopId","==",pe)]:[]);be=await et(re)}let Oe=0,Ae=0;be.forEach(re=>{const St=re.data(),ds=String(St.date??"").slice(0,10);if(!St.isDeferred&&ds>=Z&&ds<=Ne){const Os=Number(St.sellingPrice??0),pa=Number(St.quantity??0),Ds=Number(St.profit??(Number(St.sellingPrice??0)-Number(St.wholesalePrice??0))*pa);Oe+=Os*pa,Ae+=Ds}}),$t(Oe),We(Ae)}catch(d){console.error("Error loading monthly stats:",d)}},Ba=async d=>{if(!(y!=null&&y.uid))return null;try{const P=((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0),B=_&&Q?"cashier":"admin",ee=B==="cashier"?(Q==null?void 0:Q.name)||"كاشير":(w==null?void 0:w.fullName)||(y==null?void 0:y.displayName)||"الحساب الرئيسي",Z=B==="cashier"&&(Q==null?void 0:Q.username)||null,Ne=await ha(je(q,"dailySales"),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit:P,date:d.date,time:d.time,performedByType:B,performedByName:ee,performedByUsername:Z,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...w!=null&&w.shopId?{shopId:w.shopId}:E?{shopId:E}:{},createdAt:bt()});try{await ia(ze(q,"users",y.uid,"dailySales",Ne.id),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit:P,date:d.date,time:d.time,performedByType:B,performedByName:ee,performedByUsername:Z,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...w!=null&&w.shopId?{shopId:w.shopId}:E?{shopId:E}:{},createdAt:bt()})}catch{}return Ne.id}catch{try{const P=await ha(je(q,"users",y.uid,"dailySales"),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit,date:d.date,time:d.time,performedByType,performedByName,performedByUsername,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...w!=null&&w.shopId?{shopId:w.shopId}:E?{shopId:E}:{},createdAt:bt()});try{await ia(ze(q,"dailySales",P.id),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit,date:d.date,time:d.time,performedByType,performedByName,performedByUsername,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...w!=null&&w.shopId?{shopId:w.shopId}:E?{shopId:E}:{},createdAt:bt()})}catch{}return P.id}catch(P){return console.error("Error saving sale:",P),null}}},wa=()=>{const d=E||(w==null?void 0:w.shopId)||"main";return`cashBalance_${(y==null?void 0:y.uid)||"default"}_${d}`},Qr=async(d,P)=>{if(y!=null&&y.uid)try{const B=ze(q,"dailySales",d);await Yt(B,P)}catch{try{const B=ze(q,"users",y.uid,"dailySales",d);await Yt(B,P)}catch(B){console.error("Error updating sale:",B)}}},Rn=async d=>{try{const P=d.firestoreId;if(P)await Qr(P,{isDeferred:!1});else try{const B=Ye(je(q,"dailySales"),he("userId","==",(y==null?void 0:y.uid)||""),he("date","==",d.date),he("productName","==",d.productName),bn(5)),Z=(await et(B)).docs[0];Z&&await Yt(Z.ref,{isDeferred:!1})}catch{}N(B=>B.map(ee=>ee.id===d.id?{...ee,isDeferred:!1}:ee));try{await Gt()}catch{}k({title:"تم التسديد",description:`تم تسديد أجل ${d.productName}`})}catch(P){console.error("Error marking deferred sale as paid:",P),k({title:"فشل التسديد",description:"تعذّر تحديث حالة البيع المؤجّل",variant:"destructive"})}},dt=async()=>{if(!(y!=null&&y.uid))return;const d=f.filter(P=>!P.firestoreId);if(d.length!==0)for(const P of d)try{let B;try{const Z=Ye(je(q,"dailySales"),he("userId","==",y.uid),he("clientId","==",P.id),bn(1));B=await et(Z)}catch{const Z=Ye(je(q,"users",y.uid,"dailySales"),he("clientId","==",P.id),bn(1));B=await et(Z)}if(!B.empty){const Z=B.docs[0].id,Ne=f.map(pe=>pe.id===P.id?{...pe,firestoreId:Z}:pe);ft(Ne);continue}const ee=await Ba(P);if(ee){const Z=f.map(Ne=>Ne.id===P.id?{...Ne,firestoreId:ee}:Ne);ft(Z)}}catch{}},it=async d=>{try{if(y!=null&&y.uid)try{const Oe=je(q,"deficiencies"),Ae=await ha(Oe,{shopId:(w==null?void 0:w.shopId)||y.uid||"default-shop",name:d,quantity:1,status:"pending",createdAt:bt()});try{const re=`deficiencies_${(w==null?void 0:w.shopId)||(y==null?void 0:y.uid)||"default-shop"}`,St=localStorage.getItem(re),ds=St?JSON.parse(St):[],Os=Array.isArray(ds)?ds:[],pa=Os.some(Es=>String((Es==null?void 0:Es.id)||"")===Ae.id),Ds={id:Ae.id,name:d,quantity:1,status:"pending",createdAt:new Date().toISOString()},Ta=pa?Os:[...Os,Ds];localStorage.setItem(re,JSON.stringify(Ta))}catch{}k({title:"تمت الإضافة للنواقص",description:`المنتج ${d} نفد من المخزون وتمت إضافته للنواقص`});return}catch(Oe){console.warn("Failed to add deficiency to Firestore, falling back to local storage:",Oe)}const P=`deficiencies_${(w==null?void 0:w.shopId)||(y==null?void 0:y.uid)||"default-shop"}`,B=localStorage.getItem(P),ee=B?JSON.parse(B):[],Z=Array.isArray(ee)?ee:[];if(Z.some(Oe=>String((Oe==null?void 0:Oe.name)||"").trim()===d&&String((Oe==null?void 0:Oe.status)||"pending")==="pending"))return;const pe={id:Date.now().toString(),name:d,quantity:1,status:"pending",createdAt:new Date().toISOString()},be=[...Z,pe];localStorage.setItem(P,JSON.stringify(be)),k({title:"تمت الإضافة للنواقص",description:`المنتج ${d} نفد من المخزون وتمت إضافته للنواقص`})}catch(P){console.error("Error adding deficiency for out-of-stock:",P)}},Ks=async(d,P=!1,B)=>{const ee=me[d.id]||"",Z=parseInt(ee);if(isNaN(Z)||Z<=0){k({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(Z>d.quantity){k({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const Ne=new Date,pe=_&&Q?"cashier":"admin",be=pe==="cashier"?(Q==null?void 0:Q.name)||"كاشير":(w==null?void 0:w.fullName)||(y==null?void 0:y.displayName)||"الحساب الرئيسي",Oe=pe==="cashier"&&(Q==null?void 0:Q.username)||null,Ae=(d.serialNumber||"").trim(),re=gt[d.id]||"",St=parseFloat(re),ds=!isNaN(St)&&St>0?St:d.sellingPrice,Os={id:Date.now().toString(),productName:d.name,price:ds,wholesalePrice:d.wholesalePrice,quantity:Z,date:Ne.toISOString().split("T")[0],time:Ne.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),createdAtMs:Ne.getTime(),performedByType:pe,performedByName:be,performedByUsername:Oe,serialNumber:Ae||void 0,barcode:d.barcode,isDeferred:P,customerName:B==null?void 0:B.name,customerMobile:B==null?void 0:B.mobile,customerId:B==null?void 0:B.id};try{const pa=await Ba(Os),Ds=pa?{...Os,firestoreId:pa}:Os;ft([...f,Ds]);const Ta=d.quantity-Z;if(await Yt(ze(q,"products",d.id),{quantity:Ta,updatedAt:bt()}),ie(Es=>Es.map(Pa=>Pa.id===d.id?{...Pa,quantity:Ta}:Pa)),M(Es=>({...Es,[d.id]:""})),ms(Es=>({...Es,[d.id]:""})),Ta===0&&it(d.name),!P)try{const Es=ds*Z,Pa=wa(),$n=localStorage.getItem(Pa),jr=($n?parseFloat($n):0)+Es;localStorage.setItem(Pa,jr.toString());const Sr=`userData_${y==null?void 0:y.uid}`,Fn={cashBalance:jr,lastUpdated:new Date().toISOString()};localStorage.setItem(Sr,JSON.stringify(Fn)),y!=null&&y.uid&&Ce.updateUserData(y.uid,Fn).catch(()=>{});const Dr=(w==null?void 0:w.shopId)||E;if(Dr)try{await Yt(ze(q,"dashboardData",Dr),{cashBalance:jr})}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:jr}}))}catch{}try{if(y!=null&&y.uid){const Wn=`SALECASH-${y.uid}-${Date.now()}`,Gr={txnType:"cash_addition",type:"cash_addition",amount:Es,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:Wn,title:"إيصال إضافة نقدية",merchantUserId:y.uid,createdBy:y.uid,shopId:(w==null?void 0:w.shopId)||E||void 0,cashierName:be,performedByType:pe,performedByUsername:Oe,createdAt:new Date};await Ce.saveUserTransaction(y.uid,Gr)}}catch{}}catch(Es){console.warn("تعذر تحديث رصيد الدرج النقدي بعد البيع:",Es)}k({title:"تم البيع",description:`تم بيع ${Z} قطعة من ${d.name}`})}catch(pa){console.error("Error selling product:",pa),k({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},uo=async d=>{if(y!=null&&y.uid){if(_){k({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف إيصالات البيع أثناء الورديه",variant:"destructive"});return}ss("تأكيد حذف إيصال بيع","أدخل الرقم السري الرئيسي لحذف الإيصال وعكس الآثار",async()=>{try{const P=z(),B=`salesData_${y.uid}_${P}`,ee=`salesData_all_${y.uid}`,Z=f.filter(pe=>pe.id!==d.id);try{localStorage.setItem(B,JSON.stringify(Z));const pe=localStorage.getItem(ee),be=pe?JSON.parse(pe):[],Oe=(Array.isArray(be)?be:[]).filter(Ae=>(Ae==null?void 0:Ae.id)!==d.id);localStorage.setItem(ee,JSON.stringify(Oe))}catch{}N(Z);const Ne=[];if(!d.isDeferred)try{const pe=(d.price??0)*(d.quantity??0),be=wa(),Oe=localStorage.getItem(be),re=(Oe?parseFloat(Oe):0)-pe;localStorage.setItem(be,re.toString());const St=`userData_${y==null?void 0:y.uid}`,ds={cashBalance:re,lastUpdated:new Date().toISOString()};try{localStorage.setItem(St,JSON.stringify(ds))}catch{}y!=null&&y.uid&&Ne.push(Ce.updateUserData(y.uid,ds));const Os=(w==null?void 0:w.shopId)||E;Os&&Ne.push(Yt(ze(q,"dashboardData",Os),{cashBalance:re}).catch(()=>{}));try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:re}}))}catch{}}catch(pe){console.warn("تعذر عكس رصيد الدرج النقدي عند حذف الإيصال:",pe)}try{const pe=Y.find(be=>d.barcode&&be.barcode===d.barcode||be.name===d.productName);if(pe){const be=(pe.quantity||0)+(d.quantity||0);ie(Oe=>Oe.map(Ae=>Ae.id===pe.id?{...Ae,quantity:be}:Ae)),Ne.push(Yt(ze(q,"products",pe.id),{quantity:be,updatedAt:bt()}))}}catch(pe){console.warn("تعذر عكس المخزون عند حذف الإيصال:",pe)}try{d.firestoreId?(Ne.push(qs(ze(q,"dailySales",d.firestoreId)).catch(()=>{})),Ne.push(qs(ze(q,"users",y.uid,"dailySales",d.firestoreId)).catch(()=>{}))):Ne.push((async()=>{try{const pe=Ye(je(q,"dailySales"),he("userId","==",y.uid),he("date","==",d.date),he("productName","==",d.productName),bn(5));let be=await et(pe);if(be.empty){const Oe=Ye(je(q,"users",y.uid,"dailySales"),he("date","==",d.date),he("productName","==",d.productName),bn(5));be=await et(Oe)}if(!be.empty){const Oe=be.docs.find(Ae=>{const re=Ae.data();return Number((re==null?void 0:re.sellingPrice)??0)===Number(d.price??0)&&Number((re==null?void 0:re.quantity)??0)===Number(d.quantity??0)&&String((re==null?void 0:re.time)??"")===String(d.time??"")})||be.docs[0];Oe&&await qs(Oe.ref)}}catch(pe){console.warn("تعذر حذف سجل البيع من Firestore (استعلام بديل):",pe)}})())}catch(pe){console.warn("تعذر جدولة حذف سجل البيع من Firestore:",pe)}try{Re||setTimeout(()=>{try{Gt()}catch{}},0)}catch{}try{await Promise.allSettled(Ne)}catch{}k({title:"تم حذف الإيصال",description:`تم حذف إيصال بيع للمنتج ${d.productName} وتم عكس الآثار`})}catch(P){console.error("Error deleting sale:",P),k({title:"فشل حذف الإيصال",description:"تعذّر حذف إيصال البيع",variant:"destructive"})}})}},Ln=async d=>{try{M(P=>({...P,[d.id]:"1"})),await Ks(d)}catch(P){console.error("Error selling by barcode:",P)}},Ys=async d=>{if(_){k({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة قطع أثناء الورديه",variant:"destructive"});return}const P=F[d.id]||"",B=parseInt(P);if(isNaN(B)||B<=0){k({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للإضافة",variant:"destructive"});return}ss("تأكيد إضافة قطع","لا يمكن إضافة قطع إلا بإدخال الرقم السري الرئيسي",async()=>{try{const ee=d.quantity+B;await Yt(ze(q,"products",d.id),{quantity:ee,updatedAt:bt()}),ie(Z=>Z.map(Ne=>Ne.id===d.id?{...Ne,quantity:ee}:Ne)),le(Z=>({...Z,[d.id]:""})),k({title:"تمت الإضافة",description:`تمت إضافة ${B} قطعة إلى ${d.name}`})}catch(ee){console.error("Error adding pieces:",ee),k({title:"فشل الإضافة",description:"تعذّر إضافة الكمية إلى المخزون",variant:"destructive"})}})},Ua=async d=>{if(!(y!=null&&y.uid))return;if(_){k({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف المنتجات أثناء الورديه",variant:"destructive"});return}window.confirm(`هل تريد حذف المنتج "${d.name}"؟`)&&ss("تأكيد حذف منتج","لا يمكن حذف المنتجات إلا بإدخال الرقم السري الرئيسي",async()=>{try{await qs(ze(q,"products",d.id)),ie(B=>B.filter(ee=>ee.id!==d.id)),k({title:"تم الحذف",description:`تم حذف المنتج ${d.name}`})}catch(B){console.error("Error deleting product:",B),k({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}})},Ss=async()=>{try{if(!(y!=null&&y.uid)){k({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}if(_){k({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتجات أثناء الورديه",variant:"destructive"});return}const d=D.productName.trim(),P=parseFloat(D.price),B=parseFloat(D.wholesalePrice||"0"),ee=parseInt(D.quantity);if(!d||isNaN(P)||isNaN(ee)){k({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const Z={name:d,sellingPrice:P,wholesalePrice:isNaN(B)?0:B,quantity:isNaN(ee)?0:ee,userId:y.uid,createdAt:bt(),updatedAt:bt()},Ne=(D.barcode||"").trim();Ne&&(Z.barcode=Ne);const pe=(D.serialNumber||"").trim();pe&&(Z.serialNumber=pe),w!=null&&w.shopId&&(Z.shopId=w.shopId);const be=await ha(je(q,"products"),Z);ie(Oe=>[{id:be.id,name:d,sellingPrice:P,wholesalePrice:isNaN(B)?0:B,quantity:isNaN(ee)?0:ee,barcode:(D.barcode||"").trim()||"",serialNumber:(D.serialNumber||"").trim()||""},...Oe]),t({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),k({title:"تمت الإضافة",description:`تم إضافة المنتج ${d} بنجاح`})}catch(d){console.error("createProduct error",d),k({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}},za=async d=>{const P=(d||"").trim();if(!P)return;const B=Y.find(ee=>(ee.barcode||"")===P);if(!B){k({title:"باركود غير معروف",description:"لم يتم العثور على منتج بهذا الباركود"});return}await Ln(B)},cs=()=>{const d=Object.entries($e).map(([Oe,Ae])=>{const re=Number(Ae),St=Y.find(ds=>ds.id===Oe);return!St||!re||re<=0?null:{name:St.name,qty:re,price:St.sellingPrice,total:re*St.sellingPrice}}).filter(Boolean);if(d.length===0){k({title:"لم يتم اختيار منتجات",description:"فعّل وضع الفاتورة واختر منتجات وكميات للطباعة"});return}const P=(w==null?void 0:w.shopName)||(y==null?void 0:y.displayName)||"المحل",B=(w==null?void 0:w.phone)||(y==null?void 0:y.phoneNumber)||"",ee=d.reduce((Oe,Ae)=>Oe+Ae.total,0),Z=new Date().toLocaleString("ar-EG"),Ne=d.map(Oe=>`
        <tr>
          <td style="border:1px solid #ddd;padding:6px">${Oe.name}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${Oe.qty}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${Kt(Oe.price)}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center;font-weight:bold;color:#0a7">${Kt(Oe.total)}</td>
        </tr>
      `).join(""),pe=`
      <html>
        <head>
          <meta charset="utf-8" />
          <title>فاتورة</title>
          <style>
            body { font-family: Tahoma, Arial, sans-serif; direction: rtl; }
            .header { text-align: center; margin-bottom: 12px; }
            .header h2 { margin: 0; }
            .meta { text-align: center; color: #555; margin-bottom: 8px; }
            table { width: 100%; border-collapse: collapse; }
            .total { text-align: left; font-weight: bold; margin-top: 10px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>${P}</h2>
            ${B?`<div class="meta">رقم التليفون: ${B}</div>`:""}
            <div class="meta">التاريخ: ${Z}</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="border:1px solid #ddd;padding:6px">المنتج</th>
                <th style="border:1px solid #ddd;padding:6px">الكمية</th>
                <th style="border:1px solid #ddd;padding:6px">السعر</th>
                <th style="border:1px solid #ddd;padding:6px">الإجمالي</th>
              </tr>
            </thead>
            <tbody>
              ${Ne}
            </tbody>
          </table>
          <div class="total">الإجمالي الكلي: ${Kt(ee)}</div>
        </body>
      </html>
    `,be=window.open("","_blank");be&&(be.document.write(pe),be.document.close(),be.focus(),be.print(),be.close())};return e.jsxs(Te,{open:r,onOpenChange:m,children:[e.jsxs(Pe,{className:"max-w-none w-[100vw] md:w-[100vw] lg:w-[100vw] max-h-[85vh] md:h-[100dvh] md:max-h-[100dvh] p-0 overflow-y-auto",children:[e.jsx(ke,{className:"px-3 md:px-6 py-3 md:py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-blue-100 rounded-lg",children:e.jsx(ki,{className:"h-5 w-5 md:h-6 md:w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(_e,{className:"text-lg md:text-xl font-bold text-gray-800",children:"📊 قسم المبيعات"}),e.jsx("p",{className:"text-xs md:text-sm text-gray-600 mt-1 hidden sm:block",children:"إدارة وتتبع المبيعات"})]})]}),e.jsxs("div",{className:"flex items-center gap-1 md:gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:()=>dt(),className:"text-xs md:text-sm",children:"استرجاع الإيصالات"}),e.jsx(x,{variant:"ghost",size:"sm",onClick:m,className:"h-8 w-8 md:h-9 md:w-9",children:e.jsx(Ti,{className:"h-4 w-4"})})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row h-full",dir:"rtl",children:[e.jsxs("div",{className:"w-full md:w-72 lg:w-80 bg-white/50 border-r",children:[e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(es,{className:"h-4 w-4 text-green-600"}),"ملخص المبيعات"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:gap-3",children:[e.jsxs("div",{className:"bg-blue-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-blue-600",children:Kt(f.filter(d=>!d.isDeferred).reduce((d,P)=>d+P.price*P.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-blue-600",children:"إجمالي المبيعات"})]}),e.jsxs("div",{className:"relative bg-green-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsxs("div",{className:ne?"filter blur-sm pointer-events-none":"",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-green-600",children:Kt(f.filter(d=>!d.isDeferred).reduce((d,P)=>d+(P.price-(P.wholesalePrice??0))*P.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-green-600",children:"إجمالي الأرباح"})]}),ne&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>xe(!0),className:"bg-white/80 hover:bg-white text-green-700 border border-green-200",children:"عرض الأرباح"})})]}),e.jsxs("div",{className:"bg-yellow-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-yellow-600",children:Ga(Y.length)}),e.jsx("div",{className:"text-xs md:text-sm text-yellow-600",children:"عدد المنتجات"})]}),e.jsxs("div",{className:"bg-purple-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-purple-600",children:Ga(f.filter(d=>!d.isDeferred).length)}),e.jsx("div",{className:"text-xs md:text-sm text-purple-600",children:"عدد المبيعات"})]})]}),e.jsxs("div",{className:"relative mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1 md:gap-2 text-xs md:text-sm font-semibold text-indigo-700",children:[e.jsx(ir,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx(ki,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{children:"تقارير الشهر"})]}),e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>U(d=>!d),className:"h-6 w-6 p-0 rounded-full",title:X?"إظهار التقارير":"إخفاء التقارير",children:X?e.jsx(Pn,{className:"h-4 w-4"}):e.jsx(Ii,{className:"h-4 w-4"})})]}),e.jsx("div",{className:X?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]",children:e.jsxs("div",{className:Re?"grid grid-cols-2 gap-2 md:gap-4 filter blur-sm pointer-events-none":"grid grid-cols-2 gap-2 md:gap-4",children:[e.jsxs("div",{className:"bg-indigo-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-indigo-600",children:Kt(zt)}),e.jsx("div",{className:"text-xs md:text-sm text-indigo-600",children:"مبيعات الشهر"})]}),e.jsxs("div",{className:"bg-pink-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-pink-600",children:Kt(ts)}),e.jsx("div",{className:"text-xs md:text-sm text-pink-600",children:"أرباح الشهر"})]})]})}),!X&&Re&&e.jsx("div",{className:"absolute left-0 right-0 top-7 md:top-10 bottom-0 flex items-center justify-center rounded-lg bg-yellow-400/70 backdrop-blur-[2px]",children:e.jsxs(x,{size:"sm",variant:"ghost",onClick:async()=>{try{if(await isZeroPlan()){k({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}mt(!0)},className:"flex items-center gap-2 bg-amber-200/70 hover:bg-amber-300 text-amber-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all btn-monthly-reports",title:"عرض تقارير الشهر",children:[e.jsx(Ht,{className:"h-5 w-5 md:h-7 md:w-7"}),e.jsx("span",{className:"text-xs md:text-sm",children:"عرض تقارير الشهر"})]})})]})]}),e.jsx("div",{className:"flex justify-end mb-3",children:e.jsxs(x,{size:"sm",variant:"ghost",onClick:()=>Ot(!0),className:"h-7 px-3 rounded-full bg-green-50 hover:bg-green-100 text-green-700",title:"إيصالات البيع",children:[e.jsx(yr,{className:"h-4 w-4 mr-1"}),"إيصالات البيع"]})}),e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(Dn,{className:"h-4 w-4 text-indigo-600"}),"إحصائيات المنتجات"]}),e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>we(d=>!d),className:"h-6 w-6 p-0 rounded-full",title:W?"إظهار القسم":"إخفاء القسم",children:W?e.jsx(Pn,{className:"h-4 w-4"}):e.jsx(Ii,{className:"h-4 w-4"})})]}),e.jsx("div",{className:W?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]}),e.jsxs("div",{className:"p-3 md:p-4 flex-1 hidden md:block",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Xl,{className:"h-4 w-4 text-blue-600"}),"نصائح للمبيعات"]}),e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>pt(d=>!d),className:"h-6 w-6 p-0 rounded-full",title:Le?"إظهار القسم":"إخفاء القسم",children:Le?e.jsx(Pn,{className:"h-4 w-4"}):e.jsx(Ii,{className:"h-4 w-4"})})]}),e.jsx("div",{className:Le?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-visible transition-all duration-300 ease-in-out",children:e.jsxs("div",{className:"p-3 md:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-2",children:[e.jsxs("h2",{className:"text-base md:text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(ox,{className:"h-4 w-4 md:h-5 md:w-5 text-blue-600"}),"سجل المبيعات (",f.filter(d=>!d.isDeferred).length," عنصر)"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm text-gray-600",children:[e.jsx(ir,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(Fa,{className:"h-3 w-3 md:h-4 md:w-4 ml-2"}),e.jsx("span",{children:new Date().toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 md:p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(gs,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج جديد"]}),e.jsxs(x,{size:"sm",variant:"ghost",className:"h-8",onClick:()=>{if(_){k({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتج أثناء الورديه",variant:"destructive"});return}ss("فتح نموذج إضافة منتج","أدخل الرقم السري الرئيسي لفتح نموذج الإضافة",()=>R(!0))},children:[e.jsx(gs,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج"]})]}),S&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(se,{htmlFor:"new-product-name",className:"text-xs md:text-sm",children:"اسم المنتج"}),e.jsx(V,{id:"new-product-name",value:D.productName,onChange:d=>t(P=>({...P,productName:d.target.value})),placeholder:"أدخل اسم المنتج"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(se,{htmlFor:"new-product-price",className:"text-xs md:text-sm",children:"سعر البيع (ج.م)"}),e.jsx(V,{type:"number",id:"new-product-price",value:D.price,onChange:d=>t(P=>({...P,price:d.target.value})),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(se,{htmlFor:"new-product-wholesale",className:"text-xs md:text-sm",children:"سعر الجملة (ج.م)"}),e.jsx(V,{type:"number",id:"new-product-wholesale",value:D.wholesalePrice||"",onChange:d=>t(P=>({...P,wholesalePrice:d.target.value})),placeholder:"0.00"})]})]}),e.jsxs("div",{children:[e.jsx(se,{htmlFor:"new-product-qty",className:"text-xs md:text-sm",children:"الكمية"}),e.jsx(V,{type:"number",id:"new-product-qty",value:D.quantity,onChange:d=>t(P=>({...P,quantity:d.target.value})),placeholder:"1"})]}),e.jsxs("div",{children:[e.jsx(se,{htmlFor:"new-product-barcode",className:"text-xs md:text-sm",children:"باركود المنتج (اختياري)"}),e.jsx(V,{id:"new-product-barcode",value:D.barcode||"",onChange:d=>t(P=>({...P,barcode:d.target.value})),placeholder:"أدخل/امسح الباركود"})]}),e.jsxs("div",{children:[e.jsx(se,{htmlFor:"new-product-serial",className:"text-xs md:text-sm",children:"سيريال الجهاز (اختياري)"}),e.jsx(V,{id:"new-product-serial",value:D.serialNumber||"",onChange:d=>t(P=>({...P,serialNumber:d.target.value})),placeholder:"أدخل سيريال الجهاز"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(x,{className:"h-9 w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white",onClick:Ss,children:"إضافة المنتج"}),e.jsx(x,{variant:"outline",className:"h-9 w-full md:w-auto",onClick:()=>R(!1),children:"إغلاق"})]})]})]}),e.jsx("div",{id:"shop-products-section",className:"bg-white rounded-lg border border-gray-200 overflow-hidden mb-4",children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 mb-2 flex items-center gap-2",children:[e.jsx(Dn,{className:"h-4 w-4 text-green-600"}),"منتجات المحل"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(x,{variant:Be?"default":"outline",size:"sm",onClick:()=>qe(d=>!d),children:Be?"وضع الفاتورة: مفعل":"تفعيل وضع الفاتورة"}),e.jsx(x,{size:"sm",className:"bg-indigo-600 hover:bg-indigo-700 text-white",disabled:Object.keys($e).filter(d=>($e[d]||0)>0).length===0,onClick:cs,children:"طباعة فاتورة"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(V,{value:la,onChange:d=>Nr(d.target.value),placeholder:"ابحث عن منتج...",className:"h-9 w-full md:w-72 text-sm","aria-label":"البحث عن منتج من منتجات المحل"}),e.jsx(V,{value:ve,onChange:d=>ae(d.target.value),onKeyDown:async d=>{if(d.key!=="Enter")return;const P=ve.trim();P&&(await za(P),ae(""))},placeholder:"مرّر ماسح الباركود هنا (اختياري)",className:"h-9 w-full md:w-64 text-sm","aria-label":"مسح الباركود لإضافة المنتج تلقائياً"}),la&&e.jsx(x,{variant:"ghost",size:"sm",className:"h-9",onClick:()=>Nr(""),children:"مسح"})]}),e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg hidden md:block",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Ct(d=>!d),"aria-label":Ge?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Ge?e.jsx(_s,{className:"h-4 w-4"}):e.jsx(Ht,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المتاح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"بيع"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:Fs.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-3 py-3 text-center text-gray-500",children:Y.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"})}):Fs.map(d=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:d.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Kt(d.sellingPrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:e.jsx("span",{className:Ge?"":"blur-sm select-none",children:Kt(d.wholesalePrice)})}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Ga(d.quantity)}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 flex-nowrap",children:[e.jsx(V,{value:me[d.id]||"",onChange:P=>M(B=>({...B,[d.id]:P.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-8 w-28 text-sm"}),e.jsx(V,{value:gt[d.id]||"",onChange:P=>ms(B=>({...B,[d.id]:P.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-8 w-32 text-sm","aria-label":`سعر بيع اختياري لـ ${d.name}`}),e.jsx(x,{size:"sm",className:"h-8 min-w-[64px] bg-indigo-600 hover:bg-indigo-700 text-white",onClick:()=>Ks(d),children:"بيع"}),e.jsx(x,{size:"sm",className:"h-8 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>{H(d),ws(!0)},children:"بيع أجل"}),Be&&e.jsx(V,{value:$e[d.id]??"",onChange:P=>{const B=parseInt(P.target.value||"0");Qe(ee=>({...ee,[d.id]:isNaN(B)?0:B}))},type:"number",placeholder:"كمية للفاتورة",className:"h-8 w-24 text-sm"}),e.jsx(V,{value:F[d.id]||"",onChange:P=>le(B=>({...B,[d.id]:P.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-8 w-28 text-sm",disabled:_}),e.jsxs("div",{className:"inline-flex items-center gap-2 flex-nowrap",children:[e.jsx(x,{size:"sm",variant:"outline",className:"h-8 whitespace-nowrap",onClick:()=>Ys(d),disabled:_,title:_?"غير مسموح في وضع الكاشير":void 0,children:"إضافة قطع جديدة"}),e.jsx(x,{size:"sm",variant:"destructive",className:"h-8",onClick:()=>Ua(d),title:"حذف المنتج",disabled:_,children:e.jsx(ys,{className:"h-4 w-4"})})]})]})})]},d.id))})]})}),e.jsx("div",{className:"block md:hidden space-y-3",children:Fs.length===0?e.jsx("div",{className:"text-center text-gray-500 text-sm",children:Y.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"}):Fs.map(d=>e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm break-words",children:d.name}),e.jsx(x,{size:"sm",variant:"destructive",className:"h-8 min-w-[44px] touch-manipulation",onClick:()=>Ua(d),title:"حذف المنتج",disabled:_,children:e.jsx(ys,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-700",children:[e.jsx("div",{className:"text-gray-600",children:"سعر البيع"}),e.jsx("div",{className:"text-right font-medium",children:Kt(d.sellingPrice)}),e.jsxs("div",{className:"text-gray-600 inline-flex items-center gap-1",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>Ct(P=>!P),"aria-label":Ge?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Ge?e.jsx(_s,{className:"h-4 w-4"}):e.jsx(Ht,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:Ge?"":"blur-sm select-none",children:Kt(d.wholesalePrice)})}),e.jsx("div",{className:"text-gray-600",children:"المتاح"}),e.jsx("div",{className:"text-right font-medium",children:Ga(d.quantity)})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(V,{value:me[d.id]||"",onChange:P=>M(B=>({...B,[d.id]:P.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للبيع لـ ${d.name}`}),e.jsx(V,{value:gt[d.id]||"",onChange:P=>ms(B=>({...B,[d.id]:P.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-9 w-28 text-sm","aria-label":`سعر بيع اختياري لـ ${d.name}`}),e.jsx(x,{size:"sm",className:"h-9 min-w-[64px] bg-indigo-600 hover:bg-indigo-700 text-white",onClick:()=>Ks(d),children:"بيع"}),e.jsx(x,{size:"sm",className:"h-9 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>{H(d),ws(!0)},children:"بيع أجل"})]}),Be&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(V,{value:$e[d.id]??"",onChange:P=>{const B=parseInt(P.target.value||"0");Qe(ee=>({...ee,[d.id]:isNaN(B)?0:B}))},type:"number",placeholder:"كمية للفاتورة",className:"h-9 flex-1 text-sm","aria-label":`كمية للفاتورة لـ ${d.name}`})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(V,{value:F[d.id]||"",onChange:P=>le(B=>({...B,[d.id]:P.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للإضافة لـ ${d.name}`,disabled:_}),e.jsx(x,{size:"sm",variant:"outline",className:"h-9 min-w-[64px]",onClick:()=>Ys(d),disabled:_,title:_?"غير مسموح في وضع الكاشير":void 0,children:"إضافة"})]})]})]},d.id))})]})}),f.length===0?e.jsxs("div",{className:"text-center py-8 md:py-12",children:[e.jsx("div",{className:"w-16 h-16 md:w-24 md:h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx(Dn,{className:"h-8 w-8 md:h-12 md:w-12 text-gray-400"})}),e.jsx("h3",{className:"text-base md:text-lg font-medium text-gray-900 mb-2",children:"لا توجد مبيعات اليوم"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ابدأ ببيع منتج من القائمة أعلاه"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"block md:hidden",children:e.jsx("div",{className:"max-h-[70vh] overflow-y-auto space-y-3 p-3",children:f.map(d=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-200 shadow-sm",children:[e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-base break-words",children:d.productName}),d.isDeferred&&e.jsx("span",{className:"px-2 py-0.5 rounded bg-amber-100 text-amber-700 text-[11px]",children:"مؤجّل"})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(es,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر البيع"})]}),e.jsx("div",{className:"text-right font-medium",children:Kt(d.price)}),typeof d.wholesalePrice=="number"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(es,{className:"h-4 w-4 text-indigo-600"}),e.jsxs("span",{className:"text-gray-600 inline-flex items-center gap-1",children:["سعر الجملة",e.jsx(x,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>Ct(P=>!P),"aria-label":Ge?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Ge?e.jsx(_s,{className:"h-4 w-4"}):e.jsx(Ht,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:Ge?"":"blur-sm select-none",children:Kt(d.wholesalePrice)})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Dn,{className:"h-4 w-4 text-emerald-600"}),e.jsx("span",{className:"text-gray-600",children:"الكمية"})]}),e.jsx("div",{className:"text-right font-medium",children:Ga(d.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(An,{className:"h-4 w-4 text-indigo-600"}),e.jsx("span",{className:"text-gray-600",children:"الربح"})]}),e.jsx("div",{className:"text-right font-semibold text-indigo-600",children:e.jsx("span",{className:Ge?"":"blur-sm select-none",children:Kt(((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0))})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(es,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"الإجمالي"})]}),e.jsx("div",{className:"text-right font-bold text-green-700",children:Kt(d.price*d.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(nx,{className:"h-4 w-4 text-amber-600"}),e.jsx("span",{className:"text-gray-600",children:"المنفذ"})]}),e.jsx("div",{className:"text-right text-gray-700",children:d.performedByName??"-"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ir,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"التاريخ"})]}),e.jsx("div",{className:"text-right text-gray-600",children:Yl(d.date)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fa,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"الوقت"})]}),e.jsx("div",{className:"text-right text-gray-600",children:d.time})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[d.isDeferred&&e.jsx(x,{size:"sm",className:"h-8 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>Rn(d),title:"تم التسديد",children:"تم التسديد"}),e.jsx(x,{size:"sm",variant:"outline",onClick:()=>sa(d,"return"),disabled:_,title:_?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsxs(x,{size:"sm",variant:"destructive",onClick:()=>sa(d,"delete"),disabled:_,title:_?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:[e.jsx(ys,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-1",children:"حذف الإيصال"})]})]})]},d.id))})}),e.jsx("div",{className:"hidden md:block overflow-x-auto max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-green-300 scrollbar-track-green-100 hover:scrollbar-thumb-green-400",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر البيع (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة (ج.م)"}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Ct(d=>!d),"aria-label":Ge?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Ge?e.jsx(_s,{className:"h-4 w-4"}):e.jsx(Ht,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الإجمالي (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الربح (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الوقت"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنفذ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"إجراءات"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:f.map((d,P)=>e.jsxs("tr",{className:P%2===0?"bg-white":"bg-gray-50/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:e.jsxs("div",{className:"flex items-center gap-2 justify-end md:justify-start",children:[e.jsx("span",{children:d.productName}),d.isDeferred&&e.jsx("span",{className:"px-2 py-0.5 rounded bg-amber-100 text-amber-700 text-xs",children:"مؤجّل"})]})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Kt(d.price)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:typeof d.wholesalePrice=="number"?e.jsx("span",{className:Ge?"":"blur-sm select-none",children:Kt(d.wholesalePrice)}):"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Ga(d.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-green-600",children:Kt(d.price*d.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-indigo-600",children:e.jsx("span",{className:Ge?"":"blur-sm select-none",children:Kt(((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0))})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:Yl(d.date)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:d.time}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:d.performedByName??"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[d.isDeferred&&e.jsx(x,{size:"sm",className:"h-8 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>Rn(d),title:"تم التسديد",children:"تم التسديد"}),e.jsx(x,{size:"sm",variant:"outline",onClick:()=>sa(d,"return"),disabled:_,title:_?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsx(x,{size:"sm",variant:"destructive",onClick:()=>sa(d,"delete"),disabled:_,title:_?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:e.jsx(ys,{className:"h-4 w-4"})})]})})]},d.id))})]})})]})]})})]})]}),e.jsx(Te,{open:va,onOpenChange:ws,children:e.jsxs(Pe,{className:"max-w-sm mx-auto bg-white border border-gray-200 shadow-2xl rounded-2xl sm:max-w-md",children:[e.jsx(ke,{className:"text-center",children:e.jsx(_e,{className:"text-base md:text-lg font-bold text-gray-900",children:"بيع أجل"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsx(se,{className:"text-sm",children:"اختيار عميل (اختياري)"}),e.jsxs("select",{className:"h-9 border rounded px-2 text-sm",value:O,onChange:d=>{const P=d.target.value;fe(P);const B=Ia.find(ee=>ee.id===P);B&&(Fe(B.name),vt(B.mobile||""))},children:[e.jsx("option",{value:"",children:"-- بدون اختيار --"}),Ia.map(d=>e.jsxs("option",{value:d.id,children:[d.name,d.mobile?` - ${d.mobile}`:""]},d.id))]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsx(se,{className:"text-sm",children:"اسم العميل"}),e.jsx(V,{value:ge,onChange:d=>Fe(d.target.value),placeholder:"اسم العميل",className:"h-9 text-sm"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsx(se,{className:"text-sm",children:"رقم التليفون (اختياري)"}),e.jsx(V,{value:Ve,onChange:d=>vt(d.target.value),placeholder:"رقم التليفون",className:"h-9 text-sm"})]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-3 mt-3",children:[e.jsx(x,{variant:"outline",className:"h-8 min-w-[80px]",onClick:()=>ws(!1),children:"إلغاء"}),e.jsx(x,{className:"h-8 min-w-[100px] bg-amber-600 hover:bg-amber-700 text-white",onClick:async()=>{try{const d=Nt;if(!d){ws(!1);return}const P=ge.trim(),B=Ve.trim()||void 0,ee=O||void 0;if(!P){k({title:"بيانات مطلوبة",description:"أدخل اسم العميل",variant:"destructive"});return}await Ks(d,!0,{id:ee,name:P,mobile:B});try{if(y!=null&&y.uid){const Z=d.sellingPrice*(parseInt(me[d.id]||"0")||0),Ne=await Ce.getUserData(y.uid),pe=Array.isArray(Ne==null?void 0:Ne.debts)?Ne.debts:[],be={id:Date.now().toString(),debtorName:P,customerId:ee||null,mobile:B||null,amount:Z,reason:`بيع أجل للمنتج ${d.name}`,status:"pending",createdAt:new Date,partialPayments:[]},Oe=[be,...pe];Ce.updateUserData(y.uid,{debts:Oe}).catch(()=>{});try{const Ae=E||(w==null?void 0:w.shopId)||"main";localStorage.setItem(`debts_${y.uid}_${Ae}`,JSON.stringify(Oe)),localStorage.setItem(`debts_default_${Ae}`,JSON.stringify(Oe)),localStorage.setItem(`debts_last_write_${y.uid}_${Ae}`,Date.now().toString())}catch{}try{window.dispatchEvent(new CustomEvent("debtsUpdated",{detail:{count:Oe.length}}))}catch{}try{Za.send(y.uid,`تم إضافة دين على ${be.debtorName} بمبلغ ${be.amount} جنيه`).catch(()=>{})}catch{}}}catch{}ws(!1),H(null)}catch{}},children:"تأكيد البيع الآجل"})]})]})}),e.jsx(Te,{open:Rt,onOpenChange:Ot,children:e.jsxs(Pe,{className:"sm:max-w-3xl",children:[e.jsx(ke,{children:e.jsx(_e,{children:"إيصالات البيع"})}),f.filter(d=>!d.isDeferred).length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا توجد إيصالات بيع حتى الآن."}):e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg max-h-[70vh] overflow-y-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر الجملة"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الإجمالي"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الربح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الوقت"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنفذ"})]})}),e.jsx("tbody",{children:f.filter(d=>!d.isDeferred).map(d=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:d.productName}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Kt(d.price)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Kt(d.wholesalePrice??0)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Ga(d.quantity)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Kt((d.price??0)*(d.quantity??0))}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Kt(((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0))}),e.jsx("td",{className:"px-3 py-2 text-gray-500",children:Yl(d.date)}),e.jsx("td",{className:"px-3 py-2 text-gray-500",children:d.time}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:d.executedBy||"-"})]},d.id))})]})}),e.jsx("div",{className:"flex justify-end mt-3",children:e.jsx(x,{variant:"outline",onClick:()=>Ot(!1),children:"إغلاق"})})]})}),e.jsx(Te,{open:ye,onOpenChange:G,children:e.jsxs(Pe,{className:"max-w-sm mx-auto bg-white border border-gray-200 shadow-2xl rounded-2xl sm:max-w-md",children:[e.jsx(ke,{className:"text-center",children:e.jsx(_e,{className:"text-base md:text-lg font-bold text-gray-900",children:as==="return"?"تأكيد المرتجع":"تأكيد حذف الإيصال"})}),e.jsxs("div",{className:"space-y-3 text-center px-2",children:[e.jsxs("p",{className:"text-sm text-gray-700",children:["هل تريد ",as==="return"?"عمل مرتجع":"حذف الإيصال"," للمنتج:",e.jsxs("span",{className:"font-semibold text-gray-900",children:[" ",ht==null?void 0:ht.productName," "]}),"بكمية",e.jsxs("span",{className:"font-semibold text-gray-900",children:[" ",Ga((ht==null?void 0:ht.quantity)||0)," "]}),"؟"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"سيتم عكس المخزون والرصيد حسب الحالة."})]}),e.jsxs("div",{className:"flex items-center justify-center gap-3 mt-2",children:[e.jsx(x,{variant:"outline",className:"h-8 min-w-[80px]",onClick:()=>G(!1),children:"إلغاء"}),e.jsx(x,{className:"h-8 min-w-[100px] bg-red-600 hover:bg-red-700 text-white",onClick:()=>{const d=ht;G(!1),d&&uo(d)},children:"تأكيد"})]})]})}),e.jsx(fs,{open:tt,onOpenChange:xe,mode:"verify",title:"قفل إجمالي الأرباح",description:"أدخل الرقم السري الرئيسي لعرض إجمالي الأرباح",onSuccess:()=>{Ie(!1),xe(!1)}}),e.jsx(fs,{open:Je,onOpenChange:mt,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const d=y==null?void 0:y.uid;if(d){const P=await co(d),B=(P==null?void 0:P.planType)??(P==null?void 0:P.plan)??null,ee=typeof B=="string"?B.toLowerCase():null;if(B===ea.ZERO||ee==="zero"){k({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}Xe(!1),mt(!1),Gt()}}),e.jsx(fs,{open:os,onOpenChange:Lt,mode:"verify",title:nt,description:Qt,onSuccess:()=>{const d=hs.current;hs.current=null,Lt(!1),d&&d()}})]})}const Ga=r=>new Intl.NumberFormat("ar-EG").format(Number(r||0)),Kt=r=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(r||0))} ج.م`,Yl=r=>{try{const m=new Date(r);return isNaN(m.getTime())?new Date(`${r}T00:00:00`).toLocaleDateString("ar-EG"):m.toLocaleDateString("ar-EG")}catch{return r}},Gx=({open:r,onOpenChange:m,userId:o,cashBalance:f,walletBalances:N,transactions:D})=>{const[t,S]=He.useState(0),[R,C]=He.useState(0),[L,k]=He.useState(0),[y,w]=He.useState(0),[_,Q]=He.useState(f||0),[E,Y]=He.useState(!1),[ie,me]=He.useState(null),{toast:M}=xa(),{shopId:F}=Ei()||{},{profile:le}=Ca(),[Ee,ue]=He.useState(!1),[ve,ae]=He.useState(""),[Be,qe]=He.useState(!1),[$e,Qe]=He.useState(!1),[Ge,Ct]=He.useState(""),ne=()=>`cashBalance_${o||"default"}_${F||(le==null?void 0:le.shopId)||"main"}`,Ie=We=>`${new Intl.NumberFormat("ar-EG").format(Number(We||0))} جنيه`;He.useEffect(()=>{const We=async()=>{try{if(!o){S(0);return}const Re=new Date,Xe=Re.getFullYear(),X=String(Re.getMonth()+1).padStart(2,"0"),U=String(Re.getDate()).padStart(2,"0"),Rt=`${Xe}-${X}-${U}`;let Ot;try{const we=Ye(je(q,"dailySales"),he("userId","==",o),...F?[he("shopId","==",F)]:[],he("date","==",Rt));Ot=await et(we)}catch{const we=Ye(je(q,"users",o,"dailySales"),...F?[he("shopId","==",F)]:[],he("date","==",Rt));Ot=await et(we)}let W=0;Ot.forEach(we=>{const Le=we.data(),pt=Number(Le.sellingPrice??0),gt=Number(Le.quantity??0);pt>0&&gt>0&&(W+=pt*gt)}),S(W)}catch(Re){console.warn("فشل تحميل مبيعات الإكسسوار لليوم:",Re)}},Je=async()=>{try{if(!o){setMaintenanceProfitToday(0);return}const Re=new Date,Xe=new Date(Re.getFullYear(),Re.getMonth(),Re.getDate(),0,0,0,0),X=new Date(Re.getFullYear(),Re.getMonth(),Re.getDate(),23,59,59,999);let U;try{const Ot=Ye(je(q,"maintenance_items"),he("userId","==",o),he("status","==","completed"));U=await et(Ot)}catch{U=await et(Ye(je(q,"maintenance_items"),he("userId","==",o)))}let Rt=0;U.forEach(Ot=>{var Le,pt;const W=Ot.data();if((W.status||"in_progress")!=="completed")return;const we=(pt=(Le=W.completedAt)==null?void 0:Le.toDate)==null?void 0:pt.call(Le);if(we&&we.getTime()>=Xe.getTime()&&we.getTime()<=X.getTime()){const gt=Number(W.repairPrice||0);Number.isFinite(gt)&&gt>0&&(Rt+=gt)}}),k(Math.max(0,Rt))}catch(Re){console.warn("فشل تحميل إجمالي فلوس الصيانة لليوم:",Re)}},mt=async()=>{var Re;try{if(!o){C(0);return}const Xe=await Ce.getUserData(o),X=new Date().toISOString().slice(0,10),U=(Xe==null?void 0:Xe.dailyReceipts)||{};U!=null&&U.date&&String(U.date).slice(0,10)===X?(C(Number(U.accessory||0)),w(Number(U.maintenance||0))):(C(0),w(0));try{const Rt=F||(le==null?void 0:le.shopId)||"main",Ot=await Sa(ze(q,"dashboardData",Rt));if(Ot.exists()){const W=Number(((Re=Ot.data())==null?void 0:Re.cashBalance)||0);Q(W);try{localStorage.setItem(`cashBalance_${o}`,String(W)),localStorage.setItem(ne(),String(W))}catch{}}else Q(Number((Xe==null?void 0:Xe.cashBalance)||f||0))}catch{Q(Number((Xe==null?void 0:Xe.cashBalance)||f||0))}}catch{C(0),w(0)}};r&&(We(),Je(),mt())},[r,o,D,f,F]),He.useEffect(()=>{const We=Je=>{var mt;try{const Re=Number((mt=Je==null?void 0:Je.detail)==null?void 0:mt.value);Number.isFinite(Re)&&Q(Re)}catch{}};return window.addEventListener("cashBalanceChanged",We),()=>window.removeEventListener("cashBalanceChanged",We)},[r]),He.useEffect(()=>{if(!r||!o)return;const We=F||(le==null?void 0:le.shopId)||"main";let Je=null;try{Je=zs(ze(q,"dashboardData",We),mt=>{var Re;try{if(mt.exists()){const Xe=Number(((Re=mt.data())==null?void 0:Re.cashBalance)||0);Q(Xe);try{localStorage.setItem(`cashBalance_${o}`,String(Xe)),localStorage.setItem(ne(),String(Xe))}catch{}}}catch{}})}catch{}return()=>{try{typeof Je=="function"&&Je()}catch{}}},[r,o,F]);const tt=Math.max(0,Number(t)-Number(R)),xe=Math.max(0,Number(L)-Number(y)),Me=async We=>{if(!o)return;const Je=new Date().toISOString().slice(0,10);try{const mt=We==="accessory"?tt:xe;if(mt<=0){M({title:"لا يوجد مبلغ لتأكيد استلامه",variant:"default"});return}const Re=Math.max(0,Number(_)-mt);Q(Re),We==="accessory"?C(Xe=>Xe+mt):w(Xe=>Xe+mt),await Ce.updateUserData(o,{cashBalance:Re,dailyReceipts:{date:Je,accessory:We==="accessory"?R+mt:R,maintenance:We==="maintenance"?y+mt:y}});try{const Xe=F||(le==null?void 0:le.shopId)||"main";await Yt(ze(q,"dashboardData",Xe),{cashBalance:Re,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${o}`,String(Re)),localStorage.setItem(ne(),String(Re))}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:Re}}))}catch{}M({title:"تم الاستلام",description:`تم خصم ${mt.toFixed(2)} من الدرج وتصفير بند ${We==="accessory"?"الإكسسوار":"الصيانة"}`})}catch{M({title:"خطأ",description:"تعذر تنفيذ عملية تم الاستلام",variant:"destructive"})}},Pt=()=>{ae(""),Ct(""),ue(!0)},zt=()=>{if(!ve.trim()){M({title:"سبب الخصم مطلوب",variant:"destructive"});return}ue(!1),qe(!0)},$t=()=>{qe(!1),Qe(!0)},ts=async()=>{try{if(!o)return;const We=Math.max(0,Number(Ge||0));if(!Number.isFinite(We)||We<=0){M({title:"مبلغ غير صالح",description:"أدخل مبلغ خصم صحيح أكبر من الصفر",variant:"destructive"});return}const Je=Math.max(0,Number(_)-We);Q(Je),await Ce.updateUserData(o,{cashBalance:Je});try{const Re=F||(le==null?void 0:le.shopId)||"main";await Yt(ze(q,"dashboardData",Re),{cashBalance:Je,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${o}`,String(Je))}catch{}try{const Re=new Date().toISOString();localStorage.setItem(ne(),String(Je)),localStorage.setItem(ne()+"_lastUpdated",Re)}catch{}const mt={title:"ايصال خصم من الفلوس النقديه",type:"cash_deduction",amount:We,status:"completed",createdAt:new Date,note:ve,cashierName:"الحساب الرئيسي"};try{await Ce.saveUserTransaction(o,mt)}catch{}M({title:"تم الخصم",description:`تم خصم ${We.toFixed(2)} من الدرج`}),Qe(!1),Ct(""),ae("")}catch{M({title:"فشل الخصم",description:"تعذر تنفيذ عملية الخصم",variant:"destructive"})}};return e.jsx(Te,{open:r,onOpenChange:m,children:e.jsxs(Pe,{className:"sm:max-w-lg animate-in fade-in-90 zoom-in-95 slide-in-from-top-4",dir:"rtl",children:[e.jsx(ke,{children:e.jsxs(_e,{className:"flex items-center gap-2 text-right",children:[e.jsx(es,{className:"h-5 w-5 text-emerald-600"}),"تفاصيل الفلوس النقدية"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between bg-amber-50 border border-amber-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 font-bold text-sm",children:[e.jsx(es,{className:"h-4 w-4"}),"مجموع الفلوس النقدية (الدرج)"]}),e.jsx("div",{className:"text-amber-700 font-extrabold text-sm",children:Ie(_)})]}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 font-bold text-sm",children:[e.jsx(Dn,{className:"h-4 w-4"}),"فلوس الاكسسوار"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-blue-700 font-extrabold text-sm",children:Ie(tt)}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800",onClick:()=>{me("accessory"),Y(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-emerald-50 border border-emerald-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-800 font-bold text-sm",children:[e.jsx(mo,{className:"h-4 w-4"}),"فلوس الصيانة"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-emerald-700 font-extrabold text-sm",children:Ie(xe)}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800",onClick:()=>{me("maintenance"),Y(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-red-800 font-bold text-sm",children:"خصم فلوس من الفلوس النقديه"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(x,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800",onClick:Pt,children:"خصم"})})]})]}),e.jsx(fs,{open:E,onOpenChange:Y,mode:"verify",title:"تأكيد الرقم السري لعملية تم الاستلام",description:"يرجى إدخال الرقم السري الرئيسي لتأكيد استلام المبلغ",onSuccess:()=>{ie&&(Me(ie),me(null)),Y(!1)}}),e.jsx(Te,{open:Ee,onOpenChange:ue,children:e.jsxs(Pe,{className:"sm:max-w-sm",children:[e.jsx(ke,{children:e.jsx(_e,{children:"سبب الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"deduct-reason",children:"اكتب سبب الخصم"}),e.jsx(V,{id:"deduct-reason",value:ve,onChange:We=>ae(We.target.value),placeholder:"سبب الخصم"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(x,{variant:"outline",onClick:()=>ue(!1),children:"إلغاء"}),e.jsx(x,{onClick:zt,className:"bg-red-600 hover:bg-red-700",children:"متابعة"})]})]})}),e.jsx(fs,{open:Be,onOpenChange:qe,mode:"verify",title:"تأكيد الرقم السري لعملية الخصم",description:"يرجى إدخال الرقم السري الرئيسي لمتابعة الخصم",onSuccess:$t}),e.jsx(Te,{open:$e,onOpenChange:Qe,children:e.jsxs(Pe,{className:"sm:max-w-sm",children:[e.jsx(ke,{children:e.jsx(_e,{children:"مبلغ الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"deduct-amount",children:"أدخل مبلغ الخصم"}),e.jsx(V,{id:"deduct-amount",type:"number",value:Ge,onChange:We=>Ct(We.target.value),placeholder:"0.00"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(x,{variant:"outline",onClick:()=>Qe(!1),children:"إلغاء"}),e.jsx(x,{onClick:ts,className:"bg-red-600 hover:bg-red-700",children:"تأكيد الخصم"})]})]})})]})})};function $d({size:r=24,className:m,...o}){return e.jsxs("svg",{width:r,height:r,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:m,...o,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}var Fd="AlertDialog",[Zx]=fu(Fd,[jd]),Wa=jd(),Wd=r=>{const{__scopeAlertDialog:m,...o}=r,f=Wa(m);return e.jsx(xu,{...f,...o,modal:!0})};Wd.displayName=Fd;var Xx="AlertDialogTrigger",ep=i.forwardRef((r,m)=>{const{__scopeAlertDialog:o,...f}=r,N=Wa(o);return e.jsx(Su,{...N,...f,ref:m})});ep.displayName=Xx;var tp="AlertDialogPortal",Bd=r=>{const{__scopeAlertDialog:m,...o}=r,f=Wa(m);return e.jsx(pu,{...f,...o})};Bd.displayName=tp;var sp="AlertDialogOverlay",Ud=i.forwardRef((r,m)=>{const{__scopeAlertDialog:o,...f}=r,N=Wa(o);return e.jsx(ju,{...N,...f,ref:m})});Ud.displayName=sp;var qr="AlertDialogContent",[ap,rp]=Zx(qr),np=vu("AlertDialogContent"),zd=i.forwardRef((r,m)=>{const{__scopeAlertDialog:o,children:f,...N}=r,D=Wa(o),t=i.useRef(null),S=Sd(m,t),R=i.useRef(null);return e.jsx(gu,{contentName:qr,titleName:qd,docsSlug:"alert-dialog",children:e.jsx(ap,{scope:o,cancelRef:R,children:e.jsxs(yu,{role:"alertdialog",...D,...N,ref:S,onOpenAutoFocus:bu(N.onOpenAutoFocus,C=>{var L;C.preventDefault(),(L=R.current)==null||L.focus({preventScroll:!0})}),onPointerDownOutside:C=>C.preventDefault(),onInteractOutside:C=>C.preventDefault(),children:[e.jsx(np,{children:f}),e.jsx(lp,{contentRef:t})]})})})});zd.displayName=qr;var qd="AlertDialogTitle",Vd=i.forwardRef((r,m)=>{const{__scopeAlertDialog:o,...f}=r,N=Wa(o);return e.jsx(wu,{...N,...f,ref:m})});Vd.displayName=qd;var Jd="AlertDialogDescription",Kd=i.forwardRef((r,m)=>{const{__scopeAlertDialog:o,...f}=r,N=Wa(o);return e.jsx(Nu,{...N,...f,ref:m})});Kd.displayName=Jd;var ip="AlertDialogAction",Yd=i.forwardRef((r,m)=>{const{__scopeAlertDialog:o,...f}=r,N=Wa(o);return e.jsx(Dd,{...N,...f,ref:m})});Yd.displayName=ip;var Hd="AlertDialogCancel",Qd=i.forwardRef((r,m)=>{const{__scopeAlertDialog:o,...f}=r,{cancelRef:N}=rp(Hd,o),D=Wa(o),t=Sd(m,N);return e.jsx(Dd,{...D,...f,ref:t})});Qd.displayName=Hd;var lp=({contentRef:r})=>{const m=`\`${qr}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${qr}\` by passing a \`${Jd}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${qr}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return i.useEffect(()=>{var f;document.getElementById((f=r.current)==null?void 0:f.getAttribute("aria-describedby"))||console.warn(m)},[m,r]),null},op=Wd,cp=Bd,Gd=Ud,Zd=zd,Xd=Yd,em=Qd,tm=Vd,sm=Kd;const dp=op,mp=cp,am=i.forwardRef(({className:r,...m},o)=>e.jsx(Gd,{className:vr("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",r),...m,ref:o}));am.displayName=Gd.displayName;const rm=i.forwardRef(({className:r,...m},o)=>e.jsxs(mp,{children:[e.jsx(am,{}),e.jsx(Zd,{ref:o,className:vr("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg rounded-2xl duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",r),...m})]}));rm.displayName=Zd.displayName;const nm=({className:r,...m})=>e.jsx("div",{className:vr("flex flex-col space-y-2 text-center sm:text-left",r),...m});nm.displayName="AlertDialogHeader";const im=i.forwardRef(({className:r,...m},o)=>e.jsx(tm,{ref:o,className:vr("text-lg font-semibold",r),...m}));im.displayName=tm.displayName;const lm=i.forwardRef(({className:r,...m},o)=>e.jsx(sm,{ref:o,className:vr("text-sm text-muted-foreground",r),...m}));lm.displayName=sm.displayName;const oo=i.forwardRef(({className:r,...m},o)=>e.jsx(Xd,{ref:o,className:vr(Cd(),r),...m}));oo.displayName=Xd.displayName;const om=i.forwardRef(({className:r,...m},o)=>e.jsx(em,{ref:o,className:vr(Cd({variant:"outline"}),"mt-2 sm:mt-0",r),...m}));om.displayName=em.displayName;const Bt=r=>{try{return r.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(r)}},xd=r=>{try{return(r?new Date(r):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},Ma="machine_daily_opening_values",Ra="machine_daily_opening_snapshot";function hp({open:r,onOpenChange:m}){const{toast:o}=xa(),{shiftUser:f}=Mn(),{shopId:N,shopName:D}=Ei(),t=()=>{try{const O=Object.keys(localStorage||{}).filter(fe=>fe.startsWith("selectedShopId_"));for(const fe of O){const ge=localStorage.getItem(fe);if(ge)return ge}return null}catch{return null}};i.useEffect(()=>{try{if(r){const O=document.body.style.overflow;document.body.setAttribute("data-prev-overflow",O),document.body.style.overflow="hidden"}else{const O=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=O,document.body.removeAttribute("data-prev-overflow")}}catch{}return()=>{try{const O=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=O,document.body.removeAttribute("data-prev-overflow")}catch{}}},[r]);const[S,R]=i.useState(""),[C,L]=i.useState(""),[k,y]=i.useState(""),[w,_]=i.useState(null),[Q,E]=i.useState(null),[Y,ie]=i.useState(null),[me,M]=i.useState(null),[F,le]=i.useState(!1),[Ee,ue]=i.useState(!1),[ve,ae]=i.useState(""),[Be,qe]=i.useState(""),[$e,Qe]=i.useState(null),[Ge,Ct]=i.useState([]),[ne,Ie]=i.useState([]),[tt,xe]=i.useState(!1),[Me,Pt]=i.useState(""),[zt,$t]=i.useState(""),[ts,We]=i.useState(!1),[Je,mt]=i.useState(null),[Re,Xe]=i.useState([]),[X,U]=i.useState(null),[Rt,Ot]=i.useState(""),[W,we]=i.useState(!1),[Le,pt]=i.useState(!1);i.useEffect(()=>{if(r)try{const O=X?`${Ma}_${X}`:Ma,fe=X?`${Ra}_${X}`:Ra,ge=localStorage.getItem(O);if(ge){const Ve=JSON.parse(ge);typeof(Ve==null?void 0:Ve.openingBase)=="number"&&_(Ve.openingBase),typeof(Ve==null?void 0:Ve.openingAir)=="number"&&E(Ve.openingAir),typeof(Ve==null?void 0:Ve.drawerCash)=="number"&&ie(Ve.drawerCash)}else _(null),E(null),ie(null);const Fe=localStorage.getItem(fe);if(Fe){const Ve=JSON.parse(Fe);typeof(Ve==null?void 0:Ve.openingBase)=="number"&&typeof(Ve==null?void 0:Ve.openingAir)=="number"?M({openingBase:Ve.openingBase,openingAir:Ve.openingAir,drawerCash:Ve.drawerCash||0}):M(null)}else M(null)}catch{}},[r,X]),i.useEffect(()=>{(async()=>{try{const O=N||t();if(!r||!O)return;const{getDocs:fe}=await wt(async()=>{const{getDocs:vt}=await import("./index-DA5EGBVC.js").then(Nt=>Nt.c4);return{getDocs:vt}},__vite__mapDeps([0,1]),import.meta.url),ge=je(q,"shops",O,"machines"),Ve=(await fe(Ye(ge))).docs.map(vt=>({id:vt.id,name:String(vt.data().name||"ماكينة")}));Xe(Ve);try{const vt=localStorage.getItem(`machineDaily_selected_${O}`);vt&&Ve.some(H=>H.id===vt)?U(vt):!X&&Ve.length>0&&(U(Ve[0].id),localStorage.setItem(`machineDaily_selected_${O}`,Ve[0].id))}catch{}}catch(O){console.error("Load machines error:",O)}})()},[r,N]);const gt=i.useMemo(()=>(f==null?void 0:f.displayName)||(f==null?void 0:f.name)||(f==null?void 0:f.username)||void 0,[f]),ms=i.useMemo(()=>ne.reduce((O,fe)=>O+(fe.profit||0),0),[ne]),os=i.useMemo(()=>ne.reduce((O,fe)=>O+(fe.wholesalePrice||0),0),[ne]),Lt=async()=>{try{const O=N||t();if(O&&X){const fe=je(q,"shops",O,"machines",X,"transfers"),ge=await et(Ye(fe));await Promise.all(ge.docs.map(Fe=>qs(Fe.ref)));try{localStorage.setItem(`machineDaily_transfers_${O}_${X}`,JSON.stringify([]))}catch{}}}catch{}Ie([]),o({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."})},nt=async()=>{try{const O=N||t();if(O&&X){const fe=je(q,"shops",O,"machines",X,"deliveries"),ge=await et(Ye(fe));await Promise.all(ge.docs.map(Fe=>qs(Fe.ref)));try{localStorage.setItem(`machineDaily_deliveries_${O}_${X}`,JSON.stringify([]))}catch{}}}catch{}Ct([]),o({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."})},kt=O=>{Ct(fe=>fe.filter(ge=>ge.id!==O)),o({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},Qt=()=>{_(null),E(null),ie(null),M(null),R(""),L(""),y("");try{const O=X?`${Ma}_${X}`:Ma,fe=X?`${Ra}_${X}`:Ra;localStorage.removeItem(O),localStorage.removeItem(fe)}catch{}o({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},$s=async()=>{var Fe;const O=parseFloat(S||"0"),fe=parseFloat(C||"0"),ge=parseFloat(k||"0");if(isNaN(O)||isNaN(fe)||isNaN(ge)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(O<0||fe<0||ge<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}_(O),E(fe),ie(ge);try{const Ve=X?`${Ma}_${X}`:Ma,vt=X?`${Ra}_${X}`:Ra;localStorage.setItem(Ve,JSON.stringify({openingBase:O,openingAir:fe,drawerCash:ge})),localStorage.setItem(vt,JSON.stringify({openingBase:O,openingAir:fe,drawerCash:ge})),M({openingBase:O,openingAir:fe,drawerCash:ge});const Nt=N||t();if(Nt&&X){const H=ze(q,"shops",Nt,"machines",X);await ia(H,{name:((Fe=Re.find(ye=>ye.id===X))==null?void 0:Fe.name)||"ماكينة",openingBase:O,openingAir:fe,drawerCash:ge,cashierName:gt,shopName:D||null,updatedAt:bt()},{merge:!0})}}catch{}o({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${Bt(O)}، الهواء: ${Bt(fe)}، فلوس الدرج: ${Bt(ge)}`})},hs=()=>{if(w==null||Q==null){o({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}ue(!0)},ss=()=>{const O=parseFloat(ve||"0"),fe=parseFloat(Be||"0");if(isNaN(O)||isNaN(fe)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(O<0||fe<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const ge=(me==null?void 0:me.openingBase)??(w||0),Fe=(me==null?void 0:me.openingAir)??(Q||0),Ve=ge+Fe,Nt=O+fe-Ve;Qe(Nt);const H={id:`${Date.now()}`,openingBase:ge,openingAir:Fe,deliveryBase:O,deliveryAir:fe,netResult:Nt,createdAt:new Date().toISOString(),cashierName:gt,requiredDrawerNoProfit:Nt<0?Math.round(-Nt*100)/100:0};(async()=>{try{const ye=N||t();ye&&X&&(await ha(je(q,"shops",ye,"machines",X,"deliveries"),{cashierName:gt,openingBase:ge,openingAir:Fe,deliveryBase:O,deliveryAir:fe,netResult:Nt,createdAt:bt()}),await ia(ze(q,"shops",ye,"machines",X),{lastDeliveryAt:bt(),updatedAt:bt()},{merge:!0}))}catch(ye){console.error("Persist delivery error:",ye)}})(),Ct(ye=>[H,...ye]);try{const ye=N||t(),G=ye&&X?`machineDaily_deliveries_${ye}_${X}`:`machineDaily_deliveries_${X}`,ht=localStorage.getItem(G),It=ht?JSON.parse(ht):[],as=[H,...Array.isArray(It)?It:[]];localStorage.setItem(G,JSON.stringify(as))}catch{}o({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${Bt(Nt)}`})},Ia=()=>{const O=parseFloat(Me||"0"),fe=parseFloat(zt||"0");if(!Number.isFinite(O)||!Number.isFinite(fe)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if(O<0||fe<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(w==null||Q==null){o({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const ge=Math.round((fe-O)*100)/100;mt({wholesalePrice:O,retailPrice:fe,profit:ge}),We(!0)},Js=async O=>{if(!Je)return;const fe={id:`transfer_${Date.now()}`,wholesalePrice:Je.wholesalePrice,retailPrice:Je.retailPrice,profit:Je.profit,createdAt:new Date().toISOString(),cashierName:gt,deductFrom:O},ge=Je.wholesalePrice,Fe=w??0,Ve=Q??0,vt=Y??0;if(ge>(O==="base"?Fe:Ve)){o({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const H=O==="base"?Math.round((Fe-ge)*100)/100:Fe,ye=O==="air"?Math.round((Ve-ge)*100)/100:Ve,G=Je.retailPrice,ht=Math.round((vt+G)*100)/100;_(H),E(ye),ie(ht);try{const It=X?`${Ma}_${X}`:Ma,as=X?`${Ra}_${X}`:Ra;localStorage.setItem(It,JSON.stringify({openingBase:H,openingAir:ye,drawerCash:ht})),localStorage.setItem(as,JSON.stringify({openingBase:H,openingAir:ye,drawerCash:ht}));const Ns=N||t();if(Ns&&X){const sa=ze(q,"shops",Ns,"machines",X);await ia(sa,{openingBase:H,openingAir:ye,drawerCash:ht,cashierName:gt,updatedAt:bt()},{merge:!0}),await ha(je(q,"shops",Ns,"machines",X,"transfers"),{wholesalePrice:Je.wholesalePrice,retailPrice:Je.retailPrice,profit:Je.profit,deductFrom:O,cashierName:gt,createdAt:bt()})}}catch{}Ie(It=>[fe,...It]);try{const It=N||t(),as=It&&X?`machineDaily_transfers_${It}_${X}`:"machineDaily_transfers",Ns=localStorage.getItem(as),sa=Ns?JSON.parse(Ns):[],la=[fe,...Array.isArray(sa)?sa:[]];localStorage.setItem(as,JSON.stringify(la))}catch{}xe(!1),Pt(""),$t(""),mt(null),We(!1),o({title:"تم تسجيل تحويل",description:`الربح الفوري: ${Bt(fe.profit)} | خصم المخزون: -${Bt(ge)} (${O==="base"?"الأساسي":"الهواء"}) | درج (المباع فقط): +${Bt(G)}`})},va=()=>{R(""),L(""),ue(!1),ae(""),qe(""),Qe(null)};i.useEffect(()=>{const O=N||t();if(!(!r||!O||!X))try{const fe=je(q,"shops",O,"machines",X,"transfers"),ge=zs(fe,async Fe=>{const vt=[...Fe.docs.map(Nt=>{var ht,It;const H=Nt.data(),ye=(It=(ht=H==null?void 0:H.createdAt)==null?void 0:ht.toDate)!=null&&It.call(ht)?H.createdAt.toDate():new Date,G=H==null?void 0:H.deductFrom;return{id:Nt.id,wholesalePrice:Number((H==null?void 0:H.wholesalePrice)||0),retailPrice:Number((H==null?void 0:H.retailPrice)||0),profit:Number((H==null?void 0:H.profit)??(Number((H==null?void 0:H.retailPrice)||0)-Number((H==null?void 0:H.wholesalePrice)||0)||0)),createdAt:ye.toISOString(),cashierName:(H==null?void 0:H.cashierName)||void 0,deductFrom:G==="base"||G==="air"?G:void 0}})].sort((Nt,H)=>{const ye=new Date(Nt.createdAt).getTime();return new Date(H.createdAt).getTime()-ye});if(vt.length>0){Ie(vt),we(!0);try{localStorage.setItem(`machineDaily_transfers_${O}_${X}`,JSON.stringify(vt))}catch{}}else if(W){Ie([]);try{localStorage.setItem(`machineDaily_transfers_${O}_${X}`,JSON.stringify([]))}catch{}}});return()=>{try{ge()}catch{}}}catch{}},[r,N,X,W]),i.useEffect(()=>{const O=N||t();if(!(!r||!O||!X))try{const fe=je(q,"shops",O,"machines",X,"deliveries"),ge=zs(fe,Fe=>{const vt=[...Fe.docs.map(Nt=>{var G,ht;const H=Nt.data(),ye=(ht=(G=H==null?void 0:H.createdAt)==null?void 0:G.toDate)!=null&&ht.call(G)?H.createdAt.toDate():new Date;return{id:Nt.id,openingBase:Number((H==null?void 0:H.openingBase)||0),openingAir:Number((H==null?void 0:H.openingAir)||0),deliveryBase:Number((H==null?void 0:H.deliveryBase)||0),deliveryAir:Number((H==null?void 0:H.deliveryAir)||0),netResult:typeof(H==null?void 0:H.netResult)=="number"?Number(H.netResult):Math.round((Number((H==null?void 0:H.deliveryBase)||0)+Number((H==null?void 0:H.deliveryAir)||0)-(Number((H==null?void 0:H.openingBase)||0)+Number((H==null?void 0:H.openingAir)||0)))*100)/100,createdAt:ye.toISOString(),cashierName:(H==null?void 0:H.cashierName)||void 0,requiredDrawerNoProfit:typeof(H==null?void 0:H.requiredDrawerNoProfit)=="number"?H.requiredDrawerNoProfit:void 0}})].sort((Nt,H)=>new Date(H.createdAt).getTime()-new Date(Nt.createdAt).getTime());if(vt.length>0){Ct(vt),pt(!0);try{localStorage.setItem(`machineDaily_deliveries_${O}_${X}`,JSON.stringify(vt))}catch{}}else if(Le){Ct([]);try{localStorage.setItem(`machineDaily_deliveries_${O}_${X}`,JSON.stringify([]))}catch{}}});return()=>{try{ge()}catch{}}}catch{}},[r,N,X,Le]),i.useEffect(()=>{if(!(!r||!X))try{const O=N||t(),fe=O?`machineDaily_deliveries_${O}_${X}`:`machineDaily_deliveries_${X}`,ge=localStorage.getItem(fe);if(ge){const Fe=JSON.parse(ge);Array.isArray(Fe)&&Fe.length>0&&Ct(Fe)}(async()=>{try{const Fe=N||t();if(!Fe)return;const Ve=je(q,"shops",Fe,"machines",X,"deliveries"),H=[...(await et(Ye(Ve))).docs.map(ye=>{var It,as;const G=ye.data(),ht=(as=(It=G==null?void 0:G.createdAt)==null?void 0:It.toDate)!=null&&as.call(It)?G.createdAt.toDate():new Date;return{id:ye.id,openingBase:Number((G==null?void 0:G.openingBase)||0),openingAir:Number((G==null?void 0:G.openingAir)||0),deliveryBase:Number((G==null?void 0:G.deliveryBase)||0),deliveryAir:Number((G==null?void 0:G.deliveryAir)||0),netResult:typeof(G==null?void 0:G.netResult)=="number"?Number(G.netResult):Math.round((Number((G==null?void 0:G.deliveryBase)||0)+Number((G==null?void 0:G.deliveryAir)||0)-(Number((G==null?void 0:G.openingBase)||0)+Number((G==null?void 0:G.openingAir)||0)))*100)/100,createdAt:ht.toISOString(),cashierName:(G==null?void 0:G.cashierName)||void 0,requiredDrawerNoProfit:typeof(G==null?void 0:G.requiredDrawerNoProfit)=="number"?G.requiredDrawerNoProfit:void 0}})].sort((ye,G)=>new Date(G.createdAt).getTime()-new Date(ye.createdAt).getTime());if(H.length>0){Ct(H);try{localStorage.setItem(`machineDaily_deliveries_${Fe}_${X}`,JSON.stringify(H))}catch{}}}catch{}})()}catch{}},[r,N,X]),i.useEffect(()=>{if(!(!r||!X))try{const O=N||t(),fe=O?`machineDaily_transfers_${O}_${X}`:`machineDaily_transfers_${X}`,ge=localStorage.getItem(fe);if(ge){const Fe=JSON.parse(ge);Array.isArray(Fe)&&Fe.length>0&&Ie(Fe)}(async()=>{try{const Fe=N||t();if(!Fe)return;const Ve=je(q,"shops",Fe,"machines",X,"transfers"),H=[...(await et(Ye(Ve))).docs.map(ye=>{var as,Ns;const G=ye.data(),ht=(Ns=(as=G==null?void 0:G.createdAt)==null?void 0:as.toDate)!=null&&Ns.call(as)?G.createdAt.toDate():new Date,It=G==null?void 0:G.deductFrom;return{id:ye.id,wholesalePrice:Number((G==null?void 0:G.wholesalePrice)||0),retailPrice:Number((G==null?void 0:G.retailPrice)||0),profit:Number((G==null?void 0:G.profit)??(Number((G==null?void 0:G.retailPrice)||0)-Number((G==null?void 0:G.wholesalePrice)||0)||0)),createdAt:ht.toISOString(),cashierName:(G==null?void 0:G.cashierName)||void 0,deductFrom:It==="base"||It==="air"?It:void 0}})].sort((ye,G)=>new Date(G.createdAt).getTime()-new Date(ye.createdAt).getTime());if(H.length>0){Ie(H);try{localStorage.setItem(`machineDaily_transfers_${Fe}_${X}`,JSON.stringify(H))}catch{}}}catch{}})()}catch{}},[r,N,X]);const ws=O=>{O||va(),m(O)};return e.jsxs(Te,{open:r,onOpenChange:ws,children:[e.jsxs(Pe,{className:"w-screen h-[100vh] overflow-hidden rounded-none p-0 flex flex-col dark:bg-[#121212]",children:[e.jsxs(ke,{className:"sticky top-0 bg-white dark:bg-[#0F0F0F] z-20 border-b border-gray-200 dark:border-[#333] px-4 py-3",children:[e.jsx(_e,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx($d,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(Ps,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"px-4 py-3 overflow-y-auto flex-1 grid grid-cols-1 gap-6",children:[e.jsxs(Ut,{children:[e.jsx(vs,{className:"pb-2",children:e.jsxs(Vs,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"اختيار ماكينة"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(x,{variant:"destructive",onClick:async()=>{try{if(!N||!X)return;const O=ze(q,"shops",N,"machines",X);try{const ge=await et(je(q,"shops",N,"machines",X,"transfers"));await Promise.all(ge.docs.map(Fe=>qs(Fe.ref)))}catch{}try{const ge=await et(je(q,"shops",N,"machines",X,"deliveries"));await Promise.all(ge.docs.map(Fe=>qs(Fe.ref)))}catch{}await qs(O),Xe(ge=>ge.filter(Fe=>Fe.id!==X));const fe=Re.find(ge=>ge.id!==X);U(fe?fe.id:null);try{const ge=`${Ma}_${X}`,Fe=`${Ra}_${X}`;localStorage.removeItem(ge),localStorage.removeItem(Fe)}catch{}o({title:"تم حذف الماكينة",description:"تمت الإزالة نهائيًا."})}catch{o({title:"فشل الحذف",description:"تعذر حذف الماكينة.",variant:"destructive"})}},disabled:!X,title:"حذف الماكينة",children:e.jsx(ys,{className:"h-4 w-4"})})})]})}),e.jsx(qt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الماكينة الحالية"}),e.jsxs(Xa,{value:X??"",onValueChange:O=>{U(O);try{const fe=N||t();fe&&localStorage.setItem(`machineDaily_selected_${fe}`,O)}catch{}},children:[e.jsx(er,{className:"text-right",children:e.jsx(tr,{placeholder:"اختر ماكينة"})}),e.jsx(sr,{children:Re.map(O=>e.jsx(fa,{value:O.id,children:O.name},O.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"إنشاء ماكينة جديدة"}),e.jsx(V,{value:Rt,onChange:O=>Ot(O.target.value),placeholder:"اسم الماكينة",className:"text-right"})]}),e.jsx("div",{className:"flex justify-end md:justify-start",children:e.jsx(x,{onClick:async()=>{try{if(!N){o({title:"لا يوجد محل",description:"يرجى التأكد من تحميل بيانات المحل.",variant:"destructive"});return}const O=(Rt||"").trim();if(!O){o({title:"اسم الماكينة مطلوب",description:"أدخل اسم للماكينة الجديدة.",variant:"destructive"});return}const fe=await ha(je(q,"shops",N,"machines"),{name:O,shopId:N,createdAt:bt(),updatedAt:bt(),isActive:!0}),ge={id:fe.id,name:O};Xe(Fe=>[ge,...Fe]),U(fe.id),Ot(""),o({title:"تم إنشاء ماكينة",description:`تمت إضافة ${O}`})}catch(O){console.error("Create machine error:",O),o({title:"خطأ في الإنشاء",description:"تعذر إنشاء الماكينة.",variant:"destructive"})}},className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})})]})]})})]}),e.jsxs(Ut,{children:[e.jsx(vs,{className:"pb-2",children:e.jsxs(Vs,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>le(O=>!O),className:"flex items-center gap-1",children:e.jsx(Pn,{className:`h-4 w-4 transition-transform ${F?"rotate-180":""}`})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(x,{variant:"outline",onClick:()=>xe(!0),disabled:w==null||Q==null,className:"border-violet-300 text-violet-700",children:"تحويل"})}),w!=null&&Q!=null&&e.jsxs(bs,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",Bt(w)," | هواء ",Bt(Q)," | درج ",Bt(Y??0)]})]}),e.jsxs(qt,{className:`space-y-4 ${F?"":"hidden"}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(V,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:S,onChange:O=>R(O.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(V,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:C,onChange:O=>L(O.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx(V,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:k,onChange:O=>y(O.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(x,{variant:"outline",className:"mr-2",onClick:Qt,children:"تصفير"}),e.jsx(x,{onClick:$s,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),e.jsxs(Ut,{children:[e.jsx(vs,{className:"pb-2",children:e.jsxs(Vs,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات تحويل"}),e.jsxs(bs,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",Bt(ms)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:Lt,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(yr,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(qt,{className:"space-y-3",children:ne.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-3 max-h-52 overflow-y-auto pr-1",children:ne.map(O=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر الجملة"}),e.jsx("p",{className:"text-sm",children:Bt(O.wholesalePrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر التجزئة"}),e.jsx("p",{className:"text-sm",children:Bt(O.retailPrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الربح الفوري"}),e.jsx("p",{className:"text-sm text-green-700",children:Bt(O.profit)}),O.deductFrom&&e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"text-[11px] bg-violet-100 text-violet-700 border border-violet-200 rounded px-2 py-0.5",children:["الخصم من: ",O.deductFrom==="base"?"الأساسي":"الهواء"]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(ir,{className:"h-3 w-3"}),e.jsx("span",{children:xd(O.createdAt)}),O.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Zl,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",O.cashierName]})]})]})]})]},O.id))})})]}),e.jsxs(Ut,{children:[e.jsx(vs,{className:"pb-2",children:e.jsx(Vs,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(qt,{className:"space-y-4",children:Ee?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(V,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:ve,onChange:O=>ae(O.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(V,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Be,onChange:O=>qe(O.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>ue(!1),children:"إلغاء"}),e.jsx(x,{onClick:ss,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),$e!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(bs,{className:$e>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",Bt($e)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(bs,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",Bt(parseFloat(ve||"0")+parseFloat(Be||"0"))]}),e.jsxs(bs,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",Bt(os)]})]})]})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(x,{variant:"outline",onClick:hs,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs(Ut,{children:[e.jsx(vs,{className:"pb-2",children:e.jsxs(Vs,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:nt,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(yr,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(qt,{className:"space-y-3",children:Ge.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:Ge.map(O=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Bt(O.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Bt(O.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Bt(O.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Bt(O.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>kt(O.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(ys,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${O.netResult>=0?"text-green-700":"text-red-700"}`,children:Bt(O.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",Bt(O.deliveryBase+O.deliveryAir)]}),typeof O.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",Bt(O.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(ir,{className:"h-3 w-3"}),e.jsx("span",{children:xd(O.createdAt)}),O.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Zl,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",O.cashierName]})]})]})]})]},O.id))})})]})]}),e.jsxs(xt,{className:"sticky bottom-0 bg-white dark:bg-[#0F0F0F] z-20 border-t border-gray-200 dark:border-[#333] px-4 py-3 flex items-center justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>ws(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(Fa,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(Te,{open:tt,onOpenChange:xe,children:e.jsxs(Pe,{className:"sm:max-w-sm",children:[e.jsx(ke,{children:e.jsx(_e,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(V,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Me,onChange:O=>Pt(O.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(V,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:zt,onChange:O=>$t(O.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(bs,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",Bt(parseFloat(zt||"0")-parseFloat(Me||"0")||0)]})})]}),e.jsxs(xt,{className:"flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>xe(!1),children:"إلغاء"}),e.jsx(x,{onClick:Ia,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(dp,{open:ts,onOpenChange:We,children:e.jsxs(rm,{children:[e.jsxs(nm,{children:[e.jsx(im,{children:"اختيار مصدر الخصم"}),e.jsx(lm,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(om,{onClick:()=>We(!1),children:"رجوع"}),e.jsx(oo,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>Js("base"),children:"خصم من الأساسي"}),e.jsx(oo,{className:"bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>Js("air"),children:"خصم من الهواء"})]})]})})]})}function up(r,m=300){const[o,f]=He.useState(r);return He.useEffect(()=>{const N=setTimeout(()=>f(r),m);return()=>clearTimeout(N)},[r,m]),o}const xp=({userId:r,transactions:m})=>{const[o,f]=i.useState(!1),[N,D]=i.useState(!1),[t,S]=i.useState(!1),[R,C]=i.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:L}=Ca();i.useEffect(()=>{r&&o&&t&&k()},[r,o,t]);const k=async()=>{if(r)try{if(Array.isArray(m)&&m.length>0){const Y=new Date,ie=Y.getMonth(),me=Y.getFullYear(),M=Ls.filterVisibleTransactions(m,"monthly",r);let F=0,le=0;M.forEach(Ee=>{const ue=new Date(Ee.createdAt),ve=String(Ee.status||"confirmed").toLowerCase();if(ue.getMonth()!==ie||ue.getFullYear()!==me||ve!=="completed"&&ve!=="confirmed")return;const ae=(Ee.type||Ee.txnType||"").toLowerCase(),Be={type:ae==="withdrawal"?"withdraw":ae,amount:Number(Ee.amount||0),commission:Ee.commission};Be.type==="withdraw"?F+=ar.calculateProfitFromTransaction(Be):(Be.type==="send"||Be.type==="receive"||Be.type==="transfer")&&(le+=ar.calculateProfitFromTransaction(Be))}),C({monthlyWithdrawalProfit:Math.round(F*100)/100,monthlyTransferProfit:Math.round(le*100)/100,lastUpdated:new Date});return}const E=ar.getWithdrawTransferProfits(r);C({monthlyWithdrawalProfit:E.monthlyWithdrawProfit||0,monthlyTransferProfit:E.monthlyTransferProfit||0,lastUpdated:new Date})}catch(E){console.error("Error loading profit data:",E)}},y=E=>`${E.toFixed(2)} ج.م`,w=async()=>{try{const E=(L==null?void 0:L.subscription)||null,Y=(E==null?void 0:E.planType)??(E==null?void 0:E.plan)??null,ie=typeof Y=="string"?Y.toLowerCase():null;if(Y===ea.ZERO||ie==="zero"||ie==="0"||Y===0)return!0}catch{}try{if(r){const E=await co(r),Y=(E==null?void 0:E.planType)??(E==null?void 0:E.plan)??null,ie=typeof Y=="string"?Y.toLowerCase():null;if(Y===ea.ZERO||ie==="zero"||ie==="0"||Y===0)return!0}}catch{}return!1},_=async()=>{try{if(await w()){Zc({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}D(!0)},Q=async()=>{try{if(await w()){Zc({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),D(!1);return}}catch{}S(!0),f(!0),D(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:_,className:"h-6 w-6 p-0 text-gray-400 hover:text-purple-600 hover:bg-purple-50 rounded-full transition-colors duration-200",title:"عرض الأرباح الشهرية",children:e.jsx(Ht,{className:"h-4 w-4"})}),e.jsx(Te,{open:o,onOpenChange:f,children:e.jsxs(Pe,{className:"max-w-[280px] sm:max-w-[320px] mx-auto bg-white border border-gray-200 shadow-xl rounded-xl p-0 overflow-hidden",children:[e.jsx(ke,{className:"bg-gray-50 px-4 py-3 border-b border-gray-100",children:e.jsxs(_e,{className:"text-sm font-bold text-gray-900 flex items-center justify-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-white rounded-full border border-gray-200",children:e.jsx(ir,{className:"h-4 w-4 text-purple-600"})}),"أرباح الشهر"]})}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg border border-gray-100 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-red-50 rounded-md",children:e.jsx(Br,{className:"h-3.5 w-3.5 text-red-600"})}),e.jsx("span",{className:"font-medium text-gray-700 text-sm",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-gray-900",children:y(R.monthlyWithdrawalProfit)})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg border border-gray-100 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-green-50 rounded-md",children:e.jsx(mo,{className:"h-3.5 w-3.5 text-green-600"})}),e.jsx("span",{className:"font-medium text-gray-700 text-sm",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-gray-900",children:y(R.monthlyTransferProfit)})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-purple-50 rounded-lg border border-purple-100 mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-white rounded-md shadow-sm",children:e.jsx(es,{className:"h-3.5 w-3.5 text-purple-600"})}),e.jsx("span",{className:"font-bold text-purple-900 text-sm",children:"الإجمالي"})]}),e.jsx("span",{className:"font-bold text-base text-purple-700",children:y(R.monthlyWithdrawalProfit+R.monthlyTransferProfit)})]})]}),e.jsx("div",{className:"bg-gray-50 px-4 py-3 border-t border-gray-100 flex justify-center",children:e.jsx(x,{onClick:()=>f(!1),className:"bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 hover:text-gray-900 w-full sm:w-auto px-8 rounded-lg text-sm font-medium shadow-sm",children:"إغلاق"})})]})}),e.jsx(fs,{open:N,onOpenChange:D,onSuccess:Q,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},pp=r=>e.jsx(xp,{...r});function gp({open:r,onOpenChange:m,onSuccess:o,userId:f}){const[N,D]=i.useState(""),[t,S]=i.useState(""),[R,C]=i.useState(!1),[L,k]=i.useState(!1),[y,w]=i.useState(""),[_,Q]=i.useState(!1),[E,Y]=i.useState(!1),{toast:ie}=xa();i.useEffect(()=>{let F=!0;return(async()=>{const le=await ks.hasMasterPin(f);F&&Y(le)})(),()=>{F=!1}},[f,r]);const me=()=>{D(""),S(""),w(""),C(!1),k(!1),m(!1)},M=async F=>{F.preventDefault(),w(""),Q(!0);try{if(E){if(!await ks.verifyMasterPin(N,f)){w("الرقم السري غير صحيح"),Q(!1);return}}else{if(N.length<4){w("يجب أن يكون الرقم السري 4 أرقام على الأقل"),Q(!1);return}if(N!==t){w("الرقم السري غير متطابق"),Q(!1);return}if(!await ks.createMasterPin(N,f)){w("تعذر إنشاء الرقم السري الرئيسي"),Q(!1);return}}ie({title:"نجح العملية",description:E?"تم التحقق من الرقم السري الرئيسي بنجاح":"تم إنشاء الرقم السري الرئيسي بنجاح"}),o(),me()}catch{w("حدث خطأ أثناء معالجة الرقم السري")}finally{Q(!1)}};return e.jsx(Te,{open:r,onOpenChange:m,children:e.jsxs(Pe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ke,{children:e.jsxs(_e,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(br,{className:"h-5 w-5 text-green-600"}),E?"أدخل الرقم السري الرئيسي":"إنشاء الرقم السري الرئيسي"]})}),e.jsxs("form",{onSubmit:M,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:E?"أدخل الرقم السري الرئيسي لعرض بيانات الأرباح":"قم بإنشاء الرقم السري الرئيسي لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"pin",children:E?"الرقم السري الرئيسي":"الرقم السري الرئيسي الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(V,{id:"pin",type:R?"text":"password",value:N,onChange:F=>D(F.target.value),placeholder:E?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>C(!R),children:R?e.jsx(_s,{className:"h-4 w-4"}):e.jsx(Ht,{className:"h-4 w-4"})})]})]}),!E&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(V,{id:"confirmPin",type:L?"text":"password",value:t,onChange:F=>S(F.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>k(!L),children:L?e.jsx(_s,{className:"h-4 w-4"}):e.jsx(Ht,{className:"h-4 w-4"})})]})]}),y&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(wr,{className:"h-4 w-4"}),y]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:_,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(br,{className:"h-4 w-4 mr-2"}),_?"جاري المعالجة...":E?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(x,{type:"button",variant:"outline",onClick:me,disabled:_,children:"إلغاء"})]})]})]})})}const fp=({userId:r,transactions:m})=>{const[o,f]=i.useState(!1),[N,D]=i.useState(!1),[t,S]=i.useState(!1),[R,C]=i.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});i.useEffect(()=>{r&&o&&t&&L()},[r,o,t,m]);const L=async()=>{if(r)try{if(Array.isArray(m)&&m.length>0){const Q=new Date,E=Ls.filterVisibleTransactions(m,"daily",r);let Y=0,ie=0;E.forEach(me=>{const M=new Date(me.createdAt),F=String(me.status||"confirmed").toLowerCase();if(M.toDateString()!==Q.toDateString())return;const le=(me.type||me.txnType||"").toLowerCase(),Ee=String(me.title||"");if(le==="cash_addition"||Ee.includes("إيصال إضافة نقدية"))return;const ue={type:le==="withdrawal"?"withdraw":le,amount:Number(me.amount||0),commission:me.commission};ue.type==="withdraw"?Y+=ar.calculateProfitFromTransaction(ue):(ue.type==="send"||ue.type==="receive"||ue.type==="transfer")&&(ie+=ar.calculateProfitFromTransaction(ue))}),C({dailyWithdrawalProfit:Math.round(Y*100)/100,dailyTransferProfit:Math.round(ie*100)/100,lastUpdated:new Date});try{ar.updateProfitsFromTransactions(m,r)}catch{}return}const _=ar.getWithdrawTransferProfits(r);C({dailyWithdrawalProfit:_.dailyWithdrawProfit||0,dailyTransferProfit:_.dailyTransferProfit||0,lastUpdated:new Date})}catch(_){console.error("Error loading profit data:",_)}},k=_=>`${_.toFixed(2)} ج.م`,y=()=>{ar.hasProfitPin(r),D(!0)},w=()=>{S(!0),f(!0),D(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:y,className:"h-6 w-6 p-0 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors duration-200",title:"عرض الأرباح اليومية",children:e.jsx(Ht,{className:"h-4 w-4"})}),e.jsx(Te,{open:o,onOpenChange:f,children:e.jsxs(Pe,{className:"max-w-[280px] sm:max-w-[320px] mx-auto bg-white border border-gray-200 shadow-xl rounded-xl p-0 overflow-hidden",children:[e.jsx(ke,{className:"bg-gray-50 px-4 py-3 border-b border-gray-100",children:e.jsxs(_e,{className:"text-sm font-bold text-gray-900 flex items-center justify-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-white rounded-full border border-gray-200",children:e.jsx(es,{className:"h-4 w-4 text-blue-600"})}),"أرباح اليوم"]})}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg border border-gray-100 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-red-50 rounded-md",children:e.jsx(Br,{className:"h-3.5 w-3.5 text-red-600"})}),e.jsx("span",{className:"font-medium text-gray-700 text-sm",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-gray-900",children:k(R.dailyWithdrawalProfit)})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg border border-gray-100 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-green-50 rounded-md",children:e.jsx(mo,{className:"h-3.5 w-3.5 text-green-600"})}),e.jsx("span",{className:"font-medium text-gray-700 text-sm",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-gray-900",children:k(R.dailyTransferProfit)})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-100 mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-white rounded-md shadow-sm",children:e.jsx(es,{className:"h-3.5 w-3.5 text-blue-600"})}),e.jsx("span",{className:"font-bold text-blue-900 text-sm",children:"الإجمالي"})]}),e.jsx("span",{className:"font-bold text-base text-blue-700",children:k(R.dailyWithdrawalProfit+R.dailyTransferProfit)})]})]}),e.jsx("div",{className:"bg-gray-50 px-4 py-3 border-t border-gray-100 flex justify-center",children:e.jsx(x,{onClick:()=>f(!1),className:"bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 hover:text-gray-900 w-full sm:w-auto px-8 rounded-lg text-sm font-medium shadow-sm",children:"إغلاق"})})]})}),e.jsx(gp,{open:N,onOpenChange:D,onSuccess:w,userId:r})]})},yp=r=>e.jsx(fp,{...r}),bp=({open:r,onOpenChange:m})=>{var Aa;const{shiftUser:o,isShiftActive:f,shiftStartAt:N,setShiftUser:D,startShift:t,endShift:S}=Mn(),{userSubscription:R,user:C,signIn:L,profile:k}=Ca(),{toast:y}=xa(),[w,_]=i.useState((o==null?void 0:o.name)||""),[Q,E]=i.useState((o==null?void 0:o.username)||""),[Y,ie]=i.useState(""),[me,M]=i.useState(!1),[F,le]=i.useState(null),[Ee,ue]=i.useState(""),[ve,ae]=i.useState(""),[Be,qe]=i.useState(!1),[$e,Qe]=i.useState(null),[Ge,Ct]=i.useState(""),[ne,Ie]=i.useState(""),[tt,xe]=i.useState(!1),[Me,Pt]=i.useState(!1),[zt,$t]=i.useState({totalTransfers:0,totalWithdrawals:0}),[ts,We]=i.useState(null),[Je,mt]=i.useState(""),[Re,Xe]=i.useState(""),[X,U]=i.useState(0),[Rt,Ot]=i.useState({}),[W,we]=i.useState(0),[Le,pt]=i.useState(0),[gt,ms]=i.useState({}),[os,Lt]=i.useState(""),[nt,kt]=i.useState(!1),Qt=z=>{const Se={"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9","۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9","٫":".","،":".","٬":"."," ":""};return z.split("").map(jt=>Se[jt]??jt).join("")},$s=()=>`cashierUsers_${(C==null?void 0:C.uid)||"default"}`,[hs,ss]=i.useState(()=>{try{let z=localStorage.getItem($s());if(!z){const Se=localStorage.getItem("cashierUsers");Se&&(z=Se)}return z?JSON.parse(z):[]}catch{return[]}});i.useEffect(()=>{(async()=>{try{if(!(C!=null&&C.uid))return;const z=ze(q,"profiles",C.uid,"cashierUsers","list"),Se=await Sa(z);if(Se.exists()){const jt=Se.data(),ft=Array.isArray(jt==null?void 0:jt.users)?jt.users:[];ft&&ft.length>0&&ss(ft)}}catch{}})()},[C==null?void 0:C.uid]),i.useEffect(()=>{if(!(C!=null&&C.uid))return;const z=ze(q,"profiles",C.uid,"cashierUsers","list"),Se=zs(z,jt=>{try{if(jt.exists()){const ft=jt.data(),js=Array.isArray(ft==null?void 0:ft.users)?ft.users:[];if(js&&js.length>0)ss(js);else try{const rs=localStorage.getItem($s()),Gt=rs?JSON.parse(rs):[];ss(Gt)}catch{ss([])}}}catch{}},jt=>{console.warn("cashierUsers realtime subscription error:",jt)});return()=>Se()},[C==null?void 0:C.uid]);const Ia=(Aa=R==null?void 0:R.subscription)==null?void 0:Aa.planType,Js=Ia==="yearly"?2:Ia==="lifetime"?4:Number.POSITIVE_INFINITY;i.useEffect(()=>{try{localStorage.setItem($s(),JSON.stringify(hs));try{localStorage.removeItem("cashierUsers")}catch{}}catch{}(async()=>{try{if(!(C!=null&&C.uid))return;const z=ze(q,"profiles",C.uid,"cashierUsers","list");await ia(z,{users:hs},{merge:!0})}catch{}})()},[hs]);const[va,ws]=i.useState(!1),[O,fe]=i.useState(""),[ge,Fe]=i.useState(null),[Ve,vt]=i.useState([]),[Nt,H]=i.useState(!1),[ye,G]=i.useState(null),[ht,It]=i.useState(!1),[as,Ns]=i.useState(!1),sa=z=>{const Se=(o==null?void 0:o.username)===z;let jt=!1;try{jt=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(Se&&!(Se&&!f&&(os==="الأدمن الرئيسي"||jt))){y({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const rs=`هل أنت متأكد من حذف المستخدم ${z}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(rs)&&(ss(Gt=>Gt.filter(Ba=>Ba.username!==z)),Se&&D(null),y({title:"تم حذف المستخدم",description:z}))},la=()=>{if(!w.trim()||!Q.trim()||!Y.trim())return;if(hs.length>=Js){y({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(Js)?Js:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const z={name:w.trim(),username:Q.trim(),password:Y.trim()};ss(Se=>[z,...Se]),_(""),E(""),ie("")},Nr=()=>{M(!0),le(null),Qe(null),Ct(""),Ie("")},Fs=async()=>{try{let z=[];try{C!=null&&C.uid&&(z=await Ce.getUserTransactions(C.uid))}catch{}if(!z||z.length===0)try{const dt=await Ld({merchantUserId:C==null?void 0:C.uid,limit:200});z=(dt==null?void 0:dt.transactions)||[]}catch{}const Se=N?new Date(N):null,jt=new Date,ft=dt=>{const it=dt.type,Ks=dt.txnType;return it==="withdraw"||it==="withdrawal"||it==="receive"||Ks==="receive"},js=dt=>{const it=dt.type,Ks=dt.txnType;return it==="send"||it==="transfer"||Ks==="send"},rs=dt=>{if(!dt)return null;if(dt instanceof Date)return dt;try{const it=new Date(dt);return Number.isNaN(it.getTime())?null:it}catch{return null}},Gt=dt=>{const it=rs(dt.createdAt||dt.created_at||dt.timestamp);return!it||Se&&it<Se?!1:it<=jt},Ba=dt=>dt==="completed"||dt==="confirmed",wa=z.filter(dt=>Ba(dt.status)&&Gt(dt)),Qr=wa.filter(dt=>ft(dt)).reduce((dt,it)=>{const Ks=it.withdrawnAmount??it.receivedAmount??it.amount??0;return dt+(Number(Ks)||0)},0);return{totalTransfers:wa.filter(dt=>js(dt)).reduce((dt,it)=>{const Ks=it.sentAmount??it.transferredAmount??it.amount??0;return dt+(Number(Ks)||0)},0),totalWithdrawals:Qr}}catch{return{totalTransfers:0,totalWithdrawals:0}}};i.useEffect(()=>{if(Me){try{const z=localStorage.getItem("shiftInitialReceivedDrawerFunds");z!==null&&Xe(z)}catch{}try{const z=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(z!==null){const Se=parseFloat(z);U(Number.isFinite(Se)?Se:0)}}catch{}}},[Me]),i.useEffect(()=>{me&&(async()=>{try{const z=await Fs();$t(z)}catch{}})()},[me]),i.useEffect(()=>{if(!r&&!Nt)return;(async()=>{try{const jt=((C!=null&&C.uid?await Ce.getUserTransactions(C.uid):[])||[]).filter(ft=>(ft==null?void 0:ft.type)==="report"||((ft==null?void 0:ft.title)||"").includes("إيصال تسليم وردية"));jt.sort((ft,js)=>{const rs=new Date(ft.createdAt||0).getTime();return new Date(js.createdAt||0).getTime()-rs}),vt(jt)}catch{vt([])}})()},[r,Me,Nt,C==null?void 0:C.uid]);const Hr=async(z,Se,jt)=>{try{let ft=0,js=0;try{const Gt=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");ft=Number.isFinite(Gt)?Gt:0}catch{}try{const Gt=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");js=Number.isFinite(Gt)?Gt:0}catch{}const rs={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(o==null?void 0:o.username)||"cashier",receiverPhone:os||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(o==null?void 0:o.name)||(o==null?void 0:o.username)||null,deficit:Se,deficitAmount:Se?jt:0,shiftStartAt:N,receivedDrawerFunds:ft,receivedWalletBalancesTotal:js,receivedWalletBalances:Rt,deliveredDrawerFunds:W||0,deliveredWalletBalancesTotal:Le||0,deliveredWalletBalances:gt,shiftProfit:Math.round(((W||0)+(Le||0)-(ft+js))*100)/100};C!=null&&C.uid&&await Ce.saveUserTransaction(C.uid,rs),vt(Gt=>[rs,...Gt||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(Te,{open:r,onOpenChange:m,children:e.jsxs(Pe,{className:"sm:max-w-md",children:[e.jsx(ke,{children:e.jsx(_e,{children:f?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),f?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[o==null?void 0:o.name," (",o==null?void 0:o.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),hs.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:hs.map((z,Se)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:z.name}),e.jsx("div",{className:"text-xs text-gray-500",children:z.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(x,{size:"sm",className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>{Fe(z),ws(!0)},children:"دخول"}),e.jsx(x,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>sa(z.username),children:"حذف"})]})]},Se))})]})]}),e.jsx(xt,{className:"flex flex-wrap gap-2 justify-between",children:f?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(x,{className:"w-full sm:w-auto",variant:"destructive",onClick:Nr,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(x,{className:"w-full sm:w-auto bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>Ns(!0),children:"إضافة مستخدم جديد"}),e.jsx(x,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>H(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(Te,{open:as,onOpenChange:Ns,children:e.jsxs(Pe,{className:"sm:max-w-md",children:[e.jsx(ke,{children:e.jsx(_e,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(se,{className:"mb-1 block",children:"الاسم"}),e.jsx(V,{value:w,onChange:z=>_(z.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(se,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(V,{value:Q,onChange:z=>E(z.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(se,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(V,{type:"password",autoComplete:"new-password",value:Y,onChange:z=>ie(z.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(xt,{className:"flex gap-2 justify-between",children:[e.jsx(x,{variant:"secondary",onClick:()=>{Ns(!1)},children:"إلغاء"}),e.jsx(x,{onClick:()=>{!w.trim()||!Q.trim()||!Y.trim()||(la(),Ns(!1))},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"حفظ المستخدم"})]})]})}),e.jsx(Te,{open:Nt,onOpenChange:H,children:e.jsxs(Pe,{className:"sm:max-w-lg",children:[e.jsx(ke,{children:e.jsx(_e,{children:"إيصالات التسليم"})}),Ve.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:Ve.map(z=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{G(z),It(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(z.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",z.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",z.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",z.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",z.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",z.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",z.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",z.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",z.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",z.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(z.shiftProfit??(z.deliveredDrawerFunds??0)+(z.deliveredWalletBalancesTotal??0)-(z.receivedDrawerFunds??0)-(z.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",z.shiftProfit??(z.deliveredDrawerFunds??0)+(z.deliveredWalletBalancesTotal??0)-(z.receivedDrawerFunds??0)-(z.receivedWalletBalancesTotal??0)]})]}),z.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",z.deficitAmount??0]})]},z.id))}),e.jsx(xt,{className:"flex gap-2 justify-between",children:e.jsx(x,{variant:"secondary",onClick:()=>H(!1),children:"إغلاق"})})]})}),e.jsx(Te,{open:ht,onOpenChange:It,children:e.jsxs(Pe,{className:"sm:max-w-md",children:[e.jsx(ke,{children:e.jsx(_e,{children:"إيصال تسليم وردية"})}),ye?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(ye.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",ye.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",ye.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",ye.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",ye.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",ye.deliveredWalletBalancesTotal??0]})]})]}),ye.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",ye.deficitAmount??0]})]}),ye.receivedWalletBalances&&Object.keys(ye.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(ye.receivedWalletBalances).map(([z,Se])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:z}),e.jsx("span",{className:"font-semibold",children:Se})]},z))})]}),ye.deliveredWalletBalances&&Object.keys(ye.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(ye.deliveredWalletBalances).map(([z,Se])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:z}),e.jsx("span",{className:"font-semibold",children:Se})]},z))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(xt,{className:"flex gap-2 justify-between",children:e.jsx(x,{variant:"secondary",onClick:()=>It(!1),children:"إغلاق"})})]})}),e.jsx(Te,{open:va,onOpenChange:ws,children:e.jsxs(Pe,{className:"sm:max-w-md",children:[e.jsx(ke,{children:e.jsx(_e,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:ge?`${ge.name} (${ge.username})`:""}),e.jsx(V,{type:"password",autoComplete:"off",value:O,onChange:z=>fe(z.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(xt,{className:"flex gap-2 justify-between",children:[e.jsx(x,{variant:"secondary",onClick:()=>{fe(""),Fe(null),ws(!1)},children:"إلغاء"}),e.jsx(x,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{if(ge){if(O.trim()!==ge.password){y({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}D({name:ge.name,username:ge.username}),fe(""),ws(!1),m(!1),t(),kt(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(Te,{open:nt,onOpenChange:kt,children:e.jsxs(Pe,{className:"sm:max-w-md",children:[e.jsx(ke,{children:e.jsx(_e,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(se,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(V,{type:"text",inputMode:"decimal",value:Re,onChange:z=>Xe(Qt(z.target.value)),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(se,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(V,{type:"text",inputMode:"decimal",value:Number.isFinite(X)?X:0,onChange:z=>{const Se=parseFloat(Qt(z.target.value));U(Number.isFinite(Se)?Se:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(xt,{className:"flex gap-2 justify-between",children:e.jsx(x,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{const z=parseFloat(Re),Se=X,jt=Number.isFinite(z)&&z>=0,ft=Number.isFinite(Se)&&Se>=0;if(!jt||!ft){y({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(z)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(Se))}catch{}y({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),kt(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(Te,{open:me,onOpenChange:z=>{z&&M(!0)},children:e.jsxs(Pe,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ke,{children:e.jsx(_e,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:F==="toUser"?"default":"secondary",onClick:()=>le("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(x,{variant:F==="toAdmin"?"default":"secondary",onClick:()=>le("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),F==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[hs.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:hs.map((z,Se)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${($e==null?void 0:$e.username)===z.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>Qe(z),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:z.name}),e.jsx("div",{className:"text-xs text-gray-500",children:z.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},Se))})]}),e.jsxs("div",{children:[e.jsx(se,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(V,{type:"password",autoComplete:"off",value:Ge,onChange:z=>Ct(z.target.value),placeholder:"أدخل كلمة السر"})]}),ne&&e.jsx("div",{className:"text-xs text-red-600",children:ne})]}),F==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(V,{type:"password",autoComplete:"off",value:Ee,onChange:z=>ue(z.target.value),placeholder:"كلمة المرور"}),ve&&e.jsx("div",{className:"text-xs text-red-600",children:ve})]})]}),e.jsx(xt,{className:"flex gap-2 justify-between",children:e.jsx(x,{disabled:tt||!F,onClick:async()=>{if(F){xe(!0);try{const z=zt;if(Fs().then($t).catch(()=>{}),F==="toUser"){if(!$e){Ie("يرجى اختيار المستخدم أولاً"),xe(!1);return}if(Ge.trim()!==$e.password){Ie("كلمة السر غير صحيحة"),xe(!1);return}S(),D({name:$e.name,username:$e.username}),t(),Lt(`${$e.name} (${$e.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}M(!1),le(null),Qe(null),Ct(""),Ie(""),m(!1),$t(z),We(null),mt(""),Pt(!0)}else if(F==="toAdmin"){ae("");const Se=(C==null?void 0:C.email)||"";if(!Se){ae("لا يوجد بريد للمستخدم الرئيسي للتحقق"),xe(!1);return}const{error:jt}=await L(Se,Ee);if(jt){ae("كلمة المرور غير صحيحة"),xe(!1);return}S(),D(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}ue(""),M(!1),m(!1),Lt("الأدمن الرئيسي"),$t(z),We(null),mt(""),Pt(!0)}}catch{Ie("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{xe(!1)}}},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"تأكيد التسليم"})})]})}),e.jsx(Te,{open:Me,onOpenChange:Pt,children:e.jsxs(Pe,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ke,{children:e.jsx(_e,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:os})]}),N&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(N).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(se,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(V,{type:"number",value:Re,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(se,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(V,{type:"number",value:X,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(se,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(V,{type:"text",inputMode:"decimal",value:W,onChange:z=>{const Se=parseFloat(Qt(z.target.value));we(Number.isFinite(Se)?Se:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(se,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(V,{type:"text",inputMode:"decimal",value:Le,onChange:z=>{const Se=parseFloat(Qt(z.target.value));pt(Number.isFinite(Se)?Se:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(W??0)+(Le??0)-((parseFloat(Re||"0")||0)+(X??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((W??0)+(Le??0)-((parseFloat(Re||"0")||0)+(X??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"}),e.jsx("div",{className:"mt-2 grid grid-cols-1 gap-2",children:e.jsxs("div",{className:"rounded border p-2 bg-gray-50",children:[e.jsx("div",{className:"text-xs text-gray-700",children:"مطلوب من الدرج (بدون أرباح)"}),e.jsx("div",{className:"text-sm font-semibold text-gray-900",children:Math.round(((W??0)-(parseFloat(Re||"0")||0))*100)/100})]})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:ts==="no"?"default":"secondary",onClick:()=>We("no"),children:"لا"}),e.jsx(x,{variant:ts==="yes"?"default":"secondary",onClick:()=>We("yes"),children:"نعم"})]}),ts==="yes"&&e.jsxs("div",{children:[e.jsx(se,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(V,{type:"number",value:Je,onChange:z=>mt(z.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(xt,{className:"flex gap-2 justify-between",children:e.jsx(x,{onClick:()=>{const z=ts==="yes",Se=parseFloat(Je)||0;(async()=>await Hr(zt,z,Se))(),y({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),Pt(!1)},className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:"تأكيد وحفظ الإيصال"})})]})})]})},vp=({open:r,onOpenChange:m})=>{const{shiftUser:o,endShift:f,setShiftUser:N}=Mn(),[D,t]=i.useState(""),[S,R]=i.useState(""),[C,L]=i.useState([]),{user:k}=Ca();i.useEffect(()=>{(async()=>{try{if(k!=null&&k.uid){const w=ze(q,"profiles",k.uid,"cashierUsers","list"),_=await Sa(w);if(_.exists()){const Q=_.data(),E=Array.isArray(Q==null?void 0:Q.users)?Q.users:[];if(E&&E.length>0){L(E);return}}}}catch{}try{const w=`cashierUsers_${(k==null?void 0:k.uid)||"default"}`;let _=localStorage.getItem(w);if(!_){const Q=localStorage.getItem("cashierUsers");Q&&(_=Q)}L(_?JSON.parse(_):[])}catch{L([])}})()},[r,k==null?void 0:k.uid]),i.useEffect(()=>{if(!r||!(k!=null&&k.uid))return;const w=ze(q,"profiles",k.uid,"cashierUsers","list"),_=zs(w,Q=>{if(Q.exists()){const E=Q.data(),Y=Array.isArray(E==null?void 0:E.users)?E.users:[];if(Y&&Y.length>0)L(Y);else try{const ie=`cashierUsers_${(k==null?void 0:k.uid)||"default"}`;let me=localStorage.getItem(ie);if(!me){const M=localStorage.getItem("cashierUsers");M&&(me=M)}L(me?JSON.parse(me):[])}catch{L([])}}},Q=>{console.warn("ShiftProfileDialog cashierUsers snapshot error:",Q)});return()=>_()},[r,k==null?void 0:k.uid]);const y=async()=>{if(R(""),!o)return;const w=C.find(_=>_.username===o.username);if(!w){R("لا يوجد مستخدم مطابق لهذه الوردية");return}if(D.trim()!==w.password){R("الرقم السري غير صحيح");return}f(),N(null),t(""),m(!1)};return e.jsx(Te,{open:r,onOpenChange:w=>{t(""),R(""),m(w)},children:e.jsxs(Pe,{className:"sm:max-w-md",children:[e.jsx(ke,{children:e.jsx(_e,{children:"بروفيل الوردية"})}),o?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:o.name}),e.jsx("div",{className:"text-xs text-gray-600",children:o.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx(V,{type:"password",value:D,onChange:w=>t(w.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),S&&e.jsx("div",{className:"text-red-600 text-xs",children:S})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(xt,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>m(!1),children:"إغلاق"}),e.jsx(x,{onClick:y,disabled:!o,children:"تسليم الوردية"})]})]})})},wp=({open:r,onOpenChange:m})=>e.jsx(Te,{open:r,onOpenChange:m,children:e.jsxs(Pe,{className:"sm:max-w-lg rounded-2xl",children:[e.jsxs(ke,{children:[e.jsxs(_e,{className:"text-right flex items-center gap-2 justify-end",children:[e.jsx(ql,{className:"w-5 h-5"}),"سجل التغييرات الأخيرة"]}),e.jsx(Ps,{className:"text-right",children:"هذه أبرز التحسينات التي تمت مؤخرًا في الواجهة."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Id,{className:"w-5 h-5 text-amber-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحسين نافذة تعديل المديونية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"استبدال نافذة الإدخال القديمة (prompt) بحوار أنيق لإدخال المبلغ مع تأكيد."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Mu,{className:"w-5 h-5 text-violet-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحديث شاشة التحميل"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:'تغيير النص إلى "صلي علي النبي" مع خط عربي جميل ونبض لطيف.'})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ql,{className:"w-5 h-5 text-green-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"بطاقات الأرباح وعدد العمليات"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"إضافة بطاقات عرض أرباح الفترة الحالية وعدد العمليات في تفاصيل المحفظة."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ql,{className:"w-5 h-5 text-blue-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"إصلاح تمرير نافذة اليومية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"منع تمرير الصفحة الخلفية عند فتح نافذة اليومية لراحة الاستخدام."})]})]})]}),e.jsx("div",{className:"flex justify-end gap-2 mt-6",children:e.jsx(x,{variant:"secondary",onClick:()=>m(!1),children:"إغلاق"})})]})});class Ur{static async processTransfer(m){const{amount:o,currentCashBalance:f,currentWalletBalances:N,wallets:D,selectedWalletId:t}=m;if(o<=0)return{success:!1,newCashBalance:f,newWalletBalances:N,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(t&&!m.skipRemoteLimitsCheck)try{const L=await ma.canPerformOperation(t,o,"transfer");if(!L.canPerform)return{success:!1,newCashBalance:f,newWalletBalances:N,message:L.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(L){return console.error("خطأ في التحقق من حدود التحويل:",L),{success:!1,newCashBalance:f,newWalletBalances:N,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(o<=0)return{success:!1,newCashBalance:f,newWalletBalances:N,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(t){const L=Math.max(N[t]||0,0);if(L<o){const k=D.find(y=>y.id===t);return{success:!1,newCashBalance:f,newWalletBalances:N,message:`رصيد غير كافي في المحفظة${k?` ${k.name}`:""}. المتاح: ${L} جنيه، المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const L=Ur.calculateTotalWalletBalance(N);if(L<o)return{success:!1,newCashBalance:f,newWalletBalances:N,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${L} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const S={...N};if(t){const L=S[t]||0;S[t]=L-o}else{let L=o;for(const k of D){if(L<=0)break;const y=Math.max(S[k.id]||0,0),w=Math.min(y,L);w>0&&(S[k.id]=(S[k.id]||0)-w,L-=w)}}const R=f+o;let C="تم التحويل بنجاح";if(t){const L=S[t]||0;L<0&&(C=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${t} أصبح ${L} جنيه.`)}return{success:!0,newCashBalance:R,newWalletBalances:S,message:C}}static processDeposit(m){const{amount:o,currentCashBalance:f,currentWalletBalances:N,wallets:D}=m;if(o<=0)return{success:!1,newCashBalance:f,newWalletBalances:N,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const t=this.calculateTotalWalletBalance(N);if(t<o)return{success:!1,newCashBalance:f,newWalletBalances:N,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${t} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const S=f+o,R={...N};let C=o;const L=D.find(y=>y.isDefault);if(L&&R[L.id]>=C)R[L.id]-=C,C=0;else for(const y of D){if(C<=0)break;const w=R[y.id]||0;if(w>0){const _=Math.min(w,C);R[y.id]=w-_,C-=_}}const k=C>0?`تم الإيداع جزئياً. تم إيداع ${o-C} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${o} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:S,newWalletBalances:R,message:k}}static async processWithdraw(m){const{amount:o,currentCashBalance:f,currentWalletBalances:N,wallets:D,selectedWalletId:t}=m;if(o<=0)return{success:!1,newCashBalance:f,newWalletBalances:N,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(t&&!m.skipRemoteLimitsCheck)try{const L=await ma.canPerformOperation(t,o,"withdraw");if(!L.canPerform)return{success:!1,newCashBalance:f,newWalletBalances:N,message:L.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(L){return console.error("خطأ في التحقق من حدود السحب:",L),{success:!1,newCashBalance:f,newWalletBalances:N,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(f<o)return{success:!1,newCashBalance:f,newWalletBalances:N,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${f} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const S=f-o,R={...N},C=t?D.find(L=>L.id===t):D.find(L=>L.isDefault)||D[0];if(C){const L=R[C.id]||0;R[C.id]=L+o}else return{success:!1,newCashBalance:f,newWalletBalances:N,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};return{success:!0,newCashBalance:S,newWalletBalances:R,message:`تم السحب بنجاح. تم إضافة ${o} جنيه إلى محفظة ${(C==null?void 0:C.name)||""}`}}static validateOperation(m,o){return m<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!o||o.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(m){return Object.values(m).reduce((o,f)=>o+Math.max(f,0),0)}static deductFromWalletsAddToCash(m,o,f,N){return this.processTransfer({amount:m,currentCashBalance:o,currentWalletBalances:f,wallets:N})}static deductFromWalletsAddToCashDeposit(m,o,f,N){return this.processDeposit({amount:m,currentCashBalance:o,currentWalletBalances:f,wallets:N})}static deductFromCashAddToWallets(m,o,f,N){return this.processWithdraw({amount:m,currentCashBalance:o,currentWalletBalances:f,wallets:N})}static applyTransactionResult(m,o,f){m.success&&(o(m.newCashBalance),f(m.newWalletBalances))}static validateTransaction(m,o,f,N){if(m<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(o==="transfer"){const D=this.calculateTotalWalletBalance(N);if(D<m)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${D} جنيه) غير كافي للمبلغ المطلوب (${m} جنيه)`}}else if(o==="withdraw"){if(f<m)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${f} جنيه) غير كافي للمبلغ المطلوب (${m} جنيه)`}}else if(o==="deposit"){const D=this.calculateTotalWalletBalance(N);if(D<m)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${D} جنيه) غير كافي للمبلغ المطلوب (${m} جنيه)`}}return{isValid:!0}}static getDeductionPreview(m,o,f){const N=[];let D=m;for(const t of f){if(D<=0)break;const S=o[t.id]||0,R=Math.min(Math.max(S,0),D);R>0&&(N.push({walletId:t.id,walletName:t.name,currentBalance:S,deductedAmount:R,newBalance:S-R}),D-=R)}return N}}let Sn=null;function Np(){const r=window;if(!Sn){const m=r.AudioContext||r.webkitAudioContext;Sn=new m}return Sn.state==="suspended"&&Sn.resume(),Sn}function jp(r,m,o){const f=o/1e3,N=Math.floor(r.sampleRate*f),D=r.createBuffer(1,N,r.sampleRate),t=D.getChannelData(0);for(let L=0;L<N;L++)t[L]=(Math.random()*2-1)*.6;const S=r.createBufferSource();S.buffer=D;const R=r.createBiquadFilter();R.type="highpass",R.frequency.value=1500,R.Q.value=.7;const C=r.createGain();C.gain.setValueAtTime(1e-4,m),C.gain.exponentialRampToValueAtTime(.4,m+.015),C.gain.exponentialRampToValueAtTime(1e-4,m+f),S.connect(R),R.connect(C),C.connect(r.destination),S.start(m),S.stop(m+f+.01)}function Sp(r,m,o,f,N,D="triangle"){const t=r.createOscillator(),S=r.createGain();t.type=D;const R=N/1e3;t.frequency.setValueAtTime(o,m),t.frequency.linearRampToValueAtTime(f,m+R),S.gain.setValueAtTime(1e-4,m),S.gain.exponentialRampToValueAtTime(.25,m+.02),S.gain.exponentialRampToValueAtTime(1e-4,m+R),t.connect(S),S.connect(r.destination),t.start(m),t.stop(m+R+.02)}function Dp(){try{const r=Np(),m=r.currentTime;jp(r,m,90),Sp(r,m+.12,1900,1100,180,"sawtooth")}catch{}}function Cp(r){if(!r)return!1;const o=r.replace(/[^0-9٠-٩]/g,"").replace(/[٠-٩]/g,f=>"0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(f)]);return/^(010|011|012|015)[0-9]{8}$/.test(o)}function Ip({userId:r}){const[m,o]=He.useState(null),[f,N]=He.useState("");return null}const Sg=()=>{var Bc,Uc,zc,qc,Vc,Jc;console.log("🔥 UserDashboardPage component is loading...");const{toast:r}=xa(),m=i.useRef(null),[o,f]=i.useState(0),N=async()=>{var n,l,c;const s="alkaptin678678@gmail.com",a=(l=(n=Wr.currentUser)==null?void 0:n.email)==null?void 0:l.toLowerCase();if(!a||a!==s){r({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}if(!ii||!li||!oi){r({title:"بيانات ناقصة",description:"أدخل رقم الموبايل، الشركة والمبلغ",variant:"destructive"});return}try{gc(!0);const h=await((c=Wr.currentUser)==null?void 0:c.getIdToken()),u=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...h?{Authorization:`Bearer ${h}`}:{}},body:JSON.stringify({phone:ii,countryCode:"EG",operator:li,amount:Number(oi),useLocalAmount:!0})}),g=await u.json().catch(()=>({}));u.ok&&(g!=null&&g.success)?(r({title:"تم الشحن",description:(g==null?void 0:g.message)||"تم تنفيذ عملية الشحن بنجاح"}),Nl(!1),hc(""),uc(""),xc("")):r({title:"فشل الشحن",description:(g==null?void 0:g.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(h){console.error("Topup request error:",h),r({title:"خطأ غير متوقع",description:"تعذّر تنفيذ عملية الشحن. حاول لاحقاً.",variant:"destructive"})}finally{gc(!1)}},{signOut:D,user:t,profile:S}=Ca(),R=((t==null?void 0:t.email)||"").toLowerCase()==="vodafonecash00@gmail.com",C=Nd(),L=vd(),k=Du(),{isShiftActive:y,shiftUser:w}=Mn(),{shopId:_,shopName:Q}=Ei(),E=fd(),Y=Cu();(()=>{try{return!!window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:"}catch{return!1}})();const[ie,me]=i.useState(!1),[M,F]=i.useState(!1),[le,Ee]=i.useState(!1),[ue,ve]=i.useState(!1),[ae,Be]=i.useState([]),[qe,$e]=i.useState(""),[Qe,Ge]=i.useState(""),[Ct,ne]=i.useState(""),[Ie,tt]=i.useState(""),[xe,Me]=i.useState(!1),[Pt,zt]=i.useState(!1),[$t,ts]=i.useState(null),[We,Je]=i.useState(""),[mt,Re]=i.useState(""),[Xe,X]=i.useState(!1),[U,Rt]=i.useState("");i.useEffect(()=>{const s=k==null?void 0:k.shopId;if(s&&(t!=null&&t.uid))try{const a=`selectedShopId_${t.uid}`;localStorage.setItem(a,String(s)),window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}},[k==null?void 0:k.shopId,t==null?void 0:t.uid]);const[Ot,W]=i.useState([]),[we,Le]=i.useState(()=>{try{return localStorage.getItem("cashySelectedDevice")||null}catch{return null}});i.useEffect(()=>{},[]),i.useEffect(()=>{(async()=>{if(U)try{await wn.set({key:"selected_wallet_id",value:U}),console.log("📱 Synced selected_wallet_id to Native:",U)}catch(a){console.error("Failed to sync wallet to native:",a)}else await wn.remove({key:"selected_wallet_id"})})()},[U]),i.useEffect(()=>{(async()=>{if(_)try{await wn.set({key:"shopId",value:_}),console.log("📱 Synced shopId to Native:",_)}catch(a){console.error("Failed to sync shopId to native:",a)}})()},[_]);const pt=s=>!!(s&&Ot.some(a=>a.id===s));async function gt(){const s=window.electronAPI,a=we||"";if(!s||typeof s.sendUssd!="function")return null;if(!a)return r({title:"الجهاز غير محدد",description:"اتصل بالموبايل أولاً ثم اختر الجهاز من القائمة",variant:"destructive"}),null;if(pt(a))return a;try{const h=Ot.find(u=>u&&u.id&&!String(u.id).includes(":"));if(h&&h.id)return Le(h.id),h.id}catch{}const n=a.includes(":")?a.split(":").slice(0,2).join(":"):"";if(n&&typeof s.connectWifi=="function"){try{await s.connectWifi(n)}catch{}if(await new Promise(h=>setTimeout(h,250)),pt(a))return a}const l=a.split(":")[0],c=Ot.find(h=>(h.id.startsWith(l)||h.id.includes(l))&&h.id.includes(":"));if(c!=null&&c.id){const h=c.id.split(":").slice(0,2).join(":");if(!pt(c.id)&&typeof s.connectWifi=="function"){try{await s.connectWifi(h)}catch{}await new Promise(u=>setTimeout(u,250))}if(pt(c.id))return Le(c.id),c.id}return r({title:"الجهاز غير متصل",description:"فعّل Wireless debugging أو استخدم اتصال Wi‑Fi ثم أعد المحاولة",variant:"destructive"}),null}i.useEffect(()=>{const s=window.electronAPI;s&&typeof s.onAdbDevices=="function"&&s.onAdbDevices(a=>{var c;const n=Array.isArray(a)?a:[];W(n);const l=(()=>{try{return localStorage.getItem("cashySelectedDevice")||""}catch{return""}})();l&&n.some(h=>h.id===l)?Le(l):(c=n[0])!=null&&c.id?Le(h=>h||n[0].id):Le(null)})},[]);function ms(s,a){try{const n=us==null?void 0:us(),l=(n==null?void 0:n.phone)||"";if(!l){r({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"});return}Ou(l,s,a),r({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),lr(!1),Tr(!1)}catch(n){const l=(n==null?void 0:n.message)||"تعذر إرسال الكود — تحقق من البيانات";throw r({title:"فشل الإرسال",description:l,variant:"destructive"}),n}}const os=async()=>{var n;if(!Hs||!Hs.receiver||!Hs.amount){r({title:"بيانات غير مكتملة",description:"تأكد من إدخال رقم المستقبل والمبلغ قبل الإرسال",variant:"destructive"});return}const s=String(Hs.receiver),a=Math.round(Number(Hs.amount));or(!0);try{if((n=Pi)!=null&&n.isNativePlatform&&Pi.getPlatform()==="android"){const c=us==null?void 0:us(),h=(c==null?void 0:c.phone)||"";if(!h){r({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),or(!1);return}const u=td(h,s,a);if(!u){r({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),or(!1);return}_u(u),r({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),lr(!1),Tr(!1);return}const l=window.electronAPI;if(l&&typeof l.sendUssd=="function"&&we){const c=us==null?void 0:us(),h=(c==null?void 0:c.phone)||"";if(!h){r({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),or(!1);return}const u=await gt();if(!u){or(!1);return}const g=td(h,s,a);if(!g){r({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),or(!1);return}try{const j=typeof l.pickSimAutomatically=="function"?await l.pickSimAutomatically(u,h):{deviceId:u,slot:0},p=`${j.deviceId}:sim${j.slot}`;_m(p),await l.sendUssd(p,g)}catch{try{await l.sendUssd(u,g)}catch(p){const v=u.includes(":")?u.split(":").slice(0,2).join(":"):"";if(v&&typeof l.connectWifi=="function")await l.connectWifi(v),await l.sendUssd(u,g);else throw p}}r({title:"تم إرسال كود التحويل",description:"تم التنفيذ بنجاح"}),lr(!1),Tr(!0)}else ms(s,a)}catch(l){const c=l&&l.message?l.message:"حدث خطأ غير متوقع أثناء الإرسال";r({title:"خطأ أثناء الإرسال",description:`الجهاز: ${Oo||we||"غير معروف"} — ${c}`,variant:"destructive"})}finally{or(!1)}},Lt=async(s,a)=>{const n=window.electronAPI;try{if(n&&typeof n.enterPin=="function"&&s){await n.enterPin(s,a),Tr(!1);return}const l=String((S==null?void 0:S.bridgeLink)||"").trim(),c=String((S==null?void 0:S.bridgeDeviceId)||"").trim()||void 0;if(!l){r({title:"الرابط غير مُعدّ",description:"احفظ رابط الجسر أولاً",variant:"destructive"});return}const h=String((Hs==null?void 0:Hs.receiver)||Ss||"").replace(/\D/g,""),u=Math.max(1,Math.round(Number((Hs==null?void 0:Hs.amount)||cs||0))||0),g=String(a||"").replace(/\D/g,""),p=(v=>{let I=(v||"").trim();return I=I.replace(/\/+$/,""),/^https?:\/\//i.test(I)||(I=`https://${I}`),I})(l);Tr(!1)}catch(l){const c=(l==null?void 0:l.message)||"حدث خطأ أثناء إدخال الرقم السري";r({title:"فشل الإدخال",description:c,variant:"destructive"})}};console.log("🔥 UserDashboardPage - user:",t?"exists":"null");const[nt,kt]=i.useState(!0),[Qt,$s]=i.useState(!0),[hs,ss]=i.useState(!1),[Ia,Js]=i.useState(!1),[va,ws]=i.useState(""),[O,fe]=i.useState(""),[ge,Fe]=i.useState(""),[Ve,vt]=i.useState([]),[Nt,H]=i.useState(!1),[ye,G]=i.useState(null),[ht,It]=i.useState(""),[as,Ns]=i.useState(!1),[sa,la]=i.useState(!1),[Nr,Fs]=i.useState(!1),[Hr,Aa]=i.useState(!1),[z,Se]=i.useState(""),[jt,ft]=i.useState(""),[js,rs]=i.useState([]),[Gt,Ba]=i.useState(!1),[wa,Qr]=i.useState(0),[Rn,dt]=i.useState(!1),[it,Ks]=i.useState(null),[uo,Ln]=i.useState(!1),[Ys,Ua]=i.useState(""),[Ss,za]=i.useState(""),[cs,d]=i.useState(""),[P,B]=i.useState(""),[ee,Z]=i.useState(""),[Ne,pe]=i.useState(!1),[be,Oe]=i.useState(""),[Ae,re]=i.useState(""),[St,ds]=i.useState(""),[Os,pa]=i.useState(""),[Ds,Ta]=i.useState(null),[Es,Pa]=i.useState(!1),[$n,Mi]=i.useState(!1),[jr,Sr]=i.useState(!1),[Fn,Dr]=i.useState(!1),[Wn,Gr]=i.useState(null),[Cs,Ri]=i.useState(""),[Is,Li]=i.useState(""),[xo,cm]=i.useState(""),[dm,po]=i.useState(!1),[Ap,Tp]=i.useState(null),[$i,go]=i.useState(null),[mm,Fi]=i.useState(!1);i.useEffect(()=>{(async()=>{try{const a=t!=null&&t.uid?`withdrawSenderNameInputEnabled_${t==null?void 0:t.uid}`:"withdrawSenderNameInputEnabled";let n=null;try{n=localStorage.getItem(a)??localStorage.getItem("withdrawSenderNameInputEnabled")}catch{}if(t!=null&&t.uid)try{const l=await Rr(()=>Ce.getUserData(t.uid)),c=l==null?void 0:l.withdrawSenderNameInputEnabled;if(typeof c=="boolean"){Fi(c);try{localStorage.setItem(a,c?"true":"false")}catch{}return}}catch{}Fi(n==="true")}catch{Fi(!1)}})()},[t==null?void 0:t.uid]);const Bn=s=>{const a="٠١٢٣٤٥٦٧٨٩",n="۰۱۲۳۴۵۶۷۸۹";return(s||"").split("").map(l=>{const c=a.indexOf(l);if(c>-1)return String(c);const h=n.indexOf(l);return h>-1?String(h):l}).join("")},[At,Wi]=i.useState(()=>{try{const s=localStorage.getItem("commissionMode")||localStorage.getItem("commissionMode_default");return s?s==="add":!0}catch{return!0}}),[ce,fo]=i.useState("transfer"),[Ze,Na]=i.useState([]),[ka,Bi]=i.useState("all"),[Dt,As]=i.useState([]),Ui=md({enabled:!!(t!=null&&t.uid),queryKey:["recentTransactions",t==null?void 0:t.uid,_||"main"],queryFn:async()=>{const{collection:s,query:a,where:n,orderBy:l,limit:c,getDocs:h}=await wt(async()=>{const{collection:$,query:K,where:oe,orderBy:st,limit:Wt,getDocs:Vt}=await import("./index-DA5EGBVC.js").then(Ws=>Ws.c4);return{collection:$,query:K,where:oe,orderBy:st,limit:Wt,getDocs:Vt}},__vite__mapDeps([0,1]),import.meta.url),{db:u}=await wt(async()=>{const{db:$}=await import("./index-DA5EGBVC.js").then(K=>K.c5);return{db:$}},__vite__mapDeps([0,1]),import.meta.url),g=a(s(u,"userTransactions"),n("userId","==",String((t==null?void 0:t.uid)||"")),l("createdAt","desc"),c(100)),v=(await h(g)).docs.map($=>{var da;const K=$.data(),oe=(da=K.createdAt)!=null&&da.toDate?K.createdAt.toDate():new Date(K.createdAt),st=String(K.transactionType||K.txnType||K.type||"").toLowerCase(),Wt=st==="withdraw"||st==="receive"?"withdraw":"send",Vt=K.status==="confirmed"?"completed":K.status||"completed",Ws=K.senderMsisdn||K.senderPhone||"",ca=K.receiverMsisdn||K.receiverPhone||"",Gs=Number(K.amount??K.transferredAmount??K.withdrawnAmount??0);return{id:$.id,...K,type:Wt,status:Vt,senderPhone:Ws,receiverPhone:ca,amount:Gs,createdAt:oe}}).filter($=>!(($==null?void 0:$.type)==="report"||String(($==null?void 0:$.title)||"").includes("إيصال تسليم وردية"))),I=new Set((en||[]).map($=>String($.id||$.originalTransactionId||""))),T=v.filter($=>!I.has(String($.id||""))),A=$=>{var K;return String($.transactionId||$.id||$.reference||((K=$.receipt)==null?void 0:K.reference)||`${new Date($.createdAt).getTime()}`)},J=new Set,Ue=[];for(const $ of T){const K=A($);J.has(K)||(J.add(K),Ue.push($))}return Ue},staleTime:6e4,gcTime:3e5,refetchOnWindowFocus:!1,refetchOnReconnect:!0});i.useEffect(()=>{const s=Ui.data;s&&Array.isArray(s)&&Na(s)},[Ui.data]),i.useEffect(()=>{try{if(localStorage.setItem("commissionMode",At?"add":"deduct"),t!=null&&t.uid){const s=`commissionMode_${t.uid}`;localStorage.setItem(s,At?"add":"deduct")}}catch{}},[At,t==null?void 0:t.uid]),i.useEffect(()=>{try{const s=new Set((Ze||[]).filter(l=>String((l==null?void 0:l.status)||"")==="completed"&&(l==null?void 0:l.linkedDebtId)).map(l=>String(l.linkedDebtId)));if(s.size===0)return;const a=Dt.map(l=>{if(s.has(String(l.id))){const c=Number(l.amount||0),h=Number(l.paidAmount||0);if(l.status!=="paid"||h<c)return{...l,status:"paid",paidAmount:c}}return l});if(a.some((l,c)=>l!==Dt[c])){As(a),(async()=>await oa(a))();try{t!=null&&t.uid&&a.filter((c,h)=>c!==Dt[h]&&c.status==="paid").forEach(c=>{try{Za.send(t.uid,`تم سداد الدين بالكامل للعميل ${c.debtorName}: المدفوع ${Number(c.paidAmount||c.amount||0)} جنيه`)}catch{}})}catch{}}}catch{}},[Ze,Dt,t==null?void 0:t.uid]),i.useEffect(()=>{try{const s=t!=null&&t.uid?localStorage.getItem(`commissionMode_${t.uid}`):null,a=localStorage.getItem("commissionMode"),n=localStorage.getItem("commissionMode_default"),l=s??a??n;l&&Wi(l==="add")}catch{}},[t==null?void 0:t.uid]);const[zi,Zr]=i.useState(!1),[hm,um]=i.useState(null),Un=He.useRef(""),yo=He.useRef(0);i.useEffect(()=>{const s=a=>{var l;if(zi)return;try{const c=document.activeElement;if(c){const h=(l=c.tagName)==null?void 0:l.toLowerCase();if(h==="input"||h==="textarea"||h==="select"||h==="button"||c.isContentEditable===!0)return}}catch{}const n=Date.now();if(a.key==="Enter"){const c=(Un.current||"").trim();Un.current="",c&&(um(c),Zr(!0));return}a.key.length===1&&(n-(yo.current||0)>100&&(Un.current=""),Un.current+=a.key,yo.current=n)};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[zi]);const[xm,pm]=i.useState(!1),[gm,Pp]=i.useState(null);i.useEffect(()=>{if(!Ne)return;const s=us(),a=parseFloat(cs||"0")||0;let n=0;if(ce==="transfer"){if((s==null?void 0:s.defaultTransferCommission)!=null){const c=Number(s.defaultTransferCommission)||0;n=Math.round(c*a/1e3*100)/100}else{const c=Is&&Is.trim()!==""?parseFloat(Is):0;n=Math.max(0,c)}const l=a+n;re((l||0).toString())}else{if((s==null?void 0:s.defaultWithdrawCommission)!=null){const c=Number(s.defaultWithdrawCommission)||0;n=Math.round(c*a/1e3*100)/100}else{const c=Cs&&Cs.trim()!==""?parseFloat(Cs):Math.round(a*.01*100)/100;n=Math.max(0,c)}const l=At?a:Math.max(0,Math.round((a-n)*100)/100);re((l||0).toString())}},[Ne,cs,Is,Cs,U,At,ce]);const us=()=>{var a,n;let s=Ke.find(l=>l.id===U);if(!s)try{const l=localStorage.getItem(kl());if(l){const c=JSON.parse(l);if(Array.isArray(c)&&c.length>0){const u=localStorage.getItem(Mr())||((a=c.find(g=>g.isDefault))==null?void 0:a.id)||((n=c[0])==null?void 0:n.id);s=c.find(g=>g.id===u)}}}catch{}return s};i.useLayoutEffect(()=>{try{const s=`wallets_${(t==null?void 0:t.uid)||"default"}`;let a=localStorage.getItem(s);if(!a){const n=Object.keys(localStorage).find(l=>l.startsWith("wallets_"));n&&(a=localStorage.getItem(n)||null)}if(a){const n=JSON.parse(a);if(Array.isArray(n)&&n.length>0){Cr(n);const l=localStorage.getItem(Mr()),c=l&&n.find(h=>h.id===l)||n.find(h=>h.isDefault)||n[0];c&&(Rt(c.id),Ua(c.phone))}}}catch(s){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",s)}},[]),i.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",U)},[U]),i.useEffect(()=>{bc()},[t==null?void 0:t.uid]),i.useEffect(()=>{Dh()},[]);const[Ke,Cr]=i.useState(()=>{try{const s=Object.keys(localStorage).find(n=>n.startsWith("wallets_")),a=s?localStorage.getItem(s):null;if(a){const n=JSON.parse(a);if(Array.isArray(n))return n}}catch{}return[]}),zn=md({enabled:!!(t!=null&&t.uid),queryKey:["wallets",t==null?void 0:t.uid],queryFn:async()=>{const{merchantWalletService:s}=await wt(async()=>{const{merchantWalletService:l}=await import("./index-DA5EGBVC.js").then(c=>c.c6);return{merchantWalletService:l}},__vite__mapDeps([0,1]),import.meta.url),a=await s.getByMerchantId(String((t==null?void 0:t.uid)||""));return(Array.isArray(a)?a:[]).filter(l=>l.isActive===!0).map(l=>({id:l.id,name:l.label||"محفظة بدون اسم",phone:l.msisdn,isDefault:!!l.isDefault,monthlyWithdrawalLimit:l.monthlyWithdrawalLimit??l.withdrawLimit??2e5,monthlyTransferLimit:l.monthlyTransferLimit??l.transferLimit??2e5,defaultTransferCommission:l.defaultTransferCommission!=null?Number(l.defaultTransferCommission):null,defaultWithdrawCommission:l.defaultWithdrawCommission!=null?Number(l.defaultWithdrawCommission):null}))},staleTime:6e4,gcTime:3e5,refetchOnReconnect:!0});i.useEffect(()=>{var a;const s=zn.data;if(s&&Array.isArray(s)){Cr(s);const n=localStorage.getItem(Mr());if(!!!(U&&s.find(c=>c.id===U))){const c=n&&s.find(h=>h.id===n)?n:((a=s[0])==null?void 0:a.id)||"";if(c){Rt(c);const h=s.find(u=>u.id===c);Ua(String((h==null?void 0:h.phone)||""))}}}},[zn.data]);const[bo,fm]=i.useState(""),vo=(()=>{const s=bo.replace(/\D/g,"");return s?Ke.filter(a=>(a.phone||"").replace(/\D/g,"").includes(s)):Ke})(),[ym,kp]=i.useState(null),[bm,wo]=i.useState(!1),[vm,qn]=i.useState(!1),[wm,Nm]=i.useState(null),[_p,jm]=i.useState([]),[Op,Ep]=i.useState([]),[Sm,Xr]=i.useState(!1),[qi,No]=i.useState("daily"),[en,Ir]=i.useState([]),[jo,Dm]=i.useState(!1),qa=He.useRef(new Set),So=He.useRef(new Set),Do=He.useRef([]);i.useEffect(()=>{Do.current=Ze},[Ze]);const Co=async s=>{try{if(!t)return;const a=Xt(),n=is(),l=localStorage.getItem(a),c=localStorage.getItem(n);let h=l?parseFloat(l):Mt,u=c?JSON.parse(c):{...ct};const g=Number(s.withdrawnAmount??s.sentAmount??s.transferredAmount??s.amount??0);if(s.type==="send"&&(s.fromWallet||U)){h-=g;const I=s.fromWallet||U;u[I]=(u[I]||0)+g}else if(s.type==="withdraw"&&(s.fromWallet||U)){h+=g;const I=s.fromWallet||U;u[I]=Math.max(0,(u[I]||0)-g)}ns(h),ps(u);const j=new Date().toISOString();localStorage.setItem(a,h.toString()),localStorage.setItem(a+"_lastUpdated",j),localStorage.setItem(n,JSON.stringify(u)),localStorage.setItem(n+"_lastUpdated",j);const p={cashBalance:h,walletBalances:u,lastUpdated:new Date().toISOString()},v=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(v,JSON.stringify(p));try{await Ce.updateUserData(t.uid,p),localStorage.removeItem(v),ot(!1)}catch(I){console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف (مزامنة تلقائية):",I),ot(!0)}try{const I=s.fromWallet||U,T=await ma.getWalletLimits(t.uid,I);if(T){const A={...T};s.type==="send"?(A.dailyTransferUsed=Math.max(0,(T.dailyTransferUsed||0)-g),A.monthlyTransferUsed=Math.max(0,(T.monthlyTransferUsed||0)-g)):(A.dailyWithdrawUsed=Math.max(0,(T.dailyWithdrawUsed||0)-g),A.monthlyWithdrawUsed=Math.max(0,(T.monthlyWithdrawUsed||0)-g)),await ma.updateWalletLimits(t.uid,I,A)}}catch(I){console.warn("تعذر تحديث حدود المحفظة بعد الحذف (مزامنة):",I)}try{Ls.removeTransactionEffects(s,t.uid)}catch(I){console.warn("تعذر تحديث التقارير بعد الحذف (مزامنة):",I)}}catch(a){console.warn("خطأ أثناء تطبيق تأثيرات الحذف محليًا:",a)}},Cm=async s=>{try{const a=Ze.find(u=>u.id===s);if(!a||!t)return;const n=String(s),l=String((a==null?void 0:a.transactionId)||(a==null?void 0:a.reference)||""),c=qa.current.has(n)||l&&qa.current.has(l),h=Ze.filter(u=>u.id!==s);Na(h);try{await Ce.removeUserTransaction(t.uid,s),await jn.permanentlyDeleteTransaction(s,t.uid)}catch(u){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",u)}if(!c){qa.current.add(n),l&&qa.current.add(l),await Co(a);try{t!=null&&t.uid&&Ce.removeLocalReceiptById(t.uid,s)}catch{}}r({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),qn(!1)}catch(a){console.error("خطأ أثناء حذف الإيصال:",a),r({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},Im=async s=>{var a;try{const n=Ze.find(l=>l.id===s);if(!n||!t)return;try{const l=(a=it==null?void 0:it.subscription)==null?void 0:a.planType;if(l===ea.ZERO){const{dailyOperationCountService:c}=await wt(async()=>{const{dailyOperationCountService:g}=await import("./dailyOperationCountService-OwwPy0KH.js");return{dailyOperationCountService:g}},__vite__mapDeps([2,0,1]),import.meta.url),h=n.type==="send"?"transfer":"withdraw";if(!(await c.checkAndIncrement(t.uid,h,5)).allowed){r({title:"تم بلوغ حد باقة الزيرو",description:"مسموح بحد أقصى 5 تأكيدات يوميًا للتحويل/السحب. جرّب غدًا أو قم بالترقية.",variant:"destructive"});return}}else if(l===ea.TAHWEELA){const{dailyOperationCountService:c}=await wt(async()=>{const{dailyOperationCountService:g}=await import("./dailyOperationCountService-OwwPy0KH.js");return{dailyOperationCountService:g}},__vite__mapDeps([2,0,1]),import.meta.url),h=n.type==="send"?"transfer":"withdraw";if(!(await c.checkAndIncrementCombined(t.uid,h,40)).allowed){r({title:"تم بلوغ حد باقة تحويله",description:"هذه الباقة تسمح بحد أقصى 40 عملية تحويل/سحب يومياً.",variant:"destructive"});return}}}catch(l){console.warn("تعذر التحقق من حد التأكيد اليومي:",l)}await Yt(ze(q,"userTransactions",s),{status:"completed",confirmedAt:new Date}),Na(l=>l.map(c=>c.id===s?{...c,status:"completed"}:c)),r({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),qn(!1)}catch(n){console.error("خطأ أثناء إكمال الإيصال:",n),r({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}};i.useEffect(()=>{if(t)try{const s=Ye(je(q,"deletedTransactions"),he("userId","==",t.uid)),a=zs(s,n=>{n.docChanges().forEach(l=>{if(l.type!=="added")return;const c=l.doc.data(),h=String((c==null?void 0:c.originalTransactionId)||""),u=String((c==null?void 0:c.transactionId)||""),g=String((c==null?void 0:c.reference)||""),j=h||u||g||String(l.doc.id);j&&(qa.current.has(j)||(qa.current.add(j),Na(p=>{const v=p.find(T=>T.id===h);return v?((async()=>await Co(v))(),p.filter(T=>T.id!==h)):p})))})},n=>{console.warn("فشل الاشتراك في deletedTransactions:",n)});return()=>a()}catch(s){console.warn("تعذر إنشاء مستمع deletedTransactions:",s)}},[t==null?void 0:t.uid]),i.useEffect(()=>{if(t)try{const s=ze(q,"users",t.uid),a=zs(s,async n=>{if(!n.exists())return;const l=n.data();if(l!=null&&l.reportsData)try{await Ls.syncReportsDataFromFirebase(t.uid),jm(gn())}catch(c){console.warn("تعذر مزامنة reportsData من السحابة:",c)}},n=>{console.warn("فشل الاشتراك في users.reportsData:",n)});return()=>a()}catch(s){console.warn("تعذر إنشاء مستمع users.reportsData:",s)}},[t==null?void 0:t.uid]);const[Io,Am]=i.useState(""),Ao=up(Io,300),[Vn,To]=i.useState(""),[Jn,Po]=i.useState(""),[_a,Mp]=i.useState(""),[Vi,Ar]=i.useState(!1),[ko,tn]=i.useState(!1),[Tm,lr]=i.useState(!1),[xs,Ji]=i.useState(null),[Hs,Pm]=i.useState(null),[_o,or]=i.useState(!1),[km,Tr]=i.useState(!1),[Oo,_m]=i.useState(""),[Om,Ki]=i.useState(!1),Eo=!1,[Em,Kn]=i.useState(!1),[Mm,Mo]=i.useState(!1),[Rm,Yn]=i.useState(!1),[Lm,Hn]=i.useState(!1),[$m,Qn]=i.useState(!1),[Fm,Ro]=i.useState(!0),[sn,Wm]=i.useState(!1),[Bm,Gn]=i.useState(!1),[Um,Lo]=i.useState(!1),[Zn,zm]=i.useState(""),[$o,qm]=i.useState(!1),[Vm,Yi]=i.useState(!1),[Jm,Fo]=i.useState(()=>{try{const s=t!=null&&t.uid?`dailyReportsLockEnabled_${t==null?void 0:t.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(s)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[Km,Hi]=i.useState(!1);i.useEffect(()=>{try{const s=t!=null&&t.uid?`dailyReportsLockEnabled_${t==null?void 0:t.uid}`:"dailyReportsLockEnabled",a=localStorage.getItem(s)??localStorage.getItem("dailyReportsLockEnabled");Fo(a==="true")}catch{}},[t==null?void 0:t.uid]);const[Ym,Pr]=i.useState(!1),[Hm,Qi]=i.useState(!1),[Qm,Wo]=i.useState(()=>{try{const s=t==null?void 0:t.uid,a=s?`debtsPinRequired_${s}`:"debtsPinRequired";return(localStorage.getItem(a)??localStorage.getItem("debtsPinRequired"))==="true"}catch{return!1}}),[Gm,Bo]=i.useState(!1),[Uo,Zm]=i.useState(null),[Gi,zo]=i.useState(""),[Zi,qo]=i.useState(""),[Xi,Vo]=i.useState(""),[kr,Jo]=i.useState(null),[te,Va]=i.useState(null),[Xm,Ja]=i.useState(!1),[eh,an]=i.useState(!1),[cr,Ko]=i.useState(null),[Yo,el]=i.useState(""),[Zt,Ho]=i.useState(null),[Rp,Lp]=i.useState(!1),[th,tl]=i.useState(!1),[Qo,sl]=i.useState(""),[al,dr]=i.useState(!1),[Go,rl]=i.useState(1),sh=Y?10:20,nl=He.useMemo(()=>Dt.slice(0,Go*sh),[Dt,Go]);i.useEffect(()=>{al&&rl(1)},[al]);const il=async()=>{if(Tt){r({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}try{const s=await ks.hasMasterPin(t==null?void 0:t.uid);Qm&&s?Qi(!0):Pr(!0)}catch{Pr(!0)}};i.useEffect(()=>{try{const s=t==null?void 0:t.uid,a=s?`debtsPinRequired_${s}`:"debtsPinRequired",n=localStorage.getItem(a)??localStorage.getItem("debtsPinRequired");(n==="true"||n==="false")&&Wo(n==="true")}catch{}},[t==null?void 0:t.uid]),i.useEffect(()=>{const s=()=>{try{oc()}catch{}};try{window.addEventListener("debtsUpdated",s)}catch{}return()=>{try{window.removeEventListener("debtsUpdated",s)}catch{}}},[t==null?void 0:t.uid,_,S==null?void 0:S.shopId]);const[ah,ll]=i.useState(!1),[aa,ol]=i.useState([]),[cl,Zo]=i.useState(""),[dl,Xo]=i.useState(""),[Xn,ec]=i.useState(""),[tc,rh]=i.useState(""),[nh,ei]=i.useState(!1),[ih,sc]=i.useState(""),[ac,ml]=i.useState(""),[rc,hl]=i.useState(""),[lh,ti]=i.useState(!1),[oh,ul]=i.useState(""),[nc,xl]=i.useState(""),[ch,_r]=i.useState(!1),[mr,rn]=i.useState(null),[Ms,nn]=i.useState(null),[ln,pl]=i.useState(""),[dh,Or]=i.useState(!1),[ic,si]=i.useState(0),[ra,Ka]=i.useState(null),[Ya,gl]=i.useState(""),[lt,fl]=i.useState(null),[mh,lc]=i.useState(""),oa=async s=>{try{const a=JSON.stringify(s);localStorage.setItem(Er(),a);try{localStorage.setItem(Dl(),a)}catch{}try{localStorage.setItem(Cl(),Date.now().toString())}catch{}t!=null&&t.uid&&Ce.updateUserData(t.uid,{debts:s}).then(()=>{try{localStorage.removeItem(`debts_unsynced_${t.uid}`)}catch{}}).catch(()=>{ot(!0);try{localStorage.setItem(`debts_unsynced_${t.uid}`,"true")}catch{}})}catch(a){console.error("خطأ في حفظ الديون:",a)}},oc=async()=>{try{const s=Er(),a=Dl(),n=Cl(),l=localStorage.getItem(s),c=localStorage.getItem(a),h=localStorage.getItem(n),u=h?Number(h):0,g=p=>{if(!p)return null;try{const v=JSON.parse(p);return Array.isArray(v)?v.map(I=>{var T;return{...I,createdAt:(T=I.createdAt)!=null&&T.toDate?I.createdAt.toDate():new Date(I.createdAt),partialPayments:Array.isArray(I.partialPayments)?I.partialPayments.map(A=>{var J;return{amount:Number(A.amount)||0,paidAt:(J=A.paidAt)!=null&&J.toDate?A.paidAt.toDate():new Date(A.paidAt)}}):[]}}):[]}catch(v){return console.warn("فشل في تحليل ديون localStorage:",v),null}};let j=g(l);if(!j||j.length===0){const p=g(c);if(p&&p.length>0){j=p,As(p);try{localStorage.setItem(Er(),JSON.stringify(p)),localStorage.removeItem(a)}catch(v){console.warn("تعذر ترحيل الديون محلياً من المفتاح الافتراضي:",v)}}}if(j&&j.length>0&&As(j),t!=null&&t.uid)try{const p=`debts_unsynced_${t.uid}`,v=localStorage.getItem(p)==="true",I=await Sa(ze(q,"users",t.uid));if(I.exists()){const T=I.data(),A=T.debts&&Array.isArray(T.debts)?T.debts.map($=>{var K;return{...$,amount:Number($.amount||0),paidAmount:Number($.paidAmount||0),createdAt:(K=$.createdAt)!=null&&K.toDate?$.createdAt.toDate():new Date($.createdAt),partialPayments:Array.isArray($.partialPayments)?$.partialPayments.map(oe=>{var st;return{amount:Number(oe.amount)||0,paidAt:(st=oe.paidAt)!=null&&st.toDate?oe.paidAt.toDate():new Date(oe.paidAt)}}):[]}}):[];if(!!T.debtsDeletedAt){As([]);try{localStorage.setItem(s,JSON.stringify([])),localStorage.setItem(a,JSON.stringify([]))}catch{}return}if(((A==null?void 0:A.length)||0)>0){As(A);try{localStorage.setItem(s,JSON.stringify(A))}catch{}}}else j&&j.length>0}catch(p){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",p)}}catch(s){console.error("خطأ في تحميل الديون:",s)}};i.useEffect(()=>{try{window.exportDebts=()=>{try{return JSON.stringify(Dt||[])}catch{return"[]"}},window.importDebts=async s=>{try{const a=JSON.parse(s);if(!Array.isArray(a))throw new Error("صيغة غير صحيحة — يجب أن تكون مصفوفة");return await oa(a),{ok:!0,count:a.length}}catch(a){return console.error("فشل استيراد الديون:",a),{ok:!1,error:String(a)}}},window.fixWalletsForCurrentUser=async s=>{try{if(!(t!=null&&t.uid))throw new Error("يجب تسجيل الدخول أولاً");return await(await wt(async()=>{const{merchantWalletService:n}=await import("./index-DA5EGBVC.js").then(l=>l.c6);return{merchantWalletService:n}},__vite__mapDeps([0,1]),import.meta.url)).merchantWalletService.reassignByMsisdns(s,t.uid)}catch(a){return console.error("فشل إصلاح المحافظ للمستخدم الحالي:",a),{updated:0,failed:(s==null?void 0:s.length)||0,error:String(a)}}}}catch{}},[Dt,t==null?void 0:t.uid]),i.useEffect(()=>{if(!(t!=null&&t.uid))return;const s=ze(q,"users",t.uid),a=zs(s,n=>{if(!n.exists())return;const l=n.data(),c=Array.isArray(l==null?void 0:l.debts)?l.debts:[];try{const h=c.map(u=>{var g;return{...u,createdAt:(g=u.createdAt)!=null&&g.toDate?u.createdAt.toDate():new Date(u.createdAt),partialPayments:Array.isArray(u.partialPayments)?u.partialPayments.map(j=>{var p;return{amount:Number(j.amount)||0,paidAt:(p=j.paidAt)!=null&&p.toDate?j.paidAt.toDate():new Date(j.paidAt)}}):[]}});As(h);try{localStorage.setItem(Er(),JSON.stringify(h))}catch{}}catch(h){console.warn("تعذر تحليل الديون من التحديثات الحية:",h)}},n=>{console.warn("خطأ في الاشتراك الحي لديون المستخدم:",n)});return()=>a()},[t==null?void 0:t.uid]);const hh=async()=>{if(t!=null&&t.uid)try{Ln(!0);const s=await co(t.uid);Ks(s)}catch(s){console.error("خطأ في جلب بيانات الاشتراك:",s)}finally{Ln(!1)}},[$p,Fp]=i.useState(!1),[uh,yl]=i.useState(!1),[Mt,ns]=i.useState(0),[ct,ps]=i.useState({}),[xh,cc]=i.useState(!1),[ph,dc]=i.useState(!1),[gh,bl]=i.useState(!1),[fh,ai]=i.useState(!1),[mc,vl]=i.useState(""),[yh,on]=i.useState(!1),[bh,ri]=i.useState(!1),[wl,ni]=i.useState(""),[vh,Nl]=i.useState(!1),[ii,hc]=i.useState(""),[li,uc]=i.useState(""),[oi,xc]=i.useState(""),[pc,gc]=i.useState(!1),[jl,Sl]=i.useState(!1),[wh,fc]=i.useState(!1),[yc,Nh]=i.useState([]);i.useEffect(()=>{(async()=>{try{if(!(t!=null&&t.uid)||!jl)return;try{await vn.trimToMaxCount(t.uid,30)}catch{}const s=await vn.getByUser(t.uid,30);Nh(s)}catch{}})()},[t==null?void 0:t.uid,jl]);const is=()=>{const s=_||(S==null?void 0:S.shopId)||"main";return`walletBalances_${(t==null?void 0:t.uid)||"default"}_${s}`},Xt=()=>{const s=_||(S==null?void 0:S.shopId)||"main";return`cashBalance_${(t==null?void 0:t.uid)||"default"}_${s}`},Er=()=>{const s=_||(S==null?void 0:S.shopId)||"main";return`debts_${(t==null?void 0:t.uid)||"default"}_${s}`},jh=()=>{const s=_||(S==null?void 0:S.shopId)||"main";return`customers_${(t==null?void 0:t.uid)||"default"}_${s}`},Dl=()=>`debts_default_${_||(S==null?void 0:S.shopId)||"main"}`,Cl=()=>{const s=_||(S==null?void 0:S.shopId)||"main";return`debts_last_write_${(t==null?void 0:t.uid)||"default"}_${s}`},Il=()=>`shopExpenses_${_||(S==null?void 0:S.shopId)||(t==null?void 0:t.uid)||"default"}`,bc=()=>{try{const s=localStorage.getItem(Il());if(s){const a=JSON.parse(s);vt(a.map(n=>({...n,createdAt:new Date(n.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",s)}},vc=async s=>{try{localStorage.setItem(Il(),JSON.stringify(s)),vt(s)}catch(a){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",a)}},Sh=async s=>{try{const a=Ve.filter(n=>n.id!==s);await vc(a);try{if(t!=null&&t.uid&&s){const{doc:n,deleteDoc:l}=await wt(async()=>{const{doc:u,deleteDoc:g}=await import("./index-DA5EGBVC.js").then(j=>j.c4);return{doc:u,deleteDoc:g}},__vite__mapDeps([0,1]),import.meta.url),{db:c}=await wt(async()=>{const{db:u}=await import("./index-DA5EGBVC.js").then(g=>g.c5);return{db:u}},__vite__mapDeps([0,1]),import.meta.url),h=n(c,"shop_expenses",s);await l(h)}}catch(n){console.warn("تعذر حذف المصروف من السحابة الآن، تم الحذف محليًا وسيبقى مخزّنًا دون هذا الإيصال:",n)}r({title:"تم الحذف",description:"تم حذف إيصال المصروف نهائيًا."})}catch(a){console.error("خطأ أثناء الحذف النهائي لإيصال المصروف:",a),r({title:"فشل الحذف",description:"تعذر حذف الإيصال. حاول مرة أخرى.",variant:"destructive"})}};He.useEffect(()=>{let s;return(async()=>{try{if(!(t!=null&&t.uid)){bc();return}const{collection:a,query:n,where:l,onSnapshot:c}=await wt(async()=>{const{collection:j,query:p,where:v,onSnapshot:I}=await import("./index-DA5EGBVC.js").then(T=>T.c4);return{collection:j,query:p,where:v,onSnapshot:I}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await wt(async()=>{const{db:j}=await import("./index-DA5EGBVC.js").then(p=>p.c5);return{db:j}},__vite__mapDeps([0,1]),import.meta.url),u=_||(S==null?void 0:S.shopId),g=u?n(a(h,"shop_expenses"),l("shopId","==",u)):n(a(h,"shop_expenses"),l("userId","==",t.uid));s=c(g,async j=>{const v=j.docs.map(I=>{var J;const T=I.data(),A=(J=T.createdAt)!=null&&J.toDate?T.createdAt.toDate():T.createdAt?new Date(T.createdAt):new Date;return{id:I.id,name:String(T.name||""),amount:Number(T.amount||0),notes:T.notes?String(T.notes):void 0,source:T.source==="wallet"?"wallet":"cash",walletId:T.walletId?String(T.walletId):void 0,createdAt:A}}).sort((I,T)=>T.createdAt.getTime()-I.createdAt.getTime());vt(v);try{localStorage.setItem(Il(),JSON.stringify(v))}catch{}})}catch(a){console.error("خطأ في مزامنة مصروفات المحل من Firestore:",a)}})(),()=>s==null?void 0:s()},[t==null?void 0:t.uid,S==null?void 0:S.shopId,_]);const ci=()=>`deficiencies_${_||(S==null?void 0:S.shopId)||(t==null?void 0:t.uid)||"default-shop"}`,Dh=()=>{try{const s=ci(),a=`deficiencies_${(t==null?void 0:t.uid)||"default"}`;if(a!==s){const l=localStorage.getItem(a),c=localStorage.getItem(s);if(l)try{const h=JSON.parse(l)||[],u=c?JSON.parse(c):[],g=Array.isArray(u)?[...u]:[],j=(p,v)=>p.some(I=>(I==null?void 0:I.id)&&(v==null?void 0:v.id)&&String(I.id)===String(v.id)||String((I==null?void 0:I.name)||"")===String((v==null?void 0:v.name)||"")&&String((I==null?void 0:I.status)||"pending")===String((v==null?void 0:v.status)||"pending"));if(Array.isArray(h))for(const p of h)j(g,p)||g.push(p);localStorage.setItem(s,JSON.stringify(g));try{localStorage.removeItem(a)}catch{}}catch{}}const n=localStorage.getItem(s);if(n){const l=JSON.parse(n);rs(l.map(c=>({...c,createdAt:new Date(c.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل النواقص من التخزين:",s)}},Al=async s=>{try{localStorage.setItem(ci(),JSON.stringify(s)),rs(s)}catch(a){console.error("خطأ أثناء حفظ النواقص في التخزين:",a)}};He.useEffect(()=>{let s;return(async()=>{try{if(!(t!=null&&t.uid))return;const{collection:a,query:n,where:l,orderBy:c,onSnapshot:h}=await wt(async()=>{const{collection:p,query:v,where:I,orderBy:T,onSnapshot:A}=await import("./index-DA5EGBVC.js").then(J=>J.c4);return{collection:p,query:v,where:I,orderBy:T,onSnapshot:A}},__vite__mapDeps([0,1]),import.meta.url),{db:u}=await wt(async()=>{const{db:p}=await import("./index-DA5EGBVC.js").then(v=>v.c5);return{db:p}},__vite__mapDeps([0,1]),import.meta.url),g=_||(S==null?void 0:S.shopId)||t.uid||"default-shop",j=n(a(u,"deficiencies"),l("shopId","==",g),c("createdAt","desc"));s=h(j,async p=>{const v=p.docs.map(I=>{var J;const T=I.data(),A=(J=T.createdAt)!=null&&J.toDate?T.createdAt.toDate():T.createdAt?new Date(T.createdAt):new Date;return{id:I.id,name:String(T.name||""),quantity:Number(T.quantity||1),status:T.status==="purchased"?"purchased":"pending",createdAt:A}});rs(v);try{localStorage.setItem(ci(),JSON.stringify(v))}catch{}},p=>{console.warn("فشل الاشتراك في النواقص من Firestore:",p)})}catch(a){console.warn("فشل إعداد مزامنة النواقص من Firestore:",a)}})(),()=>{try{s&&s()}catch{}}},[t==null?void 0:t.uid,S==null?void 0:S.shopId,_]);const Tl=async s=>{try{localStorage.setItem(jh(),JSON.stringify(s)),ol(s),t!=null&&t.uid&&await Ce.updateUserData(t.uid,{customers:s})}catch(a){console.error("خطأ أثناء حفظ العملاء في التخزين:",a)}},Ch=async()=>{try{if(t!=null&&t.uid){const s=await Sa(ze(q,"users",t.uid));if(s.exists()){const a=s.data();if(a.customers&&Array.isArray(a.customers)){const n=a.customers.map(l=>{var c;return{...l,createdAt:(c=l.createdAt)!=null&&c.toDate?l.createdAt.toDate():new Date(l.createdAt)}});ol(n);return}}}ol([])}catch(s){console.error("خطأ أثناء تحميل العملاء من Firestore:",s)}},Pl=()=>{const s=_||(S==null?void 0:S.shopId)||"main";return`transactions_${(t==null?void 0:t.uid)||"default"}_${s}`},kl=()=>{const s=_||(S==null?void 0:S.shopId)||"main";return`wallets_${(t==null?void 0:t.uid)||"default"}_${s}`},Mr=()=>{const s=_||(S==null?void 0:S.shopId)||"main";return`selectedWallet_${(t==null?void 0:t.uid)||"default"}_${s}`},wc=s=>{var c;const a=String((s==null?void 0:s.transactionId)||(s==null?void 0:s.id)||""),n=String((s==null?void 0:s.reference)||(s==null?void 0:s.transactionReference)||((c=s==null?void 0:s.receipt)==null?void 0:c.reference)||""),l=new Date((s==null?void 0:s.createdAt)||0).getTime();return a||n||`${n||"ref"}-${l}`};i.useEffect(()=>{let s;return(async()=>{try{if(!(t!=null&&t.uid))return;const{collection:a,query:n,where:l,orderBy:c,limit:h,onSnapshot:u}=await wt(async()=>{const{collection:p,query:v,where:I,orderBy:T,limit:A,onSnapshot:J}=await import("./index-DA5EGBVC.js").then(Ue=>Ue.c4);return{collection:p,query:v,where:I,orderBy:T,limit:A,onSnapshot:J}},__vite__mapDeps([0,1]),import.meta.url),{db:g}=await wt(async()=>{const{db:p}=await import("./index-DA5EGBVC.js").then(v=>v.c5);return{db:p}},__vite__mapDeps([0,1]),import.meta.url),j=n(a(g,"userTransactions"),l("userId","==",t.uid),c("createdAt","desc"),h(100));s=u(j,p=>{jo||Dm(!0);const I=p.docs.map($=>{var Gs;const K=$.data(),oe=(Gs=K.createdAt)!=null&&Gs.toDate?K.createdAt.toDate():new Date(K.createdAt),st=K.txnType==="send"?"send":K.txnType==="receive"?"withdraw":K.type||"withdraw",Wt=K.status==="confirmed"?"completed":K.status||"completed",Vt=K.senderMsisdn||K.senderPhone||"",Ws=K.receiverMsisdn||K.receiverPhone||"",ca=Number(K.amount??K.transferredAmount??K.withdrawnAmount??0);return{id:$.id,...K,type:st,status:Wt,senderPhone:Vt,receiverPhone:Ws,amount:ca,createdAt:oe,provider:K.provider||void 0}}).filter($=>!(($==null?void 0:$.type)==="report"||String(($==null?void 0:$.title)||"").includes("إيصال تسليم وردية"))),T=new Set((en||[]).map($=>String($.id||$.originalTransactionId||""))),A=I.filter($=>!T.has(String($.id||""))),J=new Set,Ue=[];for(const $ of A){const K=wc($);J.has(K)||(J.add(K),Ue.push($))}Na(Ue)})}catch{}})(),()=>{try{s&&s()}catch{}}},[t==null?void 0:t.uid,en.length]),i.useEffect(()=>{if(!(t!=null&&t.uid))return;let s=null;return(async()=>{try{const{collection:a,query:n,where:l,onSnapshot:c}=await wt(async()=>{const{collection:g,query:j,where:p,onSnapshot:v}=await import("./index-DA5EGBVC.js").then(I=>I.c4);return{collection:g,query:j,where:p,onSnapshot:v}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await wt(async()=>{const{db:g}=await import("./index-DA5EGBVC.js").then(j=>j.c5);return{db:g}},__vite__mapDeps([0,1]),import.meta.url),u=n(a(h,"deletedTransactions"),l("userId","==",t.uid));s=c(u,g=>{try{g.docChanges().forEach(p=>{const v=p.doc.data(),I=[v.originalTransactionId,v.transactionId,v.reference,p.doc.id].filter(Boolean).map(J=>String(J));if(I.find(J=>So.current.has(J)))return;const A=Do.current.find(J=>{const Ue=String(J.id||""),$=String(J.transactionId||""),K=String(J.reference||"");return I.includes(Ue)||I.includes($)||I.includes(K)});if(A){const J=A.fromWallet||U||"",Ue=Number(A.withdrawnAmount??A.sentAmount??A.amount??0),$=A.type==="send"?"transfer":"withdraw";J&&Ue>0&&(ma.rollbackUsage(J,Ue,$).catch(()=>{}),I.forEach(K=>So.current.add(K)))}});const j=g.docs.map(p=>{var T;const v=p.data(),I=(T=v.createdAt)!=null&&T.toDate?v.createdAt.toDate():new Date(v.createdAt||Date.now());return{id:p.id,...v,createdAt:I}});Ir(j),(async()=>{try{const p=_||(S==null?void 0:S.shopId);if(!p)return;const v=Xt(),I=is(),T=localStorage.getItem(v),A=localStorage.getItem(v+"_lastUpdated"),J=localStorage.getItem(I),Ue=localStorage.getItem(I+"_lastUpdated"),$=ze(h,"dashboardData",p),K=await Sa($);if(K.exists()){const oe=K.data(),st=oe.lastUpdated?new Date(oe.lastUpdated).getTime():0;let Wt=typeof oe.cashBalance=="number"?Number(oe.cashBalance||0):0;T&&A&&new Date(A).getTime()>st&&(Wt=Number(T),Yt($,{cashBalance:Wt,lastUpdated:new Date().toISOString()}).catch(()=>{})),ns(Wt);let Vt=oe.walletBalances&&typeof oe.walletBalances=="object"?oe.walletBalances||{}:{};if(J&&Ue&&new Date(Ue).getTime()>st)try{Vt=JSON.parse(J),Yt($,{walletBalances:Vt,lastUpdated:new Date().toISOString()}).catch(()=>{})}catch{}ps(Vt)}}catch{}})()}catch{}},g=>{console.warn("deletedTransactions subscription error (Dashboard):",g)})}catch{}})(),()=>{try{s&&s()}catch{}}},[t==null?void 0:t.uid,S==null?void 0:S.shopId,_]);const[_l,di]=i.useState(""),[Qs,Nc]=i.useState(""),ja=He.useMemo(()=>{const s=it;if(!s)return!1;const a=Iu(s),n=s.planType??s.plan??null,l=typeof n=="string"?n.toLowerCase():null,c=l==="monthly"||l==="quarterly"||l==="yearly"||l==="lifetime"||n===ea.MONTHLY||n===ea.QUARTERLY||n===ea.YEARLY||n===ea.LIFETIME;return a&&c},[it]),Tt=He.useMemo(()=>{var l,c;const s=it;if(!s)return!1;const a=((l=s.subscription)==null?void 0:l.planType)??((c=s.subscription)==null?void 0:c.plan)??s.planType??s.plan??null,n=typeof a=="string"?a.toLowerCase():null;return a===ea.ZERO||n==="zero"},[it]),Ft=He.useMemo(()=>{var l,c;const s=it;if(!s)return!1;const a=((l=s.subscription)==null?void 0:l.planType)??((c=s.subscription)==null?void 0:c.plan)??s.planType??s.plan??null,n=typeof a=="string"?String(a).trim().toLowerCase():null;return a===ea.TAHWEELA||n==="tahweela"||n==="تحويله"},[it]),Ih=()=>{if(!ja){r({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}me(!0)},[Wp,Bp]=i.useState(!1),[Ah,Th]=i.useState(!1),[Ph,kh]=i.useState(!1),[_h,Oh]=i.useState(!1),[Eh,cn]=i.useState(!1),[hr,mi]=i.useState(""),[dn,hi]=i.useState(""),[jc,ui]=i.useState(!1),[mn,hn]=i.useState(null),[Ol,xi]=i.useState(""),[Mh,Sc]=i.useState(!1),[Up,zp]=i.useState(!1),[Rh,pi]=i.useState(!1),[Dc,El]=i.useState(""),[Cc,Ml]=i.useState(""),[Ic,Ac]=i.useState(!1),Tc=async()=>{var s;if(t!=null&&t.uid)try{const a=`userData_${t.uid}`,n=localStorage.getItem(a),l=`debts_unsynced_${t.uid}`,c=localStorage.getItem(Er()),h=localStorage.getItem(l)==="true";if(n){const u=JSON.parse(n);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",u);const g={lastSynced:new Date().toISOString()};typeof u.cashBalance=="number"&&(g.cashBalance=u.cashBalance),u.walletBalances&&typeof u.walletBalances=="object"&&(g.walletBalances=u.walletBalances),await Ce.updateUserData(t.uid,g),localStorage.removeItem(a),ot(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة");if(h&&c)try{const u=JSON.parse(c)||[],g=$=>$ instanceof Date?$:typeof($==null?void 0:$.toDate)=="function"?$.toDate():$?new Date(String($)):new Date,j=$=>(Array.isArray($)?$:[]).map(K=>({...K,amount:Number(K.amount||0),paidAmount:Number(K.paidAmount||0),createdAt:g(K.createdAt),partialPayments:Array.isArray(K.partialPayments)?K.partialPayments.map(oe=>({amount:Number(oe.amount||0),paidAt:g(oe.paidAt)})):[]})),p=await Sa(ze(q,"users",t.uid)),v=p.exists()?((s=p.data())==null?void 0:s.debts)||[]:[],I=j(v),T=j(u),A={};for(const $ of I)A[String($.id||"")]=$;const J=[],Ue=new Set;for(const $ of T){const K=String($.id||""),oe=A[K];if(oe){const st=Number(oe.paidAmount||0)+(Array.isArray(oe.partialPayments)?oe.partialPayments.reduce((Gs,da)=>Gs+Number(da.amount||0),0):0),Wt=Number($.paidAmount||0)+(Array.isArray($.partialPayments)?$.partialPayments.reduce((Gs,da)=>Gs+Number(da.amount||0),0):0),Vt=String(oe.status||"pending"),Ws=String($.status||"pending"),ca=Vt==="paid"||st>=Number(oe.amount||0)?oe:Ws==="paid"?{...oe,paidAmount:Number($.paidAmount||0),partialPayments:$.partialPayments,status:"paid"}:Wt>st?{...oe,paidAmount:Number($.paidAmount||0),partialPayments:$.partialPayments,status:Wt>=Number(oe.amount||0)?"paid":"pending"}:oe;J.push(ca),Ue.add(K)}else J.push($),Ue.add(K)}for(const $ of I){const K=String($.id||"");Ue.has(K)||J.push($)}await Ce.updateUserData(t.uid,{debts:J});try{localStorage.removeItem(l)}catch{}ot(!1)}catch{ot(!0)}}catch(a){console.error("❌ فشل في مزامنة البيانات:",a),r({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},[Pc,gi]=i.useState({keepLastCount:30,intervalDays:7,lastResetAt:null});i.useEffect(()=>{(async()=>{if(t!=null&&t.uid)try{const a=await Ce.getUserData(t.uid),n=(a==null?void 0:a.recentReset)||{},l=Number(n==null?void 0:n.keepLastCount)>0?Number(n.keepLastCount):30,c=Number(n==null?void 0:n.intervalDays)>0?Number(n.intervalDays):7,h=p=>p instanceof Date?p:typeof(p==null?void 0:p.toDate)=="function"?p.toDate():p?new Date(String(p)):null,u=n!=null&&n.lastResetAt?h(n.lastResetAt):null,g=new Date;!u||g.getTime()-u.getTime()>=c*24*60*60*1e3?(await Ce.updateUserData(t.uid,{recentReset:{keepLastCount:l,intervalDays:c,lastResetAt:g}}),gi({keepLastCount:l,intervalDays:c,lastResetAt:g})):gi({keepLastCount:l,intervalDays:c,lastResetAt:u})}catch{gi({keepLastCount:30,intervalDays:7,lastResetAt:null})}})()},[t==null?void 0:t.uid]);const kc=He.useMemo(()=>{const s=Ze||[],a=u=>u instanceof Date?u:typeof(u==null?void 0:u.toDate)=="function"?u.toDate():new Date(String(u)),n=new Date,l=new Date(n.getFullYear(),n.getMonth(),1),c=new Date(n.getFullYear(),n.getMonth()+1,1);return[...s].sort((u,g)=>a(g.createdAt).getTime()-a(u.createdAt).getTime()).filter(u=>{const g=a(u.createdAt);return g>=l&&g<c})},[Ze]),Lh=He.useMemo(()=>{const s=Ze||[],a=u=>u instanceof Date?u:typeof(u==null?void 0:u.toDate)=="function"?u.toDate():new Date(String(u)),n=new Date,l=new Date(n.getFullYear(),n.getMonth(),1),c=new Date(n.getFullYear(),n.getMonth()+1,1),h=s.filter(u=>{const g=a(u.createdAt);return g>=l&&g<c}).length;return Math.max(0,((Ze==null?void 0:Ze.length)||0)-h)},[Ze==null?void 0:Ze.length]),fi=He.useMemo(()=>{const s=new Date,a=new Date(s.getFullYear(),s.getMonth(),1),n=new Date(s.getFullYear(),s.getMonth()+1,1),l={};for(const h of Ze){const u=new Date(h.createdAt||0);if(!(u>=a&&u<n))continue;const g=String(h.type||h.txnType||"").toLowerCase();if(!(g==="send"||g==="withdraw"||g==="transfer"))continue;const j=String(h.receiverPhone||h.senderPhone||"").trim();if(!j)continue;const p=ta(j),v=Number(h.amount||h.withdrawnAmount||h.sentAmount||0)||0;l[p]||(l[p]={phone:p,count:0,total:0}),l[p].count+=1,l[p].total+=v}return Object.values(l).sort((h,u)=>u.count!==h.count?u.count-h.count:u.total-h.total).slice(0,10)},[Ze]),$h=s=>{const a=ta(String(s));return a.startsWith("+20")?"20"+a.slice(3):a.startsWith("0")?"20"+a.slice(1):a.replace(/[^0-9]/g,"")},Fh=s=>{const a=$h(s.phone),n=`عميل VIP هذا الشهر
عدد العمليات: ${s.count}
الإجمالي: ${s.total} جنيه`,l=`https://wa.me/${a}?text=${encodeURIComponent(n)}`;try{window.open(l,"_blank")}catch{}};i.useEffect(()=>{(async()=>{try{if(!(t!=null&&t.uid))return;const s=`${new Date().getFullYear()}-${new Date().getMonth()+1}`;await Ce.updateUserData(t.uid,{vipTop10:fi,vipMonthTag:s})}catch{}})()},[t==null?void 0:t.uid,fi]);async function _c(){const s=new Date,a=new Intl.DateTimeFormat("ar-EG",{timeZone:"Africa/Cairo",year:"numeric",month:"2-digit",day:"2-digit"}).format(s),n=new Date(s.getFullYear(),s.getMonth(),s.getDate(),0,0,0,0),l=new Date(s.getFullYear(),s.getMonth(),s.getDate(),23,59,59,999),c=(Ze||[]).filter(A=>{const J=new Date(A.createdAt||0);return J>=n&&J<=l}),h=c.length,u=c.filter(A=>String(A.type||A.txnType||"").toLowerCase()==="withdraw"||String(A.type||"").toLowerCase()==="receive").reduce((A,J)=>A+(J.withdrawnAmount!=null?Number(J.withdrawnAmount):Number(J.amount||0)),0),g=c.filter(A=>String(A.type||A.txnType||"").toLowerCase()==="send"||String(A.type||"").toLowerCase()==="transfer").reduce((A,J)=>A+(J.sentAmount!=null?Number(J.sentAmount):Number(J.amount||0)),0);let j=0;try{j=c.reduce((A,J)=>A+Ls.calculateTransactionProfit(J),0)}catch{}let p=0;try{const A=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(s),J=Ye(je(q,"dailySales"),he("userId","==",(t==null?void 0:t.uid)||""));p=(await et(J)).docs.map(K=>K.data()).filter(K=>String(K.date||A)===A).reduce((K,oe)=>K+Number(oe.sellingPrice||oe.price||0)*Number(oe.quantity||1),0)}catch{}let v=0;try{v=(Dt||[]).filter(J=>String(J.status||"")==="pending").reduce((J,Ue)=>{const $=Number(Ue.paidAmount||0)+(Array.isArray(Ue.partialPayments)?Ue.partialPayments:[]).reduce((K,oe)=>K+Number(oe.amount||0),0);return J+Math.max(0,Number(Ue.amount||0)-$)},0)}catch{}let I="";try{const A=_||(S==null?void 0:S.shopId)||null,J=A?Ye(je(q,"deficiencies"),he("shopId","==",A)):Ye(je(q,"deficiencies"),he("userId","==",(t==null?void 0:t.uid)||""));I=(await et(J)).docs.map(oe=>oe.data()).filter(oe=>String(oe.status||"pending")==="pending").slice(0,10).map((oe,st)=>`${st+1}- ${String(oe.name||oe.productName||"عنصر")} × ${Number(oe.quantity||oe.qty||0)}`).join(`
`)}catch{}return[`تقرير يومي - ${a}`,`عدد العمليات: ${h}`,`إجمالي المسحوبات: ${u} جنيه`,`إجمالي الإرسال: ${g} جنيه`,`الأرباح: ${j} جنيه`,`إجمالي مبيعات الاكسسوار: ${p} جنيه`,`إجمالي الديون: ${v} جنيه`,"نواقص الاكسسوار:",I||"لا توجد عناصر مسجلة"].join(`
`)}const Oc=He.useCallback(()=>{let s=kc;const a=Ao.trim();if(a&&(s=s.filter(n=>{const l=n;return String(l.type||"").toLowerCase()==="cash_addition"||String(l.txnType||"").toLowerCase()==="cash_addition"||String(l.title||"").includes("إيصال إضافة نقدية")?!0:n.senderPhone&&n.senderPhone.includes(a)||n.receiverPhone&&n.receiverPhone.includes(a)})),Vn){const n=new Date(Vn);s=s.filter(l=>{const c=new Date(l.createdAt);if(Jn){const[h,u]=Jn.split(":"),g=new Date(n);g.setHours(parseInt(h),parseInt(u),0,0);const j=new Date(g);return j.setHours(j.getHours()+1),c>=g&&c<j}else return c.toDateString()===n.toDateString()})}try{s=[...s].sort((n,l)=>{const c=new Date(n.createdAt||0).getTime();return new Date(l.createdAt||0).getTime()-c})}catch{}return s},[kc,Ao,Vn,Jn]),Ec=async()=>{if(Tt||Ft){r({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"});return}if(!(t!=null&&t.uid)){r({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}try{const s=await _c(),a=t!=null&&t.uid?`tg_daily_report_last_${t.uid}`:"tg_daily_report_last",n=Date.now();let l=!0;try{const c=localStorage.getItem(a);if(c){const h=JSON.parse(c),u=Number((h==null?void 0:h.at)||0);n-u<3e4&&(l=!1)}}catch{}if(l){await Za.send(t.uid,s);try{localStorage.setItem(a,JSON.stringify({at:n}))}catch{}}r({title:"تم الإرسال",description:"تم إرسال التقرير اليومي إلى تليجرام",variant:"default"})}catch{r({title:"فشل الإرسال",description:"تعذّر إرسال التقرير اليومي إلى تليجرام",variant:"destructive"})}},[Wh,yi]=i.useState(!1),[Mc,bi]=i.useState(""),[Bh,vi]=i.useState(!1),[Rl,Ll]=i.useState(""),[Uh,ot]=i.useState(!1),[zh,$l]=i.useState(!1),Rr=async(s,a=2,n=700)=>{let l;for(let c=0;c<=a;c++)try{return await s()}catch(h){if(l=h,c===a)break;await new Promise(u=>setTimeout(u,n*Math.pow(2,c)))}throw l};Ke.reduce((s,a)=>s+(ct[a.id]||0),0);const qh=async s=>await ks.verifyMasterPin(s,t==null?void 0:t.uid),wi=async s=>await ks.verifyMasterPin(s,t==null?void 0:t.uid);i.useEffect(()=>{if(t!=null&&t.uid){try{const s=is(),a=`walletBalances_${t.uid}`,n=localStorage.getItem(s)??localStorage.getItem(a);if(n){const l=JSON.parse(n);ps(l&&typeof l=="object"?l:{});try{localStorage.setItem(s,JSON.stringify(l||{}))}catch{}}}catch{}try{const s=Xt(),a=`cashBalance_${t.uid}`,n=`userCashBalance_${t.uid}`;let l=localStorage.getItem(s)??localStorage.getItem(a)??localStorage.getItem(n);if(l!=null){const c=parseFloat(l);ns(Number.isFinite(c)?c:0);try{localStorage.setItem(s,String(Number.isFinite(c)?c:0)),localStorage.removeItem(a),localStorage.removeItem(n)}catch{}}}catch{}}},[t==null?void 0:t.uid,_,S==null?void 0:S.shopId]),i.useEffect(()=>{const s=a=>{var n;try{const l=Number((n=a==null?void 0:a.detail)==null?void 0:n.value);if(Number.isFinite(l))ns(l);else{const c=localStorage.getItem(Xt());c!=null&&ns(parseFloat(c)||0)}}catch{const l=localStorage.getItem(Xt());l!=null&&ns(parseFloat(l)||0)}};return window.addEventListener("cashBalanceChanged",s),()=>window.removeEventListener("cashBalanceChanged",s)},[t==null?void 0:t.uid,_,S==null?void 0:S.shopId]),i.useEffect(()=>{try{if(!(t!=null&&t.uid))return;const s=_||(S==null?void 0:S.shopId);if(!s)return;const a=ze(q,"dashboardData",s);let n=null;return n=zs(a,l=>{if(!l.exists())return;const c=l.data(),h=Number((c==null?void 0:c.cashBalance)||0),u=c!=null&&c.walletBalances&&typeof c.walletBalances=="object"?c.walletBalances:{};try{const g=c!=null&&c.lastUpdated?new Date(c.lastUpdated).getTime():0,j=localStorage.getItem(Xt()+"_lastUpdated"),p=j?new Date(j).getTime():0;g>=p&&(ns(h),ps(u),localStorage.setItem(Xt(),String(h)),localStorage.setItem(is(),JSON.stringify(u)),c!=null&&c.lastUpdated&&(localStorage.setItem(Xt()+"_lastUpdated",c.lastUpdated),localStorage.setItem(is()+"_lastUpdated",c.lastUpdated)))}catch{}},l=>{console.warn("dashboardData subscription error:",l)}),()=>{try{n&&n()}catch{}}}catch{}},[t==null?void 0:t.uid,_,S==null?void 0:S.shopId]);const Rc=s=>`walletLimits_${(t==null?void 0:t.uid)||"default"}_${s||"none"}`;i.useEffect(()=>{if(!U)return;try{const n=Rc(U),l=localStorage.getItem(n);if(l){const c=JSON.parse(l);fl(c)}}catch{}const s=ze(q,"walletLimits",String(U));let a=null;try{a=zs(s,n=>{if(!n.exists())return;const l=n.data(),c={walletId:U,dailyTransferLimit:l.dailyTransferLimit??6e4,dailyWithdrawLimit:l.dailyWithdrawLimit??1e5,dailyTransferUsed:l.dailyTransferUsed??0,dailyWithdrawUsed:l.dailyWithdrawUsed??0,monthlyTransferLimit:l.monthlyTransferLimit??2e5,monthlyWithdrawLimit:l.monthlyWithdrawLimit??2e5,monthlyTransferUsed:l.monthlyTransferUsed??0,monthlyWithdrawUsed:l.monthlyWithdrawUsed??0};fl(c);try{localStorage.setItem(Rc(U),JSON.stringify(c))}catch{}})}catch{}return()=>{a&&a()}},[U]),i.useEffect(()=>{if(!U)return;const s=Ke.find(a=>a.id===U);if(s!=null&&s.name){lc(String(s.name));try{localStorage.setItem(`walletName_${(t==null?void 0:t.uid)||"default"}_${U}`,String(s.name))}catch{}return}try{const a=localStorage.getItem(`walletName_${(t==null?void 0:t.uid)||"default"}_${U}`);a&&lc(String(a))}catch{}},[U,Ke]);const Fl=async()=>{try{if(!U)return;const s=await ma.autoResetLimitsIfNeeded(U);fl(s)}catch(s){console.error("خطأ في جلب حدود المحفظة المختارة:",s)}};i.useEffect(()=>{Fl()},[U]),i.useEffect(()=>{const s=a=>{var n;(n=a==null?void 0:a.detail)!=null&&n.walletId&&a.detail.walletId===U&&Fl()};return window.addEventListener("walletLimitsUpdated",s),()=>window.removeEventListener("walletLimitsUpdated",s)},[U]),i.useEffect(()=>{const s=a=>{var n;try{const l=String(((n=a==null?void 0:a.detail)==null?void 0:n.walletId)||"");l&&un(l,"sms:auto")}catch{}};return window.addEventListener("walletSelection:update",s),()=>window.removeEventListener("walletSelection:update",s)},[Ke]),i.useEffect(()=>{if(C.state){if(console.log("Location state:",C.state),C.state.openDebtDialog&&(il(),window.history.replaceState({},document.title)),C.state.openSalesDialog&&(Tt||Ft?r({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Zr(!0),window.history.replaceState({},document.title)),C.state.openMaintenanceDialog&&(Tt||Ft?r({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Hn(!0),window.history.replaceState({},document.title)),C.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),Tt||Ft?r({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Yn(!0),window.history.replaceState({},document.title)),C.state.openShopExpensesDialog&&(Tt||Ft?r({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ks.hasMasterPin()?Js(!0):ss(!0),window.history.replaceState({},document.title)),C.state.openDeficienciesDialog&&(Tt||Ft?r({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Aa(!0),window.history.replaceState({},document.title)),C.state.openInstallment&&(Tt||Ft?r({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"}):Kn(!0),window.history.replaceState({},document.title)),C.state.openTransactionSection){const s=document.getElementById("transaction-section");s&&s.scrollIntoView({behavior:"smooth"}),C.state.transactionType&&fo(C.state.transactionType),C.state.startNewTransaction&&(za(""),d(""),Ri(""),Li(""),console.log("🔒 Starting new transaction without changing wallet selection")),C.state.focusWalletSelection&&setTimeout(()=>{const a=document.querySelector('[data-testid="wallet-select"]');a&&a.focus()},500),window.history.replaceState({},document.title)}C.state.openCashierShiftModal&&(!ja||Ft?r({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):me(!0),window.history.replaceState({},document.title)),C.state.openMachineDailyDialog&&(!ja||Ft?r({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):Qn(!0),window.history.replaceState({},document.title))}},[C.state,Ke,Ft]),i.useEffect(()=>{C.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),Wl(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",C.pathname)},[C.pathname,t==null?void 0:t.uid]),i.useEffect(()=>{if(!(t!=null&&t.uid))return;console.log("🔥 Setting up real-time user activation listener for:",t.uid);const s=ze(q,"users",t.uid),a=zs(s,n=>{if(n.exists()){const l=n.data(),c=l.isActive===!0;console.log("🔥 Real-time user status update:",{userId:t.uid,isActive:c,subscription:l.subscription}),c&&!nt?(console.log("🎉 User activated! Redirecting to dashboard..."),kt(!0),Fs(!1),$s(!1)):!c&&nt&&(console.log("❌ User deactivated! Showing activation modal..."),kt(!1),Fs(!0))}},n=>{console.error("❌ Error in real-time user listener:",n)});return()=>{console.log("🔥 Cleaning up real-time user listener"),a()}},[t==null?void 0:t.uid,nt]),i.useEffect(()=>{if(!(t!=null&&t.uid))return;const s=n=>{const{userId:l}=n.detail;l===t.uid&&(console.log("🎉 Subscription activation event received for current user!"),kt(!0),Fs(!1),$s(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},a=n=>{const{userId:l,isActive:c}=n.detail;l===t.uid&&(console.log("🔄 User subscription update event received:",{userId:l,isActive:c}),c&&!nt&&(kt(!0),Fs(!1),$s(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",s),window.addEventListener("userSubscriptionUpdated",a),()=>{window.removeEventListener("subscriptionActivated",s),window.removeEventListener("userSubscriptionUpdated",a)}},[t==null?void 0:t.uid,nt]),i.useEffect(()=>{const s=a=>{var h;const n=a.target,l=(h=n==null?void 0:n.tagName)==null?void 0:h.toLowerCase();if(!(l==="input"||l==="textarea"||l==="select"||((n==null?void 0:n.isContentEditable)??!1))&&!(a.ctrlKey||a.altKey||a.metaKey)&&!a.repeat){if((Tt||Ft)&&a.key>="1"&&a.key<="9"){a.preventDefault();return}switch(a.key){case"1":break;case"2":Ki(!0);break;case"3":Tt||Ft?r({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Yn(!0);break;case"4":ja?me(!0):r({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"5":Tt||Ft?r({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Zr(!0);break;case"6":il();break;case"7":Tt||Ft?r({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Hn(!0);break;case"8":ja?Qn(!0):r({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"9":Tt||Ft?r({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ks.hasMasterPin()?Js(!0):ss(!0);break}}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[Tt,Ft,ja]),i.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:t==null?void 0:t.uid,isCheckingActivation:Qt}),(async()=>{try{if(!(t!=null&&t.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),$s(!1);return}try{const h=await Sa(ze(q,"users",t.uid));if(h.exists()){const g=h.data().isActive===!0,j=await Xu.checkTrialValidity(t.uid),p=j.isValid&&!j.isExpired;kt(g||p),Ba(p),Qr(j.hoursRemaining),dt(j.hasUsedTrial),Fs(!g&&!p),console.log("📊 حالة المستخدم:",{isActive:g,isOnTrial:p,hoursRemaining:j.hoursRemaining,hasUsedTrial:j.hasUsedTrial})}else kt(!1),Fs(!0)}catch(h){console.error("خطأ في فحص حالة تفعيل المستخدم:",h),kt(!1),Fs(!0)}finally{$s(!1)}if(console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:t==null?void 0:t.uid}),t!=null&&t.uid){const h=await Rr(()=>Ce.getUserData(t.uid)),u=`userData_${t==null?void 0:t.uid}`;let g=null;try{const j=localStorage.getItem(u);j&&(g=JSON.parse(j))}catch{}if(h){let j=(h==null?void 0:h.walletBalances)||{},p=h==null?void 0:h.cashBalance;if(g){const v=g.lastUpdated?new Date(g.lastUpdated).getTime():0,I=h.lastUpdated?new Date(h.lastUpdated).getTime():0;v>=I&&(g.walletBalances&&(j=g.walletBalances),g.cashBalance!==void 0&&(p=g.cashBalance))}ps(j),p!==void 0&&ns(p);try{const v=t!=null&&t.uid?await Rr(()=>jn.getDeletedTransactionsByUser(t.uid)):[];Ir(v||[])}catch{Ir([])}}else{ps({});try{const j=t!=null&&t.uid?await jn.getDeletedTransactionsByUser(t.uid):[];Ir(j||[])}catch{Ir([])}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const h=await Rr(()=>ba.getByMerchantId((t==null?void 0:t.uid)||""));if(h&&h.length>0){console.log("✅ تم العثور على محافظ في Firebase:",h.length);const g=h.filter(v=>v.isActive===!0).map(v=>({id:v.id,name:v.label||"محفظة بدون اسم",phone:v.msisdn,isDefault:!1,monthlyWithdrawalLimit:v.monthlyWithdrawalLimit??v.withdrawLimit??2e5,monthlyTransferLimit:v.monthlyTransferLimit??v.transferLimit??2e5,defaultTransferCommission:v.defaultTransferCommission!=null?Number(v.defaultTransferCommission):null,defaultWithdrawCommission:v.defaultWithdrawCommission!=null?Number(v.defaultWithdrawCommission):null}));Cr(g);const j=localStorage.getItem(Mr());let p=null;j&&g.find(v=>v.id===j)?p=g.find(v=>v.id===j):p=g[0],p&&(Rt(p.id),Ua(p.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else console.log("⚠️ لا توجد محافظ في Firebase. سيتم عرض قائمة فارغة بدون أي استرجاع محلي."),Cr([])}catch(h){console.error("خطأ في تحميل المحافظ من Firebase:",h),Cr([])}const c=t!=null&&t.uid?await Rr(()=>Ce.getUserTransactions(t.uid)):[];if(c&&c.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",c.length);const h=c.map(v=>({...v,createdAt:new Date(v.createdAt),senderPhone:v.senderMsisdn||v.senderPhone||"",receiverPhone:v.receiverMsisdn||v.receiverPhone||"",type:v.txnType==="send"?"send":v.txnType==="receive"?"withdraw":v.type||"withdraw",status:v.status==="confirmed"?"completed":v.status||"completed"})),u=en.map(v=>v.id||v.originalTransactionId);let g=[];try{const v=Ye(je(q,"deletedTransactions"),he("userId","==",(t==null?void 0:t.uid)||""),he("permanent","==",!0));g=(await et(v)).docs.map(T=>{const A=T.data();return String(A.originalTransactionId||A.transactionId||T.id||"")}).filter(Boolean)}catch{}const j=new Set(g),p=h.filter(v=>{var $;const I=String(v.id||""),T=String(v.transactionId||""),A=String(v.reference||v.transactionReference||(($=v.receipt)==null?void 0:$.reference)||""),J=u.includes(I),Ue=j.has(I)||T&&j.has(T);return!J&&!Ue});console.log("✅ تم فلترة المعاملات المحذوفة:",{total:c.length,deleted:u.length,active:p.length});{const v=new Set,I=[];for(const T of p){const A=wc(T);v.has(A)||(v.add(A),I.push(T))}jo||Na(I)}}await Tc()}catch(c){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",c)}})().then(async()=>{await l(),await a(),await n()});const a=async()=>{try{if(!(t!=null&&t.uid))return;const c=await ba.getByMerchantId(t.uid);await Promise.all(c.map(h=>Jx.autoResetLimitsIfNeeded(h.id)))}catch(c){console.error("خطأ في التصفير التلقائي للحدود:",c)}},n=async()=>{try{await Ls.syncReportsDataFromFirebase(t==null?void 0:t.uid);const c=Ls.getReportsData(t==null?void 0:t.uid);if((c.lastDailyResetDate?Ls.shouldResetDailyReports(c.lastDailyResetDate):!1)&&(t!=null&&t.uid)&&c.lastDailyResetDate){const g=new Date(c.lastDailyResetDate),j=g.toDateString(),p=Ze.filter($=>new Date($.createdAt).toDateString()===j&&$.status==="completed"),v=p.length,I=p.reduce(($,K)=>$+K.amount,0),T=p.filter(xn).reduce(($,K)=>{const oe=K.withdrawnAmount!==void 0?K.withdrawnAmount:K.amount;return $+oe},0),A=p.filter(pn).reduce(($,K)=>{const oe=K.sentAmount!==void 0?K.sentAmount:K.amount;return $+oe},0),J=p.reduce(($,K)=>$+Ls.calculateTransactionProfit(K),0),Ue=new Date(g).toISOString().slice(0,10);await vn.add({userId:t.uid,reportDate:Ue,totalTransactions:v,totalAmount:Number(I.toFixed(2)),totalWithdrawn:Number(T.toFixed(2)),totalSent:Number(A.toFixed(2)),profit:Number(J.toFixed(2)),walletId:null})}const u=Ls.autoResetReportsIfNeeded(t==null?void 0:t.uid);(u.dailyReset||u.monthlyReset)&&console.log("تم التصفير التلقائي:",u)}catch(c){console.error("خطأ في التصفير التلقائي للتقارير:",c)}},l=async()=>{try{if(!(t!=null&&t.uid))return;const c=new Date;if(c.getDate()!==1)return;const h=`${c.getFullYear()}-${c.getMonth()+1}`,u=`lastMonthlyDbCleanup:${t.uid}`;if(localStorage.getItem(u)===h)return;const j=new Date(c.getFullYear(),c.getMonth(),1,0,0,0,0),p=T=>T instanceof Date?T:typeof(T==null?void 0:T.toDate)=="function"?T.toDate():new Date(String(T));let v=[];try{const T=Ye(je(q,"userTransactions"),he("userId","==",t.uid),he("createdAt","<",j));v=(await et(T)).docs}catch{const T=Ye(je(q,"userTransactions"),he("userId","==",t.uid));v=(await et(T)).docs.filter(J=>{var Ue;return p((Ue=J.data())==null?void 0:Ue.createdAt)<j})}await Promise.allSettled(v.map(T=>qs(T.ref)));let I=[];try{const T=Ye(je(q,"transactions"),he("userId","==",t.uid),he("createdAt","<",j));I=(await et(T)).docs}catch{const T=Ye(je(q,"transactions"),he("userId","==",t.uid));I=(await et(T)).docs.filter(J=>{var Ue;return p((Ue=J.data())==null?void 0:Ue.createdAt)<j})}await Promise.allSettled(I.map(T=>qs(T.ref)));try{localStorage.setItem(u,h)}catch{}console.log("✅ تم تنظيف قاعدة البيانات شهريًا (Firebase فقط):",{userTransactionsDeleted:v.length,globalTransactionsDeleted:I.length,monthStart:j})}catch(c){console.error("فشل التنظيف الشهري التلقائي لقاعدة البيانات:",c)}};hh(),oc(),Ch(),console.log("🔥 useEffect loadUserData completed")},[t==null?void 0:t.uid]);const Wl=async()=>{var s;if(t!=null&&t.uid)try{const a=await Rr(()=>ba.getByMerchantId(t.uid));if(a&&a.length>0){const l=a.filter(c=>c.isActive===!0).map(c=>({id:c.id,name:c.label||"محفظة بدون اسم",phone:c.msisdn,isDefault:!1,monthlyWithdrawalLimit:c.monthlyWithdrawalLimit??c.withdrawLimit??2e5,monthlyTransferLimit:c.monthlyTransferLimit??c.transferLimit??2e5,defaultTransferCommission:c.defaultTransferCommission!=null?Number(c.defaultTransferCommission):void 0,defaultWithdrawCommission:c.defaultWithdrawCommission!=null?Number(c.defaultWithdrawCommission):void 0}));if(Cr(l),t!=null&&t.uid){const c=localStorage.getItem(Mr());if(!!(U&&l.find(u=>u.id===U)))console.log("🔒 Preserving current wallet selection:",U);else{const g=(c&&l.find(j=>j.id===c)?c:null)||((s=l[0])==null?void 0:s.id);g&&(console.log("🔄 Fixing invalid wallet selection:",g),un(g))}}console.log("🔄 تم تحديث المحافظ من Firebase:",l.length)}}catch(a){console.error("خطأ في تحميل المحافظ من Firebase:",a)}};i.useEffect(()=>{const s=C.pathname;if(sessionStorage.getItem("previousPath")==="/user/add-wallet"&&s==="/user/dashboard"){E.invalidateQueries({queryKey:["wallets",t==null?void 0:t.uid]});try{zn.refetch()}catch{}sessionStorage.removeItem("previousPath")}sessionStorage.setItem("previousPath",s)},[C.pathname,t==null?void 0:t.uid]),i.useEffect(()=>{const s=()=>{E.invalidateQueries({queryKey:["wallets",t==null?void 0:t.uid]});try{zn.refetch()}catch{}};return window.addEventListener("focus",s),()=>{window.removeEventListener("focus",s)}},[t==null?void 0:t.uid,U,Ke]);const un=async(s,a="unknown")=>{console.log(`🎯 setWalletSelection called from ${a} with walletId:`,s),console.log("🔍 Previous selectedWallet:",U),Rt(s);const n=Ke.find(l=>l.id===s);if(n&&(Ua(n.phone),console.log("✅ Wallet set successfully:",s,"Phone:",n.phone)),t!=null&&t.uid){localStorage.setItem(Mr(),s),console.log("💾 Saved wallet to localStorage:",s);try{await wn.set({key:"selected_wallet_id",value:s}),await wn.set({key:"current_user_id",value:t.uid}),console.log("📱 Saved wallet and user ID to Capacitor Preferences:",s,t.uid)}catch(l){console.error("❌ Failed to save to Capacitor Preferences:",l)}}};i.useEffect(()=>{const s=()=>{Wl()};try{window.addEventListener("wallets:activation-updated",s)}catch{}return()=>{try{window.removeEventListener("wallets:activation-updated",s)}catch{}}},[t==null?void 0:t.uid]);const Vh=s=>{if(s==="__add_wallet"){L("/user/add-wallet");return}if(s==="__view_wallets"){Sr(!0);return}tx.isEnabled(t==null?void 0:t.uid)?(Gr(s),Dr(!0)):un(s,"walletSelectionNoPin")},Ni=s=>{console.log("🔄 handleTransactionTypeChange called with type:",s),console.log("🔍 Current selectedWallet before change:",U),console.log("🔍 Available wallets count:",Ke.length),fo(s),za(""),d(""),Ri(""),Li(""),console.log("✅ Transaction type changed to:",s,"- Wallet selection preserved:",U),setTimeout(()=>{const a=document.getElementById("transaction-section");a&&a.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)};i.useEffect(()=>{const s=a=>{const n=a.target;if(!!n&&(n.tagName==="INPUT"||n.tagName==="TEXTAREA"||n.tagName==="SELECT"||n.isContentEditable)||(a.key==="ArrowLeft"?(a.preventDefault(),Ni("withdraw")):a.key==="ArrowRight"&&(a.preventDefault(),Ni("transfer"))),a.key==="Enter"){const c=ce==="transfer"?"transferSubmitButton":"withdrawSubmitButton",h=document.getElementById(c);h&&!h.disabled&&(a.preventDefault(),h.click())}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[ce]);const Lc=s=>{Nm((n=>({id:n.id,type:n.type==="send"?"transfer":"withdraw",sender_msisdn:n.senderPhone,receiver_msisdn:n.receiverPhone,amount:n.amount,commission:n.commission||0,fee:(n==null?void 0:n.fee)??0,status:n.status==="failed"?"failed":n.status==="completed"?"completed":"pending",createdAt:new Date(n.createdAt).toISOString(),updatedAt:new Date(n.createdAt).toISOString(),shopName:Q??(S==null?void 0:S.shopName)??(t==null?void 0:t.displayName)??"المحل",cashierName:(n==null?void 0:n.cashierName)??null,commissionMode:(n==null?void 0:n.commissionMode)??(n.type==="send"||At?"add":"deduct"),totalCharged:(n==null?void 0:n.totalCharged)??(n.type==="send"?Number(n.amount||0)+Number(n.commission||0)+Number((n==null?void 0:n.fee)||0):At?Number(n.amount||0)+Number(n.commission||0):Number(n.amount||0)),note:(n==null?void 0:n.note)??(n==null?void 0:n.notes)??void 0,senderName:(n==null?void 0:n.senderName)??void 0,provider:(n==null?void 0:n.provider)??void 0,title:(()=>{const l=String((n==null?void 0:n.provider)||"").toLowerCase(),c=l.includes("vodafone")?"vf-cash":l.includes("instapay")?"instapay":"",h=n.type==="send"?"تحويل":"سحب";return n.type==="withdraw"&&c?`${h} ${c}`:h})()}))(s)),qn(!0)},Jh=async s=>{var c;if(!(t!=null&&t.uid)){r({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const a=Ze.find(h=>h.id===s);if(!a){r({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}const n=String(s),l=String((a==null?void 0:a.transactionId)||(a==null?void 0:a.reference)||"");qa.current.add(n),l&&qa.current.add(l);try{console.log("🗑️ بدء عملية حذف المعاملة:",s),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:a.id,userId:t.uid,transactionData:a}),await Ce.removeUserTransaction(t.uid,a.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await jn.saveDeletedTransaction({...a,userId:t.uid,originalTransactionId:a.id,transactionId:a.transactionId||a.id,reference:a.reference||a.transactionReference||((c=a.receipt)==null?void 0:c.reference),deletedAt:new Date().toISOString(),permanent:!0}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(g){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",g)}try{await jn.permanentlyDeleteTransaction(a.id,t.uid)}catch(g){console.warn("⚠️ فشل وسم الحذف النهائي أو التنظيف الإضافي:",g)}const h=[...en,a],u=Ze.filter(g=>g.id!==s);Ir(h),Na(u),wo(!1),console.log("✅ تم تحديث الحالة بعد الحذف من Firebase (بدون نسخ محلية)");try{const g=a.fromWallet;if(g){const{walletDailyLimitsService:j}=await wt(async()=>{const{walletDailyLimitsService:v}=await import("./index-DA5EGBVC.js").then(I=>I.ca);return{walletDailyLimitsService:v}},__vite__mapDeps([0,1]),import.meta.url),p=await j.getWalletLimits(g);if(p){const v=a.type==="send",I={updatedAt:(await wt(async()=>{const{serverTimestamp:$}=await import("./index-DA5EGBVC.js").then(K=>K.c4);return{serverTimestamp:$}},__vite__mapDeps([0,1]),import.meta.url)).serverTimestamp()};v?(I.dailyTransferUsed=Math.max(0,(p.dailyTransferUsed||0)-a.amount),I.monthlyTransferUsed=Math.max(0,(p.monthlyTransferUsed||0)-a.amount)):(I.dailyWithdrawUsed=Math.max(0,(p.dailyWithdrawUsed||0)-a.amount),I.monthlyWithdrawUsed=Math.max(0,(p.monthlyWithdrawUsed||0)-a.amount));const{doc:T,setDoc:A}=await wt(async()=>{const{doc:$,setDoc:K}=await import("./index-DA5EGBVC.js").then(oe=>oe.c4);return{doc:$,setDoc:K}},__vite__mapDeps([0,1]),import.meta.url),{db:J}=await wt(async()=>{const{db:$}=await import("./index-DA5EGBVC.js").then(K=>K.c5);return{db:$}},__vite__mapDeps([0,1]),import.meta.url),Ue=T(J,"walletLimits",g);await A(Ue,I,{merge:!0})}}}catch(g){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",g)}try{const{ProfitService:g}=await wt(async()=>{const{ProfitService:T}=await import("./profitService-CQSlHJ0c.js");return{ProfitService:T}},__vite__mapDeps([3,0,1]),import.meta.url),{ReportsService:j}=await wt(async()=>{const{ReportsService:T}=await import("./index-DA5EGBVC.js").then(A=>A.c9);return{ReportsService:T}},__vite__mapDeps([0,1]),import.meta.url),v={txnType:a.type==="send"?"send":"receive",amount:a.amount,commission:a.commission||0,createdAt:a.createdAt,status:"confirmed"},I=g.calculateProfitFromTransaction(v);I>0&&g.addProfit(-I,t.uid);try{j.removeTransactionEffects(a,t.uid)}catch{}}catch(g){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",g)}r({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(h){console.error("❌ خطأ في حذف المعاملة من Firebase:",h);let u="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";h instanceof Error&&(h.message.includes("network")||h.message.includes("offline")?u="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":h.message.includes("permission")||h.message.includes("unauthorized")?u="ليس لديك صلاحية لحذف هذه المعاملة":h.message.includes("not-found")&&(u="المعاملة غير موجودة أو تم حذفها مسبقاً")),r({title:"خطأ في الحذف",description:u,variant:"destructive"})}},xn=s=>{const a=s.type,n=s.txnType;return a==="withdraw"||a==="withdrawal"||a==="receive"||n==="receive"},pn=s=>{const a=s.type,n=s.txnType;return a==="send"||a==="transfer"||n==="send"},gn=(s,a)=>{const n=new Date().toDateString();let l=Ze.filter(p=>{const v=new Date(p.createdAt).toDateString()===n,I=String(p.status||"").toLowerCase();return v&&(I==="completed"||I==="confirmed"||I==="pending")});_a&&_a.trim()!==""&&(l=l.filter(p=>p.senderPhone&&p.senderPhone.includes(_a)||p.receiverPhone&&p.receiverPhone.includes(_a)));const c=Ls.filterVisibleTransactions(l,"daily",t==null?void 0:t.uid),h=c.length,u=c.reduce((p,v)=>p+v.amount,0),g=c.filter(xn).reduce((p,v)=>{const I=v.withdrawnAmount!==void 0?v.withdrawnAmount:v.amount;return p+I},0),j=c.filter(pn).reduce((p,v)=>{const I=v.sentAmount!==void 0?v.sentAmount:v.amount;return p+I},0);return{totalTransactions:h,totalAmount:u,totalWithdrawn:g,totalSent:j}},fn=s=>{const a=new Date().getMonth(),n=new Date().getFullYear();let l=Ze.filter(p=>{const v=new Date(p.createdAt);return v.getMonth()===a&&v.getFullYear()===n&&p.status==="completed"});_a&&_a.trim()!==""&&(l=l.filter(p=>p.senderPhone&&p.senderPhone.includes(_a)||p.receiverPhone&&p.receiverPhone.includes(_a)));const c=Ls.filterVisibleTransactions(l,"monthly",t==null?void 0:t.uid),h=c.length,u=c.reduce((p,v)=>p+v.amount,0),g=c.filter(xn).reduce((p,v)=>{const I=v.withdrawnAmount!==void 0?v.withdrawnAmount:v.amount;return p+I},0),j=c.filter(pn).reduce((p,v)=>{const I=v.sentAmount!==void 0?v.sentAmount:v.amount;return p+I},0);return{totalTransactions:h,totalAmount:u,totalWithdrawn:g,totalSent:j}},Kh=s=>{const a=new Date().getMonth(),n=new Date().getFullYear(),l=Ze.filter(u=>{const g=new Date(u.createdAt);return g.getMonth()===a&&g.getFullYear()===n&&u.status==="completed"&&u.fromWallet===s}),c=l.filter(xn).reduce((u,g)=>{const j=g.withdrawnAmount||g.amount;return u+j},0),h=l.filter(pn).reduce((u,g)=>{const j=g.sentAmount||g.amount;return u+j},0);return{totalWithdrawn:c,totalTransferred:h}},Yh=s=>{const a=new Date,n=a.getDate(),l=a.getMonth(),c=a.getFullYear(),h=Ze.filter(j=>{const p=new Date(j.createdAt);return p.getDate()===n&&p.getMonth()===l&&p.getFullYear()===c&&j.status==="completed"&&j.fromWallet===s}),u=h.filter(xn).reduce((j,p)=>{const v=p.withdrawnAmount||p.amount;return j+v},0),g=h.filter(pn).reduce((j,p)=>{const v=p.sentAmount||p.amount;return j+v},0);return{totalWithdrawn:u,totalTransferred:g}},$c=He.useMemo(()=>fn(),[Ze,U,_a]);$c.totalWithdrawn,$c.totalSent;const Oa=He.useMemo(()=>Kh(U),[Ze,U]);i.useEffect(()=>{try{if(!U||Ke.length===0)return;const s=Ke.find(A=>A.id===U);if(!s)return;const a=(lt==null?void 0:lt.monthlyWithdrawLimit)??(s==null?void 0:s.monthlyWithdrawalLimit)??2e5,n=(lt==null?void 0:lt.monthlyTransferLimit)??(s==null?void 0:s.monthlyTransferLimit)??2e5,l=parseFloat(cs||"0")||0,c=(Oa==null?void 0:Oa.totalWithdrawn)??(lt==null?void 0:lt.monthlyWithdrawUsed)??0,h=(Oa==null?void 0:Oa.totalTransferred)??(lt==null?void 0:lt.monthlyTransferUsed)??0,u=c+(ce==="withdraw"?l:0),g=h+(ce==="transfer"?l:0),j=.85,p=Math.floor(Math.max(a,1)*j),v=Math.floor(Math.max(n,1)*j),I=(()=>{const A=new Date;return`${A.getFullYear()}-${String(A.getMonth()+1).padStart(2,"0")}`})(),T=`monthlyLimitWarnShown:${U}:${I}`;if(u>=p){const A=`${T}:withdraw`;if(!(localStorage.getItem(A)==="true")){go({type:"withdraw",used:u,limit:a,walletName:s.name}),po(!0);try{localStorage.setItem(A,"true")}catch{}return}}if(g>=v){const A=`${T}:transfer`;if(!(localStorage.getItem(A)==="true")){go({type:"transfer",used:g,limit:n,walletName:s.name}),po(!0);try{localStorage.setItem(A,"true")}catch{}return}}}catch{}},[U,Ke,lt,Oa,ce,cs]);const Fc=async()=>{var ca,Gs,da,yn;Dp(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:Ys,receiverPhone:Ss,amount:cs,transactionType:ce});const s=()=>{ce==="transfer"?Ar(!0):tn(!0)},a=()=>{ce==="transfer"?Ar(!1):tn(!1)};if(s(),!Ys||!cs){console.log("❌ خطأ: بيانات ناقصة"),r({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),a();return}if(ce==="transfer"&&!Ss&&!R){console.log("❌ خطأ: رقم المستقبل مفقود"),r({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),a();return}if(ce==="transfer"&&!R&&(String(Ss||"").replace(/[^0-9٠-٩]/g,""),!/[^0-9٠-٩\s]/.test(String(Ss||""))&&!Cp(Ss))){r({title:"رقم المستقبل غير صالح",description:"اكتب رقم صحيح مكون من 11 رقم ويبدأ بـ 015 أو 010 أو 012 أو 011",variant:"destructive"}),a();return}const n=parseFloat(cs);if(console.log("💰 المبلغ المحول:",n),n<=0){console.log("❌ خطأ: مبلغ غير صحيح"),r({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),a();return}if(Tt)try{const De=new Date,at=De.getFullYear(),rt=String(De.getMonth()+1).padStart(2,"0"),Et=String(De.getDate()).padStart(2,"0"),Zs=`zeroPlanDailyConfirmCount:${(t==null?void 0:t.uid)||"default"}:${at}-${rt}-${Et}`,Bs=localStorage.getItem(Zs);if((Bs&&parseInt(Bs,10)||0)>=10){r({title:"حد التأكيد اليومي",description:"باقة زيرو تسمح بـ 10 تأكيدات تحويل/سحب يومياً فقط.",variant:"destructive"}),a();return}}catch(De){console.warn("فشل قراءة عداد تأكيدات باقة زيرو من التخزين المحلي:",De)}const l=Ke.find(De=>De.id===U);if(!l){r({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),a();return}const c=Oa;if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:U,walletName:l.name,currentWithdrawn:c.totalWithdrawn,currentTransferred:c.totalTransferred,withdrawalLimit:l.monthlyWithdrawalLimit,transferLimit:l.monthlyTransferLimit}),ce==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${c.totalWithdrawn}, المبلغ الجديد: ${n}, الحد الأقصى: ${l.monthlyWithdrawalLimit}`),c.totalWithdrawn+n>l.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),r({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${l.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${c.totalTransferred}, المبلغ الجديد: ${n}, الحد الأقصى: ${l.monthlyTransferLimit}`),c.totalTransferred+n>l.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),r({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${l.monthlyTransferLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}const h=(S==null?void 0:S.shopName)||(t==null?void 0:t.displayName)||"محل كاشي لينك",u={id:Date.now().toString(),type:ce==="transfer"?"send":ce==="deposit"?"deposit":"withdraw",senderPhone:Ys,receiverPhone:ce==="transfer"?Ss:Ys,amount:n,status:"completed",createdAt:new Date,withdrawnAmount:ce==="withdraw"?n:void 0,sentAmount:ce==="transfer"?n:void 0,depositedAmount:void 0,fromWallet:U,senderNumber:Ys,senderName:ce==="withdraw"&&ee.trim()!==""?ee.trim():void 0,shopName:(l==null?void 0:l.name)||"المحفظة الرئيسية",transferredAmount:ce==="transfer"?n:void 0,receiverNumber:ce==="transfer"?Ss:void 0,withdrawnAmountDetailed:ce==="withdraw"?n:void 0,depositedAmountDetailed:void 0,merchantShopName:h,transactionReference:`TXN-${Date.now()}`,commission:0,notes:ce==="transfer"?void 0:P&&P.trim()!==""?P.trim():void 0};y&&(w!=null&&w.name||w!=null&&w.username)&&(u.cashierName=(w==null?void 0:w.name)||(w==null?void 0:w.username));const g=Ur.validateTransaction(n,ce,Mt,ct);if(!g.isValid){r({title:"خطأ في العملية",description:g.error,variant:"destructive"}),a();return}g.warning&&r({title:"تحذير",description:g.warning,variant:"destructive"});let j;if(ce==="transfer")if((l==null?void 0:l.defaultTransferCommission)!=null){const De=Number(l.defaultTransferCommission)||0;j=Math.round(De*n/1e3*100)/100}else Is&&Is.trim()!==""?j=Math.max(0,parseFloat(Is)):j=0;else if((l==null?void 0:l.defaultWithdrawCommission)!=null){const De=Number(l.defaultWithdrawCommission)||0;j=Math.round(De*n/1e3*100)/100}else Cs&&Cs.trim()!==""?j=Math.max(0,parseFloat(Cs)):j=Math.round(n*.01*100)/100;if(u.commission=j,ce!=="transfer"&&!At&&j>=n){r({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),a();return}const p=ce==="transfer"||At?n:Math.round((n-j)*100)/100;u.amount=p,u.withdrawnAmount=ce==="withdraw"?p:void 0,u.sentAmount=ce==="transfer"?p:void 0,u.transferredAmount=ce==="transfer"?p:void 0,u.withdrawnAmountDetailed=ce==="withdraw"?p:void 0;let v;const I=ce==="transfer"&&!!Ds,T=ce==="withdraw"&&!!Ds,A=I||T;let J=null;const Ue=Bn(Ys||"").replace(/\D/g,""),$=Bn(Ss||"").replace(/\D/g,""),K=ce==="transfer"&&(Ue.startsWith("010")&&($.startsWith("011")||$.startsWith("012")||$.startsWith("015"))||Ue.startsWith("012")&&$.startsWith("010")||Ue.startsWith("011")&&$.startsWith("010")||Ue.startsWith("015")&&$.startsWith("010")),oe=Math.max(0,parseFloat(xo||"0")),st=Math.round(j*100)/100;if(u.commission=st,u.fee=oe,u.totalCharged=ce==="transfer"?Number(p)+Number(st)+Number(oe):At?Number(p)+Number(st):Number(p),K&&!A&&oe<=0){r({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"}),a();return}if(ce==="transfer"&&!A){const De=Number(ct[U]||0),at=Number(p)+Number(oe);if(De<at){r({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${De} لا يكفي لخصم ${at}`,variant:"destructive"}),a();return}}if(A)if(I){const De=Ur.validateTransaction(p,"transfer",Mt,ct);if(!De.isValid)v={success:!1,newCashBalance:Mt,newWalletBalances:ct,message:De.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"};else{const at=U||((ca=Ke.find(ut=>ut.isDefault))==null?void 0:ca.id)||((Gs=Ke[0])==null?void 0:Gs.id),rt=lt??await ma.getWalletLimits(at),Et=new Date().toDateString(),Zs=Ze.filter(ut=>ut.type==="send"&&String(ut.status||"").toLowerCase()==="pending"&&ut.fromWallet===at&&new Date(ut.createdAt).toDateString()===Et).reduce((ut,Rs)=>ut+Number(Rs.sentAmount??Rs.transferredAmount??Rs.amount??0),0),Bs=Number((rt==null?void 0:rt.dailyTransferLimit)??6e4),na=Number((rt==null?void 0:rt.dailyTransferUsed)??0);if(na+Zs+Number(p)>Bs){r({title:"تجاوز الحد اليومي للتحويل",description:`المتبقي اليوم: ${(Bs-na-Zs).toLocaleString()} ج.م`,variant:"destructive"}),a();return}const ga=new Date,Ha=Ze.filter(ut=>ut.type==="send"&&String(ut.status||"").toLowerCase()==="pending"&&ut.fromWallet===at&&new Date(ut.createdAt).getMonth()===ga.getMonth()&&new Date(ut.createdAt).getFullYear()===ga.getFullYear()).reduce((ut,Rs)=>ut+Number(Rs.sentAmount??Rs.transferredAmount??Rs.amount??0),0),Ea=Number((rt==null?void 0:rt.monthlyTransferLimit)??2e5),Lr=Number((rt==null?void 0:rt.monthlyTransferUsed)??0);if(Lr+Ha+Number(p)>Ea){r({title:"تجاوز الحد الشهري للتحويل",description:`المتبقي هذا الشهر: ${(Ea-Lr-Ha).toLocaleString()} ج.م`,variant:"destructive"}),a();return}v={success:!0,newCashBalance:Mt,newWalletBalances:ct}}}else{const De=U||((da=Ke.find(ut=>ut.isDefault))==null?void 0:da.id)||((yn=Ke[0])==null?void 0:yn.id),at=lt??await ma.getWalletLimits(De),rt=new Date().toDateString(),Et=Ze.filter(ut=>ut.type==="withdraw"&&String(ut.status||"").toLowerCase()==="pending"&&ut.fromWallet===De&&new Date(ut.createdAt).toDateString()===rt).reduce((ut,Rs)=>ut+Number(Rs.withdrawnAmount??Rs.amount??0),0),Zs=Number((at==null?void 0:at.dailyWithdrawLimit)??1e5),Bs=Number((at==null?void 0:at.dailyWithdrawUsed)??0);if(Bs+Et+Number(p)>Zs){r({title:"تجاوز الحد اليومي للسحب",description:`المتبقي اليوم: ${(Zs-Bs-Et).toLocaleString()} ج.م`,variant:"destructive"}),a();return}const na=new Date,ga=Ze.filter(ut=>ut.type==="withdraw"&&String(ut.status||"").toLowerCase()==="pending"&&ut.fromWallet===De&&new Date(ut.createdAt).getMonth()===na.getMonth()&&new Date(ut.createdAt).getFullYear()===na.getFullYear()).reduce((ut,Rs)=>ut+Number(Rs.withdrawnAmount??Rs.amount??0),0),Ha=Number((at==null?void 0:at.monthlyWithdrawLimit)??2e5),Ea=Number((at==null?void 0:at.monthlyWithdrawUsed)??0);if(Ea+ga+Number(p)>Ha){r({title:"تجاوز الحد الشهري للسحب",description:`المتبقي هذا الشهر: ${(Ha-Ea-ga).toLocaleString()} ج.م`,variant:"destructive"}),a();return}v={success:!0,newCashBalance:Math.round((Number(Mt)-Number(p))*100)/100,newWalletBalances:ct}}else ce==="transfer"?v=await Ur.processTransfer({amount:p,currentCashBalance:Mt,currentWalletBalances:ct,wallets:Ke,selectedWalletId:U,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0}):v=await Ur.processWithdraw({amount:p,currentCashBalance:Mt,currentWalletBalances:ct,wallets:Ke,selectedWalletId:U,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0});if(!v.success){r({title:"فشل في العملية",description:v.error||v.message,variant:"destructive"}),a();return}let Wt=A?T?v.newCashBalance:Mt:v.newCashBalance,Vt=A?ct:v.newWalletBalances;if(!A&&ce==="transfer"&&oe>0){const De=Number(Vt[U]||0);Vt={...Vt,[U]:Math.round((De-Number(oe))*100)/100}}if(A&&I){const De=Ke.find(Et=>Et.id===U)??Ke.find(Et=>Et.isDefault)??Ke[0],at=(De==null?void 0:De.id)||U;if(at!==U)try{un(at)}catch{}const rt=Number(ct[at]||0);Vt={...ct,[at]:Math.round((rt-Number(p)-Number(oe))*100)/100}}if((I||T)&&Ds&&!Es){const De={id:`DEBT-${Date.now()}`,debtorName:Ds.debtorName,amount:Ds.amount,reason:Ds.notes||"",customerId:Ds.customerId,mobile:Ds.mobile,status:"pending",createdAt:new Date};J=De.id,u.linkedDebtId=J;const at=[De,...Dt];As(at);try{await oa(at)}catch(rt){console.error("⚠️ فشل حفظ الدين المؤجل محلياً:",rt)}r({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}if(!A){const De=Math.max(0,Number(j))+Math.max(0,Number(oe));De>0&&(Wt=Math.round((Wt+De)*100)/100,console.log(`💰 تم إضافة عمولة/رسوم ${De} جنيه لدرج النقدية`))}console.log("⚡ تحديث الواجهة فوراً بدون حجب باستخدام startTransition...");const Ws=[u,...Ze];He.startTransition(()=>{ns(Wt),ps(Vt),A&&(u.status="pending"),Na(Ws)});try{setTimeout(()=>{try{localStorage.setItem(Pl(),JSON.stringify(Ws))}catch{}},0)}catch{}if(Tt)try{const De=new Date,at=De.getFullYear(),rt=String(De.getMonth()+1).padStart(2,"0"),Et=String(De.getDate()).padStart(2,"0"),Zs=`zeroPlanDailyConfirmCount:${(t==null?void 0:t.uid)||"default"}:${at}-${rt}-${Et}`,Bs=localStorage.getItem(Zs),na=Bs&&parseInt(Bs,10)||0;localStorage.setItem(Zs,String(na+1))}catch{}setTimeout(()=>{try{const De=new Date().toISOString();localStorage.setItem(Xt(),Wt.toString()),localStorage.setItem(Xt()+"_lastUpdated",De),localStorage.setItem(is(),JSON.stringify(Vt)),localStorage.setItem(is()+"_lastUpdated",De)}catch{}},0);try{if(t!=null&&t.uid){const De=Ke.find($r=>$r.id===U)??Ke.find($r=>$r.isDefault)??Ke[0],at=(De==null?void 0:De.id)||U,rt=Number(Vt[at]||0),Et=String((De==null?void 0:De.phone)||Ys||"").trim(),Zs=String(Ss||"").trim(),Bs=Number(oe)>0,na=ce==="transfer"?"🟢":"🔴",ga=Number(st)>0?`${Number(st)} جنيه`:"0 جنيه",Ha=Bs?` و رسوم ${Number(oe)} جنيه`:"",Ea=ce==="transfer"?`${na} تم تحويل مبلغ ${Number(p)} جنيه من رقم المحفظة ${Et} إلى رقم المحفظة ${Zs} وتم أخذ عمولة ${ga}${Ha}. الرصيد المتبقي في المحفظة: ${rt} جنيه. الفلوس النقدية المتبقية: ${Number(Wt)} جنيه.`:`${na} تم السحب مبلغ ${Number(p)} جنيه من الدرج إلى رقم المحفظة ${Et} وتم أخذ عمولة ${ga}${Ha}. الرصيد المتبقي في المحفظة: ${rt} جنيه. الفلوس النقدية المتبقية: ${Number(Wt)} جنيه.`,Lr=t!=null&&t.uid?`tg_last_msg_${t.uid}`:"tg_last_msg",ut=Date.now();let Rs=!0;try{const $r=localStorage.getItem(Lr);if($r){const Fr=JSON.parse($r),au=String((Fr==null?void 0:Fr.text)||""),ru=Number((Fr==null?void 0:Fr.at)||0);au===Ea&&ut-ru<5e3&&(Rs=!1)}}catch{}if(Rs){Promise.resolve(Za.send(t.uid,Ea)).catch(()=>{});try{localStorage.setItem(Lr,JSON.stringify({text:Ea,at:ut}))}catch{}}}}catch{}if((async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const De={shopId:_||(S==null?void 0:S.shopId)||(t==null?void 0:t.uid)||"default-shop",lineId:U||"default-line",walletId:U||void 0,merchantUserId:(t==null?void 0:t.uid)||null,provider:"vodafone_cash",txnType:ce==="transfer"?"send":"receive",originType:ce==="transfer"?"transfer":"withdraw",amount:p,commission:st,fee:oe,profit:0,senderMsisdn:Ys,receiverMsisdn:ce==="transfer"?Ss:Ys,note:ce==="transfer"?void 0:P&&P.trim()!==""?P.trim():void 0,status:A?"pending":"confirmed",linkedDebtId:J||void 0,createdBy:(t==null?void 0:t.uid)||null,walletEffectAppliedOnCreation:!1,cashEffectAppliedOnCreation:!!(A&&T),limitsReservedOnCreation:!!A,limitReservedType:ce==="transfer"?"transfer":"withdraw",profitAddedOnCreation:!1},at={...De,status:A?"pending":"completed",commissionMode:ce==="transfer"||At?"add":"deduct",totalCharged:ce==="transfer"?p+st+oe:At?p+j:p,walletEffectAppliedOnCreation:!1,cashEffectAppliedOnCreation:!!(A&&T),limitsReservedOnCreation:!!A,limitReservedType:ce==="transfer"?"transfer":"withdraw",sentAmount:ce==="transfer"?p:void 0,transferredAmount:ce==="transfer"?p:void 0,withdrawnAmount:ce==="withdraw"?p:void 0,senderName:ce==="withdraw"&&ee.trim()!==""?ee.trim():void 0,createdAt:new Date},{ProfitService:rt}=await wt(async()=>{const{ProfitService:ga}=await import("./profitService-CQSlHJ0c.js");return{ProfitService:ga}},__vite__mapDeps([3,0,1]),import.meta.url),Et=rt.calculateProfitFromTransaction({...at,status:"confirmed"});Et>0&&(rt.addProfit(Et,t==null?void 0:t.uid),De.profitAddedOnCreation=!0,at.profitAddedOnCreation=!0,console.log("✅ تم إضافة الربح:",Et,"جنيه"));const Zs=await Oi.create(De);if(U)try{await ma.updateUsage(U,p,ce==="transfer"?"transfer":"withdraw");try{window.dispatchEvent(new CustomEvent("walletLimitsUpdated",{detail:{walletId:U}}))}catch{}try{await Fl()}catch{}}catch{}await Promise.all([...t!=null&&t.uid?[Ce.updateUserData(t.uid,{cashBalance:Wt,walletBalances:Vt,lastUpdated:new Date().toISOString()})]:[],...t!=null&&t.uid?[Ce.saveUserTransaction(t.uid,{...at,transactionType:ce,fromWallet:U,toWallet:ce==="transfer"?I?null:"cash":null,cashierName:y&&((w==null?void 0:w.name)||(w==null?void 0:w.username))||"الحساب الرئيسي",linkedDebtId:J||void 0,transactionId:Zs,description:`${ce==="transfer"?"تحويل":"سحب"} ${p} من ${U} ${ce==="transfer"?I?"":"إلى الدرج النقدي":""} — عمولة: ${j} (${ce==="transfer"||At?"مضافة":"مخصومة"})${oe>0?` — رسوم: ${oe}`:""}${A?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");try{E.invalidateQueries({queryKey:["recentTransactions",t==null?void 0:t.uid,_||"main"]})}catch{}try{await Ui.refetch()}catch{}const Bs=`userData_${t==null?void 0:t.uid}`,na={cashBalance:Wt,walletBalances:Vt,lastUpdated:new Date().toISOString()};localStorage.setItem(Bs,JSON.stringify(na))}catch(De){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",De);try{t!=null&&t.uid&&Ce.saveLocalReceipt(t.uid,{...transactionDataForUser,transactionType:ce,fromWallet:U,toWallet:ce==="transfer"?I?null:"cash":null,cashierName:y&&((w==null?void 0:w.name)||(w==null?void 0:w.username))||"الحساب الرئيسي",linkedDebtId:J||void 0,description:`${ce==="transfer"?"تحويل":"سحب"} ${p} من ${U} ${ce==="transfer"?I?"":"إلى الدرج النقدي":""} — عمولة: ${j} (${ce==="transfer"||At?"مضافة":"مخصومة"})${oe>0?` — رسوم: ${oe}`:""}${A?" — دين مؤجل (قيد المراجعة)":""}`})}catch{}r({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),ce==="transfer"){Ar(!0);const De=Number(n)+Number(j)+Math.max(0,Number(oe));Ji({type:"transfer",amount:Math.max(0,Math.round(De*100)/100)}),Pm({receiver:Ss,amount:n}),lr(!0),setTimeout(()=>{Ar(!1)},2e3)}else{tn(!0);const De=At?Number(n):Math.max(0,Math.round((Number(n)-Number(j))*100)/100);Ji({type:"withdraw",amount:Math.max(0,Math.round(De*100)/100)}),lr(!0),setTimeout(()=>{tn(!1)},2e3)}za(""),d(""),B(""),Z(""),Ta(null),Oe(""),re(""),ds(""),Pa(!1)},ji=He.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),Wc=He.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),Hh=He.useMemo(()=>{try{return Dt.reduce((s,a)=>{const n=Number(a.paidAmount||0),l=Math.max(0,Number(a.amount||0)-n);return s+l},0)}catch{return 0}},[Dt]),Bl=He.useMemo(()=>Oc().filter(a=>ka==="all"?!0:ka==="send"?a.type==="send":ka==="receive"?a.type==="receive":ka==="withdraw"?a.type==="withdraw":ka!=="deleted"),[Oc,ka]),Qh=()=>{if(qi==="daily"){const s=Ls.resetReportsManually("daily",Ze,t==null?void 0:t.uid);Xr(!1),r({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${s.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const s=Ls.resetReportsManually("monthly",Ze,t==null?void 0:t.uid);Xr(!1),r({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${s.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},Gh=()=>qi==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",Zh=()=>qi==="daily"?"أدخل الرقم السري الرئيسي لتصفير جميع معاملات اليوم":"أدخل الرقم السري الرئيسي لتصفير جميع معاملات الشهر",Xh=s=>{Nc(s),bl(!0)},eu=s=>{const a=Mt,n=Number(s)-Number(a);ns(s);const l=new Date().toISOString();localStorage.setItem(Xt(),s.toString()),localStorage.setItem(Xt()+"_lastUpdated",l),cc(!1);const c={cashBalance:s,lastUpdated:l},h=`userData_${t==null?void 0:t.uid}`;try{localStorage.setItem(h,JSON.stringify(c))}catch{}const u=[];if(t!=null&&t.uid){u.push(Ce.updateUserData(t.uid,c).then(()=>{try{localStorage.removeItem(h)}catch{}}).catch(()=>{}));const g=`${n>0?"CASHADD":"CASHDEDUCT"}-${(t==null?void 0:t.uid)||"anon"}-${Date.now()}`,j=n>0?{txnType:"cash_addition",type:"cash_addition",amount:n,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:g,title:"إيصال إضافة نقدية",merchantUserId:t.uid,createdBy:t.uid,shopId:(S==null?void 0:S.shopId)||void 0}:n<0?{amount:Math.abs(n),status:"completed",title:"ايصال خصم من الفلوس النقديه",merchantUserId:t.uid,createdBy:t.uid,shopId:(S==null?void 0:S.shopId)||void 0}:null;j&&u.push(Ce.saveUserTransaction(t.uid,j));const p=S==null?void 0:S.shopId;if(p){const v=ze(q,"dashboardData",p);u.push(Yt(v,{cashBalance:s}))}}Promise.allSettled(u).then(()=>{}).catch(()=>{}),r({title:n>0?"تم إضافة نقدية":n<0?"تم خصم نقدية":"تم تحديث الرصيد النقدي",description:n!==0?`التغيير: ${Math.abs(n)} جنيه، الرصيد الجديد: ${s} جنيه`:`تم تحديث الرصيد النقدي إلى ${s} جنيه`})},tu=async s=>{var u;if(!Qs){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const a={...ct,[Qs]:s};ps(a);const n=new Date().toISOString(),l={walletBalances:a,lastUpdated:n},c=`userData_${t==null?void 0:t.uid}`;try{localStorage.setItem(c,JSON.stringify(l)),localStorage.setItem(is(),JSON.stringify(a)),localStorage.setItem(is()+"_lastUpdated",n),localStorage.setItem(`walletBalances_backup_${n}`,JSON.stringify(a))}catch{}try{t!=null&&t.uid&&await Ce.updateUserData(t.uid,l)}catch(g){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",g)}dc(!1);const h=((u=Ke.find(g=>g.id===Qs))==null?void 0:u.name)||"المحفظة";r({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${h} إلى ${s.toLocaleString()} جنيه`})},su=async s=>{var a;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",Qs),console.log("💵 المبلغ المضاف/المخصوم:",s),Qs){const n=ct[Qs]||0;console.log("💰 الرصيد الحالي:",n);const l=n+s;console.log("💰 الرصيد الجديد:",l);const c={...ct,[Qs]:l};console.log("📊 الأرصدة المحدثة:",c),ps(c);const h=new Date().toISOString(),u={walletBalances:c,lastUpdated:h},g=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(g,JSON.stringify(u)),localStorage.setItem(is(),JSON.stringify(c)),localStorage.setItem(`walletBalances_backup_${h}`,JSON.stringify(c));try{if(t!=null&&t.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await Ce.updateUserData(t.uid,u),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(g),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(I){console.error("❌ فشل في حفظ البيانات في Firebase:",I),ot(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(is(),JSON.stringify(c));const j=((a=Ke.find(I=>I.id===Qs))==null?void 0:a.name)||"المحفظة",p=s>0?"إضافة":"خصم",v=Math.abs(s);r({title:`تم ${p} مبلغ ${p==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${p} ${v} جنيه ${p==="إضافة"?"إلى":"من"} رصيد ${j}. الرصيد الجديد: ${l.toLocaleString()} جنيه`})}catch(j){if(console.error("❌ فشل في حفظ البيانات في Firebase:",j),localStorage.setItem(is(),JSON.stringify(c)),t!=null&&t.uid){const p=`userData_${t.uid}`,v={walletBalances:c,lastUpdated:new Date().toISOString()};localStorage.setItem(p,JSON.stringify(v)),ot(!0)}r({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const l=Object.keys(localStorage).filter(c=>c.startsWith("walletBalances_backup_")).sort();l.length>5&&l.slice(0,l.length-5).forEach(h=>{localStorage.removeItem(h),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",h)})},5e3),bl(!1),Nc("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:Qt,isUserActive:nt,showActivationModal:Nr}),Qt?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx(Au,{})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"user-dashboard min-h-screen px-2 sm:px-4 py-2 sm:py-4 relative bg-gray-100 bg-[radial-gradient(140%_140%_at_10%_10%,#e5e7eb_0%,#d1d5db_45%,#9ca3af_100%)]",children:[e.jsx(Ip,{userId:t==null?void 0:t.uid}),e.jsxs("div",{className:"max-w-screen-2xl mx-auto grid grid-cols-1 xl:grid-cols-3 gap-4 xl:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!sn&&e.jsxs(Ut,{className:"bg-gray-100 border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-200 relative overflow-hidden",children:[e.jsx(vs,{className:"pb-2 px-3 pt-3 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Vs,{className:"text-xs font-bold text-gray-900 flex items-center gap-1.5",children:[e.jsx("div",{className:"p-1 rounded-md bg-gradient-to-br from-gray-100 to-gray-200",children:e.jsx(ld,{className:"h-3.5 w-3.5 text-gray-700"})}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>{No("monthly"),Xr(!0)},className:"h-7 w-7 p-0 bg-transparent hover:bg-red-50 text-red-600 hover:text-red-700 rounded-full transition-colors duration-200",title:"تصفير معاملات الشهر",children:e.jsx(ys,{className:"h-3 w-3"})}),e.jsx("div",{className:"p-1 bg-green-50 rounded-full border border-green-100",children:e.jsx(Nn,{className:"h-3 w-3 text-green-600"})})]})]})}),!sn&&e.jsxs(qt,{className:"pt-0 px-2 pb-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-0 rounded-lg overflow-hidden border border-gray-200 divide-x divide-y divide-gray-200 bg-white",children:[e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-blue-600",children:"عدد المعاملات"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-blue-800 mt-0.5 sm:mt-0",children:fn().totalTransactions})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-gray-600",children:"إجمالي المبالغ"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-gray-900 mt-0.5 sm:mt-0",children:fn().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-red-600",children:"المسحوب"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-red-800 mt-0.5 sm:mt-0",children:fn().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-green-600",children:"المرسل"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-green-800 mt-0.5 sm:mt-0",children:fn().totalSent.toFixed(2)})]})]}),e.jsxs("div",{className:"mt-2 rounded-lg border border-gray-100 bg-white px-2 py-1.5 flex items-center justify-between",children:[e.jsx("span",{className:"text-[12px] font-bold text-yellow-600",children:"الأرباح"}),e.jsx(pp,{userId:t==null?void 0:t.uid,transactions:Ze})]})]}),Fm&&e.jsx("div",{className:"absolute inset-0 z-20 backdrop-blur-sm bg-amber-50/60 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(x,{size:"sm",variant:"ghost",onClick:async()=>{if(Tt){r({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}Gn(!0)},className:"px-4 py-2 rounded-full bg-white border border-gray-100 text-gray-900 shadow-sm hover:bg-gray-50 hover:shadow-md transition-all duration-200 flex items-center gap-2 text-xs font-medium",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(Ht,{className:"h-3.5 w-3.5 text-gray-600"})]})})]}),e.jsx(fs,{open:Bm,onOpenChange:Gn,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(Tt){r({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),Gn(!1),Ro(!0);return}Ro(!1),Gn(!1)},userId:t==null?void 0:t.uid}),((Bc=it==null?void 0:it.subscription)==null?void 0:Bc.planType)!==ea.TAHWEELA&&e.jsxs(Ut,{className:"bg-gray-50 border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-200 relative overflow-hidden",children:[e.jsx(vs,{className:"pb-2 px-3 pt-3 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Vs,{className:"text-sm font-bold text-gray-900 flex items-center gap-2",children:[e.jsx("div",{className:"p-1 rounded-md bg-gradient-to-br from-gray-100 to-gray-200",children:e.jsx(ld,{className:"h-4 w-4 text-gray-700"})}),e.jsx("span",{className:"text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>{No("daily"),Xr(!0)},className:"h-8 w-8 p-0 bg-transparent hover:bg-red-50 text-red-600 hover:text-red-700 rounded-full transition-colors duration-200",title:"تصفير معاملات اليوم",children:e.jsx(ys,{className:"h-3.5 w-3.5"})}),e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>Wm(s=>!s),className:"h-8 w-8 p-0 bg-transparent hover:bg-gray-100 text-gray-600 hover:text-blue-600 rounded-full transition-colors duration-200",title:sn?"توسيع اليوم والشهر":"طي اليوم والشهر",children:sn?e.jsx(Pn,{className:"h-3.5 w-3.5"}):e.jsx(Ii,{className:"h-3.5 w-3.5"})}),e.jsx("div",{className:"p-2 bg-green-50 rounded-full border border-green-100",children:e.jsx(Nn,{className:"h-3.5 w-3.5 text-green-600"})})]})]})}),!sn&&e.jsxs(qt,{className:"pt-0 px-2 pb-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-0 rounded-lg overflow-hidden border border-gray-200 divide-x divide-y divide-gray-200 bg-white",children:[e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-blue-600",children:"عدد المعاملات"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-blue-800 mt-0.5 sm:mt-0",children:gn().totalTransactions})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-gray-600",children:"إجمالي المبالغ"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-gray-900 mt-0.5 sm:mt-0",children:gn().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-red-600",children:"المسحوب"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-red-800 mt-0.5 sm:mt-0",children:gn().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-green-600",children:"المرسل"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-green-800 mt-0.5 sm:mt-0",children:gn().totalSent.toFixed(2)})]})]}),e.jsxs("div",{className:"mt-2 rounded-lg border border-gray-100 bg-white px-2 py-1.5 flex items-center justify-between",children:[e.jsx("span",{className:"text-[12px] font-bold text-yellow-600",children:"الأرباح"}),e.jsx(yp,{userId:t==null?void 0:t.uid,transactions:Ze})]})]}),Jm&&e.jsx("div",{className:"absolute inset-0 z-20 backdrop-blur-sm bg-white/60 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(x,{size:"sm",variant:"ghost",onClick:()=>Hi(!0),className:"px-4 py-2 rounded-full bg-white border border-gray-100 text-gray-900 shadow-sm hover:bg-gray-50 hover:shadow-md transition-all duration-200 flex items-center gap-2 text-xs font-medium",title:"عرض تقارير اليوم (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير اليوم"}),e.jsx(Ht,{className:"h-3.5 w-3.5 text-gray-600"})]})})]}),e.jsx(fs,{open:Km,onOpenChange:Hi,mode:"verify",title:"الرقم السري لفتح تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Fo(!1),Hi(!1)},userId:t==null?void 0:t.uid})]}),e.jsxs(Ut,{className:"balance-bar bg-gray-200 border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(qt,{className:"p-2 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"bg-white border border-gray-200 p-1 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 group/cash relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex flex-col relative z-10 w-full",children:[e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx(es,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsx("span",{className:"text-[11px] font-extrabold text-emerald-800",children:"الفلوس النقدية"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-green-600 hover:bg-green-50 transition-colors",onClick:()=>cn(!0),children:e.jsx(gs,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-emerald-600 hover:bg-emerald-50 transition-colors",onClick:()=>Sc(!0),title:"تفاصيل الفلوس النقدية",children:e.jsx(id,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-red-600 hover:bg-red-50 transition-colors",onClick:()=>vi(!0),children:e.jsx(ys,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"mt-0.5",children:e.jsxs("span",{className:"text-[14px] sm:text-xl font-bold text-emerald-800 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm block w-fit",children:[Mt.toLocaleString("en-US")," جنيه"]})})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 p-1 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 group/wallet relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex flex-col relative z-10 w-full",children:[e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(Da,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsx("span",{className:"text-[11px] font-extrabold text-blue-800",children:"الأرصدة علي المحافظ"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-green-600 hover:bg-green-50 transition-colors",onClick:()=>pi(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(gs,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-red-600 hover:bg-red-50 transition-colors",onClick:()=>{yi(!0),bi("")},title:"تصفير إجمالي المحفظة",children:e.jsx(ys,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"mt-0.5",children:e.jsxs("span",{className:"text-[14px] sm:text-xl font-bold text-blue-800 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm block w-fit",children:[Object.values(ct).reduce((s,a)=>s+a,0).toLocaleString("en-US")," جنيه"]})})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-white border border-gray-200 p-1 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 group/selwallet relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex flex-col relative z-10 w-full",children:[e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(Da,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsx("span",{className:"text-[11px] font-extrabold text-indigo-800",children:"رصيد المحفظه"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-green-600 hover:bg-green-50 transition-colors",onClick:()=>{if(!U){r({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}Xh(U)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(gs,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-red-600 hover:bg-red-50 transition-colors",onClick:()=>{if(!U){r({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}ai(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(ys,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"mt-0.5",children:e.jsxs("span",{className:"text-[14px] sm:text-xl font-bold text-indigo-800 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm block w-fit",children:[(U&&ct[U]||0).toLocaleString("en-US")," جنيه"]})})]})]})]})})]}),e.jsxs(Ut,{className:"bg-gray-100 border border-gray-200 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsxs(vs,{className:`pb-2 px-4 pt-4 relative z-10 ${Y?"sticky top-0 z-20 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/60":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Vs,{className:"text-sm font-bold flex items-center gap-2 text-gray-900",children:[!Y&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gray-100 rounded-lg",children:e.jsx(Nn,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-700"})}),e.jsx("span",{className:"text-gray-900",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!Y&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-100 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(Ru,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx(V,{placeholder:"بحث...",value:Io,onChange:s=>Am(s.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!Y&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"تقسيط"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{if(Tt||Ft){r({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"});return}Kn(!0)},title:"إدارة التقسيط",children:e.jsx(Tu,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-green-600 mb-1",children:"شحن"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-green-100 text-green-600 hover:bg-green-200 border border-green-200 ring-3 ring-green-300 transition-all duration-200 hover:scale-105 active:bg-green-600 active:text-white active:border-green-600",onClick:()=>{r({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."})},title:"شحن الرصيد",children:e.jsx(_n,{className:"h-5 w-5 text-green-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>Ki(!0),title:"آلة حاسبة",children:e.jsx(_d,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{Tt||Ft?r({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Yn(!0)},title:"كروت الائتمان",children:e.jsx(_n,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"تقاريرك"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:()=>{if(Tt||Ft){r({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"});return}fc(!0)},title:"تقاريرك",children:e.jsx(px,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-sky-600 mb-1",children:"تلجرام"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-sky-100 text-sky-600 hover:bg-sky-200 border border-sky-200 ring-3 ring-sky-300 transition-all duration-200 hover:scale-105 active:bg-sky-600 active:text-white active:border-sky-600",onClick:()=>{Tt||Ft?r({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):ks.hasMasterPin()?$l(!0):Ec()},title:"إرسال تقرير يومي إلى تليجرام",children:e.jsx(yx,{className:"h-5 w-5 text-sky-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:Ih,title:y&&(w!=null&&w.name||w!=null&&w.username)?`بروفيل الوردية: ${(w==null?void 0:w.name)||(w==null?void 0:w.username)}`:"وردية الكاشير",children:e.jsx(Tn,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{Tt||Ft?r({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Zr(!0)},title:"بيانات المبيعات",children:e.jsx(ad,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),Dt.filter(s=>s.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:Dt.filter(s=>s.status==="pending").length})]}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{il()},title:"الديون",children:e.jsx(Pu,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-100 text-amber-700 hover:bg-amber-200 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105 active:bg-amber-600 active:text-white active:border-amber-600",onClick:()=>{Tt||Ft?r({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Hn(!0)},title:"الصيانة",children:e.jsx(Id,{className:"h-5 w-5 text-amber-700"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-100 text-violet-700 hover:bg-violet-200 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105 active:bg-violet-700 active:text-white active:border-violet-700",onClick:()=>{!ja||Ft?r({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Qn(!0)},title:"يومية المكنة",children:e.jsx($d,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-100 text-orange-600 hover:bg-orange-200 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105 active:bg-orange-600 active:text-white active:border-orange-600",onClick:()=>{Tt||Ft?r({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):ks.hasMasterPin()?Js(!0):ss(!0)},title:"مصروفات المحل",children:e.jsx(yr,{className:"h-5 w-5 text-orange-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-rose-600 mb-1",children:"النواقص"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-rose-100 text-rose-600 hover:bg-rose-200 border border-rose-200 ring-3 ring-rose-300 transition-all duration-200 hover:scale-105 active:bg-rose-600 active:text-white active:border-rose-600",onClick:()=>{Tt||Ft?r({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Aa(!0)},title:"النواقص",children:e.jsx(Xc,{className:"h-5 w-5 text-rose-600"})})]})]})]})]}),!Y&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"filters-bar flex items-center justify-center gap-3 bg-gray-100 rounded-md p-3 border border-gray-200",children:[e.jsx(x,{variant:"ghost",size:"sm",className:`btn-filter-send h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${ka==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-100"}`,onClick:()=>Bi("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(x,{variant:"ghost",size:"sm",className:`btn-filter-withdraw h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${ka==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-100"}`,onClick:()=>Bi("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(x,{variant:"ghost",size:"sm",className:`btn-filter-all h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${ka==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-100"}`,onClick:()=>Bi("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(x,{variant:"ghost",size:"sm",className:"h-auto px-2 py-1 text-xs text-red-600 hover:bg-red-50 rounded-md font-medium",onClick:()=>on(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(ys,{className:"h-3 w-3 mr-1"}),"تصفير"]}),Lh>0&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),e.jsx(fs,{open:Em,onOpenChange:Kn,mode:"verify",title:"فتح إدارة التقسيط",description:"أدخل الرقم السري الرئيسي للوصول إلى إدارة التقسيط",onSuccess:()=>{Kn(!1),Mo(!0)}}),e.jsx(Fu,{open:Mm,onOpenChange:Mo}),e.jsx(fs,{open:zh,onOpenChange:$l,mode:"verify",title:"إرسال تقرير يومي إلى تليجرام",description:"أدخل الرقم السري الرئيسي لإرسال التقرير اليومي إلى تليجرام",onSuccess:()=>{$l(!1),Ec()}}),Eo,e.jsxs(qt,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:[Bl.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Nn,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):Y?e.jsx("div",{className:"overflow-y-auto overscroll-contain scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[310px]",children:e.jsx("div",{className:"space-y-2 pr-2",children:Bl.map(s=>e.jsxs("div",{className:"relative flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer",onClick:()=>Lc(s),children:[e.jsx("div",{className:`h-10 w-10 rounded-full flex items-center justify-center shrink-0 ${s.type==="withdraw"?"bg-red-100":"bg-green-100"}`,children:(()=>{const a=s,n=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return n?e.jsx(yr,{className:"h-5 w-5 text-gray-600"}):l?e.jsx(gs,{className:"h-5 w-5 text-green-600"}):s.type==="withdraw"?e.jsx(Br,{className:"h-5 w-5 text-red-600"}):e.jsx(rd,{className:"h-5 w-5 text-green-600"})})()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h4",{className:"text-base font-bold truncate",children:(()=>{const a=s,n=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return n?e.jsx("span",{className:"text-foreground",children:"تسليم وردية"}):l?e.jsx("span",{className:"text-foreground",children:"إضافة نقدية"}):s.type==="send"?e.jsx("span",{className:"text-green-600",children:"تحويل أموال"}):e.jsx("span",{className:"text-red-600",children:"سحب نقدي"})})()}),e.jsxs("span",{className:`text-base font-bold whitespace-nowrap ${s.type==="withdraw"?"text-red-600":"text-green-600"}`,children:[s.type==="withdraw"||s.type==="cash_addition"||s.txnType==="cash_addition"?"+":"-"," ",ta(s.amount)," ج.م"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-0.5",children:[e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:(()=>{const a=s,n=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية"),c=(a==null?void 0:a.note)||(a==null?void 0:a.notes)||"";return n?`إلى: ${s.receiverPhone}`:l?c||"إضافة يدوية":s.type==="send"?e.jsx("span",{dir:"ltr",children:s.receiverPhone}):e.jsx("span",{dir:"ltr",children:s.senderPhone})})()}),e.jsxs("p",{className:"text-sm font-medium text-gray-500 mt-0.5",children:[ji.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))," - ",Wc.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))]})]}),e.jsxs("div",{className:`px-2 py-0.5 rounded-full text-[10px] font-medium flex items-center gap-1 ${s.status==="completed"?s.type==="withdraw"?"bg-red-100 text-red-700":"bg-green-100 text-green-700":s.status==="pending"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:[s.status==="completed"&&e.jsx(Di,{className:"h-3 w-3"}),s.status==="pending"&&e.jsx(Fa,{className:"h-3 w-3"}),s.status==="failed"&&e.jsx(Ti,{className:"h-3 w-3"}),e.jsx("span",{children:s.status==="completed"?"ناجحة":s.status==="pending"?"معالجة":"فشلت"})]})]})]})]},s.id))})}):e.jsx("div",{className:"overflow-y-auto overscroll-contain scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[calc(100dvh-300px)]",children:e.jsx("div",{className:"space-y-2 pr-2",children:Bl.map(s=>e.jsxs("div",{className:"relative flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer",onClick:()=>Lc(s),children:[e.jsx("div",{className:`h-10 w-10 rounded-full flex items-center justify-center shrink-0 ${s.type==="withdraw"?"bg-red-100":"bg-green-100"}`,children:(()=>{const a=s,n=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return n?e.jsx(yr,{className:"h-5 w-5 text-gray-600"}):l?e.jsx(gs,{className:"h-5 w-5 text-green-600"}):s.type==="withdraw"?e.jsx(Br,{className:"h-5 w-5 text-red-600"}):e.jsx(rd,{className:"h-5 w-5 text-green-600"})})()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h4",{className:"text-base font-bold truncate",children:(()=>{const a=s,n=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return n?e.jsx("span",{className:"text-foreground",children:"تسليم وردية"}):l?e.jsx("span",{className:"text-foreground",children:"إضافة نقدية"}):s.type==="send"?e.jsx("span",{className:"text-green-600",children:"تحويل أموال"}):e.jsx("span",{className:"text-red-600",children:"سحب نقدي"})})()}),e.jsxs("span",{className:`text-base font-bold whitespace-nowrap ${s.type==="withdraw"?"text-red-600":"text-green-600"}`,children:[s.type==="withdraw"||s.type==="cash_addition"||s.txnType==="cash_addition"?"+":"-"," ",ta(s.amount)," ج.م"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-0.5",children:[e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:(()=>{const a=s,n=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية"),c=(a==null?void 0:a.note)||(a==null?void 0:a.notes)||"";return n?`إلى: ${s.receiverPhone}`:l?c||"إضافة يدوية":s.type==="send"?e.jsx("span",{dir:"ltr",children:s.receiverPhone}):e.jsx("span",{dir:"ltr",children:s.senderPhone})})()}),e.jsxs("p",{className:"text-sm font-medium text-gray-500 mt-0.5",children:[ji.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))," - ",Wc.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))]})]}),e.jsxs("div",{className:`px-2 py-0.5 rounded-full text-[10px] font-medium flex items-center gap-1 ${s.status==="completed"?s.type==="withdraw"?"bg-red-100 text-red-700":"bg-green-100 text-green-700":s.status==="pending"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:[s.status==="completed"&&e.jsx(Di,{className:"h-3 w-3"}),s.status==="pending"&&e.jsx(Fa,{className:"h-3 w-3"}),s.status==="failed"&&e.jsx(Ti,{className:"h-3 w-3"}),e.jsx("span",{children:s.status==="completed"?"ناجحة":s.status==="pending"?"معالجة":"فشلت"})]})]})]})]},s.id))})}),Y&&e.jsxs("div",{className:"mt-2 flex justify-end",children:[e.jsxs(x,{variant:"ghost",size:"sm",className:"h-7 px-2 text-[11px] rounded-full border bg-red-100 text-red-700 border-red-300 hover:bg-red-200",onClick:()=>on(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(ys,{className:"h-3 w-3 mr-1"}),"تصفير"]}),(t==null?void 0:t.uid)&&localStorage.getItem(`recentTransactionsResetAt:${t.uid}`)&&e.jsx("span",{className:"inline-block h-1.5 w-1.5 rounded-full bg-red-500 ml-1 align-middle"})]})]})]})]}),e.jsx(Wu,{isOpen:vm,onClose:()=>qn(!1),transaction:wm,onPrint:()=>window.print(),onDelete:Cm,onComplete:Im}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full",children:[e.jsxs(Ut,{id:"transaction-section",className:"bg-gray-100 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx(vs,{className:"sticky top-0 z-20 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Vs,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(zr,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[Gt&&e.jsx("div",{className:"hidden md:flex items-center gap-1 bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 border border-emerald-200 text-emerald-800 text-sm transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:e.jsxs("span",{className:"text-sm font-semibold whitespace-nowrap",children:["تجربة: ",wa," ",wa>=3&&wa<=10?"ساعات":wa===2?"ساعتين":"ساعة"]})}),e.jsxs("div",{className:"top-icons-bar hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:[e.jsx(Yx,{}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"VIP",onClick:()=>Yi(!0),children:e.jsx(sx,{className:"h-5 w-5 text-yellow-500"})}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"إدارة الفروع",onClick:()=>{r({title:"قيد التطوير",description:"إدارة الفرع قيد التطوير حالياً"})},children:e.jsx(Od,{className:"h-5 w-5"})}),e.jsx(Lu,{})]})]}),Uh&&e.jsxs(x,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:Tc,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx(ax,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsx(Te,{open:Vm,onOpenChange:Yi,children:e.jsxs(Pe,{className:"sm:max-w-md",children:[e.jsx(ke,{children:e.jsx(_e,{children:"أفضل 10 عملاء هذا الشهر"})}),e.jsx("div",{className:"space-y-2",children:fi.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا توجد بيانات لهذا الشهر"}):fi.map((s,a)=>e.jsxs("div",{className:`flex items-center justify-between border rounded-md px-3 py-2 bg-white ${a===0?"bg-yellow-50 border-yellow-300":""}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(bs,{variant:"outline",className:`min-w-[28px] justify-center ${a===0?"border-yellow-300 text-yellow-700 bg-yellow-50":""}`,children:a+1}),e.jsx("span",{className:`font-semibold ${a===0?"text-yellow-700":""}`,children:s.phone})]}),e.jsxs("div",{className:"text-sm text-gray-700 flex items-center gap-3",children:[e.jsxs("span",{children:["عدد: ",s.count]}),e.jsxs("span",{children:["إجمالي: ",s.total]}),e.jsx(x,{variant:"outline",size:"sm",className:"h-8",onClick:()=>Fh(s),title:"إرسال واتساب",children:e.jsx(ed,{className:"h-4 w-4"})})]})]},s.phone+a))}),e.jsx(xt,{children:e.jsx(x,{onClick:()=>Yi(!1),children:"إغلاق"})})]})}),e.jsx(Te,{open:Um,onOpenChange:Lo,children:e.jsxs(Pe,{className:"sm:max-w-md",children:[e.jsx(ke,{children:e.jsx(_e,{children:"ربط بوت التلجرام"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(se,{children:"Telegram Chat ID"}),e.jsx(V,{value:Zn,onChange:s=>zm(s.target.value),placeholder:"اكتب رقم المحادثة"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(se,{children:"إرسال يومي 12 صباحاً"}),e.jsx(zu,{checked:$o,onCheckedChange:s=>qm(!!s)})]})]}),e.jsxs(xt,{children:[e.jsx(x,{variant:"outline",onClick:()=>Lo(!1),children:"إغلاق"}),e.jsx(x,{onClick:async()=>{t!=null&&t.uid&&(await Ce.updateUserData(t.uid,{telegramChatId:Zn,telegramDailyEnabled:$o}),r({title:"تم الحفظ"}))},children:"حفظ"}),e.jsx(x,{onClick:async()=>{if(!(t!=null&&t.uid)||!Zn){r({title:"أدخل Chat ID"});return}const s=await _c();try{const{sendTelegramMessage:a}=await wt(async()=>{const{sendTelegramMessage:n}=await Promise.resolve().then(()=>Mx);return{sendTelegramMessage:n}},void 0,import.meta.url);await a({chatId:Zn,text:s}),r({title:"تم الإرسال"})}catch{r({title:"تعذر الإرسال",description:"تحقق من ربط البوت",variant:"destructive"})}},children:"إرسال الآن"})]})]})}),e.jsx(Te,{open:ue,onOpenChange:ve,children:e.jsxs(Pe,{className:"sm:max-w-lg",children:[e.jsxs(ke,{children:[e.jsx(_e,{children:"إدارة الفروع"}),e.jsx(Ps,{children:"أضف فروع جديدة وأدِر الدخول لكل فرع"}),e.jsx("div",{className:"flex items-center justify-end gap-2 mt-2",children:e.jsx(x,{variant:"outline",size:"sm",onClick:()=>{try{const s=t!=null&&t.uid?`selectedShopId_${t.uid}`:"selectedShopId";localStorage.removeItem(s);try{window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}r({title:"تم الخروج من الفرع"}),L(`/branch/${String(b.shopId)}/dashboard`)}catch{}},children:"الخروج من الفرع"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(se,{children:"اسم المدير"}),e.jsx(V,{value:qe,onChange:s=>$e(s.target.value),placeholder:"اكتب اسم المدير"})]}),e.jsxs("div",{children:[e.jsx(se,{children:"اسم الفرع"}),e.jsx(V,{value:Qe,onChange:s=>Ge(s.target.value),placeholder:"اكتب اسم الفرع"})]}),e.jsxs("div",{children:[e.jsx(se,{children:"اسم المستخدم للدخول"}),e.jsx(V,{value:Ct,onChange:s=>ne(s.target.value),placeholder:"مثال: branch1"})]}),e.jsxs("div",{children:[e.jsx(se,{children:"كلمة السر"}),e.jsx(V,{type:"password",value:Ie,onChange:s=>tt(s.target.value),placeholder:"••••••"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{$e(""),Ge(""),ne(""),tt("")},children:"مسح"}),e.jsx(x,{className:"bg-indigo-600 hover:bg-indigo-700",disabled:xe,onClick:async()=>{if(!(t!=null&&t.uid))return;const s=qe.trim(),a=Qe.trim(),n=Ct.trim(),l=Ie.trim();if(!s||!a||!n||!l){r({title:"يرجى ملء جميع الحقول"});return}if(ae.length>=3){r({title:"عفواً",description:"لقد وصلت للحد الأقصى من الفروع (3 فروع)",variant:"destructive"});return}try{Me(!0);let c="";try{c=(await ha(je(q,"shops"),{name:a,ownerId:t.uid,createdAt:bt(),updatedAt:bt(),isActive:!0})).id}catch{c=(await ha(je(q,"users",t.uid,"shops"),{name:a,ownerId:t.uid,createdAt:bt(),updatedAt:bt(),isActive:!0})).id}const h=u=>{try{return btoa(unescape(encodeURIComponent(u)))}catch{return btoa(u)}};try{await ha(je(q,"branches"),{ownerId:t.uid,shopId:c,branchName:a,managerName:s,loginUsername:n,passwordEncoded:h(l),createdAt:bt()})}catch{await ha(je(q,"users",t.uid,"branches"),{ownerId:t.uid,shopId:c,branchName:a,managerName:s,loginUsername:n,passwordEncoded:h(l),createdAt:bt()})}try{const u=Ye(je(q,"branches"),he("ownerId","==",t.uid));let j=(await et(u)).docs.map(p=>({id:p.id,...p.data()}));if(j.length===0){const p=Ye(je(q,"users",t.uid,"branches"));j=(await et(p)).docs.map(I=>({id:I.id,...I.data()}))}Be(j)}catch{try{const u=Ye(je(q,"users",t.uid,"branches")),j=(await et(u)).docs.map(p=>({id:p.id,...p.data()}));Be(j)}catch{}}$e(""),Ge(""),ne(""),tt(""),r({title:"تم إضافة الفرع بنجاح"})}catch{r({title:"تعذّر إضافة الفرع"})}finally{Me(!1)}},children:"إضافة فرع"})]}),e.jsxs("div",{className:"border-t pt-3",children:[e.jsx("h4",{className:"text-sm font-semibold mb-2",children:"الفروع الحالية"}),xe?e.jsx("div",{className:"text-sm text-gray-500",children:"جارٍ التحميل..."}):ae.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"لا يوجد فروع بعد"}):e.jsx("div",{className:"space-y-2",children:ae.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-lg bg-white",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:s.branchName}),e.jsxs("div",{className:"text-gray-600",children:["مدير: ",s.managerName]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{size:"sm",className:"bg-blue-600 hover:bg-blue-700",onClick:()=>{ts(s),Je(String(s.loginUsername||"")),Re(""),zt(!0)},children:"دخول الفرع"}),e.jsx(x,{size:"sm",variant:"destructive",onClick:async()=>{if(confirm("هل أنت متأكد من حذف الفرع؟ سيتم حذف بيانات الفرع المرتبطة."))try{try{await qs(ze(q,"branches",s.id))}catch{}try{await qs(ze(q,"users",(t==null?void 0:t.uid)||"","branches",s.id))}catch{}if(s.shopId){try{await qs(ze(q,"shops",String(s.shopId)))}catch{}try{await qs(ze(q,"users",(t==null?void 0:t.uid)||"","shops",String(s.shopId)))}catch{}}Be(a=>a.filter(n=>n.id!==s.id)),r({title:"تم حذف الفرع"})}catch{r({title:"تعذّر حذف الفرع"})}},children:"حذف الفرع"})]})]},s.id))})]})]})]})}),e.jsx(Te,{open:Pt,onOpenChange:zt,children:e.jsxs(Pe,{className:"sm:max-w-md",children:[e.jsxs(ke,{children:[e.jsx(_e,{children:"دخول الفرع"}),e.jsx(Ps,{children:"أدخل بيانات الدخول للفرع المحدد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(se,{children:"اسم المستخدم"}),e.jsx(V,{value:We,onChange:s=>Je(s.target.value),placeholder:"اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(se,{children:"كلمة السر"}),e.jsx(V,{type:"password",value:mt,onChange:s=>Re(s.target.value),placeholder:"••••••"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{Je(""),Re("")},children:"مسح"}),e.jsx(x,{className:"bg-blue-600 hover:bg-blue-700",disabled:Xe,onClick:async()=>{const s=$t;if(!s){zt(!1);return}const a=String(s.loginUsername||"");let n="";try{const h=String(s.passwordEncoded||"");n=h?decodeURIComponent(escape(atob(h))):""}catch{try{n=s.passwordEncoded?atob(String(s.passwordEncoded)):""}catch{n=""}}const l=We.trim(),c=mt.trim();if(!l||!c){r({title:"يرجى إدخال اسم المستخدم وكلمة السر"});return}if(l!==a||c!==n){r({title:"بيانات الدخول غير صحيحة",variant:"destructive"});return}try{X(!0);const h=t!=null&&t.uid?`selectedShopId_${t.uid}`:"selectedShopId";localStorage.setItem(h,String(s.shopId)),r({title:"تم الدخول إلى الفرع",description:String(s.branchName||"")}),zt(!1),ve(!1),L("/user/dashboard")}catch{}X(!1)},children:"دخول"})]})]})]})}),e.jsxs(qt,{ref:m,className:"space-y-1 px-2 pb-2 relative z-10 transition-transform duration-200 ease-out will-change-transform",style:{transform:o?`translateY(${o}px)`:void 0},onFocusCapture:s=>{const a=s.target;if(!((a==null?void 0:a.id)==="transferExtraFeeInput")){f(0);return}const l=document.getElementById("transferSubmitButton");if(l){const c=l.getBoundingClientRect(),h=window.innerHeight;if(c.bottom>h){const u=c.bottom-h,g=Math.min(u,220);f(-g)}else f(0)}else f(0)},onBlurCapture:s=>{s.currentTarget.contains(s.relatedTarget)||f(0)},children:[e.jsxs("div",{className:"transaction-type-tabs flex w-full rounded-full border border-gray-300 overflow-hidden bg-surface fade-in-up",children:[e.jsxs("button",{type:"button",onClick:()=>Ni("transfer"),className:`flex-1 h-10 text-sm font-medium transition-colors duration-200 flex items-center justify-center gap-2 ${ce==="transfer"?"bg-blue-100 text-blue-900":"bg-transparent text-gray-600 hover:bg-gray-50"}`,children:[ce==="transfer"&&e.jsx(Di,{className:"h-4 w-4"}),e.jsx(Nn,{className:"h-4 w-4"}),"تحويل"]}),e.jsx("div",{className:"w-[1px] bg-gray-300"}),e.jsxs("button",{type:"button",onClick:()=>Ni("withdraw"),className:`flex-1 h-10 text-sm font-medium transition-colors duration-200 flex items-center justify-center gap-2 ${ce==="withdraw"?"bg-red-100 text-red-900":"bg-transparent text-gray-600 hover:bg-gray-50"}`,children:[ce==="withdraw"&&e.jsx(Di,{className:"h-4 w-4"}),e.jsx(Br,{className:"h-4 w-4"}),"سحب"]})]}),e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(Da,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(x,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>L("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(gs,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(x,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>{Sr(!0)},title:"المحافظ",children:[e.jsx(Da,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),Ke.length>0?e.jsxs(Xa,{value:U,onValueChange:Vh,children:[e.jsx(er,{"data-testid":"wallet-select",className:"w-full h-14 text-base bg-surface border border-gray-400 hover:border-gray-800 focus:border-primary rounded-xl transition-colors duration-200 flex items-center",children:e.jsx(tr,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-700"})}),e.jsxs(sr,{className:"rounded-xl border border-gray-200 shadow-md z-[9999] bg-white dark:bg-gray-900",children:[e.jsx("div",{"data-fixed-header":"true",className:"sticky top-0 z-10 bg-white dark:bg-gray-900 p-2 border-b border-gray-100 dark:border-gray-800",children:e.jsx(V,{value:bo,onChange:s=>fm(s.target.value),placeholder:"ابحث برقم المحفظة",className:"h-10 text-sm border-gray-300 rounded-lg"})}),e.jsx("div",{className:"p-1",children:vo.length===0?e.jsx("div",{className:"text-sm text-gray-500 p-3 text-center",children:"لا توجد نتائج مطابقة"}):vo.map(s=>e.jsx(fa,{value:s.id,className:"rounded-lg my-1 cursor-pointer hover:bg-gray-100 focus:bg-blue-50 transition-colors duration-200",children:e.jsxs("div",{className:"flex items-center gap-3 py-2 w-full",children:[e.jsx(Da,{className:"h-5 w-5 text-gray-500"}),e.jsxs("div",{className:"flex items-center gap-2 text-right",children:[e.jsx("span",{className:"text-base font-medium text-gray-900",children:s.name}),e.jsx("span",{className:"text-sm font-bold text-red-600",children:s.phone})]}),s.isDefault&&e.jsx("span",{className:"mr-auto text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full border border-gray-200",children:"افتراضي"})]})},s.id))})]})]}):e.jsx("div",{className:"rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 px-3 py-3 text-xs text-gray-600",children:"لا توجد محافظ حتى الآن. اضغط “إضافة محفظة” لإضافة أول محفظة."})]}),e.jsx(Te,{open:$n,onOpenChange:Mi,children:e.jsxs(Pe,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(ke,{children:e.jsx(_e,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(Zu,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),e.jsx(fs,{open:jr,onOpenChange:Sr,mode:"verify",title:"الرقم السري لفتح المحافظ",description:"أدخل الرقم السري الرئيسي لعرض وإدارة المحافظ",onSuccess:()=>{Sr(!1),Mi(!0)},userId:t==null?void 0:t.uid}),e.jsx(fs,{open:Fn,onOpenChange:s=>{Dr(s),s||Gr(null)},mode:"verify",title:"تأكيد تغيير المحفظة",description:"أدخل الرقم السري الرئيسي لتغيير المحفظة المختارة",onSuccess:()=>{Wn&&(un(Wn,"walletSelectionPin"),Gr(null)),Dr(!1)},userId:t==null?void 0:t.uid}),U&&Ke.length>0&&(()=>{var K;const s=Ke.find(oe=>oe.id===U),a=Oa,n=Yh(U),l=(lt==null?void 0:lt.monthlyWithdrawLimit)??(s==null?void 0:s.monthlyWithdrawalLimit)??2e5,c=(lt==null?void 0:lt.monthlyTransferLimit)??(s==null?void 0:s.monthlyTransferLimit)??2e5,h=(lt==null?void 0:lt.monthlyWithdrawUsed)??a.totalWithdrawn??0,u=(lt==null?void 0:lt.monthlyTransferUsed)??a.totalTransferred??0,g=((K=it==null?void 0:it.subscription)==null?void 0:K.planType)===ea.TAHWEELA,j=g?0:(lt==null?void 0:lt.dailyWithdrawLimit)??1e5,p=g?0:(lt==null?void 0:lt.dailyTransferLimit)??6e4,v=g?0:(lt==null?void 0:lt.dailyWithdrawUsed)??n.totalWithdrawn??0,I=g?0:(lt==null?void 0:lt.dailyTransferUsed)??n.totalTransferred??0,T=parseFloat(cs||"0")||0,A=h+(ce==="withdraw"?T:0),J=u+(ce==="transfer"?T:0),Ue=v+(ce==="withdraw"?T:0),$=I+(ce==="transfer"?T:0);return s?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2 p-2 bg-gray-50 rounded-xl border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-gray-200 pb-1",children:[e.jsx("span",{className:"text-sm font-bold text-gray-800",children:"الحدود الشهرية"}),e.jsx("span",{className:"text-xs font-medium text-gray-500 bg-white px-2 py-0.5 rounded-full border border-gray-200",children:mh||(s==null?void 0:s.name)})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-1 font-medium",children:[e.jsx("span",{className:"text-gray-700",children:"سحب شهري"}),e.jsxs("span",{className:"text-gray-600 dir-ltr",children:[Math.max(l-A,0).toLocaleString("en-US",{maximumFractionDigits:0})," متبقي"]})]}),e.jsx("div",{className:"h-1.5 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner ring-1 ring-gray-200/50",children:e.jsx("div",{className:"h-full bg-gradient-to-l from-red-500 to-red-600 rounded-full transition-all duration-500 ease-out shadow-sm",style:{width:`${Math.min(A/Math.max(l,1)*100,100)}%`}})}),e.jsxs("div",{className:"flex justify-between mt-0.5",children:[e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["المستخدم: ",A.toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["الحد: ",l.toLocaleString("en-US",{maximumFractionDigits:0})]})]})]}),e.jsx("div",{className:"w-[1px] bg-gray-200 self-stretch"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-1 font-medium",children:[e.jsx("span",{className:"text-gray-700",children:"تحويل شهري"}),e.jsxs("span",{className:"text-gray-600 dir-ltr",children:[Math.max(c-J,0).toLocaleString("en-US",{maximumFractionDigits:0})," متبقي"]})]}),e.jsx("div",{className:"h-1.5 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner ring-1 ring-gray-200/50",children:e.jsx("div",{className:"h-full bg-gradient-to-l from-blue-500 to-blue-600 rounded-full transition-all duration-500 ease-out shadow-sm",style:{width:`${Math.min(J/Math.max(c,1)*100,100)}%`}})}),e.jsxs("div",{className:"flex justify-between mt-0.5",children:[e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["المستخدم: ",J.toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["الحد: ",c.toLocaleString("en-US",{maximumFractionDigits:0})]})]})]})]})]}),e.jsxs("div",{className:"space-y-1 pt-1.5 border-t border-gray-200",children:[e.jsx("div",{className:"flex items-center justify-between mb-0.5",children:e.jsx("span",{className:"text-sm font-bold text-gray-800",children:"الحدود اليومية"})}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-1 font-medium",children:[e.jsx("span",{className:"text-gray-700",children:"سحب يومي"}),e.jsxs("span",{className:"text-gray-600 dir-ltr",children:[Math.max(j-Ue,0).toLocaleString("en-US",{maximumFractionDigits:0})," متبقي"]})]}),e.jsx("div",{className:"h-1.5 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner ring-1 ring-gray-200/50",children:e.jsx("div",{className:"h-full bg-gradient-to-l from-orange-400 to-orange-500 rounded-full transition-all duration-500 ease-out",style:{width:`${Math.min(Ue/Math.max(j,1)*100,100)}%`}})}),e.jsxs("div",{className:"flex justify-between mt-0.5",children:[e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["المستخدم: ",Ue.toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["الحد: ",j.toLocaleString("en-US",{maximumFractionDigits:0})]})]})]}),e.jsx("div",{className:"w-[1px] bg-gray-200 self-stretch"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-1 font-medium",children:[e.jsx("span",{className:"text-gray-700",children:"تحويل يومي"}),e.jsxs("span",{className:"text-gray-600 dir-ltr",children:[Math.max(p-$,0).toLocaleString("en-US",{maximumFractionDigits:0})," متبقي"]})]}),e.jsx("div",{className:"h-1.5 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner ring-1 ring-gray-200/50",children:e.jsx("div",{className:"h-full bg-gradient-to-l from-green-500 to-green-600 rounded-full transition-all duration-500 ease-out",style:{width:`${Math.min($/Math.max(p,1)*100,100)}%`}})}),e.jsxs("div",{className:"flex justify-between mt-0.5",children:[e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["المستخدم: ",$.toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["الحد: ",p.toLocaleString("en-US",{maximumFractionDigits:0})]})]})]})]})]})]}):null})(),ce==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative group",children:[e.jsx($a,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-green-600 group-focus-within:text-green-700 transition-colors"}),e.jsx(V,{value:Ys,onChange:s=>Ua(s.target.value),onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("receiverPhoneInput");if(a)a.focus();else{const n=document.getElementById("amountInput");n==null||n.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-blue-600 focus:ring-1 focus:ring-blue-600 transition-all duration-200"})]})]}),!R&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative group",children:[e.jsx($a,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-green-600 group-focus-within:text-green-700 transition-colors"}),e.jsx(V,{id:"receiverPhoneInput",value:Ss,onChange:s=>{za(s.target.value),Vi&&Ar(!1)},onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("amountInput");a==null||a.focus()}},inputMode:"numeric",maxLength:11,placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-blue-600 focus:ring-1 focus:ring-blue-600 transition-all duration-200"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx($a,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(V,{value:U&&((Uc=Ke.find(s=>s.id===U))==null?void 0:Uc.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 text-sm lg:text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl transition-all duration-300"})]})]}),ce==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2 group",children:[e.jsx(es,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-yellow-600 group-focus-within:text-yellow-700 transition-colors"}),e.jsx(V,{id:"amountInput",value:cs,onChange:s=>{d(s.target.value),Vi&&Ar(!1)},onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("transferCommissionInput");if(a)a.focus();else{const n=document.getElementById("quickDebtButton");n==null||n.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-blue-600 focus:ring-1 focus:ring-blue-600 transition-all duration-200"})]}),Ds?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",Ds.debtorName," بمبلغ ",Ds.amount," جنيه"]}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>Ta(null),children:"إلغاء"})]}):null]}),(()=>{if(R)return null;const s=us();return s&&s.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",s==null?void 0:s.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(x,{id:"quickDebtButton",type:"button",variant:"destructive",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-medium",onClick:()=>{const n=us(),l=(n==null?void 0:n.defaultTransferCommission)!=null?Number(n.defaultTransferCommission):0,c=parseFloat(cs||"0")||0,h=Math.round((l||0)*c/1e3*100)/100,u=c+h;re((u||0).toString()),Tt?r({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):pe(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",className:"hidden",title:At?"العمولة تُضاف":"العمولة تُخصم",children:At?e.jsx(gs,{className:"h-4 w-4 text-green-600"}):e.jsx(xr,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:At?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1 group",children:[e.jsx(es,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-yellow-600 group-focus-within:text-yellow-700 transition-colors"}),e.jsx(V,{id:"transferCommissionInput",value:Is,onChange:n=>Li(n.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all duration-200"})]}),e.jsx(x,{type:"button",variant:"destructive",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-medium",onClick:()=>{const n=us(),l=parseFloat(cs||"0")||0;let c=0;if((n==null?void 0:n.defaultTransferCommission)!=null){const u=Number(n.defaultTransferCommission)||0;c=Math.round(u*l/1e3*100)/100}else{const u=Is&&Is.trim()!==""?parseFloat(Is):0;c=Math.max(0,u)}const h=l+c;re((h||0).toString()),Tt?r({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):pe(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",className:"hidden",title:At?"العمولة تُضاف":"العمولة تُخصم",children:At?e.jsx(gs,{className:"h-4 w-4 text-green-600"}):e.jsx(xr,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:At?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),(()=>{const s=Bn(Ys||"").replace(/\D/g,""),a=Bn(Ss||"").replace(/\D/g,"");return ce==="transfer"&&(s.startsWith("010")&&a.startsWith("010")||s.startsWith("010")&&(a.startsWith("011")||a.startsWith("012")||a.startsWith("015"))||s.startsWith("012")&&a.startsWith("010")||s.startsWith("011")&&a.startsWith("010")||s.startsWith("015")&&a.startsWith("010"))?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رسوم التحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(es,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-yellow-600"}),e.jsx(V,{id:"transferExtraFeeInput",value:xo,onChange:l=>cm(l.target.value),placeholder:"أدخل رسوم التحويل",type:"number",className:"pl-10 h-10 text-sm lg:text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"hidden",children:"تُخصم من المحفظة وتضاف للدرج — لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010"})]}):null})(),e.jsxs("div",{className:"sticky bottom-0 z-20 pt-2 pb-2 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 backdrop-blur supports-[backdrop-filter]:bg-white/90 dark:supports-[backdrop-filter]:bg-gray-900/90",children:[e.jsx(x,{id:"transferSubmitButton",onClick:Fc,className:"w-full h-12 text-base font-medium rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-none hover:shadow-md transition-all duration-200",children:Vi?"تم التحويل بنجاح":"تأكيد التحويل"}),dm&&e.jsxs("div",{className:"flex items-start gap-2 mt-2 px-1 animate-in fade-in slide-in-from-bottom-2",children:[e.jsx(Xc,{className:"h-4 w-4 text-amber-500 shrink-0 mt-0.5"}),e.jsxs("p",{className:"text-xs text-gray-500 leading-tight",children:["تم الوصول إلى 85% من الحد الشهري للمحفظة ",$i==null?void 0:$i.walletName]})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative group",children:[e.jsx(Br,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400 group-focus-within:text-primary transition-colors"}),e.jsx(V,{id:"amountInput",value:cs,onChange:s=>{d(s.target.value),ko&&tn(!1)},onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("manualWithdrawCommissionInput");if(a)a.focus();else{const n=document.getElementById("withdrawSubmitButton");n==null||n.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-primary focus:ring-1 focus:ring-primary transition-all duration-200"})]})]}),mm&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"اسم الراسل (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Tn,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-500"}),e.jsx(V,{id:"withdrawSenderNameInput",value:ee,onChange:s=>Z(s.target.value),onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("manualWithdrawCommissionInput");a==null||a.focus()}},placeholder:"أدخل اسم الراسل إن وجد",className:"pl-10 h-10 text-sm lg:text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white transition-all duration-300 hover:border-blue-400 focus:border-blue-500",type:"text"})]})]}),(()=>{const s=us();return s&&s.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",s==null?void 0:s.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(x,{type:"button",variant:"destructive",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-medium",onClick:()=>{const n=us(),l=parseFloat(cs||"0")||0,c=(n==null?void 0:n.defaultWithdrawCommission)!=null&&Number(n.defaultWithdrawCommission)||0,h=Math.round(c*l/1e3*100)/100,u=At?l+h:l;re((u||0).toString()),Tt?r({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):pe(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>Wi(n=>!n),title:At?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:At?e.jsx(gs,{className:"h-4 w-4"}):e.jsx(xr,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:At?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(es,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-yellow-600"}),e.jsx(V,{id:"manualWithdrawCommissionInput",value:Cs,onChange:n=>Ri(n.target.value),onKeyDown:n=>{if(n.key==="Enter"){const l=document.getElementById("withdrawSubmitButton");l==null||l.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(x,{type:"button",variant:"destructive",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-medium",onClick:()=>{const n=us(),l=parseFloat(cs||"0")||0;let c=0;if((n==null?void 0:n.defaultWithdrawCommission)!=null){const u=Number(n.defaultWithdrawCommission)||0;c=Math.round(u*l/1e3*100)/100}else{const u=Cs&&Cs.trim()!==""?parseFloat(Cs):Math.round(l*.01*100)/100;c=Math.max(0,u)}const h=At?l+c:l;re((h||0).toString()),Tt?r({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):pe(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",title:At?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>Wi(n=>!n),children:At?e.jsx(gs,{className:"h-4 w-4 text-green-600"}):e.jsx(xr,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:At?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),(S==null?void 0:S.showWithdrawNote)&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"ملاحظة السحب (اختياري)"}),e.jsxs("div",{className:"relative group",children:[e.jsx(ed,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400 group-focus-within:text-primary transition-colors"}),e.jsx(V,{id:"withdrawNoteInput",value:P,onChange:s=>B(s.target.value),onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("withdrawSubmitButton");a==null||a.focus()}},placeholder:"أدخل ملاحظة للسحب (اختياري)",className:"pl-10 h-10 text-base border-gray-400 rounded-xl focus:border-primary focus:ring-1 focus:ring-primary transition-all duration-200"})]})]}),e.jsx("div",{className:"sticky bottom-0 z-20 pt-2 pb-2 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 backdrop-blur supports-[backdrop-filter]:bg-white/90 dark:supports-[backdrop-filter]:bg-gray-900/90",children:e.jsx(x,{id:"withdrawSubmitButton",onClick:Fc,className:"w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:ko?"تم السحب بنجاح":"تأكيد السحب"})})]}),e.jsx(Te,{open:Ne,onOpenChange:pe,children:e.jsxs(Pe,{children:[e.jsxs(ke,{children:[e.jsx(_e,{children:"تحويل مؤجل"}),e.jsx(Ps,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[aa&&aa.length>0?e.jsxs("div",{children:[e.jsx(se,{children:"اختيار عميل"}),e.jsxs(Xa,{value:Os,onValueChange:s=>{pa(s);const a=aa.find(n=>n.id===s);a&&Oe(a.name)},children:[e.jsx(er,{className:"w-full",children:e.jsx(tr,{placeholder:"اختر عميل"})}),e.jsx(sr,{children:aa.map(s=>e.jsxs(fa,{value:s.id,children:[s.name,s.mobile?` — ${s.mobile}`:""]},s.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(se,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx(V,{id:"quickDebtName",value:be,onChange:s=>Oe(s.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(se,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx(V,{id:"quickDebtAmount",type:"number",value:Ae,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(se,{htmlFor:"quickDebtCommission",children:"العمولة (محسوبة تلقائياً)"}),e.jsx(V,{id:"quickDebtCommission",type:"number",value:function(){const s=us(),a=parseFloat((cs||"0").toString())||0;let n=0;if(ce==="transfer")if((s==null?void 0:s.defaultTransferCommission)!=null){const l=Number(s.defaultTransferCommission)||0;n=Math.round(l*a/1e3*100)/100}else{const l=Is&&Is.trim()!==""?parseFloat(Is):0;n=Math.max(0,l)}else if((s==null?void 0:s.defaultWithdrawCommission)!=null){const l=Number(s.defaultWithdrawCommission)||0;n=Math.round(l*a/1e3*100)/100}else{const l=Cs&&Cs.trim()!==""?parseFloat(Cs):Math.round(a*.01*100)/100;n=Math.max(0,l)}return String(n||0)}(),readOnly:!0,placeholder:"قيمة العمولة"})]}),e.jsxs("div",{children:[e.jsx(se,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx(V,{id:"quickDebtNotes",value:St,onChange:s=>ds(s.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(xt,{children:e.jsx(x,{type:"button",variant:"default",className:"bg-green-600 text-white hover:bg-green-700",onClick:()=>{const s=us(),a=parseFloat((cs||"").toString())||0;let n=0;if(ce==="transfer")if((s==null?void 0:s.defaultTransferCommission)!=null){const h=Number(s.defaultTransferCommission)||0;n=Math.round(h*a/1e3*100)/100}else{const h=Is&&Is.trim()!==""?parseFloat(Is):0;n=Math.max(0,h)}else if((s==null?void 0:s.defaultWithdrawCommission)!=null){const h=Number(s.defaultWithdrawCommission)||0;n=Math.round(h*a/1e3*100)/100}else{const h=Cs&&Cs.trim()!==""?parseFloat(Cs):Math.round(a*.01*100)/100;n=Math.max(0,h)}let l=0;if(ce==="withdraw"?l=At?a:Math.max(0,Math.round((a-n)*100)/100):l=Math.max(0,Math.round((a+n)*100)/100),!be||isNaN(l)||l<=0){r({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const c=aa.find(h=>h.id===Os);Ta({debtorName:be,amount:l,notes:St,customerId:Os||void 0,mobile:c==null?void 0:c.mobile}),Pa(!1),pe(!1),r({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx(Ut,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(qt,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(Wx,{isOpen:xm,onClose:()=>pm(!1),initialEditingWallet:gm,onWalletUpdate:async()=>{try{await Wl()}catch(s){console.error("Error reloading wallets after update:",s)}}}),e.jsx(Bx,{isOpen:bm,onClose:()=>wo(!1),transaction:ym,onDelete:Jh}),e.jsx(fs,{open:Sm,onOpenChange:Xr,onSuccess:Qh,title:Gh(),description:Zh(),mode:"verify"}),e.jsx(hd,{open:xh,onOpenChange:cc,onSuccess:eu,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:Mt,balanceLabel:"الرصيد النقدي",userId:t==null?void 0:t.uid}),e.jsx(hd,{open:ph,onOpenChange:dc,onSuccess:tu,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:Qs&&ct[Qs]||0,balanceLabel:`رصيد ${((zc=Ke.find(s=>s.id===Qs))==null?void 0:zc.name)||"المحفظة"}`,userId:t==null?void 0:t.uid}),e.jsx(Vx,{open:gh,onOpenChange:bl,onSuccess:su,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:Qs&&ct[Qs]||0,balanceLabel:`رصيد ${((qc=Ke.find(s=>s.id===Qs))==null?void 0:qc.name)||"المحفظة"}`,userId:t==null?void 0:t.uid}),e.jsx(Ux,{open:Ah,onOpenChange:Th,userId:t==null?void 0:t.uid}),e.jsx(zx,{open:Ph,onOpenChange:kh,userId:t==null?void 0:t.uid}),e.jsx(qx,{open:_h,onOpenChange:Oh}),e.jsx(Te,{open:bh,onOpenChange:ri,children:e.jsxs(Pe,{className:"sm:max-w-md",children:[e.jsx(ke,{children:e.jsx(_e,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(se,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(V,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:wl,onChange:s=>ni(s.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(x,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:async()=>{if(!await wi(_l)){r({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const s=parseFloat(wl);if(isNaN(s)||s<=0){r({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Mt+s;ns(a);const n={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(l,JSON.stringify(n)),t!=null&&t.uid?Ce.updateUserData(t.uid,n).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),ot(!1)}).catch(c=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",c),ot(!0)}):ot(!0),r({title:"تم بنجاح",description:`تم إضافة ${s} جنيه إلى الدرج النقدية وحفظه في السحابة`}),ri(!1),ni(""),di("")},children:[e.jsx(gs,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(x,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:async()=>{if(!await wi(_l)){r({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const s=parseFloat(wl);if(isNaN(s)||s<=0){r({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Mt-s;ns(a);const n={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(l,JSON.stringify(n)),t!=null&&t.uid?Ce.updateUserData(t.uid,n).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),ot(!1)}).catch(c=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",c),ot(!0)}):ot(!0),r({title:"تم بنجاح",description:`تم خصم ${s} جنيه من الدرج النقدية وحفظه في السحابة`}),ri(!1),ni(""),di("")},children:[e.jsx(xr,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",Mt.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(se,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx(V,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:_l,onChange:s=>di(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(xt,{className:"flex gap-2",children:e.jsx(x,{variant:"outline",onClick:()=>{ri(!1),ni(""),di("")},children:"إلغاء"})})]})}),e.jsx(Te,{open:Wh,onOpenChange:yi,children:e.jsxs(Pe,{className:"sm:max-w-md",children:[e.jsx(ke,{children:e.jsx(_e,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(ct).reduce((s,a)=>s+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(se,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(V,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل الرقم السري الرئيسي",value:Mc,onChange:s=>bi(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(xt,{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{yi(!1),bi("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",onClick:async()=>{if(!await ks.verifyMasterPin(Mc,t==null?void 0:t.uid)){r({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const a={};Object.keys(ct).forEach(h=>{a[h]=0}),ps(a),localStorage.setItem(is(),JSON.stringify(a)),yi(!1),bi("");const n=new Date().toISOString(),l={walletBalances:a,lastUpdated:n},c=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(c,JSON.stringify(l)),t!=null&&t.uid?Ce.updateUserData(t.uid,l).then(()=>{localStorage.removeItem(c),ot(!1)}).catch(h=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",h),ot(!0),r({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):ot(!0),setTimeout(()=>{ps({...a})},100)}catch(a){console.error("خطأ في تصفير أرصدة المحافظ:",a),r({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(Te,{open:fh,onOpenChange:ai,children:e.jsxs(Pe,{className:"sm:max-w-md",children:[e.jsx(ke,{children:e.jsx(_e,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((Vc=Ke.find(s=>s.id===U))==null?void 0:Vc.name)||U]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(U&&ct[U]?ct[U]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(se,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(V,{id:"resetSelectedWalletPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:mc,onChange:s=>vl(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(xt,{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{ai(!1),vl("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",onClick:async()=>{var a;if(!U){r({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await ks.verifyMasterPin(mc,t==null?void 0:t.uid)){r({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const n={...ct};n[U]=0,ps(n),localStorage.setItem(is(),JSON.stringify(n)),ai(!1),vl("");const l=new Date().toISOString(),c={walletBalances:n,lastUpdated:l},h=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(h,JSON.stringify(c)),t!=null&&t.uid?Ce.updateUserData(t.uid,c).then(()=>{localStorage.removeItem(h),ot(!1)}).catch(u=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",u),ot(!0),r({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):ot(!0),r({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((a=Ke.find(u=>u.id===U))==null?void 0:a.name)||U}`})}catch(n){console.error("خطأ في تصفير رصيد المحفظة المختارة:",n),r({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(Te,{open:Rh,onOpenChange:pi,children:e.jsxs(Pe,{className:"sm:max-w-md",children:[e.jsx(ke,{children:e.jsxs(_e,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(gs,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(ct).reduce((s,a)=>s+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx(V,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:Dc,onChange:s=>El(s.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx(V,{id:"addWalletTotalPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري",value:Cc,onChange:s=>Ml(s.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(xt,{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{pi(!1),El(""),Ml("")},children:"إلغاء"}),e.jsx(x,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:Ic,onClick:async()=>{const s=parseFloat(Dc);if(!s||s<=0){r({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!await qh(Cc)){r({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}Ac(!0);try{const a=Object.values(ct).reduce((n,l)=>n+l,0);if(a===0){const n=Object.keys(ct),l=s/n.length,c={};n.forEach(h=>{c[h]=l}),ps(c),localStorage.setItem(is(),JSON.stringify(c)),t!=null&&t.uid?await Ce.updateUserData(t.uid,{walletBalances:c,lastUpdated:new Date().toISOString()}):ot(!0)}else{const n={};Object.entries(ct).forEach(([l,c])=>{const h=c/a,u=s*h;n[l]=c+u}),ps(n),localStorage.setItem(is(),JSON.stringify(n)),t!=null&&t.uid?await Ce.updateUserData(t.uid,{walletBalances:n,lastUpdated:new Date().toISOString()}):ot(!0)}setTimeout(()=>{ps(n=>({...n}))},100),pi(!1),El(""),Ml("")}catch(a){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",a),r({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{Ac(!1)}},children:Ic?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(Te,{open:Bh,onOpenChange:vi,children:e.jsxs(Pe,{className:"sm:max-w-[425px]",children:[e.jsx(ke,{children:e.jsxs(_e,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(ys,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(se,{htmlFor:"resetCashPin",children:"الرقم السري الرئيسي"}),e.jsx(V,{id:"resetCashPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:Rl,onChange:s=>Ll(s.target.value)})]})]}),e.jsxs(xt,{children:[e.jsx(x,{variant:"outline",onClick:()=>{vi(!1),Ll("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",onClick:async()=>{if(!Rl){r({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await ks.verifyMasterPin(Rl,t==null?void 0:t.uid)){r({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{ns(0),vi(!1),Ll("");const a={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem(Xt(),"0"),localStorage.setItem(Xt()+"_lastUpdated",a.lastUpdated);const n=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(n,JSON.stringify(a)),t!=null&&t.uid?Ce.updateUserData(t.uid,a).then(()=>{localStorage.removeItem(n),ot(!1)}).catch(l=>{console.error("خطأ في حفظ الرصيد في Firebase:",l),ot(!0),r({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):ot(!0)}catch(a){console.error("خطأ في تصفير الرصيد النقدي:",a),r({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(Gx,{open:Mh,onOpenChange:Sc,userId:t==null?void 0:t.uid,cashBalance:Mt,walletBalances:ct,transactions:Ze}),e.jsx(Te,{open:Eh,onOpenChange:cn,children:e.jsxs(Pe,{className:"sm:max-w-[425px]",children:[e.jsx(ke,{children:e.jsxs(_e,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(gs,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx(V,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:hr,onChange:s=>mi(s.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{className:"text-right",children:"هل تريد إضافة ملاحظة؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{type:"button",variant:mn==="yes"?"default":"outline",onClick:()=>hn("yes"),className:"flex-1",children:"نعم"}),e.jsx(x,{type:"button",variant:mn==="no"?"default":"outline",onClick:async()=>{if(hn("no"),!hr||parseFloat(hr)<=0){r({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!dn){r({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await wi(dn)){r({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}ui(!0);try{const s=parseFloat(hr),a=Mt+s;ns(a);const n=new Date().toISOString();localStorage.setItem(Xt(),a.toString()),localStorage.setItem(Xt()+"_lastUpdated",n);const l={cashBalance:a,lastUpdated:n},c=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(c,JSON.stringify(l));const h=`CASHADD-${(t==null?void 0:t.uid)||"anon"}-${Date.now()}`;cn(!1),mi(""),hi(""),hn(null),xi("");const u=[];if(t!=null&&t.uid){u.push(Ce.updateUserData(t.uid,l).then(()=>{localStorage.removeItem(c),ot(!1)}).catch(()=>{ot(!0)}));const g={txnType:"cash_addition",type:"cash_addition",amount:s,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:h,title:"إيصال إضافة نقدية",merchantUserId:t.uid,createdBy:t.uid,shopId:(S==null?void 0:S.shopId)||void 0};u.push(Ce.saveUserTransaction(t.uid,g));const j=S==null?void 0:S.shopId;if(j){const p=ze(q,"dashboardData",j);u.push(Yt(p,{cashBalance:a}))}}Promise.allSettled(u).then(()=>{}).catch(()=>{})}catch{ns(Mt),localStorage.setItem("cashBalance",Mt.toString()),r({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{ui(!1)}},className:"flex-1",children:"لا"})]})]}),mn==="yes"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"addCashNote",children:"الملاحظة"}),e.jsx(V,{id:"addCashNote",type:"text",placeholder:"اكتب الملاحظة",value:Ol,onChange:s=>xi(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx(V,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:dn,onChange:s=>hi(s.target.value)})]})]}),e.jsxs(xt,{children:[e.jsx(x,{variant:"outline",onClick:()=>{cn(!1),mi(""),hi(""),hn(null),xi("")},children:"إلغاء"}),e.jsx(x,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:jc,onClick:async()=>{if(!hr||parseFloat(hr)<=0){r({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!dn){r({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await wi(dn)){r({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}if(mn==="yes"&&Ol.trim().length===0){r({title:"تنبيه",description:"أدخل الملاحظة أو اختر لا",variant:"destructive"});return}ui(!0);try{const s=parseFloat(hr),a=Mt+s;ns(a);const n=new Date().toISOString();localStorage.setItem(Xt(),a.toString()),localStorage.setItem(Xt()+"_lastUpdated",n);const l={cashBalance:a,lastUpdated:n},c=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(c,JSON.stringify(l));const h=`CASHADD-${(t==null?void 0:t.uid)||"anon"}-${Date.now()}`;cn(!1),mi(""),hi(""),hn(null),xi("");const u=[];if(t!=null&&t.uid){u.push(Ce.updateUserData(t.uid,l).then(()=>{localStorage.removeItem(c),ot(!1)}).catch(()=>{ot(!0)}));const g={txnType:"cash_addition",type:"cash_addition",amount:s,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:h,note:mn==="yes"?Ol.trim():void 0,title:"إيصال إضافة نقدية",merchantUserId:t.uid,createdBy:t.uid,shopId:(S==null?void 0:S.shopId)||void 0};u.push(Ce.saveUserTransaction(t.uid,g));const j=S==null?void 0:S.shopId;if(j){const p=ze(q,"dashboardData",j);u.push(Yt(p,{cashBalance:a}))}}Promise.allSettled(u).then(()=>{}).catch(()=>{})}catch{ns(Mt),localStorage.setItem("cashBalance",Mt.toString()),r({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{ui(!1)}},children:jc?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(Te,{open:uh,onOpenChange:yl,children:e.jsxs(Pe,{className:"sm:max-w-md",children:[e.jsx(ke,{children:e.jsx(_e,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(se,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx(V,{id:"search-date",type:"date",value:Vn,onChange:s=>To(s.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(se,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx(V,{id:"search-time",type:"time",value:Jn,onChange:s=>Po(s.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(xt,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>{To(""),Po(""),yl(!1)},children:"مسح"}),e.jsx(x,{onClick:()=>yl(!1),children:"تطبيق"})]})]})}),e.jsx(Hx,{isOpen:Om,onClose:()=>Ki(!1)}),e.jsx(Qx,{isOpen:zi,onClose:()=>Zr(!1),initialBarcode:hm}),e.jsx(Bu,{isOpen:Rm,onClose:()=>Yn(!1)}),e.jsx(Uu,{open:Lm,onOpenChange:Hn}),e.jsx(hp,{open:$m,onOpenChange:s=>{if(s&&!ja){r({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}Qn(s)}}),e.jsx(bp,{open:ie,onOpenChange:s=>{if(s&&!ja){r({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}me(s)}}),e.jsx(vp,{open:M,onOpenChange:s=>{if(s&&!ja){r({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}F(s)}}),e.jsx(fs,{open:wh,onOpenChange:fc,onSuccess:()=>Sl(!0),title:"تقاريرك",description:"أدخل الرقم السري الرئيسي للوصول إلى تقاريرك",mode:"verify"}),e.jsx(Te,{open:jl,onOpenChange:Sl,children:e.jsxs(Pe,{className:"sm:max-w-xl",children:[e.jsxs(ke,{children:[e.jsxs(_e,{className:"flex items-center gap-2",children:[e.jsx(ad,{className:"h-4 w-4 text-blue-600"}),"تقارير اليوم"]}),e.jsx(Ps,{children:"ملخص معاملات اليوم محفوظ لآخر 30 يومًا مع أرشفة في السحابة"})]}),e.jsxs("div",{className:"space-y-4",children:[(()=>{const s=new Date().toDateString(),a=Ze.filter(g=>{const j=new Date(g.createdAt).toDateString(),p=String(g.status||"completed").toLowerCase();return j===s&&(p==="completed"||p==="confirmed")}),n=a.length,l=a.reduce((g,j)=>g+Number(j.amount||0),0),c=a.filter(g=>g.type==="withdraw").reduce((g,j)=>g+Number(j.amount||0),0),h=a.filter(g=>g.type==="send").reduce((g,j)=>g+Number(j.amount||0),0),u=a.reduce((g,j)=>g+Number(Ls.calculateTransactionProfit(j)||0),0);return e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-blue-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-blue-700",children:"عدد المعاملات"}),e.jsx("div",{className:"text-lg font-bold text-blue-800",children:n})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-indigo-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-indigo-700",children:"إجمالي المبالغ"}),e.jsx("div",{className:"text-lg font-bold text-indigo-800",children:Number(l).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-red-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-red-700",children:"المبالغ المسحوبة"}),e.jsx("div",{className:"text-lg font-bold text-red-800",children:Number(c).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-green-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-green-700",children:"المبالغ المرسلة"}),e.jsx("div",{className:"text-lg font-bold text-green-800",children:Number(h).toFixed(2)})]}),e.jsxs("div",{className:"col-span-2 rounded-lg p-3 bg-gradient-to-r from-amber-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-amber-700",children:"الأرباح"}),e.jsx("div",{className:"text-lg font-bold text-amber-800",children:Number(u).toFixed(2)})]})]})})(),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(x,{variant:"default",onClick:async()=>{try{if(!(t!=null&&t.uid))return;const s=new Date,a=s.getFullYear(),n=String(s.getMonth()+1).padStart(2,"0"),l=String(s.getDate()).padStart(2,"0"),c=`${a}-${n}-${l}`,h=s.toDateString(),u=Ze.filter(T=>{const A=new Date(T.createdAt).toDateString(),J=String(T.status||"completed").toLowerCase();return A===h&&(J==="completed"||J==="confirmed")}),g=u.length,j=u.reduce((T,A)=>T+Number(A.amount||0),0),p=u.filter(T=>T.type==="withdraw").reduce((T,A)=>T+Number(A.amount||0),0),v=u.filter(T=>T.type==="send").reduce((T,A)=>T+Number(A.amount||0),0),I=u.reduce((T,A)=>T+Number(Ls.calculateTransactionProfit(A)||0),0);await vn.add({userId:t.uid,reportDate:c,totalTransactions:g,totalAmount:Number(j.toFixed(2)),totalWithdrawn:Number(p.toFixed(2)),totalSent:Number(v.toFixed(2)),profit:Number(I.toFixed(2)),walletId:null});try{await vn.trimToMaxCount(t.uid,30)}catch{}r({title:"تم الأرشفة",description:`تم حفظ تقرير ${c}`})}catch{r({title:"فشل الأرشفة",description:"تعذر حفظ التقرير",variant:"destructive"})}},children:"أرشفة اليوم"}),e.jsx(x,{variant:"outline",onClick:()=>Sl(!1),children:"إغلاق"})]}),e.jsx("div",{className:"mt-2 border-t pt-2",children:e.jsx("div",{className:"space-y-2 max-h-[40vh] overflow-auto",children:yc.length===0?e.jsx("div",{className:"text-xs text-muted-foreground",children:"لا توجد تقارير محفوظة"}):yc.map(s=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:s.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",s.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:Number(s.totalAmount).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:Number(s.totalWithdrawn).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:Number(s.totalSent).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:Number(s.profit??0).toFixed(2)})]})]})]},s.id||`${s.userId}-${s.reportDate}`))})})]})]})}),e.jsx(Te,{open:vh,onOpenChange:s=>{if(s){r({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}Nl(!1)},children:e.jsxs(Pe,{dir:"rtl",className:"sm:max-w-md w-[95vw] sm:w-auto rounded-2xl border border-emerald-200 shadow-xl bg-gradient-to-br from-white via-green-50 to-emerald-50 backdrop-blur-md data-[state=open]:animate-in data-[state=open]:fade-in-0 data-[state=open]:zoom-in-90 data-[state=open]:slide-in-from-bottom-8 duration-300",children:[e.jsxs(ke,{children:[e.jsx(_e,{className:"text-right text-green-700",children:"شحن رصيد الموبايل"}),e.jsx(Ps,{className:"text-right text-gray-600",children:"أدخل البيانات ثم اضغط تأكيد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(se,{htmlFor:"topupPhone",className:"text-right block",children:"رقم الموبايل"}),e.jsx(V,{id:"topupPhone",value:ii,onChange:s=>hc(s.target.value),placeholder:"010xxxxxxx",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx(se,{className:"text-right block",children:"شركة التشغيل"}),e.jsxs(Xa,{value:li,onValueChange:uc,children:[e.jsx(er,{className:"text-right",children:e.jsx(tr,{placeholder:"اختر الشركة"})}),e.jsxs(sr,{children:[e.jsx(fa,{value:"vodafone",children:"فودافون"}),e.jsx(fa,{value:"orange",children:"أورنج"}),e.jsx(fa,{value:"etisalat",children:"اتصالات"}),e.jsx(fa,{value:"we",children:"WE"})]})]})]}),e.jsxs("div",{children:[e.jsx(se,{htmlFor:"topupAmount",className:"text-right block",children:"المبلغ بالجنيه"}),e.jsx(V,{id:"topupAmount",type:"number",value:oi,onChange:s=>xc(s.target.value?Number(s.target.value):""),placeholder:"50",className:"text-right"})]})]}),e.jsxs(xt,{className:"flex gap-2 justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>Nl(!1),className:"border-gray-300",children:"إلغاء"}),e.jsx(x,{onClick:N,disabled:pc||!ii||!li||!oi,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:pc?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})}),e.jsx(fs,{open:Hm,onOpenChange:Qi,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{Qi(!1),Pr(!0)}}),e.jsx(fs,{open:Gm,onOpenChange:Bo,mode:"verify",title:"تأكيد تغيير طلب الرقم السري للديون",description:"أدخل الرقم السري الرئيسي لتفعيل أو إلغاء طلب الرقم السري عند فتح الديون",onSuccess:async()=>{if(Uo!==null){const s=Uo;Wo(s);try{const a=t==null?void 0:t.uid,n=a?`debtsPinRequired_${a}`:"debtsPinRequired";localStorage.setItem(n,String(s)),a&&await Ce.updateUserData(a,{debtsPinRequired:s})}catch{}r({title:s?"تم تفعيل طلب الرقم السري للديون":"تم إلغاء طلب الرقم السري للديون",description:s?"سيُطلب الرقم السري الرئيسي عند فتح نافذة الديون.":"يمكن فتح نافذة الديون بدون طلب الرقم السري."})}Zm(null),Bo(!1)}}),e.jsx(Eu,{open:yh,onOpenChange:on,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"سيتم حذف كل المعاملات السابقة نهائيًا من حسابك وFirebase.",onSuccess:async()=>{try{if(!(t!=null&&t.uid)){on(!1);return}const s=new Date,a=l=>l instanceof Date?l:typeof(l==null?void 0:l.toDate)=="function"?l.toDate():new Date(String(l)),n=Ze.filter(l=>a(l.createdAt)<s);await Ce.updateUserData(t.uid,{recentReset:{keepLastCount:Pc.keepLastCount??30,intervalDays:Pc.intervalDays??7,lastResetAt:s}}),gi(l=>({...l,lastResetAt:s})),r({title:"تم إخفاء المعاملات السابقة",description:"تم إخفاء كل الإيصالات الأقدم من وقت التصفير من العرض بدون التأثير على تقارير اليوم/الشهر أو الحدود."})}catch(s){console.error("فشل تنفيذ التصفير النهائي:",s),r({title:"فشل التصفير",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}finally{on(!1)}}}),e.jsx(fs,{open:Ia,onOpenChange:Js,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{Js(!1),ss(!0)}}),e.jsx(Te,{open:Ym,onOpenChange:Pr,children:e.jsxs(Pe,{className:"sm:max-w-[425px]",children:[e.jsxs(ke,{className:"flex items-center justify-between",children:[e.jsx(_e,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx(id,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[Hh," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(x,{variant:kr==="debtor"?"default":"outline",onClick:()=>Jo("debtor"),children:"مدين"}),e.jsx(x,{variant:kr==="creditor"?"default":"outline",onClick:()=>Jo("creditor"),children:"دائن"})]}),kr==="creditor"&&e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(se,{htmlFor:"debtorName",className:"text-right col-span-1",children:"اسم المديون"}),e.jsx(V,{id:"debtorName",value:Gi,onChange:s=>zo(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل اسم المديون"})]}),kr&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(se,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(V,{id:"debtAmount",type:"number",value:Zi,onChange:s=>qo(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(se,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx(V,{id:"debtReason",value:Xi,onChange:s=>Vo(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]})]}),e.jsx(xt,{children:e.jsx(x,{onClick:()=>{const s=kr==="debtor",a=kr==="creditor";if(!s&&!a){r({title:"اختر نوع الدين",description:"يرجى اختيار مدين أو دائن أولاً",variant:"destructive"});return}if(!Zi||!Xi||a&&!Gi){r({title:"بيانات غير مكتملة",description:a?"يرجى إدخال الاسم والمبلغ والسبب":"يرجى إدخال المبلغ والسبب",variant:"destructive"});return}const n={id:Date.now().toString(),debtorName:s?"مدين":Gi,amount:parseFloat(Zi),reason:Xi,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};rn(n),_r(!0)},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(x,{variant:"outline",className:"w-full",onClick:()=>dr(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(x,{variant:"outline",className:"w-full",onClick:()=>ll(!0),children:"إضافة عميل"})})]})}),e.jsx(Te,{open:al,onOpenChange:dr,children:e.jsxs(Pe,{className:"w-[95vw] sm:w-auto sm:max-w-[520px] rounded-2xl",children:[e.jsxs(ke,{children:[e.jsx(_e,{className:"text-right",children:"إيصالات الديون"}),e.jsx(Ps,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),Dt.length>0?e.jsxs("div",{className:"max-h-[70vh] overflow-y-auto overscroll-contain scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 space-y-2 px-1 -mx-1 sm:mx-0 sm:px-0",style:{contain:"layout paint"},onScroll:s=>{const a=s.currentTarget;nl.length<Dt.length&&a.scrollTop+a.clientHeight>=a.scrollHeight-50&&rl(n=>n+1)},children:[nl.map(s=>e.jsx("div",{onClick:()=>{Va(s),Ja(!0),dr(!1),Pr(!1)},className:"p-4 sm:p-3 border rounded-xl cursor-pointer hover:bg-gray-50 transition-colors min-h-[64px]",children:e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:justify-between sm:items-center",children:[e.jsxs("div",{className:"text-right space-y-0.5",children:[e.jsx("p",{className:"font-medium text-[14px] sm:text-sm",children:s.debtorName}),e.jsx("p",{className:"text-[13px] sm:text-sm text-gray-600",children:s.reason}),e.jsx("p",{className:"text-[12px] sm:text-sm text-gray-500",children:ji.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-xl sm:text-lg",children:[s.amount," جنيه"]}),e.jsx(bs,{variant:s.status==="paid"?"default":"secondary",className:`${s.status==="paid"?"bg-green-500":"bg-yellow-500"} text-[12px] sm:text-xs`,children:s.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},s.id)),nl.length<Dt.length&&e.jsx("div",{className:"flex justify-center pt-1",children:e.jsx(x,{variant:"outline",size:"sm",onClick:()=>rl(s=>s+1),children:"تحميل المزيد"})})]}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"}),e.jsxs(xt,{className:"flex justify-between mt-3",children:[e.jsx(x,{variant:"destructive",onClick:async()=>{try{if(!Dt||Dt.length===0){r({title:"لا توجد ديون",description:"القائمة فارغة بالفعل."});return}if(!window.confirm("هل تريد حذف كل إيصالات الديون؟ هذا الإجراء لا يمكن التراجع عنه."))return;const a=[];if(As(a),Va(null),await oa(a),t!=null&&t.uid)try{await Ce.updateUserData(t.uid,{debts:[],debtsDeletedAt:bt()});try{localStorage.removeItem(`debts_unsynced_${t.uid}`)}catch{}}catch(n){console.error("تعذر حذف الديون من Firebase:",n),r({title:"فشل الحذف من السحابة",description:"تعذر حذف الإيصالات من Firebase، حاول مرة أخرى.",variant:"destructive"});return}r({title:"تم حذف كل إيصالات الديون",description:"تم تفريغ القائمة بالكامل."}),dr(!1)}catch(s){console.error("تعذر حذف كل إيصالات الديون:",s),r({title:"فشل الحذف",description:"حدث خطأ أثناء الحذف، حاول مرة أخرى.",variant:"destructive"})}},children:"حذف كل الإيصالات"}),e.jsx(x,{variant:"outline",onClick:()=>dr(!1),children:"إغلاق"})]})]})}),e.jsx(Te,{open:ah,onOpenChange:ll,children:e.jsxs(Pe,{className:"sm:max-w-[480px]",children:[e.jsxs(ke,{children:[e.jsx(_e,{className:"text-right",children:"إضافة عميل"}),e.jsx(Ps,{className:"text-right",children:"أدخل بيانات العميل ثم يمكنك تسجيل مبلغ دين عليه"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(se,{htmlFor:"customerName",className:"text-right col-span-1",children:"اسم العميل"}),e.jsx(V,{id:"customerName",value:cl,onChange:s=>Zo(s.target.value),className:"col-span-3 text-right",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(se,{htmlFor:"customerMobile",className:"text-right col-span-1",children:"رقم الموبايل"}),e.jsx(V,{id:"customerMobile",value:dl,onChange:s=>Xo(s.target.value),className:"col-span-3 text-right",placeholder:"اكتب رقم الموبايل"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(x,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!cl||!dl){r({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const s={id:Date.now().toString(),name:cl.trim(),mobile:dl.trim(),createdAt:new Date},a=[s,...aa];await Tl(a),Zo(""),Xo(""),r({title:"تمت إضافة العميل",description:`تم إضافة ${s.name}`})},children:"إضافة"})}),e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx(se,{className:"text-right block",children:"إضافة مبلغ على عميل"}),aa.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(Xa,{value:Xn,onValueChange:ec,children:[e.jsx(er,{className:"w-full",children:e.jsx(tr,{placeholder:"اختر عميل"})}),e.jsx(sr,{children:aa.map(s=>e.jsxs(fa,{value:s.id,children:[s.name," — ",s.mobile]},s.id))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(se,{htmlFor:"customerDebtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(V,{id:"customerDebtAmount",type:"number",value:tc,onChange:s=>rh(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(x,{className:"bg-orange-600 hover:bg-orange-700",onClick:async()=>{const s=parseFloat(tc);if(!Xn){r({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(s)||s<=0){r({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=aa.find(l=>l.id===Xn);if(!a)return;const n={id:Date.now().toString(),debtorName:a.name,customerId:a.id,mobile:a.mobile,amount:Number(s.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};rn(n),_r(!0)},children:"إضافة المبلغ"})})]}):e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد عملاء مسجلين. أضف عميلًا أولاً."})]}),e.jsxs("div",{className:"border-t pt-4 space-y-2",children:[e.jsx(se,{className:"text-right block",children:"إدارة العملاء"}),aa.length>0?e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:aa.map(s=>e.jsxs("div",{className:"p-2 border rounded-md flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium text-sm",children:s.name}),e.jsx("div",{className:"text-xs text-gray-600",children:s.mobile})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:()=>{sc(s.id),ml(s.name||""),hl(s.mobile||""),ei(!0)},children:"تعديل"}),e.jsx(x,{variant:"destructive",size:"sm",onClick:()=>{ul(s.id),xl(s.name||""),ti(!0)},children:"حذف نهائي"})]})]},s.id))}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً."})]})]}),e.jsx(xt,{className:"flex justify-end",children:e.jsx(x,{variant:"outline",onClick:()=>ll(!1),children:"إغلاق"})})]})}),e.jsx(Te,{open:lh,onOpenChange:ti,children:e.jsxs(Pe,{hideClose:!0,className:"sm:max-w-[420px] rounded-2xl bg-gradient-to-br from-white via-rose-50 to-red-50 shadow-2xl border border-red-100 text-center",children:[e.jsxs(ke,{children:[e.jsx(_e,{className:"text-center text-xl font-bold text-red-700",children:"تأكيد حذف العميل"}),e.jsxs(Ps,{className:"text-center text-gray-600",children:["سيتم حذف العميل نهائيًا: ",nc]})]}),e.jsx("div",{className:"py-2 text-sm text-gray-700",children:"لا يمكن التراجع عن هذا الإجراء."}),e.jsxs(xt,{className:"flex justify-center gap-3",children:[e.jsx(x,{variant:"outline",onClick:()=>{ti(!1),ul(""),xl("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",className:"bg-red-600 hover:bg-red-700",onClick:async()=>{const s=oh,a=aa.filter(n=>n.id!==s);await Tl(a),Xn===s&&ec(""),ti(!1),ul(""),xl(""),r({title:"تم حذف العميل",description:nc})},children:"حذف نهائي"})]})]})}),e.jsx(Te,{open:nh,onOpenChange:ei,children:e.jsxs(Pe,{className:"sm:max-w-[420px]",children:[e.jsx(ke,{children:e.jsx(_e,{className:"text-right",children:"تعديل بيانات العميل"})}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(se,{htmlFor:"editCustomerName",className:"text-right col-span-1",children:"الاسم"}),e.jsx(V,{id:"editCustomerName",value:ac,onChange:s=>ml(s.target.value),className:"col-span-3 text-right"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(se,{htmlFor:"editCustomerMobile",className:"text-right col-span-1",children:"الموبايل"}),e.jsx(V,{id:"editCustomerMobile",value:rc,onChange:s=>hl(s.target.value),className:"col-span-3 text-right"})]})]}),e.jsxs(xt,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>ei(!1),children:"إلغاء"}),e.jsx(x,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const s=ih,a=ac.trim(),n=rc.trim();if(!s||!a||!n){r({title:"بيانات غير مكتملة",description:"أدخل الاسم ورقم الموبايل",variant:"destructive"});return}const l=aa.map(h=>h.id===s?{...h,name:a,mobile:n}:h);await Tl(l);const c=Dt.map(h=>h.customerId===s?{...h,debtorName:a,mobile:n}:h);c!==Dt&&(As(c),await oa(c)),ei(!1),sc(""),ml(""),hl(""),r({title:"تم تحديث العميل",description:a})},children:"حفظ"})]})]})}),e.jsx(Te,{open:hs,onOpenChange:ss,children:e.jsxs(Pe,{className:"sm:max-w-[520px]",children:[e.jsxs(ke,{children:[e.jsx(_e,{className:"text-right",children:"مصروفات المحل"}),e.jsx(Ps,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(se,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx(V,{id:"expenseName",value:va,onChange:s=>ws(s.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(se,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx(V,{id:"expenseAmount",type:"number",value:O,onChange:s=>fe(s.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(se,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx(V,{id:"expenseNotes",value:ge,onChange:s=>Fe(s.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(xt,{className:"flex justify-between",children:[e.jsx(x,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!va||!O){r({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}H(!0)},children:"إضافة مصروف"}),e.jsx(x,{variant:"outline",onClick:()=>la(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(Te,{open:sa,onOpenChange:la,children:e.jsxs(Pe,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(ke,{children:[e.jsx(_e,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(Ps,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),Ve.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:Ve.map(s=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:s.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:s.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(s.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left flex items-start gap-2",children:[e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[s.amount," جنيه"]}),e.jsx(bs,{variant:"secondary",className:s.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:s.source==="cash"?"من النقدية":`من المحفظة${s.walletId?` (${s.walletId})`:""}`})]}),e.jsxs(x,{variant:"destructive",size:"sm",className:"shrink-0",onClick:()=>Sh(s.id),title:"حذف نهائي",children:[e.jsx(ys,{className:"w-4 h-4 ml-1"}),"حذف"]})]})]})},s.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(Te,{open:Nt,onOpenChange:H,children:e.jsxs(Pe,{className:"sm:max-w-[480px]",children:[e.jsx(ke,{children:e.jsx(_e,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(x,{variant:ye==="cash"?"default":"outline",className:ye==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>G("cash"),children:"الفلوس النقدية"}),e.jsx(x,{variant:ye==="wallet"?"default":"outline",className:ye==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>G("wallet"),children:"أرصدة المحافظ"}),e.jsx(x,{variant:ye==="fawry"?"default":"outline",className:ye==="fawry"?"bg-amber-600 hover:bg-amber-700 text-white":"",onClick:()=>G("fawry"),children:"فوري"})]}),ye==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(Xa,{value:ht,onValueChange:It,children:[e.jsx(er,{className:"w-full",children:e.jsx(tr,{placeholder:"اختر محفظة"})}),e.jsx(sr,{children:Ke.map(s=>e.jsx(fa,{value:s.id,children:s.phone||s.name||s.id},s.id))})]})]})]}),e.jsxs(xt,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>{H(!1),G(null),It("")},children:"إلغاء"}),e.jsx(x,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const s=Number(O);if(isNaN(s)||s<=0){r({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!ye){r({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(ye==="cash"){const c=Number((Mt-s).toFixed(2));ns(c),localStorage.setItem(Xt(),c.toString());const h={cashBalance:c,lastUpdated:new Date().toISOString()},u=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(u,JSON.stringify(h)),t!=null&&t.uid?(await Ce.updateUserData(t.uid,h),localStorage.removeItem(u),ot(!1)):ot(!0)}else if(ye==="wallet"){if(!ht){r({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const c=ct[ht]||0,h=Number((c-s).toFixed(2)),u={...ct,[ht]:h};ps(u);const g=new Date().toISOString(),j={walletBalances:u,lastUpdated:g},p=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(p,JSON.stringify(j)),localStorage.setItem(is(),JSON.stringify(u)),localStorage.setItem(`walletBalances_backup_${g}`,JSON.stringify(u)),t!=null&&t.uid&&Ce.updateUserData(t.uid,j).catch(()=>{})}}catch(c){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",c)}let a=Date.now().toString();try{if(t!=null&&t.uid){const{addDoc:c,collection:h,serverTimestamp:u}=await wt(async()=>{const{addDoc:p,collection:v,serverTimestamp:I}=await import("./index-DA5EGBVC.js").then(T=>T.c4);return{addDoc:p,collection:v,serverTimestamp:I}},__vite__mapDeps([0,1]),import.meta.url),{db:g}=await wt(async()=>{const{db:p}=await import("./index-DA5EGBVC.js").then(v=>v.c5);return{db:p}},__vite__mapDeps([0,1]),import.meta.url);a=(await c(h(g,"shop_expenses"),{userId:t.uid,shopId:_||(S==null?void 0:S.shopId)||t.uid||"default-shop",name:va,amount:s,notes:ge||"",source:ye,walletId:ye==="wallet"?ht:null,createdAt:u()})).id}}catch(c){console.error("خطأ أثناء حفظ المصروف في Firestore:",c)}const n={id:a,name:va,amount:s,notes:ge,source:ye,walletId:ye==="wallet"?ht:void 0,createdAt:new Date},l=[...Ve,n];await vc(l),ws(""),fe(""),Fe(""),G(null),It(""),H(!1),ss(!0),la(!0),r({title:"تم إضافة المصروف",description:ye==="cash"?"تم الخصم من النقدية":ye==="wallet"?"تم الخصم من أرصدة المحافظ":"تم تسجيل الدفع عبر فوري"})},children:"تأكيد الخصم"})]})]})}),e.jsx(Te,{open:Hr,onOpenChange:Aa,children:e.jsxs(Pe,{className:"sm:max-w-[520px]",children:[e.jsxs(ke,{children:[e.jsx(_e,{className:"text-right",children:"النواقص"}),e.jsx(Ps,{className:"text-right",children:"سجل العناصر الناقصة التي تحتاج شراء وتابع حالتها."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(se,{htmlFor:"deficiencyName",className:"text-right col-span-1",children:"اسم العنصر"}),e.jsx(V,{id:"deficiencyName",value:z,onChange:s=>Se(s.target.value),className:"col-span-3 text-right",placeholder:"مثال: سكر، زيت، مناديل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(se,{htmlFor:"deficiencyQuantity",className:"text-right col-span-1",children:"الكمية"}),e.jsx(V,{id:"deficiencyQuantity",type:"number",value:jt,onChange:s=>ft(s.target.value),className:"col-span-3 text-right",placeholder:"1"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(x,{className:"bg-rose-600 hover:bg-rose-700",onClick:()=>{if(Tt){r({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}const s=parseInt(jt||"1",10);if(!z){r({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العنصر",variant:"destructive"});return}if(isNaN(s)||s<=0){r({title:"كمية غير صحيحة",description:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}(async()=>{if(t!=null&&t.uid)try{const{collection:n,addDoc:l,serverTimestamp:c}=await wt(async()=>{const{collection:g,addDoc:j,serverTimestamp:p}=await import("./index-DA5EGBVC.js").then(v=>v.c4);return{collection:g,addDoc:j,serverTimestamp:p}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await wt(async()=>{const{db:g}=await import("./index-DA5EGBVC.js").then(j=>j.c5);return{db:g}},__vite__mapDeps([0,1]),import.meta.url),u=await l(n(h,"deficiencies"),{userId:t.uid,shopId:_||(S==null?void 0:S.shopId)||t.uid||"default-shop",name:z,quantity:s,status:"pending",createdAt:c()});try{const g=ci(),j=localStorage.getItem(g),p=j?JSON.parse(j):[],v=Array.isArray(p)?p:[],I=v.some(J=>String((J==null?void 0:J.id)||"")===u.id),T={id:u.id,name:z,quantity:s,status:"pending",createdAt:new Date().toISOString()},A=I?v:[...v,T];localStorage.setItem(g,JSON.stringify(A))}catch{}Se(""),ft(""),r({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"});return}catch(n){console.warn("فشل حفظ النواقص إلى Firestore، سيُستخدم التخزين المحلي:",n)}const a={id:Date.now().toString(),name:z,quantity:s,status:"pending",createdAt:new Date};rs(n=>{const l=[...n,a];return Al(l),l}),Se(""),ft(""),r({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"})})()},children:"إضافة للنواقص"})}),js.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:js.map(s=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:s.name}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["الكمية: ",s.quantity]}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(s.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(bs,{variant:"secondary",className:s.status==="pending"?"bg-rose-100 text-rose-700":"bg-green-100 text-green-700",children:s.status==="pending"?"قيد الشراء":"تم الشراء"}),e.jsx(x,{variant:"outline",className:s.status==="pending"?"text-green-700 border-green-300 hover:bg-green-50":"text-rose-700 border-rose-300 hover:bg-rose-50",onClick:()=>{(async()=>{const a=s.status==="pending"?"purchased":"pending";if(t!=null&&t.uid)try{const{doc:n,updateDoc:l,serverTimestamp:c}=await wt(async()=>{const{doc:u,updateDoc:g,serverTimestamp:j}=await import("./index-DA5EGBVC.js").then(p=>p.c4);return{doc:u,updateDoc:g,serverTimestamp:j}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await wt(async()=>{const{db:u}=await import("./index-DA5EGBVC.js").then(g=>g.c5);return{db:u}},__vite__mapDeps([0,1]),import.meta.url);await l(n(h,"deficiencies",s.id),{status:a,updatedAt:c()});return}catch(n){console.warn("فشل تحديث حالة النواقص على Firestore، استخدام التخزين المحلي:",n)}rs(n=>{const l=n.map(c=>c.id===s.id?{...c,status:a}:c);return Al(l),l})})()},title:s.status==="pending"?"تم الشراء":"إلغاء الشراء",children:s.status==="pending"?"تم الشراء":"إلغاء الشراء"}),e.jsx(x,{variant:"outline",className:"text-red-700 border-red-300 hover:bg-red-50",onClick:()=>{(async()=>{if(t!=null&&t.uid)try{const{doc:a,deleteDoc:n}=await wt(async()=>{const{doc:c,deleteDoc:h}=await import("./index-DA5EGBVC.js").then(u=>u.c4);return{doc:c,deleteDoc:h}},__vite__mapDeps([0,1]),import.meta.url),{db:l}=await wt(async()=>{const{db:c}=await import("./index-DA5EGBVC.js").then(h=>h.c5);return{db:c}},__vite__mapDeps([0,1]),import.meta.url);await n(a(l,"deficiencies",s.id));return}catch(a){console.warn("فشل حذف عنصر النواقص من Firestore، استخدام التخزين المحلي:",a)}rs(a=>{const n=a.filter(l=>l.id!==s.id);return Al(n),n})})()},title:"حذف",children:"حذف"})]})]})},s.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد عناصر مسجلة في النواقص"})]}),e.jsx(xt,{className:"flex justify-end",children:e.jsx(x,{variant:"outline",onClick:()=>Aa(!1),children:"إغلاق"})})]})}),e.jsx(Te,{open:ch,onOpenChange:_r,children:e.jsxs(Pe,{className:"sm:max-w-[480px]",children:[e.jsx(ke,{children:e.jsx(_e,{className:"text-right",children:(Zt==null?void 0:Zt.type)==="decrease"?"اختيار مكان إضافة مبلغ السداد":"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:(Zt==null?void 0:Zt.type)==="decrease"?"اختر هل تريد إضافة مبلغ السداد إلى الرصيد النقدي أم إلى إحدى المحافظ أو تسجيله بدون خصم.":"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(x,{variant:Ms==="cash"?"default":"outline",className:Ms==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>nn("cash"),children:"الفلوس النقدية"}),e.jsx(x,{variant:Ms==="wallet"?"default":"outline",className:Ms==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>nn("wallet"),children:"أرصدة المحافظ"}),e.jsx(x,{variant:Ms==="none"?"default":"outline",className:Ms==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>nn("none"),children:(Zt==null?void 0:Zt.type)==="decrease"?"بدون إضافة":"بدون خصم"})]}),Ms==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{className:"text-right block",children:(Zt==null?void 0:Zt.type)==="decrease"?"اختر المحفظة للإضافة":"اختر المحفظة للخصم"}),e.jsxs(Xa,{value:ln,onValueChange:pl,children:[e.jsx(er,{className:"w-full",children:e.jsx(tr,{placeholder:"اختر محفظة"})}),e.jsx(sr,{children:Ke.map(s=>e.jsx(fa,{value:s.id,children:s.phone||s.name||s.id},s.id))})]})]})]}),e.jsxs(xt,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>{_r(!1),rn(null),nn(null),pl("")},children:"إلغاء"}),e.jsx(x,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const s=!!Zt,a=s&&(Zt==null?void 0:Zt.type)==="decrease",n=Number(s?Zt.delta:(mr==null?void 0:mr.amount)||0);if(!Ms){r({title:a?"اختر مكان الإضافة":"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}const l=new Date().toISOString();let c=Mt,h=ct,u=!1,g=!1;try{if(Ms==="cash")c=Number(a?(Mt+n).toFixed(2):(Mt-n).toFixed(2)),u=!0;else if(Ms==="wallet"){if(!ln){r({title:"اختر محفظة",description:a?"يرجى اختيار محفظة للإضافة":"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const A=ct[ln]||0,J=Number(a?(A+n).toFixed(2):(A-n).toFixed(2));h={...ct,[ln]:J},g=!0}}catch(A){console.error("Error calculating balances:",A);return}let j=[...Dt],p=te,v=!1;if(s){if(!te)return;const A=Number(te.amount||0),J=Number(te.paidAmount||0),Ue=Number(Zt.delta||0);if(Zt.type==="decrease"){const $=Number((A-Ue).toFixed(2)),K=J>=$,oe={...te,amount:$,status:K?"paid":"pending"};if(j=Dt.map(st=>st.id===te.id?oe:st),p=oe,v=!0,K&&(t!=null&&t.uid)&&(async()=>{try{const[st,Wt,Vt]=[Ye(je(q,"userTransactions"),he("userId","==",t.uid),he("linkedDebtId","==",te.id),he("status","==","pending")),Ye(je(q,"transactions"),he("userId","==",t.uid),he("linkedDebtId","==",te.id),he("status","==","pending")),Ye(je(q,"transactions"),he("merchantUserId","==",t.uid),he("linkedDebtId","==",te.id),he("status","==","pending"))],[Ws,ca,Gs]=await Promise.all([et(st),et(Wt),et(Vt)]),da=ku(q);let yn=0;const De=at=>{at.docs.forEach(rt=>{da.update(rt.ref,{status:"completed",confirmedAt:new Date}),yn++})};De(Ws),De(ca),De(Gs),yn>0&&await da.commit(),t!=null&&t.uid&&[...Ws.docs.map(rt=>{var Et;return String(((Et=rt.data())==null?void 0:Et.transactionId)||"")}),...ca.docs.map(rt=>{var Et;return String(rt.id||((Et=rt.data())==null?void 0:Et.transactionId)||"")}),...Gs.docs.map(rt=>{var Et;return String(rt.id||((Et=rt.data())==null?void 0:Et.transactionId)||"")})].filter(Boolean).forEach(rt=>Ce.removeLocalReceiptById(t.uid,rt))}catch(st){console.error("Batch update failed for linked transactions:",st)}})().catch(st=>{console.error("Transaction update error:",st)}),t!=null&&t.uid&&Ms!=="none")try{const Wt={transactionId:ze(je(q,"dummy_collection")).id,amount:Ue,transactionType:"cash_addition",type:"cash_addition",status:"completed",createdAt:new Date,senderName:te.debtorName,receiverName:"المحل",description:`سداد دين من العميل ${te.debtorName}`,paymentMethod:Ms,walletId:Ms==="wallet"?ln:null,linkedDebtId:te.id,isDebtRepayment:!0};await Ce.saveUserTransaction(t.uid,Wt);try{E.invalidateQueries({queryKey:["recentTransactions",t==null?void 0:t.uid]})}catch{}}catch(st){console.error("Failed to create repayment receipt:",st)}r({title:"تم إنقاص المبلغ",description:`المبلغ الجديد: ${$} جنيه`})}else{const $=A+Ue,K=J>=$,oe={...te,amount:Number($.toFixed(2)),status:K?"paid":"pending"};j=Dt.map(st=>st.id===te.id?oe:st),p=oe,v=!0,r({title:"تم زيادة المبلغ",description:`المبلغ الجديد: ${$} جنيه`})}}else if(mr){j=[mr,...Dt],v=!0;try{t!=null&&t.uid&&Za.send(t.uid,`تم إضافة دين على ${mr.debtorName} بمبلغ ${mr.amount} جنيه`).catch(()=>{})}catch{}}u&&ns(c),g&&ps(h),v&&(As(j),s&&Va(p));const I={lastUpdated:l};if(u&&(I.cashBalance=c),g&&(I.walletBalances=h),v&&(I.debts=j),u&&(localStorage.setItem(Xt(),c.toString()),localStorage.setItem(Xt()+"_lastUpdated",l)),g&&(localStorage.setItem(is(),JSON.stringify(h)),localStorage.setItem(is()+"_lastUpdated",l)),v){localStorage.setItem(Er(),JSON.stringify(j));try{localStorage.setItem(Dl(),JSON.stringify(j))}catch{}try{localStorage.setItem(Cl(),Date.now().toString())}catch{}}const T=`userData_${t==null?void 0:t.uid}`;if(localStorage.setItem(T,JSON.stringify(I)),t!=null&&t.uid){Ce.updateUserData(t.uid,I).then(()=>{if((u||g)&&(localStorage.removeItem(T),ot(!1)),v)try{localStorage.removeItem(`debts_unsynced_${t.uid}`)}catch{}}).catch(J=>{if(console.error("Sync error:",J),ot(!0),v)try{localStorage.setItem(`debts_unsynced_${t.uid}`,"true")}catch{}});const A=_||(S==null?void 0:S.shopId);if(A&&(u||g)){const J={lastUpdated:l};u&&(J.cashBalance=c),g&&(J.walletBalances=h),ia(ze(q,"dashboardData",A),J,{merge:!0}).catch(Ue=>console.error("Failed to sync to dashboardData",Ue))}}try{}catch(A){console.error("خطأ أثناء تحديث الأرصدة عند حفظ/تعديل الدين:",A)}zo(""),qo(""),Vo(""),Pr(!1),_r(!1),s||dr(!0),rn(null),Ho(null),nn(null),pl(""),r({title:s?"تم تعديل الدين":"تم حفظ الدين",description:Ms==="none"?"لم يتم تعديل الأرصدة":Ms==="cash"?a?`تمت إضافة ${n} إلى الرصيد النقدي`:`تم خصم ${n} من الرصيد النقدي`:a?`تمت إضافة ${n} إلى رصيد المحفظة`:`تم خصم ${n} من رصيد المحفظة`})},children:(Zt==null?void 0:Zt.type)==="decrease"?"تأكيد الإضافة":"تأكيد الخصم"})]})]})}),e.jsx(Te,{open:Xm,onOpenChange:Ja,children:e.jsxs(Pe,{className:"w-[95vw] sm:w-auto sm:max-w-[425px] rounded-2xl",children:[e.jsx(ke,{children:e.jsx(_e,{className:"text-right",children:"إيصال الدين"})}),te&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:ji.format(te.createdAt instanceof Date?te.createdAt:new Date(te.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:te.debtorName})]}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:justify-between sm:items-center",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"outline",className:"h-10 w-10 sm:h-8 sm:w-8 p-0","aria-label":"إنقاص الدين",onClick:()=>{Ko("decrease"),el(""),Ja(!1),an(!0)},children:"−"}),e.jsxs("span",{className:"font-bold text-xl sm:text-lg",children:[te.amount," جنيه"]}),e.jsx(x,{variant:"outline",className:"h-10 w-10 sm:h-8 sm:w-8 p-0","aria-label":"زيادة الدين",onClick:()=>{Ko("increase"),el(""),Ja(!1),an(!0)},children:"+"})]})]}),(()=>{try{const s=(Ze||[]).filter(a=>String((a==null?void 0:a.linkedDebtId)||"")===String(te.id)).reduce((a,n)=>a+Math.max(0,Number((n==null?void 0:n.commission)||0)),0);return s>0?e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"الربح:"}),e.jsxs("span",{className:"text-green-700 font-semibold",children:[s," جنيه"]})]}):null}catch{return null}})(),e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:te.reason})]}),e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(bs,{variant:te.status==="paid"?"default":"secondary",className:`${te.status==="paid"?"bg-green-500":"bg-yellow-500"} w-fit text-[12px] sm:text-xs`,children:te.status==="paid"?"مدفوع":"مؤجل"})]}),(()=>{try{const s=(Ze||[]).filter(j=>String((j==null?void 0:j.linkedDebtId)||"")===String(te.id)),a=s.reduce((j,p)=>j+Math.max(0,Number((p==null?void 0:p.commission)||0)),0),n=s.reduce((j,p)=>j+Math.max(0,Number(((p==null?void 0:p.sentAmount)??(p==null?void 0:p.transferredAmount)??(p==null?void 0:p.withdrawnAmount)??(p==null?void 0:p.amount))||0)),0),l=Number(te.amount||0),c=Number(te.paidAmount||0),u=l<n+a?l+a:l,g=Math.max(0,Number(u)-c);return e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-xl sm:text-lg",children:[g," جنيه"]})]})}catch{return e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-xl sm:text-lg",children:[Number(te.amount||0)-Number(te.paidAmount||0)," جنيه"]})]})}})(),te.paidAmount?e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[te.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-4 border rounded-xl bg-gray-50",children:[th?e.jsxs("div",{className:"space-y-2",children:[e.jsx(se,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx(V,{id:"partialAmount",type:"number",value:Qo,onChange:s=>sl(s.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{tl(!1),sl("")},children:"إلغاء"}),e.jsx(x,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const s=parseFloat(Qo);if(!te||isNaN(s)||s<=0){r({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Math.max(0,Number(te.amount||0)-Number(te.paidAmount||0));if(s>a){r({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const n=Number(((te.paidAmount||0)+s).toFixed(2)),l=n>=Number(te.amount||0),c={...te,amount:Number(te.amount||0),paidAmount:n,status:l?"paid":"pending",partialPayments:[...te.partialPayments||[],{amount:s,paidAt:new Date}]},h=Dt.map(u=>u.id===te.id?c:u);As(h),Va(c),await oa(h);try{if(t!=null&&t.uid){const u=Math.max(0,Number(c.amount||0)-Number(c.paidAmount||0));await Za.send(t.uid,`تم سداد جزء من دين ${c.debtorName}: المدفوع ${s} جنيه، المتبقي ${u} جنيه`)}}catch{}try{c.status==="paid"&&(t!=null&&t.uid)&&(async()=>{const u=Ye(je(q,"userTransactions"),he("userId","==",t.uid),he("linkedDebtId","==",te.id),he("status","==","pending")),g=await et(u);await Promise.allSettled(g.docs.map(T=>Yt(T.ref,{status:"completed",confirmedAt:new Date})));try{const T=g.docs.map(A=>{var J;return String(((J=A.data())==null?void 0:J.transactionId)||"")});t!=null&&t.uid&&T.forEach(A=>A&&Ce.removeLocalReceiptById(t.uid,A))}catch{}const j=Ye(je(q,"transactions"),he("userId","==",t.uid),he("linkedDebtId","==",te.id),he("status","==","pending")),p=await et(j);await Promise.allSettled(p.docs.map(T=>Yt(T.ref,{status:"completed",confirmedAt:new Date})));try{const T=p.docs.map(A=>{var J;return String(A.id||((J=A.data())==null?void 0:J.transactionId)||"")});t!=null&&t.uid&&T.forEach(A=>A&&Ce.removeLocalReceiptById(t.uid,A))}catch{}const v=Ye(je(q,"transactions"),he("merchantUserId","==",t.uid),he("linkedDebtId","==",te.id),he("status","==","pending")),I=await et(v);await Promise.allSettled(I.docs.map(T=>Yt(T.ref,{status:"completed",confirmedAt:new Date})));try{const T=I.docs.map(A=>{var J;return String(A.id||((J=A.data())==null?void 0:J.transactionId)||"")});t!=null&&t.uid&&T.forEach(A=>A&&Ce.removeLocalReceiptById(t.uid,A))}catch{}})().catch(u=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",u),r({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(u){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",u)}try{const u=Pl(),g=localStorage.getItem(u);if(g){const p=(JSON.parse(g)||[]).map(v=>(v==null?void 0:v.linkedDebtId)===te.id&&(v==null?void 0:v.status)==="pending"?{...v,status:"completed",confirmedAt:new Date}:v);localStorage.setItem(u,JSON.stringify(p)),Na(v=>v.map(I=>(I==null?void 0:I.linkedDebtId)===te.id&&(I==null?void 0:I.status)==="pending"?{...I,status:"completed",confirmedAt:new Date}:I))}}catch(u){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",u)}si(s),Ka("none"),Or(!0),tl(!1),sl(""),r({title:"تم تسجيل دفع جزء",description:`تم دفع ${s} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(x,{variant:"outline",className:"w-full",onClick:()=>tl(!0),children:"دفع جزء"}),te.partialPayments&&te.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-[12px] sm:text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-[30vh] sm:max-h-24 overflow-y-auto",children:te.partialPayments.map((s,a)=>e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsxs("span",{children:["دفع: ",s.amount," جنيه"]}),e.jsx("span",{children:new Date(s.paidAt).toLocaleString("ar-EG")})]},a))})]})]})]})]}),e.jsxs(xt,{className:"flex gap-2 justify-center",children:[e.jsx(x,{onClick:async()=>{if(te){const s=Dt.map(a=>a.id===te.id?{...a,status:"pending"}:a);As(s),await oa(s);try{if(t!=null&&t.uid){const a=computedRemaining;await Za.send(t.uid,`تم سداد الدين بالكامل للعميل ${te.debtorName}: المدفوع ${a} جنيه`)}}catch{}Ja(!1),r({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(x,{onClick:async()=>{if(te){const s=Number(te.amount||0),a=Number(te.paidAmount||0);let n=Math.max(0,s-a);try{const h=(Ze||[]).filter(v=>String((v==null?void 0:v.linkedDebtId)||"")===String(te.id)),u=h.reduce((v,I)=>v+Math.max(0,Number((I==null?void 0:I.commission)||0)),0),g=h.reduce((v,I)=>v+Math.max(0,Number(((I==null?void 0:I.sentAmount)??(I==null?void 0:I.transferredAmount)??(I==null?void 0:I.withdrawnAmount)??(I==null?void 0:I.amount))||0)),0),p=s<g+u?s+u:s;n=Math.max(0,Number(p)-a)}catch{}const l=n,c=Dt.map(h=>{if(h.id!==te.id)return h;const u=Number(h.amount||0),g=Number(h.paidAmount||0),j=Number((g+l).toFixed(2)),p=j>=u;return{...h,amount:u,paidAmount:p?u:j,status:"paid",partialPayments:[...h.partialPayments||[],...l>0?[{amount:l,paidAt:new Date}]:[]]}});As(c);try{Va(c.find(h=>h.id===te.id)||null)}catch{}si(l),Ka("none"),Or(!0),await oa(c);try{t!=null&&t.uid&&(te!=null&&te.id)&&(async()=>{const h=Ye(je(q,"userTransactions"),he("userId","==",t.uid),he("linkedDebtId","==",te.id),he("status","==","pending")),u=await et(h);await Promise.allSettled(u.docs.map(I=>Yt(I.ref,{status:"completed",confirmedAt:new Date})));try{const I=u.docs.map(T=>{var A;return String(((A=T.data())==null?void 0:A.transactionId)||"")});t!=null&&t.uid&&I.forEach(T=>T&&Ce.removeLocalReceiptById(t.uid,T))}catch{}const g=Ye(je(q,"transactions"),he("userId","==",t.uid),he("linkedDebtId","==",te.id),he("status","==","pending")),j=await et(g);await Promise.allSettled(j.docs.map(I=>Yt(I.ref,{status:"completed",confirmedAt:new Date})));try{const I=j.docs.map(T=>{var A;return String(T.id||((A=T.data())==null?void 0:A.transactionId)||"")});t!=null&&t.uid&&I.forEach(T=>T&&Ce.removeLocalReceiptById(t.uid,T))}catch{}const p=Ye(je(q,"transactions"),he("merchantUserId","==",t.uid),he("linkedDebtId","==",te.id),he("status","==","pending")),v=await et(p);await Promise.allSettled(v.docs.map(I=>Yt(I.ref,{status:"completed",confirmedAt:new Date})));try{const I=v.docs.map(T=>{var A;return String(T.id||((A=T.data())==null?void 0:A.transactionId)||"")});t!=null&&t.uid&&I.forEach(T=>T&&Ce.removeLocalReceiptById(t.uid,T))}catch{}})().catch(h=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",h),r({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(h){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",h)}try{const h=Pl(),u=localStorage.getItem(h);if(u){const j=(JSON.parse(u)||[]).map(p=>(p==null?void 0:p.linkedDebtId)===te.id&&(p==null?void 0:p.status)==="pending"?{...p,status:"completed",confirmedAt:new Date}:p);localStorage.setItem(h,JSON.stringify(j)),Na(p=>p.map(v=>(v==null?void 0:v.linkedDebtId)===te.id&&(v==null?void 0:v.status)==="pending"?{...v,status:"completed",confirmedAt:new Date}:v))}}catch(h){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",h)}Ja(!1),r({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(x,{onClick:async()=>{if(te){const s=Dt.filter(a=>a.id!==te.id);As(s),await oa(s),Ja(!1),r({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(Te,{open:eh,onOpenChange:an,children:e.jsxs(Pe,{className:"sm:max-w-md rounded-2xl shadow-elegant border border-gray-200",children:[e.jsxs(ke,{children:[e.jsx(_e,{className:`text-right ${cr==="decrease"?"text-red-600":"text-green-600"}`,children:cr==="decrease"?"إنقاص مبلغ الدين":cr==="increase"?"زيادة مبلغ الدين":"تعديل مبلغ الدين"}),e.jsxs(Ps,{className:"text-right",children:["أدخل المبلغ ثم اضغط تأكيد لإتمام ",cr==="decrease"?"الإنقاص":"الزيادة","."]})]}),e.jsxs("div",{className:"grid gap-4 py-2",children:[e.jsx(se,{htmlFor:"debtAdjustAmount",className:"text-right",children:"المبلغ (جنيه)"}),e.jsx(V,{id:"debtAdjustAmount",type:"number",placeholder:"0.00",value:Yo,onChange:s=>el(s.target.value)}),te&&e.jsxs("div",{className:"text-right text-sm text-muted-foreground",children:["المبلغ الحالي: ",e.jsx("span",{className:"font-semibold",children:Number(te.amount||0).toFixed(2)})," جنيه"]})]}),e.jsxs(xt,{className:"flex gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>{an(!1),Ja(!0)},children:"إلغاء"}),e.jsx(x,{className:cr==="decrease"?"bg-red-600 hover:bg-red-700":"bg-green-600 hover:bg-green-700",onClick:async()=>{try{if(!te||!cr)return;const s=Number(parseFloat(Yo||"0").toFixed(2));if(!s||isNaN(s)||s<=0){r({title:"قيمة غير صالحة",description:"يرجى إدخال مبلغ أكبر من صفر",variant:"destructive"});return}rn(null),Ho({debtId:te.id,delta:s,type:cr}),an(!1),_r(!0)}catch(s){console.error("فشل تجهيز تعديل مبلغ الدين:",s),r({title:"خطأ",description:"تعذّر تجهيز تعديل مبلغ الدين",variant:"destructive"})}},children:"تأكيد"})]})]})}),e.jsx(Te,{open:dh,onOpenChange:Or,children:e.jsxs(Pe,{className:"sm:max-w-[480px]",children:[e.jsxs(ke,{children:[e.jsx(_e,{className:"text-right",children:"اختيار مكان إضافة مبلغ السداد"}),e.jsx(Ps,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 justify-center",children:[e.jsx(x,{variant:ra==="cash"?"default":"outline",className:ra==="cash"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>Ka("cash"),children:"الفلوس النقدية"}),e.jsx(x,{variant:ra==="wallet"?"default":"outline",className:ra==="wallet"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>Ka("wallet"),children:"أرصدة المحافظ"}),e.jsx(x,{variant:ra==="fawry"?"default":"outline",className:ra==="fawry"?"bg-amber-600 text-white":"",size:"sm",onClick:()=>Ka("fawry"),children:"فوري"}),e.jsx(x,{variant:ra==="none"?"default":"outline",className:ra==="none"?"bg-gray-600 text-white":"",size:"sm",onClick:()=>Ka("none"),children:"بدون إضافة"})]}),ra==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة للإضافة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:Ya,onChange:s=>gl(s.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),Ke&&Ke.length>0?Ke.map(s=>e.jsx("option",{value:s.id,children:s.phone||s.name||s.id},s.id)):Object.keys(ct||{}).map(s=>{var a,n,l,c,h,u;return e.jsx("option",{value:s,children:((a=Ke.find(g=>g.id===s))==null?void 0:a.phone)||((l=(n=JSON.parse(localStorage.getItem(kl())||"[]"))==null?void 0:n.find(g=>g.id===s))==null?void 0:l.phone)||((h=(c=JSON.parse(localStorage.getItem(kl())||"[]"))==null?void 0:c.find(g=>g.id===s))==null?void 0:h.name)||((u=Ke.find(g=>g.id===s))==null?void 0:u.name)||s},s)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[ic," جنيه"]})]})]}),e.jsxs(xt,{className:"flex flex-wrap justify-between gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{Or(!1),si(0),Ka(null),gl("")},children:"إلغاء"}),e.jsx(x,{onClick:async()=>{var s,a;try{const n=ic;if(!n||n<=0){Or(!1);return}const l=async(c,h)=>{if(t!=null&&t.uid&&te)try{const g={transactionId:ze(je(q,"dummy_collection")).id,amount:n,transactionType:"cash_addition",type:"cash_addition",status:"completed",createdAt:new Date,senderName:te.debtorName,receiverName:"المحل",description:`سداد دين من العميل ${te.debtorName}`,paymentMethod:c,walletId:h||null,linkedDebtId:te.id,isDebtRepayment:!0};await Ce.saveUserTransaction(t.uid,g);try{E.invalidateQueries({queryKey:["recentTransactions",t==null?void 0:t.uid]})}catch{}}catch(u){console.error("Failed to create repayment receipt:",u)}};if(ra==="cash"){const c=Mt+n;ns(c),localStorage.setItem(Xt(),c.toString());const h={cashBalance:c,lastUpdated:new Date().toISOString()},u=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(u,JSON.stringify(h)),t!=null&&t.uid?(Ce.updateUserData(t.uid,h).catch(()=>ot(!0)),localStorage.removeItem(u),ot(!1)):ot(!0),r({title:"تم إضافة مبلغ السداد",description:`تم إضافة ${n} جنيه إلى الفلوس النقدية`}),await l("cash");try{if(te){const g=Dt.map(j=>j.id===te.id?{...j,status:"paid",paidAmount:Math.max(Number(j.paidAmount||0),Number(j.amount||0))}:j);As(g);try{Va(g.find(j=>j.id===te.id)||null)}catch{}try{await oa(g)}catch{}}}catch{}}else if(ra==="wallet"){if(!Ya){r({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const c={...ct,[Ya]:(ct[Ya]||0)+n};ps(c);const h=new Date().toISOString(),u={walletBalances:c,lastUpdated:h},g=`userData_${t==null?void 0:t.uid}`;if(localStorage.setItem(g,JSON.stringify(u)),localStorage.setItem(is(),JSON.stringify(c)),localStorage.setItem(`walletBalances_backup_${h}`,JSON.stringify(c)),t!=null&&t.uid){Ce.updateUserData(t.uid,u).catch(()=>ot(!0));try{localStorage.removeItem(g)}catch{}ot(!1)}else ot(!0);r({title:"تم إضافة مبلغ السداد",description:`تم إضافة ${n} جنيه إلى المحفظة ${((s=Ke.find(j=>j.id===Ya))==null?void 0:s.phone)||((a=Ke.find(j=>j.id===Ya))==null?void 0:a.name)||Ya}`}),await l("wallet",Ya);try{if(te){const j=Dt.map(p=>p.id===te.id?{...p,status:"paid",paidAmount:Math.max(Number(p.paidAmount||0),Number(p.amount||0))}:p);As(j);try{Va(j.find(p=>p.id===te.id)||null)}catch{}try{await oa(j)}catch{}}}catch{}}else if(ra==="none"){r({title:"تم تسجيل السداد",description:`تم تسجيل ${n} جنيه بدون تعديل الأرصدة`});try{if(te){const c=Dt.map(h=>h.id===te.id?{...h,status:"paid",paidAmount:Math.max(Number(h.paidAmount||0),Number(h.amount||0))}:h);As(c);try{Va(c.find(h=>h.id===te.id)||null)}catch{}try{await oa(c)}catch{}}}catch{}}else if(ra==="fawry")r({title:"تم تسجيل سداد عبر فوري",description:`تم تسجيل ${n} جنيه كسداد عبر فوري بدون تعديل الأرصدة`}),await l("fawry");else{r({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}try{const c=n>0?n:Number((te==null?void 0:te.amount)||0);t!=null&&t.uid&&te&&await Za.send(t.uid,`تم سداد الدين بالكامل للعميل ${te.debtorName}: المدفوع ${c} جنيه`)}catch{}}catch(n){console.error("خطأ أثناء إضافة مبلغ السداد:",n),r({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{Or(!1),si(0),Ka(null),gl("");try{dr(!0)}catch{}}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(Te,{open:Tm,onOpenChange:lr,children:e.jsxs(Pe,{hideClose:!0,className:"post-confirm-card sm:max-w-[420px] w-[90vw] rounded-2xl bg-gradient-to-br from-white via-indigo-50 to-blue-50 shadow-2xl border border-indigo-100",children:[e.jsxs(ke,{children:[e.jsx(_e,{className:"text-right text-2xl font-bold",children:(xs==null?void 0:xs.type)==="transfer"?"مبلغ يجب استلامه":"مبلغ يجب تسليمه"}),e.jsx(Ps,{className:"text-right text-gray-600",children:(xs==null?void 0:xs.type)==="transfer"?"هذا هو المبلغ الواجب استلامه من العميل بعد التأكيد.":"هذا هو المبلغ الواجب تسليمه للعميل بعد التأكيد."})]}),e.jsxs("div",{className:"py-3 flex flex-col items-center gap-1.5",children:[e.jsxs("div",{className:"text-xl sm:text-2xl font-bold text-blue-700 tracking-wide",children:[ta((xs==null?void 0:xs.amount)||0)," جنيه"]}),e.jsx("div",{className:"text-sm text-gray-500 text-right w-full",children:(xs==null?void 0:xs.type)==="transfer"?"المبلغ المعروض شامل عمولة التحويل.":At?"العمولة مضافة ولا تؤثر على قيمة التسليم.":"العمولة مخصومة من المبلغ المسلّم للعميل."})]}),e.jsxs(xt,{className:"flex justify-end gap-2",children:[(xs==null?void 0:xs.type)==="transfer"&&e.jsx(x,{variant:"outline",id:"sendCodeBtn",onClick:os,disabled:_o,className:"btn-transfer-confirm",children:_o?"جارٍ الإرسال...":"إرسال كود التحويل"}),e.jsx(x,{onClick:()=>{lr(!1),Ji(null)},className:"bg-green-600 hover:bg-green-700 text-white",children:(xs==null?void 0:xs.type)==="transfer"?"تم الاستلام":"تم التسليم"})]})]})}),e.jsx(ex,{open:km,onClose:()=>Tr(!1),onSubmit:Lt,deviceId:Oo||we||"",recipientMsisdn:String(ce==="transfer"?(Hs==null?void 0:Hs.receiver)||Ss||"":((Jc=Ke.find(s=>s.id===U))==null?void 0:Jc.phone)||"").replace(/\D/g,"")}),e.jsx(wp,{open:le,onOpenChange:Ee}),Eo]}))};export{Sg as default};
//# sourceMappingURL=UserDashboardPage-DaSIDDiO.js.map
