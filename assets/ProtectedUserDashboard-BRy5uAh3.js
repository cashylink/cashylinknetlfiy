const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./UserDashboardPage-DaSIDDiO.js","./index-DA5EGBVC.js","./index-C-FbHbUs.css","./card-BDAHS7kE.js","./badge-C7RoQRV3.js","./select-D-ueobad.js","./label-DGcgSfhx.js","./MasterPinDialog-BLejEjf9.js","./circle-alert-CRivym9p.js","./wallet-FJyN6gHk.js","./star-Ck9eli2r.js","./square-pen-BlBi0wqZ.js","./progress-DQPJPvXg.js","./phone-BPnjQDX1.js","./arrow-left-DthGIAIu.js","./separator-DidRjMgH.js","./dollar-sign-B2riGpcX.js","./ProfileIcon-B58wAJLW.js","./dropdown-menu-D24DgyTC.js","./index-CPuDqvZm.js","./switch-CtqW1fNM.js","./circle-x-7MF1caut.js","./circle-check-big-HJ3q8vm4.js","./MaintenanceDialog-OCrzmwZQ.js","./whatsappService-DQcCuiwn.js","./download-BSxes68N.js","./profitService-CQSlHJ0c.js","./store-B6E9c70J.js","./broadcastService--y5MBKLO.js","./textarea-Cq06RRRe.js","./WalletsManagement-boHxi1vH.js","./freeTrialService-C0LuPwO4.js","./walletSelectionPinService-BWin8Wb1.js","./crown-CqXB_1jY.js","./refresh-cw-Cl57Ej0r.js"])))=>i.map(i=>d[i]);
import{u as V,r as u,$ as H,a as F,G as B,i as R,ak as W,j as a,aw as X,K as Z,ax as ee,c as te,ag as T,am as D,R as q,_ as se}from"./index-DA5EGBVC.js";import{s as ae,E as ie}from"./broadcastService--y5MBKLO.js";import{L as re}from"./link-Deo-1WKw.js";import{M as C}from"./MasterPinDialog-BLejEjf9.js";import"./label-DGcgSfhx.js";import"./circle-alert-CRivym9p.js";const _="dismissedBroadcastIds",oe=()=>{const{user:t,profile:e,isSubscriptionActive:r,userSubscription:c}=V(),[m,h]=u.useState(null),[s,x]=u.useState(!1),[I,p]=u.useState(!1),[k,A]=u.useState([]),P=H(),S=F(),y=u.useMemo(()=>`dismissedBroadcastIds:${(t==null?void 0:t.uid)||"global"}`,[t==null?void 0:t.uid]),j=u.useMemo(()=>{const o=["global"];return e!=null&&e.shopId&&o.push(`shop:${e.shopId}`),t!=null&&t.uid&&o.push(`user:${t.uid}`),o},[e==null?void 0:e.shopId,t==null?void 0:t.uid]),E=P.pathname.startsWith("/admin");u.useEffect(()=>{if(!(t!=null&&t.uid))return;const o=B(R,"users",t.uid),g=W(o,n=>{const f=n.data(),b=Array.isArray(f==null?void 0:f.dismissedBroadcastIds)?f.dismissedBroadcastIds:[];A(b);try{const v=localStorage.getItem(y),l=v?JSON.parse(v):[],i=Array.from(new Set([...Array.isArray(l)?l:[],...b]));localStorage.setItem(y,JSON.stringify(i)),localStorage.setItem(_,JSON.stringify(i))}catch{}},n=>{console.error("UserBroadcastModal: onSnapshot user error",n)});return()=>g()},[t==null?void 0:t.uid,y]),u.useEffect(()=>{if(!t||E||!((e==null?void 0:e.approved)===!0||r||(c==null?void 0:c.isOnFreeTrial)===!0))return;const g=ae(j,n=>{if(n){h(n);try{const f=localStorage.getItem(y),b=localStorage.getItem(_),v=f?JSON.parse(f):[],l=b?JSON.parse(b):[],i=Array.isArray(v)?[...v]:[];if(Array.isArray(l))for(const w of l)i.includes(w)||i.push(w);if(Array.isArray(k))for(const w of k)i.includes(w)||i.push(w);const U=n.id&&i.includes(n.id);x(!U),p(!1),requestAnimationFrame(()=>p(!0))}catch{x(!0),p(!0)}}});return()=>g()},[t,j,E,e==null?void 0:e.approved,r,c,k]);const d=async()=>{x(!1);try{const o=localStorage.getItem(y),g=o?JSON.parse(o):[],n=m==null?void 0:m.id;if(n&&!g.includes(n)){g.push(n),localStorage.setItem(y,JSON.stringify(g));try{localStorage.setItem(_,JSON.stringify(g))}catch{}try{t!=null&&t.uid&&await Z(B(R,"users",t.uid),{dismissedBroadcastIds:ee(n)})}catch(f){console.warn("UserBroadcastModal: failed to update dismissedBroadcastIds in Firestore",f)}}}catch{}};return!s||!m?null:a.jsxs("div",{className:"fixed inset-0 z-[9999]",children:[a.jsx("div",{className:`absolute inset-0 transition-opacity duration-300 ease-out ${I?"opacity-100":"opacity-0"} bg-black/20 dark:bg-black/20`}),a.jsxs("div",{className:`absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] sm:w-auto sm:min-w-[380px] sm:max-w-md md:max-w-lg bg-white shadow-2xl rounded-2xl border border-gray-100 ring-1 ring-black/5 transition-all duration-300 ease-out ${I?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:[a.jsx("div",{className:"relative overflow-hidden rounded-t-2xl",children:a.jsxs("div",{className:"bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 relative",children:[a.jsx("button",{"aria-label":"Ø¥ØºÙ„Ø§Ù‚",onClick:d,className:"absolute top-3 right-3 p-2 rounded-full bg-white/10 hover:bg-white/20",children:a.jsx(X,{className:"w-5 h-5 text-white"})}),a.jsx("div",{className:"p-4",children:a.jsx("h3",{className:"text-base sm:text-lg font-semibold text-white tracking-wide text-center",children:m.title||"Ø¥Ø´Ø¹Ø§Ø±"})})]})}),a.jsx("div",{className:"p-5",children:a.jsxs("div",{className:"flex items-start justify-between gap-3",children:[a.jsx("p",{className:"text-gray-700 leading-relaxed text-sm sm:text-base",children:m.message}),m.linkUrl&&a.jsxs("button",{"aria-label":"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·",title:"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·",onClick:()=>{const o=m.linkUrl;/^https?:\/\//i.test(o)?window.open(o,"_blank","noopener"):S(o)},className:"shrink-0 inline-flex items-center gap-2 px-3 py-2 rounded-md bg-indigo-600 text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 whitespace-nowrap",children:[/^https?:\/\//i.test(m.linkUrl)?a.jsx(ie,{className:"w-6 h-6"}):a.jsx(re,{className:"w-6 h-6"}),a.jsx("span",{className:"text-xs sm:text-sm font-semibold",children:"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·"})]})]})})]})]})},J="quick_login_enabled",K="quick_login_session_verified";function M(t){return t?`${J}_${t}`:J}function O(t){return t?`${K}_${t}`:K}const N={isEnabled(t){try{return localStorage.getItem(M(t))==="true"}catch{return!1}},setEnabled(t,e){try{localStorage.setItem(M(e),t?"true":"false"),sessionStorage.removeItem(O(e))}catch{}},isSessionVerified(t){try{return sessionStorage.getItem(O(t))==="true"}catch{return!1}},markSessionVerified(t){try{sessionStorage.setItem(O(t),"true")}catch{}}},ne=q.lazy(()=>se(()=>import("./UserDashboardPage-DaSIDDiO.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34]),import.meta.url)),me=()=>{var E;const t=F(),{user:e,profile:r,loading:c,refreshProfile:m,isSubscriptionActive:h,userSubscription:s,checkSubscriptionStatus:x}=V(),[I,p]=u.useState(!1),[k,A]=u.useState(!1),{toast:P}=te(),[S,y]=u.useState(!1);u.useEffect(()=>{const d=async o=>{const{userId:g,isActive:n}=o.detail;console.log("ðŸ”” ProtectedUserDashboard: Subscription update event received:",{userId:g,isActive:n,currentUserId:e==null?void 0:e.uid}),g===(e==null?void 0:e.uid)&&n&&(console.log("âœ… ProtectedUserDashboard: Subscription activated for current user, refreshing status"),await x(),p(!0),P({title:"ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ",description:"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…!"}))};return window.addEventListener("userSubscriptionUpdated",d),()=>{window.removeEventListener("userSubscriptionUpdated",d)}},[e==null?void 0:e.uid,x,P]),u.useEffect(()=>{var d,o;if(console.log("ProtectedUserDashboard - useEffect triggered",{loading:c,user:e?"exists":"null",profile:r?{role:r.role,approved:r.approved}:"null",isSubscriptionActive:h,userSubscription:s?"exists":"null"}),!c){if(!e)console.log("ProtectedUserDashboard - No user, redirecting to login"),t("/user/login");else if(r)if(console.log("ProtectedUserDashboard - Profile found:",{role:r.role,approved:r.approved,isSubscriptionActive:h,hasSubscription:!!(s!=null&&s.subscription)}),s){const g=((d=s==null?void 0:s.branchPackage)==null?void 0:d.status)==="active",n=(s==null?void 0:s.isOnFreeTrial)===!0;if(!(!!h||((o=s==null?void 0:s.subscription)==null?void 0:o.isActive)===!0||n)&&!g){try{t("/user/pending-approval",{replace:!0})}catch{}return}r.role==="user"&&p(!0);const v=N.isEnabled(e==null?void 0:e.uid),l=N.isSessionVerified(e==null?void 0:e.uid);if(v&&!l){try{N.markSessionVerified(e==null?void 0:e.uid)}catch{}A(!1),p(!0)}else p(!0)}else{try{x()}catch{}return}}},[e,r,c,t,h,s]),u.useEffect(()=>{let d=null;return!c&&e?y(!0):e&&(d=setTimeout(()=>y(!0),3e3)),()=>{try{clearTimeout(d)}catch{}}},[c,e]),u.useEffect(()=>{var b,v;if(c||!e||!S||!s)return;const d=(s==null?void 0:s.isActive)!==!1,o=((b=s==null?void 0:s.branchPackage)==null?void 0:b.status)==="active",g=(s==null?void 0:s.isOnFreeTrial)===!0,n=!!h||((v=s==null?void 0:s.subscription)==null?void 0:v.isActive)===!0||g,f=l=>{var L,$;if(!l)return"null";const i=l.subscription,U=i!=null&&i.activatedAt?i.activatedAt.toDate?i.activatedAt.toDate().toISOString():new Date(i.activatedAt).toISOString():"null",w=(i==null?void 0:i.planType)||"null",G=l.isActive!==!1,Y=(i==null?void 0:i.isActive)===!0,z=((L=l.branchPackage)==null?void 0:L.status)==="active",Q=($=l.branchPackage)!=null&&$.activatedAt?l.branchPackage.activatedAt.toDate?l.branchPackage.activatedAt.toDate().toISOString():new Date(l.branchPackage.activatedAt).toISOString():"null";return`${G}|${Y}|${w}|${U}|${z}|${Q}`};if(!d){console.log("â›” ProtectedUserDashboard: Account is deactivated, redirecting to pending approval");try{sessionStorage.setItem("dashboard_kick_signature",f(s)),t("/user/pending-approval",{replace:!0})}catch{}return}if(!n&&!o)try{sessionStorage.setItem("dashboard_kick_signature",f(s)),t("/user/pending-approval")}catch{}},[c,e,s,h,t,S]),u.useEffect(()=>{},[c,e,s,h,x,t,S]);const j=typeof window<"u"&&(window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:");return(E=T)!=null&&E.isNativePlatform&&T.getPlatform(),c&&(j||!e)?a.jsx(D,{}):S?I?(console.log("ProtectedUserDashboard - Render state:",{isAuthenticated:I,profileRole:r==null?void 0:r.role,profileApproved:r==null?void 0:r.approved,isSubscriptionActive:h,hasSubscription:!!(s!=null&&s.subscription)}),console.log("ðŸ”¥ ProtectedUserDashboard - user:",e?{uid:e.uid,email:e.email}:"null"),console.log("ðŸ”¥ ProtectedUserDashboard - profile:",r?{userId:r.userId,role:r.role}:"null"),console.log("ðŸ”¥ ProtectedUserDashboard - loading:",c),console.log("ðŸ”¥ ProtectedUserDashboard - About to render UserDashboardPage"),a.jsxs("div",{className:"relative",children:[a.jsx(q.Suspense,{fallback:a.jsx(D,{}),children:a.jsx(ne,{})}),a.jsx(oe,{}),a.jsx(C,{open:k,onOpenChange:d=>A(d),mode:"verify",title:"Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹",description:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",onSuccess:()=>{N.markSessionVerified(e==null?void 0:e.uid),A(!1),p(!0)}})]})):a.jsxs(a.Fragment,{children:[a.jsx(D,{}),a.jsx(C,{open:k,onOpenChange:d=>A(d),mode:"verify",title:"Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹",description:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",onSuccess:()=>{N.markSessionVerified(e==null?void 0:e.uid),A(!1),p(!0)}})]}):a.jsx(D,{})};export{me as default};
//# sourceMappingURL=ProtectedUserDashboard-BRy5uAh3.js.map
