const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-gOTNP7ME.js","./index-OjfkNIag.css","./dailyOperationCountService-Di0GbWDY.js","./walletDailyLimitsService-UwV1MQRJ.js","./profitService-C6ong2ih.js"])))=>i.map(i=>d[i]);
var Jm=Object.defineProperty;var Km=(i,p,d)=>p in i?Jm(i,p,{enumerable:!0,configurable:!0,writable:!0,value:d}):i[p]=d;var nl=(i,p,d)=>Km(i,typeof p!="symbol"?p+"":p,d);import{O as ca,m as oc,n as cc,u as da,r as n,c as Gs,j as e,Y as ge,Z as fe,_ as ye,$ as be,B as h,au as sa,aw as Gr,bq as ti,br as Yo,af as Jr,C as Na,S as Is,a as dc,w as Rt,av as vs,I as U,aq as mc,ay as hc,ag as bt,bs as Qr,U as hl,A as Ym,R as Ke,E as fs,v as Za,aM as Qa,y as Ve,i as V,K as Ys,s as xt,f as dr,a4 as Ga,P as va,q as Ue,h as je,at as ae,k as Qe,a1 as uc,z as Ls,bt as Hm,aE as ps,a0 as lt,p as Hs,F as Kr,G as Gm,ai as Zr,aV as si,a3 as pe,l as Rr,ax as gl,Q as ts,a$ as As,bu as xc,bv as Qm,bw as Zm,aa as pc,bx as Xm,a5 as eh,by as th,a9 as sh,bz as ah,bA as rh,bB as nh,bC as gc,bD as ih,bE as lh,W as Xa,bF as fc,a2 as bs,aU as Ho,a_ as yc,bG as oh,aj as ch,bH as Br,H as dh,ap as mh,am as Ur,aY as hh,aZ as uh,bl as Go,M as Qo,aX as zr,ak as Zo,bI as Xo,aS as xh,bJ as ph}from"./index-gOTNP7ME.js";import{C as Et,a as hs,b as Ts,d as Ft}from"./card-BQR6WmIt.js";import{B as Qt}from"./badge-DW3o6rRK.js";import{S as _a,a as Oa,b as Ea,c as Ma,d as ta,C as Yr,e as Hn}from"./select-P86IvavM.js";import{L as Z}from"./label-BvE0EeZv.js";import{M as gs,a as ws,P as gh}from"./MasterPinDialog-BZURpLXG.js";import{walletDailyLimitsService as Ks}from"./walletDailyLimitsService-UwV1MQRJ.js";import{W as oa}from"./wallet-bsm-6TqW.js";import{S as bc,a as fh}from"./star-DZalz9MZ.js";import{S as vc}from"./square-pen-uSH6fMBq.js";import{T as ms,P as ec}from"./progress-IPGm4fkb.js";import{P as wa}from"./phone-B5VvzQKp.js";import{A as wc}from"./arrow-left-DUmDYJv5.js";import{a as ul,S as yh}from"./separator-BKHyoKrx.js";import{C as $a}from"./calendar-D_3cDVX1.js";import{C as Qn}from"./chart-column-CHPtgzpb.js";import{D as Yt}from"./dollar-sign-DT7a2CaG.js";import{A as Yn,P as bh}from"./ProfileIcon-5ffheaOV.js";import{C as er}from"./circle-alert-BUN25pZL.js";import{C as Zn}from"./circle-x-BkGDEM2N.js";import{C as Wa}from"./circle-check-big-m77fPl3A.js";import{f as Ns,P as vh,C as Nc,a as fl,A as Xn,b as tc,I as wh,R as Nh,c as jh,M as Sh}from"./MaintenanceDialog-CReUVBms.js";import{S as jc}from"./store-DvQj4atB.js";import{S as Dh}from"./switch-TvgC6AJN.js";import{a as Ch,E as Ih}from"./broadcastService-BTmw9WWO.js";import{B as sc,T as Ah}from"./textarea-CmjOlCCk.js";import{D as Th,a as Ph,b as kh,c as _h,d as Oh}from"./dropdown-menu-Cun2tHO3.js";import{S as il}from"./shield-DG1jRZIq.js";import{G as Eh}from"./gift-Bf6nNSFh.js";import{ProfitService as La}from"./profitService-C6ong2ih.js";import{W as Mh}from"./WalletsManagement-CLcP4tqd.js";import{P as Lh,w as $h}from"./walletSelectionPinService-DvM7rUbA.js";import{C as Wh}from"./crown-BJvFWHu8.js";import{R as Fh}from"./refresh-cw-9asfDsp0.js";import"./whatsappService-Dduy5sRg.js";import"./download-Dut3BEQK.js";import"./index-DX1uHk70.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rh=ca("Award",[["path",{d:"m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526",key:"1yiouv"}],["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ac=ca("Banknote",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bh=ca("BookOpen",[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Sc=ca("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ei=ca("IdCard",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xl=ca("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ll=ca("ListChecks",[["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}],["path",{d:"M13 6h8",key:"15sg57"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 18h8",key:"oe0vm4"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Uh=ca("Notebook",[["path",{d:"M2 6h4",key:"aawbzj"}],["path",{d:"M2 10h4",key:"l0bgd4"}],["path",{d:"M2 14h4",key:"1gsvsf"}],["path",{d:"M2 18h4",key:"1bu2t1"}],["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["path",{d:"M16 2v20",key:"rotuqe"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vr=ca("Package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["path",{d:"m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7",key:"yx3hmr"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gn=ca("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),Dc=async(i={})=>{try{return(await oc(cc,"getLastTransactions")(i)).data}catch(p){throw console.error("Error getting last transactions:",p),p.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):p.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+p.message):p.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+p.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(p.message||"خطأ غير معروف"))}},zh=async i=>(await oc(cc,"sendTelegramMessage")(i)).data,qh=Object.freeze(Object.defineProperty({__proto__:null,getLastTransactions:Dc,sendTelegramMessage:zh},Symbol.toStringTag,{value:"Module"})),Vh=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Jh=({isOpen:i,onClose:p,onWalletSelect:d,onEditWallet:v,onDeleteWallet:w})=>{const{user:C}=da(),[s,j]=n.useState([]),[R,D]=n.useState(!1),[M,E]=n.useState([]),[f,N]=n.useState(!1),{toast:k}=Gs(),K=async(L,$)=>{const ve=new Date().getMonth(),Se=new Date().getFullYear(),he=$.filter(_e=>{const Ye=new Date(_e.createdAt);return Ye.getMonth()===ve&&Ye.getFullYear()===Se&&(_e.lineId===L||_e.fromWallet===L)}),de=_e=>{const Ye=_e.type;return _e.txnType==="receive"||Ye==="withdraw"||Ye==="withdrawal"||Ye==="receive"},ne=_e=>{const Ye=_e.type;return _e.txnType==="send"||Ye==="send"||Ye==="transfer"},$e=he.filter(de).reduce((_e,Ye)=>{const Je=Ye.withdrawnAmount!==void 0?Ye.withdrawnAmount:Ye.amount;return _e+(Je||0)},0),qe=he.filter(ne).reduce((_e,Ye)=>{const Je=Ye.sentAmount!==void 0?Ye.sentAmount:Ye.amount;return _e+(Je||0)},0);return{withdrawalUsage:$e,transferUsage:qe}},F=L=>{const $=new Date().toISOString().split("T")[0],ve=L.lastResetDate;if(!ve)return{...L,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:$};const Se=new Date(ve),he=new Date;return Se.getMonth()!==he.getMonth()||Se.getFullYear()!==he.getFullYear()?{...L,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:$}:L};n.useEffect(()=>{if(!(C!=null&&C.uid)||!i)return;(async()=>{N(!0);try{const $=await sa.getByMerchantId(C.uid),ve=await ti.getByUserId(C.uid),he=(await Promise.all($.map(async de=>{const{withdrawalUsage:ne,transferUsage:$e}=await K(de.id,ve),qe=await Ks.getWalletLimits(de.id);return{id:de.id,name:de.label||"محفظة بدون اسم",phone:de.msisdn,nationalId:de.nationalId||"",isDefault:!1,isActive:de.isActive===!0,monthlyWithdrawalLimit:(qe==null?void 0:qe.monthlyWithdrawLimit)??de.withdrawLimit??2e5,monthlyTransferLimit:(qe==null?void 0:qe.monthlyTransferLimit)??de.transferLimit??2e5,monthlyWithdrawalUsage:(qe==null?void 0:qe.monthlyWithdrawUsed)??ne??0,monthlyTransferUsage:(qe==null?void 0:qe.monthlyTransferUsed)??$e??0,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:de.walletProvider||""}}))).map(F);j(he)}catch($){console.error("Error loading wallets:",$),k({title:"فشل جلب بيانات المحافظ",description:"قد تكون المشكلة بسبب الصلاحيات أو الاتصال. سيتم عرض البيانات المحلية إن وُجدت. جرّب تسجيل الدخول مجددًا أو افتح صفحة اختبار المصادقة من القائمة.",variant:"destructive"})}finally{N(!1)}})()},[C==null?void 0:C.uid,i]);const Q=L=>Vh.find($=>$.id===L),te=(L,$)=>$>0?Math.min(L/$*100,100):0,ce=L=>new Intl.NumberFormat("ar-EG").format(L);return e.jsx(ge,{open:i,onOpenChange:p,children:e.jsxs(fe,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ye,{className:"pb-4",children:[e.jsxs(be,{className:"flex items-center gap-2 text-lg",children:[e.jsx(oa,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(Qt,{variant:"secondary",className:"mr-2",children:[s.length," محفظة"]})]}),e.jsx("div",{className:"flex items-center gap-2 mt-2",children:R?e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",onClick:async()=>{try{if(!(C!=null&&C.uid))return;const L=s.map($=>sa.update($.id,{isActive:M.includes($.id)}));await Promise.all(L),j($=>$.map(ve=>({...ve,isActive:M.includes(ve.id)}))),D(!1),k({title:"تم تفعيل المحافظ",description:"فقط المحافظ المحددة ستظهر في الاختيار الخارجي"});try{window.dispatchEvent(new CustomEvent("wallets:activation-updated"))}catch{}}catch(L){console.error("Error activating wallets:",L),k({title:"فشل التفعيل",description:"تعذر تفعيل المحافظ المحددة",variant:"destructive"})}},className:"h-7",children:"تفعيل المحافظ"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>{D(!1),E([])},className:"h-7",children:"إلغاء"})]}):e.jsx(h,{variant:"outline",size:"sm",onClick:()=>D(!0),className:"h-7",children:"تحديد المحافظ"})})]}),f?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):s.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(oa,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:s.map(L=>{const $=Q(L.walletProvider||"");te(L.monthlyWithdrawalUsage||0,L.monthlyWithdrawalLimit),te(L.monthlyTransferUsage||0,L.monthlyTransferLimit);const ve=M.includes(L.id),Se=R?`cursor-pointer transition-shadow border-2 ${ve?"border-blue-500 shadow-lg":"hover:border-blue-300"}`:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300";return e.jsxs(Et,{className:Se,onClick:()=>{R?E(he=>he.includes(L.id)?he.filter(de=>de!==L.id):[...he,L.id]):d(L)},children:[e.jsx(hs,{className:"pb-3",children:e.jsxs(Ts,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Gr,{className:"h-4 w-4"}),e.jsx("span",{children:L.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[L.isActive&&e.jsx(Qt,{variant:"default",className:"text-xs",children:"نشطة"}),L.isDefault&&e.jsxs(Qt,{variant:"default",className:"text-xs",children:[e.jsx(bc,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(h,{variant:"ghost",size:"sm",onClick:he=>{he.stopPropagation(),v==null||v(L)},className:"h-7 px-2",children:e.jsx(vc,{className:"h-4 w-4"})}),e.jsx(h,{variant:"ghost",size:"sm",onClick:he=>{he.stopPropagation(),w==null||w(L.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(ms,{className:"h-4 w-4"})})]})]})}),e.jsxs(Ft,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(wa,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:L.phone})]}),L.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ei,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:L.nationalId})]}),$&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Sc,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:$.name})]})]}),(()=>{const he=L.monthlyWithdrawalLimit,de=L.monthlyTransferLimit,ne=L.monthlyWithdrawalUsage||0,$e=L.monthlyTransferUsage||0,qe=Math.max(he-ne,0),_e=Math.max(de-$e,0);return e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{className:"text-xs text-gray-600 font-medium text-center",children:["الحدود الشهرية: ",($==null?void 0:$.name)||L.walletProvider," - ",L.phone]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(ne/Math.max(he,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min($e/Math.max(de,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",ce(qe)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",ce(_e)," جنيه"]})]})]})})(),e.jsx(h,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:he=>{he.stopPropagation(),d(L)},children:"عرض التفاصيل الكاملة"})]})]},L.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(h,{onClick:p,variant:"outline",children:[e.jsx(wc,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},Kh=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Yh=({wallet:i,isOpen:p,onClose:d,onBack:v})=>{const{user:w}=da(),[C,s]=n.useState([]),[j,R]=n.useState(!1),[D,M]=n.useState("month"),{toast:E}=Gs();if(n.useEffect(()=>{if(!i||!(w!=null&&w.uid)||!p)return;(async()=>{R(!0);try{const rt=(await ti.getByUserId(w.uid)).filter(ie=>ie.walletId===i.id).sort((ie,Ce)=>new Date(Ce.createdAt).getTime()-new Date(ie.createdAt).getTime());s(rt)}catch(we){console.error("Error loading transactions:",we),E({title:"فشل جلب معاملات المحفظة",description:"قد تكون المشكلة بسبب صلاحيات Firestore أو الاتصال. تم عرض ما أمكن محليًا. جرّب تسجيل الدخول مجددًا أو صفحة اختبار المصادقة.",variant:"destructive"})}finally{R(!1)}})()},[i,w==null?void 0:w.uid,p]),!i)return null;const f=ee=>Kh.find(we=>we.id===ee),N=(ee,we)=>we>0?Math.min(ee/we*100,100):0,k=ee=>new Intl.NumberFormat("ar-EG").format(ee),K=ee=>new Date(ee).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),Q=(()=>{const ee=new Date;let we;switch(D){case"week":we=new Date(ee.getTime()-7*24*60*60*1e3);break;case"month":we=new Date(ee.getFullYear(),ee.getMonth(),1);break;default:return C}return C.filter(rt=>new Date(rt.createdAt)>=we)})(),te=ee=>{const we=ee.type,rt=ee.txnType;return we==="withdraw"||we==="withdrawal"||we==="receive"||rt==="receive"},ce=ee=>{const we=ee.type,rt=ee.txnType;return we==="send"||we==="transfer"||rt==="send"},L=Q.filter(ee=>te(ee)&&ee.status==="completed").reduce((ee,we)=>{const rt=we.withdrawnAmount!==void 0?we.withdrawnAmount:we.amount;return ee+(rt||0)},0),$=Q.filter(ee=>ce(ee)&&ee.status==="completed").reduce((ee,we)=>{const rt=we.sentAmount!==void 0?we.sentAmount:we.amount;return ee+(rt||0)},0),ve=Q.filter(ee=>ee.type==="deposit"&&ee.status==="completed").reduce((ee,we)=>ee+we.amount,0),Se=Q.filter(ee=>ee.status==="completed"),he=Se.length,de=Se.reduce((ee,we)=>{if(te(we)){const rt=we.withdrawnAmount??we.receivedAmount??we.amount??0;return ee+Yo(Number(rt)||0,"receive")}if(ce(we)){const rt=we.sentAmount??we.transferredAmount??we.amount??0;return ee+Yo(Number(rt)||0,"send")}return ee},0),ne=f(i.walletProvider||""),$e=N(i.monthlyWithdrawalUsage||0,i.monthlyWithdrawalLimit),qe=N(i.monthlyTransferUsage||0,i.monthlyTransferLimit),_e=ee=>{switch(ee){case"withdrawal":return e.jsx(Gn,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(Jr,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx(Yt,{className:"h-4 w-4 text-green-500"});default:return e.jsx(Yn,{className:"h-4 w-4 text-gray-500"})}},Ye=ee=>{switch(ee){case"completed":return e.jsx(Wa,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(Na,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(Zn,{className:"h-4 w-4 text-red-500"});default:return e.jsx(er,{className:"h-4 w-4 text-gray-500"})}},Je=ee=>{switch(ee){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},dt=ee=>{switch(ee){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(ge,{open:p,onOpenChange:d,children:e.jsxs(fe,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ye,{className:"pb-4",children:e.jsxs(be,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Gr,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",i.name,i.isDefault&&e.jsxs(Qt,{variant:"default",className:"mr-2",children:[e.jsx(bc,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(Et,{children:[e.jsx(hs,{children:e.jsxs(Ts,{className:"text-sm flex items-center gap-2",children:[e.jsx(ei,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(Ft,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(wa,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.phone})]}),i.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ei,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.nationalId})]}),ne&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Sc,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:ne.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",ne.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",ne.nationalId]})]})]}),i.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx($a,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(i.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs(Et,{children:[e.jsx(hs,{children:e.jsxs(Ts,{className:"text-sm flex items-center gap-2",children:[e.jsx(Qn,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(Ft,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Gn,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[k(i.monthlyWithdrawalUsage||0)," / ",k(i.monthlyWithdrawalLimit)]})]}),e.jsx(ec,{value:$e,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",k(i.monthlyWithdrawalLimit-(i.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(ul,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Jr,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[k(i.monthlyTransferUsage||0)," / ",k(i.monthlyTransferLimit)]})]}),e.jsx(ec,{value:qe,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",k(i.monthlyTransferLimit-(i.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(Et,{children:e.jsxs(Ft,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Gn,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:k(L)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx(Et,{children:e.jsxs(Ft,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Jr,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:k($)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx(Et,{children:e.jsxs(Ft,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Yt,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:k(ve)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})}),e.jsx(Et,{children:e.jsxs(Ft,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Qn,{className:"h-5 w-5 text-emerald-600"})}),e.jsx("div",{className:"text-lg font-bold",children:k(de)}),e.jsx("div",{className:"text-xs text-gray-600",children:"أرباح الفترة"})]})}),e.jsx(Et,{children:e.jsxs(Ft,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Yn,{className:"h-5 w-5 text-purple-600"})}),e.jsx("div",{className:"text-lg font-bold",children:k(he)}),e.jsx("div",{className:"text-xs text-gray-600",children:"عدد العمليات"})]})})]}),e.jsxs(Et,{children:[e.jsx(hs,{children:e.jsxs(Ts,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Yn,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{size:"sm",variant:D==="week"?"default":"outline",onClick:()=>M("week"),className:"text-xs",children:"أسبوع"}),e.jsx(h,{size:"sm",variant:D==="month"?"default":"outline",onClick:()=>M("month"),className:"text-xs",children:"شهر"}),e.jsx(h,{size:"sm",variant:D==="all"?"default":"outline",onClick:()=>M("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(Ft,{children:j?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):Q.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Yn,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:Q.map(ee=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[_e(ee.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[Je(ee.type)," - ",k(ee.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:K(ee.createdAt)}),ee.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:ee.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[Ye(ee.status),e.jsx("span",{className:"text-xs",children:dt(ee.status)})]})]},ee.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(h,{onClick:v,variant:"outline",children:[e.jsx(wc,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(h,{onClick:d,variant:"outline",children:"إغلاق"})]})]})})},ol=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Hh=({isOpen:i,onClose:p,onWalletUpdate:d,initialEditingWallet:v})=>{const{toast:w}=Gs(),{user:C,userSubscription:s}=da();(()=>{var Oe,gt;const W=((Oe=s==null?void 0:s.subscription)==null?void 0:Oe.planType)??((gt=s==null?void 0:s.subscription)==null?void 0:gt.plan)??(s==null?void 0:s.planType)??(s==null?void 0:s.plan)??null,Ne=typeof W=="string"?String(W).trim().toLowerCase():null;return W===Is.TAHWEELA||Ne==="tahweela"||Ne==="تحويله"})();const j=dc(),[R,D]=n.useState([]),[M,E]=n.useState(!1),[f,N]=n.useState(null),[k,K]=n.useState(""),[F,Q]=n.useState(""),[te,ce]=n.useState(""),[L,$]=n.useState(""),[ve,Se]=n.useState("200000"),[he,de]=n.useState("200000"),[ne,$e]=n.useState("100000"),[qe,_e]=n.useState("60000"),[Ye,Je]=n.useState(!1),[dt,ee]=n.useState(null),[we,rt]=n.useState(!1),[ie,Ce]=n.useState(!1),[vt,ss]=n.useState(!1),[Bt,as]=n.useState(null),Pe=()=>`wallets_${(C==null?void 0:C.uid)||"default"}`;n.useEffect(()=>{v&&(N(v),E(!0),K(v.name||""),Q(v.phone||""),ce(v.nationalId||""),$(v.walletProvider||""),Se((v.monthlyWithdrawalLimit||2e5).toString()),de((v.monthlyTransferLimit||2e5).toString()),$e((v.dailyWithdrawalLimit||1e5).toString()),_e((v.dailyTransferLimit||6e4).toString()),Je(!!v.isDefault))},[v]);const et=W=>{const Ne=new Date,Oe=Ne.getMonth(),gt=Ne.getFullYear();if(!W.lastResetDate)return{...W,monthlyWithdrawalUsage:W.monthlyWithdrawalUsage||0,monthlyTransferUsage:W.monthlyTransferUsage||0,lastResetDate:Ne.toISOString().split("T")[0]};const ot=new Date(W.lastResetDate),Mt=ot.getMonth(),Lt=ot.getFullYear();return Oe!==Mt||gt!==Lt?{...W,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:Ne.toISOString().split("T")[0]}:W},mt=async(W,Ne)=>{const Oe=new Date().getMonth(),gt=new Date().getFullYear(),ot=Ne.filter(Nt=>{const st=new Date(Nt.createdAt);return st.getMonth()===Oe&&st.getFullYear()===gt&&Nt.lineId===W}),Mt=ot.filter(Nt=>Nt.txnType==="receive").reduce((Nt,st)=>Nt+(st.amount||0),0),Lt=ot.filter(Nt=>Nt.txnType==="send").reduce((Nt,st)=>Nt+(st.amount||0),0);return{withdrawalUsage:Mt,transferUsage:Lt}},De=async(W,Ne)=>{const Oe=new Date,gt=Oe.getDate(),ot=Oe.getMonth(),Mt=Oe.getFullYear(),Lt=Ne.filter($t=>{const kt=new Date($t.createdAt);return kt.getDate()===gt&&kt.getMonth()===ot&&kt.getFullYear()===Mt&&$t.lineId===W}),Nt=Lt.filter($t=>$t.txnType==="receive").reduce(($t,kt)=>$t+(kt.amount||0),0),st=Lt.filter($t=>$t.txnType==="send").reduce(($t,kt)=>$t+(kt.amount||0),0);return{withdrawalUsage:Nt,transferUsage:st}};n.useEffect(()=>{(async()=>{if(!(C!=null&&C.uid)){console.log("No user authenticated, skipping wallet loading"),rt(!1);return}console.log("Loading wallets for user:",C.uid),rt(!0);try{const{auth:Ne}=await bt(async()=>{const{auth:st}=await import("./index-gOTNP7ME.js").then($t=>$t.bO);return{auth:st}},__vite__mapDeps([0,1]),import.meta.url);let Oe=0;const gt=5;for(;!Ne.currentUser&&Oe<gt;)console.log(`Waiting for auth state... attempt ${Oe+1}`),await new Promise(st=>setTimeout(st,1e3)),Oe++;if(!Ne.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",Ne.currentUser.uid),console.log("Context User:",C.uid),console.log("Fetching wallets from Firebase...");const ot=await sa.getByMerchantId(C.uid);console.log("Fetched wallets:",ot),console.log("Fetching transactions from Firebase...");const Mt=await ti.getByUserId(C.uid);console.log("Fetched transactions:",Mt);const Nt=(await Promise.all(ot.map(async st=>{const{withdrawalUsage:$t,transferUsage:kt}=await mt(st.id,Mt),{withdrawalUsage:Qs,transferUsage:Vt}=await De(st.id,Mt);return{id:st.id,name:st.label||"محفظة بدون اسم",phone:st.msisdn,isDefault:!1,monthlyWithdrawalLimit:st.withdrawLimit||2e5,monthlyTransferLimit:st.transferLimit||2e5,dailyWithdrawalLimit:st.dailyWithdrawLimit||1e5,dailyTransferLimit:st.dailyTransferLimit||6e4,monthlyWithdrawalUsage:$t,monthlyTransferUsage:kt,dailyWithdrawalUsage:Qs,dailyTransferUsage:Vt,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:st.defaultTransferCommission!=null?Number(st.defaultTransferCommission):null,defaultWithdrawCommission:st.defaultWithdrawCommission!=null?Number(st.defaultWithdrawCommission):null}}))).map(et);D(Nt),console.log("Wallets loaded successfully:",Nt)}catch(Ne){console.error("Error loading wallets:",Ne),D([])}finally{rt(!1)}})()},[C==null?void 0:C.uid]);const ht=()=>{K(""),Q(""),ce(""),$(""),Se("200000"),de("200000"),$e("100000"),_e("60000"),Je(!1),N(null),E(!1)},q=async()=>{if(!k.trim()||!F.trim()||!L.trim()){w({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(C!=null&&C.uid)){w({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}rt(!0);try{if(f){await sa.update(f.id,{label:k.trim(),msisdn:F.trim(),withdrawLimit:parseInt(ve),transferLimit:parseInt(he),dailyWithdrawLimit:parseInt(ne),dailyTransferLimit:parseInt(qe)}),await Ks.setLimits(f.id,{dailyTransferLimit:parseInt(qe||"0"),dailyWithdrawLimit:parseInt(ne||"0"),monthlyTransferLimit:parseInt(he||"0"),monthlyWithdrawLimit:parseInt(ve||"0")});const W=R.map(Ne=>Ne.id===f.id?{...Ne,name:k.trim(),phone:F.trim(),nationalId:te.trim(),walletProvider:L,monthlyWithdrawalLimit:parseInt(ve),monthlyTransferLimit:parseInt(he),dailyWithdrawalLimit:parseInt(ne),dailyTransferLimit:parseInt(qe)}:Ne);D(W),localStorage.setItem(Pe(),JSON.stringify(W)),w({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const W={merchantUserId:C.uid,provider:L,msisdn:F.trim(),label:k.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(ve),transferLimit:parseInt(he),dailyTransferLimit:parseInt(qe),dailyWithdrawLimit:parseInt(ne),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},Ne=await sa.create(W);await Ks.setLimits(Ne,{dailyTransferLimit:parseInt(qe||"0"),dailyWithdrawLimit:parseInt(ne||"0"),monthlyTransferLimit:parseInt(he||"0"),monthlyWithdrawLimit:parseInt(ve||"0")});const Oe=new Date().toISOString().split("T")[0],gt={id:Ne,name:k.trim(),phone:F.trim(),nationalId:te.trim(),walletProvider:L,isDefault:Ye,monthlyWithdrawalLimit:parseInt(ve),monthlyTransferLimit:parseInt(he),dailyWithdrawalLimit:parseInt(ne),dailyTransferLimit:parseInt(qe),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:Oe,defaultTransferCommission:null,defaultWithdrawCommission:null},ot=[...R,gt];D(ot),localStorage.setItem(Pe(),JSON.stringify(ot)),w({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}d&&d(),ht(),E(!1),N(null)}catch(W){console.error("Error saving wallet:",W),w({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{rt(!1)}},Dt=W=>{N(W),K(W.name),Q(W.phone),ce(W.nationalId||""),$(W.walletProvider||""),Se(W.monthlyWithdrawalLimit.toString()),de(W.monthlyTransferLimit.toString()),Je(W.isDefault),E(!0)},Pt=async W=>{const Ne=R.find(Oe=>Oe.id===W);if(Ne!=null&&Ne.isDefault){w({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(C!=null&&C.uid)){w({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}rt(!0);try{await sa.delete(W);const Oe=R.filter(gt=>gt.id!==W);D(Oe),localStorage.setItem(Pe(),JSON.stringify(Oe)),d&&d(),w({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(Oe){console.error("Error deleting wallet:",Oe),w({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{rt(!1)}},wt=W=>{const Ne=R.map(Oe=>({...Oe,isDefault:Oe.id===W}));D(Ne),localStorage.setItem(Pe(),JSON.stringify(Ne)),d&&d(),w({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(ge,{open:i,onOpenChange:p,children:[e.jsxs(fe,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(ye,{className:"pb-2",children:e.jsxs(be,{className:"flex items-center gap-1 text-sm",children:[e.jsx(oa,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",R.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{onClick:()=>{ss(!0)},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(Rt,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(h,{onClick:()=>{p(),j("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(vs,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),(M||f)&&e.jsxs(Et,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx(hs,{className:"pb-1",children:e.jsx(Ts,{className:"text-sm",children:f?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(Ft,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(_a,{value:L,onValueChange:$,children:[e.jsx(Oa,{className:"h-6 text-xs flex-1",children:e.jsx(Ea,{placeholder:"اختر شركة المحفظة"})}),e.jsx(Ma,{children:ol.map(W=>e.jsx(ta,{value:W.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:W.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:Ne=>{Ne.preventDefault(),Ne.stopPropagation(),ee(W.id)},children:e.jsx(xl,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},W.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx(U,{value:k,onChange:W=>K(W.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx(wa,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{value:F,onChange:W=>Q(W.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx(ei,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{value:te,onChange:W=>ce(W.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Yt,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{type:"number",value:ve,onChange:W=>Se(W.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Yt,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{type:"number",value:he,onChange:W=>de(W.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Gn,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx(U,{type:"number",value:ne,onChange:W=>$e(W.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Jr,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx(U,{type:"number",value:qe,onChange:W=>_e(W.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:Ye,onChange:W=>Je(W.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(mc,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(h,{onClick:q,className:"flex-1 h-6 text-xs",size:"sm",children:f?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(h,{variant:"outline",onClick:ht,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:R.map(W=>{var Ne;return e.jsxs(Et,{className:`${W.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx(hs,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ts,{className:"text-sm flex items-center gap-1",children:[e.jsx(oa,{className:"h-3 w-3"}),W.name]}),W.isDefault&&e.jsx(Qt,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(Ft,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(wa,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:W.phone})]}),W.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((Ne=ol.find(Oe=>Oe.id===W.walletProvider))==null?void 0:Ne.name)||W.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.monthlyWithdrawalUsage||0)/W.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.monthlyTransferUsage||0)/W.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(W.monthlyWithdrawalLimit-(W.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(W.monthlyTransferLimit-(W.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.dailyWithdrawalUsage||0)/W.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.dailyTransferUsage||0)/W.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify بين items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(W.dailyWithdrawalLimit-(W.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(W.dailyTransferLimit-(W.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(h,{size:"sm",variant:"outline",onClick:()=>Dt(W),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(vc,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!W.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",variant:"outline",onClick:()=>wt(W.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(h,{size:"sm",variant:"destructive",onClick:()=>Pt(W.id),className:"h-5 px-1",children:e.jsx(ms,{className:"h-2 w-2"})})]})]})]})]},W.id)})}),R.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),dt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>ee(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(hc,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const W=ol.find(Ne=>Ne.id===dt);return W?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:W.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:W.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:W.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(xl,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(gs,{open:vt,onOpenChange:ss,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{ss(!1),Ce(!0)}}),e.jsx(Jh,{isOpen:ie,onClose:()=>Ce(!1),onWalletSelect:W=>{as(W),Ce(!1)},onEditWallet:W=>{j(`/user/add-wallet?edit=1&id=${W.id}`),Ce(!1)},onDeleteWallet:async W=>{try{if(await sa.delete(W),D(Ne=>{const Oe=Ne.filter(gt=>gt.id!==W);try{localStorage.setItem(Pe(),JSON.stringify(Oe))}catch(gt){console.error("Failed to update localStorage wallets after delete:",gt)}return Oe}),d)try{await d()}catch(Ne){console.error("onWalletUpdate callback failed:",Ne)}}catch(Ne){console.error("Error deleting wallet:",Ne)}}}),e.jsx(Yh,{wallet:Bt,isOpen:!!Bt,onClose:()=>as(null),onBack:()=>{as(null),Ce(!0)}})]})},Gh=({isOpen:i,onClose:p,transaction:d,onDelete:v})=>{if(!d)return null;const w=D=>{switch(D){case"completed":return e.jsx(Wa,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(Na,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(Zn,{className:"h-5 w-5 text-red-500"});default:return e.jsx(Na,{className:"h-5 w-5 text-gray-500"})}},C=D=>{switch(D){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},s=D=>{switch(D){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},j=()=>{const D=!!d.senderNumber,M=!!d.senderName,E=D?"الرقم المرسل:":M?"الرقم الراسل:":"رقم المحفظة:",f=D?d.senderNumber:M?d.senderName:d.senderPhone,N=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${d.transactionReference||d.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${d.merchantShopName||d.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${s(d.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${d.status==="completed"?"#16a34a":d.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${C(d.status)}
            </span>
          </div>

          ${d!=null&&d.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${d.cashierName}</span>
            </div>
          `:""}
          
          ${d.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${E}</span>
              <span style="color: #1e293b;">${f}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${d.receiverNumber||d.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${Ns(d.transferredAmount||d.amount)} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${d.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${Ns(d.withdrawnAmountDetailed||d.withdrawnAmount||d.amount)} جنيه</span>
            </div>
          `}
          
          ${d.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${Ns(d.commission||0)} جنيه</span>
            </div>
          `:""}
          ${d.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الربح:</span>
              <span style="color: #16a34a; font-weight: 600;">${Ns(d.commission||0)} جنيه</span>
            </div>
          `:""}
          ${d!=null&&d.fee&&Number(d.fee)>0?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرسوم:</span>
              <span style="color: #64748b; font-weight: 600;">${Ns(d.fee||0)} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${d.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${d.type==="withdraw"?"-":""}${Ns(d.amount)} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,k=window.open("","_blank");k&&(k.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${d.transactionReference||d.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${N}
          </body>
        </html>
      `),k.document.close(),k.print())},R=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(v(d.id),p())};return e.jsx(ge,{open:i,onOpenChange:p,children:e.jsxs(fe,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ye,{children:e.jsxs(be,{className:"flex items-center gap-2 text-xl",children:[e.jsx(Qr,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(Et,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs(hs,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[w(d.status),e.jsx(Qt,{variant:d.status==="completed"?"default":"secondary",className:"text-sm",children:C(d.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[d.type==="withdraw"?"-":"",Ns(d.amount)," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",d.transactionReference||d.id]})]})}),e.jsxs(Et,{children:[e.jsx(hs,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(jc,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(Ft,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:d.merchantShopName||d.shopName||"غير محدد"})]}),(d==null?void 0:d.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:d.cashierName})]})]})]}),e.jsxs(Et,{children:[e.jsx(hs,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Gr,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(Ft,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(Qt,{variant:"outline",className:"bg-blue-100 text-blue-800",children:s(d.type)})]}),d.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const D=!!d.senderNumber,M=!!d.senderName,E=D?"الرقم المرسل:":M?"الرقم الراسل:":"رقم المحفظة:",f=D?d.senderNumber:M?d.senderName:d.senderPhone,N=D?hl:wa;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:E})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:f})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(Ym,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(hl,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:d.receiverNumber||d.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Yt,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[Ns(d.transferredAmount||d.amount)," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(wa,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:d.senderPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Yt,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[Ns(d.withdrawnAmountDetailed||d.withdrawnAmount||d.amount)," جنيه"]})]})]}),d.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[d.commission," جنيه"]})]}),d.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-green-700",children:"الربح:"}),e.jsxs("span",{className:"text-green-900 font-semibold",children:[d.commission," جنيه"]})]}),(d==null?void 0:d.fee)&&Number(d.fee)>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الرسوم:"}),e.jsxs("span",{className:"text-gray-900 font-semibold",children:[d.fee," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($a,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:d.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(h,{onClick:j,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx(vh,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(h,{onClick:R,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(ms,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(h,{onClick:p,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function rc({open:i,onOpenChange:p,onSuccess:d,title:v,description:w,currentBalance:C,balanceLabel:s,userId:j}){const[R,D]=n.useState(""),[M,E]=n.useState(C.toString()),[f,N]=n.useState(!1),[k,K]=n.useState(""),[F,Q]=n.useState(!1),te=async L=>{L.preventDefault(),K(""),Q(!0);try{const $=parseFloat(M);if(isNaN($)||$<0){K("يرجى إدخال مبلغ صحيح"),Q(!1);return}await ws.hasMasterPin(j)?await ws.verifyMasterPin(R,j)?(d($),p(!1),D(""),E("")):K("الرقم السري غير صحيح"):K("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{K("حدث خطأ أثناء التحقق من الرقم السري")}finally{Q(!1)}},ce=()=>{D(""),E(C.toString()),K(""),p(!1)};return Ke.useEffect(()=>{i&&E(C.toString())},[C,i]),e.jsx(ge,{open:i,onOpenChange:ce,children:e.jsxs(fe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ye,{children:e.jsxs(be,{className:"flex items-center gap-2 text-right",children:[e.jsx(Yt,{className:"h-5 w-5"}),v]})}),e.jsxs("form",{onSubmit:te,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:w}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(Z,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[C.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx(U,{id:"newAmount",type:"number",step:"0.01",min:"0",value:M,onChange:L=>E(L.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"pin",type:f?"text":"password",value:R,onChange:L=>D(L.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>N(!f),children:f?e.jsx(fs,{className:"h-4 w-4"}):e.jsx(Rt,{className:"h-4 w-4"})})]})]}),k&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(er,{className:"h-4 w-4"}),k]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(h,{type:"button",variant:"outline",onClick:ce,className:"flex-1",children:"إلغاء"}),e.jsx(h,{type:"submit",disabled:F||!R||!M,className:"flex-1",children:F?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Za,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class Hr{static getSecretKey(p){return p?`${this.SECRET_KEY_BASE}_${p}`:this.SECRET_KEY_BASE}static setSecretPin(p,d){const v=btoa(p);this.secretCache.set(this.getSecretKey(d),v)}static hasSecretPin(p){return this.secretCache.has(this.getSecretKey(p))}static verifySecretPin(p,d){const v=this.secretCache.get(this.getSecretKey(d));if(!v)return!1;try{return atob(v)===p}catch{return!1}}static clearSecretPin(p){this.secretCache.delete(this.getSecretKey(p))}}nl(Hr,"SECRET_KEY_BASE","dashboard_secret_pin"),nl(Hr,"secretCache",new Map);function Qh({open:i,onOpenChange:p,userId:d}){const[v,w]=n.useState(""),[C,s]=n.useState(""),[j,R]=n.useState(""),[D,M]=n.useState(!1),[E,f]=n.useState(!1),[N,k]=n.useState(!1),[K,F]=n.useState(""),[Q,te]=n.useState(!1),{toast:ce}=Gs(),L=Hr.hasSecretPin(d),$=async Se=>{Se.preventDefault(),F(""),te(!0);try{if(!C||C.length<4){F("يجب أن يكون الرقم السري 4 أرقام على الأقل"),te(!1);return}if(C!==j){F("الرقم السري الجديد وتأكيده غير متطابقين"),te(!1);return}if(L){if(!v){F("يرجى إدخال الرقم السري الحالي"),te(!1);return}if(!Hr.verifySecretPin(v,d)){F("الرقم السري الحالي غير صحيح"),te(!1);return}}Hr.setSecretPin(C,d),ce({title:L?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:L?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),ve()}catch{F("حدث خطأ أثناء حفظ الرقم السري")}finally{te(!1)}},ve=()=>{w(""),s(""),R(""),F(""),M(!1),f(!1),k(!1),p(!1)};return e.jsx(ge,{open:i,onOpenChange:ve,children:e.jsxs(fe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ye,{children:e.jsxs(be,{className:"flex items-center gap-2 text-right",children:[e.jsx(mc,{className:"h-5 w-5"}),L?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:$,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:L?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),L&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"currentPin",type:D?"text":"password",autoComplete:"off",value:v,onChange:Se=>w(Se.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>M(!D),children:D?e.jsx(fs,{className:"h-4 w-4"}):e.jsx(Rt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"newPin",type:E?"text":"password",autoComplete:"off",value:C,onChange:Se=>s(Se.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>f(!E),children:E?e.jsx(fs,{className:"h-4 w-4"}):e.jsx(Rt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:N?"text":"password",autoComplete:"off",value:j,onChange:Se=>R(Se.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>k(!N),children:N?e.jsx(fs,{className:"h-4 w-4"}):e.jsx(Rt,{className:"h-4 w-4"})})]})]}),K&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(er,{className:"h-4 w-4"}),K]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:Q,className:"flex-1",children:[e.jsx(Za,{className:"h-4 w-4 mr-2"}),Q?"جاري الحفظ...":L?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(h,{type:"button",variant:"outline",onClick:ve,disabled:Q,children:"إلغاء"})]})]})]})})}const cl=new Map;function Zh({open:i,onOpenChange:p,userId:d}){const[v,w]=n.useState(""),[C,s]=n.useState(""),[j,R]=n.useState(""),[D,M]=n.useState(!1),[E,f]=n.useState(!1),[N,k]=n.useState(!1),[K,F]=n.useState(""),[Q,te]=n.useState(!1),{toast:ce}=Gs(),L=d?`cash_drawer_pin_${d}`:"cash_drawer_pin",$=()=>cl.has(L),ve=ne=>{const $e=cl.get(L);if(!$e)return!1;try{return atob($e)===ne}catch{return!1}},Se=ne=>{const $e=btoa(ne);cl.set(L,$e)},he=async ne=>{ne.preventDefault(),F(""),te(!0);try{if(!C||C.length<4){F("يجب أن يكون الرقم السري 4 أرقام على الأقل"),te(!1);return}if(C!==j){F("الرقم السري الجديد وتأكيده غير متطابقين"),te(!1);return}if($()){if(!v){F("يرجى إدخال الرقم السري الحالي لدرج النقدية"),te(!1);return}if(!ve(v)){F("الرقم السري الحالي لدرج النقدية غير صحيح"),te(!1);return}}Se(C),ce({title:$()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:$()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),de()}catch{F("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{te(!1)}},de=()=>{w(""),s(""),R(""),F(""),M(!1),f(!1),k(!1),p(!1)};return e.jsx(ge,{open:i,onOpenChange:de,children:e.jsxs(fe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ye,{children:e.jsxs(be,{className:"flex items-center gap-2 text-right",children:[e.jsx(Yt,{className:"h-5 w-5 text-green-600"}),$()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:he,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:$()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),$()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"currentPin",type:D?"text":"password",autoComplete:"off",value:v,onChange:ne=>w(ne.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>M(!D),children:D?e.jsx(fs,{className:"h-4 w-4"}):e.jsx(Rt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"newPin",type:E?"text":"password",autoComplete:"off",value:C,onChange:ne=>s(ne.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>f(!E),children:E?e.jsx(fs,{className:"h-4 w-4"}):e.jsx(Rt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:N?"text":"password",autoComplete:"off",value:j,onChange:ne=>R(ne.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>k(!N),children:N?e.jsx(fs,{className:"h-4 w-4"}):e.jsx(Rt,{className:"h-4 w-4"})})]})]}),K&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(er,{className:"h-4 w-4"}),K]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:Q,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Za,{className:"h-4 w-4 mr-2"}),Q?"جاري الحفظ...":$()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(h,{type:"button",variant:"outline",onClick:de,disabled:Q,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}const dl=new Map;function Xh({open:i,onOpenChange:p,userId:d}){const[v,w]=n.useState(""),[C,s]=n.useState(""),[j,R]=n.useState(""),[D,M]=n.useState(!1),[E,f]=n.useState(!1),[N,k]=n.useState(!1),[K,F]=n.useState(""),[Q,te]=n.useState(!1),{toast:ce}=Gs(),L=d?`wallet_total_pin_${d}`:"wallet_total_pin",$=()=>dl.has(L),ve=ne=>{const $e=dl.get(L);if(!$e)return!1;try{return atob($e)===ne}catch{return!1}},Se=ne=>{const $e=btoa(ne);dl.set(L,$e)},he=async ne=>{ne.preventDefault(),F(""),te(!0);try{if(!C||C.length<4){F("يجب أن يكون الرقم السري 4 أرقام على الأقل"),te(!1);return}if(C!==j){F("الرقم السري الجديد وتأكيده غير متطابقين"),te(!1);return}if($()){if(!v){F("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),te(!1);return}if(!ve(v)){F("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),te(!1);return}}Se(C),ce({title:$()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:$()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),de()}catch{F("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{te(!1)}},de=()=>{w(""),s(""),R(""),F(""),M(!1),f(!1),k(!1),p(!1)};return e.jsx(ge,{open:i,onOpenChange:de,children:e.jsxs(fe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ye,{children:e.jsxs(be,{className:"flex items-center gap-2 text-right",children:[e.jsx(oa,{className:"h-5 w-5 text-blue-600"}),$()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:he,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:$()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),$()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"currentPin",type:D?"text":"password",autoComplete:"off",value:v,onChange:ne=>w(ne.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>M(!D),children:D?e.jsx(fs,{className:"h-4 w-4"}):e.jsx(Rt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"newPin",type:E?"text":"password",autoComplete:"off",value:C,onChange:ne=>s(ne.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>f(!E),children:E?e.jsx(fs,{className:"h-4 w-4"}):e.jsx(Rt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:N?"text":"password",autoComplete:"off",value:j,onChange:ne=>R(ne.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>k(!N),children:N?e.jsx(fs,{className:"h-4 w-4"}):e.jsx(Rt,{className:"h-4 w-4"})})]})]}),K&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(er,{className:"h-4 w-4"}),K]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:Q,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(Za,{className:"h-4 w-4 mr-2"}),Q?"جاري الحفظ...":$()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(h,{type:"button",variant:"outline",onClick:de,disabled:Q,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function eu({open:i,onOpenChange:p,onSuccess:d,title:v,description:w,currentBalance:C,balanceLabel:s,userId:j}){const[R,D]=n.useState(""),[M,E]=n.useState(""),[f,N]=n.useState("add"),[k,K]=n.useState(!1),[F,Q]=n.useState(""),[te,ce]=n.useState(!1),[L,$]=n.useState(!1);n.useEffect(()=>{let de=!0;return(async()=>{const ne=await ws.hasMasterPin(j);de&&$(ne)})(),()=>{de=!1}},[j,i]);const ve=async de=>{de.preventDefault(),Q(""),ce(!0);try{const ne=parseFloat(M);if(isNaN(ne)||ne<=0){Q("يرجى إدخال مبلغ صحيح أكبر من صفر"),ce(!1);return}if(f==="subtract"&&ne>C){Q("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),ce(!1);return}if(L)if(await ws.verifyMasterPin(R,j)){const qe=f==="add"?ne:-ne;Se(),d(qe)}else Q("الرقم السري غير صحيح");else Q("لم يتم تعيين الرقم السري الرئيسي. يرجى تعيينه من إعدادات البروفيل أولاً")}catch{Q("حدث خطأ أثناء التحقق من الرقم السري")}finally{ce(!1)}},Se=()=>{D(""),E(""),N("add"),Q(""),p(!1)},he=()=>{const de=parseFloat(M)||0;return f==="add"?C+de:C-de};return e.jsx(ge,{open:i,onOpenChange:Se,children:e.jsxs(fe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ye,{children:e.jsxs(be,{className:"flex items-center gap-2 text-right",children:[f==="add"?e.jsx(vs,{className:"h-5 w-5 text-green-600"}):e.jsx(Qa,{className:"h-5 w-5 text-red-600"}),v]})}),e.jsxs("form",{onSubmit:ve,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:w}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(Z,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[C.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{type:"button",variant:f==="add"?"default":"outline",onClick:()=>N("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(vs,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(h,{type:"button",variant:f==="subtract"?"default":"outline",onClick:()=>N("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(Qa,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Z,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",f==="add"?"إضافته":"خصمه"]}),e.jsx(U,{id:"amount",type:"number",step:"0.01",min:"0.01",value:M,onChange:de=>E(de.target.value),placeholder:`أدخل المبلغ المراد ${f==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),M&&!isNaN(parseFloat(M))&&e.jsxs("div",{className:`p-3 rounded-lg ${f==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(Z,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${f==="add"?"text-green-700":"text-red-700"}`,children:[he().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"pin",type:k?"text":"password",autoComplete:"off",value:R,onChange:de=>D(de.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>K(!k),children:k?e.jsx(fs,{className:"h-4 w-4"}):e.jsx(Rt,{className:"h-4 w-4"})})]})]}),F&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(er,{className:"h-4 w-4"}),F]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(h,{type:"button",variant:"outline",onClick:Se,className:"flex-1",children:"إلغاء"}),e.jsx(h,{type:"submit",disabled:te||!R||!M,className:`flex-1 ${f==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:te?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Za,{className:"h-4 w-4 mr-2"}),f==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}const nc={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_APP_VERSION:"0.0.0",VITE_DEV_MODE:"true",VITE_ENABLE_OFFLINE_PERSISTENCE:"false",VITE_FIREBASE_API_KEY:"AIzaSyA33RTf43u2QE2OsK1RepQHSKrSet9ZI0s",VITE_FIREBASE_APP_ID:"1:483702062341:web:b1ff06ad175cb7ae428b6c",VITE_FIREBASE_AUTH_DOMAIN:"voda-c6abd.firebaseapp.com",VITE_FIREBASE_AUTH_EMULATOR_URL:"http://localhost:9099",VITE_FIREBASE_FIRESTORE_EMULATOR_HOST:"localhost:8080",VITE_FIREBASE_FUNCTIONS_EMULATOR_HOST:"localhost:5001",VITE_FIREBASE_MEASUREMENT_ID:"G-CV6QGH7G7P",VITE_FIREBASE_MESSAGING_SENDER_ID:"483702062341",VITE_FIREBASE_PROJECT_ID:"voda-c6abd",VITE_FIREBASE_STORAGE_BUCKET:"voda-c6abd.appspot.com",VITE_FORCE_HASH_ROUTER:"true",VITE_SHOP_ID:"demo-shop-001",VITE_SHOP_NAME:"محل كاشي لينك التجريبي",VITE_SHOW_ENV_BANNER:"true",VITE_USE_EMULATORS:"false",VITE_USE_FIREBASE_EMULATOR:"false"},Pa=i=>typeof i=="string"&&i.trim().length>0,tu={getCurrentMonthId(){const i=new Date;return`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}`},async getWalletUsage(i){var p;try{if(!Pa(i))return console.error("Error getting wallet usage: invalid walletId",i),null;const d=Ve(V,"walletLimits",i),v=await va(d);if(v.exists()){const C=v.data();return{walletId:i,used_transfer:C.monthlyTransferUsed??C.used_transfer??0,used_withdraw:C.monthlyWithdrawUsed??C.used_withdraw??0,monthly_limit:C.monthlyLimit??C.monthlyTransferLimit??C.monthlyWithdrawLimit??2e5,last_reset:C.lastMonthlyReset??C.last_reset??null,updatedAt:C.updatedAt||Ga.now()}}const w={walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:Ga.now()};return await Ys(d,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,monthlyTransferLimit:2e5,monthlyWithdrawLimit:2e5,lastMonthlyReset:null,updatedAt:xt(),ownerId:(p=dr.currentUser)==null?void 0:p.uid}),w}catch(d){return console.error("Error getting wallet usage:",d),{walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:Ga.now()}}},shouldResetLimits(i){const p=new Date,d=p.getDate();if(!i)return d===1;if(d===1){const v=i.toDate(),w=p.getMonth(),C=p.getFullYear();return v.getMonth()!==w||v.getFullYear()!==C}return!1},async autoResetLimitsIfNeeded(i){try{if(!Pa(i))return console.error("خطأ في التصفير التلقائي للحدود: walletId غير صالح",i),!1;typeof import.meta<"u";const p=await this.getWalletUsage(i);return p&&this.shouldResetLimits(p.last_reset)?(console.log(`🔄 تصفير تلقائي للحدود للمحفظة ${i} - اليوم الأول من الشهر`),await this.resetWalletUsage(i)):!1}catch(p){return console.error("خطأ في التصفير التلقائي للحدود:",p),!1}},async resetWalletUsage(i){try{if(!Pa(i))return console.error("خطأ في تصفير استخدام المحفظة: walletId غير صالح",i),!1;const p=Ve(V,"walletLimits",i);return await Ys(p,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:xt(),updatedAt:xt()},{merge:!0}),console.log(`🔄 تم تصفير استخدام المحفظة ${i} بنجاح`),!0}catch(p){return console.error("خطأ في تصفير استخدام المحفظة:",p),!1}},async calculateUsageFromTransactions(i){var p,d;try{if(!Pa(i))return console.error("خطأ في حساب الاستخدام من المعاملات: walletId غير صالح",i),{used_transfer:0,used_withdraw:0};const v=Ve(V,"walletLimits",i),w=new Date;let C=Ga.fromDate(new Date(w.getFullYear(),w.getMonth(),1));try{const M=await va(v);C=M.exists()?((p=M.data())==null?void 0:p.lastMonthlyReset)??((d=M.data())==null?void 0:d.last_reset)??C:C}catch{}const s=Ue(je(V,"tx"),ae("uid","==",i),...C?[ae("createdAt",">=",C)]:[]),j=await Qe(s);let R=0,D=0;return j.forEach(M=>{const E=M.data();E.status==="completed"&&(E.type==="transfer"?R+=E.amount:E.type==="withdraw"&&(D+=E.amount))}),{used_transfer:R,used_withdraw:D}}catch(v){return console.error("خطأ في حساب الاستخدام من المعاملات:",v),{used_transfer:0,used_withdraw:0}}},async getWalletUsageWithRefresh(i){var p,d;try{if(!Pa(i))return console.error("خطأ في الحصول على الاستخدام مع التحديث: walletId غير صالح",i),null;typeof import.meta<"u";const v=await this.getWalletUsage(i);if(!v){const C=await this.calculateUsageFromTransactions(i),s=Ve(V,"walletLimits",i);try{await Ys(s,{monthlyTransferUsed:C.used_transfer,monthlyWithdrawUsed:C.used_withdraw,updatedAt:xt(),ownerId:(p=dr.currentUser)==null?void 0:p.uid},{merge:!0})}catch{}return{walletId:i,used_transfer:C.used_transfer,used_withdraw:C.used_withdraw,monthly_limit:2e5,last_reset:null,updatedAt:Ga.now()}}const w=await this.calculateUsageFromTransactions(i);if(v.used_transfer!==w.used_transfer||v.used_withdraw!==w.used_withdraw){const C=Ve(V,"walletLimits",i);try{await Ys(C,{monthlyTransferUsed:w.used_transfer,monthlyWithdrawUsed:w.used_withdraw,updatedAt:xt(),ownerId:(d=dr.currentUser)==null?void 0:d.uid},{merge:!0})}catch{}return await this.getWalletUsage(i)}return v}catch(v){return console.error("خطأ في الحصول على الاستخدام مع التحديث:",v),{walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:Ga.now()}}},calculateRemaining(i){return{remainingTransfer:Math.max(0,i.monthly_limit-i.used_transfer),remainingWithdraw:Math.max(0,i.monthly_limit-i.used_withdraw)}},async canPerformOperation(i,p,d){try{if(!Pa(i))return console.error("Error checking operation limits: invalid walletId",i),{canPerform:!1,message:"walletId غير صالح"};const v=await this.getWalletUsageWithRefresh(i);if(!v)return{canPerform:!1,message:"لا يمكن العثور على بيانات الاستخدام للمحفظة"};const w=this.calculateRemaining(v);return d==="transfer"&&p>w.remainingTransfer?{canPerform:!1,message:`تجاوز حد التحويل المسموح. المتبقي: ${w.remainingTransfer.toLocaleString()} ج.م من أصل ${v.monthly_limit.toLocaleString()} ج.م`,remaining:w.remainingTransfer}:d==="withdraw"&&p>w.remainingWithdraw?{canPerform:!1,message:`تجاوز حد السحب المسموح. المتبقي: ${w.remainingWithdraw.toLocaleString()} ج.م من أصل ${v.monthly_limit.toLocaleString()} ج.م`,remaining:w.remainingWithdraw}:{canPerform:!0}}catch(v){return console.error("Error checking operation limits:",v),{canPerform:!1,message:"خطأ في التحقق من الحدود"}}},async updateUsage(i,p,d){var v;try{if(!Pa(i))throw new Error("walletId غير صالح");const w=await this.getWalletUsageWithRefresh(i);if(!w)throw new Error("لا يمكن العثور على بيانات الاستخدام للمحفظة");const C=await this.canPerformOperation(i,p,d);if(!C.canPerform)throw new Error(C.message||"لا يمكن إجراء العملية");const s=d==="transfer"?w.used_transfer+p:w.used_transfer,j=d==="withdraw"?w.used_withdraw+p:w.used_withdraw,R=Ve(V,"walletLimits",w.walletId);try{await Ys(R,{monthlyTransferUsed:s,monthlyWithdrawUsed:j,updatedAt:xt(),ownerId:(v=dr.currentUser)==null?void 0:v.uid},{merge:!0})}catch{}let D=await this.getWalletUsageWithRefresh(i);return D||(D={walletId:i,used_transfer:s,used_withdraw:j,monthly_limit:w.monthly_limit,last_reset:w.last_reset,updatedAt:Ga.now()}),D}catch(w){throw console.error("Error updating wallet usage:",w),w}},async resetWalletUsageManually(i){try{if(!Pa(i))throw new Error("walletId غير صالح");const p=Ve(V,"walletLimits",i),d={walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:0,last_reset:null,updatedAt:new Date};return Ys(p,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:xt(),updatedAt:xt()},{merge:!0}).catch(v=>{console.error("خطأ في حفظ تصفير الاستخدام في Firebase:",v)}),console.log(`✅ تم تصفير استخدام المحفظة ${i} بنجاح`),d}catch(p){throw console.error("Error resetting wallet usage:",p),p}},async getAllWalletsUsage(i){try{const d=(await sa.getByMerchantId(i)).map(w=>this.getWalletUsageWithRefresh(w.id));return(await Promise.all(d)).filter(w=>w!==null)}catch(p){return console.error("Error getting all wallets usage:",p),[]}}};function su(i){return i?`readBroadcastIds_${i}`:"readBroadcastIds_guest"}function au({className:i}){const{user:p,profile:d,isSubscriptionActive:v}=da(),w=uc(),[C,s]=n.useState([]),[j,R]=n.useState(new Set),[D,M]=n.useState(!1),[E,f]=n.useState(""),[N,k]=n.useState(!1),[K,F]=n.useState(null),[Q,te]=n.useState("none"),[ce,L]=n.useState(null),[$,ve]=n.useState(!1);n.useRef(new Set),n.useRef(!1);const Se=n.useRef(null),he=n.useRef(null);n.useRef(null);const[de,ne]=n.useState({position:"fixed",top:0,left:0,zIndex:1e4}),$e=!1,qe=n.useMemo(()=>{const ie=["global"];return p!=null&&p.uid&&ie.push(`user:${p.uid}`),d!=null&&d.shopId&&ie.push(`shop:${d.shopId}`),ie},[p==null?void 0:p.uid,d==null?void 0:d.shopId]),_e=su(p==null?void 0:p.uid),Ye=n.useMemo(()=>{var vt;const ie=(vt=w==null?void 0:w.pathname)==null?void 0:vt.includes("/user/pending-approval");return!!(p!=null&&p.uid)&&!ie},[p==null?void 0:p.uid,w==null?void 0:w.pathname]);n.useEffect(()=>{try{const ie=localStorage.getItem(_e);if(ie){const Ce=JSON.parse(ie);Array.isArray(Ce)&&R(new Set(Ce.filter(Boolean)))}else R(new Set)}catch(ie){console.warn("Failed to load read ids",ie),R(new Set)}},[_e]),n.useEffect(()=>{if(!Ye){s([]);return}const ie=Ch(qe,Ce=>{s(Ce)});return()=>ie()},[qe,Ye]),n.useEffect(()=>{},[C]),n.useEffect(()=>()=>{Se.current&&clearTimeout(Se.current)},[]);const Je=C.reduce((ie,Ce)=>ie+(Ce.id&&!j.has(Ce.id)?1:0),0),dt=ie=>{if(!ie||j.has(ie))return;const Ce=new Set(j);Ce.add(ie),R(Ce);try{localStorage.setItem(_e,JSON.stringify(Array.from(Ce)))}catch{}},ee=()=>{const ie=C.map(vt=>vt.id).filter(Boolean),Ce=new Set(j);ie.forEach(vt=>Ce.add(vt)),R(Ce);try{localStorage.setItem(_e,JSON.stringify(Array.from(Ce)))}catch{}},we=(ie,Ce)=>{ie&&window.open(ie,"_blank"),Ce&&dt(Ce)};n.useEffect(()=>{},[$]);const rt=async()=>{if(!(p!=null&&p.uid)){alert("يرجى تسجيل الدخول لإرسال الطلب.");return}const ie=E.trim();if(!ie){alert("يرجى كتابة سبب طلب التحدث.");return}try{k(!0),F(null);const Ce=d!=null&&d.fullName&&d.fullName.trim()?d.fullName.trim():p.email?p.email.split("@")[0]:"مستخدم",vt=(d==null?void 0:d.phone)||null;await Hs(je(V,"waiting_list"),{userId:p.uid,name:Ce,phone:vt,reason:ie,status:"pending",createdAt:xt()}),F("تم إرسال طلبك إلى قائمة الانتظار بنجاح ✅"),f(""),setTimeout(()=>M(!1),900)}catch(Ce){console.error("فشل إرسال طلب قائمة الانتظار:",Ce),alert("حدث خطأ أثناء إرسال الطلب. حاول مرة أخرى.")}finally{k(!1)}};return n.useEffect(()=>{if(!(p!=null&&p.uid)){te("none");return}let ie=null;try{const Ce=Ue(je(V,"waiting_list"),ae("userId","==",p.uid));ie=Ls(Ce,vt=>{const ss=vt.docs.map(Pe=>({id:Pe.id,...Pe.data()})).sort((Pe,et)=>{var ht,q,Dt,Pt,wt,W;const mt=((q=(ht=Pe==null?void 0:Pe.createdAt)==null?void 0:ht.toMillis)==null?void 0:q.call(ht))??((Dt=Pe==null?void 0:Pe.createdAt)==null?void 0:Dt.seconds)*1e3??0;return(((wt=(Pt=et==null?void 0:et.createdAt)==null?void 0:Pt.toMillis)==null?void 0:wt.call(Pt))??((W=et==null?void 0:et.createdAt)==null?void 0:W.seconds)*1e3??0)-mt});if(ss.length===0){te("none");return}const Bt=ss[0],as=(Bt==null?void 0:Bt.contacted)===!0||(Bt==null?void 0:Bt.status)==="contacted";te(as?"contacted":"pending")})}catch(Ce){console.warn("⚠️ فشل الاشتراك في waiting_list للمستخدم:",Ce),te("none")}return()=>{ie&&ie()}},[p==null?void 0:p.uid]),Ye?e.jsxs("div",{className:`relative inline-flex items-center gap-2 ${i||""}`,ref:he,children:[e.jsxs(Th,{onOpenChange:ie=>{ie&&Je>0&&ee()},children:[e.jsx(Ph,{asChild:!0,children:e.jsx(h,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:e.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[e.jsx(sc,{className:"h-4 w-4 text-primary"}),Je>0&&e.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:Je})]})})}),e.jsxs(kh,{className:"w-80",align:"end",forceMount:!0,children:[e.jsxs(_h,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"الإشعارات"}),C.length>0&&e.jsxs(h,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:ee,children:[e.jsx(Wa,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),e.jsx(Oh,{}),C.length===0?e.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):e.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:C.map(ie=>{const Ce=ie.id?!j.has(ie.id):!1;return e.jsx("div",{className:`px-2 py-2 rounded-md ${Ce?"bg-primary/5":""}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(sc,{className:`h-4 w-4 ${Ce?"text-primary":"text-muted-foreground"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium",children:ie.title||"إشعار"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:ie.message}),ie.linkUrl&&e.jsxs(h,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>we(ie.linkUrl,ie.id),children:["فتح الرابط ",e.jsx(Ih,{className:"h-3 w-3 ml-1"})]})]}),Ce?e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>dt(ie.id),title:"تمييز كمقروء",children:e.jsx(Wa,{className:"h-4 w-4 text-primary"})}):e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:e.jsx(Wa,{className:"h-4 w-4 text-muted-foreground"})})]})},ie.id)})})]})]}),e.jsxs(ge,{open:D,onOpenChange:M,children:[e.jsx(Hm,{asChild:!0,children:e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full hover:bg-transparent focus:ring-1 focus:ring-primary/60 focus:ring-offset-1",title:"قائمة الانتظار",children:e.jsx(Na,{className:`h-4 w-4 ${Q==="pending"?"text-red-600":Q==="contacted"?"text-green-600":"text-muted-foreground"}`})})}),e.jsxs(fe,{className:"max-w-md border border-purple-200/50 shadow-xl bg-gradient-to-br from-purple-50 to-blue-50",children:[e.jsxs(ye,{children:[e.jsx(be,{children:"طلب التحدث"}),e.jsx(ps,{children:"يرجى كتابة سبب طلب التحدث ليصل للإدارة في قسم قائمة الانتظار."})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"سبب الطلب"}),e.jsx(Ah,{value:E,onChange:ie=>f(ie.target.value),placeholder:"اكتب سبب طلب التحدث هنا...",className:"min-h-[120px] text-right"}),K&&e.jsx("div",{className:"text-sm text-green-700 bg-green-50 border border-green-200 rounded-md p-2",children:K})]}),e.jsxs(lt,{children:[e.jsx(h,{variant:"outline",onClick:()=>M(!1),disabled:N,children:"إلغاء"}),e.jsx(h,{onClick:rt,disabled:N,className:"bg-gradient-to-r from-green-600 to-emerald-600 text-white",children:N?"جارٍ الإرسال...":"إرسال"})]})]})]}),$e]}):null}const ic=({isOpen:i,onClose:p,onTrialStarted:d})=>{const{user:v}=da(),[w,C]=n.useState(!1),[s,j]=n.useState(!1),[R,D]=n.useState(""),[M,E]=n.useState(24);n.useEffect(()=>{const k=async()=>{if(v!=null&&v.uid){const F=await Kr.getTrialData(v.uid);j(F.hasUsedFreeTrial)}},K=async()=>{try{const F=await Kr.getTrialDurationHours();E(F)}catch{}};i&&(k(),K())},[i,v]);const f=async()=>{if(v!=null&&v.uid){C(!0);try{const k=await Kr.startFreeTrial(v.uid);k.success?(D(k.message),window.location.href="/user/dashboard"):D(k.message||"تعذر تفعيل التجربة المجانية")}catch{D("حدث خطأ أثناء تفعيل التجربة المجانية")}finally{C(!1)}}},N=async()=>{if(v!=null&&v.uid){C(!0);try{await Gm(v.uid,Is.ZERO,v.uid),window.location.href="/user/dashboard"}catch{D("حدث خطأ أثناء تفعيل باقة الزيرو")}finally{C(!1)}}};return e.jsxs(e.Fragment,{children:[i&&e.jsx("div",{className:"fixed inset-0 z-40",style:{background:"rgba(0, 0, 0, 0.15)",pointerEvents:"auto"}}),e.jsx(ge,{open:i,onOpenChange:()=>{},children:e.jsxs(fe,{className:"sm:max-w-lg z-50 border-0 shadow-2xl",style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"auto",background:"linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%)",borderRadius:"20px",border:"1px solid rgba(255, 255, 255, 0.3)"},children:[e.jsxs(ye,{className:"text-center pb-0 pt-0",children:[e.jsx("div",{className:"flex justify-center mb-1",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 rounded-full",style:{background:"linear-gradient(135deg, #f59e0b, #d97706)",filter:"blur(8px)",opacity:.3}}),e.jsx("div",{className:"relative bg-gradient-to-br from-orange-400 to-orange-600 p-2 rounded-full",children:e.jsx(il,{className:"h-12 w-12 text-white"})})]})}),e.jsx(be,{className:"text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent text-center mt-0 mb-0 leading-tight",children:"تفعيل الحساب مطلوب"})]}),e.jsxs("div",{className:"text-center pt-6 pb-0 px-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-6 mb-6 border border-orange-100",children:[e.jsx("p",{className:"text-gray-700 text-lg leading-relaxed font-medium",children:"حسابك في انتظار التفعيل من قبل المسؤول"}),e.jsx("p",{className:"text-sm font-semibold text-orange-700 mt-3 mb-3 bg-orange-100 p-3 rounded-lg border border-orange-200",children:"للتفعيل السريع: تواصل مع الإدارة عبر واتساب فقط على الرقم التالي"}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg border border-green-200 mt-3",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-base font-bold text-green-700",children:"واتساب الإدارة:"}),e.jsx("a",{href:"https://wa.me/201000392539",target:"_blank",rel:"noopener noreferrer",className:"text-lg font-bold text-green-600 hover:text-green-700 underline",children:"01000392539"})]}),e.jsx("p",{className:"text-sm text-green-600 mt-2 text-center",children:"اضغط على الرقم للتواصل المباشر عبر واتساب"})]})]}),!s&&e.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-4 border border-green-200",children:[e.jsxs("div",{className:"flex items-center justify-center mb-2",children:[e.jsx(il,{className:"h-5 w-5 text-green-600 ml-2"}),e.jsx("span",{className:"text-green-700 font-semibold",children:"باقة الزيرو المجانية الدائمة"})]}),e.jsx("p",{className:"text-green-600 text-sm text-center",children:"فعل باقة الزيرو الان واستمتع ب 10 عمليات سحب وتحويل يوميا"})]}),R&&e.jsx("div",{className:`rounded-xl p-4 mb-4 text-center ${R.includes("تم تفعيل")?"bg-green-50 border border-green-200 text-green-700":"bg-red-50 border border-red-200 text-red-700"}`,children:e.jsx("p",{className:"font-medium",children:R})}),e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-sm text-gray-500 mb-0",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse"}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.2s"}}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.4s"}})]}),e.jsx("span",{className:"mr-2",children:"في انتظار التفعيل"})]})]}),e.jsxs("div",{className:"flex flex-col space-y-3 pb-2",children:[!s&&!R.includes("تم تفعيل")&&e.jsxs(e.Fragment,{children:[e.jsxs(h,{onClick:f,disabled:w,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-blue-600 to-indigo-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-blue-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-blue-300",style:{boxShadow:"0 15px 35px rgba(59, 130, 246, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),w?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(Eh,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:`التجربة المجانية لمدة ${M} ${M>=3&&M<=10?"ساعات":M===2?"ساعتين":"ساعة"}`})]})]}),e.jsxs(h,{onClick:N,disabled:w,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-green-600 to-emerald-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-emerald-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-emerald-300",style:{boxShadow:"0 15px 35px rgba(99, 102, 241, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),w?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(il,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"فعّل باقة الزيرو الآن"})]})]})]}),e.jsx(h,{onClick:p,variant:"outline",className:"border-2 border-gray-300 hover:border-gray-400 text-gray-700 hover:text-gray-800 px-10 py-3 rounded-xl font-semibold text-lg transition-all duration-300 transform hover:scale-105",children:s?"فهمت":"إغلاق"})]})]})})]})};function ru({isOpen:i,onClose:p}){const[d,v]=n.useState("0"),[w,C]=n.useState(null),[s,j]=n.useState(null),[R,D]=n.useState(!1),M=L=>{R?(v(L),D(!1)):v(d==="0"?L:d+L)},E=L=>{const $=parseFloat(d);if(w===null)C($);else if(s){const Se=f(w||0,$,s);v(String(Se)),C(Se)}D(!0),j(L)},f=(L,$,ve)=>{switch(ve){case"+":return L+$;case"-":return L-$;case"×":return L*$;case"÷":return $===0?0:L/$;case"=":return $;default:return $}},N=()=>{const L=parseFloat(d);if(w!==null&&s){const $=f(w,L,s);v(String($)),C(null),j(null),D(!0)}},k=()=>{v("0"),C(null),j(null),D(!1)},K=()=>{v("0")},F=()=>{R?(v("0."),D(!1)):d.indexOf(".")===-1&&v(d+".")},Q=()=>{d!=="0"&&v(d.charAt(0)==="-"?d.slice(1):"-"+d)},te=()=>{const L=parseFloat(d);v(String(L/100))},ce=L=>{const $=L.key;L.preventDefault(),$>="0"&&$<="9"?M($):$==="+"?E("+"):$==="-"?E("-"):$==="*"?E("×"):$==="/"?E("÷"):$==="Enter"||$==="="?N():$==="Escape"||$==="c"||$==="C"?k():$==="Backspace"?K():$==="."?F():$==="%"&&te()};return n.useEffect(()=>(i?document.addEventListener("keydown",ce):document.removeEventListener("keydown",ce),()=>{document.removeEventListener("keydown",ce)}),[i,d,w,s,R]),e.jsx(ge,{open:i,onOpenChange:L=>!L&&p(),children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsxs(be,{className:"flex items-center gap-2 text-right",children:[e.jsx(Nc,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:d})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:k,children:"AC"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:K,children:"CE"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:te,children:"%"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>E("÷"),children:"÷"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>M("7"),children:"7"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>M("8"),children:"8"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>M("9"),children:"9"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>E("×"),children:"×"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>M("4"),children:"4"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>M("5"),children:"5"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>M("6"),children:"6"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>E("-"),children:"-"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>M("1"),children:"1"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>M("2"),children:"2"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>M("3"),children:"3"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>E("+"),children:"+"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>M("0"),children:"0"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:F,children:"."}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:N,children:"="})]}),e.jsx(h,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:Q,children:"+/-"})]})]})})}function nu({isOpen:i,onClose:p,initialBarcode:d}){const[v,w]=n.useState([]),[C,s]=n.useState({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),[j,R]=n.useState(!1),[D,M]=n.useState(null),{toast:E}=Gs(),{user:f,profile:N}=da(),{isShiftActive:k,shiftUser:K}=Zr(),{shopId:F}=si(),[Q,te]=n.useState([]),[ce,L]=n.useState({}),[$,ve]=n.useState({}),[Se,he]=n.useState({}),[de,ne]=n.useState(""),[$e,qe]=n.useState(!1),[_e,Ye]=n.useState({}),[Je,dt]=n.useState(!1),[ee,we]=n.useState(!0),[rt,ie]=n.useState(!1),Ce=Ke.useRef(""),vt=Ke.useRef(0),[ss,Bt]=n.useState(0),[as,Pe]=n.useState(0),[et,mt]=n.useState(!1),[De,ht]=n.useState(!0),[q,Dt]=n.useState(!1),[Pt,wt]=n.useState(!1),[W,Ne]=n.useState(!0),[Oe,gt]=n.useState(!0),[ot,Mt]=n.useState({}),[Lt,Nt]=n.useState(!1),[st,$t]=n.useState("التحقق قبل العملية"),[kt,Qs]=n.useState("أدخل الرقم السري الرئيسي للمتابعة"),Vt=Ke.useRef(null),is=(c,A,O)=>{$t(c),Qs(A),Vt.current=O,Nt(!0)},[aa,Us]=n.useState([]),[Sa,ls]=n.useState(!1),[_,le]=n.useState(""),[oe,Ae]=n.useState(""),[Ee,Re]=n.useState(""),[nt,J]=n.useState(null);n.useEffect(()=>{(async()=>{try{if(!i||!(f!=null&&f.uid))return;const c=await pe.getUserData(f.uid),A=Array.isArray(c==null?void 0:c.customers)?c.customers.map(O=>({id:String(O.id||""),name:String(O.name||""),mobile:O.mobile||void 0})):[];Us(A)}catch{}})()},[i,f==null?void 0:f.uid]);const[ke,H]=n.useState(!1),[jt,Ct]=n.useState(null),[Ut,rs]=n.useState(null),Ht=(c,A)=>{Ct(c),rs(A),H(!0)},[ra,ma]=n.useState(""),$s=n.useMemo(()=>{const c=ra.trim().toLowerCase();return c?Q.filter(A=>A.name.toLowerCase().includes(c)):Q},[Q,ra]),Fa=()=>new Date().toISOString().split("T")[0];n.useEffect(()=>{i&&(f!=null&&f.uid)&&(Ie(),De||Jt())},[i,f==null?void 0:f.uid,De]),n.useEffect(()=>{if(!(!i||!(f!=null&&f.uid)))try{const c=Fa(),A=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date),O=z=>{try{const Te=z.docs.map(Xe=>{const Le=Xe.data();return{id:String(Le.clientId||Xe.id),productName:String(Le.productName||""),price:Number(Le.sellingPrice||0),wholesalePrice:typeof Le.wholesalePrice=="number"?Le.wholesalePrice:Number(Le.wholesalePrice||0),quantity:Number(Le.quantity||0),date:String(Le.date||c),time:String(Le.time||""),performedByType:Le.performedByType||void 0,performedByName:Le.performedByName||void 0,performedByUsername:Le.performedByUsername||null,serialNumber:Le.serialNumber||void 0,barcode:Le.barcode||void 0,firestoreId:Xe.id}}),Me=(v||[]).filter(Xe=>!Xe.firestoreId),ze={};[...Te,...Me].forEach(Xe=>{ze[Xe.id]=Xe});const We=Object.values(ze);at(We)}catch{}};let G;try{const z=F||(N==null?void 0:N.shopId)||null,Te=Ue(je(V,"dailySales"),ae("userId","==",f.uid),...z?[ae("shopId","==",z)]:[]);G=Ls(Te,O,()=>{try{G&&G()}catch{}const Me=Ue(je(V,"users",f.uid,"dailySales"),...z?[ae("shopId","==",z)]:[]);G=Ls(Me,O)})}catch{const z=F||(N==null?void 0:N.shopId)||null,Te=Ue(je(V,"users",f.uid,"dailySales"),...z?[ae("shopId","==",z)]:[]);G=Ls(Te,O)}return()=>{try{G&&G()}catch{}}}catch{}},[i,f==null?void 0:f.uid]),n.useEffect(()=>{if(!i)return;const c=A=>{const O=Date.now();if(A.key==="Enter"){const G=(Ce.current||"").trim();Ce.current="",G&&ha(G);return}A.key.length===1&&(O-(vt.current||0)>100&&(Ce.current=""),Ce.current+=A.key,vt.current=O)};return window.addEventListener("keydown",c),()=>window.removeEventListener("keydown",c)},[i,Q]),n.useEffect(()=>{i&&d&&ha(d)},[i,d]);const Ra=async()=>{if(f!=null&&f.uid)try{const c=N==null?void 0:N.shopId;let A,O=[];if(c){const G=Ue(je(V,"products"),ae("shopId","==",c),ae("userId","==",f.uid));if(A=await Qe(G),O=A.docs.map(z=>({id:z.id,name:String(z.data().name??""),sellingPrice:Number(z.data().sellingPrice??0),wholesalePrice:Number(z.data().wholesalePrice??0),quantity:Number(z.data().quantity??0),barcode:String(z.data().barcode??""),serialNumber:String(z.data().serialNumber??"")})),O.length===0){const z=Ue(je(V,"products"),ae("userId","==",f.uid)),Me=(await Qe(z)).docs.map(ze=>({id:ze.id,name:String(ze.data().name??""),sellingPrice:Number(ze.data().sellingPrice??0),wholesalePrice:Number(ze.data().wholesalePrice??0),quantity:Number(ze.data().quantity??0),barcode:String(ze.data().barcode??""),serialNumber:String(ze.data().serialNumber??"")}));Me.length>0&&(O=Me,E({title:"تم استرجاع المنتجات",description:"عثرنا على منتجات محفوظة لك خارج المتجر الحالي وقمنا بعرضها."}))}}else{const G=Ue(je(V,"products"),ae("userId","==",f.uid));A=await Qe(G),O=A.docs.map(z=>({id:z.id,name:String(z.data().name??""),sellingPrice:Number(z.data().sellingPrice??0),wholesalePrice:Number(z.data().wholesalePrice??0),quantity:Number(z.data().quantity??0),barcode:String(z.data().barcode??""),serialNumber:String(z.data().serialNumber??"")}))}if(te(O),N!=null&&N.shopId&&O.length>0){const G=O.filter(z=>{const Te=((A==null?void 0:A.docs)||[]).find(ze=>ze.id===z.id);return!(!!Te&&!!Te.data().shopId)});if(G.length>0)try{await Promise.all(G.map(z=>ts(Ve(V,"products",z.id),{shopId:N.shopId,updatedAt:xt()}))),E({title:"تم ترتيب المنتجات",description:"تم ربط بعض المنتجات غير المربوطة بمتجرك الحالي تلقائياً."})}catch(z){console.warn("تعذّر ترحيل shopId لبعض المنتجات:",z)}}}catch(c){console.error("Error loading shop products:",c)}};n.useEffect(()=>{i&&(f!=null&&f.uid)&&(Ra(),Jt(),Ie(),ur())},[i,f==null?void 0:f.uid,N==null?void 0:N.shopId]);const B=()=>{const c=new Date,A=c.getFullYear(),O=String(c.getMonth()+1).padStart(2,"0"),G=String(c.getDate()).padStart(2,"0");return`${A}-${O}-${G}`},Ie=()=>{if(!(f!=null&&f.uid)){console.log("No user authenticated, cannot load sales data");return}const c=F||(N==null?void 0:N.shopId)||"main",A=`salesData_all_${f.uid}_${c}`,O=localStorage.getItem(A);if(O)try{w(JSON.parse(O));return}catch{}const G=B(),z=`salesData_${f.uid}_${c}_${G}`,Te=localStorage.getItem(z);if(Te){const Xe=JSON.parse(Te);w(Xe);try{localStorage.setItem(A,JSON.stringify(Xe))}catch{}return}const Me=new Date().toISOString().split("T")[0],ze=`salesData_${f.uid}_${c}_${Me}`,We=localStorage.getItem(ze);if(We){const Xe=JSON.parse(We);w(Xe);try{localStorage.setItem(z,We),localStorage.setItem(A,We)}catch{}return}us()},at=c=>{if(!(f!=null&&f.uid)){console.log("No user authenticated, cannot save sales data");return}const A=F||(N==null?void 0:N.shopId)||"main",O=B(),G=`salesData_${f.uid}_${A}_${O}`,z=`salesData_all_${f.uid}_${A}`;localStorage.setItem(G,JSON.stringify(c));try{const Te=localStorage.getItem(z),Me=Te?JSON.parse(Te):[],ze={};[...Array.isArray(Me)?Me:[],...c].forEach(We=>{ze[We.id]=We}),localStorage.setItem(z,JSON.stringify(Object.values(ze)))}catch{}w(c)},St=c=>{if(!(f!=null&&f.uid)){console.log("No user authenticated, cannot save sales data");return}const A=F||(N==null?void 0:N.shopId)||"main",O=`salesData_all_${f.uid}_${A}`;try{const G=localStorage.getItem(O),z=G?JSON.parse(G):[],Te={};[...Array.isArray(z)?z:[],...c].forEach(Me=>{Te[Me.id]=Me}),localStorage.setItem(O,JSON.stringify(Object.values(Te)))}catch{}w(c)},us=async()=>{if(f!=null&&f.uid)try{const c=F||(N==null?void 0:N.shopId)||null,A=new Date().toISOString().split("T")[0],O=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date);let G,z;try{const Xe=Ue(je(V,"dailySales"),ae("userId","==",f.uid),...c?[ae("shopId","==",c)]:[]);G=await Qe(Xe)}catch{}try{const Xe=Ue(je(V,"users",f.uid,"dailySales"),...c?[ae("shopId","==",c)]:[]);z=await Qe(Xe)}catch{}const Me=[...G?G.docs:[],...z?z.docs:[]].map(Xe=>{const Le=Xe.data();return{id:String(Le.clientId||Xe.id),firestoreId:Xe.id,productName:String(Le.productName||""),price:Number(Le.sellingPrice||0),wholesalePrice:Le.wholesalePrice!==void 0?Number(Le.wholesalePrice):null,quantity:Number(Le.quantity||0),date:String(Le.date||A),time:String(Le.time||""),serialNumber:Le.serialNumber||void 0,barcode:Le.barcode||void 0,performedByType:Le.performedByType||void 0,performedByName:Le.performedByName||void 0,performedByUsername:Le.performedByUsername||void 0,isDeferred:!!Le.isDeferred,customerName:Le.customerName||void 0,customerMobile:Le.customerMobile||void 0,customerId:Le.customerId||void 0}}),ze={};[...v,...Me].forEach(Xe=>{ze[Xe.id]=Xe});const We=Object.values(ze);St(We)}catch{}},Jt=async()=>{if(f!=null&&f.uid)try{const c=new Date,A=new Date(c.getFullYear(),c.getMonth(),1),O=new Date(c.getFullYear(),c.getMonth()+1,0),G=Le=>Le.toISOString().split("T")[0],z=G(A),Te=G(O),Me=F||(N==null?void 0:N.shopId)||null;let ze;try{const Le=Ue(je(V,"dailySales"),ae("userId","==",f.uid),...Me?[ae("shopId","==",Me)]:[]);ze=await Qe(Le)}catch{const Le=Ue(je(V,"users",f.uid,"dailySales"),...Me?[ae("shopId","==",Me)]:[]);ze=await Qe(Le)}let We=0,Xe=0;ze.forEach(Le=>{const ft=Le.data(),Ps=String(ft.date??"").slice(0,10);if(!ft.isDeferred&&Ps>=z&&Ps<=Te){const Zs=Number(ft.sellingPrice??0),zs=Number(ft.quantity??0),qa=Number(ft.profit??(Number(ft.sellingPrice??0)-Number(ft.wholesalePrice??0))*zs);We+=Zs*zs,Xe+=qa}}),Bt(We),Pe(Xe)}catch(c){console.error("Error loading monthly stats:",c)}},Zt=async c=>{if(!(f!=null&&f.uid))return null;try{const A=((c.price??0)-(c.wholesalePrice??0))*(c.quantity??0),O=k&&K?"cashier":"admin",G=O==="cashier"?(K==null?void 0:K.name)||"كاشير":(N==null?void 0:N.fullName)||(f==null?void 0:f.displayName)||"الحساب الرئيسي",z=O==="cashier"&&(K==null?void 0:K.username)||null,Te=await Hs(je(V,"dailySales"),{userId:f.uid,clientId:c.id,productName:c.productName,quantity:c.quantity,wholesalePrice:c.wholesalePrice??null,sellingPrice:c.price,profit:A,date:c.date,time:c.time,performedByType:O,performedByName:G,performedByUsername:z,serialNumber:c.serialNumber??null,barcode:c.barcode??null,isDeferred:!!c.isDeferred,customerName:c.customerName||null,customerMobile:c.customerMobile||null,customerId:c.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:F?{shopId:F}:{},createdAt:xt()});try{await Ys(Ve(V,"users",f.uid,"dailySales",Te.id),{userId:f.uid,clientId:c.id,productName:c.productName,quantity:c.quantity,wholesalePrice:c.wholesalePrice??null,sellingPrice:c.price,profit:A,date:c.date,time:c.time,performedByType:O,performedByName:G,performedByUsername:z,serialNumber:c.serialNumber??null,barcode:c.barcode??null,isDeferred:!!c.isDeferred,customerName:c.customerName||null,customerMobile:c.customerMobile||null,customerId:c.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:F?{shopId:F}:{},createdAt:xt()})}catch{}return Te.id}catch{try{const A=await Hs(je(V,"users",f.uid,"dailySales"),{userId:f.uid,clientId:c.id,productName:c.productName,quantity:c.quantity,wholesalePrice:c.wholesalePrice??null,sellingPrice:c.price,profit,date:c.date,time:c.time,performedByType,performedByName,performedByUsername,serialNumber:c.serialNumber??null,barcode:c.barcode??null,isDeferred:!!c.isDeferred,customerName:c.customerName||null,customerMobile:c.customerMobile||null,customerId:c.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:F?{shopId:F}:{},createdAt:xt()});try{await Ys(Ve(V,"dailySales",A.id),{userId:f.uid,clientId:c.id,productName:c.productName,quantity:c.quantity,wholesalePrice:c.wholesalePrice??null,sellingPrice:c.price,profit,date:c.date,time:c.time,performedByType,performedByName,performedByUsername,serialNumber:c.serialNumber??null,barcode:c.barcode??null,isDeferred:!!c.isDeferred,customerName:c.customerName||null,customerMobile:c.customerMobile||null,customerId:c.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:F?{shopId:F}:{},createdAt:xt()})}catch{}return A.id}catch(A){return console.error("Error saving sale:",A),null}}},Ba=()=>{const c=F||(N==null?void 0:N.shopId)||"main";return`cashBalance_${(f==null?void 0:f.uid)||"default"}_${c}`},Ua=async(c,A)=>{if(f!=null&&f.uid)try{const O=Ve(V,"dailySales",c);await ts(O,A)}catch{try{const O=Ve(V,"users",f.uid,"dailySales",c);await ts(O,A)}catch(O){console.error("Error updating sale:",O)}}},Xt=async c=>{try{const A=c.firestoreId;if(A)await Ua(A,{isDeferred:!1});else try{const O=Ue(je(V,"dailySales"),ae("userId","==",(f==null?void 0:f.uid)||""),ae("date","==",c.date),ae("productName","==",c.productName),Rr(5)),z=(await Qe(O)).docs[0];z&&await ts(z.ref,{isDeferred:!1})}catch{}w(O=>O.map(G=>G.id===c.id?{...G,isDeferred:!1}:G));try{await Jt()}catch{}E({title:"تم التسديد",description:`تم تسديد أجل ${c.productName}`})}catch(A){console.error("Error marking deferred sale as paid:",A),E({title:"فشل التسديد",description:"تعذّر تحديث حالة البيع المؤجّل",variant:"destructive"})}},ur=async()=>{if(!(f!=null&&f.uid))return;const c=v.filter(A=>!A.firestoreId);if(c.length!==0)for(const A of c)try{let O;try{const z=Ue(je(V,"dailySales"),ae("userId","==",f.uid),ae("clientId","==",A.id),Rr(1));O=await Qe(z)}catch{const z=Ue(je(V,"users",f.uid,"dailySales"),ae("clientId","==",A.id),Rr(1));O=await Qe(z)}if(!O.empty){const z=O.docs[0].id,Te=v.map(Me=>Me.id===A.id?{...Me,firestoreId:z}:Me);at(Te);continue}const G=await Zt(A);if(G){const z=v.map(Te=>Te.id===A.id?{...Te,firestoreId:G}:Te);at(z)}}catch{}},ct=async c=>{try{if(f!=null&&f.uid)try{const We=je(V,"deficiencies"),Xe=await Hs(We,{shopId:(N==null?void 0:N.shopId)||f.uid||"default-shop",name:c,quantity:1,status:"pending",createdAt:xt()});try{const Le=`deficiencies_${(N==null?void 0:N.shopId)||(f==null?void 0:f.uid)||"default-shop"}`,ft=localStorage.getItem(Le),Ps=ft?JSON.parse(ft):[],Zs=Array.isArray(Ps)?Ps:[],zs=Zs.some(Ss=>String((Ss==null?void 0:Ss.id)||"")===Xe.id),qa={id:Xe.id,name:c,quantity:1,status:"pending",createdAt:new Date().toISOString()},Da=zs?Zs:[...Zs,qa];localStorage.setItem(Le,JSON.stringify(Da))}catch{}E({title:"تمت الإضافة للنواقص",description:`المنتج ${c} نفد من المخزون وتمت إضافته للنواقص`});return}catch(We){console.warn("Failed to add deficiency to Firestore, falling back to local storage:",We)}const A=`deficiencies_${(N==null?void 0:N.shopId)||(f==null?void 0:f.uid)||"default-shop"}`,O=localStorage.getItem(A),G=O?JSON.parse(O):[],z=Array.isArray(G)?G:[];if(z.some(We=>String((We==null?void 0:We.name)||"").trim()===c&&String((We==null?void 0:We.status)||"pending")==="pending"))return;const Me={id:Date.now().toString(),name:c,quantity:1,status:"pending",createdAt:new Date().toISOString()},ze=[...z,Me];localStorage.setItem(A,JSON.stringify(ze)),E({title:"تمت الإضافة للنواقص",description:`المنتج ${c} نفد من المخزون وتمت إضافته للنواقص`})}catch(A){console.error("Error adding deficiency for out-of-stock:",A)}},It=async(c,A=!1,O)=>{const G=ce[c.id]||"",z=parseInt(G);if(isNaN(z)||z<=0){E({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(z>c.quantity){E({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const Te=new Date,Me=k&&K?"cashier":"admin",ze=Me==="cashier"?(K==null?void 0:K.name)||"كاشير":(N==null?void 0:N.fullName)||(f==null?void 0:f.displayName)||"الحساب الرئيسي",We=Me==="cashier"&&(K==null?void 0:K.username)||null,Xe=(c.serialNumber||"").trim(),Le=ot[c.id]||"",ft=parseFloat(Le),Ps=!isNaN(ft)&&ft>0?ft:c.sellingPrice,Zs={id:Date.now().toString(),productName:c.name,price:Ps,wholesalePrice:c.wholesalePrice,quantity:z,date:Te.toISOString().split("T")[0],time:Te.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),performedByType:Me,performedByName:ze,performedByUsername:We,serialNumber:Xe||void 0,barcode:c.barcode,isDeferred:A,customerName:O==null?void 0:O.name,customerMobile:O==null?void 0:O.mobile,customerId:O==null?void 0:O.id};try{const zs=await Zt(Zs),qa=zs?{...Zs,firestoreId:zs}:Zs;at([...v,qa]);const Da=c.quantity-z;if(await ts(Ve(V,"products",c.id),{quantity:Da,updatedAt:xt()}),te(Ss=>Ss.map(Xs=>Xs.id===c.id?{...Xs,quantity:Da}:Xs)),L(Ss=>({...Ss,[c.id]:""})),Mt(Ss=>({...Ss,[c.id]:""})),Da===0&&ct(c.name),!A)try{const Ss=Ps*z,Xs=Ba(),Xr=localStorage.getItem(Xs),xr=(Xr?parseFloat(Xr):0)+Ss;localStorage.setItem(Xs,xr.toString());const pr=`userData_${f==null?void 0:f.uid}`,es={cashBalance:xr,lastUpdated:new Date().toISOString()};localStorage.setItem(pr,JSON.stringify(es)),f!=null&&f.uid&&pe.updateUserData(f.uid,es).catch(()=>{})}catch(Ss){console.warn("تعذر تحديث رصيد الدرج النقدي بعد البيع:",Ss)}E({title:"تم البيع",description:`تم بيع ${z} قطعة من ${c.name}`})}catch(zs){console.error("Error selling product:",zs),E({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},Gt=async c=>{if(f!=null&&f.uid){if(k){E({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف إيصالات البيع أثناء الورديه",variant:"destructive"});return}is("تأكيد حذف إيصال بيع","أدخل الرقم السري الرئيسي لحذف الإيصال وعكس الآثار",async()=>{try{if(!c.isDeferred)try{const A=(c.price??0)*(c.quantity??0),O=Ba(),G=localStorage.getItem(O),Te=(G?parseFloat(G):0)-A;localStorage.setItem(O,Te.toString());const Me=`userData_${f==null?void 0:f.uid}`,ze={cashBalance:Te,lastUpdated:new Date().toISOString()};localStorage.setItem(Me,JSON.stringify(ze)),f!=null&&f.uid&&pe.updateUserData(f.uid,ze).catch(()=>{})}catch(A){console.warn("تعذر عكس رصيد الدرج النقدي عند حذف الإيصال:",A)}try{const A=Q.find(O=>c.barcode&&O.barcode===c.barcode||O.name===c.productName);if(A){const O=(A.quantity||0)+(c.quantity||0);await ts(Ve(V,"products",A.id),{quantity:O,updatedAt:xt()}),te(G=>G.map(z=>z.id===A.id?{...z,quantity:O}:z))}}catch(A){console.warn("تعذر عكس المخزون عند حذف الإيصال:",A)}try{if(c.firestoreId){try{await As(Ve(V,"dailySales",c.firestoreId))}catch{}try{await As(Ve(V,"users",f.uid,"dailySales",c.firestoreId))}catch{}}else{let A;try{const O=Ue(je(V,"dailySales"),ae("userId","==",f.uid),ae("date","==",c.date),ae("productName","==",c.productName),Rr(5));A=await Qe(O)}catch{const O=Ue(je(V,"users",f.uid,"dailySales"),ae("date","==",c.date),ae("productName","==",c.productName),Rr(5));A=await Qe(O)}if(!A.empty){const O=A.docs.find(G=>{const z=G.data();return Number((z==null?void 0:z.sellingPrice)??0)===Number(c.price??0)&&Number((z==null?void 0:z.quantity)??0)===Number(c.quantity??0)&&String((z==null?void 0:z.time)??"")===String(c.time??"")})||A.docs[0];O&&await As(O.ref)}}}catch(A){console.warn("تعذر حذف سجل البيع من Firestore:",A)}try{const A=B(),O=`salesData_${f.uid}_${A}`,G=`salesData_all_${f.uid}`,z=v.filter(We=>We.id!==c.id);localStorage.setItem(O,JSON.stringify(z));const Te=localStorage.getItem(G),Me=Te?JSON.parse(Te):[],ze=(Array.isArray(Me)?Me:[]).filter(We=>(We==null?void 0:We.id)!==c.id);localStorage.setItem(G,JSON.stringify(ze)),w(z)}catch(A){console.warn("تعذر تحديث التخزين المحلي بعد الحذف:",A)}try{De||await Jt()}catch{}E({title:"تم حذف الإيصال",description:`تم حذف إيصال بيع للمنتج ${c.productName} وتم عكس الآثار`})}catch(A){console.error("Error deleting sale:",A),E({title:"فشل حذف الإيصال",description:"تعذّر حذف إيصال البيع",variant:"destructive"})}})}},tr=async c=>{try{L(A=>({...A,[c.id]:"1"})),await It(c)}catch(A){console.error("Error selling by barcode:",A)}},js=async c=>{if(k){E({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة قطع أثناء الورديه",variant:"destructive"});return}const A=$[c.id]||"",O=parseInt(A);if(isNaN(O)||O<=0){E({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للإضافة",variant:"destructive"});return}is("تأكيد إضافة قطع","لا يمكن إضافة قطع إلا بإدخال الرقم السري الرئيسي",async()=>{try{const G=c.quantity+O;await ts(Ve(V,"products",c.id),{quantity:G,updatedAt:xt()}),te(z=>z.map(Te=>Te.id===c.id?{...Te,quantity:G}:Te)),ve(z=>({...z,[c.id]:""})),E({title:"تمت الإضافة",description:`تمت إضافة ${O} قطعة إلى ${c.name}`})}catch(G){console.error("Error adding pieces:",G),E({title:"فشل الإضافة",description:"تعذّر إضافة الكمية إلى المخزون",variant:"destructive"})}})},za=async c=>{if(!(f!=null&&f.uid))return;if(k){E({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف المنتجات أثناء الورديه",variant:"destructive"});return}window.confirm(`هل تريد حذف المنتج "${c.name}"؟`)&&is("تأكيد حذف منتج","لا يمكن حذف المنتجات إلا بإدخال الرقم السري الرئيسي",async()=>{try{await As(Ve(V,"products",c.id)),te(O=>O.filter(G=>G.id!==c.id)),E({title:"تم الحذف",description:`تم حذف المنتج ${c.name}`})}catch(O){console.error("Error deleting product:",O),E({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}})},ns=async()=>{try{if(!(f!=null&&f.uid)){E({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}if(k){E({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتجات أثناء الورديه",variant:"destructive"});return}const c=C.productName.trim(),A=parseFloat(C.price),O=parseFloat(C.wholesalePrice||"0"),G=parseInt(C.quantity);if(!c||isNaN(A)||isNaN(G)){E({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const z={name:c,sellingPrice:A,wholesalePrice:isNaN(O)?0:O,quantity:isNaN(G)?0:G,userId:f.uid,createdAt:xt(),updatedAt:xt()},Te=(C.barcode||"").trim();Te&&(z.barcode=Te);const Me=(C.serialNumber||"").trim();Me&&(z.serialNumber=Me),N!=null&&N.shopId&&(z.shopId=N.shopId);const ze=await Hs(je(V,"products"),z);te(We=>[{id:ze.id,name:c,sellingPrice:A,wholesalePrice:isNaN(O)?0:O,quantity:isNaN(G)?0:G,barcode:(C.barcode||"").trim()||"",serialNumber:(C.serialNumber||"").trim()||""},...We]),s({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),E({title:"تمت الإضافة",description:`تم إضافة المنتج ${c} بنجاح`})}catch(c){console.error("createProduct error",c),E({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}},ha=async c=>{const A=(c||"").trim();if(!A)return;const O=Q.find(G=>(G.barcode||"")===A);if(!O){E({title:"باركود غير معروف",description:"لم يتم العثور على منتج بهذا الباركود"});return}await tr(O)},ua=()=>{const c=Object.entries(_e).map(([We,Xe])=>{const Le=Number(Xe),ft=Q.find(Ps=>Ps.id===We);return!ft||!Le||Le<=0?null:{name:ft.name,qty:Le,price:ft.sellingPrice,total:Le*ft.sellingPrice}}).filter(Boolean);if(c.length===0){E({title:"لم يتم اختيار منتجات",description:"فعّل وضع الفاتورة واختر منتجات وكميات للطباعة"});return}const A=(N==null?void 0:N.shopName)||(f==null?void 0:f.displayName)||"المحل",O=(N==null?void 0:N.phone)||(f==null?void 0:f.phoneNumber)||"",G=c.reduce((We,Xe)=>We+Xe.total,0),z=new Date().toLocaleString("ar-EG"),Te=c.map(We=>`
        <tr>
          <td style="border:1px solid #ddd;padding:6px">${We.name}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${We.qty}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${qt(We.price)}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center;font-weight:bold;color:#0a7">${qt(We.total)}</td>
        </tr>
      `).join(""),Me=`
      <html>
        <head>
          <meta charset="utf-8" />
          <title>فاتورة</title>
          <style>
            body { font-family: Tahoma, Arial, sans-serif; direction: rtl; }
            .header { text-align: center; margin-bottom: 12px; }
            .header h2 { margin: 0; }
            .meta { text-align: center; color: #555; margin-bottom: 8px; }
            table { width: 100%; border-collapse: collapse; }
            .total { text-align: left; font-weight: bold; margin-top: 10px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>${A}</h2>
            ${O?`<div class="meta">رقم التليفون: ${O}</div>`:""}
            <div class="meta">التاريخ: ${z}</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="border:1px solid #ddd;padding:6px">المنتج</th>
                <th style="border:1px solid #ddd;padding:6px">الكمية</th>
                <th style="border:1px solid #ddd;padding:6px">السعر</th>
                <th style="border:1px solid #ddd;padding:6px">الإجمالي</th>
              </tr>
            </thead>
            <tbody>
              ${Te}
            </tbody>
          </table>
          <div class="total">الإجمالي الكلي: ${qt(G)}</div>
        </body>
      </html>
    `,ze=window.open("","_blank");ze&&(ze.document.write(Me),ze.document.close(),ze.focus(),ze.print(),ze.close())};return e.jsxs(ge,{open:i,onOpenChange:p,children:[e.jsxs(fe,{className:"max-w-none w-[100vw] md:w-[100vw] lg:w-[100vw] max-h-[85vh] md:h-[100dvh] md:max-h-[100dvh] p-0 overflow-y-auto",children:[e.jsx(ye,{className:"px-3 md:px-6 py-3 md:py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-blue-100 rounded-lg",children:e.jsx(Qn,{className:"h-5 w-5 md:h-6 md:w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(be,{className:"text-lg md:text-xl font-bold text-gray-800",children:"📊 قسم المبيعات"}),e.jsx("p",{className:"text-xs md:text-sm text-gray-600 mt-1 hidden sm:block",children:"إدارة وتتبع المبيعات"})]})]}),e.jsxs("div",{className:"flex items-center gap-1 md:gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:()=>ur(),className:"text-xs md:text-sm",children:"استرجاع الإيصالات"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:p,className:"h-8 w-8 md:h-9 md:w-9",children:e.jsx(hc,{className:"h-4 w-4"})})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row h-full",dir:"rtl",children:[e.jsxs("div",{className:"w-full md:w-72 lg:w-80 bg-white/50 border-r",children:[e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(Yt,{className:"h-4 w-4 text-green-600"}),"ملخص المبيعات"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:gap-3",children:[e.jsxs("div",{className:"bg-blue-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-blue-600",children:qt(v.filter(c=>!c.isDeferred).reduce((c,A)=>c+A.price*A.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-blue-600",children:"إجمالي المبيعات"})]}),e.jsxs("div",{className:"relative bg-green-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsxs("div",{className:ee?"filter blur-sm pointer-events-none":"",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-green-600",children:qt(v.filter(c=>!c.isDeferred).reduce((c,A)=>c+(A.price-(A.wholesalePrice??0))*A.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-green-600",children:"إجمالي الأرباح"})]}),ee&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>ie(!0),className:"bg-white/80 hover:bg-white text-green-700 border border-green-200",children:"عرض الأرباح"})})]}),e.jsxs("div",{className:"bg-yellow-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-yellow-600",children:ka(Q.length)}),e.jsx("div",{className:"text-xs md:text-sm text-yellow-600",children:"عدد المنتجات"})]}),e.jsxs("div",{className:"bg-purple-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-purple-600",children:ka(v.filter(c=>!c.isDeferred).length)}),e.jsx("div",{className:"text-xs md:text-sm text-purple-600",children:"عدد المبيعات"})]})]}),e.jsxs("div",{className:"relative mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1 md:gap-2 text-xs md:text-sm font-semibold text-indigo-700",children:[e.jsx($a,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx(Qn,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{children:"تقارير الشهر"})]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>Dt(c=>!c),className:"h-6 w-6 p-0 rounded-full",title:q?"إظهار التقارير":"إخفاء التقارير",children:q?e.jsx(Yr,{className:"h-4 w-4"}):e.jsx(Hn,{className:"h-4 w-4"})})]}),e.jsx("div",{className:q?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]",children:e.jsxs("div",{className:De?"grid grid-cols-2 gap-2 md:gap-4 filter blur-sm pointer-events-none":"grid grid-cols-2 gap-2 md:gap-4",children:[e.jsxs("div",{className:"bg-indigo-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-indigo-600",children:qt(ss)}),e.jsx("div",{className:"text-xs md:text-sm text-indigo-600",children:"مبيعات الشهر"})]}),e.jsxs("div",{className:"bg-pink-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-pink-600",children:qt(as)}),e.jsx("div",{className:"text-xs md:text-sm text-pink-600",children:"أرباح الشهر"})]})]})}),!q&&De&&e.jsx("div",{className:"absolute left-0 right-0 top-7 md:top-10 bottom-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:async()=>{try{if(await isZeroPlan()){E({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}mt(!0)},className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all btn-monthly-reports",title:"عرض تقارير الشهر",children:[e.jsx(Rt,{className:"h-5 w-5 md:h-7 md:w-7"}),e.jsx("span",{className:"text-xs md:text-sm",children:"عرض تقارير الشهر"})]})})]})]}),e.jsx("div",{className:"flex justify-end mb-3",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:()=>wt(!0),className:"h-7 px-3 rounded-full bg-green-50 hover:bg-green-100 text-green-700",title:"إيصالات البيع",children:[e.jsx(Qr,{className:"h-4 w-4 mr-1"}),"إيصالات البيع"]})}),e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(Vr,{className:"h-4 w-4 text-indigo-600"}),"إحصائيات المنتجات"]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>Ne(c=>!c),className:"h-6 w-6 p-0 rounded-full",title:W?"إظهار القسم":"إخفاء القسم",children:W?e.jsx(Yr,{className:"h-4 w-4"}):e.jsx(Hn,{className:"h-4 w-4"})})]}),e.jsx("div",{className:W?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]}),e.jsxs("div",{className:"p-3 md:p-4 flex-1 hidden md:block",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(xl,{className:"h-4 w-4 text-blue-600"}),"نصائح للمبيعات"]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>gt(c=>!c),className:"h-6 w-6 p-0 rounded-full",title:Oe?"إظهار القسم":"إخفاء القسم",children:Oe?e.jsx(Yr,{className:"h-4 w-4"}):e.jsx(Hn,{className:"h-4 w-4"})})]}),e.jsx("div",{className:Oe?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-visible transition-all duration-300 ease-in-out",children:e.jsxs("div",{className:"p-3 md:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-2",children:[e.jsxs("h2",{className:"text-base md:text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Bh,{className:"h-4 w-4 md:h-5 md:w-5 text-blue-600"}),"سجل المبيعات (",v.filter(c=>!c.isDeferred).length," عنصر)"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm text-gray-600",children:[e.jsx($a,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(Na,{className:"h-3 w-3 md:h-4 md:w-4 ml-2"}),e.jsx("span",{children:new Date().toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 md:p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(vs,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج جديد"]}),e.jsxs(h,{size:"sm",variant:"ghost",className:"h-8",onClick:()=>{if(k){E({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتج أثناء الورديه",variant:"destructive"});return}is("فتح نموذج إضافة منتج","أدخل الرقم السري الرئيسي لفتح نموذج الإضافة",()=>R(!0))},children:[e.jsx(vs,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج"]})]}),j&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"new-product-name",className:"text-xs md:text-sm",children:"اسم المنتج"}),e.jsx(U,{id:"new-product-name",value:C.productName,onChange:c=>s(A=>({...A,productName:c.target.value})),placeholder:"أدخل اسم المنتج"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"new-product-price",className:"text-xs md:text-sm",children:"سعر البيع (ج.م)"}),e.jsx(U,{type:"number",id:"new-product-price",value:C.price,onChange:c=>s(A=>({...A,price:c.target.value})),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"new-product-wholesale",className:"text-xs md:text-sm",children:"سعر الجملة (ج.م)"}),e.jsx(U,{type:"number",id:"new-product-wholesale",value:C.wholesalePrice||"",onChange:c=>s(A=>({...A,wholesalePrice:c.target.value})),placeholder:"0.00"})]})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"new-product-qty",className:"text-xs md:text-sm",children:"الكمية"}),e.jsx(U,{type:"number",id:"new-product-qty",value:C.quantity,onChange:c=>s(A=>({...A,quantity:c.target.value})),placeholder:"1"})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"new-product-barcode",className:"text-xs md:text-sm",children:"باركود المنتج (اختياري)"}),e.jsx(U,{id:"new-product-barcode",value:C.barcode||"",onChange:c=>s(A=>({...A,barcode:c.target.value})),placeholder:"أدخل/امسح الباركود"})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"new-product-serial",className:"text-xs md:text-sm",children:"سيريال الجهاز (اختياري)"}),e.jsx(U,{id:"new-product-serial",value:C.serialNumber||"",onChange:c=>s(A=>({...A,serialNumber:c.target.value})),placeholder:"أدخل سيريال الجهاز"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(h,{className:"h-9 w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white",onClick:ns,children:"إضافة المنتج"}),e.jsx(h,{variant:"outline",className:"h-9 w-full md:w-auto",onClick:()=>R(!1),children:"إغلاق"})]})]})]}),e.jsx("div",{id:"shop-products-section",className:"bg-white rounded-lg border border-gray-200 overflow-hidden mb-4",children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 mb-2 flex items-center gap-2",children:[e.jsx(Vr,{className:"h-4 w-4 text-green-600"}),"منتجات المحل"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(h,{variant:$e?"default":"outline",size:"sm",onClick:()=>qe(c=>!c),children:$e?"وضع الفاتورة: مفعل":"تفعيل وضع الفاتورة"}),e.jsx(h,{size:"sm",className:"bg-indigo-600 hover:bg-indigo-700 text-white",disabled:Object.keys(_e).filter(c=>(_e[c]||0)>0).length===0,onClick:ua,children:"طباعة فاتورة"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(U,{value:ra,onChange:c=>ma(c.target.value),placeholder:"ابحث عن منتج...",className:"h-9 w-full md:w-72 text-sm","aria-label":"البحث عن منتج من منتجات المحل"}),e.jsx(U,{value:de,onChange:c=>ne(c.target.value),onKeyDown:async c=>{if(c.key!=="Enter")return;const A=de.trim();A&&(await ha(A),ne(""))},placeholder:"مرّر ماسح الباركود هنا (اختياري)",className:"h-9 w-full md:w-64 text-sm","aria-label":"مسح الباركود لإضافة المنتج تلقائياً"}),ra&&e.jsx(h,{variant:"ghost",size:"sm",className:"h-9",onClick:()=>ma(""),children:"مسح"})]}),e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg hidden md:block",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>dt(c=>!c),"aria-label":Je?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Je?e.jsx(fs,{className:"h-4 w-4"}):e.jsx(Rt,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المتاح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"بيع"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:$s.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-3 py-3 text-center text-gray-500",children:Q.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"})}):$s.map(c=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:c.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:qt(c.sellingPrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:e.jsx("span",{className:Je?"":"blur-sm select-none",children:qt(c.wholesalePrice)})}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:ka(c.quantity)}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 flex-nowrap",children:[e.jsx(U,{value:ce[c.id]||"",onChange:A=>L(O=>({...O,[c.id]:A.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-8 w-28 text-sm"}),e.jsx(U,{value:ot[c.id]||"",onChange:A=>Mt(O=>({...O,[c.id]:A.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-8 w-32 text-sm","aria-label":`سعر بيع اختياري لـ ${c.name}`}),e.jsx(h,{size:"sm",className:"h-8 min-w-[64px] bg-indigo-600 hover:bg-indigo-700 text-white",onClick:()=>It(c),children:"بيع"}),e.jsx(h,{size:"sm",className:"h-8 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>{J(c),ls(!0)},children:"بيع أجل"}),$e&&e.jsx(U,{value:_e[c.id]??"",onChange:A=>{const O=parseInt(A.target.value||"0");Ye(G=>({...G,[c.id]:isNaN(O)?0:O}))},type:"number",placeholder:"كمية للفاتورة",className:"h-8 w-24 text-sm"}),e.jsx(U,{value:$[c.id]||"",onChange:A=>ve(O=>({...O,[c.id]:A.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-8 w-28 text-sm",disabled:k}),e.jsxs("div",{className:"inline-flex items-center gap-2 flex-nowrap",children:[e.jsx(h,{size:"sm",variant:"outline",className:"h-8 whitespace-nowrap",onClick:()=>js(c),disabled:k,title:k?"غير مسموح في وضع الكاشير":void 0,children:"إضافة قطع جديدة"}),e.jsx(h,{size:"sm",variant:"destructive",className:"h-8",onClick:()=>za(c),title:"حذف المنتج",disabled:k,children:e.jsx(ms,{className:"h-4 w-4"})})]})]})})]},c.id))})]})}),e.jsx("div",{className:"block md:hidden space-y-3",children:$s.length===0?e.jsx("div",{className:"text-center text-gray-500 text-sm",children:Q.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"}):$s.map(c=>e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm break-words",children:c.name}),e.jsx(h,{size:"sm",variant:"destructive",className:"h-8 min-w-[44px] touch-manipulation",onClick:()=>za(c),title:"حذف المنتج",disabled:k,children:e.jsx(ms,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-700",children:[e.jsx("div",{className:"text-gray-600",children:"سعر البيع"}),e.jsx("div",{className:"text-right font-medium",children:qt(c.sellingPrice)}),e.jsxs("div",{className:"text-gray-600 inline-flex items-center gap-1",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>dt(A=>!A),"aria-label":Je?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Je?e.jsx(fs,{className:"h-4 w-4"}):e.jsx(Rt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:Je?"":"blur-sm select-none",children:qt(c.wholesalePrice)})}),e.jsx("div",{className:"text-gray-600",children:"المتاح"}),e.jsx("div",{className:"text-right font-medium",children:ka(c.quantity)})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{value:ce[c.id]||"",onChange:A=>L(O=>({...O,[c.id]:A.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للبيع لـ ${c.name}`}),e.jsx(U,{value:ot[c.id]||"",onChange:A=>Mt(O=>({...O,[c.id]:A.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-9 w-28 text-sm","aria-label":`سعر بيع اختياري لـ ${c.name}`}),e.jsx(h,{size:"sm",className:"h-9 min-w-[64px] bg-indigo-600 hover:bg-indigo-700 text-white",onClick:()=>It(c),children:"بيع"}),e.jsx(h,{size:"sm",className:"h-9 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>{J(c),ls(!0)},children:"بيع أجل"})]}),$e&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(U,{value:_e[c.id]??"",onChange:A=>{const O=parseInt(A.target.value||"0");Ye(G=>({...G,[c.id]:isNaN(O)?0:O}))},type:"number",placeholder:"كمية للفاتورة",className:"h-9 flex-1 text-sm","aria-label":`كمية للفاتورة لـ ${c.name}`})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{value:$[c.id]||"",onChange:A=>ve(O=>({...O,[c.id]:A.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للإضافة لـ ${c.name}`,disabled:k}),e.jsx(h,{size:"sm",variant:"outline",className:"h-9 min-w-[64px]",onClick:()=>js(c),disabled:k,title:k?"غير مسموح في وضع الكاشير":void 0,children:"إضافة"})]})]})]},c.id))})]})}),v.length===0?e.jsxs("div",{className:"text-center py-8 md:py-12",children:[e.jsx("div",{className:"w-16 h-16 md:w-24 md:h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx(Vr,{className:"h-8 w-8 md:h-12 md:w-12 text-gray-400"})}),e.jsx("h3",{className:"text-base md:text-lg font-medium text-gray-900 mb-2",children:"لا توجد مبيعات اليوم"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ابدأ ببيع منتج من القائمة أعلاه"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"block md:hidden",children:e.jsx("div",{className:"max-h-[70vh] overflow-y-auto space-y-3 p-3",children:v.map(c=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-200 shadow-sm",children:[e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-base break-words",children:c.productName}),c.isDeferred&&e.jsx("span",{className:"px-2 py-0.5 rounded bg-amber-100 text-amber-700 text-[11px]",children:"مؤجّل"})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Yt,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر البيع"})]}),e.jsx("div",{className:"text-right font-medium",children:qt(c.price)}),typeof c.wholesalePrice=="number"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Yt,{className:"h-4 w-4 text-indigo-600"}),e.jsxs("span",{className:"text-gray-600 inline-flex items-center gap-1",children:["سعر الجملة",e.jsx(h,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>dt(A=>!A),"aria-label":Je?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Je?e.jsx(fs,{className:"h-4 w-4"}):e.jsx(Rt,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:Je?"":"blur-sm select-none",children:qt(c.wholesalePrice)})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Vr,{className:"h-4 w-4 text-emerald-600"}),e.jsx("span",{className:"text-gray-600",children:"الكمية"})]}),e.jsx("div",{className:"text-right font-medium",children:ka(c.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Jr,{className:"h-4 w-4 text-indigo-600"}),e.jsx("span",{className:"text-gray-600",children:"الربح"})]}),e.jsx("div",{className:"text-right font-semibold text-indigo-600",children:e.jsx("span",{className:Je?"":"blur-sm select-none",children:qt(((c.price??0)-(c.wholesalePrice??0))*(c.quantity??0))})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Yt,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"الإجمالي"})]}),e.jsx("div",{className:"text-right font-bold text-green-700",children:qt(c.price*c.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Rh,{className:"h-4 w-4 text-amber-600"}),e.jsx("span",{className:"text-gray-600",children:"المنفذ"})]}),e.jsx("div",{className:"text-right text-gray-700",children:c.performedByName??"-"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($a,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"التاريخ"})]}),e.jsx("div",{className:"text-right text-gray-600",children:ml(c.date)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Na,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"الوقت"})]}),e.jsx("div",{className:"text-right text-gray-600",children:c.time})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[c.isDeferred&&e.jsx(h,{size:"sm",className:"h-8 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>Xt(c),title:"تم التسديد",children:"تم التسديد"}),e.jsx(h,{size:"sm",variant:"outline",onClick:()=>Ht(c,"return"),disabled:k,title:k?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsxs(h,{size:"sm",variant:"destructive",onClick:()=>Ht(c,"delete"),disabled:k,title:k?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:[e.jsx(ms,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-1",children:"حذف الإيصال"})]})]})]},c.id))})}),e.jsx("div",{className:"hidden md:block overflow-x-auto max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-green-300 scrollbar-track-green-100 hover:scrollbar-thumb-green-400",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر البيع (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة (ج.م)"}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>dt(c=>!c),"aria-label":Je?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Je?e.jsx(fs,{className:"h-4 w-4"}):e.jsx(Rt,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الإجمالي (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الربح (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الوقت"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنفذ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"إجراءات"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:v.map((c,A)=>e.jsxs("tr",{className:A%2===0?"bg-white":"bg-gray-50/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:e.jsxs("div",{className:"flex items-center gap-2 justify-end md:justify-start",children:[e.jsx("span",{children:c.productName}),c.isDeferred&&e.jsx("span",{className:"px-2 py-0.5 rounded bg-amber-100 text-amber-700 text-xs",children:"مؤجّل"})]})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:qt(c.price)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:typeof c.wholesalePrice=="number"?e.jsx("span",{className:Je?"":"blur-sm select-none",children:qt(c.wholesalePrice)}):"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:ka(c.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-green-600",children:qt(c.price*c.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-indigo-600",children:e.jsx("span",{className:Je?"":"blur-sm select-none",children:qt(((c.price??0)-(c.wholesalePrice??0))*(c.quantity??0))})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:ml(c.date)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:c.time}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:c.performedByName??"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[c.isDeferred&&e.jsx(h,{size:"sm",className:"h-8 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>Xt(c),title:"تم التسديد",children:"تم التسديد"}),e.jsx(h,{size:"sm",variant:"outline",onClick:()=>Ht(c,"return"),disabled:k,title:k?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsx(h,{size:"sm",variant:"destructive",onClick:()=>Ht(c,"delete"),disabled:k,title:k?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:e.jsx(ms,{className:"h-4 w-4"})})]})})]},c.id))})]})})]})]})})]})]}),e.jsx(ge,{open:Sa,onOpenChange:ls,children:e.jsxs(fe,{className:"max-w-sm mx-auto bg-white border border-gray-200 shadow-2xl rounded-2xl sm:max-w-md",children:[e.jsx(ye,{className:"text-center",children:e.jsx(be,{className:"text-base md:text-lg font-bold text-gray-900",children:"بيع أجل"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsx(Z,{className:"text-sm",children:"اختيار عميل (اختياري)"}),e.jsxs("select",{className:"h-9 border rounded px-2 text-sm",value:_,onChange:c=>{const A=c.target.value;le(A);const O=aa.find(G=>G.id===A);O&&(Ae(O.name),Re(O.mobile||""))},children:[e.jsx("option",{value:"",children:"-- بدون اختيار --"}),aa.map(c=>e.jsxs("option",{value:c.id,children:[c.name,c.mobile?` - ${c.mobile}`:""]},c.id))]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsx(Z,{className:"text-sm",children:"اسم العميل"}),e.jsx(U,{value:oe,onChange:c=>Ae(c.target.value),placeholder:"اسم العميل",className:"h-9 text-sm"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsx(Z,{className:"text-sm",children:"رقم التليفون (اختياري)"}),e.jsx(U,{value:Ee,onChange:c=>Re(c.target.value),placeholder:"رقم التليفون",className:"h-9 text-sm"})]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-3 mt-3",children:[e.jsx(h,{variant:"outline",className:"h-8 min-w-[80px]",onClick:()=>ls(!1),children:"إلغاء"}),e.jsx(h,{className:"h-8 min-w-[100px] bg-amber-600 hover:bg-amber-700 text-white",onClick:async()=>{try{const c=nt;if(!c){ls(!1);return}const A=oe.trim(),O=Ee.trim()||void 0,G=_||void 0;if(!A){E({title:"بيانات مطلوبة",description:"أدخل اسم العميل",variant:"destructive"});return}await It(c,!0,{id:G,name:A,mobile:O});try{if(f!=null&&f.uid){const z=c.sellingPrice*(parseInt(ce[c.id]||"0")||0),Te=await pe.getUserData(f.uid),Me=Array.isArray(Te==null?void 0:Te.debts)?Te.debts:[],We=[{id:Date.now().toString(),debtorName:A,customerId:G||null,mobile:O||null,amount:z,reason:`بيع أجل للمنتج ${c.name}`,status:"pending",createdAt:new Date,partialPayments:[]},...Me];await pe.updateUserData(f.uid,{debts:We})}}catch{}ls(!1),J(null)}catch{}},children:"تأكيد البيع الآجل"})]})]})}),e.jsx(ge,{open:Pt,onOpenChange:wt,children:e.jsxs(fe,{className:"sm:max-w-3xl",children:[e.jsx(ye,{children:e.jsx(be,{children:"إيصالات البيع"})}),v.filter(c=>!c.isDeferred).length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا توجد إيصالات بيع حتى الآن."}):e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg max-h-[70vh] overflow-y-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر الجملة"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الإجمالي"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الربح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الوقت"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنفذ"})]})}),e.jsx("tbody",{children:v.filter(c=>!c.isDeferred).map(c=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:c.productName}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:qt(c.price)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:qt(c.wholesalePrice??0)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:ka(c.quantity)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:qt((c.price??0)*(c.quantity??0))}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:qt(((c.price??0)-(c.wholesalePrice??0))*(c.quantity??0))}),e.jsx("td",{className:"px-3 py-2 text-gray-500",children:ml(c.date)}),e.jsx("td",{className:"px-3 py-2 text-gray-500",children:c.time}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:c.executedBy||"-"})]},c.id))})]})}),e.jsx("div",{className:"flex justify-end mt-3",children:e.jsx(h,{variant:"outline",onClick:()=>wt(!1),children:"إغلاق"})})]})}),e.jsx(ge,{open:ke,onOpenChange:H,children:e.jsxs(fe,{className:"max-w-sm mx-auto bg-white border border-gray-200 shadow-2xl rounded-2xl sm:max-w-md",children:[e.jsx(ye,{className:"text-center",children:e.jsx(be,{className:"text-base md:text-lg font-bold text-gray-900",children:Ut==="return"?"تأكيد المرتجع":"تأكيد حذف الإيصال"})}),e.jsxs("div",{className:"space-y-3 text-center px-2",children:[e.jsxs("p",{className:"text-sm text-gray-700",children:["هل تريد ",Ut==="return"?"عمل مرتجع":"حذف الإيصال"," للمنتج:",e.jsxs("span",{className:"font-semibold text-gray-900",children:[" ",jt==null?void 0:jt.productName," "]}),"بكمية",e.jsxs("span",{className:"font-semibold text-gray-900",children:[" ",ka((jt==null?void 0:jt.quantity)||0)," "]}),"؟"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"سيتم عكس المخزون والرصيد حسب الحالة."})]}),e.jsxs("div",{className:"flex items-center justify-center gap-3 mt-2",children:[e.jsx(h,{variant:"outline",className:"h-8 min-w-[80px]",onClick:()=>H(!1),children:"إلغاء"}),e.jsx(h,{className:"h-8 min-w-[100px] bg-red-600 hover:bg-red-700 text-white",onClick:()=>{const c=jt;H(!1),c&&Gt(c)},children:"تأكيد"})]})]})}),e.jsx(gs,{open:rt,onOpenChange:ie,mode:"verify",title:"قفل إجمالي الأرباح",description:"أدخل الرقم السري الرئيسي لعرض إجمالي الأرباح",onSuccess:()=>{we(!1),ie(!1)}}),e.jsx(gs,{open:et,onOpenChange:mt,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const c=f==null?void 0:f.uid;if(c){const A=await gl(c),O=(A==null?void 0:A.planType)??(A==null?void 0:A.plan)??null,G=typeof O=="string"?O.toLowerCase():null;if(O===Is.ZERO||G==="zero"){E({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}ht(!1),mt(!1),Jt()}}),e.jsx(gs,{open:Lt,onOpenChange:Nt,mode:"verify",title:st,description:kt,onSuccess:()=>{const c=Vt.current;Vt.current=null,Nt(!1),c&&c()}})]})}const ka=i=>new Intl.NumberFormat("ar-EG").format(Number(i||0)),qt=i=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(i||0))} ج.م`,ml=i=>{try{const p=new Date(i);return isNaN(p.getTime())?new Date(`${i}T00:00:00`).toLocaleDateString("ar-EG"):p.toLocaleDateString("ar-EG")}catch{return i}},iu=({open:i,onOpenChange:p,userId:d,cashBalance:v,walletBalances:w,transactions:C})=>{const[s,j]=Ke.useState(0),[R,D]=Ke.useState(0),[M,E]=Ke.useState(0),[f,N]=Ke.useState(0),[k,K]=Ke.useState(v||0),[F,Q]=Ke.useState(!1),[te,ce]=Ke.useState(null),{toast:L}=Gs(),{shopId:$}=si()||{},[ve,Se]=Ke.useState(!1),[he,de]=Ke.useState(""),[ne,$e]=Ke.useState(!1),[qe,_e]=Ke.useState(!1),[Ye,Je]=Ke.useState(""),dt=()=>`cashBalance_${d||"default"}_${$||"main"}`,ee=()=>`cashBalance_${d||"default"}`,we=Pe=>`${new Intl.NumberFormat("ar-EG").format(Number(Pe||0))} جنيه`;Ke.useEffect(()=>{const Pe=async()=>{try{if(!d){j(0);return}const De=new Date,ht=De.getFullYear(),q=String(De.getMonth()+1).padStart(2,"0"),Dt=String(De.getDate()).padStart(2,"0"),Pt=`${ht}-${q}-${Dt}`;let wt;try{const Ne=Ue(je(V,"dailySales"),ae("userId","==",d),...$?[ae("shopId","==",$)]:[],ae("date","==",Pt));wt=await Qe(Ne)}catch{const Ne=Ue(je(V,"users",d,"dailySales"),...$?[ae("shopId","==",$)]:[],ae("date","==",Pt));wt=await Qe(Ne)}let W=0;wt.forEach(Ne=>{const Oe=Ne.data(),gt=Number(Oe.sellingPrice??0),ot=Number(Oe.quantity??0);gt>0&&ot>0&&(W+=gt*ot)}),j(W)}catch(De){console.warn("فشل تحميل مبيعات الإكسسوار لليوم:",De)}},et=async()=>{try{if(!d){setMaintenanceProfitToday(0);return}const De=new Date,ht=new Date(De.getFullYear(),De.getMonth(),De.getDate(),0,0,0,0),q=new Date(De.getFullYear(),De.getMonth(),De.getDate(),23,59,59,999);let Dt;try{const wt=Ue(je(V,"maintenance_items"),ae("userId","==",d),ae("status","==","completed"));Dt=await Qe(wt)}catch{Dt=await Qe(Ue(je(V,"maintenance_items"),ae("userId","==",d)))}let Pt=0;Dt.forEach(wt=>{var Oe,gt;const W=wt.data();if((W.status||"in_progress")!=="completed")return;const Ne=(gt=(Oe=W.completedAt)==null?void 0:Oe.toDate)==null?void 0:gt.call(Oe);if(Ne&&Ne.getTime()>=ht.getTime()&&Ne.getTime()<=q.getTime()){const ot=Number(W.repairPrice||0);Number.isFinite(ot)&&ot>0&&(Pt+=ot)}}),E(Math.max(0,Pt))}catch(De){console.warn("فشل تحميل إجمالي فلوس الصيانة لليوم:",De)}},mt=async()=>{try{if(!d){D(0);return}const De=await pe.getUserData(d),ht=new Date().toISOString().slice(0,10),q=(De==null?void 0:De.dailyReceipts)||{};q!=null&&q.date&&String(q.date).slice(0,10)===ht?(D(Number(q.accessory||0)),N(Number(q.maintenance||0))):(D(0),N(0));try{const Dt=localStorage.getItem(ee()),Pt=localStorage.getItem(dt()),wt=Dt??Pt;wt!=null?K(Number(wt)||0):K(Number((De==null?void 0:De.cashBalance)||v||0))}catch{K(Number((De==null?void 0:De.cashBalance)||v||0))}}catch{D(0),N(0)}};i&&(Pe(),et(),mt())},[i,d,C,v,$]),Ke.useEffect(()=>{const Pe=et=>{var mt;try{const De=Number((mt=et==null?void 0:et.detail)==null?void 0:mt.value);if(Number.isFinite(De))K(De);else{const ht=localStorage.getItem(ee()),q=localStorage.getItem(dt()),Dt=ht??q;Dt!=null&&K(parseFloat(Dt)||0)}}catch{const De=localStorage.getItem(ee()),ht=localStorage.getItem(dt()),q=De??ht;q!=null&&K(parseFloat(q)||0)}};return window.addEventListener("cashBalanceChanged",Pe),()=>window.removeEventListener("cashBalanceChanged",Pe)},[i,d,$]);const rt=Math.max(0,Number(s)-Number(R)),ie=Math.max(0,Number(M)-Number(f)),Ce=async Pe=>{if(!d)return;const et=new Date().toISOString().slice(0,10);try{const mt=Pe==="accessory"?rt:ie;if(mt<=0){L({title:"لا يوجد مبلغ لتأكيد استلامه",variant:"default"});return}const De=Math.max(0,Number(k)-mt);K(De),Pe==="accessory"?D(ht=>ht+mt):N(ht=>ht+mt),await pe.updateUserData(d,{cashBalance:De,dailyReceipts:{date:et,accessory:Pe==="accessory"?R+mt:R,maintenance:Pe==="maintenance"?f+mt:f}});try{localStorage.setItem(`cashBalance_${d}`,String(De)),localStorage.setItem(dt(),String(De))}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:De}}))}catch{}L({title:"تم الاستلام",description:`تم خصم ${mt.toFixed(2)} من الدرج وتصفير بند ${Pe==="accessory"?"الإكسسوار":"الصيانة"}`})}catch{L({title:"خطأ",description:"تعذر تنفيذ عملية تم الاستلام",variant:"destructive"})}},vt=()=>{de(""),Je(""),Se(!0)},ss=()=>{if(!he.trim()){L({title:"سبب الخصم مطلوب",variant:"destructive"});return}Se(!1),$e(!0)},Bt=()=>{$e(!1),_e(!0)},as=async()=>{try{if(!d)return;const Pe=Math.max(0,Number(Ye||0));if(!Number.isFinite(Pe)||Pe<=0){L({title:"مبلغ غير صالح",description:"أدخل مبلغ خصم صحيح أكبر من الصفر",variant:"destructive"});return}const et=Math.max(0,Number(k)-Pe);K(et),await pe.updateUserData(d,{cashBalance:et});try{localStorage.setItem(`cashBalance_${d}`,String(et))}catch{}try{localStorage.setItem(dt(),String(et))}catch{}const mt={title:"ايصال خصم من الفلوس النقديه",type:"cash_deduction",amount:Pe,status:"completed",createdAt:new Date,note:he,cashierName:"الحساب الرئيسي"};try{await pe.saveUserTransaction(d,mt)}catch{}L({title:"تم الخصم",description:`تم خصم ${Pe.toFixed(2)} من الدرج`}),_e(!1),Je(""),de("")}catch{L({title:"فشل الخصم",description:"تعذر تنفيذ عملية الخصم",variant:"destructive"})}};return e.jsx(ge,{open:i,onOpenChange:p,children:e.jsxs(fe,{className:"sm:max-w-lg animate-in fade-in-90 zoom-in-95 slide-in-from-top-4",dir:"rtl",children:[e.jsx(ye,{children:e.jsxs(be,{className:"flex items-center gap-2 text-right",children:[e.jsx(Yt,{className:"h-5 w-5 text-emerald-600"}),"تفاصيل الفلوس النقدية"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between bg-amber-50 border border-amber-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 font-bold text-sm",children:[e.jsx(Yt,{className:"h-4 w-4"}),"مجموع الفلوس النقدية (الدرج)"]}),e.jsx("div",{className:"text-amber-700 font-extrabold text-sm",children:we(k)})]}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 font-bold text-sm",children:[e.jsx(Vr,{className:"h-4 w-4"}),"فلوس الاكسسوار"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-blue-700 font-extrabold text-sm",children:we(rt)}),e.jsx(h,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800",onClick:()=>{ce("accessory"),Q(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-emerald-50 border border-emerald-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-800 font-bold text-sm",children:[e.jsx(fl,{className:"h-4 w-4"}),"فلوس الصيانة"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-emerald-700 font-extrabold text-sm",children:we(ie)}),e.jsx(h,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800",onClick:()=>{ce("maintenance"),Q(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-red-800 font-bold text-sm",children:"خصم فلوس من الفلوس النقديه"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800",onClick:vt,children:"خصم"})})]})]}),e.jsx(gs,{open:F,onOpenChange:Q,mode:"verify",title:"تأكيد الرقم السري لعملية تم الاستلام",description:"يرجى إدخال الرقم السري الرئيسي لتأكيد استلام المبلغ",onSuccess:()=>{te&&(Ce(te),ce(null)),Q(!1)}}),e.jsx(ge,{open:ve,onOpenChange:Se,children:e.jsxs(fe,{className:"sm:max-w-sm",children:[e.jsx(ye,{children:e.jsx(be,{children:"سبب الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"deduct-reason",children:"اكتب سبب الخصم"}),e.jsx(U,{id:"deduct-reason",value:he,onChange:Pe=>de(Pe.target.value),placeholder:"سبب الخصم"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(h,{variant:"outline",onClick:()=>Se(!1),children:"إلغاء"}),e.jsx(h,{onClick:ss,className:"bg-red-600 hover:bg-red-700",children:"متابعة"})]})]})}),e.jsx(gs,{open:ne,onOpenChange:$e,mode:"verify",title:"تأكيد الرقم السري لعملية الخصم",description:"يرجى إدخال الرقم السري الرئيسي لمتابعة الخصم",onSuccess:Bt}),e.jsx(ge,{open:qe,onOpenChange:_e,children:e.jsxs(fe,{className:"sm:max-w-sm",children:[e.jsx(ye,{children:e.jsx(be,{children:"مبلغ الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"deduct-amount",children:"أدخل مبلغ الخصم"}),e.jsx(U,{id:"deduct-amount",type:"number",value:Ye,onChange:Pe=>Je(Pe.target.value),placeholder:"0.00"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(h,{variant:"outline",onClick:()=>_e(!1),children:"إلغاء"}),e.jsx(h,{onClick:as,className:"bg-red-600 hover:bg-red-700",children:"تأكيد الخصم"})]})]})})]})})};function Cc({size:i=24,className:p,...d}){return e.jsxs("svg",{width:i,height:i,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:p,...d,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}var Ic="AlertDialog",[lu]=eh(Ic,[xc]),ja=xc(),Ac=i=>{const{__scopeAlertDialog:p,...d}=i,v=ja(p);return e.jsx(Qm,{...v,...d,modal:!0})};Ac.displayName=Ic;var ou="AlertDialogTrigger",cu=n.forwardRef((i,p)=>{const{__scopeAlertDialog:d,...v}=i,w=ja(d);return e.jsx(lh,{...w,...v,ref:p})});cu.displayName=ou;var du="AlertDialogPortal",Tc=i=>{const{__scopeAlertDialog:p,...d}=i,v=ja(p);return e.jsx(Zm,{...v,...d})};Tc.displayName=du;var mu="AlertDialogOverlay",Pc=n.forwardRef((i,p)=>{const{__scopeAlertDialog:d,...v}=i,w=ja(d);return e.jsx(ih,{...w,...v,ref:p})});Pc.displayName=mu;var hr="AlertDialogContent",[hu,uu]=lu(hr),xu=ah("AlertDialogContent"),kc=n.forwardRef((i,p)=>{const{__scopeAlertDialog:d,children:v,...w}=i,C=ja(d),s=n.useRef(null),j=pc(p,s),R=n.useRef(null);return e.jsx(Xm,{contentName:hr,titleName:_c,docsSlug:"alert-dialog",children:e.jsx(hu,{scope:d,cancelRef:R,children:e.jsxs(th,{role:"alertdialog",...C,...w,ref:j,onOpenAutoFocus:sh(w.onOpenAutoFocus,D=>{var M;D.preventDefault(),(M=R.current)==null||M.focus({preventScroll:!0})}),onPointerDownOutside:D=>D.preventDefault(),onInteractOutside:D=>D.preventDefault(),children:[e.jsx(xu,{children:v}),e.jsx(gu,{contentRef:s})]})})})});kc.displayName=hr;var _c="AlertDialogTitle",Oc=n.forwardRef((i,p)=>{const{__scopeAlertDialog:d,...v}=i,w=ja(d);return e.jsx(rh,{...w,...v,ref:p})});Oc.displayName=_c;var Ec="AlertDialogDescription",Mc=n.forwardRef((i,p)=>{const{__scopeAlertDialog:d,...v}=i,w=ja(d);return e.jsx(nh,{...w,...v,ref:p})});Mc.displayName=Ec;var pu="AlertDialogAction",Lc=n.forwardRef((i,p)=>{const{__scopeAlertDialog:d,...v}=i,w=ja(d);return e.jsx(gc,{...w,...v,ref:p})});Lc.displayName=pu;var $c="AlertDialogCancel",Wc=n.forwardRef((i,p)=>{const{__scopeAlertDialog:d,...v}=i,{cancelRef:w}=uu($c,d),C=ja(d),s=pc(p,w);return e.jsx(gc,{...C,...v,ref:s})});Wc.displayName=$c;var gu=({contentRef:i})=>{const p=`\`${hr}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${hr}\` by passing a \`${Ec}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${hr}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return n.useEffect(()=>{var v;document.getElementById((v=i.current)==null?void 0:v.getAttribute("aria-describedby"))||console.warn(p)},[p,i]),null},fu=Ac,yu=Tc,Fc=Pc,Rc=kc,Bc=Lc,Uc=Wc,zc=Oc,qc=Mc;const bu=fu,vu=yu,Vc=n.forwardRef(({className:i,...p},d)=>e.jsx(Fc,{className:Xa("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",i),...p,ref:d}));Vc.displayName=Fc.displayName;const Jc=n.forwardRef(({className:i,...p},d)=>e.jsxs(vu,{children:[e.jsx(Vc,{}),e.jsx(Rc,{ref:d,className:Xa("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",i),...p})]}));Jc.displayName=Rc.displayName;const Kc=({className:i,...p})=>e.jsx("div",{className:Xa("flex flex-col space-y-2 text-center sm:text-left",i),...p});Kc.displayName="AlertDialogHeader";const Yc=n.forwardRef(({className:i,...p},d)=>e.jsx(zc,{ref:d,className:Xa("text-lg font-semibold",i),...p}));Yc.displayName=zc.displayName;const Hc=n.forwardRef(({className:i,...p},d)=>e.jsx(qc,{ref:d,className:Xa("text-sm text-muted-foreground",i),...p}));Hc.displayName=qc.displayName;const pl=n.forwardRef(({className:i,...p},d)=>e.jsx(Bc,{ref:d,className:Xa(fc(),i),...p}));pl.displayName=Bc.displayName;const Gc=n.forwardRef(({className:i,...p},d)=>e.jsx(Uc,{ref:d,className:Xa(fc({variant:"outline"}),"mt-2 sm:mt-0",i),...p}));Gc.displayName=Uc.displayName;const Ot=i=>{try{return i.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(i)}},lc=i=>{try{return(i?new Date(i):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},ya="machine_daily_opening_values",ba="machine_daily_opening_snapshot";function wu({open:i,onOpenChange:p}){const{toast:d}=Gs(),{shiftUser:v}=Zr(),{shopId:w,shopName:C}=si(),s=()=>{try{const _=Object.keys(localStorage||{}).filter(le=>le.startsWith("selectedShopId_"));for(const le of _){const oe=localStorage.getItem(le);if(oe)return oe}return null}catch{return null}};n.useEffect(()=>{try{if(i){const _=document.body.style.overflow;document.body.setAttribute("data-prev-overflow",_),document.body.style.overflow="hidden"}else{const _=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=_,document.body.removeAttribute("data-prev-overflow")}}catch{}return()=>{try{const _=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=_,document.body.removeAttribute("data-prev-overflow")}catch{}}},[i]);const[j,R]=n.useState(""),[D,M]=n.useState(""),[E,f]=n.useState(""),[N,k]=n.useState(null),[K,F]=n.useState(null),[Q,te]=n.useState(null),[ce,L]=n.useState(null),[$,ve]=n.useState(!1),[Se,he]=n.useState(!1),[de,ne]=n.useState(""),[$e,qe]=n.useState(""),[_e,Ye]=n.useState(null),[Je,dt]=n.useState([]),[ee,we]=n.useState([]),[rt,ie]=n.useState(!1),[Ce,vt]=n.useState(""),[ss,Bt]=n.useState(""),[as,Pe]=n.useState(!1),[et,mt]=n.useState(null),[De,ht]=n.useState([]),[q,Dt]=n.useState(null),[Pt,wt]=n.useState(""),[W,Ne]=n.useState(!1),[Oe,gt]=n.useState(!1);n.useEffect(()=>{if(i)try{const _=q?`${ya}_${q}`:ya,le=q?`${ba}_${q}`:ba,oe=localStorage.getItem(_);if(oe){const Ee=JSON.parse(oe);typeof(Ee==null?void 0:Ee.openingBase)=="number"&&k(Ee.openingBase),typeof(Ee==null?void 0:Ee.openingAir)=="number"&&F(Ee.openingAir),typeof(Ee==null?void 0:Ee.drawerCash)=="number"&&te(Ee.drawerCash)}else k(null),F(null),te(null);const Ae=localStorage.getItem(le);if(Ae){const Ee=JSON.parse(Ae);typeof(Ee==null?void 0:Ee.openingBase)=="number"&&typeof(Ee==null?void 0:Ee.openingAir)=="number"?L({openingBase:Ee.openingBase,openingAir:Ee.openingAir,drawerCash:Ee.drawerCash||0}):L(null)}else L(null)}catch{}},[i,q]),n.useEffect(()=>{(async()=>{try{const _=w||s();if(!i||!_)return;const{getDocs:le}=await bt(async()=>{const{getDocs:Re}=await import("./index-gOTNP7ME.js").then(nt=>nt.bN);return{getDocs:Re}},__vite__mapDeps([0,1]),import.meta.url),oe=je(V,"shops",_,"machines"),Ee=(await le(Ue(oe))).docs.map(Re=>({id:Re.id,name:String(Re.data().name||"ماكينة")}));ht(Ee);try{const Re=localStorage.getItem(`machineDaily_selected_${_}`);Re&&Ee.some(J=>J.id===Re)?Dt(Re):!q&&Ee.length>0&&(Dt(Ee[0].id),localStorage.setItem(`machineDaily_selected_${_}`,Ee[0].id))}catch{}}catch(_){console.error("Load machines error:",_)}})()},[i,w]);const ot=n.useMemo(()=>(v==null?void 0:v.displayName)||(v==null?void 0:v.name)||(v==null?void 0:v.username)||void 0,[v]),Mt=n.useMemo(()=>ee.reduce((_,le)=>_+(le.profit||0),0),[ee]),Lt=n.useMemo(()=>ee.reduce((_,le)=>_+(le.wholesalePrice||0),0),[ee]),Nt=async()=>{try{const _=w||s();if(_&&q){const le=je(V,"shops",_,"machines",q,"transfers"),oe=await Qe(Ue(le));await Promise.all(oe.docs.map(Ae=>As(Ae.ref)));try{localStorage.setItem(`machineDaily_transfers_${_}_${q}`,JSON.stringify([]))}catch{}}}catch{}we([]),d({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."})},st=async()=>{try{const _=w||s();if(_&&q){const le=je(V,"shops",_,"machines",q,"deliveries"),oe=await Qe(Ue(le));await Promise.all(oe.docs.map(Ae=>As(Ae.ref)));try{localStorage.setItem(`machineDaily_deliveries_${_}_${q}`,JSON.stringify([]))}catch{}}}catch{}dt([]),d({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."})},$t=_=>{dt(le=>le.filter(oe=>oe.id!==_)),d({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},kt=()=>{k(null),F(null),te(null),L(null),R(""),M(""),f("");try{const _=q?`${ya}_${q}`:ya,le=q?`${ba}_${q}`:ba;localStorage.removeItem(_),localStorage.removeItem(le)}catch{}d({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},Qs=async()=>{var Ae;const _=parseFloat(j||"0"),le=parseFloat(D||"0"),oe=parseFloat(E||"0");if(isNaN(_)||isNaN(le)||isNaN(oe)){d({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(_<0||le<0||oe<0){d({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}k(_),F(le),te(oe);try{const Ee=q?`${ya}_${q}`:ya,Re=q?`${ba}_${q}`:ba;localStorage.setItem(Ee,JSON.stringify({openingBase:_,openingAir:le,drawerCash:oe})),localStorage.setItem(Re,JSON.stringify({openingBase:_,openingAir:le,drawerCash:oe})),L({openingBase:_,openingAir:le,drawerCash:oe});const nt=w||s();if(nt&&q){const J=Ve(V,"shops",nt,"machines",q);await Ys(J,{name:((Ae=De.find(ke=>ke.id===q))==null?void 0:Ae.name)||"ماكينة",openingBase:_,openingAir:le,drawerCash:oe,cashierName:ot,shopName:C||null,updatedAt:xt()},{merge:!0})}}catch{}d({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${Ot(_)}، الهواء: ${Ot(le)}، فلوس الدرج: ${Ot(oe)}`})},Vt=()=>{if(N==null||K==null){d({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}he(!0)},is=()=>{const _=parseFloat(de||"0"),le=parseFloat($e||"0");if(isNaN(_)||isNaN(le)){d({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(_<0||le<0){d({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const oe=(ce==null?void 0:ce.openingBase)??(N||0),Ae=(ce==null?void 0:ce.openingAir)??(K||0),Ee=oe+Ae,nt=_+le-Ee;Ye(nt);const J={id:`${Date.now()}`,openingBase:oe,openingAir:Ae,deliveryBase:_,deliveryAir:le,netResult:nt,createdAt:new Date().toISOString(),cashierName:ot,requiredDrawerNoProfit:nt<0?Math.round(-nt*100)/100:0};(async()=>{try{const ke=w||s();ke&&q&&(await Hs(je(V,"shops",ke,"machines",q,"deliveries"),{cashierName:ot,openingBase:oe,openingAir:Ae,deliveryBase:_,deliveryAir:le,netResult:nt,createdAt:xt()}),await Ys(Ve(V,"shops",ke,"machines",q),{lastDeliveryAt:xt(),updatedAt:xt()},{merge:!0}))}catch(ke){console.error("Persist delivery error:",ke)}})(),dt(ke=>[J,...ke]);try{const ke=w||s(),H=ke&&q?`machineDaily_deliveries_${ke}_${q}`:`machineDaily_deliveries_${q}`,jt=localStorage.getItem(H),Ct=jt?JSON.parse(jt):[],Ut=[J,...Array.isArray(Ct)?Ct:[]];localStorage.setItem(H,JSON.stringify(Ut))}catch{}d({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${Ot(nt)}`})},aa=()=>{const _=parseFloat(Ce||"0"),le=parseFloat(ss||"0");if(!Number.isFinite(_)||!Number.isFinite(le)){d({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if(_<0||le<0){d({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(N==null||K==null){d({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const oe=Math.round((le-_)*100)/100;mt({wholesalePrice:_,retailPrice:le,profit:oe}),Pe(!0)},Us=async _=>{if(!et)return;const le={id:`transfer_${Date.now()}`,wholesalePrice:et.wholesalePrice,retailPrice:et.retailPrice,profit:et.profit,createdAt:new Date().toISOString(),cashierName:ot,deductFrom:_},oe=et.wholesalePrice,Ae=N??0,Ee=K??0,Re=Q??0;if(oe>(_==="base"?Ae:Ee)){d({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const J=_==="base"?Math.round((Ae-oe)*100)/100:Ae,ke=_==="air"?Math.round((Ee-oe)*100)/100:Ee,H=et.retailPrice,jt=Math.round((Re+H)*100)/100;k(J),F(ke),te(jt);try{const Ct=q?`${ya}_${q}`:ya,Ut=q?`${ba}_${q}`:ba;localStorage.setItem(Ct,JSON.stringify({openingBase:J,openingAir:ke,drawerCash:jt})),localStorage.setItem(Ut,JSON.stringify({openingBase:J,openingAir:ke,drawerCash:jt}));const rs=w||s();if(rs&&q){const Ht=Ve(V,"shops",rs,"machines",q);await Ys(Ht,{openingBase:J,openingAir:ke,drawerCash:jt,cashierName:ot,updatedAt:xt()},{merge:!0}),await Hs(je(V,"shops",rs,"machines",q,"transfers"),{wholesalePrice:et.wholesalePrice,retailPrice:et.retailPrice,profit:et.profit,deductFrom:_,cashierName:ot,createdAt:xt()})}}catch{}we(Ct=>[le,...Ct]);try{const Ct=w||s(),Ut=Ct&&q?`machineDaily_transfers_${Ct}_${q}`:"machineDaily_transfers",rs=localStorage.getItem(Ut),Ht=rs?JSON.parse(rs):[],ra=[le,...Array.isArray(Ht)?Ht:[]];localStorage.setItem(Ut,JSON.stringify(ra))}catch{}ie(!1),vt(""),Bt(""),mt(null),Pe(!1),d({title:"تم تسجيل تحويل",description:`الربح الفوري: ${Ot(le.profit)} | خصم المخزون: -${Ot(oe)} (${_==="base"?"الأساسي":"الهواء"}) | درج (المباع فقط): +${Ot(H)}`})},Sa=()=>{R(""),M(""),he(!1),ne(""),qe(""),Ye(null)};n.useEffect(()=>{const _=w||s();if(!(!i||!_||!q))try{const le=je(V,"shops",_,"machines",q,"transfers"),oe=Ls(le,async Ae=>{const Re=[...Ae.docs.map(nt=>{var jt,Ct;const J=nt.data(),ke=(Ct=(jt=J==null?void 0:J.createdAt)==null?void 0:jt.toDate)!=null&&Ct.call(jt)?J.createdAt.toDate():new Date,H=J==null?void 0:J.deductFrom;return{id:nt.id,wholesalePrice:Number((J==null?void 0:J.wholesalePrice)||0),retailPrice:Number((J==null?void 0:J.retailPrice)||0),profit:Number((J==null?void 0:J.profit)??(Number((J==null?void 0:J.retailPrice)||0)-Number((J==null?void 0:J.wholesalePrice)||0)||0)),createdAt:ke.toISOString(),cashierName:(J==null?void 0:J.cashierName)||void 0,deductFrom:H==="base"||H==="air"?H:void 0}})].sort((nt,J)=>{const ke=new Date(nt.createdAt).getTime();return new Date(J.createdAt).getTime()-ke});if(Re.length>0){we(Re),Ne(!0);try{localStorage.setItem(`machineDaily_transfers_${_}_${q}`,JSON.stringify(Re))}catch{}}else if(W){we([]);try{localStorage.setItem(`machineDaily_transfers_${_}_${q}`,JSON.stringify([]))}catch{}}});return()=>{try{oe()}catch{}}}catch{}},[i,w,q,W]),n.useEffect(()=>{const _=w||s();if(!(!i||!_||!q))try{const le=je(V,"shops",_,"machines",q,"deliveries"),oe=Ls(le,Ae=>{const Re=[...Ae.docs.map(nt=>{var H,jt;const J=nt.data(),ke=(jt=(H=J==null?void 0:J.createdAt)==null?void 0:H.toDate)!=null&&jt.call(H)?J.createdAt.toDate():new Date;return{id:nt.id,openingBase:Number((J==null?void 0:J.openingBase)||0),openingAir:Number((J==null?void 0:J.openingAir)||0),deliveryBase:Number((J==null?void 0:J.deliveryBase)||0),deliveryAir:Number((J==null?void 0:J.deliveryAir)||0),netResult:typeof(J==null?void 0:J.netResult)=="number"?Number(J.netResult):Math.round((Number((J==null?void 0:J.deliveryBase)||0)+Number((J==null?void 0:J.deliveryAir)||0)-(Number((J==null?void 0:J.openingBase)||0)+Number((J==null?void 0:J.openingAir)||0)))*100)/100,createdAt:ke.toISOString(),cashierName:(J==null?void 0:J.cashierName)||void 0,requiredDrawerNoProfit:typeof(J==null?void 0:J.requiredDrawerNoProfit)=="number"?J.requiredDrawerNoProfit:void 0}})].sort((nt,J)=>new Date(J.createdAt).getTime()-new Date(nt.createdAt).getTime());if(Re.length>0){dt(Re),gt(!0);try{localStorage.setItem(`machineDaily_deliveries_${_}_${q}`,JSON.stringify(Re))}catch{}}else if(Oe){dt([]);try{localStorage.setItem(`machineDaily_deliveries_${_}_${q}`,JSON.stringify([]))}catch{}}});return()=>{try{oe()}catch{}}}catch{}},[i,w,q,Oe]),n.useEffect(()=>{if(!(!i||!q))try{const _=w||s(),le=_?`machineDaily_deliveries_${_}_${q}`:`machineDaily_deliveries_${q}`,oe=localStorage.getItem(le);if(oe){const Ae=JSON.parse(oe);Array.isArray(Ae)&&Ae.length>0&&dt(Ae)}(async()=>{try{const Ae=w||s();if(!Ae)return;const Ee=je(V,"shops",Ae,"machines",q,"deliveries"),J=[...(await Qe(Ue(Ee))).docs.map(ke=>{var Ct,Ut;const H=ke.data(),jt=(Ut=(Ct=H==null?void 0:H.createdAt)==null?void 0:Ct.toDate)!=null&&Ut.call(Ct)?H.createdAt.toDate():new Date;return{id:ke.id,openingBase:Number((H==null?void 0:H.openingBase)||0),openingAir:Number((H==null?void 0:H.openingAir)||0),deliveryBase:Number((H==null?void 0:H.deliveryBase)||0),deliveryAir:Number((H==null?void 0:H.deliveryAir)||0),netResult:typeof(H==null?void 0:H.netResult)=="number"?Number(H.netResult):Math.round((Number((H==null?void 0:H.deliveryBase)||0)+Number((H==null?void 0:H.deliveryAir)||0)-(Number((H==null?void 0:H.openingBase)||0)+Number((H==null?void 0:H.openingAir)||0)))*100)/100,createdAt:jt.toISOString(),cashierName:(H==null?void 0:H.cashierName)||void 0,requiredDrawerNoProfit:typeof(H==null?void 0:H.requiredDrawerNoProfit)=="number"?H.requiredDrawerNoProfit:void 0}})].sort((ke,H)=>new Date(H.createdAt).getTime()-new Date(ke.createdAt).getTime());if(J.length>0){dt(J);try{localStorage.setItem(`machineDaily_deliveries_${Ae}_${q}`,JSON.stringify(J))}catch{}}}catch{}})()}catch{}},[i,w,q]),n.useEffect(()=>{if(!(!i||!q))try{const _=w||s(),le=_?`machineDaily_transfers_${_}_${q}`:`machineDaily_transfers_${q}`,oe=localStorage.getItem(le);if(oe){const Ae=JSON.parse(oe);Array.isArray(Ae)&&Ae.length>0&&we(Ae)}(async()=>{try{const Ae=w||s();if(!Ae)return;const Ee=je(V,"shops",Ae,"machines",q,"transfers"),J=[...(await Qe(Ue(Ee))).docs.map(ke=>{var Ut,rs;const H=ke.data(),jt=(rs=(Ut=H==null?void 0:H.createdAt)==null?void 0:Ut.toDate)!=null&&rs.call(Ut)?H.createdAt.toDate():new Date,Ct=H==null?void 0:H.deductFrom;return{id:ke.id,wholesalePrice:Number((H==null?void 0:H.wholesalePrice)||0),retailPrice:Number((H==null?void 0:H.retailPrice)||0),profit:Number((H==null?void 0:H.profit)??(Number((H==null?void 0:H.retailPrice)||0)-Number((H==null?void 0:H.wholesalePrice)||0)||0)),createdAt:jt.toISOString(),cashierName:(H==null?void 0:H.cashierName)||void 0,deductFrom:Ct==="base"||Ct==="air"?Ct:void 0}})].sort((ke,H)=>new Date(H.createdAt).getTime()-new Date(ke.createdAt).getTime());if(J.length>0){we(J);try{localStorage.setItem(`machineDaily_transfers_${Ae}_${q}`,JSON.stringify(J))}catch{}}}catch{}})()}catch{}},[i,w,q]);const ls=_=>{_||Sa(),p(_)};return e.jsxs(ge,{open:i,onOpenChange:ls,children:[e.jsxs(fe,{className:"w-screen h-[100vh] overflow-hidden rounded-none p-0 flex flex-col dark:bg-[#121212]",children:[e.jsxs(ye,{className:"sticky top-0 bg-white dark:bg-[#0F0F0F] z-20 border-b border-gray-200 dark:border-[#333] px-4 py-3",children:[e.jsx(be,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Cc,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(ps,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"px-4 py-3 overflow-y-auto flex-1 grid grid-cols-1 gap-6",children:[e.jsxs(Et,{children:[e.jsx(hs,{className:"pb-2",children:e.jsxs(Ts,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"اختيار ماكينة"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{variant:"destructive",onClick:async()=>{try{if(!w||!q)return;const _=Ve(V,"shops",w,"machines",q);try{const oe=await Qe(je(V,"shops",w,"machines",q,"transfers"));await Promise.all(oe.docs.map(Ae=>As(Ae.ref)))}catch{}try{const oe=await Qe(je(V,"shops",w,"machines",q,"deliveries"));await Promise.all(oe.docs.map(Ae=>As(Ae.ref)))}catch{}await As(_),ht(oe=>oe.filter(Ae=>Ae.id!==q));const le=De.find(oe=>oe.id!==q);Dt(le?le.id:null);try{const oe=`${ya}_${q}`,Ae=`${ba}_${q}`;localStorage.removeItem(oe),localStorage.removeItem(Ae)}catch{}d({title:"تم حذف الماكينة",description:"تمت الإزالة نهائيًا."})}catch{d({title:"فشل الحذف",description:"تعذر حذف الماكينة.",variant:"destructive"})}},disabled:!q,title:"حذف الماكينة",children:e.jsx(ms,{className:"h-4 w-4"})})})]})}),e.jsx(Ft,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الماكينة الحالية"}),e.jsxs(_a,{value:q??"",onValueChange:_=>{Dt(_);try{const le=w||s();le&&localStorage.setItem(`machineDaily_selected_${le}`,_)}catch{}},children:[e.jsx(Oa,{className:"text-right",children:e.jsx(Ea,{placeholder:"اختر ماكينة"})}),e.jsx(Ma,{children:De.map(_=>e.jsx(ta,{value:_.id,children:_.name},_.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"إنشاء ماكينة جديدة"}),e.jsx(U,{value:Pt,onChange:_=>wt(_.target.value),placeholder:"اسم الماكينة",className:"text-right"})]}),e.jsx("div",{className:"flex justify-end md:justify-start",children:e.jsx(h,{onClick:async()=>{try{if(!w){d({title:"لا يوجد محل",description:"يرجى التأكد من تحميل بيانات المحل.",variant:"destructive"});return}const _=(Pt||"").trim();if(!_){d({title:"اسم الماكينة مطلوب",description:"أدخل اسم للماكينة الجديدة.",variant:"destructive"});return}const le=await Hs(je(V,"shops",w,"machines"),{name:_,shopId:w,createdAt:xt(),updatedAt:xt(),isActive:!0}),oe={id:le.id,name:_};ht(Ae=>[oe,...Ae]),Dt(le.id),wt(""),d({title:"تم إنشاء ماكينة",description:`تمت إضافة ${_}`})}catch(_){console.error("Create machine error:",_),d({title:"خطأ في الإنشاء",description:"تعذر إنشاء الماكينة.",variant:"destructive"})}},className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})})]})]})})]}),e.jsxs(Et,{children:[e.jsx(hs,{className:"pb-2",children:e.jsxs(Ts,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>ve(_=>!_),className:"flex items-center gap-1",children:e.jsx(Yr,{className:`h-4 w-4 transition-transform ${$?"rotate-180":""}`})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{variant:"outline",onClick:()=>ie(!0),disabled:N==null||K==null,className:"border-violet-300 text-violet-700",children:"تحويل"})}),N!=null&&K!=null&&e.jsxs(Qt,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",Ot(N)," | هواء ",Ot(K)," | درج ",Ot(Q??0)]})]}),e.jsxs(Ft,{className:`space-y-4 ${$?"":"hidden"}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:j,onChange:_=>R(_.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:D,onChange:_=>M(_.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:E,onChange:_=>f(_.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(h,{variant:"outline",className:"mr-2",onClick:kt,children:"تصفير"}),e.jsx(h,{onClick:Qs,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),e.jsxs(Et,{children:[e.jsx(hs,{className:"pb-2",children:e.jsxs(Ts,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات تحويل"}),e.jsxs(Qt,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",Ot(Mt)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:Nt,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(Qr,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Ft,{className:"space-y-3",children:ee.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-3 max-h-52 overflow-y-auto pr-1",children:ee.map(_=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر الجملة"}),e.jsx("p",{className:"text-sm",children:Ot(_.wholesalePrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر التجزئة"}),e.jsx("p",{className:"text-sm",children:Ot(_.retailPrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الربح الفوري"}),e.jsx("p",{className:"text-sm text-green-700",children:Ot(_.profit)}),_.deductFrom&&e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"text-[11px] bg-violet-100 text-violet-700 border border-violet-200 rounded px-2 py-0.5",children:["الخصم من: ",_.deductFrom==="base"?"الأساسي":"الهواء"]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx($a,{className:"h-3 w-3"}),e.jsx("span",{children:lc(_.createdAt)}),_.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(ul,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",_.cashierName]})]})]})]})]},_.id))})})]}),e.jsxs(Et,{children:[e.jsx(hs,{className:"pb-2",children:e.jsx(Ts,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(Ft,{className:"space-y-4",children:Se?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:de,onChange:_=>ne(_.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:$e,onChange:_=>qe(_.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"secondary",onClick:()=>he(!1),children:"إلغاء"}),e.jsx(h,{onClick:is,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),_e!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(Qt,{className:_e>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",Ot(_e)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(Qt,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",Ot(parseFloat(de||"0")+parseFloat($e||"0"))]}),e.jsxs(Qt,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",Ot(Lt)]})]})]})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{variant:"outline",onClick:Vt,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs(Et,{children:[e.jsx(hs,{className:"pb-2",children:e.jsxs(Ts,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:st,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(Qr,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Ft,{className:"space-y-3",children:Je.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:Je.map(_=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Ot(_.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Ot(_.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Ot(_.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Ot(_.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>$t(_.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(ms,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${_.netResult>=0?"text-green-700":"text-red-700"}`,children:Ot(_.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",Ot(_.deliveryBase+_.deliveryAir)]}),typeof _.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",Ot(_.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx($a,{className:"h-3 w-3"}),e.jsx("span",{children:lc(_.createdAt)}),_.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(ul,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",_.cashierName]})]})]})]})]},_.id))})})]})]}),e.jsxs(lt,{className:"sticky bottom-0 bg-white dark:bg-[#0F0F0F] z-20 border-t border-gray-200 dark:border-[#333] px-4 py-3 flex items-center justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>ls(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(Na,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(ge,{open:rt,onOpenChange:ie,children:e.jsxs(fe,{className:"sm:max-w-sm",children:[e.jsx(ye,{children:e.jsx(be,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Ce,onChange:_=>vt(_.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:ss,onChange:_=>Bt(_.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(Qt,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",Ot(parseFloat(ss||"0")-parseFloat(Ce||"0")||0)]})})]}),e.jsxs(lt,{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"secondary",onClick:()=>ie(!1),children:"إلغاء"}),e.jsx(h,{onClick:aa,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(bu,{open:as,onOpenChange:Pe,children:e.jsxs(Jc,{children:[e.jsxs(Kc,{children:[e.jsx(Yc,{children:"اختيار مصدر الخصم"}),e.jsx(Hc,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(Gc,{onClick:()=>Pe(!1),children:"رجوع"}),e.jsx(pl,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>Us("base"),children:"خصم من الأساسي"}),e.jsx(pl,{className:"bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>Us("air"),children:"خصم من الهواء"})]})]})})]})}function Nu(i,p=300){const[d,v]=Ke.useState(i);return Ke.useEffect(()=>{const w=setTimeout(()=>v(i),p);return()=>clearTimeout(w)},[i,p]),d}const ju=({userId:i,transactions:p})=>{const[d,v]=n.useState(!1),[w,C]=n.useState(!1),[s,j]=n.useState(!1),[R,D]=n.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:M}=da();n.useEffect(()=>{i&&d&&s&&E()},[i,d,s]);const E=async()=>{if(i)try{if(Array.isArray(p)&&p.length>0){const Q=new Date,te=Q.getMonth(),ce=Q.getFullYear(),L=bs.filterVisibleTransactions(p,"monthly",i);let $=0,ve=0;L.forEach(Se=>{const he=new Date(Se.createdAt),de=String(Se.status||"confirmed").toLowerCase();if(he.getMonth()!==te||he.getFullYear()!==ce||de!=="completed"&&de!=="confirmed")return;const ne=(Se.type||Se.txnType||"").toLowerCase(),$e={type:ne==="withdrawal"?"withdraw":ne,amount:Number(Se.amount||0),commission:Se.commission};$e.type==="withdraw"?$+=La.calculateProfitFromTransaction($e):($e.type==="send"||$e.type==="receive"||$e.type==="transfer")&&(ve+=La.calculateProfitFromTransaction($e))}),D({monthlyWithdrawalProfit:Math.round($*100)/100,monthlyTransferProfit:Math.round(ve*100)/100,lastUpdated:new Date});return}const F=La.getWithdrawTransferProfits(i);D({monthlyWithdrawalProfit:F.monthlyWithdrawProfit||0,monthlyTransferProfit:F.monthlyTransferProfit||0,lastUpdated:new Date})}catch(F){console.error("Error loading profit data:",F)}},f=F=>`${F.toFixed(2)} ج.م`,N=async()=>{try{const F=(M==null?void 0:M.subscription)||null,Q=(F==null?void 0:F.planType)??(F==null?void 0:F.plan)??null,te=typeof Q=="string"?Q.toLowerCase():null;if(Q===Is.ZERO||te==="zero"||te==="0"||Q===0)return!0}catch{}try{if(i){const F=await gl(i),Q=(F==null?void 0:F.planType)??(F==null?void 0:F.plan)??null,te=typeof Q=="string"?Q.toLowerCase():null;if(Q===Is.ZERO||te==="zero"||te==="0"||Q===0)return!0}}catch{}return!1},k=async()=>{try{if(await N()){Ho({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}C(!0)},K=async()=>{try{if(await N()){Ho({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),C(!1);return}}catch{}j(!0),v(!0),C(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:k,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح الشهرية",children:e.jsx(Rt,{className:"h-1.5 w-1.5"})}),e.jsx(ge,{open:d,onOpenChange:v,children:e.jsxs(fe,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ye,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:e.jsxs(be,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx($a,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"شهري"]})}),e.jsx("div",{className:"py-0 sm:py-3",children:e.jsxs("div",{className:"rounded-xl border border-purple-300 bg-white overflow-hidden",children:[e.jsx("div",{className:"p-2 sm:p-3 bg-red-50 border-b border-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Xn,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800 text-xs",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-2 py-0.5 rounded",children:f(R.monthlyWithdrawalProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-blue-50 border-b border-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(fl,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-blue-900 bg-white px-2 py-0.5 rounded",children:f(R.monthlyTransferProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Yt,{className:"h-3 w-3 text-purple-600"}),e.jsx("span",{className:"font-medium text-purple-800 text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"font-bold text-sm text-purple-900 bg-white px-2 py-0.5 rounded",children:f(R.monthlyWithdrawalProfit+R.monthlyTransferProfit)})]})})]})}),!s&&e.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>C(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:e.jsx(Rt,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:e.jsx(h,{onClick:()=>v(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),e.jsx(gs,{open:w,onOpenChange:C,onSuccess:K,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},Su=i=>e.jsx(ju,{...i});function Du({open:i,onOpenChange:p,onSuccess:d,userId:v}){const[w,C]=n.useState(""),[s,j]=n.useState(""),[R,D]=n.useState(!1),[M,E]=n.useState(!1),[f,N]=n.useState(""),[k,K]=n.useState(!1),[F,Q]=n.useState(!1),{toast:te}=Gs();n.useEffect(()=>{let $=!0;return(async()=>{const ve=await ws.hasMasterPin(v);$&&Q(ve)})(),()=>{$=!1}},[v,i]);const ce=()=>{C(""),j(""),N(""),D(!1),E(!1),p(!1)},L=async $=>{$.preventDefault(),N(""),K(!0);try{if(F){if(!await ws.verifyMasterPin(w,v)){N("الرقم السري غير صحيح"),K(!1);return}}else{if(w.length<4){N("يجب أن يكون الرقم السري 4 أرقام على الأقل"),K(!1);return}if(w!==s){N("الرقم السري غير متطابق"),K(!1);return}if(!await ws.createMasterPin(w,v)){N("تعذر إنشاء الرقم السري الرئيسي"),K(!1);return}}te({title:"نجح العملية",description:F?"تم التحقق من الرقم السري الرئيسي بنجاح":"تم إنشاء الرقم السري الرئيسي بنجاح"}),d(),ce()}catch{N("حدث خطأ أثناء معالجة الرقم السري")}finally{K(!1)}};return e.jsx(ge,{open:i,onOpenChange:p,children:e.jsxs(fe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ye,{children:e.jsxs(be,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(Za,{className:"h-5 w-5 text-green-600"}),F?"أدخل الرقم السري الرئيسي":"إنشاء الرقم السري الرئيسي"]})}),e.jsxs("form",{onSubmit:L,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:F?"أدخل الرقم السري الرئيسي لعرض بيانات الأرباح":"قم بإنشاء الرقم السري الرئيسي لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"pin",children:F?"الرقم السري الرئيسي":"الرقم السري الرئيسي الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"pin",type:R?"text":"password",value:w,onChange:$=>C($.target.value),placeholder:F?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>D(!R),children:R?e.jsx(fs,{className:"h-4 w-4"}):e.jsx(Rt,{className:"h-4 w-4"})})]})]}),!F&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:M?"text":"password",value:s,onChange:$=>j($.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>E(!M),children:M?e.jsx(fs,{className:"h-4 w-4"}):e.jsx(Rt,{className:"h-4 w-4"})})]})]}),f&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(er,{className:"h-4 w-4"}),f]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:k,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Za,{className:"h-4 w-4 mr-2"}),k?"جاري المعالجة...":F?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(h,{type:"button",variant:"outline",onClick:ce,disabled:k,children:"إلغاء"})]})]})]})})}const Cu=({userId:i,transactions:p})=>{const[d,v]=n.useState(!1),[w,C]=n.useState(!1),[s,j]=n.useState(!1),[R,D]=n.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});n.useEffect(()=>{i&&d&&s&&M()},[i,d,s,p]);const M=async()=>{if(i)try{if(Array.isArray(p)&&p.length>0){const K=new Date,F=bs.filterVisibleTransactions(p,"daily",i);let Q=0,te=0;F.forEach(ce=>{const L=new Date(ce.createdAt),$=String(ce.status||"confirmed").toLowerCase();if(L.toDateString()!==K.toDateString()||$!=="completed"&&$!=="confirmed"&&$!=="pending")return;const ve=(ce.type||ce.txnType||"").toLowerCase(),Se=String(ce.title||"");if(ve==="cash_addition"||Se.includes("إيصال إضافة نقدية"))return;const he={type:ve==="withdrawal"?"withdraw":ve,amount:Number(ce.amount||0),commission:ce.commission};he.type==="withdraw"?Q+=La.calculateProfitFromTransaction(he):(he.type==="send"||he.type==="receive"||he.type==="transfer")&&(te+=La.calculateProfitFromTransaction(he))}),D({dailyWithdrawalProfit:Math.round(Q*100)/100,dailyTransferProfit:Math.round(te*100)/100,lastUpdated:new Date});try{La.updateProfitsFromTransactions(p,i)}catch{}return}const k=La.getWithdrawTransferProfits(i);D({dailyWithdrawalProfit:k.dailyWithdrawProfit||0,dailyTransferProfit:k.dailyTransferProfit||0,lastUpdated:new Date})}catch(k){console.error("Error loading profit data:",k)}},E=k=>`${k.toFixed(2)} ج.م`,f=()=>{La.hasProfitPin(i),C(!0)},N=()=>{j(!0),v(!0),C(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:f,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح اليومية",children:e.jsx(Rt,{className:"h-1.5 w-1.5"})}),e.jsx(ge,{open:d,onOpenChange:v,children:e.jsxs(fe,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-blue-50 sm:to-white sm:border-2 sm:border-blue-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ye,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-blue-200",children:e.jsxs(be,{className:"text-xs font-bold text-blue-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-sm sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(Yt,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),"يومي"]})}),e.jsx("div",{className:"py-0 sm:py-3",children:e.jsxs("div",{className:"rounded-xl border border-blue-300 bg-white overflow-hidden",children:[e.jsx("div",{className:"p-2 sm:p-3 bg-red-50 border-b border-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Xn,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800 text-xs",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-2 py-0.5 rounded",children:E(R.dailyWithdrawalProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-green-50 border-b border-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(fl,{className:"h-3 w-3 text-green-600"}),e.jsx("span",{className:"font-medium text-green-800 text-xs",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-green-900 bg-white px-2 py-0.5 rounded",children:E(R.dailyTransferProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-blue-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Yt,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"font-bold text-sm text-blue-900 bg-white px-2 py-0.5 rounded",children:E(R.dailyWithdrawalProfit+R.dailyTransferProfit)})]})})]})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-blue-200",children:e.jsx(h,{onClick:()=>v(!1),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-blue-600 sm:to-blue-700 sm:hover:from-blue-700 sm:hover:to-blue-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300 sm:text-xs",children:"إغلاق"})})]})}),e.jsx(Du,{open:w,onOpenChange:C,onSuccess:N,userId:i})]})},Iu=i=>e.jsx(Cu,{...i}),Au=({open:i,onOpenChange:p})=>{var Ra;const{shiftUser:d,isShiftActive:v,shiftStartAt:w,setShiftUser:C,startShift:s,endShift:j}=Zr(),{userSubscription:R,user:D,signIn:M,profile:E}=da(),{toast:f}=Gs(),[N,k]=n.useState((d==null?void 0:d.name)||""),[K,F]=n.useState((d==null?void 0:d.username)||""),[Q,te]=n.useState(""),[ce,L]=n.useState(!1),[$,ve]=n.useState(null),[Se,he]=n.useState(""),[de,ne]=n.useState(""),[$e,qe]=n.useState(!1),[_e,Ye]=n.useState(null),[Je,dt]=n.useState(""),[ee,we]=n.useState(""),[rt,ie]=n.useState(!1),[Ce,vt]=n.useState(!1),[ss,Bt]=n.useState({totalTransfers:0,totalWithdrawals:0}),[as,Pe]=n.useState(null),[et,mt]=n.useState(""),[De,ht]=n.useState(""),[q,Dt]=n.useState(0),[Pt,wt]=n.useState({}),[W,Ne]=n.useState(0),[Oe,gt]=n.useState(0),[ot,Mt]=n.useState({}),[Lt,Nt]=n.useState(""),[st,$t]=n.useState(!1),kt=B=>{const Ie={"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9","۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9","٫":".","،":".","٬":"."," ":""};return B.split("").map(at=>Ie[at]??at).join("")},Qs=()=>`cashierUsers_${(D==null?void 0:D.uid)||"default"}`,[Vt,is]=n.useState(()=>{try{let B=localStorage.getItem(Qs());if(!B){const Ie=localStorage.getItem("cashierUsers");Ie&&(B=Ie)}return B?JSON.parse(B):[]}catch{return[]}});n.useEffect(()=>{(async()=>{try{if(!(D!=null&&D.uid))return;const B=Ve(V,"profiles",D.uid,"cashierUsers","list"),Ie=await va(B);if(Ie.exists()){const at=Ie.data(),St=Array.isArray(at==null?void 0:at.users)?at.users:[];St&&St.length>0&&is(St)}}catch{}})()},[D==null?void 0:D.uid]),n.useEffect(()=>{if(!(D!=null&&D.uid))return;const B=Ve(V,"profiles",D.uid,"cashierUsers","list"),Ie=Ls(B,at=>{try{if(at.exists()){const St=at.data(),us=Array.isArray(St==null?void 0:St.users)?St.users:[];if(us&&us.length>0)is(us);else try{const Jt=localStorage.getItem(Qs()),Zt=Jt?JSON.parse(Jt):[];is(Zt)}catch{is([])}}}catch{}},at=>{console.warn("cashierUsers realtime subscription error:",at)});return()=>Ie()},[D==null?void 0:D.uid]);const aa=(Ra=R==null?void 0:R.subscription)==null?void 0:Ra.planType,Us=aa==="yearly"?2:aa==="lifetime"?4:Number.POSITIVE_INFINITY;n.useEffect(()=>{try{localStorage.setItem(Qs(),JSON.stringify(Vt));try{localStorage.removeItem("cashierUsers")}catch{}}catch{}(async()=>{try{if(!(D!=null&&D.uid))return;const B=Ve(V,"profiles",D.uid,"cashierUsers","list");await Ys(B,{users:Vt},{merge:!0})}catch{}})()},[Vt]);const[Sa,ls]=n.useState(!1),[_,le]=n.useState(""),[oe,Ae]=n.useState(null),[Ee,Re]=n.useState([]),[nt,J]=n.useState(!1),[ke,H]=n.useState(null),[jt,Ct]=n.useState(!1),[Ut,rs]=n.useState(!1),Ht=B=>{const Ie=(d==null?void 0:d.username)===B;let at=!1;try{at=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(Ie&&!(Ie&&!v&&(Lt==="الأدمن الرئيسي"||at))){f({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const Jt=`هل أنت متأكد من حذف المستخدم ${B}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(Jt)&&(is(Zt=>Zt.filter(Ba=>Ba.username!==B)),Ie&&C(null),f({title:"تم حذف المستخدم",description:B}))},ra=()=>{if(!N.trim()||!K.trim()||!Q.trim())return;if(Vt.length>=Us){f({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(Us)?Us:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const B={name:N.trim(),username:K.trim(),password:Q.trim()};is(Ie=>[B,...Ie]),k(""),F(""),te("")},ma=()=>{L(!0),ve(null),Ye(null),dt(""),we("")},$s=async()=>{try{let B=[];try{D!=null&&D.uid&&(B=await pe.getUserTransactions(D.uid))}catch{}if(!B||B.length===0)try{const ct=await Dc({merchantUserId:D==null?void 0:D.uid,limit:200});B=(ct==null?void 0:ct.transactions)||[]}catch{}const Ie=w?new Date(w):null,at=new Date,St=ct=>{const It=ct.type,Gt=ct.txnType;return It==="withdraw"||It==="withdrawal"||It==="receive"||Gt==="receive"},us=ct=>{const It=ct.type,Gt=ct.txnType;return It==="send"||It==="transfer"||Gt==="send"},Jt=ct=>{if(!ct)return null;if(ct instanceof Date)return ct;try{const It=new Date(ct);return Number.isNaN(It.getTime())?null:It}catch{return null}},Zt=ct=>{const It=Jt(ct.createdAt||ct.created_at||ct.timestamp);return!It||Ie&&It<Ie?!1:It<=at},Ba=ct=>ct==="completed"||ct==="confirmed",Ua=B.filter(ct=>Ba(ct.status)&&Zt(ct)),Xt=Ua.filter(ct=>St(ct)).reduce((ct,It)=>{const Gt=It.withdrawnAmount??It.receivedAmount??It.amount??0;return ct+(Number(Gt)||0)},0);return{totalTransfers:Ua.filter(ct=>us(ct)).reduce((ct,It)=>{const Gt=It.sentAmount??It.transferredAmount??It.amount??0;return ct+(Number(Gt)||0)},0),totalWithdrawals:Xt}}catch{return{totalTransfers:0,totalWithdrawals:0}}};n.useEffect(()=>{if(Ce){try{const B=localStorage.getItem("shiftInitialReceivedDrawerFunds");B!==null&&ht(B)}catch{}try{const B=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(B!==null){const Ie=parseFloat(B);Dt(Number.isFinite(Ie)?Ie:0)}}catch{}}},[Ce]),n.useEffect(()=>{ce&&(async()=>{try{const B=await $s();Bt(B)}catch{}})()},[ce]),n.useEffect(()=>{if(!i&&!nt)return;(async()=>{try{const at=((D!=null&&D.uid?await pe.getUserTransactions(D.uid):[])||[]).filter(St=>(St==null?void 0:St.type)==="report"||((St==null?void 0:St.title)||"").includes("إيصال تسليم وردية"));at.sort((St,us)=>{const Jt=new Date(St.createdAt||0).getTime();return new Date(us.createdAt||0).getTime()-Jt}),Re(at)}catch{Re([])}})()},[i,Ce,nt,D==null?void 0:D.uid]);const Fa=async(B,Ie,at)=>{try{let St=0,us=0;try{const Zt=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");St=Number.isFinite(Zt)?Zt:0}catch{}try{const Zt=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");us=Number.isFinite(Zt)?Zt:0}catch{}const Jt={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(d==null?void 0:d.username)||"cashier",receiverPhone:Lt||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(d==null?void 0:d.name)||(d==null?void 0:d.username)||null,deficit:Ie,deficitAmount:Ie?at:0,shiftStartAt:w,receivedDrawerFunds:St,receivedWalletBalancesTotal:us,receivedWalletBalances:Pt,deliveredDrawerFunds:W||0,deliveredWalletBalancesTotal:Oe||0,deliveredWalletBalances:ot,shiftProfit:Math.round(((W||0)+(Oe||0)-(St+us))*100)/100};D!=null&&D.uid&&await pe.saveUserTransaction(D.uid,Jt),Re(Zt=>[Jt,...Zt||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(ge,{open:i,onOpenChange:p,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(be,{children:v?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),v?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[d==null?void 0:d.name," (",d==null?void 0:d.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),Vt.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:Vt.map((B,Ie)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:B.name}),e.jsx("div",{className:"text-xs text-gray-500",children:B.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(h,{size:"sm",className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>{Ae(B),ls(!0)},children:"دخول"}),e.jsx(h,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>Ht(B.username),children:"حذف"})]})]},Ie))})]})]}),e.jsx(lt,{className:"flex flex-wrap gap-2 justify-between",children:v?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(h,{className:"w-full sm:w-auto",variant:"destructive",onClick:ma,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(h,{className:"w-full sm:w-auto bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>rs(!0),children:"إضافة مستخدم جديد"}),e.jsx(h,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>J(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(ge,{open:Ut,onOpenChange:rs,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(be,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"الاسم"}),e.jsx(U,{value:N,onChange:B=>k(B.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(U,{value:K,onChange:B=>F(B.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(U,{type:"password",autoComplete:"new-password",value:Q,onChange:B=>te(B.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(lt,{className:"flex gap-2 justify-between",children:[e.jsx(h,{variant:"secondary",onClick:()=>{rs(!1)},children:"إلغاء"}),e.jsx(h,{onClick:()=>{!N.trim()||!K.trim()||!Q.trim()||(ra(),rs(!1))},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"حفظ المستخدم"})]})]})}),e.jsx(ge,{open:nt,onOpenChange:J,children:e.jsxs(fe,{className:"sm:max-w-lg",children:[e.jsx(ye,{children:e.jsx(be,{children:"إيصالات التسليم"})}),Ee.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:Ee.map(B=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{H(B),Ct(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(B.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",B.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",B.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",B.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",B.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",B.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",B.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",B.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",B.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",B.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(B.shiftProfit??(B.deliveredDrawerFunds??0)+(B.deliveredWalletBalancesTotal??0)-(B.receivedDrawerFunds??0)-(B.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",B.shiftProfit??(B.deliveredDrawerFunds??0)+(B.deliveredWalletBalancesTotal??0)-(B.receivedDrawerFunds??0)-(B.receivedWalletBalancesTotal??0)]})]}),B.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",B.deficitAmount??0]})]},B.id))}),e.jsx(lt,{className:"flex gap-2 justify-between",children:e.jsx(h,{variant:"secondary",onClick:()=>J(!1),children:"إغلاق"})})]})}),e.jsx(ge,{open:jt,onOpenChange:Ct,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(be,{children:"إيصال تسليم وردية"})}),ke?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(ke.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",ke.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",ke.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",ke.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",ke.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",ke.deliveredWalletBalancesTotal??0]})]})]}),ke.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",ke.deficitAmount??0]})]}),ke.receivedWalletBalances&&Object.keys(ke.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(ke.receivedWalletBalances).map(([B,Ie])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:B}),e.jsx("span",{className:"font-semibold",children:Ie})]},B))})]}),ke.deliveredWalletBalances&&Object.keys(ke.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(ke.deliveredWalletBalances).map(([B,Ie])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:B}),e.jsx("span",{className:"font-semibold",children:Ie})]},B))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(lt,{className:"flex gap-2 justify-between",children:e.jsx(h,{variant:"secondary",onClick:()=>Ct(!1),children:"إغلاق"})})]})}),e.jsx(ge,{open:Sa,onOpenChange:ls,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(be,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:oe?`${oe.name} (${oe.username})`:""}),e.jsx(U,{type:"password",autoComplete:"off",value:_,onChange:B=>le(B.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(lt,{className:"flex gap-2 justify-between",children:[e.jsx(h,{variant:"secondary",onClick:()=>{le(""),Ae(null),ls(!1)},children:"إلغاء"}),e.jsx(h,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{if(oe){if(_.trim()!==oe.password){f({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}C({name:oe.name,username:oe.username}),le(""),ls(!1),p(!1),s(),$t(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(ge,{open:st,onOpenChange:$t,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(be,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(U,{type:"text",inputMode:"decimal",value:De,onChange:B=>ht(kt(B.target.value)),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(U,{type:"text",inputMode:"decimal",value:Number.isFinite(q)?q:0,onChange:B=>{const Ie=parseFloat(kt(B.target.value));Dt(Number.isFinite(Ie)?Ie:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(lt,{className:"flex gap-2 justify-between",children:e.jsx(h,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{const B=parseFloat(De),Ie=q,at=Number.isFinite(B)&&B>=0,St=Number.isFinite(Ie)&&Ie>=0;if(!at||!St){f({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(B)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(Ie))}catch{}f({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),$t(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(ge,{open:ce,onOpenChange:B=>{B&&L(!0)},children:e.jsxs(fe,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ye,{children:e.jsx(be,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:$==="toUser"?"default":"secondary",onClick:()=>ve("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(h,{variant:$==="toAdmin"?"default":"secondary",onClick:()=>ve("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),$==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[Vt.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:Vt.map((B,Ie)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(_e==null?void 0:_e.username)===B.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>Ye(B),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:B.name}),e.jsx("div",{className:"text-xs text-gray-500",children:B.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},Ie))})]}),e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(U,{type:"password",autoComplete:"off",value:Je,onChange:B=>dt(B.target.value),placeholder:"أدخل كلمة السر"})]}),ee&&e.jsx("div",{className:"text-xs text-red-600",children:ee})]}),$==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(U,{type:"password",autoComplete:"off",value:Se,onChange:B=>he(B.target.value),placeholder:"كلمة المرور"}),de&&e.jsx("div",{className:"text-xs text-red-600",children:de})]})]}),e.jsx(lt,{className:"flex gap-2 justify-between",children:e.jsx(h,{disabled:rt||!$,onClick:async()=>{if($){ie(!0);try{const B=ss;if($s().then(Bt).catch(()=>{}),$==="toUser"){if(!_e){we("يرجى اختيار المستخدم أولاً"),ie(!1);return}if(Je.trim()!==_e.password){we("كلمة السر غير صحيحة"),ie(!1);return}j(),C({name:_e.name,username:_e.username}),s(),Nt(`${_e.name} (${_e.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}L(!1),ve(null),Ye(null),dt(""),we(""),p(!1),Bt(B),Pe(null),mt(""),vt(!0)}else if($==="toAdmin"){ne("");const Ie=(D==null?void 0:D.email)||"";if(!Ie){ne("لا يوجد بريد للمستخدم الرئيسي للتحقق"),ie(!1);return}const{error:at}=await M(Ie,Se);if(at){ne("كلمة المرور غير صحيحة"),ie(!1);return}j(),C(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}he(""),L(!1),p(!1),Nt("الأدمن الرئيسي"),Bt(B),Pe(null),mt(""),vt(!0)}}catch{we("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{ie(!1)}}},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"تأكيد التسليم"})})]})}),e.jsx(ge,{open:Ce,onOpenChange:vt,children:e.jsxs(fe,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ye,{children:e.jsx(be,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:Lt})]}),w&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(w).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(U,{type:"number",value:De,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(U,{type:"number",value:q,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(U,{type:"text",inputMode:"decimal",value:W,onChange:B=>{const Ie=parseFloat(kt(B.target.value));Ne(Number.isFinite(Ie)?Ie:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(U,{type:"text",inputMode:"decimal",value:Oe,onChange:B=>{const Ie=parseFloat(kt(B.target.value));gt(Number.isFinite(Ie)?Ie:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(W??0)+(Oe??0)-((parseFloat(De||"0")||0)+(q??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((W??0)+(Oe??0)-((parseFloat(De||"0")||0)+(q??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"}),e.jsx("div",{className:"mt-2 grid grid-cols-1 gap-2",children:e.jsxs("div",{className:"rounded border p-2 bg-gray-50",children:[e.jsx("div",{className:"text-xs text-gray-700",children:"مطلوب من الدرج (بدون أرباح)"}),e.jsx("div",{className:"text-sm font-semibold text-gray-900",children:Math.round(((W??0)-(parseFloat(De||"0")||0))*100)/100})]})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:as==="no"?"default":"secondary",onClick:()=>Pe("no"),children:"لا"}),e.jsx(h,{variant:as==="yes"?"default":"secondary",onClick:()=>Pe("yes"),children:"نعم"})]}),as==="yes"&&e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(U,{type:"number",value:et,onChange:B=>mt(B.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(lt,{className:"flex gap-2 justify-between",children:e.jsx(h,{onClick:()=>{const B=as==="yes",Ie=parseFloat(et)||0;(async()=>await Fa(ss,B,Ie))(),f({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),vt(!1)},className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:"تأكيد وحفظ الإيصال"})})]})})]})},Tu=({open:i,onOpenChange:p})=>{const{shiftUser:d,endShift:v,setShiftUser:w}=Zr(),[C,s]=n.useState(""),[j,R]=n.useState(""),[D,M]=n.useState([]),{user:E}=da();n.useEffect(()=>{(async()=>{try{if(E!=null&&E.uid){const N=Ve(V,"profiles",E.uid,"cashierUsers","list"),k=await va(N);if(k.exists()){const K=k.data(),F=Array.isArray(K==null?void 0:K.users)?K.users:[];if(F&&F.length>0){M(F);return}}}}catch{}try{const N=`cashierUsers_${(E==null?void 0:E.uid)||"default"}`;let k=localStorage.getItem(N);if(!k){const K=localStorage.getItem("cashierUsers");K&&(k=K)}M(k?JSON.parse(k):[])}catch{M([])}})()},[i,E==null?void 0:E.uid]),n.useEffect(()=>{if(!i||!(E!=null&&E.uid))return;const N=Ve(V,"profiles",E.uid,"cashierUsers","list"),k=Ls(N,K=>{if(K.exists()){const F=K.data(),Q=Array.isArray(F==null?void 0:F.users)?F.users:[];if(Q&&Q.length>0)M(Q);else try{const te=`cashierUsers_${(E==null?void 0:E.uid)||"default"}`;let ce=localStorage.getItem(te);if(!ce){const L=localStorage.getItem("cashierUsers");L&&(ce=L)}M(ce?JSON.parse(ce):[])}catch{M([])}}},K=>{console.warn("ShiftProfileDialog cashierUsers snapshot error:",K)});return()=>k()},[i,E==null?void 0:E.uid]);const f=async()=>{if(R(""),!d)return;const N=D.find(k=>k.username===d.username);if(!N){R("لا يوجد مستخدم مطابق لهذه الوردية");return}if(C.trim()!==N.password){R("الرقم السري غير صحيح");return}v(),w(null),s(""),p(!1)};return e.jsx(ge,{open:i,onOpenChange:N=>{s(""),R(""),p(N)},children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(be,{children:"بروفيل الوردية"})}),d?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:d.name}),e.jsx("div",{className:"text-xs text-gray-600",children:d.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx(U,{type:"password",value:C,onChange:N=>s(N.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),j&&e.jsx("div",{className:"text-red-600 text-xs",children:j})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(lt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>p(!1),children:"إغلاق"}),e.jsx(h,{onClick:f,disabled:!d,children:"تسليم الوردية"})]})]})})},Pu=({open:i,onOpenChange:p})=>e.jsx(ge,{open:i,onOpenChange:p,children:e.jsxs(fe,{className:"sm:max-w-lg rounded-2xl",children:[e.jsxs(ye,{children:[e.jsxs(be,{className:"text-right flex items-center gap-2 justify-end",children:[e.jsx(ll,{className:"w-5 h-5"}),"سجل التغييرات الأخيرة"]}),e.jsx(ps,{className:"text-right",children:"هذه أبرز التحسينات التي تمت مؤخرًا في الواجهة."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(yc,{className:"w-5 h-5 text-amber-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحسين نافذة تعديل المديونية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"استبدال نافذة الإدخال القديمة (prompt) بحوار أنيق لإدخال المبلغ مع تأكيد."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(fh,{className:"w-5 h-5 text-violet-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحديث شاشة التحميل"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:'تغيير النص إلى "صلي علي النبي" مع خط عربي جميل ونبض لطيف.'})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ll,{className:"w-5 h-5 text-green-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"بطاقات الأرباح وعدد العمليات"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"إضافة بطاقات عرض أرباح الفترة الحالية وعدد العمليات في تفاصيل المحفظة."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ll,{className:"w-5 h-5 text-blue-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"إصلاح تمرير نافذة اليومية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"منع تمرير الصفحة الخلفية عند فتح نافذة اليومية لراحة الاستخدام."})]})]})]}),e.jsx("div",{className:"flex justify-end gap-2 mt-6",children:e.jsx(h,{variant:"secondary",onClick:()=>p(!1),children:"إغلاق"})})]})});class mr{static async processTransfer(p){const{amount:d,currentCashBalance:v,currentWalletBalances:w,wallets:C,selectedWalletId:s}=p;if(d<=0)return{success:!1,newCashBalance:v,newWalletBalances:w,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!p.skipRemoteLimitsCheck)try{const M=await Ks.canPerformOperation(s,d,"transfer");if(!M.canPerform)return{success:!1,newCashBalance:v,newWalletBalances:w,message:M.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(M){return console.error("خطأ في التحقق من حدود التحويل:",M),{success:!1,newCashBalance:v,newWalletBalances:w,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(d<=0)return{success:!1,newCashBalance:v,newWalletBalances:w,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s){const M=Math.max(w[s]||0,0);if(M<d){const E=C.find(f=>f.id===s);return{success:!1,newCashBalance:v,newWalletBalances:w,message:`رصيد غير كافي في المحفظة${E?` ${E.name}`:""}. المتاح: ${M} جنيه، المطلوب: ${d} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const M=mr.calculateTotalWalletBalance(w);if(M<d)return{success:!1,newCashBalance:v,newWalletBalances:w,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${M} جنيه، المبلغ المطلوب: ${d} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const j={...w};if(s){const M=j[s]||0;j[s]=M-d}else{let M=d;for(const E of C){if(M<=0)break;const f=Math.max(j[E.id]||0,0),N=Math.min(f,M);N>0&&(j[E.id]=(j[E.id]||0)-N,M-=N)}}const R=v+d;let D="تم التحويل بنجاح";if(s){const M=j[s]||0;M<0&&(D=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${s} أصبح ${M} جنيه.`)}return{success:!0,newCashBalance:R,newWalletBalances:j,message:D}}static processDeposit(p){const{amount:d,currentCashBalance:v,currentWalletBalances:w,wallets:C}=p;if(d<=0)return{success:!1,newCashBalance:v,newWalletBalances:w,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const s=this.calculateTotalWalletBalance(w);if(s<d)return{success:!1,newCashBalance:v,newWalletBalances:w,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${s} جنيه، المبلغ المطلوب: ${d} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const j=v+d,R={...w};let D=d;const M=C.find(f=>f.isDefault);if(M&&R[M.id]>=D)R[M.id]-=D,D=0;else for(const f of C){if(D<=0)break;const N=R[f.id]||0;if(N>0){const k=Math.min(N,D);R[f.id]=N-k,D-=k}}const E=D>0?`تم الإيداع جزئياً. تم إيداع ${d-D} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${d} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:j,newWalletBalances:R,message:E}}static async processWithdraw(p){const{amount:d,currentCashBalance:v,currentWalletBalances:w,wallets:C,selectedWalletId:s}=p;if(d<=0)return{success:!1,newCashBalance:v,newWalletBalances:w,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!p.skipRemoteLimitsCheck)try{const M=await Ks.canPerformOperation(s,d,"withdraw");if(!M.canPerform)return{success:!1,newCashBalance:v,newWalletBalances:w,message:M.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(M){return console.error("خطأ في التحقق من حدود السحب:",M),{success:!1,newCashBalance:v,newWalletBalances:w,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(v<d)return{success:!1,newCashBalance:v,newWalletBalances:w,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${v} جنيه، المبلغ المطلوب: ${d} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const j=v-d,R={...w},D=s?C.find(M=>M.id===s):C.find(M=>M.isDefault)||C[0];if(D){const M=R[D.id]||0;R[D.id]=M+d}else return{success:!1,newCashBalance:v,newWalletBalances:w,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};return{success:!0,newCashBalance:j,newWalletBalances:R,message:`تم السحب بنجاح. تم إضافة ${d} جنيه إلى محفظة ${(D==null?void 0:D.name)||""}`}}static validateOperation(p,d){return p<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!d||d.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(p){return Object.values(p).reduce((d,v)=>d+Math.max(v,0),0)}static deductFromWalletsAddToCash(p,d,v,w){return this.processTransfer({amount:p,currentCashBalance:d,currentWalletBalances:v,wallets:w})}static deductFromWalletsAddToCashDeposit(p,d,v,w){return this.processDeposit({amount:p,currentCashBalance:d,currentWalletBalances:v,wallets:w})}static deductFromCashAddToWallets(p,d,v,w){return this.processWithdraw({amount:p,currentCashBalance:d,currentWalletBalances:v,wallets:w})}static applyTransactionResult(p,d,v){p.success&&(d(p.newCashBalance),v(p.newWalletBalances))}static validateTransaction(p,d,v,w){if(p<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(d==="transfer"){const C=this.calculateTotalWalletBalance(w);if(C<p)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${C} جنيه) غير كافي للمبلغ المطلوب (${p} جنيه)`}}else if(d==="withdraw"){if(v<p)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${v} جنيه) غير كافي للمبلغ المطلوب (${p} جنيه)`}}else if(d==="deposit"){const C=this.calculateTotalWalletBalance(w);if(C<p)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${C} جنيه) غير كافي للمبلغ المطلوب (${p} جنيه)`}}return{isValid:!0}}static getDeductionPreview(p,d,v){const w=[];let C=p;for(const s of v){if(C<=0)break;const j=d[s.id]||0,R=Math.min(Math.max(j,0),C);R>0&&(w.push({walletId:s.id,walletName:s.name,currentBalance:j,deductedAmount:R,newBalance:j-R}),C-=R)}return w}}let qr=null;function ku(){const i=window;if(!qr){const p=i.AudioContext||i.webkitAudioContext;qr=new p}return qr.state==="suspended"&&qr.resume(),qr}function _u(i,p,d){const v=d/1e3,w=Math.floor(i.sampleRate*v),C=i.createBuffer(1,w,i.sampleRate),s=C.getChannelData(0);for(let M=0;M<w;M++)s[M]=(Math.random()*2-1)*.6;const j=i.createBufferSource();j.buffer=C;const R=i.createBiquadFilter();R.type="highpass",R.frequency.value=1500,R.Q.value=.7;const D=i.createGain();D.gain.setValueAtTime(1e-4,p),D.gain.exponentialRampToValueAtTime(.4,p+.015),D.gain.exponentialRampToValueAtTime(1e-4,p+v),j.connect(R),R.connect(D),D.connect(i.destination),j.start(p),j.stop(p+v+.01)}function Ou(i,p,d,v,w,C="triangle"){const s=i.createOscillator(),j=i.createGain();s.type=C;const R=w/1e3;s.frequency.setValueAtTime(d,p),s.frequency.linearRampToValueAtTime(v,p+R),j.gain.setValueAtTime(1e-4,p),j.gain.exponentialRampToValueAtTime(.25,p+.02),j.gain.exponentialRampToValueAtTime(1e-4,p+R),s.connect(j),j.connect(i.destination),s.start(p),s.stop(p+R+.02)}function Eu(){try{const i=ku(),p=i.currentTime;_u(i,p,90),Ou(i,p+.12,1900,1100,180,"sawtooth")}catch{}}function Mu(i){if(!i)return!1;const d=i.replace(/[^0-9٠-٩]/g,"").replace(/[٠-٩]/g,v=>"0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(v)]);return/^(010|011|012|015)[0-9]{8}$/.test(d)}function Lu({userId:i}){const[p,d]=Ke.useState(null),[v,w]=Ke.useState("");return null}const $x=()=>{var Bo,Uo,zo,qo,Vo,Jo;console.log("🔥 UserDashboardPage component is loading...");const{toast:i}=Gs(),p=n.useRef(null),[d,v]=n.useState(0),w=async()=>{var r,l,o;const t="alkaptin678678@gmail.com",a=(l=(r=dr.currentUser)==null?void 0:r.email)==null?void 0:l.toLowerCase();if(!a||a!==t){i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}if(!Dn||!Cn||!In){i({title:"بيانات ناقصة",description:"أدخل رقم الموبايل، الشركة والمبلغ",variant:"destructive"});return}try{bo(!0);const m=await((o=dr.currentUser)==null?void 0:o.getIdToken()),x=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...m?{Authorization:`Bearer ${m}`}:{}},body:JSON.stringify({phone:Dn,countryCode:"EG",operator:Cn,amount:Number(In),useLocalAmount:!0})}),y=await x.json().catch(()=>({}));x.ok&&(y!=null&&y.success)?(i({title:"تم الشحن",description:(y==null?void 0:y.message)||"تم تنفيذ عملية الشحن بنجاح"}),Bi(!1),po(""),go(""),fo("")):i({title:"فشل الشحن",description:(y==null?void 0:y.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(m){console.error("Topup request error:",m),i({title:"خطأ غير متوقع",description:"تعذّر تنفيذ عملية الشحن. حاول لاحقاً.",variant:"destructive"})}finally{bo(!1)}},{signOut:C,user:s,profile:j}=da(),R=((s==null?void 0:s.email)||"").toLowerCase()==="vodafonecash00@gmail.com",D=uc(),M=dc(),E=oh(),{isShiftActive:f,shiftUser:N}=Zr(),{shopId:k,shopName:K}=si(),F=ch();(()=>{try{return!!window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:"}catch{return!1}})();const[Q,te]=n.useState(!1),[ce,L]=n.useState(!1),[$,ve]=n.useState(!1),[Se,he]=n.useState(!1),[de,ne]=n.useState([]),[$e,qe]=n.useState(""),[_e,Ye]=n.useState(""),[Je,dt]=n.useState(""),[ee,we]=n.useState(""),[rt,ie]=n.useState(!1),[Ce,vt]=n.useState(!1),[ss,Bt]=n.useState(null),[as,Pe]=n.useState(""),[et,mt]=n.useState(""),[De,ht]=n.useState(!1);n.useEffect(()=>{const t=E==null?void 0:E.shopId;if(t&&(s!=null&&s.uid))try{const a=`selectedShopId_${s.uid}`;localStorage.setItem(a,String(t)),window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}},[E==null?void 0:E.shopId,s==null?void 0:s.uid]);const[q,Dt]=n.useState([]),[Pt,wt]=n.useState(()=>{try{return localStorage.getItem("cashySelectedDevice")||null}catch{return null}}),W=t=>!!(t&&q.some(a=>a.id===t));async function Ne(){const t=window.electronAPI,a=Pt||"";if(!t||typeof t.sendUssd!="function")return null;if(!a)return i({title:"الجهاز غير محدد",description:"اتصل بالموبايل أولاً ثم اختر الجهاز من القائمة",variant:"destructive"}),null;if(W(a))return a;try{const m=q.find(x=>x&&x.id&&!String(x.id).includes(":"));if(m&&m.id)return wt(m.id),m.id}catch{}const r=a.includes(":")?a.split(":").slice(0,2).join(":"):"";if(r&&typeof t.connectWifi=="function"){try{await t.connectWifi(r)}catch{}if(await new Promise(m=>setTimeout(m,250)),W(a))return a}const l=a.split(":")[0],o=q.find(m=>(m.id.startsWith(l)||m.id.includes(l))&&m.id.includes(":"));if(o!=null&&o.id){const m=o.id.split(":").slice(0,2).join(":");if(!W(o.id)&&typeof t.connectWifi=="function"){try{await t.connectWifi(m)}catch{}await new Promise(x=>setTimeout(x,250))}if(W(o.id))return wt(o.id),o.id}return i({title:"الجهاز غير متصل",description:"فعّل Wireless debugging أو استخدم اتصال Wi‑Fi ثم أعد المحاولة",variant:"destructive"}),null}n.useEffect(()=>{const t=window.electronAPI;t&&typeof t.onAdbDevices=="function"&&t.onAdbDevices(a=>{var o;const r=Array.isArray(a)?a:[];Dt(r);const l=(()=>{try{return localStorage.getItem("cashySelectedDevice")||""}catch{return""}})();l&&r.some(m=>m.id===l)?wt(l):(o=r[0])!=null&&o.id?wt(m=>m||r[0].id):wt(null)})},[]);function Oe(t,a){try{const r=os==null?void 0:os(),l=(r==null?void 0:r.phone)||"";if(!l){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"});return}ph(l,t,a),i({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),Va(!1),rr(!1)}catch(r){const l=(r==null?void 0:r.message)||"تعذر إرسال الكود — تحقق من البيانات";throw i({title:"فشل الإرسال",description:l,variant:"destructive"}),r}}const gt=async()=>{var r;if(!ks||!ks.receiver||!ks.amount){i({title:"بيانات غير مكتملة",description:"تأكد من إدخال رقم المستقبل والمبلغ قبل الإرسال",variant:"destructive"});return}const t=String(ks.receiver),a=Math.round(Number(ks.amount));Ja(!0);try{if((r=Zo)!=null&&r.isNativePlatform&&Zo.getPlatform()==="android"){const o=os==null?void 0:os(),m=(o==null?void 0:o.phone)||"";if(!m){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),Ja(!1);return}const x=Xo(m,t,a);if(!x){i({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),Ja(!1);return}xh(x),i({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),Va(!1),rr(!1);return}const l=window.electronAPI;if(l&&typeof l.sendUssd=="function"&&Pt){const o=os==null?void 0:os(),m=(o==null?void 0:o.phone)||"";if(!m){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),Ja(!1);return}const x=await Ne();if(!x){Ja(!1);return}const y=Xo(m,t,a);if(!y){i({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),Ja(!1);return}try{const S=typeof l.pickSimAutomatically=="function"?await l.pickSimAutomatically(x,m):{deviceId:x,slot:0},u=`${S.deviceId}:sim${S.slot}`;bd(u),await l.sendUssd(u,y)}catch{try{await l.sendUssd(x,y)}catch(u){const g=x.includes(":")?x.split(":").slice(0,2).join(":"):"";if(g&&typeof l.connectWifi=="function")await l.connectWifi(g),await l.sendUssd(x,y);else throw u}}i({title:"تم إرسال كود التحويل",description:"تم التنفيذ بنجاح"}),Va(!1),rr(!0)}else Oe(t,a)}catch(l){const o=l&&l.message?l.message:"حدث خطأ غير متوقع أثناء الإرسال";i({title:"خطأ أثناء الإرسال",description:`الجهاز: ${Ll||Pt||"غير معروف"} — ${o}`,variant:"destructive"})}finally{Ja(!1)}},ot=async(t,a)=>{const r=window.electronAPI;try{if(r&&typeof r.enterPin=="function"&&t){await r.enterPin(t,a),rr(!1);return}const l=String((j==null?void 0:j.bridgeLink)||"").trim(),o=String((j==null?void 0:j.bridgeDeviceId)||"").trim()||void 0;if(!l){i({title:"الرابط غير مُعدّ",description:"احفظ رابط الجسر أولاً",variant:"destructive"});return}const m=String((ks==null?void 0:ks.receiver)||js||"").replace(/\D/g,""),x=Math.max(1,Math.round(Number((ks==null?void 0:ks.amount)||ns||0))||0),y=String(a||"").replace(/\D/g,""),u=(g=>{let I=(g||"").trim();return I=I.replace(/\/+$/,""),/^https?:\/\//i.test(I)||(I=`https://${I}`),I})(l);rr(!1)}catch(l){const o=(l==null?void 0:l.message)||"حدث خطأ أثناء إدخال الرقم السري";i({title:"فشل الإدخال",description:o,variant:"destructive"})}};console.log("🔥 UserDashboardPage - user:",s?"exists":"null");const[Mt,Lt]=n.useState(!0),[Nt,st]=n.useState(!0),[$t,kt]=n.useState(!1),[Qs,Vt]=n.useState(!1),[is,aa]=n.useState(""),[Us,Sa]=n.useState(""),[ls,_]=n.useState(""),[le,oe]=n.useState([]),[Ae,Ee]=n.useState(!1),[Re,nt]=n.useState(null),[J,ke]=n.useState(""),[H,jt]=n.useState(!1),[Ct,Ut]=n.useState(!1),[rs,Ht]=n.useState(!1),[ra,ma]=n.useState(!1),[$s,Fa]=n.useState(""),[Ra,B]=n.useState(""),[Ie,at]=n.useState([]),[St,us]=n.useState(!1),[Jt,Zt]=n.useState(0),[Ba,Ua]=n.useState(!1),[Xt,ur]=n.useState(null),[ct,It]=n.useState(!1),[Gt,tr]=n.useState(""),[js,za]=n.useState(""),[ns,ha]=n.useState(""),[ua,c]=n.useState(""),[A,O]=n.useState(!1),[G,z]=n.useState(""),[Te,Me]=n.useState(""),[ze,We]=n.useState(""),[Xe,Le]=n.useState(""),[ft,Ps]=n.useState(null),[Zs,zs]=n.useState(!1),[qa,Da]=n.useState(!1),[Ss,Xs]=n.useState(!1),[Xr,en]=n.useState(!1),[xr,pr]=n.useState(null),[es,ai]=n.useState(""),[xs,ri]=n.useState(""),[yl,Qc]=n.useState(""),[Zc,tn]=n.useState(!1),[$u,Wu]=n.useState(null),[qs,bl]=n.useState(null),sn=t=>{const a="٠١٢٣٤٥٦٧٨٩",r="۰۱۲۳۴۵۶۷۸۹";return(t||"").split("").map(l=>{const o=a.indexOf(l);if(o>-1)return String(o);const m=r.indexOf(l);return m>-1?String(m):l}).join("")},[yt,ni]=n.useState(()=>{try{const t=localStorage.getItem("commissionMode")||localStorage.getItem("commissionMode_default");return t?t==="add":!0}catch{return!0}}),[re,vl]=n.useState("transfer"),[Ze,xa]=n.useState([]),[pa,ii]=n.useState("all");n.useEffect(()=>{try{if(localStorage.setItem("commissionMode",yt?"add":"deduct"),s!=null&&s.uid){const t=`commissionMode_${s.uid}`;localStorage.setItem(t,yt?"add":"deduct")}}catch{}},[yt,s==null?void 0:s.uid]),n.useEffect(()=>{try{const t=s!=null&&s.uid?localStorage.getItem(`commissionMode_${s.uid}`):null,a=localStorage.getItem("commissionMode"),r=localStorage.getItem("commissionMode_default"),l=t??a??r;l&&ni(l==="add")}catch{}},[s==null?void 0:s.uid]);const[li,gr]=n.useState(!1),[Xc,ed]=n.useState(null),an=Ke.useRef(""),wl=Ke.useRef(0);n.useEffect(()=>{const t=a=>{var l;if(li)return;try{const o=document.activeElement;if(o){const m=(l=o.tagName)==null?void 0:l.toLowerCase();if(m==="input"||m==="textarea"||m==="select"||m==="button"||o.isContentEditable===!0)return}}catch{}const r=Date.now();if(a.key==="Enter"){const o=(an.current||"").trim();an.current="",o&&(ed(o),gr(!0));return}a.key.length===1&&(r-(wl.current||0)>100&&(an.current=""),an.current+=a.key,wl.current=r)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[li]);const[td,sd]=n.useState(!1),[ad,Fu]=n.useState(null),[X,oi]=n.useState("");n.useEffect(()=>{if(!A)return;const t=os(),a=parseFloat(ns||"0")||0;let r=0;if(re==="transfer"){if((t==null?void 0:t.defaultTransferCommission)!=null){const o=Number(t.defaultTransferCommission)||0;r=Math.round(o*a/1e3*100)/100}else{const o=xs&&xs.trim()!==""?parseFloat(xs):0;r=Math.max(0,o)}const l=a+r;Me((l||0).toString())}else{if((t==null?void 0:t.defaultWithdrawCommission)!=null){const o=Number(t.defaultWithdrawCommission)||0;r=Math.round(o*a/1e3*100)/100}else{const o=es&&es.trim()!==""?parseFloat(es):Math.round(a*.01*100)/100;r=Math.max(0,o)}const l=yt?a:Math.max(0,Math.round((a-r)*100)/100);Me((l||0).toString())}},[A,ns,xs,es,X,yt,re]);const os=()=>{var a,r;let t=He.find(l=>l.id===X);if(!t)try{const l=localStorage.getItem(Hi());if(l){const o=JSON.parse(l);if(Array.isArray(o)&&o.length>0){const x=localStorage.getItem(Cr())||((a=o.find(y=>y.isDefault))==null?void 0:a.id)||((r=o[0])==null?void 0:r.id);t=o.find(y=>y.id===x)}}}catch{}return t};n.useLayoutEffect(()=>{try{const t=`wallets_${(s==null?void 0:s.uid)||"default"}`;let a=localStorage.getItem(t);if(!a){const r=Object.keys(localStorage).find(l=>l.startsWith("wallets_"));r&&(a=localStorage.getItem(r)||null)}if(a){const r=JSON.parse(a);if(Array.isArray(r)&&r.length>0){fr(r);const l=localStorage.getItem(Cr()),o=l&&r.find(m=>m.id===l)||r.find(m=>m.isDefault)||r[0];o&&(oi(o.id),tr(o.phone))}}}catch(t){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",t)}},[]),n.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",X)},[X]),n.useEffect(()=>{jo()},[s==null?void 0:s.uid]),n.useEffect(()=>{xm()},[]);const[He,fr]=n.useState(()=>{try{const t=Object.keys(localStorage).find(r=>r.startsWith("wallets_")),a=t?localStorage.getItem(t):null;if(a){const r=JSON.parse(a);if(Array.isArray(r))return r}}catch{}return[]}),[Nl,rd]=n.useState(""),jl=(()=>{const t=Nl.replace(/\D/g,"");return t?He.filter(a=>(a.phone||"").replace(/\D/g,"").includes(t)):He})(),[nd,Ru]=n.useState(null),[id,Sl]=n.useState(!1),[ld,rn]=n.useState(!1),[od,cd]=n.useState(null),[Bu,dd]=n.useState([]),[Uu,zu]=n.useState([]),[md,yr]=n.useState(!1),[ci,Dl]=n.useState("daily"),[nn,sr]=n.useState([]),[Cl,hd]=n.useState(!1),Ca=Ke.useRef(new Set),Il=Ke.useRef(new Set),Al=Ke.useRef([]);n.useEffect(()=>{Al.current=Ze},[Ze]);const Tl=async t=>{try{if(!s)return;const a=Cs(),r=Ds(),l=localStorage.getItem(a),o=localStorage.getItem(r);let m=l?parseFloat(l):Tt,x=o?JSON.parse(o):{...it};const y=Number(t.withdrawnAmount??t.sentAmount??t.transferredAmount??t.amount??0);if(t.type==="send"&&(t.fromWallet||X)){m-=y;const g=t.fromWallet||X;x[g]=(x[g]||0)+y}else if(t.type==="withdraw"&&(t.fromWallet||X)){m+=y;const g=t.fromWallet||X;x[g]=Math.max(0,(x[g]||0)-y)}Kt(m),ds(x),localStorage.setItem(a,m.toString()),localStorage.setItem(r,JSON.stringify(x));const S={cashBalance:m,walletBalances:x,lastUpdated:new Date().toISOString()},u=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(u,JSON.stringify(S));try{await pe.updateUserData(s.uid,S),localStorage.removeItem(u),Ge(!1)}catch(g){console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف (مزامنة تلقائية):",g),Ge(!0)}try{const g=t.fromWallet||X,I=await Ks.getWalletLimits(s.uid,g);if(I){const T={...I};t.type==="send"?(T.dailyTransferUsed=Math.max(0,(I.dailyTransferUsed||0)-y),T.monthlyTransferUsed=Math.max(0,(I.monthlyTransferUsed||0)-y)):(T.dailyWithdrawUsed=Math.max(0,(I.dailyWithdrawUsed||0)-y),T.monthlyWithdrawUsed=Math.max(0,(I.monthlyWithdrawUsed||0)-y)),await Ks.updateWalletLimits(s.uid,g,T)}}catch(g){console.warn("تعذر تحديث حدود المحفظة بعد الحذف (مزامنة):",g)}try{bs.removeTransactionEffects(t,s.uid)}catch(g){console.warn("تعذر تحديث التقارير بعد الحذف (مزامنة):",g)}}catch(a){console.warn("خطأ أثناء تطبيق تأثيرات الحذف محليًا:",a)}},ud=async t=>{try{const a=Ze.find(x=>x.id===t);if(!a||!s)return;const r=String(t),l=String((a==null?void 0:a.transactionId)||(a==null?void 0:a.reference)||""),o=Ca.current.has(r)||l&&Ca.current.has(l),m=Ze.filter(x=>x.id!==t);xa(m);try{await pe.removeUserTransaction(s.uid,t),await zr.permanentlyDeleteTransaction(t,s.uid)}catch(x){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",x)}if(!o){Ca.current.add(r),l&&Ca.current.add(l),await Tl(a);try{s!=null&&s.uid&&pe.removeLocalReceiptById(s.uid,t)}catch{}}i({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),rn(!1)}catch(a){console.error("خطأ أثناء حذف الإيصال:",a),i({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},xd=async t=>{var a;try{const r=Ze.find(l=>l.id===t);if(!r||!s)return;try{const l=(a=Xt==null?void 0:Xt.subscription)==null?void 0:a.planType;if(l===Is.ZERO){const{dailyOperationCountService:o}=await bt(async()=>{const{dailyOperationCountService:y}=await import("./dailyOperationCountService-Di0GbWDY.js");return{dailyOperationCountService:y}},__vite__mapDeps([2,0,1]),import.meta.url),m=r.type==="send"?"transfer":"withdraw";if(!(await o.checkAndIncrement(s.uid,m,5)).allowed){i({title:"تم بلوغ حد باقة الزيرو",description:"مسموح بحد أقصى 5 تأكيدات يوميًا للتحويل/السحب. جرّب غدًا أو قم بالترقية.",variant:"destructive"});return}}else if(l===Is.TAHWEELA){const{dailyOperationCountService:o}=await bt(async()=>{const{dailyOperationCountService:y}=await import("./dailyOperationCountService-Di0GbWDY.js");return{dailyOperationCountService:y}},__vite__mapDeps([2,0,1]),import.meta.url),m=r.type==="send"?"transfer":"withdraw";if(!(await o.checkAndIncrementCombined(s.uid,m,40)).allowed){i({title:"تم بلوغ حد باقة تحويله",description:"هذه الباقة تسمح بحد أقصى 40 عملية تحويل/سحب يومياً.",variant:"destructive"});return}}}catch(l){console.warn("تعذر التحقق من حد التأكيد اليومي:",l)}await ts(Ve(V,"userTransactions",t),{status:"completed",confirmedAt:new Date}),xa(l=>l.map(o=>o.id===t?{...o,status:"completed"}:o)),i({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),rn(!1)}catch(r){console.error("خطأ أثناء إكمال الإيصال:",r),i({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}};n.useEffect(()=>{if(s)try{const t=Ue(je(V,"deletedTransactions"),ae("userId","==",s.uid)),a=Ls(t,r=>{r.docChanges().forEach(l=>{if(l.type!=="added")return;const o=l.doc.data(),m=String((o==null?void 0:o.originalTransactionId)||""),x=String((o==null?void 0:o.transactionId)||""),y=String((o==null?void 0:o.reference)||""),S=m||x||y||String(l.doc.id);S&&(Ca.current.has(S)||(Ca.current.add(S),xa(u=>{const g=u.find(T=>T.id===m);return g?((async()=>await Tl(g))(),u.filter(T=>T.id!==m)):u})))})},r=>{console.warn("فشل الاشتراك في deletedTransactions:",r)});return()=>a()}catch(t){console.warn("تعذر إنشاء مستمع deletedTransactions:",t)}},[s==null?void 0:s.uid]),n.useEffect(()=>{if(s)try{const t=Ve(V,"users",s.uid),a=Ls(t,async r=>{if(!r.exists())return;const l=r.data();if(l!=null&&l.reportsData)try{await bs.syncReportsDataFromFirebase(s.uid),dd(Mr())}catch(o){console.warn("تعذر مزامنة reportsData من السحابة:",o)}},r=>{console.warn("فشل الاشتراك في users.reportsData:",r)});return()=>a()}catch(t){console.warn("تعذر إنشاء مستمع users.reportsData:",t)}},[s==null?void 0:s.uid]);const[Pl,pd]=n.useState(""),kl=Nu(Pl,300),[ln,_l]=n.useState(""),[on,Ol]=n.useState(""),[ga,qu]=n.useState(""),[di,ar]=n.useState(!1),[El,br]=n.useState(!1),[gd,Va]=n.useState(!1),[cs,mi]=n.useState(null),[ks,fd]=n.useState(null),[Ml,Ja]=n.useState(!1),[yd,rr]=n.useState(!1),[Ll,bd]=n.useState(""),[vd,hi]=n.useState(!1),$l=!1,[wd,cn]=n.useState(!1),[Nd,Wl]=n.useState(!1),[jd,dn]=n.useState(!1),[Sd,mn]=n.useState(!1),[Dd,hn]=n.useState(!1),[Cd,Fl]=n.useState(!0),[vr,Id]=n.useState(!1),[Ad,un]=n.useState(!1),[Td,Rl]=n.useState(!1),[xn,Pd]=n.useState(""),[Bl,kd]=n.useState(!1),[_d,ui]=n.useState(!1),[Od,Ul]=n.useState(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[Ed,xi]=n.useState(!1);n.useEffect(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled",a=localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled");Ul(a==="true")}catch{}},[s==null?void 0:s.uid]);const[Md,nr]=n.useState(!1),[Ld,pi]=n.useState(!1),[$d,zl]=n.useState(()=>{try{const t=s==null?void 0:s.uid,a=t?`debtsPinRequired_${t}`:"debtsPinRequired";return(localStorage.getItem(a)??localStorage.getItem("debtsPinRequired"))==="true"}catch{return!1}}),[Wd,ql]=n.useState(!1),[Vl,Fd]=n.useState(null),[Wt,_s]=n.useState([]),[gi,Jl]=n.useState(""),[fi,Kl]=n.useState(""),[yi,Yl]=n.useState(""),[me,wr]=n.useState(null),[Rd,Ia]=n.useState(!1),[Bd,Nr]=n.useState(!1),[Ka,Hl]=n.useState(null),[Gl,bi]=n.useState(""),[pn,Ql]=n.useState(null),[Vu,Ju]=n.useState(!1),[Ud,vi]=n.useState(!1),[Zl,wi]=n.useState(""),[Ni,jr]=n.useState(!1),[Xl,ji]=n.useState(1),zd=F?10:20,Si=Ke.useMemo(()=>Wt.slice(0,Xl*zd),[Wt,Xl]);n.useEffect(()=>{Ni&&ji(1)},[Ni]);const Di=async()=>{if(At){i({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}try{const t=await ws.hasMasterPin(s==null?void 0:s.uid);$d&&t?pi(!0):nr(!0)}catch{nr(!0)}};n.useEffect(()=>{try{const t=s==null?void 0:s.uid,a=t?`debtsPinRequired_${t}`:"debtsPinRequired",r=localStorage.getItem(a)??localStorage.getItem("debtsPinRequired");(r==="true"||r==="false")&&zl(r==="true")}catch{}},[s==null?void 0:s.uid]);const[qd,Ci]=n.useState(!1),[Ws,Ii]=n.useState([]),[Ai,eo]=n.useState(""),[Ti,to]=n.useState(""),[gn,so]=n.useState(""),[ao,Vd]=n.useState(""),[Jd,fn]=n.useState(!1),[Kd,ro]=n.useState(""),[no,Pi]=n.useState(""),[io,ki]=n.useState(""),[Yd,yn]=n.useState(!1),[Hd,_i]=n.useState(""),[lo,Oi]=n.useState(""),[Gd,ir]=n.useState(!1),[lr,bn]=n.useState(null),[Os,Sr]=n.useState(null),[vn,Ei]=n.useState(""),[Qd,or]=n.useState(!1),[oo,wn]=n.useState(0),[Fs,Aa]=n.useState(null),[Ya,Mi]=n.useState(""),[tt,Li]=n.useState(null),[co,mo]=n.useState(""),Vs=async t=>{try{const a=JSON.stringify(t);localStorage.setItem(An(),a);try{localStorage.setItem(No(),a)}catch{}try{localStorage.setItem(qi(),Date.now().toString())}catch{}s!=null&&s.uid&&pe.updateUserData(s.uid,{debts:t}).then(()=>{try{localStorage.removeItem(`debts_unsynced_${s.uid}`)}catch{}}).catch(()=>{Ge(!0);try{localStorage.setItem(`debts_unsynced_${s.uid}`,"true")}catch{}})}catch(a){console.error("خطأ في حفظ الديون:",a)}},Zd=async()=>{try{const t=An(),a=No(),r=qi(),l=localStorage.getItem(t),o=localStorage.getItem(a),m=localStorage.getItem(r),x=m?Number(m):0,y=u=>{if(!u)return null;try{const g=JSON.parse(u);return Array.isArray(g)?g.map(I=>{var T;return{...I,createdAt:(T=I.createdAt)!=null&&T.toDate?I.createdAt.toDate():new Date(I.createdAt),partialPayments:Array.isArray(I.partialPayments)?I.partialPayments.map(P=>{var Y;return{amount:Number(P.amount)||0,paidAt:(Y=P.paidAt)!=null&&Y.toDate?P.paidAt.toDate():new Date(P.paidAt)}}):[]}}):[]}catch(g){return console.warn("فشل في تحليل ديون localStorage:",g),null}};let S=y(l);if(!S||S.length===0){const u=y(o);if(u&&u.length>0&&(S=u,_s(u),s!=null&&s.uid))try{await Vs(u),localStorage.removeItem(a)}catch(g){console.warn("تعذر ترحيل الديون من المفتاح الافتراضي:",g)}}if(S&&S.length>0&&_s(S),s!=null&&s.uid)try{const u=`debts_unsynced_${s.uid}`,g=localStorage.getItem(u)==="true",I=await va(Ve(V,"users",s.uid));if(I.exists()){const T=I.data(),P=T.debts&&Array.isArray(T.debts)?T.debts.map(se=>{var xe;return{...se,createdAt:(xe=se.createdAt)!=null&&xe.toDate?se.createdAt.toDate():new Date(se.createdAt),partialPayments:Array.isArray(se.partialPayments)?se.partialPayments.map(Ms=>{var ea;return{amount:Number(Ms.amount)||0,paidAt:(ea=Ms.paidAt)!=null&&ea.toDate?Ms.paidAt.toDate():new Date(Ms.paidAt)}}):[]}}):[],Y=x&&Date.now()-x<12e4,ue=g||Y?S||[]:P&&P.length>0?P:S||[];_s(ue);try{localStorage.setItem(t,JSON.stringify(ue))}catch{}((P==null?void 0:P.length)||0)===0&&((ue==null?void 0:ue.length)||0)>0&&await pe.updateUserData(s.uid,{debts:ue})}else S&&S.length>0&&await pe.saveUserData(s.uid,{debts:S})}catch(u){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",u)}}catch(t){console.error("خطأ في تحميل الديون:",t)}};n.useEffect(()=>{try{window.exportDebts=()=>{try{return JSON.stringify(Wt||[])}catch{return"[]"}},window.importDebts=async t=>{try{const a=JSON.parse(t);if(!Array.isArray(a))throw new Error("صيغة غير صحيحة — يجب أن تكون مصفوفة");return await Vs(a),{ok:!0,count:a.length}}catch(a){return console.error("فشل استيراد الديون:",a),{ok:!1,error:String(a)}}},window.fixWalletsForCurrentUser=async t=>{try{if(!(s!=null&&s.uid))throw new Error("يجب تسجيل الدخول أولاً");return await(await bt(async()=>{const{merchantWalletService:r}=await import("./index-gOTNP7ME.js").then(l=>l.bP);return{merchantWalletService:r}},__vite__mapDeps([0,1]),import.meta.url)).merchantWalletService.reassignByMsisdns(t,s.uid)}catch(a){return console.error("فشل إصلاح المحافظ للمستخدم الحالي:",a),{updated:0,failed:(t==null?void 0:t.length)||0,error:String(a)}}}}catch{}},[Wt,s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;const t=Ve(V,"users",s.uid),a=Ls(t,r=>{if(!r.exists())return;const l=r.data(),o=Array.isArray(l==null?void 0:l.debts)?l.debts:[],m=`debts_unsynced_${s.uid}`,x=localStorage.getItem(m)==="true",y=localStorage.getItem(qi()),S=y?Number(y):0,u=S&&Date.now()-S<12e4;if(!(x||u))try{const g=o.map(I=>{var T;return{...I,createdAt:(T=I.createdAt)!=null&&T.toDate?I.createdAt.toDate():new Date(I.createdAt),partialPayments:Array.isArray(I.partialPayments)?I.partialPayments.map(P=>{var Y;return{amount:Number(P.amount)||0,paidAt:(Y=P.paidAt)!=null&&Y.toDate?P.paidAt.toDate():new Date(P.paidAt)}}):[]}});_s(g);try{localStorage.setItem(An(),JSON.stringify(g))}catch{}}catch(g){console.warn("تعذر تحليل الديون من التحديثات الحية:",g)}},r=>{console.warn("خطأ في الاشتراك الحي لديون المستخدم:",r)});return()=>a()},[s==null?void 0:s.uid]);const Xd=async()=>{if(s!=null&&s.uid){console.log("🔄 إعادة فحص حالة المستخدم...");try{await new Promise(a=>setTimeout(a,500));const t=await va(Ve(V,"users",s.uid));if(t.exists()){const r=t.data().isActive===!0,l=await Kr.checkTrialValidity(s.uid),o=l.isValid&&!l.isExpired;console.log("📊 حالة المستخدم:",{isActive:r,isOnTrial:o,hoursRemaining:l.hoursRemaining}),Lt(r||o),us(o),Zt(l.hoursRemaining),Ua(l.hasUsedTrial),Ht(!r&&!o),console.log("✅ تم تحديث حالة المستخدم بنجاح:",{userIsActive:r||o,isOnFreeTrial:o})}}catch(t){console.error("خطأ في إعادة فحص حالة المستخدم:",t)}}},em=async()=>{console.log("🎉 تم بدء التجربة المجانية، إعادة فحص حالة المستخدم..."),await Xd()},tm=async()=>{if(s!=null&&s.uid)try{It(!0);const t=await gl(s.uid);ur(t)}catch(t){console.error("خطأ في جلب بيانات الاشتراك:",t)}finally{It(!1)}},[Ku,Yu]=n.useState(!1),[sm,$i]=n.useState(!1),[Tt,Kt]=n.useState(0),[it,ds]=n.useState({}),[am,ho]=n.useState(!1),[rm,uo]=n.useState(!1),[nm,Wi]=n.useState(!1),[im,Nn]=n.useState(!1),[xo,Fi]=n.useState(""),[lm,Dr]=n.useState(!1),[om,jn]=n.useState(!1),[Ri,Sn]=n.useState(""),[cm,Bi]=n.useState(!1),[Dn,po]=n.useState(""),[Cn,go]=n.useState(""),[In,fo]=n.useState(""),[yo,bo]=n.useState(!1),[Ui,zi]=n.useState(!1),[dm,vo]=n.useState(!1),[wo,mm]=n.useState([]);n.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid)||!Ui)return;try{await Br.trimToMaxCount(s.uid,30)}catch{}const t=await Br.getByUser(s.uid,30);mm(t)}catch{}})()},[s==null?void 0:s.uid,Ui]);const Ds=()=>{const t=k||(j==null?void 0:j.shopId)||"main";return`walletBalances_${(s==null?void 0:s.uid)||"default"}_${t}`},Cs=()=>{const t=k||(j==null?void 0:j.shopId)||"main";return`cashBalance_${(s==null?void 0:s.uid)||"default"}_${t}`},An=()=>{const t=k||(j==null?void 0:j.shopId)||"main";return`debts_${(s==null?void 0:s.uid)||"default"}_${t}`},hm=()=>{const t=k||(j==null?void 0:j.shopId)||"main";return`customers_${(s==null?void 0:s.uid)||"default"}_${t}`},No=()=>`debts_default_${k||(j==null?void 0:j.shopId)||"main"}`,qi=()=>{const t=k||(j==null?void 0:j.shopId)||"main";return`debts_last_write_${(s==null?void 0:s.uid)||"default"}_${t}`},Vi=()=>`shopExpenses_${k||(j==null?void 0:j.shopId)||(s==null?void 0:s.uid)||"default"}`,jo=()=>{try{const t=localStorage.getItem(Vi());if(t){const a=JSON.parse(t);oe(a.map(r=>({...r,createdAt:new Date(r.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",t)}},So=async t=>{try{localStorage.setItem(Vi(),JSON.stringify(t)),oe(t)}catch(a){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",a)}},um=async t=>{try{const a=le.filter(r=>r.id!==t);await So(a);try{if(s!=null&&s.uid&&t){const{doc:r,deleteDoc:l}=await bt(async()=>{const{doc:x,deleteDoc:y}=await import("./index-gOTNP7ME.js").then(S=>S.bN);return{doc:x,deleteDoc:y}},__vite__mapDeps([0,1]),import.meta.url),{db:o}=await bt(async()=>{const{db:x}=await import("./index-gOTNP7ME.js").then(y=>y.bO);return{db:x}},__vite__mapDeps([0,1]),import.meta.url),m=r(o,"shop_expenses",t);await l(m)}}catch(r){console.warn("تعذر حذف المصروف من السحابة الآن، تم الحذف محليًا وسيبقى مخزّنًا دون هذا الإيصال:",r)}i({title:"تم الحذف",description:"تم حذف إيصال المصروف نهائيًا."})}catch(a){console.error("خطأ أثناء الحذف النهائي لإيصال المصروف:",a),i({title:"فشل الحذف",description:"تعذر حذف الإيصال. حاول مرة أخرى.",variant:"destructive"})}};Ke.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid)){jo();return}const{collection:a,query:r,where:l,onSnapshot:o}=await bt(async()=>{const{collection:S,query:u,where:g,onSnapshot:I}=await import("./index-gOTNP7ME.js").then(T=>T.bN);return{collection:S,query:u,where:g,onSnapshot:I}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await bt(async()=>{const{db:S}=await import("./index-gOTNP7ME.js").then(u=>u.bO);return{db:S}},__vite__mapDeps([0,1]),import.meta.url),x=k||(j==null?void 0:j.shopId),y=x?r(a(m,"shop_expenses"),l("shopId","==",x)):r(a(m,"shop_expenses"),l("userId","==",s.uid));t=o(y,async S=>{const g=S.docs.map(I=>{var Y;const T=I.data(),P=(Y=T.createdAt)!=null&&Y.toDate?T.createdAt.toDate():T.createdAt?new Date(T.createdAt):new Date;return{id:I.id,name:String(T.name||""),amount:Number(T.amount||0),notes:T.notes?String(T.notes):void 0,source:T.source==="wallet"?"wallet":"cash",walletId:T.walletId?String(T.walletId):void 0,createdAt:P}}).sort((I,T)=>T.createdAt.getTime()-I.createdAt.getTime());oe(g);try{localStorage.setItem(Vi(),JSON.stringify(g))}catch{}})}catch(a){console.error("خطأ في مزامنة مصروفات المحل من Firestore:",a)}})(),()=>t==null?void 0:t()},[s==null?void 0:s.uid,j==null?void 0:j.shopId,k]);const Tn=()=>`deficiencies_${k||(j==null?void 0:j.shopId)||(s==null?void 0:s.uid)||"default-shop"}`,xm=()=>{try{const t=Tn(),a=`deficiencies_${(s==null?void 0:s.uid)||"default"}`;if(a!==t){const l=localStorage.getItem(a),o=localStorage.getItem(t);if(l)try{const m=JSON.parse(l)||[],x=o?JSON.parse(o):[],y=Array.isArray(x)?[...x]:[],S=(u,g)=>u.some(I=>(I==null?void 0:I.id)&&(g==null?void 0:g.id)&&String(I.id)===String(g.id)||String((I==null?void 0:I.name)||"")===String((g==null?void 0:g.name)||"")&&String((I==null?void 0:I.status)||"pending")===String((g==null?void 0:g.status)||"pending"));if(Array.isArray(m))for(const u of m)S(y,u)||y.push(u);localStorage.setItem(t,JSON.stringify(y));try{localStorage.removeItem(a)}catch{}}catch{}}const r=localStorage.getItem(t);if(r){const l=JSON.parse(r);at(l.map(o=>({...o,createdAt:new Date(o.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل النواقص من التخزين:",t)}},Ji=async t=>{try{localStorage.setItem(Tn(),JSON.stringify(t)),at(t)}catch(a){console.error("خطأ أثناء حفظ النواقص في التخزين:",a)}};Ke.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid))return;const{collection:a,query:r,where:l,orderBy:o,onSnapshot:m}=await bt(async()=>{const{collection:u,query:g,where:I,orderBy:T,onSnapshot:P}=await import("./index-gOTNP7ME.js").then(Y=>Y.bN);return{collection:u,query:g,where:I,orderBy:T,onSnapshot:P}},__vite__mapDeps([0,1]),import.meta.url),{db:x}=await bt(async()=>{const{db:u}=await import("./index-gOTNP7ME.js").then(g=>g.bO);return{db:u}},__vite__mapDeps([0,1]),import.meta.url),y=k||(j==null?void 0:j.shopId)||s.uid||"default-shop",S=r(a(x,"deficiencies"),l("shopId","==",y),o("createdAt","desc"));t=m(S,async u=>{const g=u.docs.map(I=>{var Y;const T=I.data(),P=(Y=T.createdAt)!=null&&Y.toDate?T.createdAt.toDate():T.createdAt?new Date(T.createdAt):new Date;return{id:I.id,name:String(T.name||""),quantity:Number(T.quantity||1),status:T.status==="purchased"?"purchased":"pending",createdAt:P}});at(g);try{localStorage.setItem(Tn(),JSON.stringify(g))}catch{}},u=>{console.warn("فشل الاشتراك في النواقص من Firestore:",u)})}catch(a){console.warn("فشل إعداد مزامنة النواقص من Firestore:",a)}})(),()=>{try{t&&t()}catch{}}},[s==null?void 0:s.uid,j==null?void 0:j.shopId,k]);const Ki=async t=>{try{localStorage.setItem(hm(),JSON.stringify(t)),Ii(t),s!=null&&s.uid&&await pe.updateUserData(s.uid,{customers:t})}catch(a){console.error("خطأ أثناء حفظ العملاء في التخزين:",a)}},pm=async()=>{try{if(s!=null&&s.uid){const t=await va(Ve(V,"users",s.uid));if(t.exists()){const a=t.data();if(a.customers&&Array.isArray(a.customers)){const r=a.customers.map(l=>{var o;return{...l,createdAt:(o=l.createdAt)!=null&&o.toDate?l.createdAt.toDate():new Date(l.createdAt)}});Ii(r);return}}}Ii([])}catch(t){console.error("خطأ أثناء تحميل العملاء من Firestore:",t)}},Yi=()=>{const t=k||(j==null?void 0:j.shopId)||"main";return`transactions_${(s==null?void 0:s.uid)||"default"}_${t}`},Hi=()=>{const t=k||(j==null?void 0:j.shopId)||"main";return`wallets_${(s==null?void 0:s.uid)||"default"}_${t}`},Cr=()=>{const t=k||(j==null?void 0:j.shopId)||"main";return`selectedWallet_${(s==null?void 0:s.uid)||"default"}_${t}`};n.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid))return;const{collection:a,query:r,where:l,orderBy:o,limit:m,onSnapshot:x}=await bt(async()=>{const{collection:u,query:g,where:I,orderBy:T,limit:P,onSnapshot:Y}=await import("./index-gOTNP7ME.js").then(Fe=>Fe.bN);return{collection:u,query:g,where:I,orderBy:T,limit:P,onSnapshot:Y}},__vite__mapDeps([0,1]),import.meta.url),{db:y}=await bt(async()=>{const{db:u}=await import("./index-gOTNP7ME.js").then(g=>g.bO);return{db:u}},__vite__mapDeps([0,1]),import.meta.url),S=r(a(y,"userTransactions"),l("userId","==",s.uid),o("createdAt","desc"),m(100));t=x(S,u=>{Cl||hd(!0);const I=u.docs.map(se=>{var $r;const xe=se.data(),Ms=($r=xe.createdAt)!=null&&$r.toDate?xe.createdAt.toDate():new Date(xe.createdAt),ea=xe.txnType==="send"?"send":xe.txnType==="receive"?"withdraw":xe.type||"withdraw",ia=xe.status==="confirmed"?"completed":xe.status||"completed",Vn=xe.senderMsisdn||xe.senderPhone||"",Jn=xe.receiverMsisdn||xe.receiverPhone||"",Kn=Number(xe.amount??xe.transferredAmount??xe.withdrawnAmount??0);return{id:se.id,...xe,type:ea,status:ia,senderPhone:Vn,receiverPhone:Jn,amount:Kn,createdAt:Ms}}).filter(se=>!((se==null?void 0:se.type)==="report"||String((se==null?void 0:se.title)||"").includes("إيصال تسليم وردية"))),T=new Set((nn||[]).map(se=>String(se.id||se.originalTransactionId||""))),P=I.filter(se=>!T.has(String(se.id||""))),Y=se=>{var xe;return String(se.transactionId||se.id||se.reference||((xe=se.receipt)==null?void 0:xe.reference)||`${new Date(se.createdAt).getTime()}`)},Fe=new Set,ue=[];for(const se of P){const xe=Y(se);Fe.has(xe)||(Fe.add(xe),ue.push(se))}xa(ue)})}catch{}})(),()=>{try{t&&t()}catch{}}},[s==null?void 0:s.uid,nn.length]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;let t=null;return(async()=>{try{const{collection:a,query:r,where:l,onSnapshot:o}=await bt(async()=>{const{collection:y,query:S,where:u,onSnapshot:g}=await import("./index-gOTNP7ME.js").then(I=>I.bN);return{collection:y,query:S,where:u,onSnapshot:g}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await bt(async()=>{const{db:y}=await import("./index-gOTNP7ME.js").then(S=>S.bO);return{db:y}},__vite__mapDeps([0,1]),import.meta.url),x=r(a(m,"deletedTransactions"),l("userId","==",s.uid));t=o(x,y=>{try{y.docChanges().forEach(u=>{const g=u.doc.data(),I=[g.originalTransactionId,g.transactionId,g.reference,u.doc.id].filter(Boolean).map(Y=>String(Y));if(I.find(Y=>Il.current.has(Y)))return;const P=Al.current.find(Y=>{const Fe=String(Y.id||""),ue=String(Y.transactionId||""),se=String(Y.reference||"");return I.includes(Fe)||I.includes(ue)||I.includes(se)});if(P){const Y=P.fromWallet||X||"",Fe=Number(P.withdrawnAmount??P.sentAmount??P.amount??0),ue=P.type==="send"?"transfer":"withdraw";Y&&Fe>0&&(Ks.rollbackUsage(Y,Fe,ue).catch(()=>{}),I.forEach(se=>Il.current.add(se)))}});const S=y.docs.map(u=>{var T;const g=u.data(),I=(T=g.createdAt)!=null&&T.toDate?g.createdAt.toDate():new Date(g.createdAt||Date.now());return{id:u.id,...g,createdAt:I}});sr(S),(async()=>{try{const u=k||(j==null?void 0:j.shopId);if(!u)return;const g=Ve(m,"dashboardData",u),I=await va(g);if(I.exists()){const T=I.data();typeof T.cashBalance=="number"&&Kt(Number(T.cashBalance||0)),T.walletBalances&&typeof T.walletBalances=="object"&&ds(T.walletBalances||{})}}catch{}})()}catch{}},y=>{console.warn("deletedTransactions subscription error (Dashboard):",y)})}catch{}})(),()=>{try{t&&t()}catch{}}},[s==null?void 0:s.uid]);const[Gi,Pn]=n.useState(""),[Es,Do]=n.useState(""),na=Ke.useMemo(()=>{const t=Xt;if(!t)return!1;const a=dh(t),r=t.planType??t.plan??null,l=typeof r=="string"?r.toLowerCase():null,o=l==="monthly"||l==="quarterly"||l==="yearly"||l==="lifetime"||r===Is.MONTHLY||r===Is.QUARTERLY||r===Is.YEARLY||r===Is.LIFETIME;return a&&o},[Xt]),At=Ke.useMemo(()=>{var l,o;const t=Xt;if(!t)return!1;const a=((l=t.subscription)==null?void 0:l.planType)??((o=t.subscription)==null?void 0:o.plan)??t.planType??t.plan??null,r=typeof a=="string"?a.toLowerCase():null;return a===Is.ZERO||r==="zero"},[Xt]),zt=Ke.useMemo(()=>{var l,o;const t=Xt;if(!t)return!1;const a=((l=t.subscription)==null?void 0:l.planType)??((o=t.subscription)==null?void 0:o.plan)??t.planType??t.plan??null,r=typeof a=="string"?String(a).trim().toLowerCase():null;return a===Is.TAHWEELA||r==="tahweela"||r==="تحويله"},[Xt]),gm=()=>{if(!na){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}te(!0)},[Hu,Gu]=n.useState(!1),[fm,ym]=n.useState(!1),[bm,vm]=n.useState(!1),[wm,Nm]=n.useState(!1),[jm,Ir]=n.useState(!1),[Ha,kn]=n.useState(""),[Ar,_n]=n.useState(""),[Co,On]=n.useState(!1),[Tr,Pr]=n.useState(null),[Qi,En]=n.useState(""),[Sm,Io]=n.useState(!1),[Qu,Zu]=n.useState(!1),[Dm,Mn]=n.useState(!1),[Ao,Zi]=n.useState(""),[To,Xi]=n.useState(""),[Po,ko]=n.useState(!1),_o=async()=>{if(s!=null&&s.uid)try{const t=`userData_${s.uid}`,a=localStorage.getItem(t),r=`debts_unsynced_${s.uid}`,l=localStorage.getItem(An()),o=localStorage.getItem(r)==="true";if(a){const m=JSON.parse(a);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",m);const x={lastSynced:new Date().toISOString()};typeof m.cashBalance=="number"&&(x.cashBalance=m.cashBalance),m.walletBalances&&typeof m.walletBalances=="object"&&(x.walletBalances=m.walletBalances),await pe.updateUserData(s.uid,x),localStorage.removeItem(t),Ge(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة");if(o&&l)try{const m=JSON.parse(l)||[];await pe.updateUserData(s.uid,{debts:m});try{localStorage.removeItem(r)}catch{}Ge(!1),console.log("✅ تمت مزامنة الديون مع Firebase")}catch(m){console.error("❌ فشل مزامنة الديون:",m),Ge(!0)}}catch(t){console.error("❌ فشل في مزامنة البيانات:",t),i({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},[cr,Ln]=n.useState({keepLastCount:30,intervalDays:7,lastResetAt:null});n.useEffect(()=>{(async()=>{if(s!=null&&s.uid)try{const a=await pe.getUserData(s.uid),r=(a==null?void 0:a.recentReset)||{},l=Number(r==null?void 0:r.keepLastCount)>0?Number(r.keepLastCount):30,o=Number(r==null?void 0:r.intervalDays)>0?Number(r.intervalDays):7,m=u=>u instanceof Date?u:typeof(u==null?void 0:u.toDate)=="function"?u.toDate():u?new Date(String(u)):null,x=r!=null&&r.lastResetAt?m(r.lastResetAt):null,y=new Date;!x||y.getTime()-x.getTime()>=o*24*60*60*1e3?(await pe.updateUserData(s.uid,{recentReset:{keepLastCount:l,intervalDays:o,lastResetAt:y}}),Ln({keepLastCount:l,intervalDays:o,lastResetAt:y})):Ln({keepLastCount:l,intervalDays:o,lastResetAt:x})}catch{Ln({keepLastCount:30,intervalDays:7,lastResetAt:null})}})()},[s==null?void 0:s.uid]);const Oo=Ke.useMemo(()=>{const t=Ze||[],a=cr.keepLastCount??30;return[...t].sort((l,o)=>{const m=x=>x instanceof Date?x:typeof(x==null?void 0:x.toDate)=="function"?x.toDate():new Date(String(x));return m(o.createdAt).getTime()-m(l.createdAt).getTime()}).slice(0,a)},[Ze,cr.keepLastCount]),Cm=Ke.useMemo(()=>Math.max(0,((Ze==null?void 0:Ze.length)||0)-(cr.keepLastCount||30)),[Ze==null?void 0:Ze.length,cr.keepLastCount]),$n=Ke.useMemo(()=>{const t=new Date,a=new Date(t.getFullYear(),t.getMonth(),1),r=new Date(t.getFullYear(),t.getMonth()+1,1),l={};for(const m of Ze){const x=new Date(m.createdAt||0);if(!(x>=a&&x<r))continue;const y=String(m.type||m.txnType||"").toLowerCase();if(!(y==="send"||y==="withdraw"||y==="transfer"))continue;const S=String(m.receiverPhone||m.senderPhone||"").trim();if(!S)continue;const u=Ns(S),g=Number(m.amount||m.withdrawnAmount||m.sentAmount||0)||0;l[u]||(l[u]={phone:u,count:0,total:0}),l[u].count+=1,l[u].total+=g}return Object.values(l).sort((m,x)=>x.count!==m.count?x.count-m.count:x.total-m.total).slice(0,10)},[Ze]),Im=t=>{const a=Ns(String(t));return a.startsWith("+20")?"20"+a.slice(3):a.startsWith("0")?"20"+a.slice(1):a.replace(/[^0-9]/g,"")},Am=t=>{const a=Im(t.phone),r=`عميل VIP هذا الشهر
عدد العمليات: ${t.count}
الإجمالي: ${t.total} جنيه`,l=`https://wa.me/${a}?text=${encodeURIComponent(r)}`;try{window.open(l,"_blank")}catch{}};n.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid))return;const t=`${new Date().getFullYear()}-${new Date().getMonth()+1}`;await pe.updateUserData(s.uid,{vipTop10:$n,vipMonthTag:t})}catch{}})()},[s==null?void 0:s.uid,$n]);async function Tm(){const t=new Date,a=new Intl.DateTimeFormat("ar-EG",{timeZone:"Africa/Cairo",year:"numeric",month:"2-digit",day:"2-digit"}).format(t),r=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0,0),l=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59,999),o=(Ze||[]).filter(P=>{const Y=new Date(P.createdAt||0);return Y>=r&&Y<=l}),m=o.length,x=o.filter(P=>String(P.type||P.txnType||"").toLowerCase()==="withdraw"||String(P.type||"").toLowerCase()==="receive").reduce((P,Y)=>P+(Y.withdrawnAmount!=null?Number(Y.withdrawnAmount):Number(Y.amount||0)),0),y=o.filter(P=>String(P.type||P.txnType||"").toLowerCase()==="send"||String(P.type||"").toLowerCase()==="transfer").reduce((P,Y)=>P+(Y.sentAmount!=null?Number(Y.sentAmount):Number(Y.amount||0)),0);let S=0;try{S=o.reduce((P,Y)=>P+bs.calculateTransactionProfit(Y),0)}catch{}let u=0;try{const P=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(t),Y=Ue(je(V,"dailySales"),ae("userId","==",(s==null?void 0:s.uid)||""));u=(await Qe(Y)).docs.map(se=>se.data()).filter(se=>String(se.date||P)===P).reduce((se,xe)=>se+Number(xe.sellingPrice||xe.price||0)*Number(xe.quantity||1),0)}catch{}let g=0;try{g=(Wt||[]).filter(Y=>String(Y.status||"")==="pending").reduce((Y,Fe)=>{const ue=Number(Fe.paidAmount||0)+(Array.isArray(Fe.partialPayments)?Fe.partialPayments:[]).reduce((se,xe)=>se+Number(xe.amount||0),0);return Y+Math.max(0,Number(Fe.amount||0)-ue)},0)}catch{}let I="";try{const P=k||(j==null?void 0:j.shopId)||null,Y=P?Ue(je(V,"deficiencies"),ae("shopId","==",P)):Ue(je(V,"deficiencies"),ae("userId","==",(s==null?void 0:s.uid)||""));I=(await Qe(Y)).docs.map(xe=>xe.data()).filter(xe=>String(xe.status||"pending")==="pending").slice(0,10).map((xe,Ms)=>`${Ms+1}- ${String(xe.name||xe.productName||"عنصر")} × ${Number(xe.quantity||xe.qty||0)}`).join(`
`)}catch{}return[`تقرير يومي - ${a}`,`عدد العمليات: ${m}`,`إجمالي المسحوبات: ${x} جنيه`,`إجمالي الإرسال: ${y} جنيه`,`الأرباح: ${S} جنيه`,`إجمالي مبيعات الاكسسوار: ${u} جنيه`,`إجمالي الديون: ${g} جنيه`,"نواقص الاكسسوار:",I||"لا توجد عناصر مسجلة"].join(`
`)}const Eo=Ke.useCallback(()=>{let t=Oo;const a=kl.trim();if(a&&(t=t.filter(r=>{const l=r;return String(l.type||"").toLowerCase()==="cash_addition"||String(l.txnType||"").toLowerCase()==="cash_addition"||String(l.title||"").includes("إيصال إضافة نقدية")?!0:r.senderPhone&&r.senderPhone.includes(a)||r.receiverPhone&&r.receiverPhone.includes(a)})),ln){const r=new Date(ln);t=t.filter(l=>{const o=new Date(l.createdAt);if(on){const[m,x]=on.split(":"),y=new Date(r);y.setHours(parseInt(m),parseInt(x),0,0);const S=new Date(y);return S.setHours(S.getHours()+1),o>=y&&o<S}else return o.toDateString()===r.toDateString()})}try{t=[...t].sort((r,l)=>{const o=new Date(r.createdAt||0).getTime();return new Date(l.createdAt||0).getTime()-o})}catch{}return t},[Oo,kl,ln,on]),[Pm,Wn]=n.useState(!1),[Mo,Fn]=n.useState(""),[km,Rn]=n.useState(!1),[el,tl]=n.useState(""),[_m,Ge]=n.useState(!1),kr=async(t,a=2,r=700)=>{let l;for(let o=0;o<=a;o++)try{return await t()}catch(m){if(l=m,o===a)break;await new Promise(x=>setTimeout(x,r*Math.pow(2,o)))}throw l};He.reduce((t,a)=>t+(it[a.id]||0),0);const Om=async t=>await ws.verifyMasterPin(t,s==null?void 0:s.uid),Bn=async t=>await ws.verifyMasterPin(t,s==null?void 0:s.uid);n.useEffect(()=>{if(s!=null&&s.uid){try{const t=Ds(),a=`walletBalances_${s.uid}`,r=localStorage.getItem(t)??localStorage.getItem(a);if(r){const l=JSON.parse(r);ds(l&&typeof l=="object"?l:{});try{localStorage.setItem(t,JSON.stringify(l||{}))}catch{}}}catch{}try{const t=Cs(),a=`cashBalance_${s.uid}`,r=`userCashBalance_${s.uid}`;let l=localStorage.getItem(t)??localStorage.getItem(a)??localStorage.getItem(r);if(l!=null){const o=parseFloat(l);Kt(Number.isFinite(o)?o:0);try{localStorage.setItem(t,String(Number.isFinite(o)?o:0)),localStorage.removeItem(a),localStorage.removeItem(r)}catch{}}}catch{}}},[s==null?void 0:s.uid,k,j==null?void 0:j.shopId]),n.useEffect(()=>{const t=a=>{var r;try{const l=Number((r=a==null?void 0:a.detail)==null?void 0:r.value);if(Number.isFinite(l))Kt(l);else{const o=localStorage.getItem(Cs());o!=null&&Kt(parseFloat(o)||0)}}catch{const l=localStorage.getItem(Cs());l!=null&&Kt(parseFloat(l)||0)}};return window.addEventListener("cashBalanceChanged",t),()=>window.removeEventListener("cashBalanceChanged",t)},[s==null?void 0:s.uid,k,j==null?void 0:j.shopId]),n.useEffect(()=>{try{if(!(s!=null&&s.uid))return;const t=k||(j==null?void 0:j.shopId);if(!t)return;const a=Ve(V,"dashboardData",t);let r=null;return r=Ls(a,l=>{if(!l.exists())return;const o=l.data(),m=Number((o==null?void 0:o.cashBalance)||0),x=o!=null&&o.walletBalances&&typeof o.walletBalances=="object"?o.walletBalances:{};Kt(m),ds(x);try{localStorage.setItem(Cs(),String(m)),localStorage.setItem(Ds(),JSON.stringify(x))}catch{}},l=>{console.warn("dashboardData subscription error:",l)}),()=>{try{r&&r()}catch{}}}catch{}},[s==null?void 0:s.uid,k,j==null?void 0:j.shopId]);const Lo=t=>`walletLimits_${(s==null?void 0:s.uid)||"default"}_${t||"none"}`;n.useEffect(()=>{if(!X)return;try{const r=Lo(X),l=localStorage.getItem(r);if(l){const o=JSON.parse(l);Li(o)}}catch{}const t=Ve(V,"walletLimits",String(X));let a=null;try{a=Ls(t,r=>{if(!r.exists())return;const l=r.data(),o={walletId:X,dailyTransferLimit:l.dailyTransferLimit??6e4,dailyWithdrawLimit:l.dailyWithdrawLimit??1e5,dailyTransferUsed:l.dailyTransferUsed??0,dailyWithdrawUsed:l.dailyWithdrawUsed??0,monthlyTransferLimit:l.monthlyTransferLimit??2e5,monthlyWithdrawLimit:l.monthlyWithdrawLimit??2e5,monthlyTransferUsed:l.monthlyTransferUsed??0,monthlyWithdrawUsed:l.monthlyWithdrawUsed??0};Li(o);try{localStorage.setItem(Lo(X),JSON.stringify(o))}catch{}})}catch{}return()=>{a&&a()}},[X]),n.useEffect(()=>{if(!X)return;const t=He.find(a=>a.id===X);if(t!=null&&t.name){mo(String(t.name));try{localStorage.setItem(`walletName_${(s==null?void 0:s.uid)||"default"}_${X}`,String(t.name))}catch{}return}try{const a=localStorage.getItem(`walletName_${(s==null?void 0:s.uid)||"default"}_${X}`);a&&mo(String(a))}catch{}},[X,He]);const sl=async()=>{try{if(!X)return;const t=await Ks.autoResetLimitsIfNeeded(X);Li(t)}catch(t){console.error("خطأ في جلب حدود المحفظة المختارة:",t)}};n.useEffect(()=>{sl()},[X]),n.useEffect(()=>{const t=a=>{var r;(r=a==null?void 0:a.detail)!=null&&r.walletId&&a.detail.walletId===X&&sl()};return window.addEventListener("walletLimitsUpdated",t),()=>window.removeEventListener("walletLimitsUpdated",t)},[X]),n.useEffect(()=>{if(D.state){if(console.log("Location state:",D.state),D.state.openDebtDialog&&(Di(),window.history.replaceState({},document.title)),D.state.openSalesDialog&&(At||zt?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):gr(!0),window.history.replaceState({},document.title)),D.state.openMaintenanceDialog&&(At||zt?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):mn(!0),window.history.replaceState({},document.title)),D.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),At||zt?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):dn(!0),window.history.replaceState({},document.title)),D.state.openShopExpensesDialog&&(At||zt?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ws.hasMasterPin()?Vt(!0):kt(!0),window.history.replaceState({},document.title)),D.state.openDeficienciesDialog&&(At||zt?i({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ma(!0),window.history.replaceState({},document.title)),D.state.openInstallment&&(At||zt?i({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"}):cn(!0),window.history.replaceState({},document.title)),D.state.openTransactionSection){const t=document.getElementById("transaction-section");t&&t.scrollIntoView({behavior:"smooth"}),D.state.transactionType&&vl(D.state.transactionType),D.state.startNewTransaction&&(za(""),ha(""),ai(""),ri(""),console.log("🔒 Starting new transaction without changing wallet selection")),D.state.focusWalletSelection&&setTimeout(()=>{const a=document.querySelector('[data-testid="wallet-select"]');a&&a.focus()},500),window.history.replaceState({},document.title)}D.state.openCashierShiftModal&&(!na||zt?i({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):te(!0),window.history.replaceState({},document.title)),D.state.openMachineDailyDialog&&(!na||zt?i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):hn(!0),window.history.replaceState({},document.title))}},[D.state,He,zt]),n.useEffect(()=>{D.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),_r(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",D.pathname)},[D.pathname,s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;console.log("🔥 Setting up real-time user activation listener for:",s.uid);const t=Ve(V,"users",s.uid),a=Ls(t,r=>{if(r.exists()){const l=r.data(),o=l.isActive===!0;console.log("🔥 Real-time user status update:",{userId:s.uid,isActive:o,subscription:l.subscription}),o&&!Mt?(console.log("🎉 User activated! Redirecting to dashboard..."),Lt(!0),Ht(!1),st(!1)):!o&&Mt&&(console.log("❌ User deactivated! Showing activation modal..."),Lt(!1),Ht(!0))}},r=>{console.error("❌ Error in real-time user listener:",r)});return()=>{console.log("🔥 Cleaning up real-time user listener"),a()}},[s==null?void 0:s.uid,Mt]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;const t=r=>{const{userId:l}=r.detail;l===s.uid&&(console.log("🎉 Subscription activation event received for current user!"),Lt(!0),Ht(!1),st(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},a=r=>{const{userId:l,isActive:o}=r.detail;l===s.uid&&(console.log("🔄 User subscription update event received:",{userId:l,isActive:o}),o&&!Mt&&(Lt(!0),Ht(!1),st(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",t),window.addEventListener("userSubscriptionUpdated",a),()=>{window.removeEventListener("subscriptionActivated",t),window.removeEventListener("userSubscriptionUpdated",a)}},[s==null?void 0:s.uid,Mt]),n.useEffect(()=>{const t=a=>{var m;const r=a.target,l=(m=r==null?void 0:r.tagName)==null?void 0:m.toLowerCase();if(!(l==="input"||l==="textarea"||l==="select"||((r==null?void 0:r.isContentEditable)??!1))&&!(a.ctrlKey||a.altKey||a.metaKey)&&!a.repeat){if((At||zt)&&a.key>="1"&&a.key<="9"){a.preventDefault();return}switch(a.key){case"1":break;case"2":hi(!0);break;case"3":At||zt?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):dn(!0);break;case"4":na?te(!0):i({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"5":At||zt?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):gr(!0);break;case"6":Di();break;case"7":At||zt?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):mn(!0);break;case"8":na?hn(!0):i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"9":At||zt?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ws.hasMasterPin()?Vt(!0):kt(!0);break}}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[At,zt,na]),n.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:s==null?void 0:s.uid,isCheckingActivation:Nt}),(async()=>{try{if(!(s!=null&&s.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),st(!1);return}try{const m=await va(Ve(V,"users",s.uid));if(m.exists()){const y=m.data().isActive===!0,S=await Kr.checkTrialValidity(s.uid),u=S.isValid&&!S.isExpired;Lt(y||u),us(u),Zt(S.hoursRemaining),Ua(S.hasUsedTrial),Ht(!y&&!u),console.log("📊 حالة المستخدم:",{isActive:y,isOnTrial:u,hoursRemaining:S.hoursRemaining,hasUsedTrial:S.hasUsedTrial})}else Lt(!1),Ht(!0)}catch(m){console.error("خطأ في فحص حالة تفعيل المستخدم:",m),Lt(!1),Ht(!0)}finally{st(!1)}if(console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:s==null?void 0:s.uid}),s!=null&&s.uid){const m=await kr(()=>pe.getUserData(s.uid));if(m){const x=(m==null?void 0:m.walletBalances)||{};ds(x),(m==null?void 0:m.cashBalance)!==void 0&&Kt(m.cashBalance);try{const y=s!=null&&s.uid?await kr(()=>zr.getDeletedTransactionsByUser(s.uid)):[];sr(y||[])}catch{sr([])}}else{ds({});try{const x=s!=null&&s.uid?await zr.getDeletedTransactionsByUser(s.uid):[];sr(x||[])}catch{sr([])}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const m=await kr(()=>sa.getByMerchantId((s==null?void 0:s.uid)||""));if(m&&m.length>0){console.log("✅ تم العثور على محافظ في Firebase:",m.length);const y=m.filter(g=>g.isActive===!0).map(g=>({id:g.id,name:g.label||"محفظة بدون اسم",phone:g.msisdn,isDefault:!1,monthlyWithdrawalLimit:g.monthlyWithdrawalLimit??g.withdrawLimit??2e5,monthlyTransferLimit:g.monthlyTransferLimit??g.transferLimit??2e5,defaultTransferCommission:g.defaultTransferCommission!=null?Number(g.defaultTransferCommission):null,defaultWithdrawCommission:g.defaultWithdrawCommission!=null?Number(g.defaultWithdrawCommission):null}));fr(y);const S=localStorage.getItem(Cr());let u=null;S&&y.find(g=>g.id===S)?u=y.find(g=>g.id===S):u=y[0],u&&(oi(u.id),tr(u.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else console.log("⚠️ لا توجد محافظ في Firebase. سيتم عرض قائمة فارغة بدون أي استرجاع محلي."),fr([])}catch(m){console.error("خطأ في تحميل المحافظ من Firebase:",m),fr([])}const o=s!=null&&s.uid?await kr(()=>pe.getUserTransactions(s.uid)):[];if(o&&o.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",o.length);const m=o.map(g=>({...g,createdAt:new Date(g.createdAt),senderPhone:g.senderMsisdn||g.senderPhone||"",receiverPhone:g.receiverMsisdn||g.receiverPhone||"",type:g.txnType==="send"?"send":g.txnType==="receive"?"withdraw":g.type||"withdraw",status:g.status==="confirmed"?"completed":g.status||"completed"})),x=nn.map(g=>g.id||g.originalTransactionId);let y=[];try{const g=Ue(je(V,"deletedTransactions"),ae("userId","==",(s==null?void 0:s.uid)||""),ae("permanent","==",!0));y=(await Qe(g)).docs.map(T=>{const P=T.data();return String(P.originalTransactionId||P.transactionId||T.id||"")}).filter(Boolean)}catch{}const S=new Set(y),u=m.filter(g=>{var ue;const I=String(g.id||""),T=String(g.transactionId||""),P=String(g.reference||g.transactionReference||((ue=g.receipt)==null?void 0:ue.reference)||""),Y=x.includes(I),Fe=S.has(I)||T&&S.has(T);return!Y&&!Fe});console.log("✅ تم فلترة المعاملات المحذوفة:",{total:o.length,deleted:x.length,active:u.length});{const g=P=>{var Y;return String((P==null?void 0:P.transactionId)||(P==null?void 0:P.id)||`${(P==null?void 0:P.transactionReference)||((Y=P==null?void 0:P.receipt)==null?void 0:Y.reference)||"ref"}-${new Date((P==null?void 0:P.createdAt)||0).getTime()}`)},I=new Set,T=[];for(const P of u){const Y=g(P);I.has(Y)||(I.add(Y),T.push(P))}Cl||xa(T)}}await _o()}catch(o){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",o)}})().then(async()=>{await l(),await a(),await r()});const a=async()=>{try{if(!(s!=null&&s.uid))return;const o=await sa.getByMerchantId(s.uid);await Promise.all(o.map(m=>tu.autoResetLimitsIfNeeded(m.id)))}catch(o){console.error("خطأ في التصفير التلقائي للحدود:",o)}},r=async()=>{try{await bs.syncReportsDataFromFirebase(s==null?void 0:s.uid);const o=bs.getReportsData(s==null?void 0:s.uid);if((o.lastDailyResetDate?bs.shouldResetDailyReports(o.lastDailyResetDate):!1)&&(s!=null&&s.uid)&&o.lastDailyResetDate){const y=new Date(o.lastDailyResetDate),S=y.toDateString(),u=Ze.filter(ue=>new Date(ue.createdAt).toDateString()===S&&ue.status==="completed"),g=u.length,I=u.reduce((ue,se)=>ue+se.amount,0),T=u.filter(Or).reduce((ue,se)=>{const xe=se.withdrawnAmount!==void 0?se.withdrawnAmount:se.amount;return ue+xe},0),P=u.filter(Er).reduce((ue,se)=>{const xe=se.sentAmount!==void 0?se.sentAmount:se.amount;return ue+xe},0),Y=u.reduce((ue,se)=>ue+bs.calculateTransactionProfit(se),0),Fe=new Date(y).toISOString().slice(0,10);await Br.add({userId:s.uid,reportDate:Fe,totalTransactions:g,totalAmount:Number(I.toFixed(2)),totalWithdrawn:Number(T.toFixed(2)),totalSent:Number(P.toFixed(2)),profit:Number(Y.toFixed(2)),walletId:null})}const x=bs.autoResetReportsIfNeeded(s==null?void 0:s.uid);(x.dailyReset||x.monthlyReset)&&console.log("تم التصفير التلقائي:",x)}catch(o){console.error("خطأ في التصفير التلقائي للتقارير:",o)}},l=async()=>{try{if(!(s!=null&&s.uid))return;const o=new Date;if(o.getDate()!==1)return;const m=`${o.getFullYear()}-${o.getMonth()+1}`,x=`lastMonthlyDbCleanup:${s.uid}`;if(localStorage.getItem(x)===m)return;const S=new Date(o.getFullYear(),o.getMonth(),1,0,0,0,0),u=T=>T instanceof Date?T:typeof(T==null?void 0:T.toDate)=="function"?T.toDate():new Date(String(T));let g=[];try{const T=Ue(je(V,"userTransactions"),ae("userId","==",s.uid),ae("createdAt","<",S));g=(await Qe(T)).docs}catch{const T=Ue(je(V,"userTransactions"),ae("userId","==",s.uid));g=(await Qe(T)).docs.filter(Y=>{var Fe;return u((Fe=Y.data())==null?void 0:Fe.createdAt)<S})}await Promise.allSettled(g.map(T=>As(T.ref)));let I=[];try{const T=Ue(je(V,"transactions"),ae("userId","==",s.uid),ae("createdAt","<",S));I=(await Qe(T)).docs}catch{const T=Ue(je(V,"transactions"),ae("userId","==",s.uid));I=(await Qe(T)).docs.filter(Y=>{var Fe;return u((Fe=Y.data())==null?void 0:Fe.createdAt)<S})}await Promise.allSettled(I.map(T=>As(T.ref)));try{localStorage.setItem(x,m)}catch{}console.log("✅ تم تنظيف قاعدة البيانات شهريًا (Firebase فقط):",{userTransactionsDeleted:g.length,globalTransactionsDeleted:I.length,monthStart:S})}catch(o){console.error("فشل التنظيف الشهري التلقائي لقاعدة البيانات:",o)}};tm(),Zd(),pm(),console.log("🔥 useEffect loadUserData completed")},[s==null?void 0:s.uid]);const _r=async()=>{var t;if(s!=null&&s.uid)try{const a=await kr(()=>sa.getByMerchantId(s.uid));if(a&&a.length>0){const l=a.filter(o=>o.isActive===!0).map(o=>({id:o.id,name:o.label||"محفظة بدون اسم",phone:o.msisdn,isDefault:!1,monthlyWithdrawalLimit:o.monthlyWithdrawalLimit??o.withdrawLimit??2e5,monthlyTransferLimit:o.monthlyTransferLimit??o.transferLimit??2e5,defaultTransferCommission:o.defaultTransferCommission!=null?Number(o.defaultTransferCommission):void 0,defaultWithdrawCommission:o.defaultWithdrawCommission!=null?Number(o.defaultWithdrawCommission):void 0}));if(fr(l),s!=null&&s.uid){const o=localStorage.getItem(Cr());if(!!(X&&l.find(x=>x.id===X)))console.log("🔒 Preserving current wallet selection:",X);else{const y=(o&&l.find(S=>S.id===o)?o:null)||((t=l[0])==null?void 0:t.id);y&&(console.log("🔄 Fixing invalid wallet selection:",y),Un(y))}}console.log("🔄 تم تحديث المحافظ من Firebase:",l.length)}}catch(a){console.error("خطأ في تحميل المحافظ من Firebase:",a)}};n.useEffect(()=>{const t=D.pathname;sessionStorage.getItem("previousPath")==="/user/add-wallet"&&t==="/user/dashboard"&&(console.log("🔄 Returning from add wallet page - reloading wallets"),console.log("🔒 Current wallet before add-wallet return reload:",X),_r(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",t)},[D.pathname,s==null?void 0:s.uid]),n.useEffect(()=>{const t=()=>{console.log("🔄 Window focused - reloading wallets"),console.log("🔒 Current wallet before focus reload:",X),_r().then(()=>{console.log("🔒 Wallet preserved after focus reload:",X)})};return window.addEventListener("focus",t),()=>{window.removeEventListener("focus",t)}},[s==null?void 0:s.uid,X,He]);const Un=(t,a="unknown")=>{console.log(`🎯 setWalletSelection called from ${a} with walletId:`,t),console.log("🔍 Previous selectedWallet:",X),oi(t);const r=He.find(l=>l.id===t);r&&(tr(r.phone),console.log("✅ Wallet set successfully:",t,"Phone:",r.phone)),s!=null&&s.uid&&(localStorage.setItem(Cr(),t),console.log("💾 Saved wallet to localStorage:",t))};n.useEffect(()=>{const t=()=>{_r()};try{window.addEventListener("wallets:activation-updated",t)}catch{}return()=>{try{window.removeEventListener("wallets:activation-updated",t)}catch{}}},[s==null?void 0:s.uid]);const Em=t=>{if(t==="__add_wallet"){M("/user/add-wallet");return}if(t==="__view_wallets"){Xs(!0);return}$h.isEnabled(s==null?void 0:s.uid)?(pr(t),en(!0)):Un(t,"walletSelectionNoPin")},zn=t=>{console.log("🔄 handleTransactionTypeChange called with type:",t),console.log("🔍 Current selectedWallet before change:",X),console.log("🔍 Available wallets count:",He.length),vl(t),za(""),ha(""),ai(""),ri(""),console.log("✅ Transaction type changed to:",t,"- Wallet selection preserved:",X),setTimeout(()=>{const a=document.getElementById("transaction-section");a&&a.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)};n.useEffect(()=>{const t=a=>{const r=a.target;if(!!r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"||r.tagName==="SELECT"||r.isContentEditable)||(a.key==="ArrowLeft"?(a.preventDefault(),zn("withdraw")):a.key==="ArrowRight"&&(a.preventDefault(),zn("transfer"))),a.key==="Enter"){const o=re==="transfer"?"transferSubmitButton":"withdrawSubmitButton",m=document.getElementById(o);m&&!m.disabled&&(a.preventDefault(),m.click())}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[re]);const $o=t=>{cd((r=>({id:r.id,type:r.type==="send"?"transfer":"withdraw",sender_msisdn:r.senderPhone,receiver_msisdn:r.receiverPhone,amount:r.amount,commission:r.commission||0,fee:(r==null?void 0:r.fee)??0,status:r.status==="failed"?"failed":r.status==="completed"?"completed":"pending",createdAt:new Date(r.createdAt).toISOString(),updatedAt:new Date(r.createdAt).toISOString(),shopName:K??(j==null?void 0:j.shopName)??(s==null?void 0:s.displayName)??"المحل",cashierName:(r==null?void 0:r.cashierName)??null,commissionMode:(r==null?void 0:r.commissionMode)??(r.type==="send"||yt?"add":"deduct"),totalCharged:(r==null?void 0:r.totalCharged)??(r.type==="send"?Number(r.amount||0)+Number(r.commission||0)+Number((r==null?void 0:r.fee)||0):yt?Number(r.amount||0)+Number(r.commission||0):Number(r.amount||0)),note:(r==null?void 0:r.note)??(r==null?void 0:r.notes)??void 0}))(t)),rn(!0)},Mm=async t=>{var o;if(!(s!=null&&s.uid)){i({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const a=Ze.find(m=>m.id===t);if(!a){i({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}const r=String(t),l=String((a==null?void 0:a.transactionId)||(a==null?void 0:a.reference)||"");Ca.current.add(r),l&&Ca.current.add(l);try{console.log("🗑️ بدء عملية حذف المعاملة:",t),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:a.id,userId:s.uid,transactionData:a}),await pe.removeUserTransaction(s.uid,a.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await zr.saveDeletedTransaction({...a,userId:s.uid,originalTransactionId:a.id,transactionId:a.transactionId||a.id,reference:a.reference||a.transactionReference||((o=a.receipt)==null?void 0:o.reference),deletedAt:new Date().toISOString(),permanent:!0}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(y){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",y)}try{await zr.permanentlyDeleteTransaction(a.id,s.uid)}catch(y){console.warn("⚠️ فشل وسم الحذف النهائي أو التنظيف الإضافي:",y)}const m=[...nn,a],x=Ze.filter(y=>y.id!==t);sr(m),xa(x),Sl(!1),console.log("✅ تم تحديث الحالة بعد الحذف من Firebase (بدون نسخ محلية)");try{const y=a.fromWallet;if(y){const{walletDailyLimitsService:S}=await bt(async()=>{const{walletDailyLimitsService:g}=await import("./walletDailyLimitsService-UwV1MQRJ.js");return{walletDailyLimitsService:g}},__vite__mapDeps([3,0,1]),import.meta.url),u=await S.getWalletLimits(y);if(u){const g=a.type==="send",I={updatedAt:(await bt(async()=>{const{serverTimestamp:ue}=await import("./index-gOTNP7ME.js").then(se=>se.bN);return{serverTimestamp:ue}},__vite__mapDeps([0,1]),import.meta.url)).serverTimestamp()};g?(I.dailyTransferUsed=Math.max(0,(u.dailyTransferUsed||0)-a.amount),I.monthlyTransferUsed=Math.max(0,(u.monthlyTransferUsed||0)-a.amount)):(I.dailyWithdrawUsed=Math.max(0,(u.dailyWithdrawUsed||0)-a.amount),I.monthlyWithdrawUsed=Math.max(0,(u.monthlyWithdrawUsed||0)-a.amount));const{doc:T,setDoc:P}=await bt(async()=>{const{doc:ue,setDoc:se}=await import("./index-gOTNP7ME.js").then(xe=>xe.bN);return{doc:ue,setDoc:se}},__vite__mapDeps([0,1]),import.meta.url),{db:Y}=await bt(async()=>{const{db:ue}=await import("./index-gOTNP7ME.js").then(se=>se.bO);return{db:ue}},__vite__mapDeps([0,1]),import.meta.url),Fe=T(Y,"walletLimits",y);await P(Fe,I,{merge:!0})}}}catch(y){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",y)}try{const{ProfitService:y}=await bt(async()=>{const{ProfitService:T}=await import("./profitService-C6ong2ih.js");return{ProfitService:T}},__vite__mapDeps([4,0,1]),import.meta.url),{ReportsService:S}=await bt(async()=>{const{ReportsService:T}=await import("./index-gOTNP7ME.js").then(P=>P.bS);return{ReportsService:T}},__vite__mapDeps([0,1]),import.meta.url),g={txnType:a.type==="send"?"send":"receive",amount:a.amount,commission:a.commission||0,createdAt:a.createdAt,status:"confirmed"},I=y.calculateProfitFromTransaction(g);I>0&&y.addProfit(-I,s.uid);try{S.removeTransactionEffects(a,s.uid)}catch{}}catch(y){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",y)}i({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(m){console.error("❌ خطأ في حذف المعاملة من Firebase:",m);let x="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";m instanceof Error&&(m.message.includes("network")||m.message.includes("offline")?x="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":m.message.includes("permission")||m.message.includes("unauthorized")?x="ليس لديك صلاحية لحذف هذه المعاملة":m.message.includes("not-found")&&(x="المعاملة غير موجودة أو تم حذفها مسبقاً")),i({title:"خطأ في الحذف",description:x,variant:"destructive"})}},Or=t=>{const a=t.type,r=t.txnType;return a==="withdraw"||a==="withdrawal"||a==="receive"||r==="receive"},Er=t=>{const a=t.type,r=t.txnType;return a==="send"||a==="transfer"||r==="send"},Mr=(t,a)=>{const r=new Date().toDateString();let l=Ze.filter(u=>{const g=new Date(u.createdAt).toDateString()===r,I=String(u.status||"").toLowerCase();return g&&(I==="completed"||I==="confirmed"||I==="pending")});ga&&ga.trim()!==""&&(l=l.filter(u=>u.senderPhone&&u.senderPhone.includes(ga)||u.receiverPhone&&u.receiverPhone.includes(ga)));const o=bs.filterVisibleTransactions(l,"daily",s==null?void 0:s.uid),m=o.length,x=o.reduce((u,g)=>u+g.amount,0),y=o.filter(Or).reduce((u,g)=>{const I=g.withdrawnAmount!==void 0?g.withdrawnAmount:g.amount;return u+I},0),S=o.filter(Er).reduce((u,g)=>{const I=g.sentAmount!==void 0?g.sentAmount:g.amount;return u+I},0);return{totalTransactions:m,totalAmount:x,totalWithdrawn:y,totalSent:S}},Lr=t=>{const a=new Date().getMonth(),r=new Date().getFullYear();let l=Ze.filter(u=>{const g=new Date(u.createdAt);return g.getMonth()===a&&g.getFullYear()===r&&u.status==="completed"});ga&&ga.trim()!==""&&(l=l.filter(u=>u.senderPhone&&u.senderPhone.includes(ga)||u.receiverPhone&&u.receiverPhone.includes(ga)));const o=bs.filterVisibleTransactions(l,"monthly",s==null?void 0:s.uid),m=o.length,x=o.reduce((u,g)=>u+g.amount,0),y=o.filter(Or).reduce((u,g)=>{const I=g.withdrawnAmount!==void 0?g.withdrawnAmount:g.amount;return u+I},0),S=o.filter(Er).reduce((u,g)=>{const I=g.sentAmount!==void 0?g.sentAmount:g.amount;return u+I},0);return{totalTransactions:m,totalAmount:x,totalWithdrawn:y,totalSent:S}},Lm=t=>{const a=new Date().getMonth(),r=new Date().getFullYear(),l=Ze.filter(x=>{const y=new Date(x.createdAt);return y.getMonth()===a&&y.getFullYear()===r&&x.status==="completed"&&x.fromWallet===t}),o=l.filter(Or).reduce((x,y)=>{const S=y.withdrawnAmount||y.amount;return x+S},0),m=l.filter(Er).reduce((x,y)=>{const S=y.sentAmount||y.amount;return x+S},0);return{totalWithdrawn:o,totalTransferred:m}},$m=t=>{const a=new Date,r=a.getDate(),l=a.getMonth(),o=a.getFullYear(),m=Ze.filter(S=>{const u=new Date(S.createdAt);return u.getDate()===r&&u.getMonth()===l&&u.getFullYear()===o&&S.status==="completed"&&S.fromWallet===t}),x=m.filter(Or).reduce((S,u)=>{const g=u.withdrawnAmount||u.amount;return S+g},0),y=m.filter(Er).reduce((S,u)=>{const g=u.sentAmount||u.amount;return S+g},0);return{totalWithdrawn:x,totalTransferred:y}},Wo=Ke.useMemo(()=>Lr(),[Ze,X,ga]);Wo.totalWithdrawn,Wo.totalSent;const fa=Ke.useMemo(()=>Lm(X),[Ze,X]);n.useEffect(()=>{try{if(!X||He.length===0)return;const t=He.find(P=>P.id===X);if(!t)return;const a=(tt==null?void 0:tt.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,r=(tt==null?void 0:tt.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,l=parseFloat(ns||"0")||0,o=(fa==null?void 0:fa.totalWithdrawn)??(tt==null?void 0:tt.monthlyWithdrawUsed)??0,m=(fa==null?void 0:fa.totalTransferred)??(tt==null?void 0:tt.monthlyTransferUsed)??0,x=o+(re==="withdraw"?l:0),y=m+(re==="transfer"?l:0),S=.85,u=Math.floor(Math.max(a,1)*S),g=Math.floor(Math.max(r,1)*S),I=(()=>{const P=new Date;return`${P.getFullYear()}-${String(P.getMonth()+1).padStart(2,"0")}`})(),T=`monthlyLimitWarnShown:${X}:${I}`;if(x>=u){const P=`${T}:withdraw`;if(!(localStorage.getItem(P)==="true")){bl({type:"withdraw",used:x,limit:a,walletName:t.name}),tn(!0);try{localStorage.setItem(P,"true")}catch{}return}}if(y>=g){const P=`${T}:transfer`;if(!(localStorage.getItem(P)==="true")){bl({type:"transfer",used:y,limit:r,walletName:t.name}),tn(!0);try{localStorage.setItem(P,"true")}catch{}return}}}catch{}},[X,He,tt,fa,re,ns]);const Fo=async()=>{var Jn,Kn,$r,Ko;Eu(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:Gt,receiverPhone:js,amount:ns,transactionType:re});const t=()=>{re==="transfer"?ar(!0):br(!0)},a=()=>{re==="transfer"?ar(!1):br(!1)};if(t(),!Gt||!ns){console.log("❌ خطأ: بيانات ناقصة"),i({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),a();return}if(re==="transfer"&&!js&&!R){console.log("❌ خطأ: رقم المستقبل مفقود"),i({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),a();return}if(re==="transfer"&&!R&&!Mu(js)){i({title:"رقم المستقبل غير صالح",description:"اكتب رقم صحيح مكون من 11 رقم ويبدأ بـ 015 أو 010 أو 012 أو 011",variant:"destructive"}),a();return}const r=parseFloat(ns);if(console.log("💰 المبلغ المحول:",r),r<=0){console.log("❌ خطأ: مبلغ غير صحيح"),i({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),a();return}if(At)try{const Be=new Date,ut=Be.getFullYear(),_t=String(Be.getMonth()+1).padStart(2,"0"),ys=String(Be.getDate()).padStart(2,"0"),Js=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${ut}-${_t}-${ys}`,Rs=localStorage.getItem(Js);if((Rs&&parseInt(Rs,10)||0)>=10){i({title:"حد التأكيد اليومي",description:"باقة زيرو تسمح بـ 10 تأكيدات تحويل/سحب يومياً فقط.",variant:"destructive"}),a();return}}catch(Be){console.warn("فشل قراءة عداد تأكيدات باقة زيرو من التخزين المحلي:",Be)}const l=He.find(Be=>Be.id===X);if(!l){i({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),a();return}const o=fa;if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:X,walletName:l.name,currentWithdrawn:o.totalWithdrawn,currentTransferred:o.totalTransferred,withdrawalLimit:l.monthlyWithdrawalLimit,transferLimit:l.monthlyTransferLimit}),re==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${o.totalWithdrawn}, المبلغ الجديد: ${r}, الحد الأقصى: ${l.monthlyWithdrawalLimit}`),o.totalWithdrawn+r>l.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),i({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${l.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${o.totalTransferred}, المبلغ الجديد: ${r}, الحد الأقصى: ${l.monthlyTransferLimit}`),o.totalTransferred+r>l.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),i({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${l.monthlyTransferLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}const m=(j==null?void 0:j.shopName)||(s==null?void 0:s.displayName)||"محل كاشي لينك",x={id:Date.now().toString(),type:re==="transfer"?"send":re==="deposit"?"deposit":"withdraw",senderPhone:Gt,receiverPhone:re==="transfer"?js:Gt,amount:r,status:"completed",createdAt:new Date,withdrawnAmount:re==="withdraw"?r:void 0,sentAmount:re==="transfer"?r:void 0,depositedAmount:void 0,fromWallet:X,senderNumber:Gt,senderName:Gt,shopName:(l==null?void 0:l.name)||"المحفظة الرئيسية",transferredAmount:re==="transfer"?r:void 0,receiverNumber:re==="transfer"?js:void 0,withdrawnAmountDetailed:re==="withdraw"?r:void 0,depositedAmountDetailed:void 0,merchantShopName:m,transactionReference:`TXN-${Date.now()}`,commission:0,notes:re==="transfer"?void 0:ua&&ua.trim()!==""?ua.trim():void 0};f&&(N!=null&&N.name||N!=null&&N.username)&&(x.cashierName=(N==null?void 0:N.name)||(N==null?void 0:N.username));const y=mr.validateTransaction(r,re,Tt,it);if(!y.isValid){i({title:"خطأ في العملية",description:y.error,variant:"destructive"}),a();return}y.warning&&i({title:"تحذير",description:y.warning,variant:"destructive"});let S;if(re==="transfer")if((l==null?void 0:l.defaultTransferCommission)!=null){const Be=Number(l.defaultTransferCommission)||0;S=Math.round(Be*r/1e3*100)/100}else xs&&xs.trim()!==""?S=Math.max(0,parseFloat(xs)):S=0;else if((l==null?void 0:l.defaultWithdrawCommission)!=null){const Be=Number(l.defaultWithdrawCommission)||0;S=Math.round(Be*r/1e3*100)/100}else es&&es.trim()!==""?S=Math.max(0,parseFloat(es)):S=Math.round(r*.01*100)/100;if(x.commission=S,re!=="transfer"&&!yt&&S>=r){i({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),a();return}const u=re==="transfer"||yt?r:Math.round((r-S)*100)/100;x.amount=u,x.withdrawnAmount=re==="withdraw"?u:void 0,x.sentAmount=re==="transfer"?u:void 0,x.transferredAmount=re==="transfer"?u:void 0,x.withdrawnAmountDetailed=re==="withdraw"?u:void 0;let g;const I=re==="transfer"&&!!ft,T=re==="withdraw"&&!!ft,P=I||T;let Y=null;const Fe=sn(Gt||"").replace(/\D/g,""),ue=sn(js||"").replace(/\D/g,""),se=re==="transfer"&&(Fe.startsWith("010")&&(ue.startsWith("011")||ue.startsWith("012")||ue.startsWith("015"))||Fe.startsWith("012")&&ue.startsWith("010")||Fe.startsWith("011")&&ue.startsWith("010")||Fe.startsWith("015")&&ue.startsWith("010")),xe=se?Math.max(0,parseFloat(yl||"0")):0,Ms=Math.round(S*100)/100;if(x.commission=Ms,x.fee=xe,x.totalCharged=re==="transfer"?Number(u)+Number(Ms)+Number(xe):yt?Number(u)+Number(Ms):Number(u),se&&!P&&xe<=0){i({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"}),a();return}if(re==="transfer"&&!P){const Be=Number(it[X]||0),ut=Number(u)+Number(xe);if(Be<ut){i({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${Be} لا يكفي لخصم ${ut}`,variant:"destructive"}),a();return}}if(P)if(I){const Be=mr.validateTransaction(u,"transfer",Tt,it);if(!Be.isValid)g={success:!1,newCashBalance:Tt,newWalletBalances:it,message:Be.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"};else{const ut=X||((Jn=He.find(pt=>pt.isDefault))==null?void 0:Jn.id)||((Kn=He[0])==null?void 0:Kn.id),_t=tt??await Ks.getWalletLimits(ut),ys=new Date().toDateString(),Js=Ze.filter(pt=>pt.type==="send"&&String(pt.status||"").toLowerCase()==="pending"&&pt.fromWallet===ut&&new Date(pt.createdAt).toDateString()===ys).reduce((pt,Bs)=>pt+Number(Bs.sentAmount??Bs.transferredAmount??Bs.amount??0),0),Rs=Number((_t==null?void 0:_t.dailyTransferLimit)??6e4),la=Number((_t==null?void 0:_t.dailyTransferUsed)??0);if(la+Js+Number(u)>Rs){i({title:"تجاوز الحد اليومي للتحويل",description:`المتبقي اليوم: ${(Rs-la-Js).toLocaleString()} ج.م`,variant:"destructive"}),a();return}const Ta=new Date,Wr=Ze.filter(pt=>pt.type==="send"&&String(pt.status||"").toLowerCase()==="pending"&&pt.fromWallet===ut&&new Date(pt.createdAt).getMonth()===Ta.getMonth()&&new Date(pt.createdAt).getFullYear()===Ta.getFullYear()).reduce((pt,Bs)=>pt+Number(Bs.sentAmount??Bs.transferredAmount??Bs.amount??0),0),Fr=Number((_t==null?void 0:_t.monthlyTransferLimit)??2e5),rl=Number((_t==null?void 0:_t.monthlyTransferUsed)??0);if(rl+Wr+Number(u)>Fr){i({title:"تجاوز الحد الشهري للتحويل",description:`المتبقي هذا الشهر: ${(Fr-rl-Wr).toLocaleString()} ج.م`,variant:"destructive"}),a();return}g={success:!0,newCashBalance:Tt,newWalletBalances:it}}}else{const Be=X||(($r=He.find(pt=>pt.isDefault))==null?void 0:$r.id)||((Ko=He[0])==null?void 0:Ko.id),ut=tt??await Ks.getWalletLimits(Be),_t=new Date().toDateString(),ys=Ze.filter(pt=>pt.type==="withdraw"&&String(pt.status||"").toLowerCase()==="pending"&&pt.fromWallet===Be&&new Date(pt.createdAt).toDateString()===_t).reduce((pt,Bs)=>pt+Number(Bs.withdrawnAmount??Bs.amount??0),0),Js=Number((ut==null?void 0:ut.dailyWithdrawLimit)??1e5),Rs=Number((ut==null?void 0:ut.dailyWithdrawUsed)??0);if(Rs+ys+Number(u)>Js){i({title:"تجاوز الحد اليومي للسحب",description:`المتبقي اليوم: ${(Js-Rs-ys).toLocaleString()} ج.م`,variant:"destructive"}),a();return}const la=new Date,Ta=Ze.filter(pt=>pt.type==="withdraw"&&String(pt.status||"").toLowerCase()==="pending"&&pt.fromWallet===Be&&new Date(pt.createdAt).getMonth()===la.getMonth()&&new Date(pt.createdAt).getFullYear()===la.getFullYear()).reduce((pt,Bs)=>pt+Number(Bs.withdrawnAmount??Bs.amount??0),0),Wr=Number((ut==null?void 0:ut.monthlyWithdrawLimit)??2e5),Fr=Number((ut==null?void 0:ut.monthlyWithdrawUsed)??0);if(Fr+Ta+Number(u)>Wr){i({title:"تجاوز الحد الشهري للسحب",description:`المتبقي هذا الشهر: ${(Wr-Fr-Ta).toLocaleString()} ج.م`,variant:"destructive"}),a();return}g={success:!0,newCashBalance:Math.round((Number(Tt)-Number(u))*100)/100,newWalletBalances:it}}else re==="transfer"?g=await mr.processTransfer({amount:u,currentCashBalance:Tt,currentWalletBalances:it,wallets:He,selectedWalletId:X,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0}):g=await mr.processWithdraw({amount:u,currentCashBalance:Tt,currentWalletBalances:it,wallets:He,selectedWalletId:X,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0});if(!g.success){i({title:"فشل في العملية",description:g.error||g.message,variant:"destructive"}),a();return}let ea=P?T?g.newCashBalance:Tt:g.newCashBalance,ia=P?it:g.newWalletBalances;if(!P&&re==="transfer"&&xe>0){const Be=Number(ia[X]||0);ia={...ia,[X]:Math.round((Be-Number(xe))*100)/100}}if(P&&I){const Be=He.find(ys=>ys.id===X)??He.find(ys=>ys.isDefault)??He[0],ut=(Be==null?void 0:Be.id)||X;if(ut!==X)try{Un(ut)}catch{}const _t=Number(it[ut]||0);ia={...it,[ut]:Math.round((_t-Number(u)-Number(xe))*100)/100}}if((I||T)&&ft&&!Zs){const Be={id:`DEBT-${Date.now()}`,debtorName:ft.debtorName,amount:ft.amount,reason:ft.notes||"",customerId:ft.customerId,mobile:ft.mobile,status:"pending",createdAt:new Date};Y=Be.id;const ut=[Be,...Wt];_s(ut);try{await Vs(ut)}catch(_t){console.error("⚠️ فشل حفظ الدين المؤجل محلياً:",_t)}i({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}if(!P){const Be=Math.max(0,Number(S))+Math.max(0,Number(xe));Be>0&&(ea=Math.round((ea+Be)*100)/100,console.log(`💰 تم إضافة عمولة/رسوم ${Be} جنيه لدرج النقدية`))}console.log("⚡ تحديث الواجهة فوراً بدون حجب باستخدام startTransition...");const Vn=[x,...Ze];Ke.startTransition(()=>{Kt(ea),ds(ia),P&&(x.status="pending"),xa(Vn)});try{setTimeout(()=>{try{localStorage.setItem(Yi(),JSON.stringify(Vn))}catch{}},0)}catch{}if(At)try{const Be=new Date,ut=Be.getFullYear(),_t=String(Be.getMonth()+1).padStart(2,"0"),ys=String(Be.getDate()).padStart(2,"0"),Js=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${ut}-${_t}-${ys}`,Rs=localStorage.getItem(Js),la=Rs&&parseInt(Rs,10)||0;localStorage.setItem(Js,String(la+1))}catch{}if(setTimeout(()=>{try{localStorage.setItem(Cs(),ea.toString()),localStorage.setItem(Ds(),JSON.stringify(ia))}catch{}},0),(async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const Be={shopId:k||(j==null?void 0:j.shopId)||(s==null?void 0:s.uid)||"default-shop",lineId:X||"default-line",walletId:X||void 0,merchantUserId:(s==null?void 0:s.uid)||null,provider:"vodafone_cash",txnType:re==="transfer"?"send":"receive",originType:re==="transfer"?"transfer":"withdraw",amount:u,commission:Ms,fee:xe,profit:0,senderMsisdn:Gt,receiverMsisdn:re==="transfer"?js:Gt,note:re==="transfer"?void 0:ua&&ua.trim()!==""?ua.trim():void 0,status:P?"pending":"confirmed",linkedDebtId:Y||void 0,createdBy:(s==null?void 0:s.uid)||null,walletEffectAppliedOnCreation:!1,cashEffectAppliedOnCreation:!!(P&&T),limitsReservedOnCreation:!!P,limitReservedType:re==="transfer"?"transfer":"withdraw"},ut={...Be,status:P?"pending":"completed",commissionMode:re==="transfer"||yt?"add":"deduct",totalCharged:re==="transfer"?u+Ms+xe:yt?u+S:u,walletEffectAppliedOnCreation:!1,cashEffectAppliedOnCreation:!!(P&&T),limitsReservedOnCreation:!!P,limitReservedType:re==="transfer"?"transfer":"withdraw",sentAmount:re==="transfer"?u:void 0,transferredAmount:re==="transfer"?u:void 0,withdrawnAmount:re==="withdraw"?u:void 0,createdAt:new Date},{ProfitService:_t}=await bt(async()=>{const{ProfitService:Ta}=await import("./profitService-C6ong2ih.js");return{ProfitService:Ta}},__vite__mapDeps([4,0,1]),import.meta.url),ys=_t.calculateProfitFromTransaction(ut);!P&&ys>0&&(_t.addProfit(ys,s==null?void 0:s.uid),console.log("✅ تم إضافة الربح:",ys,"جنيه"));const Js=await ti.create(Be);if(X)try{await Ks.updateUsage(X,u,re==="transfer"?"transfer":"withdraw");try{window.dispatchEvent(new CustomEvent("walletLimitsUpdated",{detail:{walletId:X}}))}catch{}try{await sl()}catch{}}catch{}await Promise.all([...s!=null&&s.uid?[pe.updateUserData(s.uid,{cashBalance:ea,walletBalances:ia,lastUpdated:new Date().toISOString()})]:[],...s!=null&&s.uid?[pe.saveUserTransaction(s.uid,{...ut,transactionType:re,fromWallet:X,toWallet:re==="transfer"?I?null:"cash":null,cashierName:f&&((N==null?void 0:N.name)||(N==null?void 0:N.username))||"الحساب الرئيسي",linkedDebtId:Y||void 0,transactionId:Js,description:`${re==="transfer"?"تحويل":"سحب"} ${u} من ${X} ${re==="transfer"?I?"":"إلى الدرج النقدي":""} — عمولة: ${S} (${re==="transfer"||yt?"مضافة":"مخصومة"})${xe>0?` — رسوم: ${xe}`:""}${P?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");const Rs=`userData_${s==null?void 0:s.uid}`,la={cashBalance:ea,walletBalances:ia,lastUpdated:new Date().toISOString()};localStorage.setItem(Rs,JSON.stringify(la))}catch(Be){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",Be);try{s!=null&&s.uid&&pe.saveLocalReceipt(s.uid,{...transactionDataForUser,transactionType:re,fromWallet:X,toWallet:re==="transfer"?I?null:"cash":null,cashierName:f&&((N==null?void 0:N.name)||(N==null?void 0:N.username))||"الحساب الرئيسي",linkedDebtId:Y||void 0,description:`${re==="transfer"?"تحويل":"سحب"} ${u} من ${X} ${re==="transfer"?I?"":"إلى الدرج النقدي":""} — عمولة: ${S} (${re==="transfer"||yt?"مضافة":"مخصومة"})${xe>0?` — رسوم: ${xe}`:""}${P?" — دين مؤجل (قيد المراجعة)":""}`})}catch{}i({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),re==="transfer"){ar(!0);const Be=Number(r)+Number(S)+Math.max(0,Number(xe));mi({type:"transfer",amount:Math.max(0,Math.round(Be*100)/100)}),fd({receiver:js,amount:r}),Va(!0),setTimeout(()=>{ar(!1)},2e3)}else{br(!0);const Be=yt?Number(r):Math.max(0,Math.round((Number(r)-Number(S))*100)/100);mi({type:"withdraw",amount:Math.max(0,Math.round(Be*100)/100)}),Va(!0),setTimeout(()=>{br(!1)},2e3)}za(""),ha(""),c(""),Ps(null),z(""),Me(""),We(""),zs(!1)},qn=Ke.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),Ro=Ke.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),Wm=Ke.useMemo(()=>{try{return Wt.reduce((t,a)=>{const r=Number(a.paidAmount||0),l=Math.max(0,Number(a.amount||0)-r);return t+l},0)}catch{return 0}},[Wt]),al=Ke.useMemo(()=>Eo().filter(a=>pa==="all"?!0:pa==="send"?a.type==="send":pa==="receive"?a.type==="receive":pa==="withdraw"?a.type==="withdraw":pa!=="deleted"),[Eo,pa]),Fm=()=>{if(ci==="daily"){const t=bs.resetReportsManually("daily",Ze,s==null?void 0:s.uid);yr(!1),i({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${t.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const t=bs.resetReportsManually("monthly",Ze,s==null?void 0:s.uid);yr(!1),i({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${t.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},Rm=()=>ci==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",Bm=()=>ci==="daily"?"أدخل الرقم السري الرئيسي لتصفير جميع معاملات اليوم":"أدخل الرقم السري الرئيسي لتصفير جميع معاملات الشهر",Um=t=>{Do(t),Wi(!0)},zm=t=>{const a=Tt,r=Number(t)-Number(a);Kt(t),localStorage.setItem(Cs(),t.toString()),ho(!1);const l={cashBalance:t,lastUpdated:new Date().toISOString()},o=`userData_${s==null?void 0:s.uid}`;try{localStorage.setItem(o,JSON.stringify(l))}catch{}const m=[];if(s!=null&&s.uid){m.push(pe.updateUserData(s.uid,l).then(()=>{try{localStorage.removeItem(o)}catch{}}).catch(()=>{}));const x=`${r>0?"CASHADD":"CASHDEDUCT"}-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`,y=r>0?{txnType:"cash_addition",type:"cash_addition",amount:r,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:x,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(j==null?void 0:j.shopId)||void 0}:r<0?{amount:Math.abs(r),status:"completed",title:"ايصال خصم من الفلوس النقديه",merchantUserId:s.uid,createdBy:s.uid,shopId:(j==null?void 0:j.shopId)||void 0}:null;y&&m.push(pe.saveUserTransaction(s.uid,y));const S=j==null?void 0:j.shopId;if(S){const u=Ve(V,"dashboardData",S);m.push(ts(u,{cashBalance:t}))}}Promise.allSettled(m).then(()=>{}).catch(()=>{}),i({title:r>0?"تم إضافة نقدية":r<0?"تم خصم نقدية":"تم تحديث الرصيد النقدي",description:r!==0?`التغيير: ${Math.abs(r)} جنيه، الرصيد الجديد: ${t} جنيه`:`تم تحديث الرصيد النقدي إلى ${t} جنيه`})},qm=async t=>{var x;if(!Es){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const a={...it,[Es]:t};ds(a);const r=new Date().toISOString(),l={walletBalances:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;try{localStorage.setItem(o,JSON.stringify(l)),localStorage.setItem(Ds(),JSON.stringify(a)),localStorage.setItem(`walletBalances_backup_${r}`,JSON.stringify(a))}catch{}try{s!=null&&s.uid&&await pe.updateUserData(s.uid,l)}catch(y){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",y)}uo(!1);const m=((x=He.find(y=>y.id===Es))==null?void 0:x.name)||"المحفظة";i({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${m} إلى ${t.toLocaleString()} جنيه`})},Vm=async t=>{var a;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",Es),console.log("💵 المبلغ المضاف/المخصوم:",t),Es){const r=it[Es]||0;console.log("💰 الرصيد الحالي:",r);const l=r+t;console.log("💰 الرصيد الجديد:",l);const o={...it,[Es]:l};console.log("📊 الأرصدة المحدثة:",o),ds(o);const m=new Date().toISOString(),x={walletBalances:o,lastUpdated:m},y=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(y,JSON.stringify(x)),localStorage.setItem(Ds(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${m}`,JSON.stringify(o));try{if(s!=null&&s.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await pe.updateUserData(s.uid,x),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(y),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(I){console.error("❌ فشل في حفظ البيانات في Firebase:",I),Ge(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(Ds(),JSON.stringify(o));const S=((a=He.find(I=>I.id===Es))==null?void 0:a.name)||"المحفظة",u=t>0?"إضافة":"خصم",g=Math.abs(t);i({title:`تم ${u} مبلغ ${u==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${u} ${g} جنيه ${u==="إضافة"?"إلى":"من"} رصيد ${S}. الرصيد الجديد: ${l.toLocaleString()} جنيه`})}catch(S){if(console.error("❌ فشل في حفظ البيانات في Firebase:",S),localStorage.setItem(Ds(),JSON.stringify(o)),s!=null&&s.uid){const u=`userData_${s.uid}`,g={walletBalances:o,lastUpdated:new Date().toISOString()};localStorage.setItem(u,JSON.stringify(g)),Ge(!0)}i({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const l=Object.keys(localStorage).filter(o=>o.startsWith("walletBalances_backup_")).sort();l.length>5&&l.slice(0,l.length-5).forEach(m=>{localStorage.removeItem(m),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",m)})},5e3),Wi(!1),Do("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:Nt,isUserActive:Mt,showActivationModal:rs}),!Nt&&!Mt?(console.log("🔥 UserDashboardPage - Showing activation modal"),e.jsx("div",{className:"user-dashboard min-h-screen bg-background flex items-center justify-center",children:e.jsx(ic,{isOpen:!0,onClose:()=>{}})})):Nt?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx(mh,{})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"user-dashboard min-h-screen px-2 sm:px-4 py-2 sm:py-4 relative bg-gray-50 bg-[radial-gradient(140%_140%_at_10%_10%,#f3f4f6_0%,#e5e7eb_45%,#d1d5db_100%)]",children:[e.jsx(Lu,{userId:s==null?void 0:s.uid}),e.jsxs("div",{className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!vr&&e.jsxs(Et,{className:"monthly-stats-card bg-gradient-to-br from-purple-50 via-purple-25 to-white border border-purple-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-500/5 to-purple-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-purple-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(hs,{className:"monthly-stats-header pb-2 sm:pb-1 lg:pb-1 px-3 sm:px-3 lg:px-2 pt-3 sm:pt-2 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ts,{className:"text-xs font-bold text-purple-800 flex items-center gap-1.5 sm:gap-1",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-2 h-2.5 sm:h-2 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-2 h-2.5 sm:h-2 bg-purple-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1",children:[e.jsx("div",{className:"hidden"}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>{Dl("monthly"),yr(!0)},className:"monthly-stat-action h-7 w-7 sm:h-6 sm:w-6 p-0 bg-white/60 backdrop-blur-md border border-white/50 text-purple-700 hover:bg-white hover:text-purple-900 rounded-xl transition-all duration-300 hover:scale-110 shadow-[0_8px_16px_-6px_rgba(124,58,237,0.35)] ring-1 ring-purple-200",title:"تصفير معاملات الشهر",children:e.jsx(ms,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5"})}),e.jsx("div",{className:"monthly-stat-action p-1.5 sm:p-1 bg-gradient-to-br from-purple-500/20 to-pink-500/20 border border-white/50 backdrop-blur-md rounded-xl shadow-[0_8px_16px_-6px_rgba(236,72,153,0.35)]",children:e.jsx(Ur,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5 text-purple-700"})})]})]})}),!vr&&e.jsxs(Ft,{className:"space-y-0.5 sm:space-y-1 lg:space-y-0 pt-0 px-2 sm:px-3 lg:px-2 pb-1.5 sm:pb-2 lg:pb-1 relative z-10",children:[e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Lr().totalTransactions})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Lr().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"المسحوب:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Lr().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"المرسل:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Lr().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"الأرباح:"}),e.jsx(Su,{userId:s==null?void 0:s.uid,transactions:Ze})]})]}),Cd&&e.jsx("div",{className:"monthly-overlay absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:async()=>{if(At){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}un(!0)},className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-black hover:from-yellow-600 hover:to-yellow-700 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(Rt,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(gs,{open:Ad,onOpenChange:un,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(At){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),un(!1),Fl(!0);return}Fl(!1),un(!1)},userId:s==null?void 0:s.uid}),((Bo=Xt==null?void 0:Xt.subscription)==null?void 0:Bo.planType)!==Is.TAHWEELA&&e.jsxs(Et,{className:"daily-stats-card bg-gradient-to-br from-blue-50 via-blue-25 to-white border border-blue-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 to-blue-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-blue-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(hs,{className:"daily-stats-header pb-2 sm:pb-3 lg:pb-1 px-3 sm:px-4 lg:px-2 pt-3 sm:pt-4 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ts,{className:"text-sm sm:text-base font-bold text-blue-800 flex items-center gap-1.5 sm:gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-3 h-2.5 sm:h-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-3 h-2.5 sm:h-3 bg-blue-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs sm:text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5",children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>{Dl("daily"),yr(!0)},className:"daily-stat-action h-7 w-7 sm:h-8 sm:w-8 p-0 bg-white/60 backdrop-blur-md border border-white/50 text-blue-700 hover:bg-white hover:text-blue-900 rounded-xl transition-all duration-300 hover:scale-110 shadow-[0_8px_16px_-6px_rgba(59,130,246,0.35)] ring-1 ring-blue-200",title:"تصفير معاملات اليوم",children:e.jsx(ms,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>Id(t=>!t),className:"daily-stat-action h-7 w-7 sm:h-8 sm:w-8 p-0 bg-white/60 backdrop-blur-md border border-white/50 text-blue-700 hover:bg-white hover:text-blue-900 rounded-xl transition-all duration-300 hover:scale-110 shadow-[0_8px_16px_-6px_rgba(59,130,246,0.35)] ring-1 ring-blue-200",title:vr?"توسيع اليوم والشهر":"طي اليوم والشهر",children:vr?e.jsx(Yr,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"}):e.jsx(Hn,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-br from-blue-500/20 to-emerald-500/20 border border-white/50 backdrop-blur-md rounded-xl shadow-[0_8px_16px_-6px_rgba(16,185,129,0.35)]",children:e.jsx(Ur,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-blue-700"})})]})]})}),!vr&&e.jsxs(Ft,{className:"space-y-0 pt-0 px-2 pb-1 relative z-10",children:[e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Mr().totalTransactions})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Mr().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"المسحوب:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Mr().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from_gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"المرسل:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Mr().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"الأرباح:"}),e.jsx(Iu,{userId:s==null?void 0:s.uid,transactions:Ze})]})]}),Od&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:()=>xi(!0),className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير اليوم (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير اليوم"}),e.jsx(Rt,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(gs,{open:Ed,onOpenChange:xi,mode:"verify",title:"الرقم السري لفتح تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Ul(!1),xi(!1)},userId:s==null?void 0:s.uid})]}),e.jsxs(Et,{className:"balance-bar bg-white border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(Ft,{className:"p-3 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-emerald-50 border-2 border-emerald-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/cash relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx(Yt,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-emerald-800",children:"الفلوس النقدية"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-emerald-700 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Tt.toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Ir(!0),children:e.jsx(vs,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Io(!0),title:"تفاصيل الفلوس النقدية",children:e.jsx(ac,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>Rn(!0),children:e.jsx(ms,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/wallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(oa,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-blue-800",children:"الأرصدة علي المحافظ"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-blue-700 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Object.values(it).reduce((t,a)=>t+a,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Mn(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(vs,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{Wn(!0),Fn("")},title:"تصفير إجمالي المحفظة",children:e.jsx(ms,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-indigo-50 border-2 border-indigo-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/selwallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(oa,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-indigo-800",children:"رصيد المحفظه"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-indigo-700 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm",children:[(X&&it[X]||0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>{if(!X){i({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}Um(X)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(vs,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{if(!X){i({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}Nn(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(ms,{className:"h-2 w-2"})})]})]})]})]})})]}),e.jsxs(Et,{className:"bg-gradient-to-br from-gray-50 via-white to-slate-50 border border-gray-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-500/5 to-slate-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsxs(hs,{className:`pb-2 px-4 pt-4 relative z-10 ${F?"sticky top-0 z-20 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/60":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ts,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[!F&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-gray-100 to-slate-200 rounded-lg",children:e.jsx(Ur,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-600"})}),e.jsx("span",{className:"bg-gradient-to-r from-gray-600 to-slate-600 bg-clip-text text-transparent",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!F&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(yh,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx(U,{placeholder:"بحث...",value:Pl,onChange:t=>pd(t.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!F&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"تقسيط"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{if(At||zt){i({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"});return}cn(!0)},title:"إدارة التقسيط",children:e.jsx(hh,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-green-600 mb-1",children:"شحن"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 ring-3 ring-green-300 transition-all duration-200 hover:scale-105 active:bg-green-600 active:text-white active:border-green-600",onClick:()=>{i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."})},title:"شحن الرصيد",children:e.jsx(Gr,{className:"h-5 w-5 text-green-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>hi(!0),title:"آلة حاسبة",children:e.jsx(Nc,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{At||zt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):dn(!0)},title:"كروت الائتمان",children:e.jsx(Gr,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"تقاريرك"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:()=>{if(At||zt){i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"});return}vo(!0)},title:"تقاريرك",children:e.jsx(Uh,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:gm,title:f&&(N!=null&&N.name||N!=null&&N.username)?`بروفيل الوردية: ${(N==null?void 0:N.name)||(N==null?void 0:N.username)}`:"وردية الكاشير",children:e.jsx(hl,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{At||zt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):gr(!0)},title:"بيانات المبيعات",children:e.jsx(tc,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),Wt.filter(t=>t.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:Wt.filter(t=>t.status==="pending").length})]}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{Di()},title:"الديون",children:e.jsx(uh,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105 active:bg-amber-600 active:text-white active:border-amber-600",onClick:()=>{At||zt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):mn(!0)},title:"الصيانة",children:e.jsx(yc,{className:"h-5 w-5 text-amber-700"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-50 text-violet-700 hover:bg-violet-100 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105 active:bg-violet-700 active:text-white active:border-violet-700",onClick:()=>{!na||zt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):hn(!0)},title:"يومية المكنة",children:e.jsx(Cc,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105 active:bg-orange-600 active:text-white active:border-orange-600",onClick:()=>{At||zt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):ws.hasMasterPin()?Vt(!0):kt(!0)},title:"مصروفات المحل",children:e.jsx(Qr,{className:"h-5 w-5 text-orange-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-rose-600 mb-1",children:"النواقص"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-rose-50 text-rose-600 hover:bg-rose-100 border border-rose-200 ring-3 ring-rose-300 transition-all duration-200 hover:scale-105 active:bg-rose-600 active:text-white active:border-rose-600",onClick:()=>{At||zt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):ma(!0)},title:"النواقص",children:e.jsx(Go,{className:"h-5 w-5 text-rose-600"})})]})]})]})]}),!F&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"filters-bar flex items-center justify-center gap-3 bg-gray-50 rounded-md p-3 border border-gray-200",children:[e.jsx(h,{variant:"ghost",size:"sm",className:`btn-filter-send h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${pa==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>ii("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(h,{variant:"ghost",size:"sm",className:`btn-filter-withdraw h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${pa==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-50"}`,onClick:()=>ii("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(h,{variant:"ghost",size:"sm",className:`btn-filter-all h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${pa==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>ii("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(h,{variant:"ghost",size:"sm",className:"h-8 px-3 text-[12px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>Dr(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(ms,{className:"h-3.5 w-3.5 mr-1"}),"تصفير"]}),Cm>0&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),e.jsx(gs,{open:wd,onOpenChange:cn,mode:"verify",title:"فتح إدارة التقسيط",description:"أدخل الرقم السري الرئيسي للوصول إلى إدارة التقسيط",onSuccess:()=>{cn(!1),Wl(!0)}}),e.jsx(wh,{open:Nd,onOpenChange:Wl}),$l,e.jsxs(Ft,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:[al.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Ur,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):F?e.jsx("div",{className:"overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[310px]",children:e.jsx("div",{className:"space-y-2 pr-2",children:al.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all duration-200",onClick:()=>$o(t),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(Wa,{className:`h-4 w-4 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(Na,{className:"h-4 w-4 text-yellow-500"}),t.status==="failed"&&e.jsx(Zn,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`font-medium text-sm ${r||l?"text-gray-800":t.type==="send"?"text-green-700":"text-red-700"}`,children:r?"إيصال تسليم وردية":l?`إيصال إضافة نقدية - ${Ns(t.amount)} جنيه`:(t.type==="send"?"تحويل":"سحب")+` - ${Ns(t.amount)} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(t==null?void 0:t.cashierName)??"الحساب الرئيسي"]}),(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية"),o=(a==null?void 0:a.note)||(a==null?void 0:a.notes)||"";return e.jsx("p",{className:`text-xs ${r||l?"text-gray-500":t.type==="send"?"text-green-600":"text-red-500"}`,children:r?`تم التسليم إلى: ${t.receiverPhone}`:l?o?`ملاحظة: ${o}`:"تمت إضافة نقدية للدرج":`من ${t.senderPhone}${t.type==="send"?` إلى ${t.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[qn.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",Ro.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]})]}),e.jsx(Qt,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",className:`text-xs ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700 border-red-300":t.type==="send"?"bg-green-100 text-green-700 border-green-300":"":""}`,children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})}):e.jsx("div",{className:"overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[calc(100dvh-300px)]",children:e.jsx("div",{className:"space-y-2 pr-2",children:al.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all duration-200",onClick:()=>$o(t),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(Wa,{className:`h-4 w-4 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(Na,{className:"h-4 w-4 text-yellow-500"}),t.status==="failed"&&e.jsx(Zn,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`font-medium text-sm ${r||l?"text-gray-800":t.type==="send"?"text-green-700":"text-red-700"}`,children:r?"إيصال تسليم وردية":l?`إيصال إضافة نقدية - ${Ns(t.amount)} جنيه`:(t.type==="send"?"تحويل":"سحب")+` - ${Ns(t.amount)} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(t==null?void 0:t.cashierName)??"الحساب الرئيسي"]}),(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية"),o=(a==null?void 0:a.note)||(a==null?void 0:a.notes)||"";return e.jsx("p",{className:`text-xs ${r||l?"text-gray-500":t.type==="send"?"text-green-600":"text-red-500"}`,children:r?`تم التسليم إلى: ${t.receiverPhone}`:l?o?`ملاحظة: ${o}`:"تمت إضافة نقدية للدرج":`من ${t.senderPhone}${t.type==="send"?` إلى ${t.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[qn.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",Ro.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]})]}),e.jsx(Qt,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",className:`text-xs ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700 border-red-300":t.type==="send"?"bg-green-100 text-green-700 border-green-300":"":""}`,children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})}),F&&e.jsxs("div",{className:"mt-2 flex justify-end",children:[e.jsxs(h,{variant:"ghost",size:"sm",className:"h-7 px-2 text-[11px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>Dr(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(ms,{className:"h-3 w-3 mr-1"}),"تصفير"]}),(s==null?void 0:s.uid)&&localStorage.getItem(`recentTransactionsResetAt:${s.uid}`)&&e.jsx("span",{className:"inline-block h-1.5 w-1.5 rounded-full bg-red-500 ml-1 align-middle"})]})]})]})]}),e.jsx(Nh,{isOpen:ld,onClose:()=>rn(!1),transaction:od,onPrint:()=>window.print(),onDelete:ud,onComplete:xd}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full lg:w-[92%] xl:w-[95%] mx-auto",children:[e.jsxs(Et,{id:"transaction-section",className:"bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/50 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx(hs,{className:"sticky top-0 z-20 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ts,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Wa,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[St&&e.jsx("div",{className:"hidden md:flex items-center gap-1 bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 border border-emerald-200 text-emerald-800 text-sm transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:e.jsxs("span",{className:"text-sm font-semibold whitespace-nowrap",children:["تجربة: ",Jt," ",Jt>=3&&Jt<=10?"ساعات":Jt===2?"ساعتين":"ساعة"]})}),e.jsxs("div",{className:"top-icons-bar hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:[e.jsx(au,{}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"VIP",onClick:()=>ui(!0),children:e.jsx(Wh,{className:"h-5 w-5 text-yellow-500"})}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"إدارة الفروع",onClick:()=>{i({title:"قيد التطوير",description:"إدارة الفرع قيد التطوير حالياً"})},children:e.jsx(jc,{className:"h-5 w-5"})}),e.jsx(bh,{})]})]}),_m&&e.jsxs(h,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:_o,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx(Fh,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsx(ge,{open:_d,onOpenChange:ui,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(be,{children:"أفضل 10 عملاء هذا الشهر"})}),e.jsx("div",{className:"space-y-2",children:$n.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا توجد بيانات لهذا الشهر"}):$n.map((t,a)=>e.jsxs("div",{className:`flex items-center justify-between border rounded-md px-3 py-2 bg-white ${a===0?"bg-yellow-50 border-yellow-300":""}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qt,{variant:"outline",className:`min-w-[28px] justify-center ${a===0?"border-yellow-300 text-yellow-700 bg-yellow-50":""}`,children:a+1}),e.jsx("span",{className:`font-semibold ${a===0?"text-yellow-700":""}`,children:t.phone})]}),e.jsxs("div",{className:"text-sm text-gray-700 flex items-center gap-3",children:[e.jsxs("span",{children:["عدد: ",t.count]}),e.jsxs("span",{children:["إجمالي: ",t.total]}),e.jsx(h,{variant:"outline",size:"sm",className:"h-8",onClick:()=>Am(t),title:"إرسال واتساب",children:e.jsx(Qo,{className:"h-4 w-4"})})]})]},t.phone+a))}),e.jsx(lt,{children:e.jsx(h,{onClick:()=>ui(!1),children:"إغلاق"})})]})}),e.jsx(ge,{open:Td,onOpenChange:Rl,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(be,{children:"ربط بوت التلجرام"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{children:"Telegram Chat ID"}),e.jsx(U,{value:xn,onChange:t=>Pd(t.target.value),placeholder:"اكتب رقم المحادثة"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Z,{children:"إرسال يومي 12 صباحاً"}),e.jsx(Dh,{checked:Bl,onCheckedChange:t=>kd(!!t)})]})]}),e.jsxs(lt,{children:[e.jsx(h,{variant:"outline",onClick:()=>Rl(!1),children:"إغلاق"}),e.jsx(h,{onClick:async()=>{s!=null&&s.uid&&(await pe.updateUserData(s.uid,{telegramChatId:xn,telegramDailyEnabled:Bl}),i({title:"تم الحفظ"}))},children:"حفظ"}),e.jsx(h,{onClick:async()=>{if(!(s!=null&&s.uid)||!xn){i({title:"أدخل Chat ID"});return}const t=await Tm();try{const{sendTelegramMessage:a}=await bt(async()=>{const{sendTelegramMessage:r}=await Promise.resolve().then(()=>qh);return{sendTelegramMessage:r}},void 0,import.meta.url);await a({chatId:xn,text:t}),i({title:"تم الإرسال"})}catch{i({title:"تعذر الإرسال",description:"تحقق من ربط البوت",variant:"destructive"})}},children:"إرسال الآن"})]})]})}),e.jsx(ge,{open:Se,onOpenChange:he,children:e.jsxs(fe,{className:"sm:max-w-lg",children:[e.jsxs(ye,{children:[e.jsx(be,{children:"إدارة الفروع"}),e.jsx(ps,{children:"أضف فروع جديدة وأدِر الدخول لكل فرع"}),e.jsx("div",{className:"flex items-center justify-end gap-2 mt-2",children:e.jsx(h,{variant:"outline",size:"sm",onClick:()=>{try{const t=s!=null&&s.uid?`selectedShopId_${s.uid}`:"selectedShopId";localStorage.removeItem(t);try{window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}i({title:"تم الخروج من الفرع"}),M(`/branch/${String(b.shopId)}/dashboard`)}catch{}},children:"الخروج من الفرع"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(Z,{children:"اسم المدير"}),e.jsx(U,{value:$e,onChange:t=>qe(t.target.value),placeholder:"اكتب اسم المدير"})]}),e.jsxs("div",{children:[e.jsx(Z,{children:"اسم الفرع"}),e.jsx(U,{value:_e,onChange:t=>Ye(t.target.value),placeholder:"اكتب اسم الفرع"})]}),e.jsxs("div",{children:[e.jsx(Z,{children:"اسم المستخدم للدخول"}),e.jsx(U,{value:Je,onChange:t=>dt(t.target.value),placeholder:"مثال: branch1"})]}),e.jsxs("div",{children:[e.jsx(Z,{children:"كلمة السر"}),e.jsx(U,{type:"password",value:ee,onChange:t=>we(t.target.value),placeholder:"••••••"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{qe(""),Ye(""),dt(""),we("")},children:"مسح"}),e.jsx(h,{className:"bg-indigo-600 hover:bg-indigo-700",disabled:rt,onClick:async()=>{if(!(s!=null&&s.uid))return;const t=$e.trim(),a=_e.trim(),r=Je.trim(),l=ee.trim();if(!t||!a||!r||!l){i({title:"يرجى ملء جميع الحقول"});return}if(de.length>=3){i({title:"عفواً",description:"لقد وصلت للحد الأقصى من الفروع (3 فروع)",variant:"destructive"});return}try{ie(!0);let o="";try{o=(await Hs(je(V,"shops"),{name:a,ownerId:s.uid,createdAt:xt(),updatedAt:xt(),isActive:!0})).id}catch{o=(await Hs(je(V,"users",s.uid,"shops"),{name:a,ownerId:s.uid,createdAt:xt(),updatedAt:xt(),isActive:!0})).id}const m=x=>{try{return btoa(unescape(encodeURIComponent(x)))}catch{return btoa(x)}};try{await Hs(je(V,"branches"),{ownerId:s.uid,shopId:o,branchName:a,managerName:t,loginUsername:r,passwordEncoded:m(l),createdAt:xt()})}catch{await Hs(je(V,"users",s.uid,"branches"),{ownerId:s.uid,shopId:o,branchName:a,managerName:t,loginUsername:r,passwordEncoded:m(l),createdAt:xt()})}try{const x=Ue(je(V,"branches"),ae("ownerId","==",s.uid));let S=(await Qe(x)).docs.map(u=>({id:u.id,...u.data()}));if(S.length===0){const u=Ue(je(V,"users",s.uid,"branches"));S=(await Qe(u)).docs.map(I=>({id:I.id,...I.data()}))}ne(S)}catch{try{const x=Ue(je(V,"users",s.uid,"branches")),S=(await Qe(x)).docs.map(u=>({id:u.id,...u.data()}));ne(S)}catch{}}qe(""),Ye(""),dt(""),we(""),i({title:"تم إضافة الفرع بنجاح"})}catch{i({title:"تعذّر إضافة الفرع"})}finally{ie(!1)}},children:"إضافة فرع"})]}),e.jsxs("div",{className:"border-t pt-3",children:[e.jsx("h4",{className:"text-sm font-semibold mb-2",children:"الفروع الحالية"}),rt?e.jsx("div",{className:"text-sm text-gray-500",children:"جارٍ التحميل..."}):de.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"لا يوجد فروع بعد"}):e.jsx("div",{className:"space-y-2",children:de.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-lg bg-white",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:t.branchName}),e.jsxs("div",{className:"text-gray-600",children:["مدير: ",t.managerName]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{size:"sm",className:"bg-blue-600 hover:bg-blue-700",onClick:()=>{Bt(t),Pe(String(t.loginUsername||"")),mt(""),vt(!0)},children:"دخول الفرع"}),e.jsx(h,{size:"sm",variant:"destructive",onClick:async()=>{if(confirm("هل أنت متأكد من حذف الفرع؟ سيتم حذف بيانات الفرع المرتبطة."))try{try{await As(Ve(V,"branches",t.id))}catch{}try{await As(Ve(V,"users",(s==null?void 0:s.uid)||"","branches",t.id))}catch{}if(t.shopId){try{await As(Ve(V,"shops",String(t.shopId)))}catch{}try{await As(Ve(V,"users",(s==null?void 0:s.uid)||"","shops",String(t.shopId)))}catch{}}ne(a=>a.filter(r=>r.id!==t.id)),i({title:"تم حذف الفرع"})}catch{i({title:"تعذّر حذف الفرع"})}},children:"حذف الفرع"})]})]},t.id))})]})]})]})}),e.jsx(ge,{open:Ce,onOpenChange:vt,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsxs(ye,{children:[e.jsx(be,{children:"دخول الفرع"}),e.jsx(ps,{children:"أدخل بيانات الدخول للفرع المحدد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(Z,{children:"اسم المستخدم"}),e.jsx(U,{value:as,onChange:t=>Pe(t.target.value),placeholder:"اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(Z,{children:"كلمة السر"}),e.jsx(U,{type:"password",value:et,onChange:t=>mt(t.target.value),placeholder:"••••••"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Pe(""),mt("")},children:"مسح"}),e.jsx(h,{className:"bg-blue-600 hover:bg-blue-700",disabled:De,onClick:async()=>{const t=ss;if(!t){vt(!1);return}const a=String(t.loginUsername||"");let r="";try{const m=String(t.passwordEncoded||"");r=m?decodeURIComponent(escape(atob(m))):""}catch{try{r=t.passwordEncoded?atob(String(t.passwordEncoded)):""}catch{r=""}}const l=as.trim(),o=et.trim();if(!l||!o){i({title:"يرجى إدخال اسم المستخدم وكلمة السر"});return}if(l!==a||o!==r){i({title:"بيانات الدخول غير صحيحة",variant:"destructive"});return}try{ht(!0);const m=s!=null&&s.uid?`selectedShopId_${s.uid}`:"selectedShopId";localStorage.setItem(m,String(t.shopId)),i({title:"تم الدخول إلى الفرع",description:String(t.branchName||"")}),vt(!1),he(!1),M("/user/dashboard")}catch{}ht(!1)},children:"دخول"})]})]})]})}),e.jsxs(Ft,{ref:p,className:"space-y-1 px-2 pb-2 relative z-10 transition-transform duration-200 ease-out will-change-transform",style:{transform:d?`translateY(${d}px)`:void 0},onFocusCapture:t=>{const a=t.target;if(!((a==null?void 0:a.id)==="transferExtraFeeInput")){v(0);return}const l=document.getElementById("transferSubmitButton");if(l){const o=l.getBoundingClientRect(),m=window.innerHeight;if(o.bottom>m){const x=o.bottom-m,y=Math.min(x,220);v(-y)}else v(0)}else v(0)},onBlurCapture:t=>{t.currentTarget.contains(t.relatedTarget)||v(0)},children:[e.jsxs("div",{className:"transaction-type-tabs grid grid-cols-2 gap-0.5 p-0.5 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-200/50 fade-in-up w-full lg:w-[92%] xl:w-[95%] mx-auto ",children:[e.jsxs(h,{variant:re==="transfer"?"default":"ghost",onClick:()=>zn("transfer"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${re==="transfer"?"bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg hover:shadow-md hover:from-blue-600 hover:to-indigo-700":"text-gray-600 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-700 hover:border-blue-200"}`,children:[e.jsx(Ur,{className:"h-1 w-1 mr-1"}),"تحويل"]}),e.jsxs(h,{variant:re==="withdraw"?"default":"ghost",onClick:()=>zn("withdraw"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${re==="withdraw"?"bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-lg hover:shadow-md hover:from-emerald-600 hover:to-green-700":"text-gray-600 hover:bg-gradient-to-r hover:from-emerald-50 hover:to-green-50 hover:text-emerald-700 hover:border-emerald-200"}`,children:[e.jsx(Xn,{className:"h-1 w-1 mr-1"}),"سحب"]})]}),e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(oa,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(h,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>M("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(vs,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(h,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>{Xs(!0)},title:"المحافظ",children:[e.jsx(oa,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),He.length>0?e.jsxs(_a,{value:X,onValueChange:Em,children:[e.jsx(Oa,{"data-testid":"wallet-select",className:"selected-number-card w-full h-12 text-sm bg-gradient-to-r from-white to-gray-50 border-2 border-gray-200 hover:border-blue-400 focus:border-blue-500 rounded-xl transition-all duration-300 hover:shadow-md focus:shadow-lg",children:e.jsx(Ea,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-600"})}),e.jsxs(Ma,{className:"rounded-xl border-2 border-gray-200 shadow-md z-[9999]",children:[e.jsx("div",{"data-fixed-header":"true",className:"sticky top-0 z-10 bg-white p-2 border-b border-gray-200",children:e.jsx(U,{value:Nl,onChange:t=>rd(t.target.value),placeholder:"ابحث برقم المحفظة",className:"h-6 text-xs"})}),e.jsx("div",{className:"pr-1",children:jl.length===0?e.jsx("div",{className:"text-xs text-gray-500 p-2",children:"لا توجد نتائج مطابقة"}):jl.map(t=>e.jsx(ta,{value:t.id,className:"rounded-lg hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200",children:e.jsxs("div",{className:"flex items-center gap-1 py-1 w-full justify-between",children:[e.jsx("div",{className:"p-1 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg",children:e.jsx(oa,{className:"h-1 w-1 text-blue-600"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-800",children:t.name}),e.jsxs("span",{className:"text-sm font-semibold text-red-600",children:["(",t.phone,")"]})]}),t.isDefault&&e.jsx(Qt,{variant:"secondary",className:"text-[10px] bg-gradient-to-r from-emerald-100 to-green-100 text-emerald-700 border-emerald-200",children:"افتراضي"})]}),e.jsx("div",{className:"ml-auto flex flex-col items-end gap-1"})]})},t.id))})]})]}):e.jsx("div",{className:"rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 px-3 py-3 text-xs text-gray-600",children:"لا توجد محافظ حتى الآن. اضغط “إضافة محفظة” لإضافة أول محفظة."})]}),e.jsx(ge,{open:qa,onOpenChange:Da,children:e.jsxs(fe,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(ye,{children:e.jsx(be,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(Mh,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),e.jsx(gs,{open:Ss,onOpenChange:Xs,mode:"verify",title:"الرقم السري لفتح المحافظ",description:"أدخل الرقم السري الرئيسي لعرض وإدارة المحافظ",onSuccess:()=>{Xs(!1),Da(!0)},userId:s==null?void 0:s.uid}),e.jsx(gs,{open:Xr,onOpenChange:t=>{en(t),t||pr(null)},mode:"verify",title:"تأكيد تغيير المحفظة",description:"أدخل الرقم السري الرئيسي لتغيير المحفظة المختارة",onSuccess:()=>{xr&&(Un(xr,"walletSelectionPin"),pr(null)),en(!1)},userId:s==null?void 0:s.uid}),e.jsx(ge,{open:Zc,onOpenChange:tn,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsxs(be,{className:"flex items-center gap-2 text-red-700",children:[e.jsx(Go,{className:"h-5 w-5 text-red-600"}),"تحذير حد شهري للمحفظة"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded-md border bg-red-50 border-red-200",children:[e.jsxs("p",{className:"text-sm text-red-800",children:["المحفظة: ",e.jsx("span",{className:"font-semibold",children:(qs==null?void 0:qs.walletName)||""})]}),e.jsxs("p",{className:"text-sm text-red-800",children:["الاستخدام الشهري (",(qs==null?void 0:qs.type)==="withdraw"?"سحب":"تحويل","):",e.jsxs("span",{className:"font-mono",children:[" ",Number((qs==null?void 0:qs.used)||0).toLocaleString("en-US")," "]})," جنيه"]}),e.jsxs("p",{className:"text-sm text-red-800",children:["الحد الشهري: ",e.jsx("span",{className:"font-mono",children:Number((qs==null?void 0:qs.limit)||0).toLocaleString("en-US")})," جنيه"]}),e.jsx("p",{className:"text-sm font-semibold text-red-900 mt-1",children:"تم الوصول إلى 85% من الحد الشهري — يرجى الحذر قبل الاستمرار."})]}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsx(h,{variant:"outline",onClick:()=>tn(!1),children:"حسناً"})})]})]})}),X&&He.length>0&&(()=>{var se;const t=He.find(xe=>xe.id===X),a=fa,r=$m(X),l=(tt==null?void 0:tt.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,o=(tt==null?void 0:tt.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,m=(tt==null?void 0:tt.monthlyWithdrawUsed)??a.totalWithdrawn??0,x=(tt==null?void 0:tt.monthlyTransferUsed)??a.totalTransferred??0,y=((se=Xt==null?void 0:Xt.subscription)==null?void 0:se.planType)===Is.TAHWEELA,S=y?0:(tt==null?void 0:tt.dailyWithdrawLimit)??1e5,u=y?0:(tt==null?void 0:tt.dailyTransferLimit)??6e4,g=y?0:(tt==null?void 0:tt.dailyWithdrawUsed)??r.totalWithdrawn??0,I=y?0:(tt==null?void 0:tt.dailyTransferUsed)??r.totalTransferred??0,T=parseFloat(ns||"0")||0,P=m+(re==="withdraw"?T:0),Y=x+(re==="transfer"?T:0),Fe=g+(re==="withdraw"?T:0),ue=I+(re==="transfer"?T:0);return t?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود الشهرية: ",co||(t==null?void 0:t.name)||"المحفظة المختارة"]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(P/Math.max(l,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Y/Math.max(o,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-red-600 font-medium",children:["متبقي سحب: ",Math.max(l-P,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(o-Y,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود اليومية: ",co||(t==null?void 0:t.name)||"المحفظة المختارة"]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Fe/Math.max(S,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(ue/Math.max(u,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(S-Fe,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(u-ue,0).toLocaleString("en-US")," جنيه"]})]})]})]}):null})(),re==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative",children:[e.jsx(wa,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{value:Gt,onChange:t=>tr(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("receiverPhoneInput");if(a)a.focus();else{const r=document.getElementById("amountInput");r==null||r.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),!R&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(wa,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{id:"receiverPhoneInput",value:js,onChange:t=>{za(t.target.value),di&&ar(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("amountInput");a==null||a.focus()}},inputMode:"numeric",maxLength:11,placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(wa,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{value:X&&((Uo=He.find(t=>t.id===X))==null?void 0:Uo.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base bg-gray-50 transition-all duration-300"})]})]}),re==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(Yt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{id:"amountInput",value:ns,onChange:t=>{ha(t.target.value),di&&ar(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("transferCommissionInput");if(a)a.focus();else{const r=document.getElementById("quickDebtButton");r==null||r.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),ft?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",ft.debtorName," بمبلغ ",ft.amount," جنيه"]}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>Ps(null),children:"إلغاء"})]}):null]}),(()=>{if(R)return null;const t=os();return t&&t.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",t==null?void 0:t.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(h,{id:"quickDebtButton",type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=os(),l=(r==null?void 0:r.defaultTransferCommission)!=null?Number(r.defaultTransferCommission):0,o=parseFloat(ns||"0")||0,m=Math.round((l||0)*o/1e3*100)/100,x=o+m;Me((x||0).toString()),At?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):O(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",className:"hidden",title:yt?"العمولة تُضاف":"العمولة تُخصم",children:yt?e.jsx(vs,{className:"h-4 w-4 text-green-600"}):e.jsx(Qa,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:yt?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Yt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(U,{id:"transferCommissionInput",value:xs,onChange:r=>ri(r.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=os(),l=parseFloat(ns||"0")||0;let o=0;if((r==null?void 0:r.defaultTransferCommission)!=null){const x=Number(r.defaultTransferCommission)||0;o=Math.round(x*l/1e3*100)/100}else{const x=xs&&xs.trim()!==""?parseFloat(xs):0;o=Math.max(0,x)}const m=l+o;Me((m||0).toString()),At?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):O(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",className:"hidden",title:yt?"العمولة تُضاف":"العمولة تُخصم",children:yt?e.jsx(vs,{className:"h-4 w-4 text-green-600"}):e.jsx(Qa,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:yt?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),(()=>{const t=sn(Gt||"").replace(/\D/g,""),a=sn(js||"").replace(/\D/g,"");return re==="transfer"&&(t.startsWith("010")&&(a.startsWith("011")||a.startsWith("012")||a.startsWith("015"))||t.startsWith("012")&&a.startsWith("010")||t.startsWith("011")&&a.startsWith("010")||t.startsWith("015")&&a.startsWith("010"))?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رسوم التحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Yt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(U,{id:"transferExtraFeeInput",value:yl,onChange:l=>Qc(l.target.value),placeholder:"أدخل رسوم التحويل",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"hidden",children:"تُخصم من المحفظة وتضاف للدرج — لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010"})]}):null})(),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(h,{id:"transferSubmitButton",onClick:Fo,className:"btn-transfer-confirm w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 text-white",children:di?"تم التحويل بنجاح":"تأكيد التحويل"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Xn,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-green-500"}),e.jsx(U,{id:"amountInput",value:ns,onChange:t=>{ha(t.target.value),El&&br(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("manualWithdrawCommissionInput");if(a)a.focus();else{const r=document.getElementById("withdrawSubmitButton");r==null||r.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),(()=>{const t=os();return t&&t.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",t==null?void 0:t.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=os(),l=parseFloat(ns||"0")||0,o=(r==null?void 0:r.defaultWithdrawCommission)!=null&&Number(r.defaultWithdrawCommission)||0,m=Math.round(o*l/1e3*100)/100,x=yt?l+m:l;Me((x||0).toString()),At?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):O(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>ni(r=>!r),title:yt?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:yt?e.jsx(vs,{className:"h-4 w-4"}):e.jsx(Qa,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:yt?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Yt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(U,{id:"manualWithdrawCommissionInput",value:es,onChange:r=>ai(r.target.value),onKeyDown:r=>{if(r.key==="Enter"){const l=document.getElementById("withdrawSubmitButton");l==null||l.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=os(),l=parseFloat(ns||"0")||0;let o=0;if((r==null?void 0:r.defaultWithdrawCommission)!=null){const x=Number(r.defaultWithdrawCommission)||0;o=Math.round(x*l/1e3*100)/100}else{const x=es&&es.trim()!==""?parseFloat(es):Math.round(l*.01*100)/100;o=Math.max(0,x)}const m=yt?l+o:l;Me((m||0).toString()),At?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):O(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",title:yt?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>ni(r=>!r),children:yt?e.jsx(vs,{className:"h-4 w-4 text-green-600"}):e.jsx(Qa,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:yt?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),(j==null?void 0:j.showWithdrawNote)&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"ملاحظة السحب (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Qo,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{id:"withdrawNoteInput",value:ua,onChange:t=>c(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("withdrawSubmitButton");a==null||a.focus()}},placeholder:"أدخل ملاحظة للسحب (اختياري)",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(h,{id:"withdrawSubmitButton",onClick:Fo,className:"w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:El?"تم السحب بنجاح":"تأكيد السحب"})})]}),e.jsx(ge,{open:A,onOpenChange:O,children:e.jsxs(fe,{children:[e.jsxs(ye,{children:[e.jsx(be,{children:"تحويل مؤجل"}),e.jsx(ps,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[Ws&&Ws.length>0?e.jsxs("div",{children:[e.jsx(Z,{children:"اختيار عميل"}),e.jsxs(_a,{value:Xe,onValueChange:t=>{Le(t);const a=Ws.find(r=>r.id===t);a&&z(a.name)},children:[e.jsx(Oa,{className:"w-full",children:e.jsx(Ea,{placeholder:"اختر عميل"})}),e.jsx(Ma,{children:Ws.map(t=>e.jsxs(ta,{value:t.id,children:[t.name,t.mobile?` — ${t.mobile}`:""]},t.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx(U,{id:"quickDebtName",value:G,onChange:t=>z(t.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx(U,{id:"quickDebtAmount",type:"number",value:Te,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"quickDebtCommission",children:"العمولة (محسوبة تلقائياً)"}),e.jsx(U,{id:"quickDebtCommission",type:"number",value:function(){const t=os(),a=parseFloat((ns||"0").toString())||0;let r=0;if(re==="transfer")if((t==null?void 0:t.defaultTransferCommission)!=null){const l=Number(t.defaultTransferCommission)||0;r=Math.round(l*a/1e3*100)/100}else{const l=xs&&xs.trim()!==""?parseFloat(xs):0;r=Math.max(0,l)}else if((t==null?void 0:t.defaultWithdrawCommission)!=null){const l=Number(t.defaultWithdrawCommission)||0;r=Math.round(l*a/1e3*100)/100}else{const l=es&&es.trim()!==""?parseFloat(es):Math.round(a*.01*100)/100;r=Math.max(0,l)}return String(r||0)}(),readOnly:!0,placeholder:"قيمة العمولة"})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx(U,{id:"quickDebtNotes",value:ze,onChange:t=>We(t.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(lt,{children:e.jsx(h,{type:"button",variant:"default",className:"bg-green-600 text-white hover:bg-green-700",onClick:()=>{const t=os(),a=parseFloat((ns||"").toString())||0;let r=0;if(re==="transfer")if((t==null?void 0:t.defaultTransferCommission)!=null){const m=Number(t.defaultTransferCommission)||0;r=Math.round(m*a/1e3*100)/100}else{const m=xs&&xs.trim()!==""?parseFloat(xs):0;r=Math.max(0,m)}else if((t==null?void 0:t.defaultWithdrawCommission)!=null){const m=Number(t.defaultWithdrawCommission)||0;r=Math.round(m*a/1e3*100)/100}else{const m=es&&es.trim()!==""?parseFloat(es):Math.round(a*.01*100)/100;r=Math.max(0,m)}let l=0;if(re==="withdraw"?l=yt?a:Math.max(0,Math.round((a-r)*100)/100):l=Math.max(0,Math.round((a+r)*100)/100),!G||isNaN(l)||l<=0){i({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const o=Ws.find(m=>m.id===Xe);Ps({debtorName:G,amount:l,notes:ze,customerId:Xe||void 0,mobile:o==null?void 0:o.mobile}),zs(!1),O(!1),i({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx(Et,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(Ft,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(Hh,{isOpen:td,onClose:()=>sd(!1),initialEditingWallet:ad,onWalletUpdate:async()=>{try{await _r()}catch(t){console.error("Error reloading wallets after update:",t)}}}),e.jsx(Gh,{isOpen:id,onClose:()=>Sl(!1),transaction:nd,onDelete:Mm}),e.jsx(gs,{open:md,onOpenChange:yr,onSuccess:Fm,title:Rm(),description:Bm(),mode:"verify"}),e.jsx(rc,{open:am,onOpenChange:ho,onSuccess:zm,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:Tt,balanceLabel:"الرصيد النقدي",userId:s==null?void 0:s.uid}),e.jsx(rc,{open:rm,onOpenChange:uo,onSuccess:qm,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:Es&&it[Es]||0,balanceLabel:`رصيد ${((zo=He.find(t=>t.id===Es))==null?void 0:zo.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(eu,{open:nm,onOpenChange:Wi,onSuccess:Vm,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:Es&&it[Es]||0,balanceLabel:`رصيد ${((qo=He.find(t=>t.id===Es))==null?void 0:qo.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(Qh,{open:fm,onOpenChange:ym,userId:s==null?void 0:s.uid}),e.jsx(Zh,{open:bm,onOpenChange:vm,userId:s==null?void 0:s.uid}),e.jsx(Xh,{open:wm,onOpenChange:Nm}),e.jsx(ge,{open:om,onOpenChange:jn,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(be,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(U,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:Ri,onChange:t=>Sn(t.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:async()=>{if(!await Bn(Gi)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(Ri);if(isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Tt+t;Kt(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?pe.updateUserData(s.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),Ge(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),Ge(!0)}):Ge(!0),i({title:"تم بنجاح",description:`تم إضافة ${t} جنيه إلى الدرج النقدية وحفظه في السحابة`}),jn(!1),Sn(""),Pn("")},children:[e.jsx(vs,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(h,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:async()=>{if(!await Bn(Gi)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(Ri);if(isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Tt-t;Kt(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?pe.updateUserData(s.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),Ge(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),Ge(!0)}):Ge(!0),i({title:"تم بنجاح",description:`تم خصم ${t} جنيه من الدرج النقدية وحفظه في السحابة`}),jn(!1),Sn(""),Pn("")},children:[e.jsx(Qa,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",Tt.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx(U,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:Gi,onChange:t=>Pn(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(lt,{className:"flex gap-2",children:e.jsx(h,{variant:"outline",onClick:()=>{jn(!1),Sn(""),Pn("")},children:"إلغاء"})})]})}),e.jsx(ge,{open:Pm,onOpenChange:Wn,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(be,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(it).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(U,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل الرقم السري الرئيسي",value:Mo,onChange:t=>Fn(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(lt,{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Wn(!1),Fn("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",onClick:async()=>{if(!await ws.verifyMasterPin(Mo,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const a={};Object.keys(it).forEach(m=>{a[m]=0}),ds(a),localStorage.setItem(Ds(),JSON.stringify(a)),Wn(!1),Fn("");const r=new Date().toISOString(),l={walletBalances:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(o,JSON.stringify(l)),s!=null&&s.uid?pe.updateUserData(s.uid,l).then(()=>{localStorage.removeItem(o),Ge(!1)}).catch(m=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",m),Ge(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):Ge(!0),setTimeout(()=>{ds({...a})},100)}catch(a){console.error("خطأ في تصفير أرصدة المحافظ:",a),i({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(ge,{open:im,onOpenChange:Nn,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(be,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((Vo=He.find(t=>t.id===X))==null?void 0:Vo.name)||X]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(X&&it[X]?it[X]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(U,{id:"resetSelectedWalletPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:xo,onChange:t=>Fi(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(lt,{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Nn(!1),Fi("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",onClick:async()=>{var a;if(!X){i({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await ws.verifyMasterPin(xo,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const r={...it};r[X]=0,ds(r),localStorage.setItem(Ds(),JSON.stringify(r)),Nn(!1),Fi("");const l=new Date().toISOString(),o={walletBalances:r,lastUpdated:l},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(o)),s!=null&&s.uid?pe.updateUserData(s.uid,o).then(()=>{localStorage.removeItem(m),Ge(!1)}).catch(x=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",x),Ge(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):Ge(!0),i({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((a=He.find(x=>x.id===X))==null?void 0:a.name)||X}`})}catch(r){console.error("خطأ في تصفير رصيد المحفظة المختارة:",r),i({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(ge,{open:Dm,onOpenChange:Mn,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsxs(be,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(vs,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(it).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx(U,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:Ao,onChange:t=>Zi(t.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx(U,{id:"addWalletTotalPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري",value:To,onChange:t=>Xi(t.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(lt,{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Mn(!1),Zi(""),Xi("")},children:"إلغاء"}),e.jsx(h,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:Po,onClick:async()=>{const t=parseFloat(Ao);if(!t||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!await Om(To)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}ko(!0);try{const a=Object.values(it).reduce((r,l)=>r+l,0);if(a===0){const r=Object.keys(it),l=t/r.length,o={};r.forEach(m=>{o[m]=l}),ds(o),localStorage.setItem(Ds(),JSON.stringify(o)),s!=null&&s.uid?await pe.updateUserData(s.uid,{walletBalances:o,lastUpdated:new Date().toISOString()}):Ge(!0)}else{const r={};Object.entries(it).forEach(([l,o])=>{const m=o/a,x=t*m;r[l]=o+x}),ds(r),localStorage.setItem(Ds(),JSON.stringify(r)),s!=null&&s.uid?await pe.updateUserData(s.uid,{walletBalances:r,lastUpdated:new Date().toISOString()}):Ge(!0)}setTimeout(()=>{ds(r=>({...r}))},100),Mn(!1),Zi(""),Xi("")}catch(a){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",a),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{ko(!1)}},children:Po?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(ge,{open:km,onOpenChange:Rn,children:e.jsxs(fe,{className:"sm:max-w-[425px]",children:[e.jsx(ye,{children:e.jsxs(be,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(ms,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"resetCashPin",children:"الرقم السري الرئيسي"}),e.jsx(U,{id:"resetCashPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:el,onChange:t=>tl(t.target.value)})]})]}),e.jsxs(lt,{children:[e.jsx(h,{variant:"outline",onClick:()=>{Rn(!1),tl("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",onClick:async()=>{if(!el){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await ws.verifyMasterPin(el,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{Kt(0),Rn(!1),tl("");const a={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem(Cs(),"0");const r=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(r,JSON.stringify(a)),s!=null&&s.uid?pe.updateUserData(s.uid,a).then(()=>{localStorage.removeItem(r),Ge(!1)}).catch(l=>{console.error("خطأ في حفظ الرصيد في Firebase:",l),Ge(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):Ge(!0)}catch(a){console.error("خطأ في تصفير الرصيد النقدي:",a),i({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(iu,{open:Sm,onOpenChange:Io,userId:s==null?void 0:s.uid,cashBalance:Tt,walletBalances:it,transactions:Ze}),e.jsx(ge,{open:jm,onOpenChange:Ir,children:e.jsxs(fe,{className:"sm:max-w-[425px]",children:[e.jsx(ye,{children:e.jsxs(be,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(vs,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx(U,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:Ha,onChange:t=>kn(t.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-right",children:"هل تريد إضافة ملاحظة؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{type:"button",variant:Tr==="yes"?"default":"outline",onClick:()=>Pr("yes"),className:"flex-1",children:"نعم"}),e.jsx(h,{type:"button",variant:Tr==="no"?"default":"outline",onClick:async()=>{if(Pr("no"),!Ha||parseFloat(Ha)<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!Ar){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await Bn(Ar)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}On(!0);try{const t=parseFloat(Ha),a=Tt+t;Kt(a),localStorage.setItem(Cs(),a.toString());const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r));const o=`CASHADD-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`;Ir(!1),kn(""),_n(""),Pr(null),En("");const m=[];if(s!=null&&s.uid){m.push(pe.updateUserData(s.uid,r).then(()=>{localStorage.removeItem(l),Ge(!1)}).catch(()=>{Ge(!0)}));const x={txnType:"cash_addition",type:"cash_addition",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:o,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(j==null?void 0:j.shopId)||void 0};m.push(pe.saveUserTransaction(s.uid,x));const y=j==null?void 0:j.shopId;if(y){const S=Ve(V,"dashboardData",y);m.push(ts(S,{cashBalance:a}))}}Promise.allSettled(m).then(()=>{}).catch(()=>{})}catch{Kt(Tt),localStorage.setItem("cashBalance",Tt.toString()),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{On(!1)}},className:"flex-1",children:"لا"})]})]}),Tr==="yes"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"addCashNote",children:"الملاحظة"}),e.jsx(U,{id:"addCashNote",type:"text",placeholder:"اكتب الملاحظة",value:Qi,onChange:t=>En(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx(U,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:Ar,onChange:t=>_n(t.target.value)})]})]}),e.jsxs(lt,{children:[e.jsx(h,{variant:"outline",onClick:()=>{Ir(!1),kn(""),_n(""),Pr(null),En("")},children:"إلغاء"}),e.jsx(h,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:Co,onClick:async()=>{if(!Ha||parseFloat(Ha)<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!Ar){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await Bn(Ar)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}if(Tr==="yes"&&Qi.trim().length===0){i({title:"تنبيه",description:"أدخل الملاحظة أو اختر لا",variant:"destructive"});return}On(!0);try{const t=parseFloat(Ha),a=Tt+t;Kt(a),localStorage.setItem(Cs(),a.toString());const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r));const o=`CASHADD-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`;Ir(!1),kn(""),_n(""),Pr(null),En("");const m=[];if(s!=null&&s.uid){m.push(pe.updateUserData(s.uid,r).then(()=>{localStorage.removeItem(l),Ge(!1)}).catch(()=>{Ge(!0)}));const x={txnType:"cash_addition",type:"cash_addition",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:o,note:Tr==="yes"?Qi.trim():void 0,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(j==null?void 0:j.shopId)||void 0};m.push(pe.saveUserTransaction(s.uid,x));const y=j==null?void 0:j.shopId;if(y){const S=Ve(V,"dashboardData",y);m.push(ts(S,{cashBalance:a}))}}Promise.allSettled(m).then(()=>{}).catch(()=>{})}catch{Kt(Tt),localStorage.setItem("cashBalance",Tt.toString()),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{On(!1)}},children:Co?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(ge,{open:sm,onOpenChange:$i,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(be,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx(U,{id:"search-date",type:"date",value:ln,onChange:t=>_l(t.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx(U,{id:"search-time",type:"time",value:on,onChange:t=>Ol(t.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(lt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>{_l(""),Ol(""),$i(!1)},children:"مسح"}),e.jsx(h,{onClick:()=>$i(!1),children:"تطبيق"})]})]})}),e.jsx(ic,{isOpen:rs&&!Nt,onClose:()=>Ht(!1),onTrialStarted:em}),e.jsx(ru,{isOpen:vd,onClose:()=>hi(!1)}),e.jsx(nu,{isOpen:li,onClose:()=>gr(!1),initialBarcode:Xc}),e.jsx(jh,{isOpen:jd,onClose:()=>dn(!1)}),e.jsx(Sh,{open:Sd,onOpenChange:mn}),e.jsx(wu,{open:Dd,onOpenChange:t=>{if(t&&!na){i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}hn(t)}}),e.jsx(Au,{open:Q,onOpenChange:t=>{if(t&&!na){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}te(t)}}),e.jsx(Tu,{open:ce,onOpenChange:t=>{if(t&&!na){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}L(t)}}),e.jsx(gs,{open:dm,onOpenChange:vo,onSuccess:()=>zi(!0),title:"تقاريرك",description:"أدخل الرقم السري الرئيسي للوصول إلى تقاريرك",mode:"verify"}),e.jsx(ge,{open:Ui,onOpenChange:zi,children:e.jsxs(fe,{className:"sm:max-w-xl",children:[e.jsxs(ye,{children:[e.jsxs(be,{className:"flex items-center gap-2",children:[e.jsx(tc,{className:"h-4 w-4 text-blue-600"}),"تقارير اليوم"]}),e.jsx(ps,{children:"ملخص معاملات اليوم محفوظ لآخر 30 يومًا مع أرشفة في السحابة"})]}),e.jsxs("div",{className:"space-y-4",children:[(()=>{const t=new Date().toDateString(),a=Ze.filter(y=>{const S=new Date(y.createdAt).toDateString(),u=String(y.status||"completed").toLowerCase();return S===t&&(u==="completed"||u==="confirmed")}),r=a.length,l=a.reduce((y,S)=>y+Number(S.amount||0),0),o=a.filter(y=>y.type==="withdraw").reduce((y,S)=>y+Number(S.amount||0),0),m=a.filter(y=>y.type==="send").reduce((y,S)=>y+Number(S.amount||0),0),x=a.reduce((y,S)=>y+Number(bs.calculateTransactionProfit(S)||0),0);return e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-blue-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-blue-700",children:"عدد المعاملات"}),e.jsx("div",{className:"text-lg font-bold text-blue-800",children:r})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-indigo-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-indigo-700",children:"إجمالي المبالغ"}),e.jsx("div",{className:"text-lg font-bold text-indigo-800",children:Number(l).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-red-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-red-700",children:"المبالغ المسحوبة"}),e.jsx("div",{className:"text-lg font-bold text-red-800",children:Number(o).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-green-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-green-700",children:"المبالغ المرسلة"}),e.jsx("div",{className:"text-lg font-bold text-green-800",children:Number(m).toFixed(2)})]}),e.jsxs("div",{className:"col-span-2 rounded-lg p-3 bg-gradient-to-r from-amber-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-amber-700",children:"الأرباح"}),e.jsx("div",{className:"text-lg font-bold text-amber-800",children:Number(x).toFixed(2)})]})]})})(),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(h,{variant:"default",onClick:async()=>{try{if(!(s!=null&&s.uid))return;const t=new Date,a=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0"),o=`${a}-${r}-${l}`,m=t.toDateString(),x=Ze.filter(T=>{const P=new Date(T.createdAt).toDateString(),Y=String(T.status||"completed").toLowerCase();return P===m&&(Y==="completed"||Y==="confirmed")}),y=x.length,S=x.reduce((T,P)=>T+Number(P.amount||0),0),u=x.filter(T=>T.type==="withdraw").reduce((T,P)=>T+Number(P.amount||0),0),g=x.filter(T=>T.type==="send").reduce((T,P)=>T+Number(P.amount||0),0),I=x.reduce((T,P)=>T+Number(bs.calculateTransactionProfit(P)||0),0);await Br.add({userId:s.uid,reportDate:o,totalTransactions:y,totalAmount:Number(S.toFixed(2)),totalWithdrawn:Number(u.toFixed(2)),totalSent:Number(g.toFixed(2)),profit:Number(I.toFixed(2)),walletId:null});try{await Br.trimToMaxCount(s.uid,30)}catch{}i({title:"تم الأرشفة",description:`تم حفظ تقرير ${o}`})}catch{i({title:"فشل الأرشفة",description:"تعذر حفظ التقرير",variant:"destructive"})}},children:"أرشفة اليوم"}),e.jsx(h,{variant:"outline",onClick:()=>zi(!1),children:"إغلاق"})]}),e.jsx("div",{className:"mt-2 border-t pt-2",children:e.jsx("div",{className:"space-y-2 max-h-[40vh] overflow-auto",children:wo.length===0?e.jsx("div",{className:"text-xs text-muted-foreground",children:"لا توجد تقارير محفوظة"}):wo.map(t=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:t.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",t.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalAmount).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalWithdrawn).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalSent).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:Number(t.profit??0).toFixed(2)})]})]})]},t.id||`${t.userId}-${t.reportDate}`))})})]})]})}),e.jsx(ge,{open:cm,onOpenChange:t=>{if(t){i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}Bi(!1)},children:e.jsxs(fe,{dir:"rtl",className:"sm:max-w-md w-[95vw] sm:w-auto rounded-2xl border border-emerald-200 shadow-xl bg-gradient-to-br from-white via-green-50 to-emerald-50 backdrop-blur-md data-[state=open]:animate-in data-[state=open]:fade-in-0 data-[state=open]:zoom-in-90 data-[state=open]:slide-in-from-bottom-8 duration-300",children:[e.jsxs(ye,{children:[e.jsx(be,{className:"text-right text-green-700",children:"شحن رصيد الموبايل"}),e.jsx(ps,{className:"text-right text-gray-600",children:"أدخل البيانات ثم اضغط تأكيد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"topupPhone",className:"text-right block",children:"رقم الموبايل"}),e.jsx(U,{id:"topupPhone",value:Dn,onChange:t=>po(t.target.value),placeholder:"010xxxxxxx",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx(Z,{className:"text-right block",children:"شركة التشغيل"}),e.jsxs(_a,{value:Cn,onValueChange:go,children:[e.jsx(Oa,{className:"text-right",children:e.jsx(Ea,{placeholder:"اختر الشركة"})}),e.jsxs(Ma,{children:[e.jsx(ta,{value:"vodafone",children:"فودافون"}),e.jsx(ta,{value:"orange",children:"أورنج"}),e.jsx(ta,{value:"etisalat",children:"اتصالات"}),e.jsx(ta,{value:"we",children:"WE"})]})]})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"topupAmount",className:"text-right block",children:"المبلغ بالجنيه"}),e.jsx(U,{id:"topupAmount",type:"number",value:In,onChange:t=>fo(t.target.value?Number(t.target.value):""),placeholder:"50",className:"text-right"})]})]}),e.jsxs(lt,{className:"flex gap-2 justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>Bi(!1),className:"border-gray-300",children:"إلغاء"}),e.jsx(h,{onClick:w,disabled:yo||!Dn||!Cn||!In,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:yo?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})}),e.jsx(gs,{open:Ld,onOpenChange:pi,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{pi(!1),nr(!0)}}),e.jsx(gs,{open:Wd,onOpenChange:ql,mode:"verify",title:"تأكيد تغيير طلب الرقم السري للديون",description:"أدخل الرقم السري الرئيسي لتفعيل أو إلغاء طلب الرقم السري عند فتح الديون",onSuccess:async()=>{if(Vl!==null){const t=Vl;zl(t);try{const a=s==null?void 0:s.uid,r=a?`debtsPinRequired_${a}`:"debtsPinRequired";localStorage.setItem(r,String(t)),a&&await pe.updateUserData(a,{debtsPinRequired:t})}catch{}i({title:t?"تم تفعيل طلب الرقم السري للديون":"تم إلغاء طلب الرقم السري للديون",description:t?"سيُطلب الرقم السري الرئيسي عند فتح نافذة الديون.":"يمكن فتح نافذة الديون بدون طلب الرقم السري."})}Fd(null),ql(!1)}}),e.jsx(gh,{open:lm,onOpenChange:Dr,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"سيتم حذف كل المعاملات السابقة نهائيًا من حسابك وFirebase.",onSuccess:async()=>{try{if(!(s!=null&&s.uid)){Dr(!1);return}const t=new Date,a=l=>l instanceof Date?l:typeof(l==null?void 0:l.toDate)=="function"?l.toDate():new Date(String(l)),r=Ze.filter(l=>a(l.createdAt)<t);await pe.updateUserData(s.uid,{recentReset:{keepLastCount:cr.keepLastCount??30,intervalDays:cr.intervalDays??7,lastResetAt:t}}),Ln(l=>({...l,lastResetAt:t})),i({title:"تم إخفاء المعاملات السابقة",description:"تم إخفاء كل الإيصالات الأقدم من وقت التصفير من العرض بدون التأثير على تقارير اليوم/الشهر أو الحدود."})}catch(t){console.error("فشل تنفيذ التصفير النهائي:",t),i({title:"فشل التصفير",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}finally{Dr(!1)}}}),e.jsx(gs,{open:Qs,onOpenChange:Vt,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{Vt(!1),kt(!0)}}),e.jsx(ge,{open:Md,onOpenChange:nr,children:e.jsxs(fe,{className:"sm:max-w-[425px]",children:[e.jsxs(ye,{className:"flex items-center justify-between",children:[e.jsx(be,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx(ac,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[Wm," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"debtorName",className:"text-right col-span-1",children:"اسم المديون"}),e.jsx(U,{id:"debtorName",value:gi,onChange:t=>Jl(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل اسم المديون"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(U,{id:"debtAmount",type:"number",value:fi,onChange:t=>Kl(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx(U,{id:"debtReason",value:yi,onChange:t=>Yl(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]}),e.jsx(lt,{children:e.jsx(h,{onClick:()=>{if(gi&&fi&&yi){const t={id:Date.now().toString(),debtorName:gi,amount:parseFloat(fi),reason:yi,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};bn(t),ir(!0)}else i({title:"بيانات غير مكتملة",description:"يرجى إدخال الاسم والمبلغ والسبب",variant:"destructive"})},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(h,{variant:"outline",className:"w-full",onClick:()=>jr(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(h,{variant:"outline",className:"w-full",onClick:()=>Ci(!0),children:"إضافة عميل"})})]})}),e.jsx(ge,{open:Ni,onOpenChange:jr,children:e.jsxs(fe,{className:"sm:max-w-[520px]",children:[e.jsxs(ye,{children:[e.jsx(be,{className:"text-right",children:"إيصالات الديون"}),e.jsx(ps,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),Wt.length>0?e.jsxs("div",{className:"max-h-64 overflow-y-auto space-y-2",onScroll:t=>{const a=t.currentTarget;Si.length<Wt.length&&a.scrollTop+a.clientHeight>=a.scrollHeight-50&&ji(r=>r+1)},children:[Si.map(t=>e.jsx("div",{onClick:()=>{wr(t),Ia(!0),jr(!1),nr(!1)},className:"p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium",children:t.debtorName}),e.jsx("p",{className:"text-sm text-gray-600",children:t.reason}),e.jsx("p",{className:"text-sm text-gray-500",children:qn.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-lg",children:[t.amount," جنيه"]}),e.jsx(Qt,{variant:t.status==="paid"?"default":"secondary",className:t.status==="paid"?"bg-green-500":"bg-yellow-500",children:t.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},t.id)),Si.length<Wt.length&&e.jsx("div",{className:"flex justify-center pt-1",children:e.jsx(h,{variant:"outline",size:"sm",onClick:()=>ji(t=>t+1),children:"تحميل المزيد"})})]}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"}),e.jsxs(lt,{className:"flex justify-between mt-3",children:[e.jsx(h,{variant:"destructive",onClick:async()=>{try{if(!Wt||Wt.length===0){i({title:"لا توجد ديون",description:"القائمة فارغة بالفعل."});return}if(!window.confirm("هل تريد حذف كل إيصالات الديون؟ هذا الإجراء لا يمكن التراجع عنه."))return;const a=[];_s(a),wr(null),await Vs(a),i({title:"تم حذف كل إيصالات الديون",description:"تم تفريغ القائمة بالكامل."}),jr(!1)}catch(t){console.error("تعذر حذف كل إيصالات الديون:",t),i({title:"فشل الحذف",description:"حدث خطأ أثناء الحذف، حاول مرة أخرى.",variant:"destructive"})}},children:"حذف كل الإيصالات"}),e.jsx(h,{variant:"outline",onClick:()=>jr(!1),children:"إغلاق"})]})]})}),e.jsx(ge,{open:qd,onOpenChange:Ci,children:e.jsxs(fe,{className:"sm:max-w-[480px]",children:[e.jsxs(ye,{children:[e.jsx(be,{className:"text-right",children:"إضافة عميل"}),e.jsx(ps,{className:"text-right",children:"أدخل بيانات العميل ثم يمكنك تسجيل مبلغ دين عليه"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"customerName",className:"text-right col-span-1",children:"اسم العميل"}),e.jsx(U,{id:"customerName",value:Ai,onChange:t=>eo(t.target.value),className:"col-span-3 text-right",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"customerMobile",className:"text-right col-span-1",children:"رقم الموبايل"}),e.jsx(U,{id:"customerMobile",value:Ti,onChange:t=>to(t.target.value),className:"col-span-3 text-right",placeholder:"اكتب رقم الموبايل"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!Ai||!Ti){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const t={id:Date.now().toString(),name:Ai.trim(),mobile:Ti.trim(),createdAt:new Date},a=[t,...Ws];await Ki(a),eo(""),to(""),i({title:"تمت إضافة العميل",description:`تم إضافة ${t.name}`})},children:"إضافة"})}),e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx(Z,{className:"text-right block",children:"إضافة مبلغ على عميل"}),Ws.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(_a,{value:gn,onValueChange:so,children:[e.jsx(Oa,{className:"w-full",children:e.jsx(Ea,{placeholder:"اختر عميل"})}),e.jsx(Ma,{children:Ws.map(t=>e.jsxs(ta,{value:t.id,children:[t.name," — ",t.mobile]},t.id))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"customerDebtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(U,{id:"customerDebtAmount",type:"number",value:ao,onChange:t=>Vd(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{className:"bg-orange-600 hover:bg-orange-700",onClick:async()=>{const t=parseFloat(ao);if(!gn){i({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(t)||t<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Ws.find(l=>l.id===gn);if(!a)return;const r={id:Date.now().toString(),debtorName:a.name,customerId:a.id,mobile:a.mobile,amount:Number(t.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};bn(r),ir(!0)},children:"إضافة المبلغ"})})]}):e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد عملاء مسجلين. أضف عميلًا أولاً."})]}),e.jsxs("div",{className:"border-t pt-4 space-y-2",children:[e.jsx(Z,{className:"text-right block",children:"إدارة العملاء"}),Ws.length>0?e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:Ws.map(t=>e.jsxs("div",{className:"p-2 border rounded-md flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium text-sm",children:t.name}),e.jsx("div",{className:"text-xs text-gray-600",children:t.mobile})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:()=>{ro(t.id),Pi(t.name||""),ki(t.mobile||""),fn(!0)},children:"تعديل"}),e.jsx(h,{variant:"destructive",size:"sm",onClick:()=>{_i(t.id),Oi(t.name||""),yn(!0)},children:"حذف نهائي"})]})]},t.id))}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً."})]})]}),e.jsx(lt,{className:"flex justify-end",children:e.jsx(h,{variant:"outline",onClick:()=>Ci(!1),children:"إغلاق"})})]})}),e.jsx(ge,{open:Yd,onOpenChange:yn,children:e.jsxs(fe,{hideClose:!0,className:"sm:max-w-[420px] rounded-2xl bg-gradient-to-br from-white via-rose-50 to-red-50 shadow-2xl border border-red-100 text-center",children:[e.jsxs(ye,{children:[e.jsx(be,{className:"text-center text-xl font-bold text-red-700",children:"تأكيد حذف العميل"}),e.jsxs(ps,{className:"text-center text-gray-600",children:["سيتم حذف العميل نهائيًا: ",lo]})]}),e.jsx("div",{className:"py-2 text-sm text-gray-700",children:"لا يمكن التراجع عن هذا الإجراء."}),e.jsxs(lt,{className:"flex justify-center gap-3",children:[e.jsx(h,{variant:"outline",onClick:()=>{yn(!1),_i(""),Oi("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",className:"bg-red-600 hover:bg-red-700",onClick:async()=>{const t=Hd,a=Ws.filter(r=>r.id!==t);await Ki(a),gn===t&&so(""),yn(!1),_i(""),Oi(""),i({title:"تم حذف العميل",description:lo})},children:"حذف نهائي"})]})]})}),e.jsx(ge,{open:Jd,onOpenChange:fn,children:e.jsxs(fe,{className:"sm:max-w-[420px]",children:[e.jsx(ye,{children:e.jsx(be,{className:"text-right",children:"تعديل بيانات العميل"})}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"editCustomerName",className:"text-right col-span-1",children:"الاسم"}),e.jsx(U,{id:"editCustomerName",value:no,onChange:t=>Pi(t.target.value),className:"col-span-3 text-right"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"editCustomerMobile",className:"text-right col-span-1",children:"الموبايل"}),e.jsx(U,{id:"editCustomerMobile",value:io,onChange:t=>ki(t.target.value),className:"col-span-3 text-right"})]})]}),e.jsxs(lt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>fn(!1),children:"إلغاء"}),e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=Kd,a=no.trim(),r=io.trim();if(!t||!a||!r){i({title:"بيانات غير مكتملة",description:"أدخل الاسم ورقم الموبايل",variant:"destructive"});return}const l=Ws.map(m=>m.id===t?{...m,name:a,mobile:r}:m);await Ki(l);const o=Wt.map(m=>m.customerId===t?{...m,debtorName:a,mobile:r}:m);o!==Wt&&(_s(o),await Vs(o)),fn(!1),ro(""),Pi(""),ki(""),i({title:"تم تحديث العميل",description:a})},children:"حفظ"})]})]})}),e.jsx(ge,{open:$t,onOpenChange:kt,children:e.jsxs(fe,{className:"sm:max-w-[520px]",children:[e.jsxs(ye,{children:[e.jsx(be,{className:"text-right",children:"مصروفات المحل"}),e.jsx(ps,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx(U,{id:"expenseName",value:is,onChange:t=>aa(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx(U,{id:"expenseAmount",type:"number",value:Us,onChange:t=>Sa(t.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx(U,{id:"expenseNotes",value:ls,onChange:t=>_(t.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(lt,{className:"flex justify-between",children:[e.jsx(h,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!is||!Us){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}Ee(!0)},children:"إضافة مصروف"}),e.jsx(h,{variant:"outline",onClick:()=>Ut(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(ge,{open:Ct,onOpenChange:Ut,children:e.jsxs(fe,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(ye,{children:[e.jsx(be,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(ps,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),le.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:le.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:t.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left flex items-start gap-2",children:[e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[t.amount," جنيه"]}),e.jsx(Qt,{variant:"secondary",className:t.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:t.source==="cash"?"من النقدية":`من المحفظة${t.walletId?` (${t.walletId})`:""}`})]}),e.jsxs(h,{variant:"destructive",size:"sm",className:"shrink-0",onClick:()=>um(t.id),title:"حذف نهائي",children:[e.jsx(ms,{className:"w-4 h-4 ml-1"}),"حذف"]})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(ge,{open:Ae,onOpenChange:Ee,children:e.jsxs(fe,{className:"sm:max-w-[480px]",children:[e.jsx(ye,{children:e.jsx(be,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(h,{variant:Re==="cash"?"default":"outline",className:Re==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>nt("cash"),children:"الفلوس النقدية"}),e.jsx(h,{variant:Re==="wallet"?"default":"outline",className:Re==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>nt("wallet"),children:"أرصدة المحافظ"}),e.jsx(h,{variant:Re==="fawry"?"default":"outline",className:Re==="fawry"?"bg-amber-600 hover:bg-amber-700 text-white":"",onClick:()=>nt("fawry"),children:"فوري"})]}),Re==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(_a,{value:J,onValueChange:ke,children:[e.jsx(Oa,{className:"w-full",children:e.jsx(Ea,{placeholder:"اختر محفظة"})}),e.jsx(Ma,{children:He.map(t=>e.jsx(ta,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(lt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>{Ee(!1),nt(null),ke("")},children:"إلغاء"}),e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=Number(Us);if(isNaN(t)||t<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!Re){i({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(Re==="cash"){const o=Number((Tt-t).toFixed(2));Kt(o),localStorage.setItem(Cs(),o.toString());const m={cashBalance:o,lastUpdated:new Date().toISOString()},x=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(x,JSON.stringify(m)),s!=null&&s.uid?(await pe.updateUserData(s.uid,m),localStorage.removeItem(x),Ge(!1)):Ge(!0)}else if(Re==="wallet"){if(!J){i({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const o=it[J]||0,m=Number((o-t).toFixed(2)),x={...it,[J]:m};ds(x);const y=new Date().toISOString(),S={walletBalances:x,lastUpdated:y},u=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(u,JSON.stringify(S)),localStorage.setItem(Ds(),JSON.stringify(x)),localStorage.setItem(`walletBalances_backup_${y}`,JSON.stringify(x)),s!=null&&s.uid&&await pe.updateUserData(s.uid,S)}}catch(o){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",o)}let a=Date.now().toString();try{if(s!=null&&s.uid){const{addDoc:o,collection:m,serverTimestamp:x}=await bt(async()=>{const{addDoc:u,collection:g,serverTimestamp:I}=await import("./index-gOTNP7ME.js").then(T=>T.bN);return{addDoc:u,collection:g,serverTimestamp:I}},__vite__mapDeps([0,1]),import.meta.url),{db:y}=await bt(async()=>{const{db:u}=await import("./index-gOTNP7ME.js").then(g=>g.bO);return{db:u}},__vite__mapDeps([0,1]),import.meta.url);a=(await o(m(y,"shop_expenses"),{userId:s.uid,shopId:k||(j==null?void 0:j.shopId)||s.uid||"default-shop",name:is,amount:t,notes:ls||"",source:Re,walletId:Re==="wallet"?J:null,createdAt:x()})).id}}catch(o){console.error("خطأ أثناء حفظ المصروف في Firestore:",o)}const r={id:a,name:is,amount:t,notes:ls,source:Re,walletId:Re==="wallet"?J:void 0,createdAt:new Date},l=[...le,r];await So(l),aa(""),Sa(""),_(""),nt(null),ke(""),Ee(!1),kt(!0),Ut(!0),i({title:"تم إضافة المصروف",description:Re==="cash"?"تم الخصم من النقدية":Re==="wallet"?"تم الخصم من أرصدة المحافظ":"تم تسجيل الدفع عبر فوري"})},children:"تأكيد الخصم"})]})]})}),e.jsx(ge,{open:ra,onOpenChange:ma,children:e.jsxs(fe,{className:"sm:max-w-[520px]",children:[e.jsxs(ye,{children:[e.jsx(be,{className:"text-right",children:"النواقص"}),e.jsx(ps,{className:"text-right",children:"سجل العناصر الناقصة التي تحتاج شراء وتابع حالتها."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"deficiencyName",className:"text-right col-span-1",children:"اسم العنصر"}),e.jsx(U,{id:"deficiencyName",value:$s,onChange:t=>Fa(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: سكر، زيت، مناديل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"deficiencyQuantity",className:"text-right col-span-1",children:"الكمية"}),e.jsx(U,{id:"deficiencyQuantity",type:"number",value:Ra,onChange:t=>B(t.target.value),className:"col-span-3 text-right",placeholder:"1"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{className:"bg-rose-600 hover:bg-rose-700",onClick:()=>{if(At){i({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}const t=parseInt(Ra||"1",10);if(!$s){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العنصر",variant:"destructive"});return}if(isNaN(t)||t<=0){i({title:"كمية غير صحيحة",description:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}(async()=>{if(s!=null&&s.uid)try{const{collection:r,addDoc:l,serverTimestamp:o}=await bt(async()=>{const{collection:y,addDoc:S,serverTimestamp:u}=await import("./index-gOTNP7ME.js").then(g=>g.bN);return{collection:y,addDoc:S,serverTimestamp:u}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await bt(async()=>{const{db:y}=await import("./index-gOTNP7ME.js").then(S=>S.bO);return{db:y}},__vite__mapDeps([0,1]),import.meta.url),x=await l(r(m,"deficiencies"),{userId:s.uid,shopId:k||(j==null?void 0:j.shopId)||s.uid||"default-shop",name:$s,quantity:t,status:"pending",createdAt:o()});try{const y=Tn(),S=localStorage.getItem(y),u=S?JSON.parse(S):[],g=Array.isArray(u)?u:[],I=g.some(Y=>String((Y==null?void 0:Y.id)||"")===x.id),T={id:x.id,name:$s,quantity:t,status:"pending",createdAt:new Date().toISOString()},P=I?g:[...g,T];localStorage.setItem(y,JSON.stringify(P))}catch{}Fa(""),B(""),i({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"});return}catch(r){console.warn("فشل حفظ النواقص إلى Firestore، سيُستخدم التخزين المحلي:",r)}const a={id:Date.now().toString(),name:$s,quantity:t,status:"pending",createdAt:new Date};at(r=>{const l=[...r,a];return Ji(l),l}),Fa(""),B(""),i({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"})})()},children:"إضافة للنواقص"})}),Ie.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:Ie.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["الكمية: ",t.quantity]}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qt,{variant:"secondary",className:t.status==="pending"?"bg-rose-100 text-rose-700":"bg-green-100 text-green-700",children:t.status==="pending"?"قيد الشراء":"تم الشراء"}),e.jsx(h,{variant:"outline",className:t.status==="pending"?"text-green-700 border-green-300 hover:bg-green-50":"text-rose-700 border-rose-300 hover:bg-rose-50",onClick:()=>{(async()=>{const a=t.status==="pending"?"purchased":"pending";if(s!=null&&s.uid)try{const{doc:r,updateDoc:l,serverTimestamp:o}=await bt(async()=>{const{doc:x,updateDoc:y,serverTimestamp:S}=await import("./index-gOTNP7ME.js").then(u=>u.bN);return{doc:x,updateDoc:y,serverTimestamp:S}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await bt(async()=>{const{db:x}=await import("./index-gOTNP7ME.js").then(y=>y.bO);return{db:x}},__vite__mapDeps([0,1]),import.meta.url);await l(r(m,"deficiencies",t.id),{status:a,updatedAt:o()});return}catch(r){console.warn("فشل تحديث حالة النواقص على Firestore، استخدام التخزين المحلي:",r)}at(r=>{const l=r.map(o=>o.id===t.id?{...o,status:a}:o);return Ji(l),l})})()},title:t.status==="pending"?"تم الشراء":"إلغاء الشراء",children:t.status==="pending"?"تم الشراء":"إلغاء الشراء"}),e.jsx(h,{variant:"outline",className:"text-red-700 border-red-300 hover:bg-red-50",onClick:()=>{(async()=>{if(s!=null&&s.uid)try{const{doc:a,deleteDoc:r}=await bt(async()=>{const{doc:o,deleteDoc:m}=await import("./index-gOTNP7ME.js").then(x=>x.bN);return{doc:o,deleteDoc:m}},__vite__mapDeps([0,1]),import.meta.url),{db:l}=await bt(async()=>{const{db:o}=await import("./index-gOTNP7ME.js").then(m=>m.bO);return{db:o}},__vite__mapDeps([0,1]),import.meta.url);await r(a(l,"deficiencies",t.id));return}catch(a){console.warn("فشل حذف عنصر النواقص من Firestore، استخدام التخزين المحلي:",a)}at(a=>{const r=a.filter(l=>l.id!==t.id);return Ji(r),r})})()},title:"حذف",children:"حذف"})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد عناصر مسجلة في النواقص"})]}),e.jsx(lt,{className:"flex justify-end",children:e.jsx(h,{variant:"outline",onClick:()=>ma(!1),children:"إغلاق"})})]})}),e.jsx(ge,{open:Gd,onOpenChange:ir,children:e.jsxs(fe,{className:"sm:max-w-[480px]",children:[e.jsx(ye,{children:e.jsx(be,{className:"text-right",children:"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(h,{variant:Os==="cash"?"default":"outline",className:Os==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>Sr("cash"),children:"الفلوس النقدية"}),e.jsx(h,{variant:Os==="wallet"?"default":"outline",className:Os==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>Sr("wallet"),children:"أرصدة المحافظ"}),e.jsx(h,{variant:Os==="none"?"default":"outline",className:Os==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>Sr("none"),children:"بدون خصم"})]}),Os==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(_a,{value:vn,onValueChange:Ei,children:[e.jsx(Oa,{className:"w-full",children:e.jsx(Ea,{placeholder:"اختر محفظة"})}),e.jsx(Ma,{children:He.map(t=>e.jsx(ta,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(lt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>{ir(!1),bn(null),Sr(null),Ei("")},children:"إلغاء"}),e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=!!pn&&!lr,a=Number(t?pn.delta:(lr==null?void 0:lr.amount)||0);if(!Os){i({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(Os==="cash"){const r=Number((Tt-a).toFixed(2));Kt(r),localStorage.setItem(Cs(),r.toString());const l=new Date().toISOString(),o={cashBalance:r,lastUpdated:l},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(o)),s!=null&&s.uid?await pe.updateUserData(s.uid,o).then(()=>{localStorage.removeItem(m),Ge(!1)}).catch(()=>{Ge(!0)}):Ge(!0)}else if(Os==="wallet"){if(!vn){i({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const r=it[vn]||0,l=Number((r-a).toFixed(2)),o={...it,[vn]:l};ds(o);const m=new Date().toISOString(),x={walletBalances:o,lastUpdated:m},y=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(y,JSON.stringify(x)),localStorage.setItem(Ds(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${m}`,JSON.stringify(o)),s!=null&&s.uid&&await pe.updateUserData(s.uid,x)}}catch(r){console.error("خطأ أثناء تحديث الأرصدة عند حفظ/تعديل الدين:",r)}if(t){if(!me)return;const r=Number(me.amount||0),l=Number(me.paidAmount||0),o=Number(pn.delta||0);if(pn.type==="decrease"){const m=Number((r-o).toFixed(2)),x=l>=m,y={...me,amount:m,status:x?"paid":"pending"},S=Wt.map(u=>u.id===me.id?y:u);_s(S),wr(y),await Vs(S);try{x&&(s!=null&&s.uid)&&(async()=>{const u=Ue(je(V,"userTransactions"),ae("userId","==",s.uid),ae("linkedDebtId","==",me.id),ae("status","==","pending")),g=await Qe(u);await Promise.allSettled(g.docs.map(Fe=>ts(Fe.ref,{status:"completed",confirmedAt:new Date})));try{const Fe=g.docs.map(ue=>{var se;return String(((se=ue.data())==null?void 0:se.transactionId)||"")});s!=null&&s.uid&&Fe.forEach(ue=>ue&&pe.removeLocalReceiptById(s.uid,ue))}catch{}const I=Ue(je(V,"transactions"),ae("userId","==",s.uid),ae("linkedDebtId","==",me.id),ae("status","==","pending")),T=await Qe(I);await Promise.allSettled(T.docs.map(Fe=>ts(Fe.ref,{status:"completed",confirmedAt:new Date})));try{const Fe=T.docs.map(ue=>{var se;return String(ue.id||((se=ue.data())==null?void 0:se.transactionId)||"")});s!=null&&s.uid&&Fe.forEach(ue=>ue&&pe.removeLocalReceiptById(s.uid,ue))}catch{}const P=Ue(je(V,"transactions"),ae("merchantUserId","==",s.uid),ae("linkedDebtId","==",me.id),ae("status","==","pending")),Y=await Qe(P);await Promise.allSettled(Y.docs.map(Fe=>ts(Fe.ref,{status:"completed",confirmedAt:new Date})));try{const Fe=Y.docs.map(ue=>{var se;return String(ue.id||((se=ue.data())==null?void 0:se.transactionId)||"")});s!=null&&s.uid&&Fe.forEach(ue=>ue&&pe.removeLocalReceiptById(s.uid,ue))}catch{}})().catch(u=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين بعد الإنقاص:",u),i({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(u){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة بعد الإنقاص:",u)}i({title:"تم إنقاص المبلغ",description:`المبلغ الجديد: ${m} جنيه`})}else{const m=r+o,x=l>=m,y={...me,amount:Number(m.toFixed(2)),status:x?"paid":"pending"},S=Wt.map(u=>u.id===me.id?y:u);_s(S),wr(y),await Vs(S),i({title:"تم زيادة المبلغ",description:`المبلغ الجديد: ${m} جنيه`})}}else if(lr){const r=[...Wt,lr];_s(r),await Vs(r)}Jl(""),Kl(""),Yl(""),nr(!1),ir(!1),bn(null),Ql(null),Sr(null),Ei(""),i({title:t?"تم تطبيق الخصم وتعديل الدين":Os==="none"?"تم حفظ الدين بدون خصم":"تم حفظ الدين وخصم المبلغ",description:Os==="none"?"لم يتم الخصم من الدرج أو المحافظ":Os==="cash"?`تم خصم ${a} من الرصيد النقدي`:`تم خصم ${a} من رصيد المحفظة`})},children:"تأكيد الخصم"})]})]})}),e.jsx(ge,{open:Rd,onOpenChange:Ia,children:e.jsxs(fe,{className:"sm:max-w-[425px]",children:[e.jsx(ye,{children:e.jsx(be,{className:"text-right",children:"إيصال الدين"})}),me&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:qn.format(me.createdAt instanceof Date?me.createdAt:new Date(me.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:me.debtorName})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",className:"h-8 w-8 p-0","aria-label":"إنقاص الدين",onClick:()=>{Hl("decrease"),bi(""),Ia(!1),Nr(!0)},children:"−"}),e.jsxs("span",{className:"font-bold text-lg",children:[me.amount," جنيه"]}),e.jsx(h,{variant:"outline",className:"h-8 w-8 p-0","aria-label":"زيادة الدين",onClick:()=>{Hl("increase"),bi(""),Ia(!1),Nr(!0)},children:"+"})]})]}),(()=>{try{const t=(Ze||[]).filter(a=>String((a==null?void 0:a.linkedDebtId)||"")===String(me.id)).reduce((a,r)=>a+Math.max(0,Number((r==null?void 0:r.commission)||0)),0);return t>0?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الربح:"}),e.jsxs("span",{className:"text-green-700 font-semibold",children:[t," جنيه"]})]}):null}catch{return null}})(),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:me.reason})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(Qt,{variant:me.status==="paid"?"default":"secondary",className:me.status==="paid"?"bg-green-500":"bg-yellow-500",children:me.status==="paid"?"مدفوع":"مؤجل"})]}),(()=>{try{const t=(Ze||[]).filter(S=>String((S==null?void 0:S.linkedDebtId)||"")===String(me.id)),a=t.reduce((S,u)=>S+Math.max(0,Number((u==null?void 0:u.commission)||0)),0),r=t.reduce((S,u)=>S+Math.max(0,Number(((u==null?void 0:u.sentAmount)??(u==null?void 0:u.transferredAmount)??(u==null?void 0:u.withdrawnAmount)??(u==null?void 0:u.amount))||0)),0),l=Number(me.amount||0),o=Number(me.paidAmount||0),x=l<r+a?l+a:l,y=Math.max(0,Number(x)-o);return e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[y," جنيه"]})]})}catch{return e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[Number(me.amount||0)-Number(me.paidAmount||0)," جنيه"]})]})}})(),me.paidAmount?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[me.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-3 border rounded-lg bg-gray-50",children:[Ud?e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx(U,{id:"partialAmount",type:"number",value:Zl,onChange:t=>wi(t.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{vi(!1),wi("")},children:"إلغاء"}),e.jsx(h,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const t=parseFloat(Zl);if(!me||isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Math.max(0,Number(me.amount||0)-Number(me.paidAmount||0));if(t>a){i({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const r=Number(((me.paidAmount||0)+t).toFixed(2)),l=r>=Number(me.amount||0),o={...me,amount:Number(me.amount||0),paidAmount:r,status:l?"paid":"pending",partialPayments:[...me.partialPayments||[],{amount:t,paidAt:new Date}]},m=Wt.map(x=>x.id===me.id?o:x);_s(m),wr(o),await Vs(m);try{o.status==="paid"&&(s!=null&&s.uid)&&(async()=>{const x=Ue(je(V,"userTransactions"),ae("userId","==",s.uid),ae("linkedDebtId","==",me.id),ae("status","==","pending")),y=await Qe(x);await Promise.allSettled(y.docs.map(T=>ts(T.ref,{status:"completed",confirmedAt:new Date})));try{const T=y.docs.map(P=>{var Y;return String(((Y=P.data())==null?void 0:Y.transactionId)||"")});s!=null&&s.uid&&T.forEach(P=>P&&pe.removeLocalReceiptById(s.uid,P))}catch{}const S=Ue(je(V,"transactions"),ae("userId","==",s.uid),ae("linkedDebtId","==",me.id),ae("status","==","pending")),u=await Qe(S);await Promise.allSettled(u.docs.map(T=>ts(T.ref,{status:"completed",confirmedAt:new Date})));try{const T=u.docs.map(P=>{var Y;return String(P.id||((Y=P.data())==null?void 0:Y.transactionId)||"")});s!=null&&s.uid&&T.forEach(P=>P&&pe.removeLocalReceiptById(s.uid,P))}catch{}const g=Ue(je(V,"transactions"),ae("merchantUserId","==",s.uid),ae("linkedDebtId","==",me.id),ae("status","==","pending")),I=await Qe(g);await Promise.allSettled(I.docs.map(T=>ts(T.ref,{status:"completed",confirmedAt:new Date})));try{const T=I.docs.map(P=>{var Y;return String(P.id||((Y=P.data())==null?void 0:Y.transactionId)||"")});s!=null&&s.uid&&T.forEach(P=>P&&pe.removeLocalReceiptById(s.uid,P))}catch{}})().catch(x=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",x),i({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(x){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",x)}try{const x=Yi(),y=localStorage.getItem(x);if(y){const u=(JSON.parse(y)||[]).map(g=>(g==null?void 0:g.linkedDebtId)===me.id&&(g==null?void 0:g.status)==="pending"?{...g,status:"completed",confirmedAt:new Date}:g);localStorage.setItem(x,JSON.stringify(u)),xa(g=>g.map(I=>(I==null?void 0:I.linkedDebtId)===me.id&&(I==null?void 0:I.status)==="pending"?{...I,status:"completed",confirmedAt:new Date}:I))}}catch(x){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",x)}wn(t),Aa("cash"),or(!0),vi(!1),wi(""),i({title:"تم تسجيل دفع جزء",description:`تم دفع ${t} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(h,{variant:"outline",className:"w-full",onClick:()=>vi(!0),children:"دفع جزء"}),me.partialPayments&&me.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-24 overflow-y-auto",children:me.partialPayments.map((t,a)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["دفع: ",t.amount," جنيه"]}),e.jsx("span",{children:new Date(t.paidAt).toLocaleString("ar-EG")})]},a))})]})]})]})]}),e.jsxs(lt,{className:"flex gap-2 justify-center",children:[e.jsx(h,{onClick:async()=>{if(me){const t=Wt.map(a=>a.id===me.id?{...a,status:"pending"}:a);_s(t),await Vs(t),Ia(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(h,{onClick:async()=>{if(me){const t=Number(me.amount||0),a=Number(me.paidAmount||0);let r=Math.max(0,t-a);try{const m=(Ze||[]).filter(g=>String((g==null?void 0:g.linkedDebtId)||"")===String(me.id)),x=m.reduce((g,I)=>g+Math.max(0,Number((I==null?void 0:I.commission)||0)),0),y=m.reduce((g,I)=>g+Math.max(0,Number(((I==null?void 0:I.sentAmount)??(I==null?void 0:I.transferredAmount)??(I==null?void 0:I.withdrawnAmount)??(I==null?void 0:I.amount))||0)),0),u=t<y+x?t+x:t;r=Math.max(0,Number(u)-a)}catch{}const l=r,o=Wt.map(m=>m.id===me.id?{...m,amount:Number(m.amount||0),paidAmount:Number(((m.paidAmount||0)+l).toFixed(2)),status:"paid",partialPayments:[...m.partialPayments||[],...l>0?[{amount:l,paidAt:new Date}]:[]]}:m);_s(o),l>0&&(wn(l),Aa("cash"),or(!0)),await Vs(o);try{s!=null&&s.uid&&(me!=null&&me.id)&&(async()=>{const m=Ue(je(V,"userTransactions"),ae("userId","==",s.uid),ae("linkedDebtId","==",me.id),ae("status","==","pending")),x=await Qe(m);await Promise.allSettled(x.docs.map(I=>ts(I.ref,{status:"completed",confirmedAt:new Date})));try{const I=x.docs.map(T=>{var P;return String(((P=T.data())==null?void 0:P.transactionId)||"")});s!=null&&s.uid&&I.forEach(T=>T&&pe.removeLocalReceiptById(s.uid,T))}catch{}const y=Ue(je(V,"transactions"),ae("userId","==",s.uid),ae("linkedDebtId","==",me.id),ae("status","==","pending")),S=await Qe(y);await Promise.allSettled(S.docs.map(I=>ts(I.ref,{status:"completed",confirmedAt:new Date})));try{const I=S.docs.map(T=>{var P;return String(T.id||((P=T.data())==null?void 0:P.transactionId)||"")});s!=null&&s.uid&&I.forEach(T=>T&&pe.removeLocalReceiptById(s.uid,T))}catch{}const u=Ue(je(V,"transactions"),ae("merchantUserId","==",s.uid),ae("linkedDebtId","==",me.id),ae("status","==","pending")),g=await Qe(u);await Promise.allSettled(g.docs.map(I=>ts(I.ref,{status:"completed",confirmedAt:new Date})));try{const I=g.docs.map(T=>{var P;return String(T.id||((P=T.data())==null?void 0:P.transactionId)||"")});s!=null&&s.uid&&I.forEach(T=>T&&pe.removeLocalReceiptById(s.uid,T))}catch{}})().catch(m=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",m),i({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(m){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",m)}try{const m=Yi(),x=localStorage.getItem(m);if(x){const S=(JSON.parse(x)||[]).map(u=>(u==null?void 0:u.linkedDebtId)===me.id&&(u==null?void 0:u.status)==="pending"?{...u,status:"completed",confirmedAt:new Date}:u);localStorage.setItem(m,JSON.stringify(S)),xa(u=>u.map(g=>(g==null?void 0:g.linkedDebtId)===me.id&&(g==null?void 0:g.status)==="pending"?{...g,status:"completed",confirmedAt:new Date}:g))}}catch(m){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",m)}Ia(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(h,{onClick:async()=>{if(me){const t=Wt.filter(a=>a.id!==me.id);_s(t),await Vs(t),Ia(!1),i({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(ge,{open:Bd,onOpenChange:Nr,children:e.jsxs(fe,{className:"sm:max-w-md rounded-2xl shadow-elegant border border-gray-200",children:[e.jsxs(ye,{children:[e.jsx(be,{className:`text-right ${Ka==="decrease"?"text-red-600":"text-green-600"}`,children:Ka==="decrease"?"إنقاص مبلغ الدين":Ka==="increase"?"زيادة مبلغ الدين":"تعديل مبلغ الدين"}),e.jsxs(ps,{className:"text-right",children:["أدخل المبلغ ثم اضغط تأكيد لإتمام ",Ka==="decrease"?"الإنقاص":"الزيادة","."]})]}),e.jsxs("div",{className:"grid gap-4 py-2",children:[e.jsx(Z,{htmlFor:"debtAdjustAmount",className:"text-right",children:"المبلغ (جنيه)"}),e.jsx(U,{id:"debtAdjustAmount",type:"number",placeholder:"0.00",value:Gl,onChange:t=>bi(t.target.value)}),me&&e.jsxs("div",{className:"text-right text-sm text-muted-foreground",children:["المبلغ الحالي: ",e.jsx("span",{className:"font-semibold",children:Number(me.amount||0).toFixed(2)})," جنيه"]})]}),e.jsxs(lt,{className:"flex gap-2",children:[e.jsx(h,{variant:"secondary",onClick:()=>{Nr(!1),Ia(!0)},children:"إلغاء"}),e.jsx(h,{className:Ka==="decrease"?"bg-red-600 hover:bg-red-700":"bg-green-600 hover:bg-green-700",onClick:async()=>{try{if(!me||!Ka)return;const t=Number(parseFloat(Gl||"0").toFixed(2));if(!t||isNaN(t)||t<=0){i({title:"قيمة غير صالحة",description:"يرجى إدخال مبلغ أكبر من صفر",variant:"destructive"});return}Ql({debtId:me.id,delta:t,type:Ka}),Nr(!1),ir(!0)}catch(t){console.error("فشل تجهيز تعديل مبلغ الدين:",t),i({title:"خطأ",description:"تعذّر تجهيز تعديل مبلغ الدين",variant:"destructive"})}},children:"تأكيد"})]})]})}),e.jsx(ge,{open:Qd,onOpenChange:or,children:e.jsxs(fe,{className:"sm:max-w-[480px]",children:[e.jsxs(ye,{children:[e.jsx(be,{className:"text-right",children:"اختيار إضافة مبلغ السداد"}),e.jsx(ps,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 justify-center",children:[e.jsx(h,{variant:Fs==="cash"?"default":"outline",className:Fs==="cash"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>Aa("cash"),children:"الفلوس النقدية"}),e.jsx(h,{variant:Fs==="wallet"?"default":"outline",className:Fs==="wallet"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>Aa("wallet"),children:"أرصدة المحافظ"}),e.jsx(h,{variant:Fs==="fawry"?"default":"outline",className:Fs==="fawry"?"bg-amber-600 text-white":"",size:"sm",onClick:()=>Aa("fawry"),children:"فوري"}),e.jsx(h,{variant:Fs==="none"?"default":"outline",className:Fs==="none"?"bg-gray-600 text-white":"",size:"sm",onClick:()=>Aa("none"),children:"بدون إضافة"})]}),Fs==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:Ya,onChange:t=>Mi(t.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),He&&He.length>0?He.map(t=>e.jsx("option",{value:t.id,children:t.phone||t.name||t.id},t.id)):Object.keys(it||{}).map(t=>{var a,r,l,o,m,x;return e.jsx("option",{value:t,children:((a=He.find(y=>y.id===t))==null?void 0:a.phone)||((l=(r=JSON.parse(localStorage.getItem(Hi())||"[]"))==null?void 0:r.find(y=>y.id===t))==null?void 0:l.phone)||((m=(o=JSON.parse(localStorage.getItem(Hi())||"[]"))==null?void 0:o.find(y=>y.id===t))==null?void 0:m.name)||((x=He.find(y=>y.id===t))==null?void 0:x.name)||t},t)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[oo," جنيه"]})]})]}),e.jsxs(lt,{className:"flex flex-wrap justify-between gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{or(!1),wn(0),Aa(null),Mi("")},children:"إلغاء"}),e.jsx(h,{onClick:async()=>{var t,a;try{const r=oo;if(!r||r<=0){or(!1);return}if(Fs==="cash"){const l=Tt+r;Kt(l),localStorage.setItem(Cs(),l.toString());const o={cashBalance:l,lastUpdated:new Date().toISOString()},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(o)),s!=null&&s.uid?(pe.updateUserData(s.uid,o).catch(()=>Ge(!0)),localStorage.removeItem(m),Ge(!1)):Ge(!0),i({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى الفلوس النقدية`})}else if(Fs==="wallet"){if(!Ya){i({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const l={...it,[Ya]:(it[Ya]||0)+r};ds(l);const o=(Tt||0)-r;Kt(o),localStorage.setItem(Cs(),o.toString());const m=new Date().toISOString(),x={walletBalances:l,cashBalance:o,lastUpdated:m},y=`userData_${s==null?void 0:s.uid}`;if(localStorage.setItem(y,JSON.stringify(x)),localStorage.setItem(Ds(),JSON.stringify(l)),localStorage.setItem(`walletBalances_backup_${m}`,JSON.stringify(l)),s!=null&&s.uid){pe.updateUserData(s.uid,x).catch(()=>Ge(!0));try{localStorage.removeItem(y)}catch{}Ge(!1)}else Ge(!0);i({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى المحفظة ${((t=He.find(S=>S.id===Ya))==null?void 0:t.phone)||((a=He.find(S=>S.id===Ya))==null?void 0:a.name)||Ya} وتم خصم نفس المبلغ من درج النقدية`})}else if(Fs==="none"){const l=(Tt||0)-r;Kt(l),localStorage.setItem(Cs(),l.toString());const o={cashBalance:l,lastUpdated:new Date().toISOString()},m=`userData_${s==null?void 0:s.uid}`;if(localStorage.setItem(m,JSON.stringify(o)),s!=null&&s.uid){pe.updateUserData(s.uid,o).catch(()=>Ge(!0));try{localStorage.removeItem(m)}catch{}Ge(!1)}else Ge(!0);i({title:"تم تسجيل السداد",description:`تم خصم ${r} جنيه من درج النقدية بدون إضافة للمحافظ`})}else if(Fs==="fawry")i({title:"تم تسجيل سداد عبر فوري",description:`تم تسجيل ${r} جنيه كسداد عبر فوري بدون تعديل الأرصدة`});else{i({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}}catch(r){console.error("خطأ أثناء إضافة مبلغ السداد:",r),i({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{or(!1),wn(0),Aa(null),Mi("")}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(ge,{open:gd,onOpenChange:Va,children:e.jsxs(fe,{hideClose:!0,className:"post-confirm-card sm:max-w-[420px] w-[90vw] rounded-2xl bg-gradient-to-br from-white via-indigo-50 to-blue-50 shadow-2xl border border-indigo-100",children:[e.jsxs(ye,{children:[e.jsx(be,{className:"text-right text-2xl font-bold",children:(cs==null?void 0:cs.type)==="transfer"?"مبلغ يجب استلامه":"مبلغ يجب تسليمه"}),e.jsx(ps,{className:"text-right text-gray-600",children:(cs==null?void 0:cs.type)==="transfer"?"هذا هو المبلغ الواجب استلامه من العميل بعد التأكيد.":"هذا هو المبلغ الواجب تسليمه للعميل بعد التأكيد."})]}),e.jsxs("div",{className:"py-3 flex flex-col items-center gap-1.5",children:[e.jsxs("div",{className:"text-xl sm:text-2xl font-bold text-blue-700 tracking-wide",children:[Ns((cs==null?void 0:cs.amount)||0)," جنيه"]}),e.jsx("div",{className:"text-sm text-gray-500 text-right w-full",children:(cs==null?void 0:cs.type)==="transfer"?"المبلغ المعروض شامل عمولة التحويل.":yt?"العمولة مضافة ولا تؤثر على قيمة التسليم.":"العمولة مخصومة من المبلغ المسلّم للعميل."})]}),e.jsxs(lt,{className:"flex justify-end gap-2",children:[(cs==null?void 0:cs.type)==="transfer"&&e.jsx(h,{variant:"outline",id:"sendCodeBtn",onClick:gt,disabled:Ml,className:"btn-transfer-confirm",children:Ml?"جارٍ الإرسال...":"إرسال كود التحويل"}),e.jsx(h,{onClick:()=>{Va(!1),mi(null)},className:"bg-green-600 hover:bg-green-700 text-white",children:(cs==null?void 0:cs.type)==="transfer"?"تم الاستلام":"تم التسليم"})]})]})}),e.jsx(Lh,{open:yd,onClose:()=>rr(!1),onSubmit:ot,deviceId:Ll||Pt||"",recipientMsisdn:String(re==="transfer"?(ks==null?void 0:ks.receiver)||js||"":((Jo=He.find(t=>t.id===X))==null?void 0:Jo.phone)||"").replace(/\D/g,"")}),e.jsx(Pu,{open:$,onOpenChange:ve}),$l]}))};export{$x as default};
