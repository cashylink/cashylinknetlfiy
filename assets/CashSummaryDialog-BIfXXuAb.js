import{R as n,l as Oe,ae as Me,u as Ee,j as e,af as z,ag as G,ah as H,ai as K,B as k,aE as ce,x as ie,I as oe,ad as C,q as E,p as _,s as w,aF as S,Q as _e,$ as de,T as F,ar as le,w as Q}from"./index-CzMrJEuC.js";import{D as me}from"./dollar-sign-0aC_iCk7.js";import{P as Fe}from"./UserDashboardPage-njIiAjYE.js";import{A as $e}from"./SimCardsAccessDialog-p84rP6ZI.js";import{B as Ie}from"./battery-charging-CICy0gwc.js";import"./ProfileSettingsPage-C3UNZtns.js";import"./switch-BsQLD5QZ.js";import"./square-pen-BXn6dQmK.js";import"./textarea-DH9YvORw.js";import"./select-DHMtOuee.js";import"./users-DCm2SxTc.js";import"./circle-x-BIAaVYIX.js";import"./circle-check-big-CujdvfsP.js";import"./save-C_zXO1pj.js";import"./refresh-cw-oGf6rkWG.js";import"./crown-CHbbJHO0.js";import"./arrow-left-DE7YICBa.js";import"./badge-D-234tiw.js";import"./tabs-CUOI6ynQ.js";import"./index-BBRmOonx.js";import"./dropdown-menu-BbnyNGMu.js";import"./ProfileIcon-CoHGJzAB.js";import"./freeTrialService-BlbSJwfx.js";import"./broadcastService-D5PHNSZD.js";import"./bell-BJOCCReM.js";import"./profitService-D3SXiBSD.js";import"./calendar-DNLMAp6O.js";import"./arrow-down-left-Do7B1AJE.js";import"./wallet-BpRPCgGm.js";import"./printer-BxRsauDr.js";import"./star-C4GDXCGa.js";const ft=({open:b,onOpenChange:he,userId:r,cashBalance:A,walletBalances:Pe,transactions:ge})=>{const[xe,J]=n.useState(0),[ue,$]=n.useState(0),[be,V]=n.useState(0),[fe,W]=n.useState(0),[pe,X]=n.useState(0),[ye,Y]=n.useState(0),[I,N]=n.useState(A||0),[Z,ve]=n.useState(0),[ke,D]=n.useState(!1),[ee,R]=n.useState(null),{toast:j}=Oe(),{shopId:u}=Me()||{},{profile:l}=Ee(),[we,B]=n.useState(!1),[P,U]=n.useState(""),[Ne,L]=n.useState(!1),[je,O]=n.useState(!1),[te,q]=n.useState(""),T=()=>`cashBalance_${r||"default"}_${u||(l==null?void 0:l.shopId)||"main"}`,M=a=>`${new Intl.NumberFormat("ar-EG").format(Number(a||0))} جنيه`;n.useEffect(()=>{let a;return(async()=>{if(!b||!r){b||J(0);return}try{const s=await C.getUserData(r),c=s==null?void 0:s.lastReceipt_accessory,m=c?new Date(c):new Date(0),o=m.toISOString().slice(0,10),y=E(_(w,"dailySales"),S("userId","==",r),...u?[S("shopId","==",u)]:[],S("date",">=",o));a=_e(y,h=>{let g=0;h.forEach(f=>{var x;const d=f.data();if(d.isDeferred)return;let i=0;if((x=d.createdAt)!=null&&x.toDate?i=d.createdAt.toDate().getTime():d.createdAt instanceof Date?i=d.createdAt.getTime():d.date&&(i=new Date(d.date+"T"+(d.time||"00:00")).getTime()),i>m.getTime()){const v=Number(d.sellingPrice??0),p=Number(d.quantity??0);v>0&&p>0&&(g+=v*p)}}),J(g),$(0)},h=>{console.warn("Error listening to daily sales:",h)})}catch(s){console.warn("Failed to setup accessory sales listener:",s)}})(),()=>{a&&a()}},[b,r,u,Z]),n.useEffect(()=>{if(!b)return;(async()=>{let t={};try{r&&(t=await C.getUserData(r)||{})}catch{}const s=async()=>{try{if(!r){V(0);return}const o=t==null?void 0:t.lastReceipt_maintenance,y=o?new Date(o).getTime():0;let h;try{const f=E(_(w,"maintenance_items"),S("userId","==",r),S("status","==","completed"));h=await Q(f)}catch{h=await Q(E(_(w,"maintenance_items"),S("userId","==",r)))}let g=0;h.forEach(f=>{var x,v;const d=f.data();if((d.status||"in_progress")!=="completed")return;const i=(v=(x=d.completedAt)==null?void 0:x.toDate)==null?void 0:v.call(x);if(i&&i.getTime()>y){const p=Number(d.repairPrice||0);Number.isFinite(p)&&p>0&&(g+=p)}}),V(Math.max(0,g)),W(0)}catch(o){console.warn("فشل تحميل إجمالي فلوس الصيانة لليوم:",o)}},c=async()=>{try{if(!r){X(0);return}const o=t==null?void 0:t.lastReceipt_machineCharging,y=o?new Date(o).getTime():0,h=E(_(w,"userTransactions"),S("userId","==",r)),g=await Q(h);let f=0;g.forEach(d=>{var ne;const i=d.data();let x=0;if((ne=i.createdAt)!=null&&ne.toDate?x=i.createdAt.toDate().getTime():typeof i.createdAt=="string"&&(x=new Date(i.createdAt).getTime()),x<=y)return;const v=String(i.description||""),p=String(i.title||""),Re=i.title==="إيصال تحويل مكينه"||v.includes("تحويل مكنه")||v.includes("تحويل مكينه")||p.includes("تحويل مكنه")||p.includes("تحويل مكينه"),Be=i.status==="completed"||i.status==="confirmed";Re&&Be&&(f+=Number(i.amount)||0)}),X(f),Y(0)}catch(o){console.warn(o)}},m=async()=>{var o;try{if(!r){$(0);return}try{const y=u||(l==null?void 0:l.shopId)||"main",h=await de(F(w,"dashboardData",y));if(h.exists()){const g=Number(((o=h.data())==null?void 0:o.cashBalance)||0);N(g);try{localStorage.setItem(`cashBalance_${r}`,String(g)),localStorage.setItem(T(),String(g))}catch{}}else N(Number((t==null?void 0:t.cashBalance)||A||0))}catch{N(Number((t==null?void 0:t.cashBalance)||A||0))}}catch{$(0),W(0),Y(0)}};await s(),await c(),await m()})()},[b,r,ge,A,u,Z]),n.useEffect(()=>{const a=t=>{var s;try{const c=Number((s=t==null?void 0:t.detail)==null?void 0:s.value);Number.isFinite(c)&&N(c)}catch{}};return window.addEventListener("cashBalanceChanged",a),()=>window.removeEventListener("cashBalanceChanged",a)},[b]),n.useEffect(()=>{if(!b||!r)return;const a=u||(l==null?void 0:l.shopId)||"main";return(async()=>{var s;try{const c=await de(F(w,"dashboardData",a));if(c.exists()){const m=Number(((s=c.data())==null?void 0:s.cashBalance)||0);N(m);try{localStorage.setItem(`cashBalance_${r}`,String(m)),localStorage.setItem(T(),String(m))}catch{}}}catch(c){console.warn("Error fetching dashboard data:",c)}})(),()=>{}},[b,r,u]);const ae=Math.max(0,Number(xe)-Number(ue)),re=Math.max(0,Number(be)-Number(fe)),se=Math.max(0,Number(pe)-Number(ye)),Se=async a=>{if(r){new Date().toISOString().slice(0,10);try{let t=0;if(a==="accessory"?t=ae:a==="maintenance"?t=re:a==="machineCharging"&&(t=se),t<=0){j({title:"لا يوجد مبلغ لتأكيد استلامه",variant:"default"});return}const s=Math.max(0,Number(I)-t);N(s);const c=new Date().toISOString();await C.updateUserData(r,{cashBalance:s,[`lastReceipt_${a}`]:c});try{const o=u||(l==null?void 0:l.shopId)||"main";await le(F(w,"dashboardData",o),{cashBalance:s,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${r}`,String(s)),localStorage.setItem(T(),String(s))}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:s}}))}catch{}ve(Date.now());let m="";a==="accessory"?m="الإكسسوار":a==="maintenance"?m="الصيانة":m="مكن الشحن",j({title:"تم الاستلام",description:`تم خصم ${t.toFixed(2)} من الدرج وتصفير بند ${m}`})}catch{j({title:"خطأ",description:"تعذر تنفيذ عملية تم الاستلام",variant:"destructive"})}}},De=()=>{U(""),q(""),B(!0)},Te=()=>{if(!P.trim()){j({title:"سبب الخصم مطلوب",variant:"destructive"});return}B(!1),L(!0)},Ce=()=>{L(!1),O(!0)},Ae=async()=>{try{if(!r)return;const a=Math.max(0,Number(te||0));if(!Number.isFinite(a)||a<=0){j({title:"مبلغ غير صالح",description:"أدخل مبلغ خصم صحيح أكبر من الصفر",variant:"destructive"});return}const t=Math.max(0,Number(I)-a);N(t),await C.updateUserData(r,{cashBalance:t});try{const c=u||(l==null?void 0:l.shopId)||"main";await le(F(w,"dashboardData",c),{cashBalance:t,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${r}`,String(t))}catch{}try{const c=new Date().toISOString();localStorage.setItem(T(),String(t)),localStorage.setItem(T()+"_lastUpdated",c)}catch{}const s={title:"ايصال خصم من الفلوس النقديه",type:"cash_deduction",amount:a,status:"completed",createdAt:new Date,note:P,cashierName:"الحساب الرئيسي"};try{await C.saveUserTransaction(r,s)}catch{}j({title:"تم الخصم",description:`تم خصم ${a.toFixed(2)} من الدرج`}),O(!1),q(""),U("")}catch{j({title:"فشل الخصم",description:"تعذر تنفيذ عملية الخصم",variant:"destructive"})}};return e.jsx(z,{open:b,onOpenChange:he,children:e.jsxs(G,{className:"sm:max-w-lg animate-in fade-in-90 zoom-in-95 slide-in-from-top-4 bg-white dark:bg-gray-900 border-gray-200 dark:border-gray-800",dir:"rtl",children:[e.jsx(H,{children:e.jsxs(K,{className:"flex items-center gap-2 text-right text-gray-900 dark:text-gray-100",children:[e.jsx(me,{className:"h-5 w-5 text-emerald-600 dark:text-emerald-500"}),"تفاصيل الفلوس النقدية"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-900/50 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 dark:text-amber-300 font-bold text-sm",children:[e.jsx(me,{className:"h-4 w-4"}),"مجموع الفلوس النقدية (الدرج)"]}),e.jsx("div",{className:"text-amber-700 dark:text-amber-400 font-extrabold text-sm",children:M(I)})]}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-900/50 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 dark:text-blue-300 font-bold text-sm",children:[e.jsx(Fe,{className:"h-4 w-4"}),"فلوس الاكسسوار"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-blue-700 dark:text-blue-400 font-extrabold text-sm",children:M(ae)}),e.jsx(k,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 dark:from-blue-900/50 dark:to-blue-800/50 dark:text-blue-200 dark:hover:from-blue-800 dark:hover:to-blue-700",onClick:()=>{R("accessory"),D(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-emerald-50 dark:bg-emerald-950/30 border border-emerald-200 dark:border-emerald-900/50 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-800 dark:text-emerald-300 font-bold text-sm",children:[e.jsx($e,{className:"h-4 w-4"}),"فلوس الصيانة"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-emerald-700 dark:text-emerald-400 font-extrabold text-sm",children:M(re)}),e.jsx(k,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800 dark:from-emerald-900/50 dark:to-emerald-800/50 dark:text-emerald-200 dark:hover:from-emerald-800 dark:hover:to-emerald-700",onClick:()=>{R("maintenance"),D(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-violet-50 dark:bg-violet-950/30 border border-violet-200 dark:border-violet-900/50 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-violet-800 dark:text-violet-300 font-bold text-sm",children:[e.jsx(Ie,{className:"h-4 w-4"}),"مكن الشحن"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-violet-700 dark:text-violet-400 font-extrabold text-sm",children:M(se)}),e.jsx(k,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-violet-100 to-violet-200 text-violet-700 hover:from-violet-200 hover:to-violet-300 hover:text-violet-800 dark:from-violet-900/50 dark:to-violet-800/50 dark:text-violet-200 dark:hover:from-violet-800 dark:hover:to-violet-700",onClick:()=>{R("machineCharging"),D(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-900/50 rounded-lg p-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-red-800 dark:text-red-300 font-bold text-sm",children:"خصم فلوس من الفلوس النقديه"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(k,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 dark:from-red-900/50 dark:to-red-800/50 dark:text-red-200 dark:hover:from-red-800 dark:hover:to-red-700",onClick:De,children:"خصم"})})]})]}),e.jsx(ce,{open:ke,onOpenChange:D,mode:"verify",title:"تأكيد الرقم السري لعملية تم الاستلام",description:"يرجى إدخال الرقم السري الرئيسي لتأكيد استلام المبلغ",onSuccess:()=>{ee&&(Se(ee),R(null)),D(!1)}}),e.jsx(z,{open:we,onOpenChange:B,children:e.jsxs(G,{className:"sm:max-w-sm bg-white dark:bg-gray-900 border-gray-200 dark:border-gray-800",children:[e.jsx(H,{children:e.jsx(K,{className:"text-gray-900 dark:text-gray-100",children:"سبب الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{htmlFor:"deduct-reason",className:"text-gray-900 dark:text-gray-100",children:"اكتب سبب الخصم"}),e.jsx(oe,{id:"deduct-reason",value:P,onChange:a=>U(a.target.value),placeholder:"سبب الخصم",className:"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-900 dark:text-gray-100"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(k,{variant:"outline",onClick:()=>B(!1),className:"dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-800",children:"إلغاء"}),e.jsx(k,{onClick:Te,className:"bg-red-600 hover:bg-red-700 text-white",children:"متابعة"})]})]})}),e.jsx(ce,{open:Ne,onOpenChange:L,mode:"verify",title:"تأكيد الرقم السري لعملية الخصم",description:"يرجى إدخال الرقم السري الرئيسي لمتابعة الخصم",onSuccess:Ce}),e.jsx(z,{open:je,onOpenChange:O,children:e.jsxs(G,{className:"sm:max-w-sm bg-white dark:bg-gray-900 border-gray-200 dark:border-gray-800",children:[e.jsx(H,{children:e.jsx(K,{className:"text-gray-900 dark:text-gray-100",children:"مبلغ الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{htmlFor:"deduct-amount",className:"text-gray-900 dark:text-gray-100",children:"أدخل مبلغ الخصم"}),e.jsx(oe,{id:"deduct-amount",type:"number",value:te,onChange:a=>q(a.target.value),placeholder:"0.00",className:"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-900 dark:text-gray-100"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(k,{variant:"outline",onClick:()=>O(!1),className:"dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-800",children:"إلغاء"}),e.jsx(k,{onClick:Ae,className:"bg-red-600 hover:bg-red-700 text-white",children:"تأكيد الخصم"})]})]})})]})})};export{ft as CashSummaryDialog,ft as default};
//# sourceMappingURL=CashSummaryDialog-BIfXXuAb.js.map
