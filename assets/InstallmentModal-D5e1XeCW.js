import{u as ne,r as l,j as e,af as le,ag as re,ah as ie,ai as ce,B as d,I as o,a2 as de,aC as y,aD as m,E as oe}from"./index-BhZSAJfd.js";import{B as U}from"./badge-BAx1Ncm_.js";import{C as me,V as xe}from"./VideoModal-CXkz9C08.js";import{A as W,m as H}from"./SimCardsAccessDialog-DN5nB1W3.js";import{C as he}from"./calendar-BlcmveZO.js";import"./select-eWZ9mGwi.js";const fe=({open:w,onOpenChange:Q})=>{const{user:i}=ne(),[Y,k]=l.useState(!1),[P,M]=l.useState(!1),[D,Z]=l.useState([]),[n,h]=l.useState(null),[S,_]=l.useState(""),I=s=>s!=null&&s.toDate?s.toDate():s?new Date(s):new Date,X=(s,t)=>new Date(s.getFullYear(),s.getMonth()+t,s.getDate()),q=s=>{var a;const t=I(s.createdAt),r=((a=(s.paidMonths||[]).find(c=>!c.paid))==null?void 0:a.month)||1;return X(t,r-1)},[C,z]=l.useState(""),[E,L]=l.useState(""),[F,B]=l.useState(""),[j,O]=l.useState(""),[N,T]=l.useState(""),[g,V]=l.useState(""),[v,$]=l.useState(""),J=l.useMemo(()=>{const s=Number(j||0),t=Number(N||0),r=Number(g||0),a=Number(v||0);if(!s||!a)return"";const p=Math.max(0,a-r)*(1+t/100),x=Math.round(p/s*100)/100;return isNaN(x)?"":String(x)},[j,N,g,v]);l.useEffect(()=>{if(!w||!(i!=null&&i.uid))return;(async()=>{try{const r=[...await y.getByUser(i.uid)].sort((a,c)=>{var f,u;const p=(f=a.createdAt)!=null&&f.toMillis?a.createdAt.toMillis():a.createdAt||0;return((u=c.createdAt)!=null&&u.toMillis?c.createdAt.toMillis():c.createdAt||0)-p});Z(r)}catch(t){console.error("Error fetching installments:",t)}})()},[w,i==null?void 0:i.uid]);const G=()=>{z(""),L(""),B(""),O(""),T(""),V(""),$("")},K=async()=>{try{if(!(i!=null&&i.uid))return;const s=Number(j||0),t=Number(N||0),r=Number(g||0),a=Number(v||0);if(!C||!s||!a){m({title:"بيانات غير مكتملة",description:"أدخل الاسم، عدد الشهور، والسعر الإجمالي."});return}const p=Math.max(0,a-r)*(1+t/100),x=Math.round(p/s*100)/100,f=Array.from({length:s},(pe,ae)=>({month:ae+1,paid:!1,amount:x})),u={userId:i.uid,customerName:C,deviceName:E||void 0,phone:F||void 0,months:s,percentage:t||0,downPayment:r||0,totalPrice:a,monthlyPayment:x,createdAt:oe(),status:"active",paidMonths:f},se=await y.create(i.uid,u);M(!1),G();const te={id:se,...u};h(te),m({title:"تم إضافة القسط",description:"تم إنشاء خطة التقسيط."})}catch{m({title:"تعذر إضافة القسط",description:"تحقق من الاتصال.",variant:"destructive"})}},ee=async s=>{try{if(!n)return;const t=n.id,r=(n.paidMonths||[]).map((a,c)=>c===s?{...a,paid:!0,paidAt:new Date}:a);await y.markMonthPaid(t,r),h({...n,paidMonths:r}),m({title:"تم الدفع",description:`تم دفع الشهر ${s+1}.`})}catch(t){console.error("markPaid error",t),m({title:"فشل تحديث الدفع",description:String((t==null?void 0:t.message)||"تحقق من الاتصال والصلاحيات."),variant:"destructive"})}},b=l.useMemo(()=>{if(!n)return{remainingMonths:0,remainingAmount:0};const s=n.paidMonths||[],t=s.filter(a=>!a.paid).length,r=Math.round(s.filter(a=>!a.paid).reduce((a,c)=>a+c.amount,0)*100)/100;return{remainingMonths:t,remainingAmount:r}},[n]),[R,A]=l.useState(null);return e.jsx(le,{open:w,onOpenChange:Q,children:e.jsxs(re,{className:"sm:max-w-[720px]",dir:"rtl",children:[e.jsx(ie,{children:e.jsxs(ce,{className:"flex items-center gap-2 justify-center",children:["إدارة التقسيط",e.jsxs(d,{variant:"ghost",size:"sm",onClick:()=>k(!0),className:"gap-1 px-2 text-rose-600 hover:text-rose-700 hover:bg-rose-50 mx-2",children:[e.jsx(me,{className:"h-4 w-4"}),e.jsx("span",{className:"text-xs font-medium",children:"شرح قسم التقسيط"})]})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex-1 max-w-[220px]",children:e.jsx(o,{value:S,onChange:s=>_(s.target.value),placeholder:"ابحث بالاسم أو الهاتف"})}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-8 w-8 rounded-full bg-purple-600 text-white hover:bg-purple-700",onClick:()=>{M(!0),h(null)},title:"إضافة قسط",children:e.jsx(de,{className:"h-4 w-4"})})]}),e.jsx(W,{children:P&&e.jsxs(H.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},exit:{opacity:0,y:-12},className:"rounded border p-3 bg-white dark:bg-[#1A1A1A]",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs",children:"اسم العميل"}),e.jsx(o,{value:C,onChange:s=>z(s.target.value),placeholder:"الاسم"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs",children:"اسم الجهاز"}),e.jsx(o,{value:E,onChange:s=>L(s.target.value),placeholder:"اسم الجهاز"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs",children:"رقم الهاتف"}),e.jsx(o,{value:F,onChange:s=>B(s.target.value),placeholder:"01XXXXXXXXX",dir:"ltr"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs",children:"السعر الإجمالي"}),e.jsx(o,{type:"number",min:1,value:v,onChange:s=>$(s.target.value?Number(s.target.value):""),placeholder:"1500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs",children:"عدد الشهور"}),e.jsx(o,{type:"number",min:1,max:60,value:j,onChange:s=>O(s.target.value?Number(s.target.value):""),placeholder:"12"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs",children:"نسبة التقسيط %"}),e.jsx(o,{type:"number",min:0,max:100,value:N,onChange:s=>T(s.target.value?Number(s.target.value):""),placeholder:"10"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs",children:"مقدم"}),e.jsx(o,{type:"number",min:0,value:g,onChange:s=>V(s.target.value?Number(s.target.value):""),placeholder:"200"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs",children:"القسط الشهري"}),e.jsx(o,{value:J,readOnly:!0,placeholder:"سيظهر تلقائياً"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 pt-2",children:[e.jsx(d,{variant:"outline",onClick:()=>{M(!1),G()},children:"إلغاء"}),e.jsx(d,{className:"bg-purple-600 text-white hover:bg-purple-700",onClick:K,children:"بدء القسط"})]})]})}),!P&&!n&&e.jsx("div",{className:"space-y-2 max-h-[380px] overflow-y-auto",children:D.length===0?e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد أقساط نشطة"}):D.filter(s=>{const t=S.trim();if(!t)return!0;const r=t.toLowerCase();return(s.customerName||"").toLowerCase().includes(r)||(s.phone||"").includes(t)}).map(s=>e.jsx("div",{className:"w-full p-2 bg-white dark:bg-[#1A1A1A] rounded border hover:border-purple-400 transition",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("button",{onClick:()=>h(s),className:"flex-1 text-left",children:[e.jsxs("p",{className:"text-sm font-semibold",children:[s.customerName," ",e.jsxs("span",{className:"text-gray-600",children:["— ",s.deviceName||"بدون"]})]}),e.jsx("p",{className:"text-[11px] text-gray-600",children:s.phone||""}),e.jsxs("p",{className:"text-[11px] text-purple-700 dark:text-purple-400",children:["شهرياً: ",s.monthlyPayment," جنيه"]}),e.jsxs("p",{className:"text-[11px] text-gray-700",children:["تاريخ الاستحقاق: ",q(s).toLocaleDateString("ar-EG")]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(U,{className:"bg-purple-100 text-purple-800",children:[s.months," شهر"]}),e.jsx(d,{size:"sm",className:"bg-red-600 text-white hover:bg-red-700",onClick:async t=>{t.stopPropagation();try{await y.remove(s.id),m({title:"تم الحذف",description:"تم حذف القسط نهائياً."})}catch{m({title:"تعذر الحذف",description:"تحقق من الاتصال والصلاحيات.",variant:"destructive"})}},children:"حذف"})]})]})},s.id))}),n&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-bold",children:n.customerName}),e.jsx("p",{className:"text-[11px] text-gray-600",children:n.deviceName||""})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-sm text-gray-700",children:["القسط الشهري: ",n.monthlyPayment," جنيه"]}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["متبقي: ",b.remainingMonths," شهر • ",b.remainingAmount," جنيه"]})]})]}),e.jsx("div",{className:"flex items-center justify-between",children:e.jsx(d,{variant:"secondary",onClick:()=>h(null),children:"رجوع للقائمة"})}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-[360px] overflow-y-auto",children:(n.paidMonths||[]).map((s,t)=>e.jsxs("div",{className:`p-2 rounded border ${s.paid?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(he,{className:`h-4 w-4 ${s.paid?"text-green-600":"text-red-600"}`}),e.jsxs("span",{className:"text-sm",children:["شهر ",s.month]}),e.jsx("span",{className:"text-[11px] text-gray-600",children:X(I(n.createdAt),s.month-1).toLocaleDateString("ar-EG")})]}),e.jsx(U,{className:s.paid?"bg-green-100 text-green-800":"bg-red-100 text-red-800",children:s.paid?"مدفوع":"غير مدفوع"})]}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsxs("span",{className:`text-sm ${s.paid?"text-green-700":"text-red-700"}`,children:[s.amount," جنيه"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[!s.paid&&e.jsx(d,{size:"sm",className:"bg-green-600 text-white hover:bg-green-700",onClick:()=>ee(t),children:"تم الدفع"}),e.jsx(d,{size:"sm",className:"bg-yellow-500 text-white hover:bg-yellow-600",onClick:()=>A({month:s.month}),children:"إيصال"})]})]})]},t))})]}),e.jsx(W,{children:R&&n&&e.jsxs(H.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>A(null)}),e.jsx("div",{className:"relative z-50 flex items-center justify-center min-h-screen p-4",children:e.jsxs("div",{className:"w-full max-w-md bg-white dark:bg-[#121212] rounded-xl border-2 border-purple-200 shadow-lg",children:[e.jsxs("div",{className:"p-4 text-center space-y-2",children:[e.jsx("div",{className:"text-xl font-extrabold tracking-wide text-purple-700",children:"cashy link"}),e.jsx("div",{className:"text-sm font-bold text-purple-700",children:"إيصال قسط"})]}),e.jsx("div",{className:"px-4",children:e.jsx("div",{className:"h-px bg-purple-200"})}),e.jsxs("div",{className:"p-4 space-y-3 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-purple-700",children:"العميل"}),e.jsx("span",{className:"font-semibold",children:n.customerName})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-purple-700",children:"الجهاز"}),e.jsx("span",{className:"font-semibold",children:n.deviceName||"بدون"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-purple-700",children:"الهاتف"}),e.jsx("span",{className:"font-semibold",children:n.phone||""})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-purple-700",children:"الشهر"}),e.jsx("span",{className:"font-semibold",children:R.month})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-purple-700",children:"التاريخ"}),e.jsx("span",{className:"font-semibold",children:new Date().toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center justify-between font-bold text-lg",children:[e.jsx("span",{children:"المبلغ"}),e.jsxs("span",{className:"text-purple-700",dir:"ltr",children:[e.jsx("span",{className:"font-mono",children:n.monthlyPayment})," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-purple-700",children:"متبقي"}),e.jsxs("span",{className:"font-semibold",children:[b.remainingMonths," شهر • ",b.remainingAmount," جنيه"]})]})]}),e.jsxs("div",{className:"px-4 pb-4 flex items-center justify-between gap-2",children:[e.jsx(d,{variant:"outline",onClick:()=>A(null),children:"إغلاق"}),e.jsx(d,{className:"bg-purple-600 text-white hover:bg-purple-700",onClick:()=>window.print(),children:"طباعة"})]}),e.jsx("div",{className:"text-center text-xs text-gray-500 pb-4",children:"cashy-link.com"})]})})]})}),e.jsx(xe,{isOpen:Y,onClose:()=>k(!1),videoUrl:"https://www.youtube.com/watch?v=IO2yZUDkNLQ&t=1s",title:"شرح قسم التقسيط",className:"z-[10002]"})]})]})})};export{fe as default};
//# sourceMappingURL=InstallmentModal-D5e1XeCW.js.map
