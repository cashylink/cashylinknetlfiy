const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./UserDashboardPage-3JMtMQae.js","./index-CpSuNyR6.js","./index-Bmklj-Zt.css","./card-BqRT_Nkf.js","./badge-DVugqKes.js","./select-Bo6-5BCo.js","./label-iAAbTejB.js","./MasterPinDialog-ycS94SJm.js","./circle-alert-B72PReNB.js","./wallet-DHEfW4tf.js","./star-CWzwqUZr.js","./square-pen-B6KNbT-j.js","./progress-DeC-Kpt6.js","./phone-CmWt1at1.js","./arrow-left-CZ4Sgyxt.js","./separator-DhSvPD57.js","./dollar-sign-DMbnB3A9.js","./ProfileIcon-D0q3G3qF.js","./dropdown-menu-U82PPSq2.js","./index-oriu1PZ7.js","./switch-CKdCGDFN.js","./circle-x-Cp9nsv_j.js","./circle-check-big-Bv_dG87s.js","./MaintenanceDialog-dM3h1sGw.js","./whatsappService-BLnGfqC0.js","./download-B-slC7b1.js","./profitService-DT3Yty7u.js","./store-BUpV1btK.js","./broadcastService-C7pC-IsN.js","./textarea-_yvnJ6fE.js","./WalletsManagement-C5GIPZ3s.js","./walletSelectionPinService-CwqoXcOh.js","./crown-Bse_egto.js","./refresh-cw-CyAu4JsZ.js"])))=>i.map(i=>d[i]);
import{u as z,r as h,a1 as W,a as Q,x as J,i as M,y as X,j as i,ax as Z,P as ee,ay as te,c as ae,ai as V,an as U,R as H,_ as se}from"./index-CpSuNyR6.js";import{s as ie,E as re}from"./broadcastService-C7pC-IsN.js";import{L as oe}from"./link-B8FO2oz1.js";import{M as K}from"./MasterPinDialog-ycS94SJm.js";import"./label-iAAbTejB.js";import"./circle-alert-B72PReNB.js";const T="dismissedBroadcastIds",ne=()=>{const{user:a,profile:e,isSubscriptionActive:n,userSubscription:u}=z(),[A,p]=h.useState(null),[t,S]=h.useState(!1),[P,y]=h.useState(!1),[I,w]=h.useState([]),j=W(),k=Q(),b=h.useMemo(()=>`dismissedBroadcastIds:${(a==null?void 0:a.uid)||"global"}`,[a==null?void 0:a.uid]),_=h.useMemo(()=>{const r=["global"];return e!=null&&e.shopId&&r.push(`shop:${e.shopId}`),a!=null&&a.uid&&r.push(`user:${a.uid}`),r},[e==null?void 0:e.shopId,a==null?void 0:a.uid]),D=j.pathname.startsWith("/admin");h.useEffect(()=>{if(!(a!=null&&a.uid))return;const r=J(M,"users",a.uid),l=X(r,o=>{const g=o.data(),v=Array.isArray(g==null?void 0:g.dismissedBroadcastIds)?g.dismissedBroadcastIds:[];w(v);try{const m=localStorage.getItem(b),d=m?JSON.parse(m):[],s=Array.from(new Set([...Array.isArray(d)?d:[],...v]));localStorage.setItem(b,JSON.stringify(s)),localStorage.setItem(T,JSON.stringify(s))}catch{}},o=>{console.error("UserBroadcastModal: onSnapshot user error",o)});return()=>l()},[a==null?void 0:a.uid,b]),h.useEffect(()=>{if(!a||D||!((e==null?void 0:e.approved)===!0||n||(u==null?void 0:u.isOnFreeTrial)===!0))return;const l=ie(_,o=>{if(o){p(o);try{const g=localStorage.getItem(b),v=localStorage.getItem(T),m=g?JSON.parse(g):[],d=v?JSON.parse(v):[],s=Array.isArray(m)?[...m]:[];if(Array.isArray(d))for(const x of d)s.includes(x)||s.push(x);if(Array.isArray(I))for(const x of I)s.includes(x)||s.push(x);const f=o.id&&s.includes(o.id);S(!f),y(!1),requestAnimationFrame(()=>y(!0))}catch{S(!0),y(!0)}}});return()=>l()},[a,_,D,e==null?void 0:e.approved,n,u,I]);const c=async()=>{S(!1);try{const r=localStorage.getItem(b),l=r?JSON.parse(r):[],o=A==null?void 0:A.id;if(o&&!l.includes(o)){l.push(o),localStorage.setItem(b,JSON.stringify(l));try{localStorage.setItem(T,JSON.stringify(l))}catch{}try{a!=null&&a.uid&&await ee(J(M,"users",a.uid),{dismissedBroadcastIds:te(o)})}catch(g){console.warn("UserBroadcastModal: failed to update dismissedBroadcastIds in Firestore",g)}}}catch{}};return!t||!A?null:i.jsxs("div",{className:"fixed inset-0 z-[9999]",children:[i.jsx("div",{className:`absolute inset-0 transition-opacity duration-300 ease-out ${P?"opacity-100":"opacity-0"} bg-black/20 dark:bg-black/20`}),i.jsxs("div",{className:`absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] sm:w-auto sm:min-w-[380px] sm:max-w-md md:max-w-lg bg-white shadow-2xl rounded-2xl border border-gray-100 ring-1 ring-black/5 transition-all duration-300 ease-out ${P?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:[i.jsx("div",{className:"relative overflow-hidden rounded-t-2xl",children:i.jsxs("div",{className:"bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 relative",children:[i.jsx("button",{"aria-label":"Ø¥ØºÙ„Ø§Ù‚",onClick:c,className:"absolute top-3 right-3 p-2 rounded-full bg-white/10 hover:bg-white/20",children:i.jsx(Z,{className:"w-5 h-5 text-white"})}),i.jsx("div",{className:"p-4",children:i.jsx("h3",{className:"text-base sm:text-lg font-semibold text-white tracking-wide text-center",children:A.title||"Ø¥Ø´Ø¹Ø§Ø±"})})]})}),i.jsx("div",{className:"p-5",children:i.jsxs("div",{className:"flex items-start justify-between gap-3",children:[i.jsx("p",{className:"text-gray-700 leading-relaxed text-sm sm:text-base",children:A.message}),A.linkUrl&&i.jsxs("button",{"aria-label":"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·",title:"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·",onClick:()=>{const r=A.linkUrl;/^https?:\/\//i.test(r)?window.open(r,"_blank","noopener"):k(r)},className:"shrink-0 inline-flex items-center gap-2 px-3 py-2 rounded-md bg-indigo-600 text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 whitespace-nowrap",children:[/^https?:\/\//i.test(A.linkUrl)?i.jsx(re,{className:"w-6 h-6"}):i.jsx(oe,{className:"w-6 h-6"}),i.jsx("span",{className:"text-xs sm:text-sm font-semibold",children:"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·"})]})]})})]})]})},q="quick_login_enabled",G="quick_login_session_verified";function Y(a){return a?`${q}_${a}`:q}function C(a){return a?`${G}_${a}`:G}const N={isEnabled(a){try{return localStorage.getItem(Y(a))==="true"}catch{return!1}},setEnabled(a,e){try{localStorage.setItem(Y(e),a?"true":"false"),sessionStorage.removeItem(C(e))}catch{}},isSessionVerified(a){try{return sessionStorage.getItem(C(a))==="true"}catch{return!1}},markSessionVerified(a){try{sessionStorage.setItem(C(a),"true")}catch{}}},ce=H.lazy(()=>se(()=>import("./UserDashboardPage-3JMtMQae.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33]),import.meta.url)),ve=()=>{var D;const a=Q(),{user:e,profile:n,loading:u,refreshProfile:A,isSubscriptionActive:p,userSubscription:t,checkSubscriptionStatus:S}=z(),[P,y]=h.useState(!1),[I,w]=h.useState(!1),{toast:j}=ae(),[k,b]=h.useState(!1);h.useEffect(()=>{const c=async r=>{const{userId:l,isActive:o}=r.detail;console.log("ðŸ”” ProtectedUserDashboard: Subscription update event received:",{userId:l,isActive:o,currentUserId:e==null?void 0:e.uid}),l===(e==null?void 0:e.uid)&&o&&(console.log("âœ… ProtectedUserDashboard: Subscription activated for current user, refreshing status"),await S(),y(!0),j({title:"ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ",description:"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…!"}))};return window.addEventListener("userSubscriptionUpdated",c),()=>{window.removeEventListener("userSubscriptionUpdated",c)}},[e==null?void 0:e.uid,S,j]),h.useEffect(()=>{var c,r;if(console.log("ProtectedUserDashboard - useEffect triggered",{loading:u,user:e?"exists":"null",profile:n?{role:n.role,approved:n.approved}:"null",isSubscriptionActive:p,userSubscription:t?"exists":"null"}),!u){if(!e)console.log("ProtectedUserDashboard - No user, redirecting to login"),a("/user/login");else if(n){if(console.log("ProtectedUserDashboard - Profile found:",{role:n.role,approved:n.approved,isSubscriptionActive:p,hasSubscription:!!(t!=null&&t.subscription)}),t){const g=((c=t==null?void 0:t.branchPackage)==null?void 0:c.status)==="active",v=(t==null?void 0:t.isOnFreeTrial)===!0;if(!(!!p||((r=t==null?void 0:t.subscription)==null?void 0:r.isActive)===!0||v)&&!g){try{a("/user/pending-approval",{replace:!0})}catch{}return}}n.role==="user"&&y(!0),console.log("ProtectedUserDashboard - User approved or admin, checking quick-login gate");const l=N.isEnabled(e==null?void 0:e.uid),o=N.isSessionVerified(e==null?void 0:e.uid);if(l&&!o){try{N.markSessionVerified(e==null?void 0:e.uid)}catch{}w(!1),y(!0)}else y(!0)}}},[e,n,u,a,p,t]),h.useEffect(()=>{let c=null;return!u&&e?b(!0):e&&(c=setTimeout(()=>b(!0),3e3)),()=>{try{clearTimeout(c)}catch{}}},[u,e]),h.useEffect(()=>{var v,m;if(u||!e||!k||!t)return;const c=(t==null?void 0:t.isActive)!==!1,r=((v=t==null?void 0:t.branchPackage)==null?void 0:v.status)==="active",l=(t==null?void 0:t.isOnFreeTrial)===!0,o=!!p||((m=t==null?void 0:t.subscription)==null?void 0:m.isActive)===!0||l,g=d=>{var O,E;if(!d)return"null";const s=d.subscription,f=s!=null&&s.activatedAt?s.activatedAt.toDate?s.activatedAt.toDate().toISOString():new Date(s.activatedAt).toISOString():"null",x=(s==null?void 0:s.planType)||"null",$=d.isActive!==!1,L=(s==null?void 0:s.isActive)===!0,B=((O=d.branchPackage)==null?void 0:O.status)==="active",R=(E=d.branchPackage)!=null&&E.activatedAt?d.branchPackage.activatedAt.toDate?d.branchPackage.activatedAt.toDate().toISOString():new Date(d.branchPackage.activatedAt).toISOString():"null";return`${$}|${L}|${x}|${f}|${B}|${R}`};if(!c){console.log("â›” ProtectedUserDashboard: Account is deactivated, redirecting to pending approval");try{sessionStorage.setItem("dashboard_kick_signature",g(t)),a("/user/pending-approval",{replace:!0})}catch{}return}if(!o&&!r)try{sessionStorage.setItem("dashboard_kick_signature",g(t)),a("/user/pending-approval")}catch{}},[u,e,t,p,a,k]),h.useEffect(()=>{if(u||!e||!k)return;const c=setInterval(async()=>{var m,d;const r=(t==null?void 0:t.isActive)!==!1,l=((m=t==null?void 0:t.branchPackage)==null?void 0:m.status)==="active",o=(t==null?void 0:t.isOnFreeTrial)===!0,g=!!p||((d=t==null?void 0:t.subscription)==null?void 0:d.isActive)===!0||o,v=s=>{var E,F;if(!s)return"null";const f=s.subscription,x=f!=null&&f.activatedAt?f.activatedAt.toDate?f.activatedAt.toDate().toISOString():new Date(f.activatedAt).toISOString():"null",$=(f==null?void 0:f.planType)||"null",L=s.isActive!==!1,B=(f==null?void 0:f.isActive)===!0,R=((E=s.branchPackage)==null?void 0:E.status)==="active",O=(F=s.branchPackage)!=null&&F.activatedAt?s.branchPackage.activatedAt.toDate?s.branchPackage.activatedAt.toDate().toISOString():new Date(s.branchPackage.activatedAt).toISOString():"null";return`${L}|${B}|${$}|${x}|${R}|${O}`};if(!r){try{sessionStorage.setItem("dashboard_kick_signature",v(t)),a("/user/pending-approval",{replace:!0})}catch{}return}if(!g&&!l)try{sessionStorage.setItem("dashboard_kick_signature",v(t)),a("/user/pending-approval",{replace:!0})}catch{}},5e3);return()=>clearInterval(c)},[u,e,t,p,S,a,k]);const _=typeof window<"u"&&(window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:");return(D=V)!=null&&D.isNativePlatform&&V.getPlatform(),u&&(_||!e)?i.jsx(U,{}):k?P?(console.log("ProtectedUserDashboard - Render state:",{isAuthenticated:P,profileRole:n==null?void 0:n.role,profileApproved:n==null?void 0:n.approved,isSubscriptionActive:p,hasSubscription:!!(t!=null&&t.subscription)}),console.log("ðŸ”¥ ProtectedUserDashboard - user:",e?{uid:e.uid,email:e.email}:"null"),console.log("ðŸ”¥ ProtectedUserDashboard - profile:",n?{userId:n.userId,role:n.role}:"null"),console.log("ðŸ”¥ ProtectedUserDashboard - loading:",u),console.log("ðŸ”¥ ProtectedUserDashboard - About to render UserDashboardPage"),i.jsxs("div",{className:"relative",children:[i.jsx(H.Suspense,{fallback:i.jsx(U,{}),children:i.jsx(ce,{})}),i.jsx(ne,{}),i.jsx(K,{open:I,onOpenChange:c=>w(c),mode:"verify",title:"Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹",description:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",onSuccess:()=>{N.markSessionVerified(e==null?void 0:e.uid),w(!1),y(!0)}})]})):i.jsxs(i.Fragment,{children:[i.jsx(U,{}),i.jsx(K,{open:I,onOpenChange:c=>w(c),mode:"verify",title:"Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹",description:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",onSuccess:()=>{N.markSessionVerified(e==null?void 0:e.uid),w(!1),y(!0)}})]}):i.jsx(U,{})};export{ve as default};
//# sourceMappingURL=ProtectedUserDashboard-CWb4AESX.js.map
