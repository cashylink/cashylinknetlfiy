const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-B57-Wohm.js","./index-C_Vc4bCD.css","./dailyOperationCountService-C1KYgbv3.js","./walletDailyLimitsService-C0svnn_N.js","./profitService-CxuHBzDm.js"])))=>i.map(i=>d[i]);
var Wm=Object.defineProperty;var Fm=(i,u,c)=>u in i?Wm(i,u,{enumerable:!0,configurable:!0,writable:!0,value:c}):i[u]=c;var Hi=(i,u,c)=>Fm(i,typeof u!="symbol"?u+"":u,c);import{O as ia,m as Xo,n as ec,u as la,r as n,c as Ks,j as e,Y as pe,Z as ge,_ as fe,$ as ye,B as h,as as Xs,au as zr,bn as Kn,bo as Wo,ad as Fr,C as ba,S as ws,a as tc,w as Wt,at as xs,I as U,ao as sc,ax as ac,ae as gt,bp as Bn,U as tl,A as Rm,R as Ve,E as hs,v as Ja,aK as Ka,y as ze,i as K,K as qs,s as ut,f as nr,a2 as qa,P as fa,q as He,h as De,ar as je,k as it,a1 as rc,z as Ms,bq as Bm,aD as ds,a0 as nt,p as Vs,F as Rr,G as Um,ag as qr,aT as Jn,aw as Te,l as Or,av as nl,Q as Es,aZ as js,br as nc,bs as zm,bt as qm,a8 as ic,bu as Vm,a3 as Km,bv as Jm,a7 as Ym,bw as Hm,bx as Gm,by as Qm,bz as lc,bA as Zm,bB as Xm,W as Ya,bC as oc,aS as Fo,aY as cc,bD as eh,ah as th,bE as Er,H as sh,an as ah,ak as Mr,aW as rh,aX as nh,bi as Ro,M as Bo,aV as $r,ai as Uo,bF as zo,aQ as ih,bG as lh}from"./index-B57-Wohm.js";import{C as Pt,a as ls,b as Ss,d as Lt}from"./card-BCHo6Lhz.js";import{B as Kt}from"./badge-DEy_1pxq.js";import{S as Ta,a as Pa,b as ka,c as _a,d as Zs,e as Br,f as Fn}from"./select-D6Ah4lQV.js";import{L as Q}from"./label-Dkhmstw-.js";import{M as ms,a as ps,P as oh}from"./MasterPinDialog-B4FD2nGL.js";import{walletDailyLimitsService as ra}from"./walletDailyLimitsService-C0svnn_N.js";import{W as na}from"./wallet-DxinjWf1.js";import{S as dc,a as ch}from"./star-CrC3frMc.js";import{S as mc}from"./square-pen-Dl9ynU6I.js";import{T as is,P as qo}from"./progress-DUtoimDl.js";import{P as ya}from"./phone-C-OPspnn.js";import{A as hc}from"./arrow-left-Duqnc2ct.js";import{a as sl,S as dh}from"./separator-DYEwUSxG.js";import{C as Ea}from"./calendar-BvvA9b6y.js";import{C as Un}from"./chart-column-DLUdr6SB.js";import{D as zt}from"./dollar-sign-CVGL3Wlx.js";import{A as Wn,P as mh}from"./ProfileIcon-C62GfL_n.js";import{C as Ha}from"./circle-alert-uZVrFUUg.js";import{C as zn}from"./circle-x-DxOBYhRS.js";import{C as Ma}from"./circle-check-big-DHRBy8Pa.js";import{f as Ns,P as hh,C as uc,a as il,A as qn,b as Vo,I as uh,R as xh,c as ph,M as gh}from"./MaintenanceDialog-CJuRjy50.js";import{S as xc}from"./store-DAt19Spf.js";import{S as fh}from"./switch-Bf9i02Wh.js";import{r as us,P as Oa}from"./profitService-CxuHBzDm.js";import{a as yh,E as bh}from"./broadcastService-CXD7174W.js";import{B as Ko,T as vh}from"./textarea-D0BJ26YZ.js";import{D as wh,a as Nh,b as jh,c as Sh,d as Dh}from"./dropdown-menu-D6d97Dzq.js";import{S as Gi}from"./shield-hmgtIOlg.js";import{G as Ch}from"./gift-YnkGvO51.js";import{W as Ih}from"./WalletsManagement-C9rcBxWR.js";import{P as Ah,w as Th}from"./walletSelectionPinService-4BJUi-uQ.js";import{C as Ph}from"./crown-CGDz5Zhc.js";import{R as kh}from"./refresh-cw-D0S1rEFy.js";import"./index-B--99Iwc.js";import"./whatsappService-C5XNCobX.js";import"./download-zFfPcKvb.js";import"./index--_dyLmUx.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _h=ia("Award",[["path",{d:"m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526",key:"1yiouv"}],["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Jo=ia("Banknote",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oh=ia("BookOpen",[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pc=ia("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vn=ia("IdCard",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const al=ia("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qi=ia("ListChecks",[["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}],["path",{d:"M13 6h8",key:"15sg57"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 18h8",key:"oe0vm4"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Eh=ia("Notebook",[["path",{d:"M2 6h4",key:"aawbzj"}],["path",{d:"M2 10h4",key:"l0bgd4"}],["path",{d:"M2 14h4",key:"1gsvsf"}],["path",{d:"M2 18h4",key:"1bu2t1"}],["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["path",{d:"M16 2v20",key:"rotuqe"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wr=ia("Package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["path",{d:"m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7",key:"yx3hmr"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rn=ia("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),gc=async(i={})=>{try{return(await Xo(ec,"getLastTransactions")(i)).data}catch(u){throw console.error("Error getting last transactions:",u),u.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):u.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+u.message):u.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+u.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(u.message||"خطأ غير معروف"))}},Mh=async i=>(await Xo(ec,"sendTelegramMessage")(i)).data,$h=Object.freeze(Object.defineProperty({__proto__:null,getLastTransactions:gc,sendTelegramMessage:Mh},Symbol.toStringTag,{value:"Module"})),Lh=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Wh=({isOpen:i,onClose:u,onWalletSelect:c,onEditWallet:y,onDeleteWallet:w})=>{const{user:C}=la(),[s,j]=n.useState([]),[R,D]=n.useState(!1),[O,k]=n.useState([]),[g,N]=n.useState(!1),{toast:T}=Ks(),J=async(M,W)=>{const he=new Date().getMonth(),be=new Date().getFullYear(),de=W.filter(Pe=>{const Ke=new Date(Pe.createdAt);return Ke.getMonth()===he&&Ke.getFullYear()===be&&(Pe.lineId===M||Pe.fromWallet===M)}),oe=Pe=>{const Ke=Pe.type;return Pe.txnType==="receive"||Ke==="withdraw"||Ke==="withdrawal"||Ke==="receive"},ae=Pe=>{const Ke=Pe.type;return Pe.txnType==="send"||Ke==="send"||Ke==="transfer"},Me=de.filter(oe).reduce((Pe,Ke)=>{const qe=Ke.withdrawnAmount!==void 0?Ke.withdrawnAmount:Ke.amount;return Pe+(qe||0)},0),Be=de.filter(ae).reduce((Pe,Ke)=>{const qe=Ke.sentAmount!==void 0?Ke.sentAmount:Ke.amount;return Pe+(qe||0)},0);return{withdrawalUsage:Me,transferUsage:Be}},L=M=>{const W=new Date().toISOString().split("T")[0],he=M.lastResetDate;if(!he)return{...M,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:W};const be=new Date(he),de=new Date;return be.getMonth()!==de.getMonth()||be.getFullYear()!==de.getFullYear()?{...M,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:W}:M};n.useEffect(()=>{if(!(C!=null&&C.uid)||!i)return;(async()=>{N(!0);try{const W=await Xs.getByMerchantId(C.uid),he=await Kn.getByUserId(C.uid),de=(await Promise.all(W.map(async oe=>{const{withdrawalUsage:ae,transferUsage:Me}=await J(oe.id,he),Be=await ra.getWalletLimits(oe.id);return{id:oe.id,name:oe.label||"محفظة بدون اسم",phone:oe.msisdn,nationalId:oe.nationalId||"",isDefault:!1,isActive:oe.isActive===!0,monthlyWithdrawalLimit:(Be==null?void 0:Be.monthlyWithdrawLimit)??oe.withdrawLimit??2e5,monthlyTransferLimit:(Be==null?void 0:Be.monthlyTransferLimit)??oe.transferLimit??2e5,monthlyWithdrawalUsage:(Be==null?void 0:Be.monthlyWithdrawUsed)??ae??0,monthlyTransferUsage:(Be==null?void 0:Be.monthlyTransferUsed)??Me??0,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:oe.walletProvider||""}}))).map(L);j(de)}catch(W){console.error("Error loading wallets:",W),T({title:"فشل جلب بيانات المحافظ",description:"قد تكون المشكلة بسبب الصلاحيات أو الاتصال. سيتم عرض البيانات المحلية إن وُجدت. جرّب تسجيل الدخول مجددًا أو افتح صفحة اختبار المصادقة من القائمة.",variant:"destructive"})}finally{N(!1)}})()},[C==null?void 0:C.uid,i]);const H=M=>Lh.find(W=>W.id===M),te=(M,W)=>W>0?Math.min(M/W*100,100):0,ie=M=>new Intl.NumberFormat("ar-EG").format(M);return e.jsx(pe,{open:i,onOpenChange:u,children:e.jsxs(ge,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(fe,{className:"pb-4",children:[e.jsxs(ye,{className:"flex items-center gap-2 text-lg",children:[e.jsx(na,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(Kt,{variant:"secondary",className:"mr-2",children:[s.length," محفظة"]})]}),e.jsx("div",{className:"flex items-center gap-2 mt-2",children:R?e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",onClick:async()=>{try{if(!(C!=null&&C.uid))return;const M=s.map(W=>Xs.update(W.id,{isActive:O.includes(W.id)}));await Promise.all(M),j(W=>W.map(he=>({...he,isActive:O.includes(he.id)}))),D(!1),T({title:"تم تفعيل المحافظ",description:"فقط المحافظ المحددة ستظهر في الاختيار الخارجي"});try{window.dispatchEvent(new CustomEvent("wallets:activation-updated"))}catch{}}catch(M){console.error("Error activating wallets:",M),T({title:"فشل التفعيل",description:"تعذر تفعيل المحافظ المحددة",variant:"destructive"})}},className:"h-7",children:"تفعيل المحافظ"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>{D(!1),k([])},className:"h-7",children:"إلغاء"})]}):e.jsx(h,{variant:"outline",size:"sm",onClick:()=>D(!0),className:"h-7",children:"تحديد المحافظ"})})]}),g?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):s.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(na,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:s.map(M=>{const W=H(M.walletProvider||"");te(M.monthlyWithdrawalUsage||0,M.monthlyWithdrawalLimit),te(M.monthlyTransferUsage||0,M.monthlyTransferLimit);const he=O.includes(M.id),be=R?`cursor-pointer transition-shadow border-2 ${he?"border-blue-500 shadow-lg":"hover:border-blue-300"}`:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300";return e.jsxs(Pt,{className:be,onClick:()=>{R?k(de=>de.includes(M.id)?de.filter(oe=>oe!==M.id):[...de,M.id]):c(M)},children:[e.jsx(ls,{className:"pb-3",children:e.jsxs(Ss,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(zr,{className:"h-4 w-4"}),e.jsx("span",{children:M.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[M.isActive&&e.jsx(Kt,{variant:"default",className:"text-xs",children:"نشطة"}),M.isDefault&&e.jsxs(Kt,{variant:"default",className:"text-xs",children:[e.jsx(dc,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(h,{variant:"ghost",size:"sm",onClick:de=>{de.stopPropagation(),y==null||y(M)},className:"h-7 px-2",children:e.jsx(mc,{className:"h-4 w-4"})}),e.jsx(h,{variant:"ghost",size:"sm",onClick:de=>{de.stopPropagation(),w==null||w(M.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(is,{className:"h-4 w-4"})})]})]})}),e.jsxs(Lt,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ya,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:M.phone})]}),M.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Vn,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:M.nationalId})]}),W&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(pc,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:W.name})]})]}),(()=>{const de=M.monthlyWithdrawalLimit,oe=M.monthlyTransferLimit,ae=M.monthlyWithdrawalUsage||0,Me=M.monthlyTransferUsage||0,Be=Math.max(de-ae,0),Pe=Math.max(oe-Me,0);return e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{className:"text-xs text-gray-600 font-medium text-center",children:["الحدود الشهرية: ",(W==null?void 0:W.name)||M.walletProvider," - ",M.phone]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(ae/Math.max(de,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Me/Math.max(oe,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",ie(Be)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",ie(Pe)," جنيه"]})]})]})})(),e.jsx(h,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:de=>{de.stopPropagation(),c(M)},children:"عرض التفاصيل الكاملة"})]})]},M.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(h,{onClick:u,variant:"outline",children:[e.jsx(hc,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},Fh=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Rh=({wallet:i,isOpen:u,onClose:c,onBack:y})=>{const{user:w}=la(),[C,s]=n.useState([]),[j,R]=n.useState(!1),[D,O]=n.useState("month"),{toast:k}=Ks();if(n.useEffect(()=>{if(!i||!(w!=null&&w.uid)||!u)return;(async()=>{R(!0);try{const tt=(await Kn.getByUserId(w.uid)).filter(re=>re.walletId===i.id).sort((re,Se)=>new Date(Se.createdAt).getTime()-new Date(re.createdAt).getTime());s(tt)}catch(ue){console.error("Error loading transactions:",ue),k({title:"فشل جلب معاملات المحفظة",description:"قد تكون المشكلة بسبب صلاحيات Firestore أو الاتصال. تم عرض ما أمكن محليًا. جرّب تسجيل الدخول مجددًا أو صفحة اختبار المصادقة.",variant:"destructive"})}finally{R(!1)}})()},[i,w==null?void 0:w.uid,u]),!i)return null;const g=ee=>Fh.find(ue=>ue.id===ee),N=(ee,ue)=>ue>0?Math.min(ee/ue*100,100):0,T=ee=>new Intl.NumberFormat("ar-EG").format(ee),J=ee=>new Date(ee).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),H=(()=>{const ee=new Date;let ue;switch(D){case"week":ue=new Date(ee.getTime()-7*24*60*60*1e3);break;case"month":ue=new Date(ee.getFullYear(),ee.getMonth(),1);break;default:return C}return C.filter(tt=>new Date(tt.createdAt)>=ue)})(),te=ee=>{const ue=ee.type,tt=ee.txnType;return ue==="withdraw"||ue==="withdrawal"||ue==="receive"||tt==="receive"},ie=ee=>{const ue=ee.type,tt=ee.txnType;return ue==="send"||ue==="transfer"||tt==="send"},M=H.filter(ee=>te(ee)&&ee.status==="completed").reduce((ee,ue)=>{const tt=ue.withdrawnAmount!==void 0?ue.withdrawnAmount:ue.amount;return ee+(tt||0)},0),W=H.filter(ee=>ie(ee)&&ee.status==="completed").reduce((ee,ue)=>{const tt=ue.sentAmount!==void 0?ue.sentAmount:ue.amount;return ee+(tt||0)},0),he=H.filter(ee=>ee.type==="deposit"&&ee.status==="completed").reduce((ee,ue)=>ee+ue.amount,0),be=H.filter(ee=>ee.status==="completed"),de=be.length,oe=be.reduce((ee,ue)=>{if(te(ue)){const tt=ue.withdrawnAmount??ue.receivedAmount??ue.amount??0;return ee+Wo(Number(tt)||0,"receive")}if(ie(ue)){const tt=ue.sentAmount??ue.transferredAmount??ue.amount??0;return ee+Wo(Number(tt)||0,"send")}return ee},0),ae=g(i.walletProvider||""),Me=N(i.monthlyWithdrawalUsage||0,i.monthlyWithdrawalLimit),Be=N(i.monthlyTransferUsage||0,i.monthlyTransferLimit),Pe=ee=>{switch(ee){case"withdrawal":return e.jsx(Rn,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(Fr,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx(zt,{className:"h-4 w-4 text-green-500"});default:return e.jsx(Wn,{className:"h-4 w-4 text-gray-500"})}},Ke=ee=>{switch(ee){case"completed":return e.jsx(Ma,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(ba,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(zn,{className:"h-4 w-4 text-red-500"});default:return e.jsx(Ha,{className:"h-4 w-4 text-gray-500"})}},qe=ee=>{switch(ee){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},ot=ee=>{switch(ee){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(pe,{open:u,onOpenChange:c,children:e.jsxs(ge,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(fe,{className:"pb-4",children:e.jsxs(ye,{className:"flex items-center gap-2 text-lg",children:[e.jsx(zr,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",i.name,i.isDefault&&e.jsxs(Kt,{variant:"default",className:"mr-2",children:[e.jsx(dc,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(Pt,{children:[e.jsx(ls,{children:e.jsxs(Ss,{className:"text-sm flex items-center gap-2",children:[e.jsx(Vn,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(Lt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ya,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.phone})]}),i.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Vn,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.nationalId})]}),ae&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(pc,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:ae.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",ae.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",ae.nationalId]})]})]}),i.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ea,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(i.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs(Pt,{children:[e.jsx(ls,{children:e.jsxs(Ss,{className:"text-sm flex items-center gap-2",children:[e.jsx(Un,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(Lt,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Rn,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[T(i.monthlyWithdrawalUsage||0)," / ",T(i.monthlyWithdrawalLimit)]})]}),e.jsx(qo,{value:Me,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",T(i.monthlyWithdrawalLimit-(i.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(sl,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Fr,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[T(i.monthlyTransferUsage||0)," / ",T(i.monthlyTransferLimit)]})]}),e.jsx(qo,{value:Be,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",T(i.monthlyTransferLimit-(i.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(Pt,{children:e.jsxs(Lt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Rn,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:T(M)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx(Pt,{children:e.jsxs(Lt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Fr,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:T(W)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx(Pt,{children:e.jsxs(Lt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(zt,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:T(he)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})}),e.jsx(Pt,{children:e.jsxs(Lt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Un,{className:"h-5 w-5 text-emerald-600"})}),e.jsx("div",{className:"text-lg font-bold",children:T(oe)}),e.jsx("div",{className:"text-xs text-gray-600",children:"أرباح الفترة"})]})}),e.jsx(Pt,{children:e.jsxs(Lt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Wn,{className:"h-5 w-5 text-purple-600"})}),e.jsx("div",{className:"text-lg font-bold",children:T(de)}),e.jsx("div",{className:"text-xs text-gray-600",children:"عدد العمليات"})]})})]}),e.jsxs(Pt,{children:[e.jsx(ls,{children:e.jsxs(Ss,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Wn,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{size:"sm",variant:D==="week"?"default":"outline",onClick:()=>O("week"),className:"text-xs",children:"أسبوع"}),e.jsx(h,{size:"sm",variant:D==="month"?"default":"outline",onClick:()=>O("month"),className:"text-xs",children:"شهر"}),e.jsx(h,{size:"sm",variant:D==="all"?"default":"outline",onClick:()=>O("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(Lt,{children:j?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):H.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Wn,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:H.map(ee=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[Pe(ee.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[qe(ee.type)," - ",T(ee.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:J(ee.createdAt)}),ee.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:ee.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[Ke(ee.status),e.jsx("span",{className:"text-xs",children:ot(ee.status)})]})]},ee.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(h,{onClick:y,variant:"outline",children:[e.jsx(hc,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(h,{onClick:c,variant:"outline",children:"إغلاق"})]})]})})},Zi=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Bh=({isOpen:i,onClose:u,onWalletUpdate:c,initialEditingWallet:y})=>{const{toast:w}=Ks(),{user:C,userSubscription:s}=la();(()=>{var ke,mt;const F=((ke=s==null?void 0:s.subscription)==null?void 0:ke.planType)??((mt=s==null?void 0:s.subscription)==null?void 0:mt.plan)??(s==null?void 0:s.planType)??(s==null?void 0:s.plan)??null,xe=typeof F=="string"?String(F).trim().toLowerCase():null;return F===ws.TAHWEELA||xe==="tahweela"||xe==="تحويله"})();const j=tc(),[R,D]=n.useState([]),[O,k]=n.useState(!1),[g,N]=n.useState(null),[T,J]=n.useState(""),[L,H]=n.useState(""),[te,ie]=n.useState(""),[M,W]=n.useState(""),[he,be]=n.useState("200000"),[de,oe]=n.useState("200000"),[ae,Me]=n.useState("100000"),[Be,Pe]=n.useState("60000"),[Ke,qe]=n.useState(!1),[ot,ee]=n.useState(null),[ue,tt]=n.useState(!1),[re,Se]=n.useState(!1),[ft,es]=n.useState(!1),[qt,Yt]=n.useState(null),Ie=()=>`wallets_${(C==null?void 0:C.uid)||"default"}`;n.useEffect(()=>{y&&(N(y),k(!0),J(y.name||""),H(y.phone||""),ie(y.nationalId||""),W(y.walletProvider||""),be((y.monthlyWithdrawalLimit||2e5).toString()),oe((y.monthlyTransferLimit||2e5).toString()),Me((y.dailyWithdrawalLimit||1e5).toString()),Pe((y.dailyTransferLimit||6e4).toString()),qe(!!y.isDefault))},[y]);const Ge=F=>{const xe=new Date,ke=xe.getMonth(),mt=xe.getFullYear();if(!F.lastResetDate)return{...F,monthlyWithdrawalUsage:F.monthlyWithdrawalUsage||0,monthlyTransferUsage:F.monthlyTransferUsage||0,lastResetDate:xe.toISOString().split("T")[0]};const xt=new Date(F.lastResetDate),kt=xt.getMonth(),_t=xt.getFullYear();return ke!==kt||mt!==_t?{...F,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:xe.toISOString().split("T")[0]}:F},ct=async(F,xe)=>{const ke=new Date().getMonth(),mt=new Date().getFullYear(),xt=xe.filter(Nt=>{const et=new Date(Nt.createdAt);return et.getMonth()===ke&&et.getFullYear()===mt&&Nt.lineId===F}),kt=xt.filter(Nt=>Nt.txnType==="receive").reduce((Nt,et)=>Nt+(et.amount||0),0),_t=xt.filter(Nt=>Nt.txnType==="send").reduce((Nt,et)=>Nt+(et.amount||0),0);return{withdrawalUsage:kt,transferUsage:_t}},ve=async(F,xe)=>{const ke=new Date,mt=ke.getDate(),xt=ke.getMonth(),kt=ke.getFullYear(),_t=xe.filter(Ot=>{const At=new Date(Ot.createdAt);return At.getDate()===mt&&At.getMonth()===xt&&At.getFullYear()===kt&&Ot.lineId===F}),Nt=_t.filter(Ot=>Ot.txnType==="receive").reduce((Ot,At)=>Ot+(At.amount||0),0),et=_t.filter(Ot=>Ot.txnType==="send").reduce((Ot,At)=>Ot+(At.amount||0),0);return{withdrawalUsage:Nt,transferUsage:et}};n.useEffect(()=>{(async()=>{if(!(C!=null&&C.uid)){console.log("No user authenticated, skipping wallet loading"),tt(!1);return}console.log("Loading wallets for user:",C.uid),tt(!0);try{const{auth:xe}=await gt(async()=>{const{auth:et}=await import("./index-B57-Wohm.js").then(Ot=>Ot.bL);return{auth:et}},__vite__mapDeps([0,1]),import.meta.url);let ke=0;const mt=5;for(;!xe.currentUser&&ke<mt;)console.log(`Waiting for auth state... attempt ${ke+1}`),await new Promise(et=>setTimeout(et,1e3)),ke++;if(!xe.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",xe.currentUser.uid),console.log("Context User:",C.uid),console.log("Fetching wallets from Firebase...");const xt=await Xs.getByMerchantId(C.uid);console.log("Fetched wallets:",xt),console.log("Fetching transactions from Firebase...");const kt=await Kn.getByUserId(C.uid);console.log("Fetched transactions:",kt);const Nt=(await Promise.all(xt.map(async et=>{const{withdrawalUsage:Ot,transferUsage:At}=await ct(et.id,kt),{withdrawalUsage:Ht,transferUsage:Gt}=await ve(et.id,kt);return{id:et.id,name:et.label||"محفظة بدون اسم",phone:et.msisdn,isDefault:!1,monthlyWithdrawalLimit:et.withdrawLimit||2e5,monthlyTransferLimit:et.transferLimit||2e5,dailyWithdrawalLimit:et.dailyWithdrawLimit||1e5,dailyTransferLimit:et.dailyTransferLimit||6e4,monthlyWithdrawalUsage:Ot,monthlyTransferUsage:At,dailyWithdrawalUsage:Ht,dailyTransferUsage:Gt,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:et.defaultTransferCommission!=null?Number(et.defaultTransferCommission):null,defaultWithdrawCommission:et.defaultWithdrawCommission!=null?Number(et.defaultWithdrawCommission):null}}))).map(Ge);D(Nt),console.log("Wallets loaded successfully:",Nt)}catch(xe){console.error("Error loading wallets:",xe),D([])}finally{tt(!1)}})()},[C==null?void 0:C.uid]);const dt=()=>{J(""),H(""),ie(""),W(""),be("200000"),oe("200000"),Me("100000"),Pe("60000"),qe(!1),N(null),k(!1)},V=async()=>{if(!T.trim()||!L.trim()||!M.trim()){w({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(C!=null&&C.uid)){w({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}tt(!0);try{if(g){await Xs.update(g.id,{label:T.trim(),msisdn:L.trim(),withdrawLimit:parseInt(he),transferLimit:parseInt(de),dailyWithdrawLimit:parseInt(ae),dailyTransferLimit:parseInt(Be)}),await ra.setLimits(g.id,{dailyTransferLimit:parseInt(Be||"0"),dailyWithdrawLimit:parseInt(ae||"0"),monthlyTransferLimit:parseInt(de||"0"),monthlyWithdrawLimit:parseInt(he||"0")});const F=R.map(xe=>xe.id===g.id?{...xe,name:T.trim(),phone:L.trim(),nationalId:te.trim(),walletProvider:M,monthlyWithdrawalLimit:parseInt(he),monthlyTransferLimit:parseInt(de),dailyWithdrawalLimit:parseInt(ae),dailyTransferLimit:parseInt(Be)}:xe);D(F),localStorage.setItem(Ie(),JSON.stringify(F)),w({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const F={merchantUserId:C.uid,provider:M,msisdn:L.trim(),label:T.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(he),transferLimit:parseInt(de),dailyTransferLimit:parseInt(Be),dailyWithdrawLimit:parseInt(ae),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},xe=await Xs.create(F);await ra.setLimits(xe,{dailyTransferLimit:parseInt(Be||"0"),dailyWithdrawLimit:parseInt(ae||"0"),monthlyTransferLimit:parseInt(de||"0"),monthlyWithdrawLimit:parseInt(he||"0")});const ke=new Date().toISOString().split("T")[0],mt={id:xe,name:T.trim(),phone:L.trim(),nationalId:te.trim(),walletProvider:M,isDefault:Ke,monthlyWithdrawalLimit:parseInt(he),monthlyTransferLimit:parseInt(de),dailyWithdrawalLimit:parseInt(ae),dailyTransferLimit:parseInt(Be),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:ke,defaultTransferCommission:null,defaultWithdrawCommission:null},xt=[...R,mt];D(xt),localStorage.setItem(Ie(),JSON.stringify(xt)),w({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}c&&c(),dt(),k(!1),N(null)}catch(F){console.error("Error saving wallet:",F),w({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{tt(!1)}},yt=F=>{N(F),J(F.name),H(F.phone),ie(F.nationalId||""),W(F.walletProvider||""),be(F.monthlyWithdrawalLimit.toString()),oe(F.monthlyTransferLimit.toString()),qe(F.isDefault),k(!0)},vt=async F=>{const xe=R.find(ke=>ke.id===F);if(xe!=null&&xe.isDefault){w({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(C!=null&&C.uid)){w({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}tt(!0);try{await Xs.delete(F);const ke=R.filter(mt=>mt.id!==F);D(ke),localStorage.setItem(Ie(),JSON.stringify(ke)),c&&c(),w({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(ke){console.error("Error deleting wallet:",ke),w({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{tt(!1)}},wt=F=>{const xe=R.map(ke=>({...ke,isDefault:ke.id===F}));D(xe),localStorage.setItem(Ie(),JSON.stringify(xe)),c&&c(),w({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(pe,{open:i,onOpenChange:u,children:[e.jsxs(ge,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(fe,{className:"pb-2",children:e.jsxs(ye,{className:"flex items-center gap-1 text-sm",children:[e.jsx(na,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",R.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{onClick:()=>{es(!0)},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(Wt,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(h,{onClick:()=>{u(),j("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(xs,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),(O||g)&&e.jsxs(Pt,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx(ls,{className:"pb-1",children:e.jsx(Ss,{className:"text-sm",children:g?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(Lt,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(Ta,{value:M,onValueChange:W,children:[e.jsx(Pa,{className:"h-6 text-xs flex-1",children:e.jsx(ka,{placeholder:"اختر شركة المحفظة"})}),e.jsx(_a,{children:Zi.map(F=>e.jsx(Zs,{value:F.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:F.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:xe=>{xe.preventDefault(),xe.stopPropagation(),ee(F.id)},children:e.jsx(al,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},F.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx(U,{value:T,onChange:F=>J(F.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx(ya,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{value:L,onChange:F=>H(F.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx(Vn,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{value:te,onChange:F=>ie(F.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(zt,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{type:"number",value:he,onChange:F=>be(F.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(zt,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{type:"number",value:de,onChange:F=>oe(F.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Rn,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx(U,{type:"number",value:ae,onChange:F=>Me(F.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Fr,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx(U,{type:"number",value:Be,onChange:F=>Pe(F.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:Ke,onChange:F=>qe(F.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(sc,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(h,{onClick:V,className:"flex-1 h-6 text-xs",size:"sm",children:g?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(h,{variant:"outline",onClick:dt,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:R.map(F=>{var xe;return e.jsxs(Pt,{className:`${F.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx(ls,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ss,{className:"text-sm flex items-center gap-1",children:[e.jsx(na,{className:"h-3 w-3"}),F.name]}),F.isDefault&&e.jsx(Kt,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(Lt,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ya,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:F.phone})]}),F.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((xe=Zi.find(ke=>ke.id===F.walletProvider))==null?void 0:xe.name)||F.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((F.monthlyWithdrawalUsage||0)/F.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((F.monthlyTransferUsage||0)/F.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(F.monthlyWithdrawalLimit-(F.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(F.monthlyTransferLimit-(F.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((F.dailyWithdrawalUsage||0)/F.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((F.dailyTransferUsage||0)/F.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify بين items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(F.dailyWithdrawalLimit-(F.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(F.dailyTransferLimit-(F.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(h,{size:"sm",variant:"outline",onClick:()=>yt(F),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(mc,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!F.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",variant:"outline",onClick:()=>wt(F.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(h,{size:"sm",variant:"destructive",onClick:()=>vt(F.id),className:"h-5 px-1",children:e.jsx(is,{className:"h-2 w-2"})})]})]})]})]},F.id)})}),R.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),ot&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>ee(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(ac,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const F=Zi.find(xe=>xe.id===ot);return F?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:F.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:F.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:F.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(al,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(ms,{open:ft,onOpenChange:es,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{es(!1),Se(!0)}}),e.jsx(Wh,{isOpen:re,onClose:()=>Se(!1),onWalletSelect:F=>{Yt(F),Se(!1)},onEditWallet:F=>{j(`/user/add-wallet?edit=1&id=${F.id}`),Se(!1)},onDeleteWallet:async F=>{try{if(await Xs.delete(F),D(xe=>{const ke=xe.filter(mt=>mt.id!==F);try{localStorage.setItem(Ie(),JSON.stringify(ke))}catch(mt){console.error("Failed to update localStorage wallets after delete:",mt)}return ke}),c)try{await c()}catch(xe){console.error("onWalletUpdate callback failed:",xe)}}catch(xe){console.error("Error deleting wallet:",xe)}}}),e.jsx(Rh,{wallet:qt,isOpen:!!qt,onClose:()=>Yt(null),onBack:()=>{Yt(null),Se(!0)}})]})},Uh=({isOpen:i,onClose:u,transaction:c,onDelete:y})=>{if(!c)return null;const w=D=>{switch(D){case"completed":return e.jsx(Ma,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(ba,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(zn,{className:"h-5 w-5 text-red-500"});default:return e.jsx(ba,{className:"h-5 w-5 text-gray-500"})}},C=D=>{switch(D){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},s=D=>{switch(D){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},j=()=>{const D=!!c.senderNumber,O=!!c.senderName,k=D?"الرقم المرسل:":O?"الرقم الراسل:":"رقم المحفظة:",g=D?c.senderNumber:O?c.senderName:c.senderPhone,N=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${c.transactionReference||c.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${c.merchantShopName||c.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${s(c.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${c.status==="completed"?"#16a34a":c.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${C(c.status)}
            </span>
          </div>

          ${c!=null&&c.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${c.cashierName}</span>
            </div>
          `:""}
          
          ${c.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${k}</span>
              <span style="color: #1e293b;">${g}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${c.receiverNumber||c.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${Ns(c.transferredAmount||c.amount)} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${c.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${Ns(c.withdrawnAmountDetailed||c.withdrawnAmount||c.amount)} جنيه</span>
            </div>
          `}
          
          ${c.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${Ns(c.commission||0)} جنيه</span>
            </div>
          `:""}
          ${c!=null&&c.fee&&Number(c.fee)>0?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرسوم:</span>
              <span style="color: #64748b; font-weight: 600;">${Ns(c.fee||0)} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${c.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${c.type==="withdraw"?"-":""}${Ns(c.amount)} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,T=window.open("","_blank");T&&(T.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${c.transactionReference||c.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${N}
          </body>
        </html>
      `),T.document.close(),T.print())},R=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(y(c.id),u())};return e.jsx(pe,{open:i,onOpenChange:u,children:e.jsxs(ge,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(fe,{children:e.jsxs(ye,{className:"flex items-center gap-2 text-xl",children:[e.jsx(Bn,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(Pt,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs(ls,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[w(c.status),e.jsx(Kt,{variant:c.status==="completed"?"default":"secondary",className:"text-sm",children:C(c.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[c.type==="withdraw"?"-":"",Ns(c.amount)," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",c.transactionReference||c.id]})]})}),e.jsxs(Pt,{children:[e.jsx(ls,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xc,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(Lt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:c.merchantShopName||c.shopName||"غير محدد"})]}),(c==null?void 0:c.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:c.cashierName})]})]})]}),e.jsxs(Pt,{children:[e.jsx(ls,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(zr,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(Lt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(Kt,{variant:"outline",className:"bg-blue-100 text-blue-800",children:s(c.type)})]}),c.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const D=!!c.senderNumber,O=!!c.senderName,k=D?"الرقم المرسل:":O?"الرقم الراسل:":"رقم المحفظة:",g=D?c.senderNumber:O?c.senderName:c.senderPhone,N=D?tl:ya;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:k})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:g})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(Rm,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(tl,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:c.receiverNumber||c.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(zt,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[Ns(c.transferredAmount||c.amount)," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ya,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:c.senderPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(zt,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[Ns(c.withdrawnAmountDetailed||c.withdrawnAmount||c.amount)," جنيه"]})]})]}),c.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[c.commission," جنيه"]})]}),(c==null?void 0:c.fee)&&Number(c.fee)>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الرسوم:"}),e.jsxs("span",{className:"text-gray-900 font-semibold",children:[c.fee," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ea,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:c.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(h,{onClick:j,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx(hh,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(h,{onClick:R,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(is,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(h,{onClick:u,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function Yo({open:i,onOpenChange:u,onSuccess:c,title:y,description:w,currentBalance:C,balanceLabel:s,userId:j}){const[R,D]=n.useState(""),[O,k]=n.useState(C.toString()),[g,N]=n.useState(!1),[T,J]=n.useState(""),[L,H]=n.useState(!1),te=async M=>{M.preventDefault(),J(""),H(!0);try{const W=parseFloat(O);if(isNaN(W)||W<0){J("يرجى إدخال مبلغ صحيح"),H(!1);return}await ps.hasMasterPin(j)?await ps.verifyMasterPin(R,j)?(c(W),u(!1),D(""),k("")):J("الرقم السري غير صحيح"):J("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{J("حدث خطأ أثناء التحقق من الرقم السري")}finally{H(!1)}},ie=()=>{D(""),k(C.toString()),J(""),u(!1)};return Ve.useEffect(()=>{i&&k(C.toString())},[C,i]),e.jsx(pe,{open:i,onOpenChange:ie,children:e.jsxs(ge,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(fe,{children:e.jsxs(ye,{className:"flex items-center gap-2 text-right",children:[e.jsx(zt,{className:"h-5 w-5"}),y]})}),e.jsxs("form",{onSubmit:te,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:w}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(Q,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[C.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx(U,{id:"newAmount",type:"number",step:"0.01",min:"0",value:O,onChange:M=>k(M.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"pin",type:g?"text":"password",value:R,onChange:M=>D(M.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>N(!g),children:g?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),T&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(Ha,{className:"h-4 w-4"}),T]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(h,{type:"button",variant:"outline",onClick:ie,className:"flex-1",children:"إلغاء"}),e.jsx(h,{type:"submit",disabled:L||!R||!O,className:"flex-1",children:L?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ja,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class Ur{static getSecretKey(u){return u?`${this.SECRET_KEY_BASE}_${u}`:this.SECRET_KEY_BASE}static setSecretPin(u,c){const y=btoa(u);this.secretCache.set(this.getSecretKey(c),y)}static hasSecretPin(u){return this.secretCache.has(this.getSecretKey(u))}static verifySecretPin(u,c){const y=this.secretCache.get(this.getSecretKey(c));if(!y)return!1;try{return atob(y)===u}catch{return!1}}static clearSecretPin(u){this.secretCache.delete(this.getSecretKey(u))}}Hi(Ur,"SECRET_KEY_BASE","dashboard_secret_pin"),Hi(Ur,"secretCache",new Map);function zh({open:i,onOpenChange:u,userId:c}){const[y,w]=n.useState(""),[C,s]=n.useState(""),[j,R]=n.useState(""),[D,O]=n.useState(!1),[k,g]=n.useState(!1),[N,T]=n.useState(!1),[J,L]=n.useState(""),[H,te]=n.useState(!1),{toast:ie}=Ks(),M=Ur.hasSecretPin(c),W=async be=>{be.preventDefault(),L(""),te(!0);try{if(!C||C.length<4){L("يجب أن يكون الرقم السري 4 أرقام على الأقل"),te(!1);return}if(C!==j){L("الرقم السري الجديد وتأكيده غير متطابقين"),te(!1);return}if(M){if(!y){L("يرجى إدخال الرقم السري الحالي"),te(!1);return}if(!Ur.verifySecretPin(y,c)){L("الرقم السري الحالي غير صحيح"),te(!1);return}}Ur.setSecretPin(C,c),ie({title:M?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:M?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),he()}catch{L("حدث خطأ أثناء حفظ الرقم السري")}finally{te(!1)}},he=()=>{w(""),s(""),R(""),L(""),O(!1),g(!1),T(!1),u(!1)};return e.jsx(pe,{open:i,onOpenChange:he,children:e.jsxs(ge,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(fe,{children:e.jsxs(ye,{className:"flex items-center gap-2 text-right",children:[e.jsx(sc,{className:"h-5 w-5"}),M?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:W,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:M?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),M&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"currentPin",type:D?"text":"password",autoComplete:"off",value:y,onChange:be=>w(be.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>O(!D),children:D?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"newPin",type:k?"text":"password",autoComplete:"off",value:C,onChange:be=>s(be.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>g(!k),children:k?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:N?"text":"password",autoComplete:"off",value:j,onChange:be=>R(be.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>T(!N),children:N?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),J&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ha,{className:"h-4 w-4"}),J]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:H,className:"flex-1",children:[e.jsx(Ja,{className:"h-4 w-4 mr-2"}),H?"جاري الحفظ...":M?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(h,{type:"button",variant:"outline",onClick:he,disabled:H,children:"إلغاء"})]})]})]})})}const Xi=new Map;function qh({open:i,onOpenChange:u,userId:c}){const[y,w]=n.useState(""),[C,s]=n.useState(""),[j,R]=n.useState(""),[D,O]=n.useState(!1),[k,g]=n.useState(!1),[N,T]=n.useState(!1),[J,L]=n.useState(""),[H,te]=n.useState(!1),{toast:ie}=Ks(),M=c?`cash_drawer_pin_${c}`:"cash_drawer_pin",W=()=>Xi.has(M),he=ae=>{const Me=Xi.get(M);if(!Me)return!1;try{return atob(Me)===ae}catch{return!1}},be=ae=>{const Me=btoa(ae);Xi.set(M,Me)},de=async ae=>{ae.preventDefault(),L(""),te(!0);try{if(!C||C.length<4){L("يجب أن يكون الرقم السري 4 أرقام على الأقل"),te(!1);return}if(C!==j){L("الرقم السري الجديد وتأكيده غير متطابقين"),te(!1);return}if(W()){if(!y){L("يرجى إدخال الرقم السري الحالي لدرج النقدية"),te(!1);return}if(!he(y)){L("الرقم السري الحالي لدرج النقدية غير صحيح"),te(!1);return}}be(C),ie({title:W()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:W()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),oe()}catch{L("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{te(!1)}},oe=()=>{w(""),s(""),R(""),L(""),O(!1),g(!1),T(!1),u(!1)};return e.jsx(pe,{open:i,onOpenChange:oe,children:e.jsxs(ge,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(fe,{children:e.jsxs(ye,{className:"flex items-center gap-2 text-right",children:[e.jsx(zt,{className:"h-5 w-5 text-green-600"}),W()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:de,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:W()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),W()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"currentPin",type:D?"text":"password",autoComplete:"off",value:y,onChange:ae=>w(ae.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>O(!D),children:D?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"newPin",type:k?"text":"password",autoComplete:"off",value:C,onChange:ae=>s(ae.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>g(!k),children:k?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:N?"text":"password",autoComplete:"off",value:j,onChange:ae=>R(ae.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>T(!N),children:N?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),J&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ha,{className:"h-4 w-4"}),J]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:H,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Ja,{className:"h-4 w-4 mr-2"}),H?"جاري الحفظ...":W()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(h,{type:"button",variant:"outline",onClick:oe,disabled:H,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}const el=new Map;function Vh({open:i,onOpenChange:u,userId:c}){const[y,w]=n.useState(""),[C,s]=n.useState(""),[j,R]=n.useState(""),[D,O]=n.useState(!1),[k,g]=n.useState(!1),[N,T]=n.useState(!1),[J,L]=n.useState(""),[H,te]=n.useState(!1),{toast:ie}=Ks(),M=c?`wallet_total_pin_${c}`:"wallet_total_pin",W=()=>el.has(M),he=ae=>{const Me=el.get(M);if(!Me)return!1;try{return atob(Me)===ae}catch{return!1}},be=ae=>{const Me=btoa(ae);el.set(M,Me)},de=async ae=>{ae.preventDefault(),L(""),te(!0);try{if(!C||C.length<4){L("يجب أن يكون الرقم السري 4 أرقام على الأقل"),te(!1);return}if(C!==j){L("الرقم السري الجديد وتأكيده غير متطابقين"),te(!1);return}if(W()){if(!y){L("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),te(!1);return}if(!he(y)){L("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),te(!1);return}}be(C),ie({title:W()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:W()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),oe()}catch{L("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{te(!1)}},oe=()=>{w(""),s(""),R(""),L(""),O(!1),g(!1),T(!1),u(!1)};return e.jsx(pe,{open:i,onOpenChange:oe,children:e.jsxs(ge,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(fe,{children:e.jsxs(ye,{className:"flex items-center gap-2 text-right",children:[e.jsx(na,{className:"h-5 w-5 text-blue-600"}),W()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:de,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:W()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),W()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"currentPin",type:D?"text":"password",autoComplete:"off",value:y,onChange:ae=>w(ae.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>O(!D),children:D?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"newPin",type:k?"text":"password",autoComplete:"off",value:C,onChange:ae=>s(ae.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>g(!k),children:k?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:N?"text":"password",autoComplete:"off",value:j,onChange:ae=>R(ae.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>T(!N),children:N?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),J&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ha,{className:"h-4 w-4"}),J]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:H,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(Ja,{className:"h-4 w-4 mr-2"}),H?"جاري الحفظ...":W()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(h,{type:"button",variant:"outline",onClick:oe,disabled:H,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function Kh({open:i,onOpenChange:u,onSuccess:c,title:y,description:w,currentBalance:C,balanceLabel:s,userId:j}){const[R,D]=n.useState(""),[O,k]=n.useState(""),[g,N]=n.useState("add"),[T,J]=n.useState(!1),[L,H]=n.useState(""),[te,ie]=n.useState(!1),[M,W]=n.useState(!1);n.useEffect(()=>{let oe=!0;return(async()=>{const ae=await ps.hasMasterPin(j);oe&&W(ae)})(),()=>{oe=!1}},[j,i]);const he=async oe=>{oe.preventDefault(),H(""),ie(!0);try{const ae=parseFloat(O);if(isNaN(ae)||ae<=0){H("يرجى إدخال مبلغ صحيح أكبر من صفر"),ie(!1);return}if(g==="subtract"&&ae>C){H("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),ie(!1);return}if(M)if(await ps.verifyMasterPin(R,j)){const Be=g==="add"?ae:-ae;be(),c(Be)}else H("الرقم السري غير صحيح");else H("لم يتم تعيين الرقم السري الرئيسي. يرجى تعيينه من إعدادات البروفيل أولاً")}catch{H("حدث خطأ أثناء التحقق من الرقم السري")}finally{ie(!1)}},be=()=>{D(""),k(""),N("add"),H(""),u(!1)},de=()=>{const oe=parseFloat(O)||0;return g==="add"?C+oe:C-oe};return e.jsx(pe,{open:i,onOpenChange:be,children:e.jsxs(ge,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(fe,{children:e.jsxs(ye,{className:"flex items-center gap-2 text-right",children:[g==="add"?e.jsx(xs,{className:"h-5 w-5 text-green-600"}):e.jsx(Ka,{className:"h-5 w-5 text-red-600"}),y]})}),e.jsxs("form",{onSubmit:he,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:w}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(Q,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[C.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{type:"button",variant:g==="add"?"default":"outline",onClick:()=>N("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(xs,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(h,{type:"button",variant:g==="subtract"?"default":"outline",onClick:()=>N("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(Ka,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Q,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",g==="add"?"إضافته":"خصمه"]}),e.jsx(U,{id:"amount",type:"number",step:"0.01",min:"0.01",value:O,onChange:oe=>k(oe.target.value),placeholder:`أدخل المبلغ المراد ${g==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),O&&!isNaN(parseFloat(O))&&e.jsxs("div",{className:`p-3 rounded-lg ${g==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(Q,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${g==="add"?"text-green-700":"text-red-700"}`,children:[de().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"pin",type:T?"text":"password",autoComplete:"off",value:R,onChange:oe=>D(oe.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>J(!T),children:T?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),L&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(Ha,{className:"h-4 w-4"}),L]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(h,{type:"button",variant:"outline",onClick:be,className:"flex-1",children:"إلغاء"}),e.jsx(h,{type:"submit",disabled:te||!R||!O,className:`flex-1 ${g==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:te?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ja,{className:"h-4 w-4 mr-2"}),g==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}const Ho={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_APP_VERSION:"0.0.0",VITE_DEV_MODE:"true",VITE_ENABLE_OFFLINE_PERSISTENCE:"false",VITE_FIREBASE_API_KEY:"AIzaSyA33RTf43u2QE2OsK1RepQHSKrSet9ZI0s",VITE_FIREBASE_APP_ID:"1:483702062341:web:b1ff06ad175cb7ae428b6c",VITE_FIREBASE_AUTH_DOMAIN:"voda-c6abd.firebaseapp.com",VITE_FIREBASE_AUTH_EMULATOR_URL:"http://localhost:9099",VITE_FIREBASE_FIRESTORE_EMULATOR_HOST:"localhost:8080",VITE_FIREBASE_FUNCTIONS_EMULATOR_HOST:"localhost:5001",VITE_FIREBASE_MEASUREMENT_ID:"G-CV6QGH7G7P",VITE_FIREBASE_MESSAGING_SENDER_ID:"483702062341",VITE_FIREBASE_PROJECT_ID:"voda-c6abd",VITE_FIREBASE_STORAGE_BUCKET:"voda-c6abd.appspot.com",VITE_FORCE_HASH_ROUTER:"true",VITE_SHOP_ID:"demo-shop-001",VITE_SHOP_NAME:"محل كاشي لينك التجريبي",VITE_SHOW_ENV_BANNER:"true",VITE_USE_EMULATORS:"false",VITE_USE_FIREBASE_EMULATOR:"false"},Aa=i=>typeof i=="string"&&i.trim().length>0,Jh={getCurrentMonthId(){const i=new Date;return`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}`},async getWalletUsage(i){var u;try{if(!Aa(i))return console.error("Error getting wallet usage: invalid walletId",i),null;const c=ze(K,"walletLimits",i),y=await fa(c);if(y.exists()){const C=y.data();return{walletId:i,used_transfer:C.monthlyTransferUsed??C.used_transfer??0,used_withdraw:C.monthlyWithdrawUsed??C.used_withdraw??0,monthly_limit:C.monthlyLimit??C.monthlyTransferLimit??C.monthlyWithdrawLimit??2e5,last_reset:C.lastMonthlyReset??C.last_reset??null,updatedAt:C.updatedAt||qa.now()}}const w={walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:qa.now()};return await qs(c,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,monthlyTransferLimit:2e5,monthlyWithdrawLimit:2e5,lastMonthlyReset:null,updatedAt:ut(),ownerId:(u=nr.currentUser)==null?void 0:u.uid}),w}catch(c){return console.error("Error getting wallet usage:",c),{walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:qa.now()}}},shouldResetLimits(i){const u=new Date,c=u.getDate();if(!i)return c===1;if(c===1){const y=i.toDate(),w=u.getMonth(),C=u.getFullYear();return y.getMonth()!==w||y.getFullYear()!==C}return!1},async autoResetLimitsIfNeeded(i){try{if(!Aa(i))return console.error("خطأ في التصفير التلقائي للحدود: walletId غير صالح",i),!1;typeof import.meta<"u";const u=await this.getWalletUsage(i);return u&&this.shouldResetLimits(u.last_reset)?(console.log(`🔄 تصفير تلقائي للحدود للمحفظة ${i} - اليوم الأول من الشهر`),await this.resetWalletUsage(i)):!1}catch(u){return console.error("خطأ في التصفير التلقائي للحدود:",u),!1}},async resetWalletUsage(i){try{if(!Aa(i))return console.error("خطأ في تصفير استخدام المحفظة: walletId غير صالح",i),!1;const u=ze(K,"walletLimits",i);return await qs(u,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:ut(),updatedAt:ut()},{merge:!0}),console.log(`🔄 تم تصفير استخدام المحفظة ${i} بنجاح`),!0}catch(u){return console.error("خطأ في تصفير استخدام المحفظة:",u),!1}},async calculateUsageFromTransactions(i){var u,c;try{if(!Aa(i))return console.error("خطأ في حساب الاستخدام من المعاملات: walletId غير صالح",i),{used_transfer:0,used_withdraw:0};const y=ze(K,"walletLimits",i),w=new Date;let C=qa.fromDate(new Date(w.getFullYear(),w.getMonth(),1));try{const O=await fa(y);C=O.exists()?((u=O.data())==null?void 0:u.lastMonthlyReset)??((c=O.data())==null?void 0:c.last_reset)??C:C}catch{}const s=He(De(K,"tx"),je("uid","==",i),...C?[je("createdAt",">=",C)]:[]),j=await it(s);let R=0,D=0;return j.forEach(O=>{const k=O.data();k.status==="completed"&&(k.type==="transfer"?R+=k.amount:k.type==="withdraw"&&(D+=k.amount))}),{used_transfer:R,used_withdraw:D}}catch(y){return console.error("خطأ في حساب الاستخدام من المعاملات:",y),{used_transfer:0,used_withdraw:0}}},async getWalletUsageWithRefresh(i){var u,c;try{if(!Aa(i))return console.error("خطأ في الحصول على الاستخدام مع التحديث: walletId غير صالح",i),null;typeof import.meta<"u";const y=await this.getWalletUsage(i);if(!y){const C=await this.calculateUsageFromTransactions(i),s=ze(K,"walletLimits",i);try{await qs(s,{monthlyTransferUsed:C.used_transfer,monthlyWithdrawUsed:C.used_withdraw,updatedAt:ut(),ownerId:(u=nr.currentUser)==null?void 0:u.uid},{merge:!0})}catch{}return{walletId:i,used_transfer:C.used_transfer,used_withdraw:C.used_withdraw,monthly_limit:2e5,last_reset:null,updatedAt:qa.now()}}const w=await this.calculateUsageFromTransactions(i);if(y.used_transfer!==w.used_transfer||y.used_withdraw!==w.used_withdraw){const C=ze(K,"walletLimits",i);try{await qs(C,{monthlyTransferUsed:w.used_transfer,monthlyWithdrawUsed:w.used_withdraw,updatedAt:ut(),ownerId:(c=nr.currentUser)==null?void 0:c.uid},{merge:!0})}catch{}return await this.getWalletUsage(i)}return y}catch(y){return console.error("خطأ في الحصول على الاستخدام مع التحديث:",y),{walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:qa.now()}}},calculateRemaining(i){return{remainingTransfer:Math.max(0,i.monthly_limit-i.used_transfer),remainingWithdraw:Math.max(0,i.monthly_limit-i.used_withdraw)}},async canPerformOperation(i,u,c){try{if(!Aa(i))return console.error("Error checking operation limits: invalid walletId",i),{canPerform:!1,message:"walletId غير صالح"};const y=await this.getWalletUsageWithRefresh(i);if(!y)return{canPerform:!1,message:"لا يمكن العثور على بيانات الاستخدام للمحفظة"};const w=this.calculateRemaining(y);return c==="transfer"&&u>w.remainingTransfer?{canPerform:!1,message:`تجاوز حد التحويل المسموح. المتبقي: ${w.remainingTransfer.toLocaleString()} ج.م من أصل ${y.monthly_limit.toLocaleString()} ج.م`,remaining:w.remainingTransfer}:c==="withdraw"&&u>w.remainingWithdraw?{canPerform:!1,message:`تجاوز حد السحب المسموح. المتبقي: ${w.remainingWithdraw.toLocaleString()} ج.م من أصل ${y.monthly_limit.toLocaleString()} ج.م`,remaining:w.remainingWithdraw}:{canPerform:!0}}catch(y){return console.error("Error checking operation limits:",y),{canPerform:!1,message:"خطأ في التحقق من الحدود"}}},async updateUsage(i,u,c){var y;try{if(!Aa(i))throw new Error("walletId غير صالح");const w=await this.getWalletUsageWithRefresh(i);if(!w)throw new Error("لا يمكن العثور على بيانات الاستخدام للمحفظة");const C=await this.canPerformOperation(i,u,c);if(!C.canPerform)throw new Error(C.message||"لا يمكن إجراء العملية");const s=c==="transfer"?w.used_transfer+u:w.used_transfer,j=c==="withdraw"?w.used_withdraw+u:w.used_withdraw,R=ze(K,"walletLimits",w.walletId);try{await qs(R,{monthlyTransferUsed:s,monthlyWithdrawUsed:j,updatedAt:ut(),ownerId:(y=nr.currentUser)==null?void 0:y.uid},{merge:!0})}catch{}let D=await this.getWalletUsageWithRefresh(i);return D||(D={walletId:i,used_transfer:s,used_withdraw:j,monthly_limit:w.monthly_limit,last_reset:w.last_reset,updatedAt:qa.now()}),D}catch(w){throw console.error("Error updating wallet usage:",w),w}},async resetWalletUsageManually(i){try{if(!Aa(i))throw new Error("walletId غير صالح");const u=ze(K,"walletLimits",i),c={walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:0,last_reset:null,updatedAt:new Date};return qs(u,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:ut(),updatedAt:ut()},{merge:!0}).catch(y=>{console.error("خطأ في حفظ تصفير الاستخدام في Firebase:",y)}),console.log(`✅ تم تصفير استخدام المحفظة ${i} بنجاح`),c}catch(u){throw console.error("Error resetting wallet usage:",u),u}},async getAllWalletsUsage(i){try{const c=(await Xs.getByMerchantId(i)).map(w=>this.getWalletUsageWithRefresh(w.id));return(await Promise.all(c)).filter(w=>w!==null)}catch(u){return console.error("Error getting all wallets usage:",u),[]}}};function Yh(i){return i?`readBroadcastIds_${i}`:"readBroadcastIds_guest"}function Hh({className:i}){const{user:u,profile:c,isSubscriptionActive:y}=la(),w=rc(),[C,s]=n.useState([]),[j,R]=n.useState(new Set),[D,O]=n.useState(!1),[k,g]=n.useState(""),[N,T]=n.useState(!1),[J,L]=n.useState(null),[H,te]=n.useState("none"),[ie,M]=n.useState(null),[W,he]=n.useState(!1);n.useRef(new Set),n.useRef(!1);const be=n.useRef(null),de=n.useRef(null);n.useRef(null);const[oe,ae]=n.useState({position:"fixed",top:0,left:0,zIndex:1e4}),Me=!1,Be=n.useMemo(()=>{const re=["global"];return u!=null&&u.uid&&re.push(`user:${u.uid}`),c!=null&&c.shopId&&re.push(`shop:${c.shopId}`),re},[u==null?void 0:u.uid,c==null?void 0:c.shopId]),Pe=Yh(u==null?void 0:u.uid),Ke=n.useMemo(()=>{var ft;const re=(ft=w==null?void 0:w.pathname)==null?void 0:ft.includes("/user/pending-approval");return!!(u!=null&&u.uid)&&!re},[u==null?void 0:u.uid,w==null?void 0:w.pathname]);n.useEffect(()=>{try{const re=localStorage.getItem(Pe);if(re){const Se=JSON.parse(re);Array.isArray(Se)&&R(new Set(Se.filter(Boolean)))}else R(new Set)}catch(re){console.warn("Failed to load read ids",re),R(new Set)}},[Pe]),n.useEffect(()=>{if(!Ke){s([]);return}const re=yh(Be,Se=>{s(Se)});return()=>re()},[Be,Ke]),n.useEffect(()=>{},[C]),n.useEffect(()=>()=>{be.current&&clearTimeout(be.current)},[]);const qe=C.reduce((re,Se)=>re+(Se.id&&!j.has(Se.id)?1:0),0),ot=re=>{if(!re||j.has(re))return;const Se=new Set(j);Se.add(re),R(Se);try{localStorage.setItem(Pe,JSON.stringify(Array.from(Se)))}catch{}},ee=()=>{const re=C.map(ft=>ft.id).filter(Boolean),Se=new Set(j);re.forEach(ft=>Se.add(ft)),R(Se);try{localStorage.setItem(Pe,JSON.stringify(Array.from(Se)))}catch{}},ue=(re,Se)=>{re&&window.open(re,"_blank"),Se&&ot(Se)};n.useEffect(()=>{},[W]);const tt=async()=>{if(!(u!=null&&u.uid)){alert("يرجى تسجيل الدخول لإرسال الطلب.");return}const re=k.trim();if(!re){alert("يرجى كتابة سبب طلب التحدث.");return}try{T(!0),L(null);const Se=c!=null&&c.fullName&&c.fullName.trim()?c.fullName.trim():u.email?u.email.split("@")[0]:"مستخدم",ft=(c==null?void 0:c.phone)||null;await Vs(De(K,"waiting_list"),{userId:u.uid,name:Se,phone:ft,reason:re,status:"pending",createdAt:ut()}),L("تم إرسال طلبك إلى قائمة الانتظار بنجاح ✅"),g(""),setTimeout(()=>O(!1),900)}catch(Se){console.error("فشل إرسال طلب قائمة الانتظار:",Se),alert("حدث خطأ أثناء إرسال الطلب. حاول مرة أخرى.")}finally{T(!1)}};return n.useEffect(()=>{if(!(u!=null&&u.uid)){te("none");return}let re=null;try{const Se=He(De(K,"waiting_list"),je("userId","==",u.uid));re=Ms(Se,ft=>{const es=ft.docs.map(Ie=>({id:Ie.id,...Ie.data()})).sort((Ie,Ge)=>{var dt,V,yt,vt,wt,F;const ct=((V=(dt=Ie==null?void 0:Ie.createdAt)==null?void 0:dt.toMillis)==null?void 0:V.call(dt))??((yt=Ie==null?void 0:Ie.createdAt)==null?void 0:yt.seconds)*1e3??0;return(((wt=(vt=Ge==null?void 0:Ge.createdAt)==null?void 0:vt.toMillis)==null?void 0:wt.call(vt))??((F=Ge==null?void 0:Ge.createdAt)==null?void 0:F.seconds)*1e3??0)-ct});if(es.length===0){te("none");return}const qt=es[0],Yt=(qt==null?void 0:qt.contacted)===!0||(qt==null?void 0:qt.status)==="contacted";te(Yt?"contacted":"pending")})}catch(Se){console.warn("⚠️ فشل الاشتراك في waiting_list للمستخدم:",Se),te("none")}return()=>{re&&re()}},[u==null?void 0:u.uid]),Ke?e.jsxs("div",{className:`relative inline-flex items-center gap-2 ${i||""}`,ref:de,children:[e.jsxs(wh,{onOpenChange:re=>{re&&qe>0&&ee()},children:[e.jsx(Nh,{asChild:!0,children:e.jsx(h,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:e.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[e.jsx(Ko,{className:"h-4 w-4 text-primary"}),qe>0&&e.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:qe})]})})}),e.jsxs(jh,{className:"w-80",align:"end",forceMount:!0,children:[e.jsxs(Sh,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"الإشعارات"}),C.length>0&&e.jsxs(h,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:ee,children:[e.jsx(Ma,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),e.jsx(Dh,{}),C.length===0?e.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):e.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:C.map(re=>{const Se=re.id?!j.has(re.id):!1;return e.jsx("div",{className:`px-2 py-2 rounded-md ${Se?"bg-primary/5":""}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Ko,{className:`h-4 w-4 ${Se?"text-primary":"text-muted-foreground"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium",children:re.title||"إشعار"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:re.message}),re.linkUrl&&e.jsxs(h,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>ue(re.linkUrl,re.id),children:["فتح الرابط ",e.jsx(bh,{className:"h-3 w-3 ml-1"})]})]}),Se?e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>ot(re.id),title:"تمييز كمقروء",children:e.jsx(Ma,{className:"h-4 w-4 text-primary"})}):e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:e.jsx(Ma,{className:"h-4 w-4 text-muted-foreground"})})]})},re.id)})})]})]}),e.jsxs(pe,{open:D,onOpenChange:O,children:[e.jsx(Bm,{asChild:!0,children:e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full hover:bg-transparent focus:ring-1 focus:ring-primary/60 focus:ring-offset-1",title:"قائمة الانتظار",children:e.jsx(ba,{className:`h-4 w-4 ${H==="pending"?"text-red-600":H==="contacted"?"text-green-600":"text-muted-foreground"}`})})}),e.jsxs(ge,{className:"max-w-md border border-purple-200/50 shadow-xl bg-gradient-to-br from-purple-50 to-blue-50",children:[e.jsxs(fe,{children:[e.jsx(ye,{children:"طلب التحدث"}),e.jsx(ds,{children:"يرجى كتابة سبب طلب التحدث ليصل للإدارة في قسم قائمة الانتظار."})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"سبب الطلب"}),e.jsx(vh,{value:k,onChange:re=>g(re.target.value),placeholder:"اكتب سبب طلب التحدث هنا...",className:"min-h-[120px] text-right"}),J&&e.jsx("div",{className:"text-sm text-green-700 bg-green-50 border border-green-200 rounded-md p-2",children:J})]}),e.jsxs(nt,{children:[e.jsx(h,{variant:"outline",onClick:()=>O(!1),disabled:N,children:"إلغاء"}),e.jsx(h,{onClick:tt,disabled:N,className:"bg-gradient-to-r from-green-600 to-emerald-600 text-white",children:N?"جارٍ الإرسال...":"إرسال"})]})]})]}),Me]}):null}const Go=({isOpen:i,onClose:u,onTrialStarted:c})=>{const{user:y}=la(),[w,C]=n.useState(!1),[s,j]=n.useState(!1),[R,D]=n.useState(""),[O,k]=n.useState(24);n.useEffect(()=>{const T=async()=>{if(y!=null&&y.uid){const L=await Rr.getTrialData(y.uid);j(L.hasUsedFreeTrial)}},J=async()=>{try{const L=await Rr.getTrialDurationHours();k(L)}catch{}};i&&(T(),J())},[i,y]);const g=async()=>{if(y!=null&&y.uid){C(!0);try{const T=await Rr.startFreeTrial(y.uid);T.success?(D(T.message),window.location.href="/user/dashboard"):D(T.message||"تعذر تفعيل التجربة المجانية")}catch{D("حدث خطأ أثناء تفعيل التجربة المجانية")}finally{C(!1)}}},N=async()=>{if(y!=null&&y.uid){C(!0);try{await Um(y.uid,ws.ZERO,y.uid),window.location.href="/user/dashboard"}catch{D("حدث خطأ أثناء تفعيل باقة الزيرو")}finally{C(!1)}}};return e.jsxs(e.Fragment,{children:[i&&e.jsx("div",{className:"fixed inset-0 z-40",style:{background:"rgba(0, 0, 0, 0.15)",pointerEvents:"auto"}}),e.jsx(pe,{open:i,onOpenChange:()=>{},children:e.jsxs(ge,{className:"sm:max-w-lg z-50 border-0 shadow-2xl",style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"auto",background:"linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%)",borderRadius:"20px",border:"1px solid rgba(255, 255, 255, 0.3)"},children:[e.jsxs(fe,{className:"text-center pb-0 pt-0",children:[e.jsx("div",{className:"flex justify-center mb-1",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 rounded-full",style:{background:"linear-gradient(135deg, #f59e0b, #d97706)",filter:"blur(8px)",opacity:.3}}),e.jsx("div",{className:"relative bg-gradient-to-br from-orange-400 to-orange-600 p-2 rounded-full",children:e.jsx(Gi,{className:"h-12 w-12 text-white"})})]})}),e.jsx(ye,{className:"text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent text-center mt-0 mb-0 leading-tight",children:"تفعيل الحساب مطلوب"})]}),e.jsxs("div",{className:"text-center pt-6 pb-0 px-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-6 mb-6 border border-orange-100",children:[e.jsx("p",{className:"text-gray-700 text-lg leading-relaxed font-medium",children:"حسابك في انتظار التفعيل من قبل المسؤول"}),e.jsx("p",{className:"text-sm font-semibold text-orange-700 mt-3 mb-3 bg-orange-100 p-3 rounded-lg border border-orange-200",children:"للتفعيل السريع: تواصل مع الإدارة عبر واتساب فقط على الرقم التالي"}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg border border-green-200 mt-3",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-base font-bold text-green-700",children:"واتساب الإدارة:"}),e.jsx("a",{href:"https://wa.me/201000392539",target:"_blank",rel:"noopener noreferrer",className:"text-lg font-bold text-green-600 hover:text-green-700 underline",children:"01000392539"})]}),e.jsx("p",{className:"text-sm text-green-600 mt-2 text-center",children:"اضغط على الرقم للتواصل المباشر عبر واتساب"})]})]}),!s&&e.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-4 border border-green-200",children:[e.jsxs("div",{className:"flex items-center justify-center mb-2",children:[e.jsx(Gi,{className:"h-5 w-5 text-green-600 ml-2"}),e.jsx("span",{className:"text-green-700 font-semibold",children:"باقة الزيرو المجانية الدائمة"})]}),e.jsx("p",{className:"text-green-600 text-sm text-center",children:"فعل باقة الزيرو الان واستمتع ب 10 عمليات سحب وتحويل يوميا"})]}),R&&e.jsx("div",{className:`rounded-xl p-4 mb-4 text-center ${R.includes("تم تفعيل")?"bg-green-50 border border-green-200 text-green-700":"bg-red-50 border border-red-200 text-red-700"}`,children:e.jsx("p",{className:"font-medium",children:R})}),e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-sm text-gray-500 mb-0",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse"}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.2s"}}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.4s"}})]}),e.jsx("span",{className:"mr-2",children:"في انتظار التفعيل"})]})]}),e.jsxs("div",{className:"flex flex-col space-y-3 pb-2",children:[!s&&!R.includes("تم تفعيل")&&e.jsxs(e.Fragment,{children:[e.jsxs(h,{onClick:g,disabled:w,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-blue-600 to-indigo-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-blue-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-blue-300",style:{boxShadow:"0 15px 35px rgba(59, 130, 246, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),w?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(Ch,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:`التجربة المجانية لمدة ${O} ${O>=3&&O<=10?"ساعات":O===2?"ساعتين":"ساعة"}`})]})]}),e.jsxs(h,{onClick:N,disabled:w,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-green-600 to-emerald-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-emerald-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-emerald-300",style:{boxShadow:"0 15px 35px rgba(99, 102, 241, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),w?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(Gi,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"فعّل باقة الزيرو الآن"})]})]})]}),e.jsx(h,{onClick:u,variant:"outline",className:"border-2 border-gray-300 hover:border-gray-400 text-gray-700 hover:text-gray-800 px-10 py-3 rounded-xl font-semibold text-lg transition-all duration-300 transform hover:scale-105",children:s?"فهمت":"إغلاق"})]})]})})]})};function Gh({isOpen:i,onClose:u}){const[c,y]=n.useState("0"),[w,C]=n.useState(null),[s,j]=n.useState(null),[R,D]=n.useState(!1),O=M=>{R?(y(M),D(!1)):y(c==="0"?M:c+M)},k=M=>{const W=parseFloat(c);if(w===null)C(W);else if(s){const be=g(w||0,W,s);y(String(be)),C(be)}D(!0),j(M)},g=(M,W,he)=>{switch(he){case"+":return M+W;case"-":return M-W;case"×":return M*W;case"÷":return W===0?0:M/W;case"=":return W;default:return W}},N=()=>{const M=parseFloat(c);if(w!==null&&s){const W=g(w,M,s);y(String(W)),C(null),j(null),D(!0)}},T=()=>{y("0"),C(null),j(null),D(!1)},J=()=>{y("0")},L=()=>{R?(y("0."),D(!1)):c.indexOf(".")===-1&&y(c+".")},H=()=>{c!=="0"&&y(c.charAt(0)==="-"?c.slice(1):"-"+c)},te=()=>{const M=parseFloat(c);y(String(M/100))},ie=M=>{const W=M.key;M.preventDefault(),W>="0"&&W<="9"?O(W):W==="+"?k("+"):W==="-"?k("-"):W==="*"?k("×"):W==="/"?k("÷"):W==="Enter"||W==="="?N():W==="Escape"||W==="c"||W==="C"?T():W==="Backspace"?J():W==="."?L():W==="%"&&te()};return n.useEffect(()=>(i?document.addEventListener("keydown",ie):document.removeEventListener("keydown",ie),()=>{document.removeEventListener("keydown",ie)}),[i,c,w,s,R]),e.jsx(pe,{open:i,onOpenChange:M=>!M&&u(),children:e.jsxs(ge,{className:"sm:max-w-md",children:[e.jsx(fe,{children:e.jsxs(ye,{className:"flex items-center gap-2 text-right",children:[e.jsx(uc,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:c})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:T,children:"AC"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:J,children:"CE"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:te,children:"%"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>k("÷"),children:"÷"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>O("7"),children:"7"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>O("8"),children:"8"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>O("9"),children:"9"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>k("×"),children:"×"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>O("4"),children:"4"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>O("5"),children:"5"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>O("6"),children:"6"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>k("-"),children:"-"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>O("1"),children:"1"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>O("2"),children:"2"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>O("3"),children:"3"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>k("+"),children:"+"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>O("0"),children:"0"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:L,children:"."}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:N,children:"="})]}),e.jsx(h,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:H,children:"+/-"})]})]})})}function Qh({isOpen:i,onClose:u,initialBarcode:c}){const[y,w]=n.useState([]),[C,s]=n.useState({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),[j,R]=n.useState(!1),[D,O]=n.useState(null),{toast:k}=Ks(),{user:g,profile:N}=la(),{isShiftActive:T,shiftUser:J}=qr(),{shopId:L}=Jn(),[H,te]=n.useState([]),[ie,M]=n.useState({}),[W,he]=n.useState({}),[be,de]=n.useState({}),[oe,ae]=n.useState(""),[Me,Be]=n.useState(!1),[Pe,Ke]=n.useState({}),[qe,ot]=n.useState(!1),[ee,ue]=n.useState(!0),[tt,re]=n.useState(!1),Se=Ve.useRef(""),ft=Ve.useRef(0),[es,qt]=n.useState(0),[Yt,Ie]=n.useState(0),[Ge,ct]=n.useState(!1),[ve,dt]=n.useState(!0),[V,yt]=n.useState(!1),[vt,wt]=n.useState(!0),[F,xe]=n.useState(!0),[ke,mt]=n.useState({}),[xt,kt]=n.useState(!1),[_t,Nt]=n.useState("التحقق قبل العملية"),[et,Ot]=n.useState("أدخل الرقم السري الرئيسي للمتابعة"),At=Ve.useRef(null),Ht=(d,I,_)=>{Nt(d),Ot(I),At.current=_,kt(!0)},[Gt,Js]=n.useState([]),[ea,gs]=n.useState(!1),[Fs,Ys]=n.useState(""),[A,se]=n.useState(""),[ce,Ce]=n.useState(""),[Oe,$e]=n.useState(null);n.useEffect(()=>{(async()=>{try{if(!i||!(g!=null&&g.uid))return;const d=await Te.getUserData(g.uid),I=Array.isArray(d==null?void 0:d.customers)?d.customers.map(_=>({id:String(_.id||""),name:String(_.name||""),mobile:_.mobile||void 0})):[];Js(I)}catch{}})()},[i,g==null?void 0:g.uid]);const[st,B]=n.useState(!1),[Fe,G]=n.useState(null),[Dt,Ct]=n.useState(null),jt=(d,I)=>{G(d),Ct(I),B(!0)},[Qt,Zt]=n.useState(""),ta=n.useMemo(()=>{const d=Qt.trim().toLowerCase();return d?H.filter(I=>I.name.toLowerCase().includes(d)):H},[H,Qt]),wa=()=>new Date().toISOString().split("T")[0];n.useEffect(()=>{i&&(g!=null&&g.uid)&&(z(),ve||Jt())},[i,g==null?void 0:g.uid,ve]),n.useEffect(()=>{if(!(!i||!(g!=null&&g.uid)))try{const d=wa(),I=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date),_=q=>{try{const Ne=q.docs.map(Ze=>{const Ee=Ze.data();return{id:String(Ee.clientId||Ze.id),productName:String(Ee.productName||""),price:Number(Ee.sellingPrice||0),wholesalePrice:typeof Ee.wholesalePrice=="number"?Ee.wholesalePrice:Number(Ee.wholesalePrice||0),quantity:Number(Ee.quantity||0),date:String(Ee.date||d),time:String(Ee.time||""),performedByType:Ee.performedByType||void 0,performedByName:Ee.performedByName||void 0,performedByUsername:Ee.performedByUsername||null,serialNumber:Ee.serialNumber||void 0,barcode:Ee.barcode||void 0,firestoreId:Ze.id}}),We=(y||[]).filter(Ze=>!Ze.firestoreId),Ue={};[...Ne,...We].forEach(Ze=>{Ue[Ze.id]=Ze});const _e=Object.values(Ue);we(_e)}catch{}};let Y;try{const q=L||(N==null?void 0:N.shopId)||null,Ne=He(De(K,"dailySales"),je("userId","==",g.uid),...q?[je("shopId","==",q)]:[]);Y=Ms(Ne,_,()=>{try{Y&&Y()}catch{}const We=He(De(K,"users",g.uid,"dailySales"),...q?[je("shopId","==",q)]:[]);Y=Ms(We,_)})}catch{const q=L||(N==null?void 0:N.shopId)||null,Ne=He(De(K,"users",g.uid,"dailySales"),...q?[je("shopId","==",q)]:[]);Y=Ms(Ne,_)}return()=>{try{Y&&Y()}catch{}}}catch{}},[i,g==null?void 0:g.uid]),n.useEffect(()=>{if(!i)return;const d=I=>{const _=Date.now();if(I.key==="Enter"){const Y=(Se.current||"").trim();Se.current="",Y&&ja(Y);return}I.key.length===1&&(_-(ft.current||0)>100&&(Se.current=""),Se.current+=I.key,ft.current=_)};return window.addEventListener("keydown",d),()=>window.removeEventListener("keydown",d)},[i,H]),n.useEffect(()=>{i&&c&&ja(c)},[i,c]);const oa=async()=>{if(g!=null&&g.uid)try{const d=N==null?void 0:N.shopId;let I,_=[];if(d){const Y=He(De(K,"products"),je("shopId","==",d),je("userId","==",g.uid));if(I=await it(Y),_=I.docs.map(q=>({id:q.id,name:String(q.data().name??""),sellingPrice:Number(q.data().sellingPrice??0),wholesalePrice:Number(q.data().wholesalePrice??0),quantity:Number(q.data().quantity??0),barcode:String(q.data().barcode??""),serialNumber:String(q.data().serialNumber??"")})),_.length===0){const q=He(De(K,"products"),je("userId","==",g.uid)),We=(await it(q)).docs.map(Ue=>({id:Ue.id,name:String(Ue.data().name??""),sellingPrice:Number(Ue.data().sellingPrice??0),wholesalePrice:Number(Ue.data().wholesalePrice??0),quantity:Number(Ue.data().quantity??0),barcode:String(Ue.data().barcode??""),serialNumber:String(Ue.data().serialNumber??"")}));We.length>0&&(_=We,k({title:"تم استرجاع المنتجات",description:"عثرنا على منتجات محفوظة لك خارج المتجر الحالي وقمنا بعرضها."}))}}else{const Y=He(De(K,"products"),je("userId","==",g.uid));I=await it(Y),_=I.docs.map(q=>({id:q.id,name:String(q.data().name??""),sellingPrice:Number(q.data().sellingPrice??0),wholesalePrice:Number(q.data().wholesalePrice??0),quantity:Number(q.data().quantity??0),barcode:String(q.data().barcode??""),serialNumber:String(q.data().serialNumber??"")}))}if(te(_),N!=null&&N.shopId&&_.length>0){const Y=_.filter(q=>{const Ne=((I==null?void 0:I.docs)||[]).find(Ue=>Ue.id===q.id);return!(!!Ne&&!!Ne.data().shopId)});if(Y.length>0)try{await Promise.all(Y.map(q=>Es(ze(K,"products",q.id),{shopId:N.shopId,updatedAt:ut()}))),k({title:"تم ترتيب المنتجات",description:"تم ربط بعض المنتجات غير المربوطة بمتجرك الحالي تلقائياً."})}catch(q){console.warn("تعذّر ترحيل shopId لبعض المنتجات:",q)}}}catch(d){console.error("Error loading shop products:",d)}};n.useEffect(()=>{i&&(g!=null&&g.uid)&&(oa(),Jt(),z(),$a())},[i,g==null?void 0:g.uid,N==null?void 0:N.shopId]);const sa=()=>{const d=new Date,I=d.getFullYear(),_=String(d.getMonth()+1).padStart(2,"0"),Y=String(d.getDate()).padStart(2,"0");return`${I}-${_}-${Y}`},z=()=>{if(!(g!=null&&g.uid)){console.log("No user authenticated, cannot load sales data");return}const d=L||(N==null?void 0:N.shopId)||"main",I=`salesData_all_${g.uid}_${d}`,_=localStorage.getItem(I);if(_)try{w(JSON.parse(_));return}catch{}const Y=sa(),q=`salesData_${g.uid}_${d}_${Y}`,Ne=localStorage.getItem(q);if(Ne){const Ze=JSON.parse(Ne);w(Ze);try{localStorage.setItem(I,JSON.stringify(Ze))}catch{}return}const We=new Date().toISOString().split("T")[0],Ue=`salesData_${g.uid}_${d}_${We}`,_e=localStorage.getItem(Ue);if(_e){const Ze=JSON.parse(_e);w(Ze);try{localStorage.setItem(q,_e),localStorage.setItem(I,_e)}catch{}return}lt()},we=d=>{if(!(g!=null&&g.uid)){console.log("No user authenticated, cannot save sales data");return}const I=L||(N==null?void 0:N.shopId)||"main",_=sa(),Y=`salesData_${g.uid}_${I}_${_}`,q=`salesData_all_${g.uid}_${I}`;localStorage.setItem(Y,JSON.stringify(d));try{const Ne=localStorage.getItem(q),We=Ne?JSON.parse(Ne):[],Ue={};[...Array.isArray(We)?We:[],...d].forEach(_e=>{Ue[_e.id]=_e}),localStorage.setItem(q,JSON.stringify(Object.values(Ue)))}catch{}w(d)},St=d=>{if(!(g!=null&&g.uid)){console.log("No user authenticated, cannot save sales data");return}const I=L||(N==null?void 0:N.shopId)||"main",_=`salesData_all_${g.uid}_${I}`;try{const Y=localStorage.getItem(_),q=Y?JSON.parse(Y):[],Ne={};[...Array.isArray(q)?q:[],...d].forEach(We=>{Ne[We.id]=We}),localStorage.setItem(_,JSON.stringify(Object.values(Ne)))}catch{}w(d)},lt=async()=>{if(g!=null&&g.uid)try{const d=L||(N==null?void 0:N.shopId)||null,I=new Date().toISOString().split("T")[0],_=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date);let Y,q;try{const Ze=He(De(K,"dailySales"),je("userId","==",g.uid),...d?[je("shopId","==",d)]:[]);Y=await it(Ze)}catch{}try{const Ze=He(De(K,"users",g.uid,"dailySales"),...d?[je("shopId","==",d)]:[]);q=await it(Ze)}catch{}const We=[...Y?Y.docs:[],...q?q.docs:[]].map(Ze=>{const Ee=Ze.data();return{id:String(Ee.clientId||Ze.id),firestoreId:Ze.id,productName:String(Ee.productName||""),price:Number(Ee.sellingPrice||0),wholesalePrice:Ee.wholesalePrice!==void 0?Number(Ee.wholesalePrice):null,quantity:Number(Ee.quantity||0),date:String(Ee.date||I),time:String(Ee.time||""),serialNumber:Ee.serialNumber||void 0,barcode:Ee.barcode||void 0,performedByType:Ee.performedByType||void 0,performedByName:Ee.performedByName||void 0,performedByUsername:Ee.performedByUsername||void 0,isDeferred:!!Ee.isDeferred,customerName:Ee.customerName||void 0,customerMobile:Ee.customerMobile||void 0,customerId:Ee.customerId||void 0}}),Ue={};[...y,...We].forEach(Ze=>{Ue[Ze.id]=Ze});const _e=Object.values(Ue);St(_e)}catch{}},Jt=async()=>{if(g!=null&&g.uid)try{const d=new Date,I=new Date(d.getFullYear(),d.getMonth(),1),_=new Date(d.getFullYear(),d.getMonth()+1,0),Y=Ee=>Ee.toISOString().split("T")[0],q=Y(I),Ne=Y(_),We=L||(N==null?void 0:N.shopId)||null;let Ue;try{const Ee=He(De(K,"dailySales"),je("userId","==",g.uid),...We?[je("shopId","==",We)]:[]);Ue=await it(Ee)}catch{const Ee=He(De(K,"users",g.uid,"dailySales"),...We?[je("shopId","==",We)]:[]);Ue=await it(Ee)}let _e=0,Ze=0;Ue.forEach(Ee=>{const Ft=Ee.data(),Bs=String(Ft.date??"").slice(0,10);if(!Ft.isDeferred&&Bs>=q&&Bs<=Ne){const Vt=Number(Ft.sellingPrice??0),$s=Number(Ft.quantity??0),Wa=Number(Ft.profit??(Number(Ft.sellingPrice??0)-Number(Ft.wholesalePrice??0))*$s);_e+=Vt*$s,Ze+=Wa}}),qt(_e),Ie(Ze)}catch(d){console.error("Error loading monthly stats:",d)}},os=async d=>{if(!(g!=null&&g.uid))return null;try{const I=((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0),_=T&&J?"cashier":"admin",Y=_==="cashier"?(J==null?void 0:J.name)||"كاشير":(N==null?void 0:N.fullName)||(g==null?void 0:g.displayName)||"الحساب الرئيسي",q=_==="cashier"&&(J==null?void 0:J.username)||null,Ne=await Vs(De(K,"dailySales"),{userId:g.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit:I,date:d.date,time:d.time,performedByType:_,performedByName:Y,performedByUsername:q,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:L?{shopId:L}:{},createdAt:ut()});try{await qs(ze(K,"users",g.uid,"dailySales",Ne.id),{userId:g.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit:I,date:d.date,time:d.time,performedByType:_,performedByName:Y,performedByUsername:q,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:L?{shopId:L}:{},createdAt:ut()})}catch{}return Ne.id}catch{try{const I=await Vs(De(K,"users",g.uid,"dailySales"),{userId:g.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit,date:d.date,time:d.time,performedByType,performedByName,performedByUsername,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:L?{shopId:L}:{},createdAt:ut()});try{await qs(ze(K,"dailySales",I.id),{userId:g.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit,date:d.date,time:d.time,performedByType,performedByName,performedByUsername,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:L?{shopId:L}:{},createdAt:ut()})}catch{}return I.id}catch(I){return console.error("Error saving sale:",I),null}}},Bt=()=>{const d=L||(N==null?void 0:N.shopId)||"main";return`cashBalance_${(g==null?void 0:g.uid)||"default"}_${d}`},Na=async(d,I)=>{if(g!=null&&g.uid)try{const _=ze(K,"dailySales",d);await Es(_,I)}catch{try{const _=ze(K,"users",g.uid,"dailySales",d);await Es(_,I)}catch(_){console.error("Error updating sale:",_)}}},Ga=async d=>{try{const I=d.firestoreId;if(I)await Na(I,{isDeferred:!1});else try{const _=He(De(K,"dailySales"),je("userId","==",(g==null?void 0:g.uid)||""),je("date","==",d.date),je("productName","==",d.productName),Or(5)),q=(await it(_)).docs[0];q&&await Es(q.ref,{isDeferred:!1})}catch{}w(_=>_.map(Y=>Y.id===d.id?{...Y,isDeferred:!1}:Y));try{await Jt()}catch{}k({title:"تم التسديد",description:`تم تسديد أجل ${d.productName}`})}catch(I){console.error("Error marking deferred sale as paid:",I),k({title:"فشل التسديد",description:"تعذّر تحديث حالة البيع المؤجّل",variant:"destructive"})}},$a=async()=>{if(!(g!=null&&g.uid))return;const d=y.filter(I=>!I.firestoreId);if(d.length!==0)for(const I of d)try{let _;try{const q=He(De(K,"dailySales"),je("userId","==",g.uid),je("clientId","==",I.id),Or(1));_=await it(q)}catch{const q=He(De(K,"users",g.uid,"dailySales"),je("clientId","==",I.id),Or(1));_=await it(q)}if(!_.empty){const q=_.docs[0].id,Ne=y.map(We=>We.id===I.id?{...We,firestoreId:q}:We);we(Ne);continue}const Y=await os(I);if(Y){const q=y.map(Ne=>Ne.id===I.id?{...Ne,firestoreId:Y}:Ne);we(q)}}catch{}},ts=async d=>{try{if(g!=null&&g.uid)try{const _e=De(K,"deficiencies"),Ze=await Vs(_e,{shopId:(N==null?void 0:N.shopId)||g.uid||"default-shop",name:d,quantity:1,status:"pending",createdAt:ut()});try{const Ee=`deficiencies_${(N==null?void 0:N.shopId)||(g==null?void 0:g.uid)||"default-shop"}`,Ft=localStorage.getItem(Ee),Bs=Ft?JSON.parse(Ft):[],Vt=Array.isArray(Bs)?Bs:[],$s=Vt.some(fs=>String((fs==null?void 0:fs.id)||"")===Ze.id),Wa={id:Ze.id,name:d,quantity:1,status:"pending",createdAt:new Date().toISOString()},Sa=$s?Vt:[...Vt,Wa];localStorage.setItem(Ee,JSON.stringify(Sa))}catch{}k({title:"تمت الإضافة للنواقص",description:`المنتج ${d} نفد من المخزون وتمت إضافته للنواقص`});return}catch(_e){console.warn("Failed to add deficiency to Firestore, falling back to local storage:",_e)}const I=`deficiencies_${(N==null?void 0:N.shopId)||(g==null?void 0:g.uid)||"default-shop"}`,_=localStorage.getItem(I),Y=_?JSON.parse(_):[],q=Array.isArray(Y)?Y:[];if(q.some(_e=>String((_e==null?void 0:_e.name)||"").trim()===d&&String((_e==null?void 0:_e.status)||"pending")==="pending"))return;const We={id:Date.now().toString(),name:d,quantity:1,status:"pending",createdAt:new Date().toISOString()},Ue=[...q,We];localStorage.setItem(I,JSON.stringify(Ue)),k({title:"تمت الإضافة للنواقص",description:`المنتج ${d} نفد من المخزون وتمت إضافته للنواقص`})}catch(I){console.error("Error adding deficiency for out-of-stock:",I)}},Qe=async(d,I=!1,_)=>{const Y=ie[d.id]||"",q=parseInt(Y);if(isNaN(q)||q<=0){k({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(q>d.quantity){k({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const Ne=new Date,We=T&&J?"cashier":"admin",Ue=We==="cashier"?(J==null?void 0:J.name)||"كاشير":(N==null?void 0:N.fullName)||(g==null?void 0:g.displayName)||"الحساب الرئيسي",_e=We==="cashier"&&(J==null?void 0:J.username)||null,Ze=(d.serialNumber||"").trim(),Ee=ke[d.id]||"",Ft=parseFloat(Ee),Bs=!isNaN(Ft)&&Ft>0?Ft:d.sellingPrice,Vt={id:Date.now().toString(),productName:d.name,price:Bs,wholesalePrice:d.wholesalePrice,quantity:q,date:Ne.toISOString().split("T")[0],time:Ne.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),performedByType:We,performedByName:Ue,performedByUsername:_e,serialNumber:Ze||void 0,barcode:d.barcode,isDeferred:I,customerName:_==null?void 0:_.name,customerMobile:_==null?void 0:_.mobile,customerId:_==null?void 0:_.id};try{const $s=await os(Vt),Wa=$s?{...Vt,firestoreId:$s}:Vt;we([...y,Wa]);const Sa=d.quantity-q;if(await Es(ze(K,"products",d.id),{quantity:Sa,updatedAt:ut()}),te(fs=>fs.map(ca=>ca.id===d.id?{...ca,quantity:Sa}:ca)),M(fs=>({...fs,[d.id]:""})),mt(fs=>({...fs,[d.id]:""})),Sa===0&&ts(d.name),!I)try{const fs=Bs*q,ca=Bt(),Vr=localStorage.getItem(ca),Kr=(Vr?parseFloat(Vr):0)+fs;localStorage.setItem(ca,Kr.toString());const cr=`userData_${g==null?void 0:g.uid}`,dr={cashBalance:Kr,lastUpdated:new Date().toISOString()};localStorage.setItem(cr,JSON.stringify(dr)),g!=null&&g.uid&&Te.updateUserData(g.uid,dr).catch(()=>{})}catch(fs){console.warn("تعذر تحديث رصيد الدرج النقدي بعد البيع:",fs)}k({title:"تم البيع",description:`تم بيع ${q} قطعة من ${d.name}`})}catch($s){console.error("Error selling product:",$s),k({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},Et=async d=>{if(g!=null&&g.uid){if(T){k({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف إيصالات البيع أثناء الورديه",variant:"destructive"});return}Ht("تأكيد حذف إيصال بيع","أدخل الرقم السري الرئيسي لحذف الإيصال وعكس الآثار",async()=>{try{if(!d.isDeferred)try{const I=(d.price??0)*(d.quantity??0),_=Bt(),Y=localStorage.getItem(_),Ne=(Y?parseFloat(Y):0)-I;localStorage.setItem(_,Ne.toString());const We=`userData_${g==null?void 0:g.uid}`,Ue={cashBalance:Ne,lastUpdated:new Date().toISOString()};localStorage.setItem(We,JSON.stringify(Ue)),g!=null&&g.uid&&Te.updateUserData(g.uid,Ue).catch(()=>{})}catch(I){console.warn("تعذر عكس رصيد الدرج النقدي عند حذف الإيصال:",I)}try{const I=H.find(_=>d.barcode&&_.barcode===d.barcode||_.name===d.productName);if(I){const _=(I.quantity||0)+(d.quantity||0);await Es(ze(K,"products",I.id),{quantity:_,updatedAt:ut()}),te(Y=>Y.map(q=>q.id===I.id?{...q,quantity:_}:q))}}catch(I){console.warn("تعذر عكس المخزون عند حذف الإيصال:",I)}try{if(d.firestoreId){try{await js(ze(K,"dailySales",d.firestoreId))}catch{}try{await js(ze(K,"users",g.uid,"dailySales",d.firestoreId))}catch{}}else{let I;try{const _=He(De(K,"dailySales"),je("userId","==",g.uid),je("date","==",d.date),je("productName","==",d.productName),Or(5));I=await it(_)}catch{const _=He(De(K,"users",g.uid,"dailySales"),je("date","==",d.date),je("productName","==",d.productName),Or(5));I=await it(_)}if(!I.empty){const _=I.docs.find(Y=>{const q=Y.data();return Number((q==null?void 0:q.sellingPrice)??0)===Number(d.price??0)&&Number((q==null?void 0:q.quantity)??0)===Number(d.quantity??0)&&String((q==null?void 0:q.time)??"")===String(d.time??"")})||I.docs[0];_&&await js(_.ref)}}}catch(I){console.warn("تعذر حذف سجل البيع من Firestore:",I)}try{const I=sa(),_=`salesData_${g.uid}_${I}`,Y=`salesData_all_${g.uid}`,q=y.filter(_e=>_e.id!==d.id);localStorage.setItem(_,JSON.stringify(q));const Ne=localStorage.getItem(Y),We=Ne?JSON.parse(Ne):[],Ue=(Array.isArray(We)?We:[]).filter(_e=>(_e==null?void 0:_e.id)!==d.id);localStorage.setItem(Y,JSON.stringify(Ue)),w(q)}catch(I){console.warn("تعذر تحديث التخزين المحلي بعد الحذف:",I)}try{ve||await Jt()}catch{}k({title:"تم حذف الإيصال",description:`تم حذف إيصال بيع للمنتج ${d.productName} وتم عكس الآثار`})}catch(I){console.error("Error deleting sale:",I),k({title:"فشل حذف الإيصال",description:"تعذّر حذف إيصال البيع",variant:"destructive"})}})}},Rs=async d=>{try{M(I=>({...I,[d.id]:"1"})),await Qe(d)}catch(I){console.error("Error selling by barcode:",I)}},Ds=async d=>{if(T){k({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة قطع أثناء الورديه",variant:"destructive"});return}const I=W[d.id]||"",_=parseInt(I);if(isNaN(_)||_<=0){k({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للإضافة",variant:"destructive"});return}Ht("تأكيد إضافة قطع","لا يمكن إضافة قطع إلا بإدخال الرقم السري الرئيسي",async()=>{try{const Y=d.quantity+_;await Es(ze(K,"products",d.id),{quantity:Y,updatedAt:ut()}),te(q=>q.map(Ne=>Ne.id===d.id?{...Ne,quantity:Y}:Ne)),he(q=>({...q,[d.id]:""})),k({title:"تمت الإضافة",description:`تمت إضافة ${_} قطعة إلى ${d.name}`})}catch(Y){console.error("Error adding pieces:",Y),k({title:"فشل الإضافة",description:"تعذّر إضافة الكمية إلى المخزون",variant:"destructive"})}})},La=async d=>{if(!(g!=null&&g.uid))return;if(T){k({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف المنتجات أثناء الورديه",variant:"destructive"});return}window.confirm(`هل تريد حذف المنتج "${d.name}"؟`)&&Ht("تأكيد حذف منتج","لا يمكن حذف المنتجات إلا بإدخال الرقم السري الرئيسي",async()=>{try{await js(ze(K,"products",d.id)),te(_=>_.filter(Y=>Y.id!==d.id)),k({title:"تم الحذف",description:`تم حذف المنتج ${d.name}`})}catch(_){console.error("Error deleting product:",_),k({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}})},Cs=async()=>{try{if(!(g!=null&&g.uid)){k({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}if(T){k({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتجات أثناء الورديه",variant:"destructive"});return}const d=C.productName.trim(),I=parseFloat(C.price),_=parseFloat(C.wholesalePrice||"0"),Y=parseInt(C.quantity);if(!d||isNaN(I)||isNaN(Y)){k({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const q={name:d,sellingPrice:I,wholesalePrice:isNaN(_)?0:_,quantity:isNaN(Y)?0:Y,userId:g.uid,createdAt:ut(),updatedAt:ut()},Ne=(C.barcode||"").trim();Ne&&(q.barcode=Ne);const We=(C.serialNumber||"").trim();We&&(q.serialNumber=We),N!=null&&N.shopId&&(q.shopId=N.shopId);const Ue=await Vs(De(K,"products"),q);te(_e=>[{id:Ue.id,name:d,sellingPrice:I,wholesalePrice:isNaN(_)?0:_,quantity:isNaN(Y)?0:Y,barcode:(C.barcode||"").trim()||"",serialNumber:(C.serialNumber||"").trim()||""},..._e]),s({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),k({title:"تمت الإضافة",description:`تم إضافة المنتج ${d} بنجاح`})}catch(d){console.error("createProduct error",d),k({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}},ja=async d=>{const I=(d||"").trim();if(!I)return;const _=H.find(Y=>(Y.barcode||"")===I);if(!_){k({title:"باركود غير معروف",description:"لم يتم العثور على منتج بهذا الباركود"});return}await Rs(_)},ss=()=>{const d=Object.entries(Pe).map(([_e,Ze])=>{const Ee=Number(Ze),Ft=H.find(Bs=>Bs.id===_e);return!Ft||!Ee||Ee<=0?null:{name:Ft.name,qty:Ee,price:Ft.sellingPrice,total:Ee*Ft.sellingPrice}}).filter(Boolean);if(d.length===0){k({title:"لم يتم اختيار منتجات",description:"فعّل وضع الفاتورة واختر منتجات وكميات للطباعة"});return}const I=(N==null?void 0:N.shopName)||(g==null?void 0:g.displayName)||"المحل",_=(N==null?void 0:N.phone)||(g==null?void 0:g.phoneNumber)||"",Y=d.reduce((_e,Ze)=>_e+Ze.total,0),q=new Date().toLocaleString("ar-EG"),Ne=d.map(_e=>`
        <tr>
          <td style="border:1px solid #ddd;padding:6px">${_e.name}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${_e.qty}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${Xt(_e.price)}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center;font-weight:bold;color:#0a7">${Xt(_e.total)}</td>
        </tr>
      `).join(""),We=`
      <html>
        <head>
          <meta charset="utf-8" />
          <title>فاتورة</title>
          <style>
            body { font-family: Tahoma, Arial, sans-serif; direction: rtl; }
            .header { text-align: center; margin-bottom: 12px; }
            .header h2 { margin: 0; }
            .meta { text-align: center; color: #555; margin-bottom: 8px; }
            table { width: 100%; border-collapse: collapse; }
            .total { text-align: left; font-weight: bold; margin-top: 10px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>${I}</h2>
            ${_?`<div class="meta">رقم التليفون: ${_}</div>`:""}
            <div class="meta">التاريخ: ${q}</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="border:1px solid #ddd;padding:6px">المنتج</th>
                <th style="border:1px solid #ddd;padding:6px">الكمية</th>
                <th style="border:1px solid #ddd;padding:6px">السعر</th>
                <th style="border:1px solid #ddd;padding:6px">الإجمالي</th>
              </tr>
            </thead>
            <tbody>
              ${Ne}
            </tbody>
          </table>
          <div class="total">الإجمالي الكلي: ${Xt(Y)}</div>
        </body>
      </html>
    `,Ue=window.open("","_blank");Ue&&(Ue.document.write(We),Ue.document.close(),Ue.focus(),Ue.print(),Ue.close())};return e.jsxs(pe,{open:i,onOpenChange:u,children:[e.jsxs(ge,{className:"max-w-none w-[100vw] md:w-[100vw] lg:w-[100vw] max-h-[85vh] md:h-[100dvh] md:max-h-[100dvh] p-0 overflow-y-auto",children:[e.jsx(fe,{className:"px-3 md:px-6 py-3 md:py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-blue-100 rounded-lg",children:e.jsx(Un,{className:"h-5 w-5 md:h-6 md:w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(ye,{className:"text-lg md:text-xl font-bold text-gray-800",children:"📊 قسم المبيعات"}),e.jsx("p",{className:"text-xs md:text-sm text-gray-600 mt-1 hidden sm:block",children:"إدارة وتتبع المبيعات"})]})]}),e.jsxs("div",{className:"flex items-center gap-1 md:gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:()=>$a(),className:"text-xs md:text-sm",children:"استرجاع الإيصالات"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:u,className:"h-8 w-8 md:h-9 md:w-9",children:e.jsx(ac,{className:"h-4 w-4"})})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row h-full",dir:"rtl",children:[e.jsxs("div",{className:"w-full md:w-72 lg:w-80 bg-white/50 border-r",children:[e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(zt,{className:"h-4 w-4 text-green-600"}),"ملخص المبيعات"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:gap-3",children:[e.jsxs("div",{className:"bg-blue-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-blue-600",children:Xt(y.filter(d=>!d.isDeferred).reduce((d,I)=>d+I.price*I.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-blue-600",children:"إجمالي المبيعات"})]}),e.jsxs("div",{className:"relative bg-green-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsxs("div",{className:ee?"filter blur-sm pointer-events-none":"",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-green-600",children:Xt(y.filter(d=>!d.isDeferred).reduce((d,I)=>d+(I.price-(I.wholesalePrice??0))*I.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-green-600",children:"إجمالي الأرباح"})]}),ee&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>re(!0),className:"bg-white/80 hover:bg-white text-green-700 border border-green-200",children:"عرض الأرباح"})})]}),e.jsxs("div",{className:"bg-yellow-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-yellow-600",children:Va(H.length)}),e.jsx("div",{className:"text-xs md:text-sm text-yellow-600",children:"عدد المنتجات"})]}),e.jsxs("div",{className:"bg-purple-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-purple-600",children:Va(y.filter(d=>!d.isDeferred).length)}),e.jsx("div",{className:"text-xs md:text-sm text-purple-600",children:"عدد المبيعات"})]})]}),e.jsxs("div",{className:"relative mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1 md:gap-2 text-xs md:text-sm font-semibold text-indigo-700",children:[e.jsx(Ea,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx(Un,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{children:"تقارير الشهر"})]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>yt(d=>!d),className:"h-6 w-6 p-0 rounded-full",title:V?"إظهار التقارير":"إخفاء التقارير",children:V?e.jsx(Br,{className:"h-4 w-4"}):e.jsx(Fn,{className:"h-4 w-4"})})]}),e.jsx("div",{className:V?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]",children:e.jsxs("div",{className:ve?"grid grid-cols-2 gap-2 md:gap-4 filter blur-sm pointer-events-none":"grid grid-cols-2 gap-2 md:gap-4",children:[e.jsxs("div",{className:"bg-indigo-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-indigo-600",children:Xt(es)}),e.jsx("div",{className:"text-xs md:text-sm text-indigo-600",children:"مبيعات الشهر"})]}),e.jsxs("div",{className:"bg-pink-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-pink-600",children:Xt(Yt)}),e.jsx("div",{className:"text-xs md:text-sm text-pink-600",children:"أرباح الشهر"})]})]})}),!V&&ve&&e.jsx("div",{className:"absolute left-0 right-0 top-7 md:top-10 bottom-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:async()=>{try{if(await isZeroPlan()){k({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}ct(!0)},className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all btn-monthly-reports",title:"عرض تقارير الشهر",children:[e.jsx(Wt,{className:"h-5 w-5 md:h-7 md:w-7"}),e.jsx("span",{className:"text-xs md:text-sm",children:"عرض تقارير الشهر"})]})})]})]}),e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(Wr,{className:"h-4 w-4 text-indigo-600"}),"إحصائيات المنتجات"]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>wt(d=>!d),className:"h-6 w-6 p-0 rounded-full",title:vt?"إظهار القسم":"إخفاء القسم",children:vt?e.jsx(Br,{className:"h-4 w-4"}):e.jsx(Fn,{className:"h-4 w-4"})})]}),e.jsx("div",{className:vt?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]}),e.jsxs("div",{className:"p-3 md:p-4 flex-1 hidden md:block",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(al,{className:"h-4 w-4 text-blue-600"}),"نصائح للمبيعات"]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>xe(d=>!d),className:"h-6 w-6 p-0 rounded-full",title:F?"إظهار القسم":"إخفاء القسم",children:F?e.jsx(Br,{className:"h-4 w-4"}):e.jsx(Fn,{className:"h-4 w-4"})})]}),e.jsx("div",{className:F?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-visible transition-all duration-300 ease-in-out",children:e.jsxs("div",{className:"p-3 md:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-2",children:[e.jsxs("h2",{className:"text-base md:text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Oh,{className:"h-4 w-4 md:h-5 md:w-5 text-blue-600"}),"سجل المبيعات (",y.filter(d=>!d.isDeferred).length," عنصر)"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm text-gray-600",children:[e.jsx(Ea,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(ba,{className:"h-3 w-3 md:h-4 md:w-4 ml-2"}),e.jsx("span",{children:new Date().toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 md:p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(xs,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج جديد"]}),e.jsxs(h,{size:"sm",variant:"ghost",className:"h-8",onClick:()=>{if(T){k({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتج أثناء الورديه",variant:"destructive"});return}Ht("فتح نموذج إضافة منتج","أدخل الرقم السري الرئيسي لفتح نموذج الإضافة",()=>R(!0))},children:[e.jsx(xs,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج"]})]}),j&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(Q,{htmlFor:"new-product-name",className:"text-xs md:text-sm",children:"اسم المنتج"}),e.jsx(U,{id:"new-product-name",value:C.productName,onChange:d=>s(I=>({...I,productName:d.target.value})),placeholder:"أدخل اسم المنتج"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(Q,{htmlFor:"new-product-price",className:"text-xs md:text-sm",children:"سعر البيع (ج.م)"}),e.jsx(U,{type:"number",id:"new-product-price",value:C.price,onChange:d=>s(I=>({...I,price:d.target.value})),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(Q,{htmlFor:"new-product-wholesale",className:"text-xs md:text-sm",children:"سعر الجملة (ج.م)"}),e.jsx(U,{type:"number",id:"new-product-wholesale",value:C.wholesalePrice||"",onChange:d=>s(I=>({...I,wholesalePrice:d.target.value})),placeholder:"0.00"})]})]}),e.jsxs("div",{children:[e.jsx(Q,{htmlFor:"new-product-qty",className:"text-xs md:text-sm",children:"الكمية"}),e.jsx(U,{type:"number",id:"new-product-qty",value:C.quantity,onChange:d=>s(I=>({...I,quantity:d.target.value})),placeholder:"1"})]}),e.jsxs("div",{children:[e.jsx(Q,{htmlFor:"new-product-barcode",className:"text-xs md:text-sm",children:"باركود المنتج (اختياري)"}),e.jsx(U,{id:"new-product-barcode",value:C.barcode||"",onChange:d=>s(I=>({...I,barcode:d.target.value})),placeholder:"أدخل/امسح الباركود"})]}),e.jsxs("div",{children:[e.jsx(Q,{htmlFor:"new-product-serial",className:"text-xs md:text-sm",children:"سيريال الجهاز (اختياري)"}),e.jsx(U,{id:"new-product-serial",value:C.serialNumber||"",onChange:d=>s(I=>({...I,serialNumber:d.target.value})),placeholder:"أدخل سيريال الجهاز"})]}),e.jsx(h,{className:"h-9 w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white",onClick:Cs,children:"إضافة المنتج"})]})]}),e.jsx("div",{id:"shop-products-section",className:"bg-white rounded-lg border border-gray-200 overflow-hidden mb-4",children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 mb-2 flex items-center gap-2",children:[e.jsx(Wr,{className:"h-4 w-4 text-green-600"}),"منتجات المحل"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(h,{variant:Me?"default":"outline",size:"sm",onClick:()=>Be(d=>!d),children:Me?"وضع الفاتورة: مفعل":"تفعيل وضع الفاتورة"}),e.jsx(h,{size:"sm",className:"bg-indigo-600 hover:bg-indigo-700 text-white",disabled:Object.keys(Pe).filter(d=>(Pe[d]||0)>0).length===0,onClick:ss,children:"طباعة فاتورة"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(U,{value:Qt,onChange:d=>Zt(d.target.value),placeholder:"ابحث عن منتج...",className:"h-9 w-full md:w-72 text-sm","aria-label":"البحث عن منتج من منتجات المحل"}),e.jsx(U,{value:oe,onChange:d=>ae(d.target.value),onKeyDown:async d=>{if(d.key!=="Enter")return;const I=oe.trim();I&&(await ja(I),ae(""))},placeholder:"مرّر ماسح الباركود هنا (اختياري)",className:"h-9 w-full md:w-64 text-sm","aria-label":"مسح الباركود لإضافة المنتج تلقائياً"}),Qt&&e.jsx(h,{variant:"ghost",size:"sm",className:"h-9",onClick:()=>Zt(""),children:"مسح"})]}),e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg hidden md:block",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>ot(d=>!d),"aria-label":qe?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:qe?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المتاح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"بيع"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:ta.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-3 py-3 text-center text-gray-500",children:H.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"})}):ta.map(d=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:d.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Xt(d.sellingPrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:e.jsx("span",{className:qe?"":"blur-sm select-none",children:Xt(d.wholesalePrice)})}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Va(d.quantity)}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 flex-nowrap",children:[e.jsx(U,{value:ie[d.id]||"",onChange:I=>M(_=>({..._,[d.id]:I.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-8 w-28 text-sm"}),e.jsx(U,{value:ke[d.id]||"",onChange:I=>mt(_=>({..._,[d.id]:I.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-8 w-32 text-sm","aria-label":`سعر بيع اختياري لـ ${d.name}`}),e.jsx(h,{size:"sm",className:"h-8 min-w-[64px] bg-indigo-600 hover:bg-indigo-700 text-white",onClick:()=>Qe(d),children:"بيع"}),e.jsx(h,{size:"sm",className:"h-8 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>{$e(d),gs(!0)},children:"بيع أجل"}),Me&&e.jsx(U,{value:Pe[d.id]??"",onChange:I=>{const _=parseInt(I.target.value||"0");Ke(Y=>({...Y,[d.id]:isNaN(_)?0:_}))},type:"number",placeholder:"كمية للفاتورة",className:"h-8 w-24 text-sm"}),e.jsx(U,{value:W[d.id]||"",onChange:I=>he(_=>({..._,[d.id]:I.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-8 w-28 text-sm",disabled:T}),e.jsxs("div",{className:"inline-flex items-center gap-2 flex-nowrap",children:[e.jsx(h,{size:"sm",variant:"outline",className:"h-8 whitespace-nowrap",onClick:()=>Ds(d),disabled:T,title:T?"غير مسموح في وضع الكاشير":void 0,children:"إضافة قطع جديدة"}),e.jsx(h,{size:"sm",variant:"destructive",className:"h-8",onClick:()=>La(d),title:"حذف المنتج",disabled:T,children:e.jsx(is,{className:"h-4 w-4"})})]})]})})]},d.id))})]})}),e.jsx("div",{className:"block md:hidden space-y-3",children:ta.length===0?e.jsx("div",{className:"text-center text-gray-500 text-sm",children:H.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"}):ta.map(d=>e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm break-words",children:d.name}),e.jsx(h,{size:"sm",variant:"destructive",className:"h-8 min-w-[44px] touch-manipulation",onClick:()=>La(d),title:"حذف المنتج",disabled:T,children:e.jsx(is,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-700",children:[e.jsx("div",{className:"text-gray-600",children:"سعر البيع"}),e.jsx("div",{className:"text-right font-medium",children:Xt(d.sellingPrice)}),e.jsxs("div",{className:"text-gray-600 inline-flex items-center gap-1",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>ot(I=>!I),"aria-label":qe?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:qe?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:qe?"":"blur-sm select-none",children:Xt(d.wholesalePrice)})}),e.jsx("div",{className:"text-gray-600",children:"المتاح"}),e.jsx("div",{className:"text-right font-medium",children:Va(d.quantity)})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{value:ie[d.id]||"",onChange:I=>M(_=>({..._,[d.id]:I.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للبيع لـ ${d.name}`}),e.jsx(U,{value:ke[d.id]||"",onChange:I=>mt(_=>({..._,[d.id]:I.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-9 w-28 text-sm","aria-label":`سعر بيع اختياري لـ ${d.name}`}),e.jsx(h,{size:"sm",className:"h-9 min-w-[64px] bg-indigo-600 hover:bg-indigo-700 text-white",onClick:()=>Qe(d),children:"بيع"}),e.jsx(h,{size:"sm",className:"h-9 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>{$e(d),gs(!0)},children:"بيع أجل"})]}),Me&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(U,{value:Pe[d.id]??"",onChange:I=>{const _=parseInt(I.target.value||"0");Ke(Y=>({...Y,[d.id]:isNaN(_)?0:_}))},type:"number",placeholder:"كمية للفاتورة",className:"h-9 flex-1 text-sm","aria-label":`كمية للفاتورة لـ ${d.name}`})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{value:W[d.id]||"",onChange:I=>he(_=>({..._,[d.id]:I.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للإضافة لـ ${d.name}`,disabled:T}),e.jsx(h,{size:"sm",variant:"outline",className:"h-9 min-w-[64px]",onClick:()=>Ds(d),disabled:T,title:T?"غير مسموح في وضع الكاشير":void 0,children:"إضافة"})]})]})]},d.id))})]})}),y.length===0?e.jsxs("div",{className:"text-center py-8 md:py-12",children:[e.jsx("div",{className:"w-16 h-16 md:w-24 md:h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx(Wr,{className:"h-8 w-8 md:h-12 md:w-12 text-gray-400"})}),e.jsx("h3",{className:"text-base md:text-lg font-medium text-gray-900 mb-2",children:"لا توجد مبيعات اليوم"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ابدأ ببيع منتج من القائمة أعلاه"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"block md:hidden",children:e.jsx("div",{className:"max-h-[70vh] overflow-y-auto space-y-3 p-3",children:y.map(d=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-200 shadow-sm",children:[e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-base break-words",children:d.productName}),d.isDeferred&&e.jsx("span",{className:"px-2 py-0.5 rounded bg-amber-100 text-amber-700 text-[11px]",children:"مؤجّل"})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(zt,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر البيع"})]}),e.jsx("div",{className:"text-right font-medium",children:Xt(d.price)}),typeof d.wholesalePrice=="number"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(zt,{className:"h-4 w-4 text-indigo-600"}),e.jsxs("span",{className:"text-gray-600 inline-flex items-center gap-1",children:["سعر الجملة",e.jsx(h,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>ot(I=>!I),"aria-label":qe?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:qe?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:qe?"":"blur-sm select-none",children:Xt(d.wholesalePrice)})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Wr,{className:"h-4 w-4 text-emerald-600"}),e.jsx("span",{className:"text-gray-600",children:"الكمية"})]}),e.jsx("div",{className:"text-right font-medium",children:Va(d.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fr,{className:"h-4 w-4 text-indigo-600"}),e.jsx("span",{className:"text-gray-600",children:"الربح"})]}),e.jsx("div",{className:"text-right font-semibold text-indigo-600",children:e.jsx("span",{className:qe?"":"blur-sm select-none",children:Xt(((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0))})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(zt,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"الإجمالي"})]}),e.jsx("div",{className:"text-right font-bold text-green-700",children:Xt(d.price*d.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_h,{className:"h-4 w-4 text-amber-600"}),e.jsx("span",{className:"text-gray-600",children:"المنفذ"})]}),e.jsx("div",{className:"text-right text-gray-700",children:d.performedByName??"-"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ea,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"التاريخ"})]}),e.jsx("div",{className:"text-right text-gray-600",children:Qo(d.date)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ba,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"الوقت"})]}),e.jsx("div",{className:"text-right text-gray-600",children:d.time})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[d.isDeferred&&e.jsx(h,{size:"sm",className:"h-8 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>Ga(d),title:"تم التسديد",children:"تم التسديد"}),e.jsx(h,{size:"sm",variant:"outline",onClick:()=>jt(d,"return"),disabled:T,title:T?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsxs(h,{size:"sm",variant:"destructive",onClick:()=>jt(d,"delete"),disabled:T,title:T?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:[e.jsx(is,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-1",children:"حذف الإيصال"})]})]})]},d.id))})}),e.jsx("div",{className:"hidden md:block overflow-x-auto max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-green-300 scrollbar-track-green-100 hover:scrollbar-thumb-green-400",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر البيع (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة (ج.م)"}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>ot(d=>!d),"aria-label":qe?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:qe?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الإجمالي (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الربح (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الوقت"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنفذ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"إجراءات"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:y.map((d,I)=>e.jsxs("tr",{className:I%2===0?"bg-white":"bg-gray-50/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:e.jsxs("div",{className:"flex items-center gap-2 justify-end md:justify-start",children:[e.jsx("span",{children:d.productName}),d.isDeferred&&e.jsx("span",{className:"px-2 py-0.5 rounded bg-amber-100 text-amber-700 text-xs",children:"مؤجّل"})]})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Xt(d.price)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:typeof d.wholesalePrice=="number"?e.jsx("span",{className:qe?"":"blur-sm select-none",children:Xt(d.wholesalePrice)}):"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Va(d.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-green-600",children:Xt(d.price*d.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-indigo-600",children:e.jsx("span",{className:qe?"":"blur-sm select-none",children:Xt(((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0))})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:Qo(d.date)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:d.time}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:d.performedByName??"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[d.isDeferred&&e.jsx(h,{size:"sm",className:"h-8 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>Ga(d),title:"تم التسديد",children:"تم التسديد"}),e.jsx(h,{size:"sm",variant:"outline",onClick:()=>jt(d,"return"),disabled:T,title:T?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsx(h,{size:"sm",variant:"destructive",onClick:()=>jt(d,"delete"),disabled:T,title:T?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:e.jsx(is,{className:"h-4 w-4"})})]})})]},d.id))})]})})]})]})})]})]}),e.jsx(pe,{open:ea,onOpenChange:gs,children:e.jsxs(ge,{className:"max-w-sm mx-auto bg-white border border-gray-200 shadow-2xl rounded-2xl sm:max-w-md",children:[e.jsx(fe,{className:"text-center",children:e.jsx(ye,{className:"text-base md:text-lg font-bold text-gray-900",children:"بيع أجل"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsx(Q,{className:"text-sm",children:"اختيار عميل (اختياري)"}),e.jsxs("select",{className:"h-9 border rounded px-2 text-sm",value:Fs,onChange:d=>{const I=d.target.value;Ys(I);const _=Gt.find(Y=>Y.id===I);_&&(se(_.name),Ce(_.mobile||""))},children:[e.jsx("option",{value:"",children:"-- بدون اختيار --"}),Gt.map(d=>e.jsxs("option",{value:d.id,children:[d.name,d.mobile?` - ${d.mobile}`:""]},d.id))]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsx(Q,{className:"text-sm",children:"اسم العميل"}),e.jsx(U,{value:A,onChange:d=>se(d.target.value),placeholder:"اسم العميل",className:"h-9 text-sm"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsx(Q,{className:"text-sm",children:"رقم التليفون (اختياري)"}),e.jsx(U,{value:ce,onChange:d=>Ce(d.target.value),placeholder:"رقم التليفون",className:"h-9 text-sm"})]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-3 mt-3",children:[e.jsx(h,{variant:"outline",className:"h-8 min-w-[80px]",onClick:()=>gs(!1),children:"إلغاء"}),e.jsx(h,{className:"h-8 min-w-[100px] bg-amber-600 hover:bg-amber-700 text-white",onClick:async()=>{try{const d=Oe;if(!d){gs(!1);return}const I=A.trim(),_=ce.trim()||void 0,Y=Fs||void 0;if(!I){k({title:"بيانات مطلوبة",description:"أدخل اسم العميل",variant:"destructive"});return}await Qe(d,!0,{id:Y,name:I,mobile:_});try{if(g!=null&&g.uid){const q=d.sellingPrice*(parseInt(ie[d.id]||"0")||0),Ne=await Te.getUserData(g.uid),We=Array.isArray(Ne==null?void 0:Ne.debts)?Ne.debts:[],_e=[{id:Date.now().toString(),debtorName:I,customerId:Y||null,mobile:_||null,amount:q,reason:`بيع أجل للمنتج ${d.name}`,status:"pending",createdAt:new Date,partialPayments:[]},...We];await Te.updateUserData(g.uid,{debts:_e})}}catch{}gs(!1),$e(null)}catch{}},children:"تأكيد البيع الآجل"})]})]})}),e.jsx(pe,{open:st,onOpenChange:B,children:e.jsxs(ge,{className:"max-w-sm mx-auto bg-white border border-gray-200 shadow-2xl rounded-2xl sm:max-w-md",children:[e.jsx(fe,{className:"text-center",children:e.jsx(ye,{className:"text-base md:text-lg font-bold text-gray-900",children:Dt==="return"?"تأكيد المرتجع":"تأكيد حذف الإيصال"})}),e.jsxs("div",{className:"space-y-3 text-center px-2",children:[e.jsxs("p",{className:"text-sm text-gray-700",children:["هل تريد ",Dt==="return"?"عمل مرتجع":"حذف الإيصال"," للمنتج:",e.jsxs("span",{className:"font-semibold text-gray-900",children:[" ",Fe==null?void 0:Fe.productName," "]}),"بكمية",e.jsxs("span",{className:"font-semibold text-gray-900",children:[" ",Va((Fe==null?void 0:Fe.quantity)||0)," "]}),"؟"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"سيتم عكس المخزون والرصيد حسب الحالة."})]}),e.jsxs("div",{className:"flex items-center justify-center gap-3 mt-2",children:[e.jsx(h,{variant:"outline",className:"h-8 min-w-[80px]",onClick:()=>B(!1),children:"إلغاء"}),e.jsx(h,{className:"h-8 min-w-[100px] bg-red-600 hover:bg-red-700 text-white",onClick:()=>{const d=Fe;B(!1),d&&Et(d)},children:"تأكيد"})]})]})}),e.jsx(ms,{open:tt,onOpenChange:re,mode:"verify",title:"قفل إجمالي الأرباح",description:"أدخل الرقم السري الرئيسي لعرض إجمالي الأرباح",onSuccess:()=>{ue(!1),re(!1)}}),e.jsx(ms,{open:Ge,onOpenChange:ct,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const d=g==null?void 0:g.uid;if(d){const I=await nl(d),_=(I==null?void 0:I.planType)??(I==null?void 0:I.plan)??null,Y=typeof _=="string"?_.toLowerCase():null;if(_===ws.ZERO||Y==="zero"){k({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}dt(!1),ct(!1),Jt()}}),e.jsx(ms,{open:xt,onOpenChange:kt,mode:"verify",title:_t,description:et,onSuccess:()=>{const d=At.current;At.current=null,kt(!1),d&&d()}})]})}const Va=i=>new Intl.NumberFormat("ar-EG").format(Number(i||0)),Xt=i=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(i||0))} ج.م`,Qo=i=>{try{const u=new Date(i);return isNaN(u.getTime())?new Date(`${i}T00:00:00`).toLocaleDateString("ar-EG"):u.toLocaleDateString("ar-EG")}catch{return i}},Zh=({open:i,onOpenChange:u,userId:c,cashBalance:y,walletBalances:w,transactions:C})=>{const[s,j]=Ve.useState(0),[R,D]=Ve.useState(0),[O,k]=Ve.useState(0),[g,N]=Ve.useState(0),[T,J]=Ve.useState(y||0),[L,H]=Ve.useState(!1),[te,ie]=Ve.useState(null),{toast:M}=Ks(),{shopId:W}=Jn()||{},[he,be]=Ve.useState(!1),[de,oe]=Ve.useState(""),[ae,Me]=Ve.useState(!1),[Be,Pe]=Ve.useState(!1),[Ke,qe]=Ve.useState(""),ot=()=>`cashBalance_${c||"default"}_${W||"main"}`,ee=()=>`cashBalance_${c||"default"}`,ue=Ie=>`${new Intl.NumberFormat("ar-EG").format(Number(Ie||0))} جنيه`;Ve.useEffect(()=>{const Ie=async()=>{try{if(!c){j(0);return}const ve=new Date,dt=ve.getFullYear(),V=String(ve.getMonth()+1).padStart(2,"0"),yt=String(ve.getDate()).padStart(2,"0"),vt=`${dt}-${V}-${yt}`;let wt;try{const xe=He(De(K,"dailySales"),je("userId","==",c),...W?[je("shopId","==",W)]:[],je("date","==",vt));wt=await it(xe)}catch{const xe=He(De(K,"users",c,"dailySales"),...W?[je("shopId","==",W)]:[],je("date","==",vt));wt=await it(xe)}let F=0;wt.forEach(xe=>{const ke=xe.data(),mt=Number(ke.sellingPrice??0),xt=Number(ke.quantity??0);mt>0&&xt>0&&(F+=mt*xt)}),j(F)}catch(ve){console.warn("فشل تحميل مبيعات الإكسسوار لليوم:",ve)}},Ge=async()=>{try{if(!c){setMaintenanceProfitToday(0);return}const ve=new Date,dt=new Date(ve.getFullYear(),ve.getMonth(),ve.getDate(),0,0,0,0),V=new Date(ve.getFullYear(),ve.getMonth(),ve.getDate(),23,59,59,999);let yt;try{const wt=He(De(K,"maintenance_items"),je("userId","==",c),je("status","==","completed"));yt=await it(wt)}catch{yt=await it(He(De(K,"maintenance_items"),je("userId","==",c)))}let vt=0;yt.forEach(wt=>{var ke,mt;const F=wt.data();if((F.status||"in_progress")!=="completed")return;const xe=(mt=(ke=F.completedAt)==null?void 0:ke.toDate)==null?void 0:mt.call(ke);if(xe&&xe.getTime()>=dt.getTime()&&xe.getTime()<=V.getTime()){const xt=Number(F.repairPrice||0);Number.isFinite(xt)&&xt>0&&(vt+=xt)}}),k(Math.max(0,vt))}catch(ve){console.warn("فشل تحميل إجمالي فلوس الصيانة لليوم:",ve)}},ct=async()=>{try{if(!c){D(0);return}const ve=await Te.getUserData(c),dt=new Date().toISOString().slice(0,10),V=(ve==null?void 0:ve.dailyReceipts)||{};V!=null&&V.date&&String(V.date).slice(0,10)===dt?(D(Number(V.accessory||0)),N(Number(V.maintenance||0))):(D(0),N(0));try{const yt=localStorage.getItem(ee()),vt=localStorage.getItem(ot()),wt=yt??vt;wt!=null?J(Number(wt)||0):J(Number((ve==null?void 0:ve.cashBalance)||y||0))}catch{J(Number((ve==null?void 0:ve.cashBalance)||y||0))}}catch{D(0),N(0)}};i&&(Ie(),Ge(),ct())},[i,c,C,y,W]),Ve.useEffect(()=>{const Ie=Ge=>{var ct;try{const ve=Number((ct=Ge==null?void 0:Ge.detail)==null?void 0:ct.value);if(Number.isFinite(ve))J(ve);else{const dt=localStorage.getItem(ee()),V=localStorage.getItem(ot()),yt=dt??V;yt!=null&&J(parseFloat(yt)||0)}}catch{const ve=localStorage.getItem(ee()),dt=localStorage.getItem(ot()),V=ve??dt;V!=null&&J(parseFloat(V)||0)}};return window.addEventListener("cashBalanceChanged",Ie),()=>window.removeEventListener("cashBalanceChanged",Ie)},[i,c,W]);const tt=Math.max(0,Number(s)-Number(R)),re=Math.max(0,Number(O)-Number(g)),Se=async Ie=>{if(!c)return;const Ge=new Date().toISOString().slice(0,10);try{const ct=Ie==="accessory"?tt:re;if(ct<=0){M({title:"لا يوجد مبلغ لتأكيد استلامه",variant:"default"});return}const ve=Math.max(0,Number(T)-ct);J(ve),Ie==="accessory"?D(dt=>dt+ct):N(dt=>dt+ct),await Te.updateUserData(c,{cashBalance:ve,dailyReceipts:{date:Ge,accessory:Ie==="accessory"?R+ct:R,maintenance:Ie==="maintenance"?g+ct:g}});try{localStorage.setItem(`cashBalance_${c}`,String(ve)),localStorage.setItem(ot(),String(ve))}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:ve}}))}catch{}M({title:"تم الاستلام",description:`تم خصم ${ct.toFixed(2)} من الدرج وتصفير بند ${Ie==="accessory"?"الإكسسوار":"الصيانة"}`})}catch{M({title:"خطأ",description:"تعذر تنفيذ عملية تم الاستلام",variant:"destructive"})}},ft=()=>{oe(""),qe(""),be(!0)},es=()=>{if(!de.trim()){M({title:"سبب الخصم مطلوب",variant:"destructive"});return}be(!1),Me(!0)},qt=()=>{Me(!1),Pe(!0)},Yt=async()=>{try{if(!c)return;const Ie=Math.max(0,Number(Ke||0));if(!Number.isFinite(Ie)||Ie<=0){M({title:"مبلغ غير صالح",description:"أدخل مبلغ خصم صحيح أكبر من الصفر",variant:"destructive"});return}const Ge=Math.max(0,Number(T)-Ie);J(Ge),await Te.updateUserData(c,{cashBalance:Ge});try{localStorage.setItem(`cashBalance_${c}`,String(Ge))}catch{}try{localStorage.setItem(ot(),String(Ge))}catch{}const ct={title:"ايصال خصم من الفلوس النقديه",type:"cash_deduction",amount:Ie,status:"completed",createdAt:new Date,note:de,cashierName:"الحساب الرئيسي"};try{await Te.saveUserTransaction(c,ct)}catch{}M({title:"تم الخصم",description:`تم خصم ${Ie.toFixed(2)} من الدرج`}),Pe(!1),qe(""),oe("")}catch{M({title:"فشل الخصم",description:"تعذر تنفيذ عملية الخصم",variant:"destructive"})}};return e.jsx(pe,{open:i,onOpenChange:u,children:e.jsxs(ge,{className:"sm:max-w-lg animate-in fade-in-90 zoom-in-95 slide-in-from-top-4",dir:"rtl",children:[e.jsx(fe,{children:e.jsxs(ye,{className:"flex items-center gap-2 text-right",children:[e.jsx(zt,{className:"h-5 w-5 text-emerald-600"}),"تفاصيل الفلوس النقدية"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between bg-amber-50 border border-amber-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 font-bold text-sm",children:[e.jsx(zt,{className:"h-4 w-4"}),"مجموع الفلوس النقدية (الدرج)"]}),e.jsx("div",{className:"text-amber-700 font-extrabold text-sm",children:ue(T)})]}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 font-bold text-sm",children:[e.jsx(Wr,{className:"h-4 w-4"}),"فلوس الاكسسوار"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-blue-700 font-extrabold text-sm",children:ue(tt)}),e.jsx(h,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800",onClick:()=>{ie("accessory"),H(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-emerald-50 border border-emerald-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-800 font-bold text-sm",children:[e.jsx(il,{className:"h-4 w-4"}),"فلوس الصيانة"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-emerald-700 font-extrabold text-sm",children:ue(re)}),e.jsx(h,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800",onClick:()=>{ie("maintenance"),H(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-red-800 font-bold text-sm",children:"خصم فلوس من الفلوس النقديه"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800",onClick:ft,children:"خصم"})})]})]}),e.jsx(ms,{open:L,onOpenChange:H,mode:"verify",title:"تأكيد الرقم السري لعملية تم الاستلام",description:"يرجى إدخال الرقم السري الرئيسي لتأكيد استلام المبلغ",onSuccess:()=>{te&&(Se(te),ie(null)),H(!1)}}),e.jsx(pe,{open:he,onOpenChange:be,children:e.jsxs(ge,{className:"sm:max-w-sm",children:[e.jsx(fe,{children:e.jsx(ye,{children:"سبب الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"deduct-reason",children:"اكتب سبب الخصم"}),e.jsx(U,{id:"deduct-reason",value:de,onChange:Ie=>oe(Ie.target.value),placeholder:"سبب الخصم"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(h,{variant:"outline",onClick:()=>be(!1),children:"إلغاء"}),e.jsx(h,{onClick:es,className:"bg-red-600 hover:bg-red-700",children:"متابعة"})]})]})}),e.jsx(ms,{open:ae,onOpenChange:Me,mode:"verify",title:"تأكيد الرقم السري لعملية الخصم",description:"يرجى إدخال الرقم السري الرئيسي لمتابعة الخصم",onSuccess:qt}),e.jsx(pe,{open:Be,onOpenChange:Pe,children:e.jsxs(ge,{className:"sm:max-w-sm",children:[e.jsx(fe,{children:e.jsx(ye,{children:"مبلغ الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"deduct-amount",children:"أدخل مبلغ الخصم"}),e.jsx(U,{id:"deduct-amount",type:"number",value:Ke,onChange:Ie=>qe(Ie.target.value),placeholder:"0.00"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(h,{variant:"outline",onClick:()=>Pe(!1),children:"إلغاء"}),e.jsx(h,{onClick:Yt,className:"bg-red-600 hover:bg-red-700",children:"تأكيد الخصم"})]})]})})]})})};function fc({size:i=24,className:u,...c}){return e.jsxs("svg",{width:i,height:i,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:u,...c,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}var yc="AlertDialog",[Xh]=Km(yc,[nc]),va=nc(),bc=i=>{const{__scopeAlertDialog:u,...c}=i,y=va(u);return e.jsx(zm,{...y,...c,modal:!0})};bc.displayName=yc;var eu="AlertDialogTrigger",tu=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,...y}=i,w=va(c);return e.jsx(Xm,{...w,...y,ref:u})});tu.displayName=eu;var su="AlertDialogPortal",vc=i=>{const{__scopeAlertDialog:u,...c}=i,y=va(u);return e.jsx(qm,{...y,...c})};vc.displayName=su;var au="AlertDialogOverlay",wc=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,...y}=i,w=va(c);return e.jsx(Zm,{...w,...y,ref:u})});wc.displayName=au;var lr="AlertDialogContent",[ru,nu]=Xh(lr),iu=Hm("AlertDialogContent"),Nc=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,children:y,...w}=i,C=va(c),s=n.useRef(null),j=ic(u,s),R=n.useRef(null);return e.jsx(Vm,{contentName:lr,titleName:jc,docsSlug:"alert-dialog",children:e.jsx(ru,{scope:c,cancelRef:R,children:e.jsxs(Jm,{role:"alertdialog",...C,...w,ref:j,onOpenAutoFocus:Ym(w.onOpenAutoFocus,D=>{var O;D.preventDefault(),(O=R.current)==null||O.focus({preventScroll:!0})}),onPointerDownOutside:D=>D.preventDefault(),onInteractOutside:D=>D.preventDefault(),children:[e.jsx(iu,{children:y}),e.jsx(ou,{contentRef:s})]})})})});Nc.displayName=lr;var jc="AlertDialogTitle",Sc=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,...y}=i,w=va(c);return e.jsx(Gm,{...w,...y,ref:u})});Sc.displayName=jc;var Dc="AlertDialogDescription",Cc=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,...y}=i,w=va(c);return e.jsx(Qm,{...w,...y,ref:u})});Cc.displayName=Dc;var lu="AlertDialogAction",Ic=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,...y}=i,w=va(c);return e.jsx(lc,{...w,...y,ref:u})});Ic.displayName=lu;var Ac="AlertDialogCancel",Tc=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,...y}=i,{cancelRef:w}=nu(Ac,c),C=va(c),s=ic(u,w);return e.jsx(lc,{...C,...y,ref:s})});Tc.displayName=Ac;var ou=({contentRef:i})=>{const u=`\`${lr}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${lr}\` by passing a \`${Dc}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${lr}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return n.useEffect(()=>{var y;document.getElementById((y=i.current)==null?void 0:y.getAttribute("aria-describedby"))||console.warn(u)},[u,i]),null},cu=bc,du=vc,Pc=wc,kc=Nc,_c=Ic,Oc=Tc,Ec=Sc,Mc=Cc;const mu=cu,hu=du,$c=n.forwardRef(({className:i,...u},c)=>e.jsx(Pc,{className:Ya("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",i),...u,ref:c}));$c.displayName=Pc.displayName;const Lc=n.forwardRef(({className:i,...u},c)=>e.jsxs(hu,{children:[e.jsx($c,{}),e.jsx(kc,{ref:c,className:Ya("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",i),...u})]}));Lc.displayName=kc.displayName;const Wc=({className:i,...u})=>e.jsx("div",{className:Ya("flex flex-col space-y-2 text-center sm:text-left",i),...u});Wc.displayName="AlertDialogHeader";const Fc=n.forwardRef(({className:i,...u},c)=>e.jsx(Ec,{ref:c,className:Ya("text-lg font-semibold",i),...u}));Fc.displayName=Ec.displayName;const Rc=n.forwardRef(({className:i,...u},c)=>e.jsx(Mc,{ref:c,className:Ya("text-sm text-muted-foreground",i),...u}));Rc.displayName=Mc.displayName;const rl=n.forwardRef(({className:i,...u},c)=>e.jsx(_c,{ref:c,className:Ya(oc(),i),...u}));rl.displayName=_c.displayName;const Bc=n.forwardRef(({className:i,...u},c)=>e.jsx(Oc,{ref:c,className:Ya(oc({variant:"outline"}),"mt-2 sm:mt-0",i),...u}));Bc.displayName=Oc.displayName;const Tt=i=>{try{return i.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(i)}},Zo=i=>{try{return(i?new Date(i):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},pa="machine_daily_opening_values",ga="machine_daily_opening_snapshot";function uu({open:i,onOpenChange:u}){const{toast:c}=Ks(),{shiftUser:y}=qr(),{shopId:w,shopName:C}=Jn(),s=()=>{try{const A=Object.keys(localStorage||{}).filter(se=>se.startsWith("selectedShopId_"));for(const se of A){const ce=localStorage.getItem(se);if(ce)return ce}return null}catch{return null}};n.useEffect(()=>{try{if(i){const A=document.body.style.overflow;document.body.setAttribute("data-prev-overflow",A),document.body.style.overflow="hidden"}else{const A=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=A,document.body.removeAttribute("data-prev-overflow")}}catch{}return()=>{try{const A=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=A,document.body.removeAttribute("data-prev-overflow")}catch{}}},[i]);const[j,R]=n.useState(""),[D,O]=n.useState(""),[k,g]=n.useState(""),[N,T]=n.useState(null),[J,L]=n.useState(null),[H,te]=n.useState(null),[ie,M]=n.useState(null),[W,he]=n.useState(!1),[be,de]=n.useState(!1),[oe,ae]=n.useState(""),[Me,Be]=n.useState(""),[Pe,Ke]=n.useState(null),[qe,ot]=n.useState([]),[ee,ue]=n.useState([]),[tt,re]=n.useState(!1),[Se,ft]=n.useState(""),[es,qt]=n.useState(""),[Yt,Ie]=n.useState(!1),[Ge,ct]=n.useState(null),[ve,dt]=n.useState([]),[V,yt]=n.useState(null),[vt,wt]=n.useState(""),[F,xe]=n.useState(!1),[ke,mt]=n.useState(!1);n.useEffect(()=>{if(i)try{const A=V?`${pa}_${V}`:pa,se=V?`${ga}_${V}`:ga,ce=localStorage.getItem(A);if(ce){const Oe=JSON.parse(ce);typeof(Oe==null?void 0:Oe.openingBase)=="number"&&T(Oe.openingBase),typeof(Oe==null?void 0:Oe.openingAir)=="number"&&L(Oe.openingAir),typeof(Oe==null?void 0:Oe.drawerCash)=="number"&&te(Oe.drawerCash)}else T(null),L(null),te(null);const Ce=localStorage.getItem(se);if(Ce){const Oe=JSON.parse(Ce);typeof(Oe==null?void 0:Oe.openingBase)=="number"&&typeof(Oe==null?void 0:Oe.openingAir)=="number"?M({openingBase:Oe.openingBase,openingAir:Oe.openingAir,drawerCash:Oe.drawerCash||0}):M(null)}else M(null)}catch{}},[i,V]),n.useEffect(()=>{(async()=>{try{const A=w||s();if(!i||!A)return;const{getDocs:se}=await gt(async()=>{const{getDocs:$e}=await import("./index-B57-Wohm.js").then(st=>st.bK);return{getDocs:$e}},__vite__mapDeps([0,1]),import.meta.url),ce=De(K,"shops",A,"machines"),Oe=(await se(He(ce))).docs.map($e=>({id:$e.id,name:String($e.data().name||"ماكينة")}));dt(Oe);try{const $e=localStorage.getItem(`machineDaily_selected_${A}`);$e&&Oe.some(B=>B.id===$e)?yt($e):!V&&Oe.length>0&&(yt(Oe[0].id),localStorage.setItem(`machineDaily_selected_${A}`,Oe[0].id))}catch{}}catch(A){console.error("Load machines error:",A)}})()},[i,w]);const xt=n.useMemo(()=>(y==null?void 0:y.displayName)||(y==null?void 0:y.name)||(y==null?void 0:y.username)||void 0,[y]),kt=n.useMemo(()=>ee.reduce((A,se)=>A+(se.profit||0),0),[ee]),_t=n.useMemo(()=>ee.reduce((A,se)=>A+(se.wholesalePrice||0),0),[ee]),Nt=async()=>{try{const A=w||s();if(A&&V){const se=De(K,"shops",A,"machines",V,"transfers"),ce=await it(He(se));await Promise.all(ce.docs.map(Ce=>js(Ce.ref)));try{localStorage.setItem(`machineDaily_transfers_${A}_${V}`,JSON.stringify([]))}catch{}}}catch{}ue([]),c({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."})},et=async()=>{try{const A=w||s();if(A&&V){const se=De(K,"shops",A,"machines",V,"deliveries"),ce=await it(He(se));await Promise.all(ce.docs.map(Ce=>js(Ce.ref)));try{localStorage.setItem(`machineDaily_deliveries_${A}_${V}`,JSON.stringify([]))}catch{}}}catch{}ot([]),c({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."})},Ot=A=>{ot(se=>se.filter(ce=>ce.id!==A)),c({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},At=()=>{T(null),L(null),te(null),M(null),R(""),O(""),g("");try{const A=V?`${pa}_${V}`:pa,se=V?`${ga}_${V}`:ga;localStorage.removeItem(A),localStorage.removeItem(se)}catch{}c({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},Ht=async()=>{var Ce;const A=parseFloat(j||"0"),se=parseFloat(D||"0"),ce=parseFloat(k||"0");if(isNaN(A)||isNaN(se)||isNaN(ce)){c({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(A<0||se<0||ce<0){c({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}T(A),L(se),te(ce);try{const Oe=V?`${pa}_${V}`:pa,$e=V?`${ga}_${V}`:ga;localStorage.setItem(Oe,JSON.stringify({openingBase:A,openingAir:se,drawerCash:ce})),localStorage.setItem($e,JSON.stringify({openingBase:A,openingAir:se,drawerCash:ce})),M({openingBase:A,openingAir:se,drawerCash:ce});const st=w||s();if(st&&V){const B=ze(K,"shops",st,"machines",V);await qs(B,{name:((Ce=ve.find(Fe=>Fe.id===V))==null?void 0:Ce.name)||"ماكينة",openingBase:A,openingAir:se,drawerCash:ce,cashierName:xt,shopName:C||null,updatedAt:ut()},{merge:!0})}}catch{}c({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${Tt(A)}، الهواء: ${Tt(se)}، فلوس الدرج: ${Tt(ce)}`})},Gt=()=>{if(N==null||J==null){c({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}de(!0)},Js=()=>{const A=parseFloat(oe||"0"),se=parseFloat(Me||"0");if(isNaN(A)||isNaN(se)){c({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(A<0||se<0){c({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const ce=(ie==null?void 0:ie.openingBase)??(N||0),Ce=(ie==null?void 0:ie.openingAir)??(J||0),Oe=ce+Ce,st=A+se-Oe;Ke(st);const B={id:`${Date.now()}`,openingBase:ce,openingAir:Ce,deliveryBase:A,deliveryAir:se,netResult:st,createdAt:new Date().toISOString(),cashierName:xt,requiredDrawerNoProfit:st<0?Math.round(-st*100)/100:0};(async()=>{try{const Fe=w||s();Fe&&V&&(await Vs(De(K,"shops",Fe,"machines",V,"deliveries"),{cashierName:xt,openingBase:ce,openingAir:Ce,deliveryBase:A,deliveryAir:se,netResult:st,createdAt:ut()}),await qs(ze(K,"shops",Fe,"machines",V),{lastDeliveryAt:ut(),updatedAt:ut()},{merge:!0}))}catch(Fe){console.error("Persist delivery error:",Fe)}})(),ot(Fe=>[B,...Fe]);try{const Fe=w||s(),G=Fe&&V?`machineDaily_deliveries_${Fe}_${V}`:`machineDaily_deliveries_${V}`,Dt=localStorage.getItem(G),Ct=Dt?JSON.parse(Dt):[],jt=[B,...Array.isArray(Ct)?Ct:[]];localStorage.setItem(G,JSON.stringify(jt))}catch{}c({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${Tt(st)}`})},ea=()=>{const A=parseFloat(Se||"0"),se=parseFloat(es||"0");if(!Number.isFinite(A)||!Number.isFinite(se)){c({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if(A<0||se<0){c({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(N==null||J==null){c({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const ce=Math.round((se-A)*100)/100;ct({wholesalePrice:A,retailPrice:se,profit:ce}),Ie(!0)},gs=async A=>{if(!Ge)return;const se={id:`transfer_${Date.now()}`,wholesalePrice:Ge.wholesalePrice,retailPrice:Ge.retailPrice,profit:Ge.profit,createdAt:new Date().toISOString(),cashierName:xt,deductFrom:A},ce=Ge.wholesalePrice,Ce=N??0,Oe=J??0,$e=H??0;if(ce>(A==="base"?Ce:Oe)){c({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const B=A==="base"?Math.round((Ce-ce)*100)/100:Ce,Fe=A==="air"?Math.round((Oe-ce)*100)/100:Oe,G=Ge.retailPrice+Ge.wholesalePrice,Dt=Math.round(($e+G)*100)/100;T(B),L(Fe),te(Dt);try{const Ct=V?`${pa}_${V}`:pa,jt=V?`${ga}_${V}`:ga;localStorage.setItem(Ct,JSON.stringify({openingBase:B,openingAir:Fe,drawerCash:Dt})),localStorage.setItem(jt,JSON.stringify({openingBase:B,openingAir:Fe,drawerCash:Dt}));const Qt=w||s();if(Qt&&V){const Zt=ze(K,"shops",Qt,"machines",V);await qs(Zt,{openingBase:B,openingAir:Fe,drawerCash:Dt,cashierName:xt,updatedAt:ut()},{merge:!0}),await Vs(De(K,"shops",Qt,"machines",V,"transfers"),{wholesalePrice:Ge.wholesalePrice,retailPrice:Ge.retailPrice,profit:Ge.profit,deductFrom:A,cashierName:xt,createdAt:ut()})}}catch{}ue(Ct=>[se,...Ct]);try{const Ct=w||s(),jt=Ct&&V?`machineDaily_transfers_${Ct}_${V}`:"machineDaily_transfers",Qt=localStorage.getItem(jt),Zt=Qt?JSON.parse(Qt):[],ta=[se,...Array.isArray(Zt)?Zt:[]];localStorage.setItem(jt,JSON.stringify(ta))}catch{}re(!1),ft(""),qt(""),ct(null),Ie(!1),c({title:"تم تسجيل تحويل",description:`الربح الفوري: ${Tt(se.profit)} | خصم المخزون: -${Tt(ce)} (${A==="base"?"الأساسي":"الهواء"}) | درج: +${Tt(G)}`})},Fs=()=>{R(""),O(""),de(!1),ae(""),Be(""),Ke(null)};n.useEffect(()=>{const A=w||s();if(!(!i||!A||!V))try{const se=De(K,"shops",A,"machines",V,"transfers"),ce=Ms(se,async Ce=>{const $e=[...Ce.docs.map(st=>{var Dt,Ct;const B=st.data(),Fe=(Ct=(Dt=B==null?void 0:B.createdAt)==null?void 0:Dt.toDate)!=null&&Ct.call(Dt)?B.createdAt.toDate():new Date,G=B==null?void 0:B.deductFrom;return{id:st.id,wholesalePrice:Number((B==null?void 0:B.wholesalePrice)||0),retailPrice:Number((B==null?void 0:B.retailPrice)||0),profit:Number((B==null?void 0:B.profit)??(Number((B==null?void 0:B.retailPrice)||0)-Number((B==null?void 0:B.wholesalePrice)||0)||0)),createdAt:Fe.toISOString(),cashierName:(B==null?void 0:B.cashierName)||void 0,deductFrom:G==="base"||G==="air"?G:void 0}})].sort((st,B)=>{const Fe=new Date(st.createdAt).getTime();return new Date(B.createdAt).getTime()-Fe});if($e.length>0){ue($e),xe(!0);try{localStorage.setItem(`machineDaily_transfers_${A}_${V}`,JSON.stringify($e))}catch{}}else if(F){ue([]);try{localStorage.setItem(`machineDaily_transfers_${A}_${V}`,JSON.stringify([]))}catch{}}});return()=>{try{ce()}catch{}}}catch{}},[i,w,V,F]),n.useEffect(()=>{const A=w||s();if(!(!i||!A||!V))try{const se=De(K,"shops",A,"machines",V,"deliveries"),ce=Ms(se,Ce=>{const $e=[...Ce.docs.map(st=>{var G,Dt;const B=st.data(),Fe=(Dt=(G=B==null?void 0:B.createdAt)==null?void 0:G.toDate)!=null&&Dt.call(G)?B.createdAt.toDate():new Date;return{id:st.id,openingBase:Number((B==null?void 0:B.openingBase)||0),openingAir:Number((B==null?void 0:B.openingAir)||0),deliveryBase:Number((B==null?void 0:B.deliveryBase)||0),deliveryAir:Number((B==null?void 0:B.deliveryAir)||0),netResult:typeof(B==null?void 0:B.netResult)=="number"?Number(B.netResult):Math.round((Number((B==null?void 0:B.deliveryBase)||0)+Number((B==null?void 0:B.deliveryAir)||0)-(Number((B==null?void 0:B.openingBase)||0)+Number((B==null?void 0:B.openingAir)||0)))*100)/100,createdAt:Fe.toISOString(),cashierName:(B==null?void 0:B.cashierName)||void 0,requiredDrawerNoProfit:typeof(B==null?void 0:B.requiredDrawerNoProfit)=="number"?B.requiredDrawerNoProfit:void 0}})].sort((st,B)=>new Date(B.createdAt).getTime()-new Date(st.createdAt).getTime());if($e.length>0){ot($e),mt(!0);try{localStorage.setItem(`machineDaily_deliveries_${A}_${V}`,JSON.stringify($e))}catch{}}else if(ke){ot([]);try{localStorage.setItem(`machineDaily_deliveries_${A}_${V}`,JSON.stringify([]))}catch{}}});return()=>{try{ce()}catch{}}}catch{}},[i,w,V,ke]),n.useEffect(()=>{if(!(!i||!V))try{const A=w||s(),se=A?`machineDaily_deliveries_${A}_${V}`:`machineDaily_deliveries_${V}`,ce=localStorage.getItem(se);if(ce){const Ce=JSON.parse(ce);Array.isArray(Ce)&&Ce.length>0&&ot(Ce)}(async()=>{try{const Ce=w||s();if(!Ce)return;const Oe=De(K,"shops",Ce,"machines",V,"deliveries"),B=[...(await it(He(Oe))).docs.map(Fe=>{var Ct,jt;const G=Fe.data(),Dt=(jt=(Ct=G==null?void 0:G.createdAt)==null?void 0:Ct.toDate)!=null&&jt.call(Ct)?G.createdAt.toDate():new Date;return{id:Fe.id,openingBase:Number((G==null?void 0:G.openingBase)||0),openingAir:Number((G==null?void 0:G.openingAir)||0),deliveryBase:Number((G==null?void 0:G.deliveryBase)||0),deliveryAir:Number((G==null?void 0:G.deliveryAir)||0),netResult:typeof(G==null?void 0:G.netResult)=="number"?Number(G.netResult):Math.round((Number((G==null?void 0:G.deliveryBase)||0)+Number((G==null?void 0:G.deliveryAir)||0)-(Number((G==null?void 0:G.openingBase)||0)+Number((G==null?void 0:G.openingAir)||0)))*100)/100,createdAt:Dt.toISOString(),cashierName:(G==null?void 0:G.cashierName)||void 0,requiredDrawerNoProfit:typeof(G==null?void 0:G.requiredDrawerNoProfit)=="number"?G.requiredDrawerNoProfit:void 0}})].sort((Fe,G)=>new Date(G.createdAt).getTime()-new Date(Fe.createdAt).getTime());if(B.length>0){ot(B);try{localStorage.setItem(`machineDaily_deliveries_${Ce}_${V}`,JSON.stringify(B))}catch{}}}catch{}})()}catch{}},[i,w,V]),n.useEffect(()=>{if(!(!i||!V))try{const A=w||s(),se=A?`machineDaily_transfers_${A}_${V}`:`machineDaily_transfers_${V}`,ce=localStorage.getItem(se);if(ce){const Ce=JSON.parse(ce);Array.isArray(Ce)&&Ce.length>0&&ue(Ce)}(async()=>{try{const Ce=w||s();if(!Ce)return;const Oe=De(K,"shops",Ce,"machines",V,"transfers"),B=[...(await it(He(Oe))).docs.map(Fe=>{var jt,Qt;const G=Fe.data(),Dt=(Qt=(jt=G==null?void 0:G.createdAt)==null?void 0:jt.toDate)!=null&&Qt.call(jt)?G.createdAt.toDate():new Date,Ct=G==null?void 0:G.deductFrom;return{id:Fe.id,wholesalePrice:Number((G==null?void 0:G.wholesalePrice)||0),retailPrice:Number((G==null?void 0:G.retailPrice)||0),profit:Number((G==null?void 0:G.profit)??(Number((G==null?void 0:G.retailPrice)||0)-Number((G==null?void 0:G.wholesalePrice)||0)||0)),createdAt:Dt.toISOString(),cashierName:(G==null?void 0:G.cashierName)||void 0,deductFrom:Ct==="base"||Ct==="air"?Ct:void 0}})].sort((Fe,G)=>new Date(G.createdAt).getTime()-new Date(Fe.createdAt).getTime());if(B.length>0){ue(B);try{localStorage.setItem(`machineDaily_transfers_${Ce}_${V}`,JSON.stringify(B))}catch{}}}catch{}})()}catch{}},[i,w,V]);const Ys=A=>{A||Fs(),u(A)};return e.jsxs(pe,{open:i,onOpenChange:Ys,children:[e.jsxs(ge,{className:"w-screen h-[100vh] overflow-hidden rounded-none p-0 flex flex-col dark:bg-[#121212]",children:[e.jsxs(fe,{className:"sticky top-0 bg-white dark:bg-[#0F0F0F] z-20 border-b border-gray-200 dark:border-[#333] px-4 py-3",children:[e.jsx(ye,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(fc,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(ds,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"px-4 py-3 overflow-y-auto flex-1 grid grid-cols-1 gap-6",children:[e.jsxs(Pt,{children:[e.jsx(ls,{className:"pb-2",children:e.jsxs(Ss,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"اختيار ماكينة"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{variant:"destructive",onClick:async()=>{try{if(!w||!V)return;const A=ze(K,"shops",w,"machines",V);try{const ce=await it(De(K,"shops",w,"machines",V,"transfers"));await Promise.all(ce.docs.map(Ce=>js(Ce.ref)))}catch{}try{const ce=await it(De(K,"shops",w,"machines",V,"deliveries"));await Promise.all(ce.docs.map(Ce=>js(Ce.ref)))}catch{}await js(A),dt(ce=>ce.filter(Ce=>Ce.id!==V));const se=ve.find(ce=>ce.id!==V);yt(se?se.id:null);try{const ce=`${pa}_${V}`,Ce=`${ga}_${V}`;localStorage.removeItem(ce),localStorage.removeItem(Ce)}catch{}c({title:"تم حذف الماكينة",description:"تمت الإزالة نهائيًا."})}catch{c({title:"فشل الحذف",description:"تعذر حذف الماكينة.",variant:"destructive"})}},disabled:!V,title:"حذف الماكينة",children:e.jsx(is,{className:"h-4 w-4"})})})]})}),e.jsx(Lt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الماكينة الحالية"}),e.jsxs(Ta,{value:V??"",onValueChange:A=>{yt(A);try{const se=w||s();se&&localStorage.setItem(`machineDaily_selected_${se}`,A)}catch{}},children:[e.jsx(Pa,{className:"text-right",children:e.jsx(ka,{placeholder:"اختر ماكينة"})}),e.jsx(_a,{children:ve.map(A=>e.jsx(Zs,{value:A.id,children:A.name},A.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"إنشاء ماكينة جديدة"}),e.jsx(U,{value:vt,onChange:A=>wt(A.target.value),placeholder:"اسم الماكينة",className:"text-right"})]}),e.jsx("div",{className:"flex justify-end md:justify-start",children:e.jsx(h,{onClick:async()=>{try{if(!w){c({title:"لا يوجد محل",description:"يرجى التأكد من تحميل بيانات المحل.",variant:"destructive"});return}const A=(vt||"").trim();if(!A){c({title:"اسم الماكينة مطلوب",description:"أدخل اسم للماكينة الجديدة.",variant:"destructive"});return}const se=await Vs(De(K,"shops",w,"machines"),{name:A,shopId:w,createdAt:ut(),updatedAt:ut(),isActive:!0}),ce={id:se.id,name:A};dt(Ce=>[ce,...Ce]),yt(se.id),wt(""),c({title:"تم إنشاء ماكينة",description:`تمت إضافة ${A}`})}catch(A){console.error("Create machine error:",A),c({title:"خطأ في الإنشاء",description:"تعذر إنشاء الماكينة.",variant:"destructive"})}},className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})})]})]})})]}),e.jsxs(Pt,{children:[e.jsx(ls,{className:"pb-2",children:e.jsxs(Ss,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>he(A=>!A),className:"flex items-center gap-1",children:e.jsx(Br,{className:`h-4 w-4 transition-transform ${W?"rotate-180":""}`})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{variant:"outline",onClick:()=>re(!0),disabled:N==null||J==null,className:"border-violet-300 text-violet-700",children:"تحويل"})}),N!=null&&J!=null&&e.jsxs(Kt,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",Tt(N)," | هواء ",Tt(J)," | درج ",Tt(H??0)]})]}),e.jsxs(Lt,{className:`space-y-4 ${W?"":"hidden"}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:j,onChange:A=>R(A.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:D,onChange:A=>O(A.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:k,onChange:A=>g(A.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(h,{variant:"outline",className:"mr-2",onClick:At,children:"تصفير"}),e.jsx(h,{onClick:Ht,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),e.jsxs(Pt,{children:[e.jsx(ls,{className:"pb-2",children:e.jsxs(Ss,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات تحويل"}),e.jsxs(Kt,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",Tt(kt)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:Nt,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(Bn,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Lt,{className:"space-y-3",children:ee.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-3 max-h-52 overflow-y-auto pr-1",children:ee.map(A=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر الجملة"}),e.jsx("p",{className:"text-sm",children:Tt(A.wholesalePrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر التجزئة"}),e.jsx("p",{className:"text-sm",children:Tt(A.retailPrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الربح الفوري"}),e.jsx("p",{className:"text-sm text-green-700",children:Tt(A.profit)}),A.deductFrom&&e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"text-[11px] bg-violet-100 text-violet-700 border border-violet-200 rounded px-2 py-0.5",children:["الخصم من: ",A.deductFrom==="base"?"الأساسي":"الهواء"]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(Ea,{className:"h-3 w-3"}),e.jsx("span",{children:Zo(A.createdAt)}),A.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(sl,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",A.cashierName]})]})]})]})]},A.id))})})]}),e.jsxs(Pt,{children:[e.jsx(ls,{className:"pb-2",children:e.jsx(Ss,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(Lt,{className:"space-y-4",children:be?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:oe,onChange:A=>ae(A.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Me,onChange:A=>Be(A.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"secondary",onClick:()=>de(!1),children:"إلغاء"}),e.jsx(h,{onClick:Js,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),Pe!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(Kt,{className:Pe>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",Tt(Pe)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(Kt,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",Tt(parseFloat(oe||"0")+parseFloat(Me||"0"))]}),e.jsxs(Kt,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",Tt(_t)]})]})]})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{variant:"outline",onClick:Gt,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs(Pt,{children:[e.jsx(ls,{className:"pb-2",children:e.jsxs(Ss,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:et,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(Bn,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Lt,{className:"space-y-3",children:qe.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:qe.map(A=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Tt(A.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Tt(A.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Tt(A.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Tt(A.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>Ot(A.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(is,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${A.netResult>=0?"text-green-700":"text-red-700"}`,children:Tt(A.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",Tt(A.deliveryBase+A.deliveryAir)]}),typeof A.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",Tt(A.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(Ea,{className:"h-3 w-3"}),e.jsx("span",{children:Zo(A.createdAt)}),A.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(sl,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",A.cashierName]})]})]})]})]},A.id))})})]})]}),e.jsxs(nt,{className:"sticky bottom-0 bg-white dark:bg-[#0F0F0F] z-20 border-t border-gray-200 dark:border-[#333] px-4 py-3 flex items-center justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>Ys(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(ba,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(pe,{open:tt,onOpenChange:re,children:e.jsxs(ge,{className:"sm:max-w-sm",children:[e.jsx(fe,{children:e.jsx(ye,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Se,onChange:A=>ft(A.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:es,onChange:A=>qt(A.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(Kt,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",Tt(parseFloat(es||"0")-parseFloat(Se||"0")||0)]})})]}),e.jsxs(nt,{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"secondary",onClick:()=>re(!1),children:"إلغاء"}),e.jsx(h,{onClick:ea,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(mu,{open:Yt,onOpenChange:Ie,children:e.jsxs(Lc,{children:[e.jsxs(Wc,{children:[e.jsx(Fc,{children:"اختيار مصدر الخصم"}),e.jsx(Rc,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(Bc,{onClick:()=>Ie(!1),children:"رجوع"}),e.jsx(rl,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>gs("base"),children:"خصم من الأساسي"}),e.jsx(rl,{className:"bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>gs("air"),children:"خصم من الهواء"})]})]})})]})}function xu(i,u=300){const[c,y]=Ve.useState(i);return Ve.useEffect(()=>{const w=setTimeout(()=>y(i),u);return()=>clearTimeout(w)},[i,u]),c}const pu=({userId:i,transactions:u})=>{const[c,y]=n.useState(!1),[w,C]=n.useState(!1),[s,j]=n.useState(!1),[R,D]=n.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:O}=la();n.useEffect(()=>{i&&c&&s&&k()},[i,c,s]);const k=async()=>{if(i)try{if(Array.isArray(u)&&u.length>0){const H=new Date,te=H.getMonth(),ie=H.getFullYear(),M=us.filterVisibleTransactions(u,"monthly",i);let W=0,he=0;M.forEach(be=>{const de=new Date(be.createdAt),oe=String(be.status||"confirmed").toLowerCase();if(de.getMonth()!==te||de.getFullYear()!==ie||oe!=="completed"&&oe!=="confirmed")return;const ae=(be.type||be.txnType||"").toLowerCase(),Me={type:ae==="withdrawal"?"withdraw":ae,amount:Number(be.amount||0),commission:be.commission};Me.type==="withdraw"?W+=Oa.calculateProfitFromTransaction(Me):(Me.type==="send"||Me.type==="receive"||Me.type==="transfer")&&(he+=Oa.calculateProfitFromTransaction(Me))}),D({monthlyWithdrawalProfit:Math.round(W*100)/100,monthlyTransferProfit:Math.round(he*100)/100,lastUpdated:new Date});return}const L=Oa.getWithdrawTransferProfits(i);D({monthlyWithdrawalProfit:L.monthlyWithdrawProfit||0,monthlyTransferProfit:L.monthlyTransferProfit||0,lastUpdated:new Date})}catch(L){console.error("Error loading profit data:",L)}},g=L=>`${L.toFixed(2)} ج.م`,N=async()=>{try{const L=(O==null?void 0:O.subscription)||null,H=(L==null?void 0:L.planType)??(L==null?void 0:L.plan)??null,te=typeof H=="string"?H.toLowerCase():null;if(H===ws.ZERO||te==="zero"||te==="0"||H===0)return!0}catch{}try{if(i){const L=await nl(i),H=(L==null?void 0:L.planType)??(L==null?void 0:L.plan)??null,te=typeof H=="string"?H.toLowerCase():null;if(H===ws.ZERO||te==="zero"||te==="0"||H===0)return!0}}catch{}return!1},T=async()=>{try{if(await N()){Fo({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}C(!0)},J=async()=>{try{if(await N()){Fo({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),C(!1);return}}catch{}j(!0),y(!0),C(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:T,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح الشهرية",children:e.jsx(Wt,{className:"h-1.5 w-1.5"})}),e.jsx(pe,{open:c,onOpenChange:y,children:e.jsxs(ge,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(fe,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:e.jsxs(ye,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(Ea,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"شهري"]})}),e.jsx("div",{className:"py-0 sm:py-3",children:e.jsxs("div",{className:"rounded-xl border border-purple-300 bg-white overflow-hidden",children:[e.jsx("div",{className:"p-2 sm:p-3 bg-red-50 border-b border-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(qn,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800 text-xs",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-2 py-0.5 rounded",children:g(R.monthlyWithdrawalProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-blue-50 border-b border-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(il,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-blue-900 bg-white px-2 py-0.5 rounded",children:g(R.monthlyTransferProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(zt,{className:"h-3 w-3 text-purple-600"}),e.jsx("span",{className:"font-medium text-purple-800 text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"font-bold text-sm text-purple-900 bg-white px-2 py-0.5 rounded",children:g(R.monthlyWithdrawalProfit+R.monthlyTransferProfit)})]})})]})}),!s&&e.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>C(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:e.jsx(Wt,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:e.jsx(h,{onClick:()=>y(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),e.jsx(ms,{open:w,onOpenChange:C,onSuccess:J,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},gu=i=>e.jsx(pu,{...i});function fu({open:i,onOpenChange:u,onSuccess:c,userId:y}){const[w,C]=n.useState(""),[s,j]=n.useState(""),[R,D]=n.useState(!1),[O,k]=n.useState(!1),[g,N]=n.useState(""),[T,J]=n.useState(!1),[L,H]=n.useState(!1),{toast:te}=Ks();n.useEffect(()=>{let W=!0;return(async()=>{const he=await ps.hasMasterPin(y);W&&H(he)})(),()=>{W=!1}},[y,i]);const ie=()=>{C(""),j(""),N(""),D(!1),k(!1),u(!1)},M=async W=>{W.preventDefault(),N(""),J(!0);try{if(L){if(!await ps.verifyMasterPin(w,y)){N("الرقم السري غير صحيح"),J(!1);return}}else{if(w.length<4){N("يجب أن يكون الرقم السري 4 أرقام على الأقل"),J(!1);return}if(w!==s){N("الرقم السري غير متطابق"),J(!1);return}if(!await ps.createMasterPin(w,y)){N("تعذر إنشاء الرقم السري الرئيسي"),J(!1);return}}te({title:"نجح العملية",description:L?"تم التحقق من الرقم السري الرئيسي بنجاح":"تم إنشاء الرقم السري الرئيسي بنجاح"}),c(),ie()}catch{N("حدث خطأ أثناء معالجة الرقم السري")}finally{J(!1)}};return e.jsx(pe,{open:i,onOpenChange:u,children:e.jsxs(ge,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(fe,{children:e.jsxs(ye,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(Ja,{className:"h-5 w-5 text-green-600"}),L?"أدخل الرقم السري الرئيسي":"إنشاء الرقم السري الرئيسي"]})}),e.jsxs("form",{onSubmit:M,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:L?"أدخل الرقم السري الرئيسي لعرض بيانات الأرباح":"قم بإنشاء الرقم السري الرئيسي لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"pin",children:L?"الرقم السري الرئيسي":"الرقم السري الرئيسي الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"pin",type:R?"text":"password",value:w,onChange:W=>C(W.target.value),placeholder:L?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>D(!R),children:R?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),!L&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:O?"text":"password",value:s,onChange:W=>j(W.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>k(!O),children:O?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),g&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ha,{className:"h-4 w-4"}),g]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:T,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Ja,{className:"h-4 w-4 mr-2"}),T?"جاري المعالجة...":L?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(h,{type:"button",variant:"outline",onClick:ie,disabled:T,children:"إلغاء"})]})]})]})})}const yu=({userId:i,transactions:u})=>{const[c,y]=n.useState(!1),[w,C]=n.useState(!1),[s,j]=n.useState(!1),[R,D]=n.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});n.useEffect(()=>{i&&c&&s&&O()},[i,c,s,u]);const O=async()=>{if(i)try{if(Array.isArray(u)&&u.length>0){const J=new Date,L=us.filterVisibleTransactions(u,"daily",i);let H=0,te=0;L.forEach(ie=>{const M=new Date(ie.createdAt),W=String(ie.status||"confirmed").toLowerCase();if(M.toDateString()!==J.toDateString()||W!=="completed"&&W!=="confirmed")return;const he=(ie.type||ie.txnType||"").toLowerCase(),be=String(ie.title||"");if(he==="cash_addition"||be.includes("إيصال إضافة نقدية"))return;const de={type:he==="withdrawal"?"withdraw":he,amount:Number(ie.amount||0),commission:ie.commission};de.type==="withdraw"?H+=Oa.calculateProfitFromTransaction(de):(de.type==="send"||de.type==="receive"||de.type==="transfer")&&(te+=Oa.calculateProfitFromTransaction(de))}),D({dailyWithdrawalProfit:Math.round(H*100)/100,dailyTransferProfit:Math.round(te*100)/100,lastUpdated:new Date});try{Oa.updateProfitsFromTransactions(u,i)}catch{}return}const T=Oa.getWithdrawTransferProfits(i);D({dailyWithdrawalProfit:T.dailyWithdrawProfit||0,dailyTransferProfit:T.dailyTransferProfit||0,lastUpdated:new Date})}catch(T){console.error("Error loading profit data:",T)}},k=T=>`${T.toFixed(2)} ج.م`,g=()=>{Oa.hasProfitPin(i),C(!0)},N=()=>{j(!0),y(!0),C(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:g,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح اليومية",children:e.jsx(Wt,{className:"h-1.5 w-1.5"})}),e.jsx(pe,{open:c,onOpenChange:y,children:e.jsxs(ge,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-blue-50 sm:to-white sm:border-2 sm:border-blue-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(fe,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-blue-200",children:e.jsxs(ye,{className:"text-xs font-bold text-blue-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-sm sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(zt,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),"يومي"]})}),e.jsx("div",{className:"py-0 sm:py-3",children:e.jsxs("div",{className:"rounded-xl border border-blue-300 bg-white overflow-hidden",children:[e.jsx("div",{className:"p-2 sm:p-3 bg-red-50 border-b border-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(qn,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800 text-xs",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-2 py-0.5 rounded",children:k(R.dailyWithdrawalProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-green-50 border-b border-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(il,{className:"h-3 w-3 text-green-600"}),e.jsx("span",{className:"font-medium text-green-800 text-xs",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-green-900 bg-white px-2 py-0.5 rounded",children:k(R.dailyTransferProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-blue-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(zt,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"font-bold text-sm text-blue-900 bg-white px-2 py-0.5 rounded",children:k(R.dailyWithdrawalProfit+R.dailyTransferProfit)})]})})]})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-blue-200",children:e.jsx(h,{onClick:()=>y(!1),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-blue-600 sm:to-blue-700 sm:hover:from-blue-700 sm:hover:to-blue-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300 sm:text-xs",children:"إغلاق"})})]})}),e.jsx(fu,{open:w,onOpenChange:C,onSuccess:N,userId:i})]})},bu=i=>e.jsx(yu,{...i}),vu=({open:i,onOpenChange:u})=>{var sa;const{shiftUser:c,isShiftActive:y,shiftStartAt:w,setShiftUser:C,startShift:s,endShift:j}=qr(),{userSubscription:R,user:D,signIn:O,profile:k}=la(),{toast:g}=Ks(),[N,T]=n.useState((c==null?void 0:c.name)||""),[J,L]=n.useState((c==null?void 0:c.username)||""),[H,te]=n.useState(""),[ie,M]=n.useState(!1),[W,he]=n.useState(null),[be,de]=n.useState(""),[oe,ae]=n.useState(""),[Me,Be]=n.useState(!1),[Pe,Ke]=n.useState(null),[qe,ot]=n.useState(""),[ee,ue]=n.useState(""),[tt,re]=n.useState(!1),[Se,ft]=n.useState(!1),[es,qt]=n.useState({totalTransfers:0,totalWithdrawals:0}),[Yt,Ie]=n.useState(null),[Ge,ct]=n.useState(""),[ve,dt]=n.useState(""),[V,yt]=n.useState(0),[vt,wt]=n.useState({}),[F,xe]=n.useState(0),[ke,mt]=n.useState(0),[xt,kt]=n.useState({}),[_t,Nt]=n.useState(""),[et,Ot]=n.useState(!1),At=()=>`cashierUsers_${(D==null?void 0:D.uid)||"default"}`,[Ht,Gt]=n.useState(()=>{try{let z=localStorage.getItem(At());if(!z){const we=localStorage.getItem("cashierUsers");we&&(z=we)}return z?JSON.parse(z):[]}catch{return[]}});n.useEffect(()=>{(async()=>{try{if(!(D!=null&&D.uid))return;const z=ze(K,"profiles",D.uid,"cashierUsers","list"),we=await fa(z);if(we.exists()){const St=we.data(),lt=Array.isArray(St==null?void 0:St.users)?St.users:[];lt&&lt.length>0&&Gt(lt)}}catch{}})()},[D==null?void 0:D.uid]),n.useEffect(()=>{if(!(D!=null&&D.uid))return;const z=ze(K,"profiles",D.uid,"cashierUsers","list"),we=Ms(z,St=>{try{if(St.exists()){const lt=St.data(),Jt=Array.isArray(lt==null?void 0:lt.users)?lt.users:[];if(Jt&&Jt.length>0)Gt(Jt);else try{const os=localStorage.getItem(At()),Bt=os?JSON.parse(os):[];Gt(Bt)}catch{Gt([])}}}catch{}},St=>{console.warn("cashierUsers realtime subscription error:",St)});return()=>we()},[D==null?void 0:D.uid]);const Js=(sa=R==null?void 0:R.subscription)==null?void 0:sa.planType,ea=Js==="yearly"?2:Js==="lifetime"?4:Number.POSITIVE_INFINITY;n.useEffect(()=>{try{localStorage.setItem(At(),JSON.stringify(Ht));try{localStorage.removeItem("cashierUsers")}catch{}}catch{}(async()=>{try{if(!(D!=null&&D.uid))return;const z=ze(K,"profiles",D.uid,"cashierUsers","list");await qs(z,{users:Ht},{merge:!0})}catch{}})()},[Ht]);const[gs,Fs]=n.useState(!1),[Ys,A]=n.useState(""),[se,ce]=n.useState(null),[Ce,Oe]=n.useState([]),[$e,st]=n.useState(!1),[B,Fe]=n.useState(null),[G,Dt]=n.useState(!1),[Ct,jt]=n.useState(!1),Qt=z=>{const we=(c==null?void 0:c.username)===z;let St=!1;try{St=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(we&&!(we&&!y&&(_t==="الأدمن الرئيسي"||St))){g({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const os=`هل أنت متأكد من حذف المستخدم ${z}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(os)&&(Gt(Bt=>Bt.filter(Na=>Na.username!==z)),we&&C(null),g({title:"تم حذف المستخدم",description:z}))},Zt=()=>{if(!N.trim()||!J.trim()||!H.trim())return;if(Ht.length>=ea){g({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(ea)?ea:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const z={name:N.trim(),username:J.trim(),password:H.trim()};Gt(we=>[z,...we]),T(""),L(""),te("")},ta=()=>{M(!0),he(null),Ke(null),ot(""),ue("")},wa=async()=>{try{let z=[];try{D!=null&&D.uid&&(z=await Te.getUserTransactions(D.uid))}catch{}if(!z||z.length===0)try{const Qe=await gc({merchantUserId:D==null?void 0:D.uid,limit:200});z=(Qe==null?void 0:Qe.transactions)||[]}catch{}const we=w?new Date(w):null,St=new Date,lt=Qe=>{const Et=Qe.type,Rs=Qe.txnType;return Et==="withdraw"||Et==="withdrawal"||Et==="receive"||Rs==="receive"},Jt=Qe=>{const Et=Qe.type,Rs=Qe.txnType;return Et==="send"||Et==="transfer"||Rs==="send"},os=Qe=>{if(!Qe)return null;if(Qe instanceof Date)return Qe;try{const Et=new Date(Qe);return Number.isNaN(Et.getTime())?null:Et}catch{return null}},Bt=Qe=>{const Et=os(Qe.createdAt||Qe.created_at||Qe.timestamp);return!Et||we&&Et<we?!1:Et<=St},Na=Qe=>Qe==="completed"||Qe==="confirmed",Ga=z.filter(Qe=>Na(Qe.status)&&Bt(Qe)),$a=Ga.filter(Qe=>lt(Qe)).reduce((Qe,Et)=>{const Rs=Et.withdrawnAmount??Et.receivedAmount??Et.amount??0;return Qe+(Number(Rs)||0)},0);return{totalTransfers:Ga.filter(Qe=>Jt(Qe)).reduce((Qe,Et)=>{const Rs=Et.sentAmount??Et.transferredAmount??Et.amount??0;return Qe+(Number(Rs)||0)},0),totalWithdrawals:$a}}catch{return{totalTransfers:0,totalWithdrawals:0}}};n.useEffect(()=>{if(Se){try{const z=localStorage.getItem("shiftInitialReceivedDrawerFunds");z!==null&&dt(z)}catch{}try{const z=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(z!==null){const we=parseFloat(z);yt(Number.isFinite(we)?we:0)}}catch{}}},[Se]),n.useEffect(()=>{if(!i&&!$e)return;(async()=>{try{const St=((D!=null&&D.uid?await Te.getUserTransactions(D.uid):[])||[]).filter(lt=>(lt==null?void 0:lt.type)==="report"||((lt==null?void 0:lt.title)||"").includes("إيصال تسليم وردية"));St.sort((lt,Jt)=>{const os=new Date(lt.createdAt||0).getTime();return new Date(Jt.createdAt||0).getTime()-os}),Oe(St)}catch{Oe([])}})()},[i,Se,$e,D==null?void 0:D.uid]);const oa=async(z,we,St)=>{try{let lt=0,Jt=0;try{const Bt=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");lt=Number.isFinite(Bt)?Bt:0}catch{}try{const Bt=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");Jt=Number.isFinite(Bt)?Bt:0}catch{}const os={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(c==null?void 0:c.username)||"cashier",receiverPhone:_t||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(c==null?void 0:c.name)||(c==null?void 0:c.username)||null,deficit:we,deficitAmount:we?St:0,shiftStartAt:w,receivedDrawerFunds:lt,receivedWalletBalancesTotal:Jt,receivedWalletBalances:vt,deliveredDrawerFunds:F||0,deliveredWalletBalancesTotal:ke||0,deliveredWalletBalances:xt,shiftProfit:Math.round(((F||0)+(ke||0)-(lt+Jt))*100)/100};D!=null&&D.uid&&await Te.saveUserTransaction(D.uid,os),Oe(Bt=>[os,...Bt||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(pe,{open:i,onOpenChange:u,children:e.jsxs(ge,{className:"sm:max-w-md",children:[e.jsx(fe,{children:e.jsx(ye,{children:y?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),y?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[c==null?void 0:c.name," (",c==null?void 0:c.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),Ht.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:Ht.map((z,we)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:z.name}),e.jsx("div",{className:"text-xs text-gray-500",children:z.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(h,{size:"sm",className:"w-full sm:w-auto",onClick:()=>{ce(z),Fs(!0)},children:"دخول"}),e.jsx(h,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>Qt(z.username),children:"حذف"})]})]},we))})]})]}),e.jsx(nt,{className:"flex flex-wrap gap-2 justify-between",children:y?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(h,{className:"w-full sm:w-auto",variant:"destructive",onClick:ta,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(h,{className:"w-full sm:w-auto",onClick:()=>jt(!0),children:"إضافة مستخدم جديد"}),e.jsx(h,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>st(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(pe,{open:Ct,onOpenChange:jt,children:e.jsxs(ge,{className:"sm:max-w-md",children:[e.jsx(fe,{children:e.jsx(ye,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Q,{className:"mb-1 block",children:"الاسم"}),e.jsx(U,{value:N,onChange:z=>T(z.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(Q,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(U,{value:J,onChange:z=>L(z.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(Q,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(U,{type:"password",autoComplete:"new-password",value:H,onChange:z=>te(z.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(nt,{className:"flex gap-2 justify-between",children:[e.jsx(h,{variant:"secondary",onClick:()=>{jt(!1)},children:"إلغاء"}),e.jsx(h,{onClick:()=>{!N.trim()||!J.trim()||!H.trim()||(Zt(),jt(!1))},children:"حفظ المستخدم"})]})]})}),e.jsx(pe,{open:$e,onOpenChange:st,children:e.jsxs(ge,{className:"sm:max-w-lg",children:[e.jsx(fe,{children:e.jsx(ye,{children:"إيصالات التسليم"})}),Ce.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:Ce.map(z=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{Fe(z),Dt(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(z.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",z.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",z.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",z.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",z.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",z.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",z.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",z.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",z.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",z.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(z.shiftProfit??(z.deliveredDrawerFunds??0)+(z.deliveredWalletBalancesTotal??0)-(z.receivedDrawerFunds??0)-(z.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",z.shiftProfit??(z.deliveredDrawerFunds??0)+(z.deliveredWalletBalancesTotal??0)-(z.receivedDrawerFunds??0)-(z.receivedWalletBalancesTotal??0)]})]}),z.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",z.deficitAmount??0]})]},z.id))}),e.jsx(nt,{className:"flex gap-2 justify-between",children:e.jsx(h,{variant:"secondary",onClick:()=>st(!1),children:"إغلاق"})})]})}),e.jsx(pe,{open:G,onOpenChange:Dt,children:e.jsxs(ge,{className:"sm:max-w-md",children:[e.jsx(fe,{children:e.jsx(ye,{children:"إيصال تسليم وردية"})}),B?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(B.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",B.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",B.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",B.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",B.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",B.deliveredWalletBalancesTotal??0]})]})]}),B.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",B.deficitAmount??0]})]}),B.receivedWalletBalances&&Object.keys(B.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(B.receivedWalletBalances).map(([z,we])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:z}),e.jsx("span",{className:"font-semibold",children:we})]},z))})]}),B.deliveredWalletBalances&&Object.keys(B.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(B.deliveredWalletBalances).map(([z,we])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:z}),e.jsx("span",{className:"font-semibold",children:we})]},z))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(nt,{className:"flex gap-2 justify-between",children:e.jsx(h,{variant:"secondary",onClick:()=>Dt(!1),children:"إغلاق"})})]})}),e.jsx(pe,{open:gs,onOpenChange:Fs,children:e.jsxs(ge,{className:"sm:max-w-md",children:[e.jsx(fe,{children:e.jsx(ye,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:se?`${se.name} (${se.username})`:""}),e.jsx(U,{type:"password",autoComplete:"off",value:Ys,onChange:z=>A(z.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(nt,{className:"flex gap-2 justify-between",children:[e.jsx(h,{variant:"secondary",onClick:()=>{A(""),ce(null),Fs(!1)},children:"إلغاء"}),e.jsx(h,{onClick:()=>{if(se){if(Ys.trim()!==se.password){g({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}C({name:se.name,username:se.username}),A(""),Fs(!1),u(!1),s(),Ot(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(pe,{open:et,onOpenChange:Ot,children:e.jsxs(ge,{className:"sm:max-w-md",children:[e.jsx(fe,{children:e.jsx(ye,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Q,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(U,{type:"number",value:ve,onChange:z=>dt(z.target.value),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Q,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(U,{type:"number",value:Number.isFinite(V)?V:0,onChange:z=>{const we=parseFloat(z.target.value);yt(Number.isFinite(we)?we:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(nt,{className:"flex gap-2 justify-between",children:e.jsx(h,{onClick:()=>{const z=parseFloat(ve),we=V,St=Number.isFinite(z)&&z>=0,lt=Number.isFinite(we)&&we>=0;if(!St||!lt){g({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(z)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(we))}catch{}g({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),Ot(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(pe,{open:ie,onOpenChange:z=>{z&&M(!0)},children:e.jsxs(ge,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(fe,{children:e.jsx(ye,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:W==="toUser"?"default":"secondary",onClick:()=>he("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(h,{variant:W==="toAdmin"?"default":"secondary",onClick:()=>he("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),W==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[Ht.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:Ht.map((z,we)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(Pe==null?void 0:Pe.username)===z.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>Ke(z),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:z.name}),e.jsx("div",{className:"text-xs text-gray-500",children:z.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},we))})]}),e.jsxs("div",{children:[e.jsx(Q,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(U,{type:"password",autoComplete:"off",value:qe,onChange:z=>ot(z.target.value),placeholder:"أدخل كلمة السر"})]}),ee&&e.jsx("div",{className:"text-xs text-red-600",children:ee})]}),W==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(U,{type:"password",autoComplete:"off",value:be,onChange:z=>de(z.target.value),placeholder:"كلمة المرور"}),oe&&e.jsx("div",{className:"text-xs text-red-600",children:oe})]})]}),e.jsx(nt,{className:"flex gap-2 justify-between",children:e.jsx(h,{disabled:tt||!W,onClick:async()=>{if(W){re(!0);try{const z=await wa();if(W==="toUser"){if(!Pe){ue("يرجى اختيار المستخدم أولاً"),re(!1);return}if(qe.trim()!==Pe.password){ue("كلمة السر غير صحيحة"),re(!1);return}j(),C({name:Pe.name,username:Pe.username}),s(),Nt(`${Pe.name} (${Pe.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}M(!1),he(null),Ke(null),ot(""),ue(""),u(!1),qt(z),Ie(null),ct(""),ft(!0)}else if(W==="toAdmin"){ae("");const we=(D==null?void 0:D.email)||"";if(!we){ae("لا يوجد بريد للمستخدم الرئيسي للتحقق"),re(!1);return}const{error:St}=await O(we,be);if(St){ae("كلمة المرور غير صحيحة"),re(!1);return}j(),C(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}de(""),M(!1),u(!1),Nt("الأدمن الرئيسي"),qt(z),Ie(null),ct(""),ft(!0)}}catch{ue("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{re(!1)}}},children:"تأكيد التسليم"})})]})}),e.jsx(pe,{open:Se,onOpenChange:ft,children:e.jsxs(ge,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(fe,{children:e.jsx(ye,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:_t})]}),w&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(w).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Q,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(U,{type:"number",value:ve,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Q,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(U,{type:"number",value:V,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Q,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(U,{type:"number",value:F,onChange:z=>{const we=parseFloat(z.target.value);xe(Number.isFinite(we)?we:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Q,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(U,{type:"number",value:ke,onChange:z=>{const we=parseFloat(z.target.value);mt(Number.isFinite(we)?we:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(F??0)+(ke??0)-((parseFloat(ve||"0")||0)+(V??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((F??0)+(ke??0)-((parseFloat(ve||"0")||0)+(V??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:Yt==="no"?"default":"secondary",onClick:()=>Ie("no"),children:"لا"}),e.jsx(h,{variant:Yt==="yes"?"default":"secondary",onClick:()=>Ie("yes"),children:"نعم"})]}),Yt==="yes"&&e.jsxs("div",{children:[e.jsx(Q,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(U,{type:"number",value:Ge,onChange:z=>ct(z.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(nt,{className:"flex gap-2 justify-between",children:e.jsx(h,{onClick:()=>{const z=Yt==="yes",we=parseFloat(Ge)||0;(async()=>await oa(es,z,we))(),g({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),ft(!1)},children:"تأكيد وحفظ الإيصال"})})]})})]})},wu=({open:i,onOpenChange:u})=>{const{shiftUser:c,endShift:y,setShiftUser:w}=qr(),[C,s]=n.useState(""),[j,R]=n.useState(""),[D,O]=n.useState([]),{user:k}=la();n.useEffect(()=>{(async()=>{try{if(k!=null&&k.uid){const N=ze(K,"profiles",k.uid,"cashierUsers","list"),T=await fa(N);if(T.exists()){const J=T.data(),L=Array.isArray(J==null?void 0:J.users)?J.users:[];if(L&&L.length>0){O(L);return}}}}catch{}try{const N=`cashierUsers_${(k==null?void 0:k.uid)||"default"}`;let T=localStorage.getItem(N);if(!T){const J=localStorage.getItem("cashierUsers");J&&(T=J)}O(T?JSON.parse(T):[])}catch{O([])}})()},[i,k==null?void 0:k.uid]),n.useEffect(()=>{if(!i||!(k!=null&&k.uid))return;const N=ze(K,"profiles",k.uid,"cashierUsers","list"),T=Ms(N,J=>{if(J.exists()){const L=J.data(),H=Array.isArray(L==null?void 0:L.users)?L.users:[];if(H&&H.length>0)O(H);else try{const te=`cashierUsers_${(k==null?void 0:k.uid)||"default"}`;let ie=localStorage.getItem(te);if(!ie){const M=localStorage.getItem("cashierUsers");M&&(ie=M)}O(ie?JSON.parse(ie):[])}catch{O([])}}},J=>{console.warn("ShiftProfileDialog cashierUsers snapshot error:",J)});return()=>T()},[i,k==null?void 0:k.uid]);const g=async()=>{if(R(""),!c)return;const N=D.find(T=>T.username===c.username);if(!N){R("لا يوجد مستخدم مطابق لهذه الوردية");return}if(C.trim()!==N.password){R("الرقم السري غير صحيح");return}y(),w(null),s(""),u(!1)};return e.jsx(pe,{open:i,onOpenChange:N=>{s(""),R(""),u(N)},children:e.jsxs(ge,{className:"sm:max-w-md",children:[e.jsx(fe,{children:e.jsx(ye,{children:"بروفيل الوردية"})}),c?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:c.name}),e.jsx("div",{className:"text-xs text-gray-600",children:c.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx(U,{type:"password",value:C,onChange:N=>s(N.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),j&&e.jsx("div",{className:"text-red-600 text-xs",children:j})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(nt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>u(!1),children:"إغلاق"}),e.jsx(h,{onClick:g,disabled:!c,children:"تسليم الوردية"})]})]})})},Nu=({open:i,onOpenChange:u})=>e.jsx(pe,{open:i,onOpenChange:u,children:e.jsxs(ge,{className:"sm:max-w-lg rounded-2xl",children:[e.jsxs(fe,{children:[e.jsxs(ye,{className:"text-right flex items-center gap-2 justify-end",children:[e.jsx(Qi,{className:"w-5 h-5"}),"سجل التغييرات الأخيرة"]}),e.jsx(ds,{className:"text-right",children:"هذه أبرز التحسينات التي تمت مؤخرًا في الواجهة."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(cc,{className:"w-5 h-5 text-amber-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحسين نافذة تعديل المديونية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"استبدال نافذة الإدخال القديمة (prompt) بحوار أنيق لإدخال المبلغ مع تأكيد."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ch,{className:"w-5 h-5 text-violet-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحديث شاشة التحميل"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:'تغيير النص إلى "صلي علي النبي" مع خط عربي جميل ونبض لطيف.'})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Qi,{className:"w-5 h-5 text-green-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"بطاقات الأرباح وعدد العمليات"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"إضافة بطاقات عرض أرباح الفترة الحالية وعدد العمليات في تفاصيل المحفظة."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Qi,{className:"w-5 h-5 text-blue-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"إصلاح تمرير نافذة اليومية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"منع تمرير الصفحة الخلفية عند فتح نافذة اليومية لراحة الاستخدام."})]})]})]}),e.jsx("div",{className:"flex justify-end gap-2 mt-6",children:e.jsx(h,{variant:"secondary",onClick:()=>u(!1),children:"إغلاق"})})]})});class ir{static async processTransfer(u){const{amount:c,currentCashBalance:y,currentWalletBalances:w,wallets:C,selectedWalletId:s}=u;if(c<=0)return{success:!1,newCashBalance:y,newWalletBalances:w,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!u.skipRemoteLimitsCheck)try{const O=await ra.canPerformOperation(s,c,"transfer");if(!O.canPerform)return{success:!1,newCashBalance:y,newWalletBalances:w,message:O.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(O){return console.error("خطأ في التحقق من حدود التحويل:",O),{success:!1,newCashBalance:y,newWalletBalances:w,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(c<=0)return{success:!1,newCashBalance:y,newWalletBalances:w,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s){const O=Math.max(w[s]||0,0);if(O<c){const k=C.find(g=>g.id===s);return{success:!1,newCashBalance:y,newWalletBalances:w,message:`رصيد غير كافي في المحفظة${k?` ${k.name}`:""}. المتاح: ${O} جنيه، المطلوب: ${c} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const O=ir.calculateTotalWalletBalance(w);if(O<c)return{success:!1,newCashBalance:y,newWalletBalances:w,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${O} جنيه، المبلغ المطلوب: ${c} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const j={...w};if(s){const O=j[s]||0;j[s]=O-c}else{let O=c;for(const k of C){if(O<=0)break;const g=Math.max(j[k.id]||0,0),N=Math.min(g,O);N>0&&(j[k.id]=(j[k.id]||0)-N,O-=N)}}const R=y+c;let D="تم التحويل بنجاح";if(s){const O=j[s]||0;O<0&&(D=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${s} أصبح ${O} جنيه.`)}return{success:!0,newCashBalance:R,newWalletBalances:j,message:D}}static processDeposit(u){const{amount:c,currentCashBalance:y,currentWalletBalances:w,wallets:C}=u;if(c<=0)return{success:!1,newCashBalance:y,newWalletBalances:w,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const s=this.calculateTotalWalletBalance(w);if(s<c)return{success:!1,newCashBalance:y,newWalletBalances:w,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${s} جنيه، المبلغ المطلوب: ${c} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const j=y+c,R={...w};let D=c;const O=C.find(g=>g.isDefault);if(O&&R[O.id]>=D)R[O.id]-=D,D=0;else for(const g of C){if(D<=0)break;const N=R[g.id]||0;if(N>0){const T=Math.min(N,D);R[g.id]=N-T,D-=T}}const k=D>0?`تم الإيداع جزئياً. تم إيداع ${c-D} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${c} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:j,newWalletBalances:R,message:k}}static async processWithdraw(u){const{amount:c,currentCashBalance:y,currentWalletBalances:w,wallets:C,selectedWalletId:s}=u;if(c<=0)return{success:!1,newCashBalance:y,newWalletBalances:w,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!u.skipRemoteLimitsCheck)try{const O=await ra.canPerformOperation(s,c,"withdraw");if(!O.canPerform)return{success:!1,newCashBalance:y,newWalletBalances:w,message:O.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(O){return console.error("خطأ في التحقق من حدود السحب:",O),{success:!1,newCashBalance:y,newWalletBalances:w,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(y<c)return{success:!1,newCashBalance:y,newWalletBalances:w,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${y} جنيه، المبلغ المطلوب: ${c} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const j=y-c,R={...w},D=s?C.find(O=>O.id===s):C.find(O=>O.isDefault)||C[0];if(D){const O=R[D.id]||0;R[D.id]=O+c}else return{success:!1,newCashBalance:y,newWalletBalances:w,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};return{success:!0,newCashBalance:j,newWalletBalances:R,message:`تم السحب بنجاح. تم إضافة ${c} جنيه إلى محفظة ${(D==null?void 0:D.name)||""}`}}static validateOperation(u,c){return u<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!c||c.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(u){return Object.values(u).reduce((c,y)=>c+Math.max(y,0),0)}static deductFromWalletsAddToCash(u,c,y,w){return this.processTransfer({amount:u,currentCashBalance:c,currentWalletBalances:y,wallets:w})}static deductFromWalletsAddToCashDeposit(u,c,y,w){return this.processDeposit({amount:u,currentCashBalance:c,currentWalletBalances:y,wallets:w})}static deductFromCashAddToWallets(u,c,y,w){return this.processWithdraw({amount:u,currentCashBalance:c,currentWalletBalances:y,wallets:w})}static applyTransactionResult(u,c,y){u.success&&(c(u.newCashBalance),y(u.newWalletBalances))}static validateTransaction(u,c,y,w){if(u<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(c==="transfer"){const C=this.calculateTotalWalletBalance(w);if(C<u)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${C} جنيه) غير كافي للمبلغ المطلوب (${u} جنيه)`}}else if(c==="withdraw"){if(y<u)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${y} جنيه) غير كافي للمبلغ المطلوب (${u} جنيه)`}}else if(c==="deposit"){const C=this.calculateTotalWalletBalance(w);if(C<u)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${C} جنيه) غير كافي للمبلغ المطلوب (${u} جنيه)`}}return{isValid:!0}}static getDeductionPreview(u,c,y){const w=[];let C=u;for(const s of y){if(C<=0)break;const j=c[s.id]||0,R=Math.min(Math.max(j,0),C);R>0&&(w.push({walletId:s.id,walletName:s.name,currentBalance:j,deductedAmount:R,newBalance:j-R}),C-=R)}return w}}let Lr=null;function ju(){const i=window;if(!Lr){const u=i.AudioContext||i.webkitAudioContext;Lr=new u}return Lr.state==="suspended"&&Lr.resume(),Lr}function Su(i,u,c){const y=c/1e3,w=Math.floor(i.sampleRate*y),C=i.createBuffer(1,w,i.sampleRate),s=C.getChannelData(0);for(let O=0;O<w;O++)s[O]=(Math.random()*2-1)*.6;const j=i.createBufferSource();j.buffer=C;const R=i.createBiquadFilter();R.type="highpass",R.frequency.value=1500,R.Q.value=.7;const D=i.createGain();D.gain.setValueAtTime(1e-4,u),D.gain.exponentialRampToValueAtTime(.4,u+.015),D.gain.exponentialRampToValueAtTime(1e-4,u+y),j.connect(R),R.connect(D),D.connect(i.destination),j.start(u),j.stop(u+y+.01)}function Du(i,u,c,y,w,C="triangle"){const s=i.createOscillator(),j=i.createGain();s.type=C;const R=w/1e3;s.frequency.setValueAtTime(c,u),s.frequency.linearRampToValueAtTime(y,u+R),j.gain.setValueAtTime(1e-4,u),j.gain.exponentialRampToValueAtTime(.25,u+.02),j.gain.exponentialRampToValueAtTime(1e-4,u+R),s.connect(j),j.connect(i.destination),s.start(u),s.stop(u+R+.02)}function Cu(){try{const i=ju(),u=i.currentTime;Su(i,u,90),Du(i,u+.12,1900,1100,180,"sawtooth")}catch{}}function Iu(i){if(!i)return!1;const c=i.replace(/[^0-9٠-٩]/g,"").replace(/[٠-٩]/g,y=>"0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(y)]);return/^(010|011|012|015)[0-9]{8}$/.test(c)}function Au({userId:i}){const[u,c]=Ve.useState(null),[y,w]=Ve.useState("");return null}const Px=()=>{var ko,_o,Oo,Eo,Mo,$o;console.log("🔥 UserDashboardPage component is loading...");const{toast:i}=Ks(),u=n.useRef(null),[c,y]=n.useState(0),w=async()=>{var r,l,o;const t="alkaptin678678@gmail.com",a=(l=(r=nr.currentUser)==null?void 0:r.email)==null?void 0:l.toLowerCase();if(!a||a!==t){i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}if(!fn||!yn||!bn){i({title:"بيانات ناقصة",description:"أدخل رقم الموبايل، الشركة والمبلغ",variant:"destructive"});return}try{lo(!0);const m=await((o=nr.currentUser)==null?void 0:o.getIdToken()),x=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...m?{Authorization:`Bearer ${m}`}:{}},body:JSON.stringify({phone:fn,countryCode:"EG",operator:yn,amount:Number(bn),useLocalAmount:!0})}),p=await x.json().catch(()=>({}));x.ok&&(p!=null&&p.success)?(i({title:"تم الشحن",description:(p==null?void 0:p.message)||"تم تنفيذ عملية الشحن بنجاح"}),Oi(!1),ao(""),ro(""),no("")):i({title:"فشل الشحن",description:(p==null?void 0:p.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(m){console.error("Topup request error:",m),i({title:"خطأ غير متوقع",description:"تعذّر تنفيذ عملية الشحن. حاول لاحقاً.",variant:"destructive"})}finally{lo(!1)}},{signOut:C,user:s,profile:j}=la(),R=((s==null?void 0:s.email)||"").toLowerCase()==="vodafonecash00@gmail.com",D=rc(),O=tc(),k=eh(),{isShiftActive:g,shiftUser:N}=qr(),{shopId:T,shopName:J}=Jn(),L=th();(()=>{try{return!!window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:"}catch{return!1}})();const[H,te]=n.useState(!1),[ie,M]=n.useState(!1),[W,he]=n.useState(!1),[be,de]=n.useState(!1),[oe,ae]=n.useState([]),[Me,Be]=n.useState(""),[Pe,Ke]=n.useState(""),[qe,ot]=n.useState(""),[ee,ue]=n.useState(""),[tt,re]=n.useState(!1),[Se,ft]=n.useState(!1),[es,qt]=n.useState(null),[Yt,Ie]=n.useState(""),[Ge,ct]=n.useState(""),[ve,dt]=n.useState(!1);n.useEffect(()=>{const t=k==null?void 0:k.shopId;if(t&&(s!=null&&s.uid))try{const a=`selectedShopId_${s.uid}`;localStorage.setItem(a,String(t)),window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}},[k==null?void 0:k.shopId,s==null?void 0:s.uid]);const[V,yt]=n.useState([]),[vt,wt]=n.useState(()=>{try{return localStorage.getItem("cashySelectedDevice")||null}catch{return null}}),F=t=>!!(t&&V.some(a=>a.id===t));async function xe(){const t=window.electronAPI,a=vt||"";if(!t||typeof t.sendUssd!="function")return null;if(!a)return i({title:"الجهاز غير محدد",description:"اتصل بالموبايل أولاً ثم اختر الجهاز من القائمة",variant:"destructive"}),null;if(F(a))return a;try{const m=V.find(x=>x&&x.id&&!String(x.id).includes(":"));if(m&&m.id)return wt(m.id),m.id}catch{}const r=a.includes(":")?a.split(":").slice(0,2).join(":"):"";if(r&&typeof t.connectWifi=="function"){try{await t.connectWifi(r)}catch{}if(await new Promise(m=>setTimeout(m,250)),F(a))return a}const l=a.split(":")[0],o=V.find(m=>(m.id.startsWith(l)||m.id.includes(l))&&m.id.includes(":"));if(o!=null&&o.id){const m=o.id.split(":").slice(0,2).join(":");if(!F(o.id)&&typeof t.connectWifi=="function"){try{await t.connectWifi(m)}catch{}await new Promise(x=>setTimeout(x,250))}if(F(o.id))return wt(o.id),o.id}return i({title:"الجهاز غير متصل",description:"فعّل Wireless debugging أو استخدم اتصال Wi‑Fi ثم أعد المحاولة",variant:"destructive"}),null}n.useEffect(()=>{const t=window.electronAPI;t&&typeof t.onAdbDevices=="function"&&t.onAdbDevices(a=>{var o;const r=Array.isArray(a)?a:[];yt(r);const l=(()=>{try{return localStorage.getItem("cashySelectedDevice")||""}catch{return""}})();l&&r.some(m=>m.id===l)?wt(l):(o=r[0])!=null&&o.id?wt(m=>m||r[0].id):wt(null)})},[]);function ke(t,a){try{const r=cs==null?void 0:cs(),l=(r==null?void 0:r.phone)||"";if(!l){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"});return}lh(l,t,a),i({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),Fa(!1),Xa(!1)}catch(r){const l=(r==null?void 0:r.message)||"تعذر إرسال الكود — تحقق من البيانات";throw i({title:"فشل الإرسال",description:l,variant:"destructive"}),r}}const mt=async()=>{var r;if(!Ts||!Ts.receiver||!Ts.amount){i({title:"بيانات غير مكتملة",description:"تأكد من إدخال رقم المستقبل والمبلغ قبل الإرسال",variant:"destructive"});return}const t=String(Ts.receiver),a=Math.round(Number(Ts.amount));Ra(!0);try{if((r=Uo)!=null&&r.isNativePlatform&&Uo.getPlatform()==="android"){const o=cs==null?void 0:cs(),m=(o==null?void 0:o.phone)||"";if(!m){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),Ra(!1);return}const x=zo(m,t,a);if(!x){i({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),Ra(!1);return}ih(x),i({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),Fa(!1),Xa(!1);return}const l=window.electronAPI;if(l&&typeof l.sendUssd=="function"&&vt){const o=cs==null?void 0:cs(),m=(o==null?void 0:o.phone)||"";if(!m){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),Ra(!1);return}const x=await xe();if(!x){Ra(!1);return}const p=zo(m,t,a);if(!p){i({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),Ra(!1);return}try{const S=typeof l.pickSimAutomatically=="function"?await l.pickSimAutomatically(x,m):{deviceId:x,slot:0},f=`${S.deviceId}:sim${S.slot}`;dd(f),await l.sendUssd(f,p)}catch{try{await l.sendUssd(x,p)}catch(f){const v=x.includes(":")?x.split(":").slice(0,2).join(":"):"";if(v&&typeof l.connectWifi=="function")await l.connectWifi(v),await l.sendUssd(x,p);else throw f}}i({title:"تم إرسال كود التحويل",description:"تم التنفيذ بنجاح"}),Fa(!1),Xa(!0)}else ke(t,a)}catch(l){const o=l&&l.message?l.message:"حدث خطأ غير متوقع أثناء الإرسال";i({title:"خطأ أثناء الإرسال",description:`الجهاز: ${Dl||vt||"غير معروف"} — ${o}`,variant:"destructive"})}finally{Ra(!1)}},xt=async(t,a)=>{const r=window.electronAPI;try{if(r&&typeof r.enterPin=="function"&&t){await r.enterPin(t,a),Xa(!1);return}const l=String((j==null?void 0:j.bridgeLink)||"").trim(),o=String((j==null?void 0:j.bridgeDeviceId)||"").trim()||void 0;if(!l){i({title:"الرابط غير مُعدّ",description:"احفظ رابط الجسر أولاً",variant:"destructive"});return}const m=String((Ts==null?void 0:Ts.receiver)||Cs||"").replace(/\D/g,""),x=Math.max(1,Math.round(Number((Ts==null?void 0:Ts.amount)||ss||0))||0),p=String(a||"").replace(/\D/g,""),f=(v=>{let P=(v||"").trim();return P=P.replace(/\/+$/,""),/^https?:\/\//i.test(P)||(P=`https://${P}`),P})(l);Xa(!1)}catch(l){const o=(l==null?void 0:l.message)||"حدث خطأ أثناء إدخال الرقم السري";i({title:"فشل الإدخال",description:o,variant:"destructive"})}};console.log("🔥 UserDashboardPage - user:",s?"exists":"null");const[kt,_t]=n.useState(!0),[Nt,et]=n.useState(!0),[Ot,At]=n.useState(!1),[Ht,Gt]=n.useState(!1),[Js,ea]=n.useState(""),[gs,Fs]=n.useState(""),[Ys,A]=n.useState(""),[se,ce]=n.useState([]),[Ce,Oe]=n.useState(!1),[$e,st]=n.useState(null),[B,Fe]=n.useState(""),[G,Dt]=n.useState(!1),[Ct,jt]=n.useState(!1),[Qt,Zt]=n.useState(!1),[ta,wa]=n.useState(!1),[oa,sa]=n.useState(""),[z,we]=n.useState(""),[St,lt]=n.useState([]),[Jt,os]=n.useState(!1),[Bt,Na]=n.useState(0),[Ga,$a]=n.useState(!1),[ts,Qe]=n.useState(null),[Et,Rs]=n.useState(!1),[Ds,La]=n.useState(""),[Cs,ja]=n.useState(""),[ss,d]=n.useState(""),[I,_]=n.useState(""),[Y,q]=n.useState(!1),[Ne,We]=n.useState(""),[Ue,_e]=n.useState(""),[Ze,Ee]=n.useState(""),[Ft,Bs]=n.useState(""),[Vt,$s]=n.useState(null),[Wa,Sa]=n.useState(!1),[fs,ca]=n.useState(!1),[Vr,or]=n.useState(!1),[Kr,cr]=n.useState(!1),[dr,Yn]=n.useState(null),[Is,Hn]=n.useState(""),[As,Gn]=n.useState(""),[ll,Uc]=n.useState(""),[zc,Jr]=n.useState(!1),[Tu,Pu]=n.useState(null),[Us,ol]=n.useState(null),Yr=t=>{const a="٠١٢٣٤٥٦٧٨٩",r="۰۱۲۳۴۵۶۷۸۹";return(t||"").split("").map(l=>{const o=a.indexOf(l);if(o>-1)return String(o);const m=r.indexOf(l);return m>-1?String(m):l}).join("")},[pt,Qn]=n.useState(()=>{try{const t=localStorage.getItem("commissionMode")||localStorage.getItem("commissionMode_default");return t?t==="add":!0}catch{return!0}}),[ne,cl]=n.useState("transfer"),[ht,da]=n.useState([]),[ma,Zn]=n.useState("all");n.useEffect(()=>{try{if(localStorage.setItem("commissionMode",pt?"add":"deduct"),s!=null&&s.uid){const t=`commissionMode_${s.uid}`;localStorage.setItem(t,pt?"add":"deduct")}}catch{}},[pt,s==null?void 0:s.uid]),n.useEffect(()=>{try{const t=s!=null&&s.uid?localStorage.getItem(`commissionMode_${s.uid}`):null,a=localStorage.getItem("commissionMode"),r=localStorage.getItem("commissionMode_default"),l=t??a??r;l&&Qn(l==="add")}catch{}},[s==null?void 0:s.uid]);const[Xn,mr]=n.useState(!1),[qc,Vc]=n.useState(null),Hr=Ve.useRef(""),dl=Ve.useRef(0);n.useEffect(()=>{const t=a=>{var l;if(Xn)return;try{const o=document.activeElement;if(o){const m=(l=o.tagName)==null?void 0:l.toLowerCase();if(m==="input"||m==="textarea"||m==="select"||m==="button"||o.isContentEditable===!0)return}}catch{}const r=Date.now();if(a.key==="Enter"){const o=(Hr.current||"").trim();Hr.current="",o&&(Vc(o),mr(!0));return}a.key.length===1&&(r-(dl.current||0)>100&&(Hr.current=""),Hr.current+=a.key,dl.current=r)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[Xn]);const[Kc,Jc]=n.useState(!1),[Yc,ku]=n.useState(null),[Z,ei]=n.useState("");n.useEffect(()=>{if(!Y)return;const t=cs(),a=parseFloat(ss||"0")||0;let r=0;if(ne==="transfer"){if((t==null?void 0:t.defaultTransferCommission)!=null){const o=Number(t.defaultTransferCommission)||0;r=Math.round(o*a/1e3*100)/100}else{const o=As&&As.trim()!==""?parseFloat(As):0;r=Math.max(0,o)}const l=a+r;_e((l||0).toString())}else{if((t==null?void 0:t.defaultWithdrawCommission)!=null){const o=Number(t.defaultWithdrawCommission)||0;r=Math.round(o*a/1e3*100)/100}else{const o=Is&&Is.trim()!==""?parseFloat(Is):Math.round(a*.01*100)/100;r=Math.max(0,o)}const l=pt?a:Math.max(0,Math.round((a-r)*100)/100);_e((l||0).toString())}},[Y,ss,As,Is,Z,pt,ne]);const cs=()=>{var a,r;let t=Ye.find(l=>l.id===Z);if(!t)try{const l=localStorage.getItem(Bi());if(l){const o=JSON.parse(l);if(Array.isArray(o)&&o.length>0){const x=localStorage.getItem(wr())||((a=o.find(p=>p.isDefault))==null?void 0:a.id)||((r=o[0])==null?void 0:r.id);t=o.find(p=>p.id===x)}}}catch{}return t};n.useLayoutEffect(()=>{try{const t=`wallets_${(s==null?void 0:s.uid)||"default"}`;let a=localStorage.getItem(t);if(!a){const r=Object.keys(localStorage).find(l=>l.startsWith("wallets_"));r&&(a=localStorage.getItem(r)||null)}if(a){const r=JSON.parse(a);if(Array.isArray(r)&&r.length>0){hr(r);const l=localStorage.getItem(wr()),o=l&&r.find(m=>m.id===l)||r.find(m=>m.isDefault)||r[0];o&&(ei(o.id),La(o.phone))}}}catch(t){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",t)}},[]),n.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",Z)},[Z]),n.useEffect(()=>{ho()},[s==null?void 0:s.uid]),n.useEffect(()=>{nm()},[]);const[Ye,hr]=n.useState(()=>{try{const t=Object.keys(localStorage).find(r=>r.startsWith("wallets_")),a=t?localStorage.getItem(t):null;if(a){const r=JSON.parse(a);if(Array.isArray(r))return r}}catch{}return[]}),[ml,Hc]=n.useState(""),hl=(()=>{const t=ml.replace(/\D/g,"");return t?Ye.filter(a=>(a.phone||"").replace(/\D/g,"").includes(t)):Ye})(),[Gc,_u]=n.useState(null),[Qc,ul]=n.useState(!1),[Zc,Gr]=n.useState(!1),[Xc,ed]=n.useState(null),[Ou,td]=n.useState([]),[Eu,Mu]=n.useState([]),[sd,ur]=n.useState(!1),[ti,xl]=n.useState("daily"),[Qr,Qa]=n.useState([]),[pl,ad]=n.useState(!1),Da=Ve.useRef(new Set),gl=Ve.useRef(new Set),fl=Ve.useRef([]);n.useEffect(()=>{fl.current=ht},[ht]);const yl=async t=>{try{if(!s)return;const a=bs(),r=ys(),l=localStorage.getItem(a),o=localStorage.getItem(r);let m=l?parseFloat(l):It,x=o?JSON.parse(o):{...Xe};const p=Number(t.withdrawnAmount??t.sentAmount??t.transferredAmount??t.amount??0);if(t.type==="send"&&(t.fromWallet||Z)){m-=p;const v=t.fromWallet||Z;x[v]=(x[v]||0)+p}else if(t.type==="withdraw"&&(t.fromWallet||Z)){m+=p;const v=t.fromWallet||Z;x[v]=Math.max(0,(x[v]||0)-p)}Ut(m),rs(x),localStorage.setItem(a,m.toString()),localStorage.setItem(r,JSON.stringify(x));const S={cashBalance:m,walletBalances:x,lastUpdated:new Date().toISOString()},f=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(f,JSON.stringify(S));try{await Te.updateUserData(s.uid,S),localStorage.removeItem(f),Je(!1)}catch(v){console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف (مزامنة تلقائية):",v),Je(!0)}try{const v=t.fromWallet||Z,P=await ra.getWalletLimits(s.uid,v);if(P){const $={...P};t.type==="send"?($.dailyTransferUsed=Math.max(0,(P.dailyTransferUsed||0)-p),$.monthlyTransferUsed=Math.max(0,(P.monthlyTransferUsed||0)-p)):($.dailyWithdrawUsed=Math.max(0,(P.dailyWithdrawUsed||0)-p),$.monthlyWithdrawUsed=Math.max(0,(P.monthlyWithdrawUsed||0)-p)),await ra.updateWalletLimits(s.uid,v,$)}}catch(v){console.warn("تعذر تحديث حدود المحفظة بعد الحذف (مزامنة):",v)}try{us.removeTransactionEffects(t,s.uid)}catch(v){console.warn("تعذر تحديث التقارير بعد الحذف (مزامنة):",v)}}catch(a){console.warn("خطأ أثناء تطبيق تأثيرات الحذف محليًا:",a)}},rd=async t=>{try{const a=ht.find(x=>x.id===t);if(!a||!s)return;const r=String(t),l=String((a==null?void 0:a.transactionId)||(a==null?void 0:a.reference)||""),o=Da.current.has(r)||l&&Da.current.has(l),m=ht.filter(x=>x.id!==t);da(m);try{await Te.removeUserTransaction(s.uid,t),await $r.permanentlyDeleteTransaction(t,s.uid)}catch(x){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",x)}if(!o){Da.current.add(r),l&&Da.current.add(l),await yl(a);try{s!=null&&s.uid&&Te.removeLocalReceiptById(s.uid,t)}catch{}}i({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),Gr(!1)}catch(a){console.error("خطأ أثناء حذف الإيصال:",a),i({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},nd=async t=>{var a;try{const r=ht.find(l=>l.id===t);if(!r||!s)return;try{const l=(a=ts==null?void 0:ts.subscription)==null?void 0:a.planType;if(l===ws.ZERO){const{dailyOperationCountService:o}=await gt(async()=>{const{dailyOperationCountService:p}=await import("./dailyOperationCountService-C1KYgbv3.js");return{dailyOperationCountService:p}},__vite__mapDeps([2,0,1]),import.meta.url),m=r.type==="send"?"transfer":"withdraw";if(!(await o.checkAndIncrement(s.uid,m,5)).allowed){i({title:"تم بلوغ حد باقة الزيرو",description:"مسموح بحد أقصى 5 تأكيدات يوميًا للتحويل/السحب. جرّب غدًا أو قم بالترقية.",variant:"destructive"});return}}else if(l===ws.TAHWEELA){const{dailyOperationCountService:o}=await gt(async()=>{const{dailyOperationCountService:p}=await import("./dailyOperationCountService-C1KYgbv3.js");return{dailyOperationCountService:p}},__vite__mapDeps([2,0,1]),import.meta.url),m=r.type==="send"?"transfer":"withdraw";if(!(await o.checkAndIncrementCombined(s.uid,m,40)).allowed){i({title:"تم بلوغ حد باقة تحويله",description:"هذه الباقة تسمح بحد أقصى 40 عملية تحويل/سحب يومياً.",variant:"destructive"});return}}}catch(l){console.warn("تعذر التحقق من حد التأكيد اليومي:",l)}await Es(ze(K,"userTransactions",t),{status:"completed",confirmedAt:new Date}),da(l=>l.map(o=>o.id===t?{...o,status:"completed"}:o)),i({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),Gr(!1)}catch(r){console.error("خطأ أثناء إكمال الإيصال:",r),i({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}};n.useEffect(()=>{if(s)try{const t=He(De(K,"deletedTransactions"),je("userId","==",s.uid)),a=Ms(t,r=>{r.docChanges().forEach(l=>{if(l.type!=="added")return;const o=l.doc.data(),m=String((o==null?void 0:o.originalTransactionId)||""),x=String((o==null?void 0:o.transactionId)||""),p=String((o==null?void 0:o.reference)||""),S=m||x||p||String(l.doc.id);S&&(Da.current.has(S)||(Da.current.add(S),da(f=>{const v=f.find($=>$.id===m);return v?((async()=>await yl(v))(),f.filter($=>$.id!==m)):f})))})},r=>{console.warn("فشل الاشتراك في deletedTransactions:",r)});return()=>a()}catch(t){console.warn("تعذر إنشاء مستمع deletedTransactions:",t)}},[s==null?void 0:s.uid]),n.useEffect(()=>{if(s)try{const t=ze(K,"users",s.uid),a=Ms(t,async r=>{if(!r.exists())return;const l=r.data();if(l!=null&&l.reportsData)try{await us.syncReportsDataFromFirebase(s.uid),td(kr())}catch(o){console.warn("تعذر مزامنة reportsData من السحابة:",o)}},r=>{console.warn("فشل الاشتراك في users.reportsData:",r)});return()=>a()}catch(t){console.warn("تعذر إنشاء مستمع users.reportsData:",t)}},[s==null?void 0:s.uid]);const[bl,id]=n.useState(""),vl=xu(bl,300),[Zr,wl]=n.useState(""),[Xr,Nl]=n.useState(""),[ha,$u]=n.useState(""),[si,Za]=n.useState(!1),[jl,xr]=n.useState(!1),[ld,Fa]=n.useState(!1),[as,ai]=n.useState(null),[Ts,od]=n.useState(null),[Sl,Ra]=n.useState(!1),[cd,Xa]=n.useState(!1),[Dl,dd]=n.useState(""),[md,ri]=n.useState(!1),Cl=!1,[hd,en]=n.useState(!1),[ud,Il]=n.useState(!1),[xd,tn]=n.useState(!1),[pd,sn]=n.useState(!1),[gd,an]=n.useState(!1),[fd,Al]=n.useState(!0),[pr,yd]=n.useState(!1),[bd,rn]=n.useState(!1),[vd,Tl]=n.useState(!1),[nn,wd]=n.useState(""),[Pl,Nd]=n.useState(!1),[jd,ni]=n.useState(!1),[Sd,kl]=n.useState(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[Dd,ii]=n.useState(!1);n.useEffect(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled",a=localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled");kl(a==="true")}catch{}},[s==null?void 0:s.uid]);const[Cd,er]=n.useState(!1),[Id,li]=n.useState(!1),[Ad,_l]=n.useState(()=>{try{const t=s==null?void 0:s.uid,a=t?`debtsPinRequired_${t}`:"debtsPinRequired";return(localStorage.getItem(a)??localStorage.getItem("debtsPinRequired"))==="true"}catch{return!1}}),[Td,Ol]=n.useState(!1),[El,Pd]=n.useState(null),[Mt,Ps]=n.useState([]),[oi,Ml]=n.useState(""),[ci,$l]=n.useState(""),[di,Ll]=n.useState(""),[Ae,gr]=n.useState(null),[kd,Ca]=n.useState(!1),[_d,fr]=n.useState(!1),[Ba,Wl]=n.useState(null),[Fl,mi]=n.useState(""),[ln,Rl]=n.useState(null),[Lu,Wu]=n.useState(!1),[Od,hi]=n.useState(!1),[Bl,ui]=n.useState(""),[xi,yr]=n.useState(!1),[Ul,pi]=n.useState(1),Ed=L?10:20,gi=Ve.useMemo(()=>Mt.slice(0,Ul*Ed),[Mt,Ul]);n.useEffect(()=>{xi&&pi(1)},[xi]);const fi=async()=>{if(bt){i({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}try{const t=await ps.hasMasterPin(s==null?void 0:s.uid);Ad&&t?li(!0):er(!0)}catch{er(!0)}};n.useEffect(()=>{try{const t=s==null?void 0:s.uid,a=t?`debtsPinRequired_${t}`:"debtsPinRequired",r=localStorage.getItem(a)??localStorage.getItem("debtsPinRequired");(r==="true"||r==="false")&&_l(r==="true")}catch{}},[s==null?void 0:s.uid]);const[Md,yi]=n.useState(!1),[Ls,bi]=n.useState([]),[vi,zl]=n.useState(""),[wi,ql]=n.useState(""),[on,Vl]=n.useState(""),[Kl,$d]=n.useState(""),[Ld,cn]=n.useState(!1),[Wd,Jl]=n.useState(""),[Yl,Ni]=n.useState(""),[Hl,ji]=n.useState(""),[Fd,dn]=n.useState(!1),[Rd,Si]=n.useState(""),[Gl,Di]=n.useState(""),[Bd,tr]=n.useState(!1),[sr,mn]=n.useState(null),[ks,br]=n.useState(null),[hn,Ci]=n.useState(""),[Ud,ar]=n.useState(!1),[Ql,un]=n.useState(0),[Ws,Ia]=n.useState(null),[Ua,Ii]=n.useState(""),[at,Ai]=n.useState(null),[Zl,Xl]=n.useState(""),zs=async t=>{try{const a=JSON.stringify(t);localStorage.setItem(vn(),a);try{localStorage.setItem(mo(),a)}catch{}try{localStorage.setItem($i(),Date.now().toString())}catch{}s!=null&&s.uid&&Te.updateUserData(s.uid,{debts:t}).then(()=>{try{localStorage.removeItem(`debts_unsynced_${s.uid}`)}catch{}}).catch(()=>{Je(!0);try{localStorage.setItem(`debts_unsynced_${s.uid}`,"true")}catch{}})}catch(a){console.error("خطأ في حفظ الديون:",a)}},zd=async()=>{try{const t=vn(),a=mo(),r=$i(),l=localStorage.getItem(t),o=localStorage.getItem(a),m=localStorage.getItem(r),x=m?Number(m):0,p=f=>{if(!f)return null;try{const v=JSON.parse(f);return Array.isArray(v)?v.map(P=>{var $;return{...P,createdAt:($=P.createdAt)!=null&&$.toDate?P.createdAt.toDate():new Date(P.createdAt),partialPayments:Array.isArray(P.partialPayments)?P.partialPayments.map(E=>{var X;return{amount:Number(E.amount)||0,paidAt:(X=E.paidAt)!=null&&X.toDate?E.paidAt.toDate():new Date(E.paidAt)}}):[]}}):[]}catch(v){return console.warn("فشل في تحليل ديون localStorage:",v),null}};let S=p(l);if(!S||S.length===0){const f=p(o);if(f&&f.length>0&&(S=f,Ps(f),s!=null&&s.uid))try{await zs(f),localStorage.removeItem(a)}catch(v){console.warn("تعذر ترحيل الديون من المفتاح الافتراضي:",v)}}if(S&&S.length>0&&Ps(S),s!=null&&s.uid)try{const f=`debts_unsynced_${s.uid}`,v=localStorage.getItem(f)==="true",P=await fa(ze(K,"users",s.uid));if(P.exists()){const $=P.data(),E=$.debts&&Array.isArray($.debts)?$.debts.map(le=>{var me;return{...le,createdAt:(me=le.createdAt)!=null&&me.toDate?le.createdAt.toDate():new Date(le.createdAt),partialPayments:Array.isArray(le.partialPayments)?le.partialPayments.map(Os=>{var Hs;return{amount:Number(Os.amount)||0,paidAt:(Hs=Os.paidAt)!=null&&Hs.toDate?Os.paidAt.toDate():new Date(Os.paidAt)}}):[]}}):[],X=x&&Date.now()-x<12e4,Re=v||X?S||[]:E&&E.length>0?E:S||[];Ps(Re);try{localStorage.setItem(t,JSON.stringify(Re))}catch{}((E==null?void 0:E.length)||0)===0&&((Re==null?void 0:Re.length)||0)>0&&await Te.updateUserData(s.uid,{debts:Re})}else S&&S.length>0&&await Te.saveUserData(s.uid,{debts:S})}catch(f){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",f)}}catch(t){console.error("خطأ في تحميل الديون:",t)}};n.useEffect(()=>{try{window.exportDebts=()=>{try{return JSON.stringify(Mt||[])}catch{return"[]"}},window.importDebts=async t=>{try{const a=JSON.parse(t);if(!Array.isArray(a))throw new Error("صيغة غير صحيحة — يجب أن تكون مصفوفة");return await zs(a),{ok:!0,count:a.length}}catch(a){return console.error("فشل استيراد الديون:",a),{ok:!1,error:String(a)}}},window.fixWalletsForCurrentUser=async t=>{try{if(!(s!=null&&s.uid))throw new Error("يجب تسجيل الدخول أولاً");return await(await gt(async()=>{const{merchantWalletService:r}=await import("./index-B57-Wohm.js").then(l=>l.bM);return{merchantWalletService:r}},__vite__mapDeps([0,1]),import.meta.url)).merchantWalletService.reassignByMsisdns(t,s.uid)}catch(a){return console.error("فشل إصلاح المحافظ للمستخدم الحالي:",a),{updated:0,failed:(t==null?void 0:t.length)||0,error:String(a)}}}}catch{}},[Mt,s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;const t=ze(K,"users",s.uid),a=Ms(t,r=>{if(!r.exists())return;const l=r.data(),o=Array.isArray(l==null?void 0:l.debts)?l.debts:[],m=`debts_unsynced_${s.uid}`,x=localStorage.getItem(m)==="true",p=localStorage.getItem($i()),S=p?Number(p):0,f=S&&Date.now()-S<12e4;if(!(x||f))try{const v=o.map(P=>{var $;return{...P,createdAt:($=P.createdAt)!=null&&$.toDate?P.createdAt.toDate():new Date(P.createdAt),partialPayments:Array.isArray(P.partialPayments)?P.partialPayments.map(E=>{var X;return{amount:Number(E.amount)||0,paidAt:(X=E.paidAt)!=null&&X.toDate?E.paidAt.toDate():new Date(E.paidAt)}}):[]}});Ps(v);try{localStorage.setItem(vn(),JSON.stringify(v))}catch{}}catch(v){console.warn("تعذر تحليل الديون من التحديثات الحية:",v)}},r=>{console.warn("خطأ في الاشتراك الحي لديون المستخدم:",r)});return()=>a()},[s==null?void 0:s.uid]);const qd=async()=>{if(s!=null&&s.uid){console.log("🔄 إعادة فحص حالة المستخدم...");try{await new Promise(a=>setTimeout(a,500));const t=await fa(ze(K,"users",s.uid));if(t.exists()){const r=t.data().isActive===!0,l=await Rr.checkTrialValidity(s.uid),o=l.isValid&&!l.isExpired;console.log("📊 حالة المستخدم:",{isActive:r,isOnTrial:o,hoursRemaining:l.hoursRemaining}),_t(r||o),os(o),Na(l.hoursRemaining),$a(l.hasUsedTrial),Zt(!r&&!o),console.log("✅ تم تحديث حالة المستخدم بنجاح:",{userIsActive:r||o,isOnFreeTrial:o})}}catch(t){console.error("خطأ في إعادة فحص حالة المستخدم:",t)}}},Vd=async()=>{console.log("🎉 تم بدء التجربة المجانية، إعادة فحص حالة المستخدم..."),await qd()},Kd=async()=>{if(s!=null&&s.uid)try{Rs(!0);const t=await nl(s.uid);Qe(t)}catch(t){console.error("خطأ في جلب بيانات الاشتراك:",t)}finally{Rs(!1)}},[Fu,Ru]=n.useState(!1),[Jd,Ti]=n.useState(!1),[It,Ut]=n.useState(0),[Xe,rs]=n.useState({}),[Yd,eo]=n.useState(!1),[Hd,to]=n.useState(!1),[Gd,Pi]=n.useState(!1),[Qd,xn]=n.useState(!1),[so,ki]=n.useState(""),[Zd,vr]=n.useState(!1),[Xd,pn]=n.useState(!1),[_i,gn]=n.useState(""),[em,Oi]=n.useState(!1),[fn,ao]=n.useState(""),[yn,ro]=n.useState(""),[bn,no]=n.useState(""),[io,lo]=n.useState(!1),[Ei,Mi]=n.useState(!1),[tm,oo]=n.useState(!1),[co,sm]=n.useState([]);n.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid)||!Ei)return;try{await Er.trimToMaxCount(s.uid,30)}catch{}const t=await Er.getByUser(s.uid,30);sm(t)}catch{}})()},[s==null?void 0:s.uid,Ei]);const ys=()=>{const t=T||(j==null?void 0:j.shopId)||"main";return`walletBalances_${(s==null?void 0:s.uid)||"default"}_${t}`},bs=()=>{const t=T||(j==null?void 0:j.shopId)||"main";return`cashBalance_${(s==null?void 0:s.uid)||"default"}_${t}`},vn=()=>{const t=T||(j==null?void 0:j.shopId)||"main";return`debts_${(s==null?void 0:s.uid)||"default"}_${t}`},am=()=>{const t=T||(j==null?void 0:j.shopId)||"main";return`customers_${(s==null?void 0:s.uid)||"default"}_${t}`},mo=()=>`debts_default_${T||(j==null?void 0:j.shopId)||"main"}`,$i=()=>{const t=T||(j==null?void 0:j.shopId)||"main";return`debts_last_write_${(s==null?void 0:s.uid)||"default"}_${t}`},Li=()=>`shopExpenses_${T||(j==null?void 0:j.shopId)||(s==null?void 0:s.uid)||"default"}`,ho=()=>{try{const t=localStorage.getItem(Li());if(t){const a=JSON.parse(t);ce(a.map(r=>({...r,createdAt:new Date(r.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",t)}},uo=async t=>{try{localStorage.setItem(Li(),JSON.stringify(t)),ce(t)}catch(a){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",a)}},rm=async t=>{try{const a=se.filter(r=>r.id!==t);await uo(a);try{if(s!=null&&s.uid&&t){const{doc:r,deleteDoc:l}=await gt(async()=>{const{doc:x,deleteDoc:p}=await import("./index-B57-Wohm.js").then(S=>S.bK);return{doc:x,deleteDoc:p}},__vite__mapDeps([0,1]),import.meta.url),{db:o}=await gt(async()=>{const{db:x}=await import("./index-B57-Wohm.js").then(p=>p.bL);return{db:x}},__vite__mapDeps([0,1]),import.meta.url),m=r(o,"shop_expenses",t);await l(m)}}catch(r){console.warn("تعذر حذف المصروف من السحابة الآن، تم الحذف محليًا وسيبقى مخزّنًا دون هذا الإيصال:",r)}i({title:"تم الحذف",description:"تم حذف إيصال المصروف نهائيًا."})}catch(a){console.error("خطأ أثناء الحذف النهائي لإيصال المصروف:",a),i({title:"فشل الحذف",description:"تعذر حذف الإيصال. حاول مرة أخرى.",variant:"destructive"})}};Ve.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid)){ho();return}const{collection:a,query:r,where:l,onSnapshot:o}=await gt(async()=>{const{collection:S,query:f,where:v,onSnapshot:P}=await import("./index-B57-Wohm.js").then($=>$.bK);return{collection:S,query:f,where:v,onSnapshot:P}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await gt(async()=>{const{db:S}=await import("./index-B57-Wohm.js").then(f=>f.bL);return{db:S}},__vite__mapDeps([0,1]),import.meta.url),x=T||(j==null?void 0:j.shopId),p=x?r(a(m,"shop_expenses"),l("shopId","==",x)):r(a(m,"shop_expenses"),l("userId","==",s.uid));t=o(p,async S=>{const v=S.docs.map(P=>{var X;const $=P.data(),E=(X=$.createdAt)!=null&&X.toDate?$.createdAt.toDate():$.createdAt?new Date($.createdAt):new Date;return{id:P.id,name:String($.name||""),amount:Number($.amount||0),notes:$.notes?String($.notes):void 0,source:$.source==="wallet"?"wallet":"cash",walletId:$.walletId?String($.walletId):void 0,createdAt:E}}).sort((P,$)=>$.createdAt.getTime()-P.createdAt.getTime());ce(v);try{localStorage.setItem(Li(),JSON.stringify(v))}catch{}})}catch(a){console.error("خطأ في مزامنة مصروفات المحل من Firestore:",a)}})(),()=>t==null?void 0:t()},[s==null?void 0:s.uid,j==null?void 0:j.shopId,T]);const wn=()=>`deficiencies_${T||(j==null?void 0:j.shopId)||(s==null?void 0:s.uid)||"default-shop"}`,nm=()=>{try{const t=wn(),a=`deficiencies_${(s==null?void 0:s.uid)||"default"}`;if(a!==t){const l=localStorage.getItem(a),o=localStorage.getItem(t);if(l)try{const m=JSON.parse(l)||[],x=o?JSON.parse(o):[],p=Array.isArray(x)?[...x]:[],S=(f,v)=>f.some(P=>(P==null?void 0:P.id)&&(v==null?void 0:v.id)&&String(P.id)===String(v.id)||String((P==null?void 0:P.name)||"")===String((v==null?void 0:v.name)||"")&&String((P==null?void 0:P.status)||"pending")===String((v==null?void 0:v.status)||"pending"));if(Array.isArray(m))for(const f of m)S(p,f)||p.push(f);localStorage.setItem(t,JSON.stringify(p));try{localStorage.removeItem(a)}catch{}}catch{}}const r=localStorage.getItem(t);if(r){const l=JSON.parse(r);lt(l.map(o=>({...o,createdAt:new Date(o.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل النواقص من التخزين:",t)}},Wi=async t=>{try{localStorage.setItem(wn(),JSON.stringify(t)),lt(t)}catch(a){console.error("خطأ أثناء حفظ النواقص في التخزين:",a)}};Ve.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid))return;const{collection:a,query:r,where:l,orderBy:o,onSnapshot:m}=await gt(async()=>{const{collection:f,query:v,where:P,orderBy:$,onSnapshot:E}=await import("./index-B57-Wohm.js").then(X=>X.bK);return{collection:f,query:v,where:P,orderBy:$,onSnapshot:E}},__vite__mapDeps([0,1]),import.meta.url),{db:x}=await gt(async()=>{const{db:f}=await import("./index-B57-Wohm.js").then(v=>v.bL);return{db:f}},__vite__mapDeps([0,1]),import.meta.url),p=T||(j==null?void 0:j.shopId)||s.uid||"default-shop",S=r(a(x,"deficiencies"),l("shopId","==",p),o("createdAt","desc"));t=m(S,async f=>{const v=f.docs.map(P=>{var X;const $=P.data(),E=(X=$.createdAt)!=null&&X.toDate?$.createdAt.toDate():$.createdAt?new Date($.createdAt):new Date;return{id:P.id,name:String($.name||""),quantity:Number($.quantity||1),status:$.status==="purchased"?"purchased":"pending",createdAt:E}});lt(v);try{localStorage.setItem(wn(),JSON.stringify(v))}catch{}},f=>{console.warn("فشل الاشتراك في النواقص من Firestore:",f)})}catch(a){console.warn("فشل إعداد مزامنة النواقص من Firestore:",a)}})(),()=>{try{t&&t()}catch{}}},[s==null?void 0:s.uid,j==null?void 0:j.shopId,T]);const Fi=async t=>{try{localStorage.setItem(am(),JSON.stringify(t)),bi(t),s!=null&&s.uid&&await Te.updateUserData(s.uid,{customers:t})}catch(a){console.error("خطأ أثناء حفظ العملاء في التخزين:",a)}},im=async()=>{try{if(s!=null&&s.uid){const t=await fa(ze(K,"users",s.uid));if(t.exists()){const a=t.data();if(a.customers&&Array.isArray(a.customers)){const r=a.customers.map(l=>{var o;return{...l,createdAt:(o=l.createdAt)!=null&&o.toDate?l.createdAt.toDate():new Date(l.createdAt)}});bi(r);return}}}bi([])}catch(t){console.error("خطأ أثناء تحميل العملاء من Firestore:",t)}},Ri=()=>{const t=T||(j==null?void 0:j.shopId)||"main";return`transactions_${(s==null?void 0:s.uid)||"default"}_${t}`},Bi=()=>{const t=T||(j==null?void 0:j.shopId)||"main";return`wallets_${(s==null?void 0:s.uid)||"default"}_${t}`},wr=()=>{const t=T||(j==null?void 0:j.shopId)||"main";return`selectedWallet_${(s==null?void 0:s.uid)||"default"}_${t}`};n.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid))return;const{collection:a,query:r,where:l,orderBy:o,limit:m,onSnapshot:x}=await gt(async()=>{const{collection:f,query:v,where:P,orderBy:$,limit:E,onSnapshot:X}=await import("./index-B57-Wohm.js").then(rt=>rt.bK);return{collection:f,query:v,where:P,orderBy:$,limit:E,onSnapshot:X}},__vite__mapDeps([0,1]),import.meta.url),{db:p}=await gt(async()=>{const{db:f}=await import("./index-B57-Wohm.js").then(v=>v.bL);return{db:f}},__vite__mapDeps([0,1]),import.meta.url),S=r(a(p,"userTransactions"),l("userId","==",s.uid),o("createdAt","desc"),m(100));t=x(S,f=>{pl||ad(!0);const P=f.docs.map(le=>{var vs;const me=le.data(),Os=(vs=me.createdAt)!=null&&vs.toDate?me.createdAt.toDate():new Date(me.createdAt),Hs=me.txnType==="send"?"send":me.txnType==="receive"?"withdraw":me.type||"withdraw",Gs=me.status==="confirmed"?"completed":me.status||"completed",$n=me.senderMsisdn||me.senderPhone||"",Le=me.receiverMsisdn||me.receiverPhone||"",$t=Number(me.amount??me.transferredAmount??me.withdrawnAmount??0);return{id:le.id,...me,type:Hs,status:Gs,senderPhone:$n,receiverPhone:Le,amount:$t,createdAt:Os}}).filter(le=>!((le==null?void 0:le.type)==="report"||String((le==null?void 0:le.title)||"").includes("إيصال تسليم وردية"))),$=new Set((Qr||[]).map(le=>String(le.id||le.originalTransactionId||""))),E=P.filter(le=>!$.has(String(le.id||""))),X=le=>{var me;return String(le.transactionId||le.id||le.reference||((me=le.receipt)==null?void 0:me.reference)||`${new Date(le.createdAt).getTime()}`)},rt=new Set,Re=[];for(const le of E){const me=X(le);rt.has(me)||(rt.add(me),Re.push(le))}da(Re)})}catch{}})(),()=>{try{t&&t()}catch{}}},[s==null?void 0:s.uid,Qr.length]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;let t=null;return(async()=>{try{const{collection:a,query:r,where:l,onSnapshot:o}=await gt(async()=>{const{collection:p,query:S,where:f,onSnapshot:v}=await import("./index-B57-Wohm.js").then(P=>P.bK);return{collection:p,query:S,where:f,onSnapshot:v}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await gt(async()=>{const{db:p}=await import("./index-B57-Wohm.js").then(S=>S.bL);return{db:p}},__vite__mapDeps([0,1]),import.meta.url),x=r(a(m,"deletedTransactions"),l("userId","==",s.uid));t=o(x,p=>{try{p.docChanges().forEach(f=>{const v=f.doc.data(),P=[v.originalTransactionId,v.transactionId,v.reference,f.doc.id].filter(Boolean).map(X=>String(X));if(P.find(X=>gl.current.has(X)))return;const E=fl.current.find(X=>{const rt=String(X.id||""),Re=String(X.transactionId||""),le=String(X.reference||"");return P.includes(rt)||P.includes(Re)||P.includes(le)});if(E){const X=E.fromWallet||Z||"",rt=Number(E.withdrawnAmount??E.sentAmount??E.amount??0),Re=E.type==="send"?"transfer":"withdraw";X&&rt>0&&(ra.rollbackUsage(X,rt,Re).catch(()=>{}),P.forEach(le=>gl.current.add(le)))}});const S=p.docs.map(f=>{var $;const v=f.data(),P=($=v.createdAt)!=null&&$.toDate?v.createdAt.toDate():new Date(v.createdAt||Date.now());return{id:f.id,...v,createdAt:P}});Qa(S),(async()=>{try{const f=T||(j==null?void 0:j.shopId);if(!f)return;const v=ze(m,"dashboardData",f),P=await fa(v);if(P.exists()){const $=P.data();typeof $.cashBalance=="number"&&Ut(Number($.cashBalance||0)),$.walletBalances&&typeof $.walletBalances=="object"&&rs($.walletBalances||{})}}catch{}})()}catch{}},p=>{console.warn("deletedTransactions subscription error (Dashboard):",p)})}catch{}})(),()=>{try{t&&t()}catch{}}},[s==null?void 0:s.uid]);const[Ui,Nn]=n.useState(""),[_s,xo]=n.useState(""),aa=Ve.useMemo(()=>{const t=ts;if(!t)return!1;const a=sh(t),r=t.planType??t.plan??null,l=typeof r=="string"?r.toLowerCase():null,o=l==="monthly"||l==="quarterly"||l==="yearly"||l==="lifetime"||r===ws.MONTHLY||r===ws.QUARTERLY||r===ws.YEARLY||r===ws.LIFETIME;return a&&o},[ts]),bt=Ve.useMemo(()=>{var l,o;const t=ts;if(!t)return!1;const a=((l=t.subscription)==null?void 0:l.planType)??((o=t.subscription)==null?void 0:o.plan)??t.planType??t.plan??null,r=typeof a=="string"?a.toLowerCase():null;return a===ws.ZERO||r==="zero"},[ts]),Rt=Ve.useMemo(()=>{var l,o;const t=ts;if(!t)return!1;const a=((l=t.subscription)==null?void 0:l.planType)??((o=t.subscription)==null?void 0:o.plan)??t.planType??t.plan??null,r=typeof a=="string"?String(a).trim().toLowerCase():null;return a===ws.TAHWEELA||r==="tahweela"||r==="تحويله"},[ts]),lm=()=>{if(!aa){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}te(!0)},[Bu,Uu]=n.useState(!1),[om,cm]=n.useState(!1),[dm,mm]=n.useState(!1),[hm,um]=n.useState(!1),[xm,Nr]=n.useState(!1),[za,jn]=n.useState(""),[jr,Sn]=n.useState(""),[po,Dn]=n.useState(!1),[Sr,Dr]=n.useState(null),[zi,Cn]=n.useState(""),[pm,go]=n.useState(!1),[zu,qu]=n.useState(!1),[gm,In]=n.useState(!1),[fo,qi]=n.useState(""),[yo,Vi]=n.useState(""),[bo,vo]=n.useState(!1),wo=async()=>{if(s!=null&&s.uid)try{const t=`userData_${s.uid}`,a=localStorage.getItem(t),r=`debts_unsynced_${s.uid}`,l=localStorage.getItem(vn()),o=localStorage.getItem(r)==="true";if(a){const m=JSON.parse(a);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",m);const x={lastSynced:new Date().toISOString()};typeof m.cashBalance=="number"&&(x.cashBalance=m.cashBalance),m.walletBalances&&typeof m.walletBalances=="object"&&(x.walletBalances=m.walletBalances),await Te.updateUserData(s.uid,x),localStorage.removeItem(t),Je(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة");if(o&&l)try{const m=JSON.parse(l)||[];await Te.updateUserData(s.uid,{debts:m});try{localStorage.removeItem(r)}catch{}Je(!1),console.log("✅ تمت مزامنة الديون مع Firebase")}catch(m){console.error("❌ فشل مزامنة الديون:",m),Je(!0)}}catch(t){console.error("❌ فشل في مزامنة البيانات:",t),i({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},[rr,An]=n.useState({keepLastCount:30,intervalDays:7,lastResetAt:null});n.useEffect(()=>{(async()=>{if(s!=null&&s.uid)try{const a=await Te.getUserData(s.uid),r=(a==null?void 0:a.recentReset)||{},l=Number(r==null?void 0:r.keepLastCount)>0?Number(r.keepLastCount):30,o=Number(r==null?void 0:r.intervalDays)>0?Number(r.intervalDays):7,m=f=>f instanceof Date?f:typeof(f==null?void 0:f.toDate)=="function"?f.toDate():f?new Date(String(f)):null,x=r!=null&&r.lastResetAt?m(r.lastResetAt):null,p=new Date;!x||p.getTime()-x.getTime()>=o*24*60*60*1e3?(await Te.updateUserData(s.uid,{recentReset:{keepLastCount:l,intervalDays:o,lastResetAt:p}}),An({keepLastCount:l,intervalDays:o,lastResetAt:p})):An({keepLastCount:l,intervalDays:o,lastResetAt:x})}catch{An({keepLastCount:30,intervalDays:7,lastResetAt:null})}})()},[s==null?void 0:s.uid]);const No=Ve.useMemo(()=>{const t=ht||[],a=rr.keepLastCount??30;return[...t].sort((l,o)=>{const m=x=>x instanceof Date?x:typeof(x==null?void 0:x.toDate)=="function"?x.toDate():new Date(String(x));return m(o.createdAt).getTime()-m(l.createdAt).getTime()}).slice(0,a)},[ht,rr.keepLastCount]),fm=Ve.useMemo(()=>Math.max(0,((ht==null?void 0:ht.length)||0)-(rr.keepLastCount||30)),[ht==null?void 0:ht.length,rr.keepLastCount]),Tn=Ve.useMemo(()=>{const t=new Date,a=new Date(t.getFullYear(),t.getMonth(),1),r=new Date(t.getFullYear(),t.getMonth()+1,1),l={};for(const m of ht){const x=new Date(m.createdAt||0);if(!(x>=a&&x<r))continue;const p=String(m.type||m.txnType||"").toLowerCase();if(!(p==="send"||p==="withdraw"||p==="transfer"))continue;const S=String(m.receiverPhone||m.senderPhone||"").trim();if(!S)continue;const f=Ns(S),v=Number(m.amount||m.withdrawnAmount||m.sentAmount||0)||0;l[f]||(l[f]={phone:f,count:0,total:0}),l[f].count+=1,l[f].total+=v}return Object.values(l).sort((m,x)=>x.count!==m.count?x.count-m.count:x.total-m.total).slice(0,10)},[ht]),ym=t=>{const a=Ns(String(t));return a.startsWith("+20")?"20"+a.slice(3):a.startsWith("0")?"20"+a.slice(1):a.replace(/[^0-9]/g,"")},bm=t=>{const a=ym(t.phone),r=`عميل VIP هذا الشهر
عدد العمليات: ${t.count}
الإجمالي: ${t.total} جنيه`,l=`https://wa.me/${a}?text=${encodeURIComponent(r)}`;try{window.open(l,"_blank")}catch{}};n.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid))return;const t=`${new Date().getFullYear()}-${new Date().getMonth()+1}`;await Te.updateUserData(s.uid,{vipTop10:Tn,vipMonthTag:t})}catch{}})()},[s==null?void 0:s.uid,Tn]);async function vm(){const t=new Date,a=new Intl.DateTimeFormat("ar-EG",{timeZone:"Africa/Cairo",year:"numeric",month:"2-digit",day:"2-digit"}).format(t),r=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0,0),l=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59,999),o=(ht||[]).filter(E=>{const X=new Date(E.createdAt||0);return X>=r&&X<=l}),m=o.length,x=o.filter(E=>String(E.type||E.txnType||"").toLowerCase()==="withdraw"||String(E.type||"").toLowerCase()==="receive").reduce((E,X)=>E+(X.withdrawnAmount!=null?Number(X.withdrawnAmount):Number(X.amount||0)),0),p=o.filter(E=>String(E.type||E.txnType||"").toLowerCase()==="send"||String(E.type||"").toLowerCase()==="transfer").reduce((E,X)=>E+(X.sentAmount!=null?Number(X.sentAmount):Number(X.amount||0)),0);let S=0;try{S=o.reduce((E,X)=>E+us.calculateTransactionProfit(X),0)}catch{}let f=0;try{const E=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(t),X=He(De(K,"dailySales"),je("userId","==",(s==null?void 0:s.uid)||""));f=(await it(X)).docs.map(le=>le.data()).filter(le=>String(le.date||E)===E).reduce((le,me)=>le+Number(me.sellingPrice||me.price||0)*Number(me.quantity||1),0)}catch{}let v=0;try{v=(Mt||[]).filter(X=>String(X.status||"")==="pending").reduce((X,rt)=>{const Re=Number(rt.paidAmount||0)+(Array.isArray(rt.partialPayments)?rt.partialPayments:[]).reduce((le,me)=>le+Number(me.amount||0),0);return X+Math.max(0,Number(rt.amount||0)-Re)},0)}catch{}let P="";try{const E=T||(j==null?void 0:j.shopId)||null,X=E?He(De(K,"deficiencies"),je("shopId","==",E)):He(De(K,"deficiencies"),je("userId","==",(s==null?void 0:s.uid)||""));P=(await it(X)).docs.map(me=>me.data()).filter(me=>String(me.status||"pending")==="pending").slice(0,10).map((me,Os)=>`${Os+1}- ${String(me.name||me.productName||"عنصر")} × ${Number(me.quantity||me.qty||0)}`).join(`
`)}catch{}return[`تقرير يومي - ${a}`,`عدد العمليات: ${m}`,`إجمالي المسحوبات: ${x} جنيه`,`إجمالي الإرسال: ${p} جنيه`,`الأرباح: ${S} جنيه`,`إجمالي مبيعات الاكسسوار: ${f} جنيه`,`إجمالي الديون: ${v} جنيه`,"نواقص الاكسسوار:",P||"لا توجد عناصر مسجلة"].join(`
`)}const jo=Ve.useCallback(()=>{let t=No;const a=vl.trim();if(a&&(t=t.filter(r=>{const l=r;return String(l.type||"").toLowerCase()==="cash_addition"||String(l.txnType||"").toLowerCase()==="cash_addition"||String(l.title||"").includes("إيصال إضافة نقدية")?!0:r.senderPhone&&r.senderPhone.includes(a)||r.receiverPhone&&r.receiverPhone.includes(a)})),Zr){const r=new Date(Zr);t=t.filter(l=>{const o=new Date(l.createdAt);if(Xr){const[m,x]=Xr.split(":"),p=new Date(r);p.setHours(parseInt(m),parseInt(x),0,0);const S=new Date(p);return S.setHours(S.getHours()+1),o>=p&&o<S}else return o.toDateString()===r.toDateString()})}try{t=[...t].sort((r,l)=>{const o=new Date(r.createdAt||0).getTime();return new Date(l.createdAt||0).getTime()-o})}catch{}return t},[No,vl,Zr,Xr]),[wm,Pn]=n.useState(!1),[So,kn]=n.useState(""),[Nm,_n]=n.useState(!1),[Ki,Ji]=n.useState(""),[jm,Je]=n.useState(!1),Cr=async(t,a=2,r=700)=>{let l;for(let o=0;o<=a;o++)try{return await t()}catch(m){if(l=m,o===a)break;await new Promise(x=>setTimeout(x,r*Math.pow(2,o)))}throw l};Ye.reduce((t,a)=>t+(Xe[a.id]||0),0);const Sm=async t=>await ps.verifyMasterPin(t,s==null?void 0:s.uid),On=async t=>await ps.verifyMasterPin(t,s==null?void 0:s.uid);n.useEffect(()=>{if(s!=null&&s.uid){try{const t=ys(),a=`walletBalances_${s.uid}`,r=localStorage.getItem(t)??localStorage.getItem(a);if(r){const l=JSON.parse(r);rs(l&&typeof l=="object"?l:{});try{localStorage.setItem(t,JSON.stringify(l||{}))}catch{}}}catch{}try{const t=bs(),a=`cashBalance_${s.uid}`,r=`userCashBalance_${s.uid}`;let l=localStorage.getItem(t)??localStorage.getItem(a)??localStorage.getItem(r);if(l!=null){const o=parseFloat(l);Ut(Number.isFinite(o)?o:0);try{localStorage.setItem(t,String(Number.isFinite(o)?o:0)),localStorage.removeItem(a),localStorage.removeItem(r)}catch{}}}catch{}}},[s==null?void 0:s.uid,T,j==null?void 0:j.shopId]),n.useEffect(()=>{const t=a=>{var r;try{const l=Number((r=a==null?void 0:a.detail)==null?void 0:r.value);if(Number.isFinite(l))Ut(l);else{const o=localStorage.getItem(bs());o!=null&&Ut(parseFloat(o)||0)}}catch{const l=localStorage.getItem(bs());l!=null&&Ut(parseFloat(l)||0)}};return window.addEventListener("cashBalanceChanged",t),()=>window.removeEventListener("cashBalanceChanged",t)},[s==null?void 0:s.uid,T,j==null?void 0:j.shopId]),n.useEffect(()=>{try{if(!(s!=null&&s.uid))return;const t=T||(j==null?void 0:j.shopId);if(!t)return;const a=ze(K,"dashboardData",t);let r=null;return r=Ms(a,l=>{if(!l.exists())return;const o=l.data(),m=Number((o==null?void 0:o.cashBalance)||0),x=o!=null&&o.walletBalances&&typeof o.walletBalances=="object"?o.walletBalances:{};Ut(m),rs(x);try{localStorage.setItem(bs(),String(m)),localStorage.setItem(ys(),JSON.stringify(x))}catch{}},l=>{console.warn("dashboardData subscription error:",l)}),()=>{try{r&&r()}catch{}}}catch{}},[s==null?void 0:s.uid,T,j==null?void 0:j.shopId]);const Do=t=>`walletLimits_${(s==null?void 0:s.uid)||"default"}_${t||"none"}`;n.useEffect(()=>{if(!Z)return;try{const r=Do(Z),l=localStorage.getItem(r);if(l){const o=JSON.parse(l);Ai(o)}}catch{}const t=ze(K,"walletLimits",String(Z));let a=null;try{a=Ms(t,r=>{if(!r.exists())return;const l=r.data(),o={walletId:Z,dailyTransferLimit:l.dailyTransferLimit??6e4,dailyWithdrawLimit:l.dailyWithdrawLimit??1e5,dailyTransferUsed:l.dailyTransferUsed??0,dailyWithdrawUsed:l.dailyWithdrawUsed??0,monthlyTransferLimit:l.monthlyTransferLimit??2e5,monthlyWithdrawLimit:l.monthlyWithdrawLimit??2e5,monthlyTransferUsed:l.monthlyTransferUsed??0,monthlyWithdrawUsed:l.monthlyWithdrawUsed??0};Ai(o);try{localStorage.setItem(Do(Z),JSON.stringify(o))}catch{}})}catch{}return()=>{a&&a()}},[Z]),n.useEffect(()=>{if(!Z)return;const t=Ye.find(a=>a.id===Z);if(t!=null&&t.name){Xl(String(t.name));try{localStorage.setItem(`walletName_${(s==null?void 0:s.uid)||"default"}_${Z}`,String(t.name))}catch{}return}try{const a=localStorage.getItem(`walletName_${(s==null?void 0:s.uid)||"default"}_${Z}`);a&&Xl(String(a))}catch{}},[Z,Ye]);const Co=async()=>{try{if(!Z)return;const t=await ra.autoResetLimitsIfNeeded(Z);Ai(t)}catch(t){console.error("خطأ في جلب حدود المحفظة المختارة:",t)}};n.useEffect(()=>{Co()},[Z]),n.useEffect(()=>{const t=a=>{var r;(r=a==null?void 0:a.detail)!=null&&r.walletId&&a.detail.walletId===Z&&Co()};return window.addEventListener("walletLimitsUpdated",t),()=>window.removeEventListener("walletLimitsUpdated",t)},[Z]),n.useEffect(()=>{if(D.state){if(console.log("Location state:",D.state),D.state.openDebtDialog&&(fi(),window.history.replaceState({},document.title)),D.state.openSalesDialog&&(bt||Rt?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):mr(!0),window.history.replaceState({},document.title)),D.state.openMaintenanceDialog&&(bt||Rt?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):sn(!0),window.history.replaceState({},document.title)),D.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),bt||Rt?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):tn(!0),window.history.replaceState({},document.title)),D.state.openShopExpensesDialog&&(bt||Rt?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ps.hasMasterPin()?Gt(!0):At(!0),window.history.replaceState({},document.title)),D.state.openDeficienciesDialog&&(bt||Rt?i({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):wa(!0),window.history.replaceState({},document.title)),D.state.openInstallment&&(bt||Rt?i({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"}):en(!0),window.history.replaceState({},document.title)),D.state.openTransactionSection){const t=document.getElementById("transaction-section");t&&t.scrollIntoView({behavior:"smooth"}),D.state.transactionType&&cl(D.state.transactionType),D.state.startNewTransaction&&(ja(""),d(""),Hn(""),Gn(""),console.log("🔒 Starting new transaction without changing wallet selection")),D.state.focusWalletSelection&&setTimeout(()=>{const a=document.querySelector('[data-testid="wallet-select"]');a&&a.focus()},500),window.history.replaceState({},document.title)}D.state.openCashierShiftModal&&(!aa||Rt?i({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):te(!0),window.history.replaceState({},document.title)),D.state.openMachineDailyDialog&&(!aa||Rt?i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):an(!0),window.history.replaceState({},document.title))}},[D.state,Ye,Rt]),n.useEffect(()=>{D.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),Ir(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",D.pathname)},[D.pathname,s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;console.log("🔥 Setting up real-time user activation listener for:",s.uid);const t=ze(K,"users",s.uid),a=Ms(t,r=>{if(r.exists()){const l=r.data(),o=l.isActive===!0;console.log("🔥 Real-time user status update:",{userId:s.uid,isActive:o,subscription:l.subscription}),o&&!kt?(console.log("🎉 User activated! Redirecting to dashboard..."),_t(!0),Zt(!1),et(!1)):!o&&kt&&(console.log("❌ User deactivated! Showing activation modal..."),_t(!1),Zt(!0))}},r=>{console.error("❌ Error in real-time user listener:",r)});return()=>{console.log("🔥 Cleaning up real-time user listener"),a()}},[s==null?void 0:s.uid,kt]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;const t=r=>{const{userId:l}=r.detail;l===s.uid&&(console.log("🎉 Subscription activation event received for current user!"),_t(!0),Zt(!1),et(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},a=r=>{const{userId:l,isActive:o}=r.detail;l===s.uid&&(console.log("🔄 User subscription update event received:",{userId:l,isActive:o}),o&&!kt&&(_t(!0),Zt(!1),et(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",t),window.addEventListener("userSubscriptionUpdated",a),()=>{window.removeEventListener("subscriptionActivated",t),window.removeEventListener("userSubscriptionUpdated",a)}},[s==null?void 0:s.uid,kt]),n.useEffect(()=>{const t=a=>{var m;const r=a.target,l=(m=r==null?void 0:r.tagName)==null?void 0:m.toLowerCase();if(!(l==="input"||l==="textarea"||l==="select"||((r==null?void 0:r.isContentEditable)??!1))&&!(a.ctrlKey||a.altKey||a.metaKey)&&!a.repeat){if((bt||Rt)&&a.key>="1"&&a.key<="9"){a.preventDefault();return}switch(a.key){case"1":break;case"2":ri(!0);break;case"3":bt||Rt?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):tn(!0);break;case"4":aa?te(!0):i({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"5":bt||Rt?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):mr(!0);break;case"6":fi();break;case"7":bt||Rt?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):sn(!0);break;case"8":aa?an(!0):i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"9":bt||Rt?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ps.hasMasterPin()?Gt(!0):At(!0);break}}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[bt,Rt,aa]),n.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:s==null?void 0:s.uid,isCheckingActivation:Nt}),(async()=>{try{if(!(s!=null&&s.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),et(!1);return}try{const m=await fa(ze(K,"users",s.uid));if(m.exists()){const p=m.data().isActive===!0,S=await Rr.checkTrialValidity(s.uid),f=S.isValid&&!S.isExpired;_t(p||f),os(f),Na(S.hoursRemaining),$a(S.hasUsedTrial),Zt(!p&&!f),console.log("📊 حالة المستخدم:",{isActive:p,isOnTrial:f,hoursRemaining:S.hoursRemaining,hasUsedTrial:S.hasUsedTrial})}else _t(!1),Zt(!0)}catch(m){console.error("خطأ في فحص حالة تفعيل المستخدم:",m),_t(!1),Zt(!0)}finally{et(!1)}if(console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:s==null?void 0:s.uid}),s!=null&&s.uid){const m=await Cr(()=>Te.getUserData(s.uid));if(m){const x=(m==null?void 0:m.walletBalances)||{};rs(x),(m==null?void 0:m.cashBalance)!==void 0&&Ut(m.cashBalance);try{const p=s!=null&&s.uid?await Cr(()=>$r.getDeletedTransactionsByUser(s.uid)):[];Qa(p||[])}catch{Qa([])}}else{rs({});try{const x=s!=null&&s.uid?await $r.getDeletedTransactionsByUser(s.uid):[];Qa(x||[])}catch{Qa([])}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const m=await Cr(()=>Xs.getByMerchantId((s==null?void 0:s.uid)||""));if(m&&m.length>0){console.log("✅ تم العثور على محافظ في Firebase:",m.length);const p=m.filter(v=>v.isActive===!0).map(v=>({id:v.id,name:v.label||"محفظة بدون اسم",phone:v.msisdn,isDefault:!1,monthlyWithdrawalLimit:v.monthlyWithdrawalLimit??v.withdrawLimit??2e5,monthlyTransferLimit:v.monthlyTransferLimit??v.transferLimit??2e5,defaultTransferCommission:v.defaultTransferCommission!=null?Number(v.defaultTransferCommission):null,defaultWithdrawCommission:v.defaultWithdrawCommission!=null?Number(v.defaultWithdrawCommission):null}));hr(p);const S=localStorage.getItem(wr());let f=null;S&&p.find(v=>v.id===S)?f=p.find(v=>v.id===S):f=p[0],f&&(ei(f.id),La(f.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else console.log("⚠️ لا توجد محافظ في Firebase. سيتم عرض قائمة فارغة بدون أي استرجاع محلي."),hr([])}catch(m){console.error("خطأ في تحميل المحافظ من Firebase:",m),hr([])}const o=s!=null&&s.uid?await Cr(()=>Te.getUserTransactions(s.uid)):[];if(o&&o.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",o.length);const m=o.map(v=>({...v,createdAt:new Date(v.createdAt),senderPhone:v.senderMsisdn||v.senderPhone||"",receiverPhone:v.receiverMsisdn||v.receiverPhone||"",type:v.txnType==="send"?"send":v.txnType==="receive"?"withdraw":v.type||"withdraw",status:v.status==="confirmed"?"completed":v.status||"completed"})),x=Qr.map(v=>v.id||v.originalTransactionId);let p=[];try{const v=He(De(K,"deletedTransactions"),je("userId","==",(s==null?void 0:s.uid)||""),je("permanent","==",!0));p=(await it(v)).docs.map($=>{const E=$.data();return String(E.originalTransactionId||E.transactionId||$.id||"")}).filter(Boolean)}catch{}const S=new Set(p),f=m.filter(v=>{var Re;const P=String(v.id||""),$=String(v.transactionId||""),E=String(v.reference||v.transactionReference||((Re=v.receipt)==null?void 0:Re.reference)||""),X=x.includes(P),rt=S.has(P)||$&&S.has($);return!X&&!rt});console.log("✅ تم فلترة المعاملات المحذوفة:",{total:o.length,deleted:x.length,active:f.length});{const v=E=>{var X;return String((E==null?void 0:E.transactionId)||(E==null?void 0:E.id)||`${(E==null?void 0:E.transactionReference)||((X=E==null?void 0:E.receipt)==null?void 0:X.reference)||"ref"}-${new Date((E==null?void 0:E.createdAt)||0).getTime()}`)},P=new Set,$=[];for(const E of f){const X=v(E);P.has(X)||(P.add(X),$.push(E))}pl||da($)}}await wo()}catch(o){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",o)}})().then(async()=>{await l(),await a(),await r()});const a=async()=>{try{if(!(s!=null&&s.uid))return;const o=await Xs.getByMerchantId(s.uid);await Promise.all(o.map(m=>Jh.autoResetLimitsIfNeeded(m.id)))}catch(o){console.error("خطأ في التصفير التلقائي للحدود:",o)}},r=async()=>{try{await us.syncReportsDataFromFirebase(s==null?void 0:s.uid);const o=us.getReportsData(s==null?void 0:s.uid);if((o.lastDailyResetDate?us.shouldResetDailyReports(o.lastDailyResetDate):!1)&&(s!=null&&s.uid)&&o.lastDailyResetDate){const p=new Date(o.lastDailyResetDate),S=p.toDateString(),f=ht.filter(Re=>new Date(Re.createdAt).toDateString()===S&&Re.status==="completed"),v=f.length,P=f.reduce((Re,le)=>Re+le.amount,0),$=f.filter(Tr).reduce((Re,le)=>{const me=le.withdrawnAmount!==void 0?le.withdrawnAmount:le.amount;return Re+me},0),E=f.filter(Pr).reduce((Re,le)=>{const me=le.sentAmount!==void 0?le.sentAmount:le.amount;return Re+me},0),X=f.reduce((Re,le)=>Re+us.calculateTransactionProfit(le),0),rt=new Date(p).toISOString().slice(0,10);await Er.add({userId:s.uid,reportDate:rt,totalTransactions:v,totalAmount:Number(P.toFixed(2)),totalWithdrawn:Number($.toFixed(2)),totalSent:Number(E.toFixed(2)),profit:Number(X.toFixed(2)),walletId:null})}const x=us.autoResetReportsIfNeeded(s==null?void 0:s.uid);(x.dailyReset||x.monthlyReset)&&console.log("تم التصفير التلقائي:",x)}catch(o){console.error("خطأ في التصفير التلقائي للتقارير:",o)}},l=async()=>{try{if(!(s!=null&&s.uid))return;const o=new Date;if(o.getDate()!==1)return;const m=`${o.getFullYear()}-${o.getMonth()+1}`,x=`lastMonthlyDbCleanup:${s.uid}`;if(localStorage.getItem(x)===m)return;const S=new Date(o.getFullYear(),o.getMonth(),1,0,0,0,0),f=$=>$ instanceof Date?$:typeof($==null?void 0:$.toDate)=="function"?$.toDate():new Date(String($));let v=[];try{const $=He(De(K,"userTransactions"),je("userId","==",s.uid),je("createdAt","<",S));v=(await it($)).docs}catch{const $=He(De(K,"userTransactions"),je("userId","==",s.uid));v=(await it($)).docs.filter(X=>{var rt;return f((rt=X.data())==null?void 0:rt.createdAt)<S})}await Promise.allSettled(v.map($=>js($.ref)));let P=[];try{const $=He(De(K,"transactions"),je("userId","==",s.uid),je("createdAt","<",S));P=(await it($)).docs}catch{const $=He(De(K,"transactions"),je("userId","==",s.uid));P=(await it($)).docs.filter(X=>{var rt;return f((rt=X.data())==null?void 0:rt.createdAt)<S})}await Promise.allSettled(P.map($=>js($.ref)));try{localStorage.setItem(x,m)}catch{}console.log("✅ تم تنظيف قاعدة البيانات شهريًا (Firebase فقط):",{userTransactionsDeleted:v.length,globalTransactionsDeleted:P.length,monthStart:S})}catch(o){console.error("فشل التنظيف الشهري التلقائي لقاعدة البيانات:",o)}};Kd(),zd(),im(),console.log("🔥 useEffect loadUserData completed")},[s==null?void 0:s.uid]);const Ir=async()=>{var t;if(s!=null&&s.uid)try{const a=await Cr(()=>Xs.getByMerchantId(s.uid));if(a&&a.length>0){const l=a.filter(o=>o.isActive===!0).map(o=>({id:o.id,name:o.label||"محفظة بدون اسم",phone:o.msisdn,isDefault:!1,monthlyWithdrawalLimit:o.monthlyWithdrawalLimit??o.withdrawLimit??2e5,monthlyTransferLimit:o.monthlyTransferLimit??o.transferLimit??2e5,defaultTransferCommission:o.defaultTransferCommission!=null?Number(o.defaultTransferCommission):void 0,defaultWithdrawCommission:o.defaultWithdrawCommission!=null?Number(o.defaultWithdrawCommission):void 0}));if(hr(l),s!=null&&s.uid){const o=localStorage.getItem(wr());if(!!(Z&&l.find(x=>x.id===Z)))console.log("🔒 Preserving current wallet selection:",Z);else{const p=(o&&l.find(S=>S.id===o)?o:null)||((t=l[0])==null?void 0:t.id);p&&(console.log("🔄 Fixing invalid wallet selection:",p),Ar(p))}}console.log("🔄 تم تحديث المحافظ من Firebase:",l.length)}}catch(a){console.error("خطأ في تحميل المحافظ من Firebase:",a)}};n.useEffect(()=>{const t=D.pathname;sessionStorage.getItem("previousPath")==="/user/add-wallet"&&t==="/user/dashboard"&&(console.log("🔄 Returning from add wallet page - reloading wallets"),console.log("🔒 Current wallet before add-wallet return reload:",Z),Ir(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",t)},[D.pathname,s==null?void 0:s.uid]),n.useEffect(()=>{const t=()=>{console.log("🔄 Window focused - reloading wallets"),console.log("🔒 Current wallet before focus reload:",Z),Ir().then(()=>{console.log("🔒 Wallet preserved after focus reload:",Z)})};return window.addEventListener("focus",t),()=>{window.removeEventListener("focus",t)}},[s==null?void 0:s.uid,Z,Ye]);const Ar=(t,a="unknown")=>{console.log(`🎯 setWalletSelection called from ${a} with walletId:`,t),console.log("🔍 Previous selectedWallet:",Z),ei(t);const r=Ye.find(l=>l.id===t);r&&(La(r.phone),console.log("✅ Wallet set successfully:",t,"Phone:",r.phone)),s!=null&&s.uid&&(localStorage.setItem(wr(),t),console.log("💾 Saved wallet to localStorage:",t))};n.useEffect(()=>{const t=()=>{Ir()};try{window.addEventListener("wallets:activation-updated",t)}catch{}return()=>{try{window.removeEventListener("wallets:activation-updated",t)}catch{}}},[s==null?void 0:s.uid]);const Dm=t=>{if(t==="__add_wallet"){O("/user/add-wallet");return}if(t==="__view_wallets"){or(!0);return}Th.isEnabled(s==null?void 0:s.uid)?(Yn(t),cr(!0)):Ar(t,"walletSelectionNoPin")},En=t=>{console.log("🔄 handleTransactionTypeChange called with type:",t),console.log("🔍 Current selectedWallet before change:",Z),console.log("🔍 Available wallets count:",Ye.length),cl(t),ja(""),d(""),Hn(""),Gn(""),console.log("✅ Transaction type changed to:",t,"- Wallet selection preserved:",Z),setTimeout(()=>{const a=document.getElementById("transaction-section");a&&a.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)};n.useEffect(()=>{const t=a=>{const r=a.target;if(!!r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"||r.tagName==="SELECT"||r.isContentEditable)||(a.key==="ArrowLeft"?(a.preventDefault(),En("withdraw")):a.key==="ArrowRight"&&(a.preventDefault(),En("transfer"))),a.key==="Enter"){const o=ne==="transfer"?"transferSubmitButton":"withdrawSubmitButton",m=document.getElementById(o);m&&!m.disabled&&(a.preventDefault(),m.click())}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[ne]);const Io=t=>{ed((r=>({id:r.id,type:r.type==="send"?"transfer":"withdraw",sender_msisdn:r.senderPhone,receiver_msisdn:r.receiverPhone,amount:r.amount,commission:r.commission||0,fee:(r==null?void 0:r.fee)??0,status:r.status==="failed"?"failed":r.status==="completed"?"completed":"pending",createdAt:new Date(r.createdAt).toISOString(),updatedAt:new Date(r.createdAt).toISOString(),shopName:J??(j==null?void 0:j.shopName)??(s==null?void 0:s.displayName)??"المحل",cashierName:(r==null?void 0:r.cashierName)??null,commissionMode:(r==null?void 0:r.commissionMode)??(r.type==="send"||pt?"add":"deduct"),totalCharged:(r==null?void 0:r.totalCharged)??(r.type==="send"?Number(r.amount||0)+Number(r.commission||0)+Number((r==null?void 0:r.fee)||0):pt?Number(r.amount||0)+Number(r.commission||0):Number(r.amount||0)),note:(r==null?void 0:r.note)??(r==null?void 0:r.notes)??void 0}))(t)),Gr(!0)},Cm=async t=>{var o;if(!(s!=null&&s.uid)){i({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const a=ht.find(m=>m.id===t);if(!a){i({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}const r=String(t),l=String((a==null?void 0:a.transactionId)||(a==null?void 0:a.reference)||"");Da.current.add(r),l&&Da.current.add(l);try{console.log("🗑️ بدء عملية حذف المعاملة:",t),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:a.id,userId:s.uid,transactionData:a}),await Te.removeUserTransaction(s.uid,a.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await $r.saveDeletedTransaction({...a,userId:s.uid,originalTransactionId:a.id,transactionId:a.transactionId||a.id,reference:a.reference||a.transactionReference||((o=a.receipt)==null?void 0:o.reference),deletedAt:new Date().toISOString(),permanent:!0}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(p){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",p)}try{await $r.permanentlyDeleteTransaction(a.id,s.uid)}catch(p){console.warn("⚠️ فشل وسم الحذف النهائي أو التنظيف الإضافي:",p)}const m=[...Qr,a],x=ht.filter(p=>p.id!==t);Qa(m),da(x),ul(!1),console.log("✅ تم تحديث الحالة بعد الحذف من Firebase (بدون نسخ محلية)");try{const p=a.fromWallet;if(p){const{walletDailyLimitsService:S}=await gt(async()=>{const{walletDailyLimitsService:v}=await import("./walletDailyLimitsService-C0svnn_N.js");return{walletDailyLimitsService:v}},__vite__mapDeps([3,0,1]),import.meta.url),f=await S.getWalletLimits(p);if(f){const v=a.type==="send",P={updatedAt:(await gt(async()=>{const{serverTimestamp:Re}=await import("./index-B57-Wohm.js").then(le=>le.bK);return{serverTimestamp:Re}},__vite__mapDeps([0,1]),import.meta.url)).serverTimestamp()};v?(P.dailyTransferUsed=Math.max(0,(f.dailyTransferUsed||0)-a.amount),P.monthlyTransferUsed=Math.max(0,(f.monthlyTransferUsed||0)-a.amount)):(P.dailyWithdrawUsed=Math.max(0,(f.dailyWithdrawUsed||0)-a.amount),P.monthlyWithdrawUsed=Math.max(0,(f.monthlyWithdrawUsed||0)-a.amount));const{doc:$,setDoc:E}=await gt(async()=>{const{doc:Re,setDoc:le}=await import("./index-B57-Wohm.js").then(me=>me.bK);return{doc:Re,setDoc:le}},__vite__mapDeps([0,1]),import.meta.url),{db:X}=await gt(async()=>{const{db:Re}=await import("./index-B57-Wohm.js").then(le=>le.bL);return{db:Re}},__vite__mapDeps([0,1]),import.meta.url),rt=$(X,"walletLimits",p);await E(rt,P,{merge:!0})}}}catch(p){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",p)}try{const{ProfitService:p}=await gt(async()=>{const{ProfitService:$}=await import("./profitService-CxuHBzDm.js").then(E=>E.p);return{ProfitService:$}},__vite__mapDeps([4,0,1]),import.meta.url),{ReportsService:S}=await gt(async()=>{const{ReportsService:$}=await import("./profitService-CxuHBzDm.js").then(E=>E.a);return{ReportsService:$}},__vite__mapDeps([4,0,1]),import.meta.url),v={txnType:a.type==="send"?"send":"receive",amount:a.amount,commission:a.commission||0,createdAt:a.createdAt,status:"confirmed"},P=p.calculateProfitFromTransaction(v);P>0&&p.addProfit(-P,s.uid);try{S.removeTransactionEffects(a,s.uid)}catch{}}catch(p){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",p)}i({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(m){console.error("❌ خطأ في حذف المعاملة من Firebase:",m);let x="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";m instanceof Error&&(m.message.includes("network")||m.message.includes("offline")?x="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":m.message.includes("permission")||m.message.includes("unauthorized")?x="ليس لديك صلاحية لحذف هذه المعاملة":m.message.includes("not-found")&&(x="المعاملة غير موجودة أو تم حذفها مسبقاً")),i({title:"خطأ في الحذف",description:x,variant:"destructive"})}},Tr=t=>{const a=t.type,r=t.txnType;return a==="withdraw"||a==="withdrawal"||a==="receive"||r==="receive"},Pr=t=>{const a=t.type,r=t.txnType;return a==="send"||a==="transfer"||r==="send"},kr=(t,a)=>{const r=new Date().toDateString();let l=ht.filter(f=>new Date(f.createdAt).toDateString()===r&&f.status==="completed");ha&&ha.trim()!==""&&(l=l.filter(f=>f.senderPhone&&f.senderPhone.includes(ha)||f.receiverPhone&&f.receiverPhone.includes(ha)));const o=us.filterVisibleTransactions(l,"daily",s==null?void 0:s.uid),m=o.length,x=o.reduce((f,v)=>f+v.amount,0),p=o.filter(Tr).reduce((f,v)=>{const P=v.withdrawnAmount!==void 0?v.withdrawnAmount:v.amount;return f+P},0),S=o.filter(Pr).reduce((f,v)=>{const P=v.sentAmount!==void 0?v.sentAmount:v.amount;return f+P},0);return{totalTransactions:m,totalAmount:x,totalWithdrawn:p,totalSent:S}},_r=t=>{const a=new Date().getMonth(),r=new Date().getFullYear();let l=ht.filter(f=>{const v=new Date(f.createdAt);return v.getMonth()===a&&v.getFullYear()===r&&f.status==="completed"});ha&&ha.trim()!==""&&(l=l.filter(f=>f.senderPhone&&f.senderPhone.includes(ha)||f.receiverPhone&&f.receiverPhone.includes(ha)));const o=us.filterVisibleTransactions(l,"monthly",s==null?void 0:s.uid),m=o.length,x=o.reduce((f,v)=>f+v.amount,0),p=o.filter(Tr).reduce((f,v)=>{const P=v.withdrawnAmount!==void 0?v.withdrawnAmount:v.amount;return f+P},0),S=o.filter(Pr).reduce((f,v)=>{const P=v.sentAmount!==void 0?v.sentAmount:v.amount;return f+P},0);return{totalTransactions:m,totalAmount:x,totalWithdrawn:p,totalSent:S}},Im=t=>{const a=new Date().getMonth(),r=new Date().getFullYear(),l=ht.filter(x=>{const p=new Date(x.createdAt);return p.getMonth()===a&&p.getFullYear()===r&&x.status==="completed"&&x.fromWallet===t}),o=l.filter(Tr).reduce((x,p)=>{const S=p.withdrawnAmount||p.amount;return x+S},0),m=l.filter(Pr).reduce((x,p)=>{const S=p.sentAmount||p.amount;return x+S},0);return{totalWithdrawn:o,totalTransferred:m}},Am=t=>{const a=new Date,r=a.getDate(),l=a.getMonth(),o=a.getFullYear(),m=ht.filter(S=>{const f=new Date(S.createdAt);return f.getDate()===r&&f.getMonth()===l&&f.getFullYear()===o&&S.status==="completed"&&S.fromWallet===t}),x=m.filter(Tr).reduce((S,f)=>{const v=f.withdrawnAmount||f.amount;return S+v},0),p=m.filter(Pr).reduce((S,f)=>{const v=f.sentAmount||f.amount;return S+v},0);return{totalWithdrawn:x,totalTransferred:p}},Ao=Ve.useMemo(()=>_r(),[ht,Z,ha]);Ao.totalWithdrawn,Ao.totalSent;const ua=Ve.useMemo(()=>Im(Z),[ht,Z]);n.useEffect(()=>{try{if(!Z||Ye.length===0)return;const t=Ye.find(E=>E.id===Z);if(!t)return;const a=(at==null?void 0:at.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,r=(at==null?void 0:at.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,l=parseFloat(ss||"0")||0,o=(ua==null?void 0:ua.totalWithdrawn)??(at==null?void 0:at.monthlyWithdrawUsed)??0,m=(ua==null?void 0:ua.totalTransferred)??(at==null?void 0:at.monthlyTransferUsed)??0,x=o+(ne==="withdraw"?l:0),p=m+(ne==="transfer"?l:0),S=.85,f=Math.floor(Math.max(a,1)*S),v=Math.floor(Math.max(r,1)*S),P=(()=>{const E=new Date;return`${E.getFullYear()}-${String(E.getMonth()+1).padStart(2,"0")}`})(),$=`monthlyLimitWarnShown:${Z}:${P}`;if(x>=f){const E=`${$}:withdraw`;if(!(localStorage.getItem(E)==="true")){ol({type:"withdraw",used:x,limit:a,walletName:t.name}),Jr(!0);try{localStorage.setItem(E,"true")}catch{}return}}if(p>=v){const E=`${$}:transfer`;if(!(localStorage.getItem(E)==="true")){ol({type:"transfer",used:p,limit:r,walletName:t.name}),Jr(!0);try{localStorage.setItem(E,"true")}catch{}return}}}catch{}},[Z,Ye,at,ua,ne,ss]);const To=async()=>{Cu(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:Ds,receiverPhone:Cs,amount:ss,transactionType:ne});const t=()=>{ne==="transfer"?Za(!0):xr(!0)},a=()=>{ne==="transfer"?Za(!1):xr(!1)};if(t(),!Ds||!ss){console.log("❌ خطأ: بيانات ناقصة"),i({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),a();return}if(ne==="transfer"&&!Cs&&!R){console.log("❌ خطأ: رقم المستقبل مفقود"),i({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),a();return}if(ne==="transfer"&&!R&&!Iu(Cs)){i({title:"رقم المستقبل غير صالح",description:"اكتب رقم صحيح مكون من 11 رقم ويبدأ بـ 015 أو 010 أو 012 أو 011",variant:"destructive"}),a();return}const r=parseFloat(ss);if(console.log("💰 المبلغ المحول:",r),r<=0){console.log("❌ خطأ: مبلغ غير صحيح"),i({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),a();return}if(bt)try{const Le=new Date,$t=Le.getFullYear(),vs=String(Le.getMonth()+1).padStart(2,"0"),ns=String(Le.getDate()).padStart(2,"0"),xa=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${$t}-${vs}-${ns}`,Qs=localStorage.getItem(xa);if((Qs&&parseInt(Qs,10)||0)>=10){i({title:"حد التأكيد اليومي",description:"باقة زيرو تسمح بـ 10 تأكيدات تحويل/سحب يومياً فقط.",variant:"destructive"}),a();return}}catch(Le){console.warn("فشل قراءة عداد تأكيدات باقة زيرو من التخزين المحلي:",Le)}const l=Ye.find(Le=>Le.id===Z);if(!l){i({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),a();return}const o=ua;if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:Z,walletName:l.name,currentWithdrawn:o.totalWithdrawn,currentTransferred:o.totalTransferred,withdrawalLimit:l.monthlyWithdrawalLimit,transferLimit:l.monthlyTransferLimit}),ne==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${o.totalWithdrawn}, المبلغ الجديد: ${r}, الحد الأقصى: ${l.monthlyWithdrawalLimit}`),o.totalWithdrawn+r>l.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),i({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${l.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${o.totalTransferred}, المبلغ الجديد: ${r}, الحد الأقصى: ${l.monthlyTransferLimit}`),o.totalTransferred+r>l.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),i({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${l.monthlyTransferLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}const m=(j==null?void 0:j.shopName)||(s==null?void 0:s.displayName)||"محل كاشي لينك",x={id:Date.now().toString(),type:ne==="transfer"?"send":ne==="deposit"?"deposit":"withdraw",senderPhone:Ds,receiverPhone:ne==="transfer"?Cs:Ds,amount:r,status:"completed",createdAt:new Date,withdrawnAmount:ne==="withdraw"?r:void 0,sentAmount:ne==="transfer"?r:void 0,depositedAmount:void 0,fromWallet:Z,senderNumber:Ds,senderName:Ds,shopName:(l==null?void 0:l.name)||"المحفظة الرئيسية",transferredAmount:ne==="transfer"?r:void 0,receiverNumber:ne==="transfer"?Cs:void 0,withdrawnAmountDetailed:ne==="withdraw"?r:void 0,depositedAmountDetailed:void 0,merchantShopName:m,transactionReference:`TXN-${Date.now()}`,commission:0,notes:ne==="transfer"?void 0:I&&I.trim()!==""?I.trim():void 0};g&&(N!=null&&N.name||N!=null&&N.username)&&(x.cashierName=(N==null?void 0:N.name)||(N==null?void 0:N.username));const p=ir.validateTransaction(r,ne,It,Xe);if(!p.isValid){i({title:"خطأ في العملية",description:p.error,variant:"destructive"}),a();return}p.warning&&i({title:"تحذير",description:p.warning,variant:"destructive"});let S;if(ne==="transfer")if((l==null?void 0:l.defaultTransferCommission)!=null){const Le=Number(l.defaultTransferCommission)||0;S=Math.round(Le*r/1e3*100)/100}else As&&As.trim()!==""?S=Math.max(0,parseFloat(As)):S=0;else if((l==null?void 0:l.defaultWithdrawCommission)!=null){const Le=Number(l.defaultWithdrawCommission)||0;S=Math.round(Le*r/1e3*100)/100}else Is&&Is.trim()!==""?S=Math.max(0,parseFloat(Is)):S=Math.round(r*.01*100)/100;if(x.commission=S,ne!=="transfer"&&!pt&&S>=r){i({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),a();return}const f=ne==="transfer"||pt?r:Math.round((r-S)*100)/100;x.amount=f,x.withdrawnAmount=ne==="withdraw"?f:void 0,x.sentAmount=ne==="transfer"?f:void 0,x.transferredAmount=ne==="transfer"?f:void 0,x.withdrawnAmountDetailed=ne==="withdraw"?f:void 0;let v;const P=ne==="transfer"&&!!Vt,$=ne==="withdraw"&&!!Vt,E=P||$;let X=null;const rt=Yr(Ds||"").replace(/\D/g,""),Re=Yr(Cs||"").replace(/\D/g,""),le=ne==="transfer"&&(rt.startsWith("010")&&(Re.startsWith("011")||Re.startsWith("012")||Re.startsWith("015"))||rt.startsWith("012")&&Re.startsWith("010")||rt.startsWith("011")&&Re.startsWith("010")||rt.startsWith("015")&&Re.startsWith("010")),me=le?Math.max(0,parseFloat(ll||"0")):0,Os=Math.round(S*100)/100;if(x.commission=Os,x.fee=me,x.totalCharged=ne==="transfer"?Number(f)+Number(Os)+Number(me):pt?Number(f)+Number(Os):Number(f),le&&!E&&me<=0){i({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"}),a();return}if(ne==="transfer"&&!E){const Le=Number(Xe[Z]||0),$t=Number(f)+Number(me);if(Le<$t){i({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${Le} لا يكفي لخصم ${$t}`,variant:"destructive"}),a();return}}if(E)if(P){const Le=ir.validateTransaction(f,"transfer",It,Xe);Le.isValid?v={success:!0,newCashBalance:It,newWalletBalances:Xe}:v={success:!1,newCashBalance:It,newWalletBalances:Xe,message:Le.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"}}else v={success:!0,newCashBalance:It,newWalletBalances:Xe};else ne==="transfer"?v=await ir.processTransfer({amount:f,currentCashBalance:It,currentWalletBalances:Xe,wallets:Ye,selectedWalletId:Z,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0}):v=await ir.processWithdraw({amount:f,currentCashBalance:It,currentWalletBalances:Xe,wallets:Ye,selectedWalletId:Z,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0});if(!v.success){i({title:"فشل في العملية",description:v.error||v.message,variant:"destructive"}),a();return}let Hs=E?It:v.newCashBalance,Gs=E?Xe:v.newWalletBalances;if(!E&&ne==="transfer"&&me>0){const Le=Number(Gs[Z]||0);Gs={...Gs,[Z]:Math.round((Le-Number(me))*100)/100}}if(E&&$){const Le=Ye.find(ns=>ns.id===Z)??Ye.find(ns=>ns.isDefault)??Ye[0],$t=(Le==null?void 0:Le.id)||Z;if($t!==Z)try{Ar($t)}catch{}const vs=Number(Xe[$t]||0);Gs={...Xe,[$t]:Math.round((vs+Number(f))*100)/100};try{const ns=`walletEffectsAppliedOnCreation_${(s==null?void 0:s.uid)||"default"}`,xa=localStorage.getItem(ns),Qs=xa?JSON.parse(xa):[];x!=null&&x.id&&!Qs.includes(x.id)&&(Qs.push(x.id),localStorage.setItem(ns,JSON.stringify(Qs)))}catch{}}if(E&&P){const Le=Ye.find(ns=>ns.id===Z)??Ye.find(ns=>ns.isDefault)??Ye[0],$t=(Le==null?void 0:Le.id)||Z;if($t!==Z)try{Ar($t)}catch{}const vs=Number(Xe[$t]||0);Gs={...Xe,[$t]:Math.round((vs-Number(f)-Number(me))*100)/100}}if((P||$)&&Vt&&!Wa){const Le={id:`DEBT-${Date.now()}`,debtorName:Vt.debtorName,amount:Vt.amount,reason:Vt.notes||"",customerId:Vt.customerId,mobile:Vt.mobile,status:"pending",createdAt:new Date};X=Le.id;const $t=[Le,...Mt];Ps($t);try{await zs($t)}catch(vs){console.error("⚠️ فشل حفظ الدين المؤجل محلياً:",vs)}i({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}if(!E){const Le=Math.max(0,Number(S))+Math.max(0,Number(me));Le>0&&(Hs=Math.round((Hs+Le)*100)/100,console.log(`💰 تم إضافة عمولة/رسوم ${Le} جنيه لدرج النقدية`))}console.log("⚡ تحديث الواجهة فوراً بدون حجب باستخدام startTransition...");const $n=[x,...ht];Ve.startTransition(()=>{Ut(Hs),rs(Gs),E&&(x.status="pending"),da($n)});try{setTimeout(()=>{try{localStorage.setItem(Ri(),JSON.stringify($n))}catch{}},0)}catch{}if(bt)try{const Le=new Date,$t=Le.getFullYear(),vs=String(Le.getMonth()+1).padStart(2,"0"),ns=String(Le.getDate()).padStart(2,"0"),xa=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${$t}-${vs}-${ns}`,Qs=localStorage.getItem(xa),Ln=Qs&&parseInt(Qs,10)||0;localStorage.setItem(xa,String(Ln+1))}catch{}if(setTimeout(()=>{try{localStorage.setItem(bs(),Hs.toString()),localStorage.setItem(ys(),JSON.stringify(Gs))}catch{}},0),(async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const Le={shopId:T||(j==null?void 0:j.shopId)||(s==null?void 0:s.uid)||"default-shop",lineId:Z||"default-line",walletId:Z||void 0,merchantUserId:(s==null?void 0:s.uid)||null,provider:"vodafone_cash",txnType:ne==="transfer"?"send":"receive",originType:ne==="transfer"?"transfer":"withdraw",amount:f,commission:Os,fee:me,profit:0,senderMsisdn:Ds,receiverMsisdn:ne==="transfer"?Cs:Ds,note:ne==="transfer"?void 0:I&&I.trim()!==""?I.trim():void 0,status:E?"pending":"confirmed",linkedDebtId:X||void 0,createdBy:(s==null?void 0:s.uid)||null,walletEffectAppliedOnCreation:!!(E&&$)},$t={...Le,status:E?"pending":"completed",commissionMode:ne==="transfer"||pt?"add":"deduct",totalCharged:ne==="transfer"?f+Os+me:pt?f+S:f,walletEffectAppliedOnCreation:!!(E&&$),sentAmount:ne==="transfer"?f:void 0,transferredAmount:ne==="transfer"?f:void 0,withdrawnAmount:ne==="withdraw"?f:void 0,createdAt:new Date},{ProfitService:vs}=await gt(async()=>{const{ProfitService:Lo}=await import("./profitService-CxuHBzDm.js").then(Lm=>Lm.p);return{ProfitService:Lo}},__vite__mapDeps([4,0,1]),import.meta.url),ns=vs.calculateProfitFromTransaction($t);ns>0&&(vs.addProfit(ns,s==null?void 0:s.uid),console.log("✅ تم إضافة الربح:",ns,"جنيه"));const xa=await Kn.create(Le);if(!E&&Z)try{await ra.updateUsage(Z,f,ne==="transfer"?"transfer":"withdraw")}catch{}await Promise.all([...s!=null&&s.uid?[Te.updateUserData(s.uid,{cashBalance:Hs,walletBalances:Gs,lastUpdated:new Date().toISOString()})]:[],...s!=null&&s.uid?[Te.saveUserTransaction(s.uid,{...$t,transactionType:ne,fromWallet:Z,toWallet:ne==="transfer"?P?null:"cash":null,cashierName:g&&((N==null?void 0:N.name)||(N==null?void 0:N.username))||"الحساب الرئيسي",linkedDebtId:X||void 0,transactionId:xa,description:`${ne==="transfer"?"تحويل":"سحب"} ${f} من ${Z} ${ne==="transfer"?P?"":"إلى الدرج النقدي":""} — عمولة: ${S} (${ne==="transfer"||pt?"مضافة":"مخصومة"})${me>0?` — رسوم: ${me}`:""}${E?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");const Qs=`userData_${s==null?void 0:s.uid}`,Ln={cashBalance:Hs,walletBalances:Gs,lastUpdated:new Date().toISOString()};localStorage.setItem(Qs,JSON.stringify(Ln))}catch(Le){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",Le);try{s!=null&&s.uid&&Te.saveLocalReceipt(s.uid,{...transactionDataForUser,transactionType:ne,fromWallet:Z,toWallet:ne==="transfer"?P?null:"cash":null,cashierName:g&&((N==null?void 0:N.name)||(N==null?void 0:N.username))||"الحساب الرئيسي",linkedDebtId:X||void 0,description:`${ne==="transfer"?"تحويل":"سحب"} ${f} من ${Z} ${ne==="transfer"?P?"":"إلى الدرج النقدي":""} — عمولة: ${S} (${ne==="transfer"||pt?"مضافة":"مخصومة"})${me>0?` — رسوم: ${me}`:""}${E?" — دين مؤجل (قيد المراجعة)":""}`})}catch{}i({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),ne==="transfer"){Za(!0);const Le=Number(r)+Number(S)+Math.max(0,Number(me));ai({type:"transfer",amount:Math.max(0,Math.round(Le*100)/100)}),od({receiver:Cs,amount:r}),Fa(!0),setTimeout(()=>{Za(!1)},2e3)}else{xr(!0);const Le=pt?Number(r):Math.max(0,Math.round((Number(r)-Number(S))*100)/100);ai({type:"withdraw",amount:Math.max(0,Math.round(Le*100)/100)}),Fa(!0),setTimeout(()=>{xr(!1)},2e3)}ja(""),d(""),_(""),$s(null),We(""),_e(""),Ee(""),Sa(!1)},Mn=Ve.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),Po=Ve.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),Tm=Ve.useMemo(()=>{try{return Mt.reduce((t,a)=>{const r=Number(a.paidAmount||0),l=Math.max(0,Number(a.amount||0)-r);return t+l},0)}catch{return 0}},[Mt]),Yi=Ve.useMemo(()=>jo().filter(a=>ma==="all"?!0:ma==="send"?a.type==="send":ma==="receive"?a.type==="receive":ma==="withdraw"?a.type==="withdraw":ma!=="deleted"),[jo,ma]),Pm=()=>{if(ti==="daily"){const t=us.resetReportsManually("daily",ht,s==null?void 0:s.uid);ur(!1),i({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${t.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const t=us.resetReportsManually("monthly",ht,s==null?void 0:s.uid);ur(!1),i({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${t.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},km=()=>ti==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",_m=()=>ti==="daily"?"أدخل الرقم السري الرئيسي لتصفير جميع معاملات اليوم":"أدخل الرقم السري الرئيسي لتصفير جميع معاملات الشهر",Om=t=>{xo(t),Pi(!0)},Em=t=>{const a=It,r=Number(t)-Number(a);Ut(t),localStorage.setItem(bs(),t.toString()),eo(!1);const l={cashBalance:t,lastUpdated:new Date().toISOString()},o=`userData_${s==null?void 0:s.uid}`;try{localStorage.setItem(o,JSON.stringify(l))}catch{}const m=[];if(s!=null&&s.uid){m.push(Te.updateUserData(s.uid,l).then(()=>{try{localStorage.removeItem(o)}catch{}}).catch(()=>{}));const x=`${r>0?"CASHADD":"CASHDEDUCT"}-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`,p=r>0?{txnType:"cash_addition",type:"cash_addition",amount:r,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:x,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(j==null?void 0:j.shopId)||void 0}:r<0?{amount:Math.abs(r),status:"completed",title:"ايصال خصم من الفلوس النقديه",merchantUserId:s.uid,createdBy:s.uid,shopId:(j==null?void 0:j.shopId)||void 0}:null;p&&m.push(Te.saveUserTransaction(s.uid,p));const S=j==null?void 0:j.shopId;if(S){const f=ze(K,"dashboardData",S);m.push(Es(f,{cashBalance:t}))}}Promise.allSettled(m).then(()=>{}).catch(()=>{}),i({title:r>0?"تم إضافة نقدية":r<0?"تم خصم نقدية":"تم تحديث الرصيد النقدي",description:r!==0?`التغيير: ${Math.abs(r)} جنيه، الرصيد الجديد: ${t} جنيه`:`تم تحديث الرصيد النقدي إلى ${t} جنيه`})},Mm=async t=>{var x;if(!_s){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const a={...Xe,[_s]:t};rs(a);const r=new Date().toISOString(),l={walletBalances:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;try{localStorage.setItem(o,JSON.stringify(l)),localStorage.setItem(ys(),JSON.stringify(a)),localStorage.setItem(`walletBalances_backup_${r}`,JSON.stringify(a))}catch{}try{s!=null&&s.uid&&await Te.updateUserData(s.uid,l)}catch(p){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",p)}to(!1);const m=((x=Ye.find(p=>p.id===_s))==null?void 0:x.name)||"المحفظة";i({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${m} إلى ${t.toLocaleString()} جنيه`})},$m=async t=>{var a;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",_s),console.log("💵 المبلغ المضاف/المخصوم:",t),_s){const r=Xe[_s]||0;console.log("💰 الرصيد الحالي:",r);const l=r+t;console.log("💰 الرصيد الجديد:",l);const o={...Xe,[_s]:l};console.log("📊 الأرصدة المحدثة:",o),rs(o);const m=new Date().toISOString(),x={walletBalances:o,lastUpdated:m},p=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(p,JSON.stringify(x)),localStorage.setItem(ys(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${m}`,JSON.stringify(o));try{if(s!=null&&s.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await Te.updateUserData(s.uid,x),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(p),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(P){console.error("❌ فشل في حفظ البيانات في Firebase:",P),Je(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(ys(),JSON.stringify(o));const S=((a=Ye.find(P=>P.id===_s))==null?void 0:a.name)||"المحفظة",f=t>0?"إضافة":"خصم",v=Math.abs(t);i({title:`تم ${f} مبلغ ${f==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${f} ${v} جنيه ${f==="إضافة"?"إلى":"من"} رصيد ${S}. الرصيد الجديد: ${l.toLocaleString()} جنيه`})}catch(S){if(console.error("❌ فشل في حفظ البيانات في Firebase:",S),localStorage.setItem(ys(),JSON.stringify(o)),s!=null&&s.uid){const f=`userData_${s.uid}`,v={walletBalances:o,lastUpdated:new Date().toISOString()};localStorage.setItem(f,JSON.stringify(v)),Je(!0)}i({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const l=Object.keys(localStorage).filter(o=>o.startsWith("walletBalances_backup_")).sort();l.length>5&&l.slice(0,l.length-5).forEach(m=>{localStorage.removeItem(m),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",m)})},5e3),Pi(!1),xo("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:Nt,isUserActive:kt,showActivationModal:Qt}),!Nt&&!kt?(console.log("🔥 UserDashboardPage - Showing activation modal"),e.jsx("div",{className:"user-dashboard min-h-screen bg-background flex items-center justify-center",children:e.jsx(Go,{isOpen:!0,onClose:()=>{}})})):Nt?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx(ah,{})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"user-dashboard min-h-screen px-2 sm:px-4 py-2 sm:py-4 relative bg-gray-50 bg-[radial-gradient(140%_140%_at_10%_10%,#f3f4f6_0%,#e5e7eb_45%,#d1d5db_100%)]",children:[e.jsx(Au,{userId:s==null?void 0:s.uid}),e.jsxs("div",{className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!pr&&e.jsxs(Pt,{className:"monthly-stats-card bg-gradient-to-br from-purple-50 via-purple-25 to-white border border-purple-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-500/5 to-purple-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-purple-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(ls,{className:"monthly-stats-header pb-2 sm:pb-1 lg:pb-1 px-3 sm:px-3 lg:px-2 pt-3 sm:pt-2 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ss,{className:"text-xs font-bold text-purple-800 flex items-center gap-1.5 sm:gap-1",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-2 h-2.5 sm:h-2 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-2 h-2.5 sm:h-2 bg-purple-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1",children:[e.jsx("div",{className:"hidden"}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>{xl("monthly"),ur(!0)},className:"monthly-stat-action h-7 w-7 sm:h-6 sm:w-6 p-0 bg-gradient-to-r from-purple-100 to-purple-200 text-purple-700 hover:from-purple-200 hover:to-purple-300 hover:text-purple-800 rounded-lg sm:rounded-md transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات الشهر",children:e.jsx(is,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5"})}),e.jsx("div",{className:"monthly-stat-action p-1.5 sm:p-1 bg-gradient-to-r from-purple-100 to-purple-200 rounded-lg sm:rounded-md",children:e.jsx(Mr,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5 text-purple-600"})})]})]})}),!pr&&e.jsxs(Lt,{className:"space-y-0.5 sm:space-y-1 lg:space-y-0 pt-0 px-2 sm:px-3 lg:px-2 pb-1.5 sm:pb-2 lg:pb-1 relative z-10",children:[e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:_r().totalTransactions})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:_r().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"المسحوب:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:_r().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"المرسل:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:_r().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"الأرباح:"}),e.jsx(gu,{userId:s==null?void 0:s.uid,transactions:ht})]})]}),fd&&e.jsx("div",{className:"monthly-overlay absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:async()=>{if(bt){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}rn(!0)},className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-black hover:from-yellow-600 hover:to-yellow-700 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(Wt,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(ms,{open:bd,onOpenChange:rn,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(bt){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),rn(!1),Al(!0);return}Al(!1),rn(!1)},userId:s==null?void 0:s.uid}),((ko=ts==null?void 0:ts.subscription)==null?void 0:ko.planType)!==ws.TAHWEELA&&e.jsxs(Pt,{className:"daily-stats-card bg-gradient-to-br from-blue-50 via-blue-25 to-white border border-blue-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 to-blue-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-blue-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(ls,{className:"daily-stats-header pb-2 sm:pb-3 lg:pb-1 px-3 sm:px-4 lg:px-2 pt-3 sm:pt-4 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ss,{className:"text-sm sm:text-base font-bold text-blue-800 flex items-center gap-1.5 sm:gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-3 h-2.5 sm:h-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-3 h-2.5 sm:h-3 bg-blue-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs sm:text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5",children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>{xl("daily"),ur(!0)},className:"daily-stat-action h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات اليوم",children:e.jsx(is,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>yd(t=>!t),className:"daily-stat-action h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:pr?"توسيع اليوم والشهر":"طي اليوم والشهر",children:pr?e.jsx(Br,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"}):e.jsx(Fn,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg",children:e.jsx(Mr,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-blue-600"})})]})]})}),!pr&&e.jsxs(Lt,{className:"space-y-0 pt-0 px-2 pb-1 relative z-10",children:[e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:kr().totalTransactions})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:kr().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"المسحوب:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:kr().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from_gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"المرسل:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:kr().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"الأرباح:"}),e.jsx(bu,{userId:s==null?void 0:s.uid,transactions:ht})]})]}),Sd&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:()=>ii(!0),className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير اليوم (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير اليوم"}),e.jsx(Wt,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(ms,{open:Dd,onOpenChange:ii,mode:"verify",title:"الرقم السري لفتح تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{kl(!1),ii(!1)},userId:s==null?void 0:s.uid})]}),e.jsxs(Pt,{className:"balance-bar bg-white border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(Lt,{className:"p-3 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-emerald-50 border-2 border-emerald-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/cash relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx(zt,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-emerald-800",children:"الفلوس النقدية"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-emerald-700 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm",children:[It.toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Nr(!0),children:e.jsx(xs,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>go(!0),title:"تفاصيل الفلوس النقدية",children:e.jsx(Jo,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>_n(!0),children:e.jsx(is,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/wallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(na,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-blue-800",children:"الأرصدة علي المحافظ"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-blue-700 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Object.values(Xe).reduce((t,a)=>t+a,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>In(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(xs,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{Pn(!0),kn("")},title:"تصفير إجمالي المحفظة",children:e.jsx(is,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-indigo-50 border-2 border-indigo-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/selwallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(na,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-indigo-800",children:"رصيد المحفظه"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-indigo-700 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm",children:[(Z&&Xe[Z]||0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>{if(!Z){i({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}Om(Z)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(xs,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{if(!Z){i({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}xn(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(is,{className:"h-2 w-2"})})]})]})]})]})})]}),e.jsxs(Pt,{className:"bg-gradient-to-br from-gray-50 via-white to-slate-50 border border-gray-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-500/5 to-slate-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsxs(ls,{className:`pb-2 px-4 pt-4 relative z-10 ${L?"sticky top-0 z-20 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/60":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ss,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[!L&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-gray-100 to-slate-200 rounded-lg",children:e.jsx(Mr,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-600"})}),e.jsx("span",{className:"bg-gradient-to-r from-gray-600 to-slate-600 bg-clip-text text-transparent",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!L&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(dh,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx(U,{placeholder:"بحث...",value:bl,onChange:t=>id(t.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!L&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"تقسيط"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{if(bt||Rt){i({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"});return}en(!0)},title:"إدارة التقسيط",children:e.jsx(rh,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-green-600 mb-1",children:"شحن"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 ring-3 ring-green-300 transition-all duration-200 hover:scale-105 active:bg-green-600 active:text-white active:border-green-600",onClick:()=>{i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."})},title:"شحن الرصيد",children:e.jsx(zr,{className:"h-5 w-5 text-green-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>ri(!0),title:"آلة حاسبة",children:e.jsx(uc,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{bt||Rt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):tn(!0)},title:"كروت الائتمان",children:e.jsx(zr,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"تقاريرك"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:()=>{if(bt||Rt){i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"});return}oo(!0)},title:"تقاريرك",children:e.jsx(Eh,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:lm,title:g&&(N!=null&&N.name||N!=null&&N.username)?`بروفيل الوردية: ${(N==null?void 0:N.name)||(N==null?void 0:N.username)}`:"وردية الكاشير",children:e.jsx(tl,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{bt||Rt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):mr(!0)},title:"بيانات المبيعات",children:e.jsx(Vo,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),Mt.filter(t=>t.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:Mt.filter(t=>t.status==="pending").length})]}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{fi()},title:"الديون",children:e.jsx(nh,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105 active:bg-amber-600 active:text-white active:border-amber-600",onClick:()=>{bt||Rt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):sn(!0)},title:"الصيانة",children:e.jsx(cc,{className:"h-5 w-5 text-amber-700"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-50 text-violet-700 hover:bg-violet-100 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105 active:bg-violet-700 active:text-white active:border-violet-700",onClick:()=>{!aa||Rt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):an(!0)},title:"يومية المكنة",children:e.jsx(fc,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105 active:bg-orange-600 active:text-white active:border-orange-600",onClick:()=>{bt||Rt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):ps.hasMasterPin()?Gt(!0):At(!0)},title:"مصروفات المحل",children:e.jsx(Bn,{className:"h-5 w-5 text-orange-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-rose-600 mb-1",children:"النواقص"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-rose-50 text-rose-600 hover:bg-rose-100 border border-rose-200 ring-3 ring-rose-300 transition-all duration-200 hover:scale-105 active:bg-rose-600 active:text-white active:border-rose-600",onClick:()=>{bt||Rt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):wa(!0)},title:"النواقص",children:e.jsx(Ro,{className:"h-5 w-5 text-rose-600"})})]})]})]})]}),!L&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"filters-bar flex items-center justify-center gap-3 bg-gray-50 rounded-md p-3 border border-gray-200",children:[e.jsx(h,{variant:"ghost",size:"sm",className:`btn-filter-send h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${ma==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>Zn("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(h,{variant:"ghost",size:"sm",className:`btn-filter-withdraw h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${ma==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-50"}`,onClick:()=>Zn("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(h,{variant:"ghost",size:"sm",className:`btn-filter-all h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${ma==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>Zn("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(h,{variant:"ghost",size:"sm",className:"h-8 px-3 text-[12px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>vr(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(is,{className:"h-3.5 w-3.5 mr-1"}),"تصفير"]}),fm>0&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),e.jsx(ms,{open:hd,onOpenChange:en,mode:"verify",title:"فتح إدارة التقسيط",description:"أدخل الرقم السري الرئيسي للوصول إلى إدارة التقسيط",onSuccess:()=>{en(!1),Il(!0)}}),e.jsx(uh,{open:ud,onOpenChange:Il}),Cl,e.jsxs(Lt,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:[Yi.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Mr,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):L?e.jsx("div",{className:"overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[310px]",children:e.jsx("div",{className:"space-y-2 pr-2",children:Yi.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all duration-200",onClick:()=>Io(t),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(Ma,{className:`h-4 w-4 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(ba,{className:"h-4 w-4 text-yellow-500"}),t.status==="failed"&&e.jsx(zn,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`font-medium text-sm ${r||l?"text-gray-800":t.type==="send"?"text-green-700":"text-red-700"}`,children:r?"إيصال تسليم وردية":l?`إيصال إضافة نقدية - ${Ns(t.amount)} جنيه`:(t.type==="send"?"تحويل":"سحب")+` - ${Ns(t.amount)} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(t==null?void 0:t.cashierName)??"الحساب الرئيسي"]}),(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية"),o=(a==null?void 0:a.note)||(a==null?void 0:a.notes)||"";return e.jsx("p",{className:`text-xs ${r||l?"text-gray-500":t.type==="send"?"text-green-600":"text-red-500"}`,children:r?`تم التسليم إلى: ${t.receiverPhone}`:l?o?`ملاحظة: ${o}`:"تمت إضافة نقدية للدرج":`من ${t.senderPhone}${t.type==="send"?` إلى ${t.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[Mn.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",Po.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]})]}),e.jsx(Kt,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",className:`text-xs ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700 border-red-300":t.type==="send"?"bg-green-100 text-green-700 border-green-300":"":""}`,children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})}):e.jsx("div",{className:"overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[calc(100dvh-300px)]",children:e.jsx("div",{className:"space-y-2 pr-2",children:Yi.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all duration-200",onClick:()=>Io(t),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(Ma,{className:`h-4 w-4 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(ba,{className:"h-4 w-4 text-yellow-500"}),t.status==="failed"&&e.jsx(zn,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`font-medium text-sm ${r||l?"text-gray-800":t.type==="send"?"text-green-700":"text-red-700"}`,children:r?"إيصال تسليم وردية":l?`إيصال إضافة نقدية - ${Ns(t.amount)} جنيه`:(t.type==="send"?"تحويل":"سحب")+` - ${Ns(t.amount)} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(t==null?void 0:t.cashierName)??"الحساب الرئيسي"]}),(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية"),o=(a==null?void 0:a.note)||(a==null?void 0:a.notes)||"";return e.jsx("p",{className:`text-xs ${r||l?"text-gray-500":t.type==="send"?"text-green-600":"text-red-500"}`,children:r?`تم التسليم إلى: ${t.receiverPhone}`:l?o?`ملاحظة: ${o}`:"تمت إضافة نقدية للدرج":`من ${t.senderPhone}${t.type==="send"?` إلى ${t.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[Mn.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",Po.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]})]}),e.jsx(Kt,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",className:`text-xs ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700 border-red-300":t.type==="send"?"bg-green-100 text-green-700 border-green-300":"":""}`,children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})}),L&&e.jsxs("div",{className:"mt-2 flex justify-end",children:[e.jsxs(h,{variant:"ghost",size:"sm",className:"h-7 px-2 text-[11px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>vr(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(is,{className:"h-3 w-3 mr-1"}),"تصفير"]}),(s==null?void 0:s.uid)&&localStorage.getItem(`recentTransactionsResetAt:${s.uid}`)&&e.jsx("span",{className:"inline-block h-1.5 w-1.5 rounded-full bg-red-500 ml-1 align-middle"})]})]})]})]}),e.jsx(xh,{isOpen:Zc,onClose:()=>Gr(!1),transaction:Xc,onPrint:()=>window.print(),onDelete:rd,onComplete:nd}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full lg:w-[92%] xl:w-[95%] mx-auto",children:[e.jsxs(Pt,{id:"transaction-section",className:"bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/50 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx(ls,{className:"sticky top-0 z-20 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ss,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Ma,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[Jt&&e.jsx("div",{className:"hidden md:flex items-center gap-1 bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 border border-emerald-200 text-emerald-800 text-sm transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:e.jsxs("span",{className:"text-sm font-semibold whitespace-nowrap",children:["تجربة: ",Bt," ",Bt>=3&&Bt<=10?"ساعات":Bt===2?"ساعتين":"ساعة"]})}),e.jsxs("div",{className:"top-icons-bar hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:[e.jsx(Hh,{}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"VIP",onClick:()=>ni(!0),children:e.jsx(Ph,{className:"h-5 w-5 text-yellow-500"})}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"إدارة الفروع",onClick:()=>{i({title:"قيد التطوير",description:"الميزة غير متاحة حالياً"})},children:e.jsx(xc,{className:"h-5 w-5"})}),e.jsx(mh,{})]})]}),jm&&e.jsxs(h,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:wo,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx(kh,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsx(pe,{open:jd,onOpenChange:ni,children:e.jsxs(ge,{className:"sm:max-w-md",children:[e.jsx(fe,{children:e.jsx(ye,{children:"أفضل 10 عملاء هذا الشهر"})}),e.jsx("div",{className:"space-y-2",children:Tn.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا توجد بيانات لهذا الشهر"}):Tn.map((t,a)=>e.jsxs("div",{className:`flex items-center justify-between border rounded-md px-3 py-2 bg-white ${a===0?"bg-yellow-50 border-yellow-300":""}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Kt,{variant:"outline",className:`min-w-[28px] justify-center ${a===0?"border-yellow-300 text-yellow-700 bg-yellow-50":""}`,children:a+1}),e.jsx("span",{className:`font-semibold ${a===0?"text-yellow-700":""}`,children:t.phone})]}),e.jsxs("div",{className:"text-sm text-gray-700 flex items-center gap-3",children:[e.jsxs("span",{children:["عدد: ",t.count]}),e.jsxs("span",{children:["إجمالي: ",t.total]}),e.jsx(h,{variant:"outline",size:"sm",className:"h-8",onClick:()=>bm(t),title:"إرسال واتساب",children:e.jsx(Bo,{className:"h-4 w-4"})})]})]},t.phone+a))}),e.jsx(nt,{children:e.jsx(h,{onClick:()=>ni(!1),children:"إغلاق"})})]})}),e.jsx(pe,{open:vd,onOpenChange:Tl,children:e.jsxs(ge,{className:"sm:max-w-md",children:[e.jsx(fe,{children:e.jsx(ye,{children:"ربط بوت التلجرام"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Q,{children:"Telegram Chat ID"}),e.jsx(U,{value:nn,onChange:t=>wd(t.target.value),placeholder:"اكتب رقم المحادثة"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Q,{children:"إرسال يومي 12 صباحاً"}),e.jsx(fh,{checked:Pl,onCheckedChange:t=>Nd(!!t)})]})]}),e.jsxs(nt,{children:[e.jsx(h,{variant:"outline",onClick:()=>Tl(!1),children:"إغلاق"}),e.jsx(h,{onClick:async()=>{s!=null&&s.uid&&(await Te.updateUserData(s.uid,{telegramChatId:nn,telegramDailyEnabled:Pl}),i({title:"تم الحفظ"}))},children:"حفظ"}),e.jsx(h,{onClick:async()=>{if(!(s!=null&&s.uid)||!nn){i({title:"أدخل Chat ID"});return}const t=await vm();try{const{sendTelegramMessage:a}=await gt(async()=>{const{sendTelegramMessage:r}=await Promise.resolve().then(()=>$h);return{sendTelegramMessage:r}},void 0,import.meta.url);await a({chatId:nn,text:t}),i({title:"تم الإرسال"})}catch{i({title:"تعذر الإرسال",description:"تحقق من ربط البوت",variant:"destructive"})}},children:"إرسال الآن"})]})]})}),e.jsx(pe,{open:be,onOpenChange:de,children:e.jsxs(ge,{className:"sm:max-w-lg",children:[e.jsxs(fe,{children:[e.jsx(ye,{children:"إدارة الفروع"}),e.jsx(ds,{children:"أضف فروع جديدة وأدِر الدخول لكل فرع"}),e.jsx("div",{className:"flex items-center justify-end gap-2 mt-2",children:e.jsx(h,{variant:"outline",size:"sm",onClick:()=>{try{const t=s!=null&&s.uid?`selectedShopId_${s.uid}`:"selectedShopId";localStorage.removeItem(t);try{window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}i({title:"تم الخروج من الفرع"}),O(`/branch/${String(b.shopId)}/dashboard`)}catch{}},children:"الخروج من الفرع"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(Q,{children:"اسم المدير"}),e.jsx(U,{value:Me,onChange:t=>Be(t.target.value),placeholder:"اكتب اسم المدير"})]}),e.jsxs("div",{children:[e.jsx(Q,{children:"اسم الفرع"}),e.jsx(U,{value:Pe,onChange:t=>Ke(t.target.value),placeholder:"اكتب اسم الفرع"})]}),e.jsxs("div",{children:[e.jsx(Q,{children:"اسم المستخدم للدخول"}),e.jsx(U,{value:qe,onChange:t=>ot(t.target.value),placeholder:"مثال: branch1"})]}),e.jsxs("div",{children:[e.jsx(Q,{children:"كلمة السر"}),e.jsx(U,{type:"password",value:ee,onChange:t=>ue(t.target.value),placeholder:"••••••"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Be(""),Ke(""),ot(""),ue("")},children:"مسح"}),e.jsx(h,{className:"bg-indigo-600 hover:bg-indigo-700",disabled:tt,onClick:async()=>{if(!(s!=null&&s.uid))return;const t=Me.trim(),a=Pe.trim(),r=qe.trim(),l=ee.trim();if(!t||!a||!r||!l){i({title:"يرجى ملء جميع الحقول"});return}try{re(!0);let o="";try{o=(await Vs(De(K,"shops"),{name:a,ownerId:s.uid,createdAt:ut(),updatedAt:ut(),isActive:!0})).id}catch{o=(await Vs(De(K,"users",s.uid,"shops"),{name:a,ownerId:s.uid,createdAt:ut(),updatedAt:ut(),isActive:!0})).id}const m=x=>{try{return btoa(unescape(encodeURIComponent(x)))}catch{return btoa(x)}};try{await Vs(De(K,"branches"),{ownerId:s.uid,shopId:o,branchName:a,managerName:t,loginUsername:r,passwordEncoded:m(l),createdAt:ut()})}catch{await Vs(De(K,"users",s.uid,"branches"),{ownerId:s.uid,shopId:o,branchName:a,managerName:t,loginUsername:r,passwordEncoded:m(l),createdAt:ut()})}try{const x=He(De(K,"branches"),je("ownerId","==",s.uid));let S=(await it(x)).docs.map(f=>({id:f.id,...f.data()}));if(S.length===0){const f=He(De(K,"users",s.uid,"branches"));S=(await it(f)).docs.map(P=>({id:P.id,...P.data()}))}ae(S)}catch{try{const x=He(De(K,"users",s.uid,"branches")),S=(await it(x)).docs.map(f=>({id:f.id,...f.data()}));ae(S)}catch{}}Be(""),Ke(""),ot(""),ue(""),i({title:"تم إضافة الفرع بنجاح"})}catch{i({title:"تعذّر إضافة الفرع"})}finally{re(!1)}},children:"إضافة فرع"})]}),e.jsxs("div",{className:"border-t pt-3",children:[e.jsx("h4",{className:"text-sm font-semibold mb-2",children:"الفروع الحالية"}),tt?e.jsx("div",{className:"text-sm text-gray-500",children:"جارٍ التحميل..."}):oe.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"لا يوجد فروع بعد"}):e.jsx("div",{className:"space-y-2",children:oe.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-lg bg-white",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:t.branchName}),e.jsxs("div",{className:"text-gray-600",children:["مدير: ",t.managerName]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{size:"sm",className:"bg-blue-600 hover:bg-blue-700",onClick:()=>{qt(t),Ie(String(t.loginUsername||"")),ct(""),ft(!0)},children:"دخول الفرع"}),e.jsx(h,{size:"sm",variant:"destructive",onClick:async()=>{if(confirm("هل أنت متأكد من حذف الفرع؟ سيتم حذف بيانات الفرع المرتبطة."))try{try{await js(ze(K,"branches",t.id))}catch{}try{await js(ze(K,"users",(s==null?void 0:s.uid)||"","branches",t.id))}catch{}if(t.shopId){try{await js(ze(K,"shops",String(t.shopId)))}catch{}try{await js(ze(K,"users",(s==null?void 0:s.uid)||"","shops",String(t.shopId)))}catch{}}ae(a=>a.filter(r=>r.id!==t.id)),i({title:"تم حذف الفرع"})}catch{i({title:"تعذّر حذف الفرع"})}},children:"حذف الفرع"})]})]},t.id))})]})]})]})}),e.jsx(pe,{open:Se,onOpenChange:ft,children:e.jsxs(ge,{className:"sm:max-w-md",children:[e.jsxs(fe,{children:[e.jsx(ye,{children:"دخول الفرع"}),e.jsx(ds,{children:"أدخل بيانات الدخول للفرع المحدد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(Q,{children:"اسم المستخدم"}),e.jsx(U,{value:Yt,onChange:t=>Ie(t.target.value),placeholder:"اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(Q,{children:"كلمة السر"}),e.jsx(U,{type:"password",value:Ge,onChange:t=>ct(t.target.value),placeholder:"••••••"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Ie(""),ct("")},children:"مسح"}),e.jsx(h,{className:"bg-blue-600 hover:bg-blue-700",disabled:ve,onClick:async()=>{const t=es;if(!t){ft(!1);return}const a=String(t.loginUsername||"");let r="";try{const m=String(t.passwordEncoded||"");r=m?decodeURIComponent(escape(atob(m))):""}catch{try{r=t.passwordEncoded?atob(String(t.passwordEncoded)):""}catch{r=""}}const l=Yt.trim(),o=Ge.trim();if(!l||!o){i({title:"يرجى إدخال اسم المستخدم وكلمة السر"});return}if(l!==a||o!==r){i({title:"بيانات الدخول غير صحيحة",variant:"destructive"});return}try{dt(!0);const m=s!=null&&s.uid?`selectedShopId_${s.uid}`:"selectedShopId";localStorage.setItem(m,String(t.shopId)),i({title:"تم الدخول إلى الفرع",description:String(t.branchName||"")}),ft(!1),de(!1),O("/user/dashboard")}catch{}dt(!1)},children:"دخول"})]})]})]})}),e.jsxs(Lt,{ref:u,className:"space-y-1 px-2 pb-2 relative z-10 transition-transform duration-200 ease-out will-change-transform",style:{transform:c?`translateY(${c}px)`:void 0},onFocusCapture:t=>{const a=t.target;if(!((a==null?void 0:a.id)==="transferExtraFeeInput")){y(0);return}const l=document.getElementById("transferSubmitButton");if(l){const o=l.getBoundingClientRect(),m=window.innerHeight;if(o.bottom>m){const x=o.bottom-m,p=Math.min(x,220);y(-p)}else y(0)}else y(0)},onBlurCapture:t=>{t.currentTarget.contains(t.relatedTarget)||y(0)},children:[e.jsxs("div",{className:"transaction-type-tabs grid grid-cols-2 gap-0.5 p-0.5 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-200/50 fade-in-up w-full lg:w-[92%] xl:w-[95%] mx-auto ",children:[e.jsxs(h,{variant:ne==="transfer"?"default":"ghost",onClick:()=>En("transfer"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${ne==="transfer"?"bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg hover:shadow-md hover:from-blue-600 hover:to-indigo-700":"text-gray-600 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-700 hover:border-blue-200"}`,children:[e.jsx(Mr,{className:"h-1 w-1 mr-1"}),"تحويل"]}),e.jsxs(h,{variant:ne==="withdraw"?"default":"ghost",onClick:()=>En("withdraw"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${ne==="withdraw"?"bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-lg hover:shadow-md hover:from-emerald-600 hover:to-green-700":"text-gray-600 hover:bg-gradient-to-r hover:from-emerald-50 hover:to-green-50 hover:text-emerald-700 hover:border-emerald-200"}`,children:[e.jsx(qn,{className:"h-1 w-1 mr-1"}),"سحب"]})]}),e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(na,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(h,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>O("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(xs,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(h,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>{or(!0)},title:"المحافظ",children:[e.jsx(na,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),Ye.length>0?e.jsxs(Ta,{value:Z,onValueChange:Dm,children:[e.jsx(Pa,{"data-testid":"wallet-select",className:"selected-number-card w-full h-12 text-sm bg-gradient-to-r from-white to-gray-50 border-2 border-gray-200 hover:border-blue-400 focus:border-blue-500 rounded-xl transition-all duration-300 hover:shadow-md focus:shadow-lg",children:e.jsx(ka,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-600"})}),e.jsxs(_a,{className:"rounded-xl border-2 border-gray-200 shadow-md z-[9999]",children:[e.jsx("div",{"data-fixed-header":"true",className:"sticky top-0 z-10 bg-white p-2 border-b border-gray-200",children:e.jsx(U,{value:ml,onChange:t=>Hc(t.target.value),placeholder:"ابحث برقم المحفظة",className:"h-6 text-xs"})}),e.jsx("div",{className:"pr-1",children:hl.length===0?e.jsx("div",{className:"text-xs text-gray-500 p-2",children:"لا توجد نتائج مطابقة"}):hl.map(t=>e.jsx(Zs,{value:t.id,className:"rounded-lg hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200",children:e.jsxs("div",{className:"flex items-center gap-1 py-1 w-full justify-between",children:[e.jsx("div",{className:"p-1 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg",children:e.jsx(na,{className:"h-1 w-1 text-blue-600"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-800",children:t.name}),e.jsxs("span",{className:"text-sm font-semibold text-red-600",children:["(",t.phone,")"]})]}),t.isDefault&&e.jsx(Kt,{variant:"secondary",className:"text-[10px] bg-gradient-to-r from-emerald-100 to-green-100 text-emerald-700 border-emerald-200",children:"افتراضي"})]}),e.jsx("div",{className:"ml-auto flex flex-col items-end gap-1"})]})},t.id))})]})]}):e.jsx("div",{className:"rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 px-3 py-3 text-xs text-gray-600",children:"لا توجد محافظ حتى الآن. اضغط “إضافة محفظة” لإضافة أول محفظة."})]}),e.jsx(pe,{open:fs,onOpenChange:ca,children:e.jsxs(ge,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(fe,{children:e.jsx(ye,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(Ih,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),e.jsx(ms,{open:Vr,onOpenChange:or,mode:"verify",title:"الرقم السري لفتح المحافظ",description:"أدخل الرقم السري الرئيسي لعرض وإدارة المحافظ",onSuccess:()=>{or(!1),ca(!0)},userId:s==null?void 0:s.uid}),e.jsx(ms,{open:Kr,onOpenChange:t=>{cr(t),t||Yn(null)},mode:"verify",title:"تأكيد تغيير المحفظة",description:"أدخل الرقم السري الرئيسي لتغيير المحفظة المختارة",onSuccess:()=>{dr&&(Ar(dr,"walletSelectionPin"),Yn(null)),cr(!1)},userId:s==null?void 0:s.uid}),e.jsx(pe,{open:zc,onOpenChange:Jr,children:e.jsxs(ge,{className:"sm:max-w-md",children:[e.jsx(fe,{children:e.jsxs(ye,{className:"flex items-center gap-2 text-red-700",children:[e.jsx(Ro,{className:"h-5 w-5 text-red-600"}),"تحذير حد شهري للمحفظة"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded-md border bg-red-50 border-red-200",children:[e.jsxs("p",{className:"text-sm text-red-800",children:["المحفظة: ",e.jsx("span",{className:"font-semibold",children:(Us==null?void 0:Us.walletName)||""})]}),e.jsxs("p",{className:"text-sm text-red-800",children:["الاستخدام الشهري (",(Us==null?void 0:Us.type)==="withdraw"?"سحب":"تحويل","):",e.jsxs("span",{className:"font-mono",children:[" ",Number((Us==null?void 0:Us.used)||0).toLocaleString("en-US")," "]})," جنيه"]}),e.jsxs("p",{className:"text-sm text-red-800",children:["الحد الشهري: ",e.jsx("span",{className:"font-mono",children:Number((Us==null?void 0:Us.limit)||0).toLocaleString("en-US")})," جنيه"]}),e.jsx("p",{className:"text-sm font-semibold text-red-900 mt-1",children:"تم الوصول إلى 85% من الحد الشهري — يرجى الحذر قبل الاستمرار."})]}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsx(h,{variant:"outline",onClick:()=>Jr(!1),children:"حسناً"})})]})]})}),Z&&Ye.length>0&&(()=>{var le;const t=Ye.find(me=>me.id===Z),a=ua,r=Am(Z),l=(at==null?void 0:at.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,o=(at==null?void 0:at.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,m=(at==null?void 0:at.monthlyWithdrawUsed)??a.totalWithdrawn??0,x=(at==null?void 0:at.monthlyTransferUsed)??a.totalTransferred??0,p=((le=ts==null?void 0:ts.subscription)==null?void 0:le.planType)===ws.TAHWEELA,S=p?0:(at==null?void 0:at.dailyWithdrawLimit)??1e5,f=p?0:(at==null?void 0:at.dailyTransferLimit)??6e4,v=p?0:(at==null?void 0:at.dailyWithdrawUsed)??r.totalWithdrawn??0,P=p?0:(at==null?void 0:at.dailyTransferUsed)??r.totalTransferred??0,$=parseFloat(ss||"0")||0,E=m+(ne==="withdraw"?$:0),X=x+(ne==="transfer"?$:0),rt=v+(ne==="withdraw"?$:0),Re=P+(ne==="transfer"?$:0);return t?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود الشهرية: ",Zl||(t==null?void 0:t.name)||"المحفظة المختارة"]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(E/Math.max(l,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(X/Math.max(o,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-red-600 font-medium",children:["متبقي سحب: ",Math.max(l-E,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(o-X,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود اليومية: ",Zl||(t==null?void 0:t.name)||"المحفظة المختارة"]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(rt/Math.max(S,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Re/Math.max(f,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(S-rt,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(f-Re,0).toLocaleString("en-US")," جنيه"]})]})]})]}):null})(),ne==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative",children:[e.jsx(ya,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{value:Ds,onChange:t=>La(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("receiverPhoneInput");if(a)a.focus();else{const r=document.getElementById("amountInput");r==null||r.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),!R&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(ya,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{id:"receiverPhoneInput",value:Cs,onChange:t=>{ja(t.target.value),si&&Za(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("amountInput");a==null||a.focus()}},inputMode:"numeric",maxLength:11,placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(ya,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{value:Z&&((_o=Ye.find(t=>t.id===Z))==null?void 0:_o.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base bg-gray-50 transition-all duration-300"})]})]}),ne==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(zt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{id:"amountInput",value:ss,onChange:t=>{d(t.target.value),si&&Za(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("transferCommissionInput");if(a)a.focus();else{const r=document.getElementById("quickDebtButton");r==null||r.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),Vt?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",Vt.debtorName," بمبلغ ",Vt.amount," جنيه"]}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>$s(null),children:"إلغاء"})]}):null]}),(()=>{if(R)return null;const t=cs();return t&&t.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",t==null?void 0:t.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(h,{id:"quickDebtButton",type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=cs(),l=(r==null?void 0:r.defaultTransferCommission)!=null?Number(r.defaultTransferCommission):0,o=parseFloat(ss||"0")||0,m=Math.round((l||0)*o/1e3*100)/100,x=o+m;_e((x||0).toString()),bt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):q(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",className:"hidden",title:pt?"العمولة تُضاف":"العمولة تُخصم",children:pt?e.jsx(xs,{className:"h-4 w-4 text-green-600"}):e.jsx(Ka,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:pt?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(zt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(U,{id:"transferCommissionInput",value:As,onChange:r=>Gn(r.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=cs(),l=parseFloat(ss||"0")||0;let o=0;if((r==null?void 0:r.defaultTransferCommission)!=null){const x=Number(r.defaultTransferCommission)||0;o=Math.round(x*l/1e3*100)/100}else{const x=As&&As.trim()!==""?parseFloat(As):0;o=Math.max(0,x)}const m=l+o;_e((m||0).toString()),bt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):q(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",className:"hidden",title:pt?"العمولة تُضاف":"العمولة تُخصم",children:pt?e.jsx(xs,{className:"h-4 w-4 text-green-600"}):e.jsx(Ka,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:pt?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),(()=>{const t=Yr(Ds||"").replace(/\D/g,""),a=Yr(Cs||"").replace(/\D/g,"");return ne==="transfer"&&(t.startsWith("010")&&(a.startsWith("011")||a.startsWith("012")||a.startsWith("015"))||t.startsWith("012")&&a.startsWith("010")||t.startsWith("011")&&a.startsWith("010")||t.startsWith("015")&&a.startsWith("010"))?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رسوم التحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(zt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(U,{id:"transferExtraFeeInput",value:ll,onChange:l=>Uc(l.target.value),placeholder:"أدخل رسوم التحويل",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"hidden",children:"تُخصم من المحفظة وتضاف للدرج — لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010"})]}):null})(),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(h,{id:"transferSubmitButton",onClick:To,className:"btn-transfer-confirm w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 text-white",children:si?"تم التحويل بنجاح":"تأكيد التحويل"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(qn,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-green-500"}),e.jsx(U,{id:"amountInput",value:ss,onChange:t=>{d(t.target.value),jl&&xr(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("manualWithdrawCommissionInput");if(a)a.focus();else{const r=document.getElementById("withdrawSubmitButton");r==null||r.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),(()=>{const t=cs();return t&&t.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",t==null?void 0:t.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=cs(),l=parseFloat(ss||"0")||0,o=(r==null?void 0:r.defaultWithdrawCommission)!=null&&Number(r.defaultWithdrawCommission)||0,m=Math.round(o*l/1e3*100)/100,x=pt?l+m:l;_e((x||0).toString()),bt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):q(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>Qn(r=>!r),title:pt?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:pt?e.jsx(xs,{className:"h-4 w-4"}):e.jsx(Ka,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:pt?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(zt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(U,{id:"manualWithdrawCommissionInput",value:Is,onChange:r=>Hn(r.target.value),onKeyDown:r=>{if(r.key==="Enter"){const l=document.getElementById("withdrawSubmitButton");l==null||l.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=cs(),l=parseFloat(ss||"0")||0;let o=0;if((r==null?void 0:r.defaultWithdrawCommission)!=null){const x=Number(r.defaultWithdrawCommission)||0;o=Math.round(x*l/1e3*100)/100}else{const x=Is&&Is.trim()!==""?parseFloat(Is):Math.round(l*.01*100)/100;o=Math.max(0,x)}const m=pt?l+o:l;_e((m||0).toString()),bt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):q(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",title:pt?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>Qn(r=>!r),children:pt?e.jsx(xs,{className:"h-4 w-4 text-green-600"}):e.jsx(Ka,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:pt?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),(j==null?void 0:j.showWithdrawNote)&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"ملاحظة السحب (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Bo,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{id:"withdrawNoteInput",value:I,onChange:t=>_(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("withdrawSubmitButton");a==null||a.focus()}},placeholder:"أدخل ملاحظة للسحب (اختياري)",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(h,{id:"withdrawSubmitButton",onClick:To,className:"w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:jl?"تم السحب بنجاح":"تأكيد السحب"})})]}),e.jsx(pe,{open:Y,onOpenChange:q,children:e.jsxs(ge,{children:[e.jsxs(fe,{children:[e.jsx(ye,{children:"تحويل مؤجل"}),e.jsx(ds,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[Ls&&Ls.length>0?e.jsxs("div",{children:[e.jsx(Q,{children:"اختيار عميل"}),e.jsxs(Ta,{value:Ft,onValueChange:t=>{Bs(t);const a=Ls.find(r=>r.id===t);a&&We(a.name)},children:[e.jsx(Pa,{className:"w-full",children:e.jsx(ka,{placeholder:"اختر عميل"})}),e.jsx(_a,{children:Ls.map(t=>e.jsxs(Zs,{value:t.id,children:[t.name,t.mobile?` — ${t.mobile}`:""]},t.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(Q,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx(U,{id:"quickDebtName",value:Ne,onChange:t=>We(t.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(Q,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx(U,{id:"quickDebtAmount",type:"number",value:Ue,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(Q,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx(U,{id:"quickDebtNotes",value:Ze,onChange:t=>Ee(t.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(nt,{children:e.jsx(h,{type:"button",variant:"default",className:"bg-green-600 text-white hover:bg-green-700",onClick:()=>{const t=cs(),a=parseFloat((ss||"").toString())||0;let r=0;if(ne==="transfer")if((t==null?void 0:t.defaultTransferCommission)!=null){const m=Number(t.defaultTransferCommission)||0;r=Math.round(m*a/1e3*100)/100}else{const m=As&&As.trim()!==""?parseFloat(As):0;r=Math.max(0,m)}else if((t==null?void 0:t.defaultWithdrawCommission)!=null){const m=Number(t.defaultWithdrawCommission)||0;r=Math.round(m*a/1e3*100)/100}else{const m=Is&&Is.trim()!==""?parseFloat(Is):Math.round(a*.01*100)/100;r=Math.max(0,m)}let l=0;if(ne==="withdraw"?l=pt?a:Math.max(0,Math.round((a-r)*100)/100):l=Math.max(0,Math.round((a+r)*100)/100),!Ne||isNaN(l)||l<=0){i({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const o=Ls.find(m=>m.id===Ft);$s({debtorName:Ne,amount:l,notes:Ze,customerId:Ft||void 0,mobile:o==null?void 0:o.mobile}),Sa(!1),q(!1),i({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx(Pt,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(Lt,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(Bh,{isOpen:Kc,onClose:()=>Jc(!1),initialEditingWallet:Yc,onWalletUpdate:async()=>{try{await Ir()}catch(t){console.error("Error reloading wallets after update:",t)}}}),e.jsx(Uh,{isOpen:Qc,onClose:()=>ul(!1),transaction:Gc,onDelete:Cm}),e.jsx(ms,{open:sd,onOpenChange:ur,onSuccess:Pm,title:km(),description:_m(),mode:"verify"}),e.jsx(Yo,{open:Yd,onOpenChange:eo,onSuccess:Em,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:It,balanceLabel:"الرصيد النقدي",userId:s==null?void 0:s.uid}),e.jsx(Yo,{open:Hd,onOpenChange:to,onSuccess:Mm,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:_s&&Xe[_s]||0,balanceLabel:`رصيد ${((Oo=Ye.find(t=>t.id===_s))==null?void 0:Oo.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(Kh,{open:Gd,onOpenChange:Pi,onSuccess:$m,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:_s&&Xe[_s]||0,balanceLabel:`رصيد ${((Eo=Ye.find(t=>t.id===_s))==null?void 0:Eo.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(zh,{open:om,onOpenChange:cm,userId:s==null?void 0:s.uid}),e.jsx(qh,{open:dm,onOpenChange:mm,userId:s==null?void 0:s.uid}),e.jsx(Vh,{open:hm,onOpenChange:um}),e.jsx(pe,{open:Xd,onOpenChange:pn,children:e.jsxs(ge,{className:"sm:max-w-md",children:[e.jsx(fe,{children:e.jsx(ye,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Q,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(U,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:_i,onChange:t=>gn(t.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:async()=>{if(!await On(Ui)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(_i);if(isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=It+t;Ut(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?Te.updateUserData(s.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),Je(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),Je(!0)}):Je(!0),i({title:"تم بنجاح",description:`تم إضافة ${t} جنيه إلى الدرج النقدية وحفظه في السحابة`}),pn(!1),gn(""),Nn("")},children:[e.jsx(xs,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(h,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:async()=>{if(!await On(Ui)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(_i);if(isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=It-t;Ut(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?Te.updateUserData(s.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),Je(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),Je(!0)}):Je(!0),i({title:"تم بنجاح",description:`تم خصم ${t} جنيه من الدرج النقدية وحفظه في السحابة`}),pn(!1),gn(""),Nn("")},children:[e.jsx(Ka,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",It.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Q,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx(U,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:Ui,onChange:t=>Nn(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(nt,{className:"flex gap-2",children:e.jsx(h,{variant:"outline",onClick:()=>{pn(!1),gn(""),Nn("")},children:"إلغاء"})})]})}),e.jsx(pe,{open:wm,onOpenChange:Pn,children:e.jsxs(ge,{className:"sm:max-w-md",children:[e.jsx(fe,{children:e.jsx(ye,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(Xe).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Q,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(U,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل الرقم السري الرئيسي",value:So,onChange:t=>kn(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(nt,{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Pn(!1),kn("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",onClick:async()=>{if(!await ps.verifyMasterPin(So,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const a={};Object.keys(Xe).forEach(m=>{a[m]=0}),rs(a),localStorage.setItem(ys(),JSON.stringify(a)),Pn(!1),kn("");const r=new Date().toISOString(),l={walletBalances:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(o,JSON.stringify(l)),s!=null&&s.uid?Te.updateUserData(s.uid,l).then(()=>{localStorage.removeItem(o),Je(!1)}).catch(m=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",m),Je(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):Je(!0),setTimeout(()=>{rs({...a})},100)}catch(a){console.error("خطأ في تصفير أرصدة المحافظ:",a),i({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(pe,{open:Qd,onOpenChange:xn,children:e.jsxs(ge,{className:"sm:max-w-md",children:[e.jsx(fe,{children:e.jsx(ye,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((Mo=Ye.find(t=>t.id===Z))==null?void 0:Mo.name)||Z]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(Z&&Xe[Z]?Xe[Z]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Q,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(U,{id:"resetSelectedWalletPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:so,onChange:t=>ki(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(nt,{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{xn(!1),ki("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",onClick:async()=>{var a;if(!Z){i({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await ps.verifyMasterPin(so,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const r={...Xe};r[Z]=0,rs(r),localStorage.setItem(ys(),JSON.stringify(r)),xn(!1),ki("");const l=new Date().toISOString(),o={walletBalances:r,lastUpdated:l},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(o)),s!=null&&s.uid?Te.updateUserData(s.uid,o).then(()=>{localStorage.removeItem(m),Je(!1)}).catch(x=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",x),Je(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):Je(!0),i({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((a=Ye.find(x=>x.id===Z))==null?void 0:a.name)||Z}`})}catch(r){console.error("خطأ في تصفير رصيد المحفظة المختارة:",r),i({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(pe,{open:gm,onOpenChange:In,children:e.jsxs(ge,{className:"sm:max-w-md",children:[e.jsx(fe,{children:e.jsxs(ye,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(xs,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(Xe).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx(U,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:fo,onChange:t=>qi(t.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx(U,{id:"addWalletTotalPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري",value:yo,onChange:t=>Vi(t.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(nt,{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{In(!1),qi(""),Vi("")},children:"إلغاء"}),e.jsx(h,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:bo,onClick:async()=>{const t=parseFloat(fo);if(!t||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!await Sm(yo)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}vo(!0);try{const a=Object.values(Xe).reduce((r,l)=>r+l,0);if(a===0){const r=Object.keys(Xe),l=t/r.length,o={};r.forEach(m=>{o[m]=l}),rs(o),localStorage.setItem(ys(),JSON.stringify(o)),s!=null&&s.uid?await Te.updateUserData(s.uid,{walletBalances:o,lastUpdated:new Date().toISOString()}):Je(!0)}else{const r={};Object.entries(Xe).forEach(([l,o])=>{const m=o/a,x=t*m;r[l]=o+x}),rs(r),localStorage.setItem(ys(),JSON.stringify(r)),s!=null&&s.uid?await Te.updateUserData(s.uid,{walletBalances:r,lastUpdated:new Date().toISOString()}):Je(!0)}setTimeout(()=>{rs(r=>({...r}))},100),In(!1),qi(""),Vi("")}catch(a){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",a),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{vo(!1)}},children:bo?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(pe,{open:Nm,onOpenChange:_n,children:e.jsxs(ge,{className:"sm:max-w-[425px]",children:[e.jsx(fe,{children:e.jsxs(ye,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(is,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Q,{htmlFor:"resetCashPin",children:"الرقم السري الرئيسي"}),e.jsx(U,{id:"resetCashPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:Ki,onChange:t=>Ji(t.target.value)})]})]}),e.jsxs(nt,{children:[e.jsx(h,{variant:"outline",onClick:()=>{_n(!1),Ji("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",onClick:async()=>{if(!Ki){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await ps.verifyMasterPin(Ki,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{Ut(0),_n(!1),Ji("");const a={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem(bs(),"0");const r=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(r,JSON.stringify(a)),s!=null&&s.uid?Te.updateUserData(s.uid,a).then(()=>{localStorage.removeItem(r),Je(!1)}).catch(l=>{console.error("خطأ في حفظ الرصيد في Firebase:",l),Je(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):Je(!0)}catch(a){console.error("خطأ في تصفير الرصيد النقدي:",a),i({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(Zh,{open:pm,onOpenChange:go,userId:s==null?void 0:s.uid,cashBalance:It,walletBalances:Xe,transactions:ht}),e.jsx(pe,{open:xm,onOpenChange:Nr,children:e.jsxs(ge,{className:"sm:max-w-[425px]",children:[e.jsx(fe,{children:e.jsxs(ye,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(xs,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx(U,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:za,onChange:t=>jn(t.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{className:"text-right",children:"هل تريد إضافة ملاحظة؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{type:"button",variant:Sr==="yes"?"default":"outline",onClick:()=>Dr("yes"),className:"flex-1",children:"نعم"}),e.jsx(h,{type:"button",variant:Sr==="no"?"default":"outline",onClick:async()=>{if(Dr("no"),!za||parseFloat(za)<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!jr){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await On(jr)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}Dn(!0);try{const t=parseFloat(za),a=It+t;Ut(a),localStorage.setItem(bs(),a.toString());const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r));const o=`CASHADD-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`;Nr(!1),jn(""),Sn(""),Dr(null),Cn("");const m=[];if(s!=null&&s.uid){m.push(Te.updateUserData(s.uid,r).then(()=>{localStorage.removeItem(l),Je(!1)}).catch(()=>{Je(!0)}));const x={txnType:"cash_addition",type:"cash_addition",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:o,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(j==null?void 0:j.shopId)||void 0};m.push(Te.saveUserTransaction(s.uid,x));const p=j==null?void 0:j.shopId;if(p){const S=ze(K,"dashboardData",p);m.push(Es(S,{cashBalance:a}))}}Promise.allSettled(m).then(()=>{}).catch(()=>{})}catch{Ut(It),localStorage.setItem("cashBalance",It.toString()),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{Dn(!1)}},className:"flex-1",children:"لا"})]})]}),Sr==="yes"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"addCashNote",children:"الملاحظة"}),e.jsx(U,{id:"addCashNote",type:"text",placeholder:"اكتب الملاحظة",value:zi,onChange:t=>Cn(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx(U,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:jr,onChange:t=>Sn(t.target.value)})]})]}),e.jsxs(nt,{children:[e.jsx(h,{variant:"outline",onClick:()=>{Nr(!1),jn(""),Sn(""),Dr(null),Cn("")},children:"إلغاء"}),e.jsx(h,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:po,onClick:async()=>{if(!za||parseFloat(za)<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!jr){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await On(jr)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}if(Sr==="yes"&&zi.trim().length===0){i({title:"تنبيه",description:"أدخل الملاحظة أو اختر لا",variant:"destructive"});return}Dn(!0);try{const t=parseFloat(za),a=It+t;Ut(a),localStorage.setItem(bs(),a.toString());const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r));const o=`CASHADD-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`;Nr(!1),jn(""),Sn(""),Dr(null),Cn("");const m=[];if(s!=null&&s.uid){m.push(Te.updateUserData(s.uid,r).then(()=>{localStorage.removeItem(l),Je(!1)}).catch(()=>{Je(!0)}));const x={txnType:"cash_addition",type:"cash_addition",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:o,note:Sr==="yes"?zi.trim():void 0,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(j==null?void 0:j.shopId)||void 0};m.push(Te.saveUserTransaction(s.uid,x));const p=j==null?void 0:j.shopId;if(p){const S=ze(K,"dashboardData",p);m.push(Es(S,{cashBalance:a}))}}Promise.allSettled(m).then(()=>{}).catch(()=>{})}catch{Ut(It),localStorage.setItem("cashBalance",It.toString()),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{Dn(!1)}},children:po?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(pe,{open:Jd,onOpenChange:Ti,children:e.jsxs(ge,{className:"sm:max-w-md",children:[e.jsx(fe,{children:e.jsx(ye,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Q,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx(U,{id:"search-date",type:"date",value:Zr,onChange:t=>wl(t.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Q,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx(U,{id:"search-time",type:"time",value:Xr,onChange:t=>Nl(t.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(nt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>{wl(""),Nl(""),Ti(!1)},children:"مسح"}),e.jsx(h,{onClick:()=>Ti(!1),children:"تطبيق"})]})]})}),e.jsx(Go,{isOpen:Qt&&!Nt,onClose:()=>Zt(!1),onTrialStarted:Vd}),e.jsx(Gh,{isOpen:md,onClose:()=>ri(!1)}),e.jsx(Qh,{isOpen:Xn,onClose:()=>mr(!1),initialBarcode:qc}),e.jsx(ph,{isOpen:xd,onClose:()=>tn(!1)}),e.jsx(gh,{open:pd,onOpenChange:sn}),e.jsx(uu,{open:gd,onOpenChange:t=>{if(t&&!aa){i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}an(t)}}),e.jsx(vu,{open:H,onOpenChange:t=>{if(t&&!aa){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}te(t)}}),e.jsx(wu,{open:ie,onOpenChange:t=>{if(t&&!aa){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}M(t)}}),e.jsx(ms,{open:tm,onOpenChange:oo,onSuccess:()=>Mi(!0),title:"تقاريرك",description:"أدخل الرقم السري الرئيسي للوصول إلى تقاريرك",mode:"verify"}),e.jsx(pe,{open:Ei,onOpenChange:Mi,children:e.jsxs(ge,{className:"sm:max-w-xl",children:[e.jsxs(fe,{children:[e.jsxs(ye,{className:"flex items-center gap-2",children:[e.jsx(Vo,{className:"h-4 w-4 text-blue-600"}),"تقارير اليوم"]}),e.jsx(ds,{children:"ملخص معاملات اليوم محفوظ لآخر 30 يومًا مع أرشفة في السحابة"})]}),e.jsxs("div",{className:"space-y-4",children:[(()=>{const t=new Date().toDateString(),a=ht.filter(p=>{const S=new Date(p.createdAt).toDateString(),f=String(p.status||"completed").toLowerCase();return S===t&&(f==="completed"||f==="confirmed")}),r=a.length,l=a.reduce((p,S)=>p+Number(S.amount||0),0),o=a.filter(p=>p.type==="withdraw").reduce((p,S)=>p+Number(S.amount||0),0),m=a.filter(p=>p.type==="send").reduce((p,S)=>p+Number(S.amount||0),0),x=a.reduce((p,S)=>p+Number(us.calculateTransactionProfit(S)||0),0);return e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-blue-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-blue-700",children:"عدد المعاملات"}),e.jsx("div",{className:"text-lg font-bold text-blue-800",children:r})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-indigo-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-indigo-700",children:"إجمالي المبالغ"}),e.jsx("div",{className:"text-lg font-bold text-indigo-800",children:Number(l).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-red-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-red-700",children:"المبالغ المسحوبة"}),e.jsx("div",{className:"text-lg font-bold text-red-800",children:Number(o).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-green-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-green-700",children:"المبالغ المرسلة"}),e.jsx("div",{className:"text-lg font-bold text-green-800",children:Number(m).toFixed(2)})]}),e.jsxs("div",{className:"col-span-2 rounded-lg p-3 bg-gradient-to-r from-amber-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-amber-700",children:"الأرباح"}),e.jsx("div",{className:"text-lg font-bold text-amber-800",children:Number(x).toFixed(2)})]})]})})(),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(h,{variant:"default",onClick:async()=>{try{if(!(s!=null&&s.uid))return;const t=new Date,a=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0"),o=`${a}-${r}-${l}`,m=t.toDateString(),x=ht.filter($=>{const E=new Date($.createdAt).toDateString(),X=String($.status||"completed").toLowerCase();return E===m&&(X==="completed"||X==="confirmed")}),p=x.length,S=x.reduce(($,E)=>$+Number(E.amount||0),0),f=x.filter($=>$.type==="withdraw").reduce(($,E)=>$+Number(E.amount||0),0),v=x.filter($=>$.type==="send").reduce(($,E)=>$+Number(E.amount||0),0),P=x.reduce(($,E)=>$+Number(us.calculateTransactionProfit(E)||0),0);await Er.add({userId:s.uid,reportDate:o,totalTransactions:p,totalAmount:Number(S.toFixed(2)),totalWithdrawn:Number(f.toFixed(2)),totalSent:Number(v.toFixed(2)),profit:Number(P.toFixed(2)),walletId:null});try{await Er.trimToMaxCount(s.uid,30)}catch{}i({title:"تم الأرشفة",description:`تم حفظ تقرير ${o}`})}catch{i({title:"فشل الأرشفة",description:"تعذر حفظ التقرير",variant:"destructive"})}},children:"أرشفة اليوم"}),e.jsx(h,{variant:"outline",onClick:()=>Mi(!1),children:"إغلاق"})]}),e.jsx("div",{className:"mt-2 border-t pt-2",children:e.jsx("div",{className:"space-y-2 max-h-[40vh] overflow-auto",children:co.length===0?e.jsx("div",{className:"text-xs text-muted-foreground",children:"لا توجد تقارير محفوظة"}):co.map(t=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:t.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",t.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalAmount).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalWithdrawn).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalSent).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:Number(t.profit??0).toFixed(2)})]})]})]},t.id||`${t.userId}-${t.reportDate}`))})})]})]})}),e.jsx(pe,{open:em,onOpenChange:t=>{if(t){i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}Oi(!1)},children:e.jsxs(ge,{dir:"rtl",className:"sm:max-w-md w-[95vw] sm:w-auto rounded-2xl border border-emerald-200 shadow-xl bg-gradient-to-br from-white via-green-50 to-emerald-50 backdrop-blur-md data-[state=open]:animate-in data-[state=open]:fade-in-0 data-[state=open]:zoom-in-90 data-[state=open]:slide-in-from-bottom-8 duration-300",children:[e.jsxs(fe,{children:[e.jsx(ye,{className:"text-right text-green-700",children:"شحن رصيد الموبايل"}),e.jsx(ds,{className:"text-right text-gray-600",children:"أدخل البيانات ثم اضغط تأكيد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(Q,{htmlFor:"topupPhone",className:"text-right block",children:"رقم الموبايل"}),e.jsx(U,{id:"topupPhone",value:fn,onChange:t=>ao(t.target.value),placeholder:"010xxxxxxx",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx(Q,{className:"text-right block",children:"شركة التشغيل"}),e.jsxs(Ta,{value:yn,onValueChange:ro,children:[e.jsx(Pa,{className:"text-right",children:e.jsx(ka,{placeholder:"اختر الشركة"})}),e.jsxs(_a,{children:[e.jsx(Zs,{value:"vodafone",children:"فودافون"}),e.jsx(Zs,{value:"orange",children:"أورنج"}),e.jsx(Zs,{value:"etisalat",children:"اتصالات"}),e.jsx(Zs,{value:"we",children:"WE"})]})]})]}),e.jsxs("div",{children:[e.jsx(Q,{htmlFor:"topupAmount",className:"text-right block",children:"المبلغ بالجنيه"}),e.jsx(U,{id:"topupAmount",type:"number",value:bn,onChange:t=>no(t.target.value?Number(t.target.value):""),placeholder:"50",className:"text-right"})]})]}),e.jsxs(nt,{className:"flex gap-2 justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>Oi(!1),className:"border-gray-300",children:"إلغاء"}),e.jsx(h,{onClick:w,disabled:io||!fn||!yn||!bn,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:io?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})}),e.jsx(ms,{open:Id,onOpenChange:li,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{li(!1),er(!0)}}),e.jsx(ms,{open:Td,onOpenChange:Ol,mode:"verify",title:"تأكيد تغيير طلب الرقم السري للديون",description:"أدخل الرقم السري الرئيسي لتفعيل أو إلغاء طلب الرقم السري عند فتح الديون",onSuccess:async()=>{if(El!==null){const t=El;_l(t);try{const a=s==null?void 0:s.uid,r=a?`debtsPinRequired_${a}`:"debtsPinRequired";localStorage.setItem(r,String(t)),a&&await Te.updateUserData(a,{debtsPinRequired:t})}catch{}i({title:t?"تم تفعيل طلب الرقم السري للديون":"تم إلغاء طلب الرقم السري للديون",description:t?"سيُطلب الرقم السري الرئيسي عند فتح نافذة الديون.":"يمكن فتح نافذة الديون بدون طلب الرقم السري."})}Pd(null),Ol(!1)}}),e.jsx(oh,{open:Zd,onOpenChange:vr,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"سيتم حذف كل المعاملات السابقة نهائيًا من حسابك وFirebase.",onSuccess:async()=>{try{if(!(s!=null&&s.uid)){vr(!1);return}const t=new Date,a=l=>l instanceof Date?l:typeof(l==null?void 0:l.toDate)=="function"?l.toDate():new Date(String(l)),r=ht.filter(l=>a(l.createdAt)<t);await Te.updateUserData(s.uid,{recentReset:{keepLastCount:rr.keepLastCount??30,intervalDays:rr.intervalDays??7,lastResetAt:t}}),An(l=>({...l,lastResetAt:t})),i({title:"تم إخفاء المعاملات السابقة",description:"تم إخفاء كل الإيصالات الأقدم من وقت التصفير من العرض بدون التأثير على تقارير اليوم/الشهر أو الحدود."})}catch(t){console.error("فشل تنفيذ التصفير النهائي:",t),i({title:"فشل التصفير",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}finally{vr(!1)}}}),e.jsx(ms,{open:Ht,onOpenChange:Gt,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{Gt(!1),At(!0)}}),e.jsx(pe,{open:Cd,onOpenChange:er,children:e.jsxs(ge,{className:"sm:max-w-[425px]",children:[e.jsxs(fe,{className:"flex items-center justify-between",children:[e.jsx(ye,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx(Jo,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[Tm," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Q,{htmlFor:"debtorName",className:"text-right col-span-1",children:"اسم المديون"}),e.jsx(U,{id:"debtorName",value:oi,onChange:t=>Ml(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل اسم المديون"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Q,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(U,{id:"debtAmount",type:"number",value:ci,onChange:t=>$l(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Q,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx(U,{id:"debtReason",value:di,onChange:t=>Ll(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]}),e.jsx(nt,{children:e.jsx(h,{onClick:()=>{if(oi&&ci&&di){const t={id:Date.now().toString(),debtorName:oi,amount:parseFloat(ci),reason:di,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};mn(t),tr(!0)}else i({title:"بيانات غير مكتملة",description:"يرجى إدخال الاسم والمبلغ والسبب",variant:"destructive"})},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(h,{variant:"outline",className:"w-full",onClick:()=>yr(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(h,{variant:"outline",className:"w-full",onClick:()=>yi(!0),children:"إضافة عميل"})})]})}),e.jsx(pe,{open:xi,onOpenChange:yr,children:e.jsxs(ge,{className:"sm:max-w-[520px]",children:[e.jsxs(fe,{children:[e.jsx(ye,{className:"text-right",children:"إيصالات الديون"}),e.jsx(ds,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),Mt.length>0?e.jsxs("div",{className:"max-h-64 overflow-y-auto space-y-2",onScroll:t=>{const a=t.currentTarget;gi.length<Mt.length&&a.scrollTop+a.clientHeight>=a.scrollHeight-50&&pi(r=>r+1)},children:[gi.map(t=>e.jsx("div",{onClick:()=>{gr(t),Ca(!0),yr(!1),er(!1)},className:"p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium",children:t.debtorName}),e.jsx("p",{className:"text-sm text-gray-600",children:t.reason}),e.jsx("p",{className:"text-sm text-gray-500",children:Mn.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-lg",children:[t.amount," جنيه"]}),e.jsx(Kt,{variant:t.status==="paid"?"default":"secondary",className:t.status==="paid"?"bg-green-500":"bg-yellow-500",children:t.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},t.id)),gi.length<Mt.length&&e.jsx("div",{className:"flex justify-center pt-1",children:e.jsx(h,{variant:"outline",size:"sm",onClick:()=>pi(t=>t+1),children:"تحميل المزيد"})})]}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"}),e.jsxs(nt,{className:"flex justify-between mt-3",children:[e.jsx(h,{variant:"destructive",onClick:async()=>{try{if(!Mt||Mt.length===0){i({title:"لا توجد ديون",description:"القائمة فارغة بالفعل."});return}if(!window.confirm("هل تريد حذف كل إيصالات الديون؟ هذا الإجراء لا يمكن التراجع عنه."))return;const a=[];Ps(a),gr(null),await zs(a),i({title:"تم حذف كل إيصالات الديون",description:"تم تفريغ القائمة بالكامل."}),yr(!1)}catch(t){console.error("تعذر حذف كل إيصالات الديون:",t),i({title:"فشل الحذف",description:"حدث خطأ أثناء الحذف، حاول مرة أخرى.",variant:"destructive"})}},children:"حذف كل الإيصالات"}),e.jsx(h,{variant:"outline",onClick:()=>yr(!1),children:"إغلاق"})]})]})}),e.jsx(pe,{open:Md,onOpenChange:yi,children:e.jsxs(ge,{className:"sm:max-w-[480px]",children:[e.jsxs(fe,{children:[e.jsx(ye,{className:"text-right",children:"إضافة عميل"}),e.jsx(ds,{className:"text-right",children:"أدخل بيانات العميل ثم يمكنك تسجيل مبلغ دين عليه"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Q,{htmlFor:"customerName",className:"text-right col-span-1",children:"اسم العميل"}),e.jsx(U,{id:"customerName",value:vi,onChange:t=>zl(t.target.value),className:"col-span-3 text-right",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Q,{htmlFor:"customerMobile",className:"text-right col-span-1",children:"رقم الموبايل"}),e.jsx(U,{id:"customerMobile",value:wi,onChange:t=>ql(t.target.value),className:"col-span-3 text-right",placeholder:"اكتب رقم الموبايل"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!vi||!wi){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const t={id:Date.now().toString(),name:vi.trim(),mobile:wi.trim(),createdAt:new Date},a=[t,...Ls];await Fi(a),zl(""),ql(""),i({title:"تمت إضافة العميل",description:`تم إضافة ${t.name}`})},children:"إضافة"})}),e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx(Q,{className:"text-right block",children:"إضافة مبلغ على عميل"}),Ls.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(Ta,{value:on,onValueChange:Vl,children:[e.jsx(Pa,{className:"w-full",children:e.jsx(ka,{placeholder:"اختر عميل"})}),e.jsx(_a,{children:Ls.map(t=>e.jsxs(Zs,{value:t.id,children:[t.name," — ",t.mobile]},t.id))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Q,{htmlFor:"customerDebtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(U,{id:"customerDebtAmount",type:"number",value:Kl,onChange:t=>$d(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{className:"bg-orange-600 hover:bg-orange-700",onClick:async()=>{const t=parseFloat(Kl);if(!on){i({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(t)||t<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Ls.find(l=>l.id===on);if(!a)return;const r={id:Date.now().toString(),debtorName:a.name,customerId:a.id,mobile:a.mobile,amount:Number(t.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};mn(r),tr(!0)},children:"إضافة المبلغ"})})]}):e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد عملاء مسجلين. أضف عميلًا أولاً."})]}),e.jsxs("div",{className:"border-t pt-4 space-y-2",children:[e.jsx(Q,{className:"text-right block",children:"إدارة العملاء"}),Ls.length>0?e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:Ls.map(t=>e.jsxs("div",{className:"p-2 border rounded-md flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium text-sm",children:t.name}),e.jsx("div",{className:"text-xs text-gray-600",children:t.mobile})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:()=>{Jl(t.id),Ni(t.name||""),ji(t.mobile||""),cn(!0)},children:"تعديل"}),e.jsx(h,{variant:"destructive",size:"sm",onClick:()=>{Si(t.id),Di(t.name||""),dn(!0)},children:"حذف نهائي"})]})]},t.id))}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً."})]})]}),e.jsx(nt,{className:"flex justify-end",children:e.jsx(h,{variant:"outline",onClick:()=>yi(!1),children:"إغلاق"})})]})}),e.jsx(pe,{open:Fd,onOpenChange:dn,children:e.jsxs(ge,{hideClose:!0,className:"sm:max-w-[420px] rounded-2xl bg-gradient-to-br from-white via-rose-50 to-red-50 shadow-2xl border border-red-100 text-center",children:[e.jsxs(fe,{children:[e.jsx(ye,{className:"text-center text-xl font-bold text-red-700",children:"تأكيد حذف العميل"}),e.jsxs(ds,{className:"text-center text-gray-600",children:["سيتم حذف العميل نهائيًا: ",Gl]})]}),e.jsx("div",{className:"py-2 text-sm text-gray-700",children:"لا يمكن التراجع عن هذا الإجراء."}),e.jsxs(nt,{className:"flex justify-center gap-3",children:[e.jsx(h,{variant:"outline",onClick:()=>{dn(!1),Si(""),Di("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",className:"bg-red-600 hover:bg-red-700",onClick:async()=>{const t=Rd,a=Ls.filter(r=>r.id!==t);await Fi(a),on===t&&Vl(""),dn(!1),Si(""),Di(""),i({title:"تم حذف العميل",description:Gl})},children:"حذف نهائي"})]})]})}),e.jsx(pe,{open:Ld,onOpenChange:cn,children:e.jsxs(ge,{className:"sm:max-w-[420px]",children:[e.jsx(fe,{children:e.jsx(ye,{className:"text-right",children:"تعديل بيانات العميل"})}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Q,{htmlFor:"editCustomerName",className:"text-right col-span-1",children:"الاسم"}),e.jsx(U,{id:"editCustomerName",value:Yl,onChange:t=>Ni(t.target.value),className:"col-span-3 text-right"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Q,{htmlFor:"editCustomerMobile",className:"text-right col-span-1",children:"الموبايل"}),e.jsx(U,{id:"editCustomerMobile",value:Hl,onChange:t=>ji(t.target.value),className:"col-span-3 text-right"})]})]}),e.jsxs(nt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>cn(!1),children:"إلغاء"}),e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=Wd,a=Yl.trim(),r=Hl.trim();if(!t||!a||!r){i({title:"بيانات غير مكتملة",description:"أدخل الاسم ورقم الموبايل",variant:"destructive"});return}const l=Ls.map(m=>m.id===t?{...m,name:a,mobile:r}:m);await Fi(l);const o=Mt.map(m=>m.customerId===t?{...m,debtorName:a,mobile:r}:m);o!==Mt&&(Ps(o),await zs(o)),cn(!1),Jl(""),Ni(""),ji(""),i({title:"تم تحديث العميل",description:a})},children:"حفظ"})]})]})}),e.jsx(pe,{open:Ot,onOpenChange:At,children:e.jsxs(ge,{className:"sm:max-w-[520px]",children:[e.jsxs(fe,{children:[e.jsx(ye,{className:"text-right",children:"مصروفات المحل"}),e.jsx(ds,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Q,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx(U,{id:"expenseName",value:Js,onChange:t=>ea(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Q,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx(U,{id:"expenseAmount",type:"number",value:gs,onChange:t=>Fs(t.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Q,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx(U,{id:"expenseNotes",value:Ys,onChange:t=>A(t.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(nt,{className:"flex justify-between",children:[e.jsx(h,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!Js||!gs){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}Oe(!0)},children:"إضافة مصروف"}),e.jsx(h,{variant:"outline",onClick:()=>jt(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(pe,{open:Ct,onOpenChange:jt,children:e.jsxs(ge,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(fe,{children:[e.jsx(ye,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(ds,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),se.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:se.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:t.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left flex items-start gap-2",children:[e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[t.amount," جنيه"]}),e.jsx(Kt,{variant:"secondary",className:t.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:t.source==="cash"?"من النقدية":`من المحفظة${t.walletId?` (${t.walletId})`:""}`})]}),e.jsxs(h,{variant:"destructive",size:"sm",className:"shrink-0",onClick:()=>rm(t.id),title:"حذف نهائي",children:[e.jsx(is,{className:"w-4 h-4 ml-1"}),"حذف"]})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(pe,{open:Ce,onOpenChange:Oe,children:e.jsxs(ge,{className:"sm:max-w-[480px]",children:[e.jsx(fe,{children:e.jsx(ye,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(h,{variant:$e==="cash"?"default":"outline",className:$e==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>st("cash"),children:"الفلوس النقدية"}),e.jsx(h,{variant:$e==="wallet"?"default":"outline",className:$e==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>st("wallet"),children:"أرصدة المحافظ"}),e.jsx(h,{variant:$e==="fawry"?"default":"outline",className:$e==="fawry"?"bg-amber-600 hover:bg-amber-700 text-white":"",onClick:()=>st("fawry"),children:"فوري"})]}),$e==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(Ta,{value:B,onValueChange:Fe,children:[e.jsx(Pa,{className:"w-full",children:e.jsx(ka,{placeholder:"اختر محفظة"})}),e.jsx(_a,{children:Ye.map(t=>e.jsx(Zs,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(nt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>{Oe(!1),st(null),Fe("")},children:"إلغاء"}),e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=Number(gs);if(isNaN(t)||t<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!$e){i({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if($e==="cash"){const o=Number((It-t).toFixed(2));Ut(o),localStorage.setItem(bs(),o.toString());const m={cashBalance:o,lastUpdated:new Date().toISOString()},x=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(x,JSON.stringify(m)),s!=null&&s.uid?(await Te.updateUserData(s.uid,m),localStorage.removeItem(x),Je(!1)):Je(!0)}else if($e==="wallet"){if(!B){i({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const o=Xe[B]||0,m=Number((o-t).toFixed(2)),x={...Xe,[B]:m};rs(x);const p=new Date().toISOString(),S={walletBalances:x,lastUpdated:p},f=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(f,JSON.stringify(S)),localStorage.setItem(ys(),JSON.stringify(x)),localStorage.setItem(`walletBalances_backup_${p}`,JSON.stringify(x)),s!=null&&s.uid&&await Te.updateUserData(s.uid,S)}}catch(o){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",o)}let a=Date.now().toString();try{if(s!=null&&s.uid){const{addDoc:o,collection:m,serverTimestamp:x}=await gt(async()=>{const{addDoc:f,collection:v,serverTimestamp:P}=await import("./index-B57-Wohm.js").then($=>$.bK);return{addDoc:f,collection:v,serverTimestamp:P}},__vite__mapDeps([0,1]),import.meta.url),{db:p}=await gt(async()=>{const{db:f}=await import("./index-B57-Wohm.js").then(v=>v.bL);return{db:f}},__vite__mapDeps([0,1]),import.meta.url);a=(await o(m(p,"shop_expenses"),{userId:s.uid,shopId:T||(j==null?void 0:j.shopId)||s.uid||"default-shop",name:Js,amount:t,notes:Ys||"",source:$e,walletId:$e==="wallet"?B:null,createdAt:x()})).id}}catch(o){console.error("خطأ أثناء حفظ المصروف في Firestore:",o)}const r={id:a,name:Js,amount:t,notes:Ys,source:$e,walletId:$e==="wallet"?B:void 0,createdAt:new Date},l=[...se,r];await uo(l),ea(""),Fs(""),A(""),st(null),Fe(""),Oe(!1),At(!0),jt(!0),i({title:"تم إضافة المصروف",description:$e==="cash"?"تم الخصم من النقدية":$e==="wallet"?"تم الخصم من أرصدة المحافظ":"تم تسجيل الدفع عبر فوري"})},children:"تأكيد الخصم"})]})]})}),e.jsx(pe,{open:ta,onOpenChange:wa,children:e.jsxs(ge,{className:"sm:max-w-[520px]",children:[e.jsxs(fe,{children:[e.jsx(ye,{className:"text-right",children:"النواقص"}),e.jsx(ds,{className:"text-right",children:"سجل العناصر الناقصة التي تحتاج شراء وتابع حالتها."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Q,{htmlFor:"deficiencyName",className:"text-right col-span-1",children:"اسم العنصر"}),e.jsx(U,{id:"deficiencyName",value:oa,onChange:t=>sa(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: سكر، زيت، مناديل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Q,{htmlFor:"deficiencyQuantity",className:"text-right col-span-1",children:"الكمية"}),e.jsx(U,{id:"deficiencyQuantity",type:"number",value:z,onChange:t=>we(t.target.value),className:"col-span-3 text-right",placeholder:"1"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{className:"bg-rose-600 hover:bg-rose-700",onClick:()=>{if(bt){i({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}const t=parseInt(z||"1",10);if(!oa){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العنصر",variant:"destructive"});return}if(isNaN(t)||t<=0){i({title:"كمية غير صحيحة",description:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}(async()=>{if(s!=null&&s.uid)try{const{collection:r,addDoc:l,serverTimestamp:o}=await gt(async()=>{const{collection:p,addDoc:S,serverTimestamp:f}=await import("./index-B57-Wohm.js").then(v=>v.bK);return{collection:p,addDoc:S,serverTimestamp:f}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await gt(async()=>{const{db:p}=await import("./index-B57-Wohm.js").then(S=>S.bL);return{db:p}},__vite__mapDeps([0,1]),import.meta.url),x=await l(r(m,"deficiencies"),{userId:s.uid,shopId:T||(j==null?void 0:j.shopId)||s.uid||"default-shop",name:oa,quantity:t,status:"pending",createdAt:o()});try{const p=wn(),S=localStorage.getItem(p),f=S?JSON.parse(S):[],v=Array.isArray(f)?f:[],P=v.some(X=>String((X==null?void 0:X.id)||"")===x.id),$={id:x.id,name:oa,quantity:t,status:"pending",createdAt:new Date().toISOString()},E=P?v:[...v,$];localStorage.setItem(p,JSON.stringify(E))}catch{}sa(""),we(""),i({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"});return}catch(r){console.warn("فشل حفظ النواقص إلى Firestore، سيُستخدم التخزين المحلي:",r)}const a={id:Date.now().toString(),name:oa,quantity:t,status:"pending",createdAt:new Date};lt(r=>{const l=[...r,a];return Wi(l),l}),sa(""),we(""),i({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"})})()},children:"إضافة للنواقص"})}),St.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:St.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["الكمية: ",t.quantity]}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Kt,{variant:"secondary",className:t.status==="pending"?"bg-rose-100 text-rose-700":"bg-green-100 text-green-700",children:t.status==="pending"?"قيد الشراء":"تم الشراء"}),e.jsx(h,{variant:"outline",className:t.status==="pending"?"text-green-700 border-green-300 hover:bg-green-50":"text-rose-700 border-rose-300 hover:bg-rose-50",onClick:()=>{(async()=>{const a=t.status==="pending"?"purchased":"pending";if(s!=null&&s.uid)try{const{doc:r,updateDoc:l,serverTimestamp:o}=await gt(async()=>{const{doc:x,updateDoc:p,serverTimestamp:S}=await import("./index-B57-Wohm.js").then(f=>f.bK);return{doc:x,updateDoc:p,serverTimestamp:S}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await gt(async()=>{const{db:x}=await import("./index-B57-Wohm.js").then(p=>p.bL);return{db:x}},__vite__mapDeps([0,1]),import.meta.url);await l(r(m,"deficiencies",t.id),{status:a,updatedAt:o()});return}catch(r){console.warn("فشل تحديث حالة النواقص على Firestore، استخدام التخزين المحلي:",r)}lt(r=>{const l=r.map(o=>o.id===t.id?{...o,status:a}:o);return Wi(l),l})})()},title:t.status==="pending"?"تم الشراء":"إلغاء الشراء",children:t.status==="pending"?"تم الشراء":"إلغاء الشراء"}),e.jsx(h,{variant:"outline",className:"text-red-700 border-red-300 hover:bg-red-50",onClick:()=>{(async()=>{if(s!=null&&s.uid)try{const{doc:a,deleteDoc:r}=await gt(async()=>{const{doc:o,deleteDoc:m}=await import("./index-B57-Wohm.js").then(x=>x.bK);return{doc:o,deleteDoc:m}},__vite__mapDeps([0,1]),import.meta.url),{db:l}=await gt(async()=>{const{db:o}=await import("./index-B57-Wohm.js").then(m=>m.bL);return{db:o}},__vite__mapDeps([0,1]),import.meta.url);await r(a(l,"deficiencies",t.id));return}catch(a){console.warn("فشل حذف عنصر النواقص من Firestore، استخدام التخزين المحلي:",a)}lt(a=>{const r=a.filter(l=>l.id!==t.id);return Wi(r),r})})()},title:"حذف",children:"حذف"})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد عناصر مسجلة في النواقص"})]}),e.jsx(nt,{className:"flex justify-end",children:e.jsx(h,{variant:"outline",onClick:()=>wa(!1),children:"إغلاق"})})]})}),e.jsx(pe,{open:Bd,onOpenChange:tr,children:e.jsxs(ge,{className:"sm:max-w-[480px]",children:[e.jsx(fe,{children:e.jsx(ye,{className:"text-right",children:"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(h,{variant:ks==="cash"?"default":"outline",className:ks==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>br("cash"),children:"الفلوس النقدية"}),e.jsx(h,{variant:ks==="wallet"?"default":"outline",className:ks==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>br("wallet"),children:"أرصدة المحافظ"}),e.jsx(h,{variant:ks==="none"?"default":"outline",className:ks==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>br("none"),children:"بدون خصم"})]}),ks==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(Ta,{value:hn,onValueChange:Ci,children:[e.jsx(Pa,{className:"w-full",children:e.jsx(ka,{placeholder:"اختر محفظة"})}),e.jsx(_a,{children:Ye.map(t=>e.jsx(Zs,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(nt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>{tr(!1),mn(null),br(null),Ci("")},children:"إلغاء"}),e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=!!ln&&!sr,a=Number(t?ln.delta:(sr==null?void 0:sr.amount)||0);if(!ks){i({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(ks==="cash"){const r=Number((It-a).toFixed(2));Ut(r),localStorage.setItem(bs(),r.toString());const l=new Date().toISOString(),o={cashBalance:r,lastUpdated:l},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(o)),s!=null&&s.uid?await Te.updateUserData(s.uid,o).then(()=>{localStorage.removeItem(m),Je(!1)}).catch(()=>{Je(!0)}):Je(!0)}else if(ks==="wallet"){if(!hn){i({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const r=Xe[hn]||0,l=Number((r-a).toFixed(2)),o={...Xe,[hn]:l};rs(o);const m=new Date().toISOString(),x={walletBalances:o,lastUpdated:m},p=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(p,JSON.stringify(x)),localStorage.setItem(ys(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${m}`,JSON.stringify(o)),s!=null&&s.uid&&await Te.updateUserData(s.uid,x)}}catch(r){console.error("خطأ أثناء تحديث الأرصدة عند حفظ/تعديل الدين:",r)}if(t){if(!Ae)return;const r=Number(Ae.amount||0),l=Number(Ae.paidAmount||0),o=Number(ln.delta||0);if(ln.type==="decrease"){const m=Number((r-o).toFixed(2)),x=l>=m,p={...Ae,amount:m,status:x?"paid":"pending"},S=Mt.map(f=>f.id===Ae.id?p:f);Ps(S),gr(p),await zs(S);try{x&&(s!=null&&s.uid)&&(async()=>{const f=He(De(K,"userTransactions"),je("userId","==",s.uid),je("linkedDebtId","==",Ae.id),je("status","==","pending")),v=await it(f);await Promise.allSettled(v.docs.map(P=>Es(P.ref,{status:"completed",confirmedAt:new Date})))})().catch(f=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين بعد الإنقاص:",f))}catch(f){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة بعد الإنقاص:",f)}i({title:"تم إنقاص المبلغ",description:`المبلغ الجديد: ${m} جنيه`})}else{const m=r+o,x=l>=m,p={...Ae,amount:Number(m.toFixed(2)),status:x?"paid":"pending"},S=Mt.map(f=>f.id===Ae.id?p:f);Ps(S),gr(p),await zs(S),i({title:"تم زيادة المبلغ",description:`المبلغ الجديد: ${m} جنيه`})}}else if(sr){const r=[...Mt,sr];Ps(r),await zs(r)}Ml(""),$l(""),Ll(""),er(!1),tr(!1),mn(null),Rl(null),br(null),Ci(""),i({title:t?"تم تطبيق الخصم وتعديل الدين":ks==="none"?"تم حفظ الدين بدون خصم":"تم حفظ الدين وخصم المبلغ",description:ks==="none"?"لم يتم الخصم من الدرج أو المحافظ":ks==="cash"?`تم خصم ${a} من الرصيد النقدي`:`تم خصم ${a} من رصيد المحفظة`})},children:"تأكيد الخصم"})]})]})}),e.jsx(pe,{open:kd,onOpenChange:Ca,children:e.jsxs(ge,{className:"sm:max-w-[425px]",children:[e.jsx(fe,{children:e.jsx(ye,{className:"text-right",children:"إيصال الدين"})}),Ae&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:Mn.format(Ae.createdAt instanceof Date?Ae.createdAt:new Date(Ae.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:Ae.debtorName})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",className:"h-8 w-8 p-0","aria-label":"إنقاص الدين",onClick:()=>{Wl("decrease"),mi(""),Ca(!1),fr(!0)},children:"−"}),e.jsxs("span",{className:"font-bold text-lg",children:[Ae.amount," جنيه"]}),e.jsx(h,{variant:"outline",className:"h-8 w-8 p-0","aria-label":"زيادة الدين",onClick:()=>{Wl("increase"),mi(""),Ca(!1),fr(!0)},children:"+"})]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:Ae.reason})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(Kt,{variant:Ae.status==="paid"?"default":"secondary",className:Ae.status==="paid"?"bg-green-500":"bg-yellow-500",children:Ae.status==="paid"?"مدفوع":"مؤجل"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[Number(Ae.amount||0)-Number(Ae.paidAmount||0)," جنيه"]})]}),Ae.paidAmount?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[Ae.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-3 border rounded-lg bg-gray-50",children:[Od?e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx(U,{id:"partialAmount",type:"number",value:Bl,onChange:t=>ui(t.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{hi(!1),ui("")},children:"إلغاء"}),e.jsx(h,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const t=parseFloat(Bl);if(!Ae||isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Math.max(0,Number(Ae.amount||0)-Number(Ae.paidAmount||0));if(t>a){i({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const r=Number(((Ae.paidAmount||0)+t).toFixed(2)),l=r>=Number(Ae.amount||0),o={...Ae,amount:Number(Ae.amount||0),paidAmount:r,status:l?"paid":"pending",partialPayments:[...Ae.partialPayments||[],{amount:t,paidAt:new Date}]},m=Mt.map(x=>x.id===Ae.id?o:x);Ps(m),gr(o),await zs(m);try{o.status==="paid"&&(s!=null&&s.uid)&&(async()=>{const x=He(De(K,"userTransactions"),je("userId","==",s.uid),je("linkedDebtId","==",Ae.id),je("status","==","pending")),p=await it(x);await Promise.allSettled(p.docs.map(S=>Es(S.ref,{status:"completed",confirmedAt:new Date})))})().catch(x=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",x))}catch(x){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",x)}try{const x=Ri(),p=localStorage.getItem(x);if(p){const f=(JSON.parse(p)||[]).map(v=>(v==null?void 0:v.linkedDebtId)===Ae.id&&(v==null?void 0:v.status)==="pending"?{...v,status:"completed",confirmedAt:new Date}:v);localStorage.setItem(x,JSON.stringify(f)),da(v=>v.map(P=>(P==null?void 0:P.linkedDebtId)===Ae.id&&(P==null?void 0:P.status)==="pending"?{...P,status:"completed",confirmedAt:new Date}:P))}}catch(x){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",x)}un(t),Ia("cash"),ar(!0),hi(!1),ui(""),i({title:"تم تسجيل دفع جزء",description:`تم دفع ${t} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(h,{variant:"outline",className:"w-full",onClick:()=>hi(!0),children:"دفع جزء"}),Ae.partialPayments&&Ae.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-24 overflow-y-auto",children:Ae.partialPayments.map((t,a)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["دفع: ",t.amount," جنيه"]}),e.jsx("span",{children:new Date(t.paidAt).toLocaleString("ar-EG")})]},a))})]})]})]})]}),e.jsxs(nt,{className:"flex gap-2 justify-center",children:[e.jsx(h,{onClick:async()=>{if(Ae){const t=Mt.map(a=>a.id===Ae.id?{...a,status:"pending"}:a);Ps(t),await zs(t),Ca(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(h,{onClick:async()=>{if(Ae){const a=Math.max(0,Number(Ae.amount||0)-Number(Ae.paidAmount||0)),r=Mt.map(l=>l.id===Ae.id?{...l,amount:Number(l.amount||0),paidAmount:Number(((l.paidAmount||0)+a).toFixed(2)),status:"paid",partialPayments:[...l.partialPayments||[],...a>0?[{amount:a,paidAt:new Date}]:[]]}:l);Ps(r),a>0&&(un(a),Ia("cash"),ar(!0)),await zs(r);try{s!=null&&s.uid&&(Ae!=null&&Ae.id)&&(async()=>{const l=He(De(K,"userTransactions"),je("userId","==",s.uid),je("linkedDebtId","==",Ae.id),je("status","==","pending")),o=await it(l);await Promise.allSettled(o.docs.map(m=>Es(m.ref,{status:"completed",confirmedAt:new Date})))})().catch(l=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",l))}catch(l){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",l)}try{const l=Ri(),o=localStorage.getItem(l);if(o){const x=(JSON.parse(o)||[]).map(p=>(p==null?void 0:p.linkedDebtId)===Ae.id&&(p==null?void 0:p.status)==="pending"?{...p,status:"completed",confirmedAt:new Date}:p);localStorage.setItem(l,JSON.stringify(x)),da(p=>p.map(S=>(S==null?void 0:S.linkedDebtId)===Ae.id&&(S==null?void 0:S.status)==="pending"?{...S,status:"completed",confirmedAt:new Date}:S))}}catch(l){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",l)}Ca(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(h,{onClick:async()=>{if(Ae){const t=Mt.filter(a=>a.id!==Ae.id);Ps(t),await zs(t),Ca(!1),i({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(pe,{open:_d,onOpenChange:fr,children:e.jsxs(ge,{className:"sm:max-w-md rounded-2xl shadow-elegant border border-gray-200",children:[e.jsxs(fe,{children:[e.jsx(ye,{className:`text-right ${Ba==="decrease"?"text-red-600":"text-green-600"}`,children:Ba==="decrease"?"إنقاص مبلغ الدين":Ba==="increase"?"زيادة مبلغ الدين":"تعديل مبلغ الدين"}),e.jsxs(ds,{className:"text-right",children:["أدخل المبلغ ثم اضغط تأكيد لإتمام ",Ba==="decrease"?"الإنقاص":"الزيادة","."]})]}),e.jsxs("div",{className:"grid gap-4 py-2",children:[e.jsx(Q,{htmlFor:"debtAdjustAmount",className:"text-right",children:"المبلغ (جنيه)"}),e.jsx(U,{id:"debtAdjustAmount",type:"number",placeholder:"0.00",value:Fl,onChange:t=>mi(t.target.value)}),Ae&&e.jsxs("div",{className:"text-right text-sm text-muted-foreground",children:["المبلغ الحالي: ",e.jsx("span",{className:"font-semibold",children:Number(Ae.amount||0).toFixed(2)})," جنيه"]})]}),e.jsxs(nt,{className:"flex gap-2",children:[e.jsx(h,{variant:"secondary",onClick:()=>{fr(!1),Ca(!0)},children:"إلغاء"}),e.jsx(h,{className:Ba==="decrease"?"bg-red-600 hover:bg-red-700":"bg-green-600 hover:bg-green-700",onClick:async()=>{try{if(!Ae||!Ba)return;const t=Number(parseFloat(Fl||"0").toFixed(2));if(!t||isNaN(t)||t<=0){i({title:"قيمة غير صالحة",description:"يرجى إدخال مبلغ أكبر من صفر",variant:"destructive"});return}Rl({debtId:Ae.id,delta:t,type:Ba}),fr(!1),tr(!0)}catch(t){console.error("فشل تجهيز تعديل مبلغ الدين:",t),i({title:"خطأ",description:"تعذّر تجهيز تعديل مبلغ الدين",variant:"destructive"})}},children:"تأكيد"})]})]})}),e.jsx(pe,{open:Ud,onOpenChange:ar,children:e.jsxs(ge,{className:"sm:max-w-[480px]",children:[e.jsxs(fe,{children:[e.jsx(ye,{className:"text-right",children:"اختيار إضافة مبلغ السداد"}),e.jsx(ds,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 justify-center",children:[e.jsx(h,{variant:Ws==="cash"?"default":"outline",className:Ws==="cash"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>Ia("cash"),children:"الفلوس النقدية"}),e.jsx(h,{variant:Ws==="wallet"?"default":"outline",className:Ws==="wallet"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>Ia("wallet"),children:"أرصدة المحافظ"}),e.jsx(h,{variant:Ws==="fawry"?"default":"outline",className:Ws==="fawry"?"bg-amber-600 text-white":"",size:"sm",onClick:()=>Ia("fawry"),children:"فوري"}),e.jsx(h,{variant:Ws==="none"?"default":"outline",className:Ws==="none"?"bg-gray-600 text-white":"",size:"sm",onClick:()=>Ia("none"),children:"بدون إضافة"})]}),Ws==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:Ua,onChange:t=>Ii(t.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),Ye&&Ye.length>0?Ye.map(t=>e.jsx("option",{value:t.id,children:t.phone||t.name||t.id},t.id)):Object.keys(Xe||{}).map(t=>{var a,r,l,o,m,x;return e.jsx("option",{value:t,children:((a=Ye.find(p=>p.id===t))==null?void 0:a.phone)||((l=(r=JSON.parse(localStorage.getItem(Bi())||"[]"))==null?void 0:r.find(p=>p.id===t))==null?void 0:l.phone)||((m=(o=JSON.parse(localStorage.getItem(Bi())||"[]"))==null?void 0:o.find(p=>p.id===t))==null?void 0:m.name)||((x=Ye.find(p=>p.id===t))==null?void 0:x.name)||t},t)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[Ql," جنيه"]})]})]}),e.jsxs(nt,{className:"flex flex-wrap justify-between gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{ar(!1),un(0),Ia(null),Ii("")},children:"إلغاء"}),e.jsx(h,{onClick:async()=>{var t,a;try{const r=Ql;if(!r||r<=0){ar(!1);return}if(Ws==="cash"){const l=It+r;Ut(l),localStorage.setItem(bs(),l.toString());const o={cashBalance:l,lastUpdated:new Date().toISOString()},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(o)),s!=null&&s.uid?(Te.updateUserData(s.uid,o).catch(()=>Je(!0)),localStorage.removeItem(m),Je(!1)):Je(!0),i({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى الفلوس النقدية`})}else if(Ws==="wallet"){if(!Ua){i({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const l={...Xe,[Ua]:(Xe[Ua]||0)+r};rs(l);const o=(It||0)-r;Ut(o),localStorage.setItem(bs(),o.toString());const m=new Date().toISOString(),x={walletBalances:l,cashBalance:o,lastUpdated:m},p=`userData_${s==null?void 0:s.uid}`;if(localStorage.setItem(p,JSON.stringify(x)),localStorage.setItem(ys(),JSON.stringify(l)),localStorage.setItem(`walletBalances_backup_${m}`,JSON.stringify(l)),s!=null&&s.uid){Te.updateUserData(s.uid,x).catch(()=>Je(!0));try{localStorage.removeItem(p)}catch{}Je(!1)}else Je(!0);i({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى المحفظة ${((t=Ye.find(S=>S.id===Ua))==null?void 0:t.phone)||((a=Ye.find(S=>S.id===Ua))==null?void 0:a.name)||Ua} وتم خصم نفس المبلغ من درج النقدية`})}else if(Ws==="none"){const l=(It||0)-r;Ut(l),localStorage.setItem(bs(),l.toString());const o={cashBalance:l,lastUpdated:new Date().toISOString()},m=`userData_${s==null?void 0:s.uid}`;if(localStorage.setItem(m,JSON.stringify(o)),s!=null&&s.uid){Te.updateUserData(s.uid,o).catch(()=>Je(!0));try{localStorage.removeItem(m)}catch{}Je(!1)}else Je(!0);i({title:"تم تسجيل السداد",description:`تم خصم ${r} جنيه من درج النقدية بدون إضافة للمحافظ`})}else if(Ws==="fawry")i({title:"تم تسجيل سداد عبر فوري",description:`تم تسجيل ${r} جنيه كسداد عبر فوري بدون تعديل الأرصدة`});else{i({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}}catch(r){console.error("خطأ أثناء إضافة مبلغ السداد:",r),i({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{ar(!1),un(0),Ia(null),Ii("")}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(pe,{open:ld,onOpenChange:Fa,children:e.jsxs(ge,{hideClose:!0,className:"post-confirm-card sm:max-w-[420px] w-[90vw] rounded-2xl bg-gradient-to-br from-white via-indigo-50 to-blue-50 shadow-2xl border border-indigo-100",children:[e.jsxs(fe,{children:[e.jsx(ye,{className:"text-right text-2xl font-bold",children:(as==null?void 0:as.type)==="transfer"?"مبلغ يجب استلامه":"مبلغ يجب تسليمه"}),e.jsx(ds,{className:"text-right text-gray-600",children:(as==null?void 0:as.type)==="transfer"?"هذا هو المبلغ الواجب استلامه من العميل بعد التأكيد.":"هذا هو المبلغ الواجب تسليمه للعميل بعد التأكيد."})]}),e.jsxs("div",{className:"py-3 flex flex-col items-center gap-1.5",children:[e.jsxs("div",{className:"text-xl sm:text-2xl font-bold text-blue-700 tracking-wide",children:[Ns((as==null?void 0:as.amount)||0)," جنيه"]}),e.jsx("div",{className:"text-sm text-gray-500 text-right w-full",children:(as==null?void 0:as.type)==="transfer"?"المبلغ المعروض شامل عمولة التحويل.":pt?"العمولة مضافة ولا تؤثر على قيمة التسليم.":"العمولة مخصومة من المبلغ المسلّم للعميل."})]}),e.jsxs(nt,{className:"flex justify-end gap-2",children:[(as==null?void 0:as.type)==="transfer"&&e.jsx(h,{variant:"outline",id:"sendCodeBtn",onClick:mt,disabled:Sl,className:"btn-transfer-confirm",children:Sl?"جارٍ الإرسال...":"إرسال كود التحويل"}),e.jsx(h,{onClick:()=>{Fa(!1),ai(null)},className:"bg-green-600 hover:bg-green-700 text-white",children:(as==null?void 0:as.type)==="transfer"?"تم الاستلام":"تم التسليم"})]})]})}),e.jsx(Ah,{open:cd,onClose:()=>Xa(!1),onSubmit:xt,deviceId:Dl||vt||"",recipientMsisdn:String(ne==="transfer"?(Ts==null?void 0:Ts.receiver)||Cs||"":(($o=Ye.find(t=>t.id===Z))==null?void 0:$o.phone)||"").replace(/\D/g,"")}),e.jsx(Nu,{open:W,onOpenChange:he}),Cl]}))};export{Px as default};
