{"version":3,"file":"dailyOperationCountService-9b-RCNij.js","sources":["../../src/utils/dailyOperationCountService.ts"],"sourcesContent":["import { db } from '@/firebase';\nimport { doc, getDoc, setDoc, serverTimestamp } from 'firebase/firestore';\n\nexport type OperationType = 'transfer' | 'withdraw';\n\ninterface DailyOpCounts {\n  dayId: string;\n  confirmTransferCount: number;\n  confirmWithdrawCount: number;\n  updatedAt: any;\n}\n\nexport const dailyOperationCountService = {\n  getCurrentDayId(): string {\n    const now = new Date();\n    return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;\n  },\n\n  async getCounts(userId: string, dayId?: string): Promise<DailyOpCounts> {\n    const dId = dayId || this.getCurrentDayId();\n    const ref = doc(db, 'users', userId, 'dailyOps', dId);\n    const snap = await getDoc(ref);\n    if (!snap.exists()) {\n      const initial: DailyOpCounts = {\n        dayId: dId,\n        confirmTransferCount: 0,\n        confirmWithdrawCount: 0,\n        updatedAt: serverTimestamp(),\n      } as any;\n      await setDoc(ref, initial);\n      return { ...initial, updatedAt: new Date() };\n    }\n    const data = snap.data() as any;\n    return {\n      dayId: dId,\n      confirmTransferCount: Number(data?.confirmTransferCount || 0),\n      confirmWithdrawCount: Number(data?.confirmWithdrawCount || 0),\n      updatedAt: data?.updatedAt || serverTimestamp(),\n    };\n  },\n\n  async checkAndIncrement(userId: string, type: OperationType, maxPerDay: number): Promise<{ allowed: boolean; remaining: number }> {\n    const dayId = this.getCurrentDayId();\n    const ref = doc(db, 'users', userId, 'dailyOps', dayId);\n    const current = await this.getCounts(userId, dayId);\n    const currentCount = type === 'transfer' ? current.confirmTransferCount : current.confirmWithdrawCount;\n\n    if (currentCount >= maxPerDay) {\n      return { allowed: false, remaining: 0 };\n    }\n\n    const updateData: any = { updatedAt: serverTimestamp() };\n    if (type === 'transfer') {\n      updateData.confirmTransferCount = current.confirmTransferCount + 1;\n    } else {\n      updateData.confirmWithdrawCount = current.confirmWithdrawCount + 1;\n    }\n    await setDoc(ref, updateData, { merge: true });\n\n    const remaining = Math.max(0, maxPerDay - (currentCount + 1));\n    return { allowed: true, remaining };\n  },\n\n  async checkAndIncrementCombined(userId: string, type: OperationType, maxCombinedPerDay: number): Promise<{ allowed: boolean; remaining: number }> {\n    const dayId = this.getCurrentDayId();\n    const ref = doc(db, 'users', userId, 'dailyOps', dayId);\n    const current = await this.getCounts(userId, dayId);\n    const combined = Number(current.confirmTransferCount || 0) + Number(current.confirmWithdrawCount || 0);\n    if (combined >= maxCombinedPerDay) {\n      return { allowed: false, remaining: 0 };\n    }\n    const updateData: any = { updatedAt: serverTimestamp() };\n    if (type === 'transfer') {\n      updateData.confirmTransferCount = current.confirmTransferCount + 1;\n    } else {\n      updateData.confirmWithdrawCount = current.confirmWithdrawCount + 1;\n    }\n    await setDoc(ref, updateData, { merge: true });\n    const remaining = Math.max(0, maxCombinedPerDay - (combined + 1));\n    return { allowed: true, remaining };\n  },\n};\n\nexport default dailyOperationCountService;"],"names":["dailyOperationCountService","now","userId","dayId","dId","ref","doc","db","snap","getDoc","initial","serverTimestamp","setDoc","data","type","maxPerDay","current","currentCount","updateData","maxCombinedPerDay","combined"],"mappings":"oEAYO,MAAMA,EAA6B,CACxC,iBAA0B,CACxB,MAAMC,MAAU,KAChB,MAAO,GAAGA,EAAI,YAAA,CAAa,IAAI,OAAOA,EAAI,SAAA,EAAa,CAAC,EAAE,SAAS,EAAG,GAAG,CAAC,IAAI,OAAOA,EAAI,SAAS,EAAE,SAAS,EAAG,GAAG,CAAC,EACtH,EAEA,MAAM,UAAUC,EAAgBC,EAAwC,CACtE,MAAMC,EAAMD,GAAS,KAAK,gBAAA,EACpBE,EAAMC,EAAIC,EAAI,QAASL,EAAQ,WAAYE,CAAG,EAC9CI,EAAO,MAAMC,EAAOJ,CAAG,EAC7B,GAAI,CAACG,EAAK,SAAU,CAClB,MAAME,EAAyB,CAC7B,MAAON,EACP,qBAAsB,EACtB,qBAAsB,EACtB,UAAWO,EAAA,CAAgB,EAE7B,aAAMC,EAAOP,EAAKK,CAAO,EAClB,CAAE,GAAGA,EAAS,UAAW,IAAI,IAAK,CAC3C,CACA,MAAMG,EAAOL,EAAK,KAAA,EAClB,MAAO,CACL,MAAOJ,EACP,qBAAsB,QAAOS,GAAA,YAAAA,EAAM,uBAAwB,CAAC,EAC5D,qBAAsB,QAAOA,GAAA,YAAAA,EAAM,uBAAwB,CAAC,EAC5D,WAAWA,GAAA,YAAAA,EAAM,YAAaF,EAAA,CAAgB,CAElD,EAEA,MAAM,kBAAkBT,EAAgBY,EAAqBC,EAAqE,CAChI,MAAMZ,EAAQ,KAAK,gBAAA,EACbE,EAAMC,EAAIC,EAAI,QAASL,EAAQ,WAAYC,CAAK,EAChDa,EAAU,MAAM,KAAK,UAAUd,EAAQC,CAAK,EAC5Cc,EAAeH,IAAS,WAAaE,EAAQ,qBAAuBA,EAAQ,qBAElF,GAAIC,GAAgBF,EAClB,MAAO,CAAE,QAAS,GAAO,UAAW,CAAA,EAGtC,MAAMG,EAAkB,CAAE,UAAWP,GAAgB,EACrD,OAAIG,IAAS,WACXI,EAAW,qBAAuBF,EAAQ,qBAAuB,EAEjEE,EAAW,qBAAuBF,EAAQ,qBAAuB,EAEnE,MAAMJ,EAAOP,EAAKa,EAAY,CAAE,MAAO,GAAM,EAGtC,CAAE,QAAS,GAAM,UADN,KAAK,IAAI,EAAGH,GAAaE,EAAe,EAAE,CACpC,CAC1B,EAEA,MAAM,0BAA0Bf,EAAgBY,EAAqBK,EAA6E,CAChJ,MAAMhB,EAAQ,KAAK,gBAAA,EACbE,EAAMC,EAAIC,EAAI,QAASL,EAAQ,WAAYC,CAAK,EAChDa,EAAU,MAAM,KAAK,UAAUd,EAAQC,CAAK,EAC5CiB,EAAW,OAAOJ,EAAQ,sBAAwB,CAAC,EAAI,OAAOA,EAAQ,sBAAwB,CAAC,EACrG,GAAII,GAAYD,EACd,MAAO,CAAE,QAAS,GAAO,UAAW,CAAA,EAEtC,MAAMD,EAAkB,CAAE,UAAWP,GAAgB,EACrD,OAAIG,IAAS,WACXI,EAAW,qBAAuBF,EAAQ,qBAAuB,EAEjEE,EAAW,qBAAuBF,EAAQ,qBAAuB,EAEnE,MAAMJ,EAAOP,EAAKa,EAAY,CAAE,MAAO,GAAM,EAEtC,CAAE,QAAS,GAAM,UADN,KAAK,IAAI,EAAGC,GAAqBC,EAAW,EAAE,CACxC,CAC1B,CACF"}