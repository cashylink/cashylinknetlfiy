{"version":3,"file":"whatsappService-BLnGfqC0.js","sources":["../../src/utils/whatsappService.ts"],"sourcesContent":["import { doc, getDoc, setDoc } from 'firebase/firestore';\r\nimport { db, auth } from '@/firebase';\r\n\r\n// نوع البيانات لإعدادات الواتساب\r\nexport interface WhatsAppSettings {\r\n  phoneNumber: string;\r\n  defaultMessage: string;\r\n  isEnabled: boolean;\r\n  lastUpdated: Date;\r\n}\r\n\r\n// الإعدادات الافتراضية\r\nconst DEFAULT_SETTINGS: WhatsAppSettings = {\r\n  phoneNumber: \"201000392539\",\r\n  defaultMessage: \"مرحباً، أريد الاستفسار عن خدماتكم\",\r\n  isEnabled: true,\r\n  lastUpdated: new Date()\r\n};\r\n\r\n// مرجع المستند في Firestore\r\nconst SETTINGS_DOC_ID = 'whatsapp-settings';\r\nconst SETTINGS_COLLECTION = 'app-settings';\r\nconst WHATSAPP_CACHE_KEY = 'whatsapp_settings_cache';\r\n\r\n/**\r\n * تحميل إعدادات الواتساب من Firestore\r\n */\r\nexport const loadWhatsAppSettings = async (): Promise<WhatsAppSettings> => {\r\n  try {\r\n    // إذا لم يكن المستخدم مسجلاً الدخول، تجنب قراءة Firestore العامة لتفادي أخطاء الصلاحيات\r\n    if (!auth.currentUser) {\r\n      try {\r\n        const cached = localStorage.getItem(WHATSAPP_CACHE_KEY);\r\n        if (cached) {\r\n          const parsed = JSON.parse(cached);\r\n          return {\r\n            phoneNumber: parsed.phoneNumber || DEFAULT_SETTINGS.phoneNumber,\r\n            defaultMessage: parsed.defaultMessage || DEFAULT_SETTINGS.defaultMessage,\r\n            isEnabled: parsed.isEnabled !== undefined ? parsed.isEnabled : DEFAULT_SETTINGS.isEnabled,\r\n            lastUpdated: parsed.lastUpdated ? new Date(parsed.lastUpdated) : DEFAULT_SETTINGS.lastUpdated\r\n          } as WhatsAppSettings;\r\n        }\r\n      } catch {}\r\n      // مستخدم عام بدون كاش: ارجع الإعدادات الافتراضية بصمت\r\n      return DEFAULT_SETTINGS;\r\n    }\r\n\r\n    const docRef = doc(db, SETTINGS_COLLECTION, SETTINGS_DOC_ID);\r\n    const docSnap = await getDoc(docRef);\r\n    \r\n    if (docSnap.exists()) {\r\n      const data = docSnap.data();\r\n      const settings: WhatsAppSettings = {\r\n        phoneNumber: data.phoneNumber || DEFAULT_SETTINGS.phoneNumber,\r\n        defaultMessage: data.defaultMessage || DEFAULT_SETTINGS.defaultMessage,\r\n        isEnabled: data.isEnabled !== undefined ? data.isEnabled : DEFAULT_SETTINGS.isEnabled,\r\n        lastUpdated: data.lastUpdated?.toDate() || DEFAULT_SETTINGS.lastUpdated\r\n      };\r\n      // خزن نسخة في التخزين المحلي لاستخدامها لزوار غير مسجلين\r\n      try { localStorage.setItem(WHATSAPP_CACHE_KEY, JSON.stringify(settings)); } catch {}\r\n      return settings;\r\n    } else {\r\n      // إذا لم توجد الإعدادات، احفظ الإعدادات الافتراضية\r\n      await saveWhatsAppSettings(DEFAULT_SETTINGS);\r\n      return DEFAULT_SETTINGS;\r\n    }\r\n  } catch (error) {\r\n    // في حال أخطاء الصلاحيات أو الشبكة، استخدم الكاش أو الافتراضي بدون إزعاج المستخدم العام\r\n    try {\r\n      const cached = localStorage.getItem(WHATSAPP_CACHE_KEY);\r\n      if (cached) {\r\n        const parsed = JSON.parse(cached);\r\n        return {\r\n          phoneNumber: parsed.phoneNumber || DEFAULT_SETTINGS.phoneNumber,\r\n          defaultMessage: parsed.defaultMessage || DEFAULT_SETTINGS.defaultMessage,\r\n          isEnabled: parsed.isEnabled !== undefined ? parsed.isEnabled : DEFAULT_SETTINGS.isEnabled,\r\n          lastUpdated: parsed.lastUpdated ? new Date(parsed.lastUpdated) : DEFAULT_SETTINGS.lastUpdated\r\n        } as WhatsAppSettings;\r\n      }\r\n    } catch {}\r\n    return DEFAULT_SETTINGS;\r\n  }\r\n};\r\n\r\n/**\r\n * حفظ إعدادات الواتساب في Firestore\r\n */\r\nexport const saveWhatsAppSettings = async (settings: Partial<WhatsAppSettings>): Promise<boolean> => {\r\n  try {\r\n    const docRef = doc(db, SETTINGS_COLLECTION, SETTINGS_DOC_ID);\r\n    \r\n    // تحديث الإعدادات مع الاحتفاظ بالقيم الموجودة\r\n    const updatedSettings = {\r\n      ...settings,\r\n      lastUpdated: new Date()\r\n    };\r\n    \r\n    await setDoc(docRef, updatedSettings, { merge: true });\r\n    // حدث الكاش المحلي بعد نجاح الحفظ\r\n    try { localStorage.setItem(WHATSAPP_CACHE_KEY, JSON.stringify(updatedSettings)); } catch {}\r\n    return true;\r\n  } catch (error) {\r\n    console.error('خطأ في حفظ إعدادات الواتساب:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n/**\r\n * تنسيق رقم الواتساب (إزالة الرموز غير المرغوب فيها)\r\n */\r\nexport const formatPhoneNumber = (phoneNumber: string): string => {\r\n  // إزالة جميع الرموز غير الرقمية\r\n  const cleanNumber = phoneNumber.replace(/\\D/g, '');\r\n  \r\n  // التأكد من وجود رقم صحيح\r\n  if (cleanNumber.length < 10) {\r\n    throw new Error('رقم الهاتف يجب أن يحتوي على 10 أرقام على الأقل');\r\n  }\r\n  \r\n  return cleanNumber;\r\n};\r\n\r\n/**\r\n * التحقق من صحة رقم الواتساب\r\n */\r\nexport const validatePhoneNumber = (phoneNumber: string): boolean => {\r\n  try {\r\n    const formatted = formatPhoneNumber(phoneNumber);\r\n    return formatted.length >= 10 && formatted.length <= 15;\r\n  } catch {\r\n    return false;\r\n  }\r\n};\r\n\r\n/**\r\n * إنشاء رابط الواتساب\r\n */\r\nexport const createWhatsAppLink = (phoneNumber: string, message: string): string => {\r\n  const formattedNumber = formatPhoneNumber(phoneNumber);\r\n  const encodedMessage = encodeURIComponent(message);\r\n  return `https://wa.me/${formattedNumber}?text=${encodedMessage}`;\r\n};\r\n\r\n/**\r\n * إنشاء رابط واتساب للاشتراك في باقة معينة\r\n */\r\nexport const createSubscriptionWhatsAppLink = async (\r\n  planName: string, \r\n  price: string, \r\n  features: string[]\r\n): Promise<string> => {\r\n  const settings = await loadWhatsAppSettings();\r\n  \r\n  const message = `مرحباً! أريد الاشتراك في باقة ${planName} بسعر ${price}\r\n\r\nالمميزات المشمولة:\r\n${features.map(feature => `✅ ${feature}`).join('\\n')}\r\n\r\nأرجو التواصل معي لإتمام عملية الاشتراك.`;\r\n\r\n  return createWhatsAppLink(settings.phoneNumber, message);\r\n};\r\n\r\n/**\r\n * إنشاء رابط واتساب للاستفسار العام\r\n */\r\nexport const createGeneralWhatsAppLink = async (): Promise<string> => {\r\n  const settings = await loadWhatsAppSettings();\r\n  \r\n  const message = `مرحباً! أريد الاستفسار عن خدمات CashyLink لإدارة المحافظ الإلكترونية.\r\n\r\nأرجو التواصل معي لمعرفة المزيد عن الباقات المتاحة وكيفية البدء.`;\r\n\r\n  return createWhatsAppLink(settings.phoneNumber, message);\r\n};\r\n\r\n// Hook لاستخدام إعدادات الواتساب في React\r\nexport const useWhatsAppSettings = () => {\r\n  const [settings, setSettings] = React.useState<WhatsAppSettings | null>(null);\r\n  const [loading, setLoading] = React.useState(true);\r\n  const [error, setError] = React.useState<string | null>(null);\r\n\r\n  React.useEffect(() => {\r\n    const loadSettings = async () => {\r\n      try {\r\n        setLoading(true);\r\n        const loadedSettings = await loadWhatsAppSettings();\r\n        setSettings(loadedSettings);\r\n        setError(null);\r\n      } catch (err) {\r\n        setError('فشل في تحميل إعدادات الواتساب');\r\n        console.error(err);\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    };\r\n\r\n    loadSettings();\r\n  }, []);\r\n\r\n  const updateSettings = async (newSettings: Partial<WhatsAppSettings>) => {\r\n    try {\r\n      setLoading(true);\r\n      const success = await saveWhatsAppSettings(newSettings);\r\n      if (success && settings) {\r\n        setSettings({ ...settings, ...newSettings, lastUpdated: new Date() });\r\n        setError(null);\r\n        return true;\r\n      } else {\r\n        setError('فشل في حفظ الإعدادات');\r\n        return false;\r\n      }\r\n    } catch (err) {\r\n      setError('خطأ في تحديث الإعدادات');\r\n      console.error(err);\r\n      return false;\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return {\r\n    settings,\r\n    loading,\r\n    error,\r\n    updateSettings,\r\n    refreshSettings: () => loadWhatsAppSettings().then(setSettings)\r\n  };\r\n};\r\n\r\n// إضافة import React في أعلى الملف\r\nimport React from 'react';"],"names":["DEFAULT_SETTINGS","SETTINGS_DOC_ID","SETTINGS_COLLECTION","WHATSAPP_CACHE_KEY","loadWhatsAppSettings","auth","cached","parsed","docRef","doc","db","docSnap","getDoc","data","settings","_a","saveWhatsAppSettings","updatedSettings","setDoc","error","formatPhoneNumber","phoneNumber","cleanNumber","validatePhoneNumber","formatted","createWhatsAppLink","message","formattedNumber","encodedMessage","useWhatsAppSettings","setSettings","React","loading","setLoading","setError","loadedSettings","err","newSettings"],"mappings":"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"}