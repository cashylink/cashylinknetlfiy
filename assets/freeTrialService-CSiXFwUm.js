var O=Object.defineProperty;var A=(m,a,e)=>a in m?O(m,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):m[a]=e;var S=(m,a,e)=>A(m,typeof a!="symbol"?a+"":a,e);import{J as f,o as D,X as g,V as w,z as h,K as U,Y as p}from"./index-DCCNgGPW.js";class x{static async startFreeTrialFromAdmin(a){var e,i,r,l;try{const s=f(D,"users",a),o=await g(s);if(!o.exists())return{success:!1,message:"المستخدم غير موجود"};const t=o.data(),n=!!t.hasUsedFreeTrial,T=(i=(e=t.freeTrialStartDate)==null?void 0:e.toDate)!=null&&i.call(e)?t.freeTrialStartDate.toDate():t.freeTrialStartDate?new Date(t.freeTrialStartDate):null,d=(l=(r=t.freeTrialEndDate)==null?void 0:r.toDate)!=null&&l.call(r)?t.freeTrialEndDate.toDate():t.freeTrialEndDate?new Date(t.freeTrialEndDate):null;if(n&&!(n&&!T&&!d))return{success:!1,message:"لقد استخدم هذا المستخدم التجربة المجانية من قبل"};const u=new Date,c=await this.getTrialDurationHours(),E=new Date(u.getTime()+c*60*60*1e3);return await w(s,{hasUsedFreeTrial:!0,freeTrialStartDate:u,freeTrialEndDate:E,isOnFreeTrial:!0,isActive:!0,approved:!0,updatedAt:h()},{merge:!0}),{success:!0,message:`تم تفعيل التجربة المجانية لمدة ${c} ${c>=3&&c<=10?"ساعات":c===2?"ساعتين":"ساعة"}`}}catch(s){return console.error("Error starting admin free trial:",s),{success:!1,message:"حدث خطأ أثناء تفعيل التجربة المجانية"}}}static async startFreeTrial(a){var e,i,r,l;try{const s=f(D,"users",a),o=await g(s);if(!o.exists())return{success:!1,message:"المستخدم غير موجود"};const t=o.data(),n=!!t.hasUsedFreeTrial,T=(i=(e=t.freeTrialStartDate)==null?void 0:e.toDate)!=null&&i.call(e)?t.freeTrialStartDate.toDate():t.freeTrialStartDate?new Date(t.freeTrialStartDate):null,d=(l=(r=t.freeTrialEndDate)==null?void 0:r.toDate)!=null&&l.call(r)?t.freeTrialEndDate.toDate():t.freeTrialEndDate?new Date(t.freeTrialEndDate):null;if(n&&!(n&&!T&&!d))return{success:!1,message:"لقد استخدمت التجربة المجانية من قبل"};const u=new Date,c=await this.getTrialDurationHours(),E=new Date(u.getTime()+c*60*60*1e3);return await w(s,{hasUsedFreeTrial:!0,freeTrialStartDate:u,freeTrialEndDate:E,isOnFreeTrial:!0,isActive:!0,approved:!0,updatedAt:h()},{merge:!0}),{success:!0,message:`تم تفعيل التجربة المجانية لمدة ${c} ${c>=3&&c<=10?"ساعات":c===2?"ساعتين":"ساعة"}`}}catch(s){return console.error("خطأ في بدء التجربة المجانية:",s),{success:!1,message:"حدث خطأ أثناء تفعيل التجربة المجانية"}}}static async checkTrialValidity(a){var e,i,r,l;try{const s=f(D,"users",a),o=await g(s);if(!o.exists())return{isValid:!1,isExpired:!1,hoursRemaining:0,hasUsedTrial:!1};const t=o.data(),n=t.hasUsedFreeTrial||!1,T=t.isOnFreeTrial||!1;let d=(i=(e=t.freeTrialEndDate)==null?void 0:e.toDate)!=null&&i.call(e)?t.freeTrialEndDate.toDate():t.freeTrialEndDate?new Date(t.freeTrialEndDate):null;const F=(l=(r=t.freeTrialStartDate)==null?void 0:r.toDate)!=null&&l.call(r)?t.freeTrialStartDate.toDate():t.freeTrialStartDate?new Date(t.freeTrialStartDate):null;if(!n||!T||!d)return{isValid:!1,isExpired:!1,hoursRemaining:0,hasUsedTrial:n};const u=new Date;if(u>d){const R=U(t.subscription);return await p(s,{isOnFreeTrial:!1,isActive:R,approved:R,updatedAt:h()}),{isValid:!1,isExpired:!0,hoursRemaining:0,hasUsedTrial:n}}const E=d.getTime()-u.getTime();return{isValid:!0,isExpired:!1,hoursRemaining:Math.ceil(E/(1e3*3600)),hasUsedTrial:n}}catch(s){return console.error("خطأ في التحقق من صلاحية التجربة المجانية:",s),{isValid:!1,isExpired:!1,hoursRemaining:0,hasUsedTrial:!1}}}static async getTrialData(a){var e,i;try{const r=f(D,"users",a),l=await g(r);if(!l.exists())return{hasUsedFreeTrial:!1,freeTrialStartDate:null,freeTrialEndDate:null,isOnFreeTrial:!1};const s=l.data();return{hasUsedFreeTrial:s.hasUsedFreeTrial||!1,freeTrialStartDate:((e=s.freeTrialStartDate)==null?void 0:e.toDate())||null,freeTrialEndDate:((i=s.freeTrialEndDate)==null?void 0:i.toDate())||null,isOnFreeTrial:s.isOnFreeTrial||!1}}catch(r){return console.error("خطأ في الحصول على بيانات التجربة المجانية:",r),{hasUsedFreeTrial:!1,freeTrialStartDate:null,freeTrialEndDate:null,isOnFreeTrial:!1}}}static async getTrialDurationHours(){try{const a=f(D,"config","freeTrial"),e=await g(a);if(e.exists()){const i=e.data(),r=typeof(i==null?void 0:i.durationHours)=="number"?i.durationHours:this.TRIAL_DURATION_HOURS;return!Number.isFinite(r)||r<1?this.TRIAL_DURATION_HOURS:r}return this.TRIAL_DURATION_HOURS}catch(a){return console.warn("getTrialDurationHours: fallback to default due to error",a),this.TRIAL_DURATION_HOURS}}static async updateTrialDurationHours(a){try{if(!Number.isFinite(a)||a<1)return{success:!1,message:"المدة يجب أن تكون ساعة واحدة على الأقل"};const e=f(D,"config","freeTrial");return await w(e,{durationHours:a,updatedAt:h()},{merge:!0}),{success:!0,message:"تم تحديث مدة التجربة المجانية بنجاح"}}catch(e){return console.error("Error updating trial duration hours:",e),{success:!1,message:"تعذر تحديث مدة التجربة المجانية"}}}static async resetActiveTrialToCurrentDuration(a){var e,i;try{const r=f(D,"users",a),l=await g(r);if(!l.exists())return{success:!1,message:"المستخدم غير موجود"};const s=l.data(),o=!!s.isOnFreeTrial,t=(i=(e=s.freeTrialStartDate)==null?void 0:e.toDate)!=null&&i.call(e)?s.freeTrialStartDate.toDate():s.freeTrialStartDate?new Date(s.freeTrialStartDate):null;if(!o||!t)return{success:!1,message:"لا توجد تجربة نشطة لإعادة ضبطها"};const n=await this.getTrialDurationHours(),T=new Date(t.getTime()+n*60*60*1e3);return await p(r,{freeTrialEndDate:T,updatedAt:h()}),{success:!0,message:`تم ضبط نهاية التجربة إلى ${n} ${n>=3&&n<=10?"ساعات":n===2?"ساعتين":"ساعة"}`}}catch(r){return console.error("Error resetting active trial duration:",r),{success:!1,message:"تعذر إعادة ضبط مدة التجربة"}}}static async cancelActiveFreeTrial(a){try{const e=f(D,"users",a),i=await g(e);return i.exists()?!i.data().isOnFreeTrial?{success:!1,message:"لا توجد تجربة مجانية نشطة لهذا المستخدم"}:(await p(e,{isOnFreeTrial:!1,isActive:!1,approved:!1,freeTrialEndDate:new Date,updatedAt:h()}),{success:!0,message:"تم إلغاء التجربة المجانية وحُوّل الحساب إلى طلب تفعيل"}):{success:!1,message:"المستخدم غير موجود"}}catch(e){return console.error("Error cancelling active free trial:",e),{success:!1,message:"تعذر إلغاء التجربة المجانية الآن"}}}}S(x,"TRIAL_DURATION_HOURS",4);export{x as FreeTrialService};
//# sourceMappingURL=freeTrialService-CSiXFwUm.js.map
