import{R as i,m as Me,ag as Ee,u as _e,j as e,ah as K,ai as G,aj as H,ak as V,B as k,aK as ce,y as oe,I as de,af as A,q as _,s as F,t as N,aL as S,V as Fe,a1 as le,W as L,au as me,x as W}from"./index-CgV0sHeM.js";import{D as he}from"./dollar-sign-CUtjmL1D.js";import{P as Le}from"./UserDashboardPage-BxOlnKZi.js";import{a as Ue}from"./SimCardsAccessDialog-ja1xLiJY.js";import{B as $e}from"./battery-charging-DTcxFVrm.js";import"./VideoModal-3NrJTmLh.js";import"./ProfileSettingsPage-6rJ-8Y1I.js";import"./switch-CQytG77E.js";import"./square-pen-B77-kNO1.js";import"./select-Cjxh7T8L.js";import"./users-DcT8Qdqe.js";import"./circle-check-big-iKMCgwGI.js";import"./save-CK42wzuM.js";import"./crown-2lrrj6PS.js";import"./arrow-left-L-ZCLYHX.js";import"./tabs-B1SNyKq6.js";import"./index-BVTp5Qlg.js";import"./dropdown-menu-CLdLSeyn.js";import"./ProfileIcon-CCS5CeGE.js";import"./freeTrialService-DU5AUvYv.js";import"./broadcastService-DLuBcfgc.js";import"./bell-CyrMMN44.js";import"./profitService-9EsNGq16.js";import"./calendar-0_98-YC1.js";import"./arrow-down-left-BR8IyOzF.js";import"./wallet-BjpRmBYz.js";import"./printer-D4O-3a9p.js";import"./star-DyMukElk.js";const xt=({open:b,onOpenChange:ge,userId:r,cashBalance:R,walletBalances:Ie,transactions:ue})=>{const[xe,J]=i.useState(0),[be,U]=i.useState(0),[fe,Q]=i.useState(0),[pe,X]=i.useState(0),[ye,Y]=i.useState(0),[ve,Z]=i.useState(0),[$,w]=i.useState(R||0),[ee,ke]=i.useState(0),[Ne,T]=i.useState(!1),[te,B]=i.useState(null),{toast:j}=Me(),{shopId:x}=Ee()||{},{user:D,profile:n}=_e(),[we,O]=i.useState(!1),[I,P]=i.useState(""),[je,q]=i.useState(!1),[Se,M]=i.useState(!1),[ae,z]=i.useState(""),C=()=>`cashBalance_${r||"default"}_${x||(n==null?void 0:n.shopId)||"main"}`,E=a=>`${new Intl.NumberFormat("ar-EG",{maximumFractionDigits:0}).format(Number(a||0))} جنيه`;i.useEffect(()=>{let a;return(async()=>{if(!b||!r){b||J(0);return}try{const s=await A.getUserData(r),c=s==null?void 0:s.lastReceipt_accessory,m=c?new Date(c):new Date(0),d=m.toISOString().slice(0,10),y=_(F(N,"dailySales"),S("userId","==",r),...x?[S("shopId","==",x)]:[],S("date",">=",d));a=Fe(y,h=>{let g=0;h.forEach(f=>{var u;const l=f.data();if(l.isDeferred)return;let o=0;if((u=l.createdAt)!=null&&u.toDate?o=l.createdAt.toDate().getTime():l.createdAt instanceof Date?o=l.createdAt.getTime():l.date&&(o=new Date(l.date+"T"+(l.time||"00:00")).getTime()),o>m.getTime()){const v=Number(l.sellingPrice??0),p=Number(l.quantity??0);v>0&&p>0&&(g+=v*p)}}),J(g),U(0)},h=>{console.warn("Error listening to daily sales:",h)})}catch(s){console.warn("Failed to setup accessory sales listener:",s)}})(),()=>{a&&a()}},[b,r,x,ee]),i.useEffect(()=>{if(!b)return;(async()=>{let t={};try{r&&(t=await A.getUserData(r)||{})}catch{}const s=async()=>{try{if(!r){Q(0);return}const d=t==null?void 0:t.lastReceipt_maintenance,y=d?new Date(d).getTime():0;let h;try{const f=_(F(N,"maintenance_items"),S("userId","==",r),S("status","==","completed"));h=await W(f)}catch{h=await W(_(F(N,"maintenance_items"),S("userId","==",r)))}let g=0;h.forEach(f=>{var u,v;const l=f.data();if((l.status||"in_progress")!=="completed")return;const o=(v=(u=l.completedAt)==null?void 0:u.toDate)==null?void 0:v.call(u);if(o&&o.getTime()>y){const p=Number(l.repairPrice||0);Number.isFinite(p)&&p>0&&(g+=p)}}),Q(Math.max(0,g)),X(0)}catch(d){console.warn("فشل تحميل إجمالي فلوس الصيانة لليوم:",d)}},c=async()=>{try{if(!r){Y(0);return}const d=t==null?void 0:t.lastReceipt_machineCharging,y=d?new Date(d).getTime():0,h=_(F(N,"userTransactions"),S("userId","==",r)),g=await W(h);let f=0;g.forEach(l=>{var ie;const o=l.data();let u=0;if((ie=o.createdAt)!=null&&ie.toDate?u=o.createdAt.toDate().getTime():typeof o.createdAt=="string"&&(u=new Date(o.createdAt).getTime()),u<=y)return;const v=String(o.description||""),p=String(o.title||""),Be=o.title==="إيصال تحويل مكينه"||v.includes("تحويل مكنه")||v.includes("تحويل مكينه")||p.includes("تحويل مكنه")||p.includes("تحويل مكينه"),Oe=o.status==="completed"||o.status==="confirmed";Be&&Oe&&(f+=Number(o.amount)||0)}),Y(f),Z(0)}catch(d){console.warn(d)}},m=async()=>{var d;try{if(!r){U(0);return}try{const y=x||(n==null?void 0:n.shopId)||"main",h=await le(L(N,"dashboardData",y));if(h.exists()){const g=Number(((d=h.data())==null?void 0:d.cashBalance)||0);w(g);try{localStorage.setItem(`cashBalance_${r}`,String(g)),localStorage.setItem(C(),String(g))}catch{}}else w(Number((t==null?void 0:t.cashBalance)||R||0))}catch{w(Number((t==null?void 0:t.cashBalance)||R||0))}}catch{U(0),X(0),Z(0)}};await s(),await c(),await m()})()},[b,r,ue,R,x,ee]),i.useEffect(()=>{const a=t=>{var s;try{const c=Number((s=t==null?void 0:t.detail)==null?void 0:s.value);Number.isFinite(c)&&w(c)}catch{}};return window.addEventListener("cashBalanceChanged",a),()=>window.removeEventListener("cashBalanceChanged",a)},[b]),i.useEffect(()=>{if(!b||!r)return;const a=x||(n==null?void 0:n.shopId)||"main";return(async()=>{var s;try{const c=await le(L(N,"dashboardData",a));if(c.exists()){const m=Number(((s=c.data())==null?void 0:s.cashBalance)||0);w(m);try{localStorage.setItem(`cashBalance_${r}`,String(m)),localStorage.setItem(C(),String(m))}catch{}}}catch(c){console.warn("Error fetching dashboard data:",c)}})(),()=>{}},[b,r,x]);const re=Math.max(0,Number(xe)-Number(be)),se=Math.max(0,Number(fe)-Number(pe)),ne=Math.max(0,Number(ye)-Number(ve)),De=async a=>{if(r){new Date().toISOString().slice(0,10);try{let t=0;if(a==="accessory"?t=re:a==="maintenance"?t=se:a==="machineCharging"&&(t=ne),t<=0){j({title:"لا يوجد مبلغ لتأكيد استلامه",variant:"default"});return}const s=Math.max(0,Number($)-t);w(s);const c=new Date().toISOString();await A.updateUserData(r,{cashBalance:s,[`lastReceipt_${a}`]:c});try{const d=x||(n==null?void 0:n.shopId)||"main";await me(L(N,"dashboardData",d),{cashBalance:s,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${r}`,String(s)),localStorage.setItem(C(),String(s))}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:s}}))}catch{}ke(Date.now());let m="";a==="accessory"?m="الإكسسوار":a==="maintenance"?m="الصيانة":m="مكن الشحن",j({title:"تم الاستلام",description:`تم خصم ${t.toLocaleString("en-US",{maximumFractionDigits:0})} من الدرج وتصفير بند ${m}`})}catch{j({title:"خطأ",description:"تعذر تنفيذ عملية تم الاستلام",variant:"destructive"})}}},Te=()=>{P(""),z(""),O(!0)},Ce=()=>{if(!I.trim()){j({title:"سبب الخصم مطلوب",variant:"destructive"});return}O(!1),q(!0)},Ae=()=>{q(!1),M(!0)},Re=async()=>{try{if(!r)return;const a=Math.max(0,Number(ae||0));if(!Number.isFinite(a)||a<=0){j({title:"مبلغ غير صالح",description:"أدخل مبلغ خصم صحيح أكبر من الصفر",variant:"destructive"});return}const t=Math.max(0,Number($)-a);w(t),await A.updateUserData(r,{cashBalance:t});try{const c=x||(n==null?void 0:n.shopId)||"main";await me(L(N,"dashboardData",c),{cashBalance:t,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${r}`,String(t))}catch{}try{const c=new Date().toISOString();localStorage.setItem(C(),String(t)),localStorage.setItem(C()+"_lastUpdated",c)}catch{}const s={title:"ايصال خصم من الفلوس النقديه",type:"cash_deduction",amount:a,status:"completed",createdAt:new Date,note:I,cashierName:"الحساب الرئيسي"};try{await A.saveUserTransaction(r,s)}catch{}j({title:"تم الخصم",description:`تم خصم ${a.toLocaleString("en-US",{maximumFractionDigits:0})} من الدرج`}),M(!1),z(""),P("")}catch{j({title:"فشل الخصم",description:"تعذر تنفيذ عملية الخصم",variant:"destructive"})}};return e.jsx(K,{open:b,onOpenChange:ge,children:e.jsxs(G,{className:"sm:max-w-lg animate-in fade-in-90 zoom-in-95 slide-in-from-top-4 bg-white dark:bg-gray-900 border-gray-200 dark:border-gray-800",dir:"rtl",children:[e.jsx(H,{children:e.jsxs(V,{className:"flex items-center gap-2 text-right text-gray-900 dark:text-gray-100",children:[e.jsx(he,{className:"h-5 w-5 text-emerald-600 dark:text-emerald-500"}),"تفاصيل الفلوس النقدية"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-900/50 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 dark:text-amber-300 font-bold text-sm",children:[e.jsx(he,{className:"h-4 w-4"}),"مجموع الفلوس النقدية (الدرج)"]}),e.jsx("div",{className:"text-amber-700 dark:text-amber-400 font-extrabold text-sm",children:E($)})]}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-900/50 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 dark:text-blue-300 font-bold text-sm",children:[e.jsx(Le,{className:"h-4 w-4"}),"فلوس الاكسسوار"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-blue-700 dark:text-blue-400 font-extrabold text-sm",children:E(re)}),e.jsx(k,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 dark:from-blue-900/50 dark:to-blue-800/50 dark:text-blue-200 dark:hover:from-blue-800 dark:hover:to-blue-700",onClick:()=>{B("accessory"),T(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-emerald-50 dark:bg-emerald-950/30 border border-emerald-200 dark:border-emerald-900/50 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-800 dark:text-emerald-300 font-bold text-sm",children:[e.jsx(Ue,{className:"h-4 w-4"}),"فلوس الصيانة"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-emerald-700 dark:text-emerald-400 font-extrabold text-sm",children:E(se)}),e.jsx(k,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800 dark:from-emerald-900/50 dark:to-emerald-800/50 dark:text-emerald-200 dark:hover:from-emerald-800 dark:hover:to-emerald-700",onClick:()=>{B("maintenance"),T(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-violet-50 dark:bg-violet-950/30 border border-violet-200 dark:border-violet-900/50 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-violet-800 dark:text-violet-300 font-bold text-sm",children:[e.jsx($e,{className:"h-4 w-4"}),"مكن الشحن"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-violet-700 dark:text-violet-400 font-extrabold text-sm",children:E(ne)}),e.jsx(k,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-violet-100 to-violet-200 text-violet-700 hover:from-violet-200 hover:to-violet-300 hover:text-violet-800 dark:from-violet-900/50 dark:to-violet-800/50 dark:text-violet-200 dark:hover:from-violet-800 dark:hover:to-violet-700",onClick:()=>{B("machineCharging"),T(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-900/50 rounded-lg p-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-red-800 dark:text-red-300 font-bold text-sm",children:"خصم فلوس من الفلوس النقديه"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(k,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 dark:from-red-900/50 dark:to-red-800/50 dark:text-red-200 dark:hover:from-red-800 dark:hover:to-red-700",onClick:Te,children:"خصم"})})]})]}),e.jsx(ce,{open:Ne,onOpenChange:T,mode:"verify",title:"تأكيد الرقم السري لعملية تم الاستلام",description:"يرجى إدخال الرقم السري الرئيسي لتأكيد استلام المبلغ",userId:r||(D==null?void 0:D.uid),userRole:n==null?void 0:n.role,onSuccess:()=>{te&&(De(te),B(null)),T(!1)}}),e.jsx(K,{open:we,onOpenChange:O,children:e.jsxs(G,{className:"sm:max-w-sm bg-white dark:bg-gray-900 border-gray-200 dark:border-gray-800",children:[e.jsx(H,{children:e.jsx(V,{className:"text-gray-900 dark:text-gray-100",children:"سبب الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(oe,{htmlFor:"deduct-reason",className:"text-gray-900 dark:text-gray-100",children:"اكتب سبب الخصم"}),e.jsx(de,{id:"deduct-reason",value:I,onChange:a=>P(a.target.value),placeholder:"سبب الخصم",className:"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-900 dark:text-gray-100"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(k,{variant:"outline",onClick:()=>O(!1),className:"dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-800",children:"إلغاء"}),e.jsx(k,{onClick:Ce,className:"bg-red-600 hover:bg-red-700 text-white",children:"متابعة"})]})]})}),e.jsx(ce,{open:je,onOpenChange:q,mode:"verify",title:"تأكيد الرقم السري لعملية الخصم",description:"يرجى إدخال الرقم السري الرئيسي لمتابعة الخصم",userId:r||(D==null?void 0:D.uid),userRole:n==null?void 0:n.role,onSuccess:Ae}),e.jsx(K,{open:Se,onOpenChange:M,children:e.jsxs(G,{className:"sm:max-w-sm bg-white dark:bg-gray-900 border-gray-200 dark:border-gray-800",children:[e.jsx(H,{children:e.jsx(V,{className:"text-gray-900 dark:text-gray-100",children:"مبلغ الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(oe,{htmlFor:"deduct-amount",className:"text-gray-900 dark:text-gray-100",children:"أدخل مبلغ الخصم"}),e.jsx(de,{id:"deduct-amount",type:"number",value:ae,onChange:a=>z(a.target.value),placeholder:"0.00",className:"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-900 dark:text-gray-100"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(k,{variant:"outline",onClick:()=>M(!1),className:"dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-800",children:"إلغاء"}),e.jsx(k,{onClick:Re,className:"bg-red-600 hover:bg-red-700 text-white",children:"تأكيد الخصم"})]})]})})]})})};export{xt as CashSummaryDialog,xt as default};
//# sourceMappingURL=CashSummaryDialog-C_k_cUDk.js.map
