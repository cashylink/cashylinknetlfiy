const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-C_crvORM.js","./index-Bpuv6Nub.css","./dailyOperationCountService-BuoXgFag-CymNVAFH.js","./profitService-4r9FqAF7-CduXHB_-.js"])))=>i.map(i=>d[i]);
import{d as os,S as i,W as Cs,u as cd,C as dd,a_ as Zu,w as Ai,aB as On,a$ as md,E as eh,x as bi,b0 as oi,as as je,b1 as xr,j as Ge,z as Ve,R as Ae,G as Y,aj as me,L as Oa,v as Le,aS as ja,Z as ht,_ as ft,b2 as ci,aW as is,B as Ss,a6 as th,a9 as za,aE as di,aV as fs,f as et,ai as Ea,I as e,s as ah,a as x,T as mi,m as Bt,ae as Sa,b as Ds,t as q,aF as sh,aG as Ci,l as wi,ad as rh,aH as ud,b3 as Di,ag as Rc,Y as Ps,aI as Se,aJ as Ie,aK as Ce,aL as De,O as zc,aZ as ot,aM as va,i as ls,U as dt,av as pr,a0 as Ut,F as ns,A as Ur,b4 as mr,at as lo,b5 as ih,o as hd,b6 as En,M as Ni,a5 as xd,a1 as pd,n as nh,P as ba,N as gr,h as ui,b7 as qc,aA as lh,b8 as gd,b9 as eo,ba as oh,bb as to,g as fd,bc as Jc,bd as vd,be as ch,aR as fr,bf as yd,bg as dh,aC as Yc,bh as mh,bi as bd,bj as uh,aO as hh,bk as xh,aT as ph,bl as gh,bm as fh,bn as vh,bo as wd,bp as yh,bq as bh,br as wh,bs as Vc,bt as gs,bu as ao,bv as ji,bw as Nh,bx as Gc,by as Kc,bz as jh,bA as jn,bB as Sh}from"./index-C_crvORM.js";import{o as Ft,c as ma,i as Pa,l as Wt}from"./card-SlwaggFS-CAdsFCUe.js";import{d as ta}from"./badge-Cq-GDK1F-DDXBwU_3.js";import{Y as Si,n as Dn,o as Gs,$ as Ks,r as Hs,Z as Qs,Q as ps}from"./select-QKdc2TYn-CHN9ZvrB.js";import{u as ee}from"./label-_mnIMROJ-DCx9a6ad.js";import{P as Ia,E as ya,N as Ih}from"./MasterPinDialog-CDin1iyv-DlTaZHso.js";import{t as Is}from"./wallet-MP5ofXFw-CDPV0DMK.js";import{t as Ch,e as Nd}from"./star-CXUVfJ8s-CXzfOlXH.js";import{r as jd}from"./square-pen-CHl7RpbW-BMzFK7_G.js";import{L as da,k as Hc}from"./progress-BOoGedvV-B6WhIHhL.js";import{e as Es}from"./phone-fkjnGVtI-D5yZCm03.js";import{t as Sd}from"./arrow-left-BDVMu6ut-Bh3YlyBY.js";import{S as Dh,x as so}from"./separator-Dk6MyxBB-NxpaJVcK.js";import{a as Zs}from"./calendar-DYpYXkMW-opeuviNG.js";import{e as kn}from"./chart-column-DoUryAXS-BdNWdJcU.js";import{o as Xt}from"./dollar-sign-bNLkxbzG-DZad4YjE.js";import{L as Ah,I as Sn}from"./ProfileIcon-DCyirBaq-_qtyOTam.js";import{r as vr}from"./circle-alert-BbiXZQj6-CYYPNIuO.js";import{r as _n}from"./circle-x-CAZlwHZs-DZdNBdmE.js";import{t as er}from"./circle-check-big-DcMEd0KV-kvVPwXiq.js";import{l as Ca,P as Id,R as Qc,G as kh,O as _h,M as Tn,j as Th,_ as $h,w as Oh,V as oo}from"./MaintenanceDialog-BLQvmu15-BOct_vhE.js";import{h as Cd}from"./store-i3EEOQHb-BqQT5qw5.js";import{J as Eh,O as Ph}from"./switch-CNGODERG-BZo1O1B3.js";import{T as Fh,B as Lh}from"./broadcastService-DGqqg97J-DRJTOIRh.js";import{l as Xc,n as Mh}from"./textarea-DK4Tmvmm-BLT-W9oy.js";import{f as Uh,m as Wh,n as Bh,a as Rh,s as zh}from"./dropdown-menu-MkPhHRIa-CyVuRxiX.js";import{ProfitService as Xs}from"./profitService-4r9FqAF7-CduXHB_-.js";import{S as qh}from"./WalletsManagement-B4QYl-Sx-CNmEEzPU.js";import{FreeTrialService as Jh}from"./freeTrialService-BwabY7bi-Do-h6uD3.js";import{S as Yh,k as Vh}from"./walletSelectionPinService-DoL5ZSmj-2gN5ExkA.js";import{e as Gh}from"./crown-Bkdmlc37-LFwz8dsS.js";import"./shield-DSoskD-c-Cy9u9Dod.js";import"./download-DFIibxe--BxHqrDcR.js";import"./index-CS8iiUxP-G3EfImZz.js";import"./whatsappService-D7s14JCG-CHFrP19C.js";const xt=(l,m=xt,c=m.f||(m.f=["./index-tnWDkOuX.js","./index-Bpuv6Nub.css","./dailyOperationCountService-BuoXgFag.js","./profitService-4r9FqAF7.js"]))=>l.map(f=>c[f]);var Kh=Object.defineProperty,Dd=l=>{throw TypeError(l)},Hh=(l,m,c)=>m in l?Kh(l,m,{enumerable:!0,configurable:!0,writable:!0,value:c}):l[m]=c,Zc=(l,m,c)=>Hh(l,typeof m!="symbol"?m+"":m,c),co=(l,m,c)=>m.has(l)||Dd("Cannot "+c),oe=(l,m,c)=>(co(l,m,"read from private field"),c?c.call(l):m.get(l)),Na=(l,m,c)=>m.has(l)?Dd("Cannot add the same private member more than once"):m instanceof WeakSet?m.add(l):m.set(l,c),Qt=(l,m,c,f)=>(co(l,m,"write to private field"),m.set(l,c),c),ia=(l,m,c)=>(co(l,m,"access private method"),c);/**
* @license lucide-react v0.462.0 - ISC
*
* This source code is licensed under the ISC license.
* See the LICENSE file in the root directory of this source tree.
*/const Qh=Ds("Award",[["path",{d:"m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526",key:"1yiouv"}],["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}]]);/**
* @license lucide-react v0.462.0 - ISC
*
* This source code is licensed under the ISC license.
* See the LICENSE file in the root directory of this source tree.
*/const ed=Ds("Banknote",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]]);/**
* @license lucide-react v0.462.0 - ISC
*
* This source code is licensed under the ISC license.
* See the LICENSE file in the root directory of this source tree.
*/const Xh=Ds("BookOpen",[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]]);/**
* @license lucide-react v0.462.0 - ISC
*
* This source code is licensed under the ISC license.
* See the LICENSE file in the root directory of this source tree.
*/const Ad=Ds("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]);/**
* @license lucide-react v0.462.0 - ISC
*
* This source code is licensed under the ISC license.
* See the LICENSE file in the root directory of this source tree.
*/const $n=Ds("IdCard",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]);/**
* @license lucide-react v0.462.0 - ISC
*
* This source code is licensed under the ISC license.
* See the LICENSE file in the root directory of this source tree.
*/const ro=Ds("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
* @license lucide-react v0.462.0 - ISC
*
* This source code is licensed under the ISC license.
* See the LICENSE file in the root directory of this source tree.
*/const Rl=Ds("ListChecks",[["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}],["path",{d:"M13 6h8",key:"15sg57"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 18h8",key:"oe0vm4"}]]);/**
* @license lucide-react v0.462.0 - ISC
*
* This source code is licensed under the ISC license.
* See the LICENSE file in the root directory of this source tree.
*/const Zh=Ds("Notebook",[["path",{d:"M2 6h4",key:"aawbzj"}],["path",{d:"M2 10h4",key:"l0bgd4"}],["path",{d:"M2 14h4",key:"1gsvsf"}],["path",{d:"M2 18h4",key:"1bu2t1"}],["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["path",{d:"M16 2v20",key:"rotuqe"}]]);/**
* @license lucide-react v0.462.0 - ISC
*
* This source code is licensed under the ISC license.
* See the LICENSE file in the root directory of this source tree.
*/const yi=Ds("Package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["path",{d:"m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7",key:"yx3hmr"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);/**
* @license lucide-react v0.462.0 - ISC
*
* This source code is licensed under the ISC license.
* See the LICENSE file in the root directory of this source tree.
*/const An=Ds("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]);var ts,ut,In,Ra,Fr,hi,Js,ur,Cn,xi,pi,Lr,Mr,hr,gi,ea,fi,zl,ql,Jl,Yl,Vl,Gl,Kl,td,ad,e0=(ad=class extends wh{constructor(l,m){super(),Na(this,ea),Na(this,ts),Na(this,ut),Na(this,In),Na(this,Ra),Na(this,Fr),Na(this,hi),Na(this,Js),Na(this,ur),Na(this,Cn),Na(this,xi),Na(this,pi),Na(this,Lr),Na(this,Mr),Na(this,hr),Na(this,gi,new Set),this.options=m,Qt(this,ts,l),Qt(this,ur,null),Qt(this,Js,Vc()),this.bindMethods(),this.setOptions(m)}bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(oe(this,ut).addObserver(this),sd(oe(this,ut),this.options)?ia(this,ea,fi).call(this):this.updateResult(),ia(this,ea,Yl).call(this))}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return io(oe(this,ut),this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return io(oe(this,ut),this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,ia(this,ea,Vl).call(this),ia(this,ea,Gl).call(this),oe(this,ut).removeObserver(this)}setOptions(l){const m=this.options,c=oe(this,ut);if(this.options=oe(this,ts).defaultQueryOptions(l),this.options.enabled!==void 0&&typeof this.options.enabled!="boolean"&&typeof this.options.enabled!="function"&&typeof gs(this.options.enabled,oe(this,ut))!="boolean")throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");ia(this,ea,Kl).call(this),oe(this,ut).setOptions(this.options),m._defaulted&&!ao(this.options,m)&&oe(this,ts).getQueryCache().notify({type:"observerOptionsUpdated",query:oe(this,ut),observer:this});const f=this.hasListeners();f&&rd(oe(this,ut),c,this.options,m)&&ia(this,ea,fi).call(this),this.updateResult(),f&&(oe(this,ut)!==c||gs(this.options.enabled,oe(this,ut))!==gs(m.enabled,oe(this,ut))||ji(this.options.staleTime,oe(this,ut))!==ji(m.staleTime,oe(this,ut)))&&ia(this,ea,zl).call(this);const j=ia(this,ea,ql).call(this);f&&(oe(this,ut)!==c||gs(this.options.enabled,oe(this,ut))!==gs(m.enabled,oe(this,ut))||j!==oe(this,hr))&&ia(this,ea,Jl).call(this,j)}getOptimisticResult(l){const m=oe(this,ts).getQueryCache().build(oe(this,ts),l),c=this.createResult(m,l);return a0(this,c)&&(Qt(this,Ra,c),Qt(this,hi,this.options),Qt(this,Fr,oe(this,ut).state)),c}getCurrentResult(){return oe(this,Ra)}trackResult(l,m){return new Proxy(l,{get:(c,f)=>(this.trackProp(f),m==null||m(f),f==="promise"&&(this.trackProp("data"),!this.options.experimental_prefetchInRender&&oe(this,Js).status==="pending"&&oe(this,Js).reject(new Error("experimental_prefetchInRender feature flag is not enabled"))),Reflect.get(c,f))})}trackProp(l){oe(this,gi).add(l)}getCurrentQuery(){return oe(this,ut)}refetch({...l}={}){return this.fetch({...l})}fetchOptimistic(l){const m=oe(this,ts).defaultQueryOptions(l),c=oe(this,ts).getQueryCache().build(oe(this,ts),m);return c.fetch().then(()=>this.createResult(c,m))}fetch(l){return ia(this,ea,fi).call(this,{...l,cancelRefetch:l.cancelRefetch??!0}).then(()=>(this.updateResult(),oe(this,Ra)))}createResult(l,m){var c;const f=oe(this,ut),j=this.options,S=oe(this,Ra),u=oe(this,Fr),K=oe(this,hi),B=l!==f?l.state:oe(this,In),{state:F}=l;let D={...F},T=!1,a;if(m._optimisticResults){const se=this.hasListeners(),ge=!se&&sd(l,m),fe=se&&rd(l,f,m,j);(ge||fe)&&(D={...D,...Nh(F.data,l.options)}),m._optimisticResults==="isRestoring"&&(D.fetchStatus="idle")}let{error:v,errorUpdatedAt:P,status:R}=D;a=D.data;let E=!1;if(m.placeholderData!==void 0&&a===void 0&&R==="pending"){let se;S!=null&&S.isPlaceholderData&&m.placeholderData===(K==null?void 0:K.placeholderData)?(se=S.data,E=!0):se=typeof m.placeholderData=="function"?m.placeholderData((c=oe(this,pi))==null?void 0:c.state.data,oe(this,pi)):m.placeholderData,se!==void 0&&(R="success",a=Gc(S==null?void 0:S.data,se,m),T=!0)}if(m.select&&a!==void 0&&!E)if(S&&a===(u==null?void 0:u.data)&&m.select===oe(this,Cn))a=oe(this,xi);else try{Qt(this,Cn,m.select),a=m.select(a),a=Gc(S==null?void 0:S.data,a,m),Qt(this,xi,a),Qt(this,ur,null)}catch(se){Qt(this,ur,se)}oe(this,ur)&&(v=oe(this,ur),a=oe(this,xi),P=Date.now(),R="error");const H=D.fetchStatus==="fetching",te=R==="pending",Q=R==="error",A=te&&H,U=a!==void 0,ae={status:R,fetchStatus:D.fetchStatus,isPending:te,isSuccess:R==="success",isError:Q,isInitialLoading:A,isLoading:A,data:a,dataUpdatedAt:D.dataUpdatedAt,error:v,errorUpdatedAt:P,failureCount:D.fetchFailureCount,failureReason:D.fetchFailureReason,errorUpdateCount:D.errorUpdateCount,isFetched:D.dataUpdateCount>0||D.errorUpdateCount>0,isFetchedAfterMount:D.dataUpdateCount>B.dataUpdateCount||D.errorUpdateCount>B.errorUpdateCount,isFetching:H,isRefetching:H&&!te,isLoadingError:Q&&!U,isPaused:D.fetchStatus==="paused",isPlaceholderData:T,isRefetchError:Q&&U,isStale:mo(l,m),refetch:this.refetch,promise:oe(this,Js),isEnabled:gs(m.enabled,l)!==!1};if(this.options.experimental_prefetchInRender){const se=ne=>{ae.status==="error"?ne.reject(ae.error):ae.data!==void 0&&ne.resolve(ae.data)},ge=()=>{const ne=Qt(this,Js,ae.promise=Vc());se(ne)},fe=oe(this,Js);switch(fe.status){case"pending":l.queryHash===f.queryHash&&se(fe);break;case"fulfilled":(ae.status==="error"||ae.data!==fe.value)&&ge();break;case"rejected":(ae.status!=="error"||ae.error!==fe.reason)&&ge();break}}return ae}updateResult(){const l=oe(this,Ra),m=this.createResult(oe(this,ut),this.options);if(Qt(this,Fr,oe(this,ut).state),Qt(this,hi,this.options),oe(this,Fr).data!==void 0&&Qt(this,pi,oe(this,ut)),ao(m,l))return;Qt(this,Ra,m);const c=()=>{if(!l)return!0;const{notifyOnChangeProps:f}=this.options,j=typeof f=="function"?f():f;if(j==="all"||!j&&!oe(this,gi).size)return!0;const S=new Set(j??oe(this,gi));return this.options.throwOnError&&S.add("error"),Object.keys(oe(this,Ra)).some(u=>{const K=u;return oe(this,Ra)[K]!==l[K]&&S.has(K)})};ia(this,ea,td).call(this,{listeners:c()})}onQueryUpdate(){this.updateResult(),this.hasListeners()&&ia(this,ea,Yl).call(this)}},ts=new WeakMap,ut=new WeakMap,In=new WeakMap,Ra=new WeakMap,Fr=new WeakMap,hi=new WeakMap,Js=new WeakMap,ur=new WeakMap,Cn=new WeakMap,xi=new WeakMap,pi=new WeakMap,Lr=new WeakMap,Mr=new WeakMap,hr=new WeakMap,gi=new WeakMap,ea=new WeakSet,fi=function(l){ia(this,ea,Kl).call(this);let m=oe(this,ut).fetch(this.options,l);return l!=null&&l.throwOnError||(m=m.catch(eo)),m},zl=function(){ia(this,ea,Vl).call(this);const l=ji(this.options.staleTime,oe(this,ut));if(to||oe(this,Ra).isStale||!Kc(l))return;const m=jh(oe(this,Ra).dataUpdatedAt,l)+1;Qt(this,Lr,jn.setTimeout(()=>{oe(this,Ra).isStale||this.updateResult()},m))},ql=function(){return(typeof this.options.refetchInterval=="function"?this.options.refetchInterval(oe(this,ut)):this.options.refetchInterval)??!1},Jl=function(l){ia(this,ea,Gl).call(this),Qt(this,hr,l),!(to||gs(this.options.enabled,oe(this,ut))===!1||!Kc(oe(this,hr))||oe(this,hr)===0)&&Qt(this,Mr,jn.setInterval(()=>{(this.options.refetchIntervalInBackground||Sh.isFocused())&&ia(this,ea,fi).call(this)},oe(this,hr)))},Yl=function(){ia(this,ea,zl).call(this),ia(this,ea,Jl).call(this,ia(this,ea,ql).call(this))},Vl=function(){oe(this,Lr)&&(jn.clearTimeout(oe(this,Lr)),Qt(this,Lr,void 0))},Gl=function(){oe(this,Mr)&&(jn.clearInterval(oe(this,Mr)),Qt(this,Mr,void 0))},Kl=function(){const l=oe(this,ts).getQueryCache().build(oe(this,ts),this.options);if(l===oe(this,ut))return;const m=oe(this,ut);Qt(this,ut,l),Qt(this,In,l.state),this.hasListeners()&&(m==null||m.removeObserver(this),l.addObserver(this))},td=function(l){gd.batch(()=>{l.listeners&&this.listeners.forEach(m=>{m(oe(this,Ra))}),oe(this,ts).getQueryCache().notify({query:oe(this,ut),type:"observerResultsUpdated"})})},ad);function t0(l,m){return gs(m.enabled,l)!==!1&&l.state.data===void 0&&!(l.state.status==="error"&&m.retryOnMount===!1)}function sd(l,m){return t0(l,m)||l.state.data!==void 0&&io(l,m,m.refetchOnMount)}function io(l,m,c){if(gs(m.enabled,l)!==!1&&ji(m.staleTime,l)!=="static"){const f=typeof c=="function"?c(l):c;return f==="always"||f!==!1&&mo(l,m)}return!1}function rd(l,m,c,f){return(l!==m||gs(f.enabled,l)===!1)&&(!c.suspense||l.state.status!=="error")&&mo(l,c)}function mo(l,m){return gs(m.enabled,l)!==!1&&l.isStaleByTime(ji(m.staleTime,l))}function a0(l,m){return!ao(l.getCurrentResult(),m)}var kd=i.createContext(!1),s0=()=>i.useContext(kd);kd.Provider;function r0(){let l=!1;return{clearReset:()=>{l=!1},reset:()=>{l=!0},isReset:()=>l}}var i0=i.createContext(r0()),n0=()=>i.useContext(i0),l0=(l,m)=>{(l.suspense||l.throwOnError||l.experimental_prefetchInRender)&&(m.isReset()||(l.retryOnMount=!1))},o0=l=>{i.useEffect(()=>{l.clearReset()},[l])},c0=({result:l,errorResetBoundary:m,throwOnError:c,query:f,suspense:j})=>l.isError&&!m.isReset()&&!l.isFetching&&f&&(j&&l.data===void 0||oh(c,[l.error,f])),d0=l=>{if(l.suspense){const m=f=>f==="static"?f:Math.max(f??1e3,1e3),c=l.staleTime;l.staleTime=typeof c=="function"?(...f)=>m(c(...f)):m(c),typeof l.gcTime=="number"&&(l.gcTime=Math.max(l.gcTime,1e3))}},m0=(l,m)=>l.isLoading&&l.isFetching&&!m,u0=(l,m)=>(l==null?void 0:l.suspense)&&m.isPending,id=(l,m,c)=>m.fetchOptimistic(l).catch(()=>{c.clearReset()});function h0(l,m,c){var f,j,S,u,K;const B=s0(),F=n0(),D=md(),T=D.defaultQueryOptions(l);(j=(f=D.getDefaultOptions().queries)==null?void 0:f._experimental_beforeQuery)==null||j.call(f,T),T._optimisticResults=B?"isRestoring":"optimistic",d0(T),l0(T,F),o0(F);const a=!D.getQueryCache().get(T.queryHash),[v]=i.useState(()=>new m(D,T)),P=v.getOptimisticResult(T),R=!B&&l.subscribed!==!1;if(i.useSyncExternalStore(i.useCallback(E=>{const H=R?v.subscribe(gd.batchCalls(E)):eo;return v.updateResult(),H},[v,R]),()=>v.getCurrentResult(),()=>v.getCurrentResult()),i.useEffect(()=>{v.setOptions(T)},[T,v]),u0(T,P))throw id(T,v,F);if(c0({result:P,errorResetBoundary:F,throwOnError:T.throwOnError,query:D.getQueryCache().get(T.queryHash),suspense:T.suspense}))throw P.error;if((u=(S=D.getDefaultOptions().queries)==null?void 0:S._experimental_afterQuery)==null||u.call(S,T,P),T.experimental_prefetchInRender&&!to&&m0(P,B)){const E=a?id(T,v,F):(K=D.getQueryCache().get(T.queryHash))==null?void 0:K.promise;E==null||E.catch(eo).finally(()=>{v.updateResult()})}return T.notifyOnChangeProps?P:v.trackResult(P)}function nd(l,m){return h0(l,e0)}const _d=async(l={})=>{try{return(await hd(fd,"getLastTransactions")(l)).data}catch(m){throw console.error("Error getting last transactions:",m),m.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):m.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+m.message):m.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+m.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(m.message||"خطأ غير معروف"))}},x0=async l=>(await hd(fd,"sendTelegramMessage")(l)).data,p0=Object.freeze(Object.defineProperty({__proto__:null,getLastTransactions:_d,sendTelegramMessage:x0},Symbol.toStringTag,{value:"Module"})),g0=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],f0=({isOpen:l,onClose:m,onWalletSelect:c,onEditWallet:f,onDeleteWallet:j})=>{const{user:S}=Cs(),[u,K]=i.useState([]),[B,F]=i.useState(!1),[D,T]=i.useState([]),[a,v]=i.useState(!1),{toast:P}=os(),R=async(A,U)=>{const ae=new Date().getMonth(),se=new Date().getFullYear(),ge=U.filter(tt=>{const We=new Date(tt.createdAt);return We.getMonth()===ae&&We.getFullYear()===se&&(tt.lineId===A||tt.fromWallet===A)}),fe=tt=>{const We=tt.type;return tt.txnType==="receive"||We==="withdraw"||We==="withdrawal"||We==="receive"},ne=tt=>{const We=tt.type;return tt.txnType==="send"||We==="send"||We==="transfer"},Ue=ge.filter(fe).reduce((tt,We)=>{const Qe=We.withdrawnAmount!==void 0?We.withdrawnAmount:We.amount;return tt+(Qe||0)},0),Ct=ge.filter(ne).reduce((tt,We)=>{const Qe=We.sentAmount!==void 0?We.sentAmount:We.amount;return tt+(Qe||0)},0);return{withdrawalUsage:Ue,transferUsage:Ct}},E=A=>{const U=new Date().toISOString().split("T")[0],ae=A.lastResetDate;if(!ae)return{...A,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:U};const se=new Date(ae),ge=new Date;return se.getMonth()!==ge.getMonth()||se.getFullYear()!==ge.getFullYear()?{...A,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:U}:A};i.useEffect(()=>{!(S!=null&&S.uid)||!l||(async()=>{v(!0);try{const A=await fs.getByMerchantId(S.uid),U=await En.getByUserId(S.uid),ae=(await Promise.all(A.map(async se=>{const{withdrawalUsage:ge,transferUsage:fe}=await R(se.id,U),ne=await is.getWalletLimits(se.id);return{id:se.id,name:se.label||"محفظة بدون اسم",phone:se.msisdn,nationalId:se.nationalId||"",isDefault:!1,isActive:se.isActive===!0,monthlyWithdrawalLimit:(ne==null?void 0:ne.monthlyWithdrawLimit)??se.withdrawLimit??2e5,monthlyTransferLimit:(ne==null?void 0:ne.monthlyTransferLimit)??se.transferLimit??2e5,monthlyWithdrawalUsage:(ne==null?void 0:ne.monthlyWithdrawUsed)??ge??0,monthlyTransferUsage:(ne==null?void 0:ne.monthlyTransferUsed)??fe??0,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:se.walletProvider||""}}))).map(E);K(ae)}catch(A){console.error("Error loading wallets:",A),P({title:"فشل جلب بيانات المحافظ",description:"قد تكون المشكلة بسبب الصلاحيات أو الاتصال. سيتم عرض البيانات المحلية إن وُجدت. جرّب تسجيل الدخول مجددًا أو افتح صفحة اختبار المصادقة من القائمة.",variant:"destructive"})}finally{v(!1)}})()},[S==null?void 0:S.uid,l]);const H=A=>g0.find(U=>U.id===A),te=(A,U)=>U>0?Math.min(A/U*100,100):0,Q=A=>new Intl.NumberFormat("ar-EG").format(A);return e.jsx(Se,{open:l,onOpenChange:m,children:e.jsxs(Ie,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(Ce,{className:"pb-4",children:[e.jsxs(De,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Is,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(ta,{variant:"secondary",className:"mr-2",children:[u.length," محفظة"]})]}),e.jsx("div",{className:"flex items-center gap-2 mt-2",children:B?e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",onClick:async()=>{try{if(!(S!=null&&S.uid))return;const A=u.map(U=>fs.update(U.id,{isActive:D.includes(U.id)}));await Promise.all(A),K(U=>U.map(ae=>({...ae,isActive:D.includes(ae.id)}))),F(!1),P({title:"تم تفعيل المحافظ",description:"فقط المحافظ المحددة ستظهر في الاختيار الخارجي"});try{window.dispatchEvent(new CustomEvent("wallets:activation-updated"))}catch{}}catch(A){console.error("Error activating wallets:",A),P({title:"فشل التفعيل",description:"تعذر تفعيل المحافظ المحددة",variant:"destructive"})}},className:"h-7",children:"تفعيل المحافظ"}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>{F(!1),T([])},className:"h-7",children:"إلغاء"})]}):e.jsx(x,{variant:"outline",size:"sm",onClick:()=>F(!0),className:"h-7",children:"تحديد المحافظ"})})]}),a?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):u.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Is,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:u.map(A=>{const U=H(A.walletProvider||"");te(A.monthlyWithdrawalUsage||0,A.monthlyWithdrawalLimit),te(A.monthlyTransferUsage||0,A.monthlyTransferLimit);const ae=D.includes(A.id),se=B?`cursor-pointer transition-shadow border-2 ${ae?"border-blue-500 shadow-lg":"hover:border-blue-300"}`:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300";return e.jsxs(Ft,{className:se,onClick:()=>{B?T(ge=>ge.includes(A.id)?ge.filter(fe=>fe!==A.id):[...ge,A.id]):c(A)},children:[e.jsx(ma,{className:"pb-3",children:e.jsxs(Pa,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ci,{className:"h-4 w-4"}),e.jsx("span",{children:A.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[A.isActive&&e.jsx(ta,{variant:"default",className:"text-xs",children:"نشطة"}),A.isDefault&&e.jsxs(ta,{variant:"default",className:"text-xs",children:[e.jsx(Nd,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(x,{variant:"ghost",size:"sm",onClick:ge=>{ge.stopPropagation(),f==null||f(A)},className:"h-7 px-2",children:e.jsx(jd,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",onClick:ge=>{ge.stopPropagation(),j==null||j(A.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(da,{className:"h-4 w-4"})})]})]})}),e.jsxs(Wt,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Es,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:A.phone})]}),A.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx($n,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:A.nationalId})]}),U&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ad,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:U.name})]})]}),(()=>{const ge=A.monthlyWithdrawalLimit,fe=A.monthlyTransferLimit,ne=A.monthlyWithdrawalUsage||0,Ue=A.monthlyTransferUsage||0,Ct=Math.max(ge-ne,0),tt=Math.max(fe-Ue,0);return e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{className:"text-xs text-gray-600 font-medium text-center",children:["الحدود الشهرية: ",(U==null?void 0:U.name)||A.walletProvider," - ",A.phone]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(ne/Math.max(ge,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Ue/Math.max(fe,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Q(Ct)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Q(tt)," جنيه"]})]})]})})(),e.jsx(x,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:ge=>{ge.stopPropagation(),c(A)},children:"عرض التفاصيل الكاملة"})]})]},A.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(x,{onClick:m,variant:"outline",children:[e.jsx(Sd,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},v0=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],y0=({wallet:l,isOpen:m,onClose:c,onBack:f})=>{const{user:j}=Cs(),[S,u]=i.useState([]),[K,B]=i.useState(!1),[F,D]=i.useState("month"),{toast:T}=os();if(i.useEffect(()=>{!l||!(j!=null&&j.uid)||!m||(async()=>{B(!0);try{const Z=(await En.getByUserId(j.uid)).filter(ye=>ye.walletId===l.id).sort((ye,it)=>new Date(it.createdAt).getTime()-new Date(ye.createdAt).getTime());u(Z)}catch(Z){console.error("Error loading transactions:",Z),T({title:"فشل جلب معاملات المحفظة",description:"قد تكون المشكلة بسبب صلاحيات Firestore أو الاتصال. تم عرض ما أمكن محليًا. جرّب تسجيل الدخول مجددًا أو صفحة اختبار المصادقة.",variant:"destructive"})}finally{B(!1)}})()},[l,j==null?void 0:j.uid,m]),!l)return null;const a=Z=>v0.find(ye=>ye.id===Z),v=(Z,ye)=>ye>0?Math.min(Z/ye*100,100):0,P=Z=>new Intl.NumberFormat("ar-EG").format(Z),R=Z=>new Date(Z).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),E=(()=>{const Z=new Date;let ye;switch(F){case"week":ye=new Date(Z.getTime()-7*24*60*60*1e3);break;case"month":ye=new Date(Z.getFullYear(),Z.getMonth(),1);break;default:return S}return S.filter(it=>new Date(it.createdAt)>=ye)})(),H=Z=>{const ye=Z.type,it=Z.txnType;return ye==="withdraw"||ye==="withdrawal"||ye==="receive"||it==="receive"},te=Z=>{const ye=Z.type,it=Z.txnType;return ye==="send"||ye==="transfer"||it==="send"},Q=E.filter(Z=>H(Z)&&Z.status==="completed").reduce((Z,ye)=>{const it=ye.withdrawnAmount!==void 0?ye.withdrawnAmount:ye.amount;return Z+(it||0)},0),A=E.filter(Z=>te(Z)&&Z.status==="completed").reduce((Z,ye)=>{const it=ye.sentAmount!==void 0?ye.sentAmount:ye.amount;return Z+(it||0)},0),U=E.filter(Z=>Z.type==="deposit"&&Z.status==="completed").reduce((Z,ye)=>Z+ye.amount,0),ae=E.filter(Z=>Z.status==="completed"),se=ae.length,ge=ae.reduce((Z,ye)=>{if(H(ye)){const it=ye.withdrawnAmount??ye.receivedAmount??ye.amount??0;return Z+Jc(Number(it)||0,"receive")}if(te(ye)){const it=ye.sentAmount??ye.transferredAmount??ye.amount??0;return Z+Jc(Number(it)||0,"send")}return Z},0),fe=a(l.walletProvider||""),ne=v(l.monthlyWithdrawalUsage||0,l.monthlyWithdrawalLimit),Ue=v(l.monthlyTransferUsage||0,l.monthlyTransferLimit),Ct=Z=>{switch(Z){case"withdrawal":return e.jsx(An,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(Ni,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx(Xt,{className:"h-4 w-4 text-green-500"});default:return e.jsx(Sn,{className:"h-4 w-4 text-gray-500"})}},tt=Z=>{switch(Z){case"completed":return e.jsx(er,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(Ps,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(_n,{className:"h-4 w-4 text-red-500"});default:return e.jsx(vr,{className:"h-4 w-4 text-gray-500"})}},We=Z=>{switch(Z){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},Qe=Z=>{switch(Z){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(Se,{open:m,onOpenChange:c,children:e.jsxs(Ie,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Ce,{className:"pb-4",children:e.jsxs(De,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Ci,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",l.name,l.isDefault&&e.jsxs(ta,{variant:"default",className:"mr-2",children:[e.jsx(Nd,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(Ft,{children:[e.jsx(ma,{children:e.jsxs(Pa,{className:"text-sm flex items-center gap-2",children:[e.jsx($n,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(Wt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Es,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:l.phone})]}),l.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx($n,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:l.nationalId})]}),fe&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ad,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:fe.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",fe.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",fe.nationalId]})]})]}),l.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Zs,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(l.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs(Ft,{children:[e.jsx(ma,{children:e.jsxs(Pa,{className:"text-sm flex items-center gap-2",children:[e.jsx(kn,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(Wt,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(An,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[P(l.monthlyWithdrawalUsage||0)," / ",P(l.monthlyWithdrawalLimit)]})]}),e.jsx(Hc,{value:ne,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",P(l.monthlyWithdrawalLimit-(l.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(so,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Ni,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[P(l.monthlyTransferUsage||0)," / ",P(l.monthlyTransferLimit)]})]}),e.jsx(Hc,{value:Ue,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",P(l.monthlyTransferLimit-(l.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(Ft,{children:e.jsxs(Wt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(An,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:P(Q)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx(Ft,{children:e.jsxs(Wt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Ni,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:P(A)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx(Ft,{children:e.jsxs(Wt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Xt,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:P(U)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})}),e.jsx(Ft,{children:e.jsxs(Wt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(kn,{className:"h-5 w-5 text-emerald-600"})}),e.jsx("div",{className:"text-lg font-bold",children:P(ge)}),e.jsx("div",{className:"text-xs text-gray-600",children:"أرباح الفترة"})]})}),e.jsx(Ft,{children:e.jsxs(Wt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Sn,{className:"h-5 w-5 text-purple-600"})}),e.jsx("div",{className:"text-lg font-bold",children:P(se)}),e.jsx("div",{className:"text-xs text-gray-600",children:"عدد العمليات"})]})})]}),e.jsxs(Ft,{children:[e.jsx(ma,{children:e.jsxs(Pa,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Sn,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{size:"sm",variant:F==="week"?"default":"outline",onClick:()=>D("week"),className:"text-xs",children:"أسبوع"}),e.jsx(x,{size:"sm",variant:F==="month"?"default":"outline",onClick:()=>D("month"),className:"text-xs",children:"شهر"}),e.jsx(x,{size:"sm",variant:F==="all"?"default":"outline",onClick:()=>D("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(Wt,{children:K?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):E.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Sn,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:E.map(Z=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[Ct(Z.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[We(Z.type)," - ",P(Z.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:R(Z.createdAt)}),Z.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:Z.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[tt(Z.status),e.jsx("span",{className:"text-xs",children:Qe(Z.status)})]})]},Z.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(x,{onClick:f,variant:"outline",children:[e.jsx(Sd,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(x,{onClick:c,variant:"outline",children:"إغلاق"})]})]})})},Hl=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],b0=({isOpen:l,onClose:m,onWalletUpdate:c,initialEditingWallet:f})=>{const{toast:j}=os(),{user:S,userSubscription:u}=Cs();(()=>{var M,we;const Me=((M=u==null?void 0:u.subscription)==null?void 0:M.planType)??((we=u==null?void 0:u.subscription)==null?void 0:we.plan)??(u==null?void 0:u.planType)??(u==null?void 0:u.plan)??null,L=typeof Me=="string"?String(Me).trim().toLowerCase():null;return Me===za.TAHWEELA||L==="tahweela"||L==="تحويله"})();const K=dd(),[B,F]=i.useState([]),[D,T]=i.useState(!1),[a,v]=i.useState(null),[P,R]=i.useState(""),[E,H]=i.useState(""),[te,Q]=i.useState(""),[A,U]=i.useState(""),[ae,se]=i.useState("200000"),[ge,fe]=i.useState("200000"),[ne,Ue]=i.useState("100000"),[Ct,tt]=i.useState("60000"),[We,Qe]=i.useState(!1),[Z,ye]=i.useState(null),[it,_t]=i.useState(!1),[be,ke]=i.useState(!1),[Dt,Ot]=i.useState(!1),[Gt,Kt]=i.useState(null),Oe=()=>`wallets_${(S==null?void 0:S.uid)||"default"}`;i.useEffect(()=>{f&&(v(f),T(!0),R(f.name||""),H(f.phone||""),Q(f.nationalId||""),U(f.walletProvider||""),se((f.monthlyWithdrawalLimit||2e5).toString()),fe((f.monthlyTransferLimit||2e5).toString()),Ue((f.dailyWithdrawalLimit||1e5).toString()),tt((f.dailyTransferLimit||6e4).toString()),Qe(!!f.isDefault))},[f]);const Ke=M=>{const we=new Date,Me=we.getMonth(),L=we.getFullYear();if(!M.lastResetDate)return{...M,monthlyWithdrawalUsage:M.monthlyWithdrawalUsage||0,monthlyTransferUsage:M.monthlyTransferUsage||0,lastResetDate:we.toISOString().split("T")[0]};const rt=new Date(M.lastResetDate),aa=rt.getMonth(),yt=rt.getFullYear();return Me!==aa||L!==yt?{...M,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:we.toISOString().split("T")[0]}:M},ct=async(M,we)=>{const Me=new Date().getMonth(),L=new Date().getFullYear(),rt=we.filter(pt=>{const Rt=new Date(pt.createdAt);return Rt.getMonth()===Me&&Rt.getFullYear()===L&&pt.lineId===M}),aa=rt.filter(pt=>pt.txnType==="receive").reduce((pt,Rt)=>pt+(Rt.amount||0),0),yt=rt.filter(pt=>pt.txnType==="send").reduce((pt,Rt)=>pt+(Rt.amount||0),0);return{withdrawalUsage:aa,transferUsage:yt}},$e=async(M,we)=>{const Me=new Date,L=Me.getDate(),rt=Me.getMonth(),aa=Me.getFullYear(),yt=we.filter(zt=>{const sa=new Date(zt.createdAt);return sa.getDate()===L&&sa.getMonth()===rt&&sa.getFullYear()===aa&&zt.lineId===M}),pt=yt.filter(zt=>zt.txnType==="receive").reduce((zt,sa)=>zt+(sa.amount||0),0),Rt=yt.filter(zt=>zt.txnType==="send").reduce((zt,sa)=>zt+(sa.amount||0),0);return{withdrawalUsage:pt,transferUsage:Rt}};i.useEffect(()=>{(async()=>{if(!(S!=null&&S.uid)){console.log("No user authenticated, skipping wallet loading"),_t(!1);return}console.log("Loading wallets for user:",S.uid),_t(!0);try{const{auth:M}=await ht(async()=>{const{auth:yt}=await ft(()=>import("./index-C_crvORM.js").then(pt=>pt.c3),__vite__mapDeps([0,1]),import.meta.url).then(pt=>pt.c3);return{auth:yt}},xt([0,1]),import.meta.url);let we=0;const Me=5;for(;!M.currentUser&&we<Me;)console.log(`Waiting for auth state... attempt ${we+1}`),await new Promise(yt=>setTimeout(yt,1e3)),we++;if(!M.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",M.currentUser.uid),console.log("Context User:",S.uid),console.log("Fetching wallets from Firebase...");const L=await fs.getByMerchantId(S.uid);console.log("Fetched wallets:",L),console.log("Fetching transactions from Firebase...");const rt=await En.getByUserId(S.uid);console.log("Fetched transactions:",rt);const aa=(await Promise.all(L.map(async yt=>{const{withdrawalUsage:pt,transferUsage:Rt}=await ct(yt.id,rt),{withdrawalUsage:zt,transferUsage:sa}=await $e(yt.id,rt);return{id:yt.id,name:yt.label||"محفظة بدون اسم",phone:yt.msisdn,isDefault:!1,monthlyWithdrawalLimit:yt.withdrawLimit||2e5,monthlyTransferLimit:yt.transferLimit||2e5,dailyWithdrawalLimit:yt.dailyWithdrawLimit||1e5,dailyTransferLimit:yt.dailyTransferLimit||6e4,monthlyWithdrawalUsage:pt,monthlyTransferUsage:Rt,dailyWithdrawalUsage:zt,dailyTransferUsage:sa,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:yt.defaultTransferCommission!=null?Number(yt.defaultTransferCommission):null,defaultWithdrawCommission:yt.defaultWithdrawCommission!=null?Number(yt.defaultWithdrawCommission):null}}))).map(Ke);F(aa),console.log("Wallets loaded successfully:",aa)}catch(M){console.error("Error loading wallets:",M),F([])}finally{_t(!1)}})()},[S==null?void 0:S.uid]);const at=()=>{R(""),H(""),Q(""),U(""),se("200000"),fe("200000"),Ue("100000"),tt("60000"),Qe(!1),v(null),T(!1)},X=async()=>{if(!P.trim()||!E.trim()||!A.trim()){j({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(S!=null&&S.uid)){j({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}_t(!0);try{if(a){await fs.update(a.id,{label:P.trim(),msisdn:E.trim(),withdrawLimit:parseInt(ae),transferLimit:parseInt(ge),dailyWithdrawLimit:parseInt(ne),dailyTransferLimit:parseInt(Ct)}),await is.setLimits(a.id,{dailyTransferLimit:parseInt(Ct||"0"),dailyWithdrawLimit:parseInt(ne||"0"),monthlyTransferLimit:parseInt(ge||"0"),monthlyWithdrawLimit:parseInt(ae||"0")});const M=B.map(we=>we.id===a.id?{...we,name:P.trim(),phone:E.trim(),nationalId:te.trim(),walletProvider:A,monthlyWithdrawalLimit:parseInt(ae),monthlyTransferLimit:parseInt(ge),dailyWithdrawalLimit:parseInt(ne),dailyTransferLimit:parseInt(Ct)}:we);F(M),localStorage.setItem(Oe(),JSON.stringify(M)),j({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const M={merchantUserId:S.uid,provider:A,msisdn:E.trim(),label:P.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(ae),transferLimit:parseInt(ge),dailyTransferLimit:parseInt(Ct),dailyWithdrawLimit:parseInt(ne),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},we=await fs.create(M);await is.setLimits(we,{dailyTransferLimit:parseInt(Ct||"0"),dailyWithdrawLimit:parseInt(ne||"0"),monthlyTransferLimit:parseInt(ge||"0"),monthlyWithdrawLimit:parseInt(ae||"0")});const Me=new Date().toISOString().split("T")[0],L={id:we,name:P.trim(),phone:E.trim(),nationalId:te.trim(),walletProvider:A,isDefault:We,monthlyWithdrawalLimit:parseInt(ae),monthlyTransferLimit:parseInt(ge),dailyWithdrawalLimit:parseInt(ne),dailyTransferLimit:parseInt(Ct),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:Me,defaultTransferCommission:null,defaultWithdrawCommission:null},rt=[...B,L];F(rt),localStorage.setItem(Oe(),JSON.stringify(rt)),j({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}c&&c(),at(),T(!1),v(null)}catch(M){console.error("Error saving wallet:",M),j({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{_t(!1)}},mt=M=>{v(M),R(M.name),H(M.phone),Q(M.nationalId||""),U(M.walletProvider||""),se(M.monthlyWithdrawalLimit.toString()),fe(M.monthlyTransferLimit.toString()),Qe(M.isDefault),T(!0)},Lt=async M=>{const we=B.find(Me=>Me.id===M);if(we!=null&&we.isDefault){j({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(S!=null&&S.uid)){j({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}_t(!0);try{await fs.delete(M);const Me=B.filter(L=>L.id!==M);F(Me),localStorage.setItem(Oe(),JSON.stringify(Me)),c&&c(),j({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(Me){console.error("Error deleting wallet:",Me),j({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{_t(!1)}},Tt=M=>{const we=B.map(Me=>({...Me,isDefault:Me.id===M}));F(we),localStorage.setItem(Oe(),JSON.stringify(we)),c&&c(),j({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(Se,{open:l,onOpenChange:m,children:[e.jsxs(Ie,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(Ce,{className:"pb-2",children:e.jsxs(De,{className:"flex items-center gap-1 text-sm",children:[e.jsx(Is,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",B.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(x,{onClick:()=>{Ot(!0)},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(Bt,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(x,{onClick:()=>{m(),K("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(Sa,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),(D||a)&&e.jsxs(Ft,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx(ma,{className:"pb-1",children:e.jsx(Pa,{className:"text-sm",children:a?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(Wt,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(Gs,{value:A,onValueChange:U,children:[e.jsx(Ks,{className:"h-6 text-xs flex-1",children:e.jsx(Hs,{placeholder:"اختر شركة المحفظة"})}),e.jsx(Qs,{children:Hl.map(M=>e.jsx(ps,{value:M.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:M.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:we=>{we.preventDefault(),we.stopPropagation(),ye(M.id)},children:e.jsx(ro,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},M.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx(q,{value:P,onChange:M=>R(M.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx(Es,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{value:E,onChange:M=>H(M.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx($n,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{value:te,onChange:M=>Q(M.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Xt,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{type:"number",value:ae,onChange:M=>se(M.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Xt,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{type:"number",value:ge,onChange:M=>fe(M.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(An,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx(q,{type:"number",value:ne,onChange:M=>Ue(M.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ni,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx(q,{type:"number",value:Ct,onChange:M=>tt(M.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:We,onChange:M=>Qe(M.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(xd,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(x,{onClick:X,className:"flex-1 h-6 text-xs",size:"sm",children:a?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(x,{variant:"outline",onClick:at,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:B.map(M=>{var we;return e.jsxs(Ft,{className:`${M.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx(ma,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Pa,{className:"text-sm flex items-center gap-1",children:[e.jsx(Is,{className:"h-3 w-3"}),M.name]}),M.isDefault&&e.jsx(ta,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(Wt,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Es,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:M.phone})]}),M.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((we=Hl.find(Me=>Me.id===M.walletProvider))==null?void 0:we.name)||M.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((M.monthlyWithdrawalUsage||0)/M.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((M.monthlyTransferUsage||0)/M.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(M.monthlyWithdrawalLimit-(M.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(M.monthlyTransferLimit-(M.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((M.dailyWithdrawalUsage||0)/M.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((M.dailyTransferUsage||0)/M.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify بين items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(M.dailyWithdrawalLimit-(M.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(M.dailyTransferLimit-(M.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(x,{size:"sm",variant:"outline",onClick:()=>mt(M),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(jd,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!M.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",variant:"outline",onClick:()=>Tt(M.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(x,{size:"sm",variant:"destructive",onClick:()=>Lt(M.id),className:"h-5 px-1",children:e.jsx(da,{className:"h-2 w-2"})})]})]})]})]},M.id)})}),B.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),Z&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>ye(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(pd,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const M=Hl.find(we=>we.id===Z);return M?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:M.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:M.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:M.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ro,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(ya,{open:Dt,onOpenChange:Ot,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Ot(!1),ke(!0)}}),e.jsx(f0,{isOpen:be,onClose:()=>ke(!1),onWalletSelect:M=>{Kt(M),ke(!1)},onEditWallet:M=>{K(`/user/add-wallet?edit=1&id=${M.id}`),ke(!1)},onDeleteWallet:async M=>{try{if(await fs.delete(M),F(we=>{const Me=we.filter(L=>L.id!==M);try{localStorage.setItem(Oe(),JSON.stringify(Me))}catch(L){console.error("Failed to update localStorage wallets after delete:",L)}return Me}),c)try{await c()}catch(we){console.error("onWalletUpdate callback failed:",we)}}catch(we){console.error("Error deleting wallet:",we)}}}),e.jsx(y0,{wallet:Gt,isOpen:!!Gt,onClose:()=>Kt(null),onBack:()=>{Kt(null),ke(!0)}})]})},w0=({isOpen:l,onClose:m,transaction:c,onDelete:f})=>{if(!c)return null;const j=F=>{switch(F){case"completed":return e.jsx(er,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(Ps,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(_n,{className:"h-5 w-5 text-red-500"});default:return e.jsx(Ps,{className:"h-5 w-5 text-gray-500"})}},S=F=>{switch(F){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},u=F=>{switch(F){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},K=()=>{const F=!!c.senderNumber,D=!!c.senderName,T=F?"الرقم المرسل:":D?"الرقم الراسل:":"رقم المحفظة:",a=F?c.senderNumber:D?c.senderName:c.senderPhone,v=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${c.transactionReference||c.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${c.merchantShopName||c.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${u(c.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${c.status==="completed"?"#16a34a":c.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${S(c.status)}
            </span>
          </div>

          ${c!=null&&c.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${c.cashierName}</span>
            </div>
          `:""}
          
          ${c.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${T}</span>
              <span style="color: #1e293b;">${a}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${c.receiverNumber||c.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${Ca(c.transferredAmount||c.amount)} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${c.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${Ca(c.withdrawnAmountDetailed||c.withdrawnAmount||c.amount)} جنيه</span>
            </div>
          `}
          
          ${c.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${Ca(c.commission||0)} جنيه</span>
            </div>
          `:""}
          ${c.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الربح:</span>
              <span style="color: #16a34a; font-weight: 600;">${Ca(c.commission||0)} جنيه</span>
            </div>
          `:""}
          ${c!=null&&c.fee&&Number(c.fee)>0?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرسوم:</span>
              <span style="color: #64748b; font-weight: 600;">${Ca(c.fee||0)} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${c.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${c.type==="withdraw"?"-":""}${Ca(c.amount)} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,P=window.open("","_blank");P&&(P.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${c.transactionReference||c.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${v}
          </body>
        </html>
      `),P.document.close(),P.print())},B=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(f(c.id),m())};return e.jsx(Se,{open:l,onOpenChange:m,children:e.jsxs(Ie,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Ce,{children:e.jsxs(De,{className:"flex items-center gap-2 text-xl",children:[e.jsx(Di,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ft,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs(ma,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[j(c.status),e.jsx(ta,{variant:c.status==="completed"?"default":"secondary",className:"text-sm",children:S(c.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[c.type==="withdraw"?"-":"",Ca(c.amount)," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",c.transactionReference||c.id]})]})}),e.jsxs(Ft,{children:[e.jsx(ma,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Cd,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(Wt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:c.merchantShopName||c.shopName||"غير محدد"})]}),(c==null?void 0:c.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:c.cashierName})]})]})]}),e.jsxs(Ft,{children:[e.jsx(ma,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ci,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(Wt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(ta,{variant:"outline",className:"bg-blue-100 text-blue-800",children:u(c.type)})]}),c.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const F=!!c.senderNumber,D=!!c.senderName,T=F?"الرقم المرسل:":D?"الرقم الراسل:":"رقم المحفظة:",a=F?c.senderNumber:D?c.senderName:c.senderPhone,v=F?wi:Es;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:T})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:a})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(nh,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(wi,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:c.receiverNumber||c.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Xt,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[Ca(c.transferredAmount||c.amount)," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Es,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:c.senderPhone})]}),(c==null?void 0:c.senderName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(wi,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("span",{className:"text-gray-900",children:c.senderName})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Xt,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[Ca(c.withdrawnAmountDetailed||c.withdrawnAmount||c.amount)," جنيه"]})]})]}),c.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[c.commission," جنيه"]})]}),c.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-green-700",children:"الربح:"}),e.jsxs("span",{className:"text-green-900 font-semibold",children:[c.commission," جنيه"]})]}),(c==null?void 0:c.fee)&&Number(c.fee)>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الرسوم:"}),e.jsxs("span",{className:"text-gray-900 font-semibold",children:[c.fee," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Zs,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:c.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(x,{onClick:K,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx(Oh,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(x,{onClick:B,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(da,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(x,{onClick:m,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function ld({open:l,onOpenChange:m,onSuccess:c,title:f,description:j,currentBalance:S,balanceLabel:u,userId:K}){const[B,F]=i.useState(""),[D,T]=i.useState(S.toString()),[a,v]=i.useState(!1),[P,R]=i.useState(""),[E,H]=i.useState(!1),te=async A=>{A.preventDefault(),R(""),H(!0);try{const U=parseFloat(D);if(isNaN(U)||U<0){R("يرجى إدخال مبلغ صحيح"),H(!1);return}await Ia.hasMasterPin(K)?await Ia.verifyMasterPin(B,K)?(c(U),m(!1),F(""),T("")):R("الرقم السري غير صحيح"):R("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{R("حدث خطأ أثناء التحقق من الرقم السري")}finally{H(!1)}},Q=()=>{F(""),T(S.toString()),R(""),m(!1)};return Ge.useEffect(()=>{l&&T(S.toString())},[S,l]),e.jsx(Se,{open:l,onOpenChange:Q,children:e.jsxs(Ie,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Ce,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[e.jsx(Xt,{className:"h-5 w-5"}),f]})}),e.jsxs("form",{onSubmit:te,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:j}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(ee,{className:"text-sm font-medium text-gray-700",children:[u," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[S.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx(q,{id:"newAmount",type:"number",step:"0.01",min:"0",value:D,onChange:A=>T(A.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"pin",type:a?"text":"password",value:B,onChange:A=>F(A.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>v(!a),children:a?e.jsx(ba,{className:"h-4 w-4"}):e.jsx(Bt,{className:"h-4 w-4"})})]})]}),P&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(vr,{className:"h-4 w-4"}),P]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(x,{type:"button",variant:"outline",onClick:Q,className:"flex-1",children:"إلغاء"}),e.jsx(x,{type:"submit",disabled:E||!B||!D,className:"flex-1",children:E?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(gr,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class Ii{static getSecretKey(m){return m?`${this.SECRET_KEY_BASE}_${m}`:this.SECRET_KEY_BASE}static setSecretPin(m,c){const f=btoa(m);this.secretCache.set(this.getSecretKey(c),f)}static hasSecretPin(m){return this.secretCache.has(this.getSecretKey(m))}static verifySecretPin(m,c){const f=this.secretCache.get(this.getSecretKey(c));if(!f)return!1;try{return atob(f)===m}catch{return!1}}static clearSecretPin(m){this.secretCache.delete(this.getSecretKey(m))}}Zc(Ii,"SECRET_KEY_BASE","dashboard_secret_pin"),Zc(Ii,"secretCache",new Map);function N0({open:l,onOpenChange:m,userId:c}){const[f,j]=i.useState(""),[S,u]=i.useState(""),[K,B]=i.useState(""),[F,D]=i.useState(!1),[T,a]=i.useState(!1),[v,P]=i.useState(!1),[R,E]=i.useState(""),[H,te]=i.useState(!1),{toast:Q}=os(),A=Ii.hasSecretPin(c),U=async se=>{se.preventDefault(),E(""),te(!0);try{if(!S||S.length<4){E("يجب أن يكون الرقم السري 4 أرقام على الأقل"),te(!1);return}if(S!==K){E("الرقم السري الجديد وتأكيده غير متطابقين"),te(!1);return}if(A){if(!f){E("يرجى إدخال الرقم السري الحالي"),te(!1);return}if(!Ii.verifySecretPin(f,c)){E("الرقم السري الحالي غير صحيح"),te(!1);return}}Ii.setSecretPin(S,c),Q({title:A?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:A?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),ae()}catch{E("حدث خطأ أثناء حفظ الرقم السري")}finally{te(!1)}},ae=()=>{j(""),u(""),B(""),E(""),D(!1),a(!1),P(!1),m(!1)};return e.jsx(Se,{open:l,onOpenChange:ae,children:e.jsxs(Ie,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Ce,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[e.jsx(xd,{className:"h-5 w-5"}),A?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:U,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:A?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),A&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"currentPin",type:F?"text":"password",autoComplete:"off",value:f,onChange:se=>j(se.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>D(!F),children:F?e.jsx(ba,{className:"h-4 w-4"}):e.jsx(Bt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"newPin",type:T?"text":"password",autoComplete:"off",value:S,onChange:se=>u(se.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>a(!T),children:T?e.jsx(ba,{className:"h-4 w-4"}):e.jsx(Bt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:v?"text":"password",autoComplete:"off",value:K,onChange:se=>B(se.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>P(!v),children:v?e.jsx(ba,{className:"h-4 w-4"}):e.jsx(Bt,{className:"h-4 w-4"})})]})]}),R&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(vr,{className:"h-4 w-4"}),R]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:H,className:"flex-1",children:[e.jsx(gr,{className:"h-4 w-4 mr-2"}),H?"جاري الحفظ...":A?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(x,{type:"button",variant:"outline",onClick:ae,disabled:H,children:"إلغاء"})]})]})]})})}const Ql=new Map;function j0({open:l,onOpenChange:m,userId:c}){const[f,j]=i.useState(""),[S,u]=i.useState(""),[K,B]=i.useState(""),[F,D]=i.useState(!1),[T,a]=i.useState(!1),[v,P]=i.useState(!1),[R,E]=i.useState(""),[H,te]=i.useState(!1),{toast:Q}=os(),A=c?`cash_drawer_pin_${c}`:"cash_drawer_pin",U=()=>Ql.has(A),ae=ne=>{const Ue=Ql.get(A);if(!Ue)return!1;try{return atob(Ue)===ne}catch{return!1}},se=ne=>{const Ue=btoa(ne);Ql.set(A,Ue)},ge=async ne=>{ne.preventDefault(),E(""),te(!0);try{if(!S||S.length<4){E("يجب أن يكون الرقم السري 4 أرقام على الأقل"),te(!1);return}if(S!==K){E("الرقم السري الجديد وتأكيده غير متطابقين"),te(!1);return}if(U()){if(!f){E("يرجى إدخال الرقم السري الحالي لدرج النقدية"),te(!1);return}if(!ae(f)){E("الرقم السري الحالي لدرج النقدية غير صحيح"),te(!1);return}}se(S),Q({title:U()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:U()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),fe()}catch{E("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{te(!1)}},fe=()=>{j(""),u(""),B(""),E(""),D(!1),a(!1),P(!1),m(!1)};return e.jsx(Se,{open:l,onOpenChange:fe,children:e.jsxs(Ie,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Ce,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[e.jsx(Xt,{className:"h-5 w-5 text-green-600"}),U()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:ge,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:U()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),U()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"currentPin",type:F?"text":"password",autoComplete:"off",value:f,onChange:ne=>j(ne.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>D(!F),children:F?e.jsx(ba,{className:"h-4 w-4"}):e.jsx(Bt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"newPin",type:T?"text":"password",autoComplete:"off",value:S,onChange:ne=>u(ne.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>a(!T),children:T?e.jsx(ba,{className:"h-4 w-4"}):e.jsx(Bt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:v?"text":"password",autoComplete:"off",value:K,onChange:ne=>B(ne.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>P(!v),children:v?e.jsx(ba,{className:"h-4 w-4"}):e.jsx(Bt,{className:"h-4 w-4"})})]})]}),R&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(vr,{className:"h-4 w-4"}),R]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:H,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(gr,{className:"h-4 w-4 mr-2"}),H?"جاري الحفظ...":U()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(x,{type:"button",variant:"outline",onClick:fe,disabled:H,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}const Xl=new Map;function S0({open:l,onOpenChange:m,userId:c}){const[f,j]=i.useState(""),[S,u]=i.useState(""),[K,B]=i.useState(""),[F,D]=i.useState(!1),[T,a]=i.useState(!1),[v,P]=i.useState(!1),[R,E]=i.useState(""),[H,te]=i.useState(!1),{toast:Q}=os(),A=c?`wallet_total_pin_${c}`:"wallet_total_pin",U=()=>Xl.has(A),ae=ne=>{const Ue=Xl.get(A);if(!Ue)return!1;try{return atob(Ue)===ne}catch{return!1}},se=ne=>{const Ue=btoa(ne);Xl.set(A,Ue)},ge=async ne=>{ne.preventDefault(),E(""),te(!0);try{if(!S||S.length<4){E("يجب أن يكون الرقم السري 4 أرقام على الأقل"),te(!1);return}if(S!==K){E("الرقم السري الجديد وتأكيده غير متطابقين"),te(!1);return}if(U()){if(!f){E("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),te(!1);return}if(!ae(f)){E("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),te(!1);return}}se(S),Q({title:U()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:U()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),fe()}catch{E("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{te(!1)}},fe=()=>{j(""),u(""),B(""),E(""),D(!1),a(!1),P(!1),m(!1)};return e.jsx(Se,{open:l,onOpenChange:fe,children:e.jsxs(Ie,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Ce,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[e.jsx(Is,{className:"h-5 w-5 text-blue-600"}),U()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:ge,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:U()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),U()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"currentPin",type:F?"text":"password",autoComplete:"off",value:f,onChange:ne=>j(ne.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>D(!F),children:F?e.jsx(ba,{className:"h-4 w-4"}):e.jsx(Bt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"newPin",type:T?"text":"password",autoComplete:"off",value:S,onChange:ne=>u(ne.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>a(!T),children:T?e.jsx(ba,{className:"h-4 w-4"}):e.jsx(Bt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:v?"text":"password",autoComplete:"off",value:K,onChange:ne=>B(ne.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>P(!v),children:v?e.jsx(ba,{className:"h-4 w-4"}):e.jsx(Bt,{className:"h-4 w-4"})})]})]}),R&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(vr,{className:"h-4 w-4"}),R]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:H,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(gr,{className:"h-4 w-4 mr-2"}),H?"جاري الحفظ...":U()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(x,{type:"button",variant:"outline",onClick:fe,disabled:H,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function I0({open:l,onOpenChange:m,onSuccess:c,title:f,description:j,currentBalance:S,balanceLabel:u,userId:K}){const[B,F]=i.useState(""),[D,T]=i.useState(""),[a,v]=i.useState("add"),[P,R]=i.useState(!1),[E,H]=i.useState(""),[te,Q]=i.useState(!1),[A,U]=i.useState(!1);i.useEffect(()=>{let fe=!0;return(async()=>{const ne=await Ia.hasMasterPin(K);fe&&U(ne)})(),()=>{fe=!1}},[K,l]);const ae=async fe=>{fe.preventDefault(),H(""),Q(!0);try{const ne=parseFloat(D);if(isNaN(ne)||ne<=0){H("يرجى إدخال مبلغ صحيح أكبر من صفر"),Q(!1);return}if(a==="subtract"&&ne>S){H("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),Q(!1);return}if(A)if(await Ia.verifyMasterPin(B,K)){const Ue=a==="add"?ne:-ne;se(),c(Ue)}else H("الرقم السري غير صحيح");else H("لم يتم تعيين الرقم السري الرئيسي. يرجى تعيينه من إعدادات البروفيل أولاً")}catch{H("حدث خطأ أثناء التحقق من الرقم السري")}finally{Q(!1)}},se=()=>{F(""),T(""),v("add"),H(""),m(!1)},ge=()=>{const fe=parseFloat(D)||0;return a==="add"?S+fe:S-fe};return e.jsx(Se,{open:l,onOpenChange:se,children:e.jsxs(Ie,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Ce,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[a==="add"?e.jsx(Sa,{className:"h-5 w-5 text-green-600"}):e.jsx(pr,{className:"h-5 w-5 text-red-600"}),f]})}),e.jsxs("form",{onSubmit:ae,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:j}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(ee,{className:"text-sm font-medium text-gray-700",children:[u," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[S.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(x,{type:"button",variant:a==="add"?"default":"outline",onClick:()=>v("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(Sa,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(x,{type:"button",variant:a==="subtract"?"default":"outline",onClick:()=>v("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(pr,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(ee,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",a==="add"?"إضافته":"خصمه"]}),e.jsx(q,{id:"amount",type:"number",step:"0.01",min:"0.01",value:D,onChange:fe=>T(fe.target.value),placeholder:`أدخل المبلغ المراد ${a==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),D&&!isNaN(parseFloat(D))&&e.jsxs("div",{className:`p-3 rounded-lg ${a==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(ee,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${a==="add"?"text-green-700":"text-red-700"}`,children:[ge().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"pin",type:P?"text":"password",autoComplete:"off",value:B,onChange:fe=>F(fe.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>R(!P),children:P?e.jsx(ba,{className:"h-4 w-4"}):e.jsx(Bt,{className:"h-4 w-4"})})]})]}),E&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(vr,{className:"h-4 w-4"}),E]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(x,{type:"button",variant:"outline",onClick:se,className:"flex-1",children:"إلغاء"}),e.jsx(x,{type:"submit",disabled:te||!B||!D,className:`flex-1 ${a==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:te?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(gr,{className:"h-4 w-4 mr-2"}),a==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}const Ys=l=>typeof l=="string"&&l.trim().length>0,C0={getCurrentMonthId(){const l=new Date;return`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}`},async getWalletUsage(l){var m;try{if(!Ys(l))return console.error("Error getting wallet usage: invalid walletId",l),null;const c=Le(Y,"walletLimits",l),f=await Ss(c);if(f.exists()){const S=f.data();return{walletId:l,used_transfer:S.monthlyTransferUsed??S.used_transfer??0,used_withdraw:S.monthlyWithdrawUsed??S.used_withdraw??0,monthly_limit:S.monthlyLimit??S.monthlyTransferLimit??S.monthlyWithdrawLimit??2e5,last_reset:S.lastMonthlyReset??S.last_reset??null,updatedAt:S.updatedAt||mr.now()}}const j={walletId:l,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:mr.now()};return await ns(c,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,monthlyTransferLimit:2e5,monthlyWithdrawLimit:2e5,lastMonthlyReset:null,updatedAt:dt(),ownerId:(m=Ur.currentUser)==null?void 0:m.uid}),j}catch(c){return console.error("Error getting wallet usage:",c),{walletId:l,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:mr.now()}}},shouldResetLimits(l){const m=new Date,c=m.getDate();if(!l)return c===1;if(c===1){const f=l.toDate(),j=m.getMonth(),S=m.getFullYear();return f.getMonth()!==j||f.getFullYear()!==S}return!1},async autoResetLimitsIfNeeded(l){try{if(!Ys(l))return console.error("خطأ في التصفير التلقائي للحدود: walletId غير صالح",l),!1;typeof import.meta<"u";const m=await this.getWalletUsage(l);return m&&this.shouldResetLimits(m.last_reset)?(console.log(`🔄 تصفير تلقائي للحدود للمحفظة ${l} - اليوم الأول من الشهر`),await this.resetWalletUsage(l)):!1}catch(m){return console.error("خطأ في التصفير التلقائي للحدود:",m),!1}},async resetWalletUsage(l){try{if(!Ys(l))return console.error("خطأ في تصفير استخدام المحفظة: walletId غير صالح",l),!1;const m=Le(Y,"walletLimits",l);return await ns(m,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:dt(),updatedAt:dt()},{merge:!0}),console.log(`🔄 تم تصفير استخدام المحفظة ${l} بنجاح`),!0}catch(m){return console.error("خطأ في تصفير استخدام المحفظة:",m),!1}},async calculateUsageFromTransactions(l){var m,c;try{if(!Ys(l))return console.error("خطأ في حساب الاستخدام من المعاملات: walletId غير صالح",l),{used_transfer:0,used_withdraw:0};const f=Le(Y,"walletLimits",l),j=new Date;let S=mr.fromDate(new Date(j.getFullYear(),j.getMonth(),1));try{const D=await Ss(f);S=D.exists()?((m=D.data())==null?void 0:m.lastMonthlyReset)??((c=D.data())==null?void 0:c.last_reset)??S:S}catch{}const u=Ve(Ae(Y,"tx"),me("uid","==",l),...S?[me("createdAt",">=",S)]:[]),K=await et(u);let B=0,F=0;return K.forEach(D=>{const T=D.data();T.status==="completed"&&(T.type==="transfer"?B+=T.amount:T.type==="withdraw"&&(F+=T.amount))}),{used_transfer:B,used_withdraw:F}}catch(f){return console.error("خطأ في حساب الاستخدام من المعاملات:",f),{used_transfer:0,used_withdraw:0}}},async getWalletUsageWithRefresh(l){var m,c;try{if(!Ys(l))return console.error("خطأ في الحصول على الاستخدام مع التحديث: walletId غير صالح",l),null;typeof import.meta<"u";const f=await this.getWalletUsage(l);if(!f){const S=await this.calculateUsageFromTransactions(l),u=Le(Y,"walletLimits",l);try{await ns(u,{monthlyTransferUsed:S.used_transfer,monthlyWithdrawUsed:S.used_withdraw,updatedAt:dt(),ownerId:(m=Ur.currentUser)==null?void 0:m.uid},{merge:!0})}catch{}return{walletId:l,used_transfer:S.used_transfer,used_withdraw:S.used_withdraw,monthly_limit:2e5,last_reset:null,updatedAt:mr.now()}}const j=await this.calculateUsageFromTransactions(l);if(f.used_transfer!==j.used_transfer||f.used_withdraw!==j.used_withdraw){const S=Le(Y,"walletLimits",l);try{await ns(S,{monthlyTransferUsed:j.used_transfer,monthlyWithdrawUsed:j.used_withdraw,updatedAt:dt(),ownerId:(c=Ur.currentUser)==null?void 0:c.uid},{merge:!0})}catch{}return await this.getWalletUsage(l)}return f}catch(f){return console.error("خطأ في الحصول على الاستخدام مع التحديث:",f),{walletId:l,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:mr.now()}}},calculateRemaining(l){return{remainingTransfer:Math.max(0,l.monthly_limit-l.used_transfer),remainingWithdraw:Math.max(0,l.monthly_limit-l.used_withdraw)}},async canPerformOperation(l,m,c){try{if(!Ys(l))return console.error("Error checking operation limits: invalid walletId",l),{canPerform:!1,message:"walletId غير صالح"};const f=await this.getWalletUsageWithRefresh(l);if(!f)return{canPerform:!1,message:"لا يمكن العثور على بيانات الاستخدام للمحفظة"};const j=this.calculateRemaining(f);return c==="transfer"&&m>j.remainingTransfer?{canPerform:!1,message:`تجاوز حد التحويل المسموح. المتبقي: ${j.remainingTransfer.toLocaleString()} ج.م من أصل ${f.monthly_limit.toLocaleString()} ج.م`,remaining:j.remainingTransfer}:c==="withdraw"&&m>j.remainingWithdraw?{canPerform:!1,message:`تجاوز حد السحب المسموح. المتبقي: ${j.remainingWithdraw.toLocaleString()} ج.م من أصل ${f.monthly_limit.toLocaleString()} ج.م`,remaining:j.remainingWithdraw}:{canPerform:!0}}catch(f){return console.error("Error checking operation limits:",f),{canPerform:!1,message:"خطأ في التحقق من الحدود"}}},async updateUsage(l,m,c){var f;try{if(!Ys(l))throw new Error("walletId غير صالح");const j=await this.getWalletUsageWithRefresh(l);if(!j)throw new Error("لا يمكن العثور على بيانات الاستخدام للمحفظة");const S=await this.canPerformOperation(l,m,c);if(!S.canPerform)throw new Error(S.message||"لا يمكن إجراء العملية");const u=c==="transfer"?j.used_transfer+m:j.used_transfer,K=c==="withdraw"?j.used_withdraw+m:j.used_withdraw,B=Le(Y,"walletLimits",j.walletId);try{await ns(B,{monthlyTransferUsed:u,monthlyWithdrawUsed:K,updatedAt:dt(),ownerId:(f=Ur.currentUser)==null?void 0:f.uid},{merge:!0})}catch{}let F=await this.getWalletUsageWithRefresh(l);return F||(F={walletId:l,used_transfer:u,used_withdraw:K,monthly_limit:j.monthly_limit,last_reset:j.last_reset,updatedAt:mr.now()}),F}catch(j){throw console.error("Error updating wallet usage:",j),j}},async resetWalletUsageManually(l){try{if(!Ys(l))throw new Error("walletId غير صالح");const m=Le(Y,"walletLimits",l),c={walletId:l,used_transfer:0,used_withdraw:0,monthly_limit:0,last_reset:null,updatedAt:new Date};return ns(m,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:dt(),updatedAt:dt()},{merge:!0}).catch(f=>{console.error("خطأ في حفظ تصفير الاستخدام في Firebase:",f)}),console.log(`✅ تم تصفير استخدام المحفظة ${l} بنجاح`),c}catch(m){throw console.error("Error resetting wallet usage:",m),m}},async getAllWalletsUsage(l){try{const m=(await fs.getByMerchantId(l)).map(c=>this.getWalletUsageWithRefresh(c.id));return(await Promise.all(m)).filter(c=>c!==null)}catch(m){return console.error("Error getting all wallets usage:",m),[]}}};function D0(l){return l?`readBroadcastIds_${l}`:"readBroadcastIds_guest"}function A0({className:l}){const{user:m,profile:c,isSubscriptionActive:f}=Cs(),j=cd(),[S,u]=i.useState([]),[K,B]=i.useState(new Set),[F,D]=i.useState(!1),[T,a]=i.useState(""),[v,P]=i.useState(!1),[R,E]=i.useState(null),[H,te]=i.useState("none"),[Q,A]=i.useState(null),[U,ae]=i.useState(!1);i.useRef(new Set),i.useRef(!1);const se=i.useRef(null),ge=i.useRef(null);i.useRef(null);const[fe,ne]=i.useState({position:"fixed",top:0,left:0,zIndex:1e4}),Ue=!1,Ct=i.useMemo(()=>{const be=["global"];return m!=null&&m.uid&&be.push(`user:${m.uid}`),c!=null&&c.shopId&&be.push(`shop:${c.shopId}`),be},[m==null?void 0:m.uid,c==null?void 0:c.shopId]),tt=D0(m==null?void 0:m.uid),We=i.useMemo(()=>{var be;const ke=(be=j==null?void 0:j.pathname)==null?void 0:be.includes("/user/pending-approval");return!!(m!=null&&m.uid)&&!ke},[m==null?void 0:m.uid,j==null?void 0:j.pathname]);i.useEffect(()=>{try{const be=localStorage.getItem(tt);if(be){const ke=JSON.parse(be);Array.isArray(ke)&&B(new Set(ke.filter(Boolean)))}else B(new Set)}catch(be){console.warn("Failed to load read ids",be),B(new Set)}},[tt]),i.useEffect(()=>{if(!We){u([]);return}const be=Fh(Ct,ke=>{u(ke)});return()=>be()},[Ct,We]),i.useEffect(()=>{},[S]),i.useEffect(()=>()=>{se.current&&clearTimeout(se.current)},[]);const Qe=S.reduce((be,ke)=>be+(ke.id&&!K.has(ke.id)?1:0),0),Z=be=>{if(!be||K.has(be))return;const ke=new Set(K);ke.add(be),B(ke);try{localStorage.setItem(tt,JSON.stringify(Array.from(ke)))}catch{}},ye=()=>{const be=S.map(Dt=>Dt.id).filter(Boolean),ke=new Set(K);be.forEach(Dt=>ke.add(Dt)),B(ke);try{localStorage.setItem(tt,JSON.stringify(Array.from(ke)))}catch{}},it=(be,ke)=>{var Dt;if(be)try{const Ot=((Dt=bi)==null?void 0:Dt.isNativePlatform)&&bi.getPlatform()==="android",Gt=/\.apk(\?|$)/i.test(be);if(Ot&&Gt){const Kt=`cashy://update?url=${encodeURIComponent(be)}`;window.location.href=Kt}else window.open(be,"_blank")}catch{try{window.open(be,"_blank")}catch{}}ke&&Z(ke)};i.useEffect(()=>{},[U]);const _t=async()=>{if(!(m!=null&&m.uid)){alert("يرجى تسجيل الدخول لإرسال الطلب.");return}const be=T.trim();if(!be){alert("يرجى كتابة سبب طلب التحدث.");return}try{P(!0),E(null);const ke=c!=null&&c.fullName&&c.fullName.trim()?c.fullName.trim():m.email?m.email.split("@")[0]:"مستخدم",Dt=(c==null?void 0:c.phone)||null;await ls(Ae(Y,"waiting_list"),{userId:m.uid,name:ke,phone:Dt,reason:be,status:"pending",createdAt:dt()}),E("تم إرسال طلبك إلى قائمة الانتظار بنجاح ✅"),a(""),setTimeout(()=>D(!1),900)}catch(ke){console.error("فشل إرسال طلب قائمة الانتظار:",ke),alert("حدث خطأ أثناء إرسال الطلب. حاول مرة أخرى.")}finally{P(!1)}};return i.useEffect(()=>{if(!(m!=null&&m.uid)){te("none");return}let be=null;try{const ke=Ve(Ae(Y,"waiting_list"),me("userId","==",m.uid));be=Oa(ke,Dt=>{const Ot=Dt.docs.map(Oe=>({id:Oe.id,...Oe.data()})).sort((Oe,Ke)=>{var ct,$e,at,X,mt,Lt;const Tt=(($e=(ct=Oe==null?void 0:Oe.createdAt)==null?void 0:ct.toMillis)==null?void 0:$e.call(ct))??((at=Oe==null?void 0:Oe.createdAt)==null?void 0:at.seconds)*1e3??0;return(((mt=(X=Ke==null?void 0:Ke.createdAt)==null?void 0:X.toMillis)==null?void 0:mt.call(X))??((Lt=Ke==null?void 0:Ke.createdAt)==null?void 0:Lt.seconds)*1e3??0)-Tt});if(Ot.length===0){te("none");return}const Gt=Ot[0],Kt=(Gt==null?void 0:Gt.contacted)===!0||(Gt==null?void 0:Gt.status)==="contacted";te(Kt?"contacted":"pending")})}catch(ke){console.warn("⚠️ فشل الاشتراك في waiting_list للمستخدم:",ke),te("none")}return()=>{be&&be()}},[m==null?void 0:m.uid]),We?e.jsxs("div",{className:`relative inline-flex items-center gap-2 ${l||""}`,ref:ge,children:[e.jsxs(Uh,{onOpenChange:be=>{be&&Qe>0&&ye()},children:[e.jsx(Wh,{asChild:!0,children:e.jsx(x,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:e.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[e.jsx(Xc,{className:"h-4 w-4 text-primary"}),Qe>0&&e.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:Qe})]})})}),e.jsxs(Bh,{className:"w-80",align:"end",forceMount:!0,children:[e.jsxs(Rh,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"الإشعارات"}),S.length>0&&e.jsxs(x,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:ye,children:[e.jsx(er,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),e.jsx(zh,{}),S.length===0?e.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):e.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:S.map(be=>{const ke=be.id?!K.has(be.id):!1;return e.jsx("div",{className:`px-2 py-2 rounded-md ${ke?"bg-primary/5":""}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Xc,{className:`h-4 w-4 ${ke?"text-primary":"text-muted-foreground"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium",children:be.title||"إشعار"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:be.message}),be.linkUrl&&e.jsxs(x,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>it(be.linkUrl,be.id),children:["فتح الرابط ",e.jsx(Lh,{className:"h-3 w-3 ml-1"})]})]}),ke?e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Z(be.id),title:"تمييز كمقروء",children:e.jsx(er,{className:"h-4 w-4 text-primary"})}):e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:e.jsx(er,{className:"h-4 w-4 text-muted-foreground"})})]})},be.id)})})]})]}),e.jsxs(Se,{open:F,onOpenChange:D,children:[e.jsx(ih,{asChild:!0,children:e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full hover:bg-transparent focus:ring-1 focus:ring-primary/60 focus:ring-offset-1",title:"قائمة الانتظار",children:e.jsx(Ps,{className:`h-4 w-4 ${H==="pending"?"text-red-600":H==="contacted"?"text-green-600":"text-muted-foreground"}`})})}),e.jsxs(Ie,{className:"max-w-md border border-purple-200/50 shadow-xl bg-gradient-to-br from-purple-50 to-blue-50",children:[e.jsxs(Ce,{children:[e.jsx(De,{children:"طلب التحدث"}),e.jsx(va,{children:"يرجى كتابة سبب طلب التحدث ليصل للإدارة في قسم قائمة الانتظار."})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"سبب الطلب"}),e.jsx(Mh,{value:T,onChange:be=>a(be.target.value),placeholder:"اكتب سبب طلب التحدث هنا...",className:"min-h-[120px] text-right"}),R&&e.jsx("div",{className:"text-sm text-green-700 bg-green-50 border border-green-200 rounded-md p-2",children:R})]}),e.jsxs(ot,{children:[e.jsx(x,{variant:"outline",onClick:()=>D(!1),disabled:v,children:"إلغاء"}),e.jsx(x,{onClick:_t,disabled:v,className:"bg-gradient-to-r from-green-600 to-emerald-600 text-white",children:v?"جارٍ الإرسال...":"إرسال"})]})]})]}),Ue]}):null}function k0({isOpen:l,onClose:m}){const[c,f]=i.useState("0"),[j,S]=i.useState(null),[u,K]=i.useState(null),[B,F]=i.useState(!1),D=A=>{B?(f(A),F(!1)):f(c==="0"?A:c+A)},T=A=>{const U=parseFloat(c);if(j===null)S(U);else if(u){const ae=a(j||0,U,u);f(String(ae)),S(ae)}F(!0),K(A)},a=(A,U,ae)=>{switch(ae){case"+":return A+U;case"-":return A-U;case"×":return A*U;case"÷":return U===0?0:A/U;case"=":return U;default:return U}},v=()=>{const A=parseFloat(c);if(j!==null&&u){const U=a(j,A,u);f(String(U)),S(null),K(null),F(!0)}},P=()=>{f("0"),S(null),K(null),F(!1)},R=()=>{f("0")},E=()=>{B?(f("0."),F(!1)):c.indexOf(".")===-1&&f(c+".")},H=()=>{c!=="0"&&f(c.charAt(0)==="-"?c.slice(1):"-"+c)},te=()=>{const A=parseFloat(c);f(String(A/100))},Q=A=>{const U=A.key;A.preventDefault(),U>="0"&&U<="9"?D(U):U==="+"?T("+"):U==="-"?T("-"):U==="*"?T("×"):U==="/"?T("÷"):U==="Enter"||U==="="?v():U==="Escape"||U==="c"||U==="C"?P():U==="Backspace"?R():U==="."?E():U==="%"&&te()};return i.useEffect(()=>(l?document.addEventListener("keydown",Q):document.removeEventListener("keydown",Q),()=>{document.removeEventListener("keydown",Q)}),[l,c,j,u,B]),e.jsx(Se,{open:l,onOpenChange:A=>!A&&m(),children:e.jsxs(Ie,{className:"sm:max-w-md",children:[e.jsx(Ce,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[e.jsx(Id,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:c})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:P,children:"AC"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:R,children:"CE"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:te,children:"%"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>T("÷"),children:"÷"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>D("7"),children:"7"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>D("8"),children:"8"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>D("9"),children:"9"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>T("×"),children:"×"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>D("4"),children:"4"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>D("5"),children:"5"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>D("6"),children:"6"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>T("-"),children:"-"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>D("1"),children:"1"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>D("2"),children:"2"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>D("3"),children:"3"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>T("+"),children:"+"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>D("0"),children:"0"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:E,children:"."}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:v,children:"="})]}),e.jsx(x,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:H,children:"+/-"})]})]})})}function _0({isOpen:l,onClose:m,initialBarcode:c}){const[f,j]=i.useState([]),[S,u]=i.useState({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),[K,B]=i.useState(!1),[F,D]=i.useState(null),{toast:T}=os(),{user:a,profile:v}=Cs(),{isShiftActive:P,shiftUser:R}=Ai(),{shopId:E}=On(),[H,te]=i.useState([]),[Q,A]=i.useState({}),[U,ae]=i.useState({}),[se,ge]=i.useState({}),[fe,ne]=i.useState(""),[Ue,Ct]=i.useState(!1),[tt,We]=i.useState({}),[Qe,Z]=i.useState(!1),[ye,it]=i.useState(!0),[_t,be]=i.useState(!1),ke=Ge.useRef(""),Dt=Ge.useRef(0),[Ot,Gt]=i.useState(0),[Kt,Oe]=i.useState(0),[Ke,ct]=i.useState(!1),[$e,at]=i.useState(!0),[X,mt]=i.useState(!1),[Lt,Tt]=i.useState(!1),[M,we]=i.useState(!0),[Me,L]=i.useState(!0),[rt,aa]=i.useState({}),[yt,pt]=i.useState(!1),[Rt,zt]=i.useState("التحقق قبل العملية"),[sa,vs]=i.useState("أدخل الرقم السري الرئيسي للمتابعة"),cs=Ge.useRef(null),ua=(d,C,O)=>{zt(d),vs(C),cs.current=O,pt(!0)},[na,Da]=i.useState([]),[ds,ha]=i.useState(!1),[$,he]=i.useState(""),[Ne,ce]=i.useState(""),[Te,He]=i.useState(""),[Xe,Be]=i.useState(null);i.useEffect(()=>{(async()=>{try{if(!l||!(a!=null&&a.uid))return;const d=await je.getUserData(a.uid),C=Array.isArray(d==null?void 0:d.customers)?d.customers.map(O=>({id:String(O.id||""),name:String(O.name||""),mobile:O.mobile||void 0})):[];Da(C)}catch{}})()},[l,a==null?void 0:a.uid]);const[xe,re]=i.useState(!1),[Nt,la]=i.useState(null),[Aa,qa]=i.useState(null),At=(d,C)=>{la(d),qa(C),re(!0)},[as,ms]=i.useState(""),ys=i.useMemo(()=>{const d=as.trim().toLowerCase();return d?H.filter(C=>C.name.toLowerCase().includes(d)):H},[H,as]),Rr=()=>new Date().toISOString().split("T")[0];i.useEffect(()=>{l&&a!=null&&a.uid&&(jt(),$e||qt())},[l,a==null?void 0:a.uid,$e]),i.useEffect(()=>{if(!(!l||!(a!=null&&a.uid)))try{const d=Rr(),C=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date),O=V=>{try{const de=V.docs.map(Re=>{const qe=Re.data();return{id:String(qe.clientId||Re.id),productName:String(qe.productName||""),price:Number(qe.sellingPrice||0),wholesalePrice:typeof qe.wholesalePrice=="number"?qe.wholesalePrice:Number(qe.wholesalePrice||0),quantity:Number(qe.quantity||0),date:String(qe.date||d),time:String(qe.time||""),performedByType:qe.performedByType||void 0,performedByName:qe.performedByName||void 0,performedByUsername:qe.performedByUsername||null,serialNumber:qe.serialNumber||void 0,barcode:qe.barcode||void 0,firestoreId:Re.id}}),_e=(f||[]).filter(Re=>!Re.firestoreId),Ee={};[...de,..._e].forEach(Re=>{Ee[Re.id]=Re});const Pe=Object.values(Ee);vt(Pe)}catch{}};let G;try{const V=E||(v==null?void 0:v.shopId)||null,de=Ve(Ae(Y,"dailySales"),me("userId","==",a.uid),...V?[me("shopId","==",V)]:[]);G=Oa(de,O,()=>{try{G&&G()}catch{}const _e=Ve(Ae(Y,"users",a.uid,"dailySales"),...V?[me("shopId","==",V)]:[]);G=Oa(_e,O)})}catch{const V=E||(v==null?void 0:v.shopId)||null,de=Ve(Ae(Y,"users",a.uid,"dailySales"),...V?[me("shopId","==",V)]:[]);G=Oa(de,O)}return()=>{try{G&&G()}catch{}}}catch{}},[l,a==null?void 0:a.uid]),i.useEffect(()=>{if(!l)return;const d=C=>{const O=Date.now();if(C.key==="Enter"){const G=(ke.current||"").trim();ke.current="",G&&zr(G);return}C.key.length===1&&(O-(Dt.current||0)>100&&(ke.current=""),ke.current+=C.key,Dt.current=O)};return window.addEventListener("keydown",d),()=>window.removeEventListener("keydown",d)},[l,H]),i.useEffect(()=>{l&&c&&zr(c)},[l,c]);const ki=async()=>{if(a!=null&&a.uid)try{const d=v==null?void 0:v.shopId;let C,O=[];if(d){const G=Ve(Ae(Y,"products"),me("shopId","==",d),me("userId","==",a.uid));if(C=await et(G),O=C.docs.map(V=>({id:V.id,name:String(V.data().name??""),sellingPrice:Number(V.data().sellingPrice??0),wholesalePrice:Number(V.data().wholesalePrice??0),quantity:Number(V.data().quantity??0),barcode:String(V.data().barcode??""),serialNumber:String(V.data().serialNumber??"")})),O.length===0){const V=Ve(Ae(Y,"products"),me("userId","==",a.uid)),de=(await et(V)).docs.map(_e=>({id:_e.id,name:String(_e.data().name??""),sellingPrice:Number(_e.data().sellingPrice??0),wholesalePrice:Number(_e.data().wholesalePrice??0),quantity:Number(_e.data().quantity??0),barcode:String(_e.data().barcode??""),serialNumber:String(_e.data().serialNumber??"")}));de.length>0&&(O=de,T({title:"تم استرجاع المنتجات",description:"عثرنا على منتجات محفوظة لك خارج المتجر الحالي وقمنا بعرضها."}))}}else{const G=Ve(Ae(Y,"products"),me("userId","==",a.uid));C=await et(G),O=C.docs.map(V=>({id:V.id,name:String(V.data().name??""),sellingPrice:Number(V.data().sellingPrice??0),wholesalePrice:Number(V.data().wholesalePrice??0),quantity:Number(V.data().quantity??0),barcode:String(V.data().barcode??""),serialNumber:String(V.data().serialNumber??"")}))}if(te(O),v!=null&&v.shopId&&O.length>0){const G=O.filter(V=>{const de=((C==null?void 0:C.docs)||[]).find(_e=>_e.id===V.id);return!(de&&de.data().shopId)});if(G.length>0)try{await Promise.all(G.map(V=>Ut(Le(Y,"products",V.id),{shopId:v.shopId,updatedAt:dt()}))),T({title:"تم ترتيب المنتجات",description:"تم ربط بعض المنتجات غير المربوطة بمتجرك الحالي تلقائياً."})}catch(V){console.warn("تعذّر ترحيل shopId لبعض المنتجات:",V)}}}catch(d){console.error("Error loading shop products:",d)}};i.useEffect(()=>{l&&a!=null&&a.uid&&(ki(),qt(),jt(),bt())},[l,a==null?void 0:a.uid,v==null?void 0:v.shopId]);const z=()=>{const d=new Date,C=d.getFullYear(),O=String(d.getMonth()+1).padStart(2,"0"),G=String(d.getDate()).padStart(2,"0");return`${C}-${O}-${G}`},pe=d=>{const C=O=>{if(typeof O.createdAtMs=="number")return O.createdAtMs;const G=parseInt(O.id,10);if(!isNaN(G))return G;const V=new Date(O.date);return isNaN(V.getTime())?0:V.getTime()};return[...d].sort((O,G)=>C(G)-C(O))},jt=()=>{if(!(a!=null&&a.uid)){console.log("No user authenticated, cannot load sales data");return}const d=E||(v==null?void 0:v.shopId)||"main",C=`salesData_all_${a.uid}_${d}`,O=localStorage.getItem(C);if(O)try{const Re=JSON.parse(O);j(Array.isArray(Re)?pe(Re):[]);return}catch{}const G=z(),V=`salesData_${a.uid}_${d}_${G}`,de=localStorage.getItem(V);if(de){const Re=JSON.parse(de),qe=Array.isArray(Re)?pe(Re):[];j(qe);try{localStorage.setItem(C,JSON.stringify(qe))}catch{}return}const _e=new Date().toISOString().split("T")[0],Ee=`salesData_${a.uid}_${d}_${_e}`,Pe=localStorage.getItem(Ee);if(Pe){const Re=JSON.parse(Pe),qe=Array.isArray(Re)?pe(Re):[];j(qe);try{localStorage.setItem(V,JSON.stringify(qe)),localStorage.setItem(C,JSON.stringify(qe))}catch{}return}wa()},vt=d=>{if(!(a!=null&&a.uid)){console.log("No user authenticated, cannot save sales data");return}const C=E||(v==null?void 0:v.shopId)||"main",O=z(),G=`salesData_${a.uid}_${C}_${O}`,V=`salesData_all_${a.uid}_${C}`,de=pe(d);localStorage.setItem(G,JSON.stringify(de));try{const _e=localStorage.getItem(V),Ee=_e?JSON.parse(_e):[],Pe={};[...Array.isArray(Ee)?Ee:[],...de].forEach(ze=>{Pe[ze.id]=ze});const Re=Object.values(Pe),qe=pe(Re);localStorage.setItem(V,JSON.stringify(qe))}catch{}j(de)},ka=d=>{if(!(a!=null&&a.uid)){console.log("No user authenticated, cannot save sales data");return}const C=E||(v==null?void 0:v.shopId)||"main",O=`salesData_all_${a.uid}_${C}`;try{const V=localStorage.getItem(O),de=V?JSON.parse(V):[],_e={};[...Array.isArray(de)?de:[],...d].forEach(Re=>{_e[Re.id]=Re});const Ee=Object.values(_e),Pe=pe(Ee);localStorage.setItem(O,JSON.stringify(Pe))}catch{}const G=pe(d);j(G)},wa=async()=>{if(a!=null&&a.uid)try{const d=E||(v==null?void 0:v.shopId)||null,C=new Date().toISOString().split("T")[0],O=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date);let G,V;try{const Pe=Ve(Ae(Y,"dailySales"),me("userId","==",a.uid),...d?[me("shopId","==",d)]:[]);G=await et(Pe)}catch{}try{const Pe=Ve(Ae(Y,"users",a.uid,"dailySales"),...d?[me("shopId","==",d)]:[]);V=await et(Pe)}catch{}const de=[...G?G.docs:[],...V?V.docs:[]].map(Pe=>{var Re,qe;const ze=Pe.data();return{id:String(ze.clientId||Pe.id),firestoreId:Pe.id,productName:String(ze.productName||""),price:Number(ze.sellingPrice||0),wholesalePrice:ze.wholesalePrice!==void 0?Number(ze.wholesalePrice):null,quantity:Number(ze.quantity||0),date:String(ze.date||C),time:String(ze.time||""),serialNumber:ze.serialNumber||void 0,barcode:ze.barcode||void 0,performedByType:ze.performedByType||void 0,performedByName:ze.performedByName||void 0,performedByUsername:ze.performedByUsername||void 0,isDeferred:!!ze.isDeferred,customerName:ze.customerName||void 0,customerMobile:ze.customerMobile||void 0,customerId:ze.customerId||void 0,createdAtMs:(qe=(Re=ze==null?void 0:ze.createdAt)==null?void 0:Re.toDate)!=null&&qe.call(Re)?ze.createdAt.toDate().getTime():new Date(String(ze.date||C)).getTime()}}),_e={};[...f,...de].forEach(Pe=>{_e[Pe.id]=Pe});const Ee=Object.values(_e);ka(Ee)}catch{}},qt=async()=>{if(a!=null&&a.uid)try{const d=new Date,C=new Date(d.getFullYear(),d.getMonth(),1),O=new Date(d.getFullYear(),d.getMonth()+1,0),G=qe=>qe.toISOString().split("T")[0],V=G(C),de=G(O),_e=E||(v==null?void 0:v.shopId)||null;let Ee;try{const qe=Ve(Ae(Y,"dailySales"),me("userId","==",a.uid),..._e?[me("shopId","==",_e)]:[]);Ee=await et(qe)}catch{const qe=Ve(Ae(Y,"users",a.uid,"dailySales"),..._e?[me("shopId","==",_e)]:[]);Ee=await et(qe)}let Pe=0,Re=0;Ee.forEach(qe=>{const ze=qe.data(),oa=String(ze.date??"").slice(0,10);if(!ze.isDeferred&&oa>=V&&oa<=de){const hs=Number(ze.sellingPrice??0),Ja=Number(ze.quantity??0),ar=Number(ze.profit??(Number(ze.sellingPrice??0)-Number(ze.wholesalePrice??0))*Ja);Pe+=hs*Ja,Re+=ar}}),Gt(Pe),Oe(Re)}catch(d){console.error("Error loading monthly stats:",d)}},Ls=async d=>{if(!(a!=null&&a.uid))return null;try{const C=((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0),O=P&&R?"cashier":"admin",G=O==="cashier"?(R==null?void 0:R.name)||"كاشير":(v==null?void 0:v.fullName)||(a==null?void 0:a.displayName)||"الحساب الرئيسي",V=O==="cashier"&&(R==null?void 0:R.username)||null,de=await ls(Ae(Y,"dailySales"),{userId:a.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit:C,date:d.date,time:d.time,performedByType:O,performedByName:G,performedByUsername:V,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...v!=null&&v.shopId?{shopId:v.shopId}:E?{shopId:E}:{},createdAt:dt()});try{await ns(Le(Y,"users",a.uid,"dailySales",de.id),{userId:a.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit:C,date:d.date,time:d.time,performedByType:O,performedByName:G,performedByUsername:V,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...v!=null&&v.shopId?{shopId:v.shopId}:E?{shopId:E}:{},createdAt:dt()})}catch{}return de.id}catch{try{const C=await ls(Ae(Y,"users",a.uid,"dailySales"),{userId:a.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit,date:d.date,time:d.time,performedByType,performedByName,performedByUsername,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...v!=null&&v.shopId?{shopId:v.shopId}:E?{shopId:E}:{},createdAt:dt()});try{await ns(Le(Y,"dailySales",C.id),{userId:a.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit,date:d.date,time:d.time,performedByType,performedByName,performedByUsername,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...v!=null&&v.shopId?{shopId:v.shopId}:E?{shopId:E}:{},createdAt:dt()})}catch{}return C.id}catch(C){return console.error("Error saving sale:",C),null}}},Ms=()=>{const d=E||(v==null?void 0:v.shopId)||"main";return`cashBalance_${(a==null?void 0:a.uid)||"default"}_${d}`},tr=async(d,C)=>{if(a!=null&&a.uid)try{const O=Le(Y,"dailySales",d);await Ut(O,C)}catch{try{const O=Le(Y,"users",a.uid,"dailySales",d);await Ut(O,C)}catch(O){console.error("Error updating sale:",O)}}},nt=async d=>{try{const C=d.firestoreId;if(C)await tr(C,{isDeferred:!1});else try{const O=Ve(Ae(Y,"dailySales"),me("userId","==",(a==null?void 0:a.uid)||""),me("date","==",d.date),me("productName","==",d.productName),ui(5)),G=(await et(O)).docs[0];G&&await Ut(G.ref,{isDeferred:!1})}catch{}j(O=>O.map(G=>G.id===d.id?{...G,isDeferred:!1}:G));try{await qt()}catch{}T({title:"تم التسديد",description:`تم تسديد أجل ${d.productName}`})}catch(C){console.error("Error marking deferred sale as paid:",C),T({title:"فشل التسديد",description:"تعذّر تحديث حالة البيع المؤجّل",variant:"destructive"})}},bt=async()=>{if(!(a!=null&&a.uid))return;const d=f.filter(C=>!C.firestoreId);if(d.length!==0)for(const C of d)try{let O;try{const V=Ve(Ae(Y,"dailySales"),me("userId","==",a.uid),me("clientId","==",C.id),ui(1));O=await et(V)}catch{const V=Ve(Ae(Y,"users",a.uid,"dailySales"),me("clientId","==",C.id),ui(1));O=await et(V)}if(!O.empty){const V=O.docs[0].id,de=f.map(_e=>_e.id===C.id?{..._e,firestoreId:V}:_e);vt(de);continue}const G=await Ls(C);if(G){const V=f.map(de=>de.id===C.id?{...de,firestoreId:G}:de);vt(V)}}catch{}},us=async d=>{try{if(a!=null&&a.uid)try{const Ee=Ae(Y,"deficiencies"),Pe=await ls(Ee,{shopId:(v==null?void 0:v.shopId)||a.uid||"default-shop",name:d,quantity:1,status:"pending",createdAt:dt()});try{const Re=`deficiencies_${(v==null?void 0:v.shopId)||(a==null?void 0:a.uid)||"default-shop"}`,qe=localStorage.getItem(Re),ze=qe?JSON.parse(qe):[],oa=Array.isArray(ze)?ze:[],hs=oa.some(La=>String((La==null?void 0:La.id)||"")===Pe.id),Ja={id:Pe.id,name:d,quantity:1,status:"pending",createdAt:new Date().toISOString()},ar=hs?oa:[...oa,Ja];localStorage.setItem(Re,JSON.stringify(ar))}catch{}T({title:"تمت الإضافة للنواقص",description:`المنتج ${d} نفد من المخزون وتمت إضافته للنواقص`});return}catch(Ee){console.warn("Failed to add deficiency to Firestore, falling back to local storage:",Ee)}const C=`deficiencies_${(v==null?void 0:v.shopId)||(a==null?void 0:a.uid)||"default-shop"}`,O=localStorage.getItem(C),G=O?JSON.parse(O):[],V=Array.isArray(G)?G:[];if(V.some(Ee=>String((Ee==null?void 0:Ee.name)||"").trim()===d&&String((Ee==null?void 0:Ee.status)||"pending")==="pending"))return;const de={id:Date.now().toString(),name:d,quantity:1,status:"pending",createdAt:new Date().toISOString()},_e=[...V,de];localStorage.setItem(C,JSON.stringify(_e)),T({title:"تمت الإضافة للنواقص",description:`المنتج ${d} نفد من المخزون وتمت إضافته للنواقص`})}catch(C){console.error("Error adding deficiency for out-of-stock:",C)}},yr=async(d,C=!1,O)=>{const G=Q[d.id]||"",V=parseInt(G);if(isNaN(V)||V<=0){T({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(V>d.quantity){T({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const de=new Date,_e=P&&R?"cashier":"admin",Ee=_e==="cashier"?(R==null?void 0:R.name)||"كاشير":(v==null?void 0:v.fullName)||(a==null?void 0:a.displayName)||"الحساب الرئيسي",Pe=_e==="cashier"&&(R==null?void 0:R.username)||null,Re=(d.serialNumber||"").trim(),qe=rt[d.id]||"",ze=parseFloat(qe),oa=!isNaN(ze)&&ze>0?ze:d.sellingPrice,hs={id:Date.now().toString(),productName:d.name,price:oa,wholesalePrice:d.wholesalePrice,quantity:V,date:de.toISOString().split("T")[0],time:de.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),createdAtMs:de.getTime(),performedByType:_e,performedByName:Ee,performedByUsername:Pe,serialNumber:Re||void 0,barcode:d.barcode,isDeferred:C,customerName:O==null?void 0:O.name,customerMobile:O==null?void 0:O.mobile,customerId:O==null?void 0:O.id};try{const Ja=await Ls(hs),ar=Ja?{...hs,firestoreId:Ja}:hs;vt([...f,ar]);const La=d.quantity-V;if(await Ut(Le(Y,"products",d.id),{quantity:La,updatedAt:dt()}),te(Ya=>Ya.map(As=>As.id===d.id?{...As,quantity:La}:As)),A(Ya=>({...Ya,[d.id]:""})),aa(Ya=>({...Ya,[d.id]:""})),La===0&&us(d.name),!C)try{const Ya=oa*V,As=Ms(),wr=localStorage.getItem(As),Nr=(wr?parseFloat(wr):0)+Ya;localStorage.setItem(As,Nr.toString());const Va=`userData_${a==null?void 0:a.uid}`,jr={cashBalance:Nr,lastUpdated:new Date().toISOString()};localStorage.setItem(Va,JSON.stringify(jr)),a!=null&&a.uid&&je.updateUserData(a.uid,jr).catch(()=>{});const Ti=(v==null?void 0:v.shopId)||E;if(Ti)try{await Ut(Le(Y,"dashboardData",Ti),{cashBalance:Nr})}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:Nr}}))}catch{}try{if(a!=null&&a.uid){const $i=`SALECASH-${a.uid}-${Date.now()}`,Ln={txnType:"cash_addition",type:"cash_addition",amount:Ya,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:$i,title:"إيصال إضافة نقدية",merchantUserId:a.uid,createdBy:a.uid,shopId:(v==null?void 0:v.shopId)||E||void 0,cashierName:Ee,performedByType:_e,performedByUsername:Pe,createdAt:new Date};await je.saveUserTransaction(a.uid,Ln)}}catch{}}catch(Ya){console.warn("تعذر تحديث رصيد الدرج النقدي بعد البيع:",Ya)}T({title:"تم البيع",description:`تم بيع ${V} قطعة من ${d.name}`})}catch(Ja){console.error("Error selling product:",Ja),T({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},br=async d=>{if(a!=null&&a.uid){if(P){T({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف إيصالات البيع أثناء الورديه",variant:"destructive"});return}ua("تأكيد حذف إيصال بيع","أدخل الرقم السري الرئيسي لحذف الإيصال وعكس الآثار",async()=>{try{if(!d.isDeferred)try{const C=(d.price??0)*(d.quantity??0),O=Ms(),G=localStorage.getItem(O),V=(G?parseFloat(G):0)-C;localStorage.setItem(O,V.toString());const de=`userData_${a==null?void 0:a.uid}`,_e={cashBalance:V,lastUpdated:new Date().toISOString()};localStorage.setItem(de,JSON.stringify(_e)),a!=null&&a.uid&&je.updateUserData(a.uid,_e).catch(()=>{});const Ee=(v==null?void 0:v.shopId)||E;if(Ee)try{await Ut(Le(Y,"dashboardData",Ee),{cashBalance:V})}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:V}}))}catch{}}catch(C){console.warn("تعذر عكس رصيد الدرج النقدي عند حذف الإيصال:",C)}try{const C=H.find(O=>d.barcode&&O.barcode===d.barcode||O.name===d.productName);if(C){const O=(C.quantity||0)+(d.quantity||0);await Ut(Le(Y,"products",C.id),{quantity:O,updatedAt:dt()}),te(G=>G.map(V=>V.id===C.id?{...V,quantity:O}:V))}}catch(C){console.warn("تعذر عكس المخزون عند حذف الإيصال:",C)}try{if(d.firestoreId){try{await Ea(Le(Y,"dailySales",d.firestoreId))}catch{}try{await Ea(Le(Y,"users",a.uid,"dailySales",d.firestoreId))}catch{}}else{let C;try{const O=Ve(Ae(Y,"dailySales"),me("userId","==",a.uid),me("date","==",d.date),me("productName","==",d.productName),ui(5));C=await et(O)}catch{const O=Ve(Ae(Y,"users",a.uid,"dailySales"),me("date","==",d.date),me("productName","==",d.productName),ui(5));C=await et(O)}if(!C.empty){const O=C.docs.find(G=>{const V=G.data();return Number((V==null?void 0:V.sellingPrice)??0)===Number(d.price??0)&&Number((V==null?void 0:V.quantity)??0)===Number(d.quantity??0)&&String((V==null?void 0:V.time)??"")===String(d.time??"")})||C.docs[0];O&&await Ea(O.ref)}}}catch(C){console.warn("تعذر حذف سجل البيع من Firestore:",C)}try{const C=z(),O=`salesData_${a.uid}_${C}`,G=`salesData_all_${a.uid}`,V=f.filter(Pe=>Pe.id!==d.id);localStorage.setItem(O,JSON.stringify(V));const de=localStorage.getItem(G),_e=de?JSON.parse(de):[],Ee=(Array.isArray(_e)?_e:[]).filter(Pe=>(Pe==null?void 0:Pe.id)!==d.id);localStorage.setItem(G,JSON.stringify(Ee)),j(V)}catch(C){console.warn("تعذر تحديث التخزين المحلي بعد الحذف:",C)}try{$e||await qt()}catch{}T({title:"تم حذف الإيصال",description:`تم حذف إيصال بيع للمنتج ${d.productName} وتم عكس الآثار`})}catch(C){console.error("Error deleting sale:",C),T({title:"فشل حذف الإيصال",description:"تعذّر حذف إيصال البيع",variant:"destructive"})}})}},Pn=async d=>{try{A(C=>({...C,[d.id]:"1"})),await yr(d)}catch(C){console.error("Error selling by barcode:",C)}},Fn=async d=>{if(P){T({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة قطع أثناء الورديه",variant:"destructive"});return}const C=U[d.id]||"",O=parseInt(C);if(isNaN(O)||O<=0){T({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للإضافة",variant:"destructive"});return}ua("تأكيد إضافة قطع","لا يمكن إضافة قطع إلا بإدخال الرقم السري الرئيسي",async()=>{try{const G=d.quantity+O;await Ut(Le(Y,"products",d.id),{quantity:G,updatedAt:dt()}),te(V=>V.map(de=>de.id===d.id?{...de,quantity:G}:de)),ae(V=>({...V,[d.id]:""})),T({title:"تمت الإضافة",description:`تمت إضافة ${O} قطعة إلى ${d.name}`})}catch(G){console.error("Error adding pieces:",G),T({title:"فشل الإضافة",description:"تعذّر إضافة الكمية إلى المخزون",variant:"destructive"})}})},_i=async d=>{if(a!=null&&a.uid){if(P){T({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف المنتجات أثناء الورديه",variant:"destructive"});return}window.confirm(`هل تريد حذف المنتج "${d.name}"؟`)&&ua("تأكيد حذف منتج","لا يمكن حذف المنتجات إلا بإدخال الرقم السري الرئيسي",async()=>{try{await Ea(Le(Y,"products",d.id)),te(C=>C.filter(O=>O.id!==d.id)),T({title:"تم الحذف",description:`تم حذف المنتج ${d.name}`})}catch(C){console.error("Error deleting product:",C),T({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}})}},Fa=async()=>{try{if(!(a!=null&&a.uid)){T({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}if(P){T({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتجات أثناء الورديه",variant:"destructive"});return}const d=S.productName.trim(),C=parseFloat(S.price),O=parseFloat(S.wholesalePrice||"0"),G=parseInt(S.quantity);if(!d||isNaN(C)||isNaN(G)){T({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const V={name:d,sellingPrice:C,wholesalePrice:isNaN(O)?0:O,quantity:isNaN(G)?0:G,userId:a.uid,createdAt:dt(),updatedAt:dt()},de=(S.barcode||"").trim();de&&(V.barcode=de);const _e=(S.serialNumber||"").trim();_e&&(V.serialNumber=_e),v!=null&&v.shopId&&(V.shopId=v.shopId);const Ee=await ls(Ae(Y,"products"),V);te(Pe=>[{id:Ee.id,name:d,sellingPrice:C,wholesalePrice:isNaN(O)?0:O,quantity:isNaN(G)?0:G,barcode:(S.barcode||"").trim()||"",serialNumber:(S.serialNumber||"").trim()||""},...Pe]),u({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),T({title:"تمت الإضافة",description:`تم إضافة المنتج ${d} بنجاح`})}catch(d){console.error("createProduct error",d),T({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}},zr=async d=>{const C=(d||"").trim();if(!C)return;const O=H.find(G=>(G.barcode||"")===C);if(!O){T({title:"باركود غير معروف",description:"لم يتم العثور على منتج بهذا الباركود"});return}await Pn(O)},uo=()=>{const d=Object.entries(tt).map(([Pe,Re])=>{const qe=Number(Re),ze=H.find(oa=>oa.id===Pe);return!ze||!qe||qe<=0?null:{name:ze.name,qty:qe,price:ze.sellingPrice,total:qe*ze.sellingPrice}}).filter(Boolean);if(d.length===0){T({title:"لم يتم اختيار منتجات",description:"فعّل وضع الفاتورة واختر منتجات وكميات للطباعة"});return}const C=(v==null?void 0:v.shopName)||(a==null?void 0:a.displayName)||"المحل",O=(v==null?void 0:v.phone)||(a==null?void 0:a.phoneNumber)||"",G=d.reduce((Pe,Re)=>Pe+Re.total,0),V=new Date().toLocaleString("ar-EG"),de=d.map(Pe=>`
        <tr>
          <td style="border:1px solid #ddd;padding:6px">${Pe.name}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${Pe.qty}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${Vt(Pe.price)}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center;font-weight:bold;color:#0a7">${Vt(Pe.total)}</td>
        </tr>
      `).join(""),_e=`
      <html>
        <head>
          <meta charset="utf-8" />
          <title>فاتورة</title>
          <style>
            body { font-family: Tahoma, Arial, sans-serif; direction: rtl; }
            .header { text-align: center; margin-bottom: 12px; }
            .header h2 { margin: 0; }
            .meta { text-align: center; color: #555; margin-bottom: 8px; }
            table { width: 100%; border-collapse: collapse; }
            .total { text-align: left; font-weight: bold; margin-top: 10px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>${C}</h2>
            ${O?`<div class="meta">رقم التليفون: ${O}</div>`:""}
            <div class="meta">التاريخ: ${V}</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="border:1px solid #ddd;padding:6px">المنتج</th>
                <th style="border:1px solid #ddd;padding:6px">الكمية</th>
                <th style="border:1px solid #ddd;padding:6px">السعر</th>
                <th style="border:1px solid #ddd;padding:6px">الإجمالي</th>
              </tr>
            </thead>
            <tbody>
              ${de}
            </tbody>
          </table>
          <div class="total">الإجمالي الكلي: ${Vt(G)}</div>
        </body>
      </html>
    `,Ee=window.open("","_blank");Ee&&(Ee.document.write(_e),Ee.document.close(),Ee.focus(),Ee.print(),Ee.close())};return e.jsxs(Se,{open:l,onOpenChange:m,children:[e.jsxs(Ie,{className:"max-w-none w-[100vw] md:w-[100vw] lg:w-[100vw] max-h-[85vh] md:h-[100dvh] md:max-h-[100dvh] p-0 overflow-y-auto",children:[e.jsx(Ce,{className:"px-3 md:px-6 py-3 md:py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-blue-100 rounded-lg",children:e.jsx(kn,{className:"h-5 w-5 md:h-6 md:w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(De,{className:"text-lg md:text-xl font-bold text-gray-800",children:"📊 قسم المبيعات"}),e.jsx("p",{className:"text-xs md:text-sm text-gray-600 mt-1 hidden sm:block",children:"إدارة وتتبع المبيعات"})]})]}),e.jsxs("div",{className:"flex items-center gap-1 md:gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:()=>bt(),className:"text-xs md:text-sm",children:"استرجاع الإيصالات"}),e.jsx(x,{variant:"ghost",size:"sm",onClick:m,className:"h-8 w-8 md:h-9 md:w-9",children:e.jsx(pd,{className:"h-4 w-4"})})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row h-full",dir:"rtl",children:[e.jsxs("div",{className:"w-full md:w-72 lg:w-80 bg-white/50 border-r",children:[e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(Xt,{className:"h-4 w-4 text-green-600"}),"ملخص المبيعات"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:gap-3",children:[e.jsxs("div",{className:"bg-blue-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-blue-600",children:Vt(f.filter(d=>!d.isDeferred).reduce((d,C)=>d+C.price*C.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-blue-600",children:"إجمالي المبيعات"})]}),e.jsxs("div",{className:"relative bg-green-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsxs("div",{className:ye?"filter blur-sm pointer-events-none":"",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-green-600",children:Vt(f.filter(d=>!d.isDeferred).reduce((d,C)=>d+(C.price-(C.wholesalePrice??0))*C.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-green-600",children:"إجمالي الأرباح"})]}),ye&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>be(!0),className:"bg-white/80 hover:bg-white text-green-700 border border-green-200",children:"عرض الأرباح"})})]}),e.jsxs("div",{className:"bg-yellow-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-yellow-600",children:Vs(H.length)}),e.jsx("div",{className:"text-xs md:text-sm text-yellow-600",children:"عدد المنتجات"})]}),e.jsxs("div",{className:"bg-purple-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-purple-600",children:Vs(f.filter(d=>!d.isDeferred).length)}),e.jsx("div",{className:"text-xs md:text-sm text-purple-600",children:"عدد المبيعات"})]})]}),e.jsxs("div",{className:"relative mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1 md:gap-2 text-xs md:text-sm font-semibold text-indigo-700",children:[e.jsx(Zs,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx(kn,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{children:"تقارير الشهر"})]}),e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>mt(d=>!d),className:"h-6 w-6 p-0 rounded-full",title:X?"إظهار التقارير":"إخفاء التقارير",children:X?e.jsx(Si,{className:"h-4 w-4"}):e.jsx(Dn,{className:"h-4 w-4"})})]}),e.jsx("div",{className:X?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]",children:e.jsxs("div",{className:$e?"grid grid-cols-2 gap-2 md:gap-4 filter blur-sm pointer-events-none":"grid grid-cols-2 gap-2 md:gap-4",children:[e.jsxs("div",{className:"bg-indigo-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-indigo-600",children:Vt(Ot)}),e.jsx("div",{className:"text-xs md:text-sm text-indigo-600",children:"مبيعات الشهر"})]}),e.jsxs("div",{className:"bg-pink-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-pink-600",children:Vt(Kt)}),e.jsx("div",{className:"text-xs md:text-sm text-pink-600",children:"أرباح الشهر"})]})]})}),!X&&$e&&e.jsx("div",{className:"absolute left-0 right-0 top-7 md:top-10 bottom-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(x,{size:"sm",variant:"ghost",onClick:async()=>{try{if(await isZeroPlan()){T({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}ct(!0)},className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all btn-monthly-reports",title:"عرض تقارير الشهر",children:[e.jsx(Bt,{className:"h-5 w-5 md:h-7 md:w-7"}),e.jsx("span",{className:"text-xs md:text-sm",children:"عرض تقارير الشهر"})]})})]})]}),e.jsx("div",{className:"flex justify-end mb-3",children:e.jsxs(x,{size:"sm",variant:"ghost",onClick:()=>Tt(!0),className:"h-7 px-3 rounded-full bg-green-50 hover:bg-green-100 text-green-700",title:"إيصالات البيع",children:[e.jsx(Di,{className:"h-4 w-4 mr-1"}),"إيصالات البيع"]})}),e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(yi,{className:"h-4 w-4 text-indigo-600"}),"إحصائيات المنتجات"]}),e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>we(d=>!d),className:"h-6 w-6 p-0 rounded-full",title:M?"إظهار القسم":"إخفاء القسم",children:M?e.jsx(Si,{className:"h-4 w-4"}):e.jsx(Dn,{className:"h-4 w-4"})})]}),e.jsx("div",{className:M?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]}),e.jsxs("div",{className:"p-3 md:p-4 flex-1 hidden md:block",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(ro,{className:"h-4 w-4 text-blue-600"}),"نصائح للمبيعات"]}),e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>L(d=>!d),className:"h-6 w-6 p-0 rounded-full",title:Me?"إظهار القسم":"إخفاء القسم",children:Me?e.jsx(Si,{className:"h-4 w-4"}):e.jsx(Dn,{className:"h-4 w-4"})})]}),e.jsx("div",{className:Me?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-visible transition-all duration-300 ease-in-out",children:e.jsxs("div",{className:"p-3 md:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-2",children:[e.jsxs("h2",{className:"text-base md:text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Xh,{className:"h-4 w-4 md:h-5 md:w-5 text-blue-600"}),"سجل المبيعات (",f.filter(d=>!d.isDeferred).length," عنصر)"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm text-gray-600",children:[e.jsx(Zs,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(Ps,{className:"h-3 w-3 md:h-4 md:w-4 ml-2"}),e.jsx("span",{children:new Date().toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 md:p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Sa,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج جديد"]}),e.jsxs(x,{size:"sm",variant:"ghost",className:"h-8",onClick:()=>{if(P){T({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتج أثناء الورديه",variant:"destructive"});return}ua("فتح نموذج إضافة منتج","أدخل الرقم السري الرئيسي لفتح نموذج الإضافة",()=>B(!0))},children:[e.jsx(Sa,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج"]})]}),K&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"new-product-name",className:"text-xs md:text-sm",children:"اسم المنتج"}),e.jsx(q,{id:"new-product-name",value:S.productName,onChange:d=>u(C=>({...C,productName:d.target.value})),placeholder:"أدخل اسم المنتج"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"new-product-price",className:"text-xs md:text-sm",children:"سعر البيع (ج.م)"}),e.jsx(q,{type:"number",id:"new-product-price",value:S.price,onChange:d=>u(C=>({...C,price:d.target.value})),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"new-product-wholesale",className:"text-xs md:text-sm",children:"سعر الجملة (ج.م)"}),e.jsx(q,{type:"number",id:"new-product-wholesale",value:S.wholesalePrice||"",onChange:d=>u(C=>({...C,wholesalePrice:d.target.value})),placeholder:"0.00"})]})]}),e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"new-product-qty",className:"text-xs md:text-sm",children:"الكمية"}),e.jsx(q,{type:"number",id:"new-product-qty",value:S.quantity,onChange:d=>u(C=>({...C,quantity:d.target.value})),placeholder:"1"})]}),e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"new-product-barcode",className:"text-xs md:text-sm",children:"باركود المنتج (اختياري)"}),e.jsx(q,{id:"new-product-barcode",value:S.barcode||"",onChange:d=>u(C=>({...C,barcode:d.target.value})),placeholder:"أدخل/امسح الباركود"})]}),e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"new-product-serial",className:"text-xs md:text-sm",children:"سيريال الجهاز (اختياري)"}),e.jsx(q,{id:"new-product-serial",value:S.serialNumber||"",onChange:d=>u(C=>({...C,serialNumber:d.target.value})),placeholder:"أدخل سيريال الجهاز"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(x,{className:"h-9 w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white",onClick:Fa,children:"إضافة المنتج"}),e.jsx(x,{variant:"outline",className:"h-9 w-full md:w-auto",onClick:()=>B(!1),children:"إغلاق"})]})]})]}),e.jsx("div",{id:"shop-products-section",className:"bg-white rounded-lg border border-gray-200 overflow-hidden mb-4",children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 mb-2 flex items-center gap-2",children:[e.jsx(yi,{className:"h-4 w-4 text-green-600"}),"منتجات المحل"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(x,{variant:Ue?"default":"outline",size:"sm",onClick:()=>Ct(d=>!d),children:Ue?"وضع الفاتورة: مفعل":"تفعيل وضع الفاتورة"}),e.jsx(x,{size:"sm",className:"bg-indigo-600 hover:bg-indigo-700 text-white",disabled:Object.keys(tt).filter(d=>(tt[d]||0)>0).length===0,onClick:uo,children:"طباعة فاتورة"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(q,{value:as,onChange:d=>ms(d.target.value),placeholder:"ابحث عن منتج...",className:"h-9 w-full md:w-72 text-sm","aria-label":"البحث عن منتج من منتجات المحل"}),e.jsx(q,{value:fe,onChange:d=>ne(d.target.value),onKeyDown:async d=>{if(d.key!=="Enter")return;const C=fe.trim();C&&(await zr(C),ne(""))},placeholder:"مرّر ماسح الباركود هنا (اختياري)",className:"h-9 w-full md:w-64 text-sm","aria-label":"مسح الباركود لإضافة المنتج تلقائياً"}),as&&e.jsx(x,{variant:"ghost",size:"sm",className:"h-9",onClick:()=>ms(""),children:"مسح"})]}),e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg hidden md:block",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Z(d=>!d),"aria-label":Qe?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Qe?e.jsx(ba,{className:"h-4 w-4"}):e.jsx(Bt,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المتاح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"بيع"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:ys.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-3 py-3 text-center text-gray-500",children:H.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"})}):ys.map(d=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:d.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Vt(d.sellingPrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:e.jsx("span",{className:Qe?"":"blur-sm select-none",children:Vt(d.wholesalePrice)})}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Vs(d.quantity)}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 flex-nowrap",children:[e.jsx(q,{value:Q[d.id]||"",onChange:C=>A(O=>({...O,[d.id]:C.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-8 w-28 text-sm"}),e.jsx(q,{value:rt[d.id]||"",onChange:C=>aa(O=>({...O,[d.id]:C.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-8 w-32 text-sm","aria-label":`سعر بيع اختياري لـ ${d.name}`}),e.jsx(x,{size:"sm",className:"h-8 min-w-[64px] bg-indigo-600 hover:bg-indigo-700 text-white",onClick:()=>yr(d),children:"بيع"}),e.jsx(x,{size:"sm",className:"h-8 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>{Be(d),ha(!0)},children:"بيع أجل"}),Ue&&e.jsx(q,{value:tt[d.id]??"",onChange:C=>{const O=parseInt(C.target.value||"0");We(G=>({...G,[d.id]:isNaN(O)?0:O}))},type:"number",placeholder:"كمية للفاتورة",className:"h-8 w-24 text-sm"}),e.jsx(q,{value:U[d.id]||"",onChange:C=>ae(O=>({...O,[d.id]:C.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-8 w-28 text-sm",disabled:P}),e.jsxs("div",{className:"inline-flex items-center gap-2 flex-nowrap",children:[e.jsx(x,{size:"sm",variant:"outline",className:"h-8 whitespace-nowrap",onClick:()=>Fn(d),disabled:P,title:P?"غير مسموح في وضع الكاشير":void 0,children:"إضافة قطع جديدة"}),e.jsx(x,{size:"sm",variant:"destructive",className:"h-8",onClick:()=>_i(d),title:"حذف المنتج",disabled:P,children:e.jsx(da,{className:"h-4 w-4"})})]})]})})]},d.id))})]})}),e.jsx("div",{className:"block md:hidden space-y-3",children:ys.length===0?e.jsx("div",{className:"text-center text-gray-500 text-sm",children:H.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"}):ys.map(d=>e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm break-words",children:d.name}),e.jsx(x,{size:"sm",variant:"destructive",className:"h-8 min-w-[44px] touch-manipulation",onClick:()=>_i(d),title:"حذف المنتج",disabled:P,children:e.jsx(da,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-700",children:[e.jsx("div",{className:"text-gray-600",children:"سعر البيع"}),e.jsx("div",{className:"text-right font-medium",children:Vt(d.sellingPrice)}),e.jsxs("div",{className:"text-gray-600 inline-flex items-center gap-1",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>Z(C=>!C),"aria-label":Qe?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Qe?e.jsx(ba,{className:"h-4 w-4"}):e.jsx(Bt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:Qe?"":"blur-sm select-none",children:Vt(d.wholesalePrice)})}),e.jsx("div",{className:"text-gray-600",children:"المتاح"}),e.jsx("div",{className:"text-right font-medium",children:Vs(d.quantity)})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{value:Q[d.id]||"",onChange:C=>A(O=>({...O,[d.id]:C.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للبيع لـ ${d.name}`}),e.jsx(q,{value:rt[d.id]||"",onChange:C=>aa(O=>({...O,[d.id]:C.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-9 w-28 text-sm","aria-label":`سعر بيع اختياري لـ ${d.name}`}),e.jsx(x,{size:"sm",className:"h-9 min-w-[64px] bg-indigo-600 hover:bg-indigo-700 text-white",onClick:()=>yr(d),children:"بيع"}),e.jsx(x,{size:"sm",className:"h-9 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>{Be(d),ha(!0)},children:"بيع أجل"})]}),Ue&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(q,{value:tt[d.id]??"",onChange:C=>{const O=parseInt(C.target.value||"0");We(G=>({...G,[d.id]:isNaN(O)?0:O}))},type:"number",placeholder:"كمية للفاتورة",className:"h-9 flex-1 text-sm","aria-label":`كمية للفاتورة لـ ${d.name}`})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{value:U[d.id]||"",onChange:C=>ae(O=>({...O,[d.id]:C.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للإضافة لـ ${d.name}`,disabled:P}),e.jsx(x,{size:"sm",variant:"outline",className:"h-9 min-w-[64px]",onClick:()=>Fn(d),disabled:P,title:P?"غير مسموح في وضع الكاشير":void 0,children:"إضافة"})]})]})]},d.id))})]})}),f.length===0?e.jsxs("div",{className:"text-center py-8 md:py-12",children:[e.jsx("div",{className:"w-16 h-16 md:w-24 md:h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx(yi,{className:"h-8 w-8 md:h-12 md:w-12 text-gray-400"})}),e.jsx("h3",{className:"text-base md:text-lg font-medium text-gray-900 mb-2",children:"لا توجد مبيعات اليوم"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ابدأ ببيع منتج من القائمة أعلاه"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"block md:hidden",children:e.jsx("div",{className:"max-h-[70vh] overflow-y-auto space-y-3 p-3",children:f.map(d=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-200 shadow-sm",children:[e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-base break-words",children:d.productName}),d.isDeferred&&e.jsx("span",{className:"px-2 py-0.5 rounded bg-amber-100 text-amber-700 text-[11px]",children:"مؤجّل"})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Xt,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر البيع"})]}),e.jsx("div",{className:"text-right font-medium",children:Vt(d.price)}),typeof d.wholesalePrice=="number"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Xt,{className:"h-4 w-4 text-indigo-600"}),e.jsxs("span",{className:"text-gray-600 inline-flex items-center gap-1",children:["سعر الجملة",e.jsx(x,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>Z(C=>!C),"aria-label":Qe?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Qe?e.jsx(ba,{className:"h-4 w-4"}):e.jsx(Bt,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:Qe?"":"blur-sm select-none",children:Vt(d.wholesalePrice)})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(yi,{className:"h-4 w-4 text-emerald-600"}),e.jsx("span",{className:"text-gray-600",children:"الكمية"})]}),e.jsx("div",{className:"text-right font-medium",children:Vs(d.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ni,{className:"h-4 w-4 text-indigo-600"}),e.jsx("span",{className:"text-gray-600",children:"الربح"})]}),e.jsx("div",{className:"text-right font-semibold text-indigo-600",children:e.jsx("span",{className:Qe?"":"blur-sm select-none",children:Vt(((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0))})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Xt,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"الإجمالي"})]}),e.jsx("div",{className:"text-right font-bold text-green-700",children:Vt(d.price*d.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qh,{className:"h-4 w-4 text-amber-600"}),e.jsx("span",{className:"text-gray-600",children:"المنفذ"})]}),e.jsx("div",{className:"text-right text-gray-700",children:d.performedByName??"-"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Zs,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"التاريخ"})]}),e.jsx("div",{className:"text-right text-gray-600",children:Zl(d.date)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ps,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"الوقت"})]}),e.jsx("div",{className:"text-right text-gray-600",children:d.time})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[d.isDeferred&&e.jsx(x,{size:"sm",className:"h-8 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>nt(d),title:"تم التسديد",children:"تم التسديد"}),e.jsx(x,{size:"sm",variant:"outline",onClick:()=>At(d,"return"),disabled:P,title:P?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsxs(x,{size:"sm",variant:"destructive",onClick:()=>At(d,"delete"),disabled:P,title:P?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:[e.jsx(da,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-1",children:"حذف الإيصال"})]})]})]},d.id))})}),e.jsx("div",{className:"hidden md:block overflow-x-auto max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-green-300 scrollbar-track-green-100 hover:scrollbar-thumb-green-400",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر البيع (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة (ج.م)"}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Z(d=>!d),"aria-label":Qe?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Qe?e.jsx(ba,{className:"h-4 w-4"}):e.jsx(Bt,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الإجمالي (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الربح (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الوقت"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنفذ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"إجراءات"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:f.map((d,C)=>e.jsxs("tr",{className:C%2===0?"bg-white":"bg-gray-50/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:e.jsxs("div",{className:"flex items-center gap-2 justify-end md:justify-start",children:[e.jsx("span",{children:d.productName}),d.isDeferred&&e.jsx("span",{className:"px-2 py-0.5 rounded bg-amber-100 text-amber-700 text-xs",children:"مؤجّل"})]})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Vt(d.price)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:typeof d.wholesalePrice=="number"?e.jsx("span",{className:Qe?"":"blur-sm select-none",children:Vt(d.wholesalePrice)}):"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Vs(d.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-green-600",children:Vt(d.price*d.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-indigo-600",children:e.jsx("span",{className:Qe?"":"blur-sm select-none",children:Vt(((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0))})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:Zl(d.date)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:d.time}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:d.performedByName??"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[d.isDeferred&&e.jsx(x,{size:"sm",className:"h-8 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>nt(d),title:"تم التسديد",children:"تم التسديد"}),e.jsx(x,{size:"sm",variant:"outline",onClick:()=>At(d,"return"),disabled:P,title:P?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsx(x,{size:"sm",variant:"destructive",onClick:()=>At(d,"delete"),disabled:P,title:P?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:e.jsx(da,{className:"h-4 w-4"})})]})})]},d.id))})]})})]})]})})]})]}),e.jsx(Se,{open:ds,onOpenChange:ha,children:e.jsxs(Ie,{className:"max-w-sm mx-auto bg-white border border-gray-200 shadow-2xl rounded-2xl sm:max-w-md",children:[e.jsx(Ce,{className:"text-center",children:e.jsx(De,{className:"text-base md:text-lg font-bold text-gray-900",children:"بيع أجل"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsx(ee,{className:"text-sm",children:"اختيار عميل (اختياري)"}),e.jsxs("select",{className:"h-9 border rounded px-2 text-sm",value:$,onChange:d=>{const C=d.target.value;he(C);const O=na.find(G=>G.id===C);O&&(ce(O.name),He(O.mobile||""))},children:[e.jsx("option",{value:"",children:"-- بدون اختيار --"}),na.map(d=>e.jsxs("option",{value:d.id,children:[d.name,d.mobile?` - ${d.mobile}`:""]},d.id))]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsx(ee,{className:"text-sm",children:"اسم العميل"}),e.jsx(q,{value:Ne,onChange:d=>ce(d.target.value),placeholder:"اسم العميل",className:"h-9 text-sm"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsx(ee,{className:"text-sm",children:"رقم التليفون (اختياري)"}),e.jsx(q,{value:Te,onChange:d=>He(d.target.value),placeholder:"رقم التليفون",className:"h-9 text-sm"})]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-3 mt-3",children:[e.jsx(x,{variant:"outline",className:"h-8 min-w-[80px]",onClick:()=>ha(!1),children:"إلغاء"}),e.jsx(x,{className:"h-8 min-w-[100px] bg-amber-600 hover:bg-amber-700 text-white",onClick:async()=>{try{const d=Xe;if(!d){ha(!1);return}const C=Ne.trim(),O=Te.trim()||void 0,G=$||void 0;if(!C){T({title:"بيانات مطلوبة",description:"أدخل اسم العميل",variant:"destructive"});return}await yr(d,!0,{id:G,name:C,mobile:O});try{if(a!=null&&a.uid){const V=d.sellingPrice*(parseInt(Q[d.id]||"0")||0),de=await je.getUserData(a.uid),_e=Array.isArray(de==null?void 0:de.debts)?de.debts:[],Ee={id:Date.now().toString(),debtorName:C,customerId:G||null,mobile:O||null,amount:V,reason:`بيع أجل للمنتج ${d.name}`,status:"pending",createdAt:new Date,partialPayments:[]},Pe=[Ee,..._e];await je.updateUserData(a.uid,{debts:Pe});try{const Re=E||(v==null?void 0:v.shopId)||"main";localStorage.setItem(`debts_${a.uid}_${Re}`,JSON.stringify(Pe)),localStorage.setItem(`debts_default_${Re}`,JSON.stringify(Pe)),localStorage.setItem(`debts_last_write_${a.uid}_${Re}`,Date.now().toString())}catch{}try{window.dispatchEvent(new CustomEvent("debtsUpdated",{detail:{count:Pe.length}}))}catch{}try{await xr.send(a.uid,`تم إضافة دين على ${Ee.debtorName} بمبلغ ${Ee.amount} جنيه`)}catch{}}}catch{}ha(!1),Be(null)}catch{}},children:"تأكيد البيع الآجل"})]})]})}),e.jsx(Se,{open:Lt,onOpenChange:Tt,children:e.jsxs(Ie,{className:"sm:max-w-3xl",children:[e.jsx(Ce,{children:e.jsx(De,{children:"إيصالات البيع"})}),f.filter(d=>!d.isDeferred).length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا توجد إيصالات بيع حتى الآن."}):e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg max-h-[70vh] overflow-y-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر الجملة"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الإجمالي"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الربح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الوقت"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنفذ"})]})}),e.jsx("tbody",{children:f.filter(d=>!d.isDeferred).map(d=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:d.productName}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Vt(d.price)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Vt(d.wholesalePrice??0)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Vs(d.quantity)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Vt((d.price??0)*(d.quantity??0))}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Vt(((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0))}),e.jsx("td",{className:"px-3 py-2 text-gray-500",children:Zl(d.date)}),e.jsx("td",{className:"px-3 py-2 text-gray-500",children:d.time}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:d.executedBy||"-"})]},d.id))})]})}),e.jsx("div",{className:"flex justify-end mt-3",children:e.jsx(x,{variant:"outline",onClick:()=>Tt(!1),children:"إغلاق"})})]})}),e.jsx(Se,{open:xe,onOpenChange:re,children:e.jsxs(Ie,{className:"max-w-sm mx-auto bg-white border border-gray-200 shadow-2xl rounded-2xl sm:max-w-md",children:[e.jsx(Ce,{className:"text-center",children:e.jsx(De,{className:"text-base md:text-lg font-bold text-gray-900",children:Aa==="return"?"تأكيد المرتجع":"تأكيد حذف الإيصال"})}),e.jsxs("div",{className:"space-y-3 text-center px-2",children:[e.jsxs("p",{className:"text-sm text-gray-700",children:["هل تريد ",Aa==="return"?"عمل مرتجع":"حذف الإيصال"," للمنتج:",e.jsxs("span",{className:"font-semibold text-gray-900",children:[" ",Nt==null?void 0:Nt.productName," "]}),"بكمية",e.jsxs("span",{className:"font-semibold text-gray-900",children:[" ",Vs((Nt==null?void 0:Nt.quantity)||0)," "]}),"؟"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"سيتم عكس المخزون والرصيد حسب الحالة."})]}),e.jsxs("div",{className:"flex items-center justify-center gap-3 mt-2",children:[e.jsx(x,{variant:"outline",className:"h-8 min-w-[80px]",onClick:()=>re(!1),children:"إلغاء"}),e.jsx(x,{className:"h-8 min-w-[100px] bg-red-600 hover:bg-red-700 text-white",onClick:()=>{const d=Nt;re(!1),d&&br(d)},children:"تأكيد"})]})]})}),e.jsx(ya,{open:_t,onOpenChange:be,mode:"verify",title:"قفل إجمالي الأرباح",description:"أدخل الرقم السري الرئيسي لعرض إجمالي الأرباح",onSuccess:()=>{it(!1),be(!1)}}),e.jsx(ya,{open:Ke,onOpenChange:ct,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const d=a==null?void 0:a.uid;if(d){const C=await lo(d),O=(C==null?void 0:C.planType)??(C==null?void 0:C.plan)??null,G=typeof O=="string"?O.toLowerCase():null;if(O===za.ZERO||G==="zero"){T({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}at(!1),ct(!1),qt()}}),e.jsx(ya,{open:yt,onOpenChange:pt,mode:"verify",title:Rt,description:sa,onSuccess:()=>{const d=cs.current;cs.current=null,pt(!1),d&&d()}})]})}const Vs=l=>new Intl.NumberFormat("ar-EG").format(Number(l||0)),Vt=l=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(l||0))} ج.م`,Zl=l=>{try{const m=new Date(l);return isNaN(m.getTime())?new Date(`${l}T00:00:00`).toLocaleDateString("ar-EG"):m.toLocaleDateString("ar-EG")}catch{return l}},T0=({open:l,onOpenChange:m,userId:c,cashBalance:f,walletBalances:j,transactions:S})=>{const[u,K]=Ge.useState(0),[B,F]=Ge.useState(0),[D,T]=Ge.useState(0),[a,v]=Ge.useState(0),[P,R]=Ge.useState(f||0),[E,H]=Ge.useState(!1),[te,Q]=Ge.useState(null),{toast:A}=os(),{shopId:U}=On()||{},{profile:ae}=Cs(),[se,ge]=Ge.useState(!1),[fe,ne]=Ge.useState(""),[Ue,Ct]=Ge.useState(!1),[tt,We]=Ge.useState(!1),[Qe,Z]=Ge.useState(""),ye=()=>`cashBalance_${c||"default"}_${U||(ae==null?void 0:ae.shopId)||"main"}`,it=Oe=>`${new Intl.NumberFormat("ar-EG").format(Number(Oe||0))} جنيه`;Ge.useEffect(()=>{const Oe=async()=>{try{if(!c){K(0);return}const $e=new Date,at=$e.getFullYear(),X=String($e.getMonth()+1).padStart(2,"0"),mt=String($e.getDate()).padStart(2,"0"),Lt=`${at}-${X}-${mt}`;let Tt;try{const we=Ve(Ae(Y,"dailySales"),me("userId","==",c),...U?[me("shopId","==",U)]:[],me("date","==",Lt));Tt=await et(we)}catch{const we=Ve(Ae(Y,"users",c,"dailySales"),...U?[me("shopId","==",U)]:[],me("date","==",Lt));Tt=await et(we)}let M=0;Tt.forEach(we=>{const Me=we.data(),L=Number(Me.sellingPrice??0),rt=Number(Me.quantity??0);L>0&&rt>0&&(M+=L*rt)}),K(M)}catch($e){console.warn("فشل تحميل مبيعات الإكسسوار لليوم:",$e)}},Ke=async()=>{try{if(!c){setMaintenanceProfitToday(0);return}const $e=new Date,at=new Date($e.getFullYear(),$e.getMonth(),$e.getDate(),0,0,0,0),X=new Date($e.getFullYear(),$e.getMonth(),$e.getDate(),23,59,59,999);let mt;try{const Tt=Ve(Ae(Y,"maintenance_items"),me("userId","==",c),me("status","==","completed"));mt=await et(Tt)}catch{mt=await et(Ve(Ae(Y,"maintenance_items"),me("userId","==",c)))}let Lt=0;mt.forEach(Tt=>{var M,we;const Me=Tt.data();if((Me.status||"in_progress")!=="completed")return;const L=(we=(M=Me.completedAt)==null?void 0:M.toDate)==null?void 0:we.call(M);if(L&&L.getTime()>=at.getTime()&&L.getTime()<=X.getTime()){const rt=Number(Me.repairPrice||0);Number.isFinite(rt)&&rt>0&&(Lt+=rt)}}),T(Math.max(0,Lt))}catch($e){console.warn("فشل تحميل إجمالي فلوس الصيانة لليوم:",$e)}},ct=async()=>{var $e;try{if(!c){F(0);return}const at=await je.getUserData(c),X=new Date().toISOString().slice(0,10),mt=(at==null?void 0:at.dailyReceipts)||{};mt!=null&&mt.date&&String(mt.date).slice(0,10)===X?(F(Number(mt.accessory||0)),v(Number(mt.maintenance||0))):(F(0),v(0));try{const Lt=U||(ae==null?void 0:ae.shopId)||"main",Tt=await Ss(Le(Y,"dashboardData",Lt));if(Tt.exists()){const M=Number((($e=Tt.data())==null?void 0:$e.cashBalance)||0);R(M);try{localStorage.setItem(`cashBalance_${c}`,String(M)),localStorage.setItem(ye(),String(M))}catch{}}else R(Number((at==null?void 0:at.cashBalance)||f||0))}catch{R(Number((at==null?void 0:at.cashBalance)||f||0))}}catch{F(0),v(0)}};l&&(Oe(),Ke(),ct())},[l,c,S,f,U]),Ge.useEffect(()=>{const Oe=Ke=>{var ct;try{const $e=Number((ct=Ke==null?void 0:Ke.detail)==null?void 0:ct.value);Number.isFinite($e)&&R($e)}catch{}};return window.addEventListener("cashBalanceChanged",Oe),()=>window.removeEventListener("cashBalanceChanged",Oe)},[l]),Ge.useEffect(()=>{if(!l||!c)return;const Oe=U||(ae==null?void 0:ae.shopId)||"main";let Ke=null;try{Ke=Oa(Le(Y,"dashboardData",Oe),ct=>{var $e;try{if(ct.exists()){const at=Number((($e=ct.data())==null?void 0:$e.cashBalance)||0);R(at);try{localStorage.setItem(`cashBalance_${c}`,String(at)),localStorage.setItem(ye(),String(at))}catch{}}}catch{}})}catch{}return()=>{try{typeof Ke=="function"&&Ke()}catch{}}},[l,c,U]);const _t=Math.max(0,Number(u)-Number(B)),be=Math.max(0,Number(D)-Number(a)),ke=async Oe=>{if(!c)return;const Ke=new Date().toISOString().slice(0,10);try{const ct=Oe==="accessory"?_t:be;if(ct<=0){A({title:"لا يوجد مبلغ لتأكيد استلامه",variant:"default"});return}const $e=Math.max(0,Number(P)-ct);R($e),Oe==="accessory"?F(at=>at+ct):v(at=>at+ct),await je.updateUserData(c,{cashBalance:$e,dailyReceipts:{date:Ke,accessory:Oe==="accessory"?B+ct:B,maintenance:Oe==="maintenance"?a+ct:a}});try{const at=U||(ae==null?void 0:ae.shopId)||"main";await Ut(Le(Y,"dashboardData",at),{cashBalance:$e,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${c}`,String($e)),localStorage.setItem(ye(),String($e))}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:$e}}))}catch{}A({title:"تم الاستلام",description:`تم خصم ${ct.toFixed(2)} من الدرج وتصفير بند ${Oe==="accessory"?"الإكسسوار":"الصيانة"}`})}catch{A({title:"خطأ",description:"تعذر تنفيذ عملية تم الاستلام",variant:"destructive"})}},Dt=()=>{ne(""),Z(""),ge(!0)},Ot=()=>{if(!fe.trim()){A({title:"سبب الخصم مطلوب",variant:"destructive"});return}ge(!1),Ct(!0)},Gt=()=>{Ct(!1),We(!0)},Kt=async()=>{try{if(!c)return;const Oe=Math.max(0,Number(Qe||0));if(!Number.isFinite(Oe)||Oe<=0){A({title:"مبلغ غير صالح",description:"أدخل مبلغ خصم صحيح أكبر من الصفر",variant:"destructive"});return}const Ke=Math.max(0,Number(P)-Oe);R(Ke),await je.updateUserData(c,{cashBalance:Ke});try{const $e=U||(ae==null?void 0:ae.shopId)||"main";await Ut(Le(Y,"dashboardData",$e),{cashBalance:Ke,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${c}`,String(Ke))}catch{}try{localStorage.setItem(ye(),String(Ke))}catch{}const ct={title:"ايصال خصم من الفلوس النقديه",type:"cash_deduction",amount:Oe,status:"completed",createdAt:new Date,note:fe,cashierName:"الحساب الرئيسي"};try{await je.saveUserTransaction(c,ct)}catch{}A({title:"تم الخصم",description:`تم خصم ${Oe.toFixed(2)} من الدرج`}),We(!1),Z(""),ne("")}catch{A({title:"فشل الخصم",description:"تعذر تنفيذ عملية الخصم",variant:"destructive"})}};return e.jsx(Se,{open:l,onOpenChange:m,children:e.jsxs(Ie,{className:"sm:max-w-lg animate-in fade-in-90 zoom-in-95 slide-in-from-top-4",dir:"rtl",children:[e.jsx(Ce,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[e.jsx(Xt,{className:"h-5 w-5 text-emerald-600"}),"تفاصيل الفلوس النقدية"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between bg-amber-50 border border-amber-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 font-bold text-sm",children:[e.jsx(Xt,{className:"h-4 w-4"}),"مجموع الفلوس النقدية (الدرج)"]}),e.jsx("div",{className:"text-amber-700 font-extrabold text-sm",children:it(P)})]}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 font-bold text-sm",children:[e.jsx(yi,{className:"h-4 w-4"}),"فلوس الاكسسوار"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-blue-700 font-extrabold text-sm",children:it(_t)}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800",onClick:()=>{Q("accessory"),H(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-emerald-50 border border-emerald-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-800 font-bold text-sm",children:[e.jsx(oo,{className:"h-4 w-4"}),"فلوس الصيانة"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-emerald-700 font-extrabold text-sm",children:it(be)}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800",onClick:()=>{Q("maintenance"),H(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-red-800 font-bold text-sm",children:"خصم فلوس من الفلوس النقديه"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(x,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800",onClick:Dt,children:"خصم"})})]})]}),e.jsx(ya,{open:E,onOpenChange:H,mode:"verify",title:"تأكيد الرقم السري لعملية تم الاستلام",description:"يرجى إدخال الرقم السري الرئيسي لتأكيد استلام المبلغ",onSuccess:()=>{te&&(ke(te),Q(null)),H(!1)}}),e.jsx(Se,{open:se,onOpenChange:ge,children:e.jsxs(Ie,{className:"sm:max-w-sm",children:[e.jsx(Ce,{children:e.jsx(De,{children:"سبب الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"deduct-reason",children:"اكتب سبب الخصم"}),e.jsx(q,{id:"deduct-reason",value:fe,onChange:Oe=>ne(Oe.target.value),placeholder:"سبب الخصم"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(x,{variant:"outline",onClick:()=>ge(!1),children:"إلغاء"}),e.jsx(x,{onClick:Ot,className:"bg-red-600 hover:bg-red-700",children:"متابعة"})]})]})}),e.jsx(ya,{open:Ue,onOpenChange:Ct,mode:"verify",title:"تأكيد الرقم السري لعملية الخصم",description:"يرجى إدخال الرقم السري الرئيسي لمتابعة الخصم",onSuccess:Gt}),e.jsx(Se,{open:tt,onOpenChange:We,children:e.jsxs(Ie,{className:"sm:max-w-sm",children:[e.jsx(Ce,{children:e.jsx(De,{children:"مبلغ الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"deduct-amount",children:"أدخل مبلغ الخصم"}),e.jsx(q,{id:"deduct-amount",type:"number",value:Qe,onChange:Oe=>Z(Oe.target.value),placeholder:"0.00"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(x,{variant:"outline",onClick:()=>We(!1),children:"إلغاء"}),e.jsx(x,{onClick:Kt,className:"bg-red-600 hover:bg-red-700",children:"تأكيد الخصم"})]})]})})]})})};function Td({size:l=24,className:m,...c}){return e.jsxs("svg",{width:l,height:l,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:m,...c,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}var $d="AlertDialog",[$0]=hh($d,[vd]),Fs=vd(),Od=l=>{const{__scopeAlertDialog:m,...c}=l,f=Fs(m);return e.jsx(ch,{...f,...c,modal:!0})};Od.displayName=$d;var O0="AlertDialogTrigger",E0=i.forwardRef((l,m)=>{const{__scopeAlertDialog:c,...f}=l,j=Fs(c);return e.jsx(bh,{...j,...f,ref:m})});E0.displayName=O0;var P0="AlertDialogPortal",Ed=l=>{const{__scopeAlertDialog:m,...c}=l,f=Fs(m);return e.jsx(mh,{...f,...c})};Ed.displayName=P0;var F0="AlertDialogOverlay",Pd=i.forwardRef((l,m)=>{const{__scopeAlertDialog:c,...f}=l,j=Fs(c);return e.jsx(yh,{...j,...f,ref:m})});Pd.displayName=F0;var Br="AlertDialogContent",[L0,M0]=$0(Br),U0=gh("AlertDialogContent"),Fd=i.forwardRef((l,m)=>{const{__scopeAlertDialog:c,children:f,...j}=l,S=Fs(c),u=i.useRef(null),K=bd(m,u),B=i.useRef(null);return e.jsx(uh,{contentName:Br,titleName:Ld,docsSlug:"alert-dialog",children:e.jsx(L0,{scope:c,cancelRef:B,children:e.jsxs(xh,{role:"alertdialog",...S,...j,ref:K,onOpenAutoFocus:ph(j.onOpenAutoFocus,F=>{var D;F.preventDefault(),(D=B.current)==null||D.focus({preventScroll:!0})}),onPointerDownOutside:F=>F.preventDefault(),onInteractOutside:F=>F.preventDefault(),children:[e.jsx(U0,{children:f}),e.jsx(B0,{contentRef:u})]})})})});Fd.displayName=Br;var Ld="AlertDialogTitle",Md=i.forwardRef((l,m)=>{const{__scopeAlertDialog:c,...f}=l,j=Fs(c);return e.jsx(fh,{...j,...f,ref:m})});Md.displayName=Ld;var Ud="AlertDialogDescription",Wd=i.forwardRef((l,m)=>{const{__scopeAlertDialog:c,...f}=l,j=Fs(c);return e.jsx(vh,{...j,...f,ref:m})});Wd.displayName=Ud;var W0="AlertDialogAction",Bd=i.forwardRef((l,m)=>{const{__scopeAlertDialog:c,...f}=l,j=Fs(c);return e.jsx(wd,{...j,...f,ref:m})});Bd.displayName=W0;var Rd="AlertDialogCancel",zd=i.forwardRef((l,m)=>{const{__scopeAlertDialog:c,...f}=l,{cancelRef:j}=M0(Rd,c),S=Fs(c),u=bd(m,j);return e.jsx(wd,{...S,...f,ref:u})});zd.displayName=Rd;var B0=({contentRef:l})=>{const m=`\`${Br}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${Br}\` by passing a \`${Ud}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${Br}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return i.useEffect(()=>{var c;document.getElementById((c=l.current)==null?void 0:c.getAttribute("aria-describedby"))||console.warn(m)},[m,l]),null},R0=Od,z0=Ed,qd=Pd,Jd=Fd,Yd=Bd,Vd=zd,Gd=Md,Kd=Wd;const q0=R0,J0=z0,Hd=i.forwardRef(({className:l,...m},c)=>e.jsx(qd,{className:fr("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",l),...m,ref:c}));Hd.displayName=qd.displayName;const Qd=i.forwardRef(({className:l,...m},c)=>e.jsxs(J0,{children:[e.jsx(Hd,{}),e.jsx(Jd,{ref:c,className:fr("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",l),...m})]}));Qd.displayName=Jd.displayName;const Xd=({className:l,...m})=>e.jsx("div",{className:fr("flex flex-col space-y-2 text-center sm:text-left",l),...m});Xd.displayName="AlertDialogHeader";const Zd=i.forwardRef(({className:l,...m},c)=>e.jsx(Gd,{ref:c,className:fr("text-lg font-semibold",l),...m}));Zd.displayName=Gd.displayName;const em=i.forwardRef(({className:l,...m},c)=>e.jsx(Kd,{ref:c,className:fr("text-sm text-muted-foreground",l),...m}));em.displayName=Kd.displayName;const no=i.forwardRef(({className:l,...m},c)=>e.jsx(Yd,{ref:c,className:fr(yd(),l),...m}));no.displayName=Yd.displayName;const tm=i.forwardRef(({className:l,...m},c)=>e.jsx(Vd,{ref:c,className:fr(yd({variant:"outline"}),"mt-2 sm:mt-0",l),...m}));tm.displayName=Vd.displayName;const Pt=l=>{try{return l.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(l)}},od=l=>{try{return(l?new Date(l):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},$s="machine_daily_opening_values",Os="machine_daily_opening_snapshot";function Y0({open:l,onOpenChange:m}){const{toast:c}=os(),{shiftUser:f}=Ai(),{shopId:j,shopName:S}=On(),u=()=>{try{const $=Object.keys(localStorage||{}).filter(he=>he.startsWith("selectedShopId_"));for(const he of $){const Ne=localStorage.getItem(he);if(Ne)return Ne}return null}catch{return null}};i.useEffect(()=>{try{if(l){const $=document.body.style.overflow;document.body.setAttribute("data-prev-overflow",$),document.body.style.overflow="hidden"}else{const $=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=$,document.body.removeAttribute("data-prev-overflow")}}catch{}return()=>{try{const $=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=$,document.body.removeAttribute("data-prev-overflow")}catch{}}},[l]);const[K,B]=i.useState(""),[F,D]=i.useState(""),[T,a]=i.useState(""),[v,P]=i.useState(null),[R,E]=i.useState(null),[H,te]=i.useState(null),[Q,A]=i.useState(null),[U,ae]=i.useState(!1),[se,ge]=i.useState(!1),[fe,ne]=i.useState(""),[Ue,Ct]=i.useState(""),[tt,We]=i.useState(null),[Qe,Z]=i.useState([]),[ye,it]=i.useState([]),[_t,be]=i.useState(!1),[ke,Dt]=i.useState(""),[Ot,Gt]=i.useState(""),[Kt,Oe]=i.useState(!1),[Ke,ct]=i.useState(null),[$e,at]=i.useState([]),[X,mt]=i.useState(null),[Lt,Tt]=i.useState(""),[M,we]=i.useState(!1),[Me,L]=i.useState(!1);i.useEffect(()=>{if(l)try{const $=X?`${$s}_${X}`:$s,he=X?`${Os}_${X}`:Os,Ne=localStorage.getItem($);if(Ne){const Te=JSON.parse(Ne);typeof(Te==null?void 0:Te.openingBase)=="number"&&P(Te.openingBase),typeof(Te==null?void 0:Te.openingAir)=="number"&&E(Te.openingAir),typeof(Te==null?void 0:Te.drawerCash)=="number"&&te(Te.drawerCash)}else P(null),E(null),te(null);const ce=localStorage.getItem(he);if(ce){const Te=JSON.parse(ce);typeof(Te==null?void 0:Te.openingBase)=="number"&&typeof(Te==null?void 0:Te.openingAir)=="number"?A({openingBase:Te.openingBase,openingAir:Te.openingAir,drawerCash:Te.drawerCash||0}):A(null)}else A(null)}catch{}},[l,X]),i.useEffect(()=>{(async()=>{try{const $=j||u();if(!l||!$)return;const{getDocs:he}=await ht(async()=>{const{getDocs:Te}=await ft(()=>import("./index-C_crvORM.js").then(He=>He.c3),__vite__mapDeps([0,1]),import.meta.url).then(He=>He.c2);return{getDocs:Te}},xt([0,1]),import.meta.url),Ne=Ae(Y,"shops",$,"machines"),ce=(await he(Ve(Ne))).docs.map(Te=>({id:Te.id,name:String(Te.data().name||"ماكينة")}));at(ce);try{const Te=localStorage.getItem(`machineDaily_selected_${$}`);Te&&ce.some(He=>He.id===Te)?mt(Te):!X&&ce.length>0&&(mt(ce[0].id),localStorage.setItem(`machineDaily_selected_${$}`,ce[0].id))}catch{}}catch($){console.error("Load machines error:",$)}})()},[l,j]);const rt=i.useMemo(()=>(f==null?void 0:f.displayName)||(f==null?void 0:f.name)||(f==null?void 0:f.username)||void 0,[f]),aa=i.useMemo(()=>ye.reduce(($,he)=>$+(he.profit||0),0),[ye]),yt=i.useMemo(()=>ye.reduce(($,he)=>$+(he.wholesalePrice||0),0),[ye]),pt=async()=>{try{const $=j||u();if($&&X){const he=Ae(Y,"shops",$,"machines",X,"transfers"),Ne=await et(Ve(he));await Promise.all(Ne.docs.map(ce=>Ea(ce.ref)));try{localStorage.setItem(`machineDaily_transfers_${$}_${X}`,JSON.stringify([]))}catch{}}}catch{}it([]),c({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."})},Rt=async()=>{try{const $=j||u();if($&&X){const he=Ae(Y,"shops",$,"machines",X,"deliveries"),Ne=await et(Ve(he));await Promise.all(Ne.docs.map(ce=>Ea(ce.ref)));try{localStorage.setItem(`machineDaily_deliveries_${$}_${X}`,JSON.stringify([]))}catch{}}}catch{}Z([]),c({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."})},zt=$=>{Z(he=>he.filter(Ne=>Ne.id!==$)),c({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},sa=()=>{P(null),E(null),te(null),A(null),B(""),D(""),a("");try{const $=X?`${$s}_${X}`:$s,he=X?`${Os}_${X}`:Os;localStorage.removeItem($),localStorage.removeItem(he)}catch{}c({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},vs=async()=>{var $;const he=parseFloat(K||"0"),Ne=parseFloat(F||"0"),ce=parseFloat(T||"0");if(isNaN(he)||isNaN(Ne)||isNaN(ce)){c({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(he<0||Ne<0||ce<0){c({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}P(he),E(Ne),te(ce);try{const Te=X?`${$s}_${X}`:$s,He=X?`${Os}_${X}`:Os;localStorage.setItem(Te,JSON.stringify({openingBase:he,openingAir:Ne,drawerCash:ce})),localStorage.setItem(He,JSON.stringify({openingBase:he,openingAir:Ne,drawerCash:ce})),A({openingBase:he,openingAir:Ne,drawerCash:ce});const Xe=j||u();if(Xe&&X){const Be=Le(Y,"shops",Xe,"machines",X);await ns(Be,{name:(($=$e.find(xe=>xe.id===X))==null?void 0:$.name)||"ماكينة",openingBase:he,openingAir:Ne,drawerCash:ce,cashierName:rt,shopName:S||null,updatedAt:dt()},{merge:!0})}}catch{}c({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${Pt(he)}، الهواء: ${Pt(Ne)}، فلوس الدرج: ${Pt(ce)}`})},cs=()=>{if(v==null||R==null){c({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}ge(!0)},ua=()=>{const $=parseFloat(fe||"0"),he=parseFloat(Ue||"0");if(isNaN($)||isNaN(he)){c({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if($<0||he<0){c({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const Ne=(Q==null?void 0:Q.openingBase)??(v||0),ce=(Q==null?void 0:Q.openingAir)??(R||0),Te=Ne+ce,He=$+he-Te;We(He);const Xe={id:`${Date.now()}`,openingBase:Ne,openingAir:ce,deliveryBase:$,deliveryAir:he,netResult:He,createdAt:new Date().toISOString(),cashierName:rt,requiredDrawerNoProfit:He<0?Math.round(-He*100)/100:0};(async()=>{try{const Be=j||u();Be&&X&&(await ls(Ae(Y,"shops",Be,"machines",X,"deliveries"),{cashierName:rt,openingBase:Ne,openingAir:ce,deliveryBase:$,deliveryAir:he,netResult:He,createdAt:dt()}),await ns(Le(Y,"shops",Be,"machines",X),{lastDeliveryAt:dt(),updatedAt:dt()},{merge:!0}))}catch(Be){console.error("Persist delivery error:",Be)}})(),Z(Be=>[Xe,...Be]);try{const Be=j||u(),xe=Be&&X?`machineDaily_deliveries_${Be}_${X}`:`machineDaily_deliveries_${X}`,re=localStorage.getItem(xe),Nt=re?JSON.parse(re):[],la=[Xe,...Array.isArray(Nt)?Nt:[]];localStorage.setItem(xe,JSON.stringify(la))}catch{}c({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${Pt(He)}`})},na=()=>{const $=parseFloat(ke||"0"),he=parseFloat(Ot||"0");if(!Number.isFinite($)||!Number.isFinite(he)){c({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if($<0||he<0){c({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(v==null||R==null){c({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const Ne=Math.round((he-$)*100)/100;ct({wholesalePrice:$,retailPrice:he,profit:Ne}),Oe(!0)},Da=async $=>{if(!Ke)return;const he={id:`transfer_${Date.now()}`,wholesalePrice:Ke.wholesalePrice,retailPrice:Ke.retailPrice,profit:Ke.profit,createdAt:new Date().toISOString(),cashierName:rt,deductFrom:$},Ne=Ke.wholesalePrice,ce=v??0,Te=R??0,He=H??0;if(Ne>($==="base"?ce:Te)){c({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const Xe=$==="base"?Math.round((ce-Ne)*100)/100:ce,Be=$==="air"?Math.round((Te-Ne)*100)/100:Te,xe=Ke.retailPrice,re=Math.round((He+xe)*100)/100;P(Xe),E(Be),te(re);try{const Nt=X?`${$s}_${X}`:$s,la=X?`${Os}_${X}`:Os;localStorage.setItem(Nt,JSON.stringify({openingBase:Xe,openingAir:Be,drawerCash:re})),localStorage.setItem(la,JSON.stringify({openingBase:Xe,openingAir:Be,drawerCash:re}));const Aa=j||u();if(Aa&&X){const qa=Le(Y,"shops",Aa,"machines",X);await ns(qa,{openingBase:Xe,openingAir:Be,drawerCash:re,cashierName:rt,updatedAt:dt()},{merge:!0}),await ls(Ae(Y,"shops",Aa,"machines",X,"transfers"),{wholesalePrice:Ke.wholesalePrice,retailPrice:Ke.retailPrice,profit:Ke.profit,deductFrom:$,cashierName:rt,createdAt:dt()})}}catch{}it(Nt=>[he,...Nt]);try{const Nt=j||u(),la=Nt&&X?`machineDaily_transfers_${Nt}_${X}`:"machineDaily_transfers",Aa=localStorage.getItem(la),qa=Aa?JSON.parse(Aa):[],At=[he,...Array.isArray(qa)?qa:[]];localStorage.setItem(la,JSON.stringify(At))}catch{}be(!1),Dt(""),Gt(""),ct(null),Oe(!1),c({title:"تم تسجيل تحويل",description:`الربح الفوري: ${Pt(he.profit)} | خصم المخزون: -${Pt(Ne)} (${$==="base"?"الأساسي":"الهواء"}) | درج (المباع فقط): +${Pt(xe)}`})},ds=()=>{B(""),D(""),ge(!1),ne(""),Ct(""),We(null)};i.useEffect(()=>{const $=j||u();if(!(!l||!$||!X))try{const he=Ae(Y,"shops",$,"machines",X,"transfers"),Ne=Oa(he,async ce=>{const Te=[...ce.docs.map(He=>{var Xe,Be;const xe=He.data(),re=(Be=(Xe=xe==null?void 0:xe.createdAt)==null?void 0:Xe.toDate)!=null&&Be.call(Xe)?xe.createdAt.toDate():new Date,Nt=xe==null?void 0:xe.deductFrom;return{id:He.id,wholesalePrice:Number((xe==null?void 0:xe.wholesalePrice)||0),retailPrice:Number((xe==null?void 0:xe.retailPrice)||0),profit:Number((xe==null?void 0:xe.profit)??(Number((xe==null?void 0:xe.retailPrice)||0)-Number((xe==null?void 0:xe.wholesalePrice)||0)||0)),createdAt:re.toISOString(),cashierName:(xe==null?void 0:xe.cashierName)||void 0,deductFrom:Nt==="base"||Nt==="air"?Nt:void 0}})].sort((He,Xe)=>{const Be=new Date(He.createdAt).getTime();return new Date(Xe.createdAt).getTime()-Be});if(Te.length>0){it(Te),we(!0);try{localStorage.setItem(`machineDaily_transfers_${$}_${X}`,JSON.stringify(Te))}catch{}}else if(M){it([]);try{localStorage.setItem(`machineDaily_transfers_${$}_${X}`,JSON.stringify([]))}catch{}}});return()=>{try{Ne()}catch{}}}catch{}},[l,j,X,M]),i.useEffect(()=>{const $=j||u();if(!(!l||!$||!X))try{const he=Ae(Y,"shops",$,"machines",X,"deliveries"),Ne=Oa(he,ce=>{const Te=[...ce.docs.map(He=>{var Xe,Be;const xe=He.data(),re=(Be=(Xe=xe==null?void 0:xe.createdAt)==null?void 0:Xe.toDate)!=null&&Be.call(Xe)?xe.createdAt.toDate():new Date;return{id:He.id,openingBase:Number((xe==null?void 0:xe.openingBase)||0),openingAir:Number((xe==null?void 0:xe.openingAir)||0),deliveryBase:Number((xe==null?void 0:xe.deliveryBase)||0),deliveryAir:Number((xe==null?void 0:xe.deliveryAir)||0),netResult:typeof(xe==null?void 0:xe.netResult)=="number"?Number(xe.netResult):Math.round((Number((xe==null?void 0:xe.deliveryBase)||0)+Number((xe==null?void 0:xe.deliveryAir)||0)-(Number((xe==null?void 0:xe.openingBase)||0)+Number((xe==null?void 0:xe.openingAir)||0)))*100)/100,createdAt:re.toISOString(),cashierName:(xe==null?void 0:xe.cashierName)||void 0,requiredDrawerNoProfit:typeof(xe==null?void 0:xe.requiredDrawerNoProfit)=="number"?xe.requiredDrawerNoProfit:void 0}})].sort((He,Xe)=>new Date(Xe.createdAt).getTime()-new Date(He.createdAt).getTime());if(Te.length>0){Z(Te),L(!0);try{localStorage.setItem(`machineDaily_deliveries_${$}_${X}`,JSON.stringify(Te))}catch{}}else if(Me){Z([]);try{localStorage.setItem(`machineDaily_deliveries_${$}_${X}`,JSON.stringify([]))}catch{}}});return()=>{try{Ne()}catch{}}}catch{}},[l,j,X,Me]),i.useEffect(()=>{if(!(!l||!X))try{const $=j||u(),he=$?`machineDaily_deliveries_${$}_${X}`:`machineDaily_deliveries_${X}`,Ne=localStorage.getItem(he);if(Ne){const ce=JSON.parse(Ne);Array.isArray(ce)&&ce.length>0&&Z(ce)}(async()=>{try{const ce=j||u();if(!ce)return;const Te=Ae(Y,"shops",ce,"machines",X,"deliveries"),He=[...(await et(Ve(Te))).docs.map(Xe=>{var Be,xe;const re=Xe.data(),Nt=(xe=(Be=re==null?void 0:re.createdAt)==null?void 0:Be.toDate)!=null&&xe.call(Be)?re.createdAt.toDate():new Date;return{id:Xe.id,openingBase:Number((re==null?void 0:re.openingBase)||0),openingAir:Number((re==null?void 0:re.openingAir)||0),deliveryBase:Number((re==null?void 0:re.deliveryBase)||0),deliveryAir:Number((re==null?void 0:re.deliveryAir)||0),netResult:typeof(re==null?void 0:re.netResult)=="number"?Number(re.netResult):Math.round((Number((re==null?void 0:re.deliveryBase)||0)+Number((re==null?void 0:re.deliveryAir)||0)-(Number((re==null?void 0:re.openingBase)||0)+Number((re==null?void 0:re.openingAir)||0)))*100)/100,createdAt:Nt.toISOString(),cashierName:(re==null?void 0:re.cashierName)||void 0,requiredDrawerNoProfit:typeof(re==null?void 0:re.requiredDrawerNoProfit)=="number"?re.requiredDrawerNoProfit:void 0}})].sort((Xe,Be)=>new Date(Be.createdAt).getTime()-new Date(Xe.createdAt).getTime());if(He.length>0){Z(He);try{localStorage.setItem(`machineDaily_deliveries_${ce}_${X}`,JSON.stringify(He))}catch{}}}catch{}})()}catch{}},[l,j,X]),i.useEffect(()=>{if(!(!l||!X))try{const $=j||u(),he=$?`machineDaily_transfers_${$}_${X}`:`machineDaily_transfers_${X}`,Ne=localStorage.getItem(he);if(Ne){const ce=JSON.parse(Ne);Array.isArray(ce)&&ce.length>0&&it(ce)}(async()=>{try{const ce=j||u();if(!ce)return;const Te=Ae(Y,"shops",ce,"machines",X,"transfers"),He=[...(await et(Ve(Te))).docs.map(Xe=>{var Be,xe;const re=Xe.data(),Nt=(xe=(Be=re==null?void 0:re.createdAt)==null?void 0:Be.toDate)!=null&&xe.call(Be)?re.createdAt.toDate():new Date,la=re==null?void 0:re.deductFrom;return{id:Xe.id,wholesalePrice:Number((re==null?void 0:re.wholesalePrice)||0),retailPrice:Number((re==null?void 0:re.retailPrice)||0),profit:Number((re==null?void 0:re.profit)??(Number((re==null?void 0:re.retailPrice)||0)-Number((re==null?void 0:re.wholesalePrice)||0)||0)),createdAt:Nt.toISOString(),cashierName:(re==null?void 0:re.cashierName)||void 0,deductFrom:la==="base"||la==="air"?la:void 0}})].sort((Xe,Be)=>new Date(Be.createdAt).getTime()-new Date(Xe.createdAt).getTime());if(He.length>0){it(He);try{localStorage.setItem(`machineDaily_transfers_${ce}_${X}`,JSON.stringify(He))}catch{}}}catch{}})()}catch{}},[l,j,X]);const ha=$=>{$||ds(),m($)};return e.jsxs(Se,{open:l,onOpenChange:ha,children:[e.jsxs(Ie,{className:"w-screen h-[100vh] overflow-hidden rounded-none p-0 flex flex-col dark:bg-[#121212]",children:[e.jsxs(Ce,{className:"sticky top-0 bg-white dark:bg-[#0F0F0F] z-20 border-b border-gray-200 dark:border-[#333] px-4 py-3",children:[e.jsx(De,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Td,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(va,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"px-4 py-3 overflow-y-auto flex-1 grid grid-cols-1 gap-6",children:[e.jsxs(Ft,{children:[e.jsx(ma,{className:"pb-2",children:e.jsxs(Pa,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"اختيار ماكينة"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(x,{variant:"destructive",onClick:async()=>{try{if(!j||!X)return;const $=Le(Y,"shops",j,"machines",X);try{const Ne=await et(Ae(Y,"shops",j,"machines",X,"transfers"));await Promise.all(Ne.docs.map(ce=>Ea(ce.ref)))}catch{}try{const Ne=await et(Ae(Y,"shops",j,"machines",X,"deliveries"));await Promise.all(Ne.docs.map(ce=>Ea(ce.ref)))}catch{}await Ea($),at(Ne=>Ne.filter(ce=>ce.id!==X));const he=$e.find(Ne=>Ne.id!==X);mt(he?he.id:null);try{const Ne=`${$s}_${X}`,ce=`${Os}_${X}`;localStorage.removeItem(Ne),localStorage.removeItem(ce)}catch{}c({title:"تم حذف الماكينة",description:"تمت الإزالة نهائيًا."})}catch{c({title:"فشل الحذف",description:"تعذر حذف الماكينة.",variant:"destructive"})}},disabled:!X,title:"حذف الماكينة",children:e.jsx(da,{className:"h-4 w-4"})})})]})}),e.jsx(Wt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الماكينة الحالية"}),e.jsxs(Gs,{value:X??"",onValueChange:$=>{mt($);try{const he=j||u();he&&localStorage.setItem(`machineDaily_selected_${he}`,$)}catch{}},children:[e.jsx(Ks,{className:"text-right",children:e.jsx(Hs,{placeholder:"اختر ماكينة"})}),e.jsx(Qs,{children:$e.map($=>e.jsx(ps,{value:$.id,children:$.name},$.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"إنشاء ماكينة جديدة"}),e.jsx(q,{value:Lt,onChange:$=>Tt($.target.value),placeholder:"اسم الماكينة",className:"text-right"})]}),e.jsx("div",{className:"flex justify-end md:justify-start",children:e.jsx(x,{onClick:async()=>{try{if(!j){c({title:"لا يوجد محل",description:"يرجى التأكد من تحميل بيانات المحل.",variant:"destructive"});return}const $=(Lt||"").trim();if(!$){c({title:"اسم الماكينة مطلوب",description:"أدخل اسم للماكينة الجديدة.",variant:"destructive"});return}const he=await ls(Ae(Y,"shops",j,"machines"),{name:$,shopId:j,createdAt:dt(),updatedAt:dt(),isActive:!0}),Ne={id:he.id,name:$};at(ce=>[Ne,...ce]),mt(he.id),Tt(""),c({title:"تم إنشاء ماكينة",description:`تمت إضافة ${$}`})}catch($){console.error("Create machine error:",$),c({title:"خطأ في الإنشاء",description:"تعذر إنشاء الماكينة.",variant:"destructive"})}},className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})})]})]})})]}),e.jsxs(Ft,{children:[e.jsx(ma,{className:"pb-2",children:e.jsxs(Pa,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>ae($=>!$),className:"flex items-center gap-1",children:e.jsx(Si,{className:`h-4 w-4 transition-transform ${U?"rotate-180":""}`})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(x,{variant:"outline",onClick:()=>be(!0),disabled:v==null||R==null,className:"border-violet-300 text-violet-700",children:"تحويل"})}),v!=null&&R!=null&&e.jsxs(ta,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",Pt(v)," | هواء ",Pt(R)," | درج ",Pt(H??0)]})]}),e.jsxs(Wt,{className:`space-y-4 ${U?"":"hidden"}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:K,onChange:$=>B($.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:F,onChange:$=>D($.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:T,onChange:$=>a($.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(x,{variant:"outline",className:"mr-2",onClick:sa,children:"تصفير"}),e.jsx(x,{onClick:vs,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),e.jsxs(Ft,{children:[e.jsx(ma,{className:"pb-2",children:e.jsxs(Pa,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات تحويل"}),e.jsxs(ta,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",Pt(aa)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:pt,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(Di,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Wt,{className:"space-y-3",children:ye.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-3 max-h-52 overflow-y-auto pr-1",children:ye.map($=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر الجملة"}),e.jsx("p",{className:"text-sm",children:Pt($.wholesalePrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر التجزئة"}),e.jsx("p",{className:"text-sm",children:Pt($.retailPrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الربح الفوري"}),e.jsx("p",{className:"text-sm text-green-700",children:Pt($.profit)}),$.deductFrom&&e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"text-[11px] bg-violet-100 text-violet-700 border border-violet-200 rounded px-2 py-0.5",children:["الخصم من: ",$.deductFrom==="base"?"الأساسي":"الهواء"]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(Zs,{className:"h-3 w-3"}),e.jsx("span",{children:od($.createdAt)}),$.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(so,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",$.cashierName]})]})]})]})]},$.id))})})]}),e.jsxs(Ft,{children:[e.jsx(ma,{className:"pb-2",children:e.jsx(Pa,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(Wt,{className:"space-y-4",children:se?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:fe,onChange:$=>ne($.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Ue,onChange:$=>Ct($.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>ge(!1),children:"إلغاء"}),e.jsx(x,{onClick:ua,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),tt!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(ta,{className:tt>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",Pt(tt)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(ta,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",Pt(parseFloat(fe||"0")+parseFloat(Ue||"0"))]}),e.jsxs(ta,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",Pt(yt)]})]})]})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(x,{variant:"outline",onClick:cs,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs(Ft,{children:[e.jsx(ma,{className:"pb-2",children:e.jsxs(Pa,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:Rt,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(Di,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Wt,{className:"space-y-3",children:Qe.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:Qe.map($=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Pt($.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Pt($.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Pt($.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Pt($.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>zt($.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(da,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${$.netResult>=0?"text-green-700":"text-red-700"}`,children:Pt($.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",Pt($.deliveryBase+$.deliveryAir)]}),typeof $.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",Pt($.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(Zs,{className:"h-3 w-3"}),e.jsx("span",{children:od($.createdAt)}),$.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(so,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",$.cashierName]})]})]})]})]},$.id))})})]})]}),e.jsxs(ot,{className:"sticky bottom-0 bg-white dark:bg-[#0F0F0F] z-20 border-t border-gray-200 dark:border-[#333] px-4 py-3 flex items-center justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>ha(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(Ps,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(Se,{open:_t,onOpenChange:be,children:e.jsxs(Ie,{className:"sm:max-w-sm",children:[e.jsx(Ce,{children:e.jsx(De,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:ke,onChange:$=>Dt($.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Ot,onChange:$=>Gt($.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(ta,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",Pt(parseFloat(Ot||"0")-parseFloat(ke||"0")||0)]})})]}),e.jsxs(ot,{className:"flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>be(!1),children:"إلغاء"}),e.jsx(x,{onClick:na,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(q0,{open:Kt,onOpenChange:Oe,children:e.jsxs(Qd,{children:[e.jsxs(Xd,{children:[e.jsx(Zd,{children:"اختيار مصدر الخصم"}),e.jsx(em,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(tm,{onClick:()=>Oe(!1),children:"رجوع"}),e.jsx(no,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>Da("base"),children:"خصم من الأساسي"}),e.jsx(no,{className:"bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>Da("air"),children:"خصم من الهواء"})]})]})})]})}function V0(l,m=300){const[c,f]=Ge.useState(l);return Ge.useEffect(()=>{const j=setTimeout(()=>f(l),m);return()=>clearTimeout(j)},[l,m]),c}const G0=({userId:l,transactions:m})=>{const[c,f]=i.useState(!1),[j,S]=i.useState(!1),[u,K]=i.useState(!1),[B,F]=i.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:D}=Cs();i.useEffect(()=>{l&&c&&u&&T()},[l,c,u]);const T=async()=>{if(l)try{if(Array.isArray(m)&&m.length>0){const H=new Date,te=H.getMonth(),Q=H.getFullYear(),A=ja.filterVisibleTransactions(m,"monthly",l);let U=0,ae=0;A.forEach(se=>{const ge=new Date(se.createdAt),fe=String(se.status||"confirmed").toLowerCase();if(ge.getMonth()!==te||ge.getFullYear()!==Q||fe!=="completed"&&fe!=="confirmed")return;const ne=(se.type||se.txnType||"").toLowerCase(),Ue={type:ne==="withdrawal"?"withdraw":ne,amount:Number(se.amount||0),commission:se.commission};Ue.type==="withdraw"?U+=Xs.calculateProfitFromTransaction(Ue):(Ue.type==="send"||Ue.type==="receive"||Ue.type==="transfer")&&(ae+=Xs.calculateProfitFromTransaction(Ue))}),F({monthlyWithdrawalProfit:Math.round(U*100)/100,monthlyTransferProfit:Math.round(ae*100)/100,lastUpdated:new Date});return}const E=Xs.getWithdrawTransferProfits(l);F({monthlyWithdrawalProfit:E.monthlyWithdrawProfit||0,monthlyTransferProfit:E.monthlyTransferProfit||0,lastUpdated:new Date})}catch(E){console.error("Error loading profit data:",E)}},a=E=>`${E.toFixed(2)} ج.م`,v=async()=>{try{const E=(D==null?void 0:D.subscription)||null,H=(E==null?void 0:E.planType)??(E==null?void 0:E.plan)??null,te=typeof H=="string"?H.toLowerCase():null;if(H===za.ZERO||te==="zero"||te==="0"||H===0)return!0}catch{}try{if(l){const E=await lo(l),H=(E==null?void 0:E.planType)??(E==null?void 0:E.plan)??null,te=typeof H=="string"?H.toLowerCase():null;if(H===za.ZERO||te==="zero"||te==="0"||H===0)return!0}}catch{}return!1},P=async()=>{try{if(await v()){Yc({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}S(!0)},R=async()=>{try{if(await v()){Yc({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),S(!1);return}}catch{}K(!0),f(!0),S(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:P,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح الشهرية",children:e.jsx(Bt,{className:"h-1.5 w-1.5"})}),e.jsx(Se,{open:c,onOpenChange:f,children:e.jsxs(Ie,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(Ce,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:e.jsxs(De,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(Zs,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"شهري"]})}),e.jsx("div",{className:"py-0 sm:py-3",children:e.jsxs("div",{className:"rounded-xl border border-purple-300 bg-white overflow-hidden",children:[e.jsx("div",{className:"p-2 sm:p-3 bg-red-50 border-b border-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Tn,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800 text-xs",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-2 py-0.5 rounded",children:a(B.monthlyWithdrawalProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-blue-50 border-b border-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(oo,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-blue-900 bg-white px-2 py-0.5 rounded",children:a(B.monthlyTransferProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Xt,{className:"h-3 w-3 text-purple-600"}),e.jsx("span",{className:"font-medium text-purple-800 text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"font-bold text-sm text-purple-900 bg-white px-2 py-0.5 rounded",children:a(B.monthlyWithdrawalProfit+B.monthlyTransferProfit)})]})})]})}),!u&&e.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>S(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:e.jsx(Bt,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:e.jsx(x,{onClick:()=>f(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),e.jsx(ya,{open:j,onOpenChange:S,onSuccess:R,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},K0=l=>e.jsx(G0,{...l});function H0({open:l,onOpenChange:m,onSuccess:c,userId:f}){const[j,S]=i.useState(""),[u,K]=i.useState(""),[B,F]=i.useState(!1),[D,T]=i.useState(!1),[a,v]=i.useState(""),[P,R]=i.useState(!1),[E,H]=i.useState(!1),{toast:te}=os();i.useEffect(()=>{let U=!0;return(async()=>{const ae=await Ia.hasMasterPin(f);U&&H(ae)})(),()=>{U=!1}},[f,l]);const Q=()=>{S(""),K(""),v(""),F(!1),T(!1),m(!1)},A=async U=>{U.preventDefault(),v(""),R(!0);try{if(E){if(!await Ia.verifyMasterPin(j,f)){v("الرقم السري غير صحيح"),R(!1);return}}else{if(j.length<4){v("يجب أن يكون الرقم السري 4 أرقام على الأقل"),R(!1);return}if(j!==u){v("الرقم السري غير متطابق"),R(!1);return}if(!await Ia.createMasterPin(j,f)){v("تعذر إنشاء الرقم السري الرئيسي"),R(!1);return}}te({title:"نجح العملية",description:E?"تم التحقق من الرقم السري الرئيسي بنجاح":"تم إنشاء الرقم السري الرئيسي بنجاح"}),c(),Q()}catch{v("حدث خطأ أثناء معالجة الرقم السري")}finally{R(!1)}};return e.jsx(Se,{open:l,onOpenChange:m,children:e.jsxs(Ie,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Ce,{children:e.jsxs(De,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(gr,{className:"h-5 w-5 text-green-600"}),E?"أدخل الرقم السري الرئيسي":"إنشاء الرقم السري الرئيسي"]})}),e.jsxs("form",{onSubmit:A,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:E?"أدخل الرقم السري الرئيسي لعرض بيانات الأرباح":"قم بإنشاء الرقم السري الرئيسي لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"pin",children:E?"الرقم السري الرئيسي":"الرقم السري الرئيسي الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"pin",type:B?"text":"password",value:j,onChange:U=>S(U.target.value),placeholder:E?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>F(!B),children:B?e.jsx(ba,{className:"h-4 w-4"}):e.jsx(Bt,{className:"h-4 w-4"})})]})]}),!E&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:D?"text":"password",value:u,onChange:U=>K(U.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>T(!D),children:D?e.jsx(ba,{className:"h-4 w-4"}):e.jsx(Bt,{className:"h-4 w-4"})})]})]}),a&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(vr,{className:"h-4 w-4"}),a]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:P,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(gr,{className:"h-4 w-4 mr-2"}),P?"جاري المعالجة...":E?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(x,{type:"button",variant:"outline",onClick:Q,disabled:P,children:"إلغاء"})]})]})]})})}const Q0=({userId:l,transactions:m})=>{const[c,f]=i.useState(!1),[j,S]=i.useState(!1),[u,K]=i.useState(!1),[B,F]=i.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});i.useEffect(()=>{l&&c&&u&&D()},[l,c,u,m]);const D=async()=>{if(l)try{if(Array.isArray(m)&&m.length>0){const R=new Date,E=ja.filterVisibleTransactions(m,"daily",l);let H=0,te=0;E.forEach(Q=>{const A=new Date(Q.createdAt),U=String(Q.status||"confirmed").toLowerCase();if(A.toDateString()!==R.toDateString())return;const ae=(Q.type||Q.txnType||"").toLowerCase(),se=String(Q.title||"");if(ae==="cash_addition"||se.includes("إيصال إضافة نقدية"))return;const ge={type:ae==="withdrawal"?"withdraw":ae,amount:Number(Q.amount||0),commission:Q.commission};ge.type==="withdraw"?H+=Xs.calculateProfitFromTransaction(ge):(ge.type==="send"||ge.type==="receive"||ge.type==="transfer")&&(te+=Xs.calculateProfitFromTransaction(ge))}),F({dailyWithdrawalProfit:Math.round(H*100)/100,dailyTransferProfit:Math.round(te*100)/100,lastUpdated:new Date});try{Xs.updateProfitsFromTransactions(m,l)}catch{}return}const P=Xs.getWithdrawTransferProfits(l);F({dailyWithdrawalProfit:P.dailyWithdrawProfit||0,dailyTransferProfit:P.dailyTransferProfit||0,lastUpdated:new Date})}catch(P){console.error("Error loading profit data:",P)}},T=P=>`${P.toFixed(2)} ج.م`,a=()=>{Xs.hasProfitPin(l),S(!0)},v=()=>{K(!0),f(!0),S(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:a,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح اليومية",children:e.jsx(Bt,{className:"h-1.5 w-1.5"})}),e.jsx(Se,{open:c,onOpenChange:f,children:e.jsxs(Ie,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-blue-50 sm:to-white sm:border-2 sm:border-blue-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(Ce,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-blue-200",children:e.jsxs(De,{className:"text-xs font-bold text-blue-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-sm sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(Xt,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),"يومي"]})}),e.jsx("div",{className:"py-0 sm:py-3",children:e.jsxs("div",{className:"rounded-xl border border-blue-300 bg-white overflow-hidden",children:[e.jsx("div",{className:"p-2 sm:p-3 bg-red-50 border-b border-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Tn,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800 text-xs",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-2 py-0.5 rounded",children:T(B.dailyWithdrawalProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-green-50 border-b border-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(oo,{className:"h-3 w-3 text-green-600"}),e.jsx("span",{className:"font-medium text-green-800 text-xs",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-green-900 bg-white px-2 py-0.5 rounded",children:T(B.dailyTransferProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-blue-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Xt,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"font-bold text-sm text-blue-900 bg-white px-2 py-0.5 rounded",children:T(B.dailyWithdrawalProfit+B.dailyTransferProfit)})]})})]})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-blue-200",children:e.jsx(x,{onClick:()=>f(!1),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-blue-600 sm:to-blue-700 sm:hover:from-blue-700 sm:hover:to-blue-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300 sm:text-xs",children:"إغلاق"})})]})}),e.jsx(H0,{open:j,onOpenChange:S,onSuccess:v,userId:l})]})},X0=l=>e.jsx(Q0,{...l}),Z0=({open:l,onOpenChange:m})=>{var c;const{shiftUser:f,isShiftActive:j,shiftStartAt:S,setShiftUser:u,startShift:K,endShift:B}=Ai(),{userSubscription:F,user:D,signIn:T,profile:a}=Cs(),{toast:v}=os(),[P,R]=i.useState((f==null?void 0:f.name)||""),[E,H]=i.useState((f==null?void 0:f.username)||""),[te,Q]=i.useState(""),[A,U]=i.useState(!1),[ae,se]=i.useState(null),[ge,fe]=i.useState(""),[ne,Ue]=i.useState(""),[Ct,tt]=i.useState(!1),[We,Qe]=i.useState(null),[Z,ye]=i.useState(""),[it,_t]=i.useState(""),[be,ke]=i.useState(!1),[Dt,Ot]=i.useState(!1),[Gt,Kt]=i.useState({totalTransfers:0,totalWithdrawals:0}),[Oe,Ke]=i.useState(null),[ct,$e]=i.useState(""),[at,X]=i.useState(""),[mt,Lt]=i.useState(0),[Tt,M]=i.useState({}),[we,Me]=i.useState(0),[L,rt]=i.useState(0),[aa,yt]=i.useState({}),[pt,Rt]=i.useState(""),[zt,sa]=i.useState(!1),vs=z=>{const pe={"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9","۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9","٫":".","،":".","٬":"."," ":""};return z.split("").map(jt=>pe[jt]??jt).join("")},cs=()=>`cashierUsers_${(D==null?void 0:D.uid)||"default"}`,[ua,na]=i.useState(()=>{try{let z=localStorage.getItem(cs());if(!z){const pe=localStorage.getItem("cashierUsers");pe&&(z=pe)}return z?JSON.parse(z):[]}catch{return[]}});i.useEffect(()=>{(async()=>{try{if(!(D!=null&&D.uid))return;const z=Le(Y,"profiles",D.uid,"cashierUsers","list"),pe=await Ss(z);if(pe.exists()){const jt=pe.data(),vt=Array.isArray(jt==null?void 0:jt.users)?jt.users:[];vt&&vt.length>0&&na(vt)}}catch{}})()},[D==null?void 0:D.uid]),i.useEffect(()=>{if(!(D!=null&&D.uid))return;const z=Le(Y,"profiles",D.uid,"cashierUsers","list"),pe=Oa(z,jt=>{try{if(jt.exists()){const vt=jt.data(),ka=Array.isArray(vt==null?void 0:vt.users)?vt.users:[];if(ka&&ka.length>0)na(ka);else try{const wa=localStorage.getItem(cs()),qt=wa?JSON.parse(wa):[];na(qt)}catch{na([])}}}catch{}},jt=>{console.warn("cashierUsers realtime subscription error:",jt)});return()=>pe()},[D==null?void 0:D.uid]);const Da=(c=F==null?void 0:F.subscription)==null?void 0:c.planType,ds=Da==="yearly"?2:Da==="lifetime"?4:Number.POSITIVE_INFINITY;i.useEffect(()=>{try{localStorage.setItem(cs(),JSON.stringify(ua));try{localStorage.removeItem("cashierUsers")}catch{}}catch{}(async()=>{try{if(!(D!=null&&D.uid))return;const z=Le(Y,"profiles",D.uid,"cashierUsers","list");await ns(z,{users:ua},{merge:!0})}catch{}})()},[ua]);const[ha,$]=i.useState(!1),[he,Ne]=i.useState(""),[ce,Te]=i.useState(null),[He,Xe]=i.useState([]),[Be,xe]=i.useState(!1),[re,Nt]=i.useState(null),[la,Aa]=i.useState(!1),[qa,At]=i.useState(!1),as=z=>{const pe=(f==null?void 0:f.username)===z;let jt=!1;try{jt=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(pe&&!(pe&&!j&&(pt==="الأدمن الرئيسي"||jt))){v({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const vt=`هل أنت متأكد من حذف المستخدم ${z}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(vt)&&(na(ka=>ka.filter(wa=>wa.username!==z)),pe&&u(null),v({title:"تم حذف المستخدم",description:z}))},ms=()=>{if(!P.trim()||!E.trim()||!te.trim())return;if(ua.length>=ds){v({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(ds)?ds:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const z={name:P.trim(),username:E.trim(),password:te.trim()};na(pe=>[z,...pe]),R(""),H(""),Q("")},ys=()=>{U(!0),se(null),Qe(null),ye(""),_t("")},Rr=async()=>{try{let z=[];try{D!=null&&D.uid&&(z=await je.getUserTransactions(D.uid))}catch{}if(!z||z.length===0)try{const nt=await _d({merchantUserId:D==null?void 0:D.uid,limit:200});z=(nt==null?void 0:nt.transactions)||[]}catch{}const pe=S?new Date(S):null,jt=new Date,vt=nt=>{const bt=nt.type,us=nt.txnType;return bt==="withdraw"||bt==="withdrawal"||bt==="receive"||us==="receive"},ka=nt=>{const bt=nt.type,us=nt.txnType;return bt==="send"||bt==="transfer"||us==="send"},wa=nt=>{if(!nt)return null;if(nt instanceof Date)return nt;try{const bt=new Date(nt);return Number.isNaN(bt.getTime())?null:bt}catch{return null}},qt=nt=>{const bt=wa(nt.createdAt||nt.created_at||nt.timestamp);return!bt||pe&&bt<pe?!1:bt<=jt},Ls=nt=>nt==="completed"||nt==="confirmed",Ms=z.filter(nt=>Ls(nt.status)&&qt(nt)),tr=Ms.filter(nt=>vt(nt)).reduce((nt,bt)=>{const us=bt.withdrawnAmount??bt.receivedAmount??bt.amount??0;return nt+(Number(us)||0)},0);return{totalTransfers:Ms.filter(nt=>ka(nt)).reduce((nt,bt)=>{const us=bt.sentAmount??bt.transferredAmount??bt.amount??0;return nt+(Number(us)||0)},0),totalWithdrawals:tr}}catch{return{totalTransfers:0,totalWithdrawals:0}}};i.useEffect(()=>{if(Dt){try{const z=localStorage.getItem("shiftInitialReceivedDrawerFunds");z!==null&&X(z)}catch{}try{const z=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(z!==null){const pe=parseFloat(z);Lt(Number.isFinite(pe)?pe:0)}}catch{}}},[Dt]),i.useEffect(()=>{A&&(async()=>{try{const z=await Rr();Kt(z)}catch{}})()},[A]),i.useEffect(()=>{!l&&!Be||(async()=>{try{const z=((D!=null&&D.uid?await je.getUserTransactions(D.uid):[])||[]).filter(pe=>(pe==null?void 0:pe.type)==="report"||((pe==null?void 0:pe.title)||"").includes("إيصال تسليم وردية"));z.sort((pe,jt)=>{const vt=new Date(pe.createdAt||0).getTime();return new Date(jt.createdAt||0).getTime()-vt}),Xe(z)}catch{Xe([])}})()},[l,Dt,Be,D==null?void 0:D.uid]);const ki=async(z,pe,jt)=>{try{let vt=0,ka=0;try{const qt=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");vt=Number.isFinite(qt)?qt:0}catch{}try{const qt=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");ka=Number.isFinite(qt)?qt:0}catch{}const wa={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(f==null?void 0:f.username)||"cashier",receiverPhone:pt||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(f==null?void 0:f.name)||(f==null?void 0:f.username)||null,deficit:pe,deficitAmount:pe?jt:0,shiftStartAt:S,receivedDrawerFunds:vt,receivedWalletBalancesTotal:ka,receivedWalletBalances:Tt,deliveredDrawerFunds:we||0,deliveredWalletBalancesTotal:L||0,deliveredWalletBalances:aa,shiftProfit:Math.round(((we||0)+(L||0)-(vt+ka))*100)/100};D!=null&&D.uid&&await je.saveUserTransaction(D.uid,wa),Xe(qt=>[wa,...qt||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(Se,{open:l,onOpenChange:m,children:e.jsxs(Ie,{className:"sm:max-w-md",children:[e.jsx(Ce,{children:e.jsx(De,{children:j?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),j?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[f==null?void 0:f.name," (",f==null?void 0:f.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),ua.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:ua.map((z,pe)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:z.name}),e.jsx("div",{className:"text-xs text-gray-500",children:z.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(x,{size:"sm",className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>{Te(z),$(!0)},children:"دخول"}),e.jsx(x,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>as(z.username),children:"حذف"})]})]},pe))})]})]}),e.jsx(ot,{className:"flex flex-wrap gap-2 justify-between",children:j?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(x,{className:"w-full sm:w-auto",variant:"destructive",onClick:ys,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(x,{className:"w-full sm:w-auto bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>At(!0),children:"إضافة مستخدم جديد"}),e.jsx(x,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>xe(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(Se,{open:qa,onOpenChange:At,children:e.jsxs(Ie,{className:"sm:max-w-md",children:[e.jsx(Ce,{children:e.jsx(De,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(ee,{className:"mb-1 block",children:"الاسم"}),e.jsx(q,{value:P,onChange:z=>R(z.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(ee,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(q,{value:E,onChange:z=>H(z.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(ee,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(q,{type:"password",autoComplete:"new-password",value:te,onChange:z=>Q(z.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(ot,{className:"flex gap-2 justify-between",children:[e.jsx(x,{variant:"secondary",onClick:()=>{At(!1)},children:"إلغاء"}),e.jsx(x,{onClick:()=>{!P.trim()||!E.trim()||!te.trim()||(ms(),At(!1))},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"حفظ المستخدم"})]})]})}),e.jsx(Se,{open:Be,onOpenChange:xe,children:e.jsxs(Ie,{className:"sm:max-w-lg",children:[e.jsx(Ce,{children:e.jsx(De,{children:"إيصالات التسليم"})}),He.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:He.map(z=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{Nt(z),Aa(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(z.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",z.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",z.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",z.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",z.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",z.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",z.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",z.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",z.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",z.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(z.shiftProfit??(z.deliveredDrawerFunds??0)+(z.deliveredWalletBalancesTotal??0)-(z.receivedDrawerFunds??0)-(z.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",z.shiftProfit??(z.deliveredDrawerFunds??0)+(z.deliveredWalletBalancesTotal??0)-(z.receivedDrawerFunds??0)-(z.receivedWalletBalancesTotal??0)]})]}),z.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",z.deficitAmount??0]})]},z.id))}),e.jsx(ot,{className:"flex gap-2 justify-between",children:e.jsx(x,{variant:"secondary",onClick:()=>xe(!1),children:"إغلاق"})})]})}),e.jsx(Se,{open:la,onOpenChange:Aa,children:e.jsxs(Ie,{className:"sm:max-w-md",children:[e.jsx(Ce,{children:e.jsx(De,{children:"إيصال تسليم وردية"})}),re?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(re.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",re.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",re.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",re.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",re.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",re.deliveredWalletBalancesTotal??0]})]})]}),re.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",re.deficitAmount??0]})]}),re.receivedWalletBalances&&Object.keys(re.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(re.receivedWalletBalances).map(([z,pe])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:z}),e.jsx("span",{className:"font-semibold",children:pe})]},z))})]}),re.deliveredWalletBalances&&Object.keys(re.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(re.deliveredWalletBalances).map(([z,pe])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:z}),e.jsx("span",{className:"font-semibold",children:pe})]},z))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(ot,{className:"flex gap-2 justify-between",children:e.jsx(x,{variant:"secondary",onClick:()=>Aa(!1),children:"إغلاق"})})]})}),e.jsx(Se,{open:ha,onOpenChange:$,children:e.jsxs(Ie,{className:"sm:max-w-md",children:[e.jsx(Ce,{children:e.jsx(De,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:ce?`${ce.name} (${ce.username})`:""}),e.jsx(q,{type:"password",autoComplete:"off",value:he,onChange:z=>Ne(z.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(ot,{className:"flex gap-2 justify-between",children:[e.jsx(x,{variant:"secondary",onClick:()=>{Ne(""),Te(null),$(!1)},children:"إلغاء"}),e.jsx(x,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{if(ce){if(he.trim()!==ce.password){v({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}u({name:ce.name,username:ce.username}),Ne(""),$(!1),m(!1),K(),sa(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(Se,{open:zt,onOpenChange:sa,children:e.jsxs(Ie,{className:"sm:max-w-md",children:[e.jsx(Ce,{children:e.jsx(De,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(ee,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(q,{type:"text",inputMode:"decimal",value:at,onChange:z=>X(vs(z.target.value)),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(ee,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(q,{type:"text",inputMode:"decimal",value:Number.isFinite(mt)?mt:0,onChange:z=>{const pe=parseFloat(vs(z.target.value));Lt(Number.isFinite(pe)?pe:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(ot,{className:"flex gap-2 justify-between",children:e.jsx(x,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{const z=parseFloat(at),pe=mt,jt=Number.isFinite(z)&&z>=0,vt=Number.isFinite(pe)&&pe>=0;if(!jt||!vt){v({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(z)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(pe))}catch{}v({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),sa(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(Se,{open:A,onOpenChange:z=>{z&&U(!0)},children:e.jsxs(Ie,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(Ce,{children:e.jsx(De,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:ae==="toUser"?"default":"secondary",onClick:()=>se("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(x,{variant:ae==="toAdmin"?"default":"secondary",onClick:()=>se("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),ae==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[ua.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:ua.map((z,pe)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(We==null?void 0:We.username)===z.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>Qe(z),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:z.name}),e.jsx("div",{className:"text-xs text-gray-500",children:z.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},pe))})]}),e.jsxs("div",{children:[e.jsx(ee,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(q,{type:"password",autoComplete:"off",value:Z,onChange:z=>ye(z.target.value),placeholder:"أدخل كلمة السر"})]}),it&&e.jsx("div",{className:"text-xs text-red-600",children:it})]}),ae==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(q,{type:"password",autoComplete:"off",value:ge,onChange:z=>fe(z.target.value),placeholder:"كلمة المرور"}),ne&&e.jsx("div",{className:"text-xs text-red-600",children:ne})]})]}),e.jsx(ot,{className:"flex gap-2 justify-between",children:e.jsx(x,{disabled:be||!ae,onClick:async()=>{if(ae){ke(!0);try{const z=Gt;if(Rr().then(Kt).catch(()=>{}),ae==="toUser"){if(!We){_t("يرجى اختيار المستخدم أولاً"),ke(!1);return}if(Z.trim()!==We.password){_t("كلمة السر غير صحيحة"),ke(!1);return}B(),u({name:We.name,username:We.username}),K(),Rt(`${We.name} (${We.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}U(!1),se(null),Qe(null),ye(""),_t(""),m(!1),Kt(z),Ke(null),$e(""),Ot(!0)}else if(ae==="toAdmin"){Ue("");const pe=(D==null?void 0:D.email)||"";if(!pe){Ue("لا يوجد بريد للمستخدم الرئيسي للتحقق"),ke(!1);return}const{error:jt}=await T(pe,ge);if(jt){Ue("كلمة المرور غير صحيحة"),ke(!1);return}B(),u(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}fe(""),U(!1),m(!1),Rt("الأدمن الرئيسي"),Kt(z),Ke(null),$e(""),Ot(!0)}}catch{_t("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{ke(!1)}}},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"تأكيد التسليم"})})]})}),e.jsx(Se,{open:Dt,onOpenChange:Ot,children:e.jsxs(Ie,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(Ce,{children:e.jsx(De,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:pt})]}),S&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(S).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(ee,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(q,{type:"number",value:at,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(ee,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(q,{type:"number",value:mt,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(ee,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(q,{type:"text",inputMode:"decimal",value:we,onChange:z=>{const pe=parseFloat(vs(z.target.value));Me(Number.isFinite(pe)?pe:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(ee,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(q,{type:"text",inputMode:"decimal",value:L,onChange:z=>{const pe=parseFloat(vs(z.target.value));rt(Number.isFinite(pe)?pe:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(we??0)+(L??0)-((parseFloat(at||"0")||0)+(mt??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((we??0)+(L??0)-((parseFloat(at||"0")||0)+(mt??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"}),e.jsx("div",{className:"mt-2 grid grid-cols-1 gap-2",children:e.jsxs("div",{className:"rounded border p-2 bg-gray-50",children:[e.jsx("div",{className:"text-xs text-gray-700",children:"مطلوب من الدرج (بدون أرباح)"}),e.jsx("div",{className:"text-sm font-semibold text-gray-900",children:Math.round(((we??0)-(parseFloat(at||"0")||0))*100)/100})]})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:Oe==="no"?"default":"secondary",onClick:()=>Ke("no"),children:"لا"}),e.jsx(x,{variant:Oe==="yes"?"default":"secondary",onClick:()=>Ke("yes"),children:"نعم"})]}),Oe==="yes"&&e.jsxs("div",{children:[e.jsx(ee,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(q,{type:"number",value:ct,onChange:z=>$e(z.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(ot,{className:"flex gap-2 justify-between",children:e.jsx(x,{onClick:()=>{const z=Oe==="yes",pe=parseFloat(ct)||0;(async()=>await ki(Gt,z,pe))(),v({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),Ot(!1)},className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:"تأكيد وحفظ الإيصال"})})]})})]})},ex=({open:l,onOpenChange:m})=>{const{shiftUser:c,endShift:f,setShiftUser:j}=Ai(),[S,u]=i.useState(""),[K,B]=i.useState(""),[F,D]=i.useState([]),{user:T}=Cs();i.useEffect(()=>{(async()=>{try{if(T!=null&&T.uid){const v=Le(Y,"profiles",T.uid,"cashierUsers","list"),P=await Ss(v);if(P.exists()){const R=P.data(),E=Array.isArray(R==null?void 0:R.users)?R.users:[];if(E&&E.length>0){D(E);return}}}}catch{}try{const v=`cashierUsers_${(T==null?void 0:T.uid)||"default"}`;let P=localStorage.getItem(v);if(!P){const R=localStorage.getItem("cashierUsers");R&&(P=R)}D(P?JSON.parse(P):[])}catch{D([])}})()},[l,T==null?void 0:T.uid]),i.useEffect(()=>{if(!l||!(T!=null&&T.uid))return;const v=Le(Y,"profiles",T.uid,"cashierUsers","list"),P=Oa(v,R=>{if(R.exists()){const E=R.data(),H=Array.isArray(E==null?void 0:E.users)?E.users:[];if(H&&H.length>0)D(H);else try{const te=`cashierUsers_${(T==null?void 0:T.uid)||"default"}`;let Q=localStorage.getItem(te);if(!Q){const A=localStorage.getItem("cashierUsers");A&&(Q=A)}D(Q?JSON.parse(Q):[])}catch{D([])}}},R=>{console.warn("ShiftProfileDialog cashierUsers snapshot error:",R)});return()=>P()},[l,T==null?void 0:T.uid]);const a=async()=>{if(B(""),!c)return;const v=F.find(P=>P.username===c.username);if(!v){B("لا يوجد مستخدم مطابق لهذه الوردية");return}if(S.trim()!==v.password){B("الرقم السري غير صحيح");return}f(),j(null),u(""),m(!1)};return e.jsx(Se,{open:l,onOpenChange:v=>{u(""),B(""),m(v)},children:e.jsxs(Ie,{className:"sm:max-w-md",children:[e.jsx(Ce,{children:e.jsx(De,{children:"بروفيل الوردية"})}),c?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:c.name}),e.jsx("div",{className:"text-xs text-gray-600",children:c.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx(q,{type:"password",value:S,onChange:v=>u(v.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),K&&e.jsx("div",{className:"text-red-600 text-xs",children:K})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(ot,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>m(!1),children:"إغلاق"}),e.jsx(x,{onClick:a,disabled:!c,children:"تسليم الوردية"})]})]})})},tx=({open:l,onOpenChange:m})=>e.jsx(Se,{open:l,onOpenChange:m,children:e.jsxs(Ie,{className:"sm:max-w-lg rounded-2xl",children:[e.jsxs(Ce,{children:[e.jsxs(De,{className:"text-right flex items-center gap-2 justify-end",children:[e.jsx(Rl,{className:"w-5 h-5"}),"سجل التغييرات الأخيرة"]}),e.jsx(va,{className:"text-right",children:"هذه أبرز التحسينات التي تمت مؤخرًا في الواجهة."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ud,{className:"w-5 h-5 text-amber-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحسين نافذة تعديل المديونية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"استبدال نافذة الإدخال القديمة (prompt) بحوار أنيق لإدخال المبلغ مع تأكيد."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Ch,{className:"w-5 h-5 text-violet-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحديث شاشة التحميل"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:'تغيير النص إلى "صلي علي النبي" مع خط عربي جميل ونبض لطيف.'})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Rl,{className:"w-5 h-5 text-green-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"بطاقات الأرباح وعدد العمليات"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"إضافة بطاقات عرض أرباح الفترة الحالية وعدد العمليات في تفاصيل المحفظة."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Rl,{className:"w-5 h-5 text-blue-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"إصلاح تمرير نافذة اليومية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"منع تمرير الصفحة الخلفية عند فتح نافذة اليومية لراحة الاستخدام."})]})]})]}),e.jsx("div",{className:"flex justify-end gap-2 mt-6",children:e.jsx(x,{variant:"secondary",onClick:()=>m(!1),children:"إغلاق"})})]})});class Wr{static async processTransfer(m){const{amount:c,currentCashBalance:f,currentWalletBalances:j,wallets:S,selectedWalletId:u}=m;if(c<=0)return{success:!1,newCashBalance:f,newWalletBalances:j,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(u&&!m.skipRemoteLimitsCheck)try{const D=await is.canPerformOperation(u,c,"transfer");if(!D.canPerform)return{success:!1,newCashBalance:f,newWalletBalances:j,message:D.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(D){return console.error("خطأ في التحقق من حدود التحويل:",D),{success:!1,newCashBalance:f,newWalletBalances:j,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(c<=0)return{success:!1,newCashBalance:f,newWalletBalances:j,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(u){const D=Math.max(j[u]||0,0);if(D<c){const T=S.find(a=>a.id===u);return{success:!1,newCashBalance:f,newWalletBalances:j,message:`رصيد غير كافي في المحفظة${T?` ${T.name}`:""}. المتاح: ${D} جنيه، المطلوب: ${c} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const D=Wr.calculateTotalWalletBalance(j);if(D<c)return{success:!1,newCashBalance:f,newWalletBalances:j,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${D} جنيه، المبلغ المطلوب: ${c} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const K={...j};if(u){const D=K[u]||0;K[u]=D-c}else{let D=c;for(const T of S){if(D<=0)break;const a=Math.max(K[T.id]||0,0),v=Math.min(a,D);v>0&&(K[T.id]=(K[T.id]||0)-v,D-=v)}}const B=f+c;let F="تم التحويل بنجاح";if(u){const D=K[u]||0;D<0&&(F=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${u} أصبح ${D} جنيه.`)}return{success:!0,newCashBalance:B,newWalletBalances:K,message:F}}static processDeposit(m){const{amount:c,currentCashBalance:f,currentWalletBalances:j,wallets:S}=m;if(c<=0)return{success:!1,newCashBalance:f,newWalletBalances:j,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const u=this.calculateTotalWalletBalance(j);if(u<c)return{success:!1,newCashBalance:f,newWalletBalances:j,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${u} جنيه، المبلغ المطلوب: ${c} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const K=f+c,B={...j};let F=c;const D=S.find(a=>a.isDefault);if(D&&B[D.id]>=F)B[D.id]-=F,F=0;else for(const a of S){if(F<=0)break;const v=B[a.id]||0;if(v>0){const P=Math.min(v,F);B[a.id]=v-P,F-=P}}const T=F>0?`تم الإيداع جزئياً. تم إيداع ${c-F} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${c} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:K,newWalletBalances:B,message:T}}static async processWithdraw(m){const{amount:c,currentCashBalance:f,currentWalletBalances:j,wallets:S,selectedWalletId:u}=m;if(c<=0)return{success:!1,newCashBalance:f,newWalletBalances:j,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(u&&!m.skipRemoteLimitsCheck)try{const D=await is.canPerformOperation(u,c,"withdraw");if(!D.canPerform)return{success:!1,newCashBalance:f,newWalletBalances:j,message:D.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(D){return console.error("خطأ في التحقق من حدود السحب:",D),{success:!1,newCashBalance:f,newWalletBalances:j,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(f<c)return{success:!1,newCashBalance:f,newWalletBalances:j,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${f} جنيه، المبلغ المطلوب: ${c} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const K=f-c,B={...j},F=u?S.find(D=>D.id===u):S.find(D=>D.isDefault)||S[0];if(F){const D=B[F.id]||0;B[F.id]=D+c}else return{success:!1,newCashBalance:f,newWalletBalances:j,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};return{success:!0,newCashBalance:K,newWalletBalances:B,message:`تم السحب بنجاح. تم إضافة ${c} جنيه إلى محفظة ${(F==null?void 0:F.name)||""}`}}static validateOperation(m,c){return m<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!c||c.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(m){return Object.values(m).reduce((c,f)=>c+Math.max(f,0),0)}static deductFromWalletsAddToCash(m,c,f,j){return this.processTransfer({amount:m,currentCashBalance:c,currentWalletBalances:f,wallets:j})}static deductFromWalletsAddToCashDeposit(m,c,f,j){return this.processDeposit({amount:m,currentCashBalance:c,currentWalletBalances:f,wallets:j})}static deductFromCashAddToWallets(m,c,f,j){return this.processWithdraw({amount:m,currentCashBalance:c,currentWalletBalances:f,wallets:j})}static applyTransactionResult(m,c,f){m.success&&(c(m.newCashBalance),f(m.newWalletBalances))}static validateTransaction(m,c,f,j){if(m<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(c==="transfer"){const S=this.calculateTotalWalletBalance(j);if(S<m)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${S} جنيه) غير كافي للمبلغ المطلوب (${m} جنيه)`}}else if(c==="withdraw"){if(f<m)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${f} جنيه) غير كافي للمبلغ المطلوب (${m} جنيه)`}}else if(c==="deposit"){const S=this.calculateTotalWalletBalance(j);if(S<m)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${S} جنيه) غير كافي للمبلغ المطلوب (${m} جنيه)`}}return{isValid:!0}}static getDeductionPreview(m,c,f){const j=[];let S=m;for(const u of f){if(S<=0)break;const K=c[u.id]||0,B=Math.min(Math.max(K,0),S);B>0&&(j.push({walletId:u.id,walletName:u.name,currentBalance:K,deductedAmount:B,newBalance:K-B}),S-=B)}return j}}let vi=null;function ax(){const l=window;if(!vi){const m=l.AudioContext||l.webkitAudioContext;vi=new m}return vi.state==="suspended"&&vi.resume(),vi}function sx(l,m,c){const f=c/1e3,j=Math.floor(l.sampleRate*f),S=l.createBuffer(1,j,l.sampleRate),u=S.getChannelData(0);for(let D=0;D<j;D++)u[D]=(Math.random()*2-1)*.6;const K=l.createBufferSource();K.buffer=S;const B=l.createBiquadFilter();B.type="highpass",B.frequency.value=1500,B.Q.value=.7;const F=l.createGain();F.gain.setValueAtTime(1e-4,m),F.gain.exponentialRampToValueAtTime(.4,m+.015),F.gain.exponentialRampToValueAtTime(1e-4,m+f),K.connect(B),B.connect(F),F.connect(l.destination),K.start(m),K.stop(m+f+.01)}function rx(l,m,c,f,j,S="triangle"){const u=l.createOscillator(),K=l.createGain();u.type=S;const B=j/1e3;u.frequency.setValueAtTime(c,m),u.frequency.linearRampToValueAtTime(f,m+B),K.gain.setValueAtTime(1e-4,m),K.gain.exponentialRampToValueAtTime(.25,m+.02),K.gain.exponentialRampToValueAtTime(1e-4,m+B),u.connect(K),K.connect(l.destination),u.start(m),u.stop(m+B+.02)}function ix(){try{const l=ax(),m=l.currentTime;sx(l,m,90),rx(l,m+.12,1900,1100,180,"sawtooth")}catch{}}function nx(l){if(!l)return!1;const m=l.replace(/[^0-9٠-٩]/g,"").replace(/[٠-٩]/g,c=>"0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(c)]);return/^(010|011|012|015)[0-9]{8}$/.test(m)}function lx({userId:l}){const[m,c]=Ge.useState(null),[f,j]=Ge.useState("");return null}const ip=()=>{var l,m,c,f,j,S;console.log("🔥 UserDashboardPage component is loading...");const{toast:u}=os(),K=i.useRef(null),[B,F]=i.useState(0),D=async()=>{var t,s,r;const n="alkaptin678678@gmail.com",o=(s=(t=Ur.currentUser)==null?void 0:t.email)==null?void 0:s.toLowerCase();if(!o||o!==n){u({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}if(!sn||!rn||!nn){u({title:"بيانات ناقصة",description:"أدخل رقم الموبايل، الشركة والمبلغ",variant:"destructive"});return}try{fc(!0);const h=await((r=Ur.currentUser)==null?void 0:r.getIdToken()),p=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...h?{Authorization:`Bearer ${h}`}:{}},body:JSON.stringify({phone:sn,countryCode:"EG",operator:rn,amount:Number(nn),useLocalAmount:!0})}),g=await p.json().catch(()=>({}));p.ok&&g!=null&&g.success?(u({title:"تم الشحن",description:(g==null?void 0:g.message)||"تم تنفيذ عملية الشحن بنجاح"}),Il(!1),hc(""),xc(""),pc("")):u({title:"فشل الشحن",description:(g==null?void 0:g.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(h){console.error("Topup request error:",h),u({title:"خطأ غير متوقع",description:"تعذّر تنفيذ عملية الشحن. حاول لاحقاً.",variant:"destructive"})}finally{fc(!1)}},{signOut:T,user:a,profile:v}=Cs(),P=((a==null?void 0:a.email)||"").toLowerCase()==="vodafonecash00@gmail.com",R=cd(),E=dd(),H=Zu(),{isShiftActive:te,shiftUser:Q}=Ai(),{shopId:A,shopName:U}=On(),ae=md(),se=eh();(()=>{try{return!!window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:"}catch{return!1}})();const[ge,fe]=i.useState(!1),[ne,Ue]=i.useState(!1),[Ct,tt]=i.useState(!1),[We,Qe]=i.useState(!1),[Z,ye]=i.useState([]),[it,_t]=i.useState(""),[be,ke]=i.useState(""),[Dt,Ot]=i.useState(""),[Gt,Kt]=i.useState(""),[Oe,Ke]=i.useState(!1),[ct,$e]=i.useState(!1),[at,X]=i.useState(null),[mt,Lt]=i.useState(""),[Tt,M]=i.useState(""),[we,Me]=i.useState(!1),[L,rt]=i.useState("");i.useEffect(()=>{const t=H==null?void 0:H.shopId;if(t&&a!=null&&a.uid)try{const s=`selectedShopId_${a.uid}`;localStorage.setItem(s,String(t)),window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}},[H==null?void 0:H.shopId,a==null?void 0:a.uid]);const[aa,yt]=i.useState([]),[pt,Rt]=i.useState(()=>{try{return localStorage.getItem("cashySelectedDevice")||null}catch{return null}});i.useEffect(()=>{(()=>{if(bi.isNativePlatform()){const t=()=>{var s,r;if((r=(s=window.cordova)==null?void 0:s.plugins)!=null&&r.permissions){const n=window.cordova.plugins.permissions,o=[n.RECEIVE_SMS];n.checkPermission(o,h=>{h.hasPermission?console.log("SMS permissions already granted"):n.requestPermissions(o,p=>{p.hasPermission?console.log("SMS permissions granted"):(console.warn("SMS permissions denied"),u({title:"تنبيه",description:"يرجى منح صلاحيات الرسائل لعمل التطبيق بشكل صحيح",variant:"destructive"}))},()=>{console.error("Error requesting SMS permissions")})},null)}else console.warn("Cordova permissions plugin not found yet, retrying..."),setTimeout(t,1e3)};document.addEventListener("deviceready",t,!1),t()}})()},[]),i.useEffect(()=>{(async()=>{if(L)try{await oi.set({key:"selected_wallet_id",value:L}),console.log("📱 Synced selected_wallet_id to Native:",L)}catch(t){console.error("Failed to sync wallet to native:",t)}else await oi.remove({key:"selected_wallet_id"})})()},[L]),i.useEffect(()=>{(async()=>{if(A)try{await oi.set({key:"shopId",value:A}),console.log("📱 Synced shopId to Native:",A)}catch(t){console.error("Failed to sync shopId to native:",t)}})()},[A]);const zt=t=>!!(t&&aa.some(s=>s.id===t));async function sa(){const t=window.electronAPI,s=pt||"";if(!t||typeof t.sendUssd!="function")return null;if(!s)return u({title:"الجهاز غير محدد",description:"اتصل بالموبايل أولاً ثم اختر الجهاز من القائمة",variant:"destructive"}),null;if(zt(s))return s;try{const h=aa.find(p=>p&&p.id&&!String(p.id).includes(":"));if(h&&h.id)return Rt(h.id),h.id}catch{}const r=s.includes(":")?s.split(":").slice(0,2).join(":"):"";if(r&&typeof t.connectWifi=="function"){try{await t.connectWifi(r)}catch{}if(await new Promise(h=>setTimeout(h,250)),zt(s))return s}const n=s.split(":")[0],o=aa.find(h=>(h.id.startsWith(n)||h.id.includes(n))&&h.id.includes(":"));if(o!=null&&o.id){const h=o.id.split(":").slice(0,2).join(":");if(!zt(o.id)&&typeof t.connectWifi=="function"){try{await t.connectWifi(h)}catch{}await new Promise(p=>setTimeout(p,250))}if(zt(o.id))return Rt(o.id),o.id}return u({title:"الجهاز غير متصل",description:"فعّل Wireless debugging أو استخدم اتصال Wi‑Fi ثم أعد المحاولة",variant:"destructive"}),null}i.useEffect(()=>{const t=window.electronAPI;t&&typeof t.onAdbDevices=="function"&&t.onAdbDevices(s=>{var r;const n=Array.isArray(s)?s:[];yt(n);const o=(()=>{try{return localStorage.getItem("cashySelectedDevice")||""}catch{return""}})();o&&n.some(h=>h.id===o)?Rt(o):(r=n[0])!=null&&r.id?Rt(h=>h||n[0].id):Rt(null)})},[]);function vs(t,s){try{const r=_a==null?void 0:_a(),n=(r==null?void 0:r.phone)||"";if(!n){u({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"});return}dh(n,t,s),u({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),sr(!1),Dr(!1)}catch(r){const n=(r==null?void 0:r.message)||"تعذر إرسال الكود — تحقق من البيانات";throw u({title:"فشل الإرسال",description:n,variant:"destructive"}),r}}const cs=async()=>{var t;if(!xs||!xs.receiver||!xs.amount){u({title:"بيانات غير مكتملة",description:"تأكد من إدخال رقم المستقبل والمبلغ قبل الإرسال",variant:"destructive"});return}const s=String(xs.receiver),r=Math.round(Number(xs.amount));rr(!0);try{if((t=bi)!=null&&t.isNativePlatform&&bi.getPlatform()==="android"){const o=_a==null?void 0:_a(),h=(o==null?void 0:o.phone)||"";if(!h){u({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),rr(!1);return}const p=qc(h,s,r);if(!p){u({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),rr(!1);return}lh(p),u({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),sr(!1),Dr(!1);return}const n=window.electronAPI;if(n&&typeof n.sendUssd=="function"&&pt){const o=_a==null?void 0:_a(),h=(o==null?void 0:o.phone)||"";if(!h){u({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),rr(!1);return}const p=await sa();if(!p){rr(!1);return}const g=qc(h,s,r);if(!g){u({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),rr(!1);return}try{const w=typeof n.pickSimAutomatically=="function"?await n.pickSimAutomatically(p,h):{deviceId:p,slot:0},y=`${w.deviceId}:sim${w.slot}`;Dm(y),await n.sendUssd(y,g)}catch{try{await n.sendUssd(p,g)}catch(w){const y=p.includes(":")?p.split(":").slice(0,2).join(":"):"";if(y&&typeof n.connectWifi=="function")await n.connectWifi(y),await n.sendUssd(p,g);else throw w}}u({title:"تم إرسال كود التحويل",description:"تم التنفيذ بنجاح"}),sr(!1),Dr(!0)}else vs(s,r)}catch(n){const o=n&&n.message?n.message:"حدث خطأ غير متوقع أثناء الإرسال";u({title:"خطأ أثناء الإرسال",description:`الجهاز: ${Oo||pt||"غير معروف"} — ${o}`,variant:"destructive"})}finally{rr(!1)}},ua=async(t,s)=>{const r=window.electronAPI;try{if(r&&typeof r.enterPin=="function"&&t){await r.enterPin(t,s),Dr(!1);return}const n=String((v==null?void 0:v.bridgeLink)||"").trim(),o=String((v==null?void 0:v.bridgeDeviceId)||"").trim()||void 0;if(!n){u({title:"الرابط غير مُعدّ",description:"احفظ رابط الجسر أولاً",variant:"destructive"});return}const h=String((xs==null?void 0:xs.receiver)||G||"").replace(/\D/g,""),p=Math.max(1,Math.round(Number((xs==null?void 0:xs.amount)||de||0))||0),g=String(s||"").replace(/\D/g,""),w=(y=>{let N=(y||"").trim();return N=N.replace(/\/+$/,""),/^https?:\/\//i.test(N)||(N=`https://${N}`),N})(n);Dr(!1)}catch(n){const o=(n==null?void 0:n.message)||"حدث خطأ أثناء إدخال الرقم السري";u({title:"فشل الإدخال",description:o,variant:"destructive"})}};console.log("🔥 UserDashboardPage - user:",a?"exists":"null");const[na,Da]=i.useState(!0),[ds,ha]=i.useState(!0),[$,he]=i.useState(!1),[Ne,ce]=i.useState(!1),[Te,He]=i.useState(""),[Xe,Be]=i.useState(""),[xe,re]=i.useState(""),[Nt,la]=i.useState([]),[Aa,qa]=i.useState(!1),[At,as]=i.useState(null),[ms,ys]=i.useState(""),[Rr,ki]=i.useState(!1),[z,pe]=i.useState(!1),[jt,vt]=i.useState(!1),[ka,wa]=i.useState(!1),[qt,Ls]=i.useState(""),[Ms,tr]=i.useState(""),[nt,bt]=i.useState([]),[us,yr]=i.useState(!1),[br,Pn]=i.useState(0),[Fn,_i]=i.useState(!1),[Fa,zr]=i.useState(null),[uo,d]=i.useState(!1),[C,O]=i.useState(""),[G,V]=i.useState(""),[de,_e]=i.useState(""),[Ee,Pe]=i.useState(""),[Re,qe]=i.useState(""),[ze,oa]=i.useState(!1),[hs,Ja]=i.useState(""),[ar,La]=i.useState(""),[Ya,As]=i.useState(""),[wr,Nr]=i.useState(""),[Va,jr]=i.useState(null),[Ti,$i]=i.useState(!1),[Ln,ho]=i.useState(!1),[am,Oi]=i.useState(!1),[sm,Mn]=i.useState(!1),[xo,Un]=i.useState(null),[xa,Wn]=i.useState(""),[pa,Bn]=i.useState(""),[po,rm]=i.useState(""),[im,Ei]=i.useState(!1),[ox,cx]=i.useState(null),[Us,go]=i.useState(null),[nm,Rn]=i.useState(!1);i.useEffect(()=>{(async()=>{try{const t=a!=null&&a.uid?`withdrawSenderNameInputEnabled_${a==null?void 0:a.uid}`:"withdrawSenderNameInputEnabled";let s=null;try{s=localStorage.getItem(t)??localStorage.getItem("withdrawSenderNameInputEnabled")}catch{}if(a!=null&&a.uid)try{const r=await Er(()=>je.getUserData(a.uid)),n=r==null?void 0:r.withdrawSenderNameInputEnabled;if(typeof n=="boolean"){Rn(n);try{localStorage.setItem(t,n?"true":"false")}catch{}return}}catch{}Rn(s==="true")}catch{Rn(!1)}})()},[a==null?void 0:a.uid]);const Pi=t=>{const s="٠١٢٣٤٥٦٧٨٩",r="۰۱۲۳۴۵۶۷۸۹";return(t||"").split("").map(n=>{const o=s.indexOf(n);if(o>-1)return String(o);const h=r.indexOf(n);return h>-1?String(h):n}).join("")},[wt,zn]=i.useState(()=>{try{const t=localStorage.getItem("commissionMode")||localStorage.getItem("commissionMode_default");return t?t==="add":!0}catch{return!0}}),[le,fo]=i.useState("transfer"),[Ze,bs]=i.useState([]),[ks,qn]=i.useState("all"),[St,ga]=i.useState([]),Jn=nd({enabled:!!(a!=null&&a.uid),queryKey:["recentTransactions",a==null?void 0:a.uid,A||"main"],queryFn:async()=>{const{collection:t,query:s,where:r,orderBy:n,limit:o,getDocs:h}=await ht(async()=>{const{collection:W,query:ie,where:J,orderBy:ve,limit:Ye,getDocs:Xa}=await ft(()=>import("./index-C_crvORM.js").then(fa=>fa.c3),__vite__mapDeps([0,1]),import.meta.url).then(fa=>fa.c2);return{collection:W,query:ie,where:J,orderBy:ve,limit:Ye,getDocs:Xa}},xt([0,1]),import.meta.url),{db:p}=await ht(async()=>{const{db:W}=await ft(()=>import("./index-C_crvORM.js").then(ie=>ie.c3),__vite__mapDeps([0,1]),import.meta.url).then(ie=>ie.c3);return{db:W}},xt([0,1]),import.meta.url),g=s(t(p,"userTransactions"),r("userId","==",String((a==null?void 0:a.uid)||"")),n("createdAt","desc"),o(100)),w=(await h(g)).docs.map(W=>{var ie;const J=W.data(),ve=(ie=J.createdAt)!=null&&ie.toDate?J.createdAt.toDate():new Date(J.createdAt),Ye=String(J.transactionType||J.txnType||J.type||"").toLowerCase(),Xa=Ye==="withdraw"||Ye==="receive"?"withdraw":"send",fa=J.status==="confirmed"?"completed":J.status||"completed",zs=J.senderMsisdn||J.senderPhone||"",Yt=J.receiverMsisdn||J.receiverPhone||"",Za=Number(J.amount??J.transferredAmount??J.withdrawnAmount??0);return{id:W.id,...J,type:Xa,status:fa,senderPhone:zs,receiverPhone:Yt,amount:Za,createdAt:ve}}).filter(W=>!((W==null?void 0:W.type)==="report"||String((W==null?void 0:W.title)||"").includes("إيصال تسليم وردية"))),y=new Set((Yr||[]).map(W=>String(W.id||W.originalTransactionId||""))),N=w.filter(W=>!y.has(String(W.id||""))),_=W=>{var ie;return String(W.transactionId||W.id||W.reference||((ie=W.receipt)==null?void 0:ie.reference)||`${new Date(W.createdAt).getTime()}`)},I=new Set,k=[];for(const W of N){const ie=_(W);I.has(ie)||(I.add(ie),k.push(W))}return k},staleTime:6e4,gcTime:3e5,refetchOnWindowFocus:!1,refetchOnReconnect:!0});i.useEffect(()=>{const t=Jn.data;t&&Array.isArray(t)&&bs(t)},[Jn.data]),i.useEffect(()=>{try{if(localStorage.setItem("commissionMode",wt?"add":"deduct"),a!=null&&a.uid){const t=`commissionMode_${a.uid}`;localStorage.setItem(t,wt?"add":"deduct")}}catch{}},[wt,a==null?void 0:a.uid]),i.useEffect(()=>{try{const t=new Set((Ze||[]).filter(r=>String((r==null?void 0:r.status)||"")==="completed"&&(r==null?void 0:r.linkedDebtId)).map(r=>String(r.linkedDebtId)));if(t.size===0)return;const s=St.map(r=>{if(t.has(String(r.id))){const n=Number(r.amount||0),o=Number(r.paidAmount||0);if(r.status!=="paid"||o<n)return{...r,status:"paid",paidAmount:n}}return r});if(s.some((r,n)=>r!==St[n])){ga(s),(async()=>await Qa(s))();try{a!=null&&a.uid&&s.filter((r,n)=>r!==St[n]&&r.status==="paid").forEach(r=>{try{xr.send(a.uid,`تم سداد الدين بالكامل للعميل ${r.debtorName}: المدفوع ${Number(r.paidAmount||r.amount||0)} جنيه`)}catch{}})}catch{}}}catch{}},[Ze,St,a==null?void 0:a.uid]),i.useEffect(()=>{try{const t=a!=null&&a.uid?localStorage.getItem(`commissionMode_${a.uid}`):null,s=localStorage.getItem("commissionMode"),r=localStorage.getItem("commissionMode_default"),n=t??s??r;n&&zn(n==="add")}catch{}},[a==null?void 0:a.uid]);const[Yn,qr]=i.useState(!1),[lm,om]=i.useState(null),Fi=Ge.useRef(""),vo=Ge.useRef(0);i.useEffect(()=>{const t=s=>{var r;if(Yn)return;try{const o=document.activeElement;if(o){const h=(r=o.tagName)==null?void 0:r.toLowerCase();if(h==="input"||h==="textarea"||h==="select"||h==="button"||o.isContentEditable===!0)return}}catch{}const n=Date.now();if(s.key==="Enter"){const o=(Fi.current||"").trim();Fi.current="",o&&(om(o),qr(!0));return}s.key.length===1&&(n-(vo.current||0)>100&&(Fi.current=""),Fi.current+=s.key,vo.current=n)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[Yn]);const[cm,dm]=i.useState(!1),[mm,dx]=i.useState(null);i.useEffect(()=>{if(!ze)return;const t=_a(),s=parseFloat(de||"0")||0;let r=0;if(le==="transfer"){if((t==null?void 0:t.defaultTransferCommission)!=null){const o=Number(t.defaultTransferCommission)||0;r=Math.round(o*s/1e3*100)/100}else{const o=pa&&pa.trim()!==""?parseFloat(pa):0;r=Math.max(0,o)}const n=s+r;La((n||0).toString())}else{if((t==null?void 0:t.defaultWithdrawCommission)!=null){const o=Number(t.defaultWithdrawCommission)||0;r=Math.round(o*s/1e3*100)/100}else{const o=xa&&xa.trim()!==""?parseFloat(xa):Math.round(s*.01*100)/100;r=Math.max(0,o)}const n=wt?s:Math.max(0,Math.round((s-r)*100)/100);La((n||0).toString())}},[ze,de,pa,xa,L,wt,le]);const _a=()=>{var t,s;let r=Je.find(n=>n.id===L);if(!r)try{const n=localStorage.getItem($l());if(n){const o=JSON.parse(n);if(Array.isArray(o)&&o.length>0){const h=localStorage.getItem(Or())||((t=o.find(p=>p.isDefault))==null?void 0:t.id)||((s=o[0])==null?void 0:s.id);r=o.find(p=>p.id===h)}}}catch{}return r};i.useLayoutEffect(()=>{try{const t=`wallets_${(a==null?void 0:a.uid)||"default"}`;let s=localStorage.getItem(t);if(!s){const r=Object.keys(localStorage).find(n=>n.startsWith("wallets_"));r&&(s=localStorage.getItem(r)||null)}if(s){const r=JSON.parse(s);if(Array.isArray(r)&&r.length>0){Sr(r);const n=localStorage.getItem(Or()),o=n&&r.find(h=>h.id===n)||r.find(h=>h.isDefault)||r[0];o&&(rt(o.id),O(o.phone))}}}catch(t){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",t)}},[]),i.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",L)},[L]),i.useEffect(()=>{Nc()},[a==null?void 0:a.uid]),i.useEffect(()=>{yu()},[]);const[Je,Sr]=i.useState(()=>{try{const t=Object.keys(localStorage).find(r=>r.startsWith("wallets_")),s=t?localStorage.getItem(t):null;if(s){const r=JSON.parse(s);if(Array.isArray(r))return r}}catch{}return[]}),Li=nd({enabled:!!(a!=null&&a.uid),queryKey:["wallets",a==null?void 0:a.uid],queryFn:async()=>{const{merchantWalletService:t}=await ht(async()=>{const{merchantWalletService:r}=await ft(()=>import("./index-C_crvORM.js").then(n=>n.c3),__vite__mapDeps([0,1]),import.meta.url).then(n=>n.c4);return{merchantWalletService:r}},xt([0,1]),import.meta.url),s=await t.getByMerchantId(String((a==null?void 0:a.uid)||""));return(Array.isArray(s)?s:[]).filter(r=>r.isActive===!0).map(r=>({id:r.id,name:r.label||"محفظة بدون اسم",phone:r.msisdn,isDefault:!!r.isDefault,monthlyWithdrawalLimit:r.monthlyWithdrawalLimit??r.withdrawLimit??2e5,monthlyTransferLimit:r.monthlyTransferLimit??r.transferLimit??2e5,defaultTransferCommission:r.defaultTransferCommission!=null?Number(r.defaultTransferCommission):null,defaultWithdrawCommission:r.defaultWithdrawCommission!=null?Number(r.defaultWithdrawCommission):null}))},staleTime:6e4,gcTime:3e5,refetchOnReconnect:!0});i.useEffect(()=>{var t;const s=Li.data;if(s&&Array.isArray(s)){Sr(s);const r=localStorage.getItem(Or());if(!(L&&s.find(n=>n.id===L))){const n=r&&s.find(o=>o.id===r)?r:((t=s[0])==null?void 0:t.id)||"";if(n){rt(n);const o=s.find(h=>h.id===n);O(String((o==null?void 0:o.phone)||""))}}}},[Li.data]);const[yo,um]=i.useState(""),bo=(()=>{const t=yo.replace(/\D/g,"");return t?Je.filter(s=>(s.phone||"").replace(/\D/g,"").includes(t)):Je})(),[hm,mx]=i.useState(null),[xm,wo]=i.useState(!1),[pm,Mi]=i.useState(!1),[gm,fm]=i.useState(null),[ux,vm]=i.useState([]),[hx,xx]=i.useState([]),[ym,Jr]=i.useState(!1),[Vn,No]=i.useState("daily"),[Yr,Ir]=i.useState([]),[jo,bm]=i.useState(!1),Ws=Ge.useRef(new Set),So=Ge.useRef(new Set),Io=Ge.useRef([]);i.useEffect(()=>{Io.current=Ze},[Ze]);const Co=async t=>{try{if(!a)return;const s=Ma(),r=Ta(),n=localStorage.getItem(s),o=localStorage.getItem(r);let h=n?parseFloat(n):$t,p=o?JSON.parse(o):{...lt};const g=Number(t.withdrawnAmount??t.sentAmount??t.transferredAmount??t.amount??0);if(t.type==="send"&&(t.fromWallet||L)){h-=g;const N=t.fromWallet||L;p[N]=(p[N]||0)+g}else if(t.type==="withdraw"&&(t.fromWallet||L)){h+=g;const N=t.fromWallet||L;p[N]=Math.max(0,(p[N]||0)-g)}Zt(h),ca(p),localStorage.setItem(s,h.toString()),localStorage.setItem(r,JSON.stringify(p));const w={cashBalance:h,walletBalances:p,lastUpdated:new Date().toISOString()},y=`userData_${a==null?void 0:a.uid}`;localStorage.setItem(y,JSON.stringify(w));try{await je.updateUserData(a.uid,w),localStorage.removeItem(y),st(!1)}catch(N){console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف (مزامنة تلقائية):",N),st(!0)}try{const N=t.fromWallet||L,_=await is.getWalletLimits(a.uid,N);if(_){const I={..._};t.type==="send"?(I.dailyTransferUsed=Math.max(0,(_.dailyTransferUsed||0)-g),I.monthlyTransferUsed=Math.max(0,(_.monthlyTransferUsed||0)-g)):(I.dailyWithdrawUsed=Math.max(0,(_.dailyWithdrawUsed||0)-g),I.monthlyWithdrawUsed=Math.max(0,(_.monthlyWithdrawUsed||0)-g)),await is.updateWalletLimits(a.uid,N,I)}}catch(N){console.warn("تعذر تحديث حدود المحفظة بعد الحذف (مزامنة):",N)}try{ja.removeTransactionEffects(t,a.uid)}catch(N){console.warn("تعذر تحديث التقارير بعد الحذف (مزامنة):",N)}}catch(s){console.warn("خطأ أثناء تطبيق تأثيرات الحذف محليًا:",s)}},wm=async t=>{try{const s=Ze.find(p=>p.id===t);if(!s||!a)return;const r=String(t),n=String((s==null?void 0:s.transactionId)||(s==null?void 0:s.reference)||""),o=Ws.current.has(r)||n&&Ws.current.has(n),h=Ze.filter(p=>p.id!==t);bs(h);try{await je.removeUserTransaction(a.uid,t),await di.permanentlyDeleteTransaction(t,a.uid)}catch(p){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",p)}if(!o){Ws.current.add(r),n&&Ws.current.add(n),await Co(s);try{a!=null&&a.uid&&je.removeLocalReceiptById(a.uid,t)}catch{}}u({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),Mi(!1)}catch(s){console.error("خطأ أثناء حذف الإيصال:",s),u({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},Nm=async t=>{var s;try{const r=Ze.find(n=>n.id===t);if(!r||!a)return;try{const n=(s=Fa==null?void 0:Fa.subscription)==null?void 0:s.planType;if(n===za.ZERO){const{dailyOperationCountService:o}=await ht(async()=>{const{dailyOperationCountService:p}=await ft(()=>import("./dailyOperationCountService-BuoXgFag-CymNVAFH.js"),__vite__mapDeps([2,0,1]),import.meta.url);return{dailyOperationCountService:p}},xt([2,0,1]),import.meta.url),h=r.type==="send"?"transfer":"withdraw";if(!(await o.checkAndIncrement(a.uid,h,5)).allowed){u({title:"تم بلوغ حد باقة الزيرو",description:"مسموح بحد أقصى 5 تأكيدات يوميًا للتحويل/السحب. جرّب غدًا أو قم بالترقية.",variant:"destructive"});return}}else if(n===za.TAHWEELA){const{dailyOperationCountService:o}=await ht(async()=>{const{dailyOperationCountService:p}=await ft(()=>import("./dailyOperationCountService-BuoXgFag-CymNVAFH.js"),__vite__mapDeps([2,0,1]),import.meta.url);return{dailyOperationCountService:p}},xt([2,0,1]),import.meta.url),h=r.type==="send"?"transfer":"withdraw";if(!(await o.checkAndIncrementCombined(a.uid,h,40)).allowed){u({title:"تم بلوغ حد باقة تحويله",description:"هذه الباقة تسمح بحد أقصى 40 عملية تحويل/سحب يومياً.",variant:"destructive"});return}}}catch(n){console.warn("تعذر التحقق من حد التأكيد اليومي:",n)}await Ut(Le(Y,"userTransactions",t),{status:"completed",confirmedAt:new Date}),bs(n=>n.map(o=>o.id===t?{...o,status:"completed"}:o)),u({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),Mi(!1)}catch(r){console.error("خطأ أثناء إكمال الإيصال:",r),u({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}};i.useEffect(()=>{if(a)try{const t=Ve(Ae(Y,"deletedTransactions"),me("userId","==",a.uid)),s=Oa(t,r=>{r.docChanges().forEach(n=>{if(n.type!=="added")return;const o=n.doc.data(),h=String((o==null?void 0:o.originalTransactionId)||""),p=String((o==null?void 0:o.transactionId)||""),g=String((o==null?void 0:o.reference)||""),w=h||p||g||String(n.doc.id);w&&(Ws.current.has(w)||(Ws.current.add(w),bs(y=>{const N=y.find(_=>_.id===h);return N?((async()=>await Co(N))(),y.filter(_=>_.id!==h)):y})))})},r=>{console.warn("فشل الاشتراك في deletedTransactions:",r)});return()=>s()}catch(t){console.warn("تعذر إنشاء مستمع deletedTransactions:",t)}},[a==null?void 0:a.uid]),i.useEffect(()=>{if(a)try{const t=Le(Y,"users",a.uid),s=Oa(t,async r=>{if(!r.exists())return;const n=r.data();if(n!=null&&n.reportsData)try{await ja.syncReportsDataFromFirebase(a.uid),vm(ni())}catch(o){console.warn("تعذر مزامنة reportsData من السحابة:",o)}},r=>{console.warn("فشل الاشتراك في users.reportsData:",r)});return()=>s()}catch(t){console.warn("تعذر إنشاء مستمع users.reportsData:",t)}},[a==null?void 0:a.uid]);const[Do,jm]=i.useState(""),Ao=V0(Do,300),[Ui,ko]=i.useState(""),[Wi,_o]=i.useState(""),[_s,px]=i.useState(""),[Gn,Cr]=i.useState(!1),[To,Vr]=i.useState(!1),[Sm,sr]=i.useState(!1),[ss,Kn]=i.useState(null),[xs,Im]=i.useState(null),[$o,rr]=i.useState(!1),[Cm,Dr]=i.useState(!1),[Oo,Dm]=i.useState(""),[Am,Hn]=i.useState(!1),Eo=!1,[km,Bi]=i.useState(!1),[_m,Po]=i.useState(!1),[Tm,Ri]=i.useState(!1),[$m,zi]=i.useState(!1),[Om,qi]=i.useState(!1),[Em,Fo]=i.useState(!0),[Gr,Pm]=i.useState(!1),[Fm,Ji]=i.useState(!1),[Lm,Lo]=i.useState(!1),[Yi,Mm]=i.useState(""),[Mo,Um]=i.useState(!1),[Wm,Qn]=i.useState(!1),[Bm,Uo]=i.useState(()=>{try{const t=a!=null&&a.uid?`dailyReportsLockEnabled_${a==null?void 0:a.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[Rm,Xn]=i.useState(!1);i.useEffect(()=>{try{const t=a!=null&&a.uid?`dailyReportsLockEnabled_${a==null?void 0:a.uid}`:"dailyReportsLockEnabled",s=localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled");Uo(s==="true")}catch{}},[a==null?void 0:a.uid]);const[zm,Ar]=i.useState(!1),[qm,Zn]=i.useState(!1),[Jm,Wo]=i.useState(()=>{try{const t=a==null?void 0:a.uid,s=t?`debtsPinRequired_${t}`:"debtsPinRequired";return(localStorage.getItem(s)??localStorage.getItem("debtsPinRequired"))==="true"}catch{return!1}}),[Ym,Bo]=i.useState(!1),[Ro,Vm]=i.useState(null),[el,zo]=i.useState(""),[tl,qo]=i.useState(""),[al,Jo]=i.useState(""),[kr,Yo]=i.useState(null),[ue,ir]=i.useState(null),[Gm,Bs]=i.useState(!1),[Km,Kr]=i.useState(!1),[nr,Vo]=i.useState(null),[Go,sl]=i.useState(""),[Vi,Ko]=i.useState(null),[gx,fx]=i.useState(!1),[Hm,rl]=i.useState(!1),[Ho,il]=i.useState(""),[nl,_r]=i.useState(!1),[Qo,ll]=i.useState(1),Qm=se?10:20,ol=Ge.useMemo(()=>St.slice(0,Qo*Qm),[St,Qo]);i.useEffect(()=>{nl&&ll(1)},[nl]);const cl=async()=>{if(It){u({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}try{const t=await Ia.hasMasterPin(a==null?void 0:a.uid);Jm&&t?Zn(!0):Ar(!0)}catch{Ar(!0)}};i.useEffect(()=>{try{const t=a==null?void 0:a.uid,s=t?`debtsPinRequired_${t}`:"debtsPinRequired",r=localStorage.getItem(s)??localStorage.getItem("debtsPinRequired");(r==="true"||r==="false")&&Wo(r==="true")}catch{}},[a==null?void 0:a.uid]),i.useEffect(()=>{const t=()=>{try{cc()}catch{}};try{window.addEventListener("debtsUpdated",t)}catch{}return()=>{try{window.removeEventListener("debtsUpdated",t)}catch{}}},[a==null?void 0:a.uid,A,v==null?void 0:v.shopId]);const[Xm,dl]=i.useState(!1),[Ga,ml]=i.useState([]),[ul,Xo]=i.useState(""),[hl,Zo]=i.useState(""),[Gi,ec]=i.useState(""),[tc,Zm]=i.useState(""),[eu,Ki]=i.useState(!1),[tu,ac]=i.useState(""),[sc,xl]=i.useState(""),[rc,pl]=i.useState(""),[au,Hi]=i.useState(!1),[su,gl]=i.useState(""),[ic,fl]=i.useState(""),[ru,Tr]=i.useState(!1),[lr,Qi]=i.useState(null),[Ka,Hr]=i.useState(null),[Xi,vl]=i.useState(""),[iu,$r]=i.useState(!1),[nc,Zi]=i.useState(0),[Ha,Rs]=i.useState(null),[or,yl]=i.useState(""),[kt,bl]=i.useState(null),[lc,oc]=i.useState(""),Qa=async t=>{try{const s=JSON.stringify(t);localStorage.setItem(Xr(),s);try{localStorage.setItem(bc(),s)}catch{}try{localStorage.setItem(wc(),Date.now().toString())}catch{}a!=null&&a.uid&&je.updateUserData(a.uid,{debts:t}).then(()=>{try{localStorage.removeItem(`debts_unsynced_${a.uid}`)}catch{}}).catch(()=>{st(!0);try{localStorage.setItem(`debts_unsynced_${a.uid}`,"true")}catch{}})}catch(s){console.error("خطأ في حفظ الديون:",s)}},cc=async()=>{try{const t=Xr(),s=bc(),r=wc(),n=localStorage.getItem(t),o=localStorage.getItem(s),h=localStorage.getItem(r),p=h?Number(h):0,g=y=>{if(!y)return null;try{const N=JSON.parse(y);return Array.isArray(N)?N.map(_=>{var I;return{..._,createdAt:(I=_.createdAt)!=null&&I.toDate?_.createdAt.toDate():new Date(_.createdAt),partialPayments:Array.isArray(_.partialPayments)?_.partialPayments.map(k=>{var W;return{amount:Number(k.amount)||0,paidAt:(W=k.paidAt)!=null&&W.toDate?k.paidAt.toDate():new Date(k.paidAt)}}):[]}}):[]}catch(N){return console.warn("فشل في تحليل ديون localStorage:",N),null}};let w=g(n);if(!w||w.length===0){const y=g(o);if(y&&y.length>0){w=y,ga(y);try{localStorage.setItem(Xr(),JSON.stringify(y)),localStorage.removeItem(s)}catch(N){console.warn("تعذر ترحيل الديون محلياً من المفتاح الافتراضي:",N)}}}if(w&&w.length>0&&ga(w),a!=null&&a.uid)try{const y=`debts_unsynced_${a.uid}`,N=localStorage.getItem(y)==="true",_=await Ss(Le(Y,"users",a.uid));if(_.exists()){const I=_.data(),k=I.debts&&Array.isArray(I.debts)?I.debts.map(W=>{var ie;return{...W,amount:Number(W.amount||0),paidAmount:Number(W.paidAmount||0),createdAt:(ie=W.createdAt)!=null&&ie.toDate?W.createdAt.toDate():new Date(W.createdAt),partialPayments:Array.isArray(W.partialPayments)?W.partialPayments.map(J=>{var ve;return{amount:Number(J.amount)||0,paidAt:(ve=J.paidAt)!=null&&ve.toDate?J.paidAt.toDate():new Date(J.paidAt)}}):[]}}):[];if(I.debtsDeletedAt){ga([]);try{localStorage.setItem(t,JSON.stringify([])),localStorage.setItem(s,JSON.stringify([]))}catch{}return}if(((k==null?void 0:k.length)||0)>0){ga(k);try{localStorage.setItem(t,JSON.stringify(k))}catch{}}}else w&&w.length>0}catch(y){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",y)}}catch(t){console.error("خطأ في تحميل الديون:",t)}};i.useEffect(()=>{try{window.exportDebts=()=>{try{return JSON.stringify(St||[])}catch{return"[]"}},window.importDebts=async t=>{try{const s=JSON.parse(t);if(!Array.isArray(s))throw new Error("صيغة غير صحيحة — يجب أن تكون مصفوفة");return await Qa(s),{ok:!0,count:s.length}}catch(s){return console.error("فشل استيراد الديون:",s),{ok:!1,error:String(s)}}},window.fixWalletsForCurrentUser=async t=>{try{if(!(a!=null&&a.uid))throw new Error("يجب تسجيل الدخول أولاً");return await(await ht(async()=>{const{merchantWalletService:s}=await ft(()=>import("./index-C_crvORM.js").then(r=>r.c3),__vite__mapDeps([0,1]),import.meta.url).then(r=>r.c4);return{merchantWalletService:s}},xt([0,1]),import.meta.url)).merchantWalletService.reassignByMsisdns(t,a.uid)}catch(s){return console.error("فشل إصلاح المحافظ للمستخدم الحالي:",s),{updated:0,failed:(t==null?void 0:t.length)||0,error:String(s)}}}}catch{}},[St,a==null?void 0:a.uid]),i.useEffect(()=>{if(!(a!=null&&a.uid))return;const t=Le(Y,"users",a.uid),s=Oa(t,r=>{if(!r.exists())return;const n=r.data(),o=Array.isArray(n==null?void 0:n.debts)?n.debts:[];try{const h=o.map(p=>{var g;return{...p,createdAt:(g=p.createdAt)!=null&&g.toDate?p.createdAt.toDate():new Date(p.createdAt),partialPayments:Array.isArray(p.partialPayments)?p.partialPayments.map(w=>{var y;return{amount:Number(w.amount)||0,paidAt:(y=w.paidAt)!=null&&y.toDate?w.paidAt.toDate():new Date(w.paidAt)}}):[]}});ga(h);try{localStorage.setItem(Xr(),JSON.stringify(h))}catch{}}catch(h){console.warn("تعذر تحليل الديون من التحديثات الحية:",h)}},r=>{console.warn("خطأ في الاشتراك الحي لديون المستخدم:",r)});return()=>s()},[a==null?void 0:a.uid]);const nu=async()=>{if(a!=null&&a.uid)try{d(!0);const t=await lo(a.uid);zr(t)}catch(t){console.error("خطأ في جلب بيانات الاشتراك:",t)}finally{d(!1)}},[vx,yx]=i.useState(!1),[lu,wl]=i.useState(!1),[$t,Zt]=i.useState(0),[lt,ca]=i.useState({}),[ou,dc]=i.useState(!1),[cu,mc]=i.useState(!1),[du,Nl]=i.useState(!1),[mu,en]=i.useState(!1),[uc,jl]=i.useState(""),[uu,Qr]=i.useState(!1),[hu,tn]=i.useState(!1),[Sl,an]=i.useState(""),[xu,Il]=i.useState(!1),[sn,hc]=i.useState(""),[rn,xc]=i.useState(""),[nn,pc]=i.useState(""),[gc,fc]=i.useState(!1),[Cl,Dl]=i.useState(!1),[pu,vc]=i.useState(!1),[yc,gu]=i.useState([]);i.useEffect(()=>{(async()=>{try{if(!(a!=null&&a.uid)||!Cl)return;try{await ci.trimToMaxCount(a.uid,30)}catch{}const t=await ci.getByUser(a.uid,30);gu(t)}catch{}})()},[a==null?void 0:a.uid,Cl]);const Ta=()=>{const t=A||(v==null?void 0:v.shopId)||"main";return`walletBalances_${(a==null?void 0:a.uid)||"default"}_${t}`},Ma=()=>{const t=A||(v==null?void 0:v.shopId)||"main";return`cashBalance_${(a==null?void 0:a.uid)||"default"}_${t}`},Xr=()=>{const t=A||(v==null?void 0:v.shopId)||"main";return`debts_${(a==null?void 0:a.uid)||"default"}_${t}`},fu=()=>{const t=A||(v==null?void 0:v.shopId)||"main";return`customers_${(a==null?void 0:a.uid)||"default"}_${t}`},bc=()=>`debts_default_${A||(v==null?void 0:v.shopId)||"main"}`,wc=()=>{const t=A||(v==null?void 0:v.shopId)||"main";return`debts_last_write_${(a==null?void 0:a.uid)||"default"}_${t}`},Al=()=>`shopExpenses_${A||(v==null?void 0:v.shopId)||(a==null?void 0:a.uid)||"default"}`,Nc=()=>{try{const t=localStorage.getItem(Al());if(t){const s=JSON.parse(t);la(s.map(r=>({...r,createdAt:new Date(r.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",t)}},jc=async t=>{try{localStorage.setItem(Al(),JSON.stringify(t)),la(t)}catch(s){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",s)}},vu=async t=>{try{const s=Nt.filter(r=>r.id!==t);await jc(s);try{if(a!=null&&a.uid&&t){const{doc:r,deleteDoc:n}=await ht(async()=>{const{doc:p,deleteDoc:g}=await ft(()=>import("./index-C_crvORM.js").then(w=>w.c3),__vite__mapDeps([0,1]),import.meta.url).then(w=>w.c2);return{doc:p,deleteDoc:g}},xt([0,1]),import.meta.url),{db:o}=await ht(async()=>{const{db:p}=await ft(()=>import("./index-C_crvORM.js").then(g=>g.c3),__vite__mapDeps([0,1]),import.meta.url).then(g=>g.c3);return{db:p}},xt([0,1]),import.meta.url),h=r(o,"shop_expenses",t);await n(h)}}catch(r){console.warn("تعذر حذف المصروف من السحابة الآن، تم الحذف محليًا وسيبقى مخزّنًا دون هذا الإيصال:",r)}u({title:"تم الحذف",description:"تم حذف إيصال المصروف نهائيًا."})}catch(s){console.error("خطأ أثناء الحذف النهائي لإيصال المصروف:",s),u({title:"فشل الحذف",description:"تعذر حذف الإيصال. حاول مرة أخرى.",variant:"destructive"})}};Ge.useEffect(()=>{let t;return(async()=>{try{if(!(a!=null&&a.uid)){Nc();return}const{collection:s,query:r,where:n,onSnapshot:o}=await ht(async()=>{const{collection:w,query:y,where:N,onSnapshot:_}=await ft(()=>import("./index-C_crvORM.js").then(I=>I.c3),__vite__mapDeps([0,1]),import.meta.url).then(I=>I.c2);return{collection:w,query:y,where:N,onSnapshot:_}},xt([0,1]),import.meta.url),{db:h}=await ht(async()=>{const{db:w}=await ft(()=>import("./index-C_crvORM.js").then(y=>y.c3),__vite__mapDeps([0,1]),import.meta.url).then(y=>y.c3);return{db:w}},xt([0,1]),import.meta.url),p=A||(v==null?void 0:v.shopId),g=p?r(s(h,"shop_expenses"),n("shopId","==",p)):r(s(h,"shop_expenses"),n("userId","==",a.uid));t=o(g,async w=>{const y=w.docs.map(N=>{var _;const I=N.data(),k=(_=I.createdAt)!=null&&_.toDate?I.createdAt.toDate():I.createdAt?new Date(I.createdAt):new Date;return{id:N.id,name:String(I.name||""),amount:Number(I.amount||0),notes:I.notes?String(I.notes):void 0,source:I.source==="wallet"?"wallet":"cash",walletId:I.walletId?String(I.walletId):void 0,createdAt:k}}).sort((N,_)=>_.createdAt.getTime()-N.createdAt.getTime());la(y);try{localStorage.setItem(Al(),JSON.stringify(y))}catch{}})}catch(s){console.error("خطأ في مزامنة مصروفات المحل من Firestore:",s)}})(),()=>t==null?void 0:t()},[a==null?void 0:a.uid,v==null?void 0:v.shopId,A]);const ln=()=>`deficiencies_${A||(v==null?void 0:v.shopId)||(a==null?void 0:a.uid)||"default-shop"}`,yu=()=>{try{const t=ln(),s=`deficiencies_${(a==null?void 0:a.uid)||"default"}`;if(s!==t){const n=localStorage.getItem(s),o=localStorage.getItem(t);if(n)try{const h=JSON.parse(n)||[],p=o?JSON.parse(o):[],g=Array.isArray(p)?[...p]:[],w=(y,N)=>y.some(_=>(_==null?void 0:_.id)&&(N==null?void 0:N.id)&&String(_.id)===String(N.id)||String((_==null?void 0:_.name)||"")===String((N==null?void 0:N.name)||"")&&String((_==null?void 0:_.status)||"pending")===String((N==null?void 0:N.status)||"pending"));if(Array.isArray(h))for(const y of h)w(g,y)||g.push(y);localStorage.setItem(t,JSON.stringify(g));try{localStorage.removeItem(s)}catch{}}catch{}}const r=localStorage.getItem(t);if(r){const n=JSON.parse(r);bt(n.map(o=>({...o,createdAt:new Date(o.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل النواقص من التخزين:",t)}},kl=async t=>{try{localStorage.setItem(ln(),JSON.stringify(t)),bt(t)}catch(s){console.error("خطأ أثناء حفظ النواقص في التخزين:",s)}};Ge.useEffect(()=>{let t;return(async()=>{try{if(!(a!=null&&a.uid))return;const{collection:s,query:r,where:n,orderBy:o,onSnapshot:h}=await ht(async()=>{const{collection:y,query:N,where:_,orderBy:I,onSnapshot:k}=await ft(()=>import("./index-C_crvORM.js").then(W=>W.c3),__vite__mapDeps([0,1]),import.meta.url).then(W=>W.c2);return{collection:y,query:N,where:_,orderBy:I,onSnapshot:k}},xt([0,1]),import.meta.url),{db:p}=await ht(async()=>{const{db:y}=await ft(()=>import("./index-C_crvORM.js").then(N=>N.c3),__vite__mapDeps([0,1]),import.meta.url).then(N=>N.c3);return{db:y}},xt([0,1]),import.meta.url),g=A||(v==null?void 0:v.shopId)||a.uid||"default-shop",w=r(s(p,"deficiencies"),n("shopId","==",g),o("createdAt","desc"));t=h(w,async y=>{const N=y.docs.map(_=>{var I;const k=_.data(),W=(I=k.createdAt)!=null&&I.toDate?k.createdAt.toDate():k.createdAt?new Date(k.createdAt):new Date;return{id:_.id,name:String(k.name||""),quantity:Number(k.quantity||1),status:k.status==="purchased"?"purchased":"pending",createdAt:W}});bt(N);try{localStorage.setItem(ln(),JSON.stringify(N))}catch{}},y=>{console.warn("فشل الاشتراك في النواقص من Firestore:",y)})}catch(s){console.warn("فشل إعداد مزامنة النواقص من Firestore:",s)}})(),()=>{try{t&&t()}catch{}}},[a==null?void 0:a.uid,v==null?void 0:v.shopId,A]);const _l=async t=>{try{localStorage.setItem(fu(),JSON.stringify(t)),ml(t),a!=null&&a.uid&&await je.updateUserData(a.uid,{customers:t})}catch(s){console.error("خطأ أثناء حفظ العملاء في التخزين:",s)}},bu=async()=>{try{if(a!=null&&a.uid){const t=await Ss(Le(Y,"users",a.uid));if(t.exists()){const s=t.data();if(s.customers&&Array.isArray(s.customers)){const r=s.customers.map(n=>{var o;return{...n,createdAt:(o=n.createdAt)!=null&&o.toDate?n.createdAt.toDate():new Date(n.createdAt)}});ml(r);return}}}ml([])}catch(t){console.error("خطأ أثناء تحميل العملاء من Firestore:",t)}},Tl=()=>{const t=A||(v==null?void 0:v.shopId)||"main";return`transactions_${(a==null?void 0:a.uid)||"default"}_${t}`},$l=()=>{const t=A||(v==null?void 0:v.shopId)||"main";return`wallets_${(a==null?void 0:a.uid)||"default"}_${t}`},Or=()=>{const t=A||(v==null?void 0:v.shopId)||"main";return`selectedWallet_${(a==null?void 0:a.uid)||"default"}_${t}`};i.useEffect(()=>{let t;return(async()=>{try{if(!(a!=null&&a.uid))return;const{collection:s,query:r,where:n,orderBy:o,limit:h,onSnapshot:p}=await ht(async()=>{const{collection:y,query:N,where:_,orderBy:I,limit:k,onSnapshot:W}=await ft(()=>import("./index-C_crvORM.js").then(ie=>ie.c3),__vite__mapDeps([0,1]),import.meta.url).then(ie=>ie.c2);return{collection:y,query:N,where:_,orderBy:I,limit:k,onSnapshot:W}},xt([0,1]),import.meta.url),{db:g}=await ht(async()=>{const{db:y}=await ft(()=>import("./index-C_crvORM.js").then(N=>N.c3),__vite__mapDeps([0,1]),import.meta.url).then(N=>N.c3);return{db:y}},xt([0,1]),import.meta.url),w=r(s(g,"userTransactions"),n("userId","==",a.uid),o("createdAt","desc"),h(100));t=p(w,y=>{jo||bm(!0);const N=y.docs.map(J=>{var ve;const Ye=J.data(),Xa=(ve=Ye.createdAt)!=null&&ve.toDate?Ye.createdAt.toDate():new Date(Ye.createdAt),fa=Ye.txnType==="send"?"send":Ye.txnType==="receive"?"withdraw":Ye.type||"withdraw",zs=Ye.status==="confirmed"?"completed":Ye.status||"completed",Yt=Ye.senderMsisdn||Ye.senderPhone||"",Za=Ye.receiverMsisdn||Ye.receiverPhone||"",Wa=Number(Ye.amount??Ye.transferredAmount??Ye.withdrawnAmount??0);return{id:J.id,...Ye,type:fa,status:zs,senderPhone:Yt,receiverPhone:Za,amount:Wa,createdAt:Xa}}).filter(J=>!((J==null?void 0:J.type)==="report"||String((J==null?void 0:J.title)||"").includes("إيصال تسليم وردية"))),_=new Set((Yr||[]).map(J=>String(J.id||J.originalTransactionId||""))),I=N.filter(J=>!_.has(String(J.id||""))),k=J=>{var ve;return String(J.transactionId||J.id||J.reference||((ve=J.receipt)==null?void 0:ve.reference)||`${new Date(J.createdAt).getTime()}`)},W=new Set,ie=[];for(const J of I){const ve=k(J);W.has(ve)||(W.add(ve),ie.push(J))}bs(ie)})}catch{}})(),()=>{try{t&&t()}catch{}}},[a==null?void 0:a.uid,Yr.length]),i.useEffect(()=>{if(!(a!=null&&a.uid))return;let t=null;return(async()=>{try{const{collection:s,query:r,where:n,onSnapshot:o}=await ht(async()=>{const{collection:g,query:w,where:y,onSnapshot:N}=await ft(()=>import("./index-C_crvORM.js").then(_=>_.c3),__vite__mapDeps([0,1]),import.meta.url).then(_=>_.c2);return{collection:g,query:w,where:y,onSnapshot:N}},xt([0,1]),import.meta.url),{db:h}=await ht(async()=>{const{db:g}=await ft(()=>import("./index-C_crvORM.js").then(w=>w.c3),__vite__mapDeps([0,1]),import.meta.url).then(w=>w.c3);return{db:g}},xt([0,1]),import.meta.url),p=r(s(h,"deletedTransactions"),n("userId","==",a.uid));t=o(p,g=>{try{g.docChanges().forEach(y=>{const N=y.doc.data(),_=[N.originalTransactionId,N.transactionId,N.reference,y.doc.id].filter(Boolean).map(k=>String(k));if(_.find(k=>So.current.has(k)))return;const I=Io.current.find(k=>{const W=String(k.id||""),ie=String(k.transactionId||""),J=String(k.reference||"");return _.includes(W)||_.includes(ie)||_.includes(J)});if(I){const k=I.fromWallet||L||"",W=Number(I.withdrawnAmount??I.sentAmount??I.amount??0),ie=I.type==="send"?"transfer":"withdraw";k&&W>0&&(is.rollbackUsage(k,W,ie).catch(()=>{}),_.forEach(J=>So.current.add(J)))}});const w=g.docs.map(y=>{var N;const _=y.data(),I=(N=_.createdAt)!=null&&N.toDate?_.createdAt.toDate():new Date(_.createdAt||Date.now());return{id:y.id,..._,createdAt:I}});Ir(w),(async()=>{try{const y=A||(v==null?void 0:v.shopId);if(!y)return;const N=Le(h,"dashboardData",y),_=await Ss(N);if(_.exists()){const I=_.data();typeof I.cashBalance=="number"&&Zt(Number(I.cashBalance||0)),I.walletBalances&&typeof I.walletBalances=="object"&&ca(I.walletBalances||{})}}catch{}})()}catch{}},g=>{console.warn("deletedTransactions subscription error (Dashboard):",g)})}catch{}})(),()=>{try{t&&t()}catch{}}},[a==null?void 0:a.uid]);const[Ol,on]=i.useState(""),[Ua,Sc]=i.useState(""),ws=Ge.useMemo(()=>{const t=Fa;if(!t)return!1;const s=th(t),r=t.planType??t.plan??null,n=typeof r=="string"?r.toLowerCase():null,o=n==="monthly"||n==="quarterly"||n==="yearly"||n==="lifetime"||r===za.MONTHLY||r===za.QUARTERLY||r===za.YEARLY||r===za.LIFETIME;return s&&o},[Fa]),It=Ge.useMemo(()=>{var t,s;const r=Fa;if(!r)return!1;const n=((t=r.subscription)==null?void 0:t.planType)??((s=r.subscription)==null?void 0:s.plan)??r.planType??r.plan??null,o=typeof n=="string"?n.toLowerCase():null;return n===za.ZERO||o==="zero"},[Fa]),Jt=Ge.useMemo(()=>{var t,s;const r=Fa;if(!r)return!1;const n=((t=r.subscription)==null?void 0:t.planType)??((s=r.subscription)==null?void 0:s.plan)??r.planType??r.plan??null,o=typeof n=="string"?String(n).trim().toLowerCase():null;return n===za.TAHWEELA||o==="tahweela"||o==="تحويله"},[Fa]),wu=()=>{if(!ws){u({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}fe(!0)},[bx,wx]=i.useState(!1),[Nu,ju]=i.useState(!1),[Su,Iu]=i.useState(!1),[Cu,Du]=i.useState(!1),[Au,Zr]=i.useState(!1),[cr,cn]=i.useState(""),[ei,dn]=i.useState(""),[Ic,mn]=i.useState(!1),[ti,ai]=i.useState(null),[El,un]=i.useState(""),[ku,Cc]=i.useState(!1),[Nx,jx]=i.useState(!1),[_u,hn]=i.useState(!1),[Dc,Pl]=i.useState(""),[Ac,Fl]=i.useState(""),[kc,_c]=i.useState(!1),Tc=async()=>{var t;if(a!=null&&a.uid)try{const s=`userData_${a.uid}`,r=localStorage.getItem(s),n=`debts_unsynced_${a.uid}`,o=localStorage.getItem(Xr()),h=localStorage.getItem(n)==="true";if(r){const p=JSON.parse(r);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",p);const g={lastSynced:new Date().toISOString()};typeof p.cashBalance=="number"&&(g.cashBalance=p.cashBalance),p.walletBalances&&typeof p.walletBalances=="object"&&(g.walletBalances=p.walletBalances),await je.updateUserData(a.uid,g),localStorage.removeItem(s),st(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة");if(h&&o)try{const p=JSON.parse(o)||[],g=J=>J instanceof Date?J:typeof(J==null?void 0:J.toDate)=="function"?J.toDate():J?new Date(String(J)):new Date,w=J=>(Array.isArray(J)?J:[]).map(ve=>({...ve,amount:Number(ve.amount||0),paidAmount:Number(ve.paidAmount||0),createdAt:g(ve.createdAt),partialPayments:Array.isArray(ve.partialPayments)?ve.partialPayments.map(Ye=>({amount:Number(Ye.amount||0),paidAt:g(Ye.paidAt)})):[]})),y=await Ss(Le(Y,"users",a.uid)),N=y.exists()?((t=y.data())==null?void 0:t.debts)||[]:[],_=w(N),I=w(p),k={};for(const J of _)k[String(J.id||"")]=J;const W=[],ie=new Set;for(const J of I){const ve=String(J.id||""),Ye=k[ve];if(Ye){const Xa=Number(Ye.paidAmount||0)+(Array.isArray(Ye.partialPayments)?Ye.partialPayments.reduce((Wa,es)=>Wa+Number(es.amount||0),0):0),fa=Number(J.paidAmount||0)+(Array.isArray(J.partialPayments)?J.partialPayments.reduce((Wa,es)=>Wa+Number(es.amount||0),0):0),zs=String(Ye.status||"pending"),Yt=String(J.status||"pending"),Za=zs==="paid"||Xa>=Number(Ye.amount||0)?Ye:Yt==="paid"?{...Ye,paidAmount:Number(J.paidAmount||0),partialPayments:J.partialPayments,status:"paid"}:fa>Xa?{...Ye,paidAmount:Number(J.paidAmount||0),partialPayments:J.partialPayments,status:fa>=Number(Ye.amount||0)?"paid":"pending"}:Ye;W.push(Za),ie.add(ve)}else W.push(J),ie.add(ve)}for(const J of _){const ve=String(J.id||"");ie.has(ve)||W.push(J)}await je.updateUserData(a.uid,{debts:W});try{localStorage.removeItem(n)}catch{}st(!1)}catch{st(!0)}}catch(s){console.error("❌ فشل في مزامنة البيانات:",s),u({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},[$c,xn]=i.useState({keepLastCount:30,intervalDays:7,lastResetAt:null});i.useEffect(()=>{(async()=>{if(a!=null&&a.uid)try{const t=await je.getUserData(a.uid),s=(t==null?void 0:t.recentReset)||{},r=Number(s==null?void 0:s.keepLastCount)>0?Number(s.keepLastCount):30,n=Number(s==null?void 0:s.intervalDays)>0?Number(s.intervalDays):7,o=g=>g instanceof Date?g:typeof(g==null?void 0:g.toDate)=="function"?g.toDate():g?new Date(String(g)):null,h=s!=null&&s.lastResetAt?o(s.lastResetAt):null,p=new Date;!h||p.getTime()-h.getTime()>=n*24*60*60*1e3?(await je.updateUserData(a.uid,{recentReset:{keepLastCount:r,intervalDays:n,lastResetAt:p}}),xn({keepLastCount:r,intervalDays:n,lastResetAt:p})):xn({keepLastCount:r,intervalDays:n,lastResetAt:h})}catch{xn({keepLastCount:30,intervalDays:7,lastResetAt:null})}})()},[a==null?void 0:a.uid]);const Oc=Ge.useMemo(()=>{const t=Ze||[],s=h=>h instanceof Date?h:typeof(h==null?void 0:h.toDate)=="function"?h.toDate():new Date(String(h)),r=new Date,n=new Date(r.getFullYear(),r.getMonth(),1),o=new Date(r.getFullYear(),r.getMonth()+1,1);return[...t].sort((h,p)=>s(p.createdAt).getTime()-s(h.createdAt).getTime()).filter(h=>{const p=s(h.createdAt);return p>=n&&p<o})},[Ze]),Tu=Ge.useMemo(()=>{const t=Ze||[],s=p=>p instanceof Date?p:typeof(p==null?void 0:p.toDate)=="function"?p.toDate():new Date(String(p)),r=new Date,n=new Date(r.getFullYear(),r.getMonth(),1),o=new Date(r.getFullYear(),r.getMonth()+1,1),h=t.filter(p=>{const g=s(p.createdAt);return g>=n&&g<o}).length;return Math.max(0,((Ze==null?void 0:Ze.length)||0)-h)},[Ze==null?void 0:Ze.length]),pn=Ge.useMemo(()=>{const t=new Date,s=new Date(t.getFullYear(),t.getMonth(),1),r=new Date(t.getFullYear(),t.getMonth()+1,1),n={};for(const o of Ze){const h=new Date(o.createdAt||0);if(!(h>=s&&h<r))continue;const p=String(o.type||o.txnType||"").toLowerCase();if(!(p==="send"||p==="withdraw"||p==="transfer"))continue;const g=String(o.receiverPhone||o.senderPhone||"").trim();if(!g)continue;const w=Ca(g),y=Number(o.amount||o.withdrawnAmount||o.sentAmount||0)||0;n[w]||(n[w]={phone:w,count:0,total:0}),n[w].count+=1,n[w].total+=y}return Object.values(n).sort((o,h)=>h.count!==o.count?h.count-o.count:h.total-o.total).slice(0,10)},[Ze]),$u=t=>{const s=Ca(String(t));return s.startsWith("+20")?"20"+s.slice(3):s.startsWith("0")?"20"+s.slice(1):s.replace(/[^0-9]/g,"")},Ou=t=>{const s=$u(t.phone),r=`عميل VIP هذا الشهر
عدد العمليات: ${t.count}
الإجمالي: ${t.total} جنيه`,n=`https://wa.me/${s}?text=${encodeURIComponent(r)}`;try{window.open(n,"_blank")}catch{}};i.useEffect(()=>{(async()=>{try{if(!(a!=null&&a.uid))return;const t=`${new Date().getFullYear()}-${new Date().getMonth()+1}`;await je.updateUserData(a.uid,{vipTop10:pn,vipMonthTag:t})}catch{}})()},[a==null?void 0:a.uid,pn]);async function Eu(){const t=new Date,s=new Intl.DateTimeFormat("ar-EG",{timeZone:"Africa/Cairo",year:"numeric",month:"2-digit",day:"2-digit"}).format(t),r=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0,0),n=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59,999),o=(Ze||[]).filter(I=>{const k=new Date(I.createdAt||0);return k>=r&&k<=n}),h=o.length,p=o.filter(I=>String(I.type||I.txnType||"").toLowerCase()==="withdraw"||String(I.type||"").toLowerCase()==="receive").reduce((I,k)=>I+(k.withdrawnAmount!=null?Number(k.withdrawnAmount):Number(k.amount||0)),0),g=o.filter(I=>String(I.type||I.txnType||"").toLowerCase()==="send"||String(I.type||"").toLowerCase()==="transfer").reduce((I,k)=>I+(k.sentAmount!=null?Number(k.sentAmount):Number(k.amount||0)),0);let w=0;try{w=o.reduce((I,k)=>I+ja.calculateTransactionProfit(k),0)}catch{}let y=0;try{const I=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(t),k=Ve(Ae(Y,"dailySales"),me("userId","==",(a==null?void 0:a.uid)||""));y=(await et(k)).docs.map(W=>W.data()).filter(W=>String(W.date||I)===I).reduce((W,ie)=>W+Number(ie.sellingPrice||ie.price||0)*Number(ie.quantity||1),0)}catch{}let N=0;try{N=(St||[]).filter(I=>String(I.status||"")==="pending").reduce((I,k)=>{const W=Number(k.paidAmount||0)+(Array.isArray(k.partialPayments)?k.partialPayments:[]).reduce((ie,J)=>ie+Number(J.amount||0),0);return I+Math.max(0,Number(k.amount||0)-W)},0)}catch{}let _="";try{const I=A||(v==null?void 0:v.shopId)||null,k=I?Ve(Ae(Y,"deficiencies"),me("shopId","==",I)):Ve(Ae(Y,"deficiencies"),me("userId","==",(a==null?void 0:a.uid)||""));_=(await et(k)).docs.map(W=>W.data()).filter(W=>String(W.status||"pending")==="pending").slice(0,10).map((W,ie)=>`${ie+1}- ${String(W.name||W.productName||"عنصر")} × ${Number(W.quantity||W.qty||0)}`).join(`
`)}catch{}return[`تقرير يومي - ${s}`,`عدد العمليات: ${h}`,`إجمالي المسحوبات: ${p} جنيه`,`إجمالي الإرسال: ${g} جنيه`,`الأرباح: ${w} جنيه`,`إجمالي مبيعات الاكسسوار: ${y} جنيه`,`إجمالي الديون: ${N} جنيه`,"نواقص الاكسسوار:",_||"لا توجد عناصر مسجلة"].join(`
`)}const Ec=Ge.useCallback(()=>{let t=Oc;const s=Ao.trim();if(s&&(t=t.filter(r=>{const n=r;return String(n.type||"").toLowerCase()==="cash_addition"||String(n.txnType||"").toLowerCase()==="cash_addition"||String(n.title||"").includes("إيصال إضافة نقدية")?!0:r.senderPhone&&r.senderPhone.includes(s)||r.receiverPhone&&r.receiverPhone.includes(s)})),Ui){const r=new Date(Ui);t=t.filter(n=>{const o=new Date(n.createdAt);if(Wi){const[h,p]=Wi.split(":"),g=new Date(r);g.setHours(parseInt(h),parseInt(p),0,0);const w=new Date(g);return w.setHours(w.getHours()+1),o>=g&&o<w}else return o.toDateString()===r.toDateString()})}try{t=[...t].sort((r,n)=>{const o=new Date(r.createdAt||0).getTime();return new Date(n.createdAt||0).getTime()-o})}catch{}return t},[Oc,Ao,Ui,Wi]),[Pu,gn]=i.useState(!1),[Pc,fn]=i.useState(""),[Fu,vn]=i.useState(!1),[Ll,Ml]=i.useState(""),[Lu,st]=i.useState(!1),Er=async(t,s=2,r=700)=>{let n;for(let o=0;o<=s;o++)try{return await t()}catch(h){if(n=h,o===s)break;await new Promise(p=>setTimeout(p,r*Math.pow(2,o)))}throw n};Je.reduce((t,s)=>t+(lt[s.id]||0),0);const Mu=async t=>await Ia.verifyMasterPin(t,a==null?void 0:a.uid),yn=async t=>await Ia.verifyMasterPin(t,a==null?void 0:a.uid);i.useEffect(()=>{if(a!=null&&a.uid){try{const t=Ta(),s=`walletBalances_${a.uid}`,r=localStorage.getItem(t)??localStorage.getItem(s);if(r){const n=JSON.parse(r);ca(n&&typeof n=="object"?n:{});try{localStorage.setItem(t,JSON.stringify(n||{}))}catch{}}}catch{}try{const t=Ma(),s=`cashBalance_${a.uid}`,r=`userCashBalance_${a.uid}`;let n=localStorage.getItem(t)??localStorage.getItem(s)??localStorage.getItem(r);if(n!=null){const o=parseFloat(n);Zt(Number.isFinite(o)?o:0);try{localStorage.setItem(t,String(Number.isFinite(o)?o:0)),localStorage.removeItem(s),localStorage.removeItem(r)}catch{}}}catch{}}},[a==null?void 0:a.uid,A,v==null?void 0:v.shopId]),i.useEffect(()=>{const t=s=>{var r;try{const n=Number((r=s==null?void 0:s.detail)==null?void 0:r.value);if(Number.isFinite(n))Zt(n);else{const o=localStorage.getItem(Ma());o!=null&&Zt(parseFloat(o)||0)}}catch{const n=localStorage.getItem(Ma());n!=null&&Zt(parseFloat(n)||0)}};return window.addEventListener("cashBalanceChanged",t),()=>window.removeEventListener("cashBalanceChanged",t)},[a==null?void 0:a.uid,A,v==null?void 0:v.shopId]),i.useEffect(()=>{try{if(!(a!=null&&a.uid))return;const t=A||(v==null?void 0:v.shopId);if(!t)return;const s=Le(Y,"dashboardData",t);let r=null;return r=Oa(s,n=>{if(!n.exists())return;const o=n.data(),h=Number((o==null?void 0:o.cashBalance)||0),p=o!=null&&o.walletBalances&&typeof o.walletBalances=="object"?o.walletBalances:{};Zt(h),ca(p);try{localStorage.setItem(Ma(),String(h)),localStorage.setItem(Ta(),JSON.stringify(p))}catch{}},n=>{console.warn("dashboardData subscription error:",n)}),()=>{try{r&&r()}catch{}}}catch{}},[a==null?void 0:a.uid,A,v==null?void 0:v.shopId]);const Fc=t=>`walletLimits_${(a==null?void 0:a.uid)||"default"}_${t||"none"}`;i.useEffect(()=>{if(!L)return;try{const r=Fc(L),n=localStorage.getItem(r);if(n){const o=JSON.parse(n);bl(o)}}catch{}const t=Le(Y,"walletLimits",String(L));let s=null;try{s=Oa(t,r=>{if(!r.exists())return;const n=r.data(),o={walletId:L,dailyTransferLimit:n.dailyTransferLimit??6e4,dailyWithdrawLimit:n.dailyWithdrawLimit??1e5,dailyTransferUsed:n.dailyTransferUsed??0,dailyWithdrawUsed:n.dailyWithdrawUsed??0,monthlyTransferLimit:n.monthlyTransferLimit??2e5,monthlyWithdrawLimit:n.monthlyWithdrawLimit??2e5,monthlyTransferUsed:n.monthlyTransferUsed??0,monthlyWithdrawUsed:n.monthlyWithdrawUsed??0};bl(o);try{localStorage.setItem(Fc(L),JSON.stringify(o))}catch{}})}catch{}return()=>{s&&s()}},[L]),i.useEffect(()=>{if(!L)return;const t=Je.find(s=>s.id===L);if(t!=null&&t.name){oc(String(t.name));try{localStorage.setItem(`walletName_${(a==null?void 0:a.uid)||"default"}_${L}`,String(t.name))}catch{}return}try{const s=localStorage.getItem(`walletName_${(a==null?void 0:a.uid)||"default"}_${L}`);s&&oc(String(s))}catch{}},[L,Je]);const Ul=async()=>{try{if(!L)return;const t=await is.autoResetLimitsIfNeeded(L);bl(t)}catch(t){console.error("خطأ في جلب حدود المحفظة المختارة:",t)}};i.useEffect(()=>{Ul()},[L]),i.useEffect(()=>{const t=s=>{var r;(r=s==null?void 0:s.detail)!=null&&r.walletId&&s.detail.walletId===L&&Ul()};return window.addEventListener("walletLimitsUpdated",t),()=>window.removeEventListener("walletLimitsUpdated",t)},[L]),i.useEffect(()=>{const t=s=>{var r;try{const n=String(((r=s==null?void 0:s.detail)==null?void 0:r.walletId)||"");n&&si(n,"sms:auto")}catch{}};return window.addEventListener("walletSelection:update",t),()=>window.removeEventListener("walletSelection:update",t)},[Je]),i.useEffect(()=>{if(R.state){if(console.log("Location state:",R.state),R.state.openDebtDialog&&(cl(),window.history.replaceState({},document.title)),R.state.openSalesDialog&&(It||Jt?u({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):qr(!0),window.history.replaceState({},document.title)),R.state.openMaintenanceDialog&&(It||Jt?u({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):zi(!0),window.history.replaceState({},document.title)),R.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),It||Jt?u({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ri(!0),window.history.replaceState({},document.title)),R.state.openShopExpensesDialog&&(It||Jt?u({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ia.hasMasterPin()?ce(!0):he(!0),window.history.replaceState({},document.title)),R.state.openDeficienciesDialog&&(It||Jt?u({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):wa(!0),window.history.replaceState({},document.title)),R.state.openInstallment&&(It||Jt?u({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"}):Bi(!0),window.history.replaceState({},document.title)),R.state.openTransactionSection){const t=document.getElementById("transaction-section");t&&t.scrollIntoView({behavior:"smooth"}),R.state.transactionType&&fo(R.state.transactionType),R.state.startNewTransaction&&(V(""),_e(""),Wn(""),Bn(""),console.log("🔒 Starting new transaction without changing wallet selection")),R.state.focusWalletSelection&&setTimeout(()=>{const s=document.querySelector('[data-testid="wallet-select"]');s&&s.focus()},500),window.history.replaceState({},document.title)}R.state.openCashierShiftModal&&(!ws||Jt?u({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):fe(!0),window.history.replaceState({},document.title)),R.state.openMachineDailyDialog&&(!ws||Jt?u({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):qi(!0),window.history.replaceState({},document.title))}},[R.state,Je,Jt]),i.useEffect(()=>{R.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),Wl(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",R.pathname)},[R.pathname,a==null?void 0:a.uid]),i.useEffect(()=>{if(!(a!=null&&a.uid))return;console.log("🔥 Setting up real-time user activation listener for:",a.uid);const t=Le(Y,"users",a.uid),s=Oa(t,r=>{if(r.exists()){const n=r.data(),o=n.isActive===!0;console.log("🔥 Real-time user status update:",{userId:a.uid,isActive:o,subscription:n.subscription}),o&&!na?(console.log("🎉 User activated! Redirecting to dashboard..."),Da(!0),vt(!1),ha(!1)):!o&&na&&(console.log("❌ User deactivated! Showing activation modal..."),Da(!1),vt(!0))}},r=>{console.error("❌ Error in real-time user listener:",r)});return()=>{console.log("🔥 Cleaning up real-time user listener"),s()}},[a==null?void 0:a.uid,na]),i.useEffect(()=>{if(!(a!=null&&a.uid))return;const t=r=>{const{userId:n}=r.detail;n===a.uid&&(console.log("🎉 Subscription activation event received for current user!"),Da(!0),vt(!1),ha(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},s=r=>{const{userId:n,isActive:o}=r.detail;n===a.uid&&(console.log("🔄 User subscription update event received:",{userId:n,isActive:o}),o&&!na&&(Da(!0),vt(!1),ha(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",t),window.addEventListener("userSubscriptionUpdated",s),()=>{window.removeEventListener("subscriptionActivated",t),window.removeEventListener("userSubscriptionUpdated",s)}},[a==null?void 0:a.uid,na]),i.useEffect(()=>{const t=s=>{var r;const n=s.target,o=(r=n==null?void 0:n.tagName)==null?void 0:r.toLowerCase();if(!(o==="input"||o==="textarea"||o==="select"||((n==null?void 0:n.isContentEditable)??!1))&&!(s.ctrlKey||s.altKey||s.metaKey)&&!s.repeat){if((It||Jt)&&s.key>="1"&&s.key<="9"){s.preventDefault();return}switch(s.key){case"1":break;case"2":Hn(!0);break;case"3":It||Jt?u({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ri(!0);break;case"4":ws?fe(!0):u({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"5":It||Jt?u({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):qr(!0);break;case"6":cl();break;case"7":It||Jt?u({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):zi(!0);break;case"8":ws?qi(!0):u({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"9":It||Jt?u({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ia.hasMasterPin()?ce(!0):he(!0);break}}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[It,Jt,ws]),i.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:a==null?void 0:a.uid,isCheckingActivation:ds}),(async()=>{try{if(!(a!=null&&a.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),ha(!1);return}try{const o=await Ss(Le(Y,"users",a.uid));if(o.exists()){const h=o.data().isActive===!0,p=await Jh.checkTrialValidity(a.uid),g=p.isValid&&!p.isExpired;Da(h||g),yr(g),Pn(p.hoursRemaining),_i(p.hasUsedTrial),vt(!h&&!g),console.log("📊 حالة المستخدم:",{isActive:h,isOnTrial:g,hoursRemaining:p.hoursRemaining,hasUsedTrial:p.hasUsedTrial})}else Da(!1),vt(!0)}catch(o){console.error("خطأ في فحص حالة تفعيل المستخدم:",o),Da(!1),vt(!0)}finally{ha(!1)}if(console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:a==null?void 0:a.uid}),a!=null&&a.uid){const o=await Er(()=>je.getUserData(a.uid));if(o){const h=(o==null?void 0:o.walletBalances)||{};ca(h),(o==null?void 0:o.cashBalance)!==void 0&&Zt(o.cashBalance);try{const p=a!=null&&a.uid?await Er(()=>di.getDeletedTransactionsByUser(a.uid)):[];Ir(p||[])}catch{Ir([])}}else{ca({});try{const h=a!=null&&a.uid?await di.getDeletedTransactionsByUser(a.uid):[];Ir(h||[])}catch{Ir([])}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const o=await Er(()=>fs.getByMerchantId((a==null?void 0:a.uid)||""));if(o&&o.length>0){console.log("✅ تم العثور على محافظ في Firebase:",o.length);const h=o.filter(w=>w.isActive===!0).map(w=>({id:w.id,name:w.label||"محفظة بدون اسم",phone:w.msisdn,isDefault:!1,monthlyWithdrawalLimit:w.monthlyWithdrawalLimit??w.withdrawLimit??2e5,monthlyTransferLimit:w.monthlyTransferLimit??w.transferLimit??2e5,defaultTransferCommission:w.defaultTransferCommission!=null?Number(w.defaultTransferCommission):null,defaultWithdrawCommission:w.defaultWithdrawCommission!=null?Number(w.defaultWithdrawCommission):null}));Sr(h);const p=localStorage.getItem(Or());let g=null;p&&h.find(w=>w.id===p)?g=h.find(w=>w.id===p):g=h[0],g&&(rt(g.id),O(g.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else console.log("⚠️ لا توجد محافظ في Firebase. سيتم عرض قائمة فارغة بدون أي استرجاع محلي."),Sr([])}catch(o){console.error("خطأ في تحميل المحافظ من Firebase:",o),Sr([])}const n=a!=null&&a.uid?await Er(()=>je.getUserTransactions(a.uid)):[];if(n&&n.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",n.length);const o=n.map(y=>({...y,createdAt:new Date(y.createdAt),senderPhone:y.senderMsisdn||y.senderPhone||"",receiverPhone:y.receiverMsisdn||y.receiverPhone||"",type:y.txnType==="send"?"send":y.txnType==="receive"?"withdraw":y.type||"withdraw",status:y.status==="confirmed"?"completed":y.status||"completed"})),h=Yr.map(y=>y.id||y.originalTransactionId);let p=[];try{const y=Ve(Ae(Y,"deletedTransactions"),me("userId","==",(a==null?void 0:a.uid)||""),me("permanent","==",!0));p=(await et(y)).docs.map(N=>{const _=N.data();return String(_.originalTransactionId||_.transactionId||N.id||"")}).filter(Boolean)}catch{}const g=new Set(p),w=o.filter(y=>{var N;const _=String(y.id||""),I=String(y.transactionId||""),k=String(y.reference||y.transactionReference||((N=y.receipt)==null?void 0:N.reference)||""),W=h.includes(_),ie=g.has(_)||I&&g.has(I);return!W&&!ie});console.log("✅ تم فلترة المعاملات المحذوفة:",{total:n.length,deleted:h.length,active:w.length});{const y=I=>{var k;return String((I==null?void 0:I.transactionId)||(I==null?void 0:I.id)||`${(I==null?void 0:I.transactionReference)||((k=I==null?void 0:I.receipt)==null?void 0:k.reference)||"ref"}-${new Date((I==null?void 0:I.createdAt)||0).getTime()}`)},N=new Set,_=[];for(const I of w){const k=y(I);N.has(k)||(N.add(k),_.push(I))}jo||bs(_)}}await Tc()}catch(n){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",n)}})().then(async()=>{await r(),await t(),await s()});const t=async()=>{try{if(!(a!=null&&a.uid))return;const n=await fs.getByMerchantId(a.uid);await Promise.all(n.map(o=>C0.autoResetLimitsIfNeeded(o.id)))}catch(n){console.error("خطأ في التصفير التلقائي للحدود:",n)}},s=async()=>{try{await ja.syncReportsDataFromFirebase(a==null?void 0:a.uid);const n=ja.getReportsData(a==null?void 0:a.uid);if(n.lastDailyResetDate&&ja.shouldResetDailyReports(n.lastDailyResetDate)&&a!=null&&a.uid&&n.lastDailyResetDate){const h=new Date(n.lastDailyResetDate),p=h.toDateString(),g=Ze.filter(W=>new Date(W.createdAt).toDateString()===p&&W.status==="completed"),w=g.length,y=g.reduce((W,ie)=>W+ie.amount,0),N=g.filter(ri).reduce((W,ie)=>{const J=ie.withdrawnAmount!==void 0?ie.withdrawnAmount:ie.amount;return W+J},0),_=g.filter(ii).reduce((W,ie)=>{const J=ie.sentAmount!==void 0?ie.sentAmount:ie.amount;return W+J},0),I=g.reduce((W,ie)=>W+ja.calculateTransactionProfit(ie),0),k=new Date(h).toISOString().slice(0,10);await ci.add({userId:a.uid,reportDate:k,totalTransactions:w,totalAmount:Number(y.toFixed(2)),totalWithdrawn:Number(N.toFixed(2)),totalSent:Number(_.toFixed(2)),profit:Number(I.toFixed(2)),walletId:null})}const o=ja.autoResetReportsIfNeeded(a==null?void 0:a.uid);(o.dailyReset||o.monthlyReset)&&console.log("تم التصفير التلقائي:",o)}catch(n){console.error("خطأ في التصفير التلقائي للتقارير:",n)}},r=async()=>{try{if(!(a!=null&&a.uid))return;const n=new Date;if(n.getDate()!==1)return;const o=`${n.getFullYear()}-${n.getMonth()+1}`,h=`lastMonthlyDbCleanup:${a.uid}`;if(localStorage.getItem(h)===o)return;const p=new Date(n.getFullYear(),n.getMonth(),1,0,0,0,0),g=N=>N instanceof Date?N:typeof(N==null?void 0:N.toDate)=="function"?N.toDate():new Date(String(N));let w=[];try{const N=Ve(Ae(Y,"userTransactions"),me("userId","==",a.uid),me("createdAt","<",p));w=(await et(N)).docs}catch{const N=Ve(Ae(Y,"userTransactions"),me("userId","==",a.uid));w=(await et(N)).docs.filter(_=>{var I;return g((I=_.data())==null?void 0:I.createdAt)<p})}await Promise.allSettled(w.map(N=>Ea(N.ref)));let y=[];try{const N=Ve(Ae(Y,"transactions"),me("userId","==",a.uid),me("createdAt","<",p));y=(await et(N)).docs}catch{const N=Ve(Ae(Y,"transactions"),me("userId","==",a.uid));y=(await et(N)).docs.filter(_=>{var I;return g((I=_.data())==null?void 0:I.createdAt)<p})}await Promise.allSettled(y.map(N=>Ea(N.ref)));try{localStorage.setItem(h,o)}catch{}console.log("✅ تم تنظيف قاعدة البيانات شهريًا (Firebase فقط):",{userTransactionsDeleted:w.length,globalTransactionsDeleted:y.length,monthStart:p})}catch(n){console.error("فشل التنظيف الشهري التلقائي لقاعدة البيانات:",n)}};nu(),cc(),bu(),console.log("🔥 useEffect loadUserData completed")},[a==null?void 0:a.uid]);const Wl=async()=>{var t;if(a!=null&&a.uid)try{const s=await Er(()=>fs.getByMerchantId(a.uid));if(s&&s.length>0){const r=s.filter(n=>n.isActive===!0).map(n=>({id:n.id,name:n.label||"محفظة بدون اسم",phone:n.msisdn,isDefault:!1,monthlyWithdrawalLimit:n.monthlyWithdrawalLimit??n.withdrawLimit??2e5,monthlyTransferLimit:n.monthlyTransferLimit??n.transferLimit??2e5,defaultTransferCommission:n.defaultTransferCommission!=null?Number(n.defaultTransferCommission):void 0,defaultWithdrawCommission:n.defaultWithdrawCommission!=null?Number(n.defaultWithdrawCommission):void 0}));if(Sr(r),a!=null&&a.uid){const n=localStorage.getItem(Or());if(L&&r.find(o=>o.id===L))console.log("🔒 Preserving current wallet selection:",L);else{const o=(n&&r.find(h=>h.id===n)?n:null)||((t=r[0])==null?void 0:t.id);o&&(console.log("🔄 Fixing invalid wallet selection:",o),si(o))}}console.log("🔄 تم تحديث المحافظ من Firebase:",r.length)}}catch(s){console.error("خطأ في تحميل المحافظ من Firebase:",s)}};i.useEffect(()=>{const t=R.pathname;if(sessionStorage.getItem("previousPath")==="/user/add-wallet"&&t==="/user/dashboard"){ae.invalidateQueries({queryKey:["wallets",a==null?void 0:a.uid]});try{Li.refetch()}catch{}sessionStorage.removeItem("previousPath")}sessionStorage.setItem("previousPath",t)},[R.pathname,a==null?void 0:a.uid]),i.useEffect(()=>{const t=()=>{ae.invalidateQueries({queryKey:["wallets",a==null?void 0:a.uid]});try{Li.refetch()}catch{}};return window.addEventListener("focus",t),()=>{window.removeEventListener("focus",t)}},[a==null?void 0:a.uid,L,Je]);const si=async(t,s="unknown")=>{console.log(`🎯 setWalletSelection called from ${s} with walletId:`,t),console.log("🔍 Previous selectedWallet:",L),rt(t);const r=Je.find(n=>n.id===t);if(r&&(O(r.phone),console.log("✅ Wallet set successfully:",t,"Phone:",r.phone)),a!=null&&a.uid){localStorage.setItem(Or(),t),console.log("💾 Saved wallet to localStorage:",t);try{await oi.set({key:"selected_wallet_id",value:t}),await oi.set({key:"current_user_id",value:a.uid}),console.log("📱 Saved wallet and user ID to Capacitor Preferences:",t,a.uid)}catch(n){console.error("❌ Failed to save to Capacitor Preferences:",n)}}};i.useEffect(()=>{const t=()=>{Wl()};try{window.addEventListener("wallets:activation-updated",t)}catch{}return()=>{try{window.removeEventListener("wallets:activation-updated",t)}catch{}}},[a==null?void 0:a.uid]);const Uu=t=>{if(t==="__add_wallet"){E("/user/add-wallet");return}if(t==="__view_wallets"){Oi(!0);return}Vh.isEnabled(a==null?void 0:a.uid)?(Un(t),Mn(!0)):si(t,"walletSelectionNoPin")},bn=t=>{console.log("🔄 handleTransactionTypeChange called with type:",t),console.log("🔍 Current selectedWallet before change:",L),console.log("🔍 Available wallets count:",Je.length),fo(t),V(""),_e(""),Wn(""),Bn(""),console.log("✅ Transaction type changed to:",t,"- Wallet selection preserved:",L),setTimeout(()=>{const s=document.getElementById("transaction-section");s&&s.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)};i.useEffect(()=>{const t=s=>{const r=s.target;if(r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"||r.tagName==="SELECT"||r.isContentEditable)||(s.key==="ArrowLeft"?(s.preventDefault(),bn("withdraw")):s.key==="ArrowRight"&&(s.preventDefault(),bn("transfer"))),s.key==="Enter"){const n=le==="transfer"?"transferSubmitButton":"withdrawSubmitButton",o=document.getElementById(n);o&&!o.disabled&&(s.preventDefault(),o.click())}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[le]);const Lc=t=>{fm((s=>({id:s.id,type:s.type==="send"?"transfer":"withdraw",sender_msisdn:s.senderPhone,receiver_msisdn:s.receiverPhone,amount:s.amount,commission:s.commission||0,fee:(s==null?void 0:s.fee)??0,status:s.status==="failed"?"failed":s.status==="completed"?"completed":"pending",createdAt:new Date(s.createdAt).toISOString(),updatedAt:new Date(s.createdAt).toISOString(),shopName:U??(v==null?void 0:v.shopName)??(a==null?void 0:a.displayName)??"المحل",cashierName:(s==null?void 0:s.cashierName)??null,commissionMode:(s==null?void 0:s.commissionMode)??(s.type==="send"||wt?"add":"deduct"),totalCharged:(s==null?void 0:s.totalCharged)??(s.type==="send"?Number(s.amount||0)+Number(s.commission||0)+Number((s==null?void 0:s.fee)||0):wt?Number(s.amount||0)+Number(s.commission||0):Number(s.amount||0)),note:(s==null?void 0:s.note)??(s==null?void 0:s.notes)??void 0,senderName:(s==null?void 0:s.senderName)??void 0}))(t)),Mi(!0)},Wu=async t=>{var s;if(!(a!=null&&a.uid)){u({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const r=Ze.find(h=>h.id===t);if(!r){u({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}const n=String(t),o=String((r==null?void 0:r.transactionId)||(r==null?void 0:r.reference)||"");Ws.current.add(n),o&&Ws.current.add(o);try{console.log("🗑️ بدء عملية حذف المعاملة:",t),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:r.id,userId:a.uid,transactionData:r}),await je.removeUserTransaction(a.uid,r.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await di.saveDeletedTransaction({...r,userId:a.uid,originalTransactionId:r.id,transactionId:r.transactionId||r.id,reference:r.reference||r.transactionReference||((s=r.receipt)==null?void 0:s.reference),deletedAt:new Date().toISOString(),permanent:!0}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(g){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",g)}try{await di.permanentlyDeleteTransaction(r.id,a.uid)}catch(g){console.warn("⚠️ فشل وسم الحذف النهائي أو التنظيف الإضافي:",g)}const h=[...Yr,r],p=Ze.filter(g=>g.id!==t);Ir(h),bs(p),wo(!1),console.log("✅ تم تحديث الحالة بعد الحذف من Firebase (بدون نسخ محلية)");try{const g=r.fromWallet;if(g){const{walletDailyLimitsService:w}=await ht(async()=>{const{walletDailyLimitsService:N}=await ft(()=>import("./index-C_crvORM.js").then(_=>_.c3),__vite__mapDeps([0,1]),import.meta.url).then(_=>_.c8);return{walletDailyLimitsService:N}},xt([0,1]),import.meta.url),y=await w.getWalletLimits(g);if(y){const N=r.type==="send",_={updatedAt:(await ht(async()=>{const{serverTimestamp:J}=await ft(()=>import("./index-C_crvORM.js").then(ve=>ve.c3),__vite__mapDeps([0,1]),import.meta.url).then(ve=>ve.c2);return{serverTimestamp:J}},xt([0,1]),import.meta.url)).serverTimestamp()};N?(_.dailyTransferUsed=Math.max(0,(y.dailyTransferUsed||0)-r.amount),_.monthlyTransferUsed=Math.max(0,(y.monthlyTransferUsed||0)-r.amount)):(_.dailyWithdrawUsed=Math.max(0,(y.dailyWithdrawUsed||0)-r.amount),_.monthlyWithdrawUsed=Math.max(0,(y.monthlyWithdrawUsed||0)-r.amount));const{doc:I,setDoc:k}=await ht(async()=>{const{doc:J,setDoc:ve}=await ft(()=>import("./index-C_crvORM.js").then(Ye=>Ye.c3),__vite__mapDeps([0,1]),import.meta.url).then(Ye=>Ye.c2);return{doc:J,setDoc:ve}},xt([0,1]),import.meta.url),{db:W}=await ht(async()=>{const{db:J}=await ft(()=>import("./index-C_crvORM.js").then(ve=>ve.c3),__vite__mapDeps([0,1]),import.meta.url).then(ve=>ve.c3);return{db:J}},xt([0,1]),import.meta.url),ie=I(W,"walletLimits",g);await k(ie,_,{merge:!0})}}}catch(g){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",g)}try{const{ProfitService:g}=await ht(async()=>{const{ProfitService:_}=await ft(()=>import("./profitService-4r9FqAF7-CduXHB_-.js"),__vite__mapDeps([3,0,1]),import.meta.url);return{ProfitService:_}},xt([3,0,1]),import.meta.url),{ReportsService:w}=await ht(async()=>{const{ReportsService:_}=await ft(()=>import("./index-C_crvORM.js").then(I=>I.c3),__vite__mapDeps([0,1]),import.meta.url).then(I=>I.c7);return{ReportsService:_}},xt([0,1]),import.meta.url),y={txnType:r.type==="send"?"send":"receive",amount:r.amount,commission:r.commission||0,createdAt:r.createdAt,status:"confirmed"},N=g.calculateProfitFromTransaction(y);N>0&&g.addProfit(-N,a.uid);try{w.removeTransactionEffects(r,a.uid)}catch{}}catch(g){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",g)}u({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(h){console.error("❌ خطأ في حذف المعاملة من Firebase:",h);let p="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";h instanceof Error&&(h.message.includes("network")||h.message.includes("offline")?p="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":h.message.includes("permission")||h.message.includes("unauthorized")?p="ليس لديك صلاحية لحذف هذه المعاملة":h.message.includes("not-found")&&(p="المعاملة غير موجودة أو تم حذفها مسبقاً")),u({title:"خطأ في الحذف",description:p,variant:"destructive"})}},ri=t=>{const s=t.type,r=t.txnType;return s==="withdraw"||s==="withdrawal"||s==="receive"||r==="receive"},ii=t=>{const s=t.type,r=t.txnType;return s==="send"||s==="transfer"||r==="send"},ni=(t,s)=>{const r=new Date().toDateString();let n=Ze.filter(y=>{const N=new Date(y.createdAt).toDateString()===r,_=String(y.status||"").toLowerCase();return N&&(_==="completed"||_==="confirmed"||_==="pending")});_s&&_s.trim()!==""&&(n=n.filter(y=>y.senderPhone&&y.senderPhone.includes(_s)||y.receiverPhone&&y.receiverPhone.includes(_s)));const o=ja.filterVisibleTransactions(n,"daily",a==null?void 0:a.uid),h=o.length,p=o.reduce((y,N)=>y+N.amount,0),g=o.filter(ri).reduce((y,N)=>{const _=N.withdrawnAmount!==void 0?N.withdrawnAmount:N.amount;return y+_},0),w=o.filter(ii).reduce((y,N)=>{const _=N.sentAmount!==void 0?N.sentAmount:N.amount;return y+_},0);return{totalTransactions:h,totalAmount:p,totalWithdrawn:g,totalSent:w}},li=t=>{const s=new Date().getMonth(),r=new Date().getFullYear();let n=Ze.filter(y=>{const N=new Date(y.createdAt);return N.getMonth()===s&&N.getFullYear()===r&&y.status==="completed"});_s&&_s.trim()!==""&&(n=n.filter(y=>y.senderPhone&&y.senderPhone.includes(_s)||y.receiverPhone&&y.receiverPhone.includes(_s)));const o=ja.filterVisibleTransactions(n,"monthly",a==null?void 0:a.uid),h=o.length,p=o.reduce((y,N)=>y+N.amount,0),g=o.filter(ri).reduce((y,N)=>{const _=N.withdrawnAmount!==void 0?N.withdrawnAmount:N.amount;return y+_},0),w=o.filter(ii).reduce((y,N)=>{const _=N.sentAmount!==void 0?N.sentAmount:N.amount;return y+_},0);return{totalTransactions:h,totalAmount:p,totalWithdrawn:g,totalSent:w}},Bu=t=>{const s=new Date().getMonth(),r=new Date().getFullYear(),n=Ze.filter(p=>{const g=new Date(p.createdAt);return g.getMonth()===s&&g.getFullYear()===r&&p.status==="completed"&&p.fromWallet===t}),o=n.filter(ri).reduce((p,g)=>{const w=g.withdrawnAmount||g.amount;return p+w},0),h=n.filter(ii).reduce((p,g)=>{const w=g.sentAmount||g.amount;return p+w},0);return{totalWithdrawn:o,totalTransferred:h}},Ru=t=>{const s=new Date,r=s.getDate(),n=s.getMonth(),o=s.getFullYear(),h=Ze.filter(w=>{const y=new Date(w.createdAt);return y.getDate()===r&&y.getMonth()===n&&y.getFullYear()===o&&w.status==="completed"&&w.fromWallet===t}),p=h.filter(ri).reduce((w,y)=>{const N=y.withdrawnAmount||y.amount;return w+N},0),g=h.filter(ii).reduce((w,y)=>{const N=y.sentAmount||y.amount;return w+N},0);return{totalWithdrawn:p,totalTransferred:g}},Mc=Ge.useMemo(()=>li(),[Ze,L,_s]);Mc.totalWithdrawn,Mc.totalSent;const dr=Ge.useMemo(()=>Bu(L),[Ze,L]);i.useEffect(()=>{try{if(!L||Je.length===0)return;const t=Je.find(k=>k.id===L);if(!t)return;const s=(kt==null?void 0:kt.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,r=(kt==null?void 0:kt.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,n=parseFloat(de||"0")||0,o=(dr==null?void 0:dr.totalWithdrawn)??(kt==null?void 0:kt.monthlyWithdrawUsed)??0,h=(dr==null?void 0:dr.totalTransferred)??(kt==null?void 0:kt.monthlyTransferUsed)??0,p=o+(le==="withdraw"?n:0),g=h+(le==="transfer"?n:0),w=.85,y=Math.floor(Math.max(s,1)*w),N=Math.floor(Math.max(r,1)*w),_=(()=>{const k=new Date;return`${k.getFullYear()}-${String(k.getMonth()+1).padStart(2,"0")}`})(),I=`monthlyLimitWarnShown:${L}:${_}`;if(p>=y){const k=`${I}:withdraw`;if(localStorage.getItem(k)!=="true"){go({type:"withdraw",used:p,limit:s,walletName:t.name}),Ei(!0);try{localStorage.setItem(k,"true")}catch{}return}}if(g>=N){const k=`${I}:transfer`;if(localStorage.getItem(k)!=="true"){go({type:"transfer",used:g,limit:r,walletName:t.name}),Ei(!0);try{localStorage.setItem(k,"true")}catch{}return}}}catch{}},[L,Je,kt,dr,le,de]);const Uc=async()=>{var t,s,r,n;ix(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:C,receiverPhone:G,amount:de,transactionType:le});const o=()=>{le==="transfer"?Cr(!0):Vr(!0)},h=()=>{le==="transfer"?Cr(!1):Vr(!1)};if(o(),!C||!de){console.log("❌ خطأ: بيانات ناقصة"),u({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),h();return}if(le==="transfer"&&!G&&!P){console.log("❌ خطأ: رقم المستقبل مفقود"),u({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),h();return}if(le==="transfer"&&!P&&(String(G||"").replace(/[^0-9٠-٩]/g,""),!/[^0-9٠-٩\s]/.test(String(G||""))&&!nx(G))){u({title:"رقم المستقبل غير صالح",description:"اكتب رقم صحيح مكون من 11 رقم ويبدأ بـ 015 أو 010 أو 012 أو 011",variant:"destructive"}),h();return}const p=parseFloat(de);if(console.log("💰 المبلغ المحول:",p),p<=0){console.log("❌ خطأ: مبلغ غير صحيح"),u({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),h();return}if(It)try{const Fe=new Date,gt=Fe.getFullYear(),Mt=String(Fe.getMonth()+1).padStart(2,"0"),ra=String(Fe.getDate()).padStart(2,"0"),Ba=`zeroPlanDailyConfirmCount:${(a==null?void 0:a.uid)||"default"}:${gt}-${Mt}-${ra}`,$a=localStorage.getItem(Ba);if(($a&&parseInt($a,10)||0)>=10){u({title:"حد التأكيد اليومي",description:"باقة زيرو تسمح بـ 10 تأكيدات تحويل/سحب يومياً فقط.",variant:"destructive"}),h();return}}catch(Fe){console.warn("فشل قراءة عداد تأكيدات باقة زيرو من التخزين المحلي:",Fe)}const g=Je.find(Fe=>Fe.id===L);if(!g){u({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),h();return}const w=dr;if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:L,walletName:g.name,currentWithdrawn:w.totalWithdrawn,currentTransferred:w.totalTransferred,withdrawalLimit:g.monthlyWithdrawalLimit,transferLimit:g.monthlyTransferLimit}),le==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${w.totalWithdrawn}, المبلغ الجديد: ${p}, الحد الأقصى: ${g.monthlyWithdrawalLimit}`),w.totalWithdrawn+p>g.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),u({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${g.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${g.name}`,variant:"destructive"}),h();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${w.totalTransferred}, المبلغ الجديد: ${p}, الحد الأقصى: ${g.monthlyTransferLimit}`),w.totalTransferred+p>g.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),u({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${g.monthlyTransferLimit} جنيه شهرياً من محفظة ${g.name}`,variant:"destructive"}),h();return}const y=(v==null?void 0:v.shopName)||(a==null?void 0:a.displayName)||"محل كاشي لينك",N={id:Date.now().toString(),type:le==="transfer"?"send":le==="deposit"?"deposit":"withdraw",senderPhone:C,receiverPhone:le==="transfer"?G:C,amount:p,status:"completed",createdAt:new Date,withdrawnAmount:le==="withdraw"?p:void 0,sentAmount:le==="transfer"?p:void 0,depositedAmount:void 0,fromWallet:L,senderNumber:C,senderName:le==="withdraw"&&Re.trim()!==""?Re.trim():void 0,shopName:(g==null?void 0:g.name)||"المحفظة الرئيسية",transferredAmount:le==="transfer"?p:void 0,receiverNumber:le==="transfer"?G:void 0,withdrawnAmountDetailed:le==="withdraw"?p:void 0,depositedAmountDetailed:void 0,merchantShopName:y,transactionReference:`TXN-${Date.now()}`,commission:0,notes:le==="transfer"?void 0:Ee&&Ee.trim()!==""?Ee.trim():void 0};te&&(Q!=null&&Q.name||Q!=null&&Q.username)&&(N.cashierName=(Q==null?void 0:Q.name)||(Q==null?void 0:Q.username));const _=Wr.validateTransaction(p,le,$t,lt);if(!_.isValid){u({title:"خطأ في العملية",description:_.error,variant:"destructive"}),h();return}_.warning&&u({title:"تحذير",description:_.warning,variant:"destructive"});let I;if(le==="transfer")if((g==null?void 0:g.defaultTransferCommission)!=null){const Fe=Number(g.defaultTransferCommission)||0;I=Math.round(Fe*p/1e3*100)/100}else pa&&pa.trim()!==""?I=Math.max(0,parseFloat(pa)):I=0;else if((g==null?void 0:g.defaultWithdrawCommission)!=null){const Fe=Number(g.defaultWithdrawCommission)||0;I=Math.round(Fe*p/1e3*100)/100}else xa&&xa.trim()!==""?I=Math.max(0,parseFloat(xa)):I=Math.round(p*.01*100)/100;if(N.commission=I,le!=="transfer"&&!wt&&I>=p){u({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),h();return}const k=le==="transfer"||wt?p:Math.round((p-I)*100)/100;N.amount=k,N.withdrawnAmount=le==="withdraw"?k:void 0,N.sentAmount=le==="transfer"?k:void 0,N.transferredAmount=le==="transfer"?k:void 0,N.withdrawnAmountDetailed=le==="withdraw"?k:void 0;let W;const ie=le==="transfer"&&!!Va,J=le==="withdraw"&&!!Va,ve=ie||J;let Ye=null;const Xa=Pi(C||"").replace(/\D/g,""),fa=Pi(G||"").replace(/\D/g,""),zs=le==="transfer"&&(Xa.startsWith("010")&&(fa.startsWith("011")||fa.startsWith("012")||fa.startsWith("015"))||Xa.startsWith("012")&&fa.startsWith("010")||Xa.startsWith("011")&&fa.startsWith("010")||Xa.startsWith("015")&&fa.startsWith("010")),Yt=zs?Math.max(0,parseFloat(po||"0")):0,Za=Math.round(I*100)/100;if(N.commission=Za,N.fee=Yt,N.totalCharged=le==="transfer"?Number(k)+Number(Za)+Number(Yt):wt?Number(k)+Number(Za):Number(k),zs&&!ve&&Yt<=0){u({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"}),h();return}if(le==="transfer"&&!ve){const Fe=Number(lt[L]||0),gt=Number(k)+Number(Yt);if(Fe<gt){u({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${Fe} لا يكفي لخصم ${gt}`,variant:"destructive"}),h();return}}if(ve)if(ie){const Fe=Wr.validateTransaction(k,"transfer",$t,lt);if(!Fe.isValid)W={success:!1,newCashBalance:$t,newWalletBalances:lt,message:Fe.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"};else{const gt=L||((t=Je.find(Et=>Et.isDefault))==null?void 0:t.id)||((s=Je[0])==null?void 0:s.id),Mt=kt??await is.getWalletLimits(gt),ra=new Date().toDateString(),Ba=Ze.filter(Et=>Et.type==="send"&&String(Et.status||"").toLowerCase()==="pending"&&Et.fromWallet===gt&&new Date(Et.createdAt).toDateString()===ra).reduce((Et,js)=>Et+Number(js.sentAmount??js.transferredAmount??js.amount??0),0),$a=Number((Mt==null?void 0:Mt.dailyTransferLimit)??6e4),rs=Number((Mt==null?void 0:Mt.dailyTransferUsed)??0);if(rs+Ba+Number(k)>$a){u({title:"تجاوز الحد اليومي للتحويل",description:`المتبقي اليوم: ${($a-rs-Ba).toLocaleString()} ج.م`,variant:"destructive"}),h();return}const Ns=new Date,qs=Ze.filter(Et=>Et.type==="send"&&String(Et.status||"").toLowerCase()==="pending"&&Et.fromWallet===gt&&new Date(Et.createdAt).getMonth()===Ns.getMonth()&&new Date(Et.createdAt).getFullYear()===Ns.getFullYear()).reduce((Et,js)=>Et+Number(js.sentAmount??js.transferredAmount??js.amount??0),0),Ts=Number((Mt==null?void 0:Mt.monthlyTransferLimit)??2e5),Ht=Number((Mt==null?void 0:Mt.monthlyTransferUsed)??0);if(Ht+qs+Number(k)>Ts){u({title:"تجاوز الحد الشهري للتحويل",description:`المتبقي هذا الشهر: ${(Ts-Ht-qs).toLocaleString()} ج.م`,variant:"destructive"}),h();return}W={success:!0,newCashBalance:$t,newWalletBalances:lt}}}else{const Fe=L||((r=Je.find(Ht=>Ht.isDefault))==null?void 0:r.id)||((n=Je[0])==null?void 0:n.id),gt=kt??await is.getWalletLimits(Fe),Mt=new Date().toDateString(),ra=Ze.filter(Ht=>Ht.type==="withdraw"&&String(Ht.status||"").toLowerCase()==="pending"&&Ht.fromWallet===Fe&&new Date(Ht.createdAt).toDateString()===Mt).reduce((Ht,Et)=>Ht+Number(Et.withdrawnAmount??Et.amount??0),0),Ba=Number((gt==null?void 0:gt.dailyWithdrawLimit)??1e5),$a=Number((gt==null?void 0:gt.dailyWithdrawUsed)??0);if($a+ra+Number(k)>Ba){u({title:"تجاوز الحد اليومي للسحب",description:`المتبقي اليوم: ${(Ba-$a-ra).toLocaleString()} ج.م`,variant:"destructive"}),h();return}const rs=new Date,Ns=Ze.filter(Ht=>Ht.type==="withdraw"&&String(Ht.status||"").toLowerCase()==="pending"&&Ht.fromWallet===Fe&&new Date(Ht.createdAt).getMonth()===rs.getMonth()&&new Date(Ht.createdAt).getFullYear()===rs.getFullYear()).reduce((Ht,Et)=>Ht+Number(Et.withdrawnAmount??Et.amount??0),0),qs=Number((gt==null?void 0:gt.monthlyWithdrawLimit)??2e5),Ts=Number((gt==null?void 0:gt.monthlyWithdrawUsed)??0);if(Ts+Ns+Number(k)>qs){u({title:"تجاوز الحد الشهري للسحب",description:`المتبقي هذا الشهر: ${(qs-Ts-Ns).toLocaleString()} ج.م`,variant:"destructive"}),h();return}W={success:!0,newCashBalance:Math.round((Number($t)-Number(k))*100)/100,newWalletBalances:lt}}else le==="transfer"?W=await Wr.processTransfer({amount:k,currentCashBalance:$t,currentWalletBalances:lt,wallets:Je,selectedWalletId:L,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0}):W=await Wr.processWithdraw({amount:k,currentCashBalance:$t,currentWalletBalances:lt,wallets:Je,selectedWalletId:L,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0});if(!W.success){u({title:"فشل في العملية",description:W.error||W.message,variant:"destructive"}),h();return}let Wa=ve?J?W.newCashBalance:$t:W.newCashBalance,es=ve?lt:W.newWalletBalances;if(!ve&&le==="transfer"&&Yt>0){const Fe=Number(es[L]||0);es={...es,[L]:Math.round((Fe-Number(Yt))*100)/100}}if(ve&&ie){const Fe=Je.find(ra=>ra.id===L)??Je.find(ra=>ra.isDefault)??Je[0],gt=(Fe==null?void 0:Fe.id)||L;if(gt!==L)try{si(gt)}catch{}const Mt=Number(lt[gt]||0);es={...lt,[gt]:Math.round((Mt-Number(k)-Number(Yt))*100)/100}}if((ie||J)&&Va&&!Ti){const Fe={id:`DEBT-${Date.now()}`,debtorName:Va.debtorName,amount:Va.amount,reason:Va.notes||"",customerId:Va.customerId,mobile:Va.mobile,status:"pending",createdAt:new Date};Ye=Fe.id;const gt=[Fe,...St];ga(gt);try{await Qa(gt)}catch(Mt){console.error("⚠️ فشل حفظ الدين المؤجل محلياً:",Mt)}u({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}if(!ve){const Fe=Math.max(0,Number(I))+Math.max(0,Number(Yt));Fe>0&&(Wa=Math.round((Wa+Fe)*100)/100,console.log(`💰 تم إضافة عمولة/رسوم ${Fe} جنيه لدرج النقدية`))}console.log("⚡ تحديث الواجهة فوراً بدون حجب باستخدام startTransition...");const Bc=[N,...Ze];Ge.startTransition(()=>{Zt(Wa),ca(es),ve&&(N.status="pending"),bs(Bc)});try{setTimeout(()=>{try{localStorage.setItem(Tl(),JSON.stringify(Bc))}catch{}},0)}catch{}if(It)try{const Fe=new Date,gt=Fe.getFullYear(),Mt=String(Fe.getMonth()+1).padStart(2,"0"),ra=String(Fe.getDate()).padStart(2,"0"),Ba=`zeroPlanDailyConfirmCount:${(a==null?void 0:a.uid)||"default"}:${gt}-${Mt}-${ra}`,$a=localStorage.getItem(Ba),rs=$a&&parseInt($a,10)||0;localStorage.setItem(Ba,String(rs+1))}catch{}setTimeout(()=>{try{localStorage.setItem(Ma(),Wa.toString()),localStorage.setItem(Ta(),JSON.stringify(es))}catch{}},0);try{if(a!=null&&a.uid){const Fe=Je.find(Pr=>Pr.id===L)??Je.find(Pr=>Pr.isDefault)??Je[0],gt=(Fe==null?void 0:Fe.id)||L,Mt=Number(es[gt]||0),ra=String((Fe==null?void 0:Fe.phone)||C||"").trim(),Ba=String(G||"").trim(),$a=Number(Yt)>0,rs=le==="transfer"?"🟢":"🔴",Ns=Number(Za)>0?`${Number(Za)} جنيه`:"0 جنيه",qs=$a?` و رسوم ${Number(Yt)} جنيه`:"",Ts=le==="transfer"?`${rs} تم تحويل مبلغ ${Number(k)} جنيه من رقم المحفظة ${ra} إلى رقم المحفظة ${Ba} وتم أخذ عمولة ${Ns}${qs}. الرصيد المتبقي في المحفظة: ${Mt} جنيه. الفلوس النقدية المتبقية: ${Number(Wa)} جنيه.`:`${rs} تم السحب مبلغ ${Number(k)} جنيه من الدرج إلى رقم المحفظة ${ra} وتم أخذ عمولة ${Ns}${qs}. الرصيد المتبقي في المحفظة: ${Mt} جنيه. الفلوس النقدية المتبقية: ${Number(Wa)} جنيه.`,Ht=a!=null&&a.uid?`tg_last_msg_${a.uid}`:"tg_last_msg",Et=Date.now();let js=!0;try{const Pr=localStorage.getItem(Ht);if(Pr){const Nn=JSON.parse(Pr),Qu=String((Nn==null?void 0:Nn.text)||""),Xu=Number((Nn==null?void 0:Nn.at)||0);Qu===Ts&&Et-Xu<5e3&&(js=!1)}}catch{}if(js){Promise.resolve(xr.send(a.uid,Ts)).catch(()=>{});try{localStorage.setItem(Ht,JSON.stringify({text:Ts,at:Et}))}catch{}}}}catch{}if((async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const Fe={shopId:A||(v==null?void 0:v.shopId)||(a==null?void 0:a.uid)||"default-shop",lineId:L||"default-line",walletId:L||void 0,merchantUserId:(a==null?void 0:a.uid)||null,provider:"vodafone_cash",txnType:le==="transfer"?"send":"receive",originType:le==="transfer"?"transfer":"withdraw",amount:k,commission:Za,fee:Yt,profit:0,senderMsisdn:C,receiverMsisdn:le==="transfer"?G:C,note:le==="transfer"?void 0:Ee&&Ee.trim()!==""?Ee.trim():void 0,status:ve?"pending":"confirmed",linkedDebtId:Ye||void 0,createdBy:(a==null?void 0:a.uid)||null,walletEffectAppliedOnCreation:!1,cashEffectAppliedOnCreation:!!(ve&&J),limitsReservedOnCreation:!!ve,limitReservedType:le==="transfer"?"transfer":"withdraw",profitAddedOnCreation:!1},gt={...Fe,status:ve?"pending":"completed",commissionMode:le==="transfer"||wt?"add":"deduct",totalCharged:le==="transfer"?k+Za+Yt:wt?k+I:k,walletEffectAppliedOnCreation:!1,cashEffectAppliedOnCreation:!!(ve&&J),limitsReservedOnCreation:!!ve,limitReservedType:le==="transfer"?"transfer":"withdraw",sentAmount:le==="transfer"?k:void 0,transferredAmount:le==="transfer"?k:void 0,withdrawnAmount:le==="withdraw"?k:void 0,senderName:le==="withdraw"&&Re.trim()!==""?Re.trim():void 0,createdAt:new Date},{ProfitService:Mt}=await ht(async()=>{const{ProfitService:Ns}=await ft(()=>import("./profitService-4r9FqAF7-CduXHB_-.js"),__vite__mapDeps([3,0,1]),import.meta.url);return{ProfitService:Ns}},xt([3,0,1]),import.meta.url),ra=Mt.calculateProfitFromTransaction({...gt,status:"confirmed"});ra>0&&(Mt.addProfit(ra,a==null?void 0:a.uid),Fe.profitAddedOnCreation=!0,gt.profitAddedOnCreation=!0,console.log("✅ تم إضافة الربح:",ra,"جنيه"));const Ba=await En.create(Fe);if(L)try{await is.updateUsage(L,k,le==="transfer"?"transfer":"withdraw");try{window.dispatchEvent(new CustomEvent("walletLimitsUpdated",{detail:{walletId:L}}))}catch{}try{await Ul()}catch{}}catch{}await Promise.all([...a!=null&&a.uid?[je.updateUserData(a.uid,{cashBalance:Wa,walletBalances:es,lastUpdated:new Date().toISOString()})]:[],...a!=null&&a.uid?[je.saveUserTransaction(a.uid,{...gt,transactionType:le,fromWallet:L,toWallet:le==="transfer"?ie?null:"cash":null,cashierName:te&&((Q==null?void 0:Q.name)||(Q==null?void 0:Q.username))||"الحساب الرئيسي",linkedDebtId:Ye||void 0,transactionId:Ba,description:`${le==="transfer"?"تحويل":"سحب"} ${k} من ${L} ${le==="transfer"?ie?"":"إلى الدرج النقدي":""} — عمولة: ${I} (${le==="transfer"||wt?"مضافة":"مخصومة"})${Yt>0?` — رسوم: ${Yt}`:""}${ve?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");try{ae.invalidateQueries({queryKey:["recentTransactions",a==null?void 0:a.uid,A||"main"]})}catch{}try{await Jn.refetch()}catch{}const $a=`userData_${a==null?void 0:a.uid}`,rs={cashBalance:Wa,walletBalances:es,lastUpdated:new Date().toISOString()};localStorage.setItem($a,JSON.stringify(rs))}catch(Fe){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",Fe);try{a!=null&&a.uid&&je.saveLocalReceipt(a.uid,{...transactionDataForUser,transactionType:le,fromWallet:L,toWallet:le==="transfer"?ie?null:"cash":null,cashierName:te&&((Q==null?void 0:Q.name)||(Q==null?void 0:Q.username))||"الحساب الرئيسي",linkedDebtId:Ye||void 0,description:`${le==="transfer"?"تحويل":"سحب"} ${k} من ${L} ${le==="transfer"?ie?"":"إلى الدرج النقدي":""} — عمولة: ${I} (${le==="transfer"||wt?"مضافة":"مخصومة"})${Yt>0?` — رسوم: ${Yt}`:""}${ve?" — دين مؤجل (قيد المراجعة)":""}`})}catch{}u({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),le==="transfer"){Cr(!0);const Fe=Number(p)+Number(I)+Math.max(0,Number(Yt));Kn({type:"transfer",amount:Math.max(0,Math.round(Fe*100)/100)}),Im({receiver:G,amount:p}),sr(!0),setTimeout(()=>{Cr(!1)},2e3)}else{Vr(!0);const Fe=wt?Number(p):Math.max(0,Math.round((Number(p)-Number(I))*100)/100);Kn({type:"withdraw",amount:Math.max(0,Math.round(Fe*100)/100)}),sr(!0),setTimeout(()=>{Vr(!1)},2e3)}V(""),_e(""),Pe(""),qe(""),jr(null),Ja(""),La(""),As(""),$i(!1)},wn=Ge.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),Wc=Ge.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),zu=Ge.useMemo(()=>{try{return St.reduce((t,s)=>{const r=Number(s.paidAmount||0),n=Math.max(0,Number(s.amount||0)-r);return t+n},0)}catch{return 0}},[St]),Bl=Ge.useMemo(()=>Ec().filter(t=>ks==="all"?!0:ks==="send"?t.type==="send":ks==="receive"?t.type==="receive":ks==="withdraw"?t.type==="withdraw":ks!=="deleted"),[Ec,ks]),qu=()=>{if(Vn==="daily"){const t=ja.resetReportsManually("daily",Ze,a==null?void 0:a.uid);Jr(!1),u({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${t.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const t=ja.resetReportsManually("monthly",Ze,a==null?void 0:a.uid);Jr(!1),u({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${t.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},Ju=()=>Vn==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",Yu=()=>Vn==="daily"?"أدخل الرقم السري الرئيسي لتصفير جميع معاملات اليوم":"أدخل الرقم السري الرئيسي لتصفير جميع معاملات الشهر",Vu=t=>{Sc(t),Nl(!0)},Gu=t=>{const s=$t,r=Number(t)-Number(s);Zt(t),localStorage.setItem(Ma(),t.toString()),dc(!1);const n={cashBalance:t,lastUpdated:new Date().toISOString()},o=`userData_${a==null?void 0:a.uid}`;try{localStorage.setItem(o,JSON.stringify(n))}catch{}const h=[];if(a!=null&&a.uid){h.push(je.updateUserData(a.uid,n).then(()=>{try{localStorage.removeItem(o)}catch{}}).catch(()=>{}));const p=`${r>0?"CASHADD":"CASHDEDUCT"}-${(a==null?void 0:a.uid)||"anon"}-${Date.now()}`,g=r>0?{txnType:"cash_addition",type:"cash_addition",amount:r,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:p,title:"إيصال إضافة نقدية",merchantUserId:a.uid,createdBy:a.uid,shopId:(v==null?void 0:v.shopId)||void 0}:r<0?{amount:Math.abs(r),status:"completed",title:"ايصال خصم من الفلوس النقديه",merchantUserId:a.uid,createdBy:a.uid,shopId:(v==null?void 0:v.shopId)||void 0}:null;g&&h.push(je.saveUserTransaction(a.uid,g));const w=v==null?void 0:v.shopId;if(w){const y=Le(Y,"dashboardData",w);h.push(Ut(y,{cashBalance:t}))}}Promise.allSettled(h).then(()=>{}).catch(()=>{}),u({title:r>0?"تم إضافة نقدية":r<0?"تم خصم نقدية":"تم تحديث الرصيد النقدي",description:r!==0?`التغيير: ${Math.abs(r)} جنيه، الرصيد الجديد: ${t} جنيه`:`تم تحديث الرصيد النقدي إلى ${t} جنيه`})},Ku=async t=>{var s;if(!Ua){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const r={...lt,[Ua]:t};ca(r);const n=new Date().toISOString(),o={walletBalances:r,lastUpdated:n},h=`userData_${a==null?void 0:a.uid}`;try{localStorage.setItem(h,JSON.stringify(o)),localStorage.setItem(Ta(),JSON.stringify(r)),localStorage.setItem(`walletBalances_backup_${n}`,JSON.stringify(r))}catch{}try{a!=null&&a.uid&&await je.updateUserData(a.uid,o)}catch(g){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",g)}mc(!1);const p=((s=Je.find(g=>g.id===Ua))==null?void 0:s.name)||"المحفظة";u({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${p} إلى ${t.toLocaleString()} جنيه`})},Hu=async t=>{var s;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",Ua),console.log("💵 المبلغ المضاف/المخصوم:",t),Ua){const r=lt[Ua]||0;console.log("💰 الرصيد الحالي:",r);const n=r+t;console.log("💰 الرصيد الجديد:",n);const o={...lt,[Ua]:n};console.log("📊 الأرصدة المحدثة:",o),ca(o);const h=new Date().toISOString(),p={walletBalances:o,lastUpdated:h},g=`userData_${a==null?void 0:a.uid}`;localStorage.setItem(g,JSON.stringify(p)),localStorage.setItem(Ta(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${h}`,JSON.stringify(o));try{if(a!=null&&a.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await je.updateUserData(a.uid,p),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(g),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(_){console.error("❌ فشل في حفظ البيانات في Firebase:",_),st(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(Ta(),JSON.stringify(o));const w=((s=Je.find(_=>_.id===Ua))==null?void 0:s.name)||"المحفظة",y=t>0?"إضافة":"خصم",N=Math.abs(t);u({title:`تم ${y} مبلغ ${y==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${y} ${N} جنيه ${y==="إضافة"?"إلى":"من"} رصيد ${w}. الرصيد الجديد: ${n.toLocaleString()} جنيه`})}catch(w){if(console.error("❌ فشل في حفظ البيانات في Firebase:",w),localStorage.setItem(Ta(),JSON.stringify(o)),a!=null&&a.uid){const y=`userData_${a.uid}`,N={walletBalances:o,lastUpdated:new Date().toISOString()};localStorage.setItem(y,JSON.stringify(N)),st(!0)}u({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const r=Object.keys(localStorage).filter(n=>n.startsWith("walletBalances_backup_")).sort();r.length>5&&r.slice(0,r.length-5).forEach(n=>{localStorage.removeItem(n),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",n)})},5e3),Nl(!1),Sc("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:ds,isUserActive:na,showActivationModal:jt}),ds?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx(ah,{})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"user-dashboard min-h-screen px-2 sm:px-4 py-2 sm:py-4 relative bg-gray-50 bg-[radial-gradient(140%_140%_at_10%_10%,#f3f4f6_0%,#e5e7eb_45%,#d1d5db_100%)]",children:[e.jsx(lx,{userId:a==null?void 0:a.uid}),e.jsxs("div",{className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!Gr&&e.jsxs(Ft,{className:"monthly-stats-card bg-gradient-to-br from-purple-50 via-purple-25 to-white border border-purple-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-500/5 to-purple-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-purple-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(ma,{className:"monthly-stats-header pb-2 sm:pb-1 lg:pb-1 px-3 sm:px-3 lg:px-2 pt-3 sm:pt-2 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Pa,{className:"text-xs font-bold text-purple-800 flex items-center gap-1.5 sm:gap-1",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-2 h-2.5 sm:h-2 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-2 h-2.5 sm:h-2 bg-purple-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1",children:[e.jsx("div",{className:"hidden"}),e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>{No("monthly"),Jr(!0)},className:"monthly-stat-action h-7 w-7 sm:h-6 sm:w-6 p-0 bg-white/60 backdrop-blur-md border border-white/50 text-purple-700 hover:bg-white hover:text-purple-900 rounded-xl transition-all duration-300 hover:scale-110 shadow-[0_8px_16px_-6px_rgba(124,58,237,0.35)] ring-1 ring-purple-200",title:"تصفير معاملات الشهر",children:e.jsx(da,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5"})}),e.jsx("div",{className:"monthly-stat-action p-1.5 sm:p-1 bg-gradient-to-br from-purple-500/20 to-pink-500/20 border border-white/50 backdrop-blur-md rounded-xl shadow-[0_8px_16px_-6px_rgba(236,72,153,0.35)]",children:e.jsx(mi,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5 text-purple-700"})})]})]})}),!Gr&&e.jsxs(Wt,{className:"space-y-0.5 sm:space-y-1 lg:space-y-0 pt-0 px-2 sm:px-3 lg:px-2 pb-1.5 sm:pb-2 lg:pb-1 relative z-10",children:[e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:li().totalTransactions})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:li().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"المسحوب:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:li().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"المرسل:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:li().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"الأرباح:"}),e.jsx(K0,{userId:a==null?void 0:a.uid,transactions:Ze})]})]}),Em&&e.jsx("div",{className:"monthly-overlay absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(x,{size:"sm",variant:"ghost",onClick:async()=>{if(It){u({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}Ji(!0)},className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-black hover:from-yellow-600 hover:to-yellow-700 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(Bt,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(ya,{open:Fm,onOpenChange:Ji,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(It){u({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),Ji(!1),Fo(!0);return}Fo(!1),Ji(!1)},userId:a==null?void 0:a.uid}),((l=Fa==null?void 0:Fa.subscription)==null?void 0:l.planType)!==za.TAHWEELA&&e.jsxs(Ft,{className:"daily-stats-card bg-gradient-to-br from-blue-50 via-blue-25 to-white border border-blue-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 to-blue-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-blue-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(ma,{className:"daily-stats-header pb-2 sm:pb-3 lg:pb-1 px-3 sm:px-4 lg:px-2 pt-3 sm:pt-4 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Pa,{className:"text-sm sm:text-base font-bold text-blue-800 flex items-center gap-1.5 sm:gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-3 h-2.5 sm:h-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-3 h-2.5 sm:h-3 bg-blue-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs sm:text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5",children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>{No("daily"),Jr(!0)},className:"daily-stat-action h-7 w-7 sm:h-8 sm:w-8 p-0 bg-white/60 backdrop-blur-md border border-white/50 text-blue-700 hover:bg-white hover:text-blue-900 rounded-xl transition-all duration-300 hover:scale-110 shadow-[0_8px_16px_-6px_rgba(59,130,246,0.35)] ring-1 ring-blue-200",title:"تصفير معاملات اليوم",children:e.jsx(da,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>Pm(t=>!t),className:"daily-stat-action h-7 w-7 sm:h-8 sm:w-8 p-0 bg-white/60 backdrop-blur-md border border-white/50 text-blue-700 hover:bg-white hover:text-blue-900 rounded-xl transition-all duration-300 hover:scale-110 shadow-[0_8px_16px_-6px_rgba(59,130,246,0.35)] ring-1 ring-blue-200",title:Gr?"توسيع اليوم والشهر":"طي اليوم والشهر",children:Gr?e.jsx(Si,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"}):e.jsx(Dn,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-br from-blue-500/20 to-emerald-500/20 border border-white/50 backdrop-blur-md rounded-xl shadow-[0_8px_16px_-6px_rgba(16,185,129,0.35)]",children:e.jsx(mi,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-blue-700"})})]})]})}),!Gr&&e.jsxs(Wt,{className:"space-y-0 pt-0 px-2 pb-1 relative z-10",children:[e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:ni().totalTransactions})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:ni().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"المسحوب:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:ni().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from_gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"المرسل:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:ni().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"الأرباح:"}),e.jsx(X0,{userId:a==null?void 0:a.uid,transactions:Ze})]})]}),Bm&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(x,{size:"sm",variant:"ghost",onClick:()=>Xn(!0),className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير اليوم (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير اليوم"}),e.jsx(Bt,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(ya,{open:Rm,onOpenChange:Xn,mode:"verify",title:"الرقم السري لفتح تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Uo(!1),Xn(!1)},userId:a==null?void 0:a.uid})]}),e.jsxs(Ft,{className:"balance-bar bg-white border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(Wt,{className:"p-3 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-emerald-50 border-2 border-emerald-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/cash relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx(Xt,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-emerald-800",children:"الفلوس النقدية"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-emerald-700 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm",children:[$t.toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Zr(!0),children:e.jsx(Sa,{className:"h-2 w-2"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Cc(!0),title:"تفاصيل الفلوس النقدية",children:e.jsx(ed,{className:"h-2 w-2"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>vn(!0),children:e.jsx(da,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/wallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(Is,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-blue-800",children:"الأرصدة علي المحافظ"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-blue-700 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Object.values(lt).reduce((t,s)=>t+s,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>hn(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(Sa,{className:"h-2 w-2"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{gn(!0),fn("")},title:"تصفير إجمالي المحفظة",children:e.jsx(da,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-indigo-50 border-2 border-indigo-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/selwallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(Is,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-indigo-800",children:"رصيد المحفظه"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-indigo-700 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm",children:[(L&&lt[L]||0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>{if(!L){u({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}Vu(L)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(Sa,{className:"h-2 w-2"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{if(!L){u({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}en(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(da,{className:"h-2 w-2"})})]})]})]})]})})]}),e.jsxs(Ft,{className:"bg-gradient-to-br from-gray-50 via-white to-slate-50 border border-gray-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-500/5 to-slate-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsxs(ma,{className:`pb-2 px-4 pt-4 relative z-10 ${se?"sticky top-0 z-20 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/60":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Pa,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[!se&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-gray-100 to-slate-200 rounded-lg",children:e.jsx(mi,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-600"})}),e.jsx("span",{className:"bg-gradient-to-r from-gray-600 to-slate-600 bg-clip-text text-transparent",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!se&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(Dh,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx(q,{placeholder:"بحث...",value:Do,onChange:t=>jm(t.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!se&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"تقسيط"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{if(It||Jt){u({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"});return}Bi(!0)},title:"إدارة التقسيط",children:e.jsx(sh,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-green-600 mb-1",children:"شحن"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 ring-3 ring-green-300 transition-all duration-200 hover:scale-105 active:bg-green-600 active:text-white active:border-green-600",onClick:()=>{u({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."})},title:"شحن الرصيد",children:e.jsx(Ci,{className:"h-5 w-5 text-green-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>Hn(!0),title:"آلة حاسبة",children:e.jsx(Id,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{It||Jt?u({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Ri(!0)},title:"كروت الائتمان",children:e.jsx(Ci,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"تقاريرك"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:()=>{if(It||Jt){u({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"});return}vc(!0)},title:"تقاريرك",children:e.jsx(Zh,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:wu,title:te&&(Q!=null&&Q.name||Q!=null&&Q.username)?`بروفيل الوردية: ${(Q==null?void 0:Q.name)||(Q==null?void 0:Q.username)}`:"وردية الكاشير",children:e.jsx(wi,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{It||Jt?u({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):qr(!0)},title:"بيانات المبيعات",children:e.jsx(Qc,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),St.filter(t=>t.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:St.filter(t=>t.status==="pending").length})]}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{cl()},title:"الديون",children:e.jsx(rh,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105 active:bg-amber-600 active:text-white active:border-amber-600",onClick:()=>{It||Jt?u({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):zi(!0)},title:"الصيانة",children:e.jsx(ud,{className:"h-5 w-5 text-amber-700"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-50 text-violet-700 hover:bg-violet-100 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105 active:bg-violet-700 active:text-white active:border-violet-700",onClick:()=>{!ws||Jt?u({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):qi(!0)},title:"يومية المكنة",children:e.jsx(Td,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105 active:bg-orange-600 active:text-white active:border-orange-600",onClick:()=>{It||Jt?u({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Ia.hasMasterPin()?ce(!0):he(!0)},title:"مصروفات المحل",children:e.jsx(Di,{className:"h-5 w-5 text-orange-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-rose-600 mb-1",children:"النواقص"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-rose-50 text-rose-600 hover:bg-rose-100 border border-rose-200 ring-3 ring-rose-300 transition-all duration-200 hover:scale-105 active:bg-rose-600 active:text-white active:border-rose-600",onClick:()=>{It||Jt?u({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):wa(!0)},title:"النواقص",children:e.jsx(Rc,{className:"h-5 w-5 text-rose-600"})})]})]})]})]}),!se&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"filters-bar flex items-center justify-center gap-3 bg-gray-50 rounded-md p-3 border border-gray-200",children:[e.jsx(x,{variant:"ghost",size:"sm",className:`btn-filter-send h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${ks==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>qn("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(x,{variant:"ghost",size:"sm",className:`btn-filter-withdraw h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${ks==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-50"}`,onClick:()=>qn("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(x,{variant:"ghost",size:"sm",className:`btn-filter-all h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${ks==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>qn("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(x,{variant:"ghost",size:"sm",className:"h-8 px-3 text-[12px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>Qr(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(da,{className:"h-3.5 w-3.5 mr-1"}),"تصفير"]}),Tu>0&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),e.jsx(ya,{open:km,onOpenChange:Bi,mode:"verify",title:"فتح إدارة التقسيط",description:"أدخل الرقم السري الرئيسي للوصول إلى إدارة التقسيط",onSuccess:()=>{Bi(!1),Po(!0)}}),e.jsx(kh,{open:_m,onOpenChange:Po}),Eo,e.jsxs(Wt,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:[Bl.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(mi,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):se?e.jsx("div",{className:"overflow-y-auto overscroll-contain scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[310px]",children:e.jsx("div",{className:"space-y-2 pr-2",children:Bl.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-colors duration-100 hover:bg-gray-50",onClick:()=>Lc(t),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(er,{className:`h-4 w-4 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(Ps,{className:"h-4 w-4 text-yellow-500"}),t.status==="failed"&&e.jsx(_n,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const s=t,r=(s==null?void 0:s.type)==="report"||String((s==null?void 0:s.title)||"").includes("إيصال تسليم وردية"),n=String((s==null?void 0:s.type)||"").toLowerCase()==="cash_addition"||String((s==null?void 0:s.txnType)||"").toLowerCase()==="cash_addition"||String((s==null?void 0:s.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`font-medium text-sm ${r||n?"text-gray-800":t.type==="send"?"text-green-700":"text-red-700"}`,children:r?"إيصال تسليم وردية":n?`إيصال إضافة نقدية - ${Ca(t.amount)} جنيه`:(t.type==="send"?"تحويل":"سحب")+` - ${Ca(t.amount)} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(t==null?void 0:t.cashierName)??"الحساب الرئيسي"]}),(()=>{const s=t,r=(s==null?void 0:s.type)==="report"||String((s==null?void 0:s.title)||"").includes("إيصال تسليم وردية"),n=String((s==null?void 0:s.type)||"").toLowerCase()==="cash_addition"||String((s==null?void 0:s.txnType)||"").toLowerCase()==="cash_addition"||String((s==null?void 0:s.title)||"").includes("إيصال إضافة نقدية"),o=(s==null?void 0:s.note)||(s==null?void 0:s.notes)||"";return e.jsx("p",{className:`text-xs ${r||n?"text-gray-500":t.type==="send"?"text-green-600":"text-red-500"}`,children:r?`تم التسليم إلى: ${t.receiverPhone}`:n?o?`ملاحظة: ${o}`:"تمت إضافة نقدية للدرج":`من ${t.senderPhone}${t.type==="send"?` إلى ${t.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[wn.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",Wc.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]})]}),e.jsx(ta,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",className:`text-xs ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700 border-red-300":t.type==="send"?"bg-green-100 text-green-700 border-green-300":"":""}`,children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})}):e.jsx("div",{className:"overflow-y-auto overscroll-contain scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[calc(100dvh-300px)]",children:e.jsx("div",{className:"space-y-2 pr-2",children:Bl.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-colors duration-100 hover:bg-gray-50",onClick:()=>Lc(t),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(er,{className:`h-4 w-4 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(Ps,{className:"h-4 w-4 text-yellow-500"}),t.status==="failed"&&e.jsx(_n,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const s=t,r=(s==null?void 0:s.type)==="report"||String((s==null?void 0:s.title)||"").includes("إيصال تسليم وردية"),n=String((s==null?void 0:s.type)||"").toLowerCase()==="cash_addition"||String((s==null?void 0:s.txnType)||"").toLowerCase()==="cash_addition"||String((s==null?void 0:s.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`font-medium text-sm ${r||n?"text-gray-800":t.type==="send"?"text-green-700":"text-red-700"}`,children:r?"إيصال تسليم وردية":n?`إيصال إضافة نقدية - ${Ca(t.amount)} جنيه`:(t.type==="send"?"تحويل":"سحب")+` - ${Ca(t.amount)} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(t==null?void 0:t.cashierName)??"الحساب الرئيسي"]}),(()=>{const s=t,r=(s==null?void 0:s.type)==="report"||String((s==null?void 0:s.title)||"").includes("إيصال تسليم وردية"),n=String((s==null?void 0:s.type)||"").toLowerCase()==="cash_addition"||String((s==null?void 0:s.txnType)||"").toLowerCase()==="cash_addition"||String((s==null?void 0:s.title)||"").includes("إيصال إضافة نقدية"),o=(s==null?void 0:s.note)||(s==null?void 0:s.notes)||"";return e.jsx("p",{className:`text-xs ${r||n?"text-gray-500":t.type==="send"?"text-green-600":"text-red-500"}`,children:r?`تم التسليم إلى: ${t.receiverPhone}`:n?o?`ملاحظة: ${o}`:"تمت إضافة نقدية للدرج":`من ${t.senderPhone}${t.type==="send"?` إلى ${t.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[wn.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",Wc.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]})]}),e.jsx(ta,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",className:`text-xs ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700 border-red-300":t.type==="send"?"bg-green-100 text-green-700 border-green-300":"":""}`,children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})}),se&&e.jsxs("div",{className:"mt-2 flex justify-end",children:[e.jsxs(x,{variant:"ghost",size:"sm",className:"h-7 px-2 text-[11px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>Qr(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(da,{className:"h-3 w-3 mr-1"}),"تصفير"]}),(a==null?void 0:a.uid)&&localStorage.getItem(`recentTransactionsResetAt:${a.uid}`)&&e.jsx("span",{className:"inline-block h-1.5 w-1.5 rounded-full bg-red-500 ml-1 align-middle"})]})]})]})]}),e.jsx(_h,{isOpen:pm,onClose:()=>Mi(!1),transaction:gm,onPrint:()=>window.print(),onDelete:wm,onComplete:Nm}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full lg:w-[92%] xl:w-[95%] mx-auto",children:[e.jsxs(Ft,{id:"transaction-section",className:"bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/50 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx(ma,{className:"sticky top-0 z-20 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Pa,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(er,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[us&&e.jsx("div",{className:"hidden md:flex items-center gap-1 bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 border border-emerald-200 text-emerald-800 text-sm transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:e.jsxs("span",{className:"text-sm font-semibold whitespace-nowrap",children:["تجربة: ",br," ",br>=3&&br<=10?"ساعات":br===2?"ساعتين":"ساعة"]})}),e.jsxs("div",{className:"top-icons-bar hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:[e.jsx(A0,{}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"VIP",onClick:()=>Qn(!0),children:e.jsx(Gh,{className:"h-5 w-5 text-yellow-500"})}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"إدارة الفروع",onClick:()=>{u({title:"قيد التطوير",description:"إدارة الفرع قيد التطوير حالياً"})},children:e.jsx(Cd,{className:"h-5 w-5"})}),e.jsx(Ah,{})]})]}),Lu&&e.jsxs(x,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:Tc,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx(Eh,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsx(Se,{open:Wm,onOpenChange:Qn,children:e.jsxs(Ie,{className:"sm:max-w-md",children:[e.jsx(Ce,{children:e.jsx(De,{children:"أفضل 10 عملاء هذا الشهر"})}),e.jsx("div",{className:"space-y-2",children:pn.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا توجد بيانات لهذا الشهر"}):pn.map((t,s)=>e.jsxs("div",{className:`flex items-center justify-between border rounded-md px-3 py-2 bg-white ${s===0?"bg-yellow-50 border-yellow-300":""}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ta,{variant:"outline",className:`min-w-[28px] justify-center ${s===0?"border-yellow-300 text-yellow-700 bg-yellow-50":""}`,children:s+1}),e.jsx("span",{className:`font-semibold ${s===0?"text-yellow-700":""}`,children:t.phone})]}),e.jsxs("div",{className:"text-sm text-gray-700 flex items-center gap-3",children:[e.jsxs("span",{children:["عدد: ",t.count]}),e.jsxs("span",{children:["إجمالي: ",t.total]}),e.jsx(x,{variant:"outline",size:"sm",className:"h-8",onClick:()=>Ou(t),title:"إرسال واتساب",children:e.jsx(zc,{className:"h-4 w-4"})})]})]},t.phone+s))}),e.jsx(ot,{children:e.jsx(x,{onClick:()=>Qn(!1),children:"إغلاق"})})]})}),e.jsx(Se,{open:Lm,onOpenChange:Lo,children:e.jsxs(Ie,{className:"sm:max-w-md",children:[e.jsx(Ce,{children:e.jsx(De,{children:"ربط بوت التلجرام"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(ee,{children:"Telegram Chat ID"}),e.jsx(q,{value:Yi,onChange:t=>Mm(t.target.value),placeholder:"اكتب رقم المحادثة"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ee,{children:"إرسال يومي 12 صباحاً"}),e.jsx(Ph,{checked:Mo,onCheckedChange:t=>Um(!!t)})]})]}),e.jsxs(ot,{children:[e.jsx(x,{variant:"outline",onClick:()=>Lo(!1),children:"إغلاق"}),e.jsx(x,{onClick:async()=>{a!=null&&a.uid&&(await je.updateUserData(a.uid,{telegramChatId:Yi,telegramDailyEnabled:Mo}),u({title:"تم الحفظ"}))},children:"حفظ"}),e.jsx(x,{onClick:async()=>{if(!(a!=null&&a.uid)||!Yi){u({title:"أدخل Chat ID"});return}const t=await Eu();try{const{sendTelegramMessage:s}=await ht(async()=>{const{sendTelegramMessage:r}=await Promise.resolve().then(()=>p0);return{sendTelegramMessage:r}},void 0,import.meta.url);await s({chatId:Yi,text:t}),u({title:"تم الإرسال"})}catch{u({title:"تعذر الإرسال",description:"تحقق من ربط البوت",variant:"destructive"})}},children:"إرسال الآن"})]})]})}),e.jsx(Se,{open:We,onOpenChange:Qe,children:e.jsxs(Ie,{className:"sm:max-w-lg",children:[e.jsxs(Ce,{children:[e.jsx(De,{children:"إدارة الفروع"}),e.jsx(va,{children:"أضف فروع جديدة وأدِر الدخول لكل فرع"}),e.jsx("div",{className:"flex items-center justify-end gap-2 mt-2",children:e.jsx(x,{variant:"outline",size:"sm",onClick:()=>{try{const t=a!=null&&a.uid?`selectedShopId_${a.uid}`:"selectedShopId";localStorage.removeItem(t);try{window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}u({title:"تم الخروج من الفرع"}),E(`/branch/${String(b.shopId)}/dashboard`)}catch{}},children:"الخروج من الفرع"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(ee,{children:"اسم المدير"}),e.jsx(q,{value:it,onChange:t=>_t(t.target.value),placeholder:"اكتب اسم المدير"})]}),e.jsxs("div",{children:[e.jsx(ee,{children:"اسم الفرع"}),e.jsx(q,{value:be,onChange:t=>ke(t.target.value),placeholder:"اكتب اسم الفرع"})]}),e.jsxs("div",{children:[e.jsx(ee,{children:"اسم المستخدم للدخول"}),e.jsx(q,{value:Dt,onChange:t=>Ot(t.target.value),placeholder:"مثال: branch1"})]}),e.jsxs("div",{children:[e.jsx(ee,{children:"كلمة السر"}),e.jsx(q,{type:"password",value:Gt,onChange:t=>Kt(t.target.value),placeholder:"••••••"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{_t(""),ke(""),Ot(""),Kt("")},children:"مسح"}),e.jsx(x,{className:"bg-indigo-600 hover:bg-indigo-700",disabled:Oe,onClick:async()=>{if(!(a!=null&&a.uid))return;const t=it.trim(),s=be.trim(),r=Dt.trim(),n=Gt.trim();if(!t||!s||!r||!n){u({title:"يرجى ملء جميع الحقول"});return}if(Z.length>=3){u({title:"عفواً",description:"لقد وصلت للحد الأقصى من الفروع (3 فروع)",variant:"destructive"});return}try{Ke(!0);let o="";try{o=(await ls(Ae(Y,"shops"),{name:s,ownerId:a.uid,createdAt:dt(),updatedAt:dt(),isActive:!0})).id}catch{o=(await ls(Ae(Y,"users",a.uid,"shops"),{name:s,ownerId:a.uid,createdAt:dt(),updatedAt:dt(),isActive:!0})).id}const h=p=>{try{return btoa(unescape(encodeURIComponent(p)))}catch{return btoa(p)}};try{await ls(Ae(Y,"branches"),{ownerId:a.uid,shopId:o,branchName:s,managerName:t,loginUsername:r,passwordEncoded:h(n),createdAt:dt()})}catch{await ls(Ae(Y,"users",a.uid,"branches"),{ownerId:a.uid,shopId:o,branchName:s,managerName:t,loginUsername:r,passwordEncoded:h(n),createdAt:dt()})}try{const p=Ve(Ae(Y,"branches"),me("ownerId","==",a.uid));let g=(await et(p)).docs.map(w=>({id:w.id,...w.data()}));if(g.length===0){const w=Ve(Ae(Y,"users",a.uid,"branches"));g=(await et(w)).docs.map(y=>({id:y.id,...y.data()}))}ye(g)}catch{try{const p=Ve(Ae(Y,"users",a.uid,"branches")),g=(await et(p)).docs.map(w=>({id:w.id,...w.data()}));ye(g)}catch{}}_t(""),ke(""),Ot(""),Kt(""),u({title:"تم إضافة الفرع بنجاح"})}catch{u({title:"تعذّر إضافة الفرع"})}finally{Ke(!1)}},children:"إضافة فرع"})]}),e.jsxs("div",{className:"border-t pt-3",children:[e.jsx("h4",{className:"text-sm font-semibold mb-2",children:"الفروع الحالية"}),Oe?e.jsx("div",{className:"text-sm text-gray-500",children:"جارٍ التحميل..."}):Z.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"لا يوجد فروع بعد"}):e.jsx("div",{className:"space-y-2",children:Z.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-lg bg-white",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:t.branchName}),e.jsxs("div",{className:"text-gray-600",children:["مدير: ",t.managerName]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{size:"sm",className:"bg-blue-600 hover:bg-blue-700",onClick:()=>{X(t),Lt(String(t.loginUsername||"")),M(""),$e(!0)},children:"دخول الفرع"}),e.jsx(x,{size:"sm",variant:"destructive",onClick:async()=>{if(confirm("هل أنت متأكد من حذف الفرع؟ سيتم حذف بيانات الفرع المرتبطة."))try{try{await Ea(Le(Y,"branches",t.id))}catch{}try{await Ea(Le(Y,"users",(a==null?void 0:a.uid)||"","branches",t.id))}catch{}if(t.shopId){try{await Ea(Le(Y,"shops",String(t.shopId)))}catch{}try{await Ea(Le(Y,"users",(a==null?void 0:a.uid)||"","shops",String(t.shopId)))}catch{}}ye(s=>s.filter(r=>r.id!==t.id)),u({title:"تم حذف الفرع"})}catch{u({title:"تعذّر حذف الفرع"})}},children:"حذف الفرع"})]})]},t.id))})]})]})]})}),e.jsx(Se,{open:ct,onOpenChange:$e,children:e.jsxs(Ie,{className:"sm:max-w-md",children:[e.jsxs(Ce,{children:[e.jsx(De,{children:"دخول الفرع"}),e.jsx(va,{children:"أدخل بيانات الدخول للفرع المحدد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(ee,{children:"اسم المستخدم"}),e.jsx(q,{value:mt,onChange:t=>Lt(t.target.value),placeholder:"اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(ee,{children:"كلمة السر"}),e.jsx(q,{type:"password",value:Tt,onChange:t=>M(t.target.value),placeholder:"••••••"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{Lt(""),M("")},children:"مسح"}),e.jsx(x,{className:"bg-blue-600 hover:bg-blue-700",disabled:we,onClick:async()=>{const t=at;if(!t){$e(!1);return}const s=String(t.loginUsername||"");let r="";try{const h=String(t.passwordEncoded||"");r=h?decodeURIComponent(escape(atob(h))):""}catch{try{r=t.passwordEncoded?atob(String(t.passwordEncoded)):""}catch{r=""}}const n=mt.trim(),o=Tt.trim();if(!n||!o){u({title:"يرجى إدخال اسم المستخدم وكلمة السر"});return}if(n!==s||o!==r){u({title:"بيانات الدخول غير صحيحة",variant:"destructive"});return}try{Me(!0);const h=a!=null&&a.uid?`selectedShopId_${a.uid}`:"selectedShopId";localStorage.setItem(h,String(t.shopId)),u({title:"تم الدخول إلى الفرع",description:String(t.branchName||"")}),$e(!1),Qe(!1),E("/user/dashboard")}catch{}Me(!1)},children:"دخول"})]})]})]})}),e.jsxs(Wt,{ref:K,className:"space-y-1 px-2 pb-2 relative z-10 transition-transform duration-200 ease-out will-change-transform",style:{transform:B?`translateY(${B}px)`:void 0},onFocusCapture:t=>{const s=t.target;if((s==null?void 0:s.id)!=="transferExtraFeeInput"){F(0);return}const r=document.getElementById("transferSubmitButton");if(r){const n=r.getBoundingClientRect(),o=window.innerHeight;if(n.bottom>o){const h=n.bottom-o,p=Math.min(h,220);F(-p)}else F(0)}else F(0)},onBlurCapture:t=>{t.currentTarget.contains(t.relatedTarget)||F(0)},children:[e.jsxs("div",{className:"transaction-type-tabs grid grid-cols-2 gap-0.5 p-0.5 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-200/50 fade-in-up w-full lg:w-[92%] xl:w-[95%] mx-auto ",children:[e.jsxs(x,{variant:le==="transfer"?"default":"ghost",onClick:()=>bn("transfer"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${le==="transfer"?"bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg hover:shadow-md hover:from-blue-600 hover:to-indigo-700":"text-gray-600 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-700 hover:border-blue-200"}`,children:[e.jsx(mi,{className:"h-1 w-1 mr-1"}),"تحويل"]}),e.jsxs(x,{variant:le==="withdraw"?"default":"ghost",onClick:()=>bn("withdraw"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${le==="withdraw"?"bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-lg hover:shadow-md hover:from-emerald-600 hover:to-green-700":"text-gray-600 hover:bg-gradient-to-r hover:from-emerald-50 hover:to-green-50 hover:text-emerald-700 hover:border-emerald-200"}`,children:[e.jsx(Tn,{className:"h-1 w-1 mr-1"}),"سحب"]})]}),e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(Is,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(x,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>E("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(Sa,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(x,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>{Oi(!0)},title:"المحافظ",children:[e.jsx(Is,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),Je.length>0?e.jsxs(Gs,{value:L,onValueChange:Uu,children:[e.jsx(Ks,{"data-testid":"wallet-select",className:"selected-number-card w-full h-12 text-sm bg-gradient-to-r from-white to-gray-50 border-2 border-gray-200 hover:border-blue-400 focus:border-blue-500 rounded-xl transition-all duration-300 hover:shadow-md focus:shadow-lg",children:e.jsx(Hs,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-600"})}),e.jsxs(Qs,{className:"rounded-xl border-2 border-gray-200 shadow-md z-[9999]",children:[e.jsx("div",{"data-fixed-header":"true",className:"sticky top-0 z-10 bg-white p-2 border-b border-gray-200",children:e.jsx(q,{value:yo,onChange:t=>um(t.target.value),placeholder:"ابحث برقم المحفظة",className:"h-6 text-xs"})}),e.jsx("div",{className:"pr-1",children:bo.length===0?e.jsx("div",{className:"text-xs text-gray-500 p-2",children:"لا توجد نتائج مطابقة"}):bo.map(t=>e.jsx(ps,{value:t.id,className:"rounded-lg hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200",children:e.jsxs("div",{className:"flex items-center gap-1 py-1 w-full justify-between",children:[e.jsx("div",{className:"p-1 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg",children:e.jsx(Is,{className:"h-1 w-1 text-blue-600"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-800",children:t.name}),e.jsxs("span",{className:"text-sm font-semibold text-red-600",children:["(",t.phone,")"]})]}),t.isDefault&&e.jsx(ta,{variant:"secondary",className:"text-[10px] bg-gradient-to-r from-emerald-100 to-green-100 text-emerald-700 border-emerald-200",children:"افتراضي"})]}),e.jsx("div",{className:"ml-auto flex flex-col items-end gap-1"})]})},t.id))})]})]}):e.jsx("div",{className:"rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 px-3 py-3 text-xs text-gray-600",children:"لا توجد محافظ حتى الآن. اضغط “إضافة محفظة” لإضافة أول محفظة."})]}),e.jsx(Se,{open:Ln,onOpenChange:ho,children:e.jsxs(Ie,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(Ce,{children:e.jsx(De,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(qh,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),e.jsx(ya,{open:am,onOpenChange:Oi,mode:"verify",title:"الرقم السري لفتح المحافظ",description:"أدخل الرقم السري الرئيسي لعرض وإدارة المحافظ",onSuccess:()=>{Oi(!1),ho(!0)},userId:a==null?void 0:a.uid}),e.jsx(ya,{open:sm,onOpenChange:t=>{Mn(t),t||Un(null)},mode:"verify",title:"تأكيد تغيير المحفظة",description:"أدخل الرقم السري الرئيسي لتغيير المحفظة المختارة",onSuccess:()=>{xo&&(si(xo,"walletSelectionPin"),Un(null)),Mn(!1)},userId:a==null?void 0:a.uid}),e.jsx(Se,{open:im,onOpenChange:Ei,children:e.jsxs(Ie,{className:"sm:max-w-md",children:[e.jsx(Ce,{children:e.jsxs(De,{className:"flex items-center gap-2 text-red-700",children:[e.jsx(Rc,{className:"h-5 w-5 text-red-600"}),"تحذير حد شهري للمحفظة"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded-md border bg-red-50 border-red-200",children:[e.jsxs("p",{className:"text-sm text-red-800",children:["المحفظة: ",e.jsx("span",{className:"font-semibold",children:(Us==null?void 0:Us.walletName)||""})]}),e.jsxs("p",{className:"text-sm text-red-800",children:["الاستخدام الشهري (",(Us==null?void 0:Us.type)==="withdraw"?"سحب":"تحويل","):",e.jsxs("span",{className:"font-mono",children:[" ",Number((Us==null?void 0:Us.used)||0).toLocaleString("en-US")," "]})," جنيه"]}),e.jsxs("p",{className:"text-sm text-red-800",children:["الحد الشهري: ",e.jsx("span",{className:"font-mono",children:Number((Us==null?void 0:Us.limit)||0).toLocaleString("en-US")})," جنيه"]}),e.jsx("p",{className:"text-sm font-semibold text-red-900 mt-1",children:"تم الوصول إلى 85% من الحد الشهري — يرجى الحذر قبل الاستمرار."})]}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsx(x,{variant:"outline",onClick:()=>Ei(!1),children:"حسناً"})})]})]})}),L&&Je.length>0&&(()=>{var t;const s=Je.find(Ye=>Ye.id===L),r=dr,n=Ru(L),o=(kt==null?void 0:kt.monthlyWithdrawLimit)??(s==null?void 0:s.monthlyWithdrawalLimit)??2e5,h=(kt==null?void 0:kt.monthlyTransferLimit)??(s==null?void 0:s.monthlyTransferLimit)??2e5,p=(kt==null?void 0:kt.monthlyWithdrawUsed)??r.totalWithdrawn??0,g=(kt==null?void 0:kt.monthlyTransferUsed)??r.totalTransferred??0,w=((t=Fa==null?void 0:Fa.subscription)==null?void 0:t.planType)===za.TAHWEELA,y=w?0:(kt==null?void 0:kt.dailyWithdrawLimit)??1e5,N=w?0:(kt==null?void 0:kt.dailyTransferLimit)??6e4,_=w?0:(kt==null?void 0:kt.dailyWithdrawUsed)??n.totalWithdrawn??0,I=w?0:(kt==null?void 0:kt.dailyTransferUsed)??n.totalTransferred??0,k=parseFloat(de||"0")||0,W=p+(le==="withdraw"?k:0),ie=g+(le==="transfer"?k:0),J=_+(le==="withdraw"?k:0),ve=I+(le==="transfer"?k:0);return s?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود الشهرية: ",lc||(s==null?void 0:s.name)||"المحفظة المختارة"]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(W/Math.max(o,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(ie/Math.max(h,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-red-600 font-medium",children:["متبقي سحب: ",Math.max(o-W,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(h-ie,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود اليومية: ",lc||(s==null?void 0:s.name)||"المحفظة المختارة"]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(J/Math.max(y,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(ve/Math.max(N,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(y-J,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(N-ve,0).toLocaleString("en-US")," جنيه"]})]})]})]}):null})(),le==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Es,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(q,{value:C,onChange:t=>O(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const s=document.getElementById("receiverPhoneInput");if(s)s.focus();else{const r=document.getElementById("amountInput");r==null||r.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),!P&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Es,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(q,{id:"receiverPhoneInput",value:G,onChange:t=>{V(t.target.value),Gn&&Cr(!1)},onKeyDown:t=>{if(t.key==="Enter"){const s=document.getElementById("amountInput");s==null||s.focus()}},inputMode:"numeric",maxLength:11,placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Es,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(q,{value:L&&((m=Je.find(t=>t.id===L))==null?void 0:m.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base bg-gray-50 transition-all duration-300"})]})]}),le==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(Xt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(q,{id:"amountInput",value:de,onChange:t=>{_e(t.target.value),Gn&&Cr(!1)},onKeyDown:t=>{if(t.key==="Enter"){const s=document.getElementById("transferCommissionInput");if(s)s.focus();else{const r=document.getElementById("quickDebtButton");r==null||r.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),Va?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",Va.debtorName," بمبلغ ",Va.amount," جنيه"]}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>jr(null),children:"إلغاء"})]}):null]}),(()=>{if(P)return null;const t=_a();return t&&t.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",t==null?void 0:t.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(x,{id:"quickDebtButton",type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const s=_a(),r=(s==null?void 0:s.defaultTransferCommission)!=null?Number(s.defaultTransferCommission):0,n=parseFloat(de||"0")||0,o=Math.round((r||0)*n/1e3*100)/100,h=n+o;La((h||0).toString()),It?u({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):oa(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",className:"hidden",title:wt?"العمولة تُضاف":"العمولة تُخصم",children:wt?e.jsx(Sa,{className:"h-4 w-4 text-green-600"}):e.jsx(pr,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:wt?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Xt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(q,{id:"transferCommissionInput",value:pa,onChange:s=>Bn(s.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx(x,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const s=_a(),r=parseFloat(de||"0")||0;let n=0;if((s==null?void 0:s.defaultTransferCommission)!=null){const h=Number(s.defaultTransferCommission)||0;n=Math.round(h*r/1e3*100)/100}else{const h=pa&&pa.trim()!==""?parseFloat(pa):0;n=Math.max(0,h)}const o=r+n;La((o||0).toString()),It?u({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):oa(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",className:"hidden",title:wt?"العمولة تُضاف":"العمولة تُخصم",children:wt?e.jsx(Sa,{className:"h-4 w-4 text-green-600"}):e.jsx(pr,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:wt?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),(()=>{const t=Pi(C||"").replace(/\D/g,""),s=Pi(G||"").replace(/\D/g,"");return le==="transfer"&&(t.startsWith("010")&&(s.startsWith("011")||s.startsWith("012")||s.startsWith("015"))||t.startsWith("012")&&s.startsWith("010")||t.startsWith("011")&&s.startsWith("010")||t.startsWith("015")&&s.startsWith("010"))?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رسوم التحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Xt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(q,{id:"transferExtraFeeInput",value:po,onChange:r=>rm(r.target.value),placeholder:"أدخل رسوم التحويل",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"hidden",children:"تُخصم من المحفظة وتضاف للدرج — لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010"})]}):null})(),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(x,{id:"transferSubmitButton",onClick:Uc,className:"btn-transfer-confirm w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 text-white",children:Gn?"تم التحويل بنجاح":"تأكيد التحويل"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Tn,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-green-500"}),e.jsx(q,{id:"amountInput",value:de,onChange:t=>{_e(t.target.value),To&&Vr(!1)},onKeyDown:t=>{if(t.key==="Enter"){const s=document.getElementById("manualWithdrawCommissionInput");if(s)s.focus();else{const r=document.getElementById("withdrawSubmitButton");r==null||r.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),nm&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"اسم الراسل (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsx(wi,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-500"}),e.jsx(q,{id:"withdrawSenderNameInput",value:Re,onChange:t=>qe(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const s=document.getElementById("manualWithdrawCommissionInput");s==null||s.focus()}},placeholder:"أدخل اسم الراسل إن وجد",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500",type:"text"})]})]}),(()=>{const t=_a();return t&&t.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",t==null?void 0:t.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(x,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const s=_a(),r=parseFloat(de||"0")||0,n=(s==null?void 0:s.defaultWithdrawCommission)!=null&&Number(s.defaultWithdrawCommission)||0,o=Math.round(n*r/1e3*100)/100,h=wt?r+o:r;La((h||0).toString()),It?u({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):oa(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>zn(s=>!s),title:wt?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:wt?e.jsx(Sa,{className:"h-4 w-4"}):e.jsx(pr,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:wt?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Xt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(q,{id:"manualWithdrawCommissionInput",value:xa,onChange:s=>Wn(s.target.value),onKeyDown:s=>{if(s.key==="Enter"){const r=document.getElementById("withdrawSubmitButton");r==null||r.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(x,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const s=_a(),r=parseFloat(de||"0")||0;let n=0;if((s==null?void 0:s.defaultWithdrawCommission)!=null){const h=Number(s.defaultWithdrawCommission)||0;n=Math.round(h*r/1e3*100)/100}else{const h=xa&&xa.trim()!==""?parseFloat(xa):Math.round(r*.01*100)/100;n=Math.max(0,h)}const o=wt?r+n:r;La((o||0).toString()),It?u({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):oa(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",title:wt?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>zn(s=>!s),children:wt?e.jsx(Sa,{className:"h-4 w-4 text-green-600"}):e.jsx(pr,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:wt?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),(v==null?void 0:v.showWithdrawNote)&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"ملاحظة السحب (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsx(zc,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(q,{id:"withdrawNoteInput",value:Ee,onChange:t=>Pe(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const s=document.getElementById("withdrawSubmitButton");s==null||s.focus()}},placeholder:"أدخل ملاحظة للسحب (اختياري)",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(x,{id:"withdrawSubmitButton",onClick:Uc,className:"w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:To?"تم السحب بنجاح":"تأكيد السحب"})})]}),e.jsx(Se,{open:ze,onOpenChange:oa,children:e.jsxs(Ie,{children:[e.jsxs(Ce,{children:[e.jsx(De,{children:"تحويل مؤجل"}),e.jsx(va,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[Ga&&Ga.length>0?e.jsxs("div",{children:[e.jsx(ee,{children:"اختيار عميل"}),e.jsxs(Gs,{value:wr,onValueChange:t=>{Nr(t);const s=Ga.find(r=>r.id===t);s&&Ja(s.name)},children:[e.jsx(Ks,{className:"w-full",children:e.jsx(Hs,{placeholder:"اختر عميل"})}),e.jsx(Qs,{children:Ga.map(t=>e.jsxs(ps,{value:t.id,children:[t.name,t.mobile?` — ${t.mobile}`:""]},t.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx(q,{id:"quickDebtName",value:hs,onChange:t=>Ja(t.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx(q,{id:"quickDebtAmount",type:"number",value:ar,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"quickDebtCommission",children:"العمولة (محسوبة تلقائياً)"}),e.jsx(q,{id:"quickDebtCommission",type:"number",value:function(){const t=_a(),s=parseFloat((de||"0").toString())||0;let r=0;if(le==="transfer")if((t==null?void 0:t.defaultTransferCommission)!=null){const n=Number(t.defaultTransferCommission)||0;r=Math.round(n*s/1e3*100)/100}else{const n=pa&&pa.trim()!==""?parseFloat(pa):0;r=Math.max(0,n)}else if((t==null?void 0:t.defaultWithdrawCommission)!=null){const n=Number(t.defaultWithdrawCommission)||0;r=Math.round(n*s/1e3*100)/100}else{const n=xa&&xa.trim()!==""?parseFloat(xa):Math.round(s*.01*100)/100;r=Math.max(0,n)}return String(r||0)}(),readOnly:!0,placeholder:"قيمة العمولة"})]}),e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx(q,{id:"quickDebtNotes",value:Ya,onChange:t=>As(t.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(ot,{children:e.jsx(x,{type:"button",variant:"default",className:"bg-green-600 text-white hover:bg-green-700",onClick:()=>{const t=_a(),s=parseFloat((de||"").toString())||0;let r=0;if(le==="transfer")if((t==null?void 0:t.defaultTransferCommission)!=null){const h=Number(t.defaultTransferCommission)||0;r=Math.round(h*s/1e3*100)/100}else{const h=pa&&pa.trim()!==""?parseFloat(pa):0;r=Math.max(0,h)}else if((t==null?void 0:t.defaultWithdrawCommission)!=null){const h=Number(t.defaultWithdrawCommission)||0;r=Math.round(h*s/1e3*100)/100}else{const h=xa&&xa.trim()!==""?parseFloat(xa):Math.round(s*.01*100)/100;r=Math.max(0,h)}let n=0;if(le==="withdraw"?n=wt?s:Math.max(0,Math.round((s-r)*100)/100):n=Math.max(0,Math.round((s+r)*100)/100),!hs||isNaN(n)||n<=0){u({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const o=Ga.find(h=>h.id===wr);jr({debtorName:hs,amount:n,notes:Ya,customerId:wr||void 0,mobile:o==null?void 0:o.mobile}),$i(!1),oa(!1),u({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx(Ft,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(Wt,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(b0,{isOpen:cm,onClose:()=>dm(!1),initialEditingWallet:mm,onWalletUpdate:async()=>{try{await Wl()}catch(t){console.error("Error reloading wallets after update:",t)}}}),e.jsx(w0,{isOpen:xm,onClose:()=>wo(!1),transaction:hm,onDelete:Wu}),e.jsx(ya,{open:ym,onOpenChange:Jr,onSuccess:qu,title:Ju(),description:Yu(),mode:"verify"}),e.jsx(ld,{open:ou,onOpenChange:dc,onSuccess:Gu,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:$t,balanceLabel:"الرصيد النقدي",userId:a==null?void 0:a.uid}),e.jsx(ld,{open:cu,onOpenChange:mc,onSuccess:Ku,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:Ua&&lt[Ua]||0,balanceLabel:`رصيد ${((c=Je.find(t=>t.id===Ua))==null?void 0:c.name)||"المحفظة"}`,userId:a==null?void 0:a.uid}),e.jsx(I0,{open:du,onOpenChange:Nl,onSuccess:Hu,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:Ua&&lt[Ua]||0,balanceLabel:`رصيد ${((f=Je.find(t=>t.id===Ua))==null?void 0:f.name)||"المحفظة"}`,userId:a==null?void 0:a.uid}),e.jsx(N0,{open:Nu,onOpenChange:ju,userId:a==null?void 0:a.uid}),e.jsx(j0,{open:Su,onOpenChange:Iu,userId:a==null?void 0:a.uid}),e.jsx(S0,{open:Cu,onOpenChange:Du}),e.jsx(Se,{open:hu,onOpenChange:tn,children:e.jsxs(Ie,{className:"sm:max-w-md",children:[e.jsx(Ce,{children:e.jsx(De,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(ee,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(q,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:Sl,onChange:t=>an(t.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(x,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:async()=>{if(!await yn(Ol)){u({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(Sl);if(isNaN(t)||t<=0){u({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const s=$t+t;Zt(s);const r={cashBalance:s,lastUpdated:new Date().toISOString()},n=`userData_${a==null?void 0:a.uid}`;localStorage.setItem(n,JSON.stringify(r)),a!=null&&a.uid?je.updateUserData(a.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(n),st(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),st(!0)}):st(!0),u({title:"تم بنجاح",description:`تم إضافة ${t} جنيه إلى الدرج النقدية وحفظه في السحابة`}),tn(!1),an(""),on("")},children:[e.jsx(Sa,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(x,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:async()=>{if(!await yn(Ol)){u({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(Sl);if(isNaN(t)||t<=0){u({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const s=$t-t;Zt(s);const r={cashBalance:s,lastUpdated:new Date().toISOString()},n=`userData_${a==null?void 0:a.uid}`;localStorage.setItem(n,JSON.stringify(r)),a!=null&&a.uid?je.updateUserData(a.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(n),st(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),st(!0)}):st(!0),u({title:"تم بنجاح",description:`تم خصم ${t} جنيه من الدرج النقدية وحفظه في السحابة`}),tn(!1),an(""),on("")},children:[e.jsx(pr,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",$t.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(ee,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx(q,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:Ol,onChange:t=>on(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(ot,{className:"flex gap-2",children:e.jsx(x,{variant:"outline",onClick:()=>{tn(!1),an(""),on("")},children:"إلغاء"})})]})}),e.jsx(Se,{open:Pu,onOpenChange:gn,children:e.jsxs(Ie,{className:"sm:max-w-md",children:[e.jsx(Ce,{children:e.jsx(De,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(lt).reduce((t,s)=>t+s,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(ee,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(q,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل الرقم السري الرئيسي",value:Pc,onChange:t=>fn(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(ot,{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{gn(!1),fn("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",onClick:async()=>{if(!await Ia.verifyMasterPin(Pc,a==null?void 0:a.uid)){u({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const t={};Object.keys(lt).forEach(o=>{t[o]=0}),ca(t),localStorage.setItem(Ta(),JSON.stringify(t)),gn(!1),fn("");const s=new Date().toISOString(),r={walletBalances:t,lastUpdated:s},n=`userData_${a==null?void 0:a.uid}`;localStorage.setItem(n,JSON.stringify(r)),a!=null&&a.uid?je.updateUserData(a.uid,r).then(()=>{localStorage.removeItem(n),st(!1)}).catch(o=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",o),st(!0),u({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):st(!0),setTimeout(()=>{ca({...t})},100)}catch(t){console.error("خطأ في تصفير أرصدة المحافظ:",t),u({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(Se,{open:mu,onOpenChange:en,children:e.jsxs(Ie,{className:"sm:max-w-md",children:[e.jsx(Ce,{children:e.jsx(De,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((j=Je.find(t=>t.id===L))==null?void 0:j.name)||L]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(L&&lt[L]?lt[L]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(ee,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(q,{id:"resetSelectedWalletPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:uc,onChange:t=>jl(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(ot,{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{en(!1),jl("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",onClick:async()=>{var t;if(!L){u({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await Ia.verifyMasterPin(uc,a==null?void 0:a.uid)){u({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const s={...lt};s[L]=0,ca(s),localStorage.setItem(Ta(),JSON.stringify(s)),en(!1),jl("");const r=new Date().toISOString(),n={walletBalances:s,lastUpdated:r},o=`userData_${a==null?void 0:a.uid}`;localStorage.setItem(o,JSON.stringify(n)),a!=null&&a.uid?je.updateUserData(a.uid,n).then(()=>{localStorage.removeItem(o),st(!1)}).catch(h=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",h),st(!0),u({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):st(!0),u({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((t=Je.find(h=>h.id===L))==null?void 0:t.name)||L}`})}catch(s){console.error("خطأ في تصفير رصيد المحفظة المختارة:",s),u({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(Se,{open:_u,onOpenChange:hn,children:e.jsxs(Ie,{className:"sm:max-w-md",children:[e.jsx(Ce,{children:e.jsxs(De,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(Sa,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(lt).reduce((t,s)=>t+s,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx(q,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:Dc,onChange:t=>Pl(t.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx(q,{id:"addWalletTotalPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري",value:Ac,onChange:t=>Fl(t.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(ot,{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{hn(!1),Pl(""),Fl("")},children:"إلغاء"}),e.jsx(x,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:kc,onClick:async()=>{const t=parseFloat(Dc);if(!t||t<=0){u({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!await Mu(Ac)){u({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}_c(!0);try{const s=Object.values(lt).reduce((r,n)=>r+n,0);if(s===0){const r=Object.keys(lt),n=t/r.length,o={};r.forEach(h=>{o[h]=n}),ca(o),localStorage.setItem(Ta(),JSON.stringify(o)),a!=null&&a.uid?await je.updateUserData(a.uid,{walletBalances:o,lastUpdated:new Date().toISOString()}):st(!0)}else{const r={};Object.entries(lt).forEach(([n,o])=>{const h=o/s,p=t*h;r[n]=o+p}),ca(r),localStorage.setItem(Ta(),JSON.stringify(r)),a!=null&&a.uid?await je.updateUserData(a.uid,{walletBalances:r,lastUpdated:new Date().toISOString()}):st(!0)}setTimeout(()=>{ca(r=>({...r}))},100),hn(!1),Pl(""),Fl("")}catch(s){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",s),u({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{_c(!1)}},children:kc?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(Se,{open:Fu,onOpenChange:vn,children:e.jsxs(Ie,{className:"sm:max-w-[425px]",children:[e.jsx(Ce,{children:e.jsxs(De,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(da,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(ee,{htmlFor:"resetCashPin",children:"الرقم السري الرئيسي"}),e.jsx(q,{id:"resetCashPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:Ll,onChange:t=>Ml(t.target.value)})]})]}),e.jsxs(ot,{children:[e.jsx(x,{variant:"outline",onClick:()=>{vn(!1),Ml("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",onClick:async()=>{if(!Ll){u({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await Ia.verifyMasterPin(Ll,a==null?void 0:a.uid)){u({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{Zt(0),vn(!1),Ml("");const t={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem(Ma(),"0");const s=`userData_${a==null?void 0:a.uid}`;localStorage.setItem(s,JSON.stringify(t)),a!=null&&a.uid?je.updateUserData(a.uid,t).then(()=>{localStorage.removeItem(s),st(!1)}).catch(r=>{console.error("خطأ في حفظ الرصيد في Firebase:",r),st(!0),u({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):st(!0)}catch(t){console.error("خطأ في تصفير الرصيد النقدي:",t),u({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(T0,{open:ku,onOpenChange:Cc,userId:a==null?void 0:a.uid,cashBalance:$t,walletBalances:lt,transactions:Ze}),e.jsx(Se,{open:Au,onOpenChange:Zr,children:e.jsxs(Ie,{className:"sm:max-w-[425px]",children:[e.jsx(Ce,{children:e.jsxs(De,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(Sa,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx(q,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:cr,onChange:t=>cn(t.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{className:"text-right",children:"هل تريد إضافة ملاحظة؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{type:"button",variant:ti==="yes"?"default":"outline",onClick:()=>ai("yes"),className:"flex-1",children:"نعم"}),e.jsx(x,{type:"button",variant:ti==="no"?"default":"outline",onClick:async()=>{if(ai("no"),!cr||parseFloat(cr)<=0){u({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!ei){u({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await yn(ei)){u({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}mn(!0);try{const t=parseFloat(cr),s=$t+t;Zt(s),localStorage.setItem(Ma(),s.toString());const r={cashBalance:s,lastUpdated:new Date().toISOString()},n=`userData_${a==null?void 0:a.uid}`;localStorage.setItem(n,JSON.stringify(r));const o=`CASHADD-${(a==null?void 0:a.uid)||"anon"}-${Date.now()}`;Zr(!1),cn(""),dn(""),ai(null),un("");const h=[];if(a!=null&&a.uid){h.push(je.updateUserData(a.uid,r).then(()=>{localStorage.removeItem(n),st(!1)}).catch(()=>{st(!0)}));const p={txnType:"cash_addition",type:"cash_addition",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:o,title:"إيصال إضافة نقدية",merchantUserId:a.uid,createdBy:a.uid,shopId:(v==null?void 0:v.shopId)||void 0};h.push(je.saveUserTransaction(a.uid,p));const g=v==null?void 0:v.shopId;if(g){const w=Le(Y,"dashboardData",g);h.push(Ut(w,{cashBalance:s}))}}Promise.allSettled(h).then(()=>{}).catch(()=>{})}catch{Zt($t),localStorage.setItem("cashBalance",$t.toString()),u({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{mn(!1)}},className:"flex-1",children:"لا"})]})]}),ti==="yes"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"addCashNote",children:"الملاحظة"}),e.jsx(q,{id:"addCashNote",type:"text",placeholder:"اكتب الملاحظة",value:El,onChange:t=>un(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx(q,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:ei,onChange:t=>dn(t.target.value)})]})]}),e.jsxs(ot,{children:[e.jsx(x,{variant:"outline",onClick:()=>{Zr(!1),cn(""),dn(""),ai(null),un("")},children:"إلغاء"}),e.jsx(x,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:Ic,onClick:async()=>{if(!cr||parseFloat(cr)<=0){u({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!ei){u({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await yn(ei)){u({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}if(ti==="yes"&&El.trim().length===0){u({title:"تنبيه",description:"أدخل الملاحظة أو اختر لا",variant:"destructive"});return}mn(!0);try{const t=parseFloat(cr),s=$t+t;Zt(s),localStorage.setItem(Ma(),s.toString());const r={cashBalance:s,lastUpdated:new Date().toISOString()},n=`userData_${a==null?void 0:a.uid}`;localStorage.setItem(n,JSON.stringify(r));const o=`CASHADD-${(a==null?void 0:a.uid)||"anon"}-${Date.now()}`;Zr(!1),cn(""),dn(""),ai(null),un("");const h=[];if(a!=null&&a.uid){h.push(je.updateUserData(a.uid,r).then(()=>{localStorage.removeItem(n),st(!1)}).catch(()=>{st(!0)}));const p={txnType:"cash_addition",type:"cash_addition",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:o,note:ti==="yes"?El.trim():void 0,title:"إيصال إضافة نقدية",merchantUserId:a.uid,createdBy:a.uid,shopId:(v==null?void 0:v.shopId)||void 0};h.push(je.saveUserTransaction(a.uid,p));const g=v==null?void 0:v.shopId;if(g){const w=Le(Y,"dashboardData",g);h.push(Ut(w,{cashBalance:s}))}}Promise.allSettled(h).then(()=>{}).catch(()=>{})}catch{Zt($t),localStorage.setItem("cashBalance",$t.toString()),u({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{mn(!1)}},children:Ic?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(Se,{open:lu,onOpenChange:wl,children:e.jsxs(Ie,{className:"sm:max-w-md",children:[e.jsx(Ce,{children:e.jsx(De,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(ee,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx(q,{id:"search-date",type:"date",value:Ui,onChange:t=>ko(t.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(ee,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx(q,{id:"search-time",type:"time",value:Wi,onChange:t=>_o(t.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(ot,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>{ko(""),_o(""),wl(!1)},children:"مسح"}),e.jsx(x,{onClick:()=>wl(!1),children:"تطبيق"})]})]})}),e.jsx(k0,{isOpen:Am,onClose:()=>Hn(!1)}),e.jsx(_0,{isOpen:Yn,onClose:()=>qr(!1),initialBarcode:lm}),e.jsx(Th,{isOpen:Tm,onClose:()=>Ri(!1)}),e.jsx($h,{open:$m,onOpenChange:zi}),e.jsx(Y0,{open:Om,onOpenChange:t=>{if(t&&!ws){u({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}qi(t)}}),e.jsx(Z0,{open:ge,onOpenChange:t=>{if(t&&!ws){u({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}fe(t)}}),e.jsx(ex,{open:ne,onOpenChange:t=>{if(t&&!ws){u({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}Ue(t)}}),e.jsx(ya,{open:pu,onOpenChange:vc,onSuccess:()=>Dl(!0),title:"تقاريرك",description:"أدخل الرقم السري الرئيسي للوصول إلى تقاريرك",mode:"verify"}),e.jsx(Se,{open:Cl,onOpenChange:Dl,children:e.jsxs(Ie,{className:"sm:max-w-xl",children:[e.jsxs(Ce,{children:[e.jsxs(De,{className:"flex items-center gap-2",children:[e.jsx(Qc,{className:"h-4 w-4 text-blue-600"}),"تقارير اليوم"]}),e.jsx(va,{children:"ملخص معاملات اليوم محفوظ لآخر 30 يومًا مع أرشفة في السحابة"})]}),e.jsxs("div",{className:"space-y-4",children:[(()=>{const t=new Date().toDateString(),s=Ze.filter(g=>{const w=new Date(g.createdAt).toDateString(),y=String(g.status||"completed").toLowerCase();return w===t&&(y==="completed"||y==="confirmed")}),r=s.length,n=s.reduce((g,w)=>g+Number(w.amount||0),0),o=s.filter(g=>g.type==="withdraw").reduce((g,w)=>g+Number(w.amount||0),0),h=s.filter(g=>g.type==="send").reduce((g,w)=>g+Number(w.amount||0),0),p=s.reduce((g,w)=>g+Number(ja.calculateTransactionProfit(w)||0),0);return e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-blue-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-blue-700",children:"عدد المعاملات"}),e.jsx("div",{className:"text-lg font-bold text-blue-800",children:r})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-indigo-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-indigo-700",children:"إجمالي المبالغ"}),e.jsx("div",{className:"text-lg font-bold text-indigo-800",children:Number(n).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-red-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-red-700",children:"المبالغ المسحوبة"}),e.jsx("div",{className:"text-lg font-bold text-red-800",children:Number(o).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-green-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-green-700",children:"المبالغ المرسلة"}),e.jsx("div",{className:"text-lg font-bold text-green-800",children:Number(h).toFixed(2)})]}),e.jsxs("div",{className:"col-span-2 rounded-lg p-3 bg-gradient-to-r from-amber-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-amber-700",children:"الأرباح"}),e.jsx("div",{className:"text-lg font-bold text-amber-800",children:Number(p).toFixed(2)})]})]})})(),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(x,{variant:"default",onClick:async()=>{try{if(!(a!=null&&a.uid))return;const t=new Date,s=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0"),o=`${s}-${r}-${n}`,h=t.toDateString(),p=Ze.filter(I=>{const k=new Date(I.createdAt).toDateString(),W=String(I.status||"completed").toLowerCase();return k===h&&(W==="completed"||W==="confirmed")}),g=p.length,w=p.reduce((I,k)=>I+Number(k.amount||0),0),y=p.filter(I=>I.type==="withdraw").reduce((I,k)=>I+Number(k.amount||0),0),N=p.filter(I=>I.type==="send").reduce((I,k)=>I+Number(k.amount||0),0),_=p.reduce((I,k)=>I+Number(ja.calculateTransactionProfit(k)||0),0);await ci.add({userId:a.uid,reportDate:o,totalTransactions:g,totalAmount:Number(w.toFixed(2)),totalWithdrawn:Number(y.toFixed(2)),totalSent:Number(N.toFixed(2)),profit:Number(_.toFixed(2)),walletId:null});try{await ci.trimToMaxCount(a.uid,30)}catch{}u({title:"تم الأرشفة",description:`تم حفظ تقرير ${o}`})}catch{u({title:"فشل الأرشفة",description:"تعذر حفظ التقرير",variant:"destructive"})}},children:"أرشفة اليوم"}),e.jsx(x,{variant:"outline",onClick:()=>Dl(!1),children:"إغلاق"})]}),e.jsx("div",{className:"mt-2 border-t pt-2",children:e.jsx("div",{className:"space-y-2 max-h-[40vh] overflow-auto",children:yc.length===0?e.jsx("div",{className:"text-xs text-muted-foreground",children:"لا توجد تقارير محفوظة"}):yc.map(t=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:t.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",t.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalAmount).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalWithdrawn).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalSent).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:Number(t.profit??0).toFixed(2)})]})]})]},t.id||`${t.userId}-${t.reportDate}`))})})]})]})}),e.jsx(Se,{open:xu,onOpenChange:t=>{if(t){u({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}Il(!1)},children:e.jsxs(Ie,{dir:"rtl",className:"sm:max-w-md w-[95vw] sm:w-auto rounded-2xl border border-emerald-200 shadow-xl bg-gradient-to-br from-white via-green-50 to-emerald-50 backdrop-blur-md data-[state=open]:animate-in data-[state=open]:fade-in-0 data-[state=open]:zoom-in-90 data-[state=open]:slide-in-from-bottom-8 duration-300",children:[e.jsxs(Ce,{children:[e.jsx(De,{className:"text-right text-green-700",children:"شحن رصيد الموبايل"}),e.jsx(va,{className:"text-right text-gray-600",children:"أدخل البيانات ثم اضغط تأكيد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"topupPhone",className:"text-right block",children:"رقم الموبايل"}),e.jsx(q,{id:"topupPhone",value:sn,onChange:t=>hc(t.target.value),placeholder:"010xxxxxxx",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx(ee,{className:"text-right block",children:"شركة التشغيل"}),e.jsxs(Gs,{value:rn,onValueChange:xc,children:[e.jsx(Ks,{className:"text-right",children:e.jsx(Hs,{placeholder:"اختر الشركة"})}),e.jsxs(Qs,{children:[e.jsx(ps,{value:"vodafone",children:"فودافون"}),e.jsx(ps,{value:"orange",children:"أورنج"}),e.jsx(ps,{value:"etisalat",children:"اتصالات"}),e.jsx(ps,{value:"we",children:"WE"})]})]})]}),e.jsxs("div",{children:[e.jsx(ee,{htmlFor:"topupAmount",className:"text-right block",children:"المبلغ بالجنيه"}),e.jsx(q,{id:"topupAmount",type:"number",value:nn,onChange:t=>pc(t.target.value?Number(t.target.value):""),placeholder:"50",className:"text-right"})]})]}),e.jsxs(ot,{className:"flex gap-2 justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>Il(!1),className:"border-gray-300",children:"إلغاء"}),e.jsx(x,{onClick:D,disabled:gc||!sn||!rn||!nn,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:gc?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})}),e.jsx(ya,{open:qm,onOpenChange:Zn,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{Zn(!1),Ar(!0)}}),e.jsx(ya,{open:Ym,onOpenChange:Bo,mode:"verify",title:"تأكيد تغيير طلب الرقم السري للديون",description:"أدخل الرقم السري الرئيسي لتفعيل أو إلغاء طلب الرقم السري عند فتح الديون",onSuccess:async()=>{if(Ro!==null){const t=Ro;Wo(t);try{const s=a==null?void 0:a.uid,r=s?`debtsPinRequired_${s}`:"debtsPinRequired";localStorage.setItem(r,String(t)),s&&await je.updateUserData(s,{debtsPinRequired:t})}catch{}u({title:t?"تم تفعيل طلب الرقم السري للديون":"تم إلغاء طلب الرقم السري للديون",description:t?"سيُطلب الرقم السري الرئيسي عند فتح نافذة الديون.":"يمكن فتح نافذة الديون بدون طلب الرقم السري."})}Vm(null),Bo(!1)}}),e.jsx(Ih,{open:uu,onOpenChange:Qr,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"سيتم حذف كل المعاملات السابقة نهائيًا من حسابك وFirebase.",onSuccess:async()=>{try{if(!(a!=null&&a.uid)){Qr(!1);return}const t=new Date,s=n=>n instanceof Date?n:typeof(n==null?void 0:n.toDate)=="function"?n.toDate():new Date(String(n)),r=Ze.filter(n=>s(n.createdAt)<t);await je.updateUserData(a.uid,{recentReset:{keepLastCount:$c.keepLastCount??30,intervalDays:$c.intervalDays??7,lastResetAt:t}}),xn(n=>({...n,lastResetAt:t})),u({title:"تم إخفاء المعاملات السابقة",description:"تم إخفاء كل الإيصالات الأقدم من وقت التصفير من العرض بدون التأثير على تقارير اليوم/الشهر أو الحدود."})}catch(t){console.error("فشل تنفيذ التصفير النهائي:",t),u({title:"فشل التصفير",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}finally{Qr(!1)}}}),e.jsx(ya,{open:Ne,onOpenChange:ce,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{ce(!1),he(!0)}}),e.jsx(Se,{open:zm,onOpenChange:Ar,children:e.jsxs(Ie,{className:"sm:max-w-[425px]",children:[e.jsxs(Ce,{className:"flex items-center justify-between",children:[e.jsx(De,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx(ed,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[zu," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(x,{variant:kr==="debtor"?"default":"outline",onClick:()=>Yo("debtor"),children:"مدين"}),e.jsx(x,{variant:kr==="creditor"?"default":"outline",onClick:()=>Yo("creditor"),children:"دائن"})]}),kr==="creditor"&&e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(ee,{htmlFor:"debtorName",className:"text-right col-span-1",children:"اسم المديون"}),e.jsx(q,{id:"debtorName",value:el,onChange:t=>zo(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل اسم المديون"})]}),kr&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(ee,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(q,{id:"debtAmount",type:"number",value:tl,onChange:t=>qo(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(ee,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx(q,{id:"debtReason",value:al,onChange:t=>Jo(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]})]}),e.jsx(ot,{children:e.jsx(x,{onClick:()=>{const t=kr==="debtor",s=kr==="creditor";if(!t&&!s){u({title:"اختر نوع الدين",description:"يرجى اختيار مدين أو دائن أولاً",variant:"destructive"});return}if(!tl||!al||s&&!el){u({title:"بيانات غير مكتملة",description:s?"يرجى إدخال الاسم والمبلغ والسبب":"يرجى إدخال المبلغ والسبب",variant:"destructive"});return}const r={id:Date.now().toString(),debtorName:t?"مدين":el,amount:parseFloat(tl),reason:al,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};Qi(r),Tr(!0)},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(x,{variant:"outline",className:"w-full",onClick:()=>_r(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(x,{variant:"outline",className:"w-full",onClick:()=>dl(!0),children:"إضافة عميل"})})]})}),e.jsx(Se,{open:nl,onOpenChange:_r,children:e.jsxs(Ie,{className:"sm:max-w-[520px]",children:[e.jsxs(Ce,{children:[e.jsx(De,{className:"text-right",children:"إيصالات الديون"}),e.jsx(va,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),St.length>0?e.jsxs("div",{className:"max-h-64 overflow-y-auto space-y-2",onScroll:t=>{const s=t.currentTarget;ol.length<St.length&&s.scrollTop+s.clientHeight>=s.scrollHeight-50&&ll(r=>r+1)},children:[ol.map(t=>e.jsx("div",{onClick:()=>{ir(t),Bs(!0),_r(!1),Ar(!1)},className:"p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium",children:t.debtorName}),e.jsx("p",{className:"text-sm text-gray-600",children:t.reason}),e.jsx("p",{className:"text-sm text-gray-500",children:wn.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-lg",children:[t.amount," جنيه"]}),e.jsx(ta,{variant:t.status==="paid"?"default":"secondary",className:t.status==="paid"?"bg-green-500":"bg-yellow-500",children:t.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},t.id)),ol.length<St.length&&e.jsx("div",{className:"flex justify-center pt-1",children:e.jsx(x,{variant:"outline",size:"sm",onClick:()=>ll(t=>t+1),children:"تحميل المزيد"})})]}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"}),e.jsxs(ot,{className:"flex justify-between mt-3",children:[e.jsx(x,{variant:"destructive",onClick:async()=>{try{if(!St||St.length===0){u({title:"لا توجد ديون",description:"القائمة فارغة بالفعل."});return}if(!window.confirm("هل تريد حذف كل إيصالات الديون؟ هذا الإجراء لا يمكن التراجع عنه."))return;const t=[];if(ga(t),ir(null),await Qa(t),a!=null&&a.uid)try{await je.updateUserData(a.uid,{debts:[],debtsDeletedAt:dt()});try{localStorage.removeItem(`debts_unsynced_${a.uid}`)}catch{}}catch(s){console.error("تعذر حذف الديون من Firebase:",s),u({title:"فشل الحذف من السحابة",description:"تعذر حذف الإيصالات من Firebase، حاول مرة أخرى.",variant:"destructive"});return}u({title:"تم حذف كل إيصالات الديون",description:"تم تفريغ القائمة بالكامل."}),_r(!1)}catch(t){console.error("تعذر حذف كل إيصالات الديون:",t),u({title:"فشل الحذف",description:"حدث خطأ أثناء الحذف، حاول مرة أخرى.",variant:"destructive"})}},children:"حذف كل الإيصالات"}),e.jsx(x,{variant:"outline",onClick:()=>_r(!1),children:"إغلاق"})]})]})}),e.jsx(Se,{open:Xm,onOpenChange:dl,children:e.jsxs(Ie,{className:"sm:max-w-[480px]",children:[e.jsxs(Ce,{children:[e.jsx(De,{className:"text-right",children:"إضافة عميل"}),e.jsx(va,{className:"text-right",children:"أدخل بيانات العميل ثم يمكنك تسجيل مبلغ دين عليه"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(ee,{htmlFor:"customerName",className:"text-right col-span-1",children:"اسم العميل"}),e.jsx(q,{id:"customerName",value:ul,onChange:t=>Xo(t.target.value),className:"col-span-3 text-right",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(ee,{htmlFor:"customerMobile",className:"text-right col-span-1",children:"رقم الموبايل"}),e.jsx(q,{id:"customerMobile",value:hl,onChange:t=>Zo(t.target.value),className:"col-span-3 text-right",placeholder:"اكتب رقم الموبايل"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(x,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!ul||!hl){u({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const t={id:Date.now().toString(),name:ul.trim(),mobile:hl.trim(),createdAt:new Date},s=[t,...Ga];await _l(s),Xo(""),Zo(""),u({title:"تمت إضافة العميل",description:`تم إضافة ${t.name}`})},children:"إضافة"})}),e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx(ee,{className:"text-right block",children:"إضافة مبلغ على عميل"}),Ga.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(Gs,{value:Gi,onValueChange:ec,children:[e.jsx(Ks,{className:"w-full",children:e.jsx(Hs,{placeholder:"اختر عميل"})}),e.jsx(Qs,{children:Ga.map(t=>e.jsxs(ps,{value:t.id,children:[t.name," — ",t.mobile]},t.id))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(ee,{htmlFor:"customerDebtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(q,{id:"customerDebtAmount",type:"number",value:tc,onChange:t=>Zm(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(x,{className:"bg-orange-600 hover:bg-orange-700",onClick:async()=>{const t=parseFloat(tc);if(!Gi){u({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(t)||t<=0){u({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const s=Ga.find(n=>n.id===Gi);if(!s)return;const r={id:Date.now().toString(),debtorName:s.name,customerId:s.id,mobile:s.mobile,amount:Number(t.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};Qi(r),Tr(!0)},children:"إضافة المبلغ"})})]}):e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد عملاء مسجلين. أضف عميلًا أولاً."})]}),e.jsxs("div",{className:"border-t pt-4 space-y-2",children:[e.jsx(ee,{className:"text-right block",children:"إدارة العملاء"}),Ga.length>0?e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:Ga.map(t=>e.jsxs("div",{className:"p-2 border rounded-md flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium text-sm",children:t.name}),e.jsx("div",{className:"text-xs text-gray-600",children:t.mobile})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:()=>{ac(t.id),xl(t.name||""),pl(t.mobile||""),Ki(!0)},children:"تعديل"}),e.jsx(x,{variant:"destructive",size:"sm",onClick:()=>{gl(t.id),fl(t.name||""),Hi(!0)},children:"حذف نهائي"})]})]},t.id))}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً."})]})]}),e.jsx(ot,{className:"flex justify-end",children:e.jsx(x,{variant:"outline",onClick:()=>dl(!1),children:"إغلاق"})})]})}),e.jsx(Se,{open:au,onOpenChange:Hi,children:e.jsxs(Ie,{hideClose:!0,className:"sm:max-w-[420px] rounded-2xl bg-gradient-to-br from-white via-rose-50 to-red-50 shadow-2xl border border-red-100 text-center",children:[e.jsxs(Ce,{children:[e.jsx(De,{className:"text-center text-xl font-bold text-red-700",children:"تأكيد حذف العميل"}),e.jsxs(va,{className:"text-center text-gray-600",children:["سيتم حذف العميل نهائيًا: ",ic]})]}),e.jsx("div",{className:"py-2 text-sm text-gray-700",children:"لا يمكن التراجع عن هذا الإجراء."}),e.jsxs(ot,{className:"flex justify-center gap-3",children:[e.jsx(x,{variant:"outline",onClick:()=>{Hi(!1),gl(""),fl("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",className:"bg-red-600 hover:bg-red-700",onClick:async()=>{const t=su,s=Ga.filter(r=>r.id!==t);await _l(s),Gi===t&&ec(""),Hi(!1),gl(""),fl(""),u({title:"تم حذف العميل",description:ic})},children:"حذف نهائي"})]})]})}),e.jsx(Se,{open:eu,onOpenChange:Ki,children:e.jsxs(Ie,{className:"sm:max-w-[420px]",children:[e.jsx(Ce,{children:e.jsx(De,{className:"text-right",children:"تعديل بيانات العميل"})}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(ee,{htmlFor:"editCustomerName",className:"text-right col-span-1",children:"الاسم"}),e.jsx(q,{id:"editCustomerName",value:sc,onChange:t=>xl(t.target.value),className:"col-span-3 text-right"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(ee,{htmlFor:"editCustomerMobile",className:"text-right col-span-1",children:"الموبايل"}),e.jsx(q,{id:"editCustomerMobile",value:rc,onChange:t=>pl(t.target.value),className:"col-span-3 text-right"})]})]}),e.jsxs(ot,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>Ki(!1),children:"إلغاء"}),e.jsx(x,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=tu,s=sc.trim(),r=rc.trim();if(!t||!s||!r){u({title:"بيانات غير مكتملة",description:"أدخل الاسم ورقم الموبايل",variant:"destructive"});return}const n=Ga.map(h=>h.id===t?{...h,name:s,mobile:r}:h);await _l(n);const o=St.map(h=>h.customerId===t?{...h,debtorName:s,mobile:r}:h);o!==St&&(ga(o),await Qa(o)),Ki(!1),ac(""),xl(""),pl(""),u({title:"تم تحديث العميل",description:s})},children:"حفظ"})]})]})}),e.jsx(Se,{open:$,onOpenChange:he,children:e.jsxs(Ie,{className:"sm:max-w-[520px]",children:[e.jsxs(Ce,{children:[e.jsx(De,{className:"text-right",children:"مصروفات المحل"}),e.jsx(va,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(ee,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx(q,{id:"expenseName",value:Te,onChange:t=>He(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(ee,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx(q,{id:"expenseAmount",type:"number",value:Xe,onChange:t=>Be(t.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(ee,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx(q,{id:"expenseNotes",value:xe,onChange:t=>re(t.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(ot,{className:"flex justify-between",children:[e.jsx(x,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!Te||!Xe){u({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}qa(!0)},children:"إضافة مصروف"}),e.jsx(x,{variant:"outline",onClick:()=>pe(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(Se,{open:z,onOpenChange:pe,children:e.jsxs(Ie,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(Ce,{children:[e.jsx(De,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(va,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),Nt.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:Nt.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:t.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left flex items-start gap-2",children:[e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[t.amount," جنيه"]}),e.jsx(ta,{variant:"secondary",className:t.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:t.source==="cash"?"من النقدية":`من المحفظة${t.walletId?` (${t.walletId})`:""}`})]}),e.jsxs(x,{variant:"destructive",size:"sm",className:"shrink-0",onClick:()=>vu(t.id),title:"حذف نهائي",children:[e.jsx(da,{className:"w-4 h-4 ml-1"}),"حذف"]})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(Se,{open:Aa,onOpenChange:qa,children:e.jsxs(Ie,{className:"sm:max-w-[480px]",children:[e.jsx(Ce,{children:e.jsx(De,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(x,{variant:At==="cash"?"default":"outline",className:At==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>as("cash"),children:"الفلوس النقدية"}),e.jsx(x,{variant:At==="wallet"?"default":"outline",className:At==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>as("wallet"),children:"أرصدة المحافظ"}),e.jsx(x,{variant:At==="fawry"?"default":"outline",className:At==="fawry"?"bg-amber-600 hover:bg-amber-700 text-white":"",onClick:()=>as("fawry"),children:"فوري"})]}),At==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(Gs,{value:ms,onValueChange:ys,children:[e.jsx(Ks,{className:"w-full",children:e.jsx(Hs,{placeholder:"اختر محفظة"})}),e.jsx(Qs,{children:Je.map(t=>e.jsx(ps,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(ot,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>{qa(!1),as(null),ys("")},children:"إلغاء"}),e.jsx(x,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=Number(Xe);if(isNaN(t)||t<=0){u({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!At){u({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(At==="cash"){const o=Number(($t-t).toFixed(2));Zt(o),localStorage.setItem(Ma(),o.toString());const h={cashBalance:o,lastUpdated:new Date().toISOString()},p=`userData_${a==null?void 0:a.uid}`;localStorage.setItem(p,JSON.stringify(h)),a!=null&&a.uid?(await je.updateUserData(a.uid,h),localStorage.removeItem(p),st(!1)):st(!0)}else if(At==="wallet"){if(!ms){u({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const o=lt[ms]||0,h=Number((o-t).toFixed(2)),p={...lt,[ms]:h};ca(p);const g=new Date().toISOString(),w={walletBalances:p,lastUpdated:g},y=`userData_${a==null?void 0:a.uid}`;localStorage.setItem(y,JSON.stringify(w)),localStorage.setItem(Ta(),JSON.stringify(p)),localStorage.setItem(`walletBalances_backup_${g}`,JSON.stringify(p)),a!=null&&a.uid&&await je.updateUserData(a.uid,w)}}catch(o){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",o)}let s=Date.now().toString();try{if(a!=null&&a.uid){const{addDoc:o,collection:h,serverTimestamp:p}=await ht(async()=>{const{addDoc:w,collection:y,serverTimestamp:N}=await ft(()=>import("./index-C_crvORM.js").then(_=>_.c3),__vite__mapDeps([0,1]),import.meta.url).then(_=>_.c2);return{addDoc:w,collection:y,serverTimestamp:N}},xt([0,1]),import.meta.url),{db:g}=await ht(async()=>{const{db:w}=await ft(()=>import("./index-C_crvORM.js").then(y=>y.c3),__vite__mapDeps([0,1]),import.meta.url).then(y=>y.c3);return{db:w}},xt([0,1]),import.meta.url);s=(await o(h(g,"shop_expenses"),{userId:a.uid,shopId:A||(v==null?void 0:v.shopId)||a.uid||"default-shop",name:Te,amount:t,notes:xe||"",source:At,walletId:At==="wallet"?ms:null,createdAt:p()})).id}}catch(o){console.error("خطأ أثناء حفظ المصروف في Firestore:",o)}const r={id:s,name:Te,amount:t,notes:xe,source:At,walletId:At==="wallet"?ms:void 0,createdAt:new Date},n=[...Nt,r];await jc(n),He(""),Be(""),re(""),as(null),ys(""),qa(!1),he(!0),pe(!0),u({title:"تم إضافة المصروف",description:At==="cash"?"تم الخصم من النقدية":At==="wallet"?"تم الخصم من أرصدة المحافظ":"تم تسجيل الدفع عبر فوري"})},children:"تأكيد الخصم"})]})]})}),e.jsx(Se,{open:ka,onOpenChange:wa,children:e.jsxs(Ie,{className:"sm:max-w-[520px]",children:[e.jsxs(Ce,{children:[e.jsx(De,{className:"text-right",children:"النواقص"}),e.jsx(va,{className:"text-right",children:"سجل العناصر الناقصة التي تحتاج شراء وتابع حالتها."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(ee,{htmlFor:"deficiencyName",className:"text-right col-span-1",children:"اسم العنصر"}),e.jsx(q,{id:"deficiencyName",value:qt,onChange:t=>Ls(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: سكر، زيت، مناديل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(ee,{htmlFor:"deficiencyQuantity",className:"text-right col-span-1",children:"الكمية"}),e.jsx(q,{id:"deficiencyQuantity",type:"number",value:Ms,onChange:t=>tr(t.target.value),className:"col-span-3 text-right",placeholder:"1"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(x,{className:"bg-rose-600 hover:bg-rose-700",onClick:()=>{if(It){u({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}const t=parseInt(Ms||"1",10);if(!qt){u({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العنصر",variant:"destructive"});return}if(isNaN(t)||t<=0){u({title:"كمية غير صحيحة",description:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}(async()=>{if(a!=null&&a.uid)try{const{collection:r,addDoc:n,serverTimestamp:o}=await ht(async()=>{const{collection:g,addDoc:w,serverTimestamp:y}=await ft(()=>import("./index-C_crvORM.js").then(N=>N.c3),__vite__mapDeps([0,1]),import.meta.url).then(N=>N.c2);return{collection:g,addDoc:w,serverTimestamp:y}},xt([0,1]),import.meta.url),{db:h}=await ht(async()=>{const{db:g}=await ft(()=>import("./index-C_crvORM.js").then(w=>w.c3),__vite__mapDeps([0,1]),import.meta.url).then(w=>w.c3);return{db:g}},xt([0,1]),import.meta.url),p=await n(r(h,"deficiencies"),{userId:a.uid,shopId:A||(v==null?void 0:v.shopId)||a.uid||"default-shop",name:qt,quantity:t,status:"pending",createdAt:o()});try{const g=ln(),w=localStorage.getItem(g),y=w?JSON.parse(w):[],N=Array.isArray(y)?y:[],_=N.some(W=>String((W==null?void 0:W.id)||"")===p.id),I={id:p.id,name:qt,quantity:t,status:"pending",createdAt:new Date().toISOString()},k=_?N:[...N,I];localStorage.setItem(g,JSON.stringify(k))}catch{}Ls(""),tr(""),u({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"});return}catch(r){console.warn("فشل حفظ النواقص إلى Firestore، سيُستخدم التخزين المحلي:",r)}const s={id:Date.now().toString(),name:qt,quantity:t,status:"pending",createdAt:new Date};bt(r=>{const n=[...r,s];return kl(n),n}),Ls(""),tr(""),u({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"})})()},children:"إضافة للنواقص"})}),nt.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:nt.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["الكمية: ",t.quantity]}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ta,{variant:"secondary",className:t.status==="pending"?"bg-rose-100 text-rose-700":"bg-green-100 text-green-700",children:t.status==="pending"?"قيد الشراء":"تم الشراء"}),e.jsx(x,{variant:"outline",className:t.status==="pending"?"text-green-700 border-green-300 hover:bg-green-50":"text-rose-700 border-rose-300 hover:bg-rose-50",onClick:()=>{(async()=>{const s=t.status==="pending"?"purchased":"pending";if(a!=null&&a.uid)try{const{doc:r,updateDoc:n,serverTimestamp:o}=await ht(async()=>{const{doc:p,updateDoc:g,serverTimestamp:w}=await ft(()=>import("./index-C_crvORM.js").then(y=>y.c3),__vite__mapDeps([0,1]),import.meta.url).then(y=>y.c2);return{doc:p,updateDoc:g,serverTimestamp:w}},xt([0,1]),import.meta.url),{db:h}=await ht(async()=>{const{db:p}=await ft(()=>import("./index-C_crvORM.js").then(g=>g.c3),__vite__mapDeps([0,1]),import.meta.url).then(g=>g.c3);return{db:p}},xt([0,1]),import.meta.url);await n(r(h,"deficiencies",t.id),{status:s,updatedAt:o()});return}catch(r){console.warn("فشل تحديث حالة النواقص على Firestore، استخدام التخزين المحلي:",r)}bt(r=>{const n=r.map(o=>o.id===t.id?{...o,status:s}:o);return kl(n),n})})()},title:t.status==="pending"?"تم الشراء":"إلغاء الشراء",children:t.status==="pending"?"تم الشراء":"إلغاء الشراء"}),e.jsx(x,{variant:"outline",className:"text-red-700 border-red-300 hover:bg-red-50",onClick:()=>{(async()=>{if(a!=null&&a.uid)try{const{doc:s,deleteDoc:r}=await ht(async()=>{const{doc:o,deleteDoc:h}=await ft(()=>import("./index-C_crvORM.js").then(p=>p.c3),__vite__mapDeps([0,1]),import.meta.url).then(p=>p.c2);return{doc:o,deleteDoc:h}},xt([0,1]),import.meta.url),{db:n}=await ht(async()=>{const{db:o}=await ft(()=>import("./index-C_crvORM.js").then(h=>h.c3),__vite__mapDeps([0,1]),import.meta.url).then(h=>h.c3);return{db:o}},xt([0,1]),import.meta.url);await r(s(n,"deficiencies",t.id));return}catch(s){console.warn("فشل حذف عنصر النواقص من Firestore، استخدام التخزين المحلي:",s)}bt(s=>{const r=s.filter(n=>n.id!==t.id);return kl(r),r})})()},title:"حذف",children:"حذف"})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد عناصر مسجلة في النواقص"})]}),e.jsx(ot,{className:"flex justify-end",children:e.jsx(x,{variant:"outline",onClick:()=>wa(!1),children:"إغلاق"})})]})}),e.jsx(Se,{open:ru,onOpenChange:Tr,children:e.jsxs(Ie,{className:"sm:max-w-[480px]",children:[e.jsx(Ce,{children:e.jsx(De,{className:"text-right",children:"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(x,{variant:Ka==="cash"?"default":"outline",className:Ka==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>Hr("cash"),children:"الفلوس النقدية"}),e.jsx(x,{variant:Ka==="wallet"?"default":"outline",className:Ka==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>Hr("wallet"),children:"أرصدة المحافظ"}),e.jsx(x,{variant:Ka==="none"?"default":"outline",className:Ka==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>Hr("none"),children:"بدون خصم"})]}),Ka==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(Gs,{value:Xi,onValueChange:vl,children:[e.jsx(Ks,{className:"w-full",children:e.jsx(Hs,{placeholder:"اختر محفظة"})}),e.jsx(Qs,{children:Je.map(t=>e.jsx(ps,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(ot,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>{Tr(!1),Qi(null),Hr(null),vl("")},children:"إلغاء"}),e.jsx(x,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=!!Vi&&!lr,s=Number(t?Vi.delta:(lr==null?void 0:lr.amount)||0);if(!Ka){u({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(Ka==="cash"){const r=Number(($t-s).toFixed(2));Zt(r),localStorage.setItem(Ma(),r.toString());const n=new Date().toISOString(),o={cashBalance:r,lastUpdated:n},h=`userData_${a==null?void 0:a.uid}`;localStorage.setItem(h,JSON.stringify(o)),a!=null&&a.uid?await je.updateUserData(a.uid,o).then(()=>{localStorage.removeItem(h),st(!1)}).catch(()=>{st(!0)}):st(!0)}else if(Ka==="wallet"){if(!Xi){u({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const r=lt[Xi]||0,n=Number((r-s).toFixed(2)),o={...lt,[Xi]:n};ca(o);const h=new Date().toISOString(),p={walletBalances:o,lastUpdated:h},g=`userData_${a==null?void 0:a.uid}`;localStorage.setItem(g,JSON.stringify(p)),localStorage.setItem(Ta(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${h}`,JSON.stringify(o)),a!=null&&a.uid&&await je.updateUserData(a.uid,p)}}catch(r){console.error("خطأ أثناء تحديث الأرصدة عند حفظ/تعديل الدين:",r)}if(t){if(!ue)return;const r=Number(ue.amount||0),n=Number(ue.paidAmount||0),o=Number(Vi.delta||0);if(Vi.type==="decrease"){const h=Number((r-o).toFixed(2)),p=n>=h,g={...ue,amount:h,status:p?"paid":"pending"},w=St.map(y=>y.id===ue.id?g:y);ga(w),ir(g),await Qa(w);try{p&&a!=null&&a.uid&&(async()=>{const y=Ve(Ae(Y,"userTransactions"),me("userId","==",a.uid),me("linkedDebtId","==",ue.id),me("status","==","pending")),N=await et(y);await Promise.allSettled(N.docs.map(ie=>Ut(ie.ref,{status:"completed",confirmedAt:new Date})));try{const ie=N.docs.map(J=>{var ve;return String(((ve=J.data())==null?void 0:ve.transactionId)||"")});a!=null&&a.uid&&ie.forEach(J=>J&&je.removeLocalReceiptById(a.uid,J))}catch{}const _=Ve(Ae(Y,"transactions"),me("userId","==",a.uid),me("linkedDebtId","==",ue.id),me("status","==","pending")),I=await et(_);await Promise.allSettled(I.docs.map(ie=>Ut(ie.ref,{status:"completed",confirmedAt:new Date})));try{const ie=I.docs.map(J=>{var ve;return String(J.id||((ve=J.data())==null?void 0:ve.transactionId)||"")});a!=null&&a.uid&&ie.forEach(J=>J&&je.removeLocalReceiptById(a.uid,J))}catch{}const k=Ve(Ae(Y,"transactions"),me("merchantUserId","==",a.uid),me("linkedDebtId","==",ue.id),me("status","==","pending")),W=await et(k);await Promise.allSettled(W.docs.map(ie=>Ut(ie.ref,{status:"completed",confirmedAt:new Date})));try{const ie=W.docs.map(J=>{var ve;return String(J.id||((ve=J.data())==null?void 0:ve.transactionId)||"")});a!=null&&a.uid&&ie.forEach(J=>J&&je.removeLocalReceiptById(a.uid,J))}catch{}})().catch(y=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين بعد الإنقاص:",y),u({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(y){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة بعد الإنقاص:",y)}u({title:"تم إنقاص المبلغ",description:`المبلغ الجديد: ${h} جنيه`})}else{const h=r+o,p=n>=h,g={...ue,amount:Number(h.toFixed(2)),status:p?"paid":"pending"},w=St.map(y=>y.id===ue.id?g:y);ga(w),ir(g),await Qa(w),u({title:"تم زيادة المبلغ",description:`المبلغ الجديد: ${h} جنيه`})}}else if(lr){const r=[...St,lr];ga(r),await Qa(r);try{a!=null&&a.uid&&await xr.send(a.uid,`تم إضافة دين على ${lr.debtorName} بمبلغ ${lr.amount} جنيه`)}catch{}}zo(""),qo(""),Jo(""),Ar(!1),Tr(!1),Qi(null),Ko(null),Hr(null),vl(""),u({title:t?"تم تطبيق الخصم وتعديل الدين":Ka==="none"?"تم حفظ الدين بدون خصم":"تم حفظ الدين وخصم المبلغ",description:Ka==="none"?"لم يتم الخصم من الدرج أو المحافظ":Ka==="cash"?`تم خصم ${s} من الرصيد النقدي`:`تم خصم ${s} من رصيد المحفظة`})},children:"تأكيد الخصم"})]})]})}),e.jsx(Se,{open:Gm,onOpenChange:Bs,children:e.jsxs(Ie,{className:"sm:max-w-[425px]",children:[e.jsx(Ce,{children:e.jsx(De,{className:"text-right",children:"إيصال الدين"})}),ue&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:wn.format(ue.createdAt instanceof Date?ue.createdAt:new Date(ue.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:ue.debtorName})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"outline",className:"h-8 w-8 p-0","aria-label":"إنقاص الدين",onClick:()=>{Vo("decrease"),sl(""),Bs(!1),Kr(!0)},children:"−"}),e.jsxs("span",{className:"font-bold text-lg",children:[ue.amount," جنيه"]}),e.jsx(x,{variant:"outline",className:"h-8 w-8 p-0","aria-label":"زيادة الدين",onClick:()=>{Vo("increase"),sl(""),Bs(!1),Kr(!0)},children:"+"})]})]}),(()=>{try{const t=(Ze||[]).filter(s=>String((s==null?void 0:s.linkedDebtId)||"")===String(ue.id)).reduce((s,r)=>s+Math.max(0,Number((r==null?void 0:r.commission)||0)),0);return t>0?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الربح:"}),e.jsxs("span",{className:"text-green-700 font-semibold",children:[t," جنيه"]})]}):null}catch{return null}})(),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:ue.reason})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(ta,{variant:ue.status==="paid"?"default":"secondary",className:ue.status==="paid"?"bg-green-500":"bg-yellow-500",children:ue.status==="paid"?"مدفوع":"مؤجل"})]}),(()=>{try{const t=(Ze||[]).filter(g=>String((g==null?void 0:g.linkedDebtId)||"")===String(ue.id)),s=t.reduce((g,w)=>g+Math.max(0,Number((w==null?void 0:w.commission)||0)),0),r=t.reduce((g,w)=>g+Math.max(0,Number(((w==null?void 0:w.sentAmount)??(w==null?void 0:w.transferredAmount)??(w==null?void 0:w.withdrawnAmount)??(w==null?void 0:w.amount))||0)),0),n=Number(ue.amount||0),o=Number(ue.paidAmount||0),h=n<r+s?n+s:n,p=Math.max(0,Number(h)-o);return e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[p," جنيه"]})]})}catch{return e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[Number(ue.amount||0)-Number(ue.paidAmount||0)," جنيه"]})]})}})(),ue.paidAmount?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[ue.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-3 border rounded-lg bg-gray-50",children:[Hm?e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx(q,{id:"partialAmount",type:"number",value:Ho,onChange:t=>il(t.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{rl(!1),il("")},children:"إلغاء"}),e.jsx(x,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const t=parseFloat(Ho);if(!ue||isNaN(t)||t<=0){u({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const s=Math.max(0,Number(ue.amount||0)-Number(ue.paidAmount||0));if(t>s){u({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const r=Number(((ue.paidAmount||0)+t).toFixed(2)),n=r>=Number(ue.amount||0),o={...ue,amount:Number(ue.amount||0),paidAmount:r,status:n?"paid":"pending",partialPayments:[...ue.partialPayments||[],{amount:t,paidAt:new Date}]},h=St.map(p=>p.id===ue.id?o:p);ga(h),ir(o),await Qa(h);try{if(a!=null&&a.uid){const p=Math.max(0,Number(o.amount||0)-Number(o.paidAmount||0));await xr.send(a.uid,`تم سداد جزء من دين ${o.debtorName}: المدفوع ${t} جنيه، المتبقي ${p} جنيه`)}}catch{}try{o.status==="paid"&&a!=null&&a.uid&&(async()=>{const p=Ve(Ae(Y,"userTransactions"),me("userId","==",a.uid),me("linkedDebtId","==",ue.id),me("status","==","pending")),g=await et(p);await Promise.allSettled(g.docs.map(I=>Ut(I.ref,{status:"completed",confirmedAt:new Date})));try{const I=g.docs.map(k=>{var W;return String(((W=k.data())==null?void 0:W.transactionId)||"")});a!=null&&a.uid&&I.forEach(k=>k&&je.removeLocalReceiptById(a.uid,k))}catch{}const w=Ve(Ae(Y,"transactions"),me("userId","==",a.uid),me("linkedDebtId","==",ue.id),me("status","==","pending")),y=await et(w);await Promise.allSettled(y.docs.map(I=>Ut(I.ref,{status:"completed",confirmedAt:new Date})));try{const I=y.docs.map(k=>{var W;return String(k.id||((W=k.data())==null?void 0:W.transactionId)||"")});a!=null&&a.uid&&I.forEach(k=>k&&je.removeLocalReceiptById(a.uid,k))}catch{}const N=Ve(Ae(Y,"transactions"),me("merchantUserId","==",a.uid),me("linkedDebtId","==",ue.id),me("status","==","pending")),_=await et(N);await Promise.allSettled(_.docs.map(I=>Ut(I.ref,{status:"completed",confirmedAt:new Date})));try{const I=_.docs.map(k=>{var W;return String(k.id||((W=k.data())==null?void 0:W.transactionId)||"")});a!=null&&a.uid&&I.forEach(k=>k&&je.removeLocalReceiptById(a.uid,k))}catch{}})().catch(p=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",p),u({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(p){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",p)}try{const p=Tl(),g=localStorage.getItem(p);if(g){const w=(JSON.parse(g)||[]).map(y=>(y==null?void 0:y.linkedDebtId)===ue.id&&(y==null?void 0:y.status)==="pending"?{...y,status:"completed",confirmedAt:new Date}:y);localStorage.setItem(p,JSON.stringify(w)),bs(y=>y.map(N=>(N==null?void 0:N.linkedDebtId)===ue.id&&(N==null?void 0:N.status)==="pending"?{...N,status:"completed",confirmedAt:new Date}:N))}}catch(p){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",p)}Zi(t),Rs("none"),$r(!0),rl(!1),il(""),u({title:"تم تسجيل دفع جزء",description:`تم دفع ${t} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(x,{variant:"outline",className:"w-full",onClick:()=>rl(!0),children:"دفع جزء"}),ue.partialPayments&&ue.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-24 overflow-y-auto",children:ue.partialPayments.map((t,s)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["دفع: ",t.amount," جنيه"]}),e.jsx("span",{children:new Date(t.paidAt).toLocaleString("ar-EG")})]},s))})]})]})]})]}),e.jsxs(ot,{className:"flex gap-2 justify-center",children:[e.jsx(x,{onClick:async()=>{if(ue){const t=St.map(s=>s.id===ue.id?{...s,status:"pending"}:s);ga(t),await Qa(t);try{if(a!=null&&a.uid){const s=computedRemaining;await xr.send(a.uid,`تم سداد الدين بالكامل للعميل ${ue.debtorName}: المدفوع ${s} جنيه`)}}catch{}Bs(!1),u({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(x,{onClick:async()=>{if(ue){const t=Number(ue.amount||0),s=Number(ue.paidAmount||0);let r=Math.max(0,t-s);try{const h=(Ze||[]).filter(y=>String((y==null?void 0:y.linkedDebtId)||"")===String(ue.id)),p=h.reduce((y,N)=>y+Math.max(0,Number((N==null?void 0:N.commission)||0)),0),g=h.reduce((y,N)=>y+Math.max(0,Number(((N==null?void 0:N.sentAmount)??(N==null?void 0:N.transferredAmount)??(N==null?void 0:N.withdrawnAmount)??(N==null?void 0:N.amount))||0)),0),w=t<g+p?t+p:t;r=Math.max(0,Number(w)-s)}catch{}const n=r,o=St.map(h=>{if(h.id!==ue.id)return h;const p=Number(h.amount||0),g=Number(h.paidAmount||0),w=Number((g+n).toFixed(2)),y=w>=p;return{...h,amount:p,paidAmount:y?p:w,status:"paid",partialPayments:[...h.partialPayments||[],...n>0?[{amount:n,paidAt:new Date}]:[]]}});ga(o);try{ir(o.find(h=>h.id===ue.id)||null)}catch{}Zi(n),Rs("none"),$r(!0),await Qa(o);try{a!=null&&a.uid&&ue!=null&&ue.id&&(async()=>{const h=Ve(Ae(Y,"userTransactions"),me("userId","==",a.uid),me("linkedDebtId","==",ue.id),me("status","==","pending")),p=await et(h);await Promise.allSettled(p.docs.map(_=>Ut(_.ref,{status:"completed",confirmedAt:new Date})));try{const _=p.docs.map(I=>{var k;return String(((k=I.data())==null?void 0:k.transactionId)||"")});a!=null&&a.uid&&_.forEach(I=>I&&je.removeLocalReceiptById(a.uid,I))}catch{}const g=Ve(Ae(Y,"transactions"),me("userId","==",a.uid),me("linkedDebtId","==",ue.id),me("status","==","pending")),w=await et(g);await Promise.allSettled(w.docs.map(_=>Ut(_.ref,{status:"completed",confirmedAt:new Date})));try{const _=w.docs.map(I=>{var k;return String(I.id||((k=I.data())==null?void 0:k.transactionId)||"")});a!=null&&a.uid&&_.forEach(I=>I&&je.removeLocalReceiptById(a.uid,I))}catch{}const y=Ve(Ae(Y,"transactions"),me("merchantUserId","==",a.uid),me("linkedDebtId","==",ue.id),me("status","==","pending")),N=await et(y);await Promise.allSettled(N.docs.map(_=>Ut(_.ref,{status:"completed",confirmedAt:new Date})));try{const _=N.docs.map(I=>{var k;return String(I.id||((k=I.data())==null?void 0:k.transactionId)||"")});a!=null&&a.uid&&_.forEach(I=>I&&je.removeLocalReceiptById(a.uid,I))}catch{}})().catch(h=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",h),u({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(h){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",h)}try{const h=Tl(),p=localStorage.getItem(h);if(p){const g=(JSON.parse(p)||[]).map(w=>(w==null?void 0:w.linkedDebtId)===ue.id&&(w==null?void 0:w.status)==="pending"?{...w,status:"completed",confirmedAt:new Date}:w);localStorage.setItem(h,JSON.stringify(g)),bs(w=>w.map(y=>(y==null?void 0:y.linkedDebtId)===ue.id&&(y==null?void 0:y.status)==="pending"?{...y,status:"completed",confirmedAt:new Date}:y))}}catch(h){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",h)}Bs(!1),u({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(x,{onClick:async()=>{if(ue){const t=St.filter(s=>s.id!==ue.id);ga(t),await Qa(t),Bs(!1),u({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(Se,{open:Km,onOpenChange:Kr,children:e.jsxs(Ie,{className:"sm:max-w-md rounded-2xl shadow-elegant border border-gray-200",children:[e.jsxs(Ce,{children:[e.jsx(De,{className:`text-right ${nr==="decrease"?"text-red-600":"text-green-600"}`,children:nr==="decrease"?"إنقاص مبلغ الدين":nr==="increase"?"زيادة مبلغ الدين":"تعديل مبلغ الدين"}),e.jsxs(va,{className:"text-right",children:["أدخل المبلغ ثم اضغط تأكيد لإتمام ",nr==="decrease"?"الإنقاص":"الزيادة","."]})]}),e.jsxs("div",{className:"grid gap-4 py-2",children:[e.jsx(ee,{htmlFor:"debtAdjustAmount",className:"text-right",children:"المبلغ (جنيه)"}),e.jsx(q,{id:"debtAdjustAmount",type:"number",placeholder:"0.00",value:Go,onChange:t=>sl(t.target.value)}),ue&&e.jsxs("div",{className:"text-right text-sm text-muted-foreground",children:["المبلغ الحالي: ",e.jsx("span",{className:"font-semibold",children:Number(ue.amount||0).toFixed(2)})," جنيه"]})]}),e.jsxs(ot,{className:"flex gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>{Kr(!1),Bs(!0)},children:"إلغاء"}),e.jsx(x,{className:nr==="decrease"?"bg-red-600 hover:bg-red-700":"bg-green-600 hover:bg-green-700",onClick:async()=>{try{if(!ue||!nr)return;const t=Number(parseFloat(Go||"0").toFixed(2));if(!t||isNaN(t)||t<=0){u({title:"قيمة غير صالحة",description:"يرجى إدخال مبلغ أكبر من صفر",variant:"destructive"});return}Ko({debtId:ue.id,delta:t,type:nr}),Kr(!1),Tr(!0)}catch(t){console.error("فشل تجهيز تعديل مبلغ الدين:",t),u({title:"خطأ",description:"تعذّر تجهيز تعديل مبلغ الدين",variant:"destructive"})}},children:"تأكيد"})]})]})}),e.jsx(Se,{open:iu,onOpenChange:$r,children:e.jsxs(Ie,{className:"sm:max-w-[480px]",children:[e.jsxs(Ce,{children:[e.jsx(De,{className:"text-right",children:"اختيار إضافة مبلغ السداد"}),e.jsx(va,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 justify-center",children:[e.jsx(x,{variant:Ha==="cash"?"default":"outline",className:Ha==="cash"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>Rs("cash"),children:"الفلوس النقدية"}),e.jsx(x,{variant:Ha==="wallet"?"default":"outline",className:Ha==="wallet"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>Rs("wallet"),children:"أرصدة المحافظ"}),e.jsx(x,{variant:Ha==="fawry"?"default":"outline",className:Ha==="fawry"?"bg-amber-600 text-white":"",size:"sm",onClick:()=>Rs("fawry"),children:"فوري"}),e.jsx(x,{variant:Ha==="none"?"default":"outline",className:Ha==="none"?"bg-gray-600 text-white":"",size:"sm",onClick:()=>Rs("none"),children:"بدون إضافة"})]}),Ha==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:or,onChange:t=>yl(t.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),Je&&Je.length>0?Je.map(t=>e.jsx("option",{value:t.id,children:t.phone||t.name||t.id},t.id)):Object.keys(lt||{}).map(t=>{var s,r,n,o,h,p;return e.jsx("option",{value:t,children:((s=Je.find(g=>g.id===t))==null?void 0:s.phone)||((n=(r=JSON.parse(localStorage.getItem($l())||"[]"))==null?void 0:r.find(g=>g.id===t))==null?void 0:n.phone)||((h=(o=JSON.parse(localStorage.getItem($l())||"[]"))==null?void 0:o.find(g=>g.id===t))==null?void 0:h.name)||((p=Je.find(g=>g.id===t))==null?void 0:p.name)||t},t)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[nc," جنيه"]})]})]}),e.jsxs(ot,{className:"flex flex-wrap justify-between gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{$r(!1),Zi(0),Rs(null),yl("")},children:"إلغاء"}),e.jsx(x,{onClick:async()=>{var t,s;try{const r=nc;if(!r||r<=0){$r(!1);return}if(Ha==="cash"){const n=$t+r;Zt(n),localStorage.setItem(Ma(),n.toString());const o={cashBalance:n,lastUpdated:new Date().toISOString()},h=`userData_${a==null?void 0:a.uid}`;localStorage.setItem(h,JSON.stringify(o)),a!=null&&a.uid?(je.updateUserData(a.uid,o).catch(()=>st(!0)),localStorage.removeItem(h),st(!1)):st(!0),u({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى الفلوس النقدية`})}else if(Ha==="wallet"){if(!or){u({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const n={...lt,[or]:(lt[or]||0)+r};ca(n);const o=($t||0)-r;Zt(o),localStorage.setItem(Ma(),o.toString());const h=new Date().toISOString(),p={walletBalances:n,cashBalance:o,lastUpdated:h},g=`userData_${a==null?void 0:a.uid}`;if(localStorage.setItem(g,JSON.stringify(p)),localStorage.setItem(Ta(),JSON.stringify(n)),localStorage.setItem(`walletBalances_backup_${h}`,JSON.stringify(n)),a!=null&&a.uid){je.updateUserData(a.uid,p).catch(()=>st(!0));try{localStorage.removeItem(g)}catch{}st(!1)}else st(!0);u({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى المحفظة ${((t=Je.find(w=>w.id===or))==null?void 0:t.phone)||((s=Je.find(w=>w.id===or))==null?void 0:s.name)||or} وتم خصم نفس المبلغ من درج النقدية`})}else if(Ha==="none"){u({title:"تم تسجيل السداد",description:`تم تسجيل ${r} جنيه بدون تعديل الأرصدة`});try{if(ue){const n=St.map(o=>o.id===ue.id?{...o,status:"paid",paidAmount:Math.max(Number(o.paidAmount||0),Number(o.amount||0))}:o);ga(n);try{ir(n.find(o=>o.id===ue.id)||null)}catch{}try{await Qa(n)}catch{}}}catch{}}else if(Ha==="fawry")u({title:"تم تسجيل سداد عبر فوري",description:`تم تسجيل ${r} جنيه كسداد عبر فوري بدون تعديل الأرصدة`});else{u({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}try{const n=r>0?r:Number((ue==null?void 0:ue.amount)||0);a!=null&&a.uid&&ue&&await xr.send(a.uid,`تم سداد الدين بالكامل للعميل ${ue.debtorName}: المدفوع ${n} جنيه`)}catch{}}catch(r){console.error("خطأ أثناء إضافة مبلغ السداد:",r),u({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{$r(!1),Zi(0),Rs(null),yl("");try{_r(!0)}catch{}}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(Se,{open:Sm,onOpenChange:sr,children:e.jsxs(Ie,{hideClose:!0,className:"post-confirm-card sm:max-w-[420px] w-[90vw] rounded-2xl bg-gradient-to-br from-white via-indigo-50 to-blue-50 shadow-2xl border border-indigo-100",children:[e.jsxs(Ce,{children:[e.jsx(De,{className:"text-right text-2xl font-bold",children:(ss==null?void 0:ss.type)==="transfer"?"مبلغ يجب استلامه":"مبلغ يجب تسليمه"}),e.jsx(va,{className:"text-right text-gray-600",children:(ss==null?void 0:ss.type)==="transfer"?"هذا هو المبلغ الواجب استلامه من العميل بعد التأكيد.":"هذا هو المبلغ الواجب تسليمه للعميل بعد التأكيد."})]}),e.jsxs("div",{className:"py-3 flex flex-col items-center gap-1.5",children:[e.jsxs("div",{className:"text-xl sm:text-2xl font-bold text-blue-700 tracking-wide",children:[Ca((ss==null?void 0:ss.amount)||0)," جنيه"]}),e.jsx("div",{className:"text-sm text-gray-500 text-right w-full",children:(ss==null?void 0:ss.type)==="transfer"?"المبلغ المعروض شامل عمولة التحويل.":wt?"العمولة مضافة ولا تؤثر على قيمة التسليم.":"العمولة مخصومة من المبلغ المسلّم للعميل."})]}),e.jsxs(ot,{className:"flex justify-end gap-2",children:[(ss==null?void 0:ss.type)==="transfer"&&e.jsx(x,{variant:"outline",id:"sendCodeBtn",onClick:cs,disabled:$o,className:"btn-transfer-confirm",children:$o?"جارٍ الإرسال...":"إرسال كود التحويل"}),e.jsx(x,{onClick:()=>{sr(!1),Kn(null)},className:"bg-green-600 hover:bg-green-700 text-white",children:(ss==null?void 0:ss.type)==="transfer"?"تم الاستلام":"تم التسليم"})]})]})}),e.jsx(Yh,{open:Cm,onClose:()=>Dr(!1),onSubmit:ua,deviceId:Oo||pt||"",recipientMsisdn:String(le==="transfer"?(xs==null?void 0:xs.receiver)||G||"":((S=Je.find(t=>t.id===L))==null?void 0:S.phone)||"").replace(/\D/g,"")}),e.jsx(tx,{open:Ct,onOpenChange:tt}),Eo]}))};export{ip as default};
//# sourceMappingURL=UserDashboardPage-BRKQ-meY-DTnfM6w2.js.map
