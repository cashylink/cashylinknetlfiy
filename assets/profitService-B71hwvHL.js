var _=Object.defineProperty;var I=(r,t,a)=>t in r?_(r,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[t]=a;var T=(r,t,a)=>I(r,typeof t!="symbol"?t+"":t,a);import{aw as w}from"./index-5OsgE1a1.js";const c={async syncReportsDataFromFirebase(r){try{if(!r)return null;const t=await w.getUserData(r),a=t==null?void 0:t.reportsData;if(!a)return null;const e=`reportsData_${r}`,s=n=>{if(!n)return null;try{return n!=null&&n.toDate?n.toDate():new Date(n)}catch{return null}},i={lastDailyResetDate:s(a.lastDailyResetDate),lastMonthlyResetDate:s(a.lastMonthlyResetDate),hiddenDailyTransactionIds:Array.isArray(a.hiddenDailyTransactionIds)?a.hiddenDailyTransactionIds:[],hiddenMonthlyTransactionIds:Array.isArray(a.hiddenMonthlyTransactionIds)?a.hiddenMonthlyTransactionIds:[],dailyProfit:Number(a.dailyProfit??0),monthlyProfit:Number(a.monthlyProfit??0),lastDailyProfitResetDate:s(a.lastDailyProfitResetDate),lastMonthlyProfitResetDate:s(a.lastMonthlyProfitResetDate)};try{localStorage.setItem(e,JSON.stringify(i))}catch{}return i}catch(t){return console.warn("تعذر مزامنة بيانات التقارير من Firebase:",t),null}},shouldResetDailyReports:r=>{if(!r)return!0;const t=new Date,a=new Date(r);return t.toDateString()!==a.toDateString()},shouldResetMonthlyReports:r=>{if(!r)return!0;const t=new Date,a=new Date(r),e=t.getDate()===1,s=t.getMonth()!==a.getMonth()||t.getFullYear()!==a.getFullYear();return e&&s},autoResetReportsIfNeeded:r=>{try{const t=r?`reportsData_${r}`:"reportsData",a=localStorage.getItem(t);let e={lastDailyResetDate:null,lastMonthlyResetDate:null,hiddenDailyTransactionIds:[],hiddenMonthlyTransactionIds:[],dailyProfit:0,monthlyProfit:0,lastDailyProfitResetDate:null,lastMonthlyProfitResetDate:null};if(a){const n=JSON.parse(a);e={lastDailyResetDate:n.lastDailyResetDate?new Date(n.lastDailyResetDate):null,lastMonthlyResetDate:n.lastMonthlyResetDate?new Date(n.lastMonthlyResetDate):null,hiddenDailyTransactionIds:n.hiddenDailyTransactionIds||[],hiddenMonthlyTransactionIds:n.hiddenMonthlyTransactionIds||[],dailyProfit:n.dailyProfit||0,monthlyProfit:n.monthlyProfit||0,lastDailyProfitResetDate:n.lastDailyProfitResetDate?new Date(n.lastDailyProfitResetDate):null,lastMonthlyProfitResetDate:n.lastMonthlyProfitResetDate?new Date(n.lastMonthlyProfitResetDate):null}}else if(r){const n=localStorage.getItem("reportsData");if(n)try{const o=JSON.parse(n);e={lastDailyResetDate:o.lastDailyResetDate?new Date(o.lastDailyResetDate):null,lastMonthlyResetDate:o.lastMonthlyResetDate?new Date(o.lastMonthlyResetDate):null,hiddenDailyTransactionIds:o.hiddenDailyTransactionIds||[],hiddenMonthlyTransactionIds:o.hiddenMonthlyTransactionIds||[],dailyProfit:o.dailyProfit||0,monthlyProfit:o.monthlyProfit||0,lastDailyProfitResetDate:o.lastDailyProfitResetDate?new Date(o.lastDailyProfitResetDate):null,lastMonthlyProfitResetDate:o.lastMonthlyProfitResetDate?new Date(o.lastMonthlyProfitResetDate):null},localStorage.setItem(t,JSON.stringify(e))}catch(o){console.error("خطأ في مهاجرة بيانات التقارير القديمة:",o)}}const s=!1,i=!1;if(e.lastDailyResetDate||(e.lastDailyResetDate=new Date),e.lastDailyProfitResetDate||(e.lastDailyProfitResetDate=new Date),e.lastMonthlyResetDate||(e.lastMonthlyResetDate=new Date),e.lastMonthlyProfitResetDate||(e.lastMonthlyProfitResetDate=new Date),localStorage.setItem(t,JSON.stringify(e)),r)try{w.updateUserData(r,{reportsData:{...e}})}catch(n){console.warn("تعذر تحديث بيانات التقارير في Firebase بعد التصفير التلقائي:",n)}return{dailyReset:s,monthlyReset:i}}catch(t){return console.error("خطأ في التصفير التلقائي للتقارير:",t),{dailyReset:!1,monthlyReset:!1}}},resetReportsManually:(r,t,a)=>{try{const e=a?`reportsData_${a}`:"reportsData",s=localStorage.getItem(e);let i={lastDailyResetDate:null,lastMonthlyResetDate:null,hiddenDailyTransactionIds:[],hiddenMonthlyTransactionIds:[],dailyProfit:0,monthlyProfit:0,lastDailyProfitResetDate:null,lastMonthlyProfitResetDate:null};if(s){const o=JSON.parse(s);i={lastDailyResetDate:o.lastDailyResetDate?new Date(o.lastDailyResetDate):null,lastMonthlyResetDate:o.lastMonthlyResetDate?new Date(o.lastMonthlyResetDate):null,hiddenDailyTransactionIds:o.hiddenDailyTransactionIds||[],hiddenMonthlyTransactionIds:o.hiddenMonthlyTransactionIds||[],dailyProfit:o.dailyProfit||0,monthlyProfit:o.monthlyProfit||0,lastDailyProfitResetDate:o.lastDailyProfitResetDate?new Date(o.lastDailyProfitResetDate):null,lastMonthlyProfitResetDate:o.lastMonthlyProfitResetDate?new Date(o.lastMonthlyProfitResetDate):null}}let n=[];if(r==="daily"){const o=new Date().toDateString();n=t.filter(D=>new Date(D.createdAt).toDateString()===o).map(D=>D.id),i.hiddenDailyTransactionIds=[...new Set([...i.hiddenDailyTransactionIds,...n])],i.lastDailyResetDate=new Date,i.dailyProfit=0,i.lastDailyProfitResetDate=new Date}else{const o=new Date().getMonth(),D=new Date().getFullYear();n=t.filter(d=>{const m=new Date(d.createdAt);return m.getMonth()===o&&m.getFullYear()===D}).map(d=>d.id),i.hiddenMonthlyTransactionIds=[...new Set([...i.hiddenMonthlyTransactionIds,...n])],i.lastMonthlyResetDate=new Date,i.monthlyProfit=0,i.lastMonthlyProfitResetDate=new Date}if(localStorage.setItem(e,JSON.stringify(i)),a)try{w.updateUserData(a,{reportsData:{...i}})}catch(o){console.warn("تعذر تحديث بيانات التقارير في Firebase بعد التصفير اليدوي:",o)}return console.log(`تم تصفير التقارير ${r==="daily"?"اليومية":"الشهرية"} يدوياً`),n}catch(e){return console.error("خطأ في التصفير اليدوي للتقارير:",e),[]}},getReportsData:r=>{try{const t=r?`reportsData_${r}`:"reportsData",a=localStorage.getItem(t);if(!a)return{lastDailyResetDate:null,lastMonthlyResetDate:null,hiddenDailyTransactionIds:[],hiddenMonthlyTransactionIds:[],dailyProfit:0,monthlyProfit:0,lastDailyProfitResetDate:null,lastMonthlyProfitResetDate:null};const e=JSON.parse(a);return{lastDailyResetDate:e.lastDailyResetDate?new Date(e.lastDailyResetDate):null,lastMonthlyResetDate:e.lastMonthlyResetDate?new Date(e.lastMonthlyResetDate):null,hiddenDailyTransactionIds:e.hiddenDailyTransactionIds||[],hiddenMonthlyTransactionIds:e.hiddenMonthlyTransactionIds||[],dailyProfit:e.dailyProfit||0,monthlyProfit:e.monthlyProfit||0,lastDailyProfitResetDate:e.lastDailyProfitResetDate?new Date(e.lastDailyProfitResetDate):null,lastMonthlyProfitResetDate:e.lastMonthlyProfitResetDate?new Date(e.lastMonthlyProfitResetDate):null}}catch(t){return console.error("خطأ في قراءة بيانات التقارير:",t),{lastDailyResetDate:null,lastMonthlyResetDate:null,hiddenDailyTransactionIds:[],hiddenMonthlyTransactionIds:[],dailyProfit:0,monthlyProfit:0,lastDailyProfitResetDate:null,lastMonthlyProfitResetDate:null}}},filterVisibleTransactions:(r,t,a)=>{try{const e=c.getReportsData(a),s=t==="daily"?e.hiddenDailyTransactionIds:e.hiddenMonthlyTransactionIds;return r.filter(i=>!s.includes(i.id))}catch(e){return console.error("خطأ في تصفية المعاملات:",e),r}},addProfit:(r,t,a)=>{try{const e=a?`reportsData_${a}`:"reportsData",s=c.getReportsData(a);if(t==="daily"?s.dailyProfit+=r:s.monthlyProfit+=r,localStorage.setItem(e,JSON.stringify(s)),a)try{w.updateUserData(a,{reportsData:{...s}})}catch(i){console.warn("تعذر مزامنة أرباح التقارير مع Firebase:",i)}}catch(e){console.error("خطأ في إضافة الربح:",e)}},getProfits:r=>{try{const t=c.getReportsData(r);return{dailyProfit:t.dailyProfit,monthlyProfit:t.monthlyProfit}}catch(t){return console.error("خطأ في قراءة الأرباح:",t),{dailyProfit:0,monthlyProfit:0}}},removeTransactionEffects:(r,t)=>{try{const a=t?`reportsData_${t}`:"reportsData",e=c.getReportsData(t),s=new Date(r.createdAt),i=new Date,n=i.getMonth(),o=i.getFullYear(),D=c.calculateTransactionProfit(r);if(s.toDateString()===i.toDateString()&&((e.hiddenDailyTransactionIds||[]).includes(r.id)||(e.dailyProfit=Math.round((e.dailyProfit-D)*100)/100,e.dailyProfit<0&&(e.dailyProfit=0))),s.getMonth()===n&&s.getFullYear()===o&&((e.hiddenMonthlyTransactionIds||[]).includes(r.id)||(e.monthlyProfit=Math.round((e.monthlyProfit-D)*100)/100,e.monthlyProfit<0&&(e.monthlyProfit=0))),localStorage.setItem(a,JSON.stringify(e)),t)try{w.updateUserData(t,{reportsData:{...e}})}catch(d){console.warn("تعذر مزامنة خصم تأثيرات المعاملة مع Firebase:",d)}}catch(a){console.error("خطأ في خصم تأثيرات المعاملة من التقارير:",a)}},calculateTransactionProfit:r=>{const t=Number((r==null?void 0:r.fee)??0);if(r.commission!==void 0){const s=Math.max(0,Number(r.commission||0));return Math.round((s+Math.max(0,t))*100)/100}const a=String(r.type||"").toLowerCase(),e=a==="withdrawal"?"withdraw":a;if(e==="withdraw"||e==="receive"||e==="send"||e==="transfer"){const s=Math.round(Number(r.amount||0)*.01*100)/100;return Math.round((s+Math.max(0,t))*100)/100}return 0}},b=c,v=Object.freeze(Object.defineProperty({__proto__:null,ReportsService:b,reportsService:c},Symbol.toStringTag,{value:"Module"}));class S{static getProfitPinKey(t){return t?`${this.PROFIT_PIN_KEY_BASE}_${t}`:this.PROFIT_PIN_KEY_BASE}static getMasterPinKey(t){return t?`${this.MASTER_PIN_KEY_BASE}_${t}`:this.MASTER_PIN_KEY_BASE}static setProfitPin(t,a){console.warn("setProfitPin is deprecated. Using master PIN instead.")}static hasProfitPin(t){try{const a=localStorage.getItem(this.getMasterPinKey(t));return!!a&&a.length>0}catch{return!1}}static verifyProfitPin(t,a){try{const e=localStorage.getItem(this.getMasterPinKey(a));return e?atob(e)===t:!1}catch{return!1}}static getProfitData(t){c.autoResetReportsIfNeeded(t);const a=c.getProfits(t),e=this.getWithdrawTransferProfits(t);return{dailyProfit:a.dailyProfit,monthlyProfit:a.monthlyProfit,dailyWithdrawProfit:e.dailyWithdrawProfit,monthlyWithdrawProfit:e.monthlyWithdrawProfit,dailyTransferProfit:e.dailyTransferProfit,monthlyTransferProfit:e.monthlyTransferProfit,lastUpdated:new Date}}static addProfit(t,a){c.addProfit(t,"daily",a),c.addProfit(t,"monthly",a)}static calculateProfitFromTransaction(t){return c.calculateTransactionProfit(t)}static resetProfits(t,a,e){if(!this.verifyProfitPin(a,e))return!1;const s=e?`reportsData_${e}`:"reportsData",i=c.getReportsData(e);if(t==="daily"?(i.dailyProfit=0,i.lastDailyProfitResetDate=new Date):(i.monthlyProfit=0,i.lastMonthlyProfitResetDate=new Date),localStorage.setItem(s,JSON.stringify(i)),e)try{w.updateUserData(e,{reportsData:{...i}})}catch(n){console.warn("تعذر مزامنة تصفير الأرباح مع Firebase:",n)}return!0}static clearProfitPin(t){localStorage.removeItem(this.getProfitPinKey(t))}static updateProfitsFromTransactions(t,a){const e=a?`reportsData_${a}`:"reportsData",s=c.getReportsData(a);let i=0,n=0;const o=new Date,D=o.getMonth(),d=o.getFullYear(),m=c.filterVisibleTransactions(t,"daily",a),M=c.filterVisibleTransactions(t,"monthly",a);if(m.forEach(l=>{const y=String(l.type||l.txnType||"").toLowerCase(),p=String(l.title||"");if(y==="cash_addition"||p.includes("إيصال إضافة نقدية"))return;const u=new Date(l.createdAt),P=String(l.status||"confirmed").toLowerCase();if(u.toDateString()!==o.toDateString()||P!=="completed"&&P!=="confirmed")return;const h=String(l.type||l.txnType||"").toLowerCase(),g={type:h==="withdrawal"?"withdraw":h,amount:Number(l.amount||0),commission:l.commission};i+=this.calculateProfitFromTransaction(g)}),M.forEach(l=>{const y=String(l.type||l.txnType||"").toLowerCase(),p=String(l.title||"");if(y==="cash_addition"||p.includes("إيصال إضافة نقدية"))return;const u=new Date(l.createdAt),P=String(l.status||"confirmed").toLowerCase();if(u.getMonth()!==D||u.getFullYear()!==d||P!=="completed"&&P!=="confirmed")return;const h=String(l.type||l.txnType||"").toLowerCase(),g={type:h==="withdrawal"?"withdraw":h,amount:Number(l.amount||0),commission:l.commission};n+=this.calculateProfitFromTransaction(g)}),s.dailyProfit=Math.round(i*100)/100,s.monthlyProfit=Math.round(n*100)/100,localStorage.setItem(e,JSON.stringify(s)),a)try{w.updateUserData(a,{reportsData:{...s}})}catch(l){console.warn("تعذر مزامنة تحديث الأرباح من المعاملات مع Firebase:",l)}}static getWithdrawTransferProfits(t){c.getReportsData(t);const a=new Date,e=a.getMonth(),s=a.getFullYear(),i=`transactions_${t||"default"}`,n=JSON.parse(localStorage.getItem(i)||"[]");let o=0,D=0,d=0,m=0;const M=c.filterVisibleTransactions(n,"daily",t),l=c.filterVisibleTransactions(n,"monthly",t);return M.forEach(y=>{const p=String(y.type||y.txnType||"").toLowerCase(),u=String(y.title||"");if(p==="cash_addition"||u.includes("إيصال إضافة نقدية"))return;const P=new Date(y.createdAt),h=String(y.status||"confirmed").toLowerCase();if(P.toDateString()!==a.toDateString()||h!=="completed"&&h!=="confirmed")return;const R=String(y.type||y.txnType||"").toLowerCase(),f={type:R==="withdrawal"?"withdraw":R,amount:Number(y.amount||0),commission:y.commission};f.type==="withdraw"?o+=this.calculateProfitFromTransaction(f):(f.type==="receive"||f.type==="send"||f.type==="transfer")&&(d+=this.calculateProfitFromTransaction(f))}),l.forEach(y=>{const p=String(y.type||y.txnType||"").toLowerCase(),u=String(y.title||"");if(p==="cash_addition"||u.includes("إيصال إضافة نقدية"))return;const P=new Date(y.createdAt),h=String(y.status||"confirmed").toLowerCase();if(P.getMonth()!==e||P.getFullYear()!==s||h!=="completed"&&h!=="confirmed")return;const R=String(y.type||y.txnType||"").toLowerCase(),f={type:R==="withdrawal"?"withdraw":R,amount:Number(y.amount||0),commission:y.commission};f.type==="withdraw"?D+=this.calculateProfitFromTransaction(f):(f.type==="receive"||f.type==="send"||f.type==="transfer")&&(m+=this.calculateProfitFromTransaction(f))}),{dailyWithdrawProfit:Math.round(o*100)/100,monthlyWithdrawProfit:Math.round(D*100)/100,dailyTransferProfit:Math.round(d*100)/100,monthlyTransferProfit:Math.round(m*100)/100}}}T(S,"PROFIT_PIN_KEY_BASE","profit_pin"),T(S,"MASTER_PIN_KEY_BASE","master_pin");const x=Object.freeze(Object.defineProperty({__proto__:null,ProfitService:S},Symbol.toStringTag,{value:"Module"}));export{S as P,v as a,x as p,c as r};
