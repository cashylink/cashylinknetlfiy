{"version":3,"file":"dailyOperationCountService-DzqBv2Ly.js","sources":["../../src/utils/dailyOperationCountService.ts"],"sourcesContent":["import { db } from '@/firebase';\r\nimport { doc, getDoc, setDoc, serverTimestamp } from 'firebase/firestore';\r\n\r\nexport type OperationType = 'transfer' | 'withdraw';\r\n\r\ninterface DailyOpCounts {\r\n  dayId: string;\r\n  confirmTransferCount: number;\r\n  confirmWithdrawCount: number;\r\n  updatedAt: any;\r\n}\r\n\r\nexport const dailyOperationCountService = {\r\n  getCurrentDayId(): string {\r\n    const now = new Date();\r\n    return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;\r\n  },\r\n\r\n  async getCounts(userId: string, dayId?: string): Promise<DailyOpCounts> {\r\n    const dId = dayId || this.getCurrentDayId();\r\n    const ref = doc(db, 'users', userId, 'dailyOps', dId);\r\n    const snap = await getDoc(ref);\r\n    if (!snap.exists()) {\r\n      const initial: DailyOpCounts = {\r\n        dayId: dId,\r\n        confirmTransferCount: 0,\r\n        confirmWithdrawCount: 0,\r\n        updatedAt: serverTimestamp(),\r\n      } as any;\r\n      await setDoc(ref, initial);\r\n      return { ...initial, updatedAt: new Date() };\r\n    }\r\n    const data = snap.data() as any;\r\n    return {\r\n      dayId: dId,\r\n      confirmTransferCount: Number(data?.confirmTransferCount || 0),\r\n      confirmWithdrawCount: Number(data?.confirmWithdrawCount || 0),\r\n      updatedAt: data?.updatedAt || serverTimestamp(),\r\n    };\r\n  },\r\n\r\n  async checkAndIncrement(userId: string, type: OperationType, maxPerDay: number): Promise<{ allowed: boolean; remaining: number }> {\r\n    const dayId = this.getCurrentDayId();\r\n    const ref = doc(db, 'users', userId, 'dailyOps', dayId);\r\n    const current = await this.getCounts(userId, dayId);\r\n    const currentCount = type === 'transfer' ? current.confirmTransferCount : current.confirmWithdrawCount;\r\n\r\n    if (currentCount >= maxPerDay) {\r\n      return { allowed: false, remaining: 0 };\r\n    }\r\n\r\n    const updateData: any = { updatedAt: serverTimestamp() };\r\n    if (type === 'transfer') {\r\n      updateData.confirmTransferCount = current.confirmTransferCount + 1;\r\n    } else {\r\n      updateData.confirmWithdrawCount = current.confirmWithdrawCount + 1;\r\n    }\r\n    await setDoc(ref, updateData, { merge: true });\r\n\r\n    const remaining = Math.max(0, maxPerDay - (currentCount + 1));\r\n    return { allowed: true, remaining };\r\n  },\r\n\r\n  async checkAndIncrementCombined(userId: string, type: OperationType, maxCombinedPerDay: number): Promise<{ allowed: boolean; remaining: number }> {\r\n    const dayId = this.getCurrentDayId();\r\n    const ref = doc(db, 'users', userId, 'dailyOps', dayId);\r\n    const current = await this.getCounts(userId, dayId);\r\n    const combined = Number(current.confirmTransferCount || 0) + Number(current.confirmWithdrawCount || 0);\r\n    if (combined >= maxCombinedPerDay) {\r\n      return { allowed: false, remaining: 0 };\r\n    }\r\n    const updateData: any = { updatedAt: serverTimestamp() };\r\n    if (type === 'transfer') {\r\n      updateData.confirmTransferCount = current.confirmTransferCount + 1;\r\n    } else {\r\n      updateData.confirmWithdrawCount = current.confirmWithdrawCount + 1;\r\n    }\r\n    await setDoc(ref, updateData, { merge: true });\r\n    const remaining = Math.max(0, maxCombinedPerDay - (combined + 1));\r\n    return { allowed: true, remaining };\r\n  },\r\n};\r\n\r\nexport default dailyOperationCountService;"],"names":["dailyOperationCountService","now","userId","dayId","dId","ref","doc","db","snap","getDoc","initial","serverTimestamp","setDoc","data","type","maxPerDay","current","currentCount","updateData","maxCombinedPerDay","combined"],"mappings":"qEAYO,MAAMA,EAA6B,CACxC,iBAA0B,CACxB,MAAMC,MAAU,KAChB,MAAO,GAAGA,EAAI,YAAA,CAAa,IAAI,OAAOA,EAAI,SAAA,EAAa,CAAC,EAAE,SAAS,EAAG,GAAG,CAAC,IAAI,OAAOA,EAAI,SAAS,EAAE,SAAS,EAAG,GAAG,CAAC,EACtH,EAEA,MAAM,UAAUC,EAAgBC,EAAwC,CACtE,MAAMC,EAAMD,GAAS,KAAK,gBAAA,EACpBE,EAAMC,EAAIC,EAAI,QAASL,EAAQ,WAAYE,CAAG,EAC9CI,EAAO,MAAMC,EAAOJ,CAAG,EAC7B,GAAI,CAACG,EAAK,SAAU,CAClB,MAAME,EAAyB,CAC7B,MAAON,EACP,qBAAsB,EACtB,qBAAsB,EACtB,UAAWO,EAAA,CAAgB,EAE7B,aAAMC,EAAOP,EAAKK,CAAO,EAClB,CAAE,GAAGA,EAAS,UAAW,IAAI,IAAK,CAC3C,CACA,MAAMG,EAAOL,EAAK,KAAA,EAClB,MAAO,CACL,MAAOJ,EACP,qBAAsB,QAAOS,GAAA,YAAAA,EAAM,uBAAwB,CAAC,EAC5D,qBAAsB,QAAOA,GAAA,YAAAA,EAAM,uBAAwB,CAAC,EAC5D,WAAWA,GAAA,YAAAA,EAAM,YAAaF,EAAA,CAAgB,CAElD,EAEA,MAAM,kBAAkBT,EAAgBY,EAAqBC,EAAqE,CAChI,MAAMZ,EAAQ,KAAK,gBAAA,EACbE,EAAMC,EAAIC,EAAI,QAASL,EAAQ,WAAYC,CAAK,EAChDa,EAAU,MAAM,KAAK,UAAUd,EAAQC,CAAK,EAC5Cc,EAAeH,IAAS,WAAaE,EAAQ,qBAAuBA,EAAQ,qBAElF,GAAIC,GAAgBF,EAClB,MAAO,CAAE,QAAS,GAAO,UAAW,CAAA,EAGtC,MAAMG,EAAkB,CAAE,UAAWP,GAAgB,EACrD,OAAIG,IAAS,WACXI,EAAW,qBAAuBF,EAAQ,qBAAuB,EAEjEE,EAAW,qBAAuBF,EAAQ,qBAAuB,EAEnE,MAAMJ,EAAOP,EAAKa,EAAY,CAAE,MAAO,GAAM,EAGtC,CAAE,QAAS,GAAM,UADN,KAAK,IAAI,EAAGH,GAAaE,EAAe,EAAE,CACpC,CAC1B,EAEA,MAAM,0BAA0Bf,EAAgBY,EAAqBK,EAA6E,CAChJ,MAAMhB,EAAQ,KAAK,gBAAA,EACbE,EAAMC,EAAIC,EAAI,QAASL,EAAQ,WAAYC,CAAK,EAChDa,EAAU,MAAM,KAAK,UAAUd,EAAQC,CAAK,EAC5CiB,EAAW,OAAOJ,EAAQ,sBAAwB,CAAC,EAAI,OAAOA,EAAQ,sBAAwB,CAAC,EACrG,GAAII,GAAYD,EACd,MAAO,CAAE,QAAS,GAAO,UAAW,CAAA,EAEtC,MAAMD,EAAkB,CAAE,UAAWP,GAAgB,EACrD,OAAIG,IAAS,WACXI,EAAW,qBAAuBF,EAAQ,qBAAuB,EAEjEE,EAAW,qBAAuBF,EAAQ,qBAAuB,EAEnE,MAAMJ,EAAOP,EAAKa,EAAY,CAAE,MAAO,GAAM,EAEtC,CAAE,QAAS,GAAM,UADN,KAAK,IAAI,EAAGC,GAAqBC,EAAW,EAAE,CACxC,CAC1B,CACF"}