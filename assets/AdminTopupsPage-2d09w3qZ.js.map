{"version":3,"file":"AdminTopupsPage-2d09w3qZ.js","sources":["../../src/pages/AdminTopupsPage.tsx"],"sourcesContent":["import React, { useEffect, useMemo, useState } from 'react';\nimport { collection, getDocs, limit, orderBy, query } from 'firebase/firestore';\nimport { db, auth } from '@/firebase';\nimport { Button } from '@/components/ui/button';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { useToast } from '@/hooks/use-toast';\n\ninterface TopupDoc {\n  id: string;\n  user_id?: string | null;\n  phone: string;\n  country_code: string;\n  operator: string;\n  operator_id?: number | null;\n  amount_local: number;\n  amount_usd?: number | null;\n  custom_identifier: string;\n  provider_txn_id?: string | null;\n  status: 'pending' | 'success' | 'failed' | string;\n  response_raw?: any;\n  created_at?: any;\n  updated_at?: any;\n}\n\nconst AdminTopupsPage: React.FC = () => {\n  const { toast } = useToast();\n  const [topups, setTopups] = useState<TopupDoc[]>([]);\n  const [loading, setLoading] = useState(false);\n  const [filter, setFilter] = useState<'all' | 'pending' | 'success' | 'failed'>('all');\n  const [balance, setBalance] = useState<any>(null);\n\n  useEffect(() => {\n    const fetchTopups = async () => {\n      setLoading(true);\n      try {\n        const q = query(collection(db, 'topups'), orderBy('created_at', 'desc'), limit(100));\n        const snap = await getDocs(q);\n        const list: TopupDoc[] = snap.docs.map((d) => ({ id: d.id, ...(d.data() as any) }));\n        setTopups(list);\n      } catch (err: any) {\n        console.error('Failed to fetch topups:', err);\n        toast({ title: 'خطأ', description: 'تعذر تحميل العمليات', variant: 'destructive' });\n      } finally {\n        setLoading(false);\n      }\n    };\n    fetchTopups();\n  }, [toast]);\n\n  useEffect(() => {\n    const fetchBalance = async () => {\n      try {\n        const idToken = await auth.currentUser?.getIdToken();\n        const resp = await fetch('/api/reloadly/balance', {\n          headers: idToken ? { Authorization: `Bearer ${idToken}` } : {},\n        });\n        const data = await resp.json().catch(() => null);\n        setBalance(data?.raw ?? data);\n      } catch (e) {\n        // ignore for now\n      }\n    };\n    fetchBalance();\n  }, []);\n\n  const filtered = useMemo(() => {\n    if (filter === 'all') return topups;\n    return topups.filter((t) => String(t.status).toLowerCase() === filter);\n  }, [topups, filter]);\n\n  const retryTopup = async (doc: TopupDoc) => {\n    try {\n      const idToken = await auth.currentUser?.getIdToken();\n      const resp = await fetch('/api/topup/retry', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          ...(idToken ? { Authorization: `Bearer ${idToken}` } : {}),\n        },\n        body: JSON.stringify({ id: doc.id }),\n      });\n      const data = await resp.json().catch(() => ({ success: false, message: 'فشل قراءة استجابة الخادم' }));\n      if (resp.ok && data?.success) {\n        toast({ title: 'أُعيدت المحاولة', description: 'تم إعادة محاولة العملية بنجاح' });\n      } else {\n        toast({ title: 'فشل إعادة المحاولة', description: data?.message || 'حدث خطأ أثناء إعادة المحاولة', variant: 'destructive' });\n      }\n    } catch (err: any) {\n      console.error('Retry error:', err);\n      toast({ title: 'خطأ في الاتصال', description: 'تعذر الاتصال بالخادم. حاول لاحقاً.', variant: 'destructive' });\n    }\n  };\n\n  return (\n    <div className=\"p-4\">\n      <div className=\"flex items-center justify-between mb-4\">\n        <h1 className=\"text-xl font-semibold\">لوحة تقارير الشحن</h1>\n        <div className=\"text-sm text-gray-600\">\n          رصيد Reloadly: {balance?.balance ?? balance?.availableBalance ?? 'غير متاح'}\n        </div>\n      </div>\n\n      <div className=\"flex items-center gap-2 mb-4\">\n        <span>الحالة:</span>\n        <Select value={filter} onValueChange={(v: any) => setFilter(v)}>\n          <SelectTrigger className=\"w-40\">\n            <SelectValue placeholder=\"اختر الحالة\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">الكل</SelectItem>\n            <SelectItem value=\"pending\">في الانتظار</SelectItem>\n            <SelectItem value=\"success\">ناجحة</SelectItem>\n            <SelectItem value=\"failed\">فاشلة</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      <div className=\"overflow-x-auto\">\n        <table className=\"min-w-full text-sm\">\n          <thead>\n            <tr className=\"text-right\">\n              <th className=\"px-2 py-1\">ID</th>\n              <th className=\"px-2 py-1\">User</th>\n              <th className=\"px-2 py-1\">Phone</th>\n              <th className=\"px-2 py-1\">Operator</th>\n              <th className=\"px-2 py-1\">Amount</th>\n              <th className=\"px-2 py-1\">Status</th>\n              <th className=\"px-2 py-1\">ProviderTxn</th>\n              <th className=\"px-2 py-1\">Created</th>\n              <th className=\"px-2 py-1\">Actions</th>\n            </tr>\n          </thead>\n          <tbody>\n            {loading ? (\n              <tr><td className=\"p-4\" colSpan={9}>جارٍ التحميل...</td></tr>\n            ) : filtered.length === 0 ? (\n              <tr><td className=\"p-4\" colSpan={9}>لا يوجد بيانات</td></tr>\n            ) : (\n              filtered.map((t) => (\n                <tr key={t.id} className=\"border-t\">\n                  <td className=\"px-2 py-1 font-mono\">{t.id}</td>\n                  <td className=\"px-2 py-1\">{t.user_id || '-'}</td>\n                  <td className=\"px-2 py-1\">{t.phone}</td>\n                  <td className=\"px-2 py-1\">{t.operator}</td>\n                  <td className=\"px-2 py-1\">{t.amount_local}</td>\n                  <td className=\"px-2 py-1\">{t.status}</td>\n                  <td className=\"px-2 py-1\">{t.provider_txn_id || '-'}</td>\n                  <td className=\"px-2 py-1\">{t.created_at?.toDate ? t.created_at.toDate().toLocaleString() : '-'}</td>\n                  <td className=\"px-2 py-1\">\n                    {String(t.status).toLowerCase() === 'failed' && (\n                      <Button variant=\"outline\" onClick={() => retryTopup(t)}>Retry</Button>\n                    )}\n                  </td>\n                </tr>\n              ))\n            )}\n          </tbody>\n        </table>\n      </div>\n    </div>\n  );\n};\n\nexport default AdminTopupsPage;"],"names":["AdminTopupsPage","toast","useToast","topups","setTopups","useState","loading","setLoading","filter","setFilter","balance","setBalance","useEffect","q","query","collection","db","orderBy","limit","list","getDocs","d","err","idToken","_a","auth","data","filtered","useMemo","t","retryTopup","doc","resp","jsxs","jsx","Select","v","SelectTrigger","SelectValue","SelectContent","SelectItem","Button"],"mappings":"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"}