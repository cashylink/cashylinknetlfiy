{"version":3,"file":"CashSummaryDialog-DR1rHn48.js","sources":["../../src/components/CashSummaryDialog.tsx"],"sourcesContent":["import React from 'react';\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\r\nimport { DollarSign, Package, ArrowRightLeft } from 'lucide-react';\r\nimport { db } from '@/firebase';\r\nimport { useShop } from '@/hooks/useShop';\r\nimport { useFirebaseAuth } from '@/contexts/FirebaseAuthContext';\r\nimport { collection, getDocs, query, where, doc, updateDoc, getDoc } from 'firebase/firestore';\r\nimport { reportsService } from '@/utils/reportsService';\r\nimport { Button } from '@/components/ui/button';\r\nimport { useToast } from '@/hooks/use-toast';\r\nimport { MasterPinDialog } from '@/components/MasterPinDialog';\r\nimport { userDataService } from '@/integrations/firebase/services';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\n\r\ninterface CashSummaryDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  userId?: string | null;\r\n  cashBalance: number;\r\n  walletBalances: Record<string, number>;\r\n  transactions: any[];\r\n}\r\n\r\nexport const CashSummaryDialog: React.FC<CashSummaryDialogProps> = ({ open, onOpenChange, userId, cashBalance, walletBalances, transactions }) => {\r\n  const [accessorySalesToday, setAccessorySalesToday] = React.useState(0);\r\n  const [ackAccessoryToday, setAckAccessoryToday] = React.useState(0);\r\n  const [maintenanceTotalToday, setMaintenanceTotalToday] = React.useState(0);\r\n  const [ackMaintenanceToday, setAckMaintenanceToday] = React.useState(0);\r\n  const [localCashBalance, setLocalCashBalance] = React.useState<number>(cashBalance || 0);\r\n  const [isReceiptPinOpen, setIsReceiptPinOpen] = React.useState(false);\r\n  const [pendingReceiptType, setPendingReceiptType] = React.useState<'accessory' | 'maintenance' | null>(null);\r\n  const { toast } = useToast();\r\n  const { shopId: shopIdCtx } = useShop() || ({} as any);\r\n  const { profile } = useFirebaseAuth();\r\n  const [isDeductReasonOpen, setIsDeductReasonOpen] = React.useState(false);\r\n  const [deductReason, setDeductReason] = React.useState('');\r\n  const [isDeductPinOpen, setIsDeductPinOpen] = React.useState(false);\r\n  const [isDeductAmountOpen, setIsDeductAmountOpen] = React.useState(false);\r\n  const [deductAmount, setDeductAmount] = React.useState('');\r\n\r\n  const getCashBalanceKey = () => `cashBalance_${userId || 'default'}_${(shopIdCtx || (profile as any)?.shopId || 'main')}`;\r\n  const getGenericCashKey = () => `cashBalance_${userId || 'default'}`;\r\n\r\n  const formatCurrency = (n: number) => `${new Intl.NumberFormat('ar-EG').format(Number(n || 0))} جنيه`;\r\n\r\n  React.useEffect(() => {\r\n    const loadAccessorySales = async () => {\r\n      try {\r\n        if (!userId) { setAccessorySalesToday(0); return; }\r\n        const d = new Date();\r\n        const y = d.getFullYear();\r\n        const m = String(d.getMonth() + 1).padStart(2, '0');\r\n        const dd = String(d.getDate()).padStart(2, '0');\r\n        const todayStr = `${y}-${m}-${dd}`;\r\n        let snap;\r\n        try {\r\n          const q = query(\r\n            collection(db, 'dailySales'),\r\n            where('userId', '==', userId),\r\n            ...(shopIdCtx ? [where('shopId', '==', shopIdCtx)] : []),\r\n            where('date', '==', todayStr)\r\n          );\r\n          snap = await getDocs(q);\r\n        } catch {\r\n          const q2 = query(\r\n            collection(db, 'users', userId, 'dailySales'),\r\n            ...(shopIdCtx ? [where('shopId', '==', shopIdCtx)] : []),\r\n            where('date', '==', todayStr)\r\n          );\r\n          snap = await getDocs(q2);\r\n        }\r\n        let total = 0;\r\n        snap.forEach(docSnap => {\r\n          const d: any = docSnap.data();\r\n          const price = Number(d.sellingPrice ?? 0);\r\n          const qty = Number(d.quantity ?? 0);\r\n          if (price > 0 && qty > 0) {\r\n            total += price * qty;\r\n          }\r\n        });\r\n        setAccessorySalesToday(total);\r\n      } catch (e) {\r\n        console.warn('فشل تحميل مبيعات الإكسسوار لليوم:', e);\r\n      }\r\n    };\r\n\r\n    const loadMaintenanceTotal = async () => {\r\n      try {\r\n        if (!userId) { setMaintenanceProfitToday(0); return; }\r\n        const d = new Date();\r\n        const start = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0);\r\n        const end = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59, 999);\r\n        let snap;\r\n        try {\r\n          const q = query(\r\n            collection(db, 'maintenance_items'),\r\n            where('userId', '==', userId),\r\n            where('status', '==', 'completed')\r\n          );\r\n          snap = await getDocs(q);\r\n        } catch (e) {\r\n          snap = await getDocs(query(collection(db, 'maintenance_items'), where('userId', '==', userId)));\r\n        }\r\n        let totalAmount = 0;\r\n        snap.forEach(docSnap => {\r\n          const d: any = docSnap.data();\r\n          if ((d.status || 'in_progress') !== 'completed') return;\r\n          const completedAt = d.completedAt?.toDate?.();\r\n          if (!completedAt) return;\r\n          if (completedAt.getTime() >= start.getTime() && completedAt.getTime() <= end.getTime()) {\r\n            const repair = Number(d.repairPrice || 0);\r\n            if (Number.isFinite(repair) && repair > 0) totalAmount += repair;\r\n          }\r\n        });\r\n        setMaintenanceTotalToday(Math.max(0, totalAmount));\r\n      } catch (e) {\r\n        console.warn('فشل تحميل إجمالي فلوس الصيانة لليوم:', e);\r\n      }\r\n    };\r\n\r\n    \r\n\r\n    const loadDailyReceipts = async () => {\r\n      try {\r\n        if (!userId) { setAckAccessoryToday(0); return; }\r\n        const data = await userDataService.getUserData(userId);\r\n        const todayStr = new Date().toISOString().slice(0, 10);\r\n        const r = data?.dailyReceipts || {};\r\n        if (r?.date && String(r.date).slice(0,10) === todayStr) {\r\n          setAckAccessoryToday(Number(r.accessory || 0));\r\n          setAckMaintenanceToday(Number(r.maintenance || 0));\r\n        } else {\r\n          setAckAccessoryToday(0);\r\n          setAckMaintenanceToday(0);\r\n        }\r\n        try {\r\n          const sid = (shopIdCtx || (profile as any)?.shopId || 'main');\r\n          const snap = await getDoc(doc(db, 'dashboardData', sid));\r\n          if (snap.exists()) {\r\n            const v = Number((snap.data() as any)?.cashBalance || 0);\r\n            setLocalCashBalance(v);\r\n            try { localStorage.setItem(`cashBalance_${userId}`, String(v)); localStorage.setItem(getCashBalanceKey(), String(v)); } catch {}\r\n          } else {\r\n            setLocalCashBalance(Number(data?.cashBalance || cashBalance || 0));\r\n          }\r\n        } catch {\r\n          setLocalCashBalance(Number(data?.cashBalance || cashBalance || 0));\r\n        }\r\n      } catch (e) {\r\n        setAckAccessoryToday(0);\r\n        setAckMaintenanceToday(0);\r\n      }\r\n    };\r\n\r\n    if (open) {\r\n      loadAccessorySales();\r\n      loadMaintenanceTotal();\r\n      loadDailyReceipts();\r\n    }\r\n  }, [open, userId, transactions, cashBalance, shopIdCtx]);\r\n\r\n  React.useEffect(() => {\r\n    const handler = (e: any) => {\r\n      try {\r\n        const v = Number(e?.detail?.value);\r\n        if (Number.isFinite(v)) {\r\n          setLocalCashBalance(v);\r\n        }\r\n      } catch {}\r\n    };\r\n    window.addEventListener('cashBalanceChanged', handler as EventListener);\r\n    return () => window.removeEventListener('cashBalanceChanged', handler as EventListener);\r\n  }, [open]);\r\n\r\n  React.useEffect(() => {\r\n    if (!open || !userId) return;\r\n    const sid = (shopIdCtx || (profile as any)?.shopId || 'main');\r\n    // استبدال onSnapshot بـ getDoc لتقليل القراءات\r\n    const fetchDashboardData = async () => {\r\n      try {\r\n        const snap = await getDoc(doc(db, 'dashboardData', sid));\r\n        if (snap.exists()) {\r\n          const v = Number((snap.data() as any)?.cashBalance || 0);\r\n          setLocalCashBalance(v);\r\n          try { \r\n            localStorage.setItem(`cashBalance_${userId}`, String(v)); \r\n            localStorage.setItem(getCashBalanceKey(), String(v)); \r\n          } catch {}\r\n        }\r\n      } catch (e) {\r\n        console.warn('Error fetching dashboard data:', e);\r\n      }\r\n    };\r\n    \r\n    fetchDashboardData();\r\n    \r\n    return () => { };\r\n  }, [open, userId, shopIdCtx]);\r\n\r\n  const effectiveAccessoryToday = Math.max(0, Number(accessorySalesToday) - Number(ackAccessoryToday));\r\n  const effectiveMaintenanceToday = Math.max(0, Number(maintenanceTotalToday) - Number(ackMaintenanceToday));\r\n\r\n  const handleReceipt = async (type: 'accessory' | 'maintenance') => {\r\n    if (!userId) return;\r\n    const todayStr = new Date().toISOString().slice(0, 10);\r\n    try {\r\n      const amountToAck = type === 'accessory' ? effectiveAccessoryToday : effectiveMaintenanceToday;\r\n      if (amountToAck <= 0) {\r\n        toast({ title: 'لا يوجد مبلغ لتأكيد استلامه', variant: 'default' });\r\n        return;\r\n      }\r\n      const newCash = Math.max(0, Number(localCashBalance) - amountToAck);\r\n      setLocalCashBalance(newCash);\r\n      if (type === 'accessory') {\r\n        setAckAccessoryToday(prev => prev + amountToAck);\r\n      } else {\r\n        setAckMaintenanceToday(prev => prev + amountToAck);\r\n      }\r\n      await userDataService.updateUserData(userId, {\r\n        cashBalance: newCash,\r\n        dailyReceipts: {\r\n          date: todayStr,\r\n          accessory: type === 'accessory' ? (ackAccessoryToday + amountToAck) : ackAccessoryToday,\r\n          maintenance: type === 'maintenance' ? (ackMaintenanceToday + amountToAck) : ackMaintenanceToday,\r\n        }\r\n      });\r\n      try {\r\n        const sid = (shopIdCtx || (profile as any)?.shopId || 'main');\r\n        await updateDoc(doc(db, 'dashboardData', sid), { cashBalance: newCash, lastUpdated: new Date().toISOString() } as any);\r\n      } catch { }\r\n      try {\r\n        localStorage.setItem(`cashBalance_${userId}`, String(newCash));\r\n        localStorage.setItem(getCashBalanceKey(), String(newCash));\r\n      } catch {}\r\n      try {\r\n        window.dispatchEvent(new CustomEvent('cashBalanceChanged', { detail: { value: newCash } }));\r\n      } catch {}\r\n      toast({ title: 'تم الاستلام', description: `تم خصم ${amountToAck.toFixed(2)} من الدرج وتصفير بند ${type === 'accessory' ? 'الإكسسوار' : 'الصيانة'}` });\r\n    } catch (e) {\r\n      toast({ title: 'خطأ', description: 'تعذر تنفيذ عملية تم الاستلام', variant: 'destructive' });\r\n    }\r\n  };\r\n\r\n  const startDeductionFlow = () => {\r\n    setDeductReason('');\r\n    setDeductAmount('');\r\n    setIsDeductReasonOpen(true);\r\n  };\r\n\r\n  const confirmDeductReason = () => {\r\n    if (!deductReason.trim()) {\r\n      toast({ title: 'سبب الخصم مطلوب', variant: 'destructive' });\r\n      return;\r\n    }\r\n    setIsDeductReasonOpen(false);\r\n    setIsDeductPinOpen(true);\r\n  };\r\n\r\n  const openDeductAmount = () => {\r\n    setIsDeductPinOpen(false);\r\n    setIsDeductAmountOpen(true);\r\n  };\r\n\r\n  const performDeduction = async () => {\r\n    try {\r\n      if (!userId) return;\r\n      const amt = Math.max(0, Number(deductAmount || 0));\r\n      if (!Number.isFinite(amt) || amt <= 0) {\r\n        toast({ title: 'مبلغ غير صالح', description: 'أدخل مبلغ خصم صحيح أكبر من الصفر', variant: 'destructive' });\r\n        return;\r\n      }\r\n      const newCash = Math.max(0, Number(localCashBalance) - amt);\r\n      setLocalCashBalance(newCash);\r\n      await userDataService.updateUserData(userId, { cashBalance: newCash });\r\n      try {\r\n        const sid = (shopIdCtx || (profile as any)?.shopId || 'main');\r\n        await updateDoc(doc(db, 'dashboardData', sid), { cashBalance: newCash, lastUpdated: new Date().toISOString() } as any);\r\n      } catch { }\r\n      try { localStorage.setItem(`cashBalance_${userId}`, String(newCash)); } catch {}\r\n      try {\r\n        const timestamp = new Date().toISOString();\r\n        localStorage.setItem(getCashBalanceKey(), String(newCash));\r\n        localStorage.setItem(getCashBalanceKey() + '_lastUpdated', timestamp);\r\n      } catch {}\r\n\r\n      const tx = {\r\n        title: 'ايصال خصم من الفلوس النقديه',\r\n        type: 'cash_deduction',\r\n        amount: amt,\r\n        status: 'completed',\r\n        createdAt: new Date(),\r\n        note: deductReason,\r\n        cashierName: 'الحساب الرئيسي'\r\n      };\r\n      try { await userDataService.saveUserTransaction(userId, tx); } catch {}\r\n\r\n      toast({ title: 'تم الخصم', description: `تم خصم ${amt.toFixed(2)} من الدرج` });\r\n      setIsDeductAmountOpen(false);\r\n      setDeductAmount('');\r\n      setDeductReason('');\r\n    } catch (e) {\r\n      toast({ title: 'فشل الخصم', description: 'تعذر تنفيذ عملية الخصم', variant: 'destructive' });\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"sm:max-w-lg animate-in fade-in-90 zoom-in-95 slide-in-from-top-4\" dir=\"rtl\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"flex items-center gap-2 text-right\">\r\n            <DollarSign className=\"h-5 w-5 text-emerald-600\" />\r\n            تفاصيل الفلوس النقدية\r\n          </DialogTitle>\r\n        </DialogHeader>\r\n\r\n        <div className=\"space-y-3\">\r\n          <div className=\"flex items-center justify-between bg-amber-50 border border-amber-200 rounded-lg p-2\">\r\n            <div className=\"flex items-center gap-2 text-amber-800 font-bold text-sm\">\r\n              <DollarSign className=\"h-4 w-4\" />\r\n              مجموع الفلوس النقدية (الدرج)\r\n            </div>\r\n            <div className=\"text-amber-700 font-extrabold text-sm\">\r\n              {formatCurrency(localCashBalance)}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-2\">\r\n            <div className=\"flex items-center gap-2 text-blue-800 font-bold text-sm\">\r\n              <Package className=\"h-4 w-4\" />\r\n              فلوس الاكسسوار\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <div className=\"text-blue-700 font-extrabold text-sm\">\r\n                {formatCurrency(effectiveAccessoryToday)}\r\n              </div>\r\n              <Button\r\n                size=\"sm\"\r\n                variant=\"ghost\"\r\n                className=\"h-6 px-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800\"\r\n                onClick={() => { setPendingReceiptType('accessory'); setIsReceiptPinOpen(true); }}\r\n              >\r\n                تم الاستلام\r\n              </Button>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-center justify-between bg-emerald-50 border border-emerald-200 rounded-lg p-2\">\r\n            <div className=\"flex items-center gap-2 text-emerald-800 font-bold text-sm\">\r\n              <ArrowRightLeft className=\"h-4 w-4\" />\r\n              فلوس الصيانة\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <div className=\"text-emerald-700 font-extrabold text-sm\">\r\n                {formatCurrency(effectiveMaintenanceToday)}\r\n              </div>\r\n              <Button\r\n                size=\"sm\"\r\n                variant=\"ghost\"\r\n                className=\"h-6 px-2 rounded-lg bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800\"\r\n                onClick={() => { setPendingReceiptType('maintenance'); setIsReceiptPinOpen(true); }}\r\n              >\r\n                تم الاستلام\r\n              </Button>\r\n            </div>\r\n          </div>\r\n\r\n          \r\n\r\n          <div className=\"flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-2\">\r\n            <div className=\"flex items-center gap-2 text-red-800 font-bold text-sm\">\r\n              خصم فلوس من الفلوس النقديه\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <Button\r\n                size=\"sm\"\r\n                variant=\"ghost\"\r\n                className=\"h-6 px-2 rounded-lg bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800\"\r\n                onClick={startDeductionFlow}\r\n              >\r\n                خصم\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* نافذة الرقم السري لعملية تم الاستلام */}\r\n        <MasterPinDialog\r\n          open={isReceiptPinOpen}\r\n          onOpenChange={setIsReceiptPinOpen}\r\n          mode=\"verify\"\r\n          title=\"تأكيد الرقم السري لعملية تم الاستلام\"\r\n          description=\"يرجى إدخال الرقم السري الرئيسي لتأكيد استلام المبلغ\" \r\n          onSuccess={() => {\r\n            if (pendingReceiptType) {\r\n              handleReceipt(pendingReceiptType);\r\n              setPendingReceiptType(null);\r\n            }\r\n            setIsReceiptPinOpen(false);\r\n          }}\r\n        />\r\n\r\n        <Dialog open={isDeductReasonOpen} onOpenChange={setIsDeductReasonOpen}>\r\n          <DialogContent className=\"sm:max-w-sm\">\r\n            <DialogHeader>\r\n              <DialogTitle>سبب الخصم</DialogTitle>\r\n            </DialogHeader>\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"deduct-reason\">اكتب سبب الخصم</Label>\r\n              <Input id=\"deduct-reason\" value={deductReason} onChange={(e) => setDeductReason(e.target.value)} placeholder=\"سبب الخصم\" />\r\n            </div>\r\n            <div className=\"flex justify-end gap-2 mt-3\">\r\n              <Button variant=\"outline\" onClick={() => setIsDeductReasonOpen(false)}>إلغاء</Button>\r\n              <Button onClick={confirmDeductReason} className=\"bg-red-600 hover:bg-red-700\">متابعة</Button>\r\n            </div>\r\n          </DialogContent>\r\n        </Dialog>\r\n\r\n        <MasterPinDialog\r\n          open={isDeductPinOpen}\r\n          onOpenChange={setIsDeductPinOpen}\r\n          mode=\"verify\"\r\n          title=\"تأكيد الرقم السري لعملية الخصم\"\r\n          description=\"يرجى إدخال الرقم السري الرئيسي لمتابعة الخصم\"\r\n          onSuccess={openDeductAmount}\r\n        />\r\n\r\n        <Dialog open={isDeductAmountOpen} onOpenChange={setIsDeductAmountOpen}>\r\n          <DialogContent className=\"sm:max-w-sm\">\r\n            <DialogHeader>\r\n              <DialogTitle>مبلغ الخصم</DialogTitle>\r\n            </DialogHeader>\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"deduct-amount\">أدخل مبلغ الخصم</Label>\r\n              <Input id=\"deduct-amount\" type=\"number\" value={deductAmount} onChange={(e) => setDeductAmount(e.target.value)} placeholder=\"0.00\" />\r\n            </div>\r\n            <div className=\"flex justify-end gap-2 mt-3\">\r\n              <Button variant=\"outline\" onClick={() => setIsDeductAmountOpen(false)}>إلغاء</Button>\r\n              <Button onClick={performDeduction} className=\"bg-red-600 hover:bg-red-700\">تأكيد الخصم</Button>\r\n            </div>\r\n          </DialogContent>\r\n        </Dialog>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n};\r\n\r\nexport default CashSummaryDialog;\r\n"],"names":["CashSummaryDialog","open","onOpenChange","userId","cashBalance","walletBalances","transactions","accessorySalesToday","setAccessorySalesToday","React","ackAccessoryToday","setAckAccessoryToday","maintenanceTotalToday","setMaintenanceTotalToday","ackMaintenanceToday","setAckMaintenanceToday","localCashBalance","setLocalCashBalance","isReceiptPinOpen","setIsReceiptPinOpen","pendingReceiptType","setPendingReceiptType","toast","useToast","shopIdCtx","useShop","profile","useFirebaseAuth","isDeductReasonOpen","setIsDeductReasonOpen","deductReason","setDeductReason","isDeductPinOpen","setIsDeductPinOpen","isDeductAmountOpen","setIsDeductAmountOpen","deductAmount","setDeductAmount","getCashBalanceKey","formatCurrency","n","loadAccessorySales","d","y","m","dd","todayStr","snap","q","query","collection","db","where","getDocs","q2","total","docSnap","price","qty","e","loadMaintenanceTotal","start","end","totalAmount","completedAt","repair","loadDailyReceipts","data","userDataService","r","sid","getDoc","doc","v","_a","handler","effectiveAccessoryToday","effectiveMaintenanceToday","handleReceipt","type","amountToAck","newCash","prev","updateDoc","startDeductionFlow","confirmDeductReason","openDeductAmount","performDeduction","amt","timestamp","tx","jsx","Dialog","DialogContent","DialogHeader","jsxs","DialogTitle","DollarSign","Package","Button","ArrowRightLeft","MasterPinDialog","Label","Input"],"mappings":"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"}