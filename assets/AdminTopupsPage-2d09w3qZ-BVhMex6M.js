import{d as f,S as l,z as g,R as w,G as S,e as b,h as _,f as C,A as m,I as e,a as A}from"./index-C_crvORM.js";import{o as R,$ as T,r as k,Z as z,Q as d}from"./select-QKdc2TYn-CHN9ZvrB.js";const $=()=>{const{toast:r}=f(),[o,u]=l.useState([]),[j,h]=l.useState(!1),[c,y]=l.useState("all"),[i,N]=l.useState(null);l.useEffect(()=>{(async()=>{h(!0);try{const a=g(w(S,"topups"),b("created_at","desc"),_(100)),t=(await C(a)).docs.map(s=>({id:s.id,...s.data()}));u(t)}catch(a){console.error("Failed to fetch topups:",a),r({title:"خطأ",description:"تعذر تحميل العمليات",variant:"destructive"})}finally{h(!1)}})()},[r]),l.useEffect(()=>{(async()=>{var a;try{const t=await((a=m.currentUser)==null?void 0:a.getIdToken()),s=await(await fetch("/api/reloadly/balance",{headers:t?{Authorization:`Bearer ${t}`}:{}})).json().catch(()=>null);N((s==null?void 0:s.raw)??s)}catch{}})()},[]);const x=l.useMemo(()=>c==="all"?o:o.filter(a=>String(a.status).toLowerCase()===c),[o,c]),v=async a=>{var t;try{const s=await((t=m.currentUser)==null?void 0:t.getIdToken()),p=await fetch("/api/topup/retry",{method:"POST",headers:{"Content-Type":"application/json",...s?{Authorization:`Bearer ${s}`}:{}},body:JSON.stringify({id:a.id})}),n=await p.json().catch(()=>({success:!1,message:"فشل قراءة استجابة الخادم"}));p.ok&&n!=null&&n.success?r({title:"أُعيدت المحاولة",description:"تم إعادة محاولة العملية بنجاح"}):r({title:"فشل إعادة المحاولة",description:(n==null?void 0:n.message)||"حدث خطأ أثناء إعادة المحاولة",variant:"destructive"})}catch(s){console.error("Retry error:",s),r({title:"خطأ في الاتصال",description:"تعذر الاتصال بالخادم. حاول لاحقاً.",variant:"destructive"})}};return e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"لوحة تقارير الشحن"}),e.jsxs("div",{className:"text-sm text-gray-600",children:["رصيد Reloadly: ",(i==null?void 0:i.balance)??(i==null?void 0:i.availableBalance)??"غير متاح"]})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("span",{children:"الحالة:"}),e.jsxs(R,{value:c,onValueChange:a=>y(a),children:[e.jsx(T,{className:"w-40",children:e.jsx(k,{placeholder:"اختر الحالة"})}),e.jsxs(z,{children:[e.jsx(d,{value:"all",children:"الكل"}),e.jsx(d,{value:"pending",children:"في الانتظار"}),e.jsx(d,{value:"success",children:"ناجحة"}),e.jsx(d,{value:"failed",children:"فاشلة"})]})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-right",children:[e.jsx("th",{className:"px-2 py-1",children:"ID"}),e.jsx("th",{className:"px-2 py-1",children:"User"}),e.jsx("th",{className:"px-2 py-1",children:"Phone"}),e.jsx("th",{className:"px-2 py-1",children:"Operator"}),e.jsx("th",{className:"px-2 py-1",children:"Amount"}),e.jsx("th",{className:"px-2 py-1",children:"Status"}),e.jsx("th",{className:"px-2 py-1",children:"ProviderTxn"}),e.jsx("th",{className:"px-2 py-1",children:"Created"}),e.jsx("th",{className:"px-2 py-1",children:"Actions"})]})}),e.jsx("tbody",{children:j?e.jsx("tr",{children:e.jsx("td",{className:"p-4",colSpan:9,children:"جارٍ التحميل..."})}):x.length===0?e.jsx("tr",{children:e.jsx("td",{className:"p-4",colSpan:9,children:"لا يوجد بيانات"})}):x.map(a=>{var t;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-2 py-1 font-mono",children:a.id}),e.jsx("td",{className:"px-2 py-1",children:a.user_id||"-"}),e.jsx("td",{className:"px-2 py-1",children:a.phone}),e.jsx("td",{className:"px-2 py-1",children:a.operator}),e.jsx("td",{className:"px-2 py-1",children:a.amount_local}),e.jsx("td",{className:"px-2 py-1",children:a.status}),e.jsx("td",{className:"px-2 py-1",children:a.provider_txn_id||"-"}),e.jsx("td",{className:"px-2 py-1",children:(t=a.created_at)!=null&&t.toDate?a.created_at.toDate().toLocaleString():"-"}),e.jsx("td",{className:"px-2 py-1",children:String(a.status).toLowerCase()==="failed"&&e.jsx(A,{variant:"outline",onClick:()=>v(a),children:"Retry"})})]},a.id)})})]})})]})};export{$ as default};
//# sourceMappingURL=AdminTopupsPage-2d09w3qZ-BVhMex6M.js.map
