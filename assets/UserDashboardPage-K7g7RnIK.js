const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-BwuekbvX.js","./index-Cs-oiI7s.css","./dailyOperationCountService-CLP0M_n4.js","./profitService-BQtHSEJV.js"])))=>i.map(i=>d[i]);
var du=Object.defineProperty;var mu=(i,p,c)=>p in i?du(i,p,{enumerable:!0,configurable:!0,writable:!0,value:c}):i[p]=c;var eo=(i,p,c)=>mu(i,typeof p!="symbol"?p+"":p,c);import{W as ha,w as fd,x as yd,u as Pa,r as n,i as ua,j as e,aC as ve,aD as we,aE as Ie,aF as Ne,B as x,at as ya,C as pt,b as Xt,c as vs,av as Mn,e as Nt,bv as Mi,ay as Aa,bw as Xc,ae as _n,$ as Ba,aw as Hs,a as bd,D as Ns,au as Ut,I as q,ap as vd,aA as Ln,af as xt,bx as ba,S as kn,U as nr,F as hu,R as Ke,v as Z,E as Qs,A as wa,b9 as er,J as Oe,o as U,V as As,z as dt,m as Vr,by as yr,X as Ls,q as Je,n as je,az as de,t as Re,a1 as wd,bi as uu,aj as Pi,Z as ws,ah as $n,aN as Li,a3 as Ae,s as zr,aQ as co,aG as hs,bz as Xa,ax as xo,aH as et,Y as Yt,y as Ta,bs as va,bA as Nd,bB as xu,bC as pu,a9 as jd,bD as gu,a4 as fu,bE as yu,a8 as bu,bF as vu,bG as wu,bH as Nu,bI as Sd,bJ as ju,bK as Su,bL as Dd,a2 as Bs,aM as ed,aS as Pn,aR as mo,bM as Du,bN as Cu,ai as Iu,k as Au,H as Tu,bO as Sn,K as ku,bP as Dn,ao as Pu,al as Cn,aP as _u,bn as td,bm as to,bQ as Eu,bR as Ou,bS as Mu,bT as Lu,bU as $u,P as Wu,bV as sd,bW as Fu,aq as Ru,p as Bu,aO as In,bX as ad,bf as Uu,bY as qu}from"./index-BwuekbvX.js";import{B as Lt}from"./badge-DrEBT0VN.js";import{S as tr,a as sr,b as ar,c as rr,d as fa,C as En,e as Cd,f as zu}from"./select-BIyv3xLr.js";import{M as Is,a as Ms,P as Vu}from"./MasterPinDialog-DEq9IC9r.js";import{W as ra}from"./wallet-CAgFzrHe.js";import{a as Id,C as ho,S as Ju}from"./star-LQ-Hza1a.js";import{S as _i}from"./square-pen-CkBtvZ6S.js";import{T as bs,P as rd}from"./progress-VPnhN6GK.js";import{P as ka}from"./phone-_tSrlihK.js";import{A as Ad}from"./arrow-left-DivMceD5.js";import{C as vr,a as Ei,S as Td}from"./separator-rcpIVb2w.js";import{D as es,A as Jr}from"./dollar-sign-CiJ9TSKF.js";import{A as Di,P as Ku}from"./ProfileIcon-eHxFbD24.js";import{C as wr}from"./circle-alert-BtdHnsi4.js";import{C as po}from"./circle-x-Dy0RiGTM.js";import{C as Yr}from"./circle-check-big-DNepi39w.js";import{f as Zt,P as kd,C as Pd,T as Yu,b as Hu,c as nd,d as id,A as go,u as An,a as so,I as Qu,e as ld,R as Gu,g as Zu,M as Xu}from"./MaintenanceDialog-BXbfuQnN.js";import{S as ex}from"./switch-usASIx17.js";import{E as tx,a as sx}from"./broadcastService-Cj_znoms.js";import{D as ax,a as rx,b as nx,c as ix,d as lx}from"./dropdown-menu-DYS7z04i.js";import{B as ao}from"./bell-DZ4uDfdO.js";import{R as Ii}from"./refresh-cw-Cmpmouf1.js";import{ProfitService as ir}from"./profitService-BQtHSEJV.js";import{W as ox}from"./WalletsManagement-DFkSq5vY.js";import{FreeTrialService as od}from"./freeTrialService-BgjrOWMH.js";import{C as cx,P as dx,w as mx}from"./walletSelectionPinService-B78ayfz2.js";import{C as hx}from"./crown-BIg8QPCv.js";import"./index-y0rFiiSx.js";import"./whatsappService-BZaqqZoF.js";import"./download-x4vtGEVa.js";/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ux=[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]],cd=ha("banknote",ux);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xx=[["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M9 22v-3a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3",key:"cabbwy"}],["rect",{x:"4",y:"2",width:"16",height:"20",rx:"2",key:"1uxh74"}]],_d=ha("building",xx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const px=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]],dd=ha("calendar-days",px);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gx=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]],fx=ha("circle-plus",gx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yx=[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]],Oi=ha("id-card",yx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bx=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],md=ha("info",bx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vx=[["path",{d:"M13 5h8",key:"a7qcls"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 19h8",key:"c3s6r1"}],["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}]],ro=ha("list-checks",vx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wx=[["path",{d:"M2 6h4",key:"aawbzj"}],["path",{d:"M2 10h4",key:"l0bgd4"}],["path",{d:"M2 14h4",key:"1gsvsf"}],["path",{d:"M2 18h4",key:"1bu2t1"}],["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["path",{d:"M16 2v20",key:"rotuqe"}]],hd=ha("notebook",wx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nx=[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["polyline",{points:"3.29 7 12 12 20.71 7",key:"ousv84"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]],Ed=ha("package",Nx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const jx=[["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}],["path",{d:"M8 7v10",key:"23sfjj"}],["path",{d:"M12 7v10",key:"jspqdw"}],["path",{d:"M17 7v10",key:"578dap"}]],no=ha("scan-barcode",jx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Sx=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],Dx=ha("send",Sx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Cx=[["path",{d:"M16 17h6v-6",key:"t6n2it"}],["path",{d:"m22 17-8.5-8.5-5 5L2 7",key:"x473p"}]],lr=ha("trending-down",Cx),Od=async(i={})=>{try{return(await fd(yd,"getLastTransactions")(i)).data}catch(p){throw console.error("Error getting last transactions:",p),p.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):p.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+p.message):p.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+p.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(p.message||"خطأ غير معروف"))}},Ix=async i=>(await fd(yd,"sendTelegramMessage")(i)).data,Ax=Object.freeze(Object.defineProperty({__proto__:null,getLastTransactions:Od,sendTelegramMessage:Ix},Symbol.toStringTag,{value:"Module"})),Tx=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],kx=({isOpen:i,onClose:p,onWalletSelect:c,onEditWallet:w,onDeleteWallet:S})=>{const{user:C}=Pa(),[s,b]=n.useState([]),[F,D]=n.useState(!1),[E,O]=n.useState([]),[y,N]=n.useState(!1),{toast:k}=ua(),K=async(M,W)=>{const le=new Date().getMonth(),_e=new Date().getFullYear(),Se=W.filter(te=>{const ae=new Date(te.createdAt);return ae.getMonth()===le&&ae.getFullYear()===_e&&(te.lineId===M||te.fromWallet===M)}),xe=te=>{const ae=te.type;return te.txnType==="receive"||ae==="withdraw"||ae==="withdrawal"||ae==="receive"},ne=te=>{const ae=te.type;return te.txnType==="send"||ae==="send"||ae==="transfer"},Le=Se.filter(xe).reduce((te,ae)=>{const Be=ae.withdrawnAmount!==void 0?ae.withdrawnAmount:ae.amount;return te+(Be||0)},0),H=Se.filter(ne).reduce((te,ae)=>{const Be=ae.sentAmount!==void 0?ae.sentAmount:ae.amount;return te+(Be||0)},0);return{withdrawalUsage:Le,transferUsage:H}},$=M=>{const W=new Date().toISOString().split("T")[0],le=M.lastResetDate;if(!le)return{...M,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:W};const _e=new Date(le),Se=new Date;return _e.getMonth()!==Se.getMonth()||_e.getFullYear()!==Se.getFullYear()?{...M,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:W}:M};n.useEffect(()=>{if(!(C!=null&&C.uid)||!i)return;(async()=>{N(!0);try{const W=await ya.getByMerchantId(C.uid),le=await Mi.getByUserId(C.uid),Se=(await Promise.all(W.map(async xe=>{const{withdrawalUsage:ne,transferUsage:Le}=await K(xe.id,le),H=await Aa.getWalletLimits(xe.id);return{id:xe.id,name:xe.label||"محفظة بدون اسم",phone:xe.msisdn,nationalId:xe.nationalId||"",isDefault:!1,isActive:xe.isActive===!0,monthlyWithdrawalLimit:(H==null?void 0:H.monthlyWithdrawLimit)??xe.withdrawLimit??2e5,monthlyTransferLimit:(H==null?void 0:H.monthlyTransferLimit)??xe.transferLimit??2e5,monthlyWithdrawalUsage:(H==null?void 0:H.monthlyWithdrawUsed)??ne??0,monthlyTransferUsage:(H==null?void 0:H.monthlyTransferUsed)??Le??0,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:xe.walletProvider||""}}))).map($);b(Se)}catch(W){console.error("Error loading wallets:",W),k({title:"فشل جلب بيانات المحافظ",description:"قد تكون المشكلة بسبب الصلاحيات أو الاتصال. سيتم عرض البيانات المحلية إن وُجدت. جرّب تسجيل الدخول مجددًا أو افتح صفحة اختبار المصادقة من القائمة.",variant:"destructive"})}finally{N(!1)}})()},[C==null?void 0:C.uid,i]);const Y=M=>Tx.find(W=>W.id===M),re=(M,W)=>W>0?Math.min(M/W*100,100):0,pe=M=>new Intl.NumberFormat("ar-EG").format(M);return e.jsx(ve,{open:i,onOpenChange:p,children:e.jsxs(we,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(Ie,{className:"pb-4",children:[e.jsxs(Ne,{className:"flex items-center gap-2 text-lg",children:[e.jsx(ra,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(Lt,{variant:"secondary",className:"mr-2",children:[s.length," محفظة"]})]}),e.jsx("div",{className:"flex items-center gap-2 mt-2",children:F?e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",onClick:async()=>{try{if(!(C!=null&&C.uid))return;const M=s.map(W=>ya.update(W.id,{isActive:E.includes(W.id)}));await Promise.all(M),b(W=>W.map(le=>({...le,isActive:E.includes(le.id)}))),D(!1),k({title:"تم تفعيل المحافظ",description:"فقط المحافظ المحددة ستظهر في الاختيار الخارجي"});try{window.dispatchEvent(new CustomEvent("wallets:activation-updated"))}catch{}}catch(M){console.error("Error activating wallets:",M),k({title:"فشل التفعيل",description:"تعذر تفعيل المحافظ المحددة",variant:"destructive"})}},className:"h-7",children:"تفعيل المحافظ"}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>{D(!1),O([])},className:"h-7",children:"إلغاء"})]}):e.jsx(x,{variant:"outline",size:"sm",onClick:()=>D(!0),className:"h-7",children:"تحديد المحافظ"})})]}),y?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):s.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ra,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:s.map(M=>{const W=Y(M.walletProvider||"");re(M.monthlyWithdrawalUsage||0,M.monthlyWithdrawalLimit),re(M.monthlyTransferUsage||0,M.monthlyTransferLimit);const le=E.includes(M.id),_e=F?`cursor-pointer transition-shadow border-2 ${le?"border-blue-500 shadow-lg":"hover:border-blue-300"}`:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300";return e.jsxs(pt,{className:_e,onClick:()=>{F?O(Se=>Se.includes(M.id)?Se.filter(xe=>xe!==M.id):[...Se,M.id]):c(M)},children:[e.jsx(Xt,{className:"pb-3",children:e.jsxs(vs,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Mn,{className:"h-4 w-4"}),e.jsx("span",{children:M.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[M.isActive&&e.jsx(Lt,{variant:"default",className:"text-xs",children:"نشطة"}),M.isDefault&&e.jsxs(Lt,{variant:"default",className:"text-xs",children:[e.jsx(Id,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(x,{variant:"ghost",size:"sm",onClick:Se=>{Se.stopPropagation(),w==null||w(M)},className:"h-7 px-2",children:e.jsx(_i,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",onClick:Se=>{Se.stopPropagation(),S==null||S(M.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(bs,{className:"h-4 w-4"})})]})]})}),e.jsxs(Nt,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ka,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:M.phone})]}),M.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Oi,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:M.nationalId})]}),W&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(_d,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:W.name})]})]}),(()=>{const Se=M.monthlyWithdrawalLimit,xe=M.monthlyTransferLimit,ne=M.monthlyWithdrawalUsage||0,Le=M.monthlyTransferUsage||0,H=Math.max(Se-ne,0),te=Math.max(xe-Le,0);return e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{className:"text-xs text-gray-600 font-medium text-center",children:["الحدود الشهرية: ",(W==null?void 0:W.name)||M.walletProvider," - ",M.phone]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(ne/Math.max(Se,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Le/Math.max(xe,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",pe(H)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",pe(te)," جنيه"]})]})]})})(),e.jsx(x,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:Se=>{Se.stopPropagation(),c(M)},children:"عرض التفاصيل الكاملة"})]})]},M.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(x,{onClick:p,variant:"outline",children:[e.jsx(Ad,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},Px=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],_x=({wallet:i,isOpen:p,onClose:c,onBack:w})=>{const{user:S}=Pa(),[C,s]=n.useState([]),[b,F]=n.useState(!1),[D,E]=n.useState("month"),{toast:O}=ua();if(n.useEffect(()=>{if(!i||!(S!=null&&S.uid)||!p)return;(async()=>{F(!0);try{const ze=(await Mi.getByUserId(S.uid)).filter(yt=>yt.walletId===i.id).sort((yt,bt)=>new Date(bt.createdAt).getTime()-new Date(yt.createdAt).getTime());s(ze)}catch(oe){console.error("Error loading transactions:",oe),O({title:"فشل جلب معاملات المحفظة",description:"قد تكون المشكلة بسبب صلاحيات Firestore أو الاتصال. تم عرض ما أمكن محليًا. جرّب تسجيل الدخول مجددًا أو صفحة اختبار المصادقة.",variant:"destructive"})}finally{F(!1)}})()},[i,S==null?void 0:S.uid,p]),!i)return null;const y=Q=>Px.find(oe=>oe.id===Q),N=(Q,oe)=>oe>0?Math.min(Q/oe*100,100):0,k=Q=>new Intl.NumberFormat("ar-EG").format(Q),K=Q=>new Date(Q).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),Y=(()=>{const Q=new Date;let oe;switch(D){case"week":oe=new Date(Q.getTime()-7*24*60*60*1e3);break;case"month":oe=new Date(Q.getFullYear(),Q.getMonth(),1);break;default:return C}return C.filter(ze=>new Date(ze.createdAt)>=oe)})(),re=Q=>{const oe=Q.type,ze=Q.txnType;return oe==="withdraw"||oe==="withdrawal"||oe==="receive"||ze==="receive"},pe=Q=>{const oe=Q.type,ze=Q.txnType;return oe==="send"||oe==="transfer"||ze==="send"},M=Y.filter(Q=>re(Q)&&Q.status==="completed").reduce((Q,oe)=>{const ze=oe.withdrawnAmount!==void 0?oe.withdrawnAmount:oe.amount;return Q+(ze||0)},0),W=Y.filter(Q=>pe(Q)&&Q.status==="completed").reduce((Q,oe)=>{const ze=oe.sentAmount!==void 0?oe.sentAmount:oe.amount;return Q+(ze||0)},0),le=Y.filter(Q=>Q.type==="deposit"&&Q.status==="completed").reduce((Q,oe)=>Q+oe.amount,0),_e=Y.filter(Q=>Q.status==="completed"),Se=_e.length,xe=_e.reduce((Q,oe)=>{if(re(oe)){const ze=oe.withdrawnAmount??oe.receivedAmount??oe.amount??0;return Q+Xc(Number(ze)||0,"receive")}if(pe(oe)){const ze=oe.sentAmount??oe.transferredAmount??oe.amount??0;return Q+Xc(Number(ze)||0,"send")}return Q},0),ne=y(i.walletProvider||""),Le=N(i.monthlyWithdrawalUsage||0,i.monthlyWithdrawalLimit),H=N(i.monthlyTransferUsage||0,i.monthlyTransferLimit),te=Q=>{switch(Q){case"withdrawal":return e.jsx(lr,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(_n,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx(es,{className:"h-4 w-4 text-green-500"});default:return e.jsx(Di,{className:"h-4 w-4 text-gray-500"})}},ae=Q=>{switch(Q){case"completed":return e.jsx(Yr,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(Ba,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(po,{className:"h-4 w-4 text-red-500"});default:return e.jsx(wr,{className:"h-4 w-4 text-gray-500"})}},Be=Q=>{switch(Q){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},Ge=Q=>{switch(Q){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(ve,{open:p,onOpenChange:c,children:e.jsxs(we,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Ie,{className:"pb-4",children:e.jsxs(Ne,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Mn,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",i.name,i.isDefault&&e.jsxs(Lt,{variant:"default",className:"mr-2",children:[e.jsx(Id,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(pt,{children:[e.jsx(Xt,{children:e.jsxs(vs,{className:"text-sm flex items-center gap-2",children:[e.jsx(Oi,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(Nt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ka,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.phone})]}),i.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Oi,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.nationalId})]}),ne&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(_d,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:ne.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",ne.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",ne.nationalId]})]})]}),i.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(vr,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(i.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs(pt,{children:[e.jsx(Xt,{children:e.jsxs(vs,{className:"text-sm flex items-center gap-2",children:[e.jsx(ho,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(Nt,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(lr,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[k(i.monthlyWithdrawalUsage||0)," / ",k(i.monthlyWithdrawalLimit)]})]}),e.jsx(rd,{value:Le,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",k(i.monthlyWithdrawalLimit-(i.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(Ei,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(_n,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[k(i.monthlyTransferUsage||0)," / ",k(i.monthlyTransferLimit)]})]}),e.jsx(rd,{value:H,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",k(i.monthlyTransferLimit-(i.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(pt,{children:e.jsxs(Nt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(lr,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:k(M)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx(pt,{children:e.jsxs(Nt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(_n,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:k(W)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx(pt,{children:e.jsxs(Nt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(es,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:k(le)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})}),e.jsx(pt,{children:e.jsxs(Nt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(ho,{className:"h-5 w-5 text-emerald-600"})}),e.jsx("div",{className:"text-lg font-bold",children:k(xe)}),e.jsx("div",{className:"text-xs text-gray-600",children:"أرباح الفترة"})]})}),e.jsx(pt,{children:e.jsxs(Nt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Di,{className:"h-5 w-5 text-purple-600"})}),e.jsx("div",{className:"text-lg font-bold",children:k(Se)}),e.jsx("div",{className:"text-xs text-gray-600",children:"عدد العمليات"})]})})]}),e.jsxs(pt,{children:[e.jsx(Xt,{children:e.jsxs(vs,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Di,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{size:"sm",variant:D==="week"?"default":"outline",onClick:()=>E("week"),className:"text-xs",children:"أسبوع"}),e.jsx(x,{size:"sm",variant:D==="month"?"default":"outline",onClick:()=>E("month"),className:"text-xs",children:"شهر"}),e.jsx(x,{size:"sm",variant:D==="all"?"default":"outline",onClick:()=>E("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(Nt,{children:b?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):Y.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Di,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:Y.map(Q=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[te(Q.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[Be(Q.type)," - ",k(Q.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:K(Q.createdAt)}),Q.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:Q.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[ae(Q.status),e.jsx("span",{className:"text-xs",children:Ge(Q.status)})]})]},Q.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(x,{onClick:w,variant:"outline",children:[e.jsx(Ad,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(x,{onClick:c,variant:"outline",children:"إغلاق"})]})]})})},io=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Ex=({isOpen:i,onClose:p,onWalletUpdate:c,initialEditingWallet:w})=>{const{toast:S}=ua(),{user:C,userSubscription:s}=Pa();(()=>{var Fe,jt;const B=((Fe=s==null?void 0:s.subscription)==null?void 0:Fe.planType)??((jt=s==null?void 0:s.subscription)==null?void 0:jt.plan)??(s==null?void 0:s.planType)??(s==null?void 0:s.plan)??null,De=typeof B=="string"?String(B).trim().toLowerCase():null;return B===Hs.TAHWEELA||De==="tahweela"||De==="تحويله"})();const b=bd(),[F,D]=n.useState([]),[E,O]=n.useState(!1),[y,N]=n.useState(null),[k,K]=n.useState(""),[$,Y]=n.useState(""),[re,pe]=n.useState(""),[M,W]=n.useState(""),[le,_e]=n.useState("200000"),[Se,xe]=n.useState("200000"),[ne,Le]=n.useState("100000"),[H,te]=n.useState("60000"),[ae,Be]=n.useState(!1),[Ge,Q]=n.useState(null),[oe,ze]=n.useState(!1),[yt,bt]=n.useState(!1),[$t,Ht]=n.useState(!1),[ts,Wt]=n.useState(null),qe=()=>`wallets_${(C==null?void 0:C.uid)||"default"}`;n.useEffect(()=>{w&&(N(w),O(!0),K(w.name||""),Y(w.phone||""),pe(w.nationalId||""),W(w.walletProvider||""),_e((w.monthlyWithdrawalLimit||2e5).toString()),xe((w.monthlyTransferLimit||2e5).toString()),Le((w.dailyWithdrawalLimit||1e5).toString()),te((w.dailyTransferLimit||6e4).toString()),Be(!!w.isDefault))},[w]);const rt=B=>{const De=new Date,Fe=De.getMonth(),jt=De.getFullYear();if(!B.lastResetDate)return{...B,monthlyWithdrawalUsage:B.monthlyWithdrawalUsage||0,monthlyTransferUsage:B.monthlyTransferUsage||0,lastResetDate:De.toISOString().split("T")[0]};const gt=new Date(B.lastResetDate),Tt=gt.getMonth(),xs=gt.getFullYear();return Fe!==Tt||jt!==xs?{...B,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:De.toISOString().split("T")[0]}:B},lt=async(B,De)=>{const Fe=new Date().getMonth(),jt=new Date().getFullYear(),gt=De.filter(vt=>{const it=new Date(vt.createdAt);return it.getMonth()===Fe&&it.getFullYear()===jt&&vt.lineId===B}),Tt=gt.filter(vt=>vt.txnType==="receive").reduce((vt,it)=>vt+(it.amount||0),0),xs=gt.filter(vt=>vt.txnType==="send").reduce((vt,it)=>vt+(it.amount||0),0);return{withdrawalUsage:Tt,transferUsage:xs}},$e=async(B,De)=>{const Fe=new Date,jt=Fe.getDate(),gt=Fe.getMonth(),Tt=Fe.getFullYear(),xs=De.filter(Et=>{const us=new Date(Et.createdAt);return us.getDate()===jt&&us.getMonth()===gt&&us.getFullYear()===Tt&&Et.lineId===B}),vt=xs.filter(Et=>Et.txnType==="receive").reduce((Et,us)=>Et+(us.amount||0),0),it=xs.filter(Et=>Et.txnType==="send").reduce((Et,us)=>Et+(us.amount||0),0);return{withdrawalUsage:vt,transferUsage:it}};n.useEffect(()=>{(async()=>{if(!(C!=null&&C.uid)){console.log("No user authenticated, skipping wallet loading"),ze(!1);return}console.log("Loading wallets for user:",C.uid),ze(!0);try{const{auth:De}=await xt(async()=>{const{auth:it}=await import("./index-BwuekbvX.js").then(Et=>Et.cj);return{auth:it}},__vite__mapDeps([0,1]),import.meta.url);let Fe=0;const jt=5;for(;!De.currentUser&&Fe<jt;)console.log(`Waiting for auth state... attempt ${Fe+1}`),await new Promise(it=>setTimeout(it,1e3)),Fe++;if(!De.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",De.currentUser.uid),console.log("Context User:",C.uid),console.log("Fetching wallets from Firebase...");const gt=await ya.getByMerchantId(C.uid);console.log("Fetched wallets:",gt),console.log("Fetching transactions from Firebase...");const Tt=await Mi.getByUserId(C.uid);console.log("Fetched transactions:",Tt);const vt=(await Promise.all(gt.map(async it=>{const{withdrawalUsage:Et,transferUsage:us}=await lt(it.id,Tt),{withdrawalUsage:kt,transferUsage:$s}=await $e(it.id,Tt);return{id:it.id,name:it.label||"محفظة بدون اسم",phone:it.msisdn,isDefault:!1,monthlyWithdrawalLimit:it.withdrawLimit||2e5,monthlyTransferLimit:it.transferLimit||2e5,dailyWithdrawalLimit:it.dailyWithdrawLimit||1e5,dailyTransferLimit:it.dailyTransferLimit||6e4,monthlyWithdrawalUsage:Et,monthlyTransferUsage:us,dailyWithdrawalUsage:kt,dailyTransferUsage:$s,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:it.defaultTransferCommission!=null?Number(it.defaultTransferCommission):null,defaultWithdrawCommission:it.defaultWithdrawCommission!=null?Number(it.defaultWithdrawCommission):null}}))).map(rt);D(vt),console.log("Wallets loaded successfully:",vt)}catch(De){console.error("Error loading wallets:",De),D([])}finally{ze(!1)}})()},[C==null?void 0:C.uid]);const Qe=()=>{K(""),Y(""),pe(""),W(""),_e("200000"),xe("200000"),Le("100000"),te("60000"),Be(!1),N(null),O(!1)},ee=async()=>{if(!k.trim()||!$.trim()||!M.trim()){S({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(C!=null&&C.uid)){S({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}ze(!0);try{if(y){await ya.update(y.id,{label:k.trim(),msisdn:$.trim(),withdrawLimit:parseInt(le),transferLimit:parseInt(Se),dailyWithdrawLimit:parseInt(ne),dailyTransferLimit:parseInt(H)}),await Aa.setLimits(y.id,{dailyTransferLimit:parseInt(H||"0"),dailyWithdrawLimit:parseInt(ne||"0"),monthlyTransferLimit:parseInt(Se||"0"),monthlyWithdrawLimit:parseInt(le||"0")});const B=F.map(De=>De.id===y.id?{...De,name:k.trim(),phone:$.trim(),nationalId:re.trim(),walletProvider:M,monthlyWithdrawalLimit:parseInt(le),monthlyTransferLimit:parseInt(Se),dailyWithdrawalLimit:parseInt(ne),dailyTransferLimit:parseInt(H)}:De);D(B),localStorage.setItem(qe(),JSON.stringify(B)),S({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const B={merchantUserId:C.uid,provider:M,msisdn:$.trim(),label:k.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(le),transferLimit:parseInt(Se),dailyTransferLimit:parseInt(H),dailyWithdrawLimit:parseInt(ne),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},De=await ya.create(B);await Aa.setLimits(De,{dailyTransferLimit:parseInt(H||"0"),dailyWithdrawLimit:parseInt(ne||"0"),monthlyTransferLimit:parseInt(Se||"0"),monthlyWithdrawLimit:parseInt(le||"0")});const Fe=new Date().toISOString().split("T")[0],jt={id:De,name:k.trim(),phone:$.trim(),nationalId:re.trim(),walletProvider:M,isDefault:ae,monthlyWithdrawalLimit:parseInt(le),monthlyTransferLimit:parseInt(Se),dailyWithdrawalLimit:parseInt(ne),dailyTransferLimit:parseInt(H),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:Fe,defaultTransferCommission:null,defaultWithdrawCommission:null},gt=[...F,jt];D(gt),localStorage.setItem(qe(),JSON.stringify(gt)),S({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}c&&c(),Qe(),O(!1),N(null)}catch(B){console.error("Error saving wallet:",B),S({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{ze(!1)}},_t=B=>{N(B),K(B.name),Y(B.phone),pe(B.nationalId||""),W(B.walletProvider||""),_e(B.monthlyWithdrawalLimit.toString()),xe(B.monthlyTransferLimit.toString()),Be(B.isDefault),O(!0)},ss=async B=>{const De=F.find(Fe=>Fe.id===B);if(De!=null&&De.isDefault){S({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(C!=null&&C.uid)){S({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}ze(!0);try{await ya.delete(B);const Fe=F.filter(jt=>jt.id!==B);D(Fe),localStorage.setItem(qe(),JSON.stringify(Fe)),c&&c(),S({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(Fe){console.error("Error deleting wallet:",Fe),S({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{ze(!1)}},as=B=>{const De=F.map(Fe=>({...Fe,isDefault:Fe.id===B}));D(De),localStorage.setItem(qe(),JSON.stringify(De)),c&&c(),S({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(ve,{open:i,onOpenChange:p,children:[e.jsxs(we,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(Ie,{className:"pb-2",children:e.jsxs(Ne,{className:"flex items-center gap-1 text-sm",children:[e.jsx(ra,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",F.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(x,{onClick:()=>{Ht(!0)},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(Ns,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(x,{onClick:()=>{p(),b("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(Ut,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),(E||y)&&e.jsxs(pt,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx(Xt,{className:"pb-1",children:e.jsx(vs,{className:"text-sm",children:y?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(Nt,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(tr,{value:M,onValueChange:W,children:[e.jsx(sr,{className:"h-6 text-xs flex-1",children:e.jsx(ar,{placeholder:"اختر شركة المحفظة"})}),e.jsx(rr,{children:io.map(B=>e.jsx(fa,{value:B.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:B.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:De=>{De.preventDefault(),De.stopPropagation(),Q(B.id)},children:e.jsx(md,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},B.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx(q,{value:k,onChange:B=>K(B.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx(ka,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{value:$,onChange:B=>Y(B.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx(Oi,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{value:re,onChange:B=>pe(B.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(es,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{type:"number",value:le,onChange:B=>_e(B.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(es,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{type:"number",value:Se,onChange:B=>xe(B.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(lr,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx(q,{type:"number",value:ne,onChange:B=>Le(B.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(_n,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx(q,{type:"number",value:H,onChange:B=>te(B.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:ae,onChange:B=>Be(B.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(vd,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(x,{onClick:ee,className:"flex-1 h-6 text-xs",size:"sm",children:y?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(x,{variant:"outline",onClick:Qe,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:F.map(B=>{var De;return e.jsxs(pt,{className:`${B.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx(Xt,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(vs,{className:"text-sm flex items-center gap-1",children:[e.jsx(ra,{className:"h-3 w-3"}),B.name]}),B.isDefault&&e.jsx(Lt,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(Nt,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ka,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:B.phone})]}),B.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((De=io.find(Fe=>Fe.id===B.walletProvider))==null?void 0:De.name)||B.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((B.monthlyWithdrawalUsage||0)/B.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((B.monthlyTransferUsage||0)/B.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(B.monthlyWithdrawalLimit-(B.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(B.monthlyTransferLimit-(B.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((B.dailyWithdrawalUsage||0)/B.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((B.dailyTransferUsage||0)/B.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify بين items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(B.dailyWithdrawalLimit-(B.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(B.dailyTransferLimit-(B.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(x,{size:"sm",variant:"outline",onClick:()=>_t(B),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(_i,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!B.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",variant:"outline",onClick:()=>as(B.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(x,{size:"sm",variant:"destructive",onClick:()=>ss(B.id),className:"h-5 px-1",children:e.jsx(bs,{className:"h-2 w-2"})})]})]})]})]},B.id)})}),F.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),Ge&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>Q(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(Ln,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const B=io.find(De=>De.id===Ge);return B?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:B.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:B.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:B.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(md,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(Is,{open:$t,onOpenChange:Ht,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Ht(!1),bt(!0)}}),e.jsx(kx,{isOpen:yt,onClose:()=>bt(!1),onWalletSelect:B=>{Wt(B),bt(!1)},onEditWallet:B=>{b(`/user/add-wallet?edit=1&id=${B.id}`),bt(!1)},onDeleteWallet:async B=>{try{if(await ya.delete(B),D(De=>{const Fe=De.filter(jt=>jt.id!==B);try{localStorage.setItem(qe(),JSON.stringify(Fe))}catch(jt){console.error("Failed to update localStorage wallets after delete:",jt)}return Fe}),c)try{await c()}catch(De){console.error("onWalletUpdate callback failed:",De)}}catch(De){console.error("Error deleting wallet:",De)}}}),e.jsx(_x,{wallet:ts,isOpen:!!ts,onClose:()=>Wt(null),onBack:()=>{Wt(null),bt(!0)}})]})},Ox=({isOpen:i,onClose:p,transaction:c,onDelete:w})=>{if(!c)return null;const S=D=>{switch(D){case"completed":return e.jsx(Yr,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(Ba,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(po,{className:"h-5 w-5 text-red-500"});default:return e.jsx(Ba,{className:"h-5 w-5 text-gray-500"})}},C=D=>{switch(D){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},s=D=>{switch(D){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},b=()=>{const D=!!c.senderNumber,E=!!c.senderName,O=D?"الرقم المرسل:":E?"الرقم الراسل:":"رقم المحفظة:",y=D?c.senderNumber:E?c.senderName:c.senderPhone,N=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${c.transactionReference||c.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${c.merchantShopName||c.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${s(c.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${c.status==="completed"?"#16a34a":c.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${C(c.status)}
            </span>
          </div>

          ${c!=null&&c.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${c.cashierName}</span>
            </div>
          `:""}
          
          ${c.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${O}</span>
              <span style="color: #1e293b;">${y}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${c.receiverNumber||c.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${Zt(c.transferredAmount||c.amount)} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${c.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${Zt(c.withdrawnAmountDetailed||c.withdrawnAmount||c.amount)} جنيه</span>
            </div>
          `}
          
          ${c.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${Zt(c.commission||0)} جنيه</span>
            </div>
          `:""}
          ${c.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الربح:</span>
              <span style="color: #16a34a; font-weight: 600;">${Zt(c.commission||0)} جنيه</span>
            </div>
          `:""}
          ${c!=null&&c.fee&&Number(c.fee)>0?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرسوم:</span>
              <span style="color: #64748b; font-weight: 600;">${Zt(c.fee||0)} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${c.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${c.type==="withdraw"?"-":""}${Zt(c.amount)} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,k=window.open("","_blank");k&&(k.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${c.transactionReference||c.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${N}
          </body>
        </html>
      `),k.document.close(),k.print())},F=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(w(c.id),p())};return e.jsx(ve,{open:i,onOpenChange:p,children:e.jsxs(we,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Ie,{children:e.jsxs(Ne,{className:"flex items-center gap-2 text-xl",children:[e.jsx(ba,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(pt,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs(Xt,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[S(c.status),e.jsx(Lt,{variant:c.status==="completed"?"default":"secondary",className:"text-sm",children:C(c.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[c.type==="withdraw"?"-":"",Zt(c.amount)," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",c.transactionReference||c.id]})]})}),e.jsxs(pt,{children:[e.jsx(Xt,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(kn,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(Nt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:c.merchantShopName||c.shopName||"غير محدد"})]}),(c==null?void 0:c.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:c.cashierName})]})]})]}),e.jsxs(pt,{children:[e.jsx(Xt,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Mn,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(Nt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(Lt,{variant:"outline",className:"bg-blue-100 text-blue-800",children:s(c.type)})]}),c.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const D=!!c.senderNumber,E=!!c.senderName,O=D?"الرقم المرسل:":E?"الرقم الراسل:":"رقم المحفظة:",y=D?c.senderNumber:E?c.senderName:c.senderPhone,N=D?nr:ka;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:O})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:y})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(hu,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(nr,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:c.receiverNumber||c.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(es,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[Zt(c.transferredAmount||c.amount)," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ka,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:c.senderPhone})]}),(c==null?void 0:c.senderName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(nr,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("span",{className:"text-gray-900",children:c.senderName})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(es,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[Zt(c.withdrawnAmountDetailed||c.withdrawnAmount||c.amount)," جنيه"]})]})]}),c.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[c.commission," جنيه"]})]}),c.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-green-700",children:"الربح:"}),e.jsxs("span",{className:"text-green-900 font-semibold",children:[c.commission," جنيه"]})]}),(c==null?void 0:c.fee)&&Number(c.fee)>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الرسوم:"}),e.jsxs("span",{className:"text-gray-900 font-semibold",children:[c.fee," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(vr,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:c.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(x,{onClick:b,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx(kd,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(x,{onClick:F,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(bs,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(x,{onClick:p,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function ud({open:i,onOpenChange:p,onSuccess:c,title:w,description:S,currentBalance:C,balanceLabel:s,userId:b}){const[F,D]=n.useState(""),[E,O]=n.useState(C.toString()),[y,N]=n.useState(!1),[k,K]=n.useState(""),[$,Y]=n.useState(!1),re=async M=>{M.preventDefault(),K(""),Y(!0);try{const W=parseFloat(E);if(isNaN(W)||W<0){K("يرجى إدخال مبلغ صحيح"),Y(!1);return}await Ms.hasMasterPin(b)?await Ms.verifyMasterPin(F,b)?(c(W),p(!1),D(""),O("")):K("الرقم السري غير صحيح"):K("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{K("حدث خطأ أثناء التحقق من الرقم السري")}finally{Y(!1)}},pe=()=>{D(""),O(C.toString()),K(""),p(!1)};return Ke.useEffect(()=>{i&&O(C.toString())},[C,i]),e.jsx(ve,{open:i,onOpenChange:pe,children:e.jsxs(we,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Ie,{children:e.jsxs(Ne,{className:"flex items-center gap-2 text-right",children:[e.jsx(es,{className:"h-5 w-5"}),w]})}),e.jsxs("form",{onSubmit:re,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:S}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(Z,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[C.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx(q,{id:"newAmount",type:"number",step:"0.01",min:"0",value:E,onChange:M=>O(M.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"pin",type:y?"text":"password",value:F,onChange:M=>D(M.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>N(!y),children:y?e.jsx(Qs,{className:"h-4 w-4"}):e.jsx(Ns,{className:"h-4 w-4"})})]})]}),k&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(wr,{className:"h-4 w-4"}),k]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(x,{type:"button",variant:"outline",onClick:pe,className:"flex-1",children:"إلغاء"}),e.jsx(x,{type:"submit",disabled:$||!F||!E,className:"flex-1",children:$?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(wa,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class On{static getSecretKey(p){return p?`${this.SECRET_KEY_BASE}_${p}`:this.SECRET_KEY_BASE}static setSecretPin(p,c){const w=btoa(p);this.secretCache.set(this.getSecretKey(c),w)}static hasSecretPin(p){return this.secretCache.has(this.getSecretKey(p))}static verifySecretPin(p,c){const w=this.secretCache.get(this.getSecretKey(c));if(!w)return!1;try{return atob(w)===p}catch{return!1}}static clearSecretPin(p){this.secretCache.delete(this.getSecretKey(p))}}eo(On,"SECRET_KEY_BASE","dashboard_secret_pin"),eo(On,"secretCache",new Map);function Mx({open:i,onOpenChange:p,userId:c}){const[w,S]=n.useState(""),[C,s]=n.useState(""),[b,F]=n.useState(""),[D,E]=n.useState(!1),[O,y]=n.useState(!1),[N,k]=n.useState(!1),[K,$]=n.useState(""),[Y,re]=n.useState(!1),{toast:pe}=ua(),M=On.hasSecretPin(c),W=async _e=>{_e.preventDefault(),$(""),re(!0);try{if(!C||C.length<4){$("يجب أن يكون الرقم السري 4 أرقام على الأقل"),re(!1);return}if(C!==b){$("الرقم السري الجديد وتأكيده غير متطابقين"),re(!1);return}if(M){if(!w){$("يرجى إدخال الرقم السري الحالي"),re(!1);return}if(!On.verifySecretPin(w,c)){$("الرقم السري الحالي غير صحيح"),re(!1);return}}On.setSecretPin(C,c),pe({title:M?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:M?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),le()}catch{$("حدث خطأ أثناء حفظ الرقم السري")}finally{re(!1)}},le=()=>{S(""),s(""),F(""),$(""),E(!1),y(!1),k(!1),p(!1)};return e.jsx(ve,{open:i,onOpenChange:le,children:e.jsxs(we,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Ie,{children:e.jsxs(Ne,{className:"flex items-center gap-2 text-right",children:[e.jsx(vd,{className:"h-5 w-5"}),M?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:W,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:M?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),M&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"currentPin",type:D?"text":"password",autoComplete:"off",value:w,onChange:_e=>S(_e.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>E(!D),children:D?e.jsx(Qs,{className:"h-4 w-4"}):e.jsx(Ns,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"newPin",type:O?"text":"password",autoComplete:"off",value:C,onChange:_e=>s(_e.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!O),children:O?e.jsx(Qs,{className:"h-4 w-4"}):e.jsx(Ns,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:N?"text":"password",autoComplete:"off",value:b,onChange:_e=>F(_e.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>k(!N),children:N?e.jsx(Qs,{className:"h-4 w-4"}):e.jsx(Ns,{className:"h-4 w-4"})})]})]}),K&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(wr,{className:"h-4 w-4"}),K]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:Y,className:"flex-1",children:[e.jsx(wa,{className:"h-4 w-4 mr-2"}),Y?"جاري الحفظ...":M?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(x,{type:"button",variant:"outline",onClick:le,disabled:Y,children:"إلغاء"})]})]})]})})}const lo=new Map;function Lx({open:i,onOpenChange:p,userId:c}){const[w,S]=n.useState(""),[C,s]=n.useState(""),[b,F]=n.useState(""),[D,E]=n.useState(!1),[O,y]=n.useState(!1),[N,k]=n.useState(!1),[K,$]=n.useState(""),[Y,re]=n.useState(!1),{toast:pe}=ua(),M=c?`cash_drawer_pin_${c}`:"cash_drawer_pin",W=()=>lo.has(M),le=ne=>{const Le=lo.get(M);if(!Le)return!1;try{return atob(Le)===ne}catch{return!1}},_e=ne=>{const Le=btoa(ne);lo.set(M,Le)},Se=async ne=>{ne.preventDefault(),$(""),re(!0);try{if(!C||C.length<4){$("يجب أن يكون الرقم السري 4 أرقام على الأقل"),re(!1);return}if(C!==b){$("الرقم السري الجديد وتأكيده غير متطابقين"),re(!1);return}if(W()){if(!w){$("يرجى إدخال الرقم السري الحالي لدرج النقدية"),re(!1);return}if(!le(w)){$("الرقم السري الحالي لدرج النقدية غير صحيح"),re(!1);return}}_e(C),pe({title:W()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:W()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),xe()}catch{$("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{re(!1)}},xe=()=>{S(""),s(""),F(""),$(""),E(!1),y(!1),k(!1),p(!1)};return e.jsx(ve,{open:i,onOpenChange:xe,children:e.jsxs(we,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Ie,{children:e.jsxs(Ne,{className:"flex items-center gap-2 text-right",children:[e.jsx(es,{className:"h-5 w-5 text-green-600"}),W()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:Se,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:W()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),W()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"currentPin",type:D?"text":"password",autoComplete:"off",value:w,onChange:ne=>S(ne.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>E(!D),children:D?e.jsx(Qs,{className:"h-4 w-4"}):e.jsx(Ns,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"newPin",type:O?"text":"password",autoComplete:"off",value:C,onChange:ne=>s(ne.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!O),children:O?e.jsx(Qs,{className:"h-4 w-4"}):e.jsx(Ns,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:N?"text":"password",autoComplete:"off",value:b,onChange:ne=>F(ne.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>k(!N),children:N?e.jsx(Qs,{className:"h-4 w-4"}):e.jsx(Ns,{className:"h-4 w-4"})})]})]}),K&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(wr,{className:"h-4 w-4"}),K]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:Y,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(wa,{className:"h-4 w-4 mr-2"}),Y?"جاري الحفظ...":W()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(x,{type:"button",variant:"outline",onClick:xe,disabled:Y,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}const oo=new Map;function $x({open:i,onOpenChange:p,userId:c}){const[w,S]=n.useState(""),[C,s]=n.useState(""),[b,F]=n.useState(""),[D,E]=n.useState(!1),[O,y]=n.useState(!1),[N,k]=n.useState(!1),[K,$]=n.useState(""),[Y,re]=n.useState(!1),{toast:pe}=ua(),M=c?`wallet_total_pin_${c}`:"wallet_total_pin",W=()=>oo.has(M),le=ne=>{const Le=oo.get(M);if(!Le)return!1;try{return atob(Le)===ne}catch{return!1}},_e=ne=>{const Le=btoa(ne);oo.set(M,Le)},Se=async ne=>{ne.preventDefault(),$(""),re(!0);try{if(!C||C.length<4){$("يجب أن يكون الرقم السري 4 أرقام على الأقل"),re(!1);return}if(C!==b){$("الرقم السري الجديد وتأكيده غير متطابقين"),re(!1);return}if(W()){if(!w){$("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),re(!1);return}if(!le(w)){$("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),re(!1);return}}_e(C),pe({title:W()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:W()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),xe()}catch{$("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{re(!1)}},xe=()=>{S(""),s(""),F(""),$(""),E(!1),y(!1),k(!1),p(!1)};return e.jsx(ve,{open:i,onOpenChange:xe,children:e.jsxs(we,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Ie,{children:e.jsxs(Ne,{className:"flex items-center gap-2 text-right",children:[e.jsx(ra,{className:"h-5 w-5 text-blue-600"}),W()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:Se,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:W()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),W()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"currentPin",type:D?"text":"password",autoComplete:"off",value:w,onChange:ne=>S(ne.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>E(!D),children:D?e.jsx(Qs,{className:"h-4 w-4"}):e.jsx(Ns,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"newPin",type:O?"text":"password",autoComplete:"off",value:C,onChange:ne=>s(ne.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!O),children:O?e.jsx(Qs,{className:"h-4 w-4"}):e.jsx(Ns,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:N?"text":"password",autoComplete:"off",value:b,onChange:ne=>F(ne.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>k(!N),children:N?e.jsx(Qs,{className:"h-4 w-4"}):e.jsx(Ns,{className:"h-4 w-4"})})]})]}),K&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(wr,{className:"h-4 w-4"}),K]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:Y,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(wa,{className:"h-4 w-4 mr-2"}),Y?"جاري الحفظ...":W()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(x,{type:"button",variant:"outline",onClick:xe,disabled:Y,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function Wx({open:i,onOpenChange:p,onSuccess:c,title:w,description:S,currentBalance:C,balanceLabel:s,userId:b}){const[F,D]=n.useState(""),[E,O]=n.useState(""),[y,N]=n.useState("add"),[k,K]=n.useState(!1),[$,Y]=n.useState(""),[re,pe]=n.useState(!1),[M,W]=n.useState(!1);n.useEffect(()=>{let xe=!0;return(async()=>{const ne=await Ms.hasMasterPin(b);xe&&W(ne)})(),()=>{xe=!1}},[b,i]);const le=async xe=>{xe.preventDefault(),Y(""),pe(!0);try{const ne=parseFloat(E);if(isNaN(ne)||ne<=0){Y("يرجى إدخال مبلغ صحيح أكبر من صفر"),pe(!1);return}if(y==="subtract"&&ne>C){Y("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),pe(!1);return}if(M)if(await Ms.verifyMasterPin(F,b)){const H=y==="add"?ne:-ne;_e(),c(H)}else Y("الرقم السري غير صحيح");else Y("لم يتم تعيين الرقم السري الرئيسي. يرجى تعيينه من إعدادات البروفيل أولاً")}catch{Y("حدث خطأ أثناء التحقق من الرقم السري")}finally{pe(!1)}},_e=()=>{D(""),O(""),N("add"),Y(""),p(!1)},Se=()=>{const xe=parseFloat(E)||0;return y==="add"?C+xe:C-xe};return e.jsx(ve,{open:i,onOpenChange:_e,children:e.jsxs(we,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Ie,{children:e.jsxs(Ne,{className:"flex items-center gap-2 text-right",children:[y==="add"?e.jsx(Ut,{className:"h-5 w-5 text-green-600"}):e.jsx(er,{className:"h-5 w-5 text-red-600"}),w]})}),e.jsxs("form",{onSubmit:le,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:S}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(Z,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[C.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(x,{type:"button",variant:y==="add"?"default":"outline",onClick:()=>N("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(Ut,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(x,{type:"button",variant:y==="subtract"?"default":"outline",onClick:()=>N("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(er,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Z,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",y==="add"?"إضافته":"خصمه"]}),e.jsx(q,{id:"amount",type:"number",step:"0.01",min:"0.01",value:E,onChange:xe=>O(xe.target.value),placeholder:`أدخل المبلغ المراد ${y==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),E&&!isNaN(parseFloat(E))&&e.jsxs("div",{className:`p-3 rounded-lg ${y==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(Z,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${y==="add"?"text-green-700":"text-red-700"}`,children:[Se().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"pin",type:k?"text":"password",autoComplete:"off",value:F,onChange:xe=>D(xe.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>K(!k),children:k?e.jsx(Qs,{className:"h-4 w-4"}):e.jsx(Ns,{className:"h-4 w-4"})})]})]}),$&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(wr,{className:"h-4 w-4"}),$]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(x,{type:"button",variant:"outline",onClick:_e,className:"flex-1",children:"إلغاء"}),e.jsx(x,{type:"submit",disabled:re||!F||!E,className:`flex-1 ${y==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:re?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(wa,{className:"h-4 w-4 mr-2"}),y==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}const xd={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_APP_VERSION:"0.0.0",VITE_DEV_MODE:"true",VITE_ENABLE_OFFLINE_PERSISTENCE:"false",VITE_FIREBASE_API_KEY:["AI","za","SyA33RTf43u2QE2OsK1RepQHSKrSet9ZI0s"].join(""),VITE_FIREBASE_APP_ID:"1:483702062341:web:b1ff06ad175cb7ae428b6c",VITE_FIREBASE_AUTH_DOMAIN:"voda-c6abd.firebaseapp.com",VITE_FIREBASE_AUTH_EMULATOR_URL:"http://localhost:9099",VITE_FIREBASE_FIRESTORE_EMULATOR_HOST:"localhost:8080",VITE_FIREBASE_FUNCTIONS_EMULATOR_HOST:"localhost:5001",VITE_FIREBASE_MEASUREMENT_ID:"G-CV6QGH7G7P",VITE_FIREBASE_MESSAGING_SENDER_ID:"483702062341",VITE_FIREBASE_PROJECT_ID:"voda-c6abd",VITE_FIREBASE_STORAGE_BUCKET:"voda-c6abd.appspot.com",VITE_FORCE_HASH_ROUTER:"true",VITE_SHOP_ID:"demo-shop-001",VITE_SHOP_NAME:"محل كاشي لينك التجريبي",VITE_SHOW_ENV_BANNER:"true",VITE_USE_EMULATORS:"false",VITE_USE_FIREBASE_EMULATOR:"false"},Za=i=>typeof i=="string"&&i.trim().length>0,Fx={getCurrentMonthId(){const i=new Date;return`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}`},async getWalletUsage(i){var p;try{if(!Za(i))return console.error("Error getting wallet usage: invalid walletId",i),null;const c=Oe(U,"walletLimits",i),w=await Ls(c);if(w.exists()){const C=w.data();return{walletId:i,used_transfer:C.monthlyTransferUsed??C.used_transfer??0,used_withdraw:C.monthlyWithdrawUsed??C.used_withdraw??0,monthly_limit:C.monthlyLimit??C.monthlyTransferLimit??C.monthlyWithdrawLimit??2e5,last_reset:C.lastMonthlyReset??C.last_reset??null,updatedAt:C.updatedAt||yr.now()}}const S={walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:yr.now()};return await As(c,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,monthlyTransferLimit:2e5,monthlyWithdrawLimit:2e5,lastMonthlyReset:null,updatedAt:dt(),ownerId:(p=Vr.currentUser)==null?void 0:p.uid}),S}catch(c){return console.error("Error getting wallet usage:",c),{walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:yr.now()}}},shouldResetLimits(i){const p=new Date,c=p.getDate();if(!i)return c===1;if(c===1){const w=i.toDate(),S=p.getMonth(),C=p.getFullYear();return w.getMonth()!==S||w.getFullYear()!==C}return!1},async autoResetLimitsIfNeeded(i){try{if(!Za(i))return console.error("خطأ في التصفير التلقائي للحدود: walletId غير صالح",i),!1;typeof import.meta<"u";const p=await this.getWalletUsage(i);return p&&this.shouldResetLimits(p.last_reset)?(console.log(`🔄 تصفير تلقائي للحدود للمحفظة ${i} - اليوم الأول من الشهر`),await this.resetWalletUsage(i)):!1}catch(p){return console.error("خطأ في التصفير التلقائي للحدود:",p),!1}},async resetWalletUsage(i){try{if(!Za(i))return console.error("خطأ في تصفير استخدام المحفظة: walletId غير صالح",i),!1;const p=Oe(U,"walletLimits",i);return await As(p,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:dt(),updatedAt:dt()},{merge:!0}),console.log(`🔄 تم تصفير استخدام المحفظة ${i} بنجاح`),!0}catch(p){return console.error("خطأ في تصفير استخدام المحفظة:",p),!1}},async calculateUsageFromTransactions(i){var p,c;try{if(!Za(i))return console.error("خطأ في حساب الاستخدام من المعاملات: walletId غير صالح",i),{used_transfer:0,used_withdraw:0};const w=Oe(U,"walletLimits",i),S=new Date;let C=yr.fromDate(new Date(S.getFullYear(),S.getMonth(),1));try{const E=await Ls(w);C=E.exists()?((p=E.data())==null?void 0:p.lastMonthlyReset)??((c=E.data())==null?void 0:c.last_reset)??C:C}catch{}const s=Je(je(U,"tx"),de("uid","==",i),...C?[de("createdAt",">=",C)]:[]),b=await Re(s);let F=0,D=0;return b.forEach(E=>{const O=E.data();O.status==="completed"&&(O.type==="transfer"?F+=O.amount:O.type==="withdraw"&&(D+=O.amount))}),{used_transfer:F,used_withdraw:D}}catch(w){return console.error("خطأ في حساب الاستخدام من المعاملات:",w),{used_transfer:0,used_withdraw:0}}},async getWalletUsageWithRefresh(i){var p,c;try{if(!Za(i))return console.error("خطأ في الحصول على الاستخدام مع التحديث: walletId غير صالح",i),null;typeof import.meta<"u";const w=await this.getWalletUsage(i);if(!w){const C=await this.calculateUsageFromTransactions(i),s=Oe(U,"walletLimits",i);try{await As(s,{monthlyTransferUsed:C.used_transfer,monthlyWithdrawUsed:C.used_withdraw,updatedAt:dt(),ownerId:(p=Vr.currentUser)==null?void 0:p.uid},{merge:!0})}catch{}return{walletId:i,used_transfer:C.used_transfer,used_withdraw:C.used_withdraw,monthly_limit:2e5,last_reset:null,updatedAt:yr.now()}}const S=await this.calculateUsageFromTransactions(i);if(w.used_transfer!==S.used_transfer||w.used_withdraw!==S.used_withdraw){const C=Oe(U,"walletLimits",i);try{await As(C,{monthlyTransferUsed:S.used_transfer,monthlyWithdrawUsed:S.used_withdraw,updatedAt:dt(),ownerId:(c=Vr.currentUser)==null?void 0:c.uid},{merge:!0})}catch{}return await this.getWalletUsage(i)}return w}catch(w){return console.error("خطأ في الحصول على الاستخدام مع التحديث:",w),{walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:yr.now()}}},calculateRemaining(i){return{remainingTransfer:Math.max(0,i.monthly_limit-i.used_transfer),remainingWithdraw:Math.max(0,i.monthly_limit-i.used_withdraw)}},async canPerformOperation(i,p,c){try{if(!Za(i))return console.error("Error checking operation limits: invalid walletId",i),{canPerform:!1,message:"walletId غير صالح"};const w=await this.getWalletUsageWithRefresh(i);if(!w)return{canPerform:!1,message:"لا يمكن العثور على بيانات الاستخدام للمحفظة"};const S=this.calculateRemaining(w);return c==="transfer"&&p>S.remainingTransfer?{canPerform:!1,message:`تجاوز حد التحويل المسموح. المتبقي: ${S.remainingTransfer.toLocaleString()} ج.م من أصل ${w.monthly_limit.toLocaleString()} ج.م`,remaining:S.remainingTransfer}:c==="withdraw"&&p>S.remainingWithdraw?{canPerform:!1,message:`تجاوز حد السحب المسموح. المتبقي: ${S.remainingWithdraw.toLocaleString()} ج.م من أصل ${w.monthly_limit.toLocaleString()} ج.م`,remaining:S.remainingWithdraw}:{canPerform:!0}}catch(w){return console.error("Error checking operation limits:",w),{canPerform:!1,message:"خطأ في التحقق من الحدود"}}},async updateUsage(i,p,c){var w;try{if(!Za(i))throw new Error("walletId غير صالح");const S=await this.getWalletUsageWithRefresh(i);if(!S)throw new Error("لا يمكن العثور على بيانات الاستخدام للمحفظة");const C=await this.canPerformOperation(i,p,c);if(!C.canPerform)throw new Error(C.message||"لا يمكن إجراء العملية");const s=c==="transfer"?S.used_transfer+p:S.used_transfer,b=c==="withdraw"?S.used_withdraw+p:S.used_withdraw,F=Oe(U,"walletLimits",S.walletId);try{await As(F,{monthlyTransferUsed:s,monthlyWithdrawUsed:b,updatedAt:dt(),ownerId:(w=Vr.currentUser)==null?void 0:w.uid},{merge:!0})}catch{}let D=await this.getWalletUsageWithRefresh(i);return D||(D={walletId:i,used_transfer:s,used_withdraw:b,monthly_limit:S.monthly_limit,last_reset:S.last_reset,updatedAt:yr.now()}),D}catch(S){throw console.error("Error updating wallet usage:",S),S}},async resetWalletUsageManually(i){try{if(!Za(i))throw new Error("walletId غير صالح");const p=Oe(U,"walletLimits",i),c={walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:0,last_reset:null,updatedAt:new Date};return As(p,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:dt(),updatedAt:dt()},{merge:!0}).catch(w=>{console.error("خطأ في حفظ تصفير الاستخدام في Firebase:",w)}),console.log(`✅ تم تصفير استخدام المحفظة ${i} بنجاح`),c}catch(p){throw console.error("Error resetting wallet usage:",p),p}},async getAllWalletsUsage(i){try{const c=(await ya.getByMerchantId(i)).map(S=>this.getWalletUsageWithRefresh(S.id));return(await Promise.all(c)).filter(S=>S!==null)}catch(p){return console.error("Error getting all wallets usage:",p),[]}}};function Rx(i){return i?`readBroadcastIds_${i}`:"readBroadcastIds_guest"}function Bx({className:i}){const{user:p,profile:c,isSubscriptionActive:w}=Pa(),S=wd(),[C,s]=n.useState([]),[b,F]=n.useState(new Set),[D,E]=n.useState(null),[O,y]=n.useState(!1),N=n.useRef(new Set);n.useRef(!1);const k=n.useRef(!0),K=n.useRef(null),$=n.useRef(null),Y=n.useRef(null),[re,pe]=n.useState({position:"fixed",top:0,left:0,zIndex:1e4}),M=n.useMemo(()=>{const H=["global"];return p!=null&&p.uid&&H.push(`user:${p.uid}`),c!=null&&c.shopId&&H.push(`shop:${c.shopId}`),H},[p==null?void 0:p.uid,c==null?void 0:c.shopId]),W=Rx(p==null?void 0:p.uid),le=n.useMemo(()=>{var ae;const H=(ae=S==null?void 0:S.pathname)==null?void 0:ae.includes("/user/pending-approval");return!!(p!=null&&p.uid)&&!H},[p==null?void 0:p.uid,S==null?void 0:S.pathname]);n.useEffect(()=>{try{const H=localStorage.getItem(W);if(H){const te=JSON.parse(H);Array.isArray(te)&&F(new Set(te.filter(Boolean)))}else F(new Set)}catch(H){console.warn("Failed to load read ids",H),F(new Set)}},[W]),n.useEffect(()=>{if(!le){s([]);return}k.current=!0;const H=()=>{sx(M,ae=>{if(k.current){const Be=Date.now(),Ge=60*1e3,Q=ae.filter(oe=>{var bt,$t;const ze=(bt=oe.createdAt)!=null&&bt.toMillis?oe.createdAt.toMillis():($t=oe.createdAt)!=null&&$t.seconds?oe.createdAt.seconds*1e3:0;return!(Be-ze<Ge)}).map(oe=>oe.id).filter(Boolean);N.current=new Set(Q),k.current=!1}s(ae)})};H();const te=ae=>{console.log("🔔 OneSignal Notification received",ae);try{const Be=ae.notification||ae;if(Be&&(Be.title||Be.body)){const Ge={id:`temp_${Date.now()}`,title:Be.title||"إشعار جديد",message:Be.body||Be.message||"",audienceKey:"global",active:!0,createdAt:{toMillis:()=>Date.now(),seconds:Math.floor(Date.now()/1e3),nanoseconds:0}};E(Ge),y(!0),K.current&&clearTimeout(K.current),K.current=window.setTimeout(()=>{y(!1),E(null)},5e3)}}catch(Be){console.error("Error parsing OneSignal event for instant alert",Be)}H()};try{const ae=window.OneSignal;ae&&ae.Notifications&&ae.Notifications.addEventListener&&ae.Notifications.addEventListener("foregroundWillDisplay",te)}catch(ae){console.error("Failed to add OneSignal listener",ae)}return()=>{try{const ae=window.OneSignal;ae&&ae.Notifications&&ae.Notifications.removeEventListener&&ae.Notifications.removeEventListener("foregroundWillDisplay",te)}catch{}}},[M,le]),n.useEffect(()=>{const H=new Set(C.map(ae=>ae.id).filter(Boolean)),te=C.filter(ae=>ae.id&&!N.current.has(ae.id));te.length>0&&(E(te[0]),y(!0),K.current&&clearTimeout(K.current),K.current=window.setTimeout(()=>{y(!1),E(null)},5e3)),N.current=H},[C]),n.useEffect(()=>()=>{K.current&&clearTimeout(K.current)},[]);const _e=C.reduce((H,te)=>H+(te.id&&!b.has(te.id)?1:0),0),Se=H=>{if(!H||b.has(H))return;const te=new Set(b);te.add(H),F(te);try{localStorage.setItem(W,JSON.stringify(Array.from(te)))}catch{}},xe=()=>{const H=C.map(ae=>ae.id).filter(Boolean),te=new Set(b);H.forEach(ae=>te.add(ae)),F(te);try{localStorage.setItem(W,JSON.stringify(Array.from(te)))}catch{}},ne=(H,te)=>{var ae;if(H)try{const Be=((ae=Pi)==null?void 0:ae.isNativePlatform)&&Pi.getPlatform()==="android",Ge=/\.apk(\?|$)/i.test(H);if(Be&&Ge){const Q=`cashy://update?url=${encodeURIComponent(H)}`;window.location.href=Q}else window.open(H,"_blank")}catch{try{window.open(H,"_blank")}catch{}}te&&Se(te)},Le=()=>{if(!$.current||!Y.current)return;const H=$.current.getBoundingClientRect(),te=8,ae=Y.current.offsetWidth||320,Be=H.bottom+te;let Ge=H.right-ae;const Q=window.innerWidth;Ge=Math.min(Math.max(Ge,te),Q-ae-te),pe(oe=>({...oe,top:Be,left:Ge}))};return n.useEffect(()=>{if(!O)return;Le();const H=()=>Le();return window.addEventListener("resize",H),window.addEventListener("scroll",H,!0),()=>{window.removeEventListener("resize",H),window.removeEventListener("scroll",H,!0)}},[O]),n.useEffect(()=>{if(!(p!=null&&p.uid)){setQueueLatestStatus("none");return}(async()=>{try{const te=query(collection(db,"waiting_list"),where("userId","==",p.uid)),Be=(await getDocs(te)).docs.map(oe=>({id:oe.id,...oe.data()})).sort((oe,ze)=>{var $t,Ht,ts,Wt,qe,rt;const yt=((Ht=($t=oe==null?void 0:oe.createdAt)==null?void 0:$t.toMillis)==null?void 0:Ht.call($t))??((ts=oe==null?void 0:oe.createdAt)==null?void 0:ts.seconds)*1e3??0;return(((qe=(Wt=ze==null?void 0:ze.createdAt)==null?void 0:Wt.toMillis)==null?void 0:qe.call(Wt))??((rt=ze==null?void 0:ze.createdAt)==null?void 0:rt.seconds)*1e3??0)-yt});if(Be.length===0){setQueueLatestStatus("none");return}const Ge=Be[0],Q=(Ge==null?void 0:Ge.contacted)===!0||(Ge==null?void 0:Ge.status)==="contacted";setQueueLatestStatus(Q?"contacted":"pending")}catch(te){console.warn("⚠️ فشل جلب حالة waiting_list:",te),setQueueLatestStatus("none")}})()},[p==null?void 0:p.uid]),le?e.jsxs("div",{className:`relative inline-flex items-center gap-2 ${i||""}`,ref:$,children:[e.jsxs(ax,{onOpenChange:H=>{H&&_e>0&&xe()},children:[e.jsx(rx,{asChild:!0,children:e.jsx(x,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:e.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[e.jsx(ao,{className:"h-4 w-4 text-primary"}),_e>0&&e.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:_e})]})})}),e.jsxs(nx,{className:"w-80",align:"end",forceMount:!0,children:[e.jsxs(ix,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"الإشعارات"}),C.length>0&&e.jsxs(x,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:xe,children:[e.jsx(Yr,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),e.jsx(lx,{}),C.length===0?e.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):e.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:C.map(H=>{const te=H.id?!b.has(H.id):!1;return e.jsx("div",{className:`px-2 py-2 rounded-md ${te?"bg-primary/5":""}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(ao,{className:`h-4 w-4 ${te?"text-primary":"text-muted-foreground"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium",children:H.title||"إشعار"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:H.message}),H.linkUrl&&e.jsxs(x,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>ne(H.linkUrl,H.id),children:["فتح الرابط ",e.jsx(tx,{className:"h-3 w-3 ml-1"})]})]}),te?e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Se(H.id),title:"تمييز كمقروء",children:e.jsx(Yr,{className:"h-4 w-4 text-primary"})}):e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:e.jsx(Yr,{className:"h-4 w-4 text-muted-foreground"})})]})},H.id)})})]})]}),D&&uu.createPortal(e.jsx("div",{ref:Y,style:re,className:`pointer-events-auto transition-all duration-300 ${O?"opacity-100 translate-y-0":"opacity-0 -translate-y-3"}`,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl border border-gray-200 p-4 w-80 max-w-[calc(100vw-16px)] flex items-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(ao,{className:"w-4 h-4 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-semibold",children:D.title||"إشعار جديد"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:D.message}),D.linkUrl&&e.jsx(x,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>ne(D.linkUrl,D.id),children:"فتح الرابط"})]})]})}),document.body)]}):null}function Ux({isOpen:i,onClose:p}){const[c,w]=n.useState("0"),[S,C]=n.useState(null),[s,b]=n.useState(null),[F,D]=n.useState(!1),E=M=>{F?(w(M),D(!1)):w(c==="0"?M:c+M)},O=M=>{const W=parseFloat(c);if(S===null)C(W);else if(s){const _e=y(S||0,W,s);w(String(_e)),C(_e)}D(!0),b(M)},y=(M,W,le)=>{switch(le){case"+":return M+W;case"-":return M-W;case"×":return M*W;case"÷":return W===0?0:M/W;case"=":return W;default:return W}},N=()=>{const M=parseFloat(c);if(S!==null&&s){const W=y(S,M,s);w(String(W)),C(null),b(null),D(!0)}},k=()=>{w("0"),C(null),b(null),D(!1)},K=()=>{w("0")},$=()=>{F?(w("0."),D(!1)):c.indexOf(".")===-1&&w(c+".")},Y=()=>{c!=="0"&&w(c.charAt(0)==="-"?c.slice(1):"-"+c)},re=()=>{const M=parseFloat(c);w(String(M/100))},pe=M=>{const W=M.key;M.preventDefault(),W>="0"&&W<="9"?E(W):W==="+"?O("+"):W==="-"?O("-"):W==="*"?O("×"):W==="/"?O("÷"):W==="Enter"||W==="="?N():W==="Escape"||W==="c"||W==="C"?k():W==="Backspace"?K():W==="."?$():W==="%"&&re()};return n.useEffect(()=>(i?document.addEventListener("keydown",pe):document.removeEventListener("keydown",pe),()=>{document.removeEventListener("keydown",pe)}),[i,c,S,s,F]),e.jsx(ve,{open:i,onOpenChange:M=>!M&&p(),children:e.jsxs(we,{className:"sm:max-w-md",children:[e.jsx(Ie,{children:e.jsxs(Ne,{className:"flex items-center gap-2 text-right",children:[e.jsx(Pd,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:c})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:k,children:"AC"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:K,children:"CE"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:re,children:"%"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>O("÷"),children:"÷"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>E("7"),children:"7"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>E("8"),children:"8"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>E("9"),children:"9"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>O("×"),children:"×"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>E("4"),children:"4"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>E("5"),children:"5"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>E("6"),children:"6"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>O("-"),children:"-"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>E("1"),children:"1"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>E("2"),children:"2"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>E("3"),children:"3"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>O("+"),children:"+"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>E("0"),children:"0"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:$,children:"."}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:N,children:"="})]}),e.jsx(x,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:Y,children:"+/-"})]})]})})}const Ai=n.forwardRef(({className:i,...p},c)=>e.jsx("div",{className:"relative w-full overflow-auto",children:e.jsx("table",{ref:c,className:ws("w-full caption-bottom text-sm",i),...p})}));Ai.displayName="Table";const Ti=n.forwardRef(({className:i,...p},c)=>e.jsx("thead",{ref:c,className:ws("[&_tr]:border-b",i),...p}));Ti.displayName="TableHeader";const ki=n.forwardRef(({className:i,...p},c)=>e.jsx("tbody",{ref:c,className:ws("[&_tr:last-child]:border-0",i),...p}));ki.displayName="TableBody";const qx=n.forwardRef(({className:i,...p},c)=>e.jsx("tfoot",{ref:c,className:ws("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",i),...p}));qx.displayName="TableFooter";const br=n.forwardRef(({className:i,...p},c)=>e.jsx("tr",{ref:c,className:ws("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",i),...p}));br.displayName="TableRow";const Jt=n.forwardRef(({className:i,...p},c)=>e.jsx("th",{ref:c,className:ws("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",i),...p}));Jt.displayName="TableHead";const Kt=n.forwardRef(({className:i,...p},c)=>e.jsx("td",{ref:c,className:ws("p-4 align-middle [&:has([role=checkbox])]:pr-0",i),...p}));Kt.displayName="TableCell";const zx=n.forwardRef(({className:i,...p},c)=>e.jsx("caption",{ref:c,className:ws("mt-4 text-sm text-muted-foreground",i),...p}));zx.displayName="TableCaption";function Vx({isOpen:i,onClose:p,initialBarcode:c}){const[w,S]=n.useState([]),[C,s]=n.useState({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),[b,F]=n.useState(!1),[D,E]=n.useState(null),{toast:O}=ua(),{user:y,profile:N}=Pa(),{isShiftActive:k,shiftUser:K}=$n(),{shopId:$}=Li(),[Y,re]=n.useState([]),[pe,M]=n.useState({}),[W,le]=n.useState({}),[_e,Se]=n.useState({}),[xe,ne]=n.useState(""),[Le,H]=n.useState(!1),[te,ae]=n.useState({}),[Be,Ge]=n.useState(!1),[Q,oe]=n.useState(!0),[ze,yt]=n.useState(!1),bt=Ke.useRef(""),$t=Ke.useRef(0),[Ht,ts]=n.useState(0),[Wt,qe]=n.useState(0),[rt,lt]=n.useState(!1),[$e,Qe]=n.useState(!1),[ee,_t]=n.useState(!0),[ss,as]=n.useState(!1),[B,De]=n.useState(!1),[Fe,jt]=n.useState(!0),[gt,Tt]=n.useState(!0),[xs,vt]=n.useState({}),[it,Et]=n.useState(!1),[us,kt]=n.useState("التحقق قبل العملية"),[$s,Gs]=n.useState("أدخل الرقم السري الرئيسي للمتابعة"),Na=Ke.useRef(null),Ts=(d,P,L)=>{kt(d),Gs(P),Na.current=L,Et(!0)},[qa,Zs]=n.useState([]),[Vs,T]=n.useState(!1),[ie,Ee]=n.useState(""),[He,Me]=n.useState(""),[nt,G]=n.useState(""),[ot,mt]=n.useState(null);n.useEffect(()=>{(async()=>{try{if(!i||!(y!=null&&y.uid))return;const d=await Ae.getUserData(y.uid),P=Array.isArray(d==null?void 0:d.customers)?d.customers.map(L=>({id:String(L.id||""),name:String(L.name||""),mobile:L.mobile||void 0})):[];Zs(P)}catch{}})()},[i,y==null?void 0:y.uid]);const[ps,rs]=n.useState(!1),[ns,V]=n.useState(null),[is,na]=n.useState(null),ja=(d,P)=>{V(d),na(P),rs(!0)},[xa,_a]=n.useState(""),pa=n.useMemo(()=>{const d=xa.trim().toLowerCase();return d?Y.filter(P=>P.name.toLowerCase().includes(d)):Y},[Y,xa]),[z,Te]=n.useState(!1),[ht,St]=n.useState(null),[ls,Ft]=n.useState("1"),os=d=>{St(d),Ft("1"),Te(!0)},ia=()=>{if(!ht)return;const d=parseInt(ls);d>0&&(Te(!1),Ts("إضافة مخزون",`إضافة ${d} قطع للمنتج ${ht.name}`,async()=>{try{const P=ht.quantity+d;await Yt(Oe(U,"products",ht.id),{quantity:P,updatedAt:dt()}),re(L=>L.map(se=>se.id===ht.id?{...se,quantity:P}:se)),O({title:"تمت الإضافة",description:`تمت إضافة ${d} قطعة`})}catch(P){console.error(P)}}))};n.useEffect(()=>{i&&(y!=null&&y.uid)&&(Ze(),ee||za())},[i,y==null?void 0:y.uid,ee]),n.useEffect(()=>{if(!i)return;const d=P=>{var Ce;const L=P.target,se=(Ce=L==null?void 0:L.tagName)==null?void 0:Ce.toLowerCase();if(se==="input"||se==="textarea"||!!(L&&L.isContentEditable)||it||$e||ze)return;const ce=Date.now();if(P.key==="Enter"){const ke=(bt.current||"").trim();bt.current="",ke&&Fn(ke);return}P.key.length===1&&(ce-($t.current||0)>100&&(bt.current=""),bt.current+=P.key,$t.current=ce)};return window.addEventListener("keydown",d),()=>window.removeEventListener("keydown",d)},[i,Y,it,$e,ze]),n.useEffect(()=>{i&&c&&Fn(c)},[i,c]);const Nr=async()=>{if(!(y!=null&&y.uid))return;const d=(N==null?void 0:N.shopId)||$||"main",P=`shopProducts_${y.uid}_${d}`;try{const L=localStorage.getItem(P);if(L){const se=JSON.parse(L);Array.isArray(se)&&se.length>0&&re(se)}}catch(L){console.warn("Failed to load products from cache",L)}try{let L,se=[];if(N!=null&&N.shopId){const ge=Je(je(U,"products"),de("shopId","==",N.shopId),de("userId","==",y.uid));if(L=await Re(ge),se=L.docs.map(ce=>({id:ce.id,name:String(ce.data().name??""),sellingPrice:Number(ce.data().sellingPrice??0),wholesalePrice:Number(ce.data().wholesalePrice??0),quantity:Number(ce.data().quantity??0),barcode:String(ce.data().barcode??""),serialNumber:String(ce.data().serialNumber??"")})),se.length===0){const ce=Je(je(U,"products"),de("userId","==",y.uid)),ke=(await Re(ce)).docs.map(fe=>({id:fe.id,name:String(fe.data().name??""),sellingPrice:Number(fe.data().sellingPrice??0),wholesalePrice:Number(fe.data().wholesalePrice??0),quantity:Number(fe.data().quantity??0),barcode:String(fe.data().barcode??""),serialNumber:String(fe.data().serialNumber??"")}));ke.length>0&&(se=ke,O({title:"تم استرجاع المنتجات",description:"عثرنا على منتجات محفوظة لك خارج المتجر الحالي وقمنا بعرضها."}))}}else{const ge=Je(je(U,"products"),de("userId","==",y.uid));L=await Re(ge),se=L.docs.map(ce=>({id:ce.id,name:String(ce.data().name??""),sellingPrice:Number(ce.data().sellingPrice??0),wholesalePrice:Number(ce.data().wholesalePrice??0),quantity:Number(ce.data().quantity??0),barcode:String(ce.data().barcode??""),serialNumber:String(ce.data().serialNumber??"")}))}re(se);try{localStorage.setItem(P,JSON.stringify(se))}catch{}if(N!=null&&N.shopId&&se.length>0){const ge=se.filter(ce=>{const Ce=((L==null?void 0:L.docs)||[]).find(fe=>fe.id===ce.id);return!(!!Ce&&!!Ce.data().shopId)});if(ge.length>0)try{await Promise.all(ge.map(ce=>Yt(Oe(U,"products",ce.id),{shopId:N.shopId,updatedAt:dt()}))),O({title:"تم ترتيب المنتجات",description:"تم ربط بعض المنتجات غير المربوطة بمتجرك الحالي تلقائياً."})}catch(ce){console.warn("تعذّر ترحيل shopId لبعض المنتجات:",ce)}}}catch(L){console.error("Error loading shop products:",L)}};n.useEffect(()=>{i&&(y!=null&&y.uid)&&(Nr(),za(),Ze(),Wn())},[i,y==null?void 0:y.uid,N==null?void 0:N.shopId]);const la=()=>{const d=new Date,P=d.getFullYear(),L=String(d.getMonth()+1).padStart(2,"0"),se=String(d.getDate()).padStart(2,"0");return`${P}-${L}-${se}`},Sa=d=>{const P=L=>{if(typeof L.createdAtMs=="number")return L.createdAtMs;const se=parseInt(L.id,10);if(!isNaN(se))return se;const ge=new Date(L.date);return isNaN(ge.getTime())?0:ge.getTime()};return[...d].sort((L,se)=>P(se)-P(L))},Ze=()=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot load sales data");return}const d=$||(N==null?void 0:N.shopId)||"main",P=`salesData_all_${y.uid}_${d}`,L=localStorage.getItem(P);if(L)try{const We=JSON.parse(L);S(Array.isArray(We)?Sa(We):[]);return}catch{}const se=la(),ge=`salesData_${y.uid}_${d}_${se}`,ce=localStorage.getItem(ge);if(ce){const We=JSON.parse(ce),ue=Array.isArray(We)?Sa(We):[];S(ue);try{localStorage.setItem(P,JSON.stringify(ue))}catch{}return}const Ce=new Date().toISOString().split("T")[0],ke=`salesData_${y.uid}_${d}_${Ce}`,fe=localStorage.getItem(ke);if(fe){const We=JSON.parse(fe),ue=Array.isArray(We)?Sa(We):[];S(ue);try{localStorage.setItem(ge,JSON.stringify(ue)),localStorage.setItem(P,JSON.stringify(ue))}catch{}return}Qr()},Dt=d=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot save sales data");return}const P=$||(N==null?void 0:N.shopId)||"main",L=la(),se=`salesData_${y.uid}_${P}_${L}`,ge=`salesData_all_${y.uid}_${P}`,ce=Sa(d);localStorage.setItem(se,JSON.stringify(ce));try{const Ce=localStorage.getItem(ge),ke=Ce?JSON.parse(Ce):[],fe={};[...Array.isArray(ke)?ke:[],...ce].forEach(Ct=>{fe[Ct.id]=Ct});const We=Object.values(fe),ue=Sa(We);localStorage.setItem(ge,JSON.stringify(ue))}catch{}S(ce)},oa=d=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot save sales data");return}const P=$||(N==null?void 0:N.shopId)||"main",L=`salesData_all_${y.uid}_${P}`;try{const ge=localStorage.getItem(L),ce=ge?JSON.parse(ge):[],Ce={};[...Array.isArray(ce)?ce:[],...d].forEach(We=>{Ce[We.id]=We});const ke=Object.values(Ce),fe=Sa(ke);localStorage.setItem(L,JSON.stringify(fe))}catch{}const se=Sa(d);S(se)},Qr=async()=>{if(y!=null&&y.uid)try{const d=$||(N==null?void 0:N.shopId)||null,P=new Date().toISOString().split("T")[0],L=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date);let se,ge;try{const We=Je(je(U,"dailySales"),de("userId","==",y.uid),...d?[de("shopId","==",d)]:[]);se=await Re(We)}catch{}try{const We=Je(je(U,"users",y.uid,"dailySales"),...d?[de("shopId","==",d)]:[]);ge=await Re(We)}catch{}const Ce=[...se?se.docs:[],...ge?ge.docs:[]].map(We=>{var Ct,gs;const ue=We.data();return{id:String(ue.clientId||We.id),firestoreId:We.id,productName:String(ue.productName||""),price:Number(ue.sellingPrice||0),wholesalePrice:ue.wholesalePrice!==void 0?Number(ue.wholesalePrice):null,quantity:Number(ue.quantity||0),date:String(ue.date||P),time:String(ue.time||""),serialNumber:ue.serialNumber||void 0,barcode:ue.barcode||void 0,performedByType:ue.performedByType||void 0,performedByName:ue.performedByName||void 0,performedByUsername:ue.performedByUsername||void 0,isDeferred:!!ue.isDeferred,customerName:ue.customerName||void 0,customerMobile:ue.customerMobile||void 0,customerId:ue.customerId||void 0,createdAtMs:(gs=(Ct=ue==null?void 0:ue.createdAt)==null?void 0:Ct.toDate)!=null&&gs.call(Ct)?ue.createdAt.toDate().getTime():new Date(String(ue.date||P)).getTime()}}),ke={};[...w,...Ce].forEach(We=>{ke[We.id]=We});const fe=Object.values(ke);oa(fe)}catch{}},za=async()=>{if(y!=null&&y.uid)try{const d=new Date,P=new Date(d.getFullYear(),d.getMonth(),1),L=new Date(d.getFullYear(),d.getMonth()+1,0),se=ue=>ue.toISOString().split("T")[0],ge=se(P),ce=se(L),Ce=$||(N==null?void 0:N.shopId)||null;let ke;try{const ue=Je(je(U,"dailySales"),de("userId","==",y.uid),...Ce?[de("shopId","==",Ce)]:[]);ke=await Re(ue)}catch{const ue=Je(je(U,"users",y.uid,"dailySales"),...Ce?[de("shopId","==",Ce)]:[]);ke=await Re(ue)}let fe=0,We=0;ke.forEach(ue=>{const Ct=ue.data(),gs=String(Ct.date??"").slice(0,10);if(!Ct.isDeferred&&gs>=ge&&gs<=ce){const Xs=Number(Ct.sellingPrice??0),ca=Number(Ct.quantity??0),Ar=Number(Ct.profit??(Number(Ct.sellingPrice??0)-Number(Ct.wholesalePrice??0))*ca);fe+=Xs*ca,We+=Ar}}),ts(fe),qe(We)}catch(d){console.error("Error loading monthly stats:",d)}},jr=async d=>{if(!(y!=null&&y.uid))return null;try{const P=((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0),L=k&&K?"cashier":"admin",se=L==="cashier"?(K==null?void 0:K.name)||"كاشير":(N==null?void 0:N.fullName)||(y==null?void 0:y.displayName)||"الحساب الرئيسي",ge=L==="cashier"&&(K==null?void 0:K.username)||null,ce=await Ta(je(U,"dailySales"),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit:P,date:d.date,time:d.time,performedByType:L,performedByName:se,performedByUsername:ge,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:$?{shopId:$}:{},createdAt:dt()});try{await As(Oe(U,"users",y.uid,"dailySales",ce.id),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit:P,date:d.date,time:d.time,performedByType:L,performedByName:se,performedByUsername:ge,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:$?{shopId:$}:{},createdAt:dt()})}catch{}return ce.id}catch{try{const P=await Ta(je(U,"users",y.uid,"dailySales"),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit,date:d.date,time:d.time,performedByType,performedByName,performedByUsername,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:$?{shopId:$}:{},createdAt:dt()});try{await As(Oe(U,"dailySales",P.id),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit,date:d.date,time:d.time,performedByType,performedByName,performedByUsername,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:$?{shopId:$}:{},createdAt:dt()})}catch{}return P.id}catch(P){return console.error("Error saving sale:",P),null}}},Gr=()=>{const d=$||(N==null?void 0:N.shopId)||"main";return`cashBalance_${(y==null?void 0:y.uid)||"default"}_${d}`},Sr=async(d,P)=>{if(y!=null&&y.uid)try{const L=Oe(U,"dailySales",d);await Yt(L,P)}catch{try{const L=Oe(U,"users",y.uid,"dailySales",d);await Yt(L,P)}catch(L){console.error("Error updating sale:",L)}}},Dr=async d=>{try{const P=d.firestoreId;if(P)await Sr(P,{isDeferred:!1});else try{const L=Je(je(U,"dailySales"),de("userId","==",(y==null?void 0:y.uid)||""),de("date","==",d.date),de("productName","==",d.productName),zr(5)),ge=(await Re(L)).docs[0];ge&&await Yt(ge.ref,{isDeferred:!1})}catch{}S(L=>L.map(se=>se.id===d.id?{...se,isDeferred:!1}:se));try{await za()}catch{}O({title:"تم التسديد",description:`تم تسديد أجل ${d.productName}`})}catch(P){console.error("Error marking deferred sale as paid:",P),O({title:"فشل التسديد",description:"تعذّر تحديث حالة البيع المؤجّل",variant:"destructive"})}},Wn=async()=>{if(!(y!=null&&y.uid))return;const d=w.filter(P=>!P.firestoreId);if(d.length!==0)for(const P of d)try{let L;try{const ge=Je(je(U,"dailySales"),de("userId","==",y.uid),de("clientId","==",P.id),zr(1));L=await Re(ge)}catch{const ge=Je(je(U,"users",y.uid,"dailySales"),de("clientId","==",P.id),zr(1));L=await Re(ge)}if(!L.empty){const ge=L.docs[0].id,ce=w.map(Ce=>Ce.id===P.id?{...Ce,firestoreId:ge}:Ce);Dt(ce);continue}const se=await jr(P);if(se){const ge=w.map(ce=>ce.id===P.id?{...ce,firestoreId:se}:ce);Dt(ge)}}catch{}},Cr=async d=>{try{if(y!=null&&y.uid)try{const fe=je(U,"deficiencies"),We=await Ta(fe,{shopId:(N==null?void 0:N.shopId)||y.uid||"default-shop",name:d,quantity:1,status:"pending",createdAt:dt()});try{const ue=`deficiencies_${(N==null?void 0:N.shopId)||(y==null?void 0:y.uid)||"default-shop"}`,Ct=localStorage.getItem(ue),gs=Ct?JSON.parse(Ct):[],Xs=Array.isArray(gs)?gs:[],ca=Xs.some(It=>String((It==null?void 0:It.id)||"")===We.id),Ar={id:We.id,name:d,quantity:1,status:"pending",createdAt:new Date().toISOString()},Ja=ca?Xs:[...Xs,Ar];localStorage.setItem(ue,JSON.stringify(Ja))}catch{}O({title:"تمت الإضافة للنواقص",description:`المنتج ${d} نفد من المخزون وتمت إضافته للنواقص`});return}catch(fe){console.warn("Failed to add deficiency to Firestore, falling back to local storage:",fe)}const P=`deficiencies_${(N==null?void 0:N.shopId)||(y==null?void 0:y.uid)||"default-shop"}`,L=localStorage.getItem(P),se=L?JSON.parse(L):[],ge=Array.isArray(se)?se:[];if(ge.some(fe=>String((fe==null?void 0:fe.name)||"").trim()===d&&String((fe==null?void 0:fe.status)||"pending")==="pending"))return;const Ce={id:Date.now().toString(),name:d,quantity:1,status:"pending",createdAt:new Date().toISOString()},ke=[...ge,Ce];localStorage.setItem(P,JSON.stringify(ke)),O({title:"تمت الإضافة للنواقص",description:`المنتج ${d} نفد من المخزون وتمت إضافته للنواقص`})}catch(P){console.error("Error adding deficiency for out-of-stock:",P)}},Qt=async(d,P=!1,L)=>{const se=pe[d.id]||"",ge=parseInt(se);if(isNaN(ge)||ge<=0){O({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(ge>d.quantity){O({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const ce=new Date,Ce=k&&K?"cashier":"admin",ke=Ce==="cashier"?(K==null?void 0:K.name)||"كاشير":(N==null?void 0:N.fullName)||(y==null?void 0:y.displayName)||"الحساب الرئيسي",fe=Ce==="cashier"&&(K==null?void 0:K.username)||null,We=(d.serialNumber||"").trim(),ue=xs[d.id]||"",Ct=parseFloat(ue),gs=!isNaN(Ct)&&Ct>0?Ct:d.sellingPrice,Xs={id:Date.now().toString(),productName:d.name,price:gs,wholesalePrice:d.wholesalePrice,quantity:ge,date:ce.toISOString().split("T")[0],time:ce.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),createdAtMs:ce.getTime(),performedByType:Ce,performedByName:ke,performedByUsername:fe,serialNumber:We||void 0,barcode:d.barcode,isDeferred:P,customerName:L==null?void 0:L.name,customerMobile:L==null?void 0:L.mobile,customerId:L==null?void 0:L.id};try{const ca=await jr(Xs),Ar=ca?{...Xs,firestoreId:ca}:Xs;Dt([...w,Ar]);const Ja=d.quantity-ge;if(await Yt(Oe(U,"products",d.id),{quantity:Ja,updatedAt:dt()}),re(It=>It.map(Ea=>Ea.id===d.id?{...Ea,quantity:Ja}:Ea)),M(It=>({...It,[d.id]:""})),vt(It=>({...It,[d.id]:""})),Ja===0&&Cr(d.name),!P)try{const It=gs*ge,Ea=Gr(),Ws=localStorage.getItem(Ea),Zr=(Ws?parseFloat(Ws):0)+It;localStorage.setItem(Ea,Zr.toString());const Rn=`userData_${y==null?void 0:y.uid}`,da={cashBalance:Zr,lastUpdated:new Date().toISOString()};localStorage.setItem(Rn,JSON.stringify(da)),y!=null&&y.uid&&Ae.updateUserData(y.uid,da).catch(()=>{});const Oa=(N==null?void 0:N.shopId)||$;if(Oa)try{await Yt(Oe(U,"dashboardData",Oa),{cashBalance:Zr})}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:Zr}}))}catch{}try{if(y!=null&&y.uid){const Fs=`SALECASH-${y.uid}-${Date.now()}`,Tr={txnType:"cash_addition",type:"cash_addition",amount:It,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:Fs,title:"إيصال إضافة نقدية",merchantUserId:y.uid,createdBy:y.uid,shopId:(N==null?void 0:N.shopId)||$||void 0,cashierName:ke,performedByType:Ce,performedByUsername:fe,createdAt:new Date};await Ae.saveUserTransaction(y.uid,Tr)}}catch{}}catch(It){console.warn("تعذر تحديث رصيد الدرج النقدي بعد البيع:",It)}O({title:"تم البيع",description:`تم بيع ${ge} قطعة من ${d.name}`})}catch(ca){console.error("Error selling product:",ca),O({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},or=async d=>{if(y!=null&&y.uid){if(k){O({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف إيصالات البيع أثناء الورديه",variant:"destructive"});return}Ts("تأكيد حذف إيصال بيع","أدخل الرقم السري الرئيسي لحذف الإيصال وعكس الآثار",async()=>{try{const P=la(),L=`salesData_${y.uid}_${P}`,se=`salesData_all_${y.uid}`,ge=w.filter(Ce=>Ce.id!==d.id);try{localStorage.setItem(L,JSON.stringify(ge));const Ce=localStorage.getItem(se),ke=Ce?JSON.parse(Ce):[],fe=(Array.isArray(ke)?ke:[]).filter(We=>(We==null?void 0:We.id)!==d.id);localStorage.setItem(se,JSON.stringify(fe))}catch{}S(ge);const ce=[];if(!d.isDeferred)try{const Ce=(d.price??0)*(d.quantity??0),ke=Gr(),fe=localStorage.getItem(ke),ue=(fe?parseFloat(fe):0)-Ce;localStorage.setItem(ke,ue.toString());const Ct=`userData_${y==null?void 0:y.uid}`,gs={cashBalance:ue,lastUpdated:new Date().toISOString()};try{localStorage.setItem(Ct,JSON.stringify(gs))}catch{}y!=null&&y.uid&&ce.push(Ae.updateUserData(y.uid,gs));const Xs=(N==null?void 0:N.shopId)||$;Xs&&ce.push(Yt(Oe(U,"dashboardData",Xs),{cashBalance:ue}).catch(()=>{}));try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:ue}}))}catch{}}catch(Ce){console.warn("تعذر عكس رصيد الدرج النقدي عند حذف الإيصال:",Ce)}try{const Ce=Y.find(ke=>d.barcode&&ke.barcode===d.barcode||ke.name===d.productName);if(Ce){const ke=(Ce.quantity||0)+(d.quantity||0);re(fe=>fe.map(We=>We.id===Ce.id?{...We,quantity:ke}:We)),ce.push(Yt(Oe(U,"products",Ce.id),{quantity:ke,updatedAt:dt()}))}}catch(Ce){console.warn("تعذر عكس المخزون عند حذف الإيصال:",Ce)}try{d.firestoreId?(ce.push(va(Oe(U,"dailySales",d.firestoreId)).catch(()=>{})),ce.push(va(Oe(U,"users",y.uid,"dailySales",d.firestoreId)).catch(()=>{}))):ce.push((async()=>{try{const Ce=Je(je(U,"dailySales"),de("userId","==",y.uid),de("date","==",d.date),de("productName","==",d.productName),zr(5));let ke=await Re(Ce);if(ke.empty){const fe=Je(je(U,"users",y.uid,"dailySales"),de("date","==",d.date),de("productName","==",d.productName),zr(5));ke=await Re(fe)}if(!ke.empty){const fe=ke.docs.find(We=>{const ue=We.data();return Number((ue==null?void 0:ue.sellingPrice)??0)===Number(d.price??0)&&Number((ue==null?void 0:ue.quantity)??0)===Number(d.quantity??0)&&String((ue==null?void 0:ue.time)??"")===String(d.time??"")})||ke.docs[0];fe&&await va(fe.ref)}}catch(Ce){console.warn("تعذر حذف سجل البيع من Firestore (استعلام بديل):",Ce)}})())}catch(Ce){console.warn("تعذر جدولة حذف سجل البيع من Firestore:",Ce)}try{ee||setTimeout(()=>{try{za()}catch{}},0)}catch{}try{await Promise.allSettled(ce)}catch{}O({title:"تم حذف الإيصال",description:`تم حذف إيصال بيع للمنتج ${d.productName} وتم عكس الآثار`})}catch(P){console.error("Error deleting sale:",P),O({title:"فشل حذف الإيصال",description:"تعذّر حذف إيصال البيع",variant:"destructive"})}})}},Va=async d=>{try{M(P=>({...P,[d.id]:"1"})),await Qt(d)}catch(P){console.error("Error selling by barcode:",P)}},Ir=async d=>{if(!(y!=null&&y.uid))return;if(k){O({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف المنتجات أثناء الورديه",variant:"destructive"});return}window.confirm(`هل تريد حذف المنتج "${d.name}"؟`)&&Ts("تأكيد حذف منتج","لا يمكن حذف المنتجات إلا بإدخال الرقم السري الرئيسي",async()=>{try{await va(Oe(U,"products",d.id)),re(L=>L.filter(se=>se.id!==d.id)),O({title:"تم الحذف",description:`تم حذف المنتج ${d.name}`})}catch(L){console.error("Error deleting product:",L),O({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}})},fo=async()=>{try{if(!(y!=null&&y.uid)){O({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}if(k){O({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتجات أثناء الورديه",variant:"destructive"});return}const d=C.productName.trim(),P=parseFloat(C.price),L=parseFloat(C.wholesalePrice||"0"),se=parseInt(C.quantity);if(!d||isNaN(P)||isNaN(se)){O({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const ge={name:d,sellingPrice:P,wholesalePrice:isNaN(L)?0:L,quantity:isNaN(se)?0:se,userId:y.uid,createdAt:dt(),updatedAt:dt()},ce=(C.barcode||"").trim();ce&&(ge.barcode=ce);const Ce=(C.serialNumber||"").trim();Ce&&(ge.serialNumber=Ce),N!=null&&N.shopId&&(ge.shopId=N.shopId);const ke=await Ta(je(U,"products"),ge);re(fe=>[{id:ke.id,name:d,sellingPrice:P,wholesalePrice:isNaN(L)?0:L,quantity:isNaN(se)?0:se,barcode:(C.barcode||"").trim()||"",serialNumber:(C.serialNumber||"").trim()||""},...fe]),s({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),O({title:"تمت الإضافة",description:`تم إضافة المنتج ${d} بنجاح`})}catch(d){console.error("createProduct error",d),O({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}},Fn=async d=>{const P=(d||"").trim();if(!P)return;const L=Y.find(se=>(se.barcode||"")===P);if(!L){O({title:"باركود غير معروف",description:"لم يتم العثور على منتج بهذا الباركود"});return}await Va(L)},$i=()=>{const d=Object.entries(te).map(([fe,We])=>{const ue=Number(We),Ct=Y.find(gs=>gs.id===fe);return!Ct||!ue||ue<=0?null:{name:Ct.name,qty:ue,price:Ct.sellingPrice,total:ue*Ct.sellingPrice}}).filter(Boolean);if(d.length===0){O({title:"لم يتم اختيار منتجات",description:"فعّل وضع الفاتورة واختر منتجات وكميات للطباعة"});return}const P=(N==null?void 0:N.shopName)||(y==null?void 0:y.displayName)||"المحل",L=(N==null?void 0:N.phone)||(y==null?void 0:y.phoneNumber)||"",se=d.reduce((fe,We)=>fe+We.total,0),ge=new Date().toLocaleString("ar-EG"),ce=d.map(fe=>`
        <tr>
          <td style="border:1px solid #ddd;padding:6px">${fe.name}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${fe.qty}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${Mt(fe.price)}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center;font-weight:bold;color:#0a7">${Mt(fe.total)}</td>
        </tr>
      `).join(""),Ce=`
      <html>
        <head>
          <meta charset="utf-8" />
          <title>فاتورة</title>
          <style>
            body { font-family: Tahoma, Arial, sans-serif; direction: rtl; }
            .header { text-align: center; margin-bottom: 12px; }
            .header h2 { margin: 0; }
            .meta { text-align: center; color: #555; margin-bottom: 8px; }
            table { width: 100%; border-collapse: collapse; }
            .total { text-align: left; font-weight: bold; margin-top: 10px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>${P}</h2>
            ${L?`<div class="meta">رقم التليفون: ${L}</div>`:""}
            <div class="meta">التاريخ: ${ge}</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="border:1px solid #ddd;padding:6px">المنتج</th>
                <th style="border:1px solid #ddd;padding:6px">الكمية</th>
                <th style="border:1px solid #ddd;padding:6px">السعر</th>
                <th style="border:1px solid #ddd;padding:6px">الإجمالي</th>
              </tr>
            </thead>
            <tbody>
              ${ce}
            </tbody>
          </table>
          <div class="total">الإجمالي الكلي: ${Mt(se)}</div>
        </body>
      </html>
    `,ke=window.open("","_blank");ke&&(ke.document.write(Ce),ke.document.close(),ke.focus(),ke.print(),ke.close())};return e.jsxs(ve,{open:i,onOpenChange:p,children:[e.jsx(we,{className:"max-w-none w-[100vw] h-[100dvh] p-0 overflow-hidden bg-[#fdfbf7]",children:e.jsxs("div",{className:"flex flex-col h-full",dir:"rtl",children:[e.jsxs("div",{className:"bg-[#fcf9f2] border-b px-3 py-2 flex items-center justify-between shrink-0 z-10 h-14 sm:h-auto",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"bg-primary/10 p-1.5 rounded-full",children:e.jsx(ho,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{className:"flex flex-col justify-center",children:[e.jsx(Ne,{className:"text-sm font-bold leading-tight",children:"المبيعات والمنتجات"}),e.jsx("p",{className:"text-[10px] text-muted-foreground hidden sm:block leading-none mt-0.5",children:"إدارة عمليات البيع والمخزون"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>Wn(),className:"hidden sm:flex h-7 text-[10px] px-2",children:[e.jsx(Ii,{className:"h-3 w-3 ml-1.5"}),"مزامنة"]}),e.jsx(x,{variant:"ghost",size:"icon",onClick:p,className:"rounded-full h-8 w-8",children:e.jsx(Ln,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex-1 overflow-hidden flex flex-col md:flex-row",children:[e.jsx("div",{className:"w-full md:w-80 bg-[#fcf9f2] border-l flex flex-col shrink-0 order-2 md:order-1",children:e.jsx("div",{className:"flex-1 overflow-y-auto scrollbar-thin",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs(pt,{className:"hidden md:block",children:[e.jsx(Xt,{className:"p-4 pb-2",children:e.jsxs(vs,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(es,{className:"h-4 w-4 text-primary"}),"ملخص اليوم"]})}),e.jsxs(Nt,{className:"p-4 pt-2 space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center p-3 bg-gray-50 rounded-lg border",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"المبيعات"}),e.jsx("span",{className:"text-lg font-bold text-primary",children:Mt(w.filter(d=>!d.isDeferred).reduce((d,P)=>d+P.price*P.quantity,0))})]}),e.jsxs("div",{className:"relative overflow-hidden p-3 bg-emerald-50/50 rounded-lg border border-emerald-100",children:[e.jsxs("div",{className:`flex justify-between items-center ${Q?"blur-sm":""}`,children:[e.jsx("span",{className:"text-sm text-emerald-700",children:"الأرباح"}),e.jsx("span",{className:"text-lg font-bold text-emerald-700",children:Mt(w.filter(d=>!d.isDeferred).reduce((d,P)=>d+(P.price-(P.wholesalePrice??0))*P.quantity,0))})]}),Q&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white/50",children:e.jsxs(x,{size:"sm",variant:"outline",onClick:()=>yt(!0),className:"h-7 text-xs bg-white",children:[e.jsx(wa,{className:"h-3 w-3 ml-1"}),"عرض"]})})]})]})]}),e.jsxs(pt,{className:"shadow-none border-none bg-transparent hidden md:block",children:[e.jsxs("button",{onClick:()=>as(!ss),className:"flex items-center justify-between w-full p-2 text-sm font-medium text-gray-600 hover:text-primary transition-colors",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(vr,{className:"h-4 w-4"}),"تقارير الشهر"]}),ss?e.jsx(En,{className:"h-4 w-4"}):e.jsx(Cd,{className:"h-4 w-4"})]}),!ss&&e.jsx("div",{className:"mt-2 grid grid-cols-2 gap-2 animate-in slide-in-from-top-2",children:e.jsxs("div",{className:"col-span-2 relative",children:[e.jsxs("div",{className:`grid grid-cols-2 gap-2 ${ee?"blur-sm select-none":""}`,children:[e.jsxs("div",{className:"bg-indigo-50 p-3 rounded-xl border border-indigo-100 text-center",children:[e.jsx("span",{className:"text-[10px] text-indigo-600 block mb-1",children:"المبيعات"}),e.jsx("span",{className:"text-sm font-bold text-indigo-700",children:Mt(Ht)})]}),e.jsxs("div",{className:"bg-pink-50 p-3 rounded-xl border border-pink-100 text-center",children:[e.jsx("span",{className:"text-[10px] text-pink-600 block mb-1",children:"الأرباح"}),e.jsx("span",{className:"text-sm font-bold text-pink-700",children:Mt(Wt)})]})]}),ee&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-10",children:e.jsxs(x,{size:"sm",variant:"outline",onClick:()=>Qe(!0),className:"h-8 bg-white/80 backdrop-blur-sm",children:[e.jsx(wa,{className:"h-3 w-3 ml-1"}),"فك القفل"]})})]})})]}),e.jsx(Ei,{className:"hidden md:block"}),e.jsxs(x,{variant:"outline",className:"w-full justify-start h-10",onClick:()=>De(!0),children:[e.jsx(ba,{className:"h-4 w-4 ml-2"}),"أرشيف الإيصالات"]})]})})}),e.jsx("div",{className:"flex-1 overflow-hidden flex flex-col order-1 md:order-2 bg-[#fdfbf7]",children:e.jsxs(Yu,{defaultValue:"products",className:"flex-1 flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"px-2 py-1.5 bg-[#fcf9f2] border-b flex items-center justify-between shrink-0",children:[e.jsxs(Hu,{className:"h-8",children:[e.jsx(nd,{value:"products",className:"text-xs px-2 sm:px-3",children:"المنتجات والبيع"}),e.jsxs(nd,{value:"sales-log",className:"text-xs px-2 sm:px-3",children:["سجل المبيعات",e.jsx(Lt,{variant:"secondary",className:"mr-2 h-5 px-1.5 text-[10px] hidden sm:inline-flex",children:w.filter(d=>!d.isDeferred).length})]})]}),e.jsxs(x,{variant:"ghost",size:"sm",className:"md:hidden text-xs h-8 px-2 bg-white/50 border mr-1 text-primary",onClick:()=>lt(!0),children:[e.jsx(co,{className:"h-3 w-3 ml-1"}),"تفاصيل اليوم"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500 font-mono",dir:"ltr",children:[e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(Ba,{className:"h-3.5 w-3.5 text-gray-400"})]})]}),e.jsx(id,{value:"products",className:"flex-1 p-0 m-0 overflow-hidden h-full relative",children:e.jsx("div",{className:"absolute inset-0 overflow-y-auto scrollbar-thin",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs(pt,{className:"border-dashed border-2 border-gray-200 hover:border-gray-300 transition-all bg-gray-50/30 overflow-hidden",children:[e.jsxs("div",{className:"p-4 flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors",onClick:()=>F(!b),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-emerald-100 p-2 rounded-full",children:e.jsx(Ut,{className:"h-5 w-5 text-emerald-600"})}),e.jsxs("div",{className:"text-right",children:[e.jsx("h3",{className:"font-semibold text-gray-900 text-sm",children:"إضافة منتج جديد"}),e.jsx("p",{className:"text-xs text-gray-500",children:"تسجيل منتج جديد في المخزون"})]})]}),e.jsx(x,{variant:"ghost",size:"sm",className:"rounded-full h-8 w-8 p-0",children:e.jsx(En,{className:`h-5 w-5 text-gray-400 transition-transform duration-200 ${b?"rotate-180":""}`})})]}),b&&e.jsxs("div",{className:"px-4 pb-4 pt-0 animate-in slide-in-from-top-2",children:[e.jsx("div",{className:"h-px bg-gray-200 mb-4"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs(Z,{className:"text-xs font-medium text-gray-700",children:["اسم المنتج ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(q,{value:C.productName,onChange:d=>s(P=>({...P,productName:d.target.value})),className:"h-9 bg-white",placeholder:"مثال: شاحن آيفون أصلي"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs(Z,{className:"text-xs font-medium text-gray-700",children:["سعر البيع ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(q,{type:"number",value:C.price,onChange:d=>s(P=>({...P,price:d.target.value})),className:"h-9 bg-white",placeholder:"0.00"})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Z,{className:"text-xs font-medium text-gray-700",children:"سعر الجملة"}),e.jsx(q,{type:"number",value:C.wholesalePrice||"",onChange:d=>s(P=>({...P,wholesalePrice:d.target.value})),className:"h-9 bg-white",placeholder:"0.00"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs(Z,{className:"text-xs font-medium text-gray-700",children:["الكمية ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(q,{type:"number",value:C.quantity,onChange:d=>s(P=>({...P,quantity:d.target.value})),className:"h-9 bg-white",placeholder:"1"})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Z,{className:"text-xs font-medium text-gray-700",children:"الباركود (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{value:C.barcode||"",onChange:d=>s(P=>({...P,barcode:d.target.value})),className:"h-9 bg-white pl-8",placeholder:"Scan..."}),e.jsx(no,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-gray-400"})]})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs(x,{className:"w-full h-9 bg-emerald-600 hover:bg-emerald-700 text-white shadow-sm",onClick:()=>{if(k){O({title:"غير مسموح",description:"لا يمكن إضافة منتج أثناء الوردية",variant:"destructive"});return}Ts("إضافة منتج","أدخل الرقم السري للمتابعة",fo)},children:[e.jsx(Ut,{className:"h-4 w-4 ml-2"}),"حفظ المنتج الجديد"]})})]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 items-stretch sm:items-center justify-between bg-white p-2 rounded-xl border border-gray-100 shadow-sm",children:[e.jsxs("div",{className:"relative flex-1 w-full sm:max-w-md group",children:[e.jsx(Td,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 group-focus-within:text-primary transition-colors"}),e.jsx(q,{value:xa,onChange:d=>_a(d.target.value),placeholder:"بحث عن منتج بالاسم...",className:"pl-3 pr-9 h-10 border-0 bg-transparent focus-visible:ring-0 placeholder:text-gray-400"})]}),e.jsx("div",{className:"h-8 w-px bg-gray-200 hidden sm:block"}),e.jsxs("div",{className:"flex items-center gap-2 w-full sm:w-auto",children:[e.jsxs("div",{className:"relative flex-1 sm:w-48 group",children:[e.jsx(no,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 group-focus-within:text-primary transition-colors"}),e.jsx(q,{value:xe,onChange:d=>ne(d.target.value),onKeyDown:async d=>{d.key==="Enter"&&xe.trim()&&(await Fn(xe.trim()),ne(""))},placeholder:"ماسح الباركود...",className:"pr-9 h-9 bg-gray-50 border-gray-200 focus:bg-white transition-all text-sm"})]}),e.jsxs("div",{className:"flex items-center gap-1 border-r pr-2 mr-1",children:[e.jsx(x,{variant:Le?"default":"ghost",size:"icon",onClick:()=>H(!Le),className:`h-9 w-9 shrink-0 transition-all rounded-full ${Le?"bg-primary text-primary-foreground":"text-gray-500 hover:text-primary hover:bg-primary/10"}`,title:"وضع الفاتورة",children:e.jsx(ba,{className:"h-4 w-4"})}),Le&&e.jsx(x,{variant:"outline",size:"icon",onClick:$i,disabled:Object.values(te).every(d=>!d),className:"h-9 w-9 shrink-0 rounded-full border-gray-200",title:"طباعة الفاتورة",children:e.jsx(kd,{className:"h-4 w-4 text-gray-600"})})]})]})]}),e.jsx("div",{className:"space-y-4",children:pa.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4 bg-white rounded-xl border border-dashed border-gray-200 text-center shadow-sm",children:[e.jsx("div",{className:"bg-gray-50 p-4 rounded-full mb-4",children:e.jsx(Ed,{className:"h-10 w-10 text-gray-300"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-1",children:"لا توجد منتجات"}),e.jsx("p",{className:"text-gray-500 text-sm max-w-xs mx-auto mb-4",children:"لم يتم العثور على منتجات تطابق بحثك."}),e.jsxs(x,{variant:"outline",onClick:()=>F(!0),className:"gap-2",children:[e.jsx(Ut,{className:"h-4 w-4"}),"إضافة منتج جديد"]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden md:block bg-[#fcf9f2] rounded-xl border border-gray-100 shadow-sm overflow-hidden",children:e.jsxs(Ai,{children:[e.jsx(Ti,{className:"bg-gray-50/80",children:e.jsxs(br,{className:"hover:bg-transparent border-gray-100",children:[e.jsx(Jt,{className:"text-right h-11 font-semibold text-gray-700",children:"المنتج"}),e.jsx(Jt,{className:"text-center h-11 font-semibold text-gray-700 w-28",children:"السعر"}),e.jsx(Jt,{className:"text-center h-11 font-semibold text-gray-700 w-28",children:e.jsxs("div",{className:"flex items-center justify-center gap-1.5 cursor-pointer hover:text-primary transition-colors select-none",onClick:()=>{Be?Ge(!1):Ts("عرض سعر الجملة","أدخل الرقم السري الرئيسي لعرض سعر الجملة",()=>Ge(!0))},children:[e.jsx("span",{children:"الجملة"}),Be?e.jsx(Qs,{className:"h-3.5 w-3.5"}):e.jsx(Ns,{className:"h-3.5 w-3.5"})]})}),e.jsx(Jt,{className:"text-center h-11 font-semibold text-gray-700 w-24",children:"الكمية"}),e.jsx(Jt,{className:"text-center h-11 font-semibold text-gray-700 w-[420px]",children:"إجراءات البيع"})]})}),e.jsx(ki,{children:pa.map(d=>e.jsxs(br,{className:"hover:bg-gray-50/60 transition-colors border-gray-100",children:[e.jsxs(Kt,{className:"font-medium py-3",children:[e.jsx("div",{className:"text-gray-900 font-bold",children:d.name}),d.barcode&&e.jsxs("div",{className:"flex items-center gap-1 text-[11px] text-gray-500 font-mono mt-0.5",children:[e.jsx(no,{className:"h-3 w-3"}),d.barcode]})]}),e.jsx(Kt,{className:"text-center py-3",children:e.jsx("span",{className:"font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-md",children:Mt(d.sellingPrice)})}),e.jsx(Kt,{className:"text-center py-3",children:e.jsx("span",{className:`font-medium text-xs ${Be?"text-gray-600":"blur-sm select-none text-gray-300"}`,children:Mt(d.wholesalePrice)})}),e.jsx(Kt,{className:"text-center py-3",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(Lt,{variant:d.quantity>0?"outline":"destructive",className:`font-mono ${d.quantity>0?"bg-gray-50 text-gray-700 border-gray-200":""}`,children:d.quantity}),e.jsx(x,{size:"icon",variant:"ghost",className:"h-5 w-5 rounded-full text-emerald-600 hover:bg-emerald-50 hover:text-emerald-700",onClick:()=>os(d),title:"إضافة مخزون",children:e.jsx(Ut,{className:"h-3 w-3"})})]})}),e.jsx(Kt,{className:"py-3",children:e.jsxs("div",{className:"flex items-center gap-2 justify-end",children:[e.jsxs("div",{className:"relative group",children:[e.jsx(q,{type:"number",className:"h-8 w-14 text-center px-1 text-sm bg-white border-gray-200 focus:border-primary/50",placeholder:"1",value:pe[d.id]||"",onChange:P=>M(L=>({...L,[d.id]:P.target.value}))}),e.jsx("span",{className:"absolute -top-2 -right-1 text-[9px] bg-white px-0.5 text-gray-400 group-hover:text-primary transition-colors",children:"العدد"})]}),e.jsxs("div",{className:"relative group",children:[e.jsx(q,{type:"number",className:"h-8 w-16 text-center px-1 bg-gray-50 border-gray-200 focus:border-primary/50 text-sm focus:bg-white transition-colors",placeholder:"سعر",value:xs[d.id]||"",onChange:P=>vt(L=>({...L,[d.id]:P.target.value})),title:"سعر بيع مخصص"}),e.jsx("span",{className:"absolute -top-2 -right-1 text-[9px] bg-white px-0.5 text-gray-400 group-hover:text-primary transition-colors",children:"مخصص"})]}),e.jsx(x,{size:"sm",className:"h-8 bg-indigo-600 hover:bg-indigo-700 text-white shadow-sm px-3 font-medium",onClick:()=>Qt(d),children:"بيع"}),e.jsx(x,{size:"sm",variant:"secondary",className:"h-8 text-amber-700 bg-amber-50 hover:bg-amber-100 border border-amber-200 px-3 font-medium",onClick:()=>{mt(d),T(!0)},children:"أجل"}),Le&&e.jsx(q,{type:"number",className:"h-8 w-12 text-center border-indigo-200 focus:border-indigo-400 bg-indigo-50/30",placeholder:"#",value:te[d.id]??"",onChange:P=>{const L=parseInt(P.target.value||"0");ae(se=>({...se,[d.id]:isNaN(L)?0:L}))}}),e.jsx("div",{className:"w-px h-4 bg-gray-200 mx-1"}),e.jsx(x,{size:"icon",variant:"ghost",className:"h-8 w-8 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full",onClick:()=>Ir(d),disabled:k,children:e.jsx(bs,{className:"h-4 w-4"})})]})})]},d.id))})]})}),e.jsx("div",{className:"md:hidden grid grid-cols-1 gap-3",children:pa.map(d=>e.jsx(pt,{className:"overflow-hidden border-gray-100 shadow-sm hover:shadow-md transition-shadow bg-[#fcf9f2]",children:e.jsxs(Nt,{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-gray-900 text-base",children:d.name}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-2",children:[e.jsx(Lt,{variant:"secondary",className:"bg-emerald-50 text-emerald-700 border-emerald-100",children:Mt(d.sellingPrice)}),e.jsxs("span",{className:`text-xs text-gray-500 flex items-center gap-1 ${!Be&&"blur-sm select-none"}`,children:[e.jsx("span",{className:"text-gray-400",children:"جملة:"}),Mt(d.wholesalePrice)]}),e.jsx("span",{className:"text-gray-300",children:"|"}),e.jsxs("span",{className:"text-xs text-gray-600 font-medium flex items-center gap-1",children:["متاح: ",d.quantity,e.jsx(x,{size:"icon",variant:"ghost",className:"h-5 w-5 rounded-full text-emerald-600 hover:bg-emerald-50",onClick:()=>os(d),children:e.jsx(Ut,{className:"h-3 w-3"})})]})]})]}),e.jsx(x,{size:"icon",variant:"ghost",className:"h-8 w-8 -mt-1 -ml-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full",onClick:()=>Ir(d),disabled:k,children:e.jsx(bs,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-gray-50/50 p-2 rounded-lg border border-gray-100",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(q,{type:"number",className:"h-9 w-full bg-white text-center border-gray-200 focus:border-indigo-300",placeholder:"الكمية",value:pe[d.id]||"",onChange:P=>M(L=>({...L,[d.id]:P.target.value}))}),e.jsx("span",{className:"absolute inset-y-0 right-2 flex items-center text-[10px] text-gray-400 pointer-events-none",children:"عدد"})]}),e.jsxs("div",{className:"relative w-28",children:[e.jsx(q,{type:"number",className:"h-9 w-full bg-white text-center border-gray-200 focus:border-indigo-300",placeholder:"سعر مخصص",value:xs[d.id]||"",onChange:P=>vt(L=>({...L,[d.id]:P.target.value}))}),e.jsx("span",{className:"absolute inset-y-0 right-2 flex items-center text-[10px] text-gray-400 pointer-events-none",children:"سعر"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(x,{className:"h-10 bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm font-bold",onClick:()=>Qt(d),children:[e.jsx(es,{className:"h-4 w-4 ml-2"}),"بيع فوري"]}),e.jsxs(x,{variant:"outline",className:"h-10 border-amber-200 text-amber-700 bg-amber-50 hover:bg-amber-100 font-bold",onClick:()=>{mt(d),T(!0)},children:[e.jsx(Ba,{className:"h-4 w-4 ml-2"}),"بيع أجل"]})]}),Le&&e.jsx("div",{className:"pt-3 border-t border-dashed border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-xs font-medium text-gray-500",children:"للفاتورة:"}),e.jsx(q,{type:"number",className:"h-8 flex-1 bg-indigo-50/30 border-indigo-100",value:te[d.id]??"",onChange:P=>{const L=parseInt(P.target.value||"0");ae(se=>({...se,[d.id]:isNaN(L)?0:L}))},placeholder:"العدد في الفاتورة"})]})})]})},d.id))})]})})]})})}),e.jsx(id,{value:"sales-log",className:"flex-1 p-0 m-0 overflow-hidden h-full relative",children:e.jsx("div",{className:"absolute inset-0 overflow-y-auto scrollbar-thin",children:e.jsxs("div",{className:"p-4 space-y-4 min-h-full",children:[e.jsx("div",{className:"md:hidden",children:e.jsxs(x,{variant:"outline",className:"w-full justify-between bg-white border-dashed border-2 border-gray-200 h-12 text-gray-700 hover:text-primary hover:border-primary/50 hover:bg-primary/5 shadow-sm",onClick:()=>lt(!0),children:[e.jsxs("span",{className:"flex items-center gap-2 font-semibold",children:[e.jsx(co,{className:"h-4 w-4 text-primary"}),"تفاصيل اليوم"]}),e.jsx("span",{className:"text-xs text-muted-foreground font-normal bg-gray-50 px-2 py-1 rounded-full border",children:"اضغط لعرض التقارير"})]})}),w.length===0?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center py-12 px-4 bg-[#fcf9f2]/50 rounded-xl border border-dashed border-gray-200 text-center",children:[e.jsx("div",{className:"bg-[#fcf9f2] p-4 rounded-full shadow-sm mb-4",children:e.jsx(ba,{className:"h-8 w-8 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-1",children:"لا توجد مبيعات"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"لم يتم تسجيل أي عمليات بيع اليوم."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"hidden md:block bg-[#fcf9f2] rounded-xl border border-gray-100 shadow-sm overflow-hidden",children:e.jsxs(Ai,{children:[e.jsx(Ti,{className:"bg-gray-50/80",children:e.jsxs(br,{className:"hover:bg-transparent",children:[e.jsx(Jt,{className:"text-right h-11 font-semibold text-gray-700",children:"المنتج"}),e.jsx(Jt,{className:"text-center h-11 font-semibold text-gray-700",children:"السعر"}),e.jsx(Jt,{className:"text-center h-11 font-semibold text-gray-700",children:"الكمية"}),e.jsx(Jt,{className:"text-center h-11 font-semibold text-gray-700",children:"الإجمالي"}),e.jsx(Jt,{className:"text-center h-11 font-semibold text-gray-700",children:"الربح"}),e.jsx(Jt,{className:"text-center h-11 font-semibold text-gray-700",children:"التاريخ"}),e.jsx(Jt,{className:"text-center h-11 font-semibold text-gray-700",children:"الوقت"}),e.jsx(Jt,{className:"text-center h-11 font-semibold text-gray-700",children:"إجراءات"})]})}),e.jsx(ki,{children:w.map(d=>e.jsxs(br,{className:"hover:bg-gray-50/60 transition-colors",children:[e.jsxs(Kt,{className:"py-3",children:[e.jsx("div",{className:"font-medium text-gray-900",children:d.productName}),d.isDeferred&&e.jsx(Lt,{variant:"secondary",className:"mt-1 text-[10px] bg-amber-100 text-amber-700 border-amber-200",children:"مؤجل"})]}),e.jsx(Kt,{className:"text-center py-3",children:Mt(d.price)}),e.jsx(Kt,{className:"text-center py-3",children:e.jsx(Lt,{variant:"outline",className:"font-mono bg-gray-50",children:d.quantity})}),e.jsx(Kt,{className:"text-center font-bold text-green-600 py-3",children:Mt(d.price*d.quantity)}),e.jsx(Kt,{className:"text-center text-indigo-600 py-3",children:e.jsx("span",{className:Be?"":"blur-sm select-none text-gray-300",children:Mt(((d.price??0)-(d.wholesalePrice??0))*d.quantity)})}),e.jsx(Kt,{className:"text-center text-gray-500 text-xs py-3 font-mono",children:Ci(d.date)}),e.jsx(Kt,{className:"text-center text-gray-500 text-xs py-3 font-mono",children:d.time}),e.jsx(Kt,{className:"py-3",children:e.jsxs("div",{className:"flex justify-center gap-2",children:[d.isDeferred&&e.jsx(x,{size:"sm",variant:"outline",className:"h-8 text-xs border-amber-200 text-amber-700 bg-amber-50 hover:bg-amber-100",onClick:()=>Ts("تأكيد سداد بيع مؤجل","أدخل الرقم السري الرئيسي لتأكيد السداد",()=>Dr(d)),children:"سداد"}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-8 w-8 p-0 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-full",onClick:()=>ja(d,"return"),title:"مرتجع",children:e.jsx(lr,{className:"h-4 w-4"})}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-8 w-8 p-0 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full",onClick:()=>ja(d,"delete"),title:"حذف نهائي",children:e.jsx(po,{className:"h-4 w-4"})})]})})]},d.id))})]})}),e.jsx("div",{className:"md:hidden space-y-3",children:w.map(d=>e.jsx(pt,{className:"overflow-hidden border-gray-100 shadow-sm bg-[#fcf9f2]",children:e.jsxs(Nt,{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-gray-900 text-sm",children:d.productName}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 flex items-center gap-2",children:[e.jsx("span",{className:"bg-gray-100 px-1.5 py-0.5 rounded text-gray-600 font-mono",children:d.time}),e.jsx("span",{className:"text-gray-400",children:"|"}),e.jsx("span",{children:Ci(d.date)}),d.isDeferred&&e.jsx(Lt,{variant:"outline",className:"text-[10px] bg-amber-50 text-amber-700 border-amber-100 px-1.5 py-0 h-5",children:"مؤجل"})]})]}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"font-bold text-green-600 text-sm",children:Mt(d.price*d.quantity)}),e.jsxs("div",{className:"text-xs text-gray-400 mt-0.5",children:[d.quantity," × ",Mt(d.price)]})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 pt-3 border-t border-gray-50",children:[d.isDeferred&&e.jsx(x,{size:"sm",variant:"ghost",className:"h-8 text-xs text-amber-600 bg-amber-50 hover:bg-amber-100",onClick:()=>Ts("تأكيد سداد بيع مؤجل","أدخل الرقم السري الرئيسي لتأكيد السداد",()=>Dr(d)),children:"تسديد"}),e.jsxs(x,{size:"sm",variant:"ghost",className:"h-8 text-xs text-red-600 hover:bg-red-50",onClick:()=>ja(d,"return"),children:[e.jsx(lr,{className:"h-3.5 w-3.5 ml-1.5"}),"مرتجع"]}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-8 w-8 p-0 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full",onClick:()=>ja(d,"delete"),children:e.jsx(bs,{className:"h-4 w-4"})})]})]})},d.id))})]})]})})})]})})]})]})}),e.jsx(ve,{open:Vs,onOpenChange:T,children:e.jsxs(we,{className:"max-w-sm mx-auto bg-white border border-gray-100 shadow-xl rounded-2xl sm:max-w-md p-6 gap-5",children:[e.jsxs(Ie,{className:"text-center space-y-2",children:[e.jsx("div",{className:"mx-auto bg-amber-100 p-3 rounded-full w-fit",children:e.jsx(Ba,{className:"h-6 w-6 text-amber-600"})}),e.jsx(Ne,{className:"text-xl font-bold text-gray-900",children:"تسجيل بيع أجل"}),e.jsx(hs,{className:"text-gray-500 text-sm",children:"أدخل بيانات العميل لتسجيل عملية البيع الآجل"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-1.5",children:[e.jsx(Z,{className:"text-sm font-medium text-gray-700",children:"اختيار عميل (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{className:"flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 appearance-none",value:ie,onChange:d=>{const P=d.target.value;Ee(P);const L=qa.find(se=>se.id===P);L&&(Me(L.name),G(L.mobile||""))},children:[e.jsx("option",{value:"",children:"-- اختر عميل مسجل --"}),qa.map(d=>e.jsxs("option",{value:d.id,children:[d.name,d.mobile?` - ${d.mobile}`:""]},d.id))]}),e.jsx(En,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 pointer-events-none"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-1.5",children:[e.jsxs(Z,{className:"text-sm font-medium text-gray-700",children:["اسم العميل ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(q,{value:He,onChange:d=>Me(d.target.value),placeholder:"أدخل اسم العميل...",className:"h-10"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-1.5",children:[e.jsx(Z,{className:"text-sm font-medium text-gray-700",children:"رقم التليفون (اختياري)"}),e.jsx(q,{value:nt,onChange:d=>G(d.target.value),placeholder:"أدخل رقم التليفون...",className:"h-10"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-2",children:[e.jsx(x,{variant:"outline",className:"flex-1 h-10 border-gray-200",onClick:()=>T(!1),children:"إلغاء"}),e.jsx(x,{className:"flex-1 h-10 bg-amber-600 hover:bg-amber-700 text-white shadow-sm",onClick:async()=>{try{const d=ot;if(!d){T(!1);return}const P=He.trim(),L=nt.trim()||void 0,se=ie||void 0;if(!P){O({title:"بيانات مطلوبة",description:"أدخل اسم العميل",variant:"destructive"});return}await Qt(d,!0,{id:se,name:P,mobile:L});try{if(y!=null&&y.uid){const ge=d.sellingPrice*(parseInt(pe[d.id]||"0")||0),ce=await Ae.getUserData(y.uid),Ce=Array.isArray(ce==null?void 0:ce.debts)?ce.debts:[],ke={id:Date.now().toString(),debtorName:P,customerId:se||null,mobile:L||null,amount:ge,reason:`بيع أجل للمنتج ${d.name}`,status:"pending",createdAt:new Date,partialPayments:[]},fe=[ke,...Ce];Ae.updateUserData(y.uid,{debts:fe}).catch(()=>{});try{const We=$||(N==null?void 0:N.shopId)||"main";localStorage.setItem(`debts_${y.uid}_${We}`,JSON.stringify(fe)),localStorage.setItem(`debts_default_${We}`,JSON.stringify(fe)),localStorage.setItem(`debts_last_write_${y.uid}_${We}`,Date.now().toString())}catch{}try{window.dispatchEvent(new CustomEvent("debtsUpdated",{detail:{count:fe.length}}))}catch{}try{Xa.send(y.uid,`تم إضافة دين على ${ke.debtorName} بمبلغ ${ke.amount} جنيه`).catch(()=>{})}catch{}}}catch{}T(!1),mt(null)}catch{}},children:"تأكيد البيع"})]})]})}),e.jsx(ve,{open:B,onOpenChange:De,children:e.jsxs(we,{className:"sm:max-w-4xl max-h-[85vh] flex flex-col p-0 overflow-hidden gap-0",children:[e.jsxs("div",{className:"p-4 border-b flex items-center justify-between bg-gray-50/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-white p-2 rounded-full border shadow-sm",children:e.jsx(ba,{className:"h-5 w-5 text-indigo-600"})}),e.jsxs("div",{children:[e.jsx(Ne,{className:"text-lg font-bold",children:"سجل الإيصالات"}),e.jsx(hs,{className:"text-xs",children:"عرض تفاصيل عمليات البيع الفورية"})]})]}),e.jsx(x,{variant:"ghost",size:"icon",onClick:()=>De(!1),className:"rounded-full",children:e.jsx(Ln,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:w.filter(d=>!d.isDeferred).length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx("div",{className:"bg-gray-50 p-4 rounded-full mb-3",children:e.jsx(ba,{className:"h-8 w-8 text-gray-300"})}),e.jsx("p",{className:"text-gray-500 font-medium",children:"لا توجد إيصالات بيع حتى الآن"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden md:block border rounded-xl overflow-hidden shadow-sm",children:e.jsxs(Ai,{children:[e.jsx(Ti,{className:"bg-gray-50/80",children:e.jsxs(br,{className:"hover:bg-transparent",children:[e.jsx(Jt,{className:"text-right h-10 font-semibold text-gray-700",children:"المنتج"}),e.jsx(Jt,{className:"text-right h-10 font-semibold text-gray-700",children:"سعر البيع"}),e.jsx(Jt,{className:"text-right h-10 font-semibold text-gray-700",children:"سعر الجملة"}),e.jsx(Jt,{className:"text-right h-10 font-semibold text-gray-700",children:"الكمية"}),e.jsx(Jt,{className:"text-right h-10 font-semibold text-gray-700",children:"الإجمالي"}),e.jsx(Jt,{className:"text-right h-10 font-semibold text-gray-700",children:"الربح"}),e.jsx(Jt,{className:"text-right h-10 font-semibold text-gray-700",children:"التاريخ"}),e.jsx(Jt,{className:"text-right h-10 font-semibold text-gray-700",children:"الوقت"}),e.jsx(Jt,{className:"text-right h-10 font-semibold text-gray-700",children:"المنفذ"})]})}),e.jsx(ki,{children:w.filter(d=>!d.isDeferred).map(d=>e.jsxs(br,{className:"hover:bg-gray-50/60",children:[e.jsx(Kt,{className:"font-medium text-gray-900 py-3",children:d.productName}),e.jsx(Kt,{className:"text-gray-700 py-3",children:Mt(d.price)}),e.jsx(Kt,{className:"text-gray-700 py-3",children:Mt(d.wholesalePrice??0)}),e.jsx(Kt,{className:"text-gray-700 py-3 font-mono",children:pd(d.quantity)}),e.jsx(Kt,{className:"text-gray-700 py-3 font-bold text-emerald-600",children:Mt((d.price??0)*(d.quantity??0))}),e.jsx(Kt,{className:"text-gray-700 py-3 text-indigo-600",children:Mt(((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0))}),e.jsx(Kt,{className:"text-gray-500 py-3 text-xs",children:Ci(d.date)}),e.jsx(Kt,{className:"text-gray-500 py-3 text-xs font-mono",children:d.time}),e.jsx(Kt,{className:"text-gray-700 py-3 text-xs",children:d.executedBy||"-"})]},d.id))})]})}),e.jsx("div",{className:"md:hidden space-y-3",children:w.filter(d=>!d.isDeferred).map(d=>e.jsx(pt,{className:"overflow-hidden border-gray-100 shadow-sm",children:e.jsxs(Nt,{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-gray-900 text-sm",children:d.productName}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 flex items-center gap-2",children:[e.jsx("span",{className:"bg-gray-100 px-1.5 py-0.5 rounded text-gray-600 font-mono",children:d.time}),e.jsx("span",{className:"text-gray-400",children:"|"}),e.jsx("span",{children:Ci(d.date)})]})]}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"font-bold text-emerald-600 text-sm",children:Mt((d.price??0)*(d.quantity??0))}),e.jsxs("div",{className:"text-xs text-gray-400 mt-0.5",children:[d.quantity," × ",Mt(d.price)]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 pt-3 border-t border-dashed border-gray-100 text-xs",children:[e.jsxs("div",{className:"bg-gray-50 p-2 rounded flex flex-col items-center justify-center",children:[e.jsx("span",{className:"text-gray-400 mb-1",children:"الربح"}),e.jsx("span",{className:"font-bold text-indigo-600",children:Mt(((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0))})]}),e.jsxs("div",{className:"bg-gray-50 p-2 rounded flex flex-col items-center justify-center",children:[e.jsx("span",{className:"text-gray-400 mb-1",children:"المنفذ"}),e.jsx("span",{className:"font-medium text-gray-700 truncate max-w-full px-1",children:d.executedBy||"-"})]})]})]})},d.id))})]})}),e.jsx("div",{className:"p-4 border-t bg-gray-50/30 flex justify-end",children:e.jsx(x,{variant:"outline",onClick:()=>De(!1),className:"px-6",children:"إغلاق"})})]})}),e.jsx(ve,{open:ps,onOpenChange:rs,children:e.jsxs(we,{className:"max-w-sm mx-auto bg-white border border-gray-100 shadow-xl rounded-2xl sm:max-w-md p-6 gap-6",children:[e.jsxs("div",{className:"flex flex-col items-center text-center gap-2",children:[e.jsx("div",{className:`p-3 rounded-full ${is==="return"?"bg-amber-100 text-amber-600":"bg-red-100 text-red-600"}`,children:is==="return"?e.jsx(lr,{className:"h-6 w-6"}):e.jsx(bs,{className:"h-6 w-6"})}),e.jsx(Ne,{className:"text-xl font-bold text-gray-900 mt-2",children:is==="return"?"تأكيد المرتجع":"تأكيد الحذف"}),e.jsxs("div",{className:"text-sm text-gray-500 space-y-1",children:[e.jsxs("p",{children:["هل أنت متأكد من ",is==="return"?"إرجاع":"حذف"," المنتج",e.jsx("span",{className:"font-bold text-gray-900 mx-1",children:ns==null?void 0:ns.productName}),"بكمية",e.jsx("span",{className:"font-bold text-gray-900 mx-1 font-mono",children:pd((ns==null?void 0:ns.quantity)||0)}),"؟"]}),e.jsx("p",{className:"text-xs text-gray-400",children:"سيتم تحديث المخزون والرصيد تلقائياً."})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(x,{variant:"outline",className:"h-10 border-gray-200",onClick:()=>rs(!1),children:"إلغاء"}),e.jsx(x,{className:`h-10 ${is==="return"?"bg-amber-600 hover:bg-amber-700":"bg-red-600 hover:bg-red-700"} text-white shadow-sm`,onClick:()=>{const d=ns;rs(!1),d&&or(d)},children:is==="return"?"تأكيد المرتجع":"تأكيد الحذف"})]})]})}),e.jsx(Is,{open:ze,onOpenChange:yt,mode:"verify",title:"قفل إجمالي الأرباح",description:"أدخل الرقم السري الرئيسي لعرض إجمالي الأرباح",onSuccess:()=>{oe(!1),yt(!1)}}),e.jsx(Is,{open:$e,onOpenChange:Qe,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const d=y==null?void 0:y.uid;if(d){const P=await xo(d),L=(P==null?void 0:P.planType)??(P==null?void 0:P.plan)??null,se=typeof L=="string"?L.toLowerCase():null;if(L===Hs.ZERO||se==="zero"){O({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}_t(!1),Qe(!1),za()}}),e.jsx(Is,{open:it,onOpenChange:Et,mode:"verify",title:us,description:$s,onSuccess:()=>{const d=Na.current;Na.current=null,Et(!1),d&&d()}}),e.jsx(ve,{open:z,onOpenChange:Te,children:e.jsxs(we,{className:"sm:max-w-[400px]",children:[e.jsxs(Ie,{children:[e.jsx(Ne,{className:"text-center",children:"إضافة مخزون"}),e.jsxs(hs,{className:"text-center",children:["إضافة كمية للمنتج: ",e.jsx("span",{className:"font-bold text-black",children:ht==null?void 0:ht.name})]})]}),e.jsx("div",{className:"py-6 flex flex-col items-center gap-4",children:e.jsxs("div",{className:"flex items-center gap-4 w-full justify-center",children:[e.jsx(x,{variant:"outline",size:"icon",onClick:()=>Ft(d=>String(Math.max(1,parseInt(d||"0")-1))),children:e.jsx(lr,{className:"h-4 w-4"})}),e.jsx(q,{id:"qty",type:"number",value:ls,onChange:d=>Ft(d.target.value),className:"w-32 text-center text-2xl font-bold h-12",autoFocus:!0,onKeyDown:d=>{d.key==="Enter"&&ia()}}),e.jsx(x,{variant:"outline",size:"icon",onClick:()=>Ft(d=>String(parseInt(d||"0")+1)),children:e.jsx(_n,{className:"h-4 w-4"})})]})}),e.jsxs(et,{className:"flex gap-2 sm:justify-center",children:[e.jsx(x,{variant:"outline",onClick:()=>Te(!1),className:"flex-1",children:"إلغاء"}),e.jsx(x,{onClick:ia,className:"flex-1 bg-emerald-600 hover:bg-emerald-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(ve,{open:rt,onOpenChange:lt,children:e.jsxs(we,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Ie,{children:e.jsx(Ne,{children:"تقرير اليوم والشهر"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center gap-2",children:[e.jsx(es,{className:"h-4 w-4 text-primary"}),"ملخص اليوم"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-center p-2 bg-white rounded border",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"المبيعات"}),e.jsx("div",{className:"font-bold text-primary",children:Mt(w.filter(d=>!d.isDeferred).reduce((d,P)=>d+P.price*P.quantity,0))})]}),e.jsxs("div",{className:"text-center p-2 bg-white rounded border relative overflow-hidden",children:[e.jsx("div",{className:"text-xs text-emerald-700 mb-1",children:"الأرباح"}),e.jsx("div",{className:`font-bold text-emerald-700 ${Q?"blur-sm":""}`,children:Mt(w.filter(d=>!d.isDeferred).reduce((d,P)=>d+(P.price-(P.wholesalePrice??0))*P.quantity,0))}),Q&&e.jsxs("div",{className:"absolute inset-0 flex items-center justify-center bg-white/50",children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>{lt(!1),yt(!0)},className:"h-full w-full opacity-0 absolute inset-0"}),e.jsx(wa,{className:"h-3 w-3 text-muted-foreground"})]})]})]})]}),e.jsxs("div",{className:"bg-indigo-50/50 p-4 rounded-lg border border-indigo-100",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center gap-2 text-indigo-900",children:[e.jsx(vr,{className:"h-4 w-4 text-indigo-600"}),"ملخص الشهر"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 relative",children:[e.jsxs("div",{className:`text-center p-2 bg-white rounded border border-indigo-100 ${ee?"blur-sm":""}`,children:[e.jsx("div",{className:"text-xs text-indigo-600 mb-1",children:"المبيعات"}),e.jsx("div",{className:"font-bold text-indigo-700",children:Mt(Ht)})]}),e.jsxs("div",{className:`text-center p-2 bg-white rounded border border-indigo-100 ${ee?"blur-sm":""}`,children:[e.jsx("div",{className:"text-xs text-pink-600 mb-1",children:"الأرباح"}),e.jsx("div",{className:"font-bold text-pink-700",children:Mt(Wt)})]}),ee&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-10",children:e.jsxs(x,{size:"sm",variant:"outline",onClick:()=>{lt(!1),Qe(!0)},className:"h-8 bg-white/80 backdrop-blur-sm",children:[e.jsx(wa,{className:"h-3 w-3 ml-1"}),"فك القفل"]})})]})]})]}),e.jsx(et,{children:e.jsx(x,{onClick:()=>lt(!1),children:"إغلاق"})})]})})]})}const pd=i=>new Intl.NumberFormat("ar-EG").format(Number(i||0)),Mt=i=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(i||0))} ج.م`,Ci=i=>{try{const p=new Date(i);return isNaN(p.getTime())?new Date(`${i}T00:00:00`).toLocaleDateString("ar-EG"):p.toLocaleDateString("ar-EG")}catch{return i}},Jx=({open:i,onOpenChange:p,userId:c,cashBalance:w,walletBalances:S,transactions:C})=>{const[s,b]=Ke.useState(0),[F,D]=Ke.useState(0),[E,O]=Ke.useState(0),[y,N]=Ke.useState(0),[k,K]=Ke.useState(w||0),[$,Y]=Ke.useState(!1),[re,pe]=Ke.useState(null),{toast:M}=ua(),{shopId:W}=Li()||{},{profile:le}=Pa(),[_e,Se]=Ke.useState(!1),[xe,ne]=Ke.useState(""),[Le,H]=Ke.useState(!1),[te,ae]=Ke.useState(!1),[Be,Ge]=Ke.useState(""),Q=()=>`cashBalance_${c||"default"}_${W||(le==null?void 0:le.shopId)||"main"}`,oe=qe=>`${new Intl.NumberFormat("ar-EG").format(Number(qe||0))} جنيه`;Ke.useEffect(()=>{const qe=async()=>{try{if(!c){b(0);return}const $e=new Date,Qe=$e.getFullYear(),ee=String($e.getMonth()+1).padStart(2,"0"),_t=String($e.getDate()).padStart(2,"0"),ss=`${Qe}-${ee}-${_t}`;let as;try{const De=Je(je(U,"dailySales"),de("userId","==",c),...W?[de("shopId","==",W)]:[],de("date","==",ss));as=await Re(De)}catch{const De=Je(je(U,"users",c,"dailySales"),...W?[de("shopId","==",W)]:[],de("date","==",ss));as=await Re(De)}let B=0;as.forEach(De=>{const Fe=De.data(),jt=Number(Fe.sellingPrice??0),gt=Number(Fe.quantity??0);jt>0&&gt>0&&(B+=jt*gt)}),b(B)}catch($e){console.warn("فشل تحميل مبيعات الإكسسوار لليوم:",$e)}},rt=async()=>{try{if(!c){setMaintenanceProfitToday(0);return}const $e=new Date,Qe=new Date($e.getFullYear(),$e.getMonth(),$e.getDate(),0,0,0,0),ee=new Date($e.getFullYear(),$e.getMonth(),$e.getDate(),23,59,59,999);let _t;try{const as=Je(je(U,"maintenance_items"),de("userId","==",c),de("status","==","completed"));_t=await Re(as)}catch{_t=await Re(Je(je(U,"maintenance_items"),de("userId","==",c)))}let ss=0;_t.forEach(as=>{var Fe,jt;const B=as.data();if((B.status||"in_progress")!=="completed")return;const De=(jt=(Fe=B.completedAt)==null?void 0:Fe.toDate)==null?void 0:jt.call(Fe);if(De&&De.getTime()>=Qe.getTime()&&De.getTime()<=ee.getTime()){const gt=Number(B.repairPrice||0);Number.isFinite(gt)&&gt>0&&(ss+=gt)}}),O(Math.max(0,ss))}catch($e){console.warn("فشل تحميل إجمالي فلوس الصيانة لليوم:",$e)}},lt=async()=>{var $e;try{if(!c){D(0);return}const Qe=await Ae.getUserData(c),ee=new Date().toISOString().slice(0,10),_t=(Qe==null?void 0:Qe.dailyReceipts)||{};_t!=null&&_t.date&&String(_t.date).slice(0,10)===ee?(D(Number(_t.accessory||0)),N(Number(_t.maintenance||0))):(D(0),N(0));try{const ss=W||(le==null?void 0:le.shopId)||"main",as=await Ls(Oe(U,"dashboardData",ss));if(as.exists()){const B=Number((($e=as.data())==null?void 0:$e.cashBalance)||0);K(B);try{localStorage.setItem(`cashBalance_${c}`,String(B)),localStorage.setItem(Q(),String(B))}catch{}}else K(Number((Qe==null?void 0:Qe.cashBalance)||w||0))}catch{K(Number((Qe==null?void 0:Qe.cashBalance)||w||0))}}catch{D(0),N(0)}};i&&(qe(),rt(),lt())},[i,c,C,w,W]),Ke.useEffect(()=>{const qe=rt=>{var lt;try{const $e=Number((lt=rt==null?void 0:rt.detail)==null?void 0:lt.value);Number.isFinite($e)&&K($e)}catch{}};return window.addEventListener("cashBalanceChanged",qe),()=>window.removeEventListener("cashBalanceChanged",qe)},[i]),Ke.useEffect(()=>{if(!i||!c)return;const qe=W||(le==null?void 0:le.shopId)||"main";return(async()=>{var lt;try{const $e=await Ls(Oe(U,"dashboardData",qe));if($e.exists()){const Qe=Number(((lt=$e.data())==null?void 0:lt.cashBalance)||0);K(Qe);try{localStorage.setItem(`cashBalance_${c}`,String(Qe)),localStorage.setItem(Q(),String(Qe))}catch{}}}catch($e){console.warn("Error fetching dashboard data:",$e)}})(),()=>{}},[i,c,W]);const ze=Math.max(0,Number(s)-Number(F)),yt=Math.max(0,Number(E)-Number(y)),bt=async qe=>{if(!c)return;const rt=new Date().toISOString().slice(0,10);try{const lt=qe==="accessory"?ze:yt;if(lt<=0){M({title:"لا يوجد مبلغ لتأكيد استلامه",variant:"default"});return}const $e=Math.max(0,Number(k)-lt);K($e),qe==="accessory"?D(Qe=>Qe+lt):N(Qe=>Qe+lt),await Ae.updateUserData(c,{cashBalance:$e,dailyReceipts:{date:rt,accessory:qe==="accessory"?F+lt:F,maintenance:qe==="maintenance"?y+lt:y}});try{const Qe=W||(le==null?void 0:le.shopId)||"main";await Yt(Oe(U,"dashboardData",Qe),{cashBalance:$e,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${c}`,String($e)),localStorage.setItem(Q(),String($e))}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:$e}}))}catch{}M({title:"تم الاستلام",description:`تم خصم ${lt.toFixed(2)} من الدرج وتصفير بند ${qe==="accessory"?"الإكسسوار":"الصيانة"}`})}catch{M({title:"خطأ",description:"تعذر تنفيذ عملية تم الاستلام",variant:"destructive"})}},$t=()=>{ne(""),Ge(""),Se(!0)},Ht=()=>{if(!xe.trim()){M({title:"سبب الخصم مطلوب",variant:"destructive"});return}Se(!1),H(!0)},ts=()=>{H(!1),ae(!0)},Wt=async()=>{try{if(!c)return;const qe=Math.max(0,Number(Be||0));if(!Number.isFinite(qe)||qe<=0){M({title:"مبلغ غير صالح",description:"أدخل مبلغ خصم صحيح أكبر من الصفر",variant:"destructive"});return}const rt=Math.max(0,Number(k)-qe);K(rt),await Ae.updateUserData(c,{cashBalance:rt});try{const $e=W||(le==null?void 0:le.shopId)||"main";await Yt(Oe(U,"dashboardData",$e),{cashBalance:rt,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${c}`,String(rt))}catch{}try{const $e=new Date().toISOString();localStorage.setItem(Q(),String(rt)),localStorage.setItem(Q()+"_lastUpdated",$e)}catch{}const lt={title:"ايصال خصم من الفلوس النقديه",type:"cash_deduction",amount:qe,status:"completed",createdAt:new Date,note:xe,cashierName:"الحساب الرئيسي"};try{await Ae.saveUserTransaction(c,lt)}catch{}M({title:"تم الخصم",description:`تم خصم ${qe.toFixed(2)} من الدرج`}),ae(!1),Ge(""),ne("")}catch{M({title:"فشل الخصم",description:"تعذر تنفيذ عملية الخصم",variant:"destructive"})}};return e.jsx(ve,{open:i,onOpenChange:p,children:e.jsxs(we,{className:"sm:max-w-lg animate-in fade-in-90 zoom-in-95 slide-in-from-top-4",dir:"rtl",children:[e.jsx(Ie,{children:e.jsxs(Ne,{className:"flex items-center gap-2 text-right",children:[e.jsx(es,{className:"h-5 w-5 text-emerald-600"}),"تفاصيل الفلوس النقدية"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between bg-amber-50 border border-amber-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 font-bold text-sm",children:[e.jsx(es,{className:"h-4 w-4"}),"مجموع الفلوس النقدية (الدرج)"]}),e.jsx("div",{className:"text-amber-700 font-extrabold text-sm",children:oe(k)})]}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 font-bold text-sm",children:[e.jsx(Ed,{className:"h-4 w-4"}),"فلوس الاكسسوار"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-blue-700 font-extrabold text-sm",children:oe(ze)}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800",onClick:()=>{pe("accessory"),Y(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-emerald-50 border border-emerald-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-800 font-bold text-sm",children:[e.jsx(go,{className:"h-4 w-4"}),"فلوس الصيانة"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-emerald-700 font-extrabold text-sm",children:oe(yt)}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800",onClick:()=>{pe("maintenance"),Y(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-red-800 font-bold text-sm",children:"خصم فلوس من الفلوس النقديه"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(x,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800",onClick:$t,children:"خصم"})})]})]}),e.jsx(Is,{open:$,onOpenChange:Y,mode:"verify",title:"تأكيد الرقم السري لعملية تم الاستلام",description:"يرجى إدخال الرقم السري الرئيسي لتأكيد استلام المبلغ",onSuccess:()=>{re&&(bt(re),pe(null)),Y(!1)}}),e.jsx(ve,{open:_e,onOpenChange:Se,children:e.jsxs(we,{className:"sm:max-w-sm",children:[e.jsx(Ie,{children:e.jsx(Ne,{children:"سبب الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"deduct-reason",children:"اكتب سبب الخصم"}),e.jsx(q,{id:"deduct-reason",value:xe,onChange:qe=>ne(qe.target.value),placeholder:"سبب الخصم"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(x,{variant:"outline",onClick:()=>Se(!1),children:"إلغاء"}),e.jsx(x,{onClick:Ht,className:"bg-red-600 hover:bg-red-700",children:"متابعة"})]})]})}),e.jsx(Is,{open:Le,onOpenChange:H,mode:"verify",title:"تأكيد الرقم السري لعملية الخصم",description:"يرجى إدخال الرقم السري الرئيسي لمتابعة الخصم",onSuccess:ts}),e.jsx(ve,{open:te,onOpenChange:ae,children:e.jsxs(we,{className:"sm:max-w-sm",children:[e.jsx(Ie,{children:e.jsx(Ne,{children:"مبلغ الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"deduct-amount",children:"أدخل مبلغ الخصم"}),e.jsx(q,{id:"deduct-amount",type:"number",value:Be,onChange:qe=>Ge(qe.target.value),placeholder:"0.00"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(x,{variant:"outline",onClick:()=>ae(!1),children:"إلغاء"}),e.jsx(x,{onClick:Wt,className:"bg-red-600 hover:bg-red-700",children:"تأكيد الخصم"})]})]})})]})})};function Md({size:i=24,className:p,...c}){return e.jsxs("svg",{width:i,height:i,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:p,...c,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}var Ld="AlertDialog",[Kx]=fu(Ld,[Nd]),Ua=Nd(),$d=i=>{const{__scopeAlertDialog:p,...c}=i,w=Ua(p);return e.jsx(xu,{...w,...c,modal:!0})};$d.displayName=Ld;var Yx="AlertDialogTrigger",Hx=n.forwardRef((i,p)=>{const{__scopeAlertDialog:c,...w}=i,S=Ua(c);return e.jsx(Su,{...S,...w,ref:p})});Hx.displayName=Yx;var Qx="AlertDialogPortal",Wd=i=>{const{__scopeAlertDialog:p,...c}=i,w=Ua(p);return e.jsx(pu,{...w,...c})};Wd.displayName=Qx;var Gx="AlertDialogOverlay",Fd=n.forwardRef((i,p)=>{const{__scopeAlertDialog:c,...w}=i,S=Ua(c);return e.jsx(ju,{...S,...w,ref:p})});Fd.displayName=Gx;var Hr="AlertDialogContent",[Zx,Xx]=Kx(Hr),ep=vu("AlertDialogContent"),Rd=n.forwardRef((i,p)=>{const{__scopeAlertDialog:c,children:w,...S}=i,C=Ua(c),s=n.useRef(null),b=jd(p,s),F=n.useRef(null);return e.jsx(gu,{contentName:Hr,titleName:Bd,docsSlug:"alert-dialog",children:e.jsx(Zx,{scope:c,cancelRef:F,children:e.jsxs(yu,{role:"alertdialog",...C,...S,ref:b,onOpenAutoFocus:bu(S.onOpenAutoFocus,D=>{var E;D.preventDefault(),(E=F.current)==null||E.focus({preventScroll:!0})}),onPointerDownOutside:D=>D.preventDefault(),onInteractOutside:D=>D.preventDefault(),children:[e.jsx(ep,{children:w}),e.jsx(sp,{contentRef:s})]})})})});Rd.displayName=Hr;var Bd="AlertDialogTitle",Ud=n.forwardRef((i,p)=>{const{__scopeAlertDialog:c,...w}=i,S=Ua(c);return e.jsx(wu,{...S,...w,ref:p})});Ud.displayName=Bd;var qd="AlertDialogDescription",zd=n.forwardRef((i,p)=>{const{__scopeAlertDialog:c,...w}=i,S=Ua(c);return e.jsx(Nu,{...S,...w,ref:p})});zd.displayName=qd;var tp="AlertDialogAction",Vd=n.forwardRef((i,p)=>{const{__scopeAlertDialog:c,...w}=i,S=Ua(c);return e.jsx(Sd,{...S,...w,ref:p})});Vd.displayName=tp;var Jd="AlertDialogCancel",Kd=n.forwardRef((i,p)=>{const{__scopeAlertDialog:c,...w}=i,{cancelRef:S}=Xx(Jd,c),C=Ua(c),s=jd(p,S);return e.jsx(Sd,{...C,...w,ref:s})});Kd.displayName=Jd;var sp=({contentRef:i})=>{const p=`\`${Hr}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${Hr}\` by passing a \`${qd}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${Hr}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return n.useEffect(()=>{var w;document.getElementById((w=i.current)==null?void 0:w.getAttribute("aria-describedby"))||console.warn(p)},[p,i]),null},ap=$d,rp=Wd,Yd=Fd,Hd=Rd,Qd=Vd,Gd=Kd,Zd=Ud,Xd=zd;const np=ap,ip=rp,em=n.forwardRef(({className:i,...p},c)=>e.jsx(Yd,{className:ws("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",i),...p,ref:c}));em.displayName=Yd.displayName;const tm=n.forwardRef(({className:i,...p},c)=>e.jsxs(ip,{children:[e.jsx(em,{}),e.jsx(Hd,{ref:c,className:ws("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg rounded-2xl duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",i),...p})]}));tm.displayName=Hd.displayName;const sm=({className:i,...p})=>e.jsx("div",{className:ws("flex flex-col space-y-2 text-center sm:text-left",i),...p});sm.displayName="AlertDialogHeader";const am=n.forwardRef(({className:i,...p},c)=>e.jsx(Zd,{ref:c,className:ws("text-lg font-semibold",i),...p}));am.displayName=Zd.displayName;const rm=n.forwardRef(({className:i,...p},c)=>e.jsx(Xd,{ref:c,className:ws("text-sm text-muted-foreground",i),...p}));rm.displayName=Xd.displayName;const uo=n.forwardRef(({className:i,...p},c)=>e.jsx(Qd,{ref:c,className:ws(Dd(),i),...p}));uo.displayName=Qd.displayName;const nm=n.forwardRef(({className:i,...p},c)=>e.jsx(Gd,{ref:c,className:ws(Dd({variant:"outline"}),"mt-2 sm:mt-0",i),...p}));nm.displayName=Gd.displayName;const Bt=i=>{try{return i.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(i)}},gd=i=>{try{return(i?new Date(i):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},Fa="machine_daily_opening_values",Ra="machine_daily_opening_snapshot";function lp({open:i,onOpenChange:p}){const{toast:c}=ua(),{shiftUser:w}=$n(),{shopId:S,shopName:C}=Li(),s=()=>{try{const T=Object.keys(localStorage||{}).filter(ie=>ie.startsWith("selectedShopId_"));for(const ie of T){const Ee=localStorage.getItem(ie);if(Ee)return Ee}return null}catch{return null}};n.useEffect(()=>{try{if(i){const T=document.body.style.overflow;document.body.setAttribute("data-prev-overflow",T),document.body.style.overflow="hidden"}else{const T=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=T,document.body.removeAttribute("data-prev-overflow")}}catch{}return()=>{try{const T=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=T,document.body.removeAttribute("data-prev-overflow")}catch{}}},[i]);const[b,F]=n.useState(""),[D,E]=n.useState(""),[O,y]=n.useState(""),[N,k]=n.useState(null),[K,$]=n.useState(null),[Y,re]=n.useState(null),[pe,M]=n.useState(null),[W,le]=n.useState(!1),[_e,Se]=n.useState(!1),[xe,ne]=n.useState(""),[Le,H]=n.useState(""),[te,ae]=n.useState(null),[Be,Ge]=n.useState([]),[Q,oe]=n.useState([]),[ze,yt]=n.useState(!1),[bt,$t]=n.useState(""),[Ht,ts]=n.useState(""),[Wt,qe]=n.useState(!1),[rt,lt]=n.useState(null),[$e,Qe]=n.useState([]),[ee,_t]=n.useState(null),[ss,as]=n.useState(""),[B,De]=n.useState(!1),[Fe,jt]=n.useState(!1);n.useEffect(()=>{if(i)try{const T=ee?`${Fa}_${ee}`:Fa,ie=ee?`${Ra}_${ee}`:Ra,Ee=localStorage.getItem(T);if(Ee){const Me=JSON.parse(Ee);typeof(Me==null?void 0:Me.openingBase)=="number"&&k(Me.openingBase),typeof(Me==null?void 0:Me.openingAir)=="number"&&$(Me.openingAir),typeof(Me==null?void 0:Me.drawerCash)=="number"&&re(Me.drawerCash)}else k(null),$(null),re(null);const He=localStorage.getItem(ie);if(He){const Me=JSON.parse(He);typeof(Me==null?void 0:Me.openingBase)=="number"&&typeof(Me==null?void 0:Me.openingAir)=="number"?M({openingBase:Me.openingBase,openingAir:Me.openingAir,drawerCash:Me.drawerCash||0}):M(null)}else M(null)}catch{}},[i,ee]),n.useEffect(()=>{(async()=>{try{const T=S||s();if(!i||!T)return;const{getDocs:ie}=await xt(async()=>{const{getDocs:nt}=await import("./index-BwuekbvX.js").then(G=>G.ci);return{getDocs:nt}},__vite__mapDeps([0,1]),import.meta.url),Ee=je(U,"shops",T,"machines"),Me=(await ie(Je(Ee))).docs.map(nt=>({id:nt.id,name:String(nt.data().name||"ماكينة")}));Qe(Me);try{const nt=localStorage.getItem(`machineDaily_selected_${T}`);nt&&Me.some(ot=>ot.id===nt)?_t(nt):!ee&&Me.length>0&&(_t(Me[0].id),localStorage.setItem(`machineDaily_selected_${T}`,Me[0].id))}catch{}}catch(T){console.error("Load machines error:",T)}})()},[i,S]);const gt=n.useMemo(()=>(w==null?void 0:w.displayName)||(w==null?void 0:w.name)||(w==null?void 0:w.username)||void 0,[w]),Tt=n.useMemo(()=>Q.reduce((T,ie)=>T+(ie.profit||0),0),[Q]),xs=n.useMemo(()=>Q.reduce((T,ie)=>T+(ie.wholesalePrice||0),0),[Q]),vt=async()=>{try{const T=S||s();if(T&&ee){const ie=je(U,"shops",T,"machines",ee,"transfers"),Ee=await Re(Je(ie));await Promise.all(Ee.docs.map(He=>va(He.ref)));try{localStorage.setItem(`machineDaily_transfers_${T}_${ee}`,JSON.stringify([]))}catch{}}}catch{}oe([]),c({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."})},it=async()=>{try{const T=S||s();if(T&&ee){const ie=je(U,"shops",T,"machines",ee,"deliveries"),Ee=await Re(Je(ie));await Promise.all(Ee.docs.map(He=>va(He.ref)));try{localStorage.setItem(`machineDaily_deliveries_${T}_${ee}`,JSON.stringify([]))}catch{}}}catch{}Ge([]),c({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."})},Et=T=>{Ge(ie=>ie.filter(Ee=>Ee.id!==T)),c({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},us=()=>{k(null),$(null),re(null),M(null),F(""),E(""),y("");try{const T=ee?`${Fa}_${ee}`:Fa,ie=ee?`${Ra}_${ee}`:Ra;localStorage.removeItem(T),localStorage.removeItem(ie)}catch{}c({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},kt=async()=>{var He;const T=parseFloat(b||"0"),ie=parseFloat(D||"0"),Ee=parseFloat(O||"0");if(isNaN(T)||isNaN(ie)||isNaN(Ee)){c({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(T<0||ie<0||Ee<0){c({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}k(T),$(ie),re(Ee);try{const Me=ee?`${Fa}_${ee}`:Fa,nt=ee?`${Ra}_${ee}`:Ra;localStorage.setItem(Me,JSON.stringify({openingBase:T,openingAir:ie,drawerCash:Ee})),localStorage.setItem(nt,JSON.stringify({openingBase:T,openingAir:ie,drawerCash:Ee})),M({openingBase:T,openingAir:ie,drawerCash:Ee});const G=S||s();if(G&&ee){const ot=Oe(U,"shops",G,"machines",ee);await As(ot,{name:((He=$e.find(mt=>mt.id===ee))==null?void 0:He.name)||"ماكينة",openingBase:T,openingAir:ie,drawerCash:Ee,cashierName:gt,shopName:C||null,updatedAt:dt()},{merge:!0})}}catch{}c({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${Bt(T)}، الهواء: ${Bt(ie)}، فلوس الدرج: ${Bt(Ee)}`})},$s=()=>{if(N==null||K==null){c({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}Se(!0)},Gs=()=>{const T=parseFloat(xe||"0"),ie=parseFloat(Le||"0");if(isNaN(T)||isNaN(ie)){c({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(T<0||ie<0){c({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const Ee=(pe==null?void 0:pe.openingBase)??(N||0),He=(pe==null?void 0:pe.openingAir)??(K||0),Me=Ee+He,G=T+ie-Me;ae(G);const ot={id:`${Date.now()}`,openingBase:Ee,openingAir:He,deliveryBase:T,deliveryAir:ie,netResult:G,createdAt:new Date().toISOString(),cashierName:gt,requiredDrawerNoProfit:G<0?Math.round(-G*100)/100:0};(async()=>{try{const mt=S||s();mt&&ee&&(await Ta(je(U,"shops",mt,"machines",ee,"deliveries"),{cashierName:gt,openingBase:Ee,openingAir:He,deliveryBase:T,deliveryAir:ie,netResult:G,createdAt:dt()}),await As(Oe(U,"shops",mt,"machines",ee),{lastDeliveryAt:dt(),updatedAt:dt()},{merge:!0}))}catch(mt){console.error("Persist delivery error:",mt)}})(),Ge(mt=>[ot,...mt]);try{const mt=S||s(),ps=mt&&ee?`machineDaily_deliveries_${mt}_${ee}`:`machineDaily_deliveries_${ee}`,rs=localStorage.getItem(ps),ns=rs?JSON.parse(rs):[],V=[ot,...Array.isArray(ns)?ns:[]];localStorage.setItem(ps,JSON.stringify(V))}catch{}c({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${Bt(G)}`})},Na=()=>{const T=parseFloat(bt||"0"),ie=parseFloat(Ht||"0");if(!Number.isFinite(T)||!Number.isFinite(ie)){c({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if(T<0||ie<0){c({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(N==null||K==null){c({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const Ee=Math.round((ie-T)*100)/100;lt({wholesalePrice:T,retailPrice:ie,profit:Ee}),qe(!0)},Ts=async T=>{if(!rt)return;const ie={id:`transfer_${Date.now()}`,wholesalePrice:rt.wholesalePrice,retailPrice:rt.retailPrice,profit:rt.profit,createdAt:new Date().toISOString(),cashierName:gt,deductFrom:T},Ee=rt.wholesalePrice,He=N??0,Me=K??0,nt=Y??0;if(Ee>(T==="base"?He:Me)){c({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const ot=T==="base"?Math.round((He-Ee)*100)/100:He,mt=T==="air"?Math.round((Me-Ee)*100)/100:Me,ps=rt.retailPrice,rs=Math.round((nt+ps)*100)/100;k(ot),$(mt),re(rs);try{const ns=ee?`${Fa}_${ee}`:Fa,V=ee?`${Ra}_${ee}`:Ra;localStorage.setItem(ns,JSON.stringify({openingBase:ot,openingAir:mt,drawerCash:rs})),localStorage.setItem(V,JSON.stringify({openingBase:ot,openingAir:mt,drawerCash:rs}));const is=S||s();if(is&&ee){const na=Oe(U,"shops",is,"machines",ee);await As(na,{openingBase:ot,openingAir:mt,drawerCash:rs,cashierName:gt,updatedAt:dt()},{merge:!0}),await Ta(je(U,"shops",is,"machines",ee,"transfers"),{wholesalePrice:rt.wholesalePrice,retailPrice:rt.retailPrice,profit:rt.profit,deductFrom:T,cashierName:gt,createdAt:dt()})}}catch{}oe(ns=>[ie,...ns]);try{const ns=S||s(),V=ns&&ee?`machineDaily_transfers_${ns}_${ee}`:"machineDaily_transfers",is=localStorage.getItem(V),na=is?JSON.parse(is):[],ja=[ie,...Array.isArray(na)?na:[]];localStorage.setItem(V,JSON.stringify(ja))}catch{}yt(!1),$t(""),ts(""),lt(null),qe(!1),c({title:"تم تسجيل تحويل",description:`الربح الفوري: ${Bt(ie.profit)} | خصم المخزون: -${Bt(Ee)} (${T==="base"?"الأساسي":"الهواء"}) | درج (المباع فقط): +${Bt(ps)}`})},qa=()=>{F(""),E(""),Se(!1),ne(""),H(""),ae(null)},Zs=async()=>{if(!i||!ee)return;const T=S||s();if(T){try{const ie=je(U,"shops",T,"machines",ee,"deliveries"),Me=[...(await Re(Je(ie))).docs.map(nt=>{var mt,ps;const G=nt.data(),ot=(ps=(mt=G==null?void 0:G.createdAt)==null?void 0:mt.toDate)!=null&&ps.call(mt)?G.createdAt.toDate():new Date;return{id:nt.id,openingBase:Number((G==null?void 0:G.openingBase)||0),openingAir:Number((G==null?void 0:G.openingAir)||0),deliveryBase:Number((G==null?void 0:G.deliveryBase)||0),deliveryAir:Number((G==null?void 0:G.deliveryAir)||0),netResult:typeof(G==null?void 0:G.netResult)=="number"?Number(G.netResult):Math.round((Number((G==null?void 0:G.deliveryBase)||0)+Number((G==null?void 0:G.deliveryAir)||0)-(Number((G==null?void 0:G.openingBase)||0)+Number((G==null?void 0:G.openingAir)||0)))*100)/100,createdAt:ot.toISOString(),cashierName:(G==null?void 0:G.cashierName)||void 0,requiredDrawerNoProfit:typeof(G==null?void 0:G.requiredDrawerNoProfit)=="number"?G.requiredDrawerNoProfit:void 0}})].sort((nt,G)=>new Date(G.createdAt).getTime()-new Date(nt.createdAt).getTime());Ge(Me);try{localStorage.setItem(`machineDaily_deliveries_${T}_${ee}`,JSON.stringify(Me))}catch{}}catch(ie){console.error("Error fetching deliveries:",ie)}try{const ie=je(U,"shops",T,"machines",ee,"transfers"),Me=[...(await Re(Je(ie))).docs.map(nt=>{var ps,rs;const G=nt.data(),ot=(rs=(ps=G==null?void 0:G.createdAt)==null?void 0:ps.toDate)!=null&&rs.call(ps)?G.createdAt.toDate():new Date,mt=G==null?void 0:G.deductFrom;return{id:nt.id,wholesalePrice:Number((G==null?void 0:G.wholesalePrice)||0),retailPrice:Number((G==null?void 0:G.retailPrice)||0),profit:Number((G==null?void 0:G.profit)??(Number((G==null?void 0:G.retailPrice)||0)-Number((G==null?void 0:G.wholesalePrice)||0)||0)),createdAt:ot.toISOString(),cashierName:(G==null?void 0:G.cashierName)||void 0,deductFrom:mt==="base"||mt==="air"?mt:void 0}})].sort((nt,G)=>new Date(G.createdAt).getTime()-new Date(nt.createdAt).getTime());oe(Me);try{localStorage.setItem(`machineDaily_transfers_${T}_${ee}`,JSON.stringify(Me))}catch{}}catch(ie){console.error("Error fetching transfers:",ie)}c({title:"تم التحديث",description:"تم جلب أحدث البيانات."})}};n.useEffect(()=>{if(!i||!ee)return;const T=S||s();try{const ie=T?`machineDaily_deliveries_${T}_${ee}`:`machineDaily_deliveries_${ee}`,Ee=localStorage.getItem(ie);if(Ee){const nt=JSON.parse(Ee);Array.isArray(nt)&&Ge(nt)}const He=T?`machineDaily_transfers_${T}_${ee}`:`machineDaily_transfers_${ee}`,Me=localStorage.getItem(He);if(Me){const nt=JSON.parse(Me);Array.isArray(nt)&&oe(nt)}}catch{}Zs()},[i,S,ee]);const Vs=T=>{T||qa(),p(T)};return e.jsxs(ve,{open:i,onOpenChange:Vs,children:[e.jsxs(we,{className:"w-screen h-[100vh] overflow-hidden rounded-none p-0 flex flex-col dark:bg-[#121212]",children:[e.jsxs(Ie,{className:"sticky top-0 bg-white dark:bg-[#0F0F0F] z-20 border-b border-gray-200 dark:border-[#333] px-4 py-3",children:[e.jsx(Ne,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Md,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(hs,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"px-4 py-3 overflow-y-auto flex-1 grid grid-cols-1 gap-6",children:[e.jsxs(pt,{children:[e.jsx(Xt,{className:"pb-2",children:e.jsxs(vs,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"اختيار ماكينة"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(x,{variant:"destructive",onClick:async()=>{try{if(!S||!ee)return;const T=Oe(U,"shops",S,"machines",ee);try{const Ee=await Re(je(U,"shops",S,"machines",ee,"transfers"));await Promise.all(Ee.docs.map(He=>va(He.ref)))}catch{}try{const Ee=await Re(je(U,"shops",S,"machines",ee,"deliveries"));await Promise.all(Ee.docs.map(He=>va(He.ref)))}catch{}await va(T),Qe(Ee=>Ee.filter(He=>He.id!==ee));const ie=$e.find(Ee=>Ee.id!==ee);_t(ie?ie.id:null);try{const Ee=`${Fa}_${ee}`,He=`${Ra}_${ee}`;localStorage.removeItem(Ee),localStorage.removeItem(He)}catch{}c({title:"تم حذف الماكينة",description:"تمت الإزالة نهائيًا."})}catch{c({title:"فشل الحذف",description:"تعذر حذف الماكينة.",variant:"destructive"})}},disabled:!ee,title:"حذف الماكينة",children:e.jsx(bs,{className:"h-4 w-4"})})})]})}),e.jsx(Nt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الماكينة الحالية"}),e.jsxs(tr,{value:ee??"",onValueChange:T=>{_t(T);try{const ie=S||s();ie&&localStorage.setItem(`machineDaily_selected_${ie}`,T)}catch{}},children:[e.jsx(sr,{className:"text-right",children:e.jsx(ar,{placeholder:"اختر ماكينة"})}),e.jsx(rr,{children:$e.map(T=>e.jsx(fa,{value:T.id,children:T.name},T.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"إنشاء ماكينة جديدة"}),e.jsx(q,{value:ss,onChange:T=>as(T.target.value),placeholder:"اسم الماكينة",className:"text-right"})]}),e.jsx("div",{className:"flex justify-end md:justify-start",children:e.jsx(x,{onClick:async()=>{try{if(!S){c({title:"لا يوجد محل",description:"يرجى التأكد من تحميل بيانات المحل.",variant:"destructive"});return}const T=(ss||"").trim();if(!T){c({title:"اسم الماكينة مطلوب",description:"أدخل اسم للماكينة الجديدة.",variant:"destructive"});return}const ie=await Ta(je(U,"shops",S,"machines"),{name:T,shopId:S,createdAt:dt(),updatedAt:dt(),isActive:!0}),Ee={id:ie.id,name:T};Qe(He=>[Ee,...He]),_t(ie.id),as(""),c({title:"تم إنشاء ماكينة",description:`تمت إضافة ${T}`})}catch(T){console.error("Create machine error:",T),c({title:"خطأ في الإنشاء",description:"تعذر إنشاء الماكينة.",variant:"destructive"})}},className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})})]})]})})]}),e.jsxs(pt,{children:[e.jsx(Xt,{className:"pb-2",children:e.jsxs(vs,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>le(T=>!T),className:"flex items-center gap-1",children:e.jsx(En,{className:`h-4 w-4 transition-transform ${W?"rotate-180":""}`})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(x,{variant:"outline",onClick:()=>yt(!0),disabled:N==null||K==null,className:"border-violet-300 text-violet-700",children:"تحويل"})}),N!=null&&K!=null&&e.jsxs(Lt,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",Bt(N)," | هواء ",Bt(K)," | درج ",Bt(Y??0)]})]}),e.jsxs(Nt,{className:`space-y-4 ${W?"":"hidden"}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:b,onChange:T=>F(T.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:D,onChange:T=>E(T.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:O,onChange:T=>y(T.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(x,{variant:"outline",className:"mr-2",onClick:us,children:"تصفير"}),e.jsx(x,{onClick:kt,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),e.jsxs(pt,{children:[e.jsx(Xt,{className:"pb-2",children:e.jsxs(vs,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات تحويل"}),e.jsxs(Lt,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",Bt(Tt)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:vt,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(ba,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Nt,{className:"space-y-3",children:Q.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-3 max-h-52 overflow-y-auto pr-1",children:Q.map(T=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر الجملة"}),e.jsx("p",{className:"text-sm",children:Bt(T.wholesalePrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر التجزئة"}),e.jsx("p",{className:"text-sm",children:Bt(T.retailPrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الربح الفوري"}),e.jsx("p",{className:"text-sm text-green-700",children:Bt(T.profit)}),T.deductFrom&&e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"text-[11px] bg-violet-100 text-violet-700 border border-violet-200 rounded px-2 py-0.5",children:["الخصم من: ",T.deductFrom==="base"?"الأساسي":"الهواء"]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(vr,{className:"h-3 w-3"}),e.jsx("span",{children:gd(T.createdAt)}),T.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Ei,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",T.cashierName]})]})]})]})]},T.id))})})]}),e.jsxs(pt,{children:[e.jsx(Xt,{className:"pb-2",children:e.jsx(vs,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(Nt,{className:"space-y-4",children:_e?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:xe,onChange:T=>ne(T.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Le,onChange:T=>H(T.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>Se(!1),children:"إلغاء"}),e.jsx(x,{onClick:Gs,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),te!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(Lt,{className:te>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",Bt(te)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(Lt,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",Bt(parseFloat(xe||"0")+parseFloat(Le||"0"))]}),e.jsxs(Lt,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",Bt(xs)]})]})]})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(x,{variant:"outline",onClick:$s,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs(pt,{children:[e.jsx(Xt,{className:"pb-2",children:e.jsxs(vs,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:it,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(ba,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Nt,{className:"space-y-3",children:Be.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:Be.map(T=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Bt(T.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Bt(T.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Bt(T.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Bt(T.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>Et(T.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(bs,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${T.netResult>=0?"text-green-700":"text-red-700"}`,children:Bt(T.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",Bt(T.deliveryBase+T.deliveryAir)]}),typeof T.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",Bt(T.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(vr,{className:"h-3 w-3"}),e.jsx("span",{children:gd(T.createdAt)}),T.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Ei,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",T.cashierName]})]})]})]})]},T.id))})})]})]}),e.jsxs(et,{className:"sticky bottom-0 bg-white dark:bg-[#0F0F0F] z-20 border-t border-gray-200 dark:border-[#333] px-4 py-3 flex items-center justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>Vs(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(Ba,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(ve,{open:ze,onOpenChange:yt,children:e.jsxs(we,{className:"sm:max-w-sm",children:[e.jsx(Ie,{children:e.jsx(Ne,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:bt,onChange:T=>$t(T.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Ht,onChange:T=>ts(T.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(Lt,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",Bt(parseFloat(Ht||"0")-parseFloat(bt||"0")||0)]})})]}),e.jsxs(et,{className:"flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>yt(!1),children:"إلغاء"}),e.jsx(x,{onClick:Na,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(np,{open:Wt,onOpenChange:qe,children:e.jsxs(tm,{children:[e.jsxs(sm,{children:[e.jsx(am,{children:"اختيار مصدر الخصم"}),e.jsx(rm,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(nm,{onClick:()=>qe(!1),children:"رجوع"}),e.jsx(uo,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>Ts("base"),children:"خصم من الأساسي"}),e.jsx(uo,{className:"bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>Ts("air"),children:"خصم من الهواء"})]})]})})]})}function op(i,p=300){const[c,w]=Ke.useState(i);return Ke.useEffect(()=>{const S=setTimeout(()=>w(i),p);return()=>clearTimeout(S)},[i,p]),c}const cp=({userId:i,transactions:p})=>{const[c,w]=n.useState(!1),[S,C]=n.useState(!1),[s,b]=n.useState(!1),[F,D]=n.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:E}=Pa();n.useEffect(()=>{i&&c&&s&&O()},[i,c,s]);const O=async()=>{if(i)try{if(Array.isArray(p)&&p.length>0){const Y=new Date,re=Y.getMonth(),pe=Y.getFullYear(),M=Bs.filterVisibleTransactions(p,"monthly",i);let W=0,le=0;M.forEach(_e=>{const Se=new Date(_e.createdAt),xe=String(_e.status||"confirmed").toLowerCase();if(Se.getMonth()!==re||Se.getFullYear()!==pe||xe!=="completed"&&xe!=="confirmed")return;const ne=(_e.type||_e.txnType||"").toLowerCase(),Le={type:ne==="withdrawal"?"withdraw":ne,amount:Number(_e.amount||0),commission:_e.commission};Le.type==="withdraw"?W+=ir.calculateProfitFromTransaction(Le):(Le.type==="send"||Le.type==="receive"||Le.type==="transfer")&&(le+=ir.calculateProfitFromTransaction(Le))}),D({monthlyWithdrawalProfit:Math.round(W*100)/100,monthlyTransferProfit:Math.round(le*100)/100,lastUpdated:new Date});return}const $=ir.getWithdrawTransferProfits(i);D({monthlyWithdrawalProfit:$.monthlyWithdrawProfit||0,monthlyTransferProfit:$.monthlyTransferProfit||0,lastUpdated:new Date})}catch($){console.error("Error loading profit data:",$)}},y=$=>`${$.toFixed(2)} ج.م`,N=async()=>{try{const $=(E==null?void 0:E.subscription)||null,Y=($==null?void 0:$.planType)??($==null?void 0:$.plan)??null,re=typeof Y=="string"?Y.toLowerCase():null;if(Y===Hs.ZERO||re==="zero"||re==="0"||Y===0)return!0}catch{}try{if(i){const $=await xo(i),Y=($==null?void 0:$.planType)??($==null?void 0:$.plan)??null,re=typeof Y=="string"?Y.toLowerCase():null;if(Y===Hs.ZERO||re==="zero"||re==="0"||Y===0)return!0}}catch{}return!1},k=async()=>{try{if(await N()){ed({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}C(!0)},K=async()=>{try{if(await N()){ed({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),C(!1);return}}catch{}b(!0),w(!0),C(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:k,className:"h-6 w-6 p-0 text-gray-400 hover:text-purple-600 hover:bg-purple-50 rounded-full transition-colors duration-200",title:"عرض الأرباح الشهرية",children:e.jsx(Ns,{className:"h-4 w-4"})}),e.jsx(ve,{open:c,onOpenChange:w,children:e.jsxs(we,{className:"max-w-[280px] sm:max-w-[320px] mx-auto bg-white border border-gray-200 shadow-xl rounded-xl p-0 overflow-hidden",children:[e.jsx(Ie,{className:"bg-gray-50 px-4 py-3 border-b border-gray-100",children:e.jsxs(Ne,{className:"text-sm font-bold text-gray-900 flex items-center justify-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-white rounded-full border border-gray-200",children:e.jsx(vr,{className:"h-4 w-4 text-purple-600"})}),"أرباح الشهر"]})}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg border border-gray-100 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-red-50 rounded-md",children:e.jsx(Jr,{className:"h-3.5 w-3.5 text-red-600"})}),e.jsx("span",{className:"font-medium text-gray-700 text-sm",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-gray-900",children:y(F.monthlyWithdrawalProfit)})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg border border-gray-100 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-green-50 rounded-md",children:e.jsx(go,{className:"h-3.5 w-3.5 text-green-600"})}),e.jsx("span",{className:"font-medium text-gray-700 text-sm",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-gray-900",children:y(F.monthlyTransferProfit)})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-purple-50 rounded-lg border border-purple-100 mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-white rounded-md shadow-sm",children:e.jsx(es,{className:"h-3.5 w-3.5 text-purple-600"})}),e.jsx("span",{className:"font-bold text-purple-900 text-sm",children:"الإجمالي"})]}),e.jsx("span",{className:"font-bold text-base text-purple-700",children:y(F.monthlyWithdrawalProfit+F.monthlyTransferProfit)})]})]}),e.jsx("div",{className:"bg-gray-50 px-4 py-3 border-t border-gray-100 flex justify-center",children:e.jsx(x,{onClick:()=>w(!1),className:"bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 hover:text-gray-900 w-full sm:w-auto px-8 rounded-lg text-sm font-medium shadow-sm",children:"إغلاق"})})]})}),e.jsx(Is,{open:S,onOpenChange:C,onSuccess:K,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},dp=i=>e.jsx(cp,{...i});function mp({open:i,onOpenChange:p,onSuccess:c,userId:w}){const[S,C]=n.useState(""),[s,b]=n.useState(""),[F,D]=n.useState(!1),[E,O]=n.useState(!1),[y,N]=n.useState(""),[k,K]=n.useState(!1),[$,Y]=n.useState(!1),{toast:re}=ua();n.useEffect(()=>{let W=!0;return(async()=>{const le=await Ms.hasMasterPin(w);W&&Y(le)})(),()=>{W=!1}},[w,i]);const pe=()=>{C(""),b(""),N(""),D(!1),O(!1),p(!1)},M=async W=>{W.preventDefault(),N(""),K(!0);try{if($){if(!await Ms.verifyMasterPin(S,w)){N("الرقم السري غير صحيح"),K(!1);return}}else{if(S.length<4){N("يجب أن يكون الرقم السري 4 أرقام على الأقل"),K(!1);return}if(S!==s){N("الرقم السري غير متطابق"),K(!1);return}if(!await Ms.createMasterPin(S,w)){N("تعذر إنشاء الرقم السري الرئيسي"),K(!1);return}}re({title:"نجح العملية",description:$?"تم التحقق من الرقم السري الرئيسي بنجاح":"تم إنشاء الرقم السري الرئيسي بنجاح"}),c(),pe()}catch{N("حدث خطأ أثناء معالجة الرقم السري")}finally{K(!1)}};return e.jsx(ve,{open:i,onOpenChange:p,children:e.jsxs(we,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Ie,{children:e.jsxs(Ne,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(wa,{className:"h-5 w-5 text-green-600"}),$?"أدخل الرقم السري الرئيسي":"إنشاء الرقم السري الرئيسي"]})}),e.jsxs("form",{onSubmit:M,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:$?"أدخل الرقم السري الرئيسي لعرض بيانات الأرباح":"قم بإنشاء الرقم السري الرئيسي لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"pin",children:$?"الرقم السري الرئيسي":"الرقم السري الرئيسي الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"pin",type:F?"text":"password",value:S,onChange:W=>C(W.target.value),placeholder:$?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>D(!F),children:F?e.jsx(Qs,{className:"h-4 w-4"}):e.jsx(Ns,{className:"h-4 w-4"})})]})]}),!$&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:E?"text":"password",value:s,onChange:W=>b(W.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>O(!E),children:E?e.jsx(Qs,{className:"h-4 w-4"}):e.jsx(Ns,{className:"h-4 w-4"})})]})]}),y&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(wr,{className:"h-4 w-4"}),y]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:k,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(wa,{className:"h-4 w-4 mr-2"}),k?"جاري المعالجة...":$?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(x,{type:"button",variant:"outline",onClick:pe,disabled:k,children:"إلغاء"})]})]})]})})}const hp=({userId:i,transactions:p})=>{const[c,w]=n.useState(!1),[S,C]=n.useState(!1),[s,b]=n.useState(!1),[F,D]=n.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});n.useEffect(()=>{i&&c&&s&&E()},[i,c,s,p]);const E=async()=>{if(i)try{if(Array.isArray(p)&&p.length>0){const K=new Date,$=Bs.filterVisibleTransactions(p,"daily",i);let Y=0,re=0;$.forEach(pe=>{const M=new Date(pe.createdAt),W=String(pe.status||"confirmed").toLowerCase();if(M.toDateString()!==K.toDateString())return;const le=(pe.type||pe.txnType||"").toLowerCase(),_e=String(pe.title||"");if(le==="cash_addition"||_e.includes("إيصال إضافة نقدية"))return;const Se={type:le==="withdrawal"?"withdraw":le,amount:Number(pe.amount||0),commission:pe.commission};Se.type==="withdraw"?Y+=ir.calculateProfitFromTransaction(Se):(Se.type==="send"||Se.type==="receive"||Se.type==="transfer")&&(re+=ir.calculateProfitFromTransaction(Se))}),D({dailyWithdrawalProfit:Math.round(Y*100)/100,dailyTransferProfit:Math.round(re*100)/100,lastUpdated:new Date});try{ir.updateProfitsFromTransactions(p,i)}catch{}return}const k=ir.getWithdrawTransferProfits(i);D({dailyWithdrawalProfit:k.dailyWithdrawProfit||0,dailyTransferProfit:k.dailyTransferProfit||0,lastUpdated:new Date})}catch(k){console.error("Error loading profit data:",k)}},O=k=>`${k.toFixed(2)} ج.م`,y=()=>{ir.hasProfitPin(i),C(!0)},N=()=>{b(!0),w(!0),C(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:y,className:"h-6 w-6 p-0 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors duration-200",title:"عرض الأرباح اليومية",children:e.jsx(Ns,{className:"h-4 w-4"})}),e.jsx(ve,{open:c,onOpenChange:w,children:e.jsxs(we,{className:"max-w-[280px] sm:max-w-[320px] mx-auto bg-white border border-gray-200 shadow-xl rounded-xl p-0 overflow-hidden",children:[e.jsx(Ie,{className:"bg-gray-50 px-4 py-3 border-b border-gray-100",children:e.jsxs(Ne,{className:"text-sm font-bold text-gray-900 flex items-center justify-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-white rounded-full border border-gray-200",children:e.jsx(es,{className:"h-4 w-4 text-blue-600"})}),"أرباح اليوم"]})}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg border border-gray-100 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-red-50 rounded-md",children:e.jsx(Jr,{className:"h-3.5 w-3.5 text-red-600"})}),e.jsx("span",{className:"font-medium text-gray-700 text-sm",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-gray-900",children:O(F.dailyWithdrawalProfit)})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg border border-gray-100 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-green-50 rounded-md",children:e.jsx(go,{className:"h-3.5 w-3.5 text-green-600"})}),e.jsx("span",{className:"font-medium text-gray-700 text-sm",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-gray-900",children:O(F.dailyTransferProfit)})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-100 mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-white rounded-md shadow-sm",children:e.jsx(es,{className:"h-3.5 w-3.5 text-blue-600"})}),e.jsx("span",{className:"font-bold text-blue-900 text-sm",children:"الإجمالي"})]}),e.jsx("span",{className:"font-bold text-base text-blue-700",children:O(F.dailyWithdrawalProfit+F.dailyTransferProfit)})]})]}),e.jsx("div",{className:"bg-gray-50 px-4 py-3 border-t border-gray-100 flex justify-center",children:e.jsx(x,{onClick:()=>w(!1),className:"bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 hover:text-gray-900 w-full sm:w-auto px-8 rounded-lg text-sm font-medium shadow-sm",children:"إغلاق"})})]})}),e.jsx(mp,{open:S,onOpenChange:C,onSuccess:N,userId:i})]})},up=i=>e.jsx(hp,{...i});function xp({isOpen:i,onClose:p,wallets:c,walletBalances:w,onSelectWallet:S,selectedWalletId:C}){const s=F=>{S(F),p()},b=Object.values(w).reduce((F,D)=>F+(Number(D)||0),0);return e.jsx(ve,{open:i,onOpenChange:p,children:e.jsxs(we,{className:"sm:max-w-md bg-gradient-to-br from-white to-gray-50 border-0 shadow-2xl",children:[e.jsx(Ie,{className:"space-y-4 pb-4 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-blue-100 rounded-full",children:e.jsx(ra,{className:"w-6 h-6 text-blue-600"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Ne,{className:"text-xl font-bold text-gray-900",children:"المحافظ المتاحة"}),e.jsxs("p",{className:"text-sm text-gray-500 font-medium",children:["إجمالي الرصيد: ",e.jsxs("span",{className:"text-blue-600 font-bold text-base",children:[b.toLocaleString("en-US")," جنيه"]})]})]})]})}),e.jsx(zu,{className:"max-h-[60vh] pr-4 -mr-4",children:e.jsx("div",{className:"grid gap-3 py-2",children:c.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200",children:e.jsx("p",{children:"لا توجد محافظ مضافة"})}):c.map(F=>{const D=w[F.id]||0,E=C===F.id;return e.jsxs("button",{onClick:()=>s(F.id),className:ws("w-full group relative flex items-center justify-between p-4 rounded-xl border-2 transition-all duration-200",E?"border-blue-500 bg-blue-50/50 shadow-md ring-1 ring-blue-200":"border-transparent bg-white hover:bg-gray-50 hover:border-gray-200 shadow-sm hover:shadow-md"),children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:ws("w-12 h-12 rounded-full flex items-center justify-center transition-colors",E?"bg-blue-100 text-blue-600":"bg-gray-100 text-gray-500 group-hover:bg-gray-200"),children:e.jsx(ra,{className:"w-6 h-6"})}),e.jsxs("div",{className:"flex flex-col items-start gap-1",children:[e.jsx("span",{className:ws("font-bold text-lg",E?"text-blue-900":"text-gray-900"),children:F.name}),e.jsxs("div",{className:"flex items-center gap-1.5 text-gray-500",children:[e.jsx(ka,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"text-sm font-medium dir-ltr",children:F.phone})]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsxs("span",{className:ws("font-extrabold text-lg",D>0?"text-emerald-600":"text-gray-400"),children:[D.toLocaleString("en-US"),e.jsx("span",{className:"text-xs mr-1 font-medium text-gray-400",children:"جنيه"})]}),E&&e.jsxs("div",{className:"flex items-center gap-1 text-xs font-bold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full",children:[e.jsx(Pn,{className:"w-3 h-3"}),"مختار"]})]})]},F.id)})})})]})})}const pp=({open:i,onOpenChange:p})=>{var pa;const{shiftUser:c,isShiftActive:w,shiftStartAt:S,setShiftUser:C,startShift:s,endShift:b}=$n(),{userSubscription:F,user:D,signIn:E,profile:O}=Pa(),{toast:y}=ua(),[N,k]=n.useState((c==null?void 0:c.name)||""),[K,$]=n.useState((c==null?void 0:c.username)||""),[Y,re]=n.useState(""),[pe,M]=n.useState(!1),[W,le]=n.useState(null),[_e,Se]=n.useState(""),[xe,ne]=n.useState(""),[Le,H]=n.useState(!1),[te,ae]=n.useState(null),[Be,Ge]=n.useState(""),[Q,oe]=n.useState(""),[ze,yt]=n.useState(!1),[bt,$t]=n.useState(!1),[Ht,ts]=n.useState({totalTransfers:0,totalWithdrawals:0}),[Wt,qe]=n.useState(null),[rt,lt]=n.useState(""),[$e,Qe]=n.useState(""),[ee,_t]=n.useState(0),[ss,as]=n.useState({}),[B,De]=n.useState(0),[Fe,jt]=n.useState(0),[gt,Tt]=n.useState({}),[xs,vt]=n.useState(""),[it,Et]=n.useState(!1),us=z=>{const Te={"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9","۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9","٫":".","،":".","٬":"."," ":""};return z.split("").map(ht=>Te[ht]??ht).join("")},kt=()=>`cashierUsers_${(D==null?void 0:D.uid)||"default"}`,[$s,Gs]=n.useState(()=>{try{let z=localStorage.getItem(kt());if(!z){const Te=localStorage.getItem("cashierUsers");Te&&(z=Te)}return z?JSON.parse(z):[]}catch{return[]}});n.useEffect(()=>{(async()=>{try{if(!(D!=null&&D.uid))return;const z=Oe(U,"profiles",D.uid,"cashierUsers","list"),Te=await Ls(z);if(Te.exists()){const ht=Te.data(),St=Array.isArray(ht==null?void 0:ht.users)?ht.users:[];St&&St.length>0&&Gs(St)}}catch{}})()},[D==null?void 0:D.uid]),n.useEffect(()=>{if(!(D!=null&&D.uid))return;(async()=>{try{const Te=Oe(U,"profiles",D.uid,"cashierUsers","list"),ht=await Ls(Te);if(ht.exists()){const St=ht.data(),ls=Array.isArray(St==null?void 0:St.users)?St.users:[];if(ls&&ls.length>0)Gs(ls);else try{const Ft=localStorage.getItem(kt()),os=Ft?JSON.parse(Ft):[];Gs(os)}catch{Gs([])}}}catch(Te){console.warn("Failed to fetch cashierUsers:",Te)}})()},[D==null?void 0:D.uid]);const Na=(pa=F==null?void 0:F.subscription)==null?void 0:pa.planType,Ts=Na==="yearly"?2:Na==="lifetime"?4:Number.POSITIVE_INFINITY;n.useEffect(()=>{try{localStorage.setItem(kt(),JSON.stringify($s));try{localStorage.removeItem("cashierUsers")}catch{}}catch{}(async()=>{try{if(!(D!=null&&D.uid))return;const z=Oe(U,"profiles",D.uid,"cashierUsers","list");await As(z,{users:$s},{merge:!0})}catch{}})()},[$s]);const[qa,Zs]=n.useState(!1),[Vs,T]=n.useState(""),[ie,Ee]=n.useState(null),[He,Me]=n.useState([]),[nt,G]=n.useState(!1),[ot,mt]=n.useState(null),[ps,rs]=n.useState(!1),[ns,V]=n.useState(!1),is=z=>{const Te=(c==null?void 0:c.username)===z;let ht=!1;try{ht=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(Te&&!(Te&&!w&&(xs==="الأدمن الرئيسي"||ht))){y({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const Ft=`هل أنت متأكد من حذف المستخدم ${z}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(Ft)&&(Gs(os=>os.filter(ia=>ia.username!==z)),Te&&C(null),y({title:"تم حذف المستخدم",description:z}))},na=()=>{if(!N.trim()||!K.trim()||!Y.trim())return;if($s.length>=Ts){y({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(Ts)?Ts:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const z={name:N.trim(),username:K.trim(),password:Y.trim()};Gs(Te=>[z,...Te]),k(""),$(""),re("")},ja=()=>{M(!0),le(null),ae(null),Ge(""),oe("")},xa=async()=>{try{let z=[];try{D!=null&&D.uid&&(z=await Ae.getUserTransactions(D.uid))}catch{}if(!z||z.length===0)try{const Ze=await Od({merchantUserId:D==null?void 0:D.uid,limit:200});z=(Ze==null?void 0:Ze.transactions)||[]}catch{}const Te=S?new Date(S):null,ht=new Date,St=Ze=>{const Dt=Ze.type,oa=Ze.txnType;return Dt==="withdraw"||Dt==="withdrawal"||Dt==="receive"||oa==="receive"},ls=Ze=>{const Dt=Ze.type,oa=Ze.txnType;return Dt==="send"||Dt==="transfer"||oa==="send"},Ft=Ze=>{if(!Ze)return null;if(Ze instanceof Date)return Ze;try{const Dt=new Date(Ze);return Number.isNaN(Dt.getTime())?null:Dt}catch{return null}},os=Ze=>{const Dt=Ft(Ze.createdAt||Ze.created_at||Ze.timestamp);return!Dt||Te&&Dt<Te?!1:Dt<=ht},ia=Ze=>Ze==="completed"||Ze==="confirmed",Nr=z.filter(Ze=>ia(Ze.status)&&os(Ze)),la=Nr.filter(Ze=>St(Ze)).reduce((Ze,Dt)=>{const oa=Dt.withdrawnAmount??Dt.receivedAmount??Dt.amount??0;return Ze+(Number(oa)||0)},0);return{totalTransfers:Nr.filter(Ze=>ls(Ze)).reduce((Ze,Dt)=>{const oa=Dt.sentAmount??Dt.transferredAmount??Dt.amount??0;return Ze+(Number(oa)||0)},0),totalWithdrawals:la}}catch{return{totalTransfers:0,totalWithdrawals:0}}};n.useEffect(()=>{if(bt){try{const z=localStorage.getItem("shiftInitialReceivedDrawerFunds");z!==null&&Qe(z)}catch{}try{const z=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(z!==null){const Te=parseFloat(z);_t(Number.isFinite(Te)?Te:0)}}catch{}}},[bt]),n.useEffect(()=>{pe&&(async()=>{try{const z=await xa();ts(z)}catch{}})()},[pe]),n.useEffect(()=>{if(!i&&!nt)return;(async()=>{try{const ht=((D!=null&&D.uid?await Ae.getUserTransactions(D.uid):[])||[]).filter(St=>(St==null?void 0:St.type)==="report"||((St==null?void 0:St.title)||"").includes("إيصال تسليم وردية"));ht.sort((St,ls)=>{const Ft=new Date(St.createdAt||0).getTime();return new Date(ls.createdAt||0).getTime()-Ft}),Me(ht)}catch{Me([])}})()},[i,bt,nt,D==null?void 0:D.uid]);const _a=async(z,Te,ht)=>{try{let St=0,ls=0;try{const os=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");St=Number.isFinite(os)?os:0}catch{}try{const os=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");ls=Number.isFinite(os)?os:0}catch{}const Ft={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(c==null?void 0:c.username)||"cashier",receiverPhone:xs||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(c==null?void 0:c.name)||(c==null?void 0:c.username)||null,deficit:Te,deficitAmount:Te?ht:0,shiftStartAt:S,receivedDrawerFunds:St,receivedWalletBalancesTotal:ls,receivedWalletBalances:ss,deliveredDrawerFunds:B||0,deliveredWalletBalancesTotal:Fe||0,deliveredWalletBalances:gt,shiftProfit:Math.round(((B||0)+(Fe||0)-(St+ls))*100)/100};D!=null&&D.uid&&await Ae.saveUserTransaction(D.uid,Ft),Me(os=>[Ft,...os||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(ve,{open:i,onOpenChange:p,children:e.jsxs(we,{className:"sm:max-w-md",children:[e.jsx(Ie,{children:e.jsx(Ne,{children:w?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),w?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[c==null?void 0:c.name," (",c==null?void 0:c.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),$s.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:$s.map((z,Te)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:z.name}),e.jsx("div",{className:"text-xs text-gray-500",children:z.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(x,{size:"sm",className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>{Ee(z),Zs(!0)},children:"دخول"}),e.jsx(x,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>is(z.username),children:"حذف"})]})]},Te))})]})]}),e.jsx(et,{className:"flex flex-wrap gap-2 justify-between",children:w?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(x,{className:"w-full sm:w-auto",variant:"destructive",onClick:ja,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(x,{className:"w-full sm:w-auto bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>V(!0),children:"إضافة مستخدم جديد"}),e.jsx(x,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>G(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(ve,{open:ns,onOpenChange:V,children:e.jsxs(we,{className:"sm:max-w-md",children:[e.jsx(Ie,{children:e.jsx(Ne,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"الاسم"}),e.jsx(q,{value:N,onChange:z=>k(z.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(q,{value:K,onChange:z=>$(z.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(q,{type:"password",autoComplete:"new-password",value:Y,onChange:z=>re(z.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(et,{className:"flex gap-2 justify-between",children:[e.jsx(x,{variant:"secondary",onClick:()=>{V(!1)},children:"إلغاء"}),e.jsx(x,{onClick:()=>{!N.trim()||!K.trim()||!Y.trim()||(na(),V(!1))},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"حفظ المستخدم"})]})]})}),e.jsx(ve,{open:nt,onOpenChange:G,children:e.jsxs(we,{className:"sm:max-w-lg",children:[e.jsx(Ie,{children:e.jsx(Ne,{children:"إيصالات التسليم"})}),He.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:He.map(z=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{mt(z),rs(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(z.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",z.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",z.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",z.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",z.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",z.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",z.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",z.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",z.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",z.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(z.shiftProfit??(z.deliveredDrawerFunds??0)+(z.deliveredWalletBalancesTotal??0)-(z.receivedDrawerFunds??0)-(z.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",z.shiftProfit??(z.deliveredDrawerFunds??0)+(z.deliveredWalletBalancesTotal??0)-(z.receivedDrawerFunds??0)-(z.receivedWalletBalancesTotal??0)]})]}),z.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",z.deficitAmount??0]})]},z.id))}),e.jsx(et,{className:"flex gap-2 justify-between",children:e.jsx(x,{variant:"secondary",onClick:()=>G(!1),children:"إغلاق"})})]})}),e.jsx(ve,{open:ps,onOpenChange:rs,children:e.jsxs(we,{className:"sm:max-w-md",children:[e.jsx(Ie,{children:e.jsx(Ne,{children:"إيصال تسليم وردية"})}),ot?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(ot.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",ot.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",ot.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",ot.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",ot.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",ot.deliveredWalletBalancesTotal??0]})]})]}),ot.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",ot.deficitAmount??0]})]}),ot.receivedWalletBalances&&Object.keys(ot.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(ot.receivedWalletBalances).map(([z,Te])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:z}),e.jsx("span",{className:"font-semibold",children:Te})]},z))})]}),ot.deliveredWalletBalances&&Object.keys(ot.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(ot.deliveredWalletBalances).map(([z,Te])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:z}),e.jsx("span",{className:"font-semibold",children:Te})]},z))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(et,{className:"flex gap-2 justify-between",children:e.jsx(x,{variant:"secondary",onClick:()=>rs(!1),children:"إغلاق"})})]})}),e.jsx(ve,{open:qa,onOpenChange:Zs,children:e.jsxs(we,{className:"sm:max-w-md",children:[e.jsx(Ie,{children:e.jsx(Ne,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:ie?`${ie.name} (${ie.username})`:""}),e.jsx(q,{type:"password",autoComplete:"off",value:Vs,onChange:z=>T(z.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(et,{className:"flex gap-2 justify-between",children:[e.jsx(x,{variant:"secondary",onClick:()=>{T(""),Ee(null),Zs(!1)},children:"إلغاء"}),e.jsx(x,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{if(ie){if(Vs.trim()!==ie.password){y({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}C({name:ie.name,username:ie.username}),T(""),Zs(!1),p(!1),s(),Et(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(ve,{open:it,onOpenChange:Et,children:e.jsxs(we,{className:"sm:max-w-md",children:[e.jsx(Ie,{children:e.jsx(Ne,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(q,{type:"text",inputMode:"decimal",value:$e,onChange:z=>Qe(us(z.target.value)),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(q,{type:"text",inputMode:"decimal",value:Number.isFinite(ee)?ee:0,onChange:z=>{const Te=parseFloat(us(z.target.value));_t(Number.isFinite(Te)?Te:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(et,{className:"flex gap-2 justify-between",children:e.jsx(x,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{const z=parseFloat($e),Te=ee,ht=Number.isFinite(z)&&z>=0,St=Number.isFinite(Te)&&Te>=0;if(!ht||!St){y({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(z)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(Te))}catch{}y({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),Et(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(ve,{open:pe,onOpenChange:z=>{z&&M(!0)},children:e.jsxs(we,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(Ie,{children:e.jsx(Ne,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:W==="toUser"?"default":"secondary",onClick:()=>le("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(x,{variant:W==="toAdmin"?"default":"secondary",onClick:()=>le("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),W==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[$s.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:$s.map((z,Te)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(te==null?void 0:te.username)===z.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>ae(z),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:z.name}),e.jsx("div",{className:"text-xs text-gray-500",children:z.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},Te))})]}),e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(q,{type:"password",autoComplete:"off",value:Be,onChange:z=>Ge(z.target.value),placeholder:"أدخل كلمة السر"})]}),Q&&e.jsx("div",{className:"text-xs text-red-600",children:Q})]}),W==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(q,{type:"password",autoComplete:"off",value:_e,onChange:z=>Se(z.target.value),placeholder:"كلمة المرور"}),xe&&e.jsx("div",{className:"text-xs text-red-600",children:xe})]})]}),e.jsx(et,{className:"flex gap-2 justify-between",children:e.jsx(x,{disabled:ze||!W,onClick:async()=>{if(W){yt(!0);try{const z=Ht;if(xa().then(ts).catch(()=>{}),W==="toUser"){if(!te){oe("يرجى اختيار المستخدم أولاً"),yt(!1);return}if(Be.trim()!==te.password){oe("كلمة السر غير صحيحة"),yt(!1);return}b(),C({name:te.name,username:te.username}),s(),vt(`${te.name} (${te.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}M(!1),le(null),ae(null),Ge(""),oe(""),p(!1),ts(z),qe(null),lt(""),$t(!0)}else if(W==="toAdmin"){ne("");const Te=(D==null?void 0:D.email)||"";if(!Te){ne("لا يوجد بريد للمستخدم الرئيسي للتحقق"),yt(!1);return}const{error:ht}=await E(Te,_e);if(ht){ne("كلمة المرور غير صحيحة"),yt(!1);return}b(),C(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}Se(""),M(!1),p(!1),vt("الأدمن الرئيسي"),ts(z),qe(null),lt(""),$t(!0)}}catch{oe("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{yt(!1)}}},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"تأكيد التسليم"})})]})}),e.jsx(ve,{open:bt,onOpenChange:$t,children:e.jsxs(we,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(Ie,{children:e.jsx(Ne,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:xs})]}),S&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(S).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(q,{type:"number",value:$e,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(q,{type:"number",value:ee,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(q,{type:"text",inputMode:"decimal",value:B,onChange:z=>{const Te=parseFloat(us(z.target.value));De(Number.isFinite(Te)?Te:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(q,{type:"text",inputMode:"decimal",value:Fe,onChange:z=>{const Te=parseFloat(us(z.target.value));jt(Number.isFinite(Te)?Te:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(B??0)+(Fe??0)-((parseFloat($e||"0")||0)+(ee??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((B??0)+(Fe??0)-((parseFloat($e||"0")||0)+(ee??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"}),e.jsx("div",{className:"mt-2 grid grid-cols-1 gap-2",children:e.jsxs("div",{className:"rounded border p-2 bg-gray-50",children:[e.jsx("div",{className:"text-xs text-gray-700",children:"مطلوب من الدرج (بدون أرباح)"}),e.jsx("div",{className:"text-sm font-semibold text-gray-900",children:Math.round(((B??0)-(parseFloat($e||"0")||0))*100)/100})]})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:Wt==="no"?"default":"secondary",onClick:()=>qe("no"),children:"لا"}),e.jsx(x,{variant:Wt==="yes"?"default":"secondary",onClick:()=>qe("yes"),children:"نعم"})]}),Wt==="yes"&&e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(q,{type:"number",value:rt,onChange:z=>lt(z.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(et,{className:"flex gap-2 justify-between",children:e.jsx(x,{onClick:()=>{const z=Wt==="yes",Te=parseFloat(rt)||0;(async()=>await _a(Ht,z,Te))(),y({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),$t(!1)},className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:"تأكيد وحفظ الإيصال"})})]})})]})},gp=({open:i,onOpenChange:p})=>{const{shiftUser:c,endShift:w,setShiftUser:S}=$n(),[C,s]=n.useState(""),[b,F]=n.useState(""),[D,E]=n.useState([]),{user:O}=Pa();n.useEffect(()=>{(async()=>{try{if(O!=null&&O.uid){const N=Oe(U,"profiles",O.uid,"cashierUsers","list"),k=await Ls(N);if(k.exists()){const K=k.data(),$=Array.isArray(K==null?void 0:K.users)?K.users:[];if($&&$.length>0){E($);return}}}}catch{}try{const N=`cashierUsers_${(O==null?void 0:O.uid)||"default"}`;let k=localStorage.getItem(N);if(!k){const K=localStorage.getItem("cashierUsers");K&&(k=K)}E(k?JSON.parse(k):[])}catch{E([])}})()},[i,O==null?void 0:O.uid]),n.useEffect(()=>{if(!i||!(O!=null&&O.uid))return;const N=async()=>{try{const K=Oe(U,"profiles",O.uid,"cashierUsers","list"),$=await Ls(K);if($.exists()){const Y=$.data(),re=Array.isArray(Y==null?void 0:Y.users)?Y.users:[];re&&re.length>0?E(re):k()}else k()}catch(K){console.warn("ShiftProfileDialog cashierUsers fetch error:",K),k()}},k=()=>{try{const K=`cashierUsers_${(O==null?void 0:O.uid)||"default"}`;let $=localStorage.getItem(K);if(!$){const Y=localStorage.getItem("cashierUsers");Y&&($=Y)}E($?JSON.parse($):[])}catch{E([])}};N()},[i,O==null?void 0:O.uid]);const y=async()=>{if(F(""),!c)return;const N=D.find(k=>k.username===c.username);if(!N){F("لا يوجد مستخدم مطابق لهذه الوردية");return}if(C.trim()!==N.password){F("الرقم السري غير صحيح");return}w(),S(null),s(""),p(!1)};return e.jsx(ve,{open:i,onOpenChange:N=>{s(""),F(""),p(N)},children:e.jsxs(we,{className:"sm:max-w-md",children:[e.jsx(Ie,{children:e.jsx(Ne,{children:"بروفيل الوردية"})}),c?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:c.name}),e.jsx("div",{className:"text-xs text-gray-600",children:c.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx(q,{type:"password",value:C,onChange:N=>s(N.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),b&&e.jsx("div",{className:"text-red-600 text-xs",children:b})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(et,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>p(!1),children:"إغلاق"}),e.jsx(x,{onClick:y,disabled:!c,children:"تسليم الوردية"})]})]})})},fp=({open:i,onOpenChange:p})=>e.jsx(ve,{open:i,onOpenChange:p,children:e.jsxs(we,{className:"sm:max-w-lg rounded-2xl",children:[e.jsxs(Ie,{children:[e.jsxs(Ne,{className:"text-right flex items-center gap-2 justify-end",children:[e.jsx(ro,{className:"w-5 h-5"}),"سجل التغييرات الأخيرة"]}),e.jsx(hs,{className:"text-right",children:"هذه أبرز التحسينات التي تمت مؤخرًا في الواجهة."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(mo,{className:"w-5 h-5 text-amber-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحسين نافذة تعديل المديونية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"استبدال نافذة الإدخال القديمة (prompt) بحوار أنيق لإدخال المبلغ مع تأكيد."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Ju,{className:"w-5 h-5 text-violet-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحديث شاشة التحميل"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:'تغيير النص إلى "صلي علي النبي" مع خط عربي جميل ونبض لطيف.'})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ro,{className:"w-5 h-5 text-green-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"بطاقات الأرباح وعدد العمليات"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"إضافة بطاقات عرض أرباح الفترة الحالية وعدد العمليات في تفاصيل المحفظة."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ro,{className:"w-5 h-5 text-blue-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"إصلاح تمرير نافذة اليومية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"منع تمرير الصفحة الخلفية عند فتح نافذة اليومية لراحة الاستخدام."})]})]})]}),e.jsx("div",{className:"flex justify-end gap-2 mt-6",children:e.jsx(x,{variant:"secondary",onClick:()=>p(!1),children:"إغلاق"})})]})});class Kr{static async processTransfer(p){const{amount:c,currentCashBalance:w,currentWalletBalances:S,wallets:C,selectedWalletId:s}=p;if(c<=0)return{success:!1,newCashBalance:w,newWalletBalances:S,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!p.skipRemoteLimitsCheck)try{const E=await Aa.canPerformOperation(s,c,"transfer");if(!E.canPerform)return{success:!1,newCashBalance:w,newWalletBalances:S,message:E.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(E){return console.error("خطأ في التحقق من حدود التحويل:",E),{success:!1,newCashBalance:w,newWalletBalances:S,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(c<=0)return{success:!1,newCashBalance:w,newWalletBalances:S,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s){const E=Math.max(S[s]||0,0);if(E<c){const O=C.find(y=>y.id===s);return{success:!1,newCashBalance:w,newWalletBalances:S,message:`رصيد غير كافي في المحفظة${O?` ${O.name}`:""}. المتاح: ${E} جنيه، المطلوب: ${c} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const E=Kr.calculateTotalWalletBalance(S);if(E<c)return{success:!1,newCashBalance:w,newWalletBalances:S,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${E} جنيه، المبلغ المطلوب: ${c} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const b={...S};if(s){const E=b[s]||0;b[s]=E-c}else{let E=c;for(const O of C){if(E<=0)break;const y=Math.max(b[O.id]||0,0),N=Math.min(y,E);N>0&&(b[O.id]=(b[O.id]||0)-N,E-=N)}}const F=w+c;let D="تم التحويل بنجاح";if(s){const E=b[s]||0;E<0&&(D=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${s} أصبح ${E} جنيه.`)}return{success:!0,newCashBalance:F,newWalletBalances:b,message:D}}static processDeposit(p){const{amount:c,currentCashBalance:w,currentWalletBalances:S,wallets:C}=p;if(c<=0)return{success:!1,newCashBalance:w,newWalletBalances:S,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const s=this.calculateTotalWalletBalance(S);if(s<c)return{success:!1,newCashBalance:w,newWalletBalances:S,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${s} جنيه، المبلغ المطلوب: ${c} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const b=w+c,F={...S};let D=c;const E=C.find(y=>y.isDefault);if(E&&F[E.id]>=D)F[E.id]-=D,D=0;else for(const y of C){if(D<=0)break;const N=F[y.id]||0;if(N>0){const k=Math.min(N,D);F[y.id]=N-k,D-=k}}const O=D>0?`تم الإيداع جزئياً. تم إيداع ${c-D} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${c} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:b,newWalletBalances:F,message:O}}static async processWithdraw(p){const{amount:c,currentCashBalance:w,currentWalletBalances:S,wallets:C,selectedWalletId:s}=p;if(c<=0)return{success:!1,newCashBalance:w,newWalletBalances:S,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!p.skipRemoteLimitsCheck)try{const E=await Aa.canPerformOperation(s,c,"withdraw");if(!E.canPerform)return{success:!1,newCashBalance:w,newWalletBalances:S,message:E.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(E){return console.error("خطأ في التحقق من حدود السحب:",E),{success:!1,newCashBalance:w,newWalletBalances:S,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(w<c)return{success:!1,newCashBalance:w,newWalletBalances:S,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${w} جنيه، المبلغ المطلوب: ${c} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const b=w-c,F={...S},D=s?C.find(E=>E.id===s):C.find(E=>E.isDefault)||C[0];if(D){const E=F[D.id]||0;F[D.id]=E+c}else return{success:!1,newCashBalance:w,newWalletBalances:S,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};return{success:!0,newCashBalance:b,newWalletBalances:F,message:`تم السحب بنجاح. تم إضافة ${c} جنيه إلى محفظة ${(D==null?void 0:D.name)||""}`}}static validateOperation(p,c){return p<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!c||c.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(p){return Object.values(p).reduce((c,w)=>c+Math.max(w,0),0)}static deductFromWalletsAddToCash(p,c,w,S){return this.processTransfer({amount:p,currentCashBalance:c,currentWalletBalances:w,wallets:S})}static deductFromWalletsAddToCashDeposit(p,c,w,S){return this.processDeposit({amount:p,currentCashBalance:c,currentWalletBalances:w,wallets:S})}static deductFromCashAddToWallets(p,c,w,S){return this.processWithdraw({amount:p,currentCashBalance:c,currentWalletBalances:w,wallets:S})}static applyTransactionResult(p,c,w){p.success&&(c(p.newCashBalance),w(p.newWalletBalances))}static validateTransaction(p,c,w,S){if(p<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(c==="transfer"){const C=this.calculateTotalWalletBalance(S);if(C<p)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${C} جنيه) غير كافي للمبلغ المطلوب (${p} جنيه)`}}else if(c==="withdraw"){if(w<p)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${w} جنيه) غير كافي للمبلغ المطلوب (${p} جنيه)`}}else if(c==="deposit"){const C=this.calculateTotalWalletBalance(S);if(C<p)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${C} جنيه) غير كافي للمبلغ المطلوب (${p} جنيه)`}}return{isValid:!0}}static getDeductionPreview(p,c,w){const S=[];let C=p;for(const s of w){if(C<=0)break;const b=c[s.id]||0,F=Math.min(Math.max(b,0),C);F>0&&(S.push({walletId:s.id,walletName:s.name,currentBalance:b,deductedAmount:F,newBalance:b-F}),C-=F)}return S}}let Tn=null;function yp(){const i=window;if(!Tn){const p=i.AudioContext||i.webkitAudioContext;Tn=new p}return Tn.state==="suspended"&&Tn.resume(),Tn}function bp(i,p,c){const w=c/1e3,S=Math.floor(i.sampleRate*w),C=i.createBuffer(1,S,i.sampleRate),s=C.getChannelData(0);for(let E=0;E<S;E++)s[E]=(Math.random()*2-1)*.6;const b=i.createBufferSource();b.buffer=C;const F=i.createBiquadFilter();F.type="highpass",F.frequency.value=1500,F.Q.value=.7;const D=i.createGain();D.gain.setValueAtTime(1e-4,p),D.gain.exponentialRampToValueAtTime(.4,p+.015),D.gain.exponentialRampToValueAtTime(1e-4,p+w),b.connect(F),F.connect(D),D.connect(i.destination),b.start(p),b.stop(p+w+.01)}function vp(i,p,c,w,S,C="triangle"){const s=i.createOscillator(),b=i.createGain();s.type=C;const F=S/1e3;s.frequency.setValueAtTime(c,p),s.frequency.linearRampToValueAtTime(w,p+F),b.gain.setValueAtTime(1e-4,p),b.gain.exponentialRampToValueAtTime(.25,p+.02),b.gain.exponentialRampToValueAtTime(1e-4,p+F),s.connect(b),b.connect(i.destination),s.start(p),s.stop(p+F+.02)}function wp(){try{const i=yp(),p=i.currentTime;bp(i,p,90),vp(i,p+.12,1900,1100,180,"sawtooth")}catch{}}function Np(i){if(!i)return!1;const c=i.replace(/[^0-9٠-٩]/g,"").replace(/[٠-٩]/g,w=>"0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(w)]);return/^(010|011|012|015)[0-9]{8}$/.test(c)}function jp({userId:i}){const[p,c]=Ke.useState(null),[w,S]=Ke.useState("");return null}const bg=()=>{var Yc,Hc,Qc,Gc,Zc;console.log("🔥 UserDashboardPage component is loading...");const{toast:i}=ua(),p=n.useRef(null),[c,w]=n.useState(0),S=async()=>{var r,l,o;const t="alkaptin678678@gmail.com",a=(l=(r=Vr.currentUser)==null?void 0:r.email)==null?void 0:l.toLowerCase();if(!a||a!==t){i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}if(!ii||!li||!oi){i({title:"بيانات ناقصة",description:"أدخل رقم الموبايل، الشركة والمبلغ",variant:"destructive"});return}try{jc(!0);const h=await((o=Vr.currentUser)==null?void 0:o.getIdToken()),m=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...h?{Authorization:`Bearer ${h}`}:{}},body:JSON.stringify({phone:ii,countryCode:"EG",operator:li,amount:Number(oi),useLocalAmount:!0})}),u=await m.json().catch(()=>({}));m.ok&&(u!=null&&u.success)?(i({title:"تم الشحن",description:(u==null?void 0:u.message)||"تم تنفيذ عملية الشحن بنجاح"}),_l(!1),bc(""),vc(""),wc("")):i({title:"فشل الشحن",description:(u==null?void 0:u.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(h){console.error("Topup request error:",h),i({title:"خطأ غير متوقع",description:"تعذّر تنفيذ عملية الشحن. حاول لاحقاً.",variant:"destructive"})}finally{jc(!1)}},{signOut:C,user:s,profile:b}=Pa(),F=((s==null?void 0:s.email)||"").toLowerCase()==="vodafonecash00@gmail.com",D=wd(),E=bd(),O=Du(),{isShiftActive:y,shiftUser:N}=$n(),{shopId:k,shopName:K}=Li(),$=Cu(),Y=Iu();(()=>{try{return!!window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:"}catch{return!1}})();const[re,pe]=n.useState(!1),[M,W]=n.useState(!1),[le,_e]=n.useState(!1),[Se,xe]=n.useState(!1),[ne,Le]=n.useState(!1),[H,te]=n.useState(!1),[ae,Be]=n.useState([]),[Ge,Q]=n.useState(""),[oe,ze]=n.useState(""),[yt,bt]=n.useState(""),[$t,Ht]=n.useState(""),[ts,Wt]=n.useState(!1),[qe,rt]=n.useState(!1),[lt,$e]=n.useState(null),[Qe,ee]=n.useState(""),[_t,ss]=n.useState(""),[as,B]=n.useState(!1),[De,Fe]=n.useState(!1),[jt,gt]=n.useState(!1),[Tt,xs]=n.useState(null),[vt,it]=n.useState(!1),[Et,us]=n.useState(!1),[kt,$s]=n.useState(null);n.useEffect(()=>{Au().then($s).catch(()=>{})},[]);const[Gs,Na]=n.useState(void 0);n.useEffect(()=>{try{const t=window.electronAPI;t&&typeof t.appVersion=="function"&&t.appVersion().then(a=>{typeof a=="string"&&!a.startsWith("err:")&&Na(a)}).catch(()=>{})}catch{}},[]);const Ts=(()=>{var r,l;const t=(l=(r=import.meta)==null?void 0:r.env)==null?void 0:l.VITE_APP_VERSION,a=typeof window<"u"&&(window.electronAPI||window.location.protocol==="file:"||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron"));if(a&&(b!=null&&b.desktopInstalledVersion))return b==null?void 0:b.desktopInstalledVersion;if(a&&Gs)return Gs;if(t)return t;if(!(!kt&&!b))return Y?(b==null?void 0:b.androidInstalledVersion)||(b==null?void 0:b.lastAckAndroidVersion)||(kt==null?void 0:kt.androidVersion)||(kt==null?void 0:kt.pcVersion):(kt==null?void 0:kt.pcVersion)||(kt==null?void 0:kt.androidVersion)})();n.useEffect(()=>{ne&&(s!=null&&s.uid)&&!Et&&(async()=>{Wt(!0);try{let a=[],r=[];try{const m=je(U,"users",s.uid,"branches");a=(await Re(m)).docs.map(v=>({id:v.id,...v.data(),source:"sub"}))}catch(m){console.warn("Failed to fetch subcollection branches:",m)}try{const m=Je(je(U,"branches"),de("ownerId","==",s.uid));r=(await Re(m)).docs.map(v=>({id:v.id,...v.data(),source:"root"}))}catch(m){console.warn("Failed to fetch root branches:",m)}const l=[...a,...r],o=new Map;l.forEach(m=>{const u=m.branchUserId||m.id;(!o.has(u)||m.source==="sub")&&o.set(u,m)});const h=Array.from(o.values());console.log("Loaded branches:",h),Be(h),us(!0)}catch(a){console.error("Error in branch loading process:",a),i({title:"تنبيه",description:"حدث خطأ أثناء تحديث القائمة",variant:"destructive"})}finally{Wt(!1)}})()},[ne,s==null?void 0:s.uid,Et]),n.useEffect(()=>{ne||it(!1)},[ne]);const[qa,Zs]=n.useState(!1),[Vs,T]=n.useState(null),[ie,Ee]=n.useState(""),[He,Me]=n.useState(""),[nt,G]=n.useState(""),[ot,mt]=n.useState(!1),ps=t=>{T(t),Ee(t.branchName||""),Me(t.managerName||""),G(t.loginUsername||t.email||t.username||""),Zs(!0)},rs=async()=>{if(!(!Vs||!ie||!He)){mt(!0);try{const t={branchName:ie,managerName:He,updatedAt:new Date};if(Vs.branchUserId)try{await As(Oe(U,"users",(s==null?void 0:s.uid)||"","branches",String(Vs.branchUserId)),t,{merge:!0});try{await Yt(Oe(U,"users",Vs.branchUserId),{displayName:ie,managerName:He})}catch(a){console.warn("Could not update branch root user doc",a)}}catch(a){console.warn("Sub branch update failed:",a)}try{await Yt(Oe(U,"branches",Vs.id),t)}catch{}Be(a=>a.map(r=>r.id===Vs.id?{...r,...t}:r)),i({title:"تم تحديث بيانات الفرع بنجاح"}),Zs(!1)}catch(t){console.error("Error updating branch:",t),i({title:"فشل تحديث البيانات",description:t.message,variant:"destructive"})}finally{mt(!1)}}},ns=async t=>{if(!(t!=null&&t.branchUserId)){i({title:"خطأ",description:"بيانات الفرع غير مكتملة",variant:"destructive"});return}gt(!0),Fe(!0);try{const a=t.branchUserId;if(s!=null&&s.uid&&t.branchUserId&&t.source!=="sub")try{await As(Oe(U,"users",s.uid,"branches",t.branchUserId),{branchUserId:t.branchUserId,branchName:t.branchName||"Unknown Branch",managerName:t.managerName||"",active:!0,lastSynced:dt()},{merge:!0}),console.log("✅ Branch link synced successfully"),await new Promise(ut=>setTimeout(ut,500))}catch(ut){console.error("❌ Failed to sync branch link:",ut)}const[r,l,o,h]=await Promise.all([Ls(Oe(U,"users",a)),(async()=>{try{const ut=Je(je(U,"merchantWallets"),de("merchantUserId","==",a)),Pt=await Re(ut);if(!Pt.empty)return Pt;const ys=await Re(je(U,"users",a,"wallets"));return ys.empty?await Re(Je(je(U,"wallets"),de("userId","==",a))):ys}catch(ut){console.error("Error fetching wallets",ut);try{return await Re(Je(je(U,"wallets"),de("userId","==",a)))}catch{return{docs:[]}}}})(),(async()=>{try{return await Re(Je(je(U,"debts"),de("userId","==",a)))}catch{return await Re(je(U,"users",a,"debts"))}})(),(async()=>{try{const ut=Je(je(U,"dailySales"),de("userId","==",a)),Pt=await Re(ut);return Pt.empty?await Re(je(U,"users",a,"dailySales")):Pt}catch(ut){return console.error("Error fetching sales",ut),await Re(je(U,"users",a,"dailySales"))}})()]),m=r.exists()?r.data():{},u=Number(m.cashBalance||0),v=m.reportsData||{},f=Number(v.dailyProfit||0),g=Number(v.monthlyProfit||0),j=m.walletBalances||{};let A=Object.values(j).reduce((ut,Pt)=>ut+Number(Pt||0),0);A===0&&!l.empty&&(A=l.docs.reduce((ut,Pt)=>ut+Number(Pt.data().balance||Pt.data().amount||0),0));let I=0;o.forEach(ut=>{const Pt=ut.data();if(Pt.type!=="debtor"){const ys=Number(Pt.paidAmount||0),Ds=Math.max(0,Number(Pt.amount||0)-ys);I+=Ds}});const me=new Date().toISOString().split("T")[0],_=me.slice(0,7);let J=0,be=0,Ve=f,ms=g,sa=0;console.log(`Branch Details - UID: ${a}, Wallets: ${l.size}, Sales: ${h.size}, ReportsDaily: ${f}`),h.forEach(ut=>{const Pt=ut.data(),ys=String(Pt.date||""),Ds=Number(Pt.sellingPrice||0)*Number(Pt.quantity||1),Ga=Number(Pt.profit||0);sa+=Ds,ys===me&&(J+=Ds,Ve+=Ga),ys.startsWith(_)&&(be+=Ds,ms+=Ga)}),xs({branchName:t.branchName,managerName:t.managerName,todaySales:J,monthSales:be,todayProfit:Ve,monthProfit:ms,walletsTotal:A,cashBalance:u,totalSalesSection:sa,debtsTotal:I})}catch(a){console.error("Error fetching branch details:",a),i({title:"تعذر تحميل بيانات الفرع",description:a.message,variant:"destructive"}),Fe(!1)}finally{gt(!1)}},[V,is]=n.useState("");n.useEffect(()=>{const t=O==null?void 0:O.shopId;if(t&&(s!=null&&s.uid))try{const a=`selectedShopId_${s.uid}`;localStorage.setItem(a,String(t)),window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}},[O==null?void 0:O.shopId,s==null?void 0:s.uid]);const[na,ja]=n.useState([]),[xa,_a]=n.useState(()=>{try{return localStorage.getItem("cashySelectedDevice")||null}catch{return null}});n.useEffect(()=>{},[]),n.useEffect(()=>{(async()=>{if(V)try{await Dn.set({key:"selected_wallet_id",value:V}),console.log("📱 Synced selected_wallet_id to Native:",V)}catch(a){console.error("Failed to sync wallet to native:",a)}else await Dn.remove({key:"selected_wallet_id"})})()},[V]),n.useEffect(()=>{(async()=>{if(k)try{await Dn.set({key:"shopId",value:k}),console.log("📱 Synced shopId to Native:",k)}catch(a){console.error("Failed to sync shopId to native:",a)}})()},[k]);const pa=t=>!!(t&&na.some(a=>a.id===t));async function z(){const t=window.electronAPI,a=xa||"";if(!t||typeof t.sendUssd!="function")return null;if(!a)return i({title:"الجهاز غير محدد",description:"اتصل بالموبايل أولاً ثم اختر الجهاز من القائمة",variant:"destructive"}),null;if(pa(a))return a;try{const h=na.find(m=>m&&m.id&&!String(m.id).includes(":"));if(h&&h.id)return _a(h.id),h.id}catch{}const r=a.includes(":")?a.split(":").slice(0,2).join(":"):"";if(r&&typeof t.connectWifi=="function"){try{await t.connectWifi(r)}catch{}if(await new Promise(h=>setTimeout(h,250)),pa(a))return a}const l=a.split(":")[0],o=na.find(h=>(h.id.startsWith(l)||h.id.includes(l))&&h.id.includes(":"));if(o!=null&&o.id){const h=o.id.split(":").slice(0,2).join(":");if(!pa(o.id)&&typeof t.connectWifi=="function"){try{await t.connectWifi(h)}catch{}await new Promise(m=>setTimeout(m,250))}if(pa(o.id))return _a(o.id),o.id}return i({title:"الجهاز غير متصل",description:"فعّل Wireless debugging أو استخدم اتصال Wi‑Fi ثم أعد المحاولة",variant:"destructive"}),null}n.useEffect(()=>{const t=window.electronAPI;t&&typeof t.onAdbDevices=="function"&&t.onAdbDevices(a=>{var o;const r=Array.isArray(a)?a:[];ja(r);const l=(()=>{try{return localStorage.getItem("cashySelectedDevice")||""}catch{return""}})();l&&r.some(h=>h.id===l)?_a(l):(o=r[0])!=null&&o.id?_a(h=>h||r[0].id):_a(null)})},[]);function Te(t,a){try{const r=js==null?void 0:js(),l=(r==null?void 0:r.phone)||"";if(!l){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"});return}qu(l,t,a),i({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),mr(!1),Er(!1)}catch(r){const l=(r==null?void 0:r.message)||"تعذر إرسال الكود — تحقق من البيانات";throw i({title:"فشل الإرسال",description:l,variant:"destructive"}),r}}const ht=async()=>{var r;if(!Js||!Js.receiver||!Js.amount){i({title:"بيانات غير مكتملة",description:"تأكد من إدخال رقم المستقبل والمبلغ قبل الإرسال",variant:"destructive"});return}const t=String(Js.receiver),a=Math.round(Number(Js.amount));hr(!0);try{if((r=Pi)!=null&&r.isNativePlatform&&Pi.getPlatform()==="android"){const o=js==null?void 0:js(),h=(o==null?void 0:o.phone)||"";if(!h){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),hr(!1);return}const m=ad(h,t,a);if(!m){i({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),hr(!1);return}Uu(m),i({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),mr(!1),Er(!1);return}const l=window.electronAPI;if(l&&typeof l.sendUssd=="function"&&xa){const o=js==null?void 0:js(),h=(o==null?void 0:o.phone)||"";if(!h){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),hr(!1);return}const m=await z();if(!m){hr(!1);return}const u=ad(h,t,a);if(!u){i({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),hr(!1);return}try{const v=typeof l.pickSimAutomatically=="function"?await l.pickSimAutomatically(m,h):{deviceId:m,slot:0},f=`${v.deviceId}:sim${v.slot}`;$m(f),await l.sendUssd(f,u)}catch{try{await l.sendUssd(m,u)}catch(f){const g=m.includes(":")?m.split(":").slice(0,2).join(":"):"";if(g&&typeof l.connectWifi=="function")await l.connectWifi(g),await l.sendUssd(m,u);else throw f}}i({title:"تم إرسال كود التحويل",description:"تم التنفيذ بنجاح"}),mr(!1),Er(!0)}else Te(t,a)}catch(l){const o=l&&l.message?l.message:"حدث خطأ غير متوقع أثناء الإرسال";i({title:"خطأ أثناء الإرسال",description:`الجهاز: ${Bo||xa||"غير معروف"} — ${o}`,variant:"destructive"})}finally{hr(!1)}},St=async(t,a)=>{const r=window.electronAPI;try{if(r&&typeof r.enterPin=="function"&&t){await r.enterPin(t,a),Er(!1);return}const l=String((b==null?void 0:b.bridgeLink)||"").trim(),o=String((b==null?void 0:b.bridgeDeviceId)||"").trim()||void 0;if(!l){i({title:"الرابط غير مُعدّ",description:"احفظ رابط الجسر أولاً",variant:"destructive"});return}const h=String((Js==null?void 0:Js.receiver)||Fs||"").replace(/\D/g,""),m=Math.max(1,Math.round(Number((Js==null?void 0:Js.amount)||ks||0))||0),u=String(a||"").replace(/\D/g,""),f=(g=>{let j=(g||"").trim();return j=j.replace(/\/+$/,""),/^https?:\/\//i.test(j)||(j=`https://${j}`),j})(l);Er(!1)}catch(l){const o=(l==null?void 0:l.message)||"حدث خطأ أثناء إدخال الرقم السري";i({title:"فشل الإدخال",description:o,variant:"destructive"})}};console.log("🔥 UserDashboardPage - user:",s?"exists":"null");const[ls,Ft]=n.useState(!0),[os,ia]=n.useState(!0),[Nr,la]=n.useState(!1),[Sa,Ze]=n.useState(!1),[Dt,oa]=n.useState(""),[Qr,za]=n.useState(""),[jr,Gr]=n.useState(""),[Sr,Dr]=n.useState([]),[Wn,Cr]=n.useState(!1),[Qt,or]=n.useState(null),[Va,Ir]=n.useState(""),[fo,Fn]=n.useState(!1),[$i,d]=n.useState(!1),[P,L]=n.useState(!1),[se,ge]=n.useState(!1),[ce,Ce]=n.useState(""),[ke,fe]=n.useState(""),[We,ue]=n.useState([]),[Ct,gs]=n.useState(!1),[Xs,ca]=n.useState(0),[Ar,Ja]=n.useState(!1),[It,Ea]=n.useState(null),[Ws,yo]=n.useState(null),[Zr,Rn]=n.useState(!1),[da,Oa]=n.useState(""),[Fs,Tr]=n.useState(""),[ks,Xr]=n.useState(""),[cr,bo]=n.useState(""),[en,vo]=n.useState(""),[Wi,kr]=n.useState(!1),[Fi,Ri]=n.useState(""),[im,dr]=n.useState(""),[wo,No]=n.useState(""),[Bi,lm]=n.useState(""),[ga,Ui]=n.useState(null),[om,jo]=n.useState(!1),[cm,So]=n.useState(!1),[dm,Bn]=n.useState(!1),[mm,qi]=n.useState(!1),[Do,zi]=n.useState(null),[Ps,Vi]=n.useState(""),[_s,Ji]=n.useState(""),[Co,hm]=n.useState(""),[um,Io]=n.useState(!1),[Sp,Dp]=n.useState(null),[Ki,Ao]=n.useState(null),[xm,Yi]=n.useState(!1);n.useEffect(()=>{(async()=>{try{const a=s!=null&&s.uid?`withdrawSenderNameInputEnabled_${s==null?void 0:s.uid}`:"withdrawSenderNameInputEnabled";let r=null;try{r=localStorage.getItem(a)??localStorage.getItem("withdrawSenderNameInputEnabled")}catch{}if(s!=null&&s.uid)try{const l=await Fr(()=>Ae.getUserData(s.uid)),o=l==null?void 0:l.withdrawSenderNameInputEnabled;if(typeof o=="boolean"){Yi(o);try{localStorage.setItem(a,o?"true":"false")}catch{}return}}catch{}Yi(r==="true")}catch{Yi(!1)}})()},[s==null?void 0:s.uid]);const Un=t=>{const a="٠١٢٣٤٥٦٧٨٩",r="۰۱۲۳۴۵۶۷۸۹";return(t||"").split("").map(l=>{const o=a.indexOf(l);if(o>-1)return String(o);const h=r.indexOf(l);return h>-1?String(h):l}).join("")},[At,Hi]=n.useState(()=>{try{const t=localStorage.getItem("commissionMode")||localStorage.getItem("commissionMode_default");return t?t==="add":!0}catch{return!0}}),[ye,To]=n.useState("transfer"),[Ye,ea]=n.useState([]),[Ma,Qi]=n.useState("all"),[ft,Es]=n.useState([]),La=n.useRef([]),tn=An({enabled:!!(s!=null&&s.uid),queryKey:["recentTransactions",s==null?void 0:s.uid,k||"main"],queryFn:async()=>{const{collection:t,query:a,where:r,orderBy:l,limit:o,getDocs:h}=await xt(async()=>{const{collection:_,query:J,where:be,orderBy:Ve,limit:ms,getDocs:sa}=await import("./index-BwuekbvX.js").then(ut=>ut.ci);return{collection:_,query:J,where:be,orderBy:Ve,limit:ms,getDocs:sa}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await xt(async()=>{const{db:_}=await import("./index-BwuekbvX.js").then(J=>J.cj);return{db:_}},__vite__mapDeps([0,1]),import.meta.url),u=a(t(m,"userTransactions"),r("userId","==",String((s==null?void 0:s.uid)||"")),l("createdAt","desc"),o(100)),g=(await h(u)).docs.map(_=>{var Ds;const J=_.data(),be=(Ds=J.createdAt)!=null&&Ds.toDate?J.createdAt.toDate():new Date(J.createdAt),Ve=String(J.transactionType||J.txnType||J.type||"").toLowerCase(),ms=Ve==="withdraw"||Ve==="receive"?"withdraw":"send",sa=J.status==="confirmed"?"completed":J.status||"completed",ut=J.senderMsisdn||J.senderPhone||"",Pt=J.receiverMsisdn||J.receiverPhone||"",ys=Number(J.amount??J.transferredAmount??J.withdrawnAmount??0);return{id:_.id,...J,type:ms,status:sa,senderPhone:ut,receiverPhone:Pt,amount:ys,createdAt:be}}).filter(_=>!((_==null?void 0:_.type)==="report"||String((_==null?void 0:_.title)||"").includes("إيصال تسليم وردية"))),j=new Set((rn||[]).map(_=>String(_.id||_.originalTransactionId||""))),A=g.filter(_=>!j.has(String(_.id||""))),I=_=>{var J;return String(_.transactionId||_.id||_.reference||((J=_.receipt)==null?void 0:J.reference)||`${new Date(_.createdAt).getTime()}`)},R=new Set,me=[];for(const _ of A){const J=I(_);R.has(J)||(R.add(J),me.push(_))}return me},staleTime:6e4,gcTime:3e5,refetchOnWindowFocus:!1,refetchOnReconnect:!0});n.useEffect(()=>{const t=()=>{try{tn.refetch()}catch{}};return window.addEventListener("transaction-created",t),()=>{window.removeEventListener("transaction-created",t)}},[tn]),n.useEffect(()=>{const t=tn.data;if(t&&Array.isArray(t)){const a=La.current,r=Date.now(),l=a.filter(u=>{const v=t.some(j=>j.id===u.id),f=u.reference?t.some(j=>j.reference===u.reference):!1,g=r-new Date(u.createdAt).getTime()>3e5;return!v&&!f&&!g});La.current=l;const o=[...l,...t].sort((u,v)=>new Date(v.createdAt).getTime()-new Date(u.createdAt).getTime()),h=new Set,m=[];for(const u of o)h.has(u.id)||(h.add(u.id),m.push(u));ea(m)}},[tn.data]),n.useEffect(()=>{try{if(localStorage.setItem("commissionMode",At?"add":"deduct"),s!=null&&s.uid){const t=`commissionMode_${s.uid}`;localStorage.setItem(t,At?"add":"deduct")}}catch{}},[At,s==null?void 0:s.uid]),n.useEffect(()=>{try{const t=new Set((Ye||[]).filter(l=>String((l==null?void 0:l.status)||"")==="completed"&&(l==null?void 0:l.linkedDebtId)).map(l=>String(l.linkedDebtId)));if(t.size===0)return;const a=ft.map(l=>{if(t.has(String(l.id))){const o=Number(l.amount||0),h=Number(l.paidAmount||0);if(l.status!=="paid"||h<o)return{...l,status:"paid",paidAmount:o}}return l});if(a.some((l,o)=>l!==ft[o])){Es(a),(async()=>await ma(a))();try{s!=null&&s.uid&&a.filter((o,h)=>o!==ft[h]&&o.status==="paid").forEach(o=>{try{Xa.send(s.uid,`تم سداد الدين بالكامل للعميل ${o.debtorName}: المدفوع ${Number(o.paidAmount||o.amount||0)} جنيه`)}catch{}})}catch{}}}catch{}},[Ye,ft,s==null?void 0:s.uid]),n.useEffect(()=>{try{const t=s!=null&&s.uid?localStorage.getItem(`commissionMode_${s.uid}`):null,a=localStorage.getItem("commissionMode"),r=localStorage.getItem("commissionMode_default"),l=t??a??r;l&&Hi(l==="add")}catch{}},[s==null?void 0:s.uid]);const[Gi,sn]=n.useState(!1),[pm,gm]=n.useState(null),qn=Ke.useRef(""),ko=Ke.useRef(0);n.useEffect(()=>{const t=a=>{var l;if(Gi)return;try{const o=document.activeElement;if(o){const h=(l=o.tagName)==null?void 0:l.toLowerCase();if(h==="input"||h==="textarea"||h==="select"||h==="button"||o.isContentEditable===!0)return}}catch{}const r=Date.now();if(a.key==="Enter"){const o=(qn.current||"").trim();qn.current="",o&&(gm(o),sn(!0));return}a.key.length===1&&(r-(ko.current||0)>100&&(qn.current=""),qn.current+=a.key,ko.current=r)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[Gi]);const[fm,ym]=n.useState(!1),[bm,Zi]=n.useState(!1),[vm,Cp]=n.useState(null);n.useEffect(()=>{if(!Wi)return;const t=js(),a=parseFloat(ks||"0")||0;let r=0;if(ye==="transfer"){if((t==null?void 0:t.defaultTransferCommission)!=null){const o=Number(t.defaultTransferCommission)||0;r=Math.round(o*a/1e3*100)/100}else{const o=_s&&_s.trim()!==""?parseFloat(_s):0;r=Math.max(0,o)}const l=a+r;dr((l||0).toString())}else{if((t==null?void 0:t.defaultWithdrawCommission)!=null){const o=Number(t.defaultWithdrawCommission)||0;r=Math.round(o*a/1e3*100)/100}else{const o=Ps&&Ps.trim()!==""?parseFloat(Ps):Math.round(a*.01*100)/100;r=Math.max(0,o)}const l=At?a:Math.max(0,Math.round((a-r)*100)/100);dr((l||0).toString())}},[Wi,ks,_s,Ps,V,At,ye]);const js=()=>{var a,r;let t=Ue.find(l=>l.id===V);if(!t)try{const l=localStorage.getItem(Bl());if(l){const o=JSON.parse(l);if(Array.isArray(o)&&o.length>0){const m=localStorage.getItem(gr())||((a=o.find(u=>u.isDefault))==null?void 0:a.id)||((r=o[0])==null?void 0:r.id);t=o.find(u=>u.id===m)}}}catch{}return t};n.useLayoutEffect(()=>{try{const t=`wallets_${(s==null?void 0:s.uid)||"default"}`;let a=localStorage.getItem(t);if(!a){const r=Object.keys(localStorage).find(l=>l.startsWith("wallets_"));r&&(a=localStorage.getItem(r)||null)}if(a){const r=JSON.parse(a);if(Array.isArray(r)&&r.length>0){Pr(r);const l=localStorage.getItem(gr()),o=l&&r.find(h=>h.id===l)||r.find(h=>h.isDefault)||r[0];o&&(is(o.id),Oa(o.phone))}}}catch(t){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",t)}},[]),n.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",V)},[V]),n.useEffect(()=>{Cc()},[s==null?void 0:s.uid]),n.useEffect(()=>{kh()},[]);const[Ue,Pr]=n.useState(()=>{try{const t=Object.keys(localStorage).find(r=>r.startsWith("wallets_")),a=t?localStorage.getItem(t):null;if(a){const r=JSON.parse(a);if(Array.isArray(r))return r}}catch{}return[]}),zn=An({enabled:!!(s!=null&&s.uid),queryKey:["wallets",s==null?void 0:s.uid],queryFn:async()=>{const{merchantWalletService:t}=await xt(async()=>{const{merchantWalletService:l}=await import("./index-BwuekbvX.js").then(o=>o.ck);return{merchantWalletService:l}},__vite__mapDeps([0,1]),import.meta.url),a=await t.getByMerchantId(String((s==null?void 0:s.uid)||""));return(Array.isArray(a)?a:[]).filter(l=>l.isActive===!0).map(l=>({id:l.id,name:l.label||"محفظة بدون اسم",phone:l.msisdn,isDefault:!!l.isDefault,monthlyWithdrawalLimit:l.monthlyWithdrawalLimit??l.withdrawLimit??2e5,monthlyTransferLimit:l.monthlyTransferLimit??l.transferLimit??2e5,defaultTransferCommission:l.defaultTransferCommission!=null?Number(l.defaultTransferCommission):null,defaultWithdrawCommission:l.defaultWithdrawCommission!=null?Number(l.defaultWithdrawCommission):null}))},staleTime:6e4,gcTime:3e5,refetchOnReconnect:!0});n.useEffect(()=>{var a;const t=zn.data;if(t&&Array.isArray(t)){Pr(t);const r=localStorage.getItem(gr());if(!!!(V&&t.find(o=>o.id===V))){const o=r&&t.find(h=>h.id===r)?r:((a=t[0])==null?void 0:a.id)||"";if(o){is(o);const h=t.find(m=>m.id===o);Oa(String((h==null?void 0:h.phone)||""))}}}},[zn.data]),n.useEffect(()=>{const t=a=>{const{cashBalance:r,walletBalances:l,newTransaction:o,limitUpdate:h,delta:m}=a.detail||{};if(m){const{amount:u,type:v,walletId:f,commission:g}=m,j=Number(u||0),A=Number(g||0);cs(I=>{let R=0;v==="withdraw"?R=-j+A:(v==="send"||v==="transfer")&&(R=j+A);const me=I+R;try{const _=zt();localStorage.setItem(_,String(me)),localStorage.setItem(_+"_lastUpdated",new Date().toISOString())}catch{}return me}),f&&fs(I=>{const R=Number(I[f]||0);let me=0;v==="withdraw"?me=j:(v==="send"||v==="transfer")&&(me=-j);const _=R+me,J={...I,[f]:_};try{const be=ds();localStorage.setItem(be,JSON.stringify(J)),localStorage.setItem(be+"_lastUpdated",new Date().toISOString())}catch{}return J})}if(typeof r=="number"){cs(r);try{const u=zt();localStorage.setItem(u,String(r)),localStorage.setItem(u+"_lastUpdated",new Date().toISOString())}catch{}}if(l&&typeof l=="object"){fs(l);try{const u=ds();localStorage.setItem(u,JSON.stringify(l)),localStorage.setItem(u+"_lastUpdated",new Date().toISOString())}catch{}}if(h&&h.walletId===V&&Wr(u=>{if(!u)return u;const v=Number(h.amount||0),f=h.type==="transfer",g={...u};return f?(g.dailyTransferUsed=(g.dailyTransferUsed||0)+v,g.monthlyTransferUsed=(g.monthlyTransferUsed||0)+v):(g.dailyWithdrawUsed=(g.dailyWithdrawUsed||0)+v,g.monthlyWithdrawUsed=(g.monthlyWithdrawUsed||0)+v),g}),o){try{La.current&&(La.current.some(u=>u.id===o.id)||La.current.push(o))}catch{}ea(u=>u.some(v=>v.id===o.id)?u:[o,...u]),i({title:"تم تسجيل عملية خارجية",description:"تم تحديث الأرصدة والسجلات بنجاح"});try{tn.refetch()}catch{}}};return window.addEventListener("dashboard:external-update",t),()=>window.removeEventListener("dashboard:external-update",t)},[V]);const[Po,wm]=n.useState(""),_o=(()=>{const t=Po.replace(/\D/g,"");return t?Ue.filter(a=>(a.phone||"").replace(/\D/g,"").includes(t)):Ue})(),[Nm,Ip]=n.useState(null),[jm,Eo]=n.useState(!1),[Sm,Vn]=n.useState(!1),[Dm,Cm]=n.useState(null),[Ap,Im]=n.useState([]),[Tp,kp]=n.useState([]),[Am,an]=n.useState(!1),[Xi,Oo]=n.useState("daily"),[rn,nn]=n.useState([]),[Tm,Pp]=n.useState(!1),Da=Ke.useRef(new Set);Ke.useRef(new Set);const km=Ke.useRef([]);n.useEffect(()=>{km.current=Ye},[Ye]);const el=async t=>{try{if(!s)return;const a=zt(),r=ds(),l=localStorage.getItem(a),o=localStorage.getItem(r);let h=l?parseFloat(l):Ot,m=o?JSON.parse(o):{...tt};const u=Number(t.withdrawnAmount??t.sentAmount??t.transferredAmount??t.amount??0);if(t.type==="send"&&(t.fromWallet||V)){h-=u;const j=t.fromWallet||V;m[j]=(m[j]||0)+u}else if(t.type==="withdraw"&&(t.fromWallet||V)){h+=u;const j=t.fromWallet||V;m[j]=Math.max(0,(m[j]||0)-u)}cs(h),fs(m);const v=new Date().toISOString();localStorage.setItem(a,h.toString()),localStorage.setItem(a+"_lastUpdated",v),localStorage.setItem(r,JSON.stringify(m)),localStorage.setItem(r+"_lastUpdated",v);const f={cashBalance:h,walletBalances:m,lastUpdated:new Date().toISOString()},g=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(g,JSON.stringify(f));try{await Ae.updateUserData(s.uid,f),localStorage.removeItem(g),st(!1)}catch(j){console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف (مزامنة تلقائية):",j),st(!0)}try{const j=t.fromWallet||V,A=t.type==="send"?"transfer":"withdraw";await Aa.rollbackUsage(j,u,A,t.createdAt)}catch(j){console.warn("تعذر تحديث حدود المحفظة بعد الحذف (مزامنة):",j)}try{Bs.removeTransactionEffects(t,s.uid)}catch(j){console.warn("تعذر تحديث التقارير بعد الحذف (مزامنة):",j)}}catch(a){console.warn("خطأ أثناء تطبيق تأثيرات الحذف محليًا:",a)}},Pm=async t=>{try{const a=Ye.find(m=>m.id===t);if(!a||!s)return;const r=String(t),l=String((a==null?void 0:a.transactionId)||(a==null?void 0:a.reference)||""),o=Da.current.has(r)||l&&Da.current.has(l),h=Ye.filter(m=>m.id!==t);ea(h);try{await Ae.removeUserTransaction(s.uid,t),await In.permanentlyDeleteTransaction(t,s.uid)}catch(m){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",m)}if(!o){Da.current.add(r),l&&Da.current.add(l),await el(a);try{s!=null&&s.uid&&Ae.removeLocalReceiptById(s.uid,t)}catch{}}i({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),Vn(!1)}catch(a){console.error("خطأ أثناء حذف الإيصال:",a),i({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},_m=async t=>{try{const a=Ye.find(r=>r.id===t);if(!a||!s)return;try{const r=It==null?void 0:It.planType;if(r===Hs.ZERO){const{dailyOperationCountService:l}=await xt(async()=>{const{dailyOperationCountService:m}=await import("./dailyOperationCountService-CLP0M_n4.js");return{dailyOperationCountService:m}},__vite__mapDeps([2,0,1]),import.meta.url),o=a.type==="send"?"transfer":"withdraw";if(!(await l.checkAndIncrement(s.uid,o,5)).allowed){i({title:"تم بلوغ حد باقة الزيرو",description:"مسموح بحد أقصى 5 تأكيدات يوميًا للتحويل/السحب. جرّب غدًا أو قم بالترقية.",variant:"destructive"});return}}else if(r===Hs.TAHWEELA){const{dailyOperationCountService:l}=await xt(async()=>{const{dailyOperationCountService:m}=await import("./dailyOperationCountService-CLP0M_n4.js");return{dailyOperationCountService:m}},__vite__mapDeps([2,0,1]),import.meta.url),o=a.type==="send"?"transfer":"withdraw";if(!(await l.checkAndIncrementCombined(s.uid,o,40)).allowed){i({title:"تم بلوغ حد باقة تحويله",description:"هذه الباقة تسمح بحد أقصى 40 عملية تحويل/سحب يومياً.",variant:"destructive"});return}}}catch(r){console.warn("تعذر التحقق من حد التأكيد اليومي:",r)}await Yt(Oe(U,"userTransactions",t),{status:"completed",confirmedAt:new Date}),ea(r=>r.map(l=>l.id===t?{...l,status:"completed"}:l)),i({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),Vn(!1)}catch(a){console.error("خطأ أثناء إكمال الإيصال:",a),i({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}};n.useEffect(()=>{if(!s)return;(async()=>{try{const a=Je(je(U,"deletedTransactions"),de("userId","==",s.uid),Bu("createdAt","desc"),zr(50));(await Re(a)).docs.forEach(l=>{const o=l.data(),h=String((o==null?void 0:o.originalTransactionId)||""),m=String((o==null?void 0:o.transactionId)||""),u=String((o==null?void 0:o.reference)||""),v=h||m||u||String(l.id);v&&(Da.current.has(v)||(Da.current.add(v),ea(f=>{const g=f.find(j=>j.id===h);return g?((async()=>await el(g))(),f.filter(j=>j.id!==h)):f})))})}catch(a){console.warn("تعذر جلب المعاملات المحذوفة:",a)}})()},[s==null?void 0:s.uid]),n.useEffect(()=>{if(!s)return;(async()=>{try{const a=Oe(U,"users",s.uid),r=await Ls(a);if(!r.exists())return;const l=r.data();if(!(l!=null&&l.reportsData))return;try{await Bs.syncReportsDataFromFirebase(s.uid),Im(Nn())}catch(o){console.warn("تعذر مزامنة reportsData من السحابة:",o)}}catch(a){console.warn("تعذر جلب users.reportsData:",a)}})()},[s==null?void 0:s.uid]);const[Mo,Em]=n.useState(""),Lo=op(Mo,300),[Jn,$o]=n.useState(""),[Kn,Wo]=n.useState(""),[$a,_p]=n.useState(""),[tl,_r]=n.useState(!1),[Fo,ln]=n.useState(!1),[Om,mr]=n.useState(!1),[Ss,sl]=n.useState(null),[Js,Mm]=n.useState(null),[Ro,hr]=n.useState(!1),[Lm,Er]=n.useState(!1),[Bo,$m]=n.useState(""),[Wm,al]=n.useState(!1),Uo=!1,[Fm,Yn]=n.useState(!1),[Rm,qo]=n.useState(!1),[Bm,Hn]=n.useState(!1),[Um,Qn]=n.useState(!1),[qm,Gn]=n.useState(!1),[zm,zo]=n.useState(!0),[on,Vm]=n.useState(!1),[Jm,Zn]=n.useState(!1),[Km,Vo]=n.useState(!1),[Xn,Ym]=n.useState(""),[Jo,Hm]=n.useState(!1),[Qm,rl]=n.useState(!1),[Gm,Ko]=n.useState(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[Zm,nl]=n.useState(!1);n.useEffect(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled",a=localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled");Ko(a==="true")}catch{}},[s==null?void 0:s.uid]);const[Xm,Or]=n.useState(!1),[eh,il]=n.useState(!1),[th,Yo]=n.useState(()=>{try{const t=s==null?void 0:s.uid,a=t?`debtsPinRequired_${t}`:"debtsPinRequired";return(localStorage.getItem(a)??localStorage.getItem("debtsPinRequired"))==="true"}catch{return!1}}),[sh,Ho]=n.useState(!1),[Qo,ah]=n.useState(null),[ll,Go]=n.useState(""),[ol,Zo]=n.useState(""),[cl,Xo]=n.useState(""),[Ca,ec]=n.useState(null),[X,Ka]=n.useState(null),[rh,Ya]=n.useState(!1),[nh,cn]=n.useState(!1),[ur,tc]=n.useState(null),[sc,dl]=n.useState(""),[Gt,ac]=n.useState(null),[Ep,Op]=n.useState(!1),[ih,ml]=n.useState(!1),[rc,hl]=n.useState(""),[ul,xr]=n.useState(!1),[nc,xl]=n.useState(1),lh=Y?10:20,pl=Ke.useMemo(()=>ft.slice(0,nc*lh),[ft,nc]);n.useEffect(()=>{ul&&xl(1)},[ul]);const gl=async()=>{if(wt){i({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}try{const t=await Ms.hasMasterPin(s==null?void 0:s.uid);th&&t?il(!0):Or(!0)}catch{Or(!0)}};n.useEffect(()=>{try{const t=s==null?void 0:s.uid,a=t?`debtsPinRequired_${t}`:"debtsPinRequired",r=localStorage.getItem(a)??localStorage.getItem("debtsPinRequired");(r==="true"||r==="false")&&Yo(r==="true")}catch{}},[s==null?void 0:s.uid]),n.useEffect(()=>{const t=()=>{try{Il()}catch{}};try{window.addEventListener("debtsUpdated",t)}catch{}return()=>{try{window.removeEventListener("debtsUpdated",t)}catch{}}},[s==null?void 0:s.uid,k,b==null?void 0:b.shopId]);const[oh,fl]=n.useState(!1),[Ks,yl]=n.useState([]),[bl,ic]=n.useState(""),[vl,lc]=n.useState(""),[Mr,oc]=n.useState(""),[cc,ch]=n.useState(""),[dh,ei]=n.useState(!1),[mh,dc]=n.useState(""),[mc,wl]=n.useState(""),[hc,Nl]=n.useState(""),[hh,ti]=n.useState(!1),[uh,jl]=n.useState(""),[uc,Sl]=n.useState(""),[xh,Lr]=n.useState(!1),[pr,dn]=n.useState(null),[Us,mn]=n.useState(null),[hn,Dl]=n.useState(""),[ph,$r]=n.useState(!1),[xc,si]=n.useState(0),[ta,Ha]=n.useState(null),[Qa,Cl]=n.useState(""),[Xe,Wr]=n.useState(null),[gh,pc]=n.useState(""),ma=async t=>{try{const a=JSON.stringify(t);localStorage.setItem(xn(),a);try{localStorage.setItem(Ml(),a)}catch{}try{localStorage.setItem(Ll(),Date.now().toString())}catch{}if(s!=null&&s.uid){try{localStorage.setItem(`debts_unsynced_${s.uid}`,"true")}catch{}const r=[];r.push(Ae.updateUserData(s.uid,{debts:t,debtsDeletedAt:null})),Promise.all(r).then(()=>{try{localStorage.removeItem(`debts_unsynced_${s.uid}`)}catch{}}).catch(l=>{console.error("فشل مزامنة الديون:",l),st(!0)})}}catch(a){console.error("خطأ في حفظ الديون:",a)}},Il=async()=>{try{const t=xn(),a=Ml(),r=Ll(),l=localStorage.getItem(t),o=localStorage.getItem(a),h=localStorage.getItem(r),m=h?Number(h):0,u=f=>{if(!f)return null;try{const g=JSON.parse(f);return Array.isArray(g)?g.map(j=>{var A;return{...j,createdAt:(A=j.createdAt)!=null&&A.toDate?j.createdAt.toDate():new Date(j.createdAt),partialPayments:Array.isArray(j.partialPayments)?j.partialPayments.map(I=>{var R;return{amount:Number(I.amount)||0,paidAt:(R=I.paidAt)!=null&&R.toDate?I.paidAt.toDate():new Date(I.paidAt)}}):[]}}):[]}catch(g){return console.warn("فشل في تحليل ديون localStorage:",g),null}};let v=u(l);if(!v||v.length===0){const f=u(o);if(f&&f.length>0){v=f,Es(f);try{localStorage.setItem(xn(),JSON.stringify(f)),localStorage.removeItem(a)}catch(g){console.warn("تعذر ترحيل الديون محلياً من المفتاح الافتراضي:",g)}}}if(v&&v.length>0&&Es(v),s!=null&&s.uid)try{const f=`debts_unsynced_${s.uid}`,g=localStorage.getItem(f)==="true",j=await Ls(Oe(U,"users",s.uid)),A=[];try{const I=query(je(U,"debts"),de("userId","==",s.uid));(await Re(I)).forEach(me=>{var J;const _=me.data();A.push({id:me.id,..._,amount:Number(_.amount||0),paidAmount:Number(_.paidAmount||0),createdAt:(J=_.createdAt)!=null&&J.toDate?_.createdAt.toDate():new Date(_.createdAt||Date.now()),partialPayments:Array.isArray(_.partialPayments)?_.partialPayments:[]})})}catch(I){console.warn("Failed to fetch from debts collection:",I)}if(j.exists()){const I=j.data();let R=I.debts&&Array.isArray(I.debts)?I.debts.map(J=>{var be;return{...J,amount:Number(J.amount||0),paidAmount:Number(J.paidAmount||0),createdAt:(be=J.createdAt)!=null&&be.toDate?J.createdAt.toDate():new Date(J.createdAt),partialPayments:Array.isArray(J.partialPayments)?J.partialPayments.map(Ve=>{var ms;return{amount:Number(Ve.amount)||0,paidAt:(ms=Ve.paidAt)!=null&&ms.toDate?Ve.paidAt.toDate():new Date(Ve.paidAt)}}):[]}}):[];if(!!I.debtsDeletedAt){Es([]);try{localStorage.setItem(t,JSON.stringify([])),localStorage.setItem(a,JSON.stringify([]))}catch{}return}if(((R==null?void 0:R.length)||0)>0)if(g)console.log("⚠️ تم اكتشاف ديون غير متزامنة محلياً، سيتم تجاهل نسخة السحابة مؤقتاً للحفاظ على البيانات الجديدة.");else{Es(R);try{localStorage.setItem(t,JSON.stringify(R))}catch{}}}else if(A.length>0){Es(A);try{localStorage.setItem(t,JSON.stringify(A))}catch{}}else v&&v.length>0}catch(f){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",f)}}catch(t){console.error("خطأ في تحميل الديون:",t)}};n.useEffect(()=>{try{window.exportDebts=()=>{try{return JSON.stringify(ft||[])}catch{return"[]"}},window.importDebts=async t=>{try{const a=JSON.parse(t);if(!Array.isArray(a))throw new Error("صيغة غير صحيحة — يجب أن تكون مصفوفة");return await ma(a),{ok:!0,count:a.length}}catch(a){return console.error("فشل استيراد الديون:",a),{ok:!1,error:String(a)}}},window.fixWalletsForCurrentUser=async t=>{try{if(!(s!=null&&s.uid))throw new Error("يجب تسجيل الدخول أولاً");return await(await xt(async()=>{const{merchantWalletService:r}=await import("./index-BwuekbvX.js").then(l=>l.ck);return{merchantWalletService:r}},__vite__mapDeps([0,1]),import.meta.url)).merchantWalletService.reassignByMsisdns(t,s.uid)}catch(a){return console.error("فشل إصلاح المحافظ للمستخدم الحالي:",a),{updated:0,failed:(t==null?void 0:t.length)||0,error:String(a)}}}}catch{}},[ft,s==null?void 0:s.uid]),n.useEffect(()=>{s!=null&&s.uid&&Il()},[s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;const t=Tu(Oe(U,"users",s.uid),async a=>{var r;if(a.exists()){const l=a.data(),o=l.isActive===!0;l.subscription&&Ea(l.subscription),yo(l.branchPackage||null);const h=await od.checkTrialValidity(s.uid),m=h.isValid&&!h.isExpired;Ft(o||m),gs(m),ca(h.hoursRemaining),Ja(h.hasUsedTrial);const u=!o&&!m;L(u),u&&(console.log("⛔ User not active, redirecting to pending approval..."),E("/user/pending-approval",{replace:!0})),console.log("🔄 تحديث فوري لحالة المستخدم (Real-time):",{isActive:o,isOnTrial:m,plan:(r=l.subscription)==null?void 0:r.planType,showModal:u})}});return()=>t()},[s==null?void 0:s.uid]);const fh=async()=>{if(s!=null&&s.uid)try{Rn(!0);const t=await xo(s.uid);Ea(t)}catch(t){console.error("خطأ في جلب بيانات الاشتراك:",t)}finally{Rn(!1)}},[Mp,Lp]=n.useState(!1),[yh,Al]=n.useState(!1),[Ot,cs]=n.useState(0),[tt,fs]=n.useState({}),[bh,gc]=n.useState(!1),[vh,fc]=n.useState(!1),[wh,Tl]=n.useState(!1),[Nh,ai]=n.useState(!1),[yc,kl]=n.useState(""),[jh,un]=n.useState(!1),[Sh,ri]=n.useState(!1),[Pl,ni]=n.useState(""),[Dh,_l]=n.useState(!1),[ii,bc]=n.useState(""),[li,vc]=n.useState(""),[oi,wc]=n.useState(""),[Nc,jc]=n.useState(!1),[El,Ol]=n.useState(!1),[Ch,Sc]=n.useState(!1),[Dc,Ih]=n.useState([]);n.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid)||!El)return;try{await Sn.trimToMaxCount(s.uid,30)}catch{}const t=await Sn.getByUser(s.uid,30);Ih(t)}catch{}})()},[s==null?void 0:s.uid,El]);const ds=()=>{const t=k||(b==null?void 0:b.shopId)||"main";return`walletBalances_${(s==null?void 0:s.uid)||"default"}_${t}`},zt=()=>{const t=k||(b==null?void 0:b.shopId)||"main";return`cashBalance_${(s==null?void 0:s.uid)||"default"}_${t}`},xn=()=>{const t=k||(b==null?void 0:b.shopId)||"main";return`debts_${(s==null?void 0:s.uid)||"default"}_${t}`},Ah=()=>{const t=k||(b==null?void 0:b.shopId)||"main";return`customers_${(s==null?void 0:s.uid)||"default"}_${t}`},Ml=()=>`debts_default_${k||(b==null?void 0:b.shopId)||"main"}`,Ll=()=>{const t=k||(b==null?void 0:b.shopId)||"main";return`debts_last_write_${(s==null?void 0:s.uid)||"default"}_${t}`},$l=()=>`shopExpenses_${k||(b==null?void 0:b.shopId)||(s==null?void 0:s.uid)||"default"}`,Cc=()=>{try{const t=localStorage.getItem($l());if(t){const a=JSON.parse(t);Dr(a.map(r=>({...r,createdAt:new Date(r.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",t)}},Ic=async t=>{try{localStorage.setItem($l(),JSON.stringify(t)),Dr(t)}catch(a){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",a)}},Th=async t=>{try{const a=Sr.filter(r=>r.id!==t);await Ic(a);try{if(s!=null&&s.uid&&t){const{doc:r,deleteDoc:l}=await xt(async()=>{const{doc:m,deleteDoc:u}=await import("./index-BwuekbvX.js").then(v=>v.ci);return{doc:m,deleteDoc:u}},__vite__mapDeps([0,1]),import.meta.url),{db:o}=await xt(async()=>{const{db:m}=await import("./index-BwuekbvX.js").then(u=>u.cj);return{db:m}},__vite__mapDeps([0,1]),import.meta.url),h=r(o,"shop_expenses",t);await l(h)}}catch(r){console.warn("تعذر حذف المصروف من السحابة الآن، تم الحذف محليًا وسيبقى مخزّنًا دون هذا الإيصال:",r)}i({title:"تم الحذف",description:"تم حذف إيصال المصروف نهائيًا."})}catch(a){console.error("خطأ أثناء الحذف النهائي لإيصال المصروف:",a),i({title:"فشل الحذف",description:"تعذر حذف الإيصال. حاول مرة أخرى.",variant:"destructive"})}};Ke.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid)){Cc();return}const{collection:a,query:r,where:l,getDocs:o}=await xt(async()=>{const{collection:j,query:A,where:I,getDocs:R}=await import("./index-BwuekbvX.js").then(me=>me.ci);return{collection:j,query:A,where:I,getDocs:R}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await xt(async()=>{const{db:j}=await import("./index-BwuekbvX.js").then(A=>A.cj);return{db:j}},__vite__mapDeps([0,1]),import.meta.url),m=k||(b==null?void 0:b.shopId),u=m?r(a(h,"shop_expenses"),l("shopId","==",m)):r(a(h,"shop_expenses"),l("userId","==",s.uid)),g=(await o(u)).docs.map(j=>{var R;const A=j.data(),I=(R=A.createdAt)!=null&&R.toDate?A.createdAt.toDate():A.createdAt?new Date(A.createdAt):new Date;return{id:j.id,name:String(A.name||""),amount:Number(A.amount||0),notes:A.notes?String(A.notes):void 0,source:A.source==="wallet"?"wallet":"cash",walletId:A.walletId?String(A.walletId):void 0,createdAt:I}}).sort((j,A)=>{const I=j.createdAt instanceof Date?j.createdAt.getTime():0;return(A.createdAt instanceof Date?A.createdAt.getTime():0)-I});Dr(g);try{localStorage.setItem($l(),JSON.stringify(g))}catch{}}catch(a){console.error("خطأ في مزامنة مصروفات المحل من Firestore:",a)}})(),()=>t==null?void 0:t()},[s==null?void 0:s.uid,b==null?void 0:b.shopId,k]);const ci=()=>`deficiencies_${k||(b==null?void 0:b.shopId)||(s==null?void 0:s.uid)||"default-shop"}`,kh=()=>{try{const t=ci(),a=`deficiencies_${(s==null?void 0:s.uid)||"default"}`;if(a!==t){const l=localStorage.getItem(a),o=localStorage.getItem(t);if(l)try{const h=JSON.parse(l)||[],m=o?JSON.parse(o):[],u=Array.isArray(m)?[...m]:[],v=(f,g)=>f.some(j=>(j==null?void 0:j.id)&&(g==null?void 0:g.id)&&String(j.id)===String(g.id)||String((j==null?void 0:j.name)||"")===String((g==null?void 0:g.name)||"")&&String((j==null?void 0:j.status)||"pending")===String((g==null?void 0:g.status)||"pending"));if(Array.isArray(h))for(const f of h)v(u,f)||u.push(f);localStorage.setItem(t,JSON.stringify(u));try{localStorage.removeItem(a)}catch{}}catch{}}const r=localStorage.getItem(t);if(r){const l=JSON.parse(r);ue(l.map(o=>({...o,createdAt:new Date(o.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل النواقص من التخزين:",t)}},Wl=async t=>{try{localStorage.setItem(ci(),JSON.stringify(t)),ue(t)}catch(a){console.error("خطأ أثناء حفظ النواقص في التخزين:",a)}};Ke.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid))return;const{collection:a,query:r,where:l,orderBy:o,getDocs:h}=await xt(async()=>{const{collection:j,query:A,where:I,orderBy:R,getDocs:me}=await import("./index-BwuekbvX.js").then(_=>_.ci);return{collection:j,query:A,where:I,orderBy:R,getDocs:me}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await xt(async()=>{const{db:j}=await import("./index-BwuekbvX.js").then(A=>A.cj);return{db:j}},__vite__mapDeps([0,1]),import.meta.url),u=k||(b==null?void 0:b.shopId)||s.uid||"default-shop",v=r(a(m,"deficiencies"),l("shopId","==",u),o("createdAt","desc")),g=(await h(v)).docs.map(j=>{var R;const A=j.data(),I=(R=A.createdAt)!=null&&R.toDate?A.createdAt.toDate():A.createdAt?new Date(A.createdAt):new Date;return{id:j.id,name:String(A.name||""),quantity:Number(A.quantity||1),status:A.status==="purchased"?"purchased":"pending",createdAt:I}});ue(g);try{localStorage.setItem(ci(),JSON.stringify(g))}catch{}}catch(a){console.warn("فشل جلب النواقص من Firestore:",a)}})()},[s==null?void 0:s.uid,b==null?void 0:b.shopId,k]);const Fl=async t=>{try{localStorage.setItem(Ah(),JSON.stringify(t)),yl(t),s!=null&&s.uid&&await Ae.updateUserData(s.uid,{customers:t})}catch(a){console.error("خطأ أثناء حفظ العملاء في التخزين:",a)}},Ph=async()=>{try{if(s!=null&&s.uid){const t=await Ls(Oe(U,"users",s.uid));if(t.exists()){const a=t.data();if(a.customers&&Array.isArray(a.customers)){const r=a.customers.map(l=>{var o;return{...l,createdAt:(o=l.createdAt)!=null&&o.toDate?l.createdAt.toDate():new Date(l.createdAt)}});yl(r);return}}}yl([])}catch(t){console.error("خطأ أثناء تحميل العملاء من Firestore:",t)}},Rl=()=>{const t=k||(b==null?void 0:b.shopId)||"main";return`transactions_${(s==null?void 0:s.uid)||"default"}_${t}`},Bl=()=>{const t=k||(b==null?void 0:b.shopId)||"main";return`wallets_${(s==null?void 0:s.uid)||"default"}_${t}`},gr=()=>{const t=k||(b==null?void 0:b.shopId)||"main";return`selectedWallet_${(s==null?void 0:s.uid)||"default"}_${t}`},Ac=t=>{var o;const a=String((t==null?void 0:t.transactionId)||(t==null?void 0:t.id)||""),r=String((t==null?void 0:t.reference)||(t==null?void 0:t.transactionReference)||((o=t==null?void 0:t.receipt)==null?void 0:o.reference)||""),l=new Date((t==null?void 0:t.createdAt)||0).getTime();return a||r||`${r||"ref"}-${l}`},{data:Ul,refetch:$p}=An({queryKey:["userTransactions",s==null?void 0:s.uid],queryFn:async()=>{if(!(s!=null&&s.uid))return[];const{collection:t,query:a,where:r,orderBy:l,limit:o,getDocs:h}=await xt(async()=>{const{collection:f,query:g,where:j,orderBy:A,limit:I,getDocs:R}=await import("./index-BwuekbvX.js").then(me=>me.ci);return{collection:f,query:g,where:j,orderBy:A,limit:I,getDocs:R}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await xt(async()=>{const{db:f}=await import("./index-BwuekbvX.js").then(g=>g.cj);return{db:f}},__vite__mapDeps([0,1]),import.meta.url),u=a(t(m,"userTransactions"),r("userId","==",s.uid),l("createdAt","desc"),o(100));return(await h(u)).docs.map(f=>{var J;const g=f.data(),j=(J=g.createdAt)!=null&&J.toDate?g.createdAt.toDate():new Date(g.createdAt),A=g.txnType==="send"?"send":g.txnType==="receive"?"withdraw":g.type||"withdraw",I=g.status==="confirmed"?"completed":g.status||"completed",R=g.senderMsisdn||g.senderPhone||"",me=g.receiverMsisdn||g.receiverPhone||"",_=Number(g.amount??g.transferredAmount??g.withdrawnAmount??0);return{id:f.id,...g,type:A,status:I,senderPhone:R,receiverPhone:me,amount:_,createdAt:j,provider:g.provider||void 0}})},enabled:!!(s!=null&&s.uid),staleTime:1e3*60*5,gcTime:1e3*60*10});n.useEffect(()=>{if(Ul){const a=Ul.filter(m=>!((m==null?void 0:m.type)==="report"||String((m==null?void 0:m.title)||"").includes("إيصال تسليم وردية"))),r=new Set((rn||[]).map(m=>String(m.id||m.originalTransactionId||""))),l=a.filter(m=>!r.has(String(m.id||""))),o=new Set,h=[];for(const m of l){const u=Ac(m);o.has(u)||(o.add(u),h.push(m))}ea(h)}},[Ul,rn]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;let t=!0;return(async()=>{try{const{collection:r,query:l,where:o,getDocs:h,orderBy:m,limit:u}=await xt(async()=>{const{collection:j,query:A,where:I,getDocs:R,orderBy:me,limit:_}=await import("./index-BwuekbvX.js").then(J=>J.ci);return{collection:j,query:A,where:I,getDocs:R,orderBy:me,limit:_}},__vite__mapDeps([0,1]),import.meta.url),{db:v}=await xt(async()=>{const{db:j}=await import("./index-BwuekbvX.js").then(A=>A.cj);return{db:j}},__vite__mapDeps([0,1]),import.meta.url),f=l(r(v,"deletedTransactions"),o("userId","==",s.uid),m("createdAt","desc"),u(50)),g=await h(f);if(!t)return;g.docs.forEach(j=>{const A=j.data(),I=String((A==null?void 0:A.originalTransactionId)||""),R=String((A==null?void 0:A.transactionId)||""),me=String((A==null?void 0:A.reference)||""),_=I||R||me||String(j.id);_&&(Da.current.has(_)||(Da.current.add(_),ea(J=>{const be=J.find(Ve=>Ve.id===I);return be?((async()=>await el(be))(),J.filter(Ve=>Ve.id!==I)):J})))})}catch(r){console.warn("تعذر جلب المعاملات المحذوفة:",r)}})(),()=>{t=!1}},[s==null?void 0:s.uid]);const[ql,di]=n.useState(""),[Ys,Tc]=n.useState(""),Ia=Ke.useMemo(()=>{const t=It;if(!t)return!1;const a=ku(t),r=t.planType??t.plan??null,l=typeof r=="string"?r.toLowerCase():null,o=l==="monthly"||l==="quarterly"||l==="yearly"||l==="lifetime"||r===Hs.MONTHLY||r===Hs.QUARTERLY||r===Hs.YEARLY||r===Hs.LIFETIME;return a&&o},[It]),wt=Ke.useMemo(()=>{var l,o;const t=It;if(!t)return!1;const a=((l=t.subscription)==null?void 0:l.planType)??((o=t.subscription)==null?void 0:o.plan)??t.planType??t.plan??null,r=typeof a=="string"?a.toLowerCase():null;return a===Hs.ZERO||r==="zero"},[It]),Rt=Ke.useMemo(()=>{var l,o;const t=It;if(!t)return!1;const a=((l=t.subscription)==null?void 0:l.planType)??((o=t.subscription)==null?void 0:o.plan)??t.planType??t.plan??null,r=typeof a=="string"?String(a).trim().toLowerCase():null;return a===Hs.TAHWEELA||r==="tahweela"||r==="تحويله"},[It]),_h=()=>{if(!Ia){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}pe(!0)},[Wp,Fp]=n.useState(!1),[Eh,Oh]=n.useState(!1),[Mh,Lh]=n.useState(!1),[$h,Wh]=n.useState(!1),[Fh,pn]=n.useState(!1),[fr,mi]=n.useState(""),[gn,hi]=n.useState(""),[kc,ui]=n.useState(!1),[fn,yn]=n.useState(null),[zl,xi]=n.useState(""),[Rh,Pc]=n.useState(!1),[Rp,Bp]=n.useState(!1),[Bh,pi]=n.useState(!1),[_c,Vl]=n.useState(""),[Ec,Jl]=n.useState(""),[Oc,Mc]=n.useState(!1),Lc=async()=>{var t;if(s!=null&&s.uid)try{const a=`userData_${s.uid}`,r=localStorage.getItem(a),l=`debts_unsynced_${s.uid}`,o=localStorage.getItem(xn()),h=localStorage.getItem(l)==="true";if(r){const m=JSON.parse(r);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",m);const u={lastSynced:new Date().toISOString()};typeof m.cashBalance=="number"&&(u.cashBalance=m.cashBalance),m.walletBalances&&typeof m.walletBalances=="object"&&(u.walletBalances=m.walletBalances),await Ae.updateUserData(s.uid,u),localStorage.removeItem(a),st(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة");if(h&&o)try{const m=JSON.parse(o)||[],u=_=>_ instanceof Date?_:typeof(_==null?void 0:_.toDate)=="function"?_.toDate():_?new Date(String(_)):new Date,v=_=>(Array.isArray(_)?_:[]).map(J=>({...J,amount:Number(J.amount||0),paidAmount:Number(J.paidAmount||0),createdAt:u(J.createdAt),partialPayments:Array.isArray(J.partialPayments)?J.partialPayments.map(be=>({amount:Number(be.amount||0),paidAt:u(be.paidAt)})):[]})),f=await Ls(Oe(U,"users",s.uid)),g=f.exists()?((t=f.data())==null?void 0:t.debts)||[]:[],j=v(g),A=v(m),I={};for(const _ of j)I[String(_.id||"")]=_;const R=[],me=new Set;for(const _ of A){const J=String(_.id||""),be=I[J];if(be){const Ve=Number(be.paidAmount||0)+(Array.isArray(be.partialPayments)?be.partialPayments.reduce((ys,Ds)=>ys+Number(Ds.amount||0),0):0),ms=Number(_.paidAmount||0)+(Array.isArray(_.partialPayments)?_.partialPayments.reduce((ys,Ds)=>ys+Number(Ds.amount||0),0):0),sa=String(be.status||"pending"),ut=String(_.status||"pending"),Pt=sa==="paid"||Ve>=Number(be.amount||0)?be:ut==="paid"?{...be,paidAmount:Number(_.paidAmount||0),partialPayments:_.partialPayments,status:"paid"}:ms>Ve?{...be,paidAmount:Number(_.paidAmount||0),partialPayments:_.partialPayments,status:ms>=Number(be.amount||0)?"paid":"pending"}:be;R.push(Pt),me.add(J)}else R.push(_),me.add(J)}for(const _ of j){const J=String(_.id||"");me.has(J)||R.push(_)}await Ae.updateUserData(s.uid,{debts:R});try{localStorage.removeItem(l)}catch{}st(!1)}catch{st(!0)}}catch(a){console.error("❌ فشل في مزامنة البيانات:",a),i({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},[$c,gi]=n.useState({keepLastCount:30,intervalDays:7,lastResetAt:null});n.useEffect(()=>{(async()=>{if(s!=null&&s.uid)try{const a=await Ae.getUserData(s.uid),r=(a==null?void 0:a.recentReset)||{},l=Number(r==null?void 0:r.keepLastCount)>0?Number(r.keepLastCount):30,o=Number(r==null?void 0:r.intervalDays)>0?Number(r.intervalDays):7,h=f=>f instanceof Date?f:typeof(f==null?void 0:f.toDate)=="function"?f.toDate():f?new Date(String(f)):null,m=r!=null&&r.lastResetAt?h(r.lastResetAt):null,u=new Date;!m||u.getTime()-m.getTime()>=o*24*60*60*1e3?(await Ae.updateUserData(s.uid,{recentReset:{keepLastCount:l,intervalDays:o,lastResetAt:u}}),gi({keepLastCount:l,intervalDays:o,lastResetAt:u})):gi({keepLastCount:l,intervalDays:o,lastResetAt:m})}catch{gi({keepLastCount:30,intervalDays:7,lastResetAt:null})}})()},[s==null?void 0:s.uid]);const Wc=Ke.useMemo(()=>{const t=Ye||[],a=m=>m instanceof Date?m:typeof(m==null?void 0:m.toDate)=="function"?m.toDate():new Date(String(m)),r=new Date,l=new Date(r.getFullYear(),r.getMonth(),1),o=new Date(r.getFullYear(),r.getMonth()+1,1);return[...t].sort((m,u)=>a(u.createdAt).getTime()-a(m.createdAt).getTime()).filter(m=>{const u=a(m.createdAt);return u>=l&&u<o})},[Ye]),Uh=Ke.useMemo(()=>{const t=Ye||[],a=m=>m instanceof Date?m:typeof(m==null?void 0:m.toDate)=="function"?m.toDate():new Date(String(m)),r=new Date,l=new Date(r.getFullYear(),r.getMonth(),1),o=new Date(r.getFullYear(),r.getMonth()+1,1),h=t.filter(m=>{const u=a(m.createdAt);return u>=l&&u<o}).length;return Math.max(0,((Ye==null?void 0:Ye.length)||0)-h)},[Ye==null?void 0:Ye.length]),fi=Ke.useMemo(()=>{const t=new Date,a=new Date(t.getFullYear(),t.getMonth(),1),r=new Date(t.getFullYear(),t.getMonth()+1,1),l={};for(const h of Ye){const m=new Date(h.createdAt||0);if(!(m>=a&&m<r))continue;const u=String(h.type||h.txnType||"").toLowerCase();if(!(u==="send"||u==="withdraw"||u==="transfer"))continue;const v=String(h.receiverPhone||h.senderPhone||"").trim();if(!v)continue;const f=Zt(v),g=Number(h.amount||h.withdrawnAmount||h.sentAmount||0)||0;l[f]||(l[f]={phone:f,count:0,total:0}),l[f].count+=1,l[f].total+=g}return Object.values(l).sort((h,m)=>m.count!==h.count?m.count-h.count:m.total-h.total).slice(0,10)},[Ye]),qh=t=>{const a=Zt(String(t));return a.startsWith("+20")?"20"+a.slice(3):a.startsWith("0")?"20"+a.slice(1):a.replace(/[^0-9]/g,"")},zh=t=>{const a=qh(t.phone),r=`عميل VIP هذا الشهر
عدد العمليات: ${t.count}
الإجمالي: ${t.total} جنيه`,l=`https://wa.me/${a}?text=${encodeURIComponent(r)}`;try{window.open(l,"_blank")}catch{}};n.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid))return;const t=`${new Date().getFullYear()}-${new Date().getMonth()+1}`;await Ae.updateUserData(s.uid,{vipTop10:fi,vipMonthTag:t})}catch{}})()},[s==null?void 0:s.uid,fi]);async function Fc(){const t=new Date,a=new Intl.DateTimeFormat("ar-EG",{timeZone:"Africa/Cairo",year:"numeric",month:"2-digit",day:"2-digit"}).format(t),r=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0,0),l=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59,999),o=(Ye||[]).filter(I=>{const R=new Date(I.createdAt||0);return R>=r&&R<=l}),h=o.length,m=o.filter(I=>String(I.type||I.txnType||"").toLowerCase()==="withdraw"||String(I.type||"").toLowerCase()==="receive").reduce((I,R)=>I+(R.withdrawnAmount!=null?Number(R.withdrawnAmount):Number(R.amount||0)),0),u=o.filter(I=>String(I.type||I.txnType||"").toLowerCase()==="send"||String(I.type||"").toLowerCase()==="transfer").reduce((I,R)=>I+(R.sentAmount!=null?Number(R.sentAmount):Number(R.amount||0)),0);let v=0;try{v=o.reduce((I,R)=>I+Bs.calculateTransactionProfit(R),0)}catch{}let f=0;try{const I=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(t),R=Je(je(U,"dailySales"),de("userId","==",(s==null?void 0:s.uid)||""));f=(await Re(R)).docs.map(J=>J.data()).filter(J=>String(J.date||I)===I).reduce((J,be)=>J+Number(be.sellingPrice||be.price||0)*Number(be.quantity||1),0)}catch{}let g=0;try{g=(ft||[]).filter(R=>String(R.status||"")==="pending").reduce((R,me)=>{const _=Number(me.paidAmount||0)+(Array.isArray(me.partialPayments)?me.partialPayments:[]).reduce((J,be)=>J+Number(be.amount||0),0);return R+Math.max(0,Number(me.amount||0)-_)},0)}catch{}let j="";try{const I=k||(b==null?void 0:b.shopId)||null,R=I?Je(je(U,"deficiencies"),de("shopId","==",I)):Je(je(U,"deficiencies"),de("userId","==",(s==null?void 0:s.uid)||""));j=(await Re(R)).docs.map(be=>be.data()).filter(be=>String(be.status||"pending")==="pending").slice(0,10).map((be,Ve)=>`${Ve+1}- ${String(be.name||be.productName||"عنصر")} × ${Number(be.quantity||be.qty||0)}`).join(`
`)}catch{}return[`تقرير يومي - ${a}`,`عدد العمليات: ${h}`,`إجمالي المسحوبات: ${m} جنيه`,`إجمالي الإرسال: ${u} جنيه`,`الأرباح: ${v} جنيه`,`إجمالي مبيعات الاكسسوار: ${f} جنيه`,`إجمالي الديون: ${g} جنيه`,"نواقص الاكسسوار:",j||"لا توجد عناصر مسجلة"].join(`
`)}const Rc=Ke.useCallback(()=>{let t=Wc;const a=Lo.trim();if(a&&(t=t.filter(r=>{const l=r;return String(l.type||"").toLowerCase()==="cash_addition"||String(l.txnType||"").toLowerCase()==="cash_addition"||String(l.title||"").includes("إيصال إضافة نقدية")?!0:r.senderPhone&&r.senderPhone.includes(a)||r.receiverPhone&&r.receiverPhone.includes(a)})),Jn){const r=new Date(Jn);t=t.filter(l=>{const o=new Date(l.createdAt);if(Kn){const[h,m]=Kn.split(":"),u=new Date(r);u.setHours(parseInt(h),parseInt(m),0,0);const v=new Date(u);return v.setHours(v.getHours()+1),o>=u&&o<v}else return o.toDateString()===r.toDateString()})}try{t=[...t].sort((r,l)=>{const o=new Date(r.createdAt||0).getTime();return new Date(l.createdAt||0).getTime()-o})}catch{}return t},[Wc,Lo,Jn,Kn]),Bc=async()=>{if(wt||Rt){i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"});return}if(!(s!=null&&s.uid)){i({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}try{const t=await Fc(),a=s!=null&&s.uid?`tg_daily_report_last_${s.uid}`:"tg_daily_report_last",r=Date.now();let l=!0;try{const o=localStorage.getItem(a);if(o){const h=JSON.parse(o),m=Number((h==null?void 0:h.at)||0);r-m<3e4&&(l=!1)}}catch{}if(l){await Xa.send(s.uid,t);try{localStorage.setItem(a,JSON.stringify({at:r}))}catch{}}i({title:"تم الإرسال",description:"تم إرسال التقرير اليومي إلى تليجرام",variant:"default"})}catch{i({title:"فشل الإرسال",description:"تعذّر إرسال التقرير اليومي إلى تليجرام",variant:"destructive"})}},[Vh,yi]=n.useState(!1),[Uc,bi]=n.useState(""),[Jh,vi]=n.useState(!1),[Kl,Yl]=n.useState(""),[Kh,st]=n.useState(!1),[Yh,Hl]=n.useState(!1),Fr=async(t,a=2,r=700)=>{let l;for(let o=0;o<=a;o++)try{return await t()}catch(h){if(l=h,o===a)break;await new Promise(m=>setTimeout(m,r*Math.pow(2,o)))}throw l};Ue.reduce((t,a)=>t+(tt[a.id]||0),0);const Hh=async t=>await Ms.verifyMasterPin(t,s==null?void 0:s.uid),wi=async t=>await Ms.verifyMasterPin(t,s==null?void 0:s.uid);n.useEffect(()=>{if(s!=null&&s.uid){try{const t=ds(),a=`walletBalances_${s.uid}`,r=localStorage.getItem(t)??localStorage.getItem(a);if(r){const l=JSON.parse(r);fs(l&&typeof l=="object"?l:{});try{localStorage.setItem(t,JSON.stringify(l||{}))}catch{}}}catch{}try{const t=zt(),a=`cashBalance_${s.uid}`,r=`userCashBalance_${s.uid}`;let l=localStorage.getItem(t)??localStorage.getItem(a)??localStorage.getItem(r);if(l!=null){const o=parseFloat(l);cs(Number.isFinite(o)?o:0);try{localStorage.setItem(t,String(Number.isFinite(o)?o:0)),localStorage.removeItem(a),localStorage.removeItem(r)}catch{}}}catch{}}},[s==null?void 0:s.uid,k,b==null?void 0:b.shopId]),n.useEffect(()=>{const t=a=>{var r;try{const l=Number((r=a==null?void 0:a.detail)==null?void 0:r.value);if(Number.isFinite(l))cs(l);else{const o=localStorage.getItem(zt());o!=null&&cs(parseFloat(o)||0)}}catch{const l=localStorage.getItem(zt());l!=null&&cs(parseFloat(l)||0)}};return window.addEventListener("cashBalanceChanged",t),()=>window.removeEventListener("cashBalanceChanged",t)},[s==null?void 0:s.uid,k,b==null?void 0:b.shopId]);const{data:Ql}=An({queryKey:["dashboardData",k||(b==null?void 0:b.shopId)],queryFn:async()=>{const t=k||(b==null?void 0:b.shopId);if(!t)return null;const a=Oe(U,"dashboardData",t),r=await Ls(a);return r.exists()?r.data():null},enabled:!!(s!=null&&s.uid&&(k||b!=null&&b.shopId)),staleTime:1e3*60*5,refetchInterval:1e3*60*5});n.useEffect(()=>{if(Ql){const t=Ql,a=Number((t==null?void 0:t.cashBalance)||0),r=t!=null&&t.walletBalances&&typeof t.walletBalances=="object"?t.walletBalances:{};try{const l=t!=null&&t.lastUpdated?new Date(t.lastUpdated).getTime():0,o=localStorage.getItem(zt()+"_lastUpdated"),h=o?new Date(o).getTime():0;l>=h&&(cs(a),fs(r),localStorage.setItem(zt(),String(a)),localStorage.setItem(ds(),JSON.stringify(r)),t!=null&&t.lastUpdated&&(localStorage.setItem(zt()+"_lastUpdated",t.lastUpdated),localStorage.setItem(ds()+"_lastUpdated",t.lastUpdated)))}catch{}}},[Ql]);const qc=t=>`walletLimits_${(s==null?void 0:s.uid)||"default"}_${t||"none"}`,{data:Ni}=An({queryKey:["walletLimits",V],queryFn:async()=>{if(!V)return null;const t=Oe(U,"walletLimits",String(V)),a=await Ls(t);return a.exists()?a.data():null},enabled:!!V,staleTime:1e3*60*5});n.useEffect(()=>{if(V)try{const t=qc(V),a=localStorage.getItem(t);if(a&&!Ni){const r=JSON.parse(a);Wr(r)}if(Ni){const r=Ni,l={walletId:V,dailyTransferLimit:r.dailyTransferLimit??6e4,dailyWithdrawLimit:r.dailyWithdrawLimit??1e5,dailyTransferUsed:r.dailyTransferUsed??0,dailyWithdrawUsed:r.dailyWithdrawUsed??0,monthlyTransferLimit:r.monthlyTransferLimit??2e5,monthlyWithdrawLimit:r.monthlyWithdrawLimit??2e5,monthlyTransferUsed:r.monthlyTransferUsed??0,monthlyWithdrawUsed:r.monthlyWithdrawUsed??0};Wr(l);try{localStorage.setItem(qc(V),JSON.stringify(l))}catch{}}}catch{}},[V,Ni]),n.useEffect(()=>{if(!V)return;const t=Ue.find(a=>a.id===V);if(t!=null&&t.name){pc(String(t.name));try{localStorage.setItem(`walletName_${(s==null?void 0:s.uid)||"default"}_${V}`,String(t.name))}catch{}return}try{const a=localStorage.getItem(`walletName_${(s==null?void 0:s.uid)||"default"}_${V}`);a&&pc(String(a))}catch{}},[V,Ue]);const Gl=async()=>{try{if(!V)return;const t=await Aa.autoResetLimitsIfNeeded(V);Wr(t)}catch(t){console.error("خطأ في جلب حدود المحفظة المختارة:",t)}};n.useEffect(()=>{Gl()},[V]),n.useEffect(()=>{const t=a=>{var r;(r=a==null?void 0:a.detail)!=null&&r.walletId&&a.detail.walletId===V&&Gl()};return window.addEventListener("walletLimitsUpdated",t),()=>window.removeEventListener("walletLimitsUpdated",t)},[V]),n.useEffect(()=>{const t=a=>{var r;try{const l=String(((r=a==null?void 0:a.detail)==null?void 0:r.walletId)||"");l&&bn(l,"sms:auto")}catch{}};return window.addEventListener("walletSelection:update",t),()=>window.removeEventListener("walletSelection:update",t)},[Ue]),n.useEffect(()=>{if(D.state){if(console.log("Location state:",D.state),D.state.openDebtDialog&&(gl(),window.history.replaceState({},document.title)),D.state.openSalesDialog&&(wt||Rt?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):sn(!0),window.history.replaceState({},document.title)),D.state.openMaintenanceDialog&&(wt||Rt?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Qn(!0),window.history.replaceState({},document.title)),D.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),wt||Rt?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Hn(!0),window.history.replaceState({},document.title)),D.state.openShopExpensesDialog&&(wt||Rt?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ms.hasMasterPin()?Ze(!0):la(!0),window.history.replaceState({},document.title)),D.state.openDeficienciesDialog&&(wt||Rt?i({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ge(!0),window.history.replaceState({},document.title)),D.state.openInstallment&&(wt||Rt?i({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"}):Yn(!0),window.history.replaceState({},document.title)),D.state.openTransactionSection){const t=document.getElementById("transaction-section");t&&t.scrollIntoView({behavior:"smooth"}),D.state.transactionType&&To(D.state.transactionType),D.state.startNewTransaction&&(Tr(""),Xr(""),Vi(""),Ji(""),console.log("🔒 Starting new transaction without changing wallet selection")),D.state.focusWalletSelection&&setTimeout(()=>{const a=document.querySelector('[data-testid="wallet-select"]');a&&a.focus()},500),window.history.replaceState({},document.title)}D.state.openCashierShiftModal&&(!Ia||Rt?i({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):pe(!0),window.history.replaceState({},document.title)),D.state.openMachineDailyDialog&&(!Ia||Rt?i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):Gn(!0),window.history.replaceState({},document.title)),D.state.openBranchManagement&&((Ws==null?void 0:Ws.status)==="active"?Le(!0):te(!0),window.history.replaceState({},document.title))}},[D.state,Ue,Rt,Ws]),n.useEffect(()=>{D.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),Zl(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",D.pathname)},[D.pathname,s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;(async()=>{try{const a=Oe(U,"users",s.uid),r=await Ls(a);if(r.exists()){const o=r.data().isActive===!0;o&&!ls?(Ft(!0),L(!1),ia(!1)):!o&&ls&&(Ft(!1),L(!0))}}catch(a){console.error("Check user status error",a)}})()},[s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;const t=r=>{const{userId:l}=r.detail;l===s.uid&&(console.log("🎉 Subscription activation event received for current user!"),Ft(!0),L(!1),ia(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},a=r=>{const{userId:l,isActive:o}=r.detail;l===s.uid&&(console.log("🔄 User subscription update event received:",{userId:l,isActive:o}),o&&!ls&&(Ft(!0),L(!1),ia(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",t),window.addEventListener("userSubscriptionUpdated",a),()=>{window.removeEventListener("subscriptionActivated",t),window.removeEventListener("userSubscriptionUpdated",a)}},[s==null?void 0:s.uid,ls]),n.useEffect(()=>{const t=a=>{var h;const r=a.target,l=(h=r==null?void 0:r.tagName)==null?void 0:h.toLowerCase();if(!(l==="input"||l==="textarea"||l==="select"||((r==null?void 0:r.isContentEditable)??!1))&&!(a.ctrlKey||a.altKey||a.metaKey)&&!a.repeat){if((wt||Rt)&&a.key>="1"&&a.key<="9"){a.preventDefault();return}switch(a.key){case"1":break;case"2":al(!0);break;case"3":wt||Rt?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Hn(!0);break;case"4":Ia?pe(!0):i({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"5":wt||Rt?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):sn(!0);break;case"6":gl();break;case"7":wt||Rt?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Qn(!0);break;case"8":Ia?Gn(!0):i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"9":wt||Rt?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ms.hasMasterPin()?Ze(!0):la(!0);break}}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[wt,Rt,Ia]),n.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:s==null?void 0:s.uid,isCheckingActivation:os}),(async()=>{try{if(!(s!=null&&s.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),ia(!1);return}try{const h=await Ls(Oe(U,"users",s.uid));if(h.exists()){const u=h.data().isActive===!0,v=await od.checkTrialValidity(s.uid),f=v.isValid&&!v.isExpired;Ft(u||f),gs(f),ca(v.hoursRemaining),Ja(v.hasUsedTrial),L(!u&&!f),console.log("📊 حالة المستخدم:",{isActive:u,isOnTrial:f,hoursRemaining:v.hoursRemaining,hasUsedTrial:v.hasUsedTrial})}else Ft(!1),L(!0)}catch(h){console.error("خطأ في فحص حالة تفعيل المستخدم:",h),Ft(!1),L(!0)}finally{ia(!1)}if(console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:s==null?void 0:s.uid}),s!=null&&s.uid){const h=await Fr(()=>Ae.getUserData(s.uid)),m=`userData_${s==null?void 0:s.uid}`;let u=null;try{const v=localStorage.getItem(m);v&&(u=JSON.parse(v))}catch{}if(h){let v=(h==null?void 0:h.walletBalances)||{},f=h==null?void 0:h.cashBalance;if(u){const g=u.lastUpdated?new Date(u.lastUpdated).getTime():0,j=h.lastUpdated?new Date(h.lastUpdated).getTime():0;g>=j&&(u.walletBalances&&(v=u.walletBalances),u.cashBalance!==void 0&&(f=u.cashBalance))}fs(v),f!==void 0&&cs(f);try{const g=s!=null&&s.uid?await Fr(()=>In.getDeletedTransactionsByUser(s.uid)):[];nn(g||[])}catch{nn([])}}else{fs({});try{const v=s!=null&&s.uid?await In.getDeletedTransactionsByUser(s.uid):[];nn(v||[])}catch{nn([])}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const h=await Fr(()=>ya.getByMerchantId((s==null?void 0:s.uid)||""));if(h&&h.length>0){console.log("✅ تم العثور على محافظ في Firebase:",h.length);const u=h.filter(g=>g.isActive===!0).map(g=>({id:g.id,name:g.label||"محفظة بدون اسم",phone:g.msisdn,isDefault:!1,monthlyWithdrawalLimit:g.monthlyWithdrawalLimit??g.withdrawLimit??2e5,monthlyTransferLimit:g.monthlyTransferLimit??g.transferLimit??2e5,defaultTransferCommission:g.defaultTransferCommission!=null?Number(g.defaultTransferCommission):null,defaultWithdrawCommission:g.defaultWithdrawCommission!=null?Number(g.defaultWithdrawCommission):null}));Pr(u);const v=localStorage.getItem(gr());let f=null;v&&u.find(g=>g.id===v)?f=u.find(g=>g.id===v):f=u[0],f&&(is(f.id),Oa(f.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else console.log("⚠️ لا توجد محافظ في Firebase. سيتم عرض قائمة فارغة بدون أي استرجاع محلي."),Pr([])}catch(h){console.error("خطأ في تحميل المحافظ من Firebase:",h),Pr([])}const o=s!=null&&s.uid?await Fr(()=>Ae.getUserTransactions(s.uid)):[];if(o&&o.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",o.length);const h=o.map(g=>({...g,createdAt:new Date(g.createdAt),senderPhone:g.senderMsisdn||g.senderPhone||"",receiverPhone:g.receiverMsisdn||g.receiverPhone||"",type:g.txnType==="send"?"send":g.txnType==="receive"?"withdraw":g.type||"withdraw",status:g.status==="confirmed"?"completed":g.status||"completed"})),m=rn.map(g=>g.id||g.originalTransactionId);let u=[];try{const g=Je(je(U,"deletedTransactions"),de("userId","==",(s==null?void 0:s.uid)||""),de("permanent","==",!0));u=(await Re(g)).docs.map(A=>{const I=A.data();return String(I.originalTransactionId||I.transactionId||A.id||"")}).filter(Boolean)}catch{}const v=new Set(u),f=h.filter(g=>{var _;const j=String(g.id||""),A=String(g.transactionId||""),I=String(g.reference||g.transactionReference||((_=g.receipt)==null?void 0:_.reference)||""),R=m.includes(j),me=v.has(j)||A&&v.has(A);return!R&&!me});console.log("✅ تم فلترة المعاملات المحذوفة:",{total:o.length,deleted:m.length,active:f.length});{const g=new Set,j=[];for(const A of f){const I=Ac(A);g.has(I)||(g.add(I),j.push(A))}Tm||ea(j)}}await Lc()}catch(o){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",o)}})().then(async()=>{await l(),await a(),await r()});const a=async()=>{try{if(!(s!=null&&s.uid))return;const o=await ya.getByMerchantId(s.uid);await Promise.all(o.map(h=>Fx.autoResetLimitsIfNeeded(h.id)))}catch(o){console.error("خطأ في التصفير التلقائي للحدود:",o)}},r=async()=>{try{await Bs.syncReportsDataFromFirebase(s==null?void 0:s.uid);const o=Bs.getReportsData(s==null?void 0:s.uid);if((o.lastDailyResetDate?Bs.shouldResetDailyReports(o.lastDailyResetDate):!1)&&(s!=null&&s.uid)&&o.lastDailyResetDate){const u=new Date(o.lastDailyResetDate),v=u.toDateString(),f=Ye.filter(_=>new Date(_.createdAt).toDateString()===v&&_.status==="completed"),g=f.length,j=f.reduce((_,J)=>_+J.amount,0),A=f.filter(vn).reduce((_,J)=>{const be=J.withdrawnAmount!==void 0?J.withdrawnAmount:J.amount;return _+be},0),I=f.filter(wn).reduce((_,J)=>{const be=J.sentAmount!==void 0?J.sentAmount:J.amount;return _+be},0),R=f.reduce((_,J)=>_+Bs.calculateTransactionProfit(J),0),me=new Date(u).toISOString().slice(0,10);await Sn.add({userId:s.uid,reportDate:me,totalTransactions:g,totalAmount:Number(j.toFixed(2)),totalWithdrawn:Number(A.toFixed(2)),totalSent:Number(I.toFixed(2)),profit:Number(R.toFixed(2)),walletId:null})}const m=Bs.autoResetReportsIfNeeded(s==null?void 0:s.uid);(m.dailyReset||m.monthlyReset)&&console.log("تم التصفير التلقائي:",m)}catch(o){console.error("خطأ في التصفير التلقائي للتقارير:",o)}},l=async()=>{try{if(!(s!=null&&s.uid))return;const o=new Date;if(o.getDate()!==1)return;const h=`${o.getFullYear()}-${o.getMonth()+1}`,m=`lastMonthlyDbCleanup:${s.uid}`;if(localStorage.getItem(m)===h)return;const v=new Date(o.getFullYear(),o.getMonth(),1,0,0,0,0),f=A=>A instanceof Date?A:typeof(A==null?void 0:A.toDate)=="function"?A.toDate():new Date(String(A));let g=[];try{const A=Je(je(U,"userTransactions"),de("userId","==",s.uid),de("createdAt","<",v));g=(await Re(A)).docs}catch{const A=Je(je(U,"userTransactions"),de("userId","==",s.uid));g=(await Re(A)).docs.filter(R=>{var me;return f((me=R.data())==null?void 0:me.createdAt)<v})}await Promise.allSettled(g.map(A=>va(A.ref)));let j=[];try{const A=Je(je(U,"transactions"),de("userId","==",s.uid),de("createdAt","<",v));j=(await Re(A)).docs}catch{const A=Je(je(U,"transactions"),de("userId","==",s.uid));j=(await Re(A)).docs.filter(R=>{var me;return f((me=R.data())==null?void 0:me.createdAt)<v})}await Promise.allSettled(j.map(A=>va(A.ref)));try{localStorage.setItem(m,h)}catch{}console.log("✅ تم تنظيف قاعدة البيانات شهريًا (Firebase فقط):",{userTransactionsDeleted:g.length,globalTransactionsDeleted:j.length,monthStart:v})}catch(o){console.error("فشل التنظيف الشهري التلقائي لقاعدة البيانات:",o)}};fh(),Il(),Ph(),console.log("🔥 useEffect loadUserData completed")},[s==null?void 0:s.uid]);const Zl=async()=>{var t;if(s!=null&&s.uid)try{const a=await Fr(()=>ya.getByMerchantId(s.uid));if(a&&a.length>0){const l=a.filter(o=>o.isActive===!0).map(o=>({id:o.id,name:o.label||"محفظة بدون اسم",phone:o.msisdn,isDefault:!1,monthlyWithdrawalLimit:o.monthlyWithdrawalLimit??o.withdrawLimit??2e5,monthlyTransferLimit:o.monthlyTransferLimit??o.transferLimit??2e5,defaultTransferCommission:o.defaultTransferCommission!=null?Number(o.defaultTransferCommission):void 0,defaultWithdrawCommission:o.defaultWithdrawCommission!=null?Number(o.defaultWithdrawCommission):void 0}));if(Pr(l),s!=null&&s.uid){const o=localStorage.getItem(gr());if(!!(V&&l.find(m=>m.id===V)))console.log("🔒 Preserving current wallet selection:",V);else{const u=(o&&l.find(v=>v.id===o)?o:null)||((t=l[0])==null?void 0:t.id);u&&(console.log("🔄 Fixing invalid wallet selection:",u),bn(u))}}console.log("🔄 تم تحديث المحافظ من Firebase:",l.length)}}catch(a){console.error("خطأ في تحميل المحافظ من Firebase:",a)}};n.useEffect(()=>{const t=D.pathname;if(sessionStorage.getItem("previousPath")==="/user/add-wallet"&&t==="/user/dashboard"){$.invalidateQueries({queryKey:["wallets",s==null?void 0:s.uid]});try{zn.refetch()}catch{}sessionStorage.removeItem("previousPath")}sessionStorage.setItem("previousPath",t)},[D.pathname,s==null?void 0:s.uid]),n.useEffect(()=>{const t=()=>{$.invalidateQueries({queryKey:["wallets",s==null?void 0:s.uid]});try{zn.refetch()}catch{}};return window.addEventListener("focus",t),()=>{window.removeEventListener("focus",t)}},[s==null?void 0:s.uid,V,Ue]);const bn=async(t,a="unknown")=>{console.log(`🎯 setWalletSelection called from ${a} with walletId:`,t),console.log("🔍 Previous selectedWallet:",V),is(t);const r=Ue.find(l=>l.id===t);if(r&&(Oa(r.phone),console.log("✅ Wallet set successfully:",t,"Phone:",r.phone)),s!=null&&s.uid){localStorage.setItem(gr(),t),console.log("💾 Saved wallet to localStorage:",t);try{await Dn.set({key:"selected_wallet_id",value:t}),await Dn.set({key:"current_user_id",value:s.uid}),console.log("📱 Saved wallet and user ID to Capacitor Preferences:",t,s.uid)}catch(l){console.error("❌ Failed to save to Capacitor Preferences:",l)}}};n.useEffect(()=>{const t=()=>{Zl()};try{window.addEventListener("wallets:activation-updated",t)}catch{}return()=>{try{window.removeEventListener("wallets:activation-updated",t)}catch{}}},[s==null?void 0:s.uid]);const Qh=t=>{if(t==="__add_wallet"){E("/user/add-wallet");return}if(t==="__view_wallets"){Bn(!0);return}mx.isEnabled(s==null?void 0:s.uid)?(zi(t),qi(!0)):bn(t,"walletSelectionNoPin")},ji=t=>{console.log("🔄 handleTransactionTypeChange called with type:",t),console.log("🔍 Current selectedWallet before change:",V),console.log("🔍 Available wallets count:",Ue.length),To(t),Tr(""),Xr(""),Vi(""),Ji(""),console.log("✅ Transaction type changed to:",t,"- Wallet selection preserved:",V),setTimeout(()=>{const a=document.getElementById("transaction-section");a&&a.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)};n.useEffect(()=>{const t=a=>{const r=a.target;if(!!r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"||r.tagName==="SELECT"||r.isContentEditable)||(a.key==="ArrowLeft"?(a.preventDefault(),ji("withdraw")):a.key==="ArrowRight"&&(a.preventDefault(),ji("transfer"))),a.key==="Enter"){const o=ye==="transfer"?"transferSubmitButton":"withdrawSubmitButton",h=document.getElementById(o);h&&!h.disabled&&(a.preventDefault(),h.click())}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[ye]);const zc=t=>{Cm((r=>({id:r.id,type:r.type==="send"?"transfer":"withdraw",sender_msisdn:r.senderPhone,receiver_msisdn:r.receiverPhone,amount:r.amount,commission:r.commission||0,fee:(r==null?void 0:r.fee)??0,status:r.status==="failed"?"failed":r.status==="completed"?"completed":"pending",createdAt:new Date(r.createdAt).toISOString(),updatedAt:new Date(r.createdAt).toISOString(),shopName:K??(b==null?void 0:b.shopName)??(s==null?void 0:s.displayName)??"المحل",cashierName:(r==null?void 0:r.cashierName)??null,commissionMode:(r==null?void 0:r.commissionMode)??(r.type==="send"||At?"add":"deduct"),totalCharged:(r==null?void 0:r.totalCharged)??(r.type==="send"?Number(r.amount||0)+Number(r.commission||0)+Number((r==null?void 0:r.fee)||0):At?Number(r.amount||0)+Number(r.commission||0):Number(r.amount||0)),note:(r==null?void 0:r.note)??(r==null?void 0:r.notes)??void 0,senderName:(r==null?void 0:r.senderName)??void 0,provider:(r==null?void 0:r.provider)??void 0,title:(()=>{const l=String((r==null?void 0:r.provider)||"").toLowerCase(),o=l.includes("vodafone")?"vf-cash":l.includes("instapay")?"instapay":"",h=r.type==="send"?"تحويل":"سحب";return r.type==="withdraw"&&o?`${h} ${o}`:h})()}))(t)),Vn(!0)},Gh=async t=>{var o;if(!(s!=null&&s.uid)){i({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const a=Ye.find(h=>h.id===t);if(!a){i({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}const r=String(t),l=String((a==null?void 0:a.transactionId)||(a==null?void 0:a.reference)||"");Da.current.add(r),l&&Da.current.add(l);try{console.log("🗑️ بدء عملية حذف المعاملة:",t),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:a.id,userId:s.uid,transactionData:a}),await Ae.removeUserTransaction(s.uid,a.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await In.saveDeletedTransaction({...a,userId:s.uid,originalTransactionId:a.id,transactionId:a.transactionId||a.id,reference:a.reference||a.transactionReference||((o=a.receipt)==null?void 0:o.reference),deletedAt:new Date().toISOString(),permanent:!0}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(u){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",u)}try{await In.permanentlyDeleteTransaction(a.id,s.uid)}catch(u){console.warn("⚠️ فشل وسم الحذف النهائي أو التنظيف الإضافي:",u)}const h=[...rn,a],m=Ye.filter(u=>u.id!==t);nn(h),ea(m),Eo(!1),console.log("✅ تم تحديث الحالة بعد الحذف من Firebase (بدون نسخ محلية)");try{const u=a.fromWallet;if(u){const{walletDailyLimitsService:v}=await xt(async()=>{const{walletDailyLimitsService:g}=await import("./index-BwuekbvX.js").then(j=>j.co);return{walletDailyLimitsService:g}},__vite__mapDeps([0,1]),import.meta.url),f=await v.getWalletLimits(u);if(f){const g=a.type==="send",j={updatedAt:(await xt(async()=>{const{serverTimestamp:_}=await import("./index-BwuekbvX.js").then(J=>J.ci);return{serverTimestamp:_}},__vite__mapDeps([0,1]),import.meta.url)).serverTimestamp()};g?(j.dailyTransferUsed=Math.max(0,(f.dailyTransferUsed||0)-a.amount),j.monthlyTransferUsed=Math.max(0,(f.monthlyTransferUsed||0)-a.amount)):(j.dailyWithdrawUsed=Math.max(0,(f.dailyWithdrawUsed||0)-a.amount),j.monthlyWithdrawUsed=Math.max(0,(f.monthlyWithdrawUsed||0)-a.amount));const{doc:A,setDoc:I}=await xt(async()=>{const{doc:_,setDoc:J}=await import("./index-BwuekbvX.js").then(be=>be.ci);return{doc:_,setDoc:J}},__vite__mapDeps([0,1]),import.meta.url),{db:R}=await xt(async()=>{const{db:_}=await import("./index-BwuekbvX.js").then(J=>J.cj);return{db:_}},__vite__mapDeps([0,1]),import.meta.url),me=A(R,"walletLimits",u);await I(me,j,{merge:!0})}}}catch(u){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",u)}try{const{ProfitService:u}=await xt(async()=>{const{ProfitService:A}=await import("./profitService-BQtHSEJV.js");return{ProfitService:A}},__vite__mapDeps([3,0,1]),import.meta.url),{ReportsService:v}=await xt(async()=>{const{ReportsService:A}=await import("./index-BwuekbvX.js").then(I=>I.cn);return{ReportsService:A}},__vite__mapDeps([0,1]),import.meta.url),g={txnType:a.type==="send"?"send":"receive",amount:a.amount,commission:a.commission||0,createdAt:a.createdAt,status:"confirmed"},j=u.calculateProfitFromTransaction(g);j>0&&u.addProfit(-j,s.uid);try{v.removeTransactionEffects(a,s.uid)}catch{}}catch(u){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",u)}i({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(h){console.error("❌ خطأ في حذف المعاملة من Firebase:",h);let m="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";h instanceof Error&&(h.message.includes("network")||h.message.includes("offline")?m="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":h.message.includes("permission")||h.message.includes("unauthorized")?m="ليس لديك صلاحية لحذف هذه المعاملة":h.message.includes("not-found")&&(m="المعاملة غير موجودة أو تم حذفها مسبقاً")),i({title:"خطأ في الحذف",description:m,variant:"destructive"})}},vn=t=>{const a=t.type,r=t.txnType;return a==="withdraw"||a==="withdrawal"||a==="receive"||r==="receive"},wn=t=>{const a=t.type,r=t.txnType;return a==="send"||a==="transfer"||r==="send"},Nn=(t,a)=>{const r=new Date().toDateString();let l=Ye.filter(f=>{const g=new Date(f.createdAt).toDateString()===r,j=String(f.status||"").toLowerCase();return g&&(j==="completed"||j==="confirmed"||j==="pending")});$a&&$a.trim()!==""&&(l=l.filter(f=>f.senderPhone&&f.senderPhone.includes($a)||f.receiverPhone&&f.receiverPhone.includes($a)));const o=Bs.filterVisibleTransactions(l,"daily",s==null?void 0:s.uid),h=o.length,m=o.reduce((f,g)=>f+g.amount,0),u=o.filter(vn).reduce((f,g)=>{const j=g.withdrawnAmount!==void 0?g.withdrawnAmount:g.amount;return f+j},0),v=o.filter(wn).reduce((f,g)=>{const j=g.sentAmount!==void 0?g.sentAmount:g.amount;return f+j},0);return{totalTransactions:h,totalAmount:m,totalWithdrawn:u,totalSent:v}},jn=t=>{const a=new Date().getMonth(),r=new Date().getFullYear();let l=Ye.filter(f=>{const g=new Date(f.createdAt);return g.getMonth()===a&&g.getFullYear()===r&&f.status==="completed"});$a&&$a.trim()!==""&&(l=l.filter(f=>f.senderPhone&&f.senderPhone.includes($a)||f.receiverPhone&&f.receiverPhone.includes($a)));const o=Bs.filterVisibleTransactions(l,"monthly",s==null?void 0:s.uid),h=o.length,m=o.reduce((f,g)=>f+g.amount,0),u=o.filter(vn).reduce((f,g)=>{const j=g.withdrawnAmount!==void 0?g.withdrawnAmount:g.amount;return f+j},0),v=o.filter(wn).reduce((f,g)=>{const j=g.sentAmount!==void 0?g.sentAmount:g.amount;return f+j},0);return{totalTransactions:h,totalAmount:m,totalWithdrawn:u,totalSent:v}},Zh=t=>{const a=new Date().getMonth(),r=new Date().getFullYear(),l=Ye.filter(m=>{const u=new Date(m.createdAt);return u.getMonth()===a&&u.getFullYear()===r&&m.status==="completed"&&m.fromWallet===t}),o=l.filter(vn).reduce((m,u)=>{const v=u.withdrawnAmount||u.amount;return m+v},0),h=l.filter(wn).reduce((m,u)=>{const v=u.sentAmount||u.amount;return m+v},0);return{totalWithdrawn:o,totalTransferred:h}},Xh=t=>{const a=new Date,r=a.getDate(),l=a.getMonth(),o=a.getFullYear(),h=Ye.filter(v=>{const f=new Date(v.createdAt);return f.getDate()===r&&f.getMonth()===l&&f.getFullYear()===o&&v.status==="completed"&&v.fromWallet===t}),m=h.filter(vn).reduce((v,f)=>{const g=f.withdrawnAmount||f.amount;return v+g},0),u=h.filter(wn).reduce((v,f)=>{const g=f.sentAmount||f.amount;return v+g},0);return{totalWithdrawn:m,totalTransferred:u}},Vc=Ke.useMemo(()=>jn(),[Ye,V,$a]);Vc.totalWithdrawn,Vc.totalSent;const Wa=Ke.useMemo(()=>Zh(V),[Ye,V]);n.useEffect(()=>{try{if(!V||Ue.length===0)return;const t=Ue.find(I=>I.id===V);if(!t)return;const a=(Xe==null?void 0:Xe.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,r=(Xe==null?void 0:Xe.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,l=parseFloat(ks||"0")||0,o=(Wa==null?void 0:Wa.totalWithdrawn)??(Xe==null?void 0:Xe.monthlyWithdrawUsed)??0,h=(Wa==null?void 0:Wa.totalTransferred)??(Xe==null?void 0:Xe.monthlyTransferUsed)??0,m=o+(ye==="withdraw"?l:0),u=h+(ye==="transfer"?l:0),v=.85,f=Math.floor(Math.max(a,1)*v),g=Math.floor(Math.max(r,1)*v),j=(()=>{const I=new Date;return`${I.getFullYear()}-${String(I.getMonth()+1).padStart(2,"0")}`})(),A=`monthlyLimitWarnShown:${V}:${j}`;if(m>=f){const I=`${A}:withdraw`;if(!(localStorage.getItem(I)==="true")){Ao({type:"withdraw",used:m,limit:a,walletName:t.name}),Io(!0);try{localStorage.setItem(I,"true")}catch{}return}}if(u>=g){const I=`${A}:transfer`;if(!(localStorage.getItem(I)==="true")){Ao({type:"transfer",used:u,limit:r,walletName:t.name}),Io(!0);try{localStorage.setItem(I,"true")}catch{}return}}}catch{}},[V,Ue,Xe,Wa,ye,ks]);const Jc=async()=>{var ys,Ds,Ga,Rr;wp(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:da,receiverPhone:Fs,amount:ks,transactionType:ye});const t=()=>{ye==="transfer"?_r(!0):ln(!0)},a=()=>{ye==="transfer"?_r(!1):ln(!1)};if(t(),!da||!ks){console.log("❌ خطأ: بيانات ناقصة"),i({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),a();return}if(ye==="transfer"&&!Fs&&!F){console.log("❌ خطأ: رقم المستقبل مفقود"),i({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),a();return}if(ye==="transfer"&&!F&&(String(Fs||"").replace(/[^0-9٠-٩]/g,""),!/[^0-9٠-٩\s]/.test(String(Fs||""))&&!Np(Fs))){i({title:"رقم المستقبل غير صالح",description:"اكتب رقم صحيح مكون من 11 رقم ويبدأ بـ 015 أو 010 أو 012 أو 011",variant:"destructive"}),a();return}const r=parseFloat(ks);if(console.log("💰 المبلغ المحول:",r),r<=0){console.log("❌ خطأ: مبلغ غير صحيح"),i({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),a();return}if(wt)try{const he=new Date,Pe=he.getFullYear(),at=String(he.getMonth()+1).padStart(2,"0"),qt=String(he.getDate()).padStart(2,"0"),Cs=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${Pe}-${at}-${qt}`,qs=localStorage.getItem(Cs);if((qs&&parseInt(qs,10)||0)>=10){i({title:"حد التأكيد اليومي",description:"باقة زيرو تسمح بـ 10 تأكيدات تحويل/سحب يومياً فقط.",variant:"destructive"}),a();return}}catch(he){console.warn("فشل قراءة عداد تأكيدات باقة زيرو من التخزين المحلي:",he)}const l=Ue.find(he=>he.id===V);if(!l){i({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),a();return}const o=Wa;if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:V,walletName:l.name,currentWithdrawn:o.totalWithdrawn,currentTransferred:o.totalTransferred,withdrawalLimit:l.monthlyWithdrawalLimit,transferLimit:l.monthlyTransferLimit}),ye==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${o.totalWithdrawn}, المبلغ الجديد: ${r}, الحد الأقصى: ${l.monthlyWithdrawalLimit}`),o.totalWithdrawn+r>l.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),i({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${l.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${o.totalTransferred}, المبلغ الجديد: ${r}, الحد الأقصى: ${l.monthlyTransferLimit}`),o.totalTransferred+r>l.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),i({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${l.monthlyTransferLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}b!=null&&b.shopName||s!=null&&s.displayName,Date.now().toString(),ye==="withdraw"&&en.trim()!==""&&en.trim(),l!=null&&l.name,ye==="transfer"||cr&&cr.trim()!==""&&cr.trim(),y&&(N!=null&&N.name||N!=null&&N.username)&&(N!=null&&N.name||(N==null||N.username));const h=Kr.validateTransaction(r,ye,Ot,tt);if(!h.isValid){i({title:"خطأ في العملية",description:h.error,variant:"destructive"}),a();return}h.warning&&i({title:"تحذير",description:h.warning,variant:"destructive"});let m;if(ye==="transfer")if((l==null?void 0:l.defaultTransferCommission)!=null){const he=Number(l.defaultTransferCommission)||0;m=Math.round(he*r/1e3*100)/100}else _s&&_s.trim()!==""?m=Math.max(0,parseFloat(_s)):m=0;else if((l==null?void 0:l.defaultWithdrawCommission)!=null){const he=Number(l.defaultWithdrawCommission)||0;m=Math.round(he*r/1e3*100)/100}else Ps&&Ps.trim()!==""?m=Math.max(0,parseFloat(Ps)):m=Math.round(r*.01*100)/100;if(ye!=="transfer"&&!At&&m>=r){i({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),a();return}const u=ye==="transfer"||At?r:Math.round((r-m)*100)/100;let v;const f=ye==="transfer"&&!!ga,g=ye==="withdraw"&&!!ga,j=f||g;let A=null;const I=Un(da||"").replace(/\D/g,""),R=Un(Fs||"").replace(/\D/g,""),me=ye==="transfer"&&(I.startsWith("010")&&(R.startsWith("011")||R.startsWith("012")||R.startsWith("015"))||I.startsWith("012")&&R.startsWith("010")||I.startsWith("011")&&R.startsWith("010")||I.startsWith("015")&&R.startsWith("010")),_=Math.max(0,parseFloat(Co||"0")),J=Math.round(m*100)/100;if(me&&!j&&_<=0){i({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"}),a();return}if(ye==="transfer"&&!j){const he=Number(tt[V]||0),Pe=Number(u)+Number(_);if(he<Pe){i({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${he} لا يكفي لخصم ${Pe}`,variant:"destructive"}),a();return}}if(j)if(f){const he=Kr.validateTransaction(u,"transfer",Ot,tt);if(!he.isValid)v={success:!1,newCashBalance:Ot,newWalletBalances:tt,message:he.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"};else{const Pe=V||((ys=Ue.find(ct=>ct.isDefault))==null?void 0:ys.id)||((Ds=Ue[0])==null?void 0:Ds.id),at=Xe??await Aa.getWalletLimits(Pe),qt=new Date().toDateString(),Cs=Ye.filter(ct=>ct.type==="send"&&String(ct.status||"").toLowerCase()==="pending"&&ct.fromWallet===Pe&&new Date(ct.createdAt).toDateString()===qt).reduce((ct,Rs)=>ct+Number(Rs.sentAmount??Rs.transferredAmount??Rs.amount??0),0),qs=Number((at==null?void 0:at.dailyTransferLimit)??6e4),aa=Number((at==null?void 0:at.dailyTransferUsed)??0);if(aa+Cs+Number(u)>qs){i({title:"تجاوز الحد اليومي للتحويل",description:`المتبقي اليوم: ${(qs-aa-Cs).toLocaleString()} ج.م`,variant:"destructive"}),a();return}const Vt=new Date,Os=Ye.filter(ct=>ct.type==="send"&&String(ct.status||"").toLowerCase()==="pending"&&ct.fromWallet===Pe&&new Date(ct.createdAt).getMonth()===Vt.getMonth()&&new Date(ct.createdAt).getFullYear()===Vt.getFullYear()).reduce((ct,Rs)=>ct+Number(Rs.sentAmount??Rs.transferredAmount??Rs.amount??0),0),zs=Number((at==null?void 0:at.monthlyTransferLimit)??2e5),Br=Number((at==null?void 0:at.monthlyTransferUsed)??0);if(Br+Os+Number(u)>zs){i({title:"تجاوز الحد الشهري للتحويل",description:`المتبقي هذا الشهر: ${(zs-Br-Os).toLocaleString()} ج.م`,variant:"destructive"}),a();return}v={success:!0,newCashBalance:Ot,newWalletBalances:tt}}}else{const he=V||((Ga=Ue.find(ct=>ct.isDefault))==null?void 0:Ga.id)||((Rr=Ue[0])==null?void 0:Rr.id),Pe=Xe??await Aa.getWalletLimits(he),at=new Date().toDateString(),qt=Ye.filter(ct=>ct.type==="withdraw"&&String(ct.status||"").toLowerCase()==="pending"&&ct.fromWallet===he&&new Date(ct.createdAt).toDateString()===at).reduce((ct,Rs)=>ct+Number(Rs.withdrawnAmount??Rs.amount??0),0),Cs=Number((Pe==null?void 0:Pe.dailyWithdrawLimit)??1e5),qs=Number((Pe==null?void 0:Pe.dailyWithdrawUsed)??0);if(qs+qt+Number(u)>Cs){i({title:"تجاوز الحد اليومي للسحب",description:`المتبقي اليوم: ${(Cs-qs-qt).toLocaleString()} ج.م`,variant:"destructive"}),a();return}const aa=new Date,Vt=Ye.filter(ct=>ct.type==="withdraw"&&String(ct.status||"").toLowerCase()==="pending"&&ct.fromWallet===he&&new Date(ct.createdAt).getMonth()===aa.getMonth()&&new Date(ct.createdAt).getFullYear()===aa.getFullYear()).reduce((ct,Rs)=>ct+Number(Rs.withdrawnAmount??Rs.amount??0),0),Os=Number((Pe==null?void 0:Pe.monthlyWithdrawLimit)??2e5),zs=Number((Pe==null?void 0:Pe.monthlyWithdrawUsed)??0);if(zs+Vt+Number(u)>Os){i({title:"تجاوز الحد الشهري للسحب",description:`المتبقي هذا الشهر: ${(Os-zs-Vt).toLocaleString()} ج.م`,variant:"destructive"}),a();return}v={success:!0,newCashBalance:Math.round((Number(Ot)-Number(u))*100)/100,newWalletBalances:tt}}else ye==="transfer"?v=await Kr.processTransfer({amount:u,currentCashBalance:Ot,currentWalletBalances:tt,wallets:Ue,selectedWalletId:V,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0}):v=await Kr.processWithdraw({amount:u,currentCashBalance:Ot,currentWalletBalances:tt,wallets:Ue,selectedWalletId:V,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0});if(!v.success){i({title:"فشل في العملية",description:v.error||v.message,variant:"destructive"}),a();return}let be=j?g?v.newCashBalance:Ot:v.newCashBalance,Ve=j?tt:v.newWalletBalances;if(!j&&ye==="transfer"&&_>0){const he=Number(Ve[V]||0);Ve={...Ve,[V]:Math.round((he-Number(_))*100)/100}}if(j&&f){const he=Ue.find(qt=>qt.id===V)??Ue.find(qt=>qt.isDefault)??Ue[0],Pe=(he==null?void 0:he.id)||V;if(Pe!==V)try{bn(Pe)}catch{}const at=Number(tt[Pe]||0);Ve={...tt,[Pe]:Math.round((at-Number(u)-Number(_))*100)/100}}if((f||g)&&ga&&!om){const he={id:`DEBT-${Date.now()}`,debtorName:ga.debtorName,amount:ga.amount,reason:ga.notes||"",customerId:ga.customerId,mobile:ga.mobile,status:"pending",createdAt:new Date};A=he.id;const Pe=[he,...ft];Es(Pe);try{if(await ma(Pe),s!=null&&s.uid){const at=Oe(U,"debts",he.id),qt={...he,userId:s.uid,shopId:k||(b==null?void 0:b.shopId)||null,lastUpdated:new Date().toISOString()};Object.keys(qt).forEach(Cs=>qt[Cs]===void 0&&delete qt[Cs]),await As(at,qt,{merge:!0})}}catch(at){console.error("⚠️ فشل حفظ الدين المؤجل محلياً أو سحابياً:",at)}i({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}if(!j){const he=Math.max(0,Number(m))+Math.max(0,Number(_));he>0&&(be=Math.round((be+he)*100)/100,console.log(`💰 تم إضافة عمولة/رسوم ${he} جنيه لدرج النقدية`))}console.log("⚡ تحديث الواجهة فوراً بدون حجب باستخدام startTransition...");const ms="temp_"+Date.now()+"_"+Math.random().toString(36).substring(7),sa={shopId:k||(b==null?void 0:b.shopId)||(s==null?void 0:s.uid)||"default-shop",lineId:V||"default-line",walletId:V||void 0,merchantUserId:(s==null?void 0:s.uid)||null,provider:"vodafone_cash",txnType:ye==="transfer"?"send":"receive",originType:ye==="transfer"?"transfer":"withdraw",amount:u,commission:J,fee:_,profit:0,senderMsisdn:da,receiverMsisdn:ye==="transfer"?Fs:da,note:ye==="transfer"?void 0:cr&&cr.trim()!==""?cr.trim():void 0,status:j?"pending":"confirmed",linkedDebtId:A||void 0,createdBy:(s==null?void 0:s.uid)||null,walletEffectAppliedOnCreation:!1,cashEffectAppliedOnCreation:!!(j&&g),limitsReservedOnCreation:!!j,limitReservedType:ye==="transfer"?"transfer":"withdraw",profitAddedOnCreation:!1},ut={...sa,id:ms,status:j?"pending":"completed",commissionMode:ye==="transfer"||At?"add":"deduct",totalCharged:ye==="transfer"?u+J+_:At?u+m:u,walletEffectAppliedOnCreation:!1,cashEffectAppliedOnCreation:!!(j&&g),limitsReservedOnCreation:!!j,limitReservedType:ye==="transfer"?"transfer":"withdraw",sentAmount:ye==="transfer"?u:void 0,transferredAmount:ye==="transfer"?u:void 0,withdrawnAmount:ye==="withdraw"?u:void 0,senderName:ye==="withdraw"&&en.trim()!==""?en.trim():void 0,createdAt:new Date,type:ye==="transfer"?"send":"withdraw",senderPhone:da||"",receiverPhone:Fs||""};try{La.current=[ut,...La.current],$.setQueryData(["recentTransactions",s==null?void 0:s.uid,k||"main"],he=>!he||!Array.isArray(he)?[ut]:[ut,...he])}catch(he){console.error("Error in optimistic update:",he)}if(V&&Xe)try{const he=ye==="transfer",Pe={...Xe};he?(Pe.dailyTransferUsed=(Pe.dailyTransferUsed||0)+u,Pe.monthlyTransferUsed=(Pe.monthlyTransferUsed||0)+u):(Pe.dailyWithdrawUsed=(Pe.dailyWithdrawUsed||0)+u,Pe.monthlyWithdrawUsed=(Pe.monthlyWithdrawUsed||0)+u),Wr(Pe)}catch(he){console.error("Error in optimistic limit update:",he)}const Pt=[ut,...Ye];Ke.startTransition(()=>{cs(be),fs(Ve),ea(Pt)});try{setTimeout(()=>{try{localStorage.setItem(Rl(),JSON.stringify(Pt))}catch{}},0)}catch{}if(wt)try{const he=new Date,Pe=he.getFullYear(),at=String(he.getMonth()+1).padStart(2,"0"),qt=String(he.getDate()).padStart(2,"0"),Cs=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${Pe}-${at}-${qt}`,qs=localStorage.getItem(Cs),aa=qs&&parseInt(qs,10)||0;localStorage.setItem(Cs,String(aa+1))}catch{}setTimeout(()=>{try{const he=new Date().toISOString();localStorage.setItem(zt(),be.toString()),localStorage.setItem(zt()+"_lastUpdated",he),localStorage.setItem(ds(),JSON.stringify(Ve)),localStorage.setItem(ds()+"_lastUpdated",he)}catch{}},0);try{if(s!=null&&s.uid){const he=Ue.find(Ur=>Ur.id===V)??Ue.find(Ur=>Ur.isDefault)??Ue[0],Pe=(he==null?void 0:he.id)||V,at=Number(Ve[Pe]||0),qt=String((he==null?void 0:he.phone)||da||"").trim(),Cs=String(Fs||"").trim(),qs=Number(_)>0,aa=ye==="transfer"?"🟢":"🔴",Vt=Number(J)>0?`${Number(J)} جنيه`:"0 جنيه",Os=qs?` و رسوم ${Number(_)} جنيه`:"",zs=ye==="transfer"?`${aa} تم تحويل مبلغ ${Number(u)} جنيه من رقم المحفظة ${qt} إلى رقم المحفظة ${Cs} وتم أخذ عمولة ${Vt}${Os}. الرصيد المتبقي في المحفظة: ${at} جنيه. الفلوس النقدية المتبقية: ${Number(be)} جنيه.`:`${aa} تم السحب مبلغ ${Number(u)} جنيه من الدرج إلى رقم المحفظة ${qt} وتم أخذ عمولة ${Vt}${Os}. الرصيد المتبقي في المحفظة: ${at} جنيه. الفلوس النقدية المتبقية: ${Number(be)} جنيه.`,Br=s!=null&&s.uid?`tg_last_msg_${s.uid}`:"tg_last_msg",ct=Date.now();let Rs=!0;try{const Ur=localStorage.getItem(Br);if(Ur){const qr=JSON.parse(Ur),ou=String((qr==null?void 0:qr.text)||""),cu=Number((qr==null?void 0:qr.at)||0);ou===zs&&ct-cu<5e3&&(Rs=!1)}}catch{}if(Rs){Promise.resolve(Xa.send(s.uid,zs)).catch(()=>{});try{localStorage.setItem(Br,JSON.stringify({text:zs,at:ct}))}catch{}}}}catch{}if((async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const he={...sa},Pe={...ut},{ProfitService:at}=await xt(async()=>{const{ProfitService:Vt}=await import("./profitService-BQtHSEJV.js");return{ProfitService:Vt}},__vite__mapDeps([3,0,1]),import.meta.url),qt=at.calculateProfitFromTransaction({...Pe,status:"confirmed"});qt>0&&(at.addProfit(qt,s==null?void 0:s.uid),he.profitAddedOnCreation=!0,Pe.profitAddedOnCreation=!0,console.log("✅ تم إضافة الربح:",qt,"جنيه"));const Cs=await Mi.create(he);if(V)try{const Vt=await Aa.updateUsage(V,u,ye==="transfer"?"transfer":"withdraw");Vt&&Wr(Vt);try{window.dispatchEvent(new CustomEvent("walletLimitsUpdated",{detail:{walletId:V}}))}catch{}}catch{}await Promise.all([...s!=null&&s.uid?[Ae.updateUserData(s.uid,{cashBalance:be,walletBalances:Ve,lastUpdated:new Date().toISOString()})]:[],...s!=null&&s.uid?[Ae.saveUserTransaction(s.uid,{...Pe,transactionId:Cs,transactionType:ye,fromWallet:V,toWallet:ye==="transfer"?f?null:"cash":null,cashierName:y&&((N==null?void 0:N.name)||(N==null?void 0:N.username))||"الحساب الرئيسي",linkedDebtId:A||void 0,description:`${ye==="transfer"?"تحويل":"سحب"} ${u} من ${V} ${ye==="transfer"?f?"":"إلى الدرج النقدي":""} — عمولة: ${m} (${ye==="transfer"||At?"مضافة":"مخصومة"})${_>0?` — رسوم: ${_}`:""}${j?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");try{const Vt={...ut,id:Cs};La.current=La.current.map(Os=>Os.id===ms?Vt:Os),$.setQueryData(["recentTransactions",s==null?void 0:s.uid,k||"main"],Os=>!Os||!Array.isArray(Os)?[Vt]:Os.map(zs=>zs.id===ms?Vt:zs)),Ke.startTransition(()=>{ea(Os=>Os.map(zs=>zs.id===ms?Vt:zs))})}catch(Vt){console.error("Error updating query cache with real ID:",Vt)}setTimeout(()=>{try{console.log("🔄 تنفيذ التحديث المؤجل (10 ثواني) لضمان تطابق البيانات..."),$.invalidateQueries({queryKey:["recentTransactions",s==null?void 0:s.uid,k||"main"]}),$.invalidateQueries({queryKey:["dashboardData",k||(b==null?void 0:b.shopId)]}),V&&($.invalidateQueries({queryKey:["walletLimits",V]}),Gl())}catch(Vt){console.error("Error in delayed refresh:",Vt)}},1e4);const qs=`userData_${s==null?void 0:s.uid}`,aa={cashBalance:be,walletBalances:Ve,lastUpdated:new Date().toISOString()};localStorage.setItem(qs,JSON.stringify(aa))}catch(he){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",he);try{s!=null&&s.uid&&Ae.saveLocalReceipt(s.uid,{...transactionDataForUser,transactionType:ye,fromWallet:V,toWallet:ye==="transfer"?f?null:"cash":null,cashierName:y&&((N==null?void 0:N.name)||(N==null?void 0:N.username))||"الحساب الرئيسي",linkedDebtId:A||void 0,description:`${ye==="transfer"?"تحويل":"سحب"} ${u} من ${V} ${ye==="transfer"?f?"":"إلى الدرج النقدي":""} — عمولة: ${m} (${ye==="transfer"||At?"مضافة":"مخصومة"})${_>0?` — رسوم: ${_}`:""}${j?" — دين مؤجل (قيد المراجعة)":""}`})}catch{}i({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),ye==="transfer"){_r(!0);const he=Number(r)+Number(m)+Math.max(0,Number(_));sl({type:"transfer",amount:Math.max(0,Math.round(he*100)/100)}),Mm({receiver:Fs,amount:r}),mr(!0),setTimeout(()=>{_r(!1)},2e3)}else{ln(!0);const he=At?Number(r):Math.max(0,Math.round((Number(r)-Number(m))*100)/100);sl({type:"withdraw",amount:Math.max(0,Math.round(he*100)/100)}),mr(!0),setTimeout(()=>{ln(!1)},2e3)}Tr(""),Xr(""),bo(""),vo(""),Ui(null),Ri(""),dr(""),No(""),jo(!1)},Si=Ke.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),Kc=Ke.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),eu=Ke.useMemo(()=>{try{return ft.reduce((t,a)=>{if(a.type==="debtor")return t;const r=Number(a.paidAmount||0),l=Math.max(0,Number(a.amount||0)-r);return t+l},0)}catch{return 0}},[ft]),Xl=Ke.useMemo(()=>Rc().filter(a=>Ma==="all"?!0:Ma==="send"?a.type==="send":Ma==="receive"?a.type==="receive":Ma==="withdraw"?a.type==="withdraw":Ma!=="deleted"),[Rc,Ma]),tu=()=>{if(Xi==="daily"){const t=Bs.resetReportsManually("daily",Ye,s==null?void 0:s.uid);an(!1),i({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${t.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const t=Bs.resetReportsManually("monthly",Ye,s==null?void 0:s.uid);an(!1),i({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${t.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},su=()=>Xi==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",au=()=>Xi==="daily"?"أدخل الرقم السري الرئيسي لتصفير جميع معاملات اليوم":"أدخل الرقم السري الرئيسي لتصفير جميع معاملات الشهر",ru=t=>{Tc(t),Tl(!0)},nu=t=>{const a=Ot,r=Number(t)-Number(a);cs(t);const l=new Date().toISOString();localStorage.setItem(zt(),t.toString()),localStorage.setItem(zt()+"_lastUpdated",l),gc(!1);const o={cashBalance:t,lastUpdated:l},h=`userData_${s==null?void 0:s.uid}`;try{localStorage.setItem(h,JSON.stringify(o))}catch{}const m=[];if(s!=null&&s.uid){m.push(Ae.updateUserData(s.uid,o).then(()=>{try{localStorage.removeItem(h)}catch{}}).catch(()=>{}));const u=`${r>0?"CASHADD":"CASHDEDUCT"}-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`,v=r>0?{txnType:"cash_addition",type:"cash_addition",amount:r,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:u,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(b==null?void 0:b.shopId)||void 0}:r<0?{amount:Math.abs(r),status:"completed",title:"ايصال خصم من الفلوس النقديه",merchantUserId:s.uid,createdBy:s.uid,shopId:(b==null?void 0:b.shopId)||void 0}:null;v&&m.push(Ae.saveUserTransaction(s.uid,v));const f=b==null?void 0:b.shopId;if(f){const g=Oe(U,"dashboardData",f);m.push(Yt(g,{cashBalance:t}))}}Promise.allSettled(m).then(()=>{}).catch(()=>{}),i({title:r>0?"تم إضافة نقدية":r<0?"تم خصم نقدية":"تم تحديث الرصيد النقدي",description:r!==0?`التغيير: ${Math.abs(r)} جنيه، الرصيد الجديد: ${t} جنيه`:`تم تحديث الرصيد النقدي إلى ${t} جنيه`})},iu=async t=>{var m;if(!Ys){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const a={...tt,[Ys]:t};fs(a);const r=new Date().toISOString(),l={walletBalances:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;try{localStorage.setItem(o,JSON.stringify(l)),localStorage.setItem(ds(),JSON.stringify(a)),localStorage.setItem(ds()+"_lastUpdated",r),localStorage.setItem(`walletBalances_backup_${r}`,JSON.stringify(a))}catch{}try{s!=null&&s.uid&&await Ae.updateUserData(s.uid,l)}catch(u){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",u)}fc(!1);const h=((m=Ue.find(u=>u.id===Ys))==null?void 0:m.name)||"المحفظة";i({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${h} إلى ${t.toLocaleString()} جنيه`})},lu=async t=>{var a;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",Ys),console.log("💵 المبلغ المضاف/المخصوم:",t),Ys){const r=tt[Ys]||0;console.log("💰 الرصيد الحالي:",r);const l=r+t;console.log("💰 الرصيد الجديد:",l);const o={...tt,[Ys]:l};console.log("📊 الأرصدة المحدثة:",o),fs(o);const h=new Date().toISOString(),m={walletBalances:o,lastUpdated:h},u=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(u,JSON.stringify(m)),localStorage.setItem(ds(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${h}`,JSON.stringify(o));try{if(s!=null&&s.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await Ae.updateUserData(s.uid,m),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(u),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(j){console.error("❌ فشل في حفظ البيانات في Firebase:",j),st(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(ds(),JSON.stringify(o));const v=((a=Ue.find(j=>j.id===Ys))==null?void 0:a.name)||"المحفظة",f=t>0?"إضافة":"خصم",g=Math.abs(t);i({title:`تم ${f} مبلغ ${f==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${f} ${g} جنيه ${f==="إضافة"?"إلى":"من"} رصيد ${v}. الرصيد الجديد: ${l.toLocaleString()} جنيه`})}catch(v){if(console.error("❌ فشل في حفظ البيانات في Firebase:",v),localStorage.setItem(ds(),JSON.stringify(o)),s!=null&&s.uid){const f=`userData_${s.uid}`,g={walletBalances:o,lastUpdated:new Date().toISOString()};localStorage.setItem(f,JSON.stringify(g)),st(!0)}i({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const l=Object.keys(localStorage).filter(o=>o.startsWith("walletBalances_backup_")).sort();l.length>5&&l.slice(0,l.length-5).forEach(h=>{localStorage.removeItem(h),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",h)})},5e3),Tl(!1),Tc("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:os,isUserActive:ls,showActivationModal:P}),os?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx(Pu,{})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"user-dashboard min-h-screen px-2 sm:px-4 py-2 sm:py-4 relative bg-gray-100 bg-[radial-gradient(140%_140%_at_10%_10%,#e5e7eb_0%,#d1d5db_45%,#9ca3af_100%)]",children:[e.jsx(jp,{userId:s==null?void 0:s.uid}),e.jsxs("div",{className:"max-w-screen-2xl mx-auto grid grid-cols-1 xl:grid-cols-3 gap-4 xl:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!on&&e.jsxs(pt,{className:"bg-gray-100 border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-200 relative overflow-hidden",children:[e.jsx(Xt,{className:"pb-2 px-3 pt-3 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(vs,{className:"text-xs font-bold text-gray-900 flex items-center gap-1.5",children:[e.jsx("div",{className:"p-1 rounded-md bg-gradient-to-br from-gray-100 to-gray-200",children:e.jsx(dd,{className:"h-3.5 w-3.5 text-gray-700"})}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>{Oo("monthly"),an(!0)},className:"h-7 w-7 p-0 bg-transparent hover:bg-red-50 text-red-600 hover:text-red-700 rounded-full transition-colors duration-200",title:"تصفير معاملات الشهر",children:e.jsx(bs,{className:"h-3 w-3"})}),e.jsx("div",{className:"p-1 bg-green-50 rounded-full border border-green-100",children:e.jsx(Cn,{className:"h-3 w-3 text-green-600"})})]})]})}),!on&&e.jsxs(Nt,{className:"pt-0 px-2 pb-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-0 rounded-lg overflow-hidden border border-gray-200 divide-x divide-y divide-gray-200 bg-white",children:[e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-blue-600",children:"عدد المعاملات"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-blue-800 mt-0.5 sm:mt-0",children:jn().totalTransactions})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-gray-600",children:"إجمالي المبالغ"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-gray-900 mt-0.5 sm:mt-0",children:jn().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-red-600",children:"المسحوب"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-red-800 mt-0.5 sm:mt-0",children:jn().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-green-600",children:"المرسل"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-green-800 mt-0.5 sm:mt-0",children:jn().totalSent.toFixed(2)})]})]}),e.jsxs("div",{className:"mt-2 rounded-lg border border-gray-100 bg-white px-2 py-1.5 flex items-center justify-between",children:[e.jsx("span",{className:"text-[12px] font-bold text-yellow-600",children:"الأرباح"}),e.jsx(dp,{userId:s==null?void 0:s.uid,transactions:Ye})]})]}),zm&&e.jsx("div",{className:"absolute inset-0 z-20 backdrop-blur-sm bg-amber-50/60 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(x,{size:"sm",variant:"ghost",onClick:async()=>{if(wt){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}Zn(!0)},className:"px-4 py-2 rounded-full bg-white border border-gray-100 text-gray-900 shadow-sm hover:bg-gray-50 hover:shadow-md transition-all duration-200 flex items-center gap-2 text-xs font-medium",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(Ns,{className:"h-3.5 w-3.5 text-gray-600"})]})})]}),e.jsx(Is,{open:Jm,onOpenChange:Zn,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(wt){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),Zn(!1),zo(!0);return}zo(!1),Zn(!1)},userId:s==null?void 0:s.uid}),(It==null?void 0:It.planType)!==Hs.TAHWEELA&&e.jsxs(pt,{className:"bg-gray-50 border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-200 relative overflow-hidden",children:[e.jsx(Xt,{className:"pb-2 px-3 pt-3 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(vs,{className:"text-sm font-bold text-gray-900 flex items-center gap-2",children:[e.jsx("div",{className:"p-1 rounded-md bg-gradient-to-br from-gray-100 to-gray-200",children:e.jsx(dd,{className:"h-4 w-4 text-gray-700"})}),e.jsx("span",{className:"text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>{Oo("daily"),an(!0)},className:"h-8 w-8 p-0 bg-transparent hover:bg-red-50 text-red-600 hover:text-red-700 rounded-full transition-colors duration-200",title:"تصفير معاملات اليوم",children:e.jsx(bs,{className:"h-3.5 w-3.5"})}),e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>Vm(t=>!t),className:"h-8 w-8 p-0 bg-transparent hover:bg-gray-100 text-gray-600 hover:text-blue-600 rounded-full transition-colors duration-200",title:on?"توسيع اليوم والشهر":"طي اليوم والشهر",children:on?e.jsx(En,{className:"h-3.5 w-3.5"}):e.jsx(Cd,{className:"h-3.5 w-3.5"})}),e.jsx("div",{className:"p-2 bg-green-50 rounded-full border border-green-100",children:e.jsx(Cn,{className:"h-3.5 w-3.5 text-green-600"})})]})]})}),!on&&e.jsxs(Nt,{className:"pt-0 px-2 pb-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-0 rounded-lg overflow-hidden border border-gray-200 divide-x divide-y divide-gray-200 bg-white",children:[e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-blue-600",children:"عدد المعاملات"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-blue-800 mt-0.5 sm:mt-0",children:Nn().totalTransactions})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-gray-600",children:"إجمالي المبالغ"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-gray-900 mt-0.5 sm:mt-0",children:Nn().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-red-600",children:"المسحوب"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-red-800 mt-0.5 sm:mt-0",children:Nn().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-green-600",children:"المرسل"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-green-800 mt-0.5 sm:mt-0",children:Nn().totalSent.toFixed(2)})]})]}),e.jsxs("div",{className:"mt-2 rounded-lg border border-gray-100 bg-white px-2 py-1.5 flex items-center justify-between",children:[e.jsx("span",{className:"text-[12px] font-bold text-yellow-600",children:"الأرباح"}),e.jsx(up,{userId:s==null?void 0:s.uid,transactions:Ye})]})]}),Gm&&e.jsx("div",{className:"absolute inset-0 z-20 backdrop-blur-sm bg-white/60 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(x,{size:"sm",variant:"ghost",onClick:()=>nl(!0),className:"px-4 py-2 rounded-full bg-white border border-gray-100 text-gray-900 shadow-sm hover:bg-gray-50 hover:shadow-md transition-all duration-200 flex items-center gap-2 text-xs font-medium",title:"عرض تقارير اليوم (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير اليوم"}),e.jsx(Ns,{className:"h-3.5 w-3.5 text-gray-600"})]})})]}),e.jsx(Is,{open:Zm,onOpenChange:nl,mode:"verify",title:"الرقم السري لفتح تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Ko(!1),nl(!1)},userId:s==null?void 0:s.uid})]}),e.jsxs(pt,{className:"balance-bar bg-gray-200 border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(Nt,{className:"p-2 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"bg-white border border-gray-200 p-1 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 group/cash relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex flex-col relative z-10 w-full",children:[e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx(es,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsx("span",{className:"text-[11px] font-extrabold text-emerald-800",children:"الفلوس النقدية"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-green-600 hover:bg-green-50 transition-colors",onClick:()=>pn(!0),children:e.jsx(Ut,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-emerald-600 hover:bg-emerald-50 transition-colors",onClick:()=>Pc(!0),title:"تفاصيل الفلوس النقدية",children:e.jsx(cd,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-red-600 hover:bg-red-50 transition-colors",onClick:()=>vi(!0),children:e.jsx(bs,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"mt-0.5",children:e.jsxs("span",{className:"text-[14px] sm:text-xl font-bold text-emerald-800 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm block w-fit",children:[Ot.toLocaleString("en-US")," جنيه"]})})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 p-1 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 group/wallet relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex flex-col relative z-10 w-full",children:[e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(ra,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsx("span",{className:"text-[11px] font-extrabold text-blue-800",children:"الأرصدة علي المحافظ"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-green-600 hover:bg-green-50 transition-colors",onClick:()=>pi(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(Ut,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-blue-600 hover:bg-blue-50 transition-colors",onClick:()=>Zi(!0),title:"عرض المحافظ",children:e.jsx(ra,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-red-600 hover:bg-red-50 transition-colors",onClick:()=>{yi(!0),bi("")},title:"تصفير إجمالي المحفظة",children:e.jsx(bs,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"mt-0.5",children:e.jsxs("span",{className:"text-[14px] sm:text-xl font-bold text-blue-800 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm block w-fit",children:[Object.values(tt).reduce((t,a)=>t+a,0).toLocaleString("en-US")," جنيه"]})})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-white border border-gray-200 p-1 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 group/selwallet relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex flex-col relative z-10 w-full",children:[e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(ra,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsx("span",{className:"text-[11px] font-extrabold text-indigo-800",children:"رصيد المحفظه"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-green-600 hover:bg-green-50 transition-colors",onClick:()=>{if(!V){i({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}ru(V)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(Ut,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-red-600 hover:bg-red-50 transition-colors",onClick:()=>{if(!V){i({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}ai(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(bs,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"mt-0.5",children:e.jsxs("span",{className:"text-[14px] sm:text-xl font-bold text-indigo-800 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm block w-fit",children:[(V&&tt[V]||0).toLocaleString("en-US")," جنيه"]})})]})]})]})})]}),e.jsxs(pt,{className:"bg-gray-100 border border-gray-200 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsxs(Xt,{className:`pb-2 px-4 pt-4 relative z-10 ${Y?"sticky top-0 z-20 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/60":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(vs,{className:"text-sm font-bold flex items-center gap-2 text-gray-900",children:[!Y&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gray-100 rounded-lg",children:e.jsx(Cn,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-700"})}),e.jsx("span",{className:"text-gray-900",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!Y&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-100 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(Td,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx(q,{placeholder:"بحث...",value:Mo,onChange:t=>Em(t.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!Y&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"تقسيط"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{if(wt||Rt){i({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"});return}Yn(!0)},title:"إدارة التقسيط",children:e.jsx(_u,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-green-600 mb-1",children:"شحن"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-green-100 text-green-600 hover:bg-green-200 border border-green-200 ring-3 ring-green-300 transition-all duration-200 hover:scale-105 active:bg-green-600 active:text-white active:border-green-600",onClick:()=>{i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."})},title:"شحن الرصيد",children:e.jsx(Mn,{className:"h-5 w-5 text-green-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>al(!0),title:"آلة حاسبة",children:e.jsx(Pd,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{wt||Rt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Hn(!0)},title:"كروت الائتمان",children:e.jsx(Mn,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"تقاريرك"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:()=>{if(wt||Rt){i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"});return}Sc(!0)},title:"تقاريرك",children:e.jsx(hd,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-sky-600 mb-1",children:"تلجرام"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-sky-100 text-sky-600 hover:bg-sky-200 border border-sky-200 ring-3 ring-sky-300 transition-all duration-200 hover:scale-105 active:bg-sky-600 active:text-white active:border-sky-600",onClick:()=>{wt||Rt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Ms.hasMasterPin()?Hl(!0):Bc()},title:"إرسال تقرير يومي إلى تليجرام",children:e.jsx(Dx,{className:"h-5 w-5 text-sky-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:_h,title:y&&(N!=null&&N.name||N!=null&&N.username)?`بروفيل الوردية: ${(N==null?void 0:N.name)||(N==null?void 0:N.username)}`:"وردية الكاشير",children:e.jsx(nr,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{wt||Rt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):sn(!0)},title:"بيانات المبيعات",children:e.jsx(so,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),ft.filter(t=>t.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:ft.filter(t=>t.status==="pending").length})]}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{gl()},title:"الديون",children:e.jsx(co,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-100 text-amber-700 hover:bg-amber-200 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105 active:bg-amber-600 active:text-white active:border-amber-600",onClick:()=>{wt||Rt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Qn(!0)},title:"الصيانة",children:e.jsx(mo,{className:"h-5 w-5 text-amber-700"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-100 text-violet-700 hover:bg-violet-200 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105 active:bg-violet-700 active:text-white active:border-violet-700",onClick:()=>{!Ia||Rt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Gn(!0)},title:"يومية المكنة",children:e.jsx(Md,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-100 text-orange-600 hover:bg-orange-200 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105 active:bg-orange-600 active:text-white active:border-orange-600",onClick:()=>{wt||Rt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Ms.hasMasterPin()?Ze(!0):la(!0)},title:"مصروفات المحل",children:e.jsx(ba,{className:"h-5 w-5 text-orange-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-rose-600 mb-1",children:"النواقص"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-rose-100 text-rose-600 hover:bg-rose-200 border border-rose-200 ring-3 ring-rose-300 transition-all duration-200 hover:scale-105 active:bg-rose-600 active:text-white active:border-rose-600",onClick:()=>{wt||Rt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):ge(!0)},title:"النواقص",children:e.jsx(td,{className:"h-5 w-5 text-rose-600"})})]})]})]})]}),!Y&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"filters-bar flex items-center justify-center gap-3 bg-gray-100 rounded-md p-3 border border-gray-200",children:[e.jsx(x,{variant:"ghost",size:"sm",className:`btn-filter-send h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${Ma==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-100"}`,onClick:()=>Qi("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(x,{variant:"ghost",size:"sm",className:`btn-filter-withdraw h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${Ma==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-100"}`,onClick:()=>Qi("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(x,{variant:"ghost",size:"sm",className:`btn-filter-all h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${Ma==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-100"}`,onClick:()=>Qi("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(x,{variant:"ghost",size:"sm",className:"h-auto px-2 py-1 text-xs text-red-600 hover:bg-red-50 rounded-md font-medium",onClick:()=>un(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(bs,{className:"h-3 w-3 mr-1"}),"تصفير"]}),Uh>0&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),e.jsx(Is,{open:Fm,onOpenChange:Yn,mode:"verify",title:"فتح إدارة التقسيط",description:"أدخل الرقم السري الرئيسي للوصول إلى إدارة التقسيط",onSuccess:()=>{Yn(!1),qo(!0)}}),e.jsx(Qu,{open:Rm,onOpenChange:qo}),e.jsx(Is,{open:Yh,onOpenChange:Hl,mode:"verify",title:"إرسال تقرير يومي إلى تليجرام",description:"أدخل الرقم السري الرئيسي لإرسال التقرير اليومي إلى تليجرام",onSuccess:()=>{Hl(!1),Bc()}}),Uo,e.jsxs(Nt,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:[Xl.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Cn,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):Y?e.jsx("div",{className:"overflow-y-auto overscroll-contain scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[310px]",children:e.jsx("div",{className:"space-y-2 pr-2",children:Xl.map(t=>e.jsxs("div",{className:"relative flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer",onClick:()=>zc(t),children:[e.jsx("div",{className:`h-10 w-10 rounded-full flex items-center justify-center shrink-0 ${t.type==="withdraw"?"bg-red-100":"bg-green-100"}`,children:(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return r?e.jsx(ba,{className:"h-5 w-5 text-gray-600"}):l?e.jsx(Ut,{className:"h-5 w-5 text-green-600"}):t.type==="withdraw"?e.jsx(Jr,{className:"h-5 w-5 text-red-600"}):e.jsx(ld,{className:"h-5 w-5 text-green-600"})})()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h4",{className:"text-base font-bold truncate",children:(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return r?e.jsx("span",{className:"text-foreground",children:"تسليم وردية"}):l?e.jsx("span",{className:"text-foreground",children:"إضافة نقدية"}):t.type==="send"?e.jsx("span",{className:"text-green-600",children:"تحويل أموال"}):e.jsx("span",{className:"text-red-600",children:"سحب نقدي"})})()}),e.jsxs("span",{className:`text-base font-bold whitespace-nowrap ${t.type==="withdraw"?"text-red-600":"text-green-600"}`,children:[t.type==="withdraw"||t.type==="cash_addition"||t.txnType==="cash_addition"?"+":"-"," ",Zt(t.amount)," ج.م"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-0.5",children:[e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية"),o=(a==null?void 0:a.note)||(a==null?void 0:a.notes)||"";return r?`إلى: ${t.receiverPhone}`:l?o||"إضافة يدوية":t.type==="send"?e.jsx("span",{dir:"ltr",children:t.receiverPhone}):e.jsx("span",{dir:"ltr",children:t.senderPhone})})()}),e.jsxs("p",{className:"text-sm font-medium text-gray-500 mt-0.5",children:[Si.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",Kc.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]}),e.jsxs("div",{className:`px-2 py-0.5 rounded-full text-[10px] font-medium flex items-center gap-1 ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700":"bg-green-100 text-green-700":t.status==="pending"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:[t.status==="completed"&&e.jsx(Pn,{className:"h-3 w-3"}),t.status==="pending"&&e.jsx(Ba,{className:"h-3 w-3"}),t.status==="failed"&&e.jsx(Ln,{className:"h-3 w-3"}),e.jsx("span",{children:t.status==="completed"?"ناجحة":t.status==="pending"?"معالجة":"فشلت"})]})]})]})]},t.id))})}):e.jsx("div",{className:"overflow-y-auto overscroll-contain scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[calc(100dvh-300px)]",children:e.jsx("div",{className:"space-y-2 pr-2",children:Xl.map(t=>e.jsxs("div",{className:"relative flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer",onClick:()=>zc(t),children:[e.jsx("div",{className:`h-10 w-10 rounded-full flex items-center justify-center shrink-0 ${t.type==="withdraw"?"bg-red-100":"bg-green-100"}`,children:(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return r?e.jsx(ba,{className:"h-5 w-5 text-gray-600"}):l?e.jsx(Ut,{className:"h-5 w-5 text-green-600"}):t.type==="withdraw"?e.jsx(Jr,{className:"h-5 w-5 text-red-600"}):e.jsx(ld,{className:"h-5 w-5 text-green-600"})})()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h4",{className:"text-base font-bold truncate",children:(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return r?e.jsx("span",{className:"text-foreground",children:"تسليم وردية"}):l?e.jsx("span",{className:"text-foreground",children:"إضافة نقدية"}):t.type==="send"?e.jsx("span",{className:"text-green-600",children:"تحويل أموال"}):e.jsx("span",{className:"text-red-600",children:"سحب نقدي"})})()}),e.jsxs("span",{className:`text-base font-bold whitespace-nowrap ${t.type==="withdraw"?"text-red-600":"text-green-600"}`,children:[t.type==="withdraw"||t.type==="cash_addition"||t.txnType==="cash_addition"?"+":"-"," ",Zt(t.amount)," ج.م"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-0.5",children:[e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية"),o=(a==null?void 0:a.note)||(a==null?void 0:a.notes)||"";return r?`إلى: ${t.receiverPhone}`:l?o||"إضافة يدوية":t.type==="send"?e.jsx("span",{dir:"ltr",children:t.receiverPhone}):e.jsx("span",{dir:"ltr",children:t.senderPhone})})()}),e.jsxs("p",{className:"text-sm font-medium text-gray-500 mt-0.5",children:[Si.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",Kc.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]}),e.jsxs("div",{className:`px-2 py-0.5 rounded-full text-[10px] font-medium flex items-center gap-1 ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700":"bg-green-100 text-green-700":t.status==="pending"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:[t.status==="completed"&&e.jsx(Pn,{className:"h-3 w-3"}),t.status==="pending"&&e.jsx(Ba,{className:"h-3 w-3"}),t.status==="failed"&&e.jsx(Ln,{className:"h-3 w-3"}),e.jsx("span",{children:t.status==="completed"?"ناجحة":t.status==="pending"?"معالجة":"فشلت"})]})]})]})]},t.id))})}),Y&&e.jsxs("div",{className:"mt-2 flex justify-end",children:[e.jsxs(x,{variant:"ghost",size:"sm",className:"h-7 px-2 text-[11px] rounded-full border bg-red-100 text-red-700 border-red-300 hover:bg-red-200",onClick:()=>un(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(bs,{className:"h-3 w-3 mr-1"}),"تصفير"]}),(s==null?void 0:s.uid)&&localStorage.getItem(`recentTransactionsResetAt:${s.uid}`)&&e.jsx("span",{className:"inline-block h-1.5 w-1.5 rounded-full bg-red-500 ml-1 align-middle"})]})]})]})]}),e.jsx(Gu,{isOpen:Sm,onClose:()=>Vn(!1),transaction:Dm,onPrint:()=>window.print(),onDelete:Pm,onComplete:_m}),e.jsx(ve,{open:Se,onOpenChange:xe,children:e.jsxs(we,{className:"sm:max-w-md",children:[e.jsx(Ie,{children:e.jsx(Ne,{children:"معلومات المطور"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"flex flex-col items-center gap-4 bg-gradient-to-br from-indigo-50 to-blue-50 p-6 rounded-xl border border-blue-100 text-center",children:[e.jsx("div",{className:"h-16 w-16 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 shadow-sm",children:e.jsx(cx,{className:"h-8 w-8"})}),e.jsxs("div",{className:"space-y-3 w-full",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"معلومات التطوير"}),e.jsx("p",{className:"text-lg font-bold bg-gradient-to-r from-blue-700 to-indigo-700 bg-clip-text text-transparent leading-relaxed",children:"تم تطوير الابلكيشن بالكامل بواسطة م/أحمد عبد الرحيم محمد"}),e.jsxs("div",{className:"flex flex-col items-center gap-1 mt-4",children:[e.jsx("p",{className:"text-base font-semibold text-gray-800",children:"رقم خدمة العملاء الوحيد لنا"}),e.jsx("a",{href:"tel:01000392539",className:"text-2xl font-black text-blue-600 tracking-wider hover:underline",dir:"ltr",children:"01000392539"})]}),e.jsx("p",{className:"text-sm text-red-600 font-bold bg-red-50 py-1 px-3 rounded-full inline-block mt-2",children:"ليس لنا اي ارقام اخري"})]})]}),e.jsx("div",{className:"text-center text-xs text-gray-400 mt-2",children:Ts?`v${Ts}`:"v1.0.0"})]}),e.jsx(et,{children:e.jsx(x,{onClick:()=>xe(!1),children:"إغلاق"})})]})}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full",children:[e.jsxs(pt,{id:"transaction-section",className:"bg-gray-100 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx(Xt,{className:"sticky top-0 z-20 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(vs,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Yr,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("div",{className:"top-icons-bar hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:[e.jsx(Bx,{}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"VIP",onClick:()=>rl(!0),children:e.jsx(hx,{className:"h-5 w-5 text-yellow-500"})}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"إدارة الفروع",onClick:()=>(Ws==null?void 0:Ws.status)==="active"?Le(!0):te(!0),children:e.jsx(kn,{className:"h-5 w-5"})}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"معلومات المطور",onClick:()=>xe(!0),children:e.jsx(mo,{className:"h-5 w-5 text-gray-600"})}),e.jsx(Ku,{})]})}),Kh&&e.jsxs(x,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:Lc,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx(Ii,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsx(ve,{open:Qm,onOpenChange:rl,children:e.jsxs(we,{className:"sm:max-w-md",children:[e.jsx(Ie,{children:e.jsx(Ne,{children:"أفضل 10 عملاء هذا الشهر"})}),e.jsx("div",{className:"space-y-2",children:fi.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا توجد بيانات لهذا الشهر"}):fi.map((t,a)=>e.jsxs("div",{className:`flex items-center justify-between border rounded-md px-3 py-2 bg-white ${a===0?"bg-yellow-50 border-yellow-300":""}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Lt,{variant:"outline",className:`min-w-[28px] justify-center ${a===0?"border-yellow-300 text-yellow-700 bg-yellow-50":""}`,children:a+1}),e.jsx("span",{className:`font-semibold ${a===0?"text-yellow-700":""}`,children:t.phone})]}),e.jsxs("div",{className:"text-sm text-gray-700 flex items-center gap-3",children:[e.jsxs("span",{children:["عدد: ",t.count]}),e.jsxs("span",{children:["إجمالي: ",t.total]}),e.jsx(x,{variant:"outline",size:"sm",className:"h-8",onClick:()=>zh(t),title:"إرسال واتساب",children:e.jsx(to,{className:"h-4 w-4"})})]})]},t.phone+a))}),e.jsx(et,{children:e.jsx(x,{onClick:()=>rl(!1),children:"إغلاق"})})]})}),e.jsx(ve,{open:Km,onOpenChange:Vo,children:e.jsxs(we,{className:"sm:max-w-md",children:[e.jsx(Ie,{children:e.jsx(Ne,{children:"ربط بوت التلجرام"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{children:"Telegram Chat ID"}),e.jsx(q,{value:Xn,onChange:t=>Ym(t.target.value),placeholder:"اكتب رقم المحادثة"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Z,{children:"إرسال يومي 12 صباحاً"}),e.jsx(ex,{checked:Jo,onCheckedChange:t=>Hm(!!t)})]})]}),e.jsxs(et,{children:[e.jsx(x,{variant:"outline",onClick:()=>Vo(!1),children:"إغلاق"}),e.jsx(x,{onClick:async()=>{s!=null&&s.uid&&(await Ae.updateUserData(s.uid,{telegramChatId:Xn,telegramDailyEnabled:Jo}),i({title:"تم الحفظ"}))},children:"حفظ"}),e.jsx(x,{onClick:async()=>{if(!(s!=null&&s.uid)||!Xn){i({title:"أدخل Chat ID"});return}const t=await Fc();try{const{sendTelegramMessage:a}=await xt(async()=>{const{sendTelegramMessage:r}=await Promise.resolve().then(()=>Ax);return{sendTelegramMessage:r}},void 0,import.meta.url);await a({chatId:Xn,text:t}),i({title:"تم الإرسال"})}catch{i({title:"تعذر الإرسال",description:"تحقق من ربط البوت",variant:"destructive"})}},children:"إرسال الآن"})]})]})}),e.jsx(ve,{open:ne,onOpenChange:Le,children:e.jsxs(we,{className:"sm:max-w-2xl bg-gray-50/80 backdrop-blur-sm",children:[e.jsx(Ie,{className:"border-b pb-4 mb-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-indigo-100 rounded-lg",children:e.jsx(kn,{className:"w-6 h-6 text-indigo-600"})}),e.jsxs("div",{children:[e.jsx(Ne,{className:"text-xl font-bold text-gray-900",children:"إدارة الفروع"}),e.jsx(hs,{className:"text-gray-500 mt-1",children:"أضف فروعاً جديدة وتابع أداء كل فرع بسهولة"})]})]}),e.jsx(x,{size:"icon",variant:vt?"destructive":"default",className:`rounded-full transition-all duration-300 ${vt?"bg-red-50 text-red-600 hover:bg-red-100 border border-red-200":"bg-indigo-600 hover:bg-indigo-700 text-white shadow-lg hover:shadow-indigo-200"}`,onClick:()=>it(!vt),title:vt?"إلغاء الإضافة":"إضافة فرع جديد",children:vt?e.jsx(er,{className:"w-6 h-6"}):e.jsx(Ut,{className:"w-6 h-6"})})]})}),e.jsxs("div",{className:"space-y-6",children:[vt&&e.jsxs("div",{className:"bg-white p-5 rounded-xl border shadow-sm space-y-4 animate-in slide-in-from-top-4 fade-in duration-300",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-indigo-700 font-semibold",children:[e.jsx(Ut,{className:"w-5 h-5"}),e.jsx("h3",{children:"إضافة فرع جديد"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{onClick:()=>checkSubscriptionStatus(!0).then(()=>i({title:"تم تحديث البيانات"})),variant:"ghost",size:"icon",title:"تحديث بيانات الاشتراك",children:e.jsx(Ii,{className:"w-4 h-4 text-gray-500"})}),e.jsxs(x,{onClick:()=>te(!0),variant:"outline",size:"sm",className:"gap-2",children:[e.jsx(fx,{className:"w-4 h-4"}),"طلب زيادة فرع"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-gray-700",children:"اسم المدير"}),e.jsxs("div",{className:"relative",children:[e.jsx(nr,{className:"absolute right-3 top-2.5 h-4 w-4 text-gray-400"}),e.jsx(q,{className:"pr-9",value:Ge,onChange:t=>Q(t.target.value),placeholder:"مثال: أحمد محمد"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-gray-700",children:"اسم الفرع"}),e.jsxs("div",{className:"relative",children:[e.jsx(kn,{className:"absolute right-3 top-2.5 h-4 w-4 text-gray-400"}),e.jsx(q,{className:"pr-9",value:oe,onChange:t=>ze(t.target.value),placeholder:"مثال: فرع وسط البلد"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-gray-700",children:"البريد الإلكتروني للدخول"}),e.jsxs("div",{className:"relative",children:[e.jsx(to,{className:"absolute right-3 top-2.5 h-4 w-4 text-gray-400"}),e.jsx(q,{className:"pr-9",value:yt,onChange:t=>bt(t.target.value),placeholder:"branch@example.com"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-gray-700",children:"كلمة المرور"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute right-3 top-2.5 h-4 w-4 text-gray-400",children:"🔒"}),e.jsx(q,{type:"password",className:"pr-9",value:$t,onChange:t=>Ht(t.target.value),placeholder:"••••••"})]})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 pt-2",children:[e.jsx(x,{variant:"ghost",onClick:()=>{Q(""),ze(""),bt(""),Ht("")},className:"text-gray-500 hover:text-gray-700",children:"مسح الحقول"}),e.jsx(x,{className:"bg-indigo-600 hover:bg-indigo-700 text-white min-w-[120px]",disabled:ts,onClick:async()=>{if(!(s!=null&&s.uid))return;const t=Ge.trim(),a=oe.trim(),r=yt.trim(),l=$t.trim();if(!t||!a||!r||!l){i({title:"يرجى ملء جميع الحقول المطلوبة"});return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r)){i({title:"البريد الإلكتروني غير صالح",variant:"destructive"});return}if(l.length<6){i({title:"كلمة السر يجب أن تكون 6 أحرف على الأقل",variant:"destructive"});return}const h=(Ws==null?void 0:Ws.limit)||0;if(ae.length>=h){i({title:"عفواً",description:`لقد وصلت للحد الأقصى من الفروع (${h} فروع)`,variant:"destructive"});return}try{Wt(!0);let m="",u="";const v=`tempApp_${Date.now()}`,f=Eu(Ou,v),g=Mu(f),j=Lu(f);try{m=(await $u(g,r,l)).user.uid;try{await As(Oe(j,"users",m),{email:r,isActive:!0,isBranch:!0,ownerId:s.uid,createdAt:dt(),updatedAt:dt(),role:"branch",isActive:!1,subscription:{isActive:!1,planType:null,startDate:null,endDate:null}})}catch(R){console.error("Error creating branch user document:",R)}try{u=(await Ta(je(j,"shops"),{name:a,ownerId:m,managerName:t,createdAt:dt(),updatedAt:dt(),isActive:!0})).id}catch(R){console.error("Error creating shop as new user:",R);try{u=(await Ta(je(j,"users",m,"shops"),{name:a,ownerId:m,managerName:t,createdAt:dt(),updatedAt:dt(),isActive:!0})).id}catch(me){throw console.error("Error creating shop in subcollection:",me),R}}await Wu(g)}catch(I){console.error("Registration/Shop Creation Error:",I);let R="تعذر إنشاء المستخدم أو المتجر";I.code==="auth/email-already-in-use"&&(R="البريد الإلكتروني مستخدم بالفعل"),I.code==="auth/invalid-email"&&(R="البريد الإلكتروني غير صالح"),I.code==="auth/weak-password"&&(R="كلمة المرور ضعيفة"),I.code==="permission-denied"&&(R="ليس لديك صلاحية لإنشاء متجر لهذا المستخدم"),i({title:R,description:I.message,variant:"destructive"});try{await sd(f)}catch{}return}finally{try{await sd(f)}catch(I){console.warn("Error deleting temp app:",I)}}if(!m||!u)return;const A=I=>{try{return btoa(unescape(encodeURIComponent(I)))}catch{return btoa(I)}};try{const I={ownerId:s.uid,shopId:u,branchUserId:m,branchName:a,managerName:t,loginUsername:r,passwordEncoded:A(l),createdAt:dt()};await As(Oe(U,"users",s.uid,"branches",m),I);try{await Ta(je(U,"branches"),I)}catch(me){console.warn("Branch ref creation error in root collection (non-fatal):",me)}const R={id:m,branchUserId:m,branchName:a,managerName:t,source:"sub",...I};Be(me=>[...me,R])}catch(I){console.error("Branch ref creation error:",I),i({title:"خطأ في حفظ بيانات الفرع",description:"تم إنشاء المستخدم ولكن فشل حفظ البيانات",variant:"destructive"})}Q(""),ze(""),bt(""),Ht(""),i({title:"تم إضافة الفرع وإنشاء المستخدم بنجاح"})}catch(m){console.error("General Error adding branch:",m),i({title:"تعذّر إضافة الفرع",description:m.message||"حدث خطأ غير متوقع"})}finally{Wt(!1)}},children:ts?"جارٍ الإضافة...":"إضافة فرع"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx("div",{className:"w-1.5 h-6 bg-indigo-500 rounded-full"}),"الفروع الحالية",e.jsxs(Lt,{variant:"secondary",className:"mr-auto",children:[ae.length," / ",(Ws==null?void 0:Ws.limit)||0]})]}),ts&&ae.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-8 text-gray-500",children:[e.jsx(Ii,{className:"w-8 h-8 animate-spin mb-2 text-indigo-400"}),e.jsx("p",{children:"جارٍ تحميل الفروع..."})]}):ae.length===0?e.jsxs("div",{className:"text-center py-8 border-2 border-dashed rounded-xl bg-gray-50",children:[e.jsx(kn,{className:"w-12 h-12 text-gray-300 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-500",children:"لا يوجد فروع مضافة حالياً"})]}):e.jsx("div",{className:"grid grid-cols-1 gap-3",children:ae.map(t=>{var a;return e.jsx("div",{className:"group relative bg-white border rounded-xl p-4 shadow-sm hover:shadow-md transition-all duration-200",children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-lg",children:((a=t.branchName)==null?void 0:a.charAt(0))||"B"}),e.jsxs("div",{children:[e.jsx("h5",{className:"font-bold text-gray-900 text-lg",children:t.branchName}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(nr,{className:"w-3 h-3"}),e.jsxs("span",{children:["المدير: ",t.managerName]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 w-full sm:w-auto mt-2 sm:mt-0",children:[e.jsxs(x,{className:"flex-1 sm:flex-none bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>ns(t),children:[e.jsx(so,{className:"w-4 h-4 ml-2"}),"عرض البيانات"]}),e.jsx(x,{variant:"ghost",size:"icon",className:"text-blue-500 hover:text-blue-700 hover:bg-blue-50",title:"تعديل بيانات الفرع",onClick:()=>ps(t),children:e.jsx(_i,{className:"w-4 h-4"})})]})]})},t.id)})})]})]})]})}),e.jsx(ve,{open:qe,onOpenChange:rt,children:e.jsxs(we,{className:"sm:max-w-md",children:[e.jsxs(Ie,{children:[e.jsx(Ne,{children:"دخول الفرع"}),e.jsx(hs,{children:"أدخل بيانات الدخول للفرع المحدد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(Z,{children:"اسم المستخدم (البريد الإلكتروني)"}),e.jsx(q,{value:Qe,onChange:t=>ee(t.target.value),placeholder:"example@email.com"})]}),e.jsxs("div",{children:[e.jsx(Z,{children:"كلمة السر"}),e.jsx(q,{type:"password",value:_t,onChange:t=>ss(t.target.value),placeholder:"••••••"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{ee(""),ss("")},children:"مسح"}),e.jsx(x,{className:"bg-blue-600 hover:bg-blue-700",disabled:as,onClick:async()=>{const t=lt;if(!t){rt(!1);return}const a=String(t.loginUsername||"");let r="";try{const h=String(t.passwordEncoded||"");r=h?decodeURIComponent(escape(atob(h))):""}catch{try{r=t.passwordEncoded?atob(String(t.passwordEncoded)):""}catch{r=""}}const l=Qe.trim(),o=_t.trim();if(!l||!o){i({title:"يرجى إدخال اسم المستخدم وكلمة السر"});return}if(l!==a||o!==r){i({title:"بيانات الدخول غير صحيحة",variant:"destructive"});return}try{B(!0);const h=s!=null&&s.uid?`selectedShopId_${s.uid}`:"selectedShopId";localStorage.setItem(h,String(t.shopId)),i({title:"تم الدخول إلى الفرع",description:String(t.branchName||"")}),rt(!1),Le(!1),E("/user/dashboard")}catch{}B(!1)},children:"دخول"})]})]})]})}),e.jsx(ve,{open:De,onOpenChange:Fe,children:e.jsxs(we,{className:"sm:max-w-2xl",children:[e.jsxs(Ie,{children:[e.jsxs(Ne,{children:["بيانات فرع ",Tt==null?void 0:Tt.branchName]}),e.jsxs(hs,{children:["مدير الفرع: ",Tt==null?void 0:Tt.managerName]})]}),jt?e.jsx("div",{className:"py-8 flex justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):Tt?e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 py-4",children:[e.jsxs("div",{className:"p-4 border rounded-xl bg-green-50",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-1",children:"مبيعات اليوم"}),e.jsxs("div",{className:"text-xl font-bold text-green-700",children:[Zt(Tt.todaySales)," ج.م"]})]}),e.jsxs("div",{className:"p-4 border rounded-xl bg-blue-50",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-1",children:"مبيعات الشهر"}),e.jsxs("div",{className:"text-xl font-bold text-blue-700",children:[Zt(Tt.monthSales)," ج.م"]})]}),e.jsxs("div",{className:"p-4 border rounded-xl bg-emerald-50",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-1",children:"ارباح اليوم"}),e.jsxs("div",{className:"text-xl font-bold text-emerald-700",children:[Zt(Tt.todayProfit)," ج.م"]})]}),e.jsxs("div",{className:"p-4 border rounded-xl bg-cyan-50",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-1",children:"ارباح الشهر"}),e.jsxs("div",{className:"text-xl font-bold text-cyan-700",children:[Zt(Tt.monthProfit)," ج.م"]})]}),e.jsxs("div",{className:"p-4 border rounded-xl bg-purple-50",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-1",children:"أرصدة المحافظ"}),e.jsxs("div",{className:"text-xl font-bold text-purple-700",children:[Zt(Tt.walletsTotal)," ج.م"]})]}),e.jsxs("div",{className:"p-4 border rounded-xl bg-yellow-50",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-1",children:"نقدية الدرج"}),e.jsxs("div",{className:"text-xl font-bold text-yellow-700",children:[Zt(Tt.cashBalance)," ج.م"]})]}),e.jsxs("div",{className:"p-4 border rounded-xl bg-indigo-50",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-1",children:"مبيعات قسم المبيعات"}),e.jsxs("div",{className:"text-xl font-bold text-indigo-700",children:[Zt(Tt.totalSalesSection)," ج.م"]})]}),e.jsxs("div",{className:"p-4 border rounded-xl bg-red-50",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-1",children:"مجموع الديون"}),e.jsxs("div",{className:"text-xl font-bold text-red-700",children:[Zt(Tt.debtsTotal)," ج.م"]})]})]}):null,e.jsx(et,{children:e.jsx(x,{onClick:()=>Fe(!1),children:"إغلاق"})})]})}),e.jsx(ve,{open:qa,onOpenChange:Zs,children:e.jsxs(we,{className:"sm:max-w-md",children:[e.jsxs(Ie,{children:[e.jsx(Ne,{children:"تعديل بيانات الفرع"}),e.jsx(hs,{children:"تعديل اسم الفرع واسم المدير"})]}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{children:"البريد الإلكتروني (اسم المستخدم)"}),e.jsx(q,{value:nt,readOnly:!0,disabled:!0,placeholder:"لا يوجد بريد مسجل",className:"bg-gray-100 text-black opacity-100 font-medium"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{children:"اسم الفرع"}),e.jsx(q,{value:ie,onChange:t=>Ee(t.target.value),placeholder:"مثال: فرع القاهرة"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{children:"اسم المدير"}),e.jsx(q,{value:He,onChange:t=>Me(t.target.value),placeholder:"مثال: أحمد محمد"})]})]}),e.jsxs(et,{children:[e.jsx(x,{variant:"outline",onClick:()=>Zs(!1),children:"إلغاء"}),e.jsx(x,{onClick:rs,disabled:ot,children:ot?"جارٍ الحفظ...":"حفظ التعديلات"})]})]})}),e.jsxs(Nt,{ref:p,className:"space-y-1 px-2 pb-2 relative z-10 transition-transform duration-200 ease-out will-change-transform",style:{transform:c?`translateY(${c}px)`:void 0},onFocusCapture:t=>{const a=t.target;if(!((a==null?void 0:a.id)==="transferExtraFeeInput")){w(0);return}const l=document.getElementById("transferSubmitButton");if(l){const o=l.getBoundingClientRect(),h=window.innerHeight;if(o.bottom>h){const m=o.bottom-h,u=Math.min(m,220);w(-u)}else w(0)}else w(0)},onBlurCapture:t=>{t.currentTarget.contains(t.relatedTarget)||w(0)},children:[e.jsxs("div",{className:"transaction-type-tabs flex w-full rounded-full border border-gray-300 overflow-hidden bg-surface fade-in-up",children:[e.jsxs("button",{type:"button",onClick:()=>ji("transfer"),className:`flex-1 h-10 text-sm font-medium transition-colors duration-200 flex items-center justify-center gap-2 ${ye==="transfer"?"bg-blue-100 text-blue-900":"bg-transparent text-gray-600 hover:bg-gray-50"}`,children:[ye==="transfer"&&e.jsx(Pn,{className:"h-4 w-4"}),e.jsx(Cn,{className:"h-4 w-4"}),"تحويل"]}),e.jsx("div",{className:"w-[1px] bg-gray-300"}),e.jsxs("button",{type:"button",onClick:()=>ji("withdraw"),className:`flex-1 h-10 text-sm font-medium transition-colors duration-200 flex items-center justify-center gap-2 ${ye==="withdraw"?"bg-red-100 text-red-900":"bg-transparent text-gray-600 hover:bg-gray-50"}`,children:[ye==="withdraw"&&e.jsx(Pn,{className:"h-4 w-4"}),e.jsx(Jr,{className:"h-4 w-4"}),"سحب"]})]}),e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(ra,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(x,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>E("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(Ut,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(x,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>{Bn(!0)},title:"المحافظ",children:[e.jsx(ra,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),Ue.length>0?e.jsxs(tr,{value:V,onValueChange:Qh,children:[e.jsx(sr,{"data-testid":"wallet-select",className:"w-full h-14 text-base bg-surface border border-gray-400 hover:border-gray-800 focus:border-primary rounded-xl transition-colors duration-200 flex items-center",children:e.jsx(ar,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-700"})}),e.jsxs(rr,{className:"rounded-xl border border-gray-200 shadow-md z-[9999] bg-white dark:bg-gray-900",children:[e.jsx("div",{"data-fixed-header":"true",className:"sticky top-0 z-10 bg-white dark:bg-gray-900 p-2 border-b border-gray-100 dark:border-gray-800",children:e.jsx(q,{value:Po,onChange:t=>wm(t.target.value),placeholder:"ابحث برقم المحفظة",className:"h-10 text-sm border-gray-300 rounded-lg"})}),e.jsx("div",{className:"p-1",children:_o.length===0?e.jsx("div",{className:"text-sm text-gray-500 p-3 text-center",children:"لا توجد نتائج مطابقة"}):_o.map(t=>e.jsx(fa,{value:t.id,className:"rounded-lg my-1 cursor-pointer hover:bg-gray-100 focus:bg-blue-50 transition-colors duration-200",children:e.jsxs("div",{className:"flex items-center gap-3 py-2 w-full",children:[e.jsx(ra,{className:"h-5 w-5 text-gray-500"}),e.jsxs("div",{className:"flex items-center gap-2 text-right",children:[e.jsx("span",{className:"text-base font-medium text-gray-900",children:t.name}),e.jsx("span",{className:"text-sm font-bold text-red-600",children:t.phone})]}),t.isDefault&&e.jsx("span",{className:"mr-auto text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full border border-gray-200",children:"افتراضي"})]})},t.id))})]})]}):e.jsx("div",{className:"rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 px-3 py-3 text-xs text-gray-600",children:"لا توجد محافظ حتى الآن. اضغط “إضافة محفظة” لإضافة أول محفظة."})]}),e.jsx(ve,{open:cm,onOpenChange:So,children:e.jsxs(we,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(Ie,{children:e.jsx(Ne,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(ox,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),e.jsx(Is,{open:dm,onOpenChange:Bn,mode:"verify",title:"الرقم السري لفتح المحافظ",description:"أدخل الرقم السري الرئيسي لعرض وإدارة المحافظ",onSuccess:()=>{Bn(!1),So(!0)},userId:s==null?void 0:s.uid}),e.jsx(Is,{open:mm,onOpenChange:t=>{qi(t),t||zi(null)},mode:"verify",title:"تأكيد تغيير المحفظة",description:"أدخل الرقم السري الرئيسي لتغيير المحفظة المختارة",onSuccess:()=>{Do&&(bn(Do,"walletSelectionPin"),zi(null)),qi(!1)},userId:s==null?void 0:s.uid}),V&&Ue.length>0&&(()=>{var J;const t=Ue.find(be=>be.id===V),a=Wa,r=Xh(V),l=(Xe==null?void 0:Xe.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,o=(Xe==null?void 0:Xe.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,h=(Xe==null?void 0:Xe.monthlyWithdrawUsed)??a.totalWithdrawn??0,m=(Xe==null?void 0:Xe.monthlyTransferUsed)??a.totalTransferred??0,u=((J=It==null?void 0:It.subscription)==null?void 0:J.planType)===Hs.TAHWEELA,v=u?0:(Xe==null?void 0:Xe.dailyWithdrawLimit)??1e5,f=u?0:(Xe==null?void 0:Xe.dailyTransferLimit)??6e4,g=u?0:(Xe==null?void 0:Xe.dailyWithdrawUsed)??r.totalWithdrawn??0,j=u?0:(Xe==null?void 0:Xe.dailyTransferUsed)??r.totalTransferred??0,A=parseFloat(ks||"0")||0,I=h+(ye==="withdraw"?A:0),R=m+(ye==="transfer"?A:0),me=g+(ye==="withdraw"?A:0),_=j+(ye==="transfer"?A:0);return t?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2 p-2 bg-gray-50 rounded-xl border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-gray-200 pb-1",children:[e.jsx("span",{className:"text-sm font-bold text-gray-800",children:"الحدود الشهرية"}),e.jsx("span",{className:"text-xs font-medium text-gray-500 bg-white px-2 py-0.5 rounded-full border border-gray-200",children:gh||(t==null?void 0:t.name)})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-1 font-medium",children:[e.jsx("span",{className:"text-gray-700",children:"سحب شهري"}),e.jsxs("span",{className:"text-gray-600 dir-ltr",children:[Math.max(l-I,0).toLocaleString("en-US",{maximumFractionDigits:0})," متبقي"]})]}),e.jsx("div",{className:"h-1.5 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner ring-1 ring-gray-200/50",children:e.jsx("div",{className:"h-full bg-gradient-to-l from-red-500 to-red-600 rounded-full transition-all duration-500 ease-out shadow-sm",style:{width:`${Math.min(I/Math.max(l,1)*100,100)}%`}})}),e.jsxs("div",{className:"flex justify-between mt-0.5",children:[e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["المستخدم: ",I.toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["الحد: ",l.toLocaleString("en-US",{maximumFractionDigits:0})]})]})]}),e.jsx("div",{className:"w-[1px] bg-gray-200 self-stretch"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-1 font-medium",children:[e.jsx("span",{className:"text-gray-700",children:"تحويل شهري"}),e.jsxs("span",{className:"text-gray-600 dir-ltr",children:[Math.max(o-R,0).toLocaleString("en-US",{maximumFractionDigits:0})," متبقي"]})]}),e.jsx("div",{className:"h-1.5 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner ring-1 ring-gray-200/50",children:e.jsx("div",{className:"h-full bg-gradient-to-l from-blue-500 to-blue-600 rounded-full transition-all duration-500 ease-out shadow-sm",style:{width:`${Math.min(R/Math.max(o,1)*100,100)}%`}})}),e.jsxs("div",{className:"flex justify-between mt-0.5",children:[e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["المستخدم: ",R.toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["الحد: ",o.toLocaleString("en-US",{maximumFractionDigits:0})]})]})]})]})]}),e.jsxs("div",{className:"space-y-1 pt-1.5 border-t border-gray-200",children:[e.jsx("div",{className:"flex items-center justify-between mb-0.5",children:e.jsx("span",{className:"text-sm font-bold text-gray-800",children:"الحدود اليومية"})}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-1 font-medium",children:[e.jsx("span",{className:"text-gray-700",children:"سحب يومي"}),e.jsxs("span",{className:"text-gray-600 dir-ltr",children:[Math.max(v-me,0).toLocaleString("en-US",{maximumFractionDigits:0})," متبقي"]})]}),e.jsx("div",{className:"h-1.5 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner ring-1 ring-gray-200/50",children:e.jsx("div",{className:"h-full bg-gradient-to-l from-orange-400 to-orange-500 rounded-full transition-all duration-500 ease-out",style:{width:`${Math.min(me/Math.max(v,1)*100,100)}%`}})}),e.jsxs("div",{className:"flex justify-between mt-0.5",children:[e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["المستخدم: ",me.toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["الحد: ",v.toLocaleString("en-US",{maximumFractionDigits:0})]})]})]}),e.jsx("div",{className:"w-[1px] bg-gray-200 self-stretch"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-1 font-medium",children:[e.jsx("span",{className:"text-gray-700",children:"تحويل يومي"}),e.jsxs("span",{className:"text-gray-600 dir-ltr",children:[Math.max(f-_,0).toLocaleString("en-US",{maximumFractionDigits:0})," متبقي"]})]}),e.jsx("div",{className:"h-1.5 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner ring-1 ring-gray-200/50",children:e.jsx("div",{className:"h-full bg-gradient-to-l from-green-500 to-green-600 rounded-full transition-all duration-500 ease-out",style:{width:`${Math.min(_/Math.max(f,1)*100,100)}%`}})}),e.jsxs("div",{className:"flex justify-between mt-0.5",children:[e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["المستخدم: ",_.toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["الحد: ",f.toLocaleString("en-US",{maximumFractionDigits:0})]})]})]})]})]})]}):null})(),ye==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative group",children:[e.jsx(ka,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-green-600 group-focus-within:text-green-700 transition-colors"}),e.jsx(q,{value:da,onChange:t=>Oa(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("receiverPhoneInput");if(a)a.focus();else{const r=document.getElementById("amountInput");r==null||r.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-blue-600 focus:ring-1 focus:ring-blue-600 transition-all duration-200"})]})]}),!F&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative group",children:[e.jsx(ka,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-green-600 group-focus-within:text-green-700 transition-colors"}),e.jsx(q,{id:"receiverPhoneInput",value:Fs,onChange:t=>{Tr(t.target.value),tl&&_r(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("amountInput");a==null||a.focus()}},inputMode:"numeric",maxLength:11,placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-blue-600 focus:ring-1 focus:ring-blue-600 transition-all duration-200"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(ka,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(q,{value:V&&((Yc=Ue.find(t=>t.id===V))==null?void 0:Yc.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 text-sm lg:text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl transition-all duration-300"})]})]}),ye==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2 group",children:[e.jsx(es,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-yellow-600 group-focus-within:text-yellow-700 transition-colors"}),e.jsx(q,{id:"amountInput",value:ks,onChange:t=>{Xr(t.target.value),tl&&_r(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("transferCommissionInput");if(a)a.focus();else{const r=document.getElementById("quickDebtButton");r==null||r.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-blue-600 focus:ring-1 focus:ring-blue-600 transition-all duration-200"})]}),ga?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",ga.debtorName," بمبلغ ",ga.amount," جنيه"]}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>Ui(null),children:"إلغاء"})]}):null]}),(()=>{if(F)return null;const t=js();return t&&t.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",t==null?void 0:t.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(x,{id:"quickDebtButton",type:"button",variant:"destructive",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-medium",onClick:()=>{const r=js(),l=(r==null?void 0:r.defaultTransferCommission)!=null?Number(r.defaultTransferCommission):0,o=parseFloat(ks||"0")||0,h=Math.round((l||0)*o/1e3*100)/100,m=o+h;dr((m||0).toString()),wt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):kr(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",className:"hidden",title:At?"العمولة تُضاف":"العمولة تُخصم",children:At?e.jsx(Ut,{className:"h-4 w-4 text-green-600"}):e.jsx(er,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:At?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1 group",children:[e.jsx(es,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-yellow-600 group-focus-within:text-yellow-700 transition-colors"}),e.jsx(q,{id:"transferCommissionInput",value:_s,onChange:r=>Ji(r.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all duration-200"})]}),e.jsx(x,{type:"button",variant:"destructive",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-medium",onClick:()=>{const r=js(),l=parseFloat(ks||"0")||0;let o=0;if((r==null?void 0:r.defaultTransferCommission)!=null){const m=Number(r.defaultTransferCommission)||0;o=Math.round(m*l/1e3*100)/100}else{const m=_s&&_s.trim()!==""?parseFloat(_s):0;o=Math.max(0,m)}const h=l+o;dr((h||0).toString()),wt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):kr(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",className:"hidden",title:At?"العمولة تُضاف":"العمولة تُخصم",children:At?e.jsx(Ut,{className:"h-4 w-4 text-green-600"}):e.jsx(er,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:At?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),(()=>{const t=Un(da||"").replace(/\D/g,""),a=Un(Fs||"").replace(/\D/g,"");return ye==="transfer"&&(t.startsWith("010")&&a.startsWith("010")||t.startsWith("010")&&(a.startsWith("011")||a.startsWith("012")||a.startsWith("015"))||t.startsWith("012")&&a.startsWith("010")||t.startsWith("011")&&a.startsWith("010")||t.startsWith("015")&&a.startsWith("010"))?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رسوم التحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(es,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-yellow-600"}),e.jsx(q,{id:"transferExtraFeeInput",value:Co,onChange:l=>hm(l.target.value),placeholder:"أدخل رسوم التحويل",type:"number",className:"pl-10 h-10 text-sm lg:text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"hidden",children:"تُخصم من المحفظة وتضاف للدرج — لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010"})]}):null})(),e.jsxs("div",{className:"sticky bottom-0 z-20 pt-2 pb-2 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 backdrop-blur supports-[backdrop-filter]:bg-white/90 dark:supports-[backdrop-filter]:bg-gray-900/90",children:[e.jsx(x,{id:"transferSubmitButton",onClick:Jc,className:"w-full h-12 text-base font-medium rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-none hover:shadow-md transition-all duration-200",children:tl?"تم التحويل بنجاح":"تأكيد التحويل"}),um&&e.jsxs("div",{className:"flex items-start gap-2 mt-2 px-1 animate-in fade-in slide-in-from-bottom-2",children:[e.jsx(td,{className:"h-4 w-4 text-amber-500 shrink-0 mt-0.5"}),e.jsxs("p",{className:"text-xs text-gray-500 leading-tight",children:["تم الوصول إلى 85% من الحد الشهري للمحفظة ",Ki==null?void 0:Ki.walletName]})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative group",children:[e.jsx(Jr,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400 group-focus-within:text-primary transition-colors"}),e.jsx(q,{id:"amountInput",value:ks,onChange:t=>{Xr(t.target.value),Fo&&ln(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("manualWithdrawCommissionInput");if(a)a.focus();else{const r=document.getElementById("withdrawSubmitButton");r==null||r.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-primary focus:ring-1 focus:ring-primary transition-all duration-200"})]})]}),xm&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"اسم الراسل (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsx(nr,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-500"}),e.jsx(q,{id:"withdrawSenderNameInput",value:en,onChange:t=>vo(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("manualWithdrawCommissionInput");a==null||a.focus()}},placeholder:"أدخل اسم الراسل إن وجد",className:"pl-10 h-10 text-sm lg:text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white transition-all duration-300 hover:border-blue-400 focus:border-blue-500",type:"text"})]})]}),(()=>{const t=js();return t&&t.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",t==null?void 0:t.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(x,{type:"button",variant:"destructive",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-medium",onClick:()=>{const r=js(),l=parseFloat(ks||"0")||0,o=(r==null?void 0:r.defaultWithdrawCommission)!=null&&Number(r.defaultWithdrawCommission)||0,h=Math.round(o*l/1e3*100)/100,m=At?l+h:l;dr((m||0).toString()),wt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):kr(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>Hi(r=>!r),title:At?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:At?e.jsx(Ut,{className:"h-4 w-4"}):e.jsx(er,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:At?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(es,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-yellow-600"}),e.jsx(q,{id:"manualWithdrawCommissionInput",value:Ps,onChange:r=>Vi(r.target.value),onKeyDown:r=>{if(r.key==="Enter"){const l=document.getElementById("withdrawSubmitButton");l==null||l.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(x,{type:"button",variant:"destructive",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-medium",onClick:()=>{const r=js(),l=parseFloat(ks||"0")||0;let o=0;if((r==null?void 0:r.defaultWithdrawCommission)!=null){const m=Number(r.defaultWithdrawCommission)||0;o=Math.round(m*l/1e3*100)/100}else{const m=Ps&&Ps.trim()!==""?parseFloat(Ps):Math.round(l*.01*100)/100;o=Math.max(0,m)}const h=At?l+o:l;dr((h||0).toString()),wt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):kr(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",title:At?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>Hi(r=>!r),children:At?e.jsx(Ut,{className:"h-4 w-4 text-green-600"}):e.jsx(er,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:At?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),(b==null?void 0:b.showWithdrawNote)&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"ملاحظة السحب (اختياري)"}),e.jsxs("div",{className:"relative group",children:[e.jsx(to,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400 group-focus-within:text-primary transition-colors"}),e.jsx(q,{id:"withdrawNoteInput",value:cr,onChange:t=>bo(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("withdrawSubmitButton");a==null||a.focus()}},placeholder:"أدخل ملاحظة للسحب (اختياري)",className:"pl-10 h-10 text-base border-gray-400 rounded-xl focus:border-primary focus:ring-1 focus:ring-primary transition-all duration-200"})]})]}),e.jsx("div",{className:"sticky bottom-0 z-20 pt-2 pb-2 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 backdrop-blur supports-[backdrop-filter]:bg-white/90 dark:supports-[backdrop-filter]:bg-gray-900/90",children:e.jsx(x,{id:"withdrawSubmitButton",onClick:Jc,className:"w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:Fo?"تم السحب بنجاح":"تأكيد السحب"})})]}),e.jsx(ve,{open:Wi,onOpenChange:kr,children:e.jsxs(we,{children:[e.jsxs(Ie,{children:[e.jsx(Ne,{children:"تحويل مؤجل"}),e.jsx(hs,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[Ks&&Ks.length>0?e.jsxs("div",{children:[e.jsx(Z,{children:"اختيار عميل"}),e.jsxs(tr,{value:Bi,onValueChange:t=>{lm(t);const a=Ks.find(r=>r.id===t);a&&Ri(a.name)},children:[e.jsx(sr,{className:"w-full",children:e.jsx(ar,{placeholder:"اختر عميل"})}),e.jsx(rr,{children:Ks.map(t=>e.jsxs(fa,{value:t.id,children:[t.name,t.mobile?` — ${t.mobile}`:""]},t.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx(q,{id:"quickDebtName",value:Fi,onChange:t=>Ri(t.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx(q,{id:"quickDebtAmount",type:"number",value:im,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"quickDebtCommission",children:"العمولة (محسوبة تلقائياً)"}),e.jsx(q,{id:"quickDebtCommission",type:"number",value:function(){const t=js(),a=parseFloat((ks||"0").toString())||0;let r=0;if(ye==="transfer")if((t==null?void 0:t.defaultTransferCommission)!=null){const l=Number(t.defaultTransferCommission)||0;r=Math.round(l*a/1e3*100)/100}else{const l=_s&&_s.trim()!==""?parseFloat(_s):0;r=Math.max(0,l)}else if((t==null?void 0:t.defaultWithdrawCommission)!=null){const l=Number(t.defaultWithdrawCommission)||0;r=Math.round(l*a/1e3*100)/100}else{const l=Ps&&Ps.trim()!==""?parseFloat(Ps):Math.round(a*.01*100)/100;r=Math.max(0,l)}return String(r||0)}(),readOnly:!0,placeholder:"قيمة العمولة"})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx(q,{id:"quickDebtNotes",value:wo,onChange:t=>No(t.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(et,{children:e.jsx(x,{type:"button",variant:"default",className:"bg-green-600 text-white hover:bg-green-700",onClick:()=>{const t=js(),a=parseFloat((ks||"").toString())||0;let r=0;if(ye==="transfer")if((t==null?void 0:t.defaultTransferCommission)!=null){const h=Number(t.defaultTransferCommission)||0;r=Math.round(h*a/1e3*100)/100}else{const h=_s&&_s.trim()!==""?parseFloat(_s):0;r=Math.max(0,h)}else if((t==null?void 0:t.defaultWithdrawCommission)!=null){const h=Number(t.defaultWithdrawCommission)||0;r=Math.round(h*a/1e3*100)/100}else{const h=Ps&&Ps.trim()!==""?parseFloat(Ps):Math.round(a*.01*100)/100;r=Math.max(0,h)}let l=0;if(ye==="withdraw"?l=At?a:Math.max(0,Math.round((a-r)*100)/100):l=Math.max(0,Math.round((a+r)*100)/100),!Fi||isNaN(l)||l<=0){i({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const o=Ks.find(h=>h.id===Bi);Ui({debtorName:Fi,amount:l,notes:wo,customerId:Bi||void 0,mobile:o==null?void 0:o.mobile}),jo(!1),kr(!1),i({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx(pt,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(Nt,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(Ex,{isOpen:fm,onClose:()=>ym(!1),initialEditingWallet:vm,onWalletUpdate:async()=>{try{await Zl()}catch(t){console.error("Error reloading wallets after update:",t)}}}),e.jsx(Ox,{isOpen:jm,onClose:()=>Eo(!1),transaction:Nm,onDelete:Gh}),e.jsx(Is,{open:Am,onOpenChange:an,onSuccess:tu,title:su(),description:au(),mode:"verify"}),e.jsx(ud,{open:bh,onOpenChange:gc,onSuccess:nu,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:Ot,balanceLabel:"الرصيد النقدي",userId:s==null?void 0:s.uid}),e.jsx(ud,{open:vh,onOpenChange:fc,onSuccess:iu,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:Ys&&tt[Ys]||0,balanceLabel:`رصيد ${((Hc=Ue.find(t=>t.id===Ys))==null?void 0:Hc.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(Wx,{open:wh,onOpenChange:Tl,onSuccess:lu,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:Ys&&tt[Ys]||0,balanceLabel:`رصيد ${((Qc=Ue.find(t=>t.id===Ys))==null?void 0:Qc.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(Mx,{open:Eh,onOpenChange:Oh,userId:s==null?void 0:s.uid}),e.jsx(Lx,{open:Mh,onOpenChange:Lh,userId:s==null?void 0:s.uid}),e.jsx($x,{open:$h,onOpenChange:Wh}),e.jsx(ve,{open:Sh,onOpenChange:ri,children:e.jsxs(we,{className:"sm:max-w-md",children:[e.jsx(Ie,{children:e.jsx(Ne,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(q,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:Pl,onChange:t=>ni(t.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(x,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:async()=>{if(!await wi(ql)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(Pl);if(isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Ot+t;cs(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?Ae.updateUserData(s.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),st(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),st(!0)}):st(!0),i({title:"تم بنجاح",description:`تم إضافة ${t} جنيه إلى الدرج النقدية وحفظه في السحابة`}),ri(!1),ni(""),di("")},children:[e.jsx(Ut,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(x,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:async()=>{if(!await wi(ql)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(Pl);if(isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Ot-t;cs(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?Ae.updateUserData(s.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),st(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),st(!0)}):st(!0),i({title:"تم بنجاح",description:`تم خصم ${t} جنيه من الدرج النقدية وحفظه في السحابة`}),ri(!1),ni(""),di("")},children:[e.jsx(er,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",Ot.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx(q,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:ql,onChange:t=>di(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(et,{className:"flex gap-2",children:e.jsx(x,{variant:"outline",onClick:()=>{ri(!1),ni(""),di("")},children:"إلغاء"})})]})}),e.jsx(ve,{open:Vh,onOpenChange:yi,children:e.jsxs(we,{className:"sm:max-w-md",children:[e.jsx(Ie,{children:e.jsx(Ne,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(tt).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(q,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل الرقم السري الرئيسي",value:Uc,onChange:t=>bi(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(et,{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{yi(!1),bi("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",onClick:async()=>{if(!await Ms.verifyMasterPin(Uc,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const a={};Object.keys(tt).forEach(h=>{a[h]=0}),fs(a),localStorage.setItem(ds(),JSON.stringify(a)),yi(!1),bi("");const r=new Date().toISOString(),l={walletBalances:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(o,JSON.stringify(l)),s!=null&&s.uid?Ae.updateUserData(s.uid,l).then(()=>{localStorage.removeItem(o),st(!1)}).catch(h=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",h),st(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):st(!0),setTimeout(()=>{fs({...a})},100)}catch(a){console.error("خطأ في تصفير أرصدة المحافظ:",a),i({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(ve,{open:Nh,onOpenChange:ai,children:e.jsxs(we,{className:"sm:max-w-md",children:[e.jsx(Ie,{children:e.jsx(Ne,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((Gc=Ue.find(t=>t.id===V))==null?void 0:Gc.name)||V]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(V&&tt[V]?tt[V]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(q,{id:"resetSelectedWalletPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:yc,onChange:t=>kl(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(et,{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{ai(!1),kl("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",onClick:async()=>{var a;if(!V){i({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await Ms.verifyMasterPin(yc,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const r={...tt};r[V]=0,fs(r),localStorage.setItem(ds(),JSON.stringify(r)),ai(!1),kl("");const l=new Date().toISOString(),o={walletBalances:r,lastUpdated:l},h=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(h,JSON.stringify(o)),s!=null&&s.uid?Ae.updateUserData(s.uid,o).then(()=>{localStorage.removeItem(h),st(!1)}).catch(m=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",m),st(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):st(!0),i({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((a=Ue.find(m=>m.id===V))==null?void 0:a.name)||V}`})}catch(r){console.error("خطأ في تصفير رصيد المحفظة المختارة:",r),i({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(ve,{open:Bh,onOpenChange:pi,children:e.jsxs(we,{className:"sm:max-w-md",children:[e.jsx(Ie,{children:e.jsxs(Ne,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(Ut,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(tt).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx(q,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:_c,onChange:t=>Vl(t.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx(q,{id:"addWalletTotalPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري",value:Ec,onChange:t=>Jl(t.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(et,{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{pi(!1),Vl(""),Jl("")},children:"إلغاء"}),e.jsx(x,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:Oc,onClick:async()=>{const t=parseFloat(_c);if(!t||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!await Hh(Ec)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}Mc(!0);try{const a=Object.values(tt).reduce((r,l)=>r+l,0);if(a===0){const r=Object.keys(tt),l=t/r.length,o={};r.forEach(h=>{o[h]=l}),fs(o),localStorage.setItem(ds(),JSON.stringify(o)),s!=null&&s.uid?await Ae.updateUserData(s.uid,{walletBalances:o,lastUpdated:new Date().toISOString()}):st(!0)}else{const r={};Object.entries(tt).forEach(([l,o])=>{const h=o/a,m=t*h;r[l]=o+m}),fs(r),localStorage.setItem(ds(),JSON.stringify(r)),s!=null&&s.uid?await Ae.updateUserData(s.uid,{walletBalances:r,lastUpdated:new Date().toISOString()}):st(!0)}setTimeout(()=>{fs(r=>({...r}))},100),pi(!1),Vl(""),Jl("")}catch(a){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",a),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{Mc(!1)}},children:Oc?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(ve,{open:Jh,onOpenChange:vi,children:e.jsxs(we,{className:"sm:max-w-[425px]",children:[e.jsx(Ie,{children:e.jsxs(Ne,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(bs,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"resetCashPin",children:"الرقم السري الرئيسي"}),e.jsx(q,{id:"resetCashPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:Kl,onChange:t=>Yl(t.target.value)})]})]}),e.jsxs(et,{children:[e.jsx(x,{variant:"outline",onClick:()=>{vi(!1),Yl("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",onClick:async()=>{if(!Kl){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await Ms.verifyMasterPin(Kl,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{cs(0),vi(!1),Yl("");const a={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem(zt(),"0"),localStorage.setItem(zt()+"_lastUpdated",a.lastUpdated);const r=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(r,JSON.stringify(a)),s!=null&&s.uid?Ae.updateUserData(s.uid,a).then(()=>{localStorage.removeItem(r),st(!1)}).catch(l=>{console.error("خطأ في حفظ الرصيد في Firebase:",l),st(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):st(!0)}catch(a){console.error("خطأ في تصفير الرصيد النقدي:",a),i({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(Jx,{open:Rh,onOpenChange:Pc,userId:s==null?void 0:s.uid,cashBalance:Ot,walletBalances:tt,transactions:Ye}),e.jsx(ve,{open:Fh,onOpenChange:pn,children:e.jsxs(we,{className:"sm:max-w-[425px]",children:[e.jsx(Ie,{children:e.jsxs(Ne,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(Ut,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx(q,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:fr,onChange:t=>mi(t.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-right",children:"هل تريد إضافة ملاحظة؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{type:"button",variant:fn==="yes"?"default":"outline",onClick:()=>yn("yes"),className:"flex-1",children:"نعم"}),e.jsx(x,{type:"button",variant:fn==="no"?"default":"outline",onClick:async()=>{if(yn("no"),!fr||parseFloat(fr)<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!gn){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await wi(gn)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}ui(!0);try{const t=parseFloat(fr),a=Ot+t;cs(a);const r=new Date().toISOString();localStorage.setItem(zt(),a.toString()),localStorage.setItem(zt()+"_lastUpdated",r);const l={cashBalance:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(o,JSON.stringify(l));const h=`CASHADD-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`;pn(!1),mi(""),hi(""),yn(null),xi("");const m=[];if(s!=null&&s.uid){m.push(Ae.updateUserData(s.uid,l).then(()=>{localStorage.removeItem(o),st(!1)}).catch(()=>{st(!0)}));const u={txnType:"cash_addition",type:"cash_addition",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:h,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(b==null?void 0:b.shopId)||void 0};m.push(Ae.saveUserTransaction(s.uid,u));const v=b==null?void 0:b.shopId;if(v){const f=Oe(U,"dashboardData",v);m.push(Yt(f,{cashBalance:a}))}}Promise.allSettled(m).then(()=>{}).catch(()=>{})}catch{cs(Ot),localStorage.setItem("cashBalance",Ot.toString()),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{ui(!1)}},className:"flex-1",children:"لا"})]})]}),fn==="yes"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"addCashNote",children:"الملاحظة"}),e.jsx(q,{id:"addCashNote",type:"text",placeholder:"اكتب الملاحظة",value:zl,onChange:t=>xi(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx(q,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:gn,onChange:t=>hi(t.target.value)})]})]}),e.jsxs(et,{children:[e.jsx(x,{variant:"outline",onClick:()=>{pn(!1),mi(""),hi(""),yn(null),xi("")},children:"إلغاء"}),e.jsx(x,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:kc,onClick:async()=>{if(!fr||parseFloat(fr)<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!gn){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await wi(gn)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}if(fn==="yes"&&zl.trim().length===0){i({title:"تنبيه",description:"أدخل الملاحظة أو اختر لا",variant:"destructive"});return}ui(!0);try{const t=parseFloat(fr),a=Ot+t;cs(a);const r=new Date().toISOString();localStorage.setItem(zt(),a.toString()),localStorage.setItem(zt()+"_lastUpdated",r);const l={cashBalance:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(o,JSON.stringify(l));const h=`CASHADD-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`;pn(!1),mi(""),hi(""),yn(null),xi("");const m=[];if(s!=null&&s.uid){m.push(Ae.updateUserData(s.uid,l).then(()=>{localStorage.removeItem(o),st(!1)}).catch(()=>{st(!0)}));const u={txnType:"cash_addition",type:"cash_addition",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:h,note:fn==="yes"?zl.trim():void 0,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(b==null?void 0:b.shopId)||void 0};m.push(Ae.saveUserTransaction(s.uid,u));const v=b==null?void 0:b.shopId;if(v){const f=Oe(U,"dashboardData",v);m.push(Yt(f,{cashBalance:a}))}}Promise.allSettled(m).then(()=>{}).catch(()=>{})}catch{cs(Ot),localStorage.setItem("cashBalance",Ot.toString()),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{ui(!1)}},children:kc?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(ve,{open:yh,onOpenChange:Al,children:e.jsxs(we,{className:"sm:max-w-md",children:[e.jsx(Ie,{children:e.jsx(Ne,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx(q,{id:"search-date",type:"date",value:Jn,onChange:t=>$o(t.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx(q,{id:"search-time",type:"time",value:Kn,onChange:t=>Wo(t.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(et,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>{$o(""),Wo(""),Al(!1)},children:"مسح"}),e.jsx(x,{onClick:()=>Al(!1),children:"تطبيق"})]})]})}),e.jsx(Ux,{isOpen:Wm,onClose:()=>al(!1)}),e.jsx(Vx,{isOpen:Gi,onClose:()=>sn(!1),initialBarcode:pm}),e.jsx(Zu,{isOpen:Bm,onClose:()=>Hn(!1)}),e.jsx(Xu,{open:Um,onOpenChange:Qn}),e.jsx(lp,{open:qm,onOpenChange:t=>{if(t&&!Ia){i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}Gn(t)}}),e.jsx(pp,{open:re,onOpenChange:t=>{if(t&&!Ia){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}pe(t)}}),e.jsx(gp,{open:M,onOpenChange:t=>{if(t&&!Ia){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}W(t)}}),e.jsx(Is,{open:Ch,onOpenChange:Sc,onSuccess:()=>Ol(!0),title:"تقاريرك",description:"أدخل الرقم السري الرئيسي للوصول إلى تقاريرك",mode:"verify"}),e.jsx(ve,{open:El,onOpenChange:Ol,children:e.jsxs(we,{className:"sm:max-w-xl",children:[e.jsxs(Ie,{children:[e.jsxs(Ne,{className:"flex items-center gap-2",children:[e.jsx(so,{className:"h-4 w-4 text-blue-600"}),"تقارير اليوم"]}),e.jsx(hs,{children:"ملخص معاملات اليوم محفوظ لآخر 30 يومًا مع أرشفة في السحابة"})]}),e.jsxs("div",{className:"space-y-4",children:[(()=>{const t=new Date().toDateString(),a=Ye.filter(u=>{const v=new Date(u.createdAt).toDateString(),f=String(u.status||"completed").toLowerCase();return v===t&&(f==="completed"||f==="confirmed")}),r=a.length,l=a.reduce((u,v)=>u+Number(v.amount||0),0),o=a.filter(u=>u.type==="withdraw").reduce((u,v)=>u+Number(v.amount||0),0),h=a.filter(u=>u.type==="send").reduce((u,v)=>u+Number(v.amount||0),0),m=a.reduce((u,v)=>u+Number(Bs.calculateTransactionProfit(v)||0),0);return e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-blue-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-blue-700",children:"عدد المعاملات"}),e.jsx("div",{className:"text-lg font-bold text-blue-800",children:r})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-indigo-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-indigo-700",children:"إجمالي المبالغ"}),e.jsx("div",{className:"text-lg font-bold text-indigo-800",children:Number(l).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-red-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-red-700",children:"المبالغ المسحوبة"}),e.jsx("div",{className:"text-lg font-bold text-red-800",children:Number(o).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-green-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-green-700",children:"المبالغ المرسلة"}),e.jsx("div",{className:"text-lg font-bold text-green-800",children:Number(h).toFixed(2)})]}),e.jsxs("div",{className:"col-span-2 rounded-lg p-3 bg-gradient-to-r from-amber-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-amber-700",children:"الأرباح"}),e.jsx("div",{className:"text-lg font-bold text-amber-800",children:Number(m).toFixed(2)})]})]})})(),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(x,{variant:"default",onClick:async()=>{try{if(!(s!=null&&s.uid))return;const t=new Date,a=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0"),o=`${a}-${r}-${l}`,h=t.toDateString(),m=Ye.filter(A=>{const I=new Date(A.createdAt).toDateString(),R=String(A.status||"completed").toLowerCase();return I===h&&(R==="completed"||R==="confirmed")}),u=m.length,v=m.reduce((A,I)=>A+Number(I.amount||0),0),f=m.filter(A=>A.type==="withdraw").reduce((A,I)=>A+Number(I.amount||0),0),g=m.filter(A=>A.type==="send").reduce((A,I)=>A+Number(I.amount||0),0),j=m.reduce((A,I)=>A+Number(Bs.calculateTransactionProfit(I)||0),0);await Sn.add({userId:s.uid,reportDate:o,totalTransactions:u,totalAmount:Number(v.toFixed(2)),totalWithdrawn:Number(f.toFixed(2)),totalSent:Number(g.toFixed(2)),profit:Number(j.toFixed(2)),walletId:null});try{await Sn.trimToMaxCount(s.uid,30)}catch{}i({title:"تم الأرشفة",description:`تم حفظ تقرير ${o}`})}catch{i({title:"فشل الأرشفة",description:"تعذر حفظ التقرير",variant:"destructive"})}},children:"أرشفة اليوم"}),e.jsx(x,{variant:"outline",onClick:()=>Ol(!1),children:"إغلاق"})]}),e.jsx("div",{className:"mt-2 border-t pt-2",children:e.jsx("div",{className:"space-y-2 max-h-[40vh] overflow-auto",children:Dc.length===0?e.jsx("div",{className:"text-xs text-muted-foreground",children:"لا توجد تقارير محفوظة"}):Dc.map(t=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:t.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",t.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalAmount).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalWithdrawn).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalSent).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:Number(t.profit??0).toFixed(2)})]})]})]},t.id||`${t.userId}-${t.reportDate}`))})})]})]})}),e.jsx(ve,{open:Dh,onOpenChange:t=>{if(t){i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}_l(!1)},children:e.jsxs(we,{dir:"rtl",className:"sm:max-w-md w-[95vw] sm:w-auto rounded-2xl border border-emerald-200 shadow-xl bg-gradient-to-br from-white via-green-50 to-emerald-50 backdrop-blur-md data-[state=open]:animate-in data-[state=open]:fade-in-0 data-[state=open]:zoom-in-90 data-[state=open]:slide-in-from-bottom-8 duration-300",children:[e.jsxs(Ie,{children:[e.jsx(Ne,{className:"text-right text-green-700",children:"شحن رصيد الموبايل"}),e.jsx(hs,{className:"text-right text-gray-600",children:"أدخل البيانات ثم اضغط تأكيد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"topupPhone",className:"text-right block",children:"رقم الموبايل"}),e.jsx(q,{id:"topupPhone",value:ii,onChange:t=>bc(t.target.value),placeholder:"010xxxxxxx",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx(Z,{className:"text-right block",children:"شركة التشغيل"}),e.jsxs(tr,{value:li,onValueChange:vc,children:[e.jsx(sr,{className:"text-right",children:e.jsx(ar,{placeholder:"اختر الشركة"})}),e.jsxs(rr,{children:[e.jsx(fa,{value:"vodafone",children:"فودافون"}),e.jsx(fa,{value:"orange",children:"أورنج"}),e.jsx(fa,{value:"etisalat",children:"اتصالات"}),e.jsx(fa,{value:"we",children:"WE"})]})]})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"topupAmount",className:"text-right block",children:"المبلغ بالجنيه"}),e.jsx(q,{id:"topupAmount",type:"number",value:oi,onChange:t=>wc(t.target.value?Number(t.target.value):""),placeholder:"50",className:"text-right"})]})]}),e.jsxs(et,{className:"flex gap-2 justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>_l(!1),className:"border-gray-300",children:"إلغاء"}),e.jsx(x,{onClick:S,disabled:Nc||!ii||!li||!oi,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:Nc?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})}),e.jsx(Is,{open:eh,onOpenChange:il,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{il(!1),Or(!0)}}),e.jsx(Is,{open:sh,onOpenChange:Ho,mode:"verify",title:"تأكيد تغيير طلب الرقم السري للديون",description:"أدخل الرقم السري الرئيسي لتفعيل أو إلغاء طلب الرقم السري عند فتح الديون",onSuccess:async()=>{if(Qo!==null){const t=Qo;Yo(t);try{const a=s==null?void 0:s.uid,r=a?`debtsPinRequired_${a}`:"debtsPinRequired";localStorage.setItem(r,String(t)),a&&await Ae.updateUserData(a,{debtsPinRequired:t})}catch{}i({title:t?"تم تفعيل طلب الرقم السري للديون":"تم إلغاء طلب الرقم السري للديون",description:t?"سيُطلب الرقم السري الرئيسي عند فتح نافذة الديون.":"يمكن فتح نافذة الديون بدون طلب الرقم السري."})}ah(null),Ho(!1)}}),e.jsx(Vu,{open:jh,onOpenChange:un,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"سيتم حذف كل المعاملات السابقة نهائيًا من حسابك وFirebase.",onSuccess:async()=>{try{if(!(s!=null&&s.uid)){un(!1);return}const t=new Date,a=l=>l instanceof Date?l:typeof(l==null?void 0:l.toDate)=="function"?l.toDate():new Date(String(l)),r=Ye.filter(l=>a(l.createdAt)<t);await Ae.updateUserData(s.uid,{recentReset:{keepLastCount:$c.keepLastCount??30,intervalDays:$c.intervalDays??7,lastResetAt:t}}),gi(l=>({...l,lastResetAt:t})),i({title:"تم إخفاء المعاملات السابقة",description:"تم إخفاء كل الإيصالات الأقدم من وقت التصفير من العرض بدون التأثير على تقارير اليوم/الشهر أو الحدود."})}catch(t){console.error("فشل تنفيذ التصفير النهائي:",t),i({title:"فشل التصفير",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}finally{un(!1)}}}),e.jsx(Is,{open:Sa,onOpenChange:Ze,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{Ze(!1),la(!0)}}),e.jsx(ve,{open:Xm,onOpenChange:Or,children:e.jsxs(we,{className:"sm:max-w-[425px]",children:[e.jsxs(Ie,{className:"flex items-center justify-between",children:[e.jsx(Ne,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx(cd,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[eu," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(x,{variant:Ca==="debtor"?"default":"outline",onClick:()=>ec("debtor"),children:"مدين"}),e.jsx(x,{variant:Ca==="creditor"?"default":"outline",onClick:()=>ec("creditor"),children:"دائن"})]}),(Ca==="creditor"||Ca==="debtor")&&e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"debtorName",className:"text-right col-span-1",children:Ca==="creditor"?"اسم المديون":"اسم الدائن"}),e.jsx(q,{id:"debtorName",value:ll,onChange:t=>Go(t.target.value),className:"col-span-3 text-right",placeholder:Ca==="creditor"?"أدخل اسم المديون":"أدخل اسم الدائن"})]}),Ca&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(q,{id:"debtAmount",type:"number",value:ol,onChange:t=>Zo(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx(q,{id:"debtReason",value:cl,onChange:t=>Xo(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]})]}),e.jsx(et,{children:e.jsx(x,{onClick:()=>{if(!(Ca==="debtor")&&!(Ca==="creditor")){i({title:"اختر نوع الدين",description:"يرجى اختيار مدين أو دائن أولاً",variant:"destructive"});return}if(!ol||!cl||!ll){i({title:"بيانات غير مكتملة",description:"يرجى إدخال الاسم والمبلغ والسبب",variant:"destructive"});return}const r={id:Date.now().toString(),debtorName:ll,amount:parseFloat(ol),reason:cl,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[],type:Ca||"creditor"};dn(r),Lr(!0)},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(x,{variant:"outline",className:"w-full",onClick:()=>xr(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(x,{variant:"outline",className:"w-full",onClick:()=>fl(!0),children:"إضافة عميل"})})]})}),e.jsx(ve,{open:ul,onOpenChange:xr,children:e.jsxs(we,{className:"w-[95vw] sm:w-auto sm:max-w-[520px] rounded-2xl",children:[e.jsxs(Ie,{children:[e.jsx(Ne,{className:"text-right",children:"إيصالات الديون"}),e.jsx(hs,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),ft.length>0?e.jsxs("div",{className:"max-h-[70vh] overflow-y-auto overscroll-contain scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 space-y-2 px-1 -mx-1 sm:mx-0 sm:px-0",style:{contain:"layout paint"},onScroll:t=>{const a=t.currentTarget;pl.length<ft.length&&a.scrollTop+a.clientHeight>=a.scrollHeight-50&&xl(r=>r+1)},children:[pl.map(t=>e.jsx("div",{onClick:()=>{Ka(t),Ya(!0),xr(!1),Or(!1)},className:`p-4 sm:p-3 border rounded-xl cursor-pointer hover:bg-gray-50 transition-colors min-h-[64px] ${t.type==="debtor"?"border-r-4 border-r-red-500 bg-red-50/10":"border-r-4 border-r-emerald-500"}`,children:e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:justify-between sm:items-center",children:[e.jsxs("div",{className:"text-right space-y-0.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"font-medium text-[14px] sm:text-sm",children:t.debtorName}),t.type==="debtor"&&e.jsx(Lt,{variant:"destructive",className:"h-5 text-[10px] px-1",children:"علينا"}),(!t.type||t.type==="creditor")&&e.jsx(Lt,{variant:"outline",className:"h-5 text-[10px] px-1 text-emerald-700 border-emerald-200 bg-emerald-50",children:"لنا"})]}),e.jsx("p",{className:"text-[13px] sm:text-sm text-gray-600",children:t.reason}),e.jsx("p",{className:"text-[12px] sm:text-sm text-gray-500",children:Si.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-xl sm:text-lg",children:[t.amount," جنيه"]}),e.jsx(Lt,{variant:t.status==="paid"?"default":"secondary",className:`${t.status==="paid"?"bg-green-500":"bg-yellow-500"} text-[12px] sm:text-xs`,children:t.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},t.id)),pl.length<ft.length&&e.jsx("div",{className:"flex justify-center pt-1",children:e.jsx(x,{variant:"outline",size:"sm",onClick:()=>xl(t=>t+1),children:"تحميل المزيد"})})]}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"}),e.jsxs(et,{className:"flex justify-between mt-3",children:[e.jsx(x,{variant:"destructive",onClick:async()=>{try{if(!ft||ft.length===0){i({title:"لا توجد ديون",description:"القائمة فارغة بالفعل."});return}if(!window.confirm("هل تريد حذف كل إيصالات الديون؟ هذا الإجراء لا يمكن التراجع عنه."))return;const a=[];if(Es(a),Ka(null),await ma(a),s!=null&&s.uid)try{await Ae.updateUserData(s.uid,{debts:[],debtsDeletedAt:dt()});try{localStorage.removeItem(`debts_unsynced_${s.uid}`)}catch{}}catch(r){console.error("تعذر حذف الديون من Firebase:",r),i({title:"فشل الحذف من السحابة",description:"تعذر حذف الإيصالات من Firebase، حاول مرة أخرى.",variant:"destructive"});return}i({title:"تم حذف كل إيصالات الديون",description:"تم تفريغ القائمة بالكامل."}),xr(!1)}catch(t){console.error("تعذر حذف كل إيصالات الديون:",t),i({title:"فشل الحذف",description:"حدث خطأ أثناء الحذف، حاول مرة أخرى.",variant:"destructive"})}},children:"حذف كل الإيصالات"}),e.jsx(x,{variant:"outline",onClick:()=>xr(!1),children:"إغلاق"})]})]})}),e.jsx(ve,{open:oh,onOpenChange:fl,children:e.jsxs(we,{className:"sm:max-w-[500px] w-full max-h-[90vh] overflow-hidden flex flex-col p-0 gap-0 bg-gray-50/50",children:[e.jsx("div",{className:"p-4 border-b bg-white",children:e.jsxs(Ie,{children:[e.jsxs(Ne,{className:"text-right flex items-center justify-end gap-2",children:[e.jsx(nr,{className:"w-5 h-5 text-primary"}),"إدارة العملاء والديون"]}),e.jsx(hs,{className:"text-right",children:"سجل بيانات العملاء والديون بسهولة"})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[e.jsxs(pt,{className:"border shadow-sm bg-white",children:[e.jsx(Xt,{className:"pb-2 pt-4 px-4",children:e.jsxs(vs,{className:"text-sm font-medium text-right text-gray-700 flex items-center justify-end gap-2",children:[e.jsx(Ut,{className:"w-4 h-4"}),"إضافة عميل جديد"]})}),e.jsxs(Nt,{className:"p-4 pt-2 space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{className:"text-right block text-xs text-gray-500",children:"اسم العميل"}),e.jsx(q,{value:bl,onChange:t=>ic(t.target.value),className:"text-right h-9",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{className:"text-right block text-xs text-gray-500",children:"رقم الموبايل"}),e.jsx(q,{value:vl,onChange:t=>lc(t.target.value),className:"text-right h-9",placeholder:"اكتب رقم الموبايل"})]}),e.jsxs(x,{className:"w-full bg-emerald-600 hover:bg-emerald-700 text-white h-9 mt-2",onClick:async()=>{if(!bl||!vl){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const t={id:Date.now().toString(),name:bl.trim(),mobile:vl.trim(),createdAt:new Date},a=[t,...Ks];await Fl(a),ic(""),lc(""),i({title:"تمت إضافة العميل",description:`تم إضافة ${t.name}`})},children:[e.jsx(Ut,{className:"w-4 h-4 mr-2"}),"إضافة العميل"]})]})]}),e.jsxs(pt,{className:"border shadow-sm bg-white",children:[e.jsx(Xt,{className:"pb-2 pt-4 px-4",children:e.jsxs(vs,{className:"text-sm font-medium text-right text-gray-700 flex items-center justify-end gap-2",children:[e.jsx(es,{className:"w-4 h-4 text-orange-600"}),"تسجيل مبلغ دين"]})}),e.jsx(Nt,{className:"p-4 pt-2 space-y-3",children:Ks.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{className:"text-right block text-xs text-gray-500",children:"اختر العميل"}),e.jsxs(tr,{value:Mr,onValueChange:oc,children:[e.jsx(sr,{className:"w-full h-9 text-right",dir:"rtl",children:e.jsx(ar,{placeholder:"اختر عميل"})}),e.jsx(rr,{children:Ks.map(t=>e.jsxs(fa,{value:t.id,className:"text-right justify-end",children:[t.name," — ",t.mobile]},t.id))})]}),Mr&&(()=>{const t=ft.filter(a=>a.customerId===Mr&&a.status==="pending").reduce((a,r)=>a+(r.amount-(r.paidAmount||0)),0);return t>0?e.jsxs("div",{className:"text-xs text-red-600 font-semibold mt-1 text-right",children:["إجمالي الديون الحالية: ",t.toFixed(2)," جنيه"]}):null})()]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{className:"text-right block text-xs text-gray-500",children:"المبلغ"}),e.jsx(q,{type:"number",value:cc,onChange:t=>ch(t.target.value),className:"text-right h-9",placeholder:"0.00"})]}),e.jsx(x,{className:"w-full bg-orange-600 hover:bg-orange-700 text-white h-9 mt-2",onClick:async()=>{const t=parseFloat(cc);if(!Mr){i({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(t)||t<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Ks.find(l=>l.id===Mr);if(!a)return;const r={id:Date.now().toString(),debtorName:a.name,customerId:a.id,mobile:a.mobile,amount:Number(t.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};dn(r),Lr(!0)},children:"متابعة وإضافة المبلغ"})]}):e.jsx("div",{className:"text-center py-4 text-gray-500 text-sm bg-gray-50 rounded border border-dashed",children:"لا يوجد عملاء مسجلين. أضف عميلاً أولاً."})})]}),e.jsxs(pt,{className:"border shadow-sm bg-white",children:[e.jsx(Xt,{className:"pb-2 pt-4 px-4",children:e.jsxs(vs,{className:"text-sm font-medium text-right text-gray-700 flex items-center justify-end gap-2",children:[e.jsx(hd,{className:"w-4 h-4"}),"العملاء المسجلين (",Ks.length,")"]})}),e.jsx(Nt,{className:"p-4 pt-2",children:Ks.length>0?e.jsx("div",{className:"space-y-2",children:Ks.map(t=>e.jsxs("div",{className:"p-3 border rounded-lg flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition-colors",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8 text-blue-600 hover:text-blue-700 hover:bg-blue-50",onClick:()=>{dc(t.id),wl(t.name||""),Nl(t.mobile||""),ei(!0)},children:e.jsx(_i,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8 text-red-600 hover:text-red-700 hover:bg-red-50",onClick:()=>{jl(t.id),Sl(t.name||""),ti(!0)},children:e.jsx(bs,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium text-sm text-gray-900",children:t.name}),e.jsx("div",{className:"text-xs text-gray-500 font-mono",children:t.mobile})]})]},t.id))}):e.jsx("div",{className:"text-center py-4 text-gray-400 text-sm",children:"لا توجد بيانات لعرضها"})})]})]}),e.jsx(et,{className:"p-4 border-t bg-white",children:e.jsx(x,{variant:"outline",className:"w-full sm:w-auto",onClick:()=>fl(!1),children:"إغلاق"})})]})}),e.jsx(ve,{open:hh,onOpenChange:ti,children:e.jsxs(we,{hideClose:!0,className:"sm:max-w-[420px] rounded-2xl bg-gradient-to-br from-white via-rose-50 to-red-50 shadow-2xl border border-red-100 text-center",children:[e.jsxs(Ie,{children:[e.jsx(Ne,{className:"text-center text-xl font-bold text-red-700",children:"تأكيد حذف العميل"}),e.jsxs(hs,{className:"text-center text-gray-600",children:["سيتم حذف العميل نهائيًا: ",uc]})]}),e.jsx("div",{className:"py-2 text-sm text-gray-700",children:"لا يمكن التراجع عن هذا الإجراء."}),e.jsxs(et,{className:"flex justify-center gap-3",children:[e.jsx(x,{variant:"outline",onClick:()=>{ti(!1),jl(""),Sl("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",className:"bg-red-600 hover:bg-red-700",onClick:async()=>{const t=uh,a=Ks.filter(r=>r.id!==t);await Fl(a),Mr===t&&oc(""),ti(!1),jl(""),Sl(""),i({title:"تم حذف العميل",description:uc})},children:"حذف نهائي"})]})]})}),e.jsx(ve,{open:dh,onOpenChange:ei,children:e.jsxs(we,{className:"sm:max-w-[420px]",children:[e.jsx(Ie,{children:e.jsx(Ne,{className:"text-right",children:"تعديل بيانات العميل"})}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"editCustomerName",className:"text-right col-span-1",children:"الاسم"}),e.jsx(q,{id:"editCustomerName",value:mc,onChange:t=>wl(t.target.value),className:"col-span-3 text-right"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"editCustomerMobile",className:"text-right col-span-1",children:"الموبايل"}),e.jsx(q,{id:"editCustomerMobile",value:hc,onChange:t=>Nl(t.target.value),className:"col-span-3 text-right"})]})]}),e.jsxs(et,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>ei(!1),children:"إلغاء"}),e.jsx(x,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=mh,a=mc.trim(),r=hc.trim();if(!t||!a||!r){i({title:"بيانات غير مكتملة",description:"أدخل الاسم ورقم الموبايل",variant:"destructive"});return}const l=Ks.map(h=>h.id===t?{...h,name:a,mobile:r}:h);await Fl(l);const o=ft.map(h=>h.customerId===t?{...h,debtorName:a,mobile:r}:h);o!==ft&&(Es(o),await ma(o)),ei(!1),dc(""),wl(""),Nl(""),i({title:"تم تحديث العميل",description:a})},children:"حفظ"})]})]})}),e.jsx(ve,{open:Nr,onOpenChange:la,children:e.jsxs(we,{className:"sm:max-w-[520px]",children:[e.jsxs(Ie,{children:[e.jsx(Ne,{className:"text-right",children:"مصروفات المحل"}),e.jsx(hs,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx(q,{id:"expenseName",value:Dt,onChange:t=>oa(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx(q,{id:"expenseAmount",type:"number",value:Qr,onChange:t=>za(t.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx(q,{id:"expenseNotes",value:jr,onChange:t=>Gr(t.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(et,{className:"flex justify-between",children:[e.jsx(x,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!Dt||!Qr){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}Cr(!0)},children:"إضافة مصروف"}),e.jsx(x,{variant:"outline",onClick:()=>d(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(ve,{open:$i,onOpenChange:d,children:e.jsxs(we,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(Ie,{children:[e.jsx(Ne,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(hs,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),Sr.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:Sr.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:t.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left flex items-start gap-2",children:[e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[t.amount," جنيه"]}),e.jsx(Lt,{variant:"secondary",className:t.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:t.source==="cash"?"من النقدية":`من المحفظة${t.walletId?` (${t.walletId})`:""}`})]}),e.jsxs(x,{variant:"destructive",size:"sm",className:"shrink-0",onClick:()=>Th(t.id),title:"حذف نهائي",children:[e.jsx(bs,{className:"w-4 h-4 ml-1"}),"حذف"]})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(ve,{open:Wn,onOpenChange:Cr,children:e.jsxs(we,{className:"sm:max-w-[480px]",children:[e.jsx(Ie,{children:e.jsx(Ne,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(x,{variant:Qt==="cash"?"default":"outline",className:Qt==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>or("cash"),children:"الفلوس النقدية"}),e.jsx(x,{variant:Qt==="wallet"?"default":"outline",className:Qt==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>or("wallet"),children:"أرصدة المحافظ"}),e.jsx(x,{variant:Qt==="fawry"?"default":"outline",className:Qt==="fawry"?"bg-amber-600 hover:bg-amber-700 text-white":"",onClick:()=>or("fawry"),children:"فوري"})]}),Qt==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(tr,{value:Va,onValueChange:Ir,children:[e.jsx(sr,{className:"w-full",children:e.jsx(ar,{placeholder:"اختر محفظة"})}),e.jsx(rr,{children:Ue.map(t=>e.jsx(fa,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(et,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>{Cr(!1),or(null),Ir("")},children:"إلغاء"}),e.jsx(x,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=Number(Qr);if(isNaN(t)||t<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!Qt){i({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(Qt==="cash"){const o=Number((Ot-t).toFixed(2));cs(o),localStorage.setItem(zt(),o.toString());const h={cashBalance:o,lastUpdated:new Date().toISOString()},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(h)),s!=null&&s.uid?(await Ae.updateUserData(s.uid,h),localStorage.removeItem(m),st(!1)):st(!0)}else if(Qt==="wallet"){if(!Va){i({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const o=tt[Va]||0,h=Number((o-t).toFixed(2)),m={...tt,[Va]:h};fs(m);const u=new Date().toISOString(),v={walletBalances:m,lastUpdated:u},f=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(f,JSON.stringify(v)),localStorage.setItem(ds(),JSON.stringify(m)),localStorage.setItem(`walletBalances_backup_${u}`,JSON.stringify(m)),s!=null&&s.uid&&Ae.updateUserData(s.uid,v).catch(()=>{})}}catch(o){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",o)}let a=Date.now().toString();try{if(s!=null&&s.uid){const{addDoc:o,collection:h,serverTimestamp:m}=await xt(async()=>{const{addDoc:f,collection:g,serverTimestamp:j}=await import("./index-BwuekbvX.js").then(A=>A.ci);return{addDoc:f,collection:g,serverTimestamp:j}},__vite__mapDeps([0,1]),import.meta.url),{db:u}=await xt(async()=>{const{db:f}=await import("./index-BwuekbvX.js").then(g=>g.cj);return{db:f}},__vite__mapDeps([0,1]),import.meta.url);a=(await o(h(u,"shop_expenses"),{userId:s.uid,shopId:k||(b==null?void 0:b.shopId)||s.uid||"default-shop",name:Dt,amount:t,notes:jr||"",source:Qt,walletId:Qt==="wallet"?Va:null,createdAt:m()})).id}}catch(o){console.error("خطأ أثناء حفظ المصروف في Firestore:",o)}const r={id:a,name:Dt,amount:t,notes:jr,source:Qt,walletId:Qt==="wallet"?Va:void 0,createdAt:new Date},l=[...Sr,r];await Ic(l),oa(""),za(""),Gr(""),or(null),Ir(""),Cr(!1),la(!0),d(!0),i({title:"تم إضافة المصروف",description:Qt==="cash"?"تم الخصم من النقدية":Qt==="wallet"?"تم الخصم من أرصدة المحافظ":"تم تسجيل الدفع عبر فوري"})},children:"تأكيد الخصم"})]})]})}),e.jsx(ve,{open:se,onOpenChange:ge,children:e.jsxs(we,{className:"sm:max-w-[520px]",children:[e.jsxs(Ie,{children:[e.jsx(Ne,{className:"text-right",children:"النواقص"}),e.jsx(hs,{className:"text-right",children:"سجل العناصر الناقصة التي تحتاج شراء وتابع حالتها."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"deficiencyName",className:"text-right col-span-1",children:"اسم العنصر"}),e.jsx(q,{id:"deficiencyName",value:ce,onChange:t=>Ce(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: سكر، زيت، مناديل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"deficiencyQuantity",className:"text-right col-span-1",children:"الكمية"}),e.jsx(q,{id:"deficiencyQuantity",type:"number",value:ke,onChange:t=>fe(t.target.value),className:"col-span-3 text-right",placeholder:"1"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(x,{className:"bg-rose-600 hover:bg-rose-700",onClick:()=>{if(wt){i({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}const t=parseInt(ke||"1",10);if(!ce){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العنصر",variant:"destructive"});return}if(isNaN(t)||t<=0){i({title:"كمية غير صحيحة",description:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}(async()=>{if(s!=null&&s.uid)try{const{collection:r,addDoc:l,serverTimestamp:o}=await xt(async()=>{const{collection:u,addDoc:v,serverTimestamp:f}=await import("./index-BwuekbvX.js").then(g=>g.ci);return{collection:u,addDoc:v,serverTimestamp:f}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await xt(async()=>{const{db:u}=await import("./index-BwuekbvX.js").then(v=>v.cj);return{db:u}},__vite__mapDeps([0,1]),import.meta.url),m=await l(r(h,"deficiencies"),{userId:s.uid,shopId:k||(b==null?void 0:b.shopId)||s.uid||"default-shop",name:ce,quantity:t,status:"pending",createdAt:o()});try{const u=ci(),v=localStorage.getItem(u),f=v?JSON.parse(v):[],g=Array.isArray(f)?f:[],j=g.some(R=>String((R==null?void 0:R.id)||"")===m.id),A={id:m.id,name:ce,quantity:t,status:"pending",createdAt:new Date().toISOString()},I=j?g:[...g,A];localStorage.setItem(u,JSON.stringify(I))}catch{}Ce(""),fe(""),i({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"});return}catch(r){console.warn("فشل حفظ النواقص إلى Firestore، سيُستخدم التخزين المحلي:",r)}const a={id:Date.now().toString(),name:ce,quantity:t,status:"pending",createdAt:new Date};ue(r=>{const l=[...r,a];return Wl(l),l}),Ce(""),fe(""),i({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"})})()},children:"إضافة للنواقص"})}),We.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:We.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["الكمية: ",t.quantity]}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Lt,{variant:"secondary",className:t.status==="pending"?"bg-rose-100 text-rose-700":"bg-green-100 text-green-700",children:t.status==="pending"?"قيد الشراء":"تم الشراء"}),e.jsx(x,{variant:"outline",className:t.status==="pending"?"text-green-700 border-green-300 hover:bg-green-50":"text-rose-700 border-rose-300 hover:bg-rose-50",onClick:()=>{(async()=>{const a=t.status==="pending"?"purchased":"pending";if(s!=null&&s.uid)try{const{doc:r,updateDoc:l,serverTimestamp:o}=await xt(async()=>{const{doc:m,updateDoc:u,serverTimestamp:v}=await import("./index-BwuekbvX.js").then(f=>f.ci);return{doc:m,updateDoc:u,serverTimestamp:v}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await xt(async()=>{const{db:m}=await import("./index-BwuekbvX.js").then(u=>u.cj);return{db:m}},__vite__mapDeps([0,1]),import.meta.url);await l(r(h,"deficiencies",t.id),{status:a,updatedAt:o()});return}catch(r){console.warn("فشل تحديث حالة النواقص على Firestore، استخدام التخزين المحلي:",r)}ue(r=>{const l=r.map(o=>o.id===t.id?{...o,status:a}:o);return Wl(l),l})})()},title:t.status==="pending"?"تم الشراء":"إلغاء الشراء",children:t.status==="pending"?"تم الشراء":"إلغاء الشراء"}),e.jsx(x,{variant:"outline",className:"text-red-700 border-red-300 hover:bg-red-50",onClick:()=>{(async()=>{if(s!=null&&s.uid)try{const{doc:a,deleteDoc:r}=await xt(async()=>{const{doc:o,deleteDoc:h}=await import("./index-BwuekbvX.js").then(m=>m.ci);return{doc:o,deleteDoc:h}},__vite__mapDeps([0,1]),import.meta.url),{db:l}=await xt(async()=>{const{db:o}=await import("./index-BwuekbvX.js").then(h=>h.cj);return{db:o}},__vite__mapDeps([0,1]),import.meta.url);await r(a(l,"deficiencies",t.id));return}catch(a){console.warn("فشل حذف عنصر النواقص من Firestore، استخدام التخزين المحلي:",a)}ue(a=>{const r=a.filter(l=>l.id!==t.id);return Wl(r),r})})()},title:"حذف",children:"حذف"})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد عناصر مسجلة في النواقص"})]}),e.jsx(et,{className:"flex justify-end",children:e.jsx(x,{variant:"outline",onClick:()=>ge(!1),children:"إغلاق"})})]})}),e.jsx(ve,{open:xh,onOpenChange:Lr,children:e.jsxs(we,{className:"sm:max-w-[480px]",children:[e.jsx(Ie,{children:e.jsx(Ne,{className:"text-right",children:(Gt==null?void 0:Gt.type)==="decrease"?"اختيار مكان إضافة مبلغ السداد":"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:(Gt==null?void 0:Gt.type)==="decrease"?"اختر هل تريد إضافة مبلغ السداد إلى الرصيد النقدي أم إلى إحدى المحافظ أو تسجيله بدون خصم.":"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(x,{variant:Us==="cash"?"default":"outline",className:Us==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>mn("cash"),children:"الفلوس النقدية"}),e.jsx(x,{variant:Us==="wallet"?"default":"outline",className:Us==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>mn("wallet"),children:"أرصدة المحافظ"}),e.jsx(x,{variant:Us==="none"?"default":"outline",className:Us==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>mn("none"),children:(Gt==null?void 0:Gt.type)==="decrease"?"بدون إضافة":"بدون خصم"})]}),Us==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-right block",children:(Gt==null?void 0:Gt.type)==="decrease"?"اختر المحفظة للإضافة":"اختر المحفظة للخصم"}),e.jsxs(tr,{value:hn,onValueChange:Dl,children:[e.jsx(sr,{className:"w-full",children:e.jsx(ar,{placeholder:"اختر محفظة"})}),e.jsx(rr,{children:Ue.map(t=>e.jsx(fa,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(et,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>{Lr(!1),dn(null),mn(null),Dl("")},children:"إلغاء"}),e.jsx(x,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=!!Gt,a=t&&(Gt==null?void 0:Gt.type)==="decrease",r=Number(t?Gt.delta:(pr==null?void 0:pr.amount)||0);if(!Us){i({title:a?"اختر مكان الإضافة":"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}const l=new Date().toISOString();let o=Ot,h=tt,m=!1,u=!1;try{if(Us==="cash")o=Number(a?(Ot+r).toFixed(2):(Ot-r).toFixed(2)),m=!0;else if(Us==="wallet"){if(!hn){i({title:"اختر محفظة",description:a?"يرجى اختيار محفظة للإضافة":"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const I=tt[hn]||0,R=Number(a?(I+r).toFixed(2):(I-r).toFixed(2));h={...tt,[hn]:R},u=!0}}catch(I){console.error("Error calculating balances:",I);return}let v=[...ft],f=X,g=!1;if(t){if(!X)return;const I=Number(X.amount||0),R=Number(X.paidAmount||0),me=Number(Gt.delta||0);if(Gt.type==="decrease"){const _=Number((I-me).toFixed(2)),J=R>=_,be={...X,amount:_,status:J?"paid":"pending"};if(v=ft.map(Ve=>Ve.id===X.id?be:Ve),f=be,g=!0,J&&(s!=null&&s.uid)&&(async()=>{try{const[Ve,ms,sa]=[Je(je(U,"userTransactions"),de("userId","==",s.uid),de("linkedDebtId","==",X.id),de("status","==","pending")),Je(je(U,"transactions"),de("userId","==",s.uid),de("linkedDebtId","==",X.id),de("status","==","pending")),Je(je(U,"transactions"),de("merchantUserId","==",s.uid),de("linkedDebtId","==",X.id),de("status","==","pending"))],[ut,Pt,ys]=await Promise.all([Re(Ve),Re(ms),Re(sa)]),Ds=Fu(U);let Ga=0;const Rr=he=>{he.docs.forEach(Pe=>{Ds.update(Pe.ref,{status:"completed",confirmedAt:new Date}),Ga++})};Rr(ut),Rr(Pt),Rr(ys),Ga>0&&await Ds.commit(),s!=null&&s.uid&&[...ut.docs.map(Pe=>{var at;return String(((at=Pe.data())==null?void 0:at.transactionId)||"")}),...Pt.docs.map(Pe=>{var at;return String(Pe.id||((at=Pe.data())==null?void 0:at.transactionId)||"")}),...ys.docs.map(Pe=>{var at;return String(Pe.id||((at=Pe.data())==null?void 0:at.transactionId)||"")})].filter(Boolean).forEach(Pe=>Ae.removeLocalReceiptById(s.uid,Pe))}catch(Ve){console.error("Batch update failed for linked transactions:",Ve)}})().catch(Ve=>{console.error("Transaction update error:",Ve)}),s!=null&&s.uid&&Us!=="none")try{const ms={transactionId:Oe(je(U,"dummy_collection")).id,amount:me,transactionType:"cash_addition",type:"cash_addition",status:"completed",createdAt:new Date,senderName:X.debtorName,receiverName:"المحل",description:`سداد دين من العميل ${X.debtorName}`,paymentMethod:Us,walletId:Us==="wallet"?hn:null,linkedDebtId:X.id,isDebtRepayment:!0};await Ae.saveUserTransaction(s.uid,ms);try{$.invalidateQueries({queryKey:["recentTransactions",s==null?void 0:s.uid]})}catch{}}catch(Ve){console.error("Failed to create repayment receipt:",Ve)}i({title:"تم إنقاص المبلغ",description:`المبلغ الجديد: ${_} جنيه`})}else{const _=I+me,J=R>=_,be={...X,amount:Number(_.toFixed(2)),status:J?"paid":"pending"};v=ft.map(Ve=>Ve.id===X.id?be:Ve),f=be,g=!0,i({title:"تم زيادة المبلغ",description:`المبلغ الجديد: ${_} جنيه`})}}else if(pr){v=[{...pr,userId:s==null?void 0:s.uid,shopId:k||(b==null?void 0:b.shopId)||null},...ft],g=!0;try{s!=null&&s.uid&&Xa.send(s.uid,`تم إضافة دين على ${pr.debtorName} بمبلغ ${pr.amount} جنيه`).catch(()=>{})}catch{}}m&&cs(o),u&&fs(h),g&&(Es(v),t&&Ka(f)),Go(""),Zo(""),Xo(""),Or(!1),Lr(!1),!t&&g&&xr(!0),dn(null),ac(null),mn(null),Dl(""),i({title:t?"تم تعديل الدين":"تم حفظ الدين",description:Us==="none"?"لم يتم تعديل الأرصدة":Us==="cash"?a?`تمت إضافة ${r} إلى الرصيد النقدي`:`تم خصم ${r} من الرصيد النقدي`:a?`تمت إضافة ${r} إلى رصيد المحفظة`:`تم خصم ${r} من رصيد المحفظة`});const j={lastUpdated:l};if(m&&(j.cashBalance=o),u&&(j.walletBalances=h),g&&(j.debts=v,j.debtsDeletedAt=null),m&&(localStorage.setItem(zt(),o.toString()),localStorage.setItem(zt()+"_lastUpdated",l)),u&&(localStorage.setItem(ds(),JSON.stringify(h)),localStorage.setItem(ds()+"_lastUpdated",l)),g){localStorage.setItem(xn(),JSON.stringify(v));try{localStorage.setItem(Ml(),JSON.stringify(v))}catch{}try{localStorage.setItem(Ll(),Date.now().toString())}catch{}}const A=`userData_${s==null?void 0:s.uid}`;if(localStorage.setItem(A,JSON.stringify(j)),s!=null&&s.uid){if(g)try{localStorage.setItem(`debts_unsynced_${s.uid}`,"true")}catch{}const I=[];I.push(Ae.updateUserData(s.uid,j).then(()=>{(m||u)&&(localStorage.removeItem(A),st(!1))}));const R=k||(b==null?void 0:b.shopId);if(R&&(m||u)){const me={lastUpdated:l};m&&(me.cashBalance=o),u&&(me.walletBalances=h),I.push(As(Oe(U,"dashboardData",R),me,{merge:!0}).catch(_=>console.error("Failed to sync to dashboardData",_)))}Promise.all(I).then(()=>{if(g)try{localStorage.removeItem(`debts_unsynced_${s.uid}`)}catch{}}).catch(me=>{console.error("Sync error:",me),st(!0)})}},children:(Gt==null?void 0:Gt.type)==="decrease"?"تأكيد الإضافة":"تأكيد الخصم"})]})]})}),e.jsx(ve,{open:rh,onOpenChange:Ya,children:e.jsxs(we,{className:"w-[95vw] sm:w-auto sm:max-w-[425px] rounded-2xl",children:[e.jsx(Ie,{children:e.jsx(Ne,{className:"text-right",children:"إيصال الدين"})}),X&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:Si.format(X.createdAt instanceof Date?X.createdAt:new Date(X.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:X.debtorName})]}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:justify-between sm:items-center",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"outline",className:"h-10 w-10 sm:h-8 sm:w-8 p-0","aria-label":"إنقاص الدين",onClick:()=>{tc("decrease"),dl(""),Ya(!1),cn(!0)},children:"−"}),e.jsxs("span",{className:"font-bold text-xl sm:text-lg",children:[X.amount," جنيه"]}),e.jsx(x,{variant:"outline",className:"h-10 w-10 sm:h-8 sm:w-8 p-0","aria-label":"زيادة الدين",onClick:()=>{tc("increase"),dl(""),Ya(!1),cn(!0)},children:"+"})]})]}),(()=>{try{const t=(Ye||[]).filter(a=>String((a==null?void 0:a.linkedDebtId)||"")===String(X.id)).reduce((a,r)=>a+Math.max(0,Number((r==null?void 0:r.commission)||0)),0);return t>0?e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"الربح:"}),e.jsxs("span",{className:"text-green-700 font-semibold",children:[t," جنيه"]})]}):null}catch{return null}})(),e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:X.reason})]}),e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(Lt,{variant:X.status==="paid"?"default":"secondary",className:`${X.status==="paid"?"bg-green-500":"bg-yellow-500"} w-fit text-[12px] sm:text-xs`,children:X.status==="paid"?"مدفوع":"مؤجل"})]}),(()=>{try{const t=(Ye||[]).filter(v=>String((v==null?void 0:v.linkedDebtId)||"")===String(X.id)),a=t.reduce((v,f)=>v+Math.max(0,Number((f==null?void 0:f.commission)||0)),0),r=t.reduce((v,f)=>v+Math.max(0,Number(((f==null?void 0:f.sentAmount)??(f==null?void 0:f.transferredAmount)??(f==null?void 0:f.withdrawnAmount)??(f==null?void 0:f.amount))||0)),0),l=Number(X.amount||0),o=Number(X.paidAmount||0),m=l<r+a?l+a:l,u=Math.max(0,Number(m)-o);return e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-xl sm:text-lg",children:[u," جنيه"]})]})}catch{return e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-xl sm:text-lg",children:[Number(X.amount||0)-Number(X.paidAmount||0)," جنيه"]})]})}})(),X.paidAmount?e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[X.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-4 border rounded-xl bg-gray-50",children:[ih?e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx(q,{id:"partialAmount",type:"number",value:rc,onChange:t=>hl(t.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{ml(!1),hl("")},children:"إلغاء"}),e.jsx(x,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const t=parseFloat(rc);if(!X||isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Math.max(0,Number(X.amount||0)-Number(X.paidAmount||0));if(t>a){i({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const r=Number(((X.paidAmount||0)+t).toFixed(2)),l=r>=Number(X.amount||0),o={...X,amount:Number(X.amount||0),paidAmount:r,status:l?"paid":"pending",partialPayments:[...X.partialPayments||[],{amount:t,paidAt:new Date}]},h=ft.map(m=>m.id===X.id?o:m);Es(h),Ka(o),await ma(h);try{if(s!=null&&s.uid){const m=Math.max(0,Number(o.amount||0)-Number(o.paidAmount||0));await Xa.send(s.uid,`تم سداد جزء من دين ${o.debtorName}: المدفوع ${t} جنيه، المتبقي ${m} جنيه`)}}catch{}try{o.status==="paid"&&(s!=null&&s.uid)&&(async()=>{const m=Je(je(U,"userTransactions"),de("userId","==",s.uid),de("linkedDebtId","==",X.id),de("status","==","pending")),u=await Re(m);await Promise.allSettled(u.docs.map(A=>Yt(A.ref,{status:"completed",confirmedAt:new Date})));try{const A=u.docs.map(I=>{var R;return String(((R=I.data())==null?void 0:R.transactionId)||"")});s!=null&&s.uid&&A.forEach(I=>I&&Ae.removeLocalReceiptById(s.uid,I))}catch{}const v=Je(je(U,"transactions"),de("userId","==",s.uid),de("linkedDebtId","==",X.id),de("status","==","pending")),f=await Re(v);await Promise.allSettled(f.docs.map(A=>Yt(A.ref,{status:"completed",confirmedAt:new Date})));try{const A=f.docs.map(I=>{var R;return String(I.id||((R=I.data())==null?void 0:R.transactionId)||"")});s!=null&&s.uid&&A.forEach(I=>I&&Ae.removeLocalReceiptById(s.uid,I))}catch{}const g=Je(je(U,"transactions"),de("merchantUserId","==",s.uid),de("linkedDebtId","==",X.id),de("status","==","pending")),j=await Re(g);await Promise.allSettled(j.docs.map(A=>Yt(A.ref,{status:"completed",confirmedAt:new Date})));try{const A=j.docs.map(I=>{var R;return String(I.id||((R=I.data())==null?void 0:R.transactionId)||"")});s!=null&&s.uid&&A.forEach(I=>I&&Ae.removeLocalReceiptById(s.uid,I))}catch{}})().catch(m=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",m),i({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(m){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",m)}try{const m=Rl(),u=localStorage.getItem(m);if(u){const f=(JSON.parse(u)||[]).map(g=>(g==null?void 0:g.linkedDebtId)===X.id&&(g==null?void 0:g.status)==="pending"?{...g,status:"completed",confirmedAt:new Date}:g);localStorage.setItem(m,JSON.stringify(f)),ea(g=>g.map(j=>(j==null?void 0:j.linkedDebtId)===X.id&&(j==null?void 0:j.status)==="pending"?{...j,status:"completed",confirmedAt:new Date}:j))}}catch(m){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",m)}si(t),Ha("none"),$r(!0),ml(!1),hl(""),i({title:"تم تسجيل دفع جزء",description:`تم دفع ${t} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(x,{variant:"outline",className:"w-full",onClick:()=>ml(!0),children:"دفع جزء"}),X.partialPayments&&X.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-[12px] sm:text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-[30vh] sm:max-h-24 overflow-y-auto",children:X.partialPayments.map((t,a)=>e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsxs("span",{children:["دفع: ",t.amount," جنيه"]}),e.jsx("span",{children:new Date(t.paidAt).toLocaleString("ar-EG")})]},a))})]})]})]})]}),e.jsxs(et,{className:"flex gap-2 justify-center",children:[e.jsx(x,{onClick:async()=>{if(X){const t=ft.map(a=>a.id===X.id?{...a,status:"pending"}:a);Es(t),await ma(t);try{if(s!=null&&s.uid){const a=computedRemaining;await Xa.send(s.uid,`تم سداد الدين بالكامل للعميل ${X.debtorName}: المدفوع ${a} جنيه`)}}catch{}Ya(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(x,{onClick:async()=>{if(X){const t=Number(X.amount||0),a=Number(X.paidAmount||0);let r=Math.max(0,t-a);try{const h=(Ye||[]).filter(g=>String((g==null?void 0:g.linkedDebtId)||"")===String(X.id)),m=h.reduce((g,j)=>g+Math.max(0,Number((j==null?void 0:j.commission)||0)),0),u=h.reduce((g,j)=>g+Math.max(0,Number(((j==null?void 0:j.sentAmount)??(j==null?void 0:j.transferredAmount)??(j==null?void 0:j.withdrawnAmount)??(j==null?void 0:j.amount))||0)),0),f=t<u+m?t+m:t;r=Math.max(0,Number(f)-a)}catch{}const l=r,o=ft.map(h=>{if(h.id!==X.id)return h;const m=Number(h.amount||0),u=Number(h.paidAmount||0),v=Number((u+l).toFixed(2)),f=v>=m;return{...h,amount:m,paidAmount:f?m:v,status:"paid",partialPayments:[...h.partialPayments||[],...l>0?[{amount:l,paidAt:new Date}]:[]]}});Es(o);try{Ka(o.find(h=>h.id===X.id)||null)}catch{}si(l),Ha("none"),$r(!0),await ma(o);try{s!=null&&s.uid&&(X!=null&&X.id)&&(async()=>{const h=Je(je(U,"userTransactions"),de("userId","==",s.uid),de("linkedDebtId","==",X.id),de("status","==","pending")),m=await Re(h);await Promise.allSettled(m.docs.map(j=>Yt(j.ref,{status:"completed",confirmedAt:new Date})));try{const j=m.docs.map(A=>{var I;return String(((I=A.data())==null?void 0:I.transactionId)||"")});s!=null&&s.uid&&j.forEach(A=>A&&Ae.removeLocalReceiptById(s.uid,A))}catch{}const u=Je(je(U,"transactions"),de("userId","==",s.uid),de("linkedDebtId","==",X.id),de("status","==","pending")),v=await Re(u);await Promise.allSettled(v.docs.map(j=>Yt(j.ref,{status:"completed",confirmedAt:new Date})));try{const j=v.docs.map(A=>{var I;return String(A.id||((I=A.data())==null?void 0:I.transactionId)||"")});s!=null&&s.uid&&j.forEach(A=>A&&Ae.removeLocalReceiptById(s.uid,A))}catch{}const f=Je(je(U,"transactions"),de("merchantUserId","==",s.uid),de("linkedDebtId","==",X.id),de("status","==","pending")),g=await Re(f);await Promise.allSettled(g.docs.map(j=>Yt(j.ref,{status:"completed",confirmedAt:new Date})));try{const j=g.docs.map(A=>{var I;return String(A.id||((I=A.data())==null?void 0:I.transactionId)||"")});s!=null&&s.uid&&j.forEach(A=>A&&Ae.removeLocalReceiptById(s.uid,A))}catch{}})().catch(h=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",h),i({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(h){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",h)}try{const h=Rl(),m=localStorage.getItem(h);if(m){const v=(JSON.parse(m)||[]).map(f=>(f==null?void 0:f.linkedDebtId)===X.id&&(f==null?void 0:f.status)==="pending"?{...f,status:"completed",confirmedAt:new Date}:f);localStorage.setItem(h,JSON.stringify(v)),ea(f=>f.map(g=>(g==null?void 0:g.linkedDebtId)===X.id&&(g==null?void 0:g.status)==="pending"?{...g,status:"completed",confirmedAt:new Date}:g))}}catch(h){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",h)}Ya(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(x,{onClick:async()=>{if(X){const t=ft.filter(a=>a.id!==X.id);Es(t),await ma(t),Ya(!1),i({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(ve,{open:nh,onOpenChange:cn,children:e.jsxs(we,{className:"sm:max-w-md rounded-2xl shadow-elegant border border-gray-200",children:[e.jsxs(Ie,{children:[e.jsx(Ne,{className:`text-right ${ur==="decrease"?"text-red-600":"text-green-600"}`,children:ur==="decrease"?"إنقاص مبلغ الدين":ur==="increase"?"زيادة مبلغ الدين":"تعديل مبلغ الدين"}),e.jsxs(hs,{className:"text-right",children:["أدخل المبلغ ثم اضغط تأكيد لإتمام ",ur==="decrease"?"الإنقاص":"الزيادة","."]})]}),e.jsxs("div",{className:"grid gap-4 py-2",children:[e.jsx(Z,{htmlFor:"debtAdjustAmount",className:"text-right",children:"المبلغ (جنيه)"}),e.jsx(q,{id:"debtAdjustAmount",type:"number",placeholder:"0.00",value:sc,onChange:t=>dl(t.target.value)}),X&&e.jsxs("div",{className:"text-right text-sm text-muted-foreground",children:["المبلغ الحالي: ",e.jsx("span",{className:"font-semibold",children:Number(X.amount||0).toFixed(2)})," جنيه"]})]}),e.jsxs(et,{className:"flex gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>{cn(!1),Ya(!0)},children:"إلغاء"}),e.jsx(x,{className:ur==="decrease"?"bg-red-600 hover:bg-red-700":"bg-green-600 hover:bg-green-700",onClick:async()=>{try{if(!X||!ur)return;const t=Number(parseFloat(sc||"0").toFixed(2));if(!t||isNaN(t)||t<=0){i({title:"قيمة غير صالحة",description:"يرجى إدخال مبلغ أكبر من صفر",variant:"destructive"});return}dn(null),ac({debtId:X.id,delta:t,type:ur}),cn(!1),Lr(!0)}catch(t){console.error("فشل تجهيز تعديل مبلغ الدين:",t),i({title:"خطأ",description:"تعذّر تجهيز تعديل مبلغ الدين",variant:"destructive"})}},children:"تأكيد"})]})]})}),e.jsx(ve,{open:ph,onOpenChange:$r,children:e.jsxs(we,{className:"sm:max-w-[480px]",children:[e.jsxs(Ie,{children:[e.jsx(Ne,{className:"text-right",children:"اختيار مكان إضافة مبلغ السداد"}),e.jsx(hs,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 justify-center",children:[e.jsx(x,{variant:ta==="cash"?"default":"outline",className:ta==="cash"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>Ha("cash"),children:"الفلوس النقدية"}),e.jsx(x,{variant:ta==="wallet"?"default":"outline",className:ta==="wallet"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>Ha("wallet"),children:"أرصدة المحافظ"}),e.jsx(x,{variant:ta==="fawry"?"default":"outline",className:ta==="fawry"?"bg-amber-600 text-white":"",size:"sm",onClick:()=>Ha("fawry"),children:"فوري"}),e.jsx(x,{variant:ta==="none"?"default":"outline",className:ta==="none"?"bg-gray-600 text-white":"",size:"sm",onClick:()=>Ha("none"),children:"بدون إضافة"})]}),ta==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة للإضافة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:Qa,onChange:t=>Cl(t.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),Ue&&Ue.length>0?Ue.map(t=>e.jsx("option",{value:t.id,children:t.phone||t.name||t.id},t.id)):Object.keys(tt||{}).map(t=>{var a,r,l,o,h,m;return e.jsx("option",{value:t,children:((a=Ue.find(u=>u.id===t))==null?void 0:a.phone)||((l=(r=JSON.parse(localStorage.getItem(Bl())||"[]"))==null?void 0:r.find(u=>u.id===t))==null?void 0:l.phone)||((h=(o=JSON.parse(localStorage.getItem(Bl())||"[]"))==null?void 0:o.find(u=>u.id===t))==null?void 0:h.name)||((m=Ue.find(u=>u.id===t))==null?void 0:m.name)||t},t)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[xc," جنيه"]})]})]}),e.jsxs(et,{className:"flex flex-wrap justify-between gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{$r(!1),si(0),Ha(null),Cl("")},children:"إلغاء"}),e.jsx(x,{onClick:async()=>{var t,a;try{const r=xc;if(!r||r<=0){$r(!1);return}const l=async(o,h)=>{if(s!=null&&s.uid&&X)try{const u={transactionId:Oe(je(U,"dummy_collection")).id,amount:r,transactionType:"cash_addition",type:"cash_addition",status:"completed",createdAt:new Date,senderName:X.debtorName,receiverName:"المحل",description:`سداد دين من العميل ${X.debtorName}`,paymentMethod:o,walletId:h||null,linkedDebtId:X.id,isDebtRepayment:!0};await Ae.saveUserTransaction(s.uid,u);try{$.invalidateQueries({queryKey:["recentTransactions",s==null?void 0:s.uid]})}catch{}}catch(m){console.error("Failed to create repayment receipt:",m)}};if(ta==="cash"){const o=Ot+r;cs(o),localStorage.setItem(zt(),o.toString());const h={cashBalance:o,lastUpdated:new Date().toISOString()},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(h)),s!=null&&s.uid?(Ae.updateUserData(s.uid,h).catch(()=>st(!0)),localStorage.removeItem(m),st(!1)):st(!0),i({title:"تم إضافة مبلغ السداد",description:`تم إضافة ${r} جنيه إلى الفلوس النقدية`}),await l("cash");try{if(X){const u=ft.map(v=>v.id===X.id?{...v,status:"paid",paidAmount:Math.max(Number(v.paidAmount||0),Number(v.amount||0))}:v);Es(u);try{Ka(u.find(v=>v.id===X.id)||null)}catch{}try{await ma(u)}catch{}}}catch{}}else if(ta==="wallet"){if(!Qa){i({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const o={...tt,[Qa]:(tt[Qa]||0)+r};fs(o);const h=new Date().toISOString(),m={walletBalances:o,lastUpdated:h},u=`userData_${s==null?void 0:s.uid}`;if(localStorage.setItem(u,JSON.stringify(m)),localStorage.setItem(ds(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${h}`,JSON.stringify(o)),s!=null&&s.uid){Ae.updateUserData(s.uid,m).catch(()=>st(!0));try{localStorage.removeItem(u)}catch{}st(!1)}else st(!0);i({title:"تم إضافة مبلغ السداد",description:`تم إضافة ${r} جنيه إلى المحفظة ${((t=Ue.find(v=>v.id===Qa))==null?void 0:t.phone)||((a=Ue.find(v=>v.id===Qa))==null?void 0:a.name)||Qa}`}),await l("wallet",Qa);try{if(X){const v=ft.map(f=>f.id===X.id?{...f,status:"paid",paidAmount:Math.max(Number(f.paidAmount||0),Number(f.amount||0))}:f);Es(v);try{Ka(v.find(f=>f.id===X.id)||null)}catch{}try{await ma(v)}catch{}}}catch{}}else if(ta==="none"){i({title:"تم تسجيل السداد",description:`تم تسجيل ${r} جنيه بدون تعديل الأرصدة`});try{if(X){const o=ft.map(h=>h.id===X.id?{...h,status:"paid",paidAmount:Math.max(Number(h.paidAmount||0),Number(h.amount||0))}:h);Es(o);try{Ka(o.find(h=>h.id===X.id)||null)}catch{}try{await ma(o)}catch{}}}catch{}}else if(ta==="fawry")i({title:"تم تسجيل سداد عبر فوري",description:`تم تسجيل ${r} جنيه كسداد عبر فوري بدون تعديل الأرصدة`}),await l("fawry");else{i({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}try{const o=r>0?r:Number((X==null?void 0:X.amount)||0);s!=null&&s.uid&&X&&await Xa.send(s.uid,`تم سداد الدين بالكامل للعميل ${X.debtorName}: المدفوع ${o} جنيه`)}catch{}}catch(r){console.error("خطأ أثناء إضافة مبلغ السداد:",r),i({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{$r(!1),si(0),Ha(null),Cl("");try{xr(!0)}catch{}}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(ve,{open:Om,onOpenChange:mr,children:e.jsxs(we,{hideClose:!0,className:"post-confirm-card sm:max-w-[420px] w-[90vw] rounded-2xl bg-gradient-to-br from-white via-indigo-50 to-blue-50 shadow-2xl border border-indigo-100",children:[e.jsxs(Ie,{children:[e.jsx(Ne,{className:"text-right text-2xl font-bold",children:(Ss==null?void 0:Ss.type)==="transfer"?"مبلغ يجب استلامه":"مبلغ يجب تسليمه"}),e.jsx(hs,{className:"text-right text-gray-600",children:(Ss==null?void 0:Ss.type)==="transfer"?"هذا هو المبلغ الواجب استلامه من العميل بعد التأكيد.":"هذا هو المبلغ الواجب تسليمه للعميل بعد التأكيد."})]}),e.jsxs("div",{className:"py-3 flex flex-col items-center gap-1.5",children:[e.jsxs("div",{className:"text-xl sm:text-2xl font-bold text-blue-700 tracking-wide",children:[Zt((Ss==null?void 0:Ss.amount)||0)," جنيه"]}),e.jsx("div",{className:"text-sm text-gray-500 text-right w-full",children:(Ss==null?void 0:Ss.type)==="transfer"?"المبلغ المعروض شامل عمولة التحويل.":At?"العمولة مضافة ولا تؤثر على قيمة التسليم.":"العمولة مخصومة من المبلغ المسلّم للعميل."})]}),e.jsxs(et,{className:"flex justify-end gap-2",children:[(Ss==null?void 0:Ss.type)==="transfer"&&e.jsx(x,{variant:"outline",id:"sendCodeBtn",onClick:ht,disabled:Ro,className:"btn-transfer-confirm",children:Ro?"جارٍ الإرسال...":"إرسال كود التحويل"}),e.jsx(x,{onClick:()=>{mr(!1),sl(null)},className:"bg-green-600 hover:bg-green-700 text-white",children:(Ss==null?void 0:Ss.type)==="transfer"?"تم الاستلام":"تم التسليم"})]})]})}),e.jsx(dx,{open:Lm,onClose:()=>Er(!1),onSubmit:St,deviceId:Bo||xa||"",recipientMsisdn:String(ye==="transfer"?(Js==null?void 0:Js.receiver)||Fs||"":((Zc=Ue.find(t=>t.id===V))==null?void 0:Zc.phone)||"").replace(/\D/g,"")}),e.jsx(xp,{isOpen:bm,onClose:()=>Zi(!1),wallets:Ue,walletBalances:tt,onSelectWallet:t=>{is(t);const a=Ue.find(r=>r.id===t);if(a){Oa(a.phone);try{localStorage.setItem(gr(),t)}catch{}}Zi(!1)},selectedWalletId:V||void 0}),e.jsx(fp,{open:le,onOpenChange:_e}),e.jsx(Ru,{open:H,onOpenChange:te}),Uo]}))};export{bg as default};
//# sourceMappingURL=UserDashboardPage-K7g7RnIK.js.map
