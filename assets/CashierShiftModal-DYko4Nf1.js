import{aM as Ys,u as Gs,m as Qs,r as l,aT as K,aU as Xs,j as e,aa as f,ab as g,ac as y,ad as N,B as d,aR as b,y as u,I as x,ar as ps,W as js,t as We,a1 as Zs,$ as et,a8 as Ae,D as st,s as tt,E as at}from"./index-DhbnydJl.js";import{S as lt,a as rt,b as it,c as nt,d as me}from"./select-Bn8RCTk-.js";import{C as ct,V as dt}from"./VideoModal-w5Ot-7KI.js";import{getLastTransactions as ot}from"./functions-DxNA6i1h.js";const St=({open:M,onOpenChange:J})=>{var xs,hs,us;const{shiftUser:c,isShiftActive:Y,shiftStartAt:U,setShiftUser:L,startShift:Ie,endShift:Fe}=Ys(),{userSubscription:D,user:a,signIn:mt,profile:xt,checkSubscriptionStatus:xe}=Gs(),{toast:w}=Qs(),[P,Oe]=l.useState((c==null?void 0:c.name)||""),[V,Ee]=l.useState((c==null?void 0:c.username)||""),[$,Be]=l.useState(""),[he,G]=l.useState(!1),[k,Q]=l.useState(null),[Re,Me]=l.useState(""),[Ue,X]=l.useState(""),[ht,ut]=l.useState(!1),[C,ue]=l.useState(null),[Le,ve]=l.useState(""),[Pe,H]=l.useState(""),[Ve,I]=l.useState(!1),[Z,ee]=l.useState(!1),[$e,se]=l.useState({totalTransfers:0,totalWithdrawals:0}),[te,ae]=l.useState(null),[He,pe]=l.useState(""),[F,qe]=l.useState(""),[O,_e]=l.useState(0),[fs,vt]=l.useState({}),[E,gs]=l.useState(0),[q,ys]=l.useState(0),[Ns,pt]=l.useState({}),[je,ze]=l.useState(""),[bs,fe]=l.useState(!1),[Ke,Je]=l.useState([]),[ws,Ye]=l.useState(!1),[ge,Ss]=l.useState(""),[Cs,Ge]=l.useState(!1),[Ds,ks]=l.useState(""),[Ts,Ws]=l.useState(""),As=(s,t)=>{ks(s),Ws(t),Ge(!0)};l.useEffect(()=>{M&&xe&&xe(!0)},[M,xe]);const B=s=>{const t={"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9","۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9","٫":".","،":".","٬":"."," ":""};return s.split("").map(i=>t[i]??i).join("")},ye=()=>`cashierUsers_${(a==null?void 0:a.uid)||"default"}`,[S,R]=l.useState(()=>{try{let s=localStorage.getItem(ye());if(!s){const t=localStorage.getItem("cashierUsers");t&&(s=t)}return s?JSON.parse(s):[]}catch{return[]}}),[Qe,Is]=l.useState(!1);l.useEffect(()=>{if(!(a!=null&&a.uid))return;(async()=>{let t=!1;try{const i=js(We,"profiles",a.uid,"cashierUsers","list"),r=await Zs(i);if(r.exists()){const v=r.data(),j=Array.isArray(v==null?void 0:v.users)?v.users:[];j.length>0&&(R(j),t=!0)}}catch(i){console.warn("Failed to fetch cashierUsers from Firestore:",i)}if(!t)try{const i=localStorage.getItem(ye()),r=i?JSON.parse(i):[];r.length>0?R(r):S.length>0&&R([])}catch{}Is(!0)})()},[a==null?void 0:a.uid]);const le=(xs=D==null?void 0:D.subscription)==null?void 0:xs.planType,Xe=((hs=D==null?void 0:D.subscription)==null?void 0:hs.extraCashiers)||0,re=(us=D==null?void 0:D.subscription)==null?void 0:us.extraCashiersEndsAt;let Ze=!1;Xe>0&&re&&(re.seconds?new Date(re.seconds*1e3):new Date(re))>new Date&&(Ze=!0);const W=(le==="quarterly"||le==="half_yearly"||le==="yearly"||le==="lifetime"?2:1)+(Ze?Xe:0);l.useEffect(()=>{try{localStorage.setItem(ye(),JSON.stringify(S));try{localStorage.removeItem("cashierUsers")}catch{}}catch{}(async()=>{try{if(!(a!=null&&a.uid)||S.length===0&&!Qe)return;const t=js(We,"profiles",a.uid,"cashierUsers","list");await et(t,{users:S},{merge:!0})}catch(t){console.warn("Failed to save cashierUsers to Cloud:",t)}})()},[S,Qe,a==null?void 0:a.uid]);const[Fs,ie]=l.useState(!1),[es,Ne]=l.useState(""),[T,ss]=l.useState(null),[ts,be]=l.useState([]),[we,Se]=l.useState(!1),[h,Os]=l.useState(null),[Es,Ce]=l.useState(!1),[Bs,_]=l.useState(!1),[Rs,ne]=l.useState(!1),[Ms,ce]=l.useState(!1),[as,Us]=l.useState("1"),[ls,Ls]=l.useState(K.MONTHLY),Ps=async()=>{if(a!=null&&a.uid)try{await st(tt(We,"cashierRequests"),{userId:a.uid,userName:a.displayName||a.email,userEmail:a.email,requestedCount:parseInt(as),planType:ls,status:"pending",createdAt:at()}),w({title:"تم إرسال الطلب بنجاح",description:"سيتم مراجعة طلبك من قبل الإدارة"}),ce(!1)}catch(s){console.error(s),w({title:"خطأ",description:"حدث خطأ أثناء إرسال الطلب",variant:"destructive"})}},[De,ke]=l.useState(!1),[o,z]=l.useState(null),[Vs,de]=l.useState(!1),[rs,is]=l.useState(""),[ns,oe]=l.useState(""),$s=s=>{z(s),de(!0),is(""),oe("")},cs=async()=>{if(!(a!=null&&a.uid)){oe("خطأ في معرف المستخدم");return}try{if(!await ps.verifyMasterPin(rs,a.uid)){oe("الرقم السري الرئيسي غير صحيح");return}de(!1),ke(!0)}catch{oe("حدث خطأ أثناء التحقق")}};l.useEffect(()=>{if(!De||!(a!=null&&a.uid))return;let s=!1;try{const t=`wallets_for_permissions_${a.uid}`,i=localStorage.getItem(t);if(i){const r=JSON.parse(i);Array.isArray(r)&&Je(r)}}catch{}return(async()=>{try{Ye(!0);const t=await Xs.getByMerchantId(a.uid);if(s)return;const i=(t||[]).map(r=>({id:String(r.id),name:r.label||"محفظة بدون اسم",phone:r.msisdn||""}));Je(i);try{const r=`wallets_for_permissions_${a.uid}`;localStorage.setItem(r,JSON.stringify(i))}catch{}}catch(t){console.error("Failed to load wallets for permissions:",t)}finally{s||Ye(!1)}})(),()=>{s=!0}},[De,a==null?void 0:a.uid]);const Hs=s=>{if(!o)return;const t={...o,permissions:s};R(i=>i.map(r=>r.username===o.username?t:r)),(c==null?void 0:c.username)===o.username&&L({name:c.name,username:c.username,permissions:s,allowedWalletIds:t.allowedWalletIds}),ke(!1),z(null),w({title:"تم تحديث الصلاحيات بنجاح"})},qs=()=>{S.length>=W?ne(!0):_(!0)},_s=s=>{const t=(c==null?void 0:c.username)===s;let i=!1;try{i=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(t&&!(t&&!Y&&(je==="الأدمن الرئيسي"||i))){w({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const j=`هل أنت متأكد من حذف المستخدم ${s}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(j)&&(R(p=>p.filter(Te=>Te.username!==s)),t&&L(null),w({title:"تم حذف المستخدم",description:s}))},ds=()=>{if(!P.trim()||!V.trim()||!$.trim())return;if(S.length>=W){w({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(W)?W:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const s={name:P.trim(),username:V.trim(),password:$.trim()};R(t=>[s,...t]),Oe(""),Ee(""),Be("")},zs=()=>{G(!0),Q(null),ue(null),ve(""),H("")},os=async()=>{try{let s=[];try{a!=null&&a.uid&&(s=await Ae.getUserTransactions(a.uid))}catch{}if(!s||s.length===0)try{const n=await ot({merchantUserId:a==null?void 0:a.uid,limit:200});s=(n==null?void 0:n.transactions)||[]}catch{}const t=U?new Date(U):null,i=new Date,r=n=>{const m=n.type,A=n.txnType;return m==="withdraw"||m==="withdrawal"||m==="receive"||A==="receive"},v=n=>{const m=n.type,A=n.txnType;return m==="send"||m==="transfer"||A==="send"},j=n=>{if(!n)return null;if(n instanceof Date)return n;try{const m=new Date(n);return Number.isNaN(m.getTime())?null:m}catch{return null}},p=n=>{const m=j(n.createdAt||n.created_at||n.timestamp);return!m||t&&m<t?!1:m<=i},Te=n=>n==="completed"||n==="confirmed",vs=s.filter(n=>Te(n.status)&&p(n)),Js=vs.filter(n=>r(n)).reduce((n,m)=>{const A=m.withdrawnAmount??m.receivedAmount??m.amount??0;return n+(Number(A)||0)},0);return{totalTransfers:vs.filter(n=>v(n)).reduce((n,m)=>{const A=m.sentAmount??m.transferredAmount??m.amount??0;return n+(Number(A)||0)},0),totalWithdrawals:Js}}catch{return{totalTransfers:0,totalWithdrawals:0}}};l.useEffect(()=>{if(Z){try{const s=localStorage.getItem("shiftInitialReceivedDrawerFunds");s!==null&&qe(s)}catch{}try{const s=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(s!==null){const t=parseFloat(s);_e(Number.isFinite(t)?t:0)}}catch{}}},[Z]),l.useEffect(()=>{he&&(async()=>{try{const s=await os();se(s)}catch{}})()},[he]),l.useEffect(()=>{if(!M&&!we)return;(async()=>{try{const i=((a!=null&&a.uid?await Ae.getUserTransactions(a.uid):[])||[]).filter(r=>(r==null?void 0:r.type)==="report"||((r==null?void 0:r.title)||"").includes("إيصال تسليم وردية"));i.sort((r,v)=>{const j=new Date(r.createdAt||0).getTime();return new Date(v.createdAt||0).getTime()-j}),be(i)}catch{be([])}})()},[M,Z,we,a==null?void 0:a.uid]);const Ks=async(s,t,i)=>{try{let r=0,v=0;try{const p=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");r=Number.isFinite(p)?p:0}catch{}try{const p=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");v=Number.isFinite(p)?p:0}catch{}const j={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(c==null?void 0:c.username)||"cashier",receiverPhone:je||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(c==null?void 0:c.name)||(c==null?void 0:c.username)||null,deficit:t,deficitAmount:t?i:0,shiftStartAt:U,receivedDrawerFunds:r,receivedWalletBalancesTotal:v,receivedWalletBalances:fs,deliveredDrawerFunds:E||0,deliveredWalletBalancesTotal:q||0,deliveredWalletBalances:Ns,shiftProfit:Math.round(((E||0)+(q||0)-(r+v))*100)/100};a!=null&&a.uid&&await Ae.saveUserTransaction(a.uid,j),be(p=>[j,...p||[]])}catch{}},ms=S.slice(Math.max(0,S.length-W));return e.jsxs(e.Fragment,{children:[e.jsx(f,{open:M,onOpenChange:J,children:e.jsxs(g,{className:"sm:max-w-md",children:[e.jsx(y,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(N,{children:Y?"تسليم الورديه والخروج":"إضافة مستخدم وردية"}),e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>As("https://www.youtube.com/watch?v=1SwXIN-xBeo","شرح الوردية (فيديو)"),className:"h-7 text-[10px] px-2 text-rose-600 border-rose-200 hover:bg-rose-50 dark:border-rose-900/30 dark:text-rose-400 dark:hover:bg-rose-900/20",children:[e.jsx(ct,{className:"h-3 w-3 ml-1.5"}),"شرح الوردية (فيديو)"]})]})}),Y?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[c==null?void 0:c.name," (",c==null?void 0:c.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),S.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:ms.map((s,t)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:s.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(d,{size:"sm",className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>{ss(s),ie(!0)},children:"دخول"}),e.jsx(d,{size:"sm",className:"w-full sm:w-auto",variant:"outline",onClick:()=>$s(s),children:"الصلاحيات"}),e.jsx(d,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>_s(s.username),children:"حذف"})]})]},t))})]})]}),e.jsx(b,{className:"flex flex-wrap gap-2 justify-between",children:Y?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(d,{className:"w-full sm:w-auto",variant:"destructive",onClick:zs,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(d,{className:"w-full sm:w-auto bg-emerald-600 hover:bg-emerald-700 text-white",onClick:qs,children:"إضافة مستخدم جديد"}),e.jsx(d,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>Se(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(f,{open:Rs,onOpenChange:ne,children:e.jsxs(g,{className:"sm:max-w-md",children:[e.jsx(y,{children:e.jsxs(N,{className:"text-red-600 flex items-center gap-2",children:[e.jsx("span",{className:"text-xl",children:"⚠️"})," تنبيه: الحد الأقصى للمستخدمين"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("p",{className:"text-sm text-gray-700 leading-relaxed",children:["عفواً، لا يمكنك إضافة المزيد من مستخدمي الوردية. ",e.jsx("br",{}),"الحد المسموح به لباقة اشتراكك هو ",e.jsx("strong",{children:W})," ",W===1?"مستخدم":"مستخدمين","."]}),e.jsx("p",{className:"text-sm text-gray-600",children:"لزيادة عدد المستخدمين، يرجى التواصل مع خدمة العملاء لترقية الباقة أو طلب زيادة العدد."})]}),e.jsxs(b,{className:"flex flex-col sm:flex-row gap-2 justify-end",children:[e.jsx(d,{className:"w-full sm:w-auto",onClick:()=>ne(!1),variant:"secondary",children:"حسناً، فهمت"}),e.jsx(d,{className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>{ne(!1),ce(!0)},children:"طلب إضافة كاشير"})]})]})}),e.jsx(f,{open:Ms,onOpenChange:ce,children:e.jsxs(g,{className:"sm:max-w-md",children:[e.jsx(y,{children:e.jsx(N,{children:"طلب زيادة عدد الكاشير"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"يمكنك طلب زيادة عدد الكاشير المسموح به. سيتم مراجعة الطلب من قبل الإدارة."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"عدد الكاشير المطلوب إضافتهم"}),e.jsx(x,{type:"number",min:"1",max:"10",value:as,onChange:s=>Us(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"نظام الاشتراك للكاشير الإضافي"}),e.jsxs(lt,{value:ls,onValueChange:s=>Ls(s),children:[e.jsx(rt,{children:e.jsx(it,{placeholder:"اختر الباقة"})}),e.jsxs(nt,{children:[e.jsx(me,{value:K.MONTHLY,children:"شهري"}),e.jsx(me,{value:K.QUARTERLY,children:"ربع سنوي"}),e.jsx(me,{value:K.YEARLY,children:"سنوي"}),e.jsx(me,{value:K.LIFETIME,children:"مدى الحياة"})]})]})]})]}),e.jsxs(b,{children:[e.jsx(d,{variant:"secondary",onClick:()=>ce(!1),children:"إلغاء"}),e.jsx(d,{className:"bg-blue-600 hover:bg-blue-700 text-white",onClick:Ps,children:"إرسال الطلب"})]})]})}),e.jsx(f,{open:Bs,onOpenChange:_,children:e.jsxs(g,{className:"sm:max-w-md",children:[e.jsx(y,{children:e.jsx(N,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(u,{className:"mb-1 block",children:"الاسم"}),e.jsx(x,{value:P,onChange:s=>Oe(s.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(u,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(x,{value:V,onChange:s=>Ee(s.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(u,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(x,{type:"password",autoComplete:"new-password",value:$,onChange:s=>Be(s.target.value),onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),P.trim()&&V.trim()&&$.trim()&&(ds(),_(!1)))},placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(b,{className:"flex gap-2 justify-between",children:[e.jsx(d,{variant:"secondary",onClick:()=>{_(!1)},children:"إلغاء"}),e.jsx(d,{onClick:()=>{!P.trim()||!V.trim()||!$.trim()||(ds(),_(!1))},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"حفظ المستخدم"})]})]})}),e.jsx(f,{open:Vs,onOpenChange:de,children:e.jsxs(g,{className:"sm:max-w-md",children:[e.jsx(y,{children:e.jsx(N,{children:"تأكيد هوية المدير"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"يرجى إدخال الرقم السري الرئيسي (كلمة مرور حسابك) لفتح إعدادات الصلاحيات."}),e.jsxs("div",{children:[e.jsx(u,{className:"mb-1 block",children:"كلمة المرور"}),e.jsx(x,{type:"password",value:rs,onChange:s=>is(s.target.value),onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),cs())},placeholder:"أدخل كلمة المرور"}),ns&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:ns})]})]}),e.jsxs(b,{children:[e.jsx(d,{variant:"outline",onClick:()=>de(!1),children:"إلغاء"}),e.jsx(d,{onClick:cs,className:"bg-blue-600 hover:bg-blue-700 text-white",children:"تأكيد"})]})]})}),e.jsx(f,{open:De,onOpenChange:ke,children:e.jsxs(g,{className:"sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(y,{children:e.jsxs(N,{children:["صلاحيات المستخدم: ",o==null?void 0:o.name]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 py-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-700",children:"الوحدات المسموح بها"}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[{key:"sales",label:"المبيعات"},{key:"debts",label:"الديون"},{key:"deficiencies",label:"النواقص"},{key:"cards",label:"البطاقات"},{key:"lines",label:"الخطوط"},{key:"myNumbers",label:"أرقامي"},{key:"installments",label:"تقسيط"},{key:"maintenance",label:"صيانة"},{key:"machines",label:"المكنة"},{key:"expenses",label:"المصروفات"},{key:"settings",label:"الإعدادات"},{key:"branches",label:"الفروع"},{key:"transfers",label:"التحويل"},{key:"withdrawals",label:"السحب"}].map(s=>{var i;const t=((i=o==null?void 0:o.permissions)==null?void 0:i[s.key])!==!1;return e.jsxs("div",{className:"flex items-center justify-between border p-3 rounded bg-gray-50 dark:bg-gray-800",children:[e.jsx(u,{htmlFor:`perm-${s.key}`,className:"cursor-pointer font-medium",children:s.label}),e.jsx(d,{id:`perm-${s.key}`,size:"sm",onClick:()=>{o&&z({...o,permissions:{...o.permissions,[s.key]:!t}})},className:`w-24 font-bold text-white transition-colors ${t?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:t?"مفعل":"معطل"})]},s.key)})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-700",children:"المحافظ المسموح بها في الورديه"}),e.jsx(d,{size:"sm",variant:"outline",onClick:()=>{o&&z({...o,allowedWalletIds:[]})},children:"مسح الاختيار"})]}),e.jsx("div",{className:"text-xs text-gray-500 mb-2",children:"يمكن للمستخدم العمل فقط على المحافظ المحددة هنا، وهي التي ستظهر له عند فتح الورديه."}),e.jsx("div",{className:"mb-2",children:e.jsx(x,{placeholder:"ابحث بالاسم أو رقم المحفظة...",value:ge,onChange:s=>Ss(s.target.value),className:"h-8 text-xs"})}),e.jsx("div",{className:"border rounded-md bg-gray-50 dark:bg-gray-900/40 p-3 max-h-56 overflow-y-auto space-y-2",children:ws?e.jsx("div",{className:"text-xs text-gray-500",children:"جاري تحميل المحافظ..."}):Ke.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"لا توجد محافظ مسجلة حالياً."}):Ke.filter(s=>{if(!ge.trim())return!0;const t=B(ge).toLowerCase(),i=(s.name||"").toLowerCase(),r=B(s.phone||"");return i.includes(t)||r.includes(t)}).map(s=>{const i=((o==null?void 0:o.allowedWalletIds)||[]).includes(s.id);return e.jsxs("button",{type:"button",onClick:()=>{if(!o)return;const r=o.allowedWalletIds||[],j=r.includes(s.id)?r.filter(p=>p!==s.id):[...r,s.id];z({...o,allowedWalletIds:j})},className:`w-full flex items-center justify-between px-2 py-1.5 rounded border text-xs ${i?"bg-green-50 border-green-400 text-green-800":"bg-white border-gray-200 text-gray-700"}`,children:[e.jsxs("div",{className:"flex flex-col items-start",children:[e.jsx("span",{className:"font-medium",children:s.name}),e.jsx("span",{className:"text-[10px] text-gray-500",children:s.phone})]}),e.jsx("span",{className:"ml-2 text-[11px] font-bold",children:i?"مسموح":"محجوبة"})]},s.id)})})]})]}),e.jsx(b,{children:e.jsx(d,{onClick:()=>Hs(o==null?void 0:o.permissions),className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",children:"حفظ الصلاحيات"})})]})}),e.jsx(f,{open:we,onOpenChange:Se,children:e.jsxs(g,{className:"sm:max-w-lg",children:[e.jsx(y,{children:e.jsx(N,{children:"إيصالات التسليم"})}),ts.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:ts.map(s=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{Os(s),Ce(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(s.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",s.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",s.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",s.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",s.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",s.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",s.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",s.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",s.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",s.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(s.shiftProfit??(s.deliveredDrawerFunds??0)+(s.deliveredWalletBalancesTotal??0)-(s.receivedDrawerFunds??0)-(s.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",s.shiftProfit??(s.deliveredDrawerFunds??0)+(s.deliveredWalletBalancesTotal??0)-(s.receivedDrawerFunds??0)-(s.receivedWalletBalancesTotal??0)]})]}),s.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",s.deficitAmount??0]})]},s.id))}),e.jsx(b,{className:"flex gap-2 justify-between",children:e.jsx(d,{variant:"secondary",onClick:()=>Se(!1),children:"إغلاق"})})]})}),e.jsx(f,{open:Es,onOpenChange:Ce,children:e.jsxs(g,{className:"sm:max-w-md",children:[e.jsx(y,{children:e.jsx(N,{children:"إيصال تسليم وردية"})}),h?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(h.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",h.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",(h.receivedDrawerFunds??0).toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",(h.receivedWalletBalancesTotal??0).toLocaleString("en-US",{maximumFractionDigits:0})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",(h.deliveredDrawerFunds??0).toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",(h.deliveredWalletBalancesTotal??0).toLocaleString("en-US",{maximumFractionDigits:0})]})]})]}),h.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",(h.deficitAmount??0).toLocaleString("en-US",{maximumFractionDigits:0})]})]}),h.receivedWalletBalances&&Object.keys(h.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(h.receivedWalletBalances).map(([s,t])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:s}),e.jsx("span",{className:"font-semibold",children:t.toLocaleString("en-US",{maximumFractionDigits:0})})]},s))})]}),h.deliveredWalletBalances&&Object.keys(h.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(h.deliveredWalletBalances).map(([s,t])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:s}),e.jsx("span",{className:"font-semibold",children:t})]},s))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(b,{className:"flex gap-2 justify-between",children:e.jsx(d,{variant:"secondary",onClick:()=>Ce(!1),children:"إغلاق"})})]})}),e.jsx(f,{open:Fs,onOpenChange:ie,children:e.jsxs(g,{className:"sm:max-w-md",children:[e.jsx(y,{children:e.jsx(N,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:T?`${T.name} (${T.username})`:""}),e.jsx(x,{type:"password",autoComplete:"off",value:es,onChange:s=>Ne(s.target.value),onKeyDown:s=>{var t;s.key==="Enter"&&(s.preventDefault(),(t=document.getElementById("login-confirm-btn"))==null||t.click())},placeholder:"أدخل الرقم السري"})]}),e.jsxs(b,{className:"flex gap-2 justify-between",children:[e.jsx(d,{variant:"secondary",onClick:()=>{Ne(""),ss(null),ie(!1)},children:"إلغاء"}),e.jsx(d,{id:"login-confirm-btn",className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{if(T){if(es.trim()!==T.password){w({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}L({name:T.name,username:T.username,permissions:T.permissions,allowedWalletIds:T.allowedWalletIds}),Ne(""),ie(!1),J(!1),Ie(),fe(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(f,{open:bs,onOpenChange:fe,children:e.jsxs(g,{className:"sm:max-w-md",children:[e.jsx(y,{children:e.jsx(N,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(u,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(x,{type:"text",inputMode:"decimal",value:F,onChange:s=>qe(B(s.target.value)),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(u,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(x,{type:"text",inputMode:"decimal",value:Number.isFinite(O)?O:0,onChange:s=>{const t=parseFloat(B(s.target.value));_e(Number.isFinite(t)?t:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(b,{className:"flex gap-2 justify-between",children:e.jsx(d,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{const s=parseFloat(F),t=O,i=Number.isFinite(s)&&s>=0,r=Number.isFinite(t)&&t>=0;if(!i||!r){w({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(s)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(t))}catch{}w({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),fe(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(f,{open:he,onOpenChange:s=>{s&&G(!0)},children:e.jsxs(g,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(y,{children:e.jsx(N,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{variant:k==="toUser"?"default":"secondary",onClick:()=>Q("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(d,{variant:k==="toAdmin"?"default":"secondary",onClick:()=>Q("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),k==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[S.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:ms.map((s,t)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(C==null?void 0:C.username)===s.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>ue(s),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:s.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},t))})]}),e.jsxs("div",{children:[e.jsx(u,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(x,{type:"password",autoComplete:"off",value:Le,onChange:s=>ve(s.target.value),placeholder:"أدخل كلمة السر"})]}),Pe&&e.jsx("div",{className:"text-xs text-red-600",children:Pe})]}),k==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(x,{type:"password",autoComplete:"off",value:Re,onChange:s=>Me(s.target.value),placeholder:"كلمة المرور"}),Ue&&e.jsx("div",{className:"text-xs text-red-600",children:Ue})]})]}),e.jsx(b,{className:"flex gap-2 justify-between",children:e.jsx(d,{id:"handover-confirm-btn",disabled:Ve||!k,onClick:async()=>{if(k){I(!0);try{const s=$e;if(os().then(se).catch(()=>{}),k==="toUser"){if(!C){H("يرجى اختيار المستخدم أولاً"),I(!1);return}if(Le.trim()!==C.password){H("كلمة السر غير صحيحة"),I(!1);return}Fe(),L({name:C.name,username:C.username,permissions:C.permissions}),Ie(),ze(`${C.name} (${C.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}G(!1),Q(null),ue(null),ve(""),H(""),J(!1),se(s),ae(null),pe(""),ee(!0)}else if(k==="toAdmin"){if(X(""),!(a!=null&&a.uid)){X("خطأ في معرف المستخدم"),I(!1);return}if(!await ps.verifyMasterPin(Re,a.uid)){X("الرقم السري الرئيسي غير صحيح"),I(!1);return}Fe(),L(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}Me(""),G(!1),J(!1),ze("الأدمن الرئيسي"),se(s),ae(null),pe(""),ee(!0)}}catch(s){console.error(s);const t="حدث خطأ أثناء التسليم، حاول مرة أخرى";k==="toAdmin"?X(t):H(t),w({title:"خطأ",description:t,variant:"destructive"})}finally{I(!1)}}},className:"bg-blue-600 hover:bg-blue-700 text-white",children:Ve?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري المعالجة..."]}):"تأكيد التسليم"})})]})}),e.jsx(f,{open:Z,onOpenChange:ee,children:e.jsxs(g,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(y,{children:e.jsx(N,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:je})]}),U&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(U).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(u,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(x,{type:"number",value:F,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(u,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(x,{type:"number",value:O,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(u,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(x,{type:"text",inputMode:"decimal",value:E,onChange:s=>{const t=parseFloat(B(s.target.value));gs(Number.isFinite(t)?t:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(u,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(x,{type:"text",inputMode:"decimal",value:q,onChange:s=>{const t=parseFloat(B(s.target.value));ys(Number.isFinite(t)?t:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(E??0)+(q??0)-((parseFloat(F||"0")||0)+(O??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((E??0)+(q??0)-((parseFloat(F||"0")||0)+(O??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"}),e.jsx("div",{className:"mt-2 grid grid-cols-1 gap-2",children:e.jsxs("div",{className:"rounded border p-2 bg-gray-50",children:[e.jsx("div",{className:"text-xs text-gray-700",children:"مطلوب من الدرج (بدون أرباح)"}),e.jsx("div",{className:"text-sm font-semibold text-gray-900",children:Math.round(((E??0)-(parseFloat(F||"0")||0))*100)/100})]})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{variant:te==="no"?"default":"secondary",onClick:()=>ae("no"),children:"لا"}),e.jsx(d,{variant:te==="yes"?"default":"secondary",onClick:()=>ae("yes"),children:"نعم"})]}),te==="yes"&&e.jsxs("div",{children:[e.jsx(u,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(x,{type:"number",value:He,onChange:s=>pe(s.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(b,{className:"flex gap-2 justify-between",children:e.jsx(d,{onClick:()=>{const s=te==="yes",t=parseFloat(He)||0;(async()=>await Ks($e,s,t))(),w({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),ee(!1)},className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:"تأكيد وحفظ الإيصال"})})]})}),e.jsx(dt,{isOpen:Cs,onClose:()=>Ge(!1),videoUrl:Ds,title:Ts})]})};export{St as default};
//# sourceMappingURL=CashierShiftModal-DYko4Nf1.js.map
