import{R as o,m as Fe,a9 as _e,u as Ue,j as e,aa as Q,ab as V,ac as X,ad as Y,B as N,aG as me,y as he,I as ge,a8 as O,q,s as E,t as y,aH as A,x as F,a1 as ue,W as L,an as xe}from"./index-DhbnydJl.js";import{D as fe}from"./dollar-sign-AUKMnGdi.js";import{P as $e}from"./UserDashboardPage-XbIVMTiD.js";import{a as Ie}from"./SimCardsAccessDialog-Z5OgVyJn.js";import{B as Pe}from"./battery-charging-BKlgE6-N.js";import"./VideoModal-w5Ot-7KI.js";import"./ProfileSettingsPage-DnVs4YJB.js";import"./switch-klIFyYmY.js";import"./square-pen-CSLFtBCt.js";import"./select-Bn8RCTk-.js";import"./users-D9PlfCO2.js";import"./circle-check-big-Dtvck6_a.js";import"./save-DZuHrrpv.js";import"./crown-D1WD830B.js";import"./arrow-left-DTf_k4UZ.js";import"./tabs-VyDQ-WsJ.js";import"./index-xL9tDy8r.js";import"./dropdown-menu-DhUxXtWv.js";import"./ProfileIcon-IxzO755X.js";import"./freeTrialService-u-lJSTVe.js";import"./broadcastService-BQWgcmoe.js";import"./bell-C-d1sJAh.js";import"./profitService-QTJQLMA0.js";import"./calendar-4dCWv1Gk.js";import"./arrow-down-left-DcYD3MrR.js";import"./wallet--cZcBirk.js";import"./printer-DeiqlOce.js";import"./star-BSPZIAqJ.js";const ft=({open:b,onOpenChange:be,userId:s,cashBalance:_,walletBalances:qe,transactions:pe})=>{const[ye,z]=o.useState(0),[ve,C]=o.useState(0),[ke,Z]=o.useState(0),[we,ee]=o.useState(0),[Ne,te]=o.useState(0),[Se,ae]=o.useState(0),[G,S]=o.useState(_||0),[re,De]=o.useState(0),[je,R]=o.useState(!1),[se,U]=o.useState(null),{toast:D}=Fe(),{shopId:g}=_e()||{},{user:j,profile:i}=Ue(),[Te,$]=o.useState(!1),[H,K]=o.useState(""),[Ae,W]=o.useState(!1),[Ce,I]=o.useState(!1),[ne,J]=o.useState(""),M=()=>`cashBalance_${s||"default"}_${g||(i==null?void 0:i.shopId)||"main"}`,P=r=>`${new Intl.NumberFormat("ar-EG",{maximumFractionDigits:0}).format(Number(r||0))} جنيه`;o.useEffect(()=>{if(!b||!s){b||(z(0),C(0));return}let r=!1;return(async()=>{try{const c=await O.getUserData(s),l=c==null?void 0:c.lastReceipt_accessory,h=l?new Date(l):new Date(0),m=h.getTime(),v=h.toISOString().slice(0,10),u=[];try{const t=q(E(y,"dailySales"),A("userId","==",s),...g?[A("shopId","==",g)]:[],A("date",">=",v));(await F(t)).forEach(d=>{u.push({id:d.id,data:d.data()})})}catch(t){console.warn("Failed to load top-level dailySales for accessory:",t)}try{(await F(E(y,"users",s,"dailySales"))).forEach(n=>{const d=n.data();g&&d.shopId&&d.shopId!==g||u.push({id:n.id,data:d})})}catch(t){console.warn("Failed to load nested dailySales for accessory:",t)}const x=new Map;u.forEach(t=>{const n=String(t.data.clientId||t.id);x.has(n)||x.set(n,t.data)});let f=0;x.forEach(t=>{var k;if(t.isDeferred)return;let n=0;if((k=t.createdAt)!=null&&k.toDate)n=t.createdAt.toDate().getTime();else if(t.createdAt instanceof Date)n=t.createdAt.getTime();else if(typeof t.createdAt=="number")n=t.createdAt;else if(typeof t.createdAt=="string")n=new Date(t.createdAt).getTime();else if(t.date){const w=t.time||"00:00";n=new Date(`${t.date}T${w}:00`).getTime()}if(!n||n<=m)return;const d=Number(t.sellingPrice??t.price??0),p=Number(t.quantity??t.qty??0);d>0&&p>0&&(f+=d*p)}),r||(z(f),C(0))}catch(c){console.warn("Failed to load accessory sales for cash summary:",c),r||(z(0),C(0))}})(),()=>{r=!0}},[b,s,g,re]),o.useEffect(()=>{if(!b)return;(async()=>{let a={};try{s&&(a=await O.getUserData(s)||{})}catch{}const c=async()=>{try{if(!s){Z(0);return}const m=a==null?void 0:a.lastReceipt_maintenance,v=m?new Date(m).getTime():0;let u;try{const f=q(E(y,"maintenance_items"),A("userId","==",s));u=await F(f)}catch{u=await F(q(E(y,"maintenance_items"),A("userId","==",s)))}let x=0;u.forEach(f=>{var le,de;const t=f.data(),n=t.status||"in_progress";let d=0;(le=t.createdAt)!=null&&le.toDate?d=t.createdAt.toDate().getTime():typeof t.createdAt=="string"&&(d=new Date(t.createdAt).getTime());let p=0;(de=t.completedAt)!=null&&de.toDate?p=t.completedAt.toDate().getTime():typeof t.completedAt=="string"&&(p=new Date(t.completedAt).getTime());const k=n==="completed"&&p||d;if(!k||k<=v)return;let w=0;const B=Number(t.repairPrice||0),T=t.partialPayment!==void 0?Number(t.partialPayment):NaN;n==="completed"?Number.isFinite(B)&&B>0&&(w=B):Number.isFinite(T)&&T>0&&(w=T),w>0&&(x+=w)}),Z(Math.max(0,x)),ee(0)}catch(m){console.warn("فشل تحميل إجمالي فلوس الصيانة لليوم:",m)}},l=async()=>{try{if(!s){te(0);return}const m=a==null?void 0:a.lastReceipt_machineCharging,v=m?new Date(m).getTime():0,u=q(E(y,"userTransactions"),A("userId","==",s)),x=await F(u);let f=0;x.forEach(t=>{var T;const n=t.data();let d=0;if((T=n.createdAt)!=null&&T.toDate?d=n.createdAt.toDate().getTime():typeof n.createdAt=="string"&&(d=new Date(n.createdAt).getTime()),d<=v)return;const p=String(n.description||""),k=String(n.title||""),w=n.title==="إيصال تحويل مكينه"||p.includes("تحويل مكنه")||p.includes("تحويل مكينه")||k.includes("تحويل مكنه")||k.includes("تحويل مكينه"),B=n.status==="completed"||n.status==="confirmed";w&&B&&(f+=Number(n.amount)||0)}),te(f),ae(0)}catch(m){console.warn(m)}},h=async()=>{var m;try{if(!s){C(0);return}try{const v=g||(i==null?void 0:i.shopId)||"main",u=await ue(L(y,"dashboardData",v));if(u.exists()){const x=Number(((m=u.data())==null?void 0:m.cashBalance)||0);S(x);try{localStorage.setItem(`cashBalance_${s}`,String(x)),localStorage.setItem(M(),String(x))}catch{}}else S(Number((a==null?void 0:a.cashBalance)||_||0))}catch{S(Number((a==null?void 0:a.cashBalance)||_||0))}}catch{C(0),ee(0),ae(0)}};await c(),await l(),await h()})()},[b,s,pe,_,g,re]),o.useEffect(()=>{const r=a=>{var c;try{const l=Number((c=a==null?void 0:a.detail)==null?void 0:c.value);Number.isFinite(l)&&S(l)}catch{}};return window.addEventListener("cashBalanceChanged",r),()=>window.removeEventListener("cashBalanceChanged",r)},[b]),o.useEffect(()=>{if(!b||!s)return;const r=g||(i==null?void 0:i.shopId)||"main";return(async()=>{var c;try{const l=await ue(L(y,"dashboardData",r));if(l.exists()){const h=Number(((c=l.data())==null?void 0:c.cashBalance)||0);S(h);try{localStorage.setItem(`cashBalance_${s}`,String(h)),localStorage.setItem(M(),String(h))}catch{}}}catch(l){console.warn("Error fetching dashboard data:",l)}})(),()=>{}},[b,s,g]);const ce=Math.max(0,Number(ye)-Number(ve)),ie=Math.max(0,Number(ke)-Number(we)),oe=Math.max(0,Number(Ne)-Number(Se)),Re=async r=>{if(s){new Date().toISOString().slice(0,10);try{let a=0;if(r==="accessory"?a=ce:r==="maintenance"?a=ie:r==="machineCharging"&&(a=oe),a<=0){D({title:"لا يوجد مبلغ لتأكيد استلامه",variant:"default"});return}const c=Math.max(0,Number(G)-a);S(c);const l=new Date().toISOString();await O.updateUserData(s,{cashBalance:c,[`lastReceipt_${r}`]:l});try{const m=g||(i==null?void 0:i.shopId)||"main";await xe(L(y,"dashboardData",m),{cashBalance:c,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${s}`,String(c)),localStorage.setItem(M(),String(c))}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:c}}))}catch{}De(Date.now());let h="";r==="accessory"?h="الإكسسوار":r==="maintenance"?h="الصيانة":h="مكن الشحن",D({title:"تم الاستلام",description:`تم خصم ${a.toLocaleString("en-US",{maximumFractionDigits:0})} من الدرج وتصفير بند ${h}`})}catch{D({title:"خطأ",description:"تعذر تنفيذ عملية تم الاستلام",variant:"destructive"})}}},Me=()=>{K(""),J(""),$(!0)},Be=()=>{if(!H.trim()){D({title:"سبب الخصم مطلوب",variant:"destructive"});return}$(!1),W(!0)},Oe=()=>{W(!1),I(!0)},Ee=async()=>{try{if(!s)return;const r=Math.max(0,Number(ne||0));if(!Number.isFinite(r)||r<=0){D({title:"مبلغ غير صالح",description:"أدخل مبلغ خصم صحيح أكبر من الصفر",variant:"destructive"});return}const a=Math.max(0,Number(G)-r);S(a),await O.updateUserData(s,{cashBalance:a});try{const l=g||(i==null?void 0:i.shopId)||"main";await xe(L(y,"dashboardData",l),{cashBalance:a,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${s}`,String(a))}catch{}try{const l=new Date().toISOString();localStorage.setItem(M(),String(a)),localStorage.setItem(M()+"_lastUpdated",l)}catch{}const c={title:"ايصال خصم من الفلوس النقديه",type:"cash_deduction",amount:r,status:"completed",createdAt:new Date,note:H,cashierName:"الحساب الرئيسي"};try{await O.saveUserTransaction(s,c)}catch{}D({title:"تم الخصم",description:`تم خصم ${r.toLocaleString("en-US",{maximumFractionDigits:0})} من الدرج`}),I(!1),J(""),K("")}catch{D({title:"فشل الخصم",description:"تعذر تنفيذ عملية الخصم",variant:"destructive"})}};return e.jsx(Q,{open:b,onOpenChange:be,children:e.jsxs(V,{className:"sm:max-w-lg animate-in fade-in-90 zoom-in-95 slide-in-from-top-4 bg-white dark:bg-gray-900 border-gray-200 dark:border-gray-800",dir:"rtl",children:[e.jsx(X,{children:e.jsxs(Y,{className:"flex items-center gap-2 text-right text-gray-900 dark:text-gray-100",children:[e.jsx(fe,{className:"h-5 w-5 text-emerald-600 dark:text-emerald-500"}),"تفاصيل الفلوس النقدية"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-900/50 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 dark:text-amber-300 font-bold text-sm",children:[e.jsx(fe,{className:"h-4 w-4"}),"مجموع الفلوس النقدية (الدرج)"]}),e.jsx("div",{className:"text-amber-700 dark:text-amber-400 font-extrabold text-sm",children:P(G)})]}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-900/50 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 dark:text-blue-300 font-bold text-sm",children:[e.jsx($e,{className:"h-4 w-4"}),"فلوس الاكسسوار"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-blue-700 dark:text-blue-400 font-extrabold text-sm",children:P(ce)}),e.jsx(N,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 dark:from-blue-900/50 dark:to-blue-800/50 dark:text-blue-200 dark:hover:from-blue-800 dark:hover:to-blue-700",onClick:()=>{U("accessory"),R(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-emerald-50 dark:bg-emerald-950/30 border border-emerald-200 dark:border-emerald-900/50 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-800 dark:text-emerald-300 font-bold text-sm",children:[e.jsx(Ie,{className:"h-4 w-4"}),"فلوس الصيانة"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-emerald-700 dark:text-emerald-400 font-extrabold text-sm",children:P(ie)}),e.jsx(N,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800 dark:from-emerald-900/50 dark:to-emerald-800/50 dark:text-emerald-200 dark:hover:from-emerald-800 dark:hover:to-emerald-700",onClick:()=>{U("maintenance"),R(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-violet-50 dark:bg-violet-950/30 border border-violet-200 dark:border-violet-900/50 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-violet-800 dark:text-violet-300 font-bold text-sm",children:[e.jsx(Pe,{className:"h-4 w-4"}),"مكن الشحن"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-violet-700 dark:text-violet-400 font-extrabold text-sm",children:P(oe)}),e.jsx(N,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-violet-100 to-violet-200 text-violet-700 hover:from-violet-200 hover:to-violet-300 hover:text-violet-800 dark:from-violet-900/50 dark:to-violet-800/50 dark:text-violet-200 dark:hover:from-violet-800 dark:hover:to-violet-700",onClick:()=>{U("machineCharging"),R(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-900/50 rounded-lg p-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-red-800 dark:text-red-300 font-bold text-sm",children:"خصم فلوس من الفلوس النقديه"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(N,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 dark:from-red-900/50 dark:to-red-800/50 dark:text-red-200 dark:hover:from-red-800 dark:hover:to-red-700",onClick:Me,children:"خصم"})})]})]}),e.jsx(me,{open:je,onOpenChange:R,mode:"verify",title:"تأكيد الرقم السري لعملية تم الاستلام",description:"يرجى إدخال الرقم السري الرئيسي لتأكيد استلام المبلغ",userId:s||(j==null?void 0:j.uid),userRole:i==null?void 0:i.role,onSuccess:()=>{se&&(Re(se),U(null)),R(!1)}}),e.jsx(Q,{open:Te,onOpenChange:$,children:e.jsxs(V,{className:"sm:max-w-sm bg-white dark:bg-gray-900 border-gray-200 dark:border-gray-800",children:[e.jsx(X,{children:e.jsx(Y,{className:"text-gray-900 dark:text-gray-100",children:"سبب الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(he,{htmlFor:"deduct-reason",className:"text-gray-900 dark:text-gray-100",children:"اكتب سبب الخصم"}),e.jsx(ge,{id:"deduct-reason",value:H,onChange:r=>K(r.target.value),placeholder:"سبب الخصم",className:"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-900 dark:text-gray-100"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(N,{variant:"outline",onClick:()=>$(!1),className:"dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-800",children:"إلغاء"}),e.jsx(N,{onClick:Be,className:"bg-red-600 hover:bg-red-700 text-white",children:"متابعة"})]})]})}),e.jsx(me,{open:Ae,onOpenChange:W,mode:"verify",title:"تأكيد الرقم السري لعملية الخصم",description:"يرجى إدخال الرقم السري الرئيسي لمتابعة الخصم",userId:s||(j==null?void 0:j.uid),userRole:i==null?void 0:i.role,onSuccess:Oe}),e.jsx(Q,{open:Ce,onOpenChange:I,children:e.jsxs(V,{className:"sm:max-w-sm bg-white dark:bg-gray-900 border-gray-200 dark:border-gray-800",children:[e.jsx(X,{children:e.jsx(Y,{className:"text-gray-900 dark:text-gray-100",children:"مبلغ الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(he,{htmlFor:"deduct-amount",className:"text-gray-900 dark:text-gray-100",children:"أدخل مبلغ الخصم"}),e.jsx(ge,{id:"deduct-amount",type:"number",value:ne,onChange:r=>J(r.target.value),placeholder:"0.00",className:"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-900 dark:text-gray-100"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(N,{variant:"outline",onClick:()=>I(!1),className:"dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-800",children:"إلغاء"}),e.jsx(N,{onClick:Ee,className:"bg-red-600 hover:bg-red-700 text-white",children:"تأكيد الخصم"})]})]})})]})})};export{ft as CashSummaryDialog,ft as default};
//# sourceMappingURL=CashSummaryDialog-C52yFq-V.js.map
