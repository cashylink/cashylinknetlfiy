import{aa as $e,l as Ue,u as ze,aF as Ve,aQ as Ke,aR as ne,r as a,j as e,B as _,aS as Ge,C as S,c as D,d as T,f as I,aT as He,H as Te,aD as Qe,I as W,a7 as qe,aP as re,Q as ie,s as le,aU as Je,_ as Ie,Y as Xe,aV as We,aq as Ye,a as Ze,aW as Ce}from"./index-mBSeGJ8K.js";import{S as oe,a as ce,b as de,c as me,d as x}from"./select-DGk4nkpB.js";import{ProfitService as ke}from"./profitService-B3iovAHD.js";import{D as Ee}from"./dollar-sign-tQQ_yre_.js";import{W as et}from"./wallet-Li-2CV_d.js";import{A as tt}from"./arrow-down-left-BTRRls4w.js";const st=()=>{const w=$e(),{toast:o}=Ue(),{signOut:q,user:r,profile:p}=ze(),{isShiftActive:Be,shiftUser:he}=Ve(),C=Ke(),J=(typeof ne<"u"&&typeof ne.getPlatform=="function"?ne.getPlatform():"web")==="android"||/Android/i.test(typeof navigator<"u"?navigator.userAgent:""),[m,k]=a.useState("01030302038"),[Y,ue]=a.useState(""),[h,Z]=a.useState(""),[E,$]=a.useState(""),[f,xe]=a.useState("transfer"),[ee,fe]=a.useState("vodafone_cash"),[te,pe]=a.useState("vodafone_cash"),[B,se]=a.useState(""),[g,A]=a.useState([]),[at,nt]=a.useState("all"),[rt,it]=a.useState(!1),[ge,lt]=a.useState(""),[U,ot]=a.useState([]),[ct,dt]=a.useState(null),[mt,ht]=a.useState(!1),[ut,xt]=a.useState([]),[ft,pt]=a.useState([]),[gt,jt]=a.useState(!1),[bt,vt]=a.useState("daily"),[wt,P]=a.useState([]),[ae,j]=a.useState(0),[y,b]=a.useState({}),[yt,Nt]=a.useState(!1),[St,Dt]=a.useState(!1),[Tt,It]=a.useState(!1),[Wt,Ct]=a.useState(!1),[kt,Et]=a.useState(!1),[Bt,At]=a.useState(""),[Pt,Lt]=a.useState(!1),[Ae,L]=a.useState(!1),[z,je]=a.useState(()=>{try{const t=r!=null&&r.uid?`dailyReportsLockEnabled_${r==null?void 0:r.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[Pe,V]=a.useState(!1),[Le,Oe]=a.useState(!1),c=t=>{const s="٠١٢٣٤٥٦٧٨٩",n="۰۱۲۳۴۵۶۷۸۹";return(t||"").split("").map(l=>{const i=s.indexOf(l);if(i>-1)return String(i);const d=n.indexOf(l);return d>-1?String(d):l}).join("")},be=t=>{const s=c(t).replace(/\D/g,"");return s.startsWith("010")?"vodafone_cash":s.startsWith("011")?"etisalat_cash":s.startsWith("012")?"orange_cash":null};a.useEffect(()=>{const t=be(m);t&&t!==ee&&fe(t)},[m]),a.useEffect(()=>{const t=be(h);t&&t!==te&&pe(t)},[h]),a.useEffect(()=>{try{const t=r!=null&&r.uid?`dailyReportsLockEnabled_${r==null?void 0:r.uid}`:"dailyReportsLockEnabled",s=localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled");je(s==="true")}catch{}},[r==null?void 0:r.uid]),a.useEffect(()=>{const t=w.state||{};t!=null&&t.openTransactionSection&&(((t==null?void 0:t.transactionType)==="withdraw"||(t==null?void 0:t.transactionType)==="transfer")&&xe(t.transactionType),Oe(!0),t!=null&&t.startNewTransaction&&(k("01030302038"),Z(""),$(""),se("")),setTimeout(()=>{window.scrollTo({top:0,behavior:"smooth"})},50))},[w.state]);const K=async t=>{if(r)try{const s=await re.getById(r.uid);if(s!=null&&s.shopId){const n=ie(le,"dashboardData",s.shopId);await Ye(n,t)}}catch(s){console.error("Error saving to Firebase:",s),o({title:"خطأ في الحفظ",description:"حدث خطأ أثناء حفظ البيانات في Firebase",variant:"destructive"})}};a.useEffect(()=>{if(!r)return;(async()=>{L(!0);try{const s=await re.getById(r.uid);if(s!=null&&s.shopId){const n=ie(le,"dashboardData",s.shopId);try{const i=await Je(n);if(i.exists()){const d=i.data();j(d.cashBalance||0),b(d.walletBalances||{}),P(d.deletedTransactions||[]),L(!1)}}catch{}const l=await Ie(n);if(l.exists()){const i=l.data();j(i.cashBalance||0),b(i.walletBalances||{}),P(i.deletedTransactions||[])}else{const i={walletBalances:{},deletedTransactions:[]};await Xe(n,i),j(0),b(i.walletBalances),P(i.deletedTransactions)}}}catch(s){console.error("Error loading data from Firebase:",s),j(0),b({}),P([])}finally{L(!1)}})()},[r]),a.useEffect(()=>{const t=s=>{const{cashBalance:n,walletBalances:l,newTransaction:i}=s.detail||{};typeof n=="number"&&j(n),l&&typeof l=="object"&&b(l),i&&(A(d=>d.some(N=>N.id===i.id)?d:[i,...d]),o({title:"تم تسجيل عملية خارجية",description:"تم تحديث الأرصدة والسجلات بنجاح"}))};return window.addEventListener("dashboard:external-update",t),()=>window.removeEventListener("dashboard:external-update",t)},[]);const Fe=async()=>{if(r){L(!0);try{const t=await re.getById(r.uid);if(t!=null&&t.shopId){const s=ie(le,"dashboardData",t.shopId),n=await Ie(s);if(n.exists()){const l=n.data();j(l.cashBalance||0),b(l.walletBalances||{}),P(l.deletedTransactions||[]),o({title:"تم تحديث البيانات",description:"تم تحميل أحدث البيانات من السيرفر بنجاح"})}}}catch(t){console.error("Error refreshing dashboard data:",t),o({title:"فشل التحديث",description:"حدث خطأ أثناء تحديث البيانات",variant:"destructive"})}finally{L(!1)}}},Re=async t=>{if(t.preventDefault(),f==="transfer"){if(!m||!h||!E){o({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}const s=(p==null?void 0:p.shopName)||(r==null?void 0:r.displayName)||"محل كاشي لينك",n=U.find(Q=>Q.id===ge)||U.find(Q=>Q.isDefault),l=c(m||"").replace(/\D/g,""),i=c(h||"").replace(/\D/g,""),d=ee===te,N=l.startsWith("010")&&(i.startsWith("011")||i.startsWith("012")||i.startsWith("015"))||l.startsWith("012")&&i.startsWith("010")||l.startsWith("011")&&i.startsWith("010")||l.startsWith("015")&&i.startsWith("010"),u=d?B&&B.trim()!==""?parseFloat(B):1:N?parseFloat(B||"0"):0;if(N&&(Number.isNaN(u)||u<=0)){o({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"});return}if(!n){o({title:"لا توجد محفظة",description:"يرجى اختيار محفظة لإتمام التحويل",variant:"destructive"});return}const v=parseFloat(E),O=v+u,G=y[n.id]||0;if(G<O){o({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${G} لا يكفي لخصم ${O}`,variant:"destructive"});return}const F=We(v,"send"),R={id:Date.now().toString(),type:"send",senderPhone:m,receiverPhone:h,amount:v,status:"pending",createdAt:new Date,withdrawnAmount:0,sentAmount:v,merchantShopName:s,shopName:(n==null?void 0:n.name)||"المحفظة الرئيسية",commission:F,fee:u,fromWallet:n.id},ve=[R,...g];A(ve);const _e=v+u,H=n==null?void 0:n.id,Me=H&&y[H]||0,we=H?{...y,[H]:Me-_e}:y;b(we),await K({transactions:ve,walletBalances:we}),o({title:"تم إرسال التحويل",description:"جاري معالجة التحويل..."}),setTimeout(async()=>{const ye=[{...R,status:"completed"},...g];A(ye);const Ne=u,Se=Math.max(0,F)+(Number.isFinite(Ne)?Ne:0),De=ae+Se;j(De),await K({transactions:ye,cashBalance:De}),ke.addProfit(Se)},2e3),k("01030302038"),Z(""),$(""),se("")}else if(f==="withdraw"){if(!m||!E){o({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}const s=(p==null?void 0:p.shopName)||(r==null?void 0:r.displayName)||"محل كاشي لينك",n=U.find(u=>u.id===ge)||U.find(u=>u.isDefault);if(!n){o({title:"لا توجد محفظة",description:"يرجى اختيار محفظة لإتمام السحب",variant:"destructive"});return}const l=parseFloat(E);if(!Number.isFinite(l)||l<=0){o({title:"خطأ",description:"أدخل مبلغًا صحيحًا للسحب",variant:"destructive"});return}const i=We(l,"receive"),d={id:Date.now().toString(),type:"withdraw",senderPhone:m,receiverPhone:"",amount:l,status:"pending",createdAt:new Date,withdrawnAmount:l,sentAmount:0,merchantShopName:s,shopName:(n==null?void 0:n.name)||"المحفظة الرئيسية",commission:i,fromWallet:n.id,senderName:Y||void 0},N=[d,...g];A(N),await K({transactions:N}),o({title:"تم إنشاء عملية السحب",description:"جاري معالجة السحب..."}),setTimeout(async()=>{const v=[{...d,status:"completed"},...g];A(v);const O=n.id,G=y[O]||0,F={...y,[O]:G+l};b(F);const R=ae-l+Math.max(0,i);j(R),await K({transactions:v,walletBalances:F,cashBalance:R}),ke.addProfit(Math.max(0,i))},2e3),k("01030302038"),$("")}};return e.jsxs("div",{className:"min-h-screen bg-background p-4",children:[Ae&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-center",children:"جاري تحميل البيانات..."})]})}),e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"لوحة تحكم الإدارة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(_,{onClick:Fe,variant:"outline",className:"flex items-center gap-2",children:[e.jsx(RefreshCcw,{className:"h-4 w-4"}),"تحديث"]}),e.jsxs(_,{onClick:q,variant:"outline",className:"flex items-center gap-2",children:[e.jsx(Ge,{className:"h-4 w-4"}),"تسجيل الخروج"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsxs(S,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(T,{className:"text-sm font-medium",children:"الرصيد النقدي"}),e.jsx(Ee,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(I,{children:e.jsxs("div",{className:"text-2xl font-bold",children:[ae.toLocaleString()," جنيه"]})})]}),e.jsxs(S,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(T,{className:"text-sm font-medium",children:"الأرصدة علي المحافظ"}),e.jsx(et,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(I,{children:e.jsxs("div",{className:"text-2xl font-bold",children:[Object.values(y).reduce((t,s)=>t+s,0).toLocaleString()," جنيه"]})})]}),e.jsxs(S,{className:"relative",children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(T,{className:"text-sm font-medium",children:"المعاملات اليوم"}),e.jsx(He,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(I,{className:z?"filter blur-sm pointer-events-none":"",children:e.jsx("div",{className:"text-2xl font-bold",children:g.length})}),z&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(_,{size:"sm",variant:"ghost",onClick:()=>V(!0),className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير اليوم",children:[e.jsx(Te,{className:"h-5 w-5"}),e.jsx("span",{className:"text-xs",children:"عرض تقارير اليوم"})]})})]}),e.jsxs(S,{className:"relative",children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(T,{className:"text-sm font-medium",children:"إجمالي اليوم"}),e.jsx(Ee,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(I,{className:z?"filter blur-sm pointer-events-none":"",children:e.jsxs("div",{className:"text-2xl font-bold",children:[g.reduce((t,s)=>t+s.amount,0).toLocaleString()," جنيه"]})}),z&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(_,{size:"sm",variant:"ghost",onClick:()=>V(!0),className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير اليوم",children:[e.jsx(Te,{className:"h-5 w-5"}),e.jsx("span",{className:"text-xs",children:"عرض تقارير اليوم"})]})})]}),e.jsx(Qe,{open:Pe,onOpenChange:V,mode:"verify",title:"قفل تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{je(!1),V(!1)}})]}),e.jsxs(S,{className:C&&Le?"sticky top-0 z-40 shadow-lg bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/70":"",children:[e.jsx(D,{children:e.jsx(T,{children:"إجراء معاملة جديدة"})}),e.jsx(I,{children:e.jsxs("form",{onSubmit:Re,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"نوع المعاملة"}),e.jsxs(oe,{value:f,onValueChange:t=>xe(t),children:[e.jsx(ce,{children:e.jsx(de,{})}),e.jsxs(me,{children:[e.jsx(x,{value:"transfer",children:"تحويل"}),e.jsx(x,{value:"withdraw",children:"سحب"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رقم المرسل"}),e.jsx(W,{type:"tel",value:m,onChange:t=>k(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const s=document.getElementById("receiverPhoneInput");if(s)s.focus();else{const n=document.getElementById("amountInput");n==null||n.focus()}}},placeholder:"01xxxxxxxxx"})]}),f==="transfer"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رقم المستقبل"}),e.jsx(W,{id:"receiverPhoneInput",type:"tel",value:h,onChange:t=>Z(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const s=document.getElementById("amountInput");s==null||s.focus()}},placeholder:"01xxxxxxxxx"})]}),f==="withdraw"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"اسم الراسل (اختياري)"}),e.jsx(W,{id:"senderNameInput",type:"text",value:Y,onChange:t=>ue(t.target.value),placeholder:"مثال: أحمد عبد الرحمن"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"شركة المرسل"}),e.jsxs(oe,{value:ee,onValueChange:t=>fe(t),children:[e.jsx(ce,{children:e.jsx(de,{})}),e.jsxs(me,{children:[e.jsx(x,{value:"vodafone_cash",children:"فودافون"}),e.jsx(x,{value:"etisalat_cash",children:"اتصالات"}),e.jsx(x,{value:"orange_cash",children:"أورانج"}),e.jsx(x,{value:"instapay",children:"إنستاباي"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"شركة المستقبل"}),e.jsxs(oe,{value:te,onValueChange:t=>pe(t),children:[e.jsx(ce,{children:e.jsx(de,{})}),e.jsxs(me,{children:[e.jsx(x,{value:"vodafone_cash",children:"فودافون"}),e.jsx(x,{value:"etisalat_cash",children:"اتصالات"}),e.jsx(x,{value:"orange_cash",children:"أورانج"}),e.jsx(x,{value:"instapay",children:"إنستاباي"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"المبلغ"}),e.jsx(W,{id:"amountInput",type:"number",value:E,onChange:t=>$(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const s=document.getElementById("txSubmitButton");s==null||s.focus()}},placeholder:"0.00"})]}),f==="withdraw"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"اسم الراسل (اختياري)"}),e.jsx(W,{id:"senderNameInput",type:"text",value:Y,onChange:t=>ue(t.target.value),placeholder:"مثال: أحمد عبد الرحمن"})]}),f==="transfer"&&(c(m||"").replace(/\D/g,"").startsWith("010")&&c(h||"").replace(/\D/g,"").startsWith("010")||c(m||"").replace(/\D/g,"").startsWith("010")&&(c(h||"").replace(/\D/g,"").startsWith("011")||c(h||"").replace(/\D/g,"").startsWith("012")||c(h||"").replace(/\D/g,"").startsWith("015"))||c(m||"").replace(/\D/g,"").startsWith("012")&&c(h||"").replace(/\D/g,"").startsWith("010")||c(m||"").replace(/\D/g,"").startsWith("011")&&c(h||"").replace(/\D/g,"").startsWith("010")||c(m||"").replace(/\D/g,"").startsWith("015")&&c(h||"").replace(/\D/g,"").startsWith("010"))&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رسوم التحويل"}),e.jsx(W,{type:"number",value:B,onChange:t=>se(t.target.value),placeholder:"0.00"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"تُخصم من المحفظة وتضاف للدرج"})]})]}),e.jsx(_,{id:"txSubmitButton",type:"submit",className:`w-full ${f==="transfer"?"btn-transfer-confirm":"btn-withdraw-confirm"}`,children:f==="transfer"?"إرسال التحويل":"تنفيذ السحب"})]})})]}),e.jsxs(S,{children:[e.jsx(D,{children:e.jsx(T,{children:"المعاملات الأخيرة"})}),e.jsx(I,{children:g.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"لا توجد معاملات حديثة."}):e.jsx("div",{className:C||J?"receipts-list space-y-3 max-h-[310px] overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400":"receipts-list space-y-3",children:g.map(t=>e.jsxs("div",{className:"relative flex items-center gap-4 p-4 rounded-xl bg-card border border-gray-100 shadow-sm hover:shadow-md transition-all duration-200",children:[e.jsx("div",{className:`h-12 w-12 rounded-full flex items-center justify-center shrink-0 ${t.type==="withdraw"?"bg-red-50":"bg-green-50"}`,children:t.type==="withdraw"?e.jsx(tt,{className:"h-6 w-6 text-red-600"}):e.jsx(ArrowUpRight,{className:"h-6 w-6 text-green-600"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h4",{className:"text-base font-bold text-foreground truncate",children:t.type==="send"?"تحويل أموال":"سحب نقدي"}),e.jsxs("span",{className:`text-base font-bold whitespace-nowrap ${t.type==="send"?"text-green-600":"text-red-600"}`,children:[t.type==="send"?"-":"+"," ",t.amount.toLocaleString()," ج.م"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-0.5",children:[e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:t.type==="send"?e.jsx("span",{dir:"ltr",children:t.receiverPhone}):e.jsx("span",{dir:"ltr",children:t.senderPhone})}),e.jsx("p",{className:"text-sm font-medium text-gray-500 mt-0.5",children:t.createdAt instanceof Date?t.createdAt.toLocaleString("ar-EG",{day:"numeric",month:"short",hour:"numeric",minute:"numeric",hour12:!0}):new Date(t.createdAt.seconds*1e3).toLocaleString("ar-EG",{day:"numeric",month:"short",hour:"numeric",minute:"numeric",hour12:!0})})]}),e.jsxs("div",{className:`px-2.5 py-1 rounded-full text-xs font-medium flex items-center gap-1 ${t.status==="completed"?"bg-green-50 text-green-700":t.status==="pending"?"bg-yellow-50 text-yellow-700":"bg-red-50 text-red-700"}`,children:[t.status==="completed"&&e.jsx(Check,{className:"h-3 w-3"}),t.status==="pending"&&e.jsx(qe,{className:"h-3 w-3"}),t.status==="failed"&&e.jsx(X,{className:"h-3 w-3"}),e.jsx("span",{children:t.status==="completed"?"ناجحة":t.status==="pending"?"معالجة":"فشلت"})]})]})]})]},t.id))})})]})]})]})},Ut=()=>{const w=Ze(),[o,q]=a.useState(!1),[r,p]=a.useState(!0);return a.useEffect(()=>{(()=>{const he=localStorage.getItem("dashboardAuth"),C=localStorage.getItem("dashboardUser");if(he==="true"&&C)try{const M=JSON.parse(C),J=new Date(M.loginTime);(new Date().getTime()-J.getTime())/(1e3*60*60)<24?q(!0):(localStorage.removeItem("dashboardAuth"),localStorage.removeItem("dashboardUser"),w("/dashboard/login"))}catch(M){console.error("Error parsing user data:",M),w("/dashboard/login")}else w("/dashboard/login");p(!1)})()},[w]),r?e.jsx(Ce,{}):o?e.jsx(st,{}):e.jsx(Ce,{})};export{Ut as default};
//# sourceMappingURL=ProtectedDashboard-K-13upKR.js.map
