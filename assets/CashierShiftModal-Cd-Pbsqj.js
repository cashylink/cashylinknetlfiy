import{aL as Rs,u as Ms,m as Ps,r as l,a5 as _,j as e,af as j,ag as f,ah as g,ai as y,B as c,aQ as N,y as h,I as u,av as os,V as ms,t as ke,a0 as Us,_ as Ls,ad as Te,D as Hs,s as Vs,E as $s}from"./index-CZwBW8vR.js";import{S as qs,a as _s,b as zs,c as Ys,d as oe}from"./select-C1gLQVXw.js";import{getLastTransactions as Gs}from"./functions-P4y9aL9k.js";const ia=({open:R,onOpenChange:z})=>{var ns,is,cs;const{shiftUser:n,isShiftActive:Y,shiftStartAt:M,setShiftUser:P,startShift:Ae,endShift:Oe}=Rs(),{userSubscription:D,user:t,signIn:Ks,profile:Js,checkSubscriptionStatus:me}=Ms(),{toast:b}=Ps(),[U,Fe]=l.useState((n==null?void 0:n.name)||""),[L,We]=l.useState((n==null?void 0:n.username)||""),[H,Ie]=l.useState(""),[xe,G]=l.useState(!1),[k,K]=l.useState(null),[Ee,Be]=l.useState(""),[Re,J]=l.useState(""),[Qs,Xs]=l.useState(!1),[C,he]=l.useState(null),[Me,ue]=l.useState(""),[Pe,V]=l.useState(""),[Ue,F]=l.useState(!1),[Q,X]=l.useState(!1),[Le,Z]=l.useState({totalTransfers:0,totalWithdrawals:0}),[ee,se]=l.useState(null),[He,ve]=l.useState(""),[W,Ve]=l.useState(""),[I,$e]=l.useState(0),[xs,Zs]=l.useState({}),[E,hs]=l.useState(0),[$,us]=l.useState(0),[vs,ea]=l.useState({}),[pe,qe]=l.useState(""),[ps,je]=l.useState(!1);l.useEffect(()=>{R&&me&&me(!0)},[R,me]);const ae=s=>{const a={"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9","۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9","٫":".","،":".","٬":"."," ":""};return s.split("").map(i=>a[i]??i).join("")},fe=()=>`cashierUsers_${(t==null?void 0:t.uid)||"default"}`,[w,B]=l.useState(()=>{try{let s=localStorage.getItem(fe());if(!s){const a=localStorage.getItem("cashierUsers");a&&(s=a)}return s?JSON.parse(s):[]}catch{return[]}}),[_e,js]=l.useState(!1);l.useEffect(()=>{if(!(t!=null&&t.uid))return;(async()=>{let a=!1;try{const i=ms(ke,"profiles",t.uid,"cashierUsers","list"),d=await Us(i);if(d.exists()){const v=d.data(),S=Array.isArray(v==null?void 0:v.users)?v.users:[];S.length>0&&(B(S),a=!0)}}catch(i){console.warn("Failed to fetch cashierUsers from Firestore:",i)}if(!a)try{const i=localStorage.getItem(fe()),d=i?JSON.parse(i):[];d.length>0?B(d):w.length>0&&B([])}catch{}js(!0)})()},[t==null?void 0:t.uid]);const te=(ns=D==null?void 0:D.subscription)==null?void 0:ns.planType,ze=((is=D==null?void 0:D.subscription)==null?void 0:is.extraCashiers)||0,le=(cs=D==null?void 0:D.subscription)==null?void 0:cs.extraCashiersEndsAt;let Ye=!1;ze>0&&le&&(le.seconds?new Date(le.seconds*1e3):new Date(le))>new Date&&(Ye=!0);const A=(te==="quarterly"||te==="half_yearly"||te==="yearly"||te==="lifetime"?2:1)+(Ye?ze:0);l.useEffect(()=>{try{localStorage.setItem(fe(),JSON.stringify(w));try{localStorage.removeItem("cashierUsers")}catch{}}catch{}(async()=>{try{if(!(t!=null&&t.uid)||w.length===0&&!_e)return;const a=ms(ke,"profiles",t.uid,"cashierUsers","list");await Ls(a,{users:w},{merge:!0})}catch(a){console.warn("Failed to save cashierUsers to Cloud:",a)}})()},[w,_e,t==null?void 0:t.uid]);const[fs,re]=l.useState(!1),[Ge,ge]=l.useState(""),[T,Ke]=l.useState(null),[Je,ye]=l.useState([]),[Ne,be]=l.useState(!1),[m,gs]=l.useState(null),[ys,we]=l.useState(!1),[Ns,q]=l.useState(!1),[bs,ne]=l.useState(!1),[ws,ie]=l.useState(!1),[Qe,Ss]=l.useState("1"),[Xe,Cs]=l.useState(_.MONTHLY),Ds=async()=>{if(t!=null&&t.uid)try{await Hs(Vs(ke,"cashierRequests"),{userId:t.uid,userName:t.displayName||t.email,userEmail:t.email,requestedCount:parseInt(Qe),planType:Xe,status:"pending",createdAt:$s()}),b({title:"تم إرسال الطلب بنجاح",description:"سيتم مراجعة طلبك من قبل الإدارة"}),ie(!1)}catch(s){console.error(s),b({title:"خطأ",description:"حدث خطأ أثناء إرسال الطلب",variant:"destructive"})}},[ks,Se]=l.useState(!1),[x,Ce]=l.useState(null),[Ts,ce]=l.useState(!1),[Ze,es]=l.useState(""),[ss,de]=l.useState(""),As=s=>{Ce(s),ce(!0),es(""),de("")},as=async()=>{if(!(t!=null&&t.uid)){de("خطأ في معرف المستخدم");return}try{if(!await os.verifyMasterPin(Ze,t.uid)){de("الرقم السري الرئيسي غير صحيح");return}ce(!1),Se(!0)}catch{de("حدث خطأ أثناء التحقق")}},Os=s=>{x&&(B(a=>a.map(i=>i.username===x.username?{...i,permissions:s}:i)),(n==null?void 0:n.username)===x.username&&P({...n,permissions:s}),Se(!1),Ce(null),b({title:"تم تحديث الصلاحيات بنجاح"}))},Fs=()=>{w.length>=A?ne(!0):q(!0)},Ws=s=>{const a=(n==null?void 0:n.username)===s;let i=!1;try{i=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(a&&!(a&&!Y&&(pe==="الأدمن الرئيسي"||i))){b({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const S=`هل أنت متأكد من حذف المستخدم ${s}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(S)&&(B(p=>p.filter(De=>De.username!==s)),a&&P(null),b({title:"تم حذف المستخدم",description:s}))},ts=()=>{if(!U.trim()||!L.trim()||!H.trim())return;if(w.length>=A){b({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(A)?A:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const s={name:U.trim(),username:L.trim(),password:H.trim()};B(a=>[s,...a]),Fe(""),We(""),Ie("")},Is=()=>{G(!0),K(null),he(null),ue(""),V("")},ls=async()=>{try{let s=[];try{t!=null&&t.uid&&(s=await Te.getUserTransactions(t.uid))}catch{}if(!s||s.length===0)try{const r=await Gs({merchantUserId:t==null?void 0:t.uid,limit:200});s=(r==null?void 0:r.transactions)||[]}catch{}const a=M?new Date(M):null,i=new Date,d=r=>{const o=r.type,O=r.txnType;return o==="withdraw"||o==="withdrawal"||o==="receive"||O==="receive"},v=r=>{const o=r.type,O=r.txnType;return o==="send"||o==="transfer"||O==="send"},S=r=>{if(!r)return null;if(r instanceof Date)return r;try{const o=new Date(r);return Number.isNaN(o.getTime())?null:o}catch{return null}},p=r=>{const o=S(r.createdAt||r.created_at||r.timestamp);return!o||a&&o<a?!1:o<=i},De=r=>r==="completed"||r==="confirmed",ds=s.filter(r=>De(r.status)&&p(r)),Bs=ds.filter(r=>d(r)).reduce((r,o)=>{const O=o.withdrawnAmount??o.receivedAmount??o.amount??0;return r+(Number(O)||0)},0);return{totalTransfers:ds.filter(r=>v(r)).reduce((r,o)=>{const O=o.sentAmount??o.transferredAmount??o.amount??0;return r+(Number(O)||0)},0),totalWithdrawals:Bs}}catch{return{totalTransfers:0,totalWithdrawals:0}}};l.useEffect(()=>{if(Q){try{const s=localStorage.getItem("shiftInitialReceivedDrawerFunds");s!==null&&Ve(s)}catch{}try{const s=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(s!==null){const a=parseFloat(s);$e(Number.isFinite(a)?a:0)}}catch{}}},[Q]),l.useEffect(()=>{xe&&(async()=>{try{const s=await ls();Z(s)}catch{}})()},[xe]),l.useEffect(()=>{if(!R&&!Ne)return;(async()=>{try{const i=((t!=null&&t.uid?await Te.getUserTransactions(t.uid):[])||[]).filter(d=>(d==null?void 0:d.type)==="report"||((d==null?void 0:d.title)||"").includes("إيصال تسليم وردية"));i.sort((d,v)=>{const S=new Date(d.createdAt||0).getTime();return new Date(v.createdAt||0).getTime()-S}),ye(i)}catch{ye([])}})()},[R,Q,Ne,t==null?void 0:t.uid]);const Es=async(s,a,i)=>{try{let d=0,v=0;try{const p=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");d=Number.isFinite(p)?p:0}catch{}try{const p=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");v=Number.isFinite(p)?p:0}catch{}const S={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(n==null?void 0:n.username)||"cashier",receiverPhone:pe||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(n==null?void 0:n.name)||(n==null?void 0:n.username)||null,deficit:a,deficitAmount:a?i:0,shiftStartAt:M,receivedDrawerFunds:d,receivedWalletBalancesTotal:v,receivedWalletBalances:xs,deliveredDrawerFunds:E||0,deliveredWalletBalancesTotal:$||0,deliveredWalletBalances:vs,shiftProfit:Math.round(((E||0)+($||0)-(d+v))*100)/100};t!=null&&t.uid&&await Te.saveUserTransaction(t.uid,S),ye(p=>[S,...p||[]])}catch{}},rs=w.slice(Math.max(0,w.length-A));return e.jsxs(e.Fragment,{children:[e.jsx(j,{open:R,onOpenChange:z,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:Y?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),Y?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[n==null?void 0:n.name," (",n==null?void 0:n.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),w.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:rs.map((s,a)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:s.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(c,{size:"sm",className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>{Ke(s),re(!0)},children:"دخول"}),e.jsx(c,{size:"sm",className:"w-full sm:w-auto",variant:"outline",onClick:()=>As(s),children:"الصلاحيات"}),e.jsx(c,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>Ws(s.username),children:"حذف"})]})]},a))})]})]}),e.jsx(N,{className:"flex flex-wrap gap-2 justify-between",children:Y?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(c,{className:"w-full sm:w-auto",variant:"destructive",onClick:Is,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(c,{className:"w-full sm:w-auto bg-emerald-600 hover:bg-emerald-700 text-white",onClick:Fs,children:"إضافة مستخدم جديد"}),e.jsx(c,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>be(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(j,{open:bs,onOpenChange:ne,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsxs(y,{className:"text-red-600 flex items-center gap-2",children:[e.jsx("span",{className:"text-xl",children:"⚠️"})," تنبيه: الحد الأقصى للمستخدمين"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("p",{className:"text-sm text-gray-700 leading-relaxed",children:["عفواً، لا يمكنك إضافة المزيد من مستخدمي الوردية. ",e.jsx("br",{}),"الحد المسموح به لباقة اشتراكك هو ",e.jsx("strong",{children:A})," ",A===1?"مستخدم":"مستخدمين","."]}),e.jsx("p",{className:"text-sm text-gray-600",children:"لزيادة عدد المستخدمين، يرجى التواصل مع خدمة العملاء لترقية الباقة أو طلب زيادة العدد."})]}),e.jsxs(N,{className:"flex flex-col sm:flex-row gap-2 justify-end",children:[e.jsx(c,{className:"w-full sm:w-auto",onClick:()=>ne(!1),variant:"secondary",children:"حسناً، فهمت"}),e.jsx(c,{className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>{ne(!1),ie(!0)},children:"طلب إضافة كاشير"})]})]})}),e.jsx(j,{open:ws,onOpenChange:ie,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:"طلب زيادة عدد الكاشير"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"يمكنك طلب زيادة عدد الكاشير المسموح به. سيتم مراجعة الطلب من قبل الإدارة."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"عدد الكاشير المطلوب إضافتهم"}),e.jsx(u,{type:"number",min:"1",max:"10",value:Qe,onChange:s=>Ss(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"نظام الاشتراك للكاشير الإضافي"}),e.jsxs(qs,{value:Xe,onValueChange:s=>Cs(s),children:[e.jsx(_s,{children:e.jsx(zs,{placeholder:"اختر الباقة"})}),e.jsxs(Ys,{children:[e.jsx(oe,{value:_.MONTHLY,children:"شهري"}),e.jsx(oe,{value:_.QUARTERLY,children:"ربع سنوي"}),e.jsx(oe,{value:_.YEARLY,children:"سنوي"}),e.jsx(oe,{value:_.LIFETIME,children:"مدى الحياة"})]})]})]})]}),e.jsxs(N,{children:[e.jsx(c,{variant:"secondary",onClick:()=>ie(!1),children:"إلغاء"}),e.jsx(c,{className:"bg-blue-600 hover:bg-blue-700 text-white",onClick:Ds,children:"إرسال الطلب"})]})]})}),e.jsx(j,{open:Ns,onOpenChange:q,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(h,{className:"mb-1 block",children:"الاسم"}),e.jsx(u,{value:U,onChange:s=>Fe(s.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(h,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(u,{value:L,onChange:s=>We(s.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(h,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(u,{type:"password",autoComplete:"new-password",value:H,onChange:s=>Ie(s.target.value),onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),U.trim()&&L.trim()&&H.trim()&&(ts(),q(!1)))},placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(N,{className:"flex gap-2 justify-between",children:[e.jsx(c,{variant:"secondary",onClick:()=>{q(!1)},children:"إلغاء"}),e.jsx(c,{onClick:()=>{!U.trim()||!L.trim()||!H.trim()||(ts(),q(!1))},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"حفظ المستخدم"})]})]})}),e.jsx(j,{open:Ts,onOpenChange:ce,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:"تأكيد هوية المدير"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"يرجى إدخال الرقم السري الرئيسي (كلمة مرور حسابك) لفتح إعدادات الصلاحيات."}),e.jsxs("div",{children:[e.jsx(h,{className:"mb-1 block",children:"كلمة المرور"}),e.jsx(u,{type:"password",value:Ze,onChange:s=>es(s.target.value),onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),as())},placeholder:"أدخل كلمة المرور"}),ss&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:ss})]})]}),e.jsxs(N,{children:[e.jsx(c,{variant:"outline",onClick:()=>ce(!1),children:"إلغاء"}),e.jsx(c,{onClick:as,className:"bg-blue-600 hover:bg-blue-700 text-white",children:"تأكيد"})]})]})}),e.jsx(j,{open:ks,onOpenChange:Se,children:e.jsxs(f,{className:"sm:max-w-lg max-h-[90vh] overflow-y-auto",children:[e.jsx(g,{children:e.jsxs(y,{children:["صلاحيات المستخدم: ",x==null?void 0:x.name]})}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 py-4",children:[{key:"sales",label:"المبيعات"},{key:"debts",label:"الديون"},{key:"deficiencies",label:"النواقص"},{key:"cards",label:"البطاقات"},{key:"lines",label:"الخطوط"},{key:"myNumbers",label:"أرقامي"},{key:"installments",label:"تقسيط"},{key:"maintenance",label:"صيانة"},{key:"machines",label:"المكنة"},{key:"expenses",label:"المصروفات"},{key:"settings",label:"الإعدادات"},{key:"branches",label:"الفروع"},{key:"transfers",label:"التحويل"},{key:"withdrawals",label:"السحب"}].map(s=>{var i;const a=((i=x==null?void 0:x.permissions)==null?void 0:i[s.key])!==!1;return e.jsxs("div",{className:"flex items-center justify-between border p-3 rounded bg-gray-50 dark:bg-gray-800",children:[e.jsx(h,{htmlFor:`perm-${s.key}`,className:"cursor-pointer font-medium",children:s.label}),e.jsx(c,{id:`perm-${s.key}`,size:"sm",onClick:()=>{x&&Ce({...x,permissions:{...x.permissions,[s.key]:!a}})},className:`w-24 font-bold text-white transition-colors ${a?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:a?"مفعل":"معطل"})]},s.key)})}),e.jsx(N,{children:e.jsx(c,{onClick:()=>Os(x==null?void 0:x.permissions),className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",children:"حفظ الصلاحيات"})})]})}),e.jsx(j,{open:Ne,onOpenChange:be,children:e.jsxs(f,{className:"sm:max-w-lg",children:[e.jsx(g,{children:e.jsx(y,{children:"إيصالات التسليم"})}),Je.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:Je.map(s=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{gs(s),we(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(s.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",s.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",s.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",s.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",s.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",s.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",s.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",s.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",s.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",s.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(s.shiftProfit??(s.deliveredDrawerFunds??0)+(s.deliveredWalletBalancesTotal??0)-(s.receivedDrawerFunds??0)-(s.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",s.shiftProfit??(s.deliveredDrawerFunds??0)+(s.deliveredWalletBalancesTotal??0)-(s.receivedDrawerFunds??0)-(s.receivedWalletBalancesTotal??0)]})]}),s.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",s.deficitAmount??0]})]},s.id))}),e.jsx(N,{className:"flex gap-2 justify-between",children:e.jsx(c,{variant:"secondary",onClick:()=>be(!1),children:"إغلاق"})})]})}),e.jsx(j,{open:ys,onOpenChange:we,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:"إيصال تسليم وردية"})}),m?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(m.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",m.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",m.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",m.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",m.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",m.deliveredWalletBalancesTotal??0]})]})]}),m.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",m.deficitAmount??0]})]}),m.receivedWalletBalances&&Object.keys(m.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(m.receivedWalletBalances).map(([s,a])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:s}),e.jsx("span",{className:"font-semibold",children:a})]},s))})]}),m.deliveredWalletBalances&&Object.keys(m.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(m.deliveredWalletBalances).map(([s,a])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:s}),e.jsx("span",{className:"font-semibold",children:a})]},s))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(N,{className:"flex gap-2 justify-between",children:e.jsx(c,{variant:"secondary",onClick:()=>we(!1),children:"إغلاق"})})]})}),e.jsx(j,{open:fs,onOpenChange:re,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:T?`${T.name} (${T.username})`:""}),e.jsx(u,{type:"password",autoComplete:"off",value:Ge,onChange:s=>ge(s.target.value),onKeyDown:s=>{var a;s.key==="Enter"&&(s.preventDefault(),(a=document.getElementById("login-confirm-btn"))==null||a.click())},placeholder:"أدخل الرقم السري"})]}),e.jsxs(N,{className:"flex gap-2 justify-between",children:[e.jsx(c,{variant:"secondary",onClick:()=>{ge(""),Ke(null),re(!1)},children:"إلغاء"}),e.jsx(c,{id:"login-confirm-btn",className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{if(T){if(Ge.trim()!==T.password){b({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}P({name:T.name,username:T.username,permissions:T.permissions}),ge(""),re(!1),z(!1),Ae(),je(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(j,{open:ps,onOpenChange:je,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(h,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(u,{type:"text",inputMode:"decimal",value:W,onChange:s=>Ve(ae(s.target.value)),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(h,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(u,{type:"text",inputMode:"decimal",value:Number.isFinite(I)?I:0,onChange:s=>{const a=parseFloat(ae(s.target.value));$e(Number.isFinite(a)?a:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(N,{className:"flex gap-2 justify-between",children:e.jsx(c,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{const s=parseFloat(W),a=I,i=Number.isFinite(s)&&s>=0,d=Number.isFinite(a)&&a>=0;if(!i||!d){b({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(s)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(a))}catch{}b({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),je(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(j,{open:xe,onOpenChange:s=>{s&&G(!0)},children:e.jsxs(f,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(g,{children:e.jsx(y,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{variant:k==="toUser"?"default":"secondary",onClick:()=>K("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(c,{variant:k==="toAdmin"?"default":"secondary",onClick:()=>K("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),k==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[w.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:rs.map((s,a)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(C==null?void 0:C.username)===s.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>he(s),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:s.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},a))})]}),e.jsxs("div",{children:[e.jsx(h,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(u,{type:"password",autoComplete:"off",value:Me,onChange:s=>ue(s.target.value),placeholder:"أدخل كلمة السر"})]}),Pe&&e.jsx("div",{className:"text-xs text-red-600",children:Pe})]}),k==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(u,{type:"password",autoComplete:"off",value:Ee,onChange:s=>Be(s.target.value),placeholder:"كلمة المرور"}),Re&&e.jsx("div",{className:"text-xs text-red-600",children:Re})]})]}),e.jsx(N,{className:"flex gap-2 justify-between",children:e.jsx(c,{id:"handover-confirm-btn",disabled:Ue||!k,onClick:async()=>{if(k){F(!0);try{const s=Le;if(ls().then(Z).catch(()=>{}),k==="toUser"){if(!C){V("يرجى اختيار المستخدم أولاً"),F(!1);return}if(Me.trim()!==C.password){V("كلمة السر غير صحيحة"),F(!1);return}Oe(),P({name:C.name,username:C.username,permissions:C.permissions}),Ae(),qe(`${C.name} (${C.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}G(!1),K(null),he(null),ue(""),V(""),z(!1),Z(s),se(null),ve(""),X(!0)}else if(k==="toAdmin"){if(J(""),!(t!=null&&t.uid)){J("خطأ في معرف المستخدم"),F(!1);return}if(!await os.verifyMasterPin(Ee,t.uid)){J("الرقم السري الرئيسي غير صحيح"),F(!1);return}Oe(),P(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}Be(""),G(!1),z(!1),qe("الأدمن الرئيسي"),Z(s),se(null),ve(""),X(!0)}}catch(s){console.error(s);const a="حدث خطأ أثناء التسليم، حاول مرة أخرى";k==="toAdmin"?J(a):V(a),b({title:"خطأ",description:a,variant:"destructive"})}finally{F(!1)}}},className:"bg-blue-600 hover:bg-blue-700 text-white",children:Ue?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري المعالجة..."]}):"تأكيد التسليم"})})]})}),e.jsx(j,{open:Q,onOpenChange:X,children:e.jsxs(f,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(g,{children:e.jsx(y,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:pe})]}),M&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(M).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(h,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(u,{type:"number",value:W,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(h,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(u,{type:"number",value:I,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(h,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(u,{type:"text",inputMode:"decimal",value:E,onChange:s=>{const a=parseFloat(ae(s.target.value));hs(Number.isFinite(a)?a:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(h,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(u,{type:"text",inputMode:"decimal",value:$,onChange:s=>{const a=parseFloat(ae(s.target.value));us(Number.isFinite(a)?a:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(E??0)+($??0)-((parseFloat(W||"0")||0)+(I??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((E??0)+($??0)-((parseFloat(W||"0")||0)+(I??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"}),e.jsx("div",{className:"mt-2 grid grid-cols-1 gap-2",children:e.jsxs("div",{className:"rounded border p-2 bg-gray-50",children:[e.jsx("div",{className:"text-xs text-gray-700",children:"مطلوب من الدرج (بدون أرباح)"}),e.jsx("div",{className:"text-sm font-semibold text-gray-900",children:Math.round(((E??0)-(parseFloat(W||"0")||0))*100)/100})]})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{variant:ee==="no"?"default":"secondary",onClick:()=>se("no"),children:"لا"}),e.jsx(c,{variant:ee==="yes"?"default":"secondary",onClick:()=>se("yes"),children:"نعم"})]}),ee==="yes"&&e.jsxs("div",{children:[e.jsx(h,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(u,{type:"number",value:He,onChange:s=>ve(s.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(N,{className:"flex gap-2 justify-between",children:e.jsx(c,{onClick:()=>{const s=ee==="yes",a=parseFloat(He)||0;(async()=>await Es(Le,s,a))(),b({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),X(!1)},className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:"تأكيد وحفظ الإيصال"})})]})})]})};export{ia as default};
//# sourceMappingURL=CashierShiftModal-Cd-Pbsqj.js.map
