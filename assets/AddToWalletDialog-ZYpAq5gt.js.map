{"version":3,"file":"AddToWalletDialog-ZYpAq5gt.js","sources":["../../src/components/AddToWalletDialog.tsx"],"sourcesContent":["import React, { useEffect, useState } from 'react';\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Lock, Eye, EyeOff, AlertCircle, Plus, Minus } from 'lucide-react';\r\nimport { MasterPinService } from '@/utils/masterPinService';\r\n\r\ninterface AddToWalletDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  onSuccess: (addedAmount: number) => void;\r\n  title: string;\r\n  description: string;\r\n  currentBalance: number;\r\n  balanceLabel: string;\r\n  userId?: string;\r\n}\r\n\r\nexport function AddToWalletDialog({ \r\n  open, \r\n  onOpenChange, \r\n  onSuccess, \r\n  title, \r\n  description,\r\n  currentBalance,\r\n  balanceLabel,\r\n  userId\r\n}: AddToWalletDialogProps) {\r\n  const [pin, setPin] = useState('');\r\n  const [amount, setAmount] = useState('');\r\n  const [operationType, setOperationType] = useState<'add' | 'subtract'>('add');\r\n  const [showPin, setShowPin] = useState(false);\r\n  const [error, setError] = useState('');\r\n  const [isLoading, setIsLoading] = useState(false);\r\n\r\n  const [hasMasterPin, setHasMasterPin] = useState(false);\r\n\r\n  useEffect(() => {\r\n    let mounted = true;\r\n    (async () => {\r\n      const has = await MasterPinService.hasMasterPin(userId);\r\n      if (mounted) setHasMasterPin(has);\r\n    })();\r\n    return () => { mounted = false; };\r\n  }, [userId, open]);\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setError('');\r\n    setIsLoading(true);\r\n\r\n    try {\r\n      // التحقق من صحة المبلغ\r\n      const amountValue = parseFloat(amount);\r\n      if (isNaN(amountValue) || amountValue <= 0) {\r\n        setError('يرجى إدخال مبلغ صحيح أكبر من صفر');\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n\r\n      // التحقق من أن المبلغ المطروح لا يجعل الرصيد سالباً\r\n      if (operationType === 'subtract' && amountValue > currentBalance) {\r\n        setError('لا يمكن خصم مبلغ أكبر من الرصيد الحالي');\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n\r\n      if (hasMasterPin) {\r\n        // التحقق من الرقم السري الرئيسي\r\n        const ok = await MasterPinService.verifyMasterPin(pin, userId);\r\n        if (ok) {\r\n          const finalAmount = operationType === 'add' ? amountValue : -amountValue;\r\n          \r\n          // إغلاق النافذة فوراً\r\n          handleClose();\r\n          \r\n          // تنفيذ العملية فوراً\r\n          onSuccess(finalAmount);\r\n        } else {\r\n          setError('الرقم السري غير صحيح');\r\n        }\r\n      } else {\r\n        setError('لم يتم تعيين الرقم السري الرئيسي. يرجى تعيينه من إعدادات البروفيل أولاً');\r\n      }\r\n    } catch (error) {\r\n      setError('حدث خطأ أثناء التحقق من الرقم السري');\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleClose = () => {\r\n    setPin('');\r\n    setAmount('');\r\n    setOperationType('add');\r\n    setError('');\r\n    onOpenChange(false);\r\n  };\r\n\r\n  const getNewBalance = () => {\r\n    const amountValue = parseFloat(amount) || 0;\r\n    if (operationType === 'add') {\r\n      return currentBalance + amountValue;\r\n    } else {\r\n      return currentBalance - amountValue;\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={handleClose}>\r\n      <DialogContent className=\"sm:max-w-md\" dir=\"rtl\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"flex items-center gap-2 text-right\">\r\n            {operationType === 'add' ? (\r\n              <Plus className=\"h-5 w-5 text-green-600\" />\r\n            ) : (\r\n              <Minus className=\"h-5 w-5 text-red-600\" />\r\n            )}\r\n            {title}\r\n          </DialogTitle>\r\n        </DialogHeader>\r\n        \r\n        <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n          <div className=\"text-sm text-muted-foreground text-right\">\r\n            {description}\r\n          </div>\r\n\r\n          {/* عرض الرصيد الحالي */}\r\n          <div className=\"bg-gray-50 p-3 rounded-lg\">\r\n            <Label className=\"text-sm font-medium text-gray-700\">\r\n              {balanceLabel} الحالي\r\n            </Label>\r\n            <div className=\"text-lg font-bold text-gray-900 mt-1\">\r\n              {currentBalance.toLocaleString()} جنيه\r\n            </div>\r\n          </div>\r\n\r\n          {/* اختيار نوع العملية */}\r\n          <div className=\"space-y-2\">\r\n            <Label className=\"text-right\">نوع العملية</Label>\r\n            <div className=\"flex gap-2\">\r\n              <Button\r\n                type=\"button\"\r\n                variant={operationType === 'add' ? 'default' : 'outline'}\r\n                onClick={() => setOperationType('add')}\r\n                className=\"flex-1 flex items-center gap-2\"\r\n              >\r\n                <Plus className=\"h-4 w-4\" />\r\n                إضافة\r\n              </Button>\r\n              <Button\r\n                type=\"button\"\r\n                variant={operationType === 'subtract' ? 'default' : 'outline'}\r\n                onClick={() => setOperationType('subtract')}\r\n                className=\"flex-1 flex items-center gap-2\"\r\n              >\r\n                <Minus className=\"h-4 w-4\" />\r\n                خصم\r\n              </Button>\r\n            </div>\r\n          </div>\r\n\r\n          {/* إدخال المبلغ */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"amount\" className=\"text-right\">\r\n              المبلغ المراد {operationType === 'add' ? 'إضافته' : 'خصمه'}\r\n            </Label>\r\n            <Input\r\n              id=\"amount\"\r\n              type=\"number\"\r\n              step=\"0.01\"\r\n              min=\"0.01\"\r\n              value={amount}\r\n              onChange={(e) => setAmount(e.target.value)}\r\n              placeholder={`أدخل المبلغ المراد ${operationType === 'add' ? 'إضافته' : 'خصمه'}`}\r\n              className=\"text-right\"\r\n              required\r\n            />\r\n          </div>\r\n\r\n          {/* عرض الرصيد الجديد المتوقع */}\r\n          {amount && !isNaN(parseFloat(amount)) && (\r\n            <div className={`p-3 rounded-lg ${operationType === 'add' ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`}>\r\n              <Label className=\"text-sm font-medium text-gray-700\">\r\n                الرصيد الجديد المتوقع\r\n              </Label>\r\n              <div className={`text-lg font-bold mt-1 ${operationType === 'add' ? 'text-green-700' : 'text-red-700'}`}>\r\n                {getNewBalance().toLocaleString()} جنيه\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* إدخال الرقم السري */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"pin\" className=\"text-right\">\r\n              الرقم السري\r\n            </Label>\r\n            <div className=\"relative\">\r\n              <Input\r\n                id=\"pin\"\r\n                type={showPin ? 'text' : 'password'}\r\n                autoComplete=\"off\"\r\n                value={pin}\r\n                onChange={(e) => setPin(e.target.value)}\r\n                placeholder=\"أدخل الرقم السري\"\r\n                className=\"text-right pr-10\"\r\n                required\r\n              />\r\n              <Button\r\n                type=\"button\"\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                className=\"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent\"\r\n                onClick={() => setShowPin(!showPin)}\r\n              >\r\n                {showPin ? (\r\n                  <EyeOff className=\"h-4 w-4\" />\r\n                ) : (\r\n                  <Eye className=\"h-4 w-4\" />\r\n                )}\r\n              </Button>\r\n            </div>\r\n          </div>\r\n\r\n          {error && (\r\n            <div className=\"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded\">\r\n              <AlertCircle className=\"h-4 w-4\" />\r\n              {error}\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"flex gap-2 pt-4\">\r\n            <Button\r\n              type=\"button\"\r\n              variant=\"outline\"\r\n              onClick={handleClose}\r\n              className=\"flex-1\"\r\n            >\r\n              إلغاء\r\n            </Button>\r\n            <Button\r\n              type=\"submit\"\r\n              disabled={isLoading || !pin || !amount}\r\n              className={`flex-1 ${operationType === 'add' ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}`}\r\n            >\r\n              {isLoading ? (\r\n                <div className=\"flex items-center gap-2\">\r\n                  <div className=\"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin\" />\r\n                  جاري التحديث...\r\n                </div>\r\n              ) : (\r\n                <>\r\n                  <Lock className=\"h-4 w-4 mr-2\" />\r\n                  {operationType === 'add' ? 'إضافة المبلغ' : 'خصم المبلغ'}\r\n                </>\r\n              )}\r\n            </Button>\r\n          </div>\r\n        </form>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}"],"names":["AddToWalletDialog","open","onOpenChange","onSuccess","title","description","currentBalance","balanceLabel","userId","pin","setPin","useState","amount","setAmount","operationType","setOperationType","showPin","setShowPin","error","setError","isLoading","setIsLoading","hasMasterPin","setHasMasterPin","useEffect","mounted","has","MasterPinService","handleSubmit","e","amountValue","finalAmount","handleClose","getNewBalance","jsx","Dialog","DialogContent","DialogHeader","jsxs","DialogTitle","Plus","Minus","Label","Button","Input","EyeOff","Eye","AlertCircle","Fragment","Lock"],"mappings":"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"}