import{a0 as Re,c as _e,u as Me,ag as ze,ah as $e,ai as ae,r as a,j as e,B as H,aj as Ue,ak as Ve,w as De,I as N,T as Ke,af as ne,y as ie,i as re,al as Je,O as He,J as Xe,z as qe,am as Te,P as Ge,a as Qe,an as Ie}from"./index-BN0752Qr.js";import{C as S,a as D,b as T,d as I}from"./card-DVUXmIdS.js";import{B as Ye}from"./badge-BWTxsXDh.js";import{S as le,a as oe,b as ce,c as de,d as x}from"./select-DjC0EQBT.js";import{M as Ze}from"./MasterPinDialog-VHlDGLlu.js";import{ProfitService as We}from"./profitService-Dt6LKUWS.js";import{D as Ce}from"./dollar-sign-DUPscho4.js";import{W as et}from"./wallet-D5TJUJXW.js";import{C as tt}from"./circle-check-big-B4Ee5e7u.js";import{C as st}from"./circle-x-5x6tiK46.js";import"./label-DIwIXbCl.js";import"./circle-alert-BhVKXFXv.js";const at=()=>{const j=Re(),{toast:h}=_e(),{signOut:X,user:i,profile:f}=Me(),{isShiftActive:ke,shiftUser:me}=ze(),W=$e(),q=(typeof ae<"u"&&typeof ae.getPlatform=="function"?ae.getPlatform():"web")==="android"||/Android/i.test(typeof navigator<"u"?navigator.userAgent:""),[d,C]=a.useState("01030302038"),[G,he]=a.useState(""),[m,Q]=a.useState(""),[k,R]=a.useState(""),[p,ue]=a.useState("transfer"),[Y,xe]=a.useState("vodafone_cash"),[Z,pe]=a.useState("vodafone_cash"),[B,ee]=a.useState(""),[g,_]=a.useState([]),[nt,it]=a.useState("all"),[rt,lt]=a.useState(!1),[fe,ot]=a.useState(""),[M,ct]=a.useState([]),[dt,mt]=a.useState(null),[ht,ut]=a.useState(!1),[xt,pt]=a.useState([]),[ft,gt]=a.useState([]),[bt,jt]=a.useState(!1),[vt,yt]=a.useState("daily"),[wt,E]=a.useState([]),[te,v]=a.useState(0),[y,w]=a.useState({}),[Nt,St]=a.useState(!1),[Dt,Tt]=a.useState(!1),[It,Wt]=a.useState(!1),[Ct,kt]=a.useState(!1),[Bt,Et]=a.useState(!1),[Pt,At]=a.useState(""),[Ot,Ft]=a.useState(!1),[Be,se]=a.useState(!1),[z,ge]=a.useState(()=>{try{const t=i!=null&&i.uid?`dailyReportsLockEnabled_${i==null?void 0:i.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[Ee,$]=a.useState(!1),[Pe,Ae]=a.useState(!1),o=t=>{const s="٠١٢٣٤٥٦٧٨٩",n="۰۱۲۳۴۵۶۷۸۹";return(t||"").split("").map(l=>{const r=s.indexOf(l);if(r>-1)return String(r);const c=n.indexOf(l);return c>-1?String(c):l}).join("")},be=t=>{const s=o(t).replace(/\D/g,"");return s.startsWith("010")?"vodafone_cash":s.startsWith("011")?"etisalat_cash":s.startsWith("012")?"orange_cash":null};a.useEffect(()=>{const t=be(d);t&&t!==Y&&xe(t)},[d]),a.useEffect(()=>{const t=be(m);t&&t!==Z&&pe(t)},[m]),a.useEffect(()=>{try{const t=i!=null&&i.uid?`dailyReportsLockEnabled_${i==null?void 0:i.uid}`:"dailyReportsLockEnabled",s=localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled");ge(s==="true")}catch{}},[i==null?void 0:i.uid]),a.useEffect(()=>{const t=j.state||{};t!=null&&t.openTransactionSection&&(((t==null?void 0:t.transactionType)==="withdraw"||(t==null?void 0:t.transactionType)==="transfer")&&ue(t.transactionType),Ae(!0),t!=null&&t.startNewTransaction&&(C("01030302038"),Q(""),R(""),ee("")),setTimeout(()=>{window.scrollTo({top:0,behavior:"smooth"})},50))},[j.state]);const U=async t=>{if(i)try{const s=await ne.getById(i.uid);if(s!=null&&s.shopId){const n=ie(re,"dashboardData",s.shopId);await Ge(n,t)}}catch(s){console.error("Error saving to Firebase:",s),h({title:"خطأ في الحفظ",description:"حدث خطأ أثناء حفظ البيانات في Firebase",variant:"destructive"})}};a.useEffect(()=>{if(!i)return;(async()=>{se(!0);try{const s=await ne.getById(i.uid);if(s!=null&&s.shopId){const n=ie(re,"dashboardData",s.shopId);try{const r=await Je(n);if(r.exists()){const c=r.data();v(c.cashBalance||0),w(c.walletBalances||{}),E(c.deletedTransactions||[]),se(!1)}}catch{}const l=await He(n);if(l.exists()){const r=l.data();v(r.cashBalance||0),w(r.walletBalances||{}),E(r.deletedTransactions||[])}else{const r={walletBalances:{},deletedTransactions:[]};await Xe(n,r),v(0),w(r.walletBalances),E(r.deletedTransactions)}}}catch(s){console.error("Error loading data from Firebase:",s),v(0),w({}),E([])}finally{se(!1)}})()},[i]),a.useEffect(()=>{if(!i)return;let t=null;return(async()=>{try{const n=await ne.getById(i.uid);if(n!=null&&n.shopId){const l=ie(re,"dashboardData",n.shopId);t=qe(l,{includeMetadataChanges:!0},r=>{if(r.exists()){const c=r.data();v(c.cashBalance||0),w(c.walletBalances||{}),E(c.deletedTransactions||[])}},r=>{console.error("Error subscribing to dashboardData:",r)})}}catch(n){console.error("Error initializing realtime dashboard subscription:",n)}})(),()=>{t&&t()}},[i==null?void 0:i.uid]);const Oe=async t=>{if(t.preventDefault(),p==="transfer"){if(!d||!m||!k){h({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}const s=(f==null?void 0:f.shopName)||(i==null?void 0:i.displayName)||"محل كاشي لينك",n=M.find(J=>J.id===fe)||M.find(J=>J.isDefault),l=o(d||"").replace(/\D/g,""),r=o(m||"").replace(/\D/g,""),c=Y===Z,P=l.startsWith("010")&&(r.startsWith("011")||r.startsWith("012")||r.startsWith("015"))||l.startsWith("012")&&r.startsWith("010")||l.startsWith("011")&&r.startsWith("010")||l.startsWith("015")&&r.startsWith("010"),u=c?B&&B.trim()!==""?parseFloat(B):1:P?parseFloat(B||"0"):0;if(P&&(Number.isNaN(u)||u<=0)){h({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"});return}if(!n){h({title:"لا توجد محفظة",description:"يرجى اختيار محفظة لإتمام التحويل",variant:"destructive"});return}const b=parseFloat(k),A=b+u,V=y[n.id]||0;if(V<A){h({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${V} لا يكفي لخصم ${A}`,variant:"destructive"});return}const O=Te(b,"send"),F={id:Date.now().toString(),type:"send",senderPhone:d,receiverPhone:m,amount:b,status:"pending",createdAt:new Date,withdrawnAmount:0,sentAmount:b,merchantShopName:s,shopName:(n==null?void 0:n.name)||"المحفظة الرئيسية",commission:O,fee:u,fromWallet:n.id},je=[F,...g];_(je);const Fe=b+u,K=n==null?void 0:n.id,Le=K&&y[K]||0,ve=K?{...y,[K]:Le-Fe}:y;w(ve),await U({transactions:je,walletBalances:ve}),h({title:"تم إرسال التحويل",description:"جاري معالجة التحويل..."}),setTimeout(async()=>{const ye=[{...F,status:"completed"},...g];_(ye);const we=u,Ne=Math.max(0,O)+(Number.isFinite(we)?we:0),Se=te+Ne;v(Se),await U({transactions:ye,cashBalance:Se}),We.addProfit(Ne)},2e3),C("01030302038"),Q(""),R(""),ee("")}else if(p==="withdraw"){if(!d||!k){h({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}const s=(f==null?void 0:f.shopName)||(i==null?void 0:i.displayName)||"محل كاشي لينك",n=M.find(u=>u.id===fe)||M.find(u=>u.isDefault);if(!n){h({title:"لا توجد محفظة",description:"يرجى اختيار محفظة لإتمام السحب",variant:"destructive"});return}const l=parseFloat(k);if(!Number.isFinite(l)||l<=0){h({title:"خطأ",description:"أدخل مبلغًا صحيحًا للسحب",variant:"destructive"});return}const r=Te(l,"receive"),c={id:Date.now().toString(),type:"withdraw",senderPhone:d,receiverPhone:"",amount:l,status:"pending",createdAt:new Date,withdrawnAmount:l,sentAmount:0,merchantShopName:s,shopName:(n==null?void 0:n.name)||"المحفظة الرئيسية",commission:r,fromWallet:n.id,senderName:G||void 0},P=[c,...g];_(P),await U({transactions:P}),h({title:"تم إنشاء عملية السحب",description:"جاري معالجة السحب..."}),setTimeout(async()=>{const b=[{...c,status:"completed"},...g];_(b);const A=n.id,V=y[A]||0,O={...y,[A]:V+l};w(O);const F=te-l+Math.max(0,r);v(F),await U({transactions:b,walletBalances:O,cashBalance:F}),We.addProfit(Math.max(0,r))},2e3),C("01030302038"),R("")}};return e.jsxs("div",{className:"min-h-screen bg-background p-4",children:[Be&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-center",children:"جاري تحميل البيانات..."})]})}),e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"لوحة تحكم الإدارة"}),e.jsxs(H,{onClick:X,variant:"outline",className:"flex items-center gap-2",children:[e.jsx(Ue,{className:"h-4 w-4"}),"تسجيل الخروج"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsxs(S,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(T,{className:"text-sm font-medium",children:"الرصيد النقدي"}),e.jsx(Ce,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(I,{children:e.jsxs("div",{className:"text-2xl font-bold",children:[te.toLocaleString()," جنيه"]})})]}),e.jsxs(S,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(T,{className:"text-sm font-medium",children:"الأرصدة علي المحافظ"}),e.jsx(et,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(I,{children:e.jsxs("div",{className:"text-2xl font-bold",children:[Object.values(y).reduce((t,s)=>t+s,0).toLocaleString()," جنيه"]})})]}),e.jsxs(S,{className:"relative",children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(T,{className:"text-sm font-medium",children:"المعاملات اليوم"}),e.jsx(Ve,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(I,{className:z?"filter blur-sm pointer-events-none":"",children:e.jsx("div",{className:"text-2xl font-bold",children:g.length})}),z&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(H,{size:"sm",variant:"ghost",onClick:()=>$(!0),className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير اليوم",children:[e.jsx(De,{className:"h-5 w-5"}),e.jsx("span",{className:"text-xs",children:"عرض تقارير اليوم"})]})})]}),e.jsxs(S,{className:"relative",children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(T,{className:"text-sm font-medium",children:"إجمالي اليوم"}),e.jsx(Ce,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(I,{className:z?"filter blur-sm pointer-events-none":"",children:e.jsxs("div",{className:"text-2xl font-bold",children:[g.reduce((t,s)=>t+s.amount,0).toLocaleString()," جنيه"]})}),z&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(H,{size:"sm",variant:"ghost",onClick:()=>$(!0),className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير اليوم",children:[e.jsx(De,{className:"h-5 w-5"}),e.jsx("span",{className:"text-xs",children:"عرض تقارير اليوم"})]})})]}),e.jsx(Ze,{open:Ee,onOpenChange:$,mode:"verify",title:"قفل تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{ge(!1),$(!1)}})]}),e.jsxs(S,{className:W&&Pe?"sticky top-0 z-40 shadow-lg bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/70":"",children:[e.jsx(D,{children:e.jsx(T,{children:"إجراء معاملة جديدة"})}),e.jsx(I,{children:e.jsxs("form",{onSubmit:Oe,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"نوع المعاملة"}),e.jsxs(le,{value:p,onValueChange:t=>ue(t),children:[e.jsx(oe,{children:e.jsx(ce,{})}),e.jsxs(de,{children:[e.jsx(x,{value:"transfer",children:"تحويل"}),e.jsx(x,{value:"withdraw",children:"سحب"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رقم المرسل"}),e.jsx(N,{type:"tel",value:d,onChange:t=>C(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const s=document.getElementById("receiverPhoneInput");if(s)s.focus();else{const n=document.getElementById("amountInput");n==null||n.focus()}}},placeholder:"01xxxxxxxxx"})]}),p==="transfer"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رقم المستقبل"}),e.jsx(N,{id:"receiverPhoneInput",type:"tel",value:m,onChange:t=>Q(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const s=document.getElementById("amountInput");s==null||s.focus()}},placeholder:"01xxxxxxxxx"})]}),p==="withdraw"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"اسم الراسل (اختياري)"}),e.jsx(N,{id:"senderNameInput",type:"text",value:G,onChange:t=>he(t.target.value),placeholder:"مثال: أحمد عبد الرحمن"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"شركة المرسل"}),e.jsxs(le,{value:Y,onValueChange:t=>xe(t),children:[e.jsx(oe,{children:e.jsx(ce,{})}),e.jsxs(de,{children:[e.jsx(x,{value:"vodafone_cash",children:"فودافون"}),e.jsx(x,{value:"etisalat_cash",children:"اتصالات"}),e.jsx(x,{value:"orange_cash",children:"أورانج"}),e.jsx(x,{value:"instapay",children:"إنستاباي"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"شركة المستقبل"}),e.jsxs(le,{value:Z,onValueChange:t=>pe(t),children:[e.jsx(oe,{children:e.jsx(ce,{})}),e.jsxs(de,{children:[e.jsx(x,{value:"vodafone_cash",children:"فودافون"}),e.jsx(x,{value:"etisalat_cash",children:"اتصالات"}),e.jsx(x,{value:"orange_cash",children:"أورانج"}),e.jsx(x,{value:"instapay",children:"إنستاباي"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"المبلغ"}),e.jsx(N,{id:"amountInput",type:"number",value:k,onChange:t=>R(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const s=document.getElementById("txSubmitButton");s==null||s.focus()}},placeholder:"0.00"})]}),p==="withdraw"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"اسم الراسل (اختياري)"}),e.jsx(N,{id:"senderNameInput",type:"text",value:G,onChange:t=>he(t.target.value),placeholder:"مثال: أحمد عبد الرحمن"})]}),p==="transfer"&&(o(d||"").replace(/\D/g,"").startsWith("010")&&o(m||"").replace(/\D/g,"").startsWith("010")||o(d||"").replace(/\D/g,"").startsWith("010")&&(o(m||"").replace(/\D/g,"").startsWith("011")||o(m||"").replace(/\D/g,"").startsWith("012")||o(m||"").replace(/\D/g,"").startsWith("015"))||o(d||"").replace(/\D/g,"").startsWith("012")&&o(m||"").replace(/\D/g,"").startsWith("010")||o(d||"").replace(/\D/g,"").startsWith("011")&&o(m||"").replace(/\D/g,"").startsWith("010")||o(d||"").replace(/\D/g,"").startsWith("015")&&o(m||"").replace(/\D/g,"").startsWith("010"))&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رسوم التحويل"}),e.jsx(N,{type:"number",value:B,onChange:t=>ee(t.target.value),placeholder:"0.00"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"تُخصم من المحفظة وتضاف للدرج"})]})]}),e.jsx(H,{id:"txSubmitButton",type:"submit",className:`w-full ${p==="transfer"?"btn-transfer-confirm":"btn-withdraw-confirm"}`,children:p==="transfer"?"إرسال التحويل":"تنفيذ السحب"})]})})]}),e.jsxs(S,{children:[e.jsx(D,{children:e.jsx(T,{children:"المعاملات الأخيرة"})}),e.jsx(I,{children:g.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"لا توجد معاملات حديثة."}):e.jsx("div",{className:W||q?"receipts-list space-y-4 max-h-[310px] overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400":"receipts-list space-y-4",children:g.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(tt,{className:`h-5 w-5 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(Ke,{className:"h-5 w-5 text-yellow-500"}),t.status==="failed"&&e.jsx(st,{className:"h-5 w-5 text-red-500"})]}),e.jsxs("div",{children:[e.jsxs("p",{className:`font-medium ${t.type==="send"?"text-green-700":"text-red-700"}`,children:[t.type==="send"?"تحويل":"سحب"," - ",t.amount.toLocaleString()," جنيه"]}),t.type==="send"?e.jsxs("p",{className:"text-sm text-green-600",children:["من ",t.senderPhone," إلى ",t.receiverPhone]}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-sm text-red-500",children:["من ",t.senderPhone]}),t.senderName&&e.jsxs("p",{className:"text-xs text-red-400",children:["اسم الراسل: ",t.senderName]})]})]})]}),e.jsx(Ye,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})})]})]})]})},qt=()=>{const j=Qe(),[h,X]=a.useState(!1),[i,f]=a.useState(!0);return a.useEffect(()=>{(()=>{const me=localStorage.getItem("dashboardAuth"),W=localStorage.getItem("dashboardUser");if(me==="true"&&W)try{const L=JSON.parse(W),q=new Date(L.loginTime);(new Date().getTime()-q.getTime())/(1e3*60*60)<24?X(!0):(localStorage.removeItem("dashboardAuth"),localStorage.removeItem("dashboardUser"),j("/dashboard/login"))}catch(L){console.error("Error parsing user data:",L),j("/dashboard/login")}else j("/dashboard/login");f(!1)})()},[j]),i?e.jsx(Ie,{}):h?e.jsx(at,{}):e.jsx(Ie,{})};export{qt as default};
//# sourceMappingURL=ProtectedDashboard-DCHGFSEr.js.map
