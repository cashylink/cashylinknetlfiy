const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-CHyvkdwe.js","./index-CF_cwj-9.css","./UserDashboardPage-8yy5stmd.js","./SimCardsAccessDialog-D6WUUhMa.js","./select-VBB5jzA0.js","./VideoModal-ChGRvXmu.js","./ProfileSettingsPage-fL_qYmdn.js","./switch-Ng20LGJl.js","./square-pen-Cud2vy-2.js","./textarea-ymmQWf49.js","./users-Qcw8yGaM.js","./dollar-sign-_wKHiNUd.js","./circle-check-big-uv2lkbPR.js","./save-C1HQozbU.js","./refresh-cw-Do-H4KwK.js","./crown-DiWo4O6v.js","./arrow-left-4i_BaYCY.js","./badge-C_UcFznF.js","./tabs-B0OQD0l8.js","./index-BZ_s4N2Q.js","./dropdown-menu-CZzBeEST.js","./ProfileIcon-DR9RBlJs.js","./freeTrialService-CSbqfZaj.js","./broadcastService-CIt5XDVt.js","./bell-BuLjh4AU.js","./profitService-Bwtuj4RF.js","./calendar-CvcoBvx3.js","./arrow-down-left-C-H_qrrL.js","./wallet-C8MuVqXX.js","./printer-tQRybv7D.js","./star-qDE6mYRi.js"])))=>i.map(i=>d[i]);
import{u as z,r as d,ab as Z,a as H,j as i,au as ee,V as F,t as J,aO as Q,ar as te,bb as ae,m as se,aX as K,b0 as E,aH as M,R as X}from"./index-CHyvkdwe.js";import{s as ie,E as re}from"./broadcastService-CIt5XDVt.js";import{L as ne}from"./link-7VAWoPr6.js";const L="dismissedBroadcastIds",oe=()=>{const{user:t,profile:e,isSubscriptionActive:o,userSubscription:l}=z(),[v,y]=d.useState(null),[a,D]=d.useState(!1),[P,x]=d.useState(!1),[k,w]=d.useState([]),S=Z(),j=H(),A=d.useMemo(()=>`dismissedBroadcastIds:${(t==null?void 0:t.uid)||"global"}`,[t==null?void 0:t.uid]),N=d.useMemo(()=>{const f=["global"];return e!=null&&e.shopId&&f.push(`shop:${e.shopId}`),t!=null&&t.uid&&f.push(`user:${t.uid}`),f},[e==null?void 0:e.shopId,t==null?void 0:t.uid]),_=S.pathname.startsWith("/admin");d.useEffect(()=>{if(!(t!=null&&t.uid))return;(async()=>{try{const h=F(J,"users",t.uid),r=await Q(()=>import("./index-CHyvkdwe.js").then(c=>c.cF),__vite__mapDeps([0,1]),import.meta.url).then(c=>c.getDoc(h));if(r.exists()){const c=r.data(),s=Array.isArray(c==null?void 0:c.dismissedBroadcastIds)?c.dismissedBroadcastIds:[];w(s);try{const m=localStorage.getItem(A),p=m?JSON.parse(m):[],u=Array.from(new Set([...Array.isArray(p)?p:[],...s]));localStorage.setItem(A,JSON.stringify(u)),localStorage.setItem(L,JSON.stringify(u))}catch{}}}catch(h){console.error("UserBroadcastModal: fetch user error",h)}})()},[t==null?void 0:t.uid,A]),d.useEffect(()=>{if(!t||_||!((e==null?void 0:e.approved)===!0||o||(l==null?void 0:l.isOnFreeTrial)===!0))return;const h=ie(N,r=>{if(r){y(r);try{const c=localStorage.getItem(A),s=localStorage.getItem(L),m=c?JSON.parse(c):[],p=s?JSON.parse(s):[],u=Array.isArray(m)?[...m]:[];if(Array.isArray(p))for(const n of p)u.includes(n)||u.push(n);if(Array.isArray(k))for(const n of k)u.includes(n)||u.push(n);const g=r.id&&u.includes(r.id);D(!g),x(!1),requestAnimationFrame(()=>x(!0))}catch{D(!0),x(!0)}}});return()=>h()},[t,N,_,e==null?void 0:e.approved,o,l,k]);const $=async()=>{D(!1);try{const f=localStorage.getItem(A),h=f?JSON.parse(f):[],r=v==null?void 0:v.id;if(r&&!h.includes(r)){h.push(r),localStorage.setItem(A,JSON.stringify(h));try{localStorage.setItem(L,JSON.stringify(h))}catch{}try{t!=null&&t.uid&&await te(F(J,"users",t.uid),{dismissedBroadcastIds:ae(r)})}catch(c){console.warn("UserBroadcastModal: failed to update dismissedBroadcastIds in Firestore",c)}}}catch{}};return!a||!v?null:i.jsxs("div",{className:"fixed inset-0 z-[9999]",children:[i.jsx("div",{className:`absolute inset-0 transition-opacity duration-300 ease-out ${P?"opacity-100":"opacity-0"} bg-black/20 dark:bg-black/20`}),i.jsxs("div",{className:`absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] sm:w-auto sm:min-w-[380px] sm:max-w-md md:max-w-lg bg-white shadow-2xl rounded-2xl border border-gray-100 ring-1 ring-black/5 transition-all duration-300 ease-out ${P?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:[i.jsx("div",{className:"relative overflow-hidden rounded-t-2xl",children:i.jsxs("div",{className:"bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 relative",children:[i.jsx("button",{"aria-label":"Ø¥ØºÙ„Ø§Ù‚",onClick:$,className:"absolute top-3 right-3 p-2 rounded-full bg-white/10 hover:bg-white/20",children:i.jsx(ee,{className:"w-5 h-5 text-white"})}),i.jsx("div",{className:"p-4",children:i.jsx("h3",{className:"text-base sm:text-lg font-semibold text-white tracking-wide text-center",children:v.title||"Ø¥Ø´Ø¹Ø§Ø±"})})]})}),i.jsx("div",{className:"p-5",children:i.jsxs("div",{className:"flex items-start justify-between gap-3",children:[i.jsx("p",{className:"text-gray-700 leading-relaxed text-sm sm:text-base",children:v.message}),v.linkUrl&&i.jsxs("button",{"aria-label":"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·",title:"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·",onClick:()=>{const f=v.linkUrl;/^https?:\/\//i.test(f)?window.open(f,"_blank","noopener"):j(f)},className:"shrink-0 inline-flex items-center gap-2 px-3 py-2 rounded-md bg-indigo-600 text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 whitespace-nowrap",children:[/^https?:\/\//i.test(v.linkUrl)?i.jsx(re,{className:"w-6 h-6"}):i.jsx(ne,{className:"w-6 h-6"}),i.jsx("span",{className:"text-xs sm:text-sm font-semibold",children:v.actionText||"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·"})]})]})})]})]})},q="quick_login_enabled",G="quick_login_session_verified";function Y(t){return t?`${q}_${t}`:q}function B(t){return t?`${G}_${t}`:G}const I={isEnabled(t){try{return localStorage.getItem(Y(t))==="true"}catch{return!1}},setEnabled(t,e){try{localStorage.setItem(Y(e),t?"true":"false"),sessionStorage.removeItem(B(e))}catch{}},isSessionVerified(t){try{return sessionStorage.getItem(B(t))==="true"}catch{return!1}},markSessionVerified(t){try{sessionStorage.setItem(B(t),"true")}catch{}}},ce=X.lazy(()=>Q(()=>import("./UserDashboardPage-8yy5stmd.js").then(t=>t.U),__vite__mapDeps([2,0,1,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30]),import.meta.url)),fe=()=>{var f,h;const t=H(),{user:e,profile:o,loading:l,refreshProfile:v,isSubscriptionActive:y,userSubscription:a,checkSubscriptionStatus:D}=z(),[P,x]=d.useState(!1),[k,w]=d.useState(!1);se();const[S,j]=d.useState(!1);d.useEffect(()=>{if(!(e!=null&&e.uid)||!a)return;const c=setInterval(()=>{var n,O,U,T,V;const s=a;if(!s)return;const m=new Date;let p=!1;if(s!=null&&s.isOnFreeTrial){const b=(n=s.freeTrialEndDate)!=null&&n.toDate?s.freeTrialEndDate.toDate():s.freeTrialEndDate?new Date(s.freeTrialEndDate):null;p=b&&m<b}let u=!1;if((O=s==null?void 0:s.subscription)!=null&&O.isActive){const b=(U=s.subscription.endDate)!=null&&U.toDate?s.subscription.endDate.toDate():s.subscription.endDate?new Date(s.subscription.endDate):null;u=!b||m<b}let g=!1;if(((T=s==null?void 0:s.branchPackage)==null?void 0:T.status)==="active"){const b=(V=s.branchPackage.endDate)!=null&&V.toDate?s.branchPackage.endDate.toDate():s.branchPackage.endDate?new Date(s.branchPackage.endDate):null;g=!b||m<b}!p&&!u&&!g&&(console.log("ProtectedUserDashboard: All access methods expired client-side."),t("/user/pending-approval"))},60*60*1e3);return()=>clearInterval(c)},[e==null?void 0:e.uid,a,t]),d.useEffect(()=>()=>{},[]),d.useEffect(()=>{var r;if(console.log("ProtectedUserDashboard - useEffect triggered",{loading:l,user:e?"exists":"null",profile:o?{role:o.role,approved:o.approved}:"null",isSubscriptionActive:y,userSubscription:a?"exists":"null"}),!l){if(!e)console.log("ProtectedUserDashboard - No user, redirecting to login"),t("/user/login");else if(o)if(console.log("ProtectedUserDashboard - Profile found:",{role:o.role,approved:o.approved,isSubscriptionActive:y,hasSubscription:!!(a!=null&&a.subscription)}),a){const c=((r=a==null?void 0:a.branchPackage)==null?void 0:r.status)==="active",s=(a==null?void 0:a.isOnFreeTrial)===!0;if(!(!!y||s)&&!c){try{t("/user/pending-approval",{replace:!0})}catch{}return}o.role==="user"&&x(!0);const u=I.isEnabled(e==null?void 0:e.uid),g=I.isSessionVerified(e==null?void 0:e.uid);if(u&&!g){try{I.markSessionVerified(e==null?void 0:e.uid)}catch{}w(!1),x(!0)}else x(!0)}else{try{D()}catch{}return}}},[e,o,l,t,y,a]),d.useEffect(()=>{let r=null;return!l&&e?j(!0):e&&(r=setTimeout(()=>j(!0),3e3)),()=>{try{clearTimeout(r)}catch{}}},[l,e]),d.useEffect(()=>{var u;if(l||!e||!S||!a)return;const r=(a==null?void 0:a.isActive)!==!1,c=((u=a==null?void 0:a.branchPackage)==null?void 0:u.status)==="active",s=(a==null?void 0:a.isOnFreeTrial)===!0,m=!!y||s,p=g=>{var R,C;if(!g)return"null";const n=g.subscription,O=n!=null&&n.activatedAt?n.activatedAt.toDate?n.activatedAt.toDate().toISOString():new Date(n.activatedAt).toISOString():"null",U=(n==null?void 0:n.planType)||"null",T=g.isActive!==!1,V=(n==null?void 0:n.isActive)===!0,b=((R=g.branchPackage)==null?void 0:R.status)==="active",W=(C=g.branchPackage)!=null&&C.activatedAt?g.branchPackage.activatedAt.toDate?g.branchPackage.activatedAt.toDate().toISOString():new Date(g.branchPackage.activatedAt).toISOString():"null";return`${T}|${V}|${U}|${O}|${b}|${W}`};if(!r){console.log("â›” ProtectedUserDashboard: Account is deactivated, redirecting to pending approval");try{sessionStorage.setItem("dashboard_kick_signature",p(a)),t("/user/pending-approval",{replace:!0})}catch{}return}if(!m&&!c)try{sessionStorage.setItem("dashboard_kick_signature",p(a)),t("/user/pending-approval")}catch{}},[l,e,a,y,t,S]),d.useEffect(()=>{},[l,e,a,y,D,t,S]);const A=typeof window<"u"&&(window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:");if((f=K)!=null&&f.isNativePlatform&&K.getPlatform(),l&&(A||!e))return i.jsx(E,{});if(!S)return i.jsx(E,{});if(e&&!l&&!a)return i.jsx(E,{});const N=(a==null?void 0:a.isOnFreeTrial)===!0,_=((h=a==null?void 0:a.branchPackage)==null?void 0:h.status)==="active";return e&&!l&&a&&!(!!y||N||_)?i.jsx(E,{}):P?(console.log("ProtectedUserDashboard - Render state:",{isAuthenticated:P,profileRole:o==null?void 0:o.role,profileApproved:o==null?void 0:o.approved,isSubscriptionActive:y,hasSubscription:!!(a!=null&&a.subscription)}),console.log("ðŸ”¥ ProtectedUserDashboard - user:",e?{uid:e.uid,email:e.email}:"null"),console.log("ðŸ”¥ ProtectedUserDashboard - profile:",o?{userId:o.userId,role:o.role}:"null"),console.log("ðŸ”¥ ProtectedUserDashboard - loading:",l),console.log("ðŸ”¥ ProtectedUserDashboard - About to render UserDashboardPage"),i.jsxs("div",{className:"relative",children:[i.jsx(X.Suspense,{fallback:i.jsx(E,{}),children:i.jsx(ce,{})}),i.jsx(oe,{}),i.jsx(M,{open:k,onOpenChange:r=>w(r),mode:"verify",title:"Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹",description:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",onSuccess:()=>{I.markSessionVerified(e==null?void 0:e.uid),w(!1),x(!0)}})]})):i.jsxs(i.Fragment,{children:[i.jsx(E,{}),i.jsx(M,{open:k,onOpenChange:r=>w(r),mode:"verify",title:"Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹",description:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",onSuccess:()=>{I.markSessionVerified(e==null?void 0:e.uid),w(!1),x(!0)}})]})};export{fe as default};
//# sourceMappingURL=ProtectedUserDashboard-DQnGVB29.js.map
