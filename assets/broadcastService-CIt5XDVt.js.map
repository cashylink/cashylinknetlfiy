{"version":3,"mappings":"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","names":["__iconNode","ExternalLink","createLucideIcon","publishBroadcast","title","message","audienceKey","createdBy","linkUrl","actionText","payload","serverTimestamp","addDoc","collection","db","fetchActiveBroadcasts","audienceKeys","getDocs","__vitePreload","getDocs2","promises","key","q","query","where","snapshots","allActive","snap","doc","data","a","b","ta","_a","tb","_b","error","subscribeToActiveBroadcasts","cb","subscribeToActiveBroadcastsList","cache","unsubscribers","updateAndEmit","allDocs","items","item","unsubscribe","onSnapshot","snapshot","unsub"],"ignoreList":[0],"sources":["../../node_modules/lucide-react/dist/esm/icons/external-link.js","../../src/utils/broadcastService.ts"],"sourcesContent":["/**\n * @license lucide-react v0.561.0 - ISC\n *\n * This source code is licensed under the ISC license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createLucideIcon from '../createLucideIcon.js';\n\nconst __iconNode = [\n  [\"path\", { d: \"M15 3h6v6\", key: \"1q9fwt\" }],\n  [\"path\", { d: \"M10 14 21 3\", key: \"gplh6r\" }],\n  [\"path\", { d: \"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6\", key: \"a6xqqp\" }]\n];\nconst ExternalLink = createLucideIcon(\"external-link\", __iconNode);\n\nexport { __iconNode, ExternalLink as default };\n//# sourceMappingURL=external-link.js.map\n","import { db } from '@/firebase';\r\nimport { addDoc, collection, serverTimestamp, query, where, updateDoc, doc, getDocs, onSnapshot } from 'firebase/firestore';\r\n\r\nexport type Broadcast = {\r\n  id?: string;\r\n  title: string;\r\n  message: string;\r\n  audienceKey: string; // 'global' أو 'shop:<shopId>'\r\n  active: boolean;\r\n  createdAt?: any;\r\n  createdBy?: string;\r\n  linkUrl?: string;\r\n  actionText?: string;\r\n};\r\n\r\nexport async function publishBroadcast({ title, message, audienceKey, createdBy, linkUrl, actionText }: { title: string; message: string; audienceKey: string; createdBy?: string; linkUrl?: string; actionText?: string; }) {\r\n  const payload: Broadcast = {\r\n    title,\r\n    message,\r\n    audienceKey,\r\n    active: true,\r\n    createdAt: serverTimestamp(),\r\n    createdBy: createdBy || null as any,\r\n    linkUrl: linkUrl || undefined,\r\n    actionText: actionText || undefined,\r\n  };\r\n  const ref = await addDoc(collection(db, 'broadcasts'), payload as any);\r\n  return ref.id;\r\n}\r\n\r\nexport async function fetchActiveBroadcasts(audienceKeys: string[]): Promise<Broadcast | null> {\r\n  try {\r\n    const { getDocs } = await import('firebase/firestore');\r\n    const promises = audienceKeys.map(key => {\r\n      const q = query(collection(db, 'broadcasts'), where('audienceKey', '==', key));\r\n      return getDocs(q);\r\n    });\r\n\r\n    const snapshots = await Promise.all(promises);\r\n    const allActive: Broadcast[] = [];\r\n\r\n    snapshots.forEach(snap => {\r\n      snap.forEach(doc => {\r\n        const data = doc.data() as Broadcast;\r\n        if (data.active) {\r\n          allActive.push({ ...data, id: doc.id });\r\n        }\r\n      });\r\n    });\r\n\r\n    if (allActive.length === 0) return null;\r\n\r\n    // ترتيب حسب createdAt (الأحدث أولاً)\r\n    allActive.sort((a, b) => {\r\n      const ta = typeof a.createdAt?.toMillis === 'function' ? a.createdAt.toMillis() : 0;\r\n      const tb = typeof b.createdAt?.toMillis === 'function' ? b.createdAt.toMillis() : 0;\r\n      return ta - tb;\r\n    });\r\n\r\n    return allActive[allActive.length - 1]; // إرجاع الأحدث\r\n  } catch (error) {\r\n    console.error('fetchActiveBroadcasts error:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport function subscribeToActiveBroadcasts(audienceKeys: string[], cb: (b: Broadcast | null) => void) {\r\n  // تم تحويلها لاستخدام الجلب مرة واحدة بدلاً من الاستماع المستمر لتوفير القراءات\r\n  fetchActiveBroadcasts(audienceKeys).then(cb);\r\n  return () => {};\r\n}\r\n\r\nexport async function fetchActiveBroadcastsList(audienceKeys: string[]): Promise<Broadcast[]> {\r\n  try {\r\n    const { getDocs } = await import('firebase/firestore');\r\n    const promises = audienceKeys.map(key => {\r\n      const q = query(collection(db, 'broadcasts'), where('audienceKey', '==', key));\r\n      return getDocs(q);\r\n    });\r\n\r\n    const snapshots = await Promise.all(promises);\r\n    const docsMap = new Map<string, Broadcast>();\r\n\r\n    snapshots.forEach(snap => {\r\n      snap.forEach(doc => {\r\n        const data = doc.data() as Broadcast;\r\n        if (data.active) {\r\n          docsMap.set(doc.id, { ...data, id: doc.id });\r\n        }\r\n      });\r\n    });\r\n\r\n    const allActive = Array.from(docsMap.values());\r\n    return allActive.sort((a, b) => {\r\n      const ta = typeof a.createdAt?.toMillis === 'function' ? a.createdAt.toMillis() : 0;\r\n      const tb = typeof b.createdAt?.toMillis === 'function' ? b.createdAt.toMillis() : 0;\r\n      return tb - ta; // الأحدث أولاً\r\n    });\r\n  } catch (error) {\r\n    console.error('fetchActiveBroadcastsList error:', error);\r\n    return [];\r\n  }\r\n}\r\n\r\nexport function subscribeToActiveBroadcastsList(audienceKeys: string[], cb: (list: Broadcast[]) => void) {\r\n  // Re-enabled real-time listening as requested to ensure notifications appear on Web/PC immediately\r\n  // when they arrive on Android (synced via Firestore).\r\n  \r\n  const cache = new Map<string, Broadcast[]>();\r\n  const unsubscribers: (() => void)[] = [];\r\n\r\n  const updateAndEmit = () => {\r\n    const allDocs = new Map<string, Broadcast>();\r\n    \r\n    // Merge all lists from different audience keys\r\n    cache.forEach((items) => {\r\n      items.forEach(item => {\r\n        if (item.id) allDocs.set(item.id, item);\r\n      });\r\n    });\r\n\r\n    const allActive = Array.from(allDocs.values());\r\n    // Sort by createdAt desc\r\n    allActive.sort((a, b) => {\r\n      const ta = typeof a.createdAt?.toMillis === 'function' ? a.createdAt.toMillis() : 0;\r\n      const tb = typeof b.createdAt?.toMillis === 'function' ? b.createdAt.toMillis() : 0;\r\n      return tb - ta;\r\n    });\r\n\r\n    cb(allActive);\r\n  };\r\n\r\n  audienceKeys.forEach(key => {\r\n    const q = query(collection(db, 'broadcasts'), where('audienceKey', '==', key));\r\n    const unsubscribe = onSnapshot(q, (snapshot) => {\r\n      const items: Broadcast[] = [];\r\n      snapshot.forEach(doc => {\r\n        const data = doc.data() as Broadcast;\r\n        if (data.active) {\r\n          items.push({ ...data, id: doc.id });\r\n        }\r\n      });\r\n      cache.set(key, items);\r\n      updateAndEmit();\r\n    }, (error) => {\r\n      console.error(`Error in broadcast subscription for key ${key}:`, error);\r\n    });\r\n    unsubscribers.push(unsubscribe);\r\n  });\r\n\r\n  return () => {\r\n    unsubscribers.forEach(unsub => unsub());\r\n  };\r\n}\r\n\r\nexport async function deactivateBroadcast(id: string) {\r\n  await updateDoc(doc(db, 'broadcasts', id), { active: false });\r\n}"],"file":"assets/broadcastService-CIt5XDVt.js"}