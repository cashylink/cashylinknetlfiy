const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./dailyOperationCountService-9b-RCNij.js","./index-DKHjTn06.js","./index-VBQ-m3Jj.css","./walletDailyLimitsService-DdjjL_Zn.js","./profitService-DRDD-Fph.js"])))=>i.map(i=>d[i]);
import{J as Lt,r as p,a6 as Ps,j as t,a0 as ks,a2 as Es,a3 as Le,a4 as Ge,aO as Os,T as Je,u as _t,a8 as St,B as S,w as Rt,W as ke,X as Ee,Y as Oe,Z as Ie,Q as Ye,S as X,at as qe,aP as j,a as Is,R as pe,aQ as Ls,ag as _s,y as J,i as O,z as se,q as G,h as q,au as W,a9 as U,k as ne,aR as Ms,o as Ws,aS as he,$ as Bs,af as He,K as ie,I as Xe,aT as Fs,as as Pt,aU as Us,aV as zs,f as Ke,aC as $s,aW as kt,ae as H,O as Se}from"./index-DKHjTn06.js";import{C as Vs,a as Gs,b as qs,d as Hs}from"./card-CdZ89wHA.js";import{u as Xs,S as Ks,a as Ys,b as Zs,c as Js,d as Re}from"./select-CNUPPz9r.js";import{B as Pe}from"./badge-dOZ4uC2s.js";import{c as Mt,R as Qs,I as ea}from"./index-DyzQfDCv.js";import{A as Et,a as Ot,C as ta,b as sa,f as z,M as aa,c as ra,R as na,I as ia}from"./MaintenanceDialog-BuCRnuhC.js";import{M as Ze,P as oa}from"./MasterPinDialog-CZFMuEah.js";import{ProfitService as xe}from"./profitService-DRDD-Fph.js";import{D as la}from"./dollar-sign-CpfSiT3v.js";import{C as Wt}from"./calendar-n6d7WDHa.js";import{A as ca}from"./arrow-left-Dg0WTfXV.js";import{S as da}from"./separator-hqlx8nZp.js";import{T as It}from"./progress-CZUZSHBo.js";import{C as ma}from"./circle-x-DCthG7Az.js";import{C as ua}from"./circle-check-big-zx-PzrIn.js";import"./whatsappService-Ch9FyFNb.js";import"./download-C6bsx04M.js";import"./label-xK2gNCpt.js";import"./circle-alert--64_gie4.js";import"./shield-BpPPeTvJ.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pa=Lt("BatteryCharging",[["path",{d:"M15 7h1a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-2",key:"1sdynx"}],["path",{d:"M6 7H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h1",key:"1gkd3k"}],["path",{d:"m11 7-3 5h4l-3 5",key:"b4a64w"}],["line",{x1:"22",x2:"22",y1:"11",y2:"13",key:"4dh1rd"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ha=Lt("CirclePlay",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polygon",{points:"10 8 16 12 10 16 10 8",key:"1cimsy"}]]);var _e="Tabs",[xa]=ks(_e,[Mt]),Bt=Mt(),[fa,Qe]=xa(_e),Ft=p.forwardRef((v,a)=>{const{__scopeTabs:y,value:f,onValueChange:E,defaultValue:I,orientation:P="horizontal",dir:$,activationMode:_="automatic",...k}=v,T=Xs($),[D,B]=Ps({prop:f,onChange:E,defaultProp:I??"",caller:_e});return t.jsx(fa,{scope:y,baseId:Es(),value:D,onValueChange:B,orientation:P,dir:T,activationMode:_,children:t.jsx(Le.div,{dir:T,"data-orientation":P,...k,ref:a})})});Ft.displayName=_e;var Ut="TabsList",zt=p.forwardRef((v,a)=>{const{__scopeTabs:y,loop:f=!0,...E}=v,I=Qe(Ut,y),P=Bt(y);return t.jsx(Qs,{asChild:!0,...P,orientation:I.orientation,dir:I.dir,loop:f,children:t.jsx(Le.div,{role:"tablist","aria-orientation":I.orientation,...E,ref:a})})});zt.displayName=Ut;var $t="TabsTrigger",Vt=p.forwardRef((v,a)=>{const{__scopeTabs:y,value:f,disabled:E=!1,...I}=v,P=Qe($t,y),$=Bt(y),_=Ht(P.baseId,f),k=Xt(P.baseId,f),T=f===P.value;return t.jsx(ea,{asChild:!0,...$,focusable:!E,active:T,children:t.jsx(Le.button,{type:"button",role:"tab","aria-selected":T,"aria-controls":k,"data-state":T?"active":"inactive","data-disabled":E?"":void 0,disabled:E,id:_,...I,ref:a,onMouseDown:Ge(v.onMouseDown,D=>{!E&&D.button===0&&D.ctrlKey===!1?P.onValueChange(f):D.preventDefault()}),onKeyDown:Ge(v.onKeyDown,D=>{[" ","Enter"].includes(D.key)&&P.onValueChange(f)}),onFocus:Ge(v.onFocus,()=>{const D=P.activationMode!=="manual";!T&&!E&&D&&P.onValueChange(f)})})})});Vt.displayName=$t;var Gt="TabsContent",qt=p.forwardRef((v,a)=>{const{__scopeTabs:y,value:f,forceMount:E,children:I,...P}=v,$=Qe(Gt,y),_=Ht($.baseId,f),k=Xt($.baseId,f),T=f===$.value,D=p.useRef(T);return p.useEffect(()=>{const B=requestAnimationFrame(()=>D.current=!1);return()=>cancelAnimationFrame(B)},[]),t.jsx(Os,{present:E||T,children:({present:B})=>t.jsx(Le.div,{"data-state":T?"active":"inactive","data-orientation":$.orientation,role:"tabpanel","aria-labelledby":_,hidden:!B,id:k,tabIndex:0,...P,ref:a,style:{...v.style,animationDuration:D.current?"0s":void 0},children:B&&I})})});qt.displayName=Gt;function Ht(v,a){return`${v}-trigger-${a}`}function Xt(v,a){return`${v}-content-${a}`}var ga=Ft,Kt=zt,Yt=Vt,Zt=qt;const ya=ga,Jt=p.forwardRef(({className:v,...a},y)=>t.jsx(Kt,{ref:y,className:Je("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",v),...a}));Jt.displayName=Kt.displayName;const fe=p.forwardRef(({className:v,...a},y)=>t.jsx(Yt,{ref:y,className:Je("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",v),...a}));fe.displayName=Yt.displayName;const ge=p.forwardRef(({className:v,...a},y)=>t.jsx(Zt,{ref:y,className:Je("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",v),...a}));ge.displayName=Zt.displayName;const ba=({userId:v,transactions:a=[]})=>{const[y,f]=p.useState(!1),[E,I]=p.useState(!1),[P,$]=p.useState(!1),[_,k]=p.useState({dailyWithdraw:0,dailyTransfer:0,monthlyWithdraw:0,monthlyTransfer:0,lastUpdated:new Date}),{userSubscription:T}=_t();p.useEffect(()=>{v&&y&&P&&Me()},[v,y,P]);const D=w=>`${w.toFixed(2)} ج.م`,B=async()=>{try{const w=(T==null?void 0:T.subscription)||null,g=(w==null?void 0:w.planType)??(w==null?void 0:w.plan)??null,C=typeof g=="string"?g.toLowerCase():null;if(g===X.ZERO||C==="zero"||C==="0"||g===0)return!0}catch{}try{if(v){const w=await qe(v),g=(w==null?void 0:w.planType)??(w==null?void 0:w.plan)??null,C=typeof g=="string"?g.toLowerCase():null;if(g===X.ZERO||C==="zero"||C==="0"||g===0)return!0}}catch{}return!1},oe=async()=>{try{const w=await(async()=>{try{const g=(T==null?void 0:T.subscription)||null,C=(g==null?void 0:g.planType)??(g==null?void 0:g.plan)??null,V=typeof C=="string"?C.toLowerCase():null;if(C===X.TAHWEELA||V==="tahweela")return!0}catch{}try{if(v){const g=await qe(v),C=(g==null?void 0:g.planType)??(g==null?void 0:g.plan)??null,V=typeof C=="string"?C.toLowerCase():null;if(C===X.TAHWEELA||V==="tahweela")return!0}}catch{}return!1})();if(await B()||w){j({title:"غير متاح لاشتراكك",description:"عرض إجمالي الأرباح غير متاح في هذه الخطة.",variant:"destructive"});return}}catch{}I(!0)},ae=async()=>{try{const w=await(async()=>{try{const g=(T==null?void 0:T.subscription)||null,C=(g==null?void 0:g.planType)??(g==null?void 0:g.plan)??null,V=typeof C=="string"?C.toLowerCase():null;if(C===X.TAHWEELA||V==="tahweela")return!0}catch{}try{if(v){const g=await qe(v),C=(g==null?void 0:g.planType)??(g==null?void 0:g.plan)??null,V=typeof C=="string"?C.toLowerCase():null;if(C===X.TAHWEELA||V==="tahweela")return!0}}catch{}return!1})();if(await B()||w){j({title:"غير متاح لاشتراكك",description:"عرض إجمالي الأرباح غير متاح في هذه الخطة.",variant:"destructive"}),I(!1);return}}catch{}$(!0),f(!0),I(!1)},Me=async()=>{if(v)try{if(Array.isArray(a)&&a.length>0){const g=new Date,C=g.getMonth(),V=g.getFullYear(),We=St.filterVisibleTransactions(a,"daily",v),Q=St.filterVisibleTransactions(a,"monthly",v);let le=0,Y=0,ye=0,Z=0;We.forEach(M=>{const ce=new Date(M.createdAt),K=String(M.status||"confirmed").toLowerCase();if(ce.toDateString()!==g.toDateString()||K!=="completed"&&K!=="confirmed"&&K!=="pending")return;const ee=(M.type||M.txnType||"").toLowerCase(),L={type:ee==="withdrawal"?"withdraw":ee,amount:Number(M.amount||0),commission:M.commission};L.type==="withdraw"?le+=xe.calculateProfitFromTransaction(L):(L.type==="send"||L.type==="receive"||L.type==="transfer")&&(Y+=xe.calculateProfitFromTransaction(L))}),Q.forEach(M=>{const ce=new Date(M.createdAt),K=String(M.status||"confirmed").toLowerCase();if(ce.getMonth()!==C||ce.getFullYear()!==V||K!=="completed"&&K!=="confirmed"&&K!=="pending")return;const ee=(M.type||M.txnType||"").toLowerCase(),L={type:ee==="withdrawal"?"withdraw":ee,amount:Number(M.amount||0),commission:M.commission};L.type==="withdraw"?ye+=xe.calculateProfitFromTransaction(L):(L.type==="send"||L.type==="receive"||L.type==="transfer")&&(Z+=xe.calculateProfitFromTransaction(L))}),k({dailyWithdraw:Math.round(le*100)/100,dailyTransfer:Math.round(Y*100)/100,monthlyWithdraw:Math.round(ye*100)/100,monthlyTransfer:Math.round(Z*100)/100,lastUpdated:new Date});return}const w=xe.getWithdrawTransferProfits(v);k({dailyWithdraw:w.dailyWithdrawProfit||0,dailyTransfer:w.dailyTransferProfit||0,monthlyWithdraw:w.monthlyWithdrawProfit||0,monthlyTransfer:w.monthlyTransferProfit||0,lastUpdated:new Date})}catch(w){console.error("Error loading total profits:",w)}};return t.jsxs(t.Fragment,{children:[t.jsx(S,{size:"sm",variant:"ghost",onClick:oe,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-purple-200 text-purple-700 hover:from-blue-200 hover:to-purple-300 hover:text-purple-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض إجمالي الأرباح",children:t.jsx(Rt,{className:"h-1.5 w-1.5"})}),t.jsx(ke,{open:y,onOpenChange:f,children:t.jsxs(Ee,{className:"max-w-[240px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[220px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[t.jsx(Oe,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:t.jsxs(Ie,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-1 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[t.jsx(la,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"إجمالي الأرباح (فوري)"]})}),t.jsxs("div",{className:"space-y-1 py-1 sm:space-y-2 sm:py-2",children:[t.jsxs("div",{className:"bg-blue-50 p-1 rounded border border-blue-200 sm:bg-gradient-to-r sm:from-blue-50 sm:to-blue-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Ye,{className:"h-2 w-2 text-blue-600"}),t.jsx("span",{className:"text-[10px] font-semibold text-blue-800",children:"يومي"})]}),t.jsx("span",{className:"text-[10px] font-bold text-blue-900",children:D((_.dailyWithdraw??0)+(_.dailyTransfer??0))})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-1",children:[t.jsxs("div",{className:"flex items-center justify-between bg-red-50 p-0.5 rounded border border-red-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Et,{className:"h-2 w-2 text-red-600"}),t.jsx("span",{className:"text-[10px] text-red-800",children:"سحب"})]}),t.jsx("span",{className:"text-[10px] font-bold text-red-700",children:D(_.dailyWithdraw)})]}),t.jsxs("div",{className:"flex items-center justify-between bg-green-50 p-0.5 rounded border border-green-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Ot,{className:"h-2 w-2 text-green-600"}),t.jsx("span",{className:"text-[10px] text-green-800",children:"تحويل"})]}),t.jsx("span",{className:"text-[10px] font-bold text-green-700",children:D(_.dailyTransfer)})]})]})]}),t.jsxs("div",{className:"bg-purple-50 p-1 rounded border border-purple-200 sm:bg-gradient-to-r sm:from-purple-50 sm:to-purple-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Wt,{className:"h-2 w-2 text-purple-600"}),t.jsx("span",{className:"text-[10px] font-semibold text-purple-800",children:"شهري"})]}),t.jsx("span",{className:"text-[10px] font-bold text-purple-900",children:D((_.monthlyWithdraw??0)+(_.monthlyTransfer??0))})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-1",children:[t.jsxs("div",{className:"flex items-center justify-between bg-red-50 p-0.5 rounded border border-red-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Et,{className:"h-2 w-2 text-red-600"}),t.jsx("span",{className:"text-[10px] text-red-800",children:"سحب"})]}),t.jsx("span",{className:"text-[10px] font-bold text-red-700",children:D(_.monthlyWithdraw)})]}),t.jsxs("div",{className:"flex items-center justify-between bg-blue-50 p-0.5 rounded border border-blue-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Ot,{className:"h-2 w-2 text-blue-600"}),t.jsx("span",{className:"text-[10px] text-blue-800",children:"تحويل"})]}),t.jsx("span",{className:"text-[10px] font-bold text-blue-700",children:D(_.monthlyTransfer)})]})]})]})]}),!P&&t.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:t.jsx(S,{size:"sm",variant:"ghost",onClick:()=>I(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:t.jsx(Rt,{className:"h-4 w-4"})})}),t.jsx("div",{className:"flex justify-center pt-1 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:t.jsx(S,{onClick:()=>f(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-4 py-1 rounded-xl text-xs sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),t.jsx(Ze,{open:E,onOpenChange:I,onSuccess:ae,description:"لا يمكن الاطلاع على إجمالي الأرباح إلا بإدخال الرقم السري الرئيسي"})]})},va=v=>t.jsx(ba,{...v}),Ga=()=>{var bt,vt,jt,wt,Nt,Tt,Ct,At,Dt;const v=Is(),{user:a,profile:y,userSubscription:f}=_t(),E=pe.useMemo(()=>{var r,i,n,s;const e=((r=f==null?void 0:f.subscription)==null?void 0:r.planType)??((i=f==null?void 0:f.subscription)==null?void 0:i.plan)??((n=y==null?void 0:y.subscription)==null?void 0:n.planType)??((s=y==null?void 0:y.subscription)==null?void 0:s.plan)??null;return e===X.ZERO||String(e).toLowerCase()==="zero"},[(bt=f==null?void 0:f.subscription)==null?void 0:bt.planType,(vt=f==null?void 0:f.subscription)==null?void 0:vt.plan,(jt=y==null?void 0:y.subscription)==null?void 0:jt.planType,(wt=y==null?void 0:y.subscription)==null?void 0:wt.plan]),I=pe.useMemo(()=>{var r,i,n,s;const e=((r=f==null?void 0:f.subscription)==null?void 0:r.planType)??((i=f==null?void 0:f.subscription)==null?void 0:i.plan)??((n=y==null?void 0:y.subscription)==null?void 0:n.planType)??((s=y==null?void 0:y.subscription)==null?void 0:s.plan)??null;return e===X.TAHWEELA||String(e).toLowerCase()==="tahweela"},[(Nt=f==null?void 0:f.subscription)==null?void 0:Nt.planType,(Tt=f==null?void 0:f.subscription)==null?void 0:Tt.plan,(Ct=y==null?void 0:y.subscription)==null?void 0:Ct.planType,(At=y==null?void 0:y.subscription)==null?void 0:At.plan]),{shopName:P}=Ls(),{isShiftActive:$,shiftUser:_}=_s(),[k,T]=p.useState([]),[D,B]=p.useState([]),[oe,ae]=p.useState(new Set),[Me,w]=p.useState(!1),[g,C]=p.useState(null),[V,We]=p.useState("all"),[Q,le]=p.useState(""),[Y,ye]=p.useState(""),[Z,M]=p.useState(""),[ce,K]=p.useState(!1),[ee,L]=p.useState(!1),[Qt,et]=p.useState(!1),[es,tt]=p.useState(!1),[st,at]=p.useState(""),[ts,rt]=p.useState("شرح التطبيق"),[ja,nt]=p.useState(null),[de,ss]=p.useState(null),[as,be]=p.useState(!1);pe.useEffect(()=>{var r;((r=f==null?void 0:f.subscription)==null?void 0:r.planType)===X.TAHWEELA&&(j({title:"غير متاح لاشتراكك",description:"صفحة المعاملات غير متاحة في باقة تحويله. استخدم لوحة المستخدم للتحويل/السحب فقط.",variant:"destructive"}),v("/user/dashboard"))},[(Dt=f==null?void 0:f.subscription)==null?void 0:Dt.planType]);const[wa,rs]=p.useState(!1),[Na,ns]=p.useState(!1),[Ta,is]=p.useState(!1),[os,Be]=p.useState(!1),[ls,it]=p.useState(!1),[cs,ot]=p.useState(!1),[ds,Fe]=p.useState(!1),[ms,us]=p.useState(null),[ps,ve]=p.useState(!1),[re,je]=p.useState({keepLastCount:30,intervalDays:7,lastResetAt:null});p.useEffect(()=>{(async()=>{if(a!=null&&a.uid)try{const r=await U.getUserData(a.uid),i=(r==null?void 0:r.recentReset)||{},n=Number(i==null?void 0:i.keepLastCount)>0?Number(i.keepLastCount):30,s=Number(i==null?void 0:i.intervalDays)>0?Number(i.intervalDays):7,c=u=>u instanceof Date?u:typeof(u==null?void 0:u.toDate)=="function"?u.toDate():u?new Date(String(u)):null,d=i!=null&&i.lastResetAt?c(i.lastResetAt):null,h=new Date;!d||h.getTime()-d.getTime()>=s*24*60*60*1e3?(await U.updateUserData(a.uid,{recentReset:{keepLastCount:n,intervalDays:s,lastResetAt:h}}),je({keepLastCount:n,intervalDays:s,lastResetAt:h})):je({keepLastCount:n,intervalDays:s,lastResetAt:d})}catch{je({keepLastCount:30,intervalDays:7,lastResetAt:null})}})()},[a==null?void 0:a.uid]),p.useEffect(()=>{if(!(a!=null&&a.uid))return;const e=J(O,"users",a.uid),r=se(e,i=>{try{const n=i.exists()?i.data():{},s=n==null?void 0:n.tutorialSeenAt,c=s!=null&&s.toDate?s.toDate():s?new Date(s):null;ss(c)}catch{}});return()=>r()},[a==null?void 0:a.uid]),p.useEffect(()=>{const e=se(J(O,"app_guides","latest"),r=>{try{const i=r.exists()?r.data():null;if(!i){at(""),rt(""),nt(null),be(!1);return}const n=String(i.url||""),s=String(i.title||"شرح التطبيق"),c=i.publishedAt,d=c!=null&&c.toDate?c.toDate():c?new Date(c):new Date;at(n),rt(s),nt(d),be(d?!de||d.getTime()>((de==null?void 0:de.getTime())||0):!1)}catch{be(!1)}},r=>{console.warn("فشل الاشتراك في دليل التطبيق:",r)});return()=>e()},[de]);const hs=e=>{try{const r=new URL(e);let i="";return r.hostname.includes("youtube.com")?r.pathname==="/watch"?i=r.searchParams.get("v")||"":(r.pathname.startsWith("/embed/")||r.pathname.startsWith("/shorts/"))&&(i=r.pathname.split("/").pop()||""):r.hostname==="youtu.be"&&(i=r.pathname.replace(/^\//,"")),i?`https://www.youtube.com/embed/${i}?autoplay=1&rel=0`:e}catch{return e}},xs=async()=>{tt(!0);try{a!=null&&a.uid&&await U.updateUserData(a.uid,{tutorialSeenAt:new Date}),be(!1)}catch{}},[fs,we]=p.useState(!1),[Ne,lt]=p.useState(""),[me,ct]=p.useState(""),[Te,dt]=p.useState(""),[mt,ut]=p.useState(!1),[pt,Ce]=p.useState(0);p.useEffect(()=>{if(!(a!=null&&a.uid)){Ce(0);return}const e=J(O,"users",a.uid),r=se(e,i=>{try{const n=i.exists()?i.data():{},c=(Array.isArray(n==null?void 0:n.debts)?n.debts:[]).filter(d=>(d==null?void 0:d.status)==="pending"&&(Number(d==null?void 0:d.amount)||0)>0).length;Ce(c)}catch{Ce(0)}},i=>{console.warn("فشل الاشتراك في ديون المستخدم من Firestore:",i),Ce(0)});return()=>r()},[a==null?void 0:a.uid]),p.useEffect(()=>{gs(),ys()},[a]),p.useEffect(()=>{if(!(a!=null&&a.uid))return;let e=null,r=null;try{const i=G(q(O,"deletedTransactions"),W("userId","==",a.uid));e=se(i,n=>{try{const s=[];n.docChanges().forEach(c=>{const d=c.doc.data(),h=[d.originalTransactionId,d.transactionId,d.reference,c.doc.id].filter(Boolean).map(x=>String(x));s.push(...h)}),s.length>0&&(ae(c=>{const d=new Set(c);return s.forEach(h=>d.add(h)),d}),T(c=>c.filter(d=>{const h=String(d.id||""),x=String(d.transactionId||""),u=String(d.reference||"");return!(s.includes(h)||s.includes(x)||s.includes(u))})))}catch(s){console.warn("deletedTransactions snapshot handling failed:",s)}},n=>{console.warn("deletedTransactions subscription error:",n)});try{r=U.subscribeDeletedTransactionsLocalSync(a.uid)}catch{}}catch{}return()=>{try{e&&e()}catch{}try{r&&r()}catch{}}},[a==null?void 0:a.uid]),p.useEffect(()=>{(async()=>{try{if(!(a!=null&&a.uid)){ae(new Set);return}const e=G(q(O,"deletedTransactions"),W("userId","==",a.uid),W("permanent","==",!0)),i=(await ne(e)).docs.flatMap(n=>{const s=n.data();return[s.originalTransactionId,s.transactionId,s.reference,n.id].filter(Boolean).map(String)});ae(new Set(i))}catch{ae(new Set)}})()},[a==null?void 0:a.uid]),p.useEffect(()=>{(async()=>{try{if(!(a!=null&&a.uid))return;const r=new Date;if(r.getDate()!==1)return;const i=`${r.getFullYear()}-${r.getMonth()+1}`,n=`lastMonthlyDbCleanup:${a.uid}`;if(localStorage.getItem(n)===i)return;const c=new Date(r.getFullYear(),r.getMonth(),1,0,0,0,0),d=u=>u instanceof Date?u:typeof(u==null?void 0:u.toDate)=="function"?u.toDate():new Date(String(u));let h=[];try{const u=G(q(O,"userTransactions"),W("userId","==",a.uid),W("createdAt","<",c));h=(await ne(u)).docs}catch{const u=G(q(O,"userTransactions"),W("userId","==",a.uid));h=(await ne(u)).docs.filter(N=>{var l;return d((l=N.data())==null?void 0:l.createdAt)<c})}await Promise.allSettled(h.map(u=>kt(u.ref)));let x=[];try{const u=G(q(O,"transactions"),W("userId","==",a.uid),W("createdAt","<",c));x=(await ne(u)).docs}catch{const u=G(q(O,"transactions"),W("userId","==",a.uid));x=(await ne(u)).docs.filter(N=>{var l;return d((l=N.data())==null?void 0:l.createdAt)<c})}await Promise.allSettled(x.map(u=>kt(u.ref)));try{localStorage.setItem(n,i)}catch{}console.log("✅ تنظيف شهري (TransactionsPage):",{userTransactionsDeleted:h.length,globalTransactionsDeleted:x.length,monthStart:c})}catch(r){console.error("فشل التنظيف الشهري التلقائي (TransactionsPage):",r)}})()},[a==null?void 0:a.uid]),p.useEffect(()=>{if(!(a!=null&&a.uid))return;let e=null,r=!1;const i=s=>{const d=s.map(l=>{const o=l.data(),m=o==null?void 0:o.createdAt,b=m!=null&&m.toDate?m.toDate():m instanceof Date?m:new Date(m);return{id:l.id,...o,createdAt:b}}).filter(l=>(l==null?void 0:l.status)!=="cancelled"&&!(l!=null&&l.isDeleted)).filter(l=>!((l==null?void 0:l.type)==="report"||((l==null?void 0:l.title)||"").includes("إيصال تسليم وردية"))).sort((l,o)=>{const m=l.createdAt?new Date(l.createdAt).getTime():0;return(o.createdAt?new Date(o.createdAt).getTime():0)-m}).filter(l=>{const o=String(l.id||""),m=String(l.transactionId||""),b=String(l.reference||l.transactionReference||"");return!oe.has(o)&&(!m||!oe.has(m))&&(!b||!oe.has(b))}),h=a!=null&&a.uid?U.getLocalReceipts(a.uid):[],x=[...d,...Array.isArray(h)?h:[]],u=l=>{var o;return String((l==null?void 0:l.transactionId)||(l==null?void 0:l.id)||(l==null?void 0:l.reference)||(l==null?void 0:l.transactionReference)||((o=l==null?void 0:l.receipt)==null?void 0:o.reference)||`${new Date((l==null?void 0:l.createdAt)||Date.now()).getTime()}`)},A=new Set,N=x.filter(l=>{const o=u(l);return A.has(o)?!1:(A.add(o),!0)});T(N.map(ze))},n=()=>{const s=G(q(O,"userTransactions"),W("userId","==",a.uid));e=se(s,c=>{try{i(c.docs)}catch(d){console.error("خطأ في معالجة بيانات الاشتراك الاحتياطي:",d)}},c=>{console.error("خطأ في الاشتراك الاحتياطي لمعاملات المستخدم:",c)})};(async()=>{try{const s=G(q(O,"userTransactions"),W("userId","==",a.uid)),c=await Ms(s);if(c&&c.docs&&c.docs.length>0)try{i(c.docs)}catch{}}catch{}})();try{const s=G(q(O,"userTransactions"),W("userId","==",a.uid),Ws("createdAt","desc"),limit(200));try{e=se(s,{includeMetadataChanges:!0},c=>{try{i(c.docs)}catch(d){console.error("خطأ في معالجة بيانات الاشتراك:",d)}},c=>{if(console.error("خطأ في الاشتراك لمعاملات المستخدم:",c),!r){r=!0;try{e&&e()}catch{}n()}})}catch{const d=G(q(O,"userTransactions"),W("userId","==",a.uid));e=se(d,h=>{try{i(h.docs)}catch{}},h=>{console.error("خطأ في الاشتراك البسيط لمعاملات المستخدم:",h),r||(r=!0,n())})}}catch(s){console.error("فشل إعداد الاشتراك الفوري لمعاملات المستخدم، بدء السقوط الاحتياطي:",s),n()}return()=>{try{e&&e()}catch{}}},[a==null?void 0:a.uid]);const gs=async()=>{try{if(!a)return;const e=G(q(O,"deletedTransactions"),W("userId","==",a.uid),W("permanent","==",!0)),[r,i,n]=await Promise.all([U.getUserTransactions(a.uid).catch(()=>[]),U.getByUserId(a.uid).catch(()=>[]),ne(e).then(o=>o.docs.flatMap(m=>{const b=m.data();return[b.originalTransactionId,b.transactionId,b.reference,m.id].filter(Boolean).map(String)})).catch(()=>[])]),s=Array.isArray(r)&&r.length>0?r:Array.isArray(i)?i:[],c=new Set(n),h=(s||[]).map(o=>({...o,createdAt:o.createdAt instanceof Date?o.createdAt:new Date(o.createdAt)})).filter(o=>!((o==null?void 0:o.type)==="report"||((o==null?void 0:o.title)||"").includes("إيصال تسليم وردية"))).filter(o=>{const m=String(o.id||""),b=String(o.transactionId||""),R=String(o.reference||o.transactionReference||"");return!c.has(m)&&(!b||!c.has(b))&&(!R||!c.has(R))}),x=a!=null&&a.uid?U.getLocalReceipts(a.uid):[],u=[...h,...Array.isArray(x)?x:[]],A=o=>{var m;return String((o==null?void 0:o.transactionId)||(o==null?void 0:o.id)||(o==null?void 0:o.reference)||(o==null?void 0:o.transactionReference)||((m=o==null?void 0:o.receipt)==null?void 0:m.reference)||`${new Date((o==null?void 0:o.createdAt)||Date.now()).getTime()}`)},N=new Set,l=u.filter(o=>{const m=A(o);return N.has(m)?!1:(N.add(m),!0)});T(l.map(ze))}catch(e){console.error("خطأ في تحميل معاملات المستخدم من Firestore:",e),j({title:"فشل جلب معاملات المستخدم",description:"قد تكون المشكلة صلاحيات Firestore أو اتصال الشبكة. سيتم عرض المتاح محليًا إن وُجد. جرّب تسجيل الدخول مجددًا أو افتح صفحة اختبار المصادقة.",variant:"destructive"})}},ys=async()=>{try{if(!a)return;const r=(await he.getDeletedTransactionsByUser(a.uid)).map(i=>({...i,createdAt:i.createdAt instanceof Date?i.createdAt:new Date(i.createdAt)}));B(r.map(ze))}catch(e){console.error("خطأ في تحميل المعاملات المحذوفة من Firestore:",e),j({title:"فشل جلب المعاملات المحذوفة",description:"تحقق من الصلاحيات والاتصال. يمكن مراجعة صفحة اختبار المصادقة للتشخيص.",variant:"destructive"})}},ue=pe.useMemo(()=>{const e=re.keepLastCount??30;return[...k].sort((i,n)=>n.createdAt.getTime()-i.createdAt.getTime()).slice(0,e)},[k,re.keepLastCount]),bs=pe.useMemo(()=>Math.max(0,((k==null?void 0:k.length)||0)-(re.keepLastCount||30)),[k==null?void 0:k.length,re.keepLastCount]),ht=ue.filter(e=>{const r=!Q||e.senderPhone.includes(Q)||e.receiverPhone.includes(Q),i=!Y||e.createdAt.toDateString()===new Date(Y).toDateString(),n=!Z||e.createdAt.toTimeString().startsWith(Z);return r&&i&&n}),Ae=(e,r)=>{switch(e){case"completed":return t.jsx(ua,{className:`h-4 w-4 ${r==="withdraw"?"text-red-500":"text-green-500"}`});case"pending":return t.jsx(Ye,{className:"h-4 w-4 text-yellow-500"});case"cancelled":return t.jsx(ma,{className:"h-4 w-4 text-red-500"});default:return t.jsx(Ye,{className:"h-4 w-4 text-gray-500"})}},Ue=e=>{switch(e){case"completed":return"مكتمل";case"pending":return"قيد المراجعة";case"cancelled":return"ملغي";default:return"غير معروف"}},ze=e=>{const r=((e==null?void 0:e.status)??"").toString().toLowerCase(),i=r==="confirmed"||r==="success"||r==="completed"?"completed":r==="failed"||r==="error"||r==="cancelled"||r==="canceled"?"cancelled":"pending",s=((e==null?void 0:e.type)??(e==null?void 0:e.txnType)??"").toString().toLowerCase()==="withdraw"?"withdraw":"send",c=(e==null?void 0:e.senderPhone)??(e==null?void 0:e.senderMsisdn)??(e==null?void 0:e.sender_msisdn)??(e==null?void 0:e.sender)??(e==null?void 0:e.from)??"",d=(e==null?void 0:e.receiverPhone)??(e==null?void 0:e.receiverMsisdn)??(e==null?void 0:e.receiver_msisdn)??(e==null?void 0:e.receiver)??(e==null?void 0:e.to)??"",h=e==null?void 0:e.createdAt,x=h instanceof Date?h:h!=null&&h.toDate?h.toDate():new Date(h);return{id:e==null?void 0:e.id,senderPhone:c||"غير معروف",receiverPhone:d||"غير معروف",amount:Number((e==null?void 0:e.amount)??0),status:i,type:s,createdAt:x,commission:(e==null?void 0:e.commission)??void 0,withdrawnAmount:(e==null?void 0:e.withdrawnAmount)??void 0,sentAmount:(e==null?void 0:e.sentAmount)??void 0,fromWallet:(e==null?void 0:e.fromWallet)??(e==null?void 0:e.walletId)??void 0,cashierName:(e==null?void 0:e.cashierName)??(e==null?void 0:e.createdByName)??(e==null?void 0:e.cashier)??void 0,commissionMode:(e==null?void 0:e.commissionMode)??(e==null?void 0:e.commission_mode)??void 0,totalCharged:(e==null?void 0:e.totalCharged)??void 0,walletEffectAppliedOnCreation:(e==null?void 0:e.walletEffectAppliedOnCreation)??(e==null?void 0:e.effectsAppliedOnCreation)??(e==null?void 0:e.effectAppliedOnCreation)??!1,cashEffectAppliedOnCreation:(e==null?void 0:e.cashEffectAppliedOnCreation)??!1,fee:(e==null?void 0:e.fee)??void 0}},vs=e=>({id:e.id,type:e.type==="send"?"transfer":"withdraw",sender_msisdn:e.senderPhone,receiver_msisdn:e.receiverPhone,amount:e.amount,commission:e.commission||0,status:e.status==="cancelled"?"failed":e.status,createdAt:e.createdAt.toISOString(),updatedAt:e.createdAt.toISOString(),shopName:P??(y==null?void 0:y.shopName)??(a==null?void 0:a.displayName)??"المحل",cashierName:(e==null?void 0:e.cashierName)??null,commissionMode:(e==null?void 0:e.commissionMode)??void 0,totalCharged:(e==null?void 0:e.totalCharged)??void 0,fee:(e==null?void 0:e.fee)??void 0,note:(e==null?void 0:e.note)??(e==null?void 0:e.notes)??void 0}),$e=e=>{const r=vs(e);us(r),Fe(!0)},js=e=>{C(e),w(!0)},ws=async()=>{g&&(await Ns(g.id),w(!1),C(null))},Ns=async e=>{try{const r=D.find(s=>s.id===e);if(!r||!a)return;const i=await U.saveUserTransaction(a.uid,{...r,userId:a.uid,status:"completed",cashierName:r.cashierName??"الحساب الرئيسي"});await he.permanentlyDeleteTransaction(e,a.uid);const n={...r,id:i};T(s=>[...s,n]),B(s=>s.filter(c=>c.id!==e)),j({title:"تم الاسترجاع",description:"تم استرجاع الإيصال إلى حسابك."})}catch(r){console.error("خطأ في استرجاع المعاملة من Firestore:",r),j({title:"فشل الاسترجاع",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}},Ts=async e=>{try{if(!a)return;B(r=>r.filter(i=>i.id!==e)),await he.permanentlyDeleteTransaction(e,a.uid),await U.removeUserTransaction(a.uid,e),j({title:"تم الحذف نهائيًا",description:"الإيصال لن يعود بعد التحديث."})}catch(r){console.error("فشل الحذف النهائي للمعاملة:",r),j({title:"خطأ في الحذف النهائي",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}},xt=async e=>{var r,i,n;try{const s=k.find(m=>m.id===e);if(!s||!a)return;try{const m=(r=f==null?void 0:f.subscription)==null?void 0:r.planType;if(m===X.ZERO){const{dailyOperationCountService:b}=await H(async()=>{const{dailyOperationCountService:te}=await import("./dailyOperationCountService-9b-RCNij.js");return{dailyOperationCountService:te}},__vite__mapDeps([0,1,2]),import.meta.url),R=s.type==="send"?"transfer":"withdraw";if(!(await b.checkAndIncrement(a.uid,R,5)).allowed){j({title:"تم بلوغ حد باقة الزيرو",description:"مسموح بحد أقصى 5 تأكيدات يوميًا للتحويل/السحب. جرّب غدًا أو قم بالترقية.",variant:"destructive"});return}}else if(m===X.TAHWEELA){const{dailyOperationCountService:b}=await H(async()=>{const{dailyOperationCountService:te}=await import("./dailyOperationCountService-9b-RCNij.js");return{dailyOperationCountService:te}},__vite__mapDeps([0,1,2]),import.meta.url),R=s.type==="send"?"transfer":"withdraw";if(!(await b.checkAndIncrementCombined(a.uid,R,40)).allowed){j({title:"تم بلوغ حد باقة تحويله",description:"هذه الباقة تسمح بحد أقصى 40 عملية تحويل/سحب يومياً.",variant:"destructive"});return}}}catch(m){console.warn("تعذر التحقق من حد التأكيد اليومي:",m)}const c=await He.getById(a.uid);if(!(c!=null&&c.shopId))throw new Error("لا يمكن تحديد معرف المتجر (shopId) للمستخدم");const d=J(O,"dashboardData",c.shopId),h=await ie(d);let x=h.exists()?Number(((i=h.data())==null?void 0:i.cashBalance)||0):0;const u=h.exists()?((n=h.data())==null?void 0:n.walletBalances)||{}:{},A=s.fromWallet||Object.keys(u)[0],N=!!(s!=null&&s.limitsReservedOnCreation),l=Number(s.withdrawnAmount??s.sentAmount??s.amount??0),o=s.type==="send"?"transfer":"withdraw";try{const{walletDailyLimitsService:m}=await H(async()=>{const{walletDailyLimitsService:R}=await import("./walletDailyLimitsService-DdjjL_Zn.js");return{walletDailyLimitsService:R}},__vite__mapDeps([3,1,2]),import.meta.url),b=await m.canPerformOperation(A,l,o);if(!N&&!b.canPerform){j({title:"تجاوز الحدود",description:String(b.message||"لا يمكن الإكمال لتجاوز الحد اليومي/الشهري"),variant:"destructive"});return}}catch{j({title:"فشل التحقق من الحدود",description:"حاول مجددًا بعد قليل",variant:"destructive"});return}if(s.type==="withdraw"){const m=s.fromWallet||Object.keys(u)[0],b=Number(s.withdrawnAmount??s.amount??0),R=Number(s.commission??0),F=!!(s!=null&&s.walletEffectAppliedOnCreation),te=!!(s!=null&&s.cashEffectAppliedOnCreation);if(!F&&m&&b>0){const Ve=u[m]||0;u[m]=Ve+b}te?x=x+b+R:x=x-b+R,await Se(d,{cashBalance:x,walletBalances:u})}else if(s.type==="send"){const m=Number(s.commission??0),b=Number((s==null?void 0:s.fee)??0),R=Number((s==null?void 0:s.sentAmount)??(s==null?void 0:s.transferredAmount)??s.amount??0),F=Math.max(0,R)+Math.max(0,m)+Math.max(0,b);F>0&&(x=x+F,await Se(d,{cashBalance:x}))}await Se(J(O,"userTransactions",e),{status:"completed",confirmedAt:new Date});try{const m=s.fromWallet||Object.keys(u)[0],b=Number(s.withdrawnAmount??s.sentAmount??s.amount??0);if(m&&b>0&&!N){const{walletDailyLimitsService:R}=await H(async()=>{const{walletDailyLimitsService:F}=await import("./walletDailyLimitsService-DdjjL_Zn.js");return{walletDailyLimitsService:F}},__vite__mapDeps([3,1,2]),import.meta.url);await R.updateUsage(m,b,s.type==="send"?"transfer":"withdraw")}}catch{j({title:"فشل تحديث الحدود",description:"تجاوز حد اليوم/الشهر يمنع الإكمال",variant:"destructive"});return}try{const{ProfitService:m}=await H(async()=>{const{ProfitService:R}=await import("./profitService-DRDD-Fph.js");return{ProfitService:R}},__vite__mapDeps([4,1,2]),import.meta.url),b=Math.max(0,Number(s.commission||0));b>0&&m.addProfit(b,a==null?void 0:a.uid)}catch{}T(m=>m.map(b=>b.id===e?{...b,status:"completed"}:b)),j({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),Fe(!1)}catch(s){console.error("خطأ في إكمال المعاملة:",s),j({title:"فشل الإكمال",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}},ft=async e=>{var r,i;try{const n=k.find(s=>s.id===e);if(!n||!a)return;T(s=>s.filter(c=>c.id!==e)),B(s=>[{...n},...s]);try{let s={};try{const x=await ie(J(O,"userTransactions",e));s=x.exists()?x.data():{}}catch{}const c=e,d=String((s==null?void 0:s.transactionId)||(n==null?void 0:n.transactionId)||c),h=String((s==null?void 0:s.reference)||(s==null?void 0:s.transactionReference)||(n==null?void 0:n.reference)||(n==null?void 0:n.transactionReference)||"");await U.removeUserTransaction(a.uid,e),await he.saveDeletedTransaction({...n,userId:a.uid,originalTransactionId:e,transactionId:d,reference:h||void 0,permanent:!0});try{await he.permanentlyDeleteTransaction(e,a.uid)}catch{}}catch(s){console.warn("تعذر الحذف النهائي من قواعد البيانات في هذه الخطوة، سيتم الحذف من لائحة المحذوفات عند التنفيذ اليدوي للحذف النهائي:",s)}try{const s=await He.getById(a.uid);if(!(s!=null&&s.shopId))throw new Error("لا يمكن تحديد معرف المتجر (shopId) للمستخدم");const c=J(O,"dashboardData",s.shopId),d=await ie(c);let h=d.exists()?Number(((r=d.data())==null?void 0:r.cashBalance)||0):0;const x=d.exists()?((i=d.data())==null?void 0:i.walletBalances)||{}:{},u=Number(n.withdrawnAmount??n.amount??0),A=Number(n.commission??0),N=n.fromWallet||Object.keys(x)[0],l=!!(n!=null&&n.walletEffectAppliedOnCreation);if(n.type==="send"){const o=Number(n.fee??0),m=Number((n==null?void 0:n.sentAmount)??(n==null?void 0:n.transferredAmount)??n.amount??0);if(n.status==="completed"&&(h=h-(m+A+o)),N&&m>0){const b=x[N]||0;x[N]=b+m}}else if(n.type==="withdraw"){if(n.status==="completed"){if(h=h+u-A,N&&u>0){const o=x[N]||0;x[N]=o-u}}else if(N&&l&&u>0){const o=x[N]||0;x[N]=o-u}}await Se(c,{cashBalance:h,walletBalances:x})}catch(s){console.warn("فشل عكس تأثير الأرصدة محليًا:",s)}try{const s=n.fromWallet;if(s){const{walletDailyLimitsService:c}=await H(async()=>{const{walletDailyLimitsService:h}=await import("./walletDailyLimitsService-DdjjL_Zn.js");return{walletDailyLimitsService:h}},__vite__mapDeps([3,1,2]),import.meta.url),d=await c.getWalletLimits(s);if(d){const h=n.type==="send",x={updatedAt:(await H(async()=>{const{serverTimestamp:o}=await import("./index-DKHjTn06.js").then(m=>m.bH);return{serverTimestamp:o}},__vite__mapDeps([1,2]),import.meta.url)).serverTimestamp()};h?(x.dailyTransferUsed=Math.max(0,(d.dailyTransferUsed||0)-n.amount),x.monthlyTransferUsed=Math.max(0,(d.monthlyTransferUsed||0)-n.amount)):(x.dailyWithdrawUsed=Math.max(0,(d.dailyWithdrawUsed||0)-n.amount),x.monthlyWithdrawUsed=Math.max(0,(d.monthlyWithdrawUsed||0)-n.amount));const{doc:u,setDoc:A}=await H(async()=>{const{doc:o,setDoc:m}=await import("./index-DKHjTn06.js").then(b=>b.bH);return{doc:o,setDoc:m}},__vite__mapDeps([1,2]),import.meta.url),{db:N}=await H(async()=>{const{db:o}=await import("./index-DKHjTn06.js").then(m=>m.bI);return{db:o}},__vite__mapDeps([1,2]),import.meta.url),l=u(N,"walletLimits",s);await A(l,x,{merge:!0})}}}catch(s){console.warn("فشل استرجاع حدود المحفظة:",s)}try{const{ProfitService:s}=await H(async()=>{const{ProfitService:u}=await import("./profitService-DRDD-Fph.js");return{ProfitService:u}},__vite__mapDeps([4,1,2]),import.meta.url),{ReportsService:c}=await H(async()=>{const{ReportsService:u}=await import("./index-DKHjTn06.js").then(A=>A.bL);return{ReportsService:u}},__vite__mapDeps([1,2]),import.meta.url),h={txnType:n.type==="send"?"send":"receive",amount:n.amount,commission:n.commission||0,createdAt:n.createdAt,status:"confirmed"},x=s.calculateProfitFromTransaction(h);x>0&&s.addProfit(-x,a.uid);try{c.removeTransactionEffects(n,a.uid)}catch{}}catch(s){console.warn("فشل تحديث التقارير/الأرباح بعد الحذف:",s)}}catch(n){console.error("خطأ أثناء حذف الإيصال:",n)}},gt=p.useRef(!1),yt=Bs();p.useEffect(()=>{!(new URLSearchParams(yt.search).get("autoTestBalances")==="1")||gt.current||(gt.current=!0,(async()=>{var i,n,s,c,d,h;try{if(!a)return;const x=await He.getById(a.uid);if(!(x!=null&&x.shopId)){console.warn("autoTest: لا يوجد shopId للمستخدم، سيتم إيقاف الاختبار.");return}const u=J(O,"dashboardData",x.shopId),A=await ie(u),N=A.exists()?Number(((i=A.data())==null?void 0:i.cashBalance)||0):0,l=A.exists()?((n=A.data())==null?void 0:n.walletBalances)||{}:{},o=Object.keys(l)[0]||void 0,m=100,b=5,R=await U.saveUserTransaction(a.uid,{senderPhone:"auto-test-sender",receiverPhone:"auto-test-receiver",amount:m,status:"pending",type:"withdraw",createdAt:new Date,reference:`AUTO-${Date.now()}`,commission:b,withdrawnAmount:m,fromWallet:o,cashierName:"AutoTest",commissionMode:"add",totalCharged:m+b,walletEffectAppliedOnCreation:!1});console.log("autoTest: تم إنشاء إيصال سحب تجريبي:",R),await xt(R);const F=await ie(u),te=F.exists()?Number(((s=F.data())==null?void 0:s.cashBalance)||0):0,Ve=F.exists()?((c=F.data())==null?void 0:c.walletBalances)||{}:{},As=N-m+b,Ds=o?Number(l[o]||0)+m:void 0;console.log("autoTest: توقع الدرج بعد الإكمال:",As,"فعلي:",te),o&&console.log("autoTest: توقع المحفظة بعد الإكمال:",Ds,"فعلي:",Ve[o]),await ft(R);const De=await ie(u),Ss=De.exists()?Number(((d=De.data())==null?void 0:d.cashBalance)||0):0,Rs=De.exists()?((h=De.data())==null?void 0:h.walletBalances)||{}:{};console.log("autoTest: تحقق نهائي — الدرج قبل/بعد الحذف:",N,Ss),o&&console.log("autoTest: تحقق نهائي — المحفظة قبل/بعد الحذف:",l[o]||0,Rs[o]||0),j({title:"اختبار الأرصدة (Firestore فقط)",description:"تم إنشاء/إكمال/حذف إيصال تجريبي والتحقق من الأرصدة.",variant:"default"})}catch(x){console.error("autoTest: فشل اختبار الأرصدة:",x),j({title:"فشل اختبار الأرصدة",description:"تحقق من الاتصال ووجود shopId والمحافظ في Firestore.",variant:"destructive"})}})())},[yt.search,a]);const Cs=async()=>{var i,n,s;const e="alkaptin678678@gmail.com",r=(n=(i=Ke.currentUser)==null?void 0:i.email)==null?void 0:n.toLowerCase();if(!r||r!==e){j({title:"قيد الإنشاء",description:"ميزة الشحن متاحة لهذا الحساب فقط حالياً."});return}if(!Ne||!me||!Te){j({title:"بيانات ناقصة",description:"يرجى إدخال رقم وشركة والمبلغ",variant:"destructive"});return}ut(!0);try{const d={vodafone_eg:"Vodafone",orange_eg:"Orange",etisalat_eg:"Etisalat",we_eg:"WE"}[me]??me,h=new AbortController,x=setTimeout(()=>h.abort(),15e3),u=await((s=Ke.currentUser)==null?void 0:s.getIdToken()),A=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...u?{Authorization:`Bearer ${u}`}:{}},body:JSON.stringify({phone:Ne,countryCode:"EG",operator:d,amount:Number(Te),useLocalAmount:!0}),signal:h.signal});clearTimeout(x);const N=await A.text();let l;try{l=JSON.parse(N)}catch{l={success:!1,message:N||"فشل قراءة استجابة الخادم"}}A.ok&&(l!=null&&l.success)?(j({title:"تم الشحن",description:(l==null?void 0:l.message)||"تم تنفيذ عملية الشحن بنجاح"}),we(!1),lt(""),ct(""),dt("")):j({title:"فشل الشحن",description:(l==null?void 0:l.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(c){console.error("Topup request error:",c),(c==null?void 0:c.name)==="AbortError"?j({title:"انتهت المهلة",description:"الخادم لم يستجب في الوقت المحدد. تأكد أن السيرفر يعمل.",variant:"destructive"}):j({title:"خطأ في الاتصال",description:"تعذر الاتصال بالخادم. حاول لاحقاً.",variant:"destructive"})}finally{ut(!1)}};return t.jsxs("div",{className:"fixed inset-0 overscroll-y-none overflow-y-auto bg-background p-4",children:[t.jsxs("div",{className:"max-w-4xl mx-auto",children:[t.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[t.jsxs(S,{variant:"ghost",size:"sm",onClick:()=>v("/user/dashboard"),className:"flex items-center gap-2 text-gray-600 hover:text-gray-800",children:[t.jsx(ca,{className:"h-4 w-4"}),"العودة"]}),t.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"المعاملات"})]}),t.jsxs(Vs,{className:"card-modern fade-in-up",children:[t.jsxs(Gs,{className:"pb-2 px-3 pt-3",children:[t.jsx(qs,{className:"text-sm font-bold",children:"المعاملات الأخيرة"}),t.jsxs("div",{className:"flex items-center gap-0.5 mt-1 relative",children:[t.jsxs("div",{className:"flex items-center gap-0.5 flex-1 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[t.jsx(da,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),t.jsx(Xe,{placeholder:"بحث...",value:Q,onChange:e=>le(e.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),t.jsxs("div",{className:"hidden md:flex items-center gap-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"relative h-5 w-5 p-0 rounded bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 hover:border-red-300 transition-all duration-200 hover:scale-105",onClick:xs,title:"شرح التطبيق",children:t.jsxs("div",{className:"relative inline-flex items-center justify-center h-full w-full",children:[t.jsx(ha,{className:"h-2.5 w-2.5"}),as&&t.jsx("div",{className:"absolute -top-0.5 -right-0.5 h-1 w-1 bg-red-600 rounded-full"})]})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"شرح"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 hover:border-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(E||I){j({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"});return}L(!0)},title:"إدارة التقسيط",children:t.jsx(Fs,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"تقسيط"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(va,{userId:a==null?void 0:a.uid,transactions:k}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"أرباح"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-emerald-50 text-emerald-600 hover:bg-emerald-100 border border-emerald-200 hover:border-emerald-300 transition-all duration-200 hover:scale-105",onClick:()=>{j({title:"قيد الإنشاء",description:"هذه الميزة قيد الإنشاء حالياً."})},title:"نافذة شحن سريعة",children:t.jsx(Pt,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"شحن"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 hover:border-blue-300 transition-all duration-200 hover:scale-105",onClick:()=>K(!0),title:"آلة حاسبة",children:t.jsx(ta,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"حاسبة"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 hover:border-green-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(E){j({title:"الخطة الحالية لا تسمح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية."});return}rs(!0)},title:"بيانات المبيعات",children:t.jsx(sa,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"مبيعات"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsxs(S,{variant:"ghost",size:"sm",className:`h-5 w-5 p-0 rounded border transition-all duration-200 hover:scale-105 ${Y||Z?"bg-purple-100 text-purple-600 border-purple-300":"bg-purple-50 text-purple-600 hover:bg-purple-100 border-purple-200 hover:border-purple-300"}`,onClick:()=>ns(!0),title:"اختيار التاريخ",children:[t.jsx(Wt,{className:"h-2.5 w-2.5"}),(Y||Z)&&t.jsx("div",{className:"absolute -top-0.5 -right-0.5 h-1 w-1 bg-purple-500 rounded-full"})]}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"تاريخ"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"relative h-5 w-5 p-0 rounded bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 hover:border-orange-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(E){j({title:"الخطة الحالية لا تسمح",description:"إدارة الديون غير متاحة في خطة زيرو. قم بالترقية."});return}Be(!0)},title:"إدارة الديون",children:t.jsxs("div",{className:"relative inline-flex items-center justify-center h-full w-full",children:[t.jsx(Us,{className:"h-2.5 w-2.5"}),pt>0&&t.jsx("div",{className:"absolute -top-1 -right-1 z-10 min-w-[12px] h-[12px] px-[2px] bg-red-600 text-white rounded-full text-[8px] leading-[12px] flex items-center justify-center pointer-events-none ring-1 ring-white",children:pt})]})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"ديون"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 hover:border-amber-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(E){j({title:"الخطة الحالية لا تسمح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية."});return}ot(!0)},title:"الصيانة",children:t.jsx(zs,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"صيانه"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-violet-50 text-violet-600 hover:bg-violet-100 border border-violet-200 hover:border-violet-300 transition-all duration-200 hover:scale-105",onClick:()=>{v("/user/dashboard",{state:{openCashierShiftModal:!0}})},title:"يومية المكنة",children:t.jsx(pa,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"المكنة"})]}),t.jsxs("div",{className:"hidden sm:flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border border-indigo-200 hover:border-indigo-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(E){j({title:"الخطة الحالية لا تسمح",description:"الفيز الائتمانية غير متاحة في خطة زيرو. قم بالترقية."});return}it(!0)},title:"الفيز الائتمانية",children:t.jsx(Pt,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"فيز"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsxs(S,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 hover:border-red-300 transition-all duration-200 hover:scale-105 relative",onClick:()=>{ve(!0)},title:"تصفير المعاملات الأخيرة",children:[t.jsx(It,{className:"h-2.5 w-2.5"}),bs>0&&t.jsx("div",{className:"absolute -top-0.5 -right-0.5 h-1 w-1 bg-red-500 rounded-full"})]}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"تصفير"})]}),(Q||Y||Z)&&t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-red-50 text-red-500 hover:bg-red-100 border border-red-200 hover:border-red-300 transition-all duration-200 hover:scale-105",onClick:()=>{le(""),ye(""),M("")},title:"مسح",children:t.jsx("span",{className:"text-[10px] font-bold",children:"×"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"مسح"})]})]})]})]}),t.jsx(Hs,{className:"px-3 pb-3",children:t.jsxs(ya,{value:V,onValueChange:We,className:"w-full",children:[t.jsxs(Jt,{className:"hidden sm:grid w-full grid-cols-4 h-10 text-sm bg-gradient-to-r from-gray-50 via-blue-50/30 to-purple-50/30 border border-gray-200/60 rounded-md p-1 shadow-sm relative overflow-hidden",children:[t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-500/5 via-purple-500/5 to-pink-500/5 opacity-0 hover:opacity-100 transition-all duration-200"}),t.jsxs(fe,{value:"all",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-blue-500 data-[state=active]:to-blue-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-blue-200/50 hover:bg-blue-50/80 hover:text-blue-700 group",children:[t.jsx("span",{className:"relative z-10",children:"الكل"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-500/10 to-purple-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]}),t.jsxs(fe,{value:"send",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-green-500 data-[state=active]:to-emerald-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-green-200/50 hover:bg-green-50/80 hover:text-green-700 group",children:[t.jsx("span",{className:"relative z-10",children:"مرسل"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-green-500/10 to-emerald-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]}),t.jsxs(fe,{value:"withdraw",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-orange-500 data-[state=active]:to-amber-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-orange-200/50 hover:bg-orange-50/80 hover:text-orange-700 group",children:[t.jsx("span",{className:"relative z-10",children:"سحب"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-orange-500/10 to-amber-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]}),t.jsxs(fe,{value:"deleted",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-red-500 data-[state=active]:to-rose-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-red-200/50 hover:bg-red-50/80 hover:text-red-700 group",children:[t.jsx("span",{className:"relative z-10",children:"محذوف"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-red-500/10 to-rose-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]})]}),t.jsx(ge,{value:"all",className:"mt-2 receipts-list",children:ht.length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات محفوظة بعد"}):t.jsx("div",{className:"space-y-1 fade-in-up tab-content-smooth max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:ht.map((e,r)=>t.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 bg-white rounded-lg border hover:shadow-md cursor-pointer transition-all duration-200",onClick:()=>$e(e),children:[t.jsxs("div",{className:"flex items-center gap-1",children:[Ae(e.status,e.type),t.jsxs("div",{children:[t.jsx("p",{className:`font-medium text-sm ${e.type==="withdraw"?"text-red-700":"text-green-700"}`,children:e.type==="withdraw"?e.receiverPhone:`${e.senderPhone} → ${e.receiverPhone}`}),e.type==="withdraw"&&t.jsxs(t.Fragment,{children:[t.jsxs("p",{className:"text-sm font-semibold text-red-600",children:[z(e.amount)," جنيه"]}),t.jsxs("p",{className:"text-xs text-red-600",children:["عمولة: ",z(e.commission||0)," جنيه"]})]}),t.jsxs("p",{className:`text-[10px] ${e.type==="withdraw"?"text-red-700":"text-green-700"}`,children:["تمت بواسطة: ",e.cashierName??"الحساب الرئيسي"]}),t.jsx("p",{className:`text-sm ${e.type==="withdraw"?"text-red-500":"text-green-600"}`,children:e.createdAt.toLocaleString("en-GB")})]})]}),t.jsxs("div",{className:"text-right",children:[e.type!=="withdraw"&&t.jsxs("p",{className:"font-bold text-sm text-green-700",children:[z(e.amount)," جنيه"]}),e.withdrawnAmount&&t.jsxs("p",{className:"text-sm text-red-600",children:["مسحوب: ",z(e.withdrawnAmount)," جنيه"]}),e.sentAmount&&t.jsxs("p",{className:"text-sm text-green-600",children:["مرسل: ",z(e.sentAmount)," جنيه"]}),t.jsx(Pe,{variant:e.status==="completed"?"default":"secondary",className:`text-sm ${e.status==="completed"?e.type==="withdraw"?"bg-red-100 text-red-800 border-red-300":e.type==="send"?"bg-green-100 text-green-800 border-green-300":"":e.type==="withdraw"?"bg-red-100 text-red-800":""}`,children:e.type==="withdraw"?"سحب":Ue(e.status)})]})]},e.id))})}),t.jsx(ge,{value:"send",className:"mt-2 receipts-list",children:ue.filter(e=>e.type==="send").length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات إرسال محفوظة بعد"}):t.jsx("div",{className:"space-y-1 fade-in-up tab-content-smooth max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:ue.filter(e=>e.type==="send").map((e,r)=>t.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all duration-200",onClick:()=>$e(e),children:[t.jsxs("div",{className:"flex items-center gap-1",children:[Ae(e.status,e.type),t.jsxs("div",{children:[t.jsxs("p",{className:"font-medium text-sm text-green-700",children:[e.senderPhone," → ",e.receiverPhone]}),t.jsxs("p",{className:"text-[10px] text-green-700",children:["تمت بواسطة: ",e.cashierName??"الحساب الرئيسي"]}),t.jsx("p",{className:"text-sm text-green-600",children:e.createdAt.toLocaleString("ar-EG")})]})]}),t.jsxs("div",{className:"text-right",children:[t.jsxs("p",{className:"font-bold text-sm text-green-700",children:[z(e.amount)," جنيه"]}),e.sentAmount&&t.jsxs("p",{className:"text-sm text-green-600",children:["مرسل: ",z(e.sentAmount)," جنيه"]}),t.jsx(Pe,{variant:e.status==="completed"?"default":"secondary",className:`text-sm ${e.status==="completed"?"bg-green-100 text-green-800 border-green-300":""}`,children:Ue(e.status)})]})]},e.id))})}),t.jsx(ge,{value:"withdraw",className:"mt-2 receipts-list",children:ue.filter(e=>e.type==="withdraw").length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات سحب محفوظة بعد"}):t.jsx("div",{className:"space-y-1 max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:ue.filter(e=>e.type==="withdraw").map((e,r)=>t.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer",onClick:()=>$e(e),children:[t.jsxs("div",{className:"flex items-center gap-1",children:[Ae(e.status,e.type),t.jsxs("div",{children:[t.jsx("p",{className:"font-medium text-sm text-red-700",children:e.receiverPhone}),t.jsxs("p",{className:"text-[10px] text-red-700",children:["تمت بواسطة: ",e.cashierName??"الحساب الرئيسي"]}),t.jsx("p",{className:"text-sm text-red-500",children:e.createdAt.toLocaleString("ar-EG")})]})]}),t.jsxs("div",{className:"text-right",children:[t.jsxs("p",{className:"font-bold text-sm text-red-700",children:[z(e.amount)," جنيه"]}),e.withdrawnAmount&&t.jsxs("p",{className:"text-sm text-red-600",children:["مسحوب: ",z(e.withdrawnAmount)," جنيه"]}),t.jsx(Pe,{variant:e.status==="completed"?"default":"secondary",className:`text-sm ${e.status==="completed"?"bg-red-100 text-red-800 border-red-300":"bg-red-100 text-red-800"}`,children:Ue(e.status)})]})]},e.id))})}),t.jsx(ge,{value:"deleted",className:"mt-2",children:D.length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات محذوفة"}):t.jsx("div",{className:"space-y-1 max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:D.map((e,r)=>t.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[Ae(e.status,e.type),t.jsxs("div",{children:[t.jsx("p",{className:"font-medium text-sm text-red-700",children:e.type==="withdraw"?e.receiverPhone:`${e.senderPhone} → ${e.receiverPhone}`}),e.type==="withdraw"&&t.jsxs(t.Fragment,{children:[t.jsxs("p",{className:"text-sm font-semibold text-red-600",children:[z(e.amount)," جنيه"]}),t.jsxs("p",{className:"text-xs text-orange-500",children:["عمولة: ",z(e.commission||0)," جنيه"]})]}),t.jsxs("p",{className:"text-[10px] text-red-700",children:["تمت بواسطة: ",e.cashierName??"الحساب الرئيسي"]}),t.jsx("p",{className:"text-sm text-red-500",children:e.createdAt.toLocaleString("ar-EG")})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("div",{className:"text-right mr-2",children:[e.type!=="withdraw"&&t.jsxs("p",{className:"font-bold text-sm text-red-700",children:[z(e.amount)," جنيه"]}),t.jsx(Pe,{variant:"secondary",className:"text-[10px] bg-red-100 text-red-800",children:"محذوف"})]}),t.jsx(S,{variant:"ghost",size:"sm",className:"text-green-600 hover:bg-green-100 h-10 sm:h-12 px-4 sm:px-5 min-w-[44px] touch-manipulation",onClick:()=>js(e),children:t.jsx("span",{className:"text-xs sm:text-sm",children:"استرجاع"})}),t.jsx(S,{variant:"ghost",size:"sm",className:"text-red-600 hover:bg-red-100 h-10 sm:h-12 px-3 sm:px-4 min-w-[44px] touch-manipulation",onClick:()=>Ts(e.id),children:t.jsx(It,{className:"h-4 w-4 sm:h-5 sm:w-5"})})]})]},e.id))})})]})})]}),t.jsx(ke,{open:es,onOpenChange:tt,children:t.jsxs(Ee,{className:"dialog-modern max-w-3xl w-full p-0 overflow-hidden border-0 shadow-2xl",children:[t.jsx(Oe,{className:"px-4 pt-4",children:t.jsx(Ie,{className:"text-lg font-bold",children:ts||"شرح التطبيق"})}),t.jsx("div",{className:"aspect-video w-full bg-black",children:st?t.jsx("iframe",{src:hs(st),title:"Application Guide",className:"w-full h-full",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",allowFullScreen:!0}):t.jsx("div",{className:"flex items-center justify-center h-full text-white/80",children:"لا يوجد فيديو متاح حالياً"})})]})}),t.jsx(aa,{open:cs,onOpenChange:ot})]}),t.jsx(ra,{isOpen:ls,onClose:()=>it(!1)}),t.jsx(Ze,{open:os,onOpenChange:Be,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{Be(!1),is(!0)}}),t.jsx(oa,{open:ps,onOpenChange:ve,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"سيتم حذف كل المعاملات السابقة نهائيًا من حسابك وFirebase.",onSuccess:async()=>{try{if(!(a!=null&&a.uid)){ve(!1);return}const e=new Date,r=i=>i instanceof Date?i:typeof(i==null?void 0:i.toDate)=="function"?i.toDate():new Date(String(i));await U.updateUserData(a.uid,{recentReset:{keepLastCount:re.keepLastCount??30,intervalDays:re.intervalDays??7,lastResetAt:e}}),je(i=>({...i,lastResetAt:e})),j({title:"تم إخفاء المعاملات السابقة",description:"تم إخفاء كل الإيصالات الأقدم من وقت التصفير من العرض بدون التأثير على التقارير اليومية/الشهرية أو الحدود."})}catch(e){console.error("فشل تنفيذ التصفير النهائي:",e),j({title:"فشل التصفير",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}finally{ve(!1)}}}),t.jsx(ke,{open:fs,onOpenChange:e=>{var r,i;if(e){const n="alkaptin678678@gmail.com",s=(i=(r=Ke.currentUser)==null?void 0:r.email)==null?void 0:i.toLowerCase();if(!s||s!==n){j({title:"قيد الإنشاء",description:"هذه الميزة قيد الإنشاء حالياً."});return}we(!0)}else we(!1)},children:t.jsxs(Ee,{dir:"rtl",className:"sm:max-w-md",children:[t.jsx(Oe,{children:t.jsx(Ie,{children:"شحن رصيد الموبايل"})}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-right mb-1",children:"رقم الموبايل"}),t.jsx(Xe,{value:Ne,onChange:e=>lt(e.target.value),placeholder:"01XXXXXXXXX",dir:"ltr"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-right mb-1",children:"الشركة"}),t.jsxs(Ks,{value:me,onValueChange:ct,children:[t.jsx(Ys,{className:"w-full",children:t.jsx(Zs,{placeholder:"اختر الشركة"})}),t.jsxs(Js,{children:[t.jsx(Re,{value:"vodafone_eg",children:"فودافون"}),t.jsx(Re,{value:"orange_eg",children:"أورنج"}),t.jsx(Re,{value:"etisalat_eg",children:"اتصالات"}),t.jsx(Re,{value:"we_eg",children:"WE"})]})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-right mb-1",children:"المبلغ بالجنيه"}),t.jsx(Xe,{type:"number",min:1,value:Te,onChange:e=>dt(e.target.value?Number(e.target.value):""),placeholder:"50"})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 pt-2",children:[t.jsx(S,{variant:"outline",onClick:()=>we(!1),children:"إلغاء"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(S,{variant:"secondary",onClick:()=>v("/topup"),children:"صفحة الشحن الكاملة"}),t.jsx(S,{onClick:Cs,disabled:mt||!Ne||!me||!Te,children:mt?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})]})]})}),t.jsx(ke,{open:Me,onOpenChange:w,children:t.jsxs(Ee,{className:"sm:max-w-[460px]",children:[t.jsxs(Oe,{children:[t.jsx(Ie,{children:"تأكيد استرجاع الإيصال"}),t.jsx($s,{children:"سيتم إعادة الإيصال إلى قائمة المعاملات الحالية."})]}),g&&t.jsxs("div",{className:"mt-2 space-y-2 text-sm",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"المبلغ"}),t.jsxs("span",{className:"font-bold",children:[g.amount," جنيه"]})]}),g.type==="withdraw"?t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"العميل"}),t.jsx("span",{className:"font-medium",children:g.receiverPhone})]}):t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"من → إلى"}),t.jsxs("span",{className:"font-medium",children:[g.senderPhone," → ",g.receiverPhone]})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"الكاشير"}),t.jsx("span",{className:"font-medium",children:g.cashierName??"الحساب الرئيسي"})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"التاريخ"}),t.jsx("span",{className:"font-medium",children:g.createdAt.toLocaleString("ar-EG")})]})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 pt-3",children:[t.jsx(S,{variant:"outline",onClick:()=>{w(!1),C(null)},children:"إلغاء"}),t.jsx(S,{onClick:ws,children:"تأكيد الاسترجاع"})]})]})}),t.jsx(na,{isOpen:ds,onClose:()=>Fe(!1),transaction:ms,onPrint:()=>window.print(),onDelete:ft,onComplete:xt}),t.jsx(Ze,{open:ee,onOpenChange:L,mode:"verify",title:"فتح إدارة التقسيط",description:"أدخل الرقم السري الرئيسي للوصول إلى إدارة التقسيط",onSuccess:()=>{L(!1),et(!0)}}),t.jsx(ia,{open:Qt,onOpenChange:et})]})};export{Ga as default};
//# sourceMappingURL=TransactionsPage-D3QJMUmN.js.map
