import{a1 as Le,c as Fe,u as Re,ai as _e,aj as Me,ak as te,r as a,j as e,B as V,al as $e,am as ze,w as Se,I as H,C as Ke,ah as se,y as ae,i as ne,an as Ue,P as Ve,K as He,z as Je,ao as Ne,Q as Qe,a as Xe,ap as De}from"./index-BkgvAZmL.js";import{C as S,a as N,b as D,d as T}from"./card-BeLkzSXB.js";import{B as qe}from"./badge-Ci_XTcYi.js";import{S as ie,a as re,b as le,c as oe,d as x}from"./select-DKh-OuoK.js";import{M as Ge}from"./MasterPinDialog-DaJbi9vd.js";import{ProfitService as Te}from"./profitService-CFuTlKsL.js";import{D as Ie}from"./dollar-sign-H_lcvHHV.js";import{W as Ye}from"./wallet-CuaS1OFH.js";import{C as Ze}from"./circle-check-big-DVBA-oYy.js";import{C as et}from"./circle-x-BdZ9AUYM.js";import"./label-BnTYfWNe.js";import"./shield-YHMfenbZ.js";import"./circle-alert-BKdAArNc.js";const tt=()=>{const b=Le(),{toast:m}=Fe(),{signOut:J,user:i,profile:p}=Re(),{isShiftActive:We,shiftUser:ce}=_e(),I=Me(),Q=(typeof te<"u"&&typeof te.getPlatform=="function"?te.getPlatform():"web")==="android"||/Android/i.test(typeof navigator<"u"?navigator.userAgent:""),[c,W]=a.useState("01030302038"),[u,X]=a.useState(""),[C,L]=a.useState(""),[j,de]=a.useState("transfer"),[q,me]=a.useState("vodafone_cash"),[G,ue]=a.useState("vodafone_cash"),[he,Y]=a.useState(""),[f,F]=a.useState([]),[st,at]=a.useState("all"),[nt,it]=a.useState(!1),[xe,rt]=a.useState(""),[R,lt]=a.useState([]),[ot,ct]=a.useState(null),[dt,mt]=a.useState(!1),[ut,ht]=a.useState([]),[xt,pt]=a.useState([]),[ft,gt]=a.useState(!1),[bt,jt]=a.useState("daily"),[vt,k]=a.useState([]),[Z,v]=a.useState(0),[y,w]=a.useState({}),[yt,wt]=a.useState(!1),[St,Nt]=a.useState(!1),[Dt,Tt]=a.useState(!1),[It,Wt]=a.useState(!1),[Ct,kt]=a.useState(!1),[Bt,Et]=a.useState(""),[At,Pt]=a.useState(!1),[Ce,ee]=a.useState(!1),[_,pe]=a.useState(()=>{try{const t=i!=null&&i.uid?`dailyReportsLockEnabled_${i==null?void 0:i.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[ke,M]=a.useState(!1),[Be,Ee]=a.useState(!1),d=t=>{const s="٠١٢٣٤٥٦٧٨٩",n="۰۱۲۳۴۵۶۷۸۹";return(t||"").split("").map(l=>{const r=s.indexOf(l);if(r>-1)return String(r);const o=n.indexOf(l);return o>-1?String(o):l}).join("")},fe=t=>{const s=d(t).replace(/\D/g,"");return s.startsWith("010")?"vodafone_cash":s.startsWith("011")?"etisalat_cash":s.startsWith("012")?"orange_cash":null};a.useEffect(()=>{const t=fe(c);t&&t!==q&&me(t)},[c]),a.useEffect(()=>{const t=fe(u);t&&t!==G&&ue(t)},[u]),a.useEffect(()=>{try{const t=i!=null&&i.uid?`dailyReportsLockEnabled_${i==null?void 0:i.uid}`:"dailyReportsLockEnabled",s=localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled");pe(s==="true")}catch{}},[i==null?void 0:i.uid]),a.useEffect(()=>{const t=b.state||{};t!=null&&t.openTransactionSection&&(((t==null?void 0:t.transactionType)==="withdraw"||(t==null?void 0:t.transactionType)==="transfer")&&de(t.transactionType),Ee(!0),t!=null&&t.startNewTransaction&&(W("01030302038"),X(""),L(""),Y("")),setTimeout(()=>{window.scrollTo({top:0,behavior:"smooth"})},50))},[b.state]);const $=async t=>{if(i)try{const s=await se.getById(i.uid);if(s!=null&&s.shopId){const n=ae(ne,"dashboardData",s.shopId);await Qe(n,t)}}catch(s){console.error("Error saving to Firebase:",s),m({title:"خطأ في الحفظ",description:"حدث خطأ أثناء حفظ البيانات في Firebase",variant:"destructive"})}};a.useEffect(()=>{if(!i)return;(async()=>{ee(!0);try{const s=await se.getById(i.uid);if(s!=null&&s.shopId){const n=ae(ne,"dashboardData",s.shopId);try{const r=await Ue(n);if(r.exists()){const o=r.data();v(o.cashBalance||0),w(o.walletBalances||{}),k(o.deletedTransactions||[]),ee(!1)}}catch{}const l=await Ve(n);if(l.exists()){const r=l.data();v(r.cashBalance||0),w(r.walletBalances||{}),k(r.deletedTransactions||[])}else{const r={walletBalances:{},deletedTransactions:[]};await He(n,r),v(0),w(r.walletBalances),k(r.deletedTransactions)}}}catch(s){console.error("Error loading data from Firebase:",s),v(0),w({}),k([])}finally{ee(!1)}})()},[i]),a.useEffect(()=>{if(!i)return;let t=null;return(async()=>{try{const n=await se.getById(i.uid);if(n!=null&&n.shopId){const l=ae(ne,"dashboardData",n.shopId);t=Je(l,{includeMetadataChanges:!0},r=>{if(r.exists()){const o=r.data();v(o.cashBalance||0),w(o.walletBalances||{}),k(o.deletedTransactions||[])}},r=>{console.error("Error subscribing to dashboardData:",r)})}}catch(n){console.error("Error initializing realtime dashboard subscription:",n)}})(),()=>{t&&t()}},[i==null?void 0:i.uid]);const Ae=async t=>{if(t.preventDefault(),j==="transfer"){if(!c||!u||!C){m({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}const s=(p==null?void 0:p.shopName)||(i==null?void 0:i.displayName)||"محل كاشي لينك",n=R.find(U=>U.id===xe)||R.find(U=>U.isDefault),l=d(c||"").replace(/\D/g,""),r=d(u||"").replace(/\D/g,""),o=q===G,B=l.startsWith("010")&&(r.startsWith("011")||r.startsWith("012")||r.startsWith("015"))||l.startsWith("012")&&r.startsWith("010")||l.startsWith("011")&&r.startsWith("010")||l.startsWith("015")&&r.startsWith("010"),h=o?1:B?parseFloat(he||"0"):0;if(B&&(Number.isNaN(h)||h<=0)){m({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"});return}if(!n){m({title:"لا توجد محفظة",description:"يرجى اختيار محفظة لإتمام التحويل",variant:"destructive"});return}const g=parseFloat(C),E=g+h,z=y[n.id]||0;if(z<E){m({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${z} لا يكفي لخصم ${E}`,variant:"destructive"});return}const A=Ne(g,"send"),P={id:Date.now().toString(),type:"send",senderPhone:c,receiverPhone:u,amount:g,status:"pending",createdAt:new Date,withdrawnAmount:0,sentAmount:g,merchantShopName:s,shopName:(n==null?void 0:n.name)||"المحفظة الرئيسية",commission:A,fee:h,fromWallet:n.id},ge=[P,...f];F(ge);const Pe=g+h,K=n==null?void 0:n.id,Oe=K&&y[K]||0,be=K?{...y,[K]:Oe-Pe}:y;w(be),await $({transactions:ge,walletBalances:be}),m({title:"تم إرسال التحويل",description:"جاري معالجة التحويل..."}),setTimeout(async()=>{const je=[{...P,status:"completed"},...f];F(je);const ve=h,ye=Math.max(0,A)+(Number.isFinite(ve)?ve:0),we=Z+ye;v(we),await $({transactions:je,cashBalance:we}),Te.addProfit(ye)},2e3),W("01030302038"),X(""),L(""),Y("")}else if(j==="withdraw"){if(!c||!C){m({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}const s=(p==null?void 0:p.shopName)||(i==null?void 0:i.displayName)||"محل كاشي لينك",n=R.find(h=>h.id===xe)||R.find(h=>h.isDefault);if(!n){m({title:"لا توجد محفظة",description:"يرجى اختيار محفظة لإتمام السحب",variant:"destructive"});return}const l=parseFloat(C);if(!Number.isFinite(l)||l<=0){m({title:"خطأ",description:"أدخل مبلغًا صحيحًا للسحب",variant:"destructive"});return}const r=Ne(l,"receive"),o={id:Date.now().toString(),type:"withdraw",senderPhone:c,receiverPhone:"",amount:l,status:"pending",createdAt:new Date,withdrawnAmount:l,sentAmount:0,merchantShopName:s,shopName:(n==null?void 0:n.name)||"المحفظة الرئيسية",commission:r,fromWallet:n.id},B=[o,...f];F(B),await $({transactions:B}),m({title:"تم إنشاء عملية السحب",description:"جاري معالجة السحب..."}),setTimeout(async()=>{const g=[{...o,status:"completed"},...f];F(g);const E=n.id,z=y[E]||0,A={...y,[E]:z+l};w(A);const P=Z-l+Math.max(0,r);v(P),await $({transactions:g,walletBalances:A,cashBalance:P}),Te.addProfit(Math.max(0,r))},2e3),W("01030302038"),L("")}};return e.jsxs("div",{className:"min-h-screen bg-background p-4",children:[Ce&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-center",children:"جاري تحميل البيانات..."})]})}),e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"لوحة تحكم الإدارة"}),e.jsxs(V,{onClick:J,variant:"outline",className:"flex items-center gap-2",children:[e.jsx($e,{className:"h-4 w-4"}),"تسجيل الخروج"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsxs(S,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(D,{className:"text-sm font-medium",children:"الرصيد النقدي"}),e.jsx(Ie,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(T,{children:e.jsxs("div",{className:"text-2xl font-bold",children:[Z.toLocaleString()," جنيه"]})})]}),e.jsxs(S,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(D,{className:"text-sm font-medium",children:"الأرصدة علي المحافظ"}),e.jsx(Ye,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(T,{children:e.jsxs("div",{className:"text-2xl font-bold",children:[Object.values(y).reduce((t,s)=>t+s,0).toLocaleString()," جنيه"]})})]}),e.jsxs(S,{className:"relative",children:[e.jsxs(N,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(D,{className:"text-sm font-medium",children:"المعاملات اليوم"}),e.jsx(ze,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(T,{className:_?"filter blur-sm pointer-events-none":"",children:e.jsx("div",{className:"text-2xl font-bold",children:f.length})}),_&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(V,{size:"sm",variant:"ghost",onClick:()=>M(!0),className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير اليوم",children:[e.jsx(Se,{className:"h-5 w-5"}),e.jsx("span",{className:"text-xs",children:"عرض تقارير اليوم"})]})})]}),e.jsxs(S,{className:"relative",children:[e.jsxs(N,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(D,{className:"text-sm font-medium",children:"إجمالي اليوم"}),e.jsx(Ie,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(T,{className:_?"filter blur-sm pointer-events-none":"",children:e.jsxs("div",{className:"text-2xl font-bold",children:[f.reduce((t,s)=>t+s.amount,0).toLocaleString()," جنيه"]})}),_&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(V,{size:"sm",variant:"ghost",onClick:()=>M(!0),className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير اليوم",children:[e.jsx(Se,{className:"h-5 w-5"}),e.jsx("span",{className:"text-xs",children:"عرض تقارير اليوم"})]})})]}),e.jsx(Ge,{open:ke,onOpenChange:M,mode:"verify",title:"قفل تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{pe(!1),M(!1)}})]}),e.jsxs(S,{className:I&&Be?"sticky top-0 z-40 shadow-lg bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/70":"",children:[e.jsx(N,{children:e.jsx(D,{children:"إجراء معاملة جديدة"})}),e.jsx(T,{children:e.jsxs("form",{onSubmit:Ae,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"نوع المعاملة"}),e.jsxs(ie,{value:j,onValueChange:t=>de(t),children:[e.jsx(re,{children:e.jsx(le,{})}),e.jsxs(oe,{children:[e.jsx(x,{value:"transfer",children:"تحويل"}),e.jsx(x,{value:"withdraw",children:"سحب"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رقم المرسل"}),e.jsx(H,{type:"tel",value:c,onChange:t=>W(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const s=document.getElementById("receiverPhoneInput");if(s)s.focus();else{const n=document.getElementById("amountInput");n==null||n.focus()}}},placeholder:"01xxxxxxxxx"})]}),j==="transfer"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رقم المستقبل"}),e.jsx(H,{id:"receiverPhoneInput",type:"tel",value:u,onChange:t=>X(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const s=document.getElementById("amountInput");s==null||s.focus()}},placeholder:"01xxxxxxxxx"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"شركة المرسل"}),e.jsxs(ie,{value:q,onValueChange:t=>me(t),children:[e.jsx(re,{children:e.jsx(le,{})}),e.jsxs(oe,{children:[e.jsx(x,{value:"vodafone_cash",children:"فودافون"}),e.jsx(x,{value:"etisalat_cash",children:"اتصالات"}),e.jsx(x,{value:"orange_cash",children:"أورانج"}),e.jsx(x,{value:"instapay",children:"إنستاباي"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"شركة المستقبل"}),e.jsxs(ie,{value:G,onValueChange:t=>ue(t),children:[e.jsx(re,{children:e.jsx(le,{})}),e.jsxs(oe,{children:[e.jsx(x,{value:"vodafone_cash",children:"فودافون"}),e.jsx(x,{value:"etisalat_cash",children:"اتصالات"}),e.jsx(x,{value:"orange_cash",children:"أورانج"}),e.jsx(x,{value:"instapay",children:"إنستاباي"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"المبلغ"}),e.jsx(H,{id:"amountInput",type:"number",value:C,onChange:t=>L(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const s=document.getElementById("txSubmitButton");s==null||s.focus()}},placeholder:"0.00"})]}),j==="transfer"&&(d(c||"").replace(/\D/g,"").startsWith("010")&&(d(u||"").replace(/\D/g,"").startsWith("011")||d(u||"").replace(/\D/g,"").startsWith("012")||d(u||"").replace(/\D/g,"").startsWith("015"))||d(c||"").replace(/\D/g,"").startsWith("012")&&d(u||"").replace(/\D/g,"").startsWith("010")||d(c||"").replace(/\D/g,"").startsWith("011")&&d(u||"").replace(/\D/g,"").startsWith("010")||d(c||"").replace(/\D/g,"").startsWith("015")&&d(u||"").replace(/\D/g,"").startsWith("010"))&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رسوم التحويل"}),e.jsx(H,{type:"number",value:he,onChange:t=>Y(t.target.value),placeholder:"0.00"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"تُخصم من المحفظة وتضاف للدرج"})]})]}),e.jsx(V,{id:"txSubmitButton",type:"submit",className:`w-full ${j==="transfer"?"btn-transfer-confirm":"btn-withdraw-confirm"}`,children:j==="transfer"?"إرسال التحويل":"تنفيذ السحب"})]})})]}),e.jsxs(S,{children:[e.jsx(N,{children:e.jsx(D,{children:"المعاملات الأخيرة"})}),e.jsx(T,{children:f.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"لا توجد معاملات حديثة."}):e.jsx("div",{className:I||Q?"receipts-list space-y-4 max-h-[310px] overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400":"receipts-list space-y-4",children:f.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(Ze,{className:`h-5 w-5 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(Ke,{className:"h-5 w-5 text-yellow-500"}),t.status==="failed"&&e.jsx(et,{className:"h-5 w-5 text-red-500"})]}),e.jsxs("div",{children:[e.jsxs("p",{className:`font-medium ${t.type==="send"?"text-green-700":"text-red-700"}`,children:[t.type==="send"?"تحويل":"سحب"," - ",t.amount.toLocaleString()," جنيه"]}),e.jsxs("p",{className:`text-sm ${t.type==="send"?"text-green-600":"text-red-500"}`,children:["من ",t.senderPhone," إلى ",t.receiverPhone]})]})]}),e.jsx(qe,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})})]})]})]})},Qt=()=>{const b=Xe(),[m,J]=a.useState(!1),[i,p]=a.useState(!0);return a.useEffect(()=>{(()=>{const ce=localStorage.getItem("dashboardAuth"),I=localStorage.getItem("dashboardUser");if(ce==="true"&&I)try{const O=JSON.parse(I),Q=new Date(O.loginTime);(new Date().getTime()-Q.getTime())/(1e3*60*60)<24?J(!0):(localStorage.removeItem("dashboardAuth"),localStorage.removeItem("dashboardUser"),b("/dashboard/login"))}catch(O){console.error("Error parsing user data:",O),b("/dashboard/login")}else b("/dashboard/login");p(!1)})()},[b]),i?e.jsx(De,{}):m?e.jsx(tt,{}):e.jsx(De,{})};export{Qt as default};
