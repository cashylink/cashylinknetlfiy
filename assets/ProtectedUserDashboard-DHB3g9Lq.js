const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./UserDashboardPage-COYQf6xb.js","./index-gOTNP7ME.js","./index-OjfkNIag.css","./card-BQR6WmIt.js","./badge-DW3o6rRK.js","./select-P86IvavM.js","./label-BvE0EeZv.js","./MasterPinDialog-BZURpLXG.js","./shield-DG1jRZIq.js","./circle-alert-BUN25pZL.js","./walletDailyLimitsService-UwV1MQRJ.js","./wallet-bsm-6TqW.js","./star-DZalz9MZ.js","./square-pen-uSH6fMBq.js","./progress-IPGm4fkb.js","./phone-B5VvzQKp.js","./arrow-left-DUmDYJv5.js","./separator-BKHyoKrx.js","./calendar-D_3cDVX1.js","./chart-column-CHPtgzpb.js","./dollar-sign-DT7a2CaG.js","./ProfileIcon-5ffheaOV.js","./dropdown-menu-Cun2tHO3.js","./index-DX1uHk70.js","./switch-TvgC6AJN.js","./circle-x-BkGDEM2N.js","./circle-check-big-m77fPl3A.js","./MaintenanceDialog-CReUVBms.js","./whatsappService-Dduy5sRg.js","./download-Dut3BEQK.js","./profitService-C6ong2ih.js","./store-DvQj4atB.js","./broadcastService-BTmw9WWO.js","./textarea-CmjOlCCk.js","./gift-Bf6nNSFh.js","./WalletsManagement-CLcP4tqd.js","./walletSelectionPinService-DvM7rUbA.js","./crown-BJvFWHu8.js","./refresh-cw-9asfDsp0.js"])))=>i.map(i=>d[i]);
import{u as J,r as i,a1 as K,a as M,y as _,i as O,z as q,j as t,ay as z,Q as F,az as T,c as Y,ap as I,R as Q,ag as G}from"./index-gOTNP7ME.js";import{s as W,E as X}from"./broadcastService-BTmw9WWO.js";import{L as H}from"./link-Tm4_C6pp.js";import{M as L}from"./MasterPinDialog-BZURpLXG.js";import"./label-BvE0EeZv.js";import"./shield-DG1jRZIq.js";import"./circle-alert-BUN25pZL.js";const D="dismissedBroadcastIds",Z=()=>{const{user:s,profile:e,isSubscriptionActive:a,userSubscription:c}=J(),[n,f]=i.useState(null),[d,x]=i.useState(!1),[y,l]=i.useState(!1),[v,b]=i.useState([]),E=K(),u=M(),m=i.useMemo(()=>`dismissedBroadcastIds:${(s==null?void 0:s.uid)||"global"}`,[s==null?void 0:s.uid]),S=i.useMemo(()=>{const o=["global"];return e!=null&&e.shopId&&o.push(`shop:${e.shopId}`),s!=null&&s.uid&&o.push(`user:${s.uid}`),o},[e==null?void 0:e.shopId,s==null?void 0:s.uid]),w=E.pathname.startsWith("/admin");i.useEffect(()=>{if(!(s!=null&&s.uid))return;const o=_(O,"users",s.uid),g=q(o,r=>{const p=r.data(),j=Array.isArray(p==null?void 0:p.dismissedBroadcastIds)?p.dismissedBroadcastIds:[];b(j);try{const N=localStorage.getItem(m),k=N?JSON.parse(N):[],h=Array.from(new Set([...Array.isArray(k)?k:[],...j]));localStorage.setItem(m,JSON.stringify(h)),localStorage.setItem(D,JSON.stringify(h))}catch{}},r=>{console.error("UserBroadcastModal: onSnapshot user error",r)});return()=>g()},[s==null?void 0:s.uid,m]),i.useEffect(()=>{if(!s||w||!((e==null?void 0:e.approved)===!0||a||(c==null?void 0:c.isOnFreeTrial)===!0))return;const g=W(S,r=>{if(r){f(r);try{const p=localStorage.getItem(m),j=localStorage.getItem(D),N=p?JSON.parse(p):[],k=j?JSON.parse(j):[],h=Array.isArray(N)?[...N]:[];if(Array.isArray(k))for(const U of k)h.includes(U)||h.push(U);if(Array.isArray(v))for(const U of v)h.includes(U)||h.push(U);const C=r.id&&h.includes(r.id);x(!C),l(!1),requestAnimationFrame(()=>l(!0))}catch{x(!0),l(!0)}}});return()=>g()},[s,S,w,e==null?void 0:e.approved,a,c,v]);const V=async()=>{x(!1);try{const o=localStorage.getItem(m),g=o?JSON.parse(o):[],r=n==null?void 0:n.id;if(r&&!g.includes(r)){g.push(r),localStorage.setItem(m,JSON.stringify(g));try{localStorage.setItem(D,JSON.stringify(g))}catch{}try{s!=null&&s.uid&&await F(_(O,"users",s.uid),{dismissedBroadcastIds:T(r)})}catch(p){console.warn("UserBroadcastModal: failed to update dismissedBroadcastIds in Firestore",p)}}}catch{}};return!d||!n?null:t.jsxs("div",{className:"fixed inset-0 z-[9999]",children:[t.jsx("div",{className:`absolute inset-0 transition-opacity duration-300 ease-out ${y?"opacity-100":"opacity-0"} bg-black/20 dark:bg-black/20`}),t.jsxs("div",{className:`absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] sm:w-auto sm:min-w-[380px] sm:max-w-md md:max-w-lg bg-white shadow-2xl rounded-2xl border border-gray-100 ring-1 ring-black/5 transition-all duration-300 ease-out ${y?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:[t.jsx("div",{className:"relative overflow-hidden rounded-t-2xl",children:t.jsxs("div",{className:"bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 relative",children:[t.jsx("button",{"aria-label":"Ø¥ØºÙ„Ø§Ù‚",onClick:V,className:"absolute top-3 right-3 p-2 rounded-full bg-white/10 hover:bg-white/20",children:t.jsx(z,{className:"w-5 h-5 text-white"})}),t.jsx("div",{className:"p-4",children:t.jsx("h3",{className:"text-base sm:text-lg font-semibold text-white tracking-wide text-center",children:n.title||"Ø¥Ø´Ø¹Ø§Ø±"})})]})}),t.jsx("div",{className:"p-5",children:t.jsxs("div",{className:"flex items-start justify-between gap-3",children:[t.jsx("p",{className:"text-gray-700 leading-relaxed text-sm sm:text-base",children:n.message}),n.linkUrl&&t.jsxs("button",{"aria-label":"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·",title:"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·",onClick:()=>{const o=n.linkUrl;/^https?:\/\//i.test(o)?window.open(o,"_blank","noopener"):u(o)},className:"shrink-0 inline-flex items-center gap-2 px-3 py-2 rounded-md bg-indigo-600 text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 whitespace-nowrap",children:[/^https?:\/\//i.test(n.linkUrl)?t.jsx(X,{className:"w-6 h-6"}):t.jsx(H,{className:"w-6 h-6"}),t.jsx("span",{className:"text-xs sm:text-sm font-semibold",children:"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·"})]})]})})]})]})},B="quick_login_enabled",R="quick_login_session_verified";function $(s){return s?`${B}_${s}`:B}function P(s){return s?`${R}_${s}`:R}const A={isEnabled(s){try{return localStorage.getItem($(s))==="true"}catch{return!1}},setEnabled(s,e){try{localStorage.setItem($(e),s?"true":"false"),sessionStorage.removeItem(P(e))}catch{}},isSessionVerified(s){try{return sessionStorage.getItem(P(s))==="true"}catch{return!1}},markSessionVerified(s){try{sessionStorage.setItem(P(s),"true")}catch{}}},ee=Q.lazy(()=>G(()=>import("./UserDashboardPage-COYQf6xb.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38]),import.meta.url)),ce=()=>{const s=M(),{user:e,profile:a,loading:c,refreshProfile:n,isSubscriptionActive:f,userSubscription:d,checkSubscriptionStatus:x}=J(),[y,l]=i.useState(!1),[v,b]=i.useState(!1),{toast:E}=Y();return i.useEffect(()=>{const u=async m=>{const{userId:S,isActive:w}=m.detail;console.log("ðŸ”” ProtectedUserDashboard: Subscription update event received:",{userId:S,isActive:w,currentUserId:e==null?void 0:e.uid}),S===(e==null?void 0:e.uid)&&w&&(console.log("âœ… ProtectedUserDashboard: Subscription activated for current user, refreshing status"),await x(),l(!0),E({title:"ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ",description:"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…!"}))};return window.addEventListener("userSubscriptionUpdated",u),()=>{window.removeEventListener("userSubscriptionUpdated",u)}},[e==null?void 0:e.uid,x,E]),i.useEffect(()=>{if(console.log("ProtectedUserDashboard - useEffect triggered",{loading:c,user:e?"exists":"null",profile:a?{role:a.role,approved:a.approved}:"null",isSubscriptionActive:f,userSubscription:d?"exists":"null"}),!c){if(!e)console.log("ProtectedUserDashboard - No user, redirecting to login"),s("/user/login");else if(a){if(console.log("ProtectedUserDashboard - Profile found:",{role:a.role,approved:a.approved,isSubscriptionActive:f,hasSubscription:!!(d!=null&&d.subscription)}),a.role==="user"){if(f){console.log("ProtectedUserDashboard - User has active subscription, allowing access"),l(!0);return}if(a.approved===!1){console.log("ProtectedUserDashboard - User not approved and no active subscription, redirecting to pending approval"),s("/user/pending-approval");return}}console.log("ProtectedUserDashboard - User approved or admin, checking quick-login gate");const u=A.isEnabled(e==null?void 0:e.uid),m=A.isSessionVerified(e==null?void 0:e.uid);if(u&&!m){try{A.markSessionVerified(e==null?void 0:e.uid)}catch{}b(!1),l(!0)}else l(!0)}}},[e,a,c,s,f,d]),c?t.jsx(I,{}):e&&!a?t.jsxs("div",{className:"min-h-screen flex flex-col items-center justify-center gap-4",children:[t.jsx(I,{}),t.jsxs("div",{className:"text-center",children:[t.jsx("p",{className:"text-sm text-muted-foreground",children:"Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨â€¦ Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø°Ù„Ùƒ Ù„Ø­Ø¸Ø§Øª"}),t.jsx("div",{className:"mt-2",children:t.jsx("button",{type:"button",onClick:()=>{try{n()}catch{}},className:"px-3 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white text-xs",children:"ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„"})})]})]}):y?(console.log("ProtectedUserDashboard - Render state:",{isAuthenticated:y,profileRole:a==null?void 0:a.role,profileApproved:a==null?void 0:a.approved,isSubscriptionActive:f,hasSubscription:!!(d!=null&&d.subscription)}),console.log("ðŸ”¥ ProtectedUserDashboard - user:",e?{uid:e.uid,email:e.email}:"null"),console.log("ðŸ”¥ ProtectedUserDashboard - profile:",a?{userId:a.userId,role:a.role}:"null"),console.log("ðŸ”¥ ProtectedUserDashboard - loading:",c),console.log("ðŸ”¥ ProtectedUserDashboard - About to render UserDashboardPage"),t.jsxs("div",{className:"relative",children:[t.jsx(i.Suspense,{fallback:t.jsx(I,{}),children:t.jsx(ee,{})}),t.jsx(Z,{}),t.jsx(L,{open:v,onOpenChange:u=>b(u),mode:"verify",title:"Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹",description:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",onSuccess:()=>{A.markSessionVerified(e==null?void 0:e.uid),b(!1),l(!0)}})]})):t.jsxs(t.Fragment,{children:[t.jsx(I,{}),t.jsx(L,{open:v,onOpenChange:u=>b(u),mode:"verify",title:"Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹",description:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",onSuccess:()=>{A.markSessionVerified(e==null?void 0:e.uid),b(!1),l(!0)}})]})};export{ce as default};
