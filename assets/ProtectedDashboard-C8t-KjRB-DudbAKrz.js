import{C as _e,S as s,I as e,s as Se,u as Ae,d as Le,W as Oe,w as ze,E as Re,x as te,p as se,v as ae,G as re,y as Ke,B as Me,F as Qe,L as Ue,a as Q,Q as Ge,T as He,m as Ee,t as E,Y as Je,$ as ke,a0 as Ve}from"./index-C_crvORM.js";import{o as k,c as I,i as D,l as W}from"./card-SlwaggFS-CAdsFCUe.js";import{d as Ze}from"./badge-Cq-GDK1F-DDXBwU_3.js";import{o as le,$ as ne,r as ie,Z as oe,Q as h}from"./select-QKdc2TYn-CHN9ZvrB.js";import{E as qe}from"./MasterPinDialog-CDin1iyv-DlTaZHso.js";import{ProfitService as Ie}from"./profitService-4r9FqAF7-CduXHB_-.js";import{o as De}from"./dollar-sign-bNLkxbzG-DZad4YjE.js";import{t as Ye}from"./wallet-MP5ofXFw-CDPV0DMK.js";import{t as Xe}from"./circle-check-big-DcMEd0KV-kvVPwXiq.js";import{r as et}from"./circle-x-CAZlwHZs-DZdNBdmE.js";import"./label-_mnIMROJ-DCx9a6ad.js";import"./shield-DSoskD-c-Cy9u9Dod.js";import"./circle-alert-BbiXZQj6-CYYPNIuO.js";const tt=()=>{const g=Ae(),{toast:d}=Le(),{signOut:U,user:l,profile:w}=Oe(),{isShiftActive:ce,shiftUser:G}=ze(),N=Re(),H=(typeof te<"u"&&typeof te.getPlatform=="function"?te.getPlatform():"web")==="android"||/Android/i.test(typeof navigator<"u"?navigator.userAgent:""),[u,F]=s.useState("01030302038"),[J,de]=s.useState(""),[m,V]=s.useState(""),[B,_]=s.useState(""),[x,ue]=s.useState("transfer"),[Z,me]=s.useState("vodafone_cash"),[q,he]=s.useState("vodafone_cash"),[xe,Y]=s.useState(""),[f,A]=s.useState([]),[st,at]=s.useState("all"),[rt,lt]=s.useState(!1),[fe,nt]=s.useState(""),[L,it]=s.useState([]),[ot,ct]=s.useState(null),[dt,ut]=s.useState(!1),[mt,ht]=s.useState([]),[xt,ft]=s.useState([]),[pt,gt]=s.useState(!1),[jt,vt]=s.useState("daily"),[bt,$]=s.useState([]),[X,j]=s.useState(0),[v,b]=s.useState({}),[yt,wt]=s.useState(!1),[Nt,St]=s.useState(!1),[Et,kt]=s.useState(!1),[It,Dt]=s.useState(!1),[Wt,Bt]=s.useState(!1),[$t,Ct]=s.useState(""),[Tt,Pt]=s.useState(!1),[We,ee]=s.useState(!1),[O,pe]=s.useState(()=>{try{const t=l!=null&&l.uid?`dailyReportsLockEnabled_${l==null?void 0:l.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[Be,z]=s.useState(!1),[$e,Ce]=s.useState(!1),o=t=>{const a="٠١٢٣٤٥٦٧٨٩",n="۰۱۲۳۴۵۶۷۸۹";return(t||"").split("").map(r=>{const i=a.indexOf(r);if(i>-1)return String(i);const y=n.indexOf(r);return y>-1?String(y):r}).join("")},ge=t=>{const a=o(t).replace(/\D/g,"");return a.startsWith("010")?"vodafone_cash":a.startsWith("011")?"etisalat_cash":a.startsWith("012")?"orange_cash":null};s.useEffect(()=>{const t=ge(u);t&&t!==Z&&me(t)},[u]),s.useEffect(()=>{const t=ge(m);t&&t!==q&&he(t)},[m]),s.useEffect(()=>{try{const t=l!=null&&l.uid?`dailyReportsLockEnabled_${l==null?void 0:l.uid}`:"dailyReportsLockEnabled",a=localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled");pe(a==="true")}catch{}},[l==null?void 0:l.uid]),s.useEffect(()=>{const t=g.state||{};t!=null&&t.openTransactionSection&&(((t==null?void 0:t.transactionType)==="withdraw"||(t==null?void 0:t.transactionType)==="transfer")&&ue(t.transactionType),Ce(!0),t!=null&&t.startNewTransaction&&(F("01030302038"),V(""),_(""),Y("")),setTimeout(()=>{window.scrollTo({top:0,behavior:"smooth"})},50))},[g.state]);const R=async t=>{if(l)try{const a=await se.getById(l.uid);if(a!=null&&a.shopId){const n=ae(re,"dashboardData",a.shopId);await Ve(n,t)}}catch(a){console.error("Error saving to Firebase:",a),d({title:"خطأ في الحفظ",description:"حدث خطأ أثناء حفظ البيانات في Firebase",variant:"destructive"})}};s.useEffect(()=>{l&&(async()=>{ee(!0);try{const t=await se.getById(l.uid);if(t!=null&&t.shopId){const a=ae(re,"dashboardData",t.shopId);try{const r=await Ke(a);if(r.exists()){const i=r.data();j(i.cashBalance||0),b(i.walletBalances||{}),$(i.deletedTransactions||[]),ee(!1)}}catch{}const n=await Me(a);if(n.exists()){const r=n.data();j(r.cashBalance||0),b(r.walletBalances||{}),$(r.deletedTransactions||[])}else{const r={walletBalances:{},deletedTransactions:[]};await Qe(a,r),j(0),b(r.walletBalances),$(r.deletedTransactions)}}}catch(t){console.error("Error loading data from Firebase:",t),j(0),b({}),$([])}finally{ee(!1)}})()},[l]),s.useEffect(()=>{if(!l)return;let t=null;return(async()=>{try{const a=await se.getById(l.uid);if(a!=null&&a.shopId){const n=ae(re,"dashboardData",a.shopId);t=Ue(n,{includeMetadataChanges:!0},r=>{if(r.exists()){const i=r.data();j(i.cashBalance||0),b(i.walletBalances||{}),$(i.deletedTransactions||[])}},r=>{console.error("Error subscribing to dashboardData:",r)})}}catch(a){console.error("Error initializing realtime dashboard subscription:",a)}})(),()=>{t&&t()}},[l==null?void 0:l.uid]);const Te=async t=>{if(t.preventDefault(),x==="transfer"){if(!u||!m||!B){d({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}const a=(w==null?void 0:w.shopName)||(l==null?void 0:l.displayName)||"محل كاشي لينك",n=L.find(S=>S.id===fe)||L.find(S=>S.isDefault),r=o(u||"").replace(/\D/g,""),i=o(m||"").replace(/\D/g,""),y=Z===q,C=r.startsWith("010")&&(i.startsWith("011")||i.startsWith("012")||i.startsWith("015"))||r.startsWith("012")&&i.startsWith("010")||r.startsWith("011")&&i.startsWith("010")||r.startsWith("015")&&i.startsWith("010"),c=y?1:C?parseFloat(xe||"0"):0;if(C&&(Number.isNaN(c)||c<=0)){d({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"});return}if(!n){d({title:"لا توجد محفظة",description:"يرجى اختيار محفظة لإتمام التحويل",variant:"destructive"});return}const p=parseFloat(B),K=p+c,T=v[n.id]||0;if(T<K){d({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${T} لا يكفي لخصم ${K}`,variant:"destructive"});return}const P=ke(p,"send"),je={id:Date.now().toString(),type:"send",senderPhone:u,receiverPhone:m,amount:p,status:"pending",createdAt:new Date,withdrawnAmount:0,sentAmount:p,merchantShopName:a,shopName:(n==null?void 0:n.name)||"المحفظة الرئيسية",commission:P,fee:c,fromWallet:n.id},ve=[je,...f];A(ve);const Pe=p+c,M=n==null?void 0:n.id,Fe=M&&v[M]||0,be=M?{...v,[M]:Fe-Pe}:v;b(be),await R({transactions:ve,walletBalances:be}),d({title:"تم إرسال التحويل",description:"جاري معالجة التحويل..."}),setTimeout(async()=>{const S=[{...je,status:"completed"},...f];A(S);const ye=c,we=Math.max(0,P)+(Number.isFinite(ye)?ye:0),Ne=X+we;j(Ne),await R({transactions:S,cashBalance:Ne}),Ie.addProfit(we)},2e3),F("01030302038"),V(""),_(""),Y("")}else if(x==="withdraw"){if(!u||!B){d({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}const a=(w==null?void 0:w.shopName)||(l==null?void 0:l.displayName)||"محل كاشي لينك",n=L.find(c=>c.id===fe)||L.find(c=>c.isDefault);if(!n){d({title:"لا توجد محفظة",description:"يرجى اختيار محفظة لإتمام السحب",variant:"destructive"});return}const r=parseFloat(B);if(!Number.isFinite(r)||r<=0){d({title:"خطأ",description:"أدخل مبلغًا صحيحًا للسحب",variant:"destructive"});return}const i=ke(r,"receive"),y={id:Date.now().toString(),type:"withdraw",senderPhone:u,receiverPhone:"",amount:r,status:"pending",createdAt:new Date,withdrawnAmount:r,sentAmount:0,merchantShopName:a,shopName:(n==null?void 0:n.name)||"المحفظة الرئيسية",commission:i,fromWallet:n.id,senderName:J||void 0},C=[y,...f];A(C),await R({transactions:C}),d({title:"تم إنشاء عملية السحب",description:"جاري معالجة السحب..."}),setTimeout(async()=>{const c=[{...y,status:"completed"},...f];A(c);const p=n.id,K=v[p]||0,T={...v,[p]:K+r};b(T);const P=X-r+Math.max(0,i);j(P),await R({transactions:c,walletBalances:T,cashBalance:P}),Ie.addProfit(Math.max(0,i))},2e3),F("01030302038"),_("")}};return e.jsxs("div",{className:"min-h-screen bg-background p-4",children:[We&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-center",children:"جاري تحميل البيانات..."})]})}),e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"لوحة تحكم الإدارة"}),e.jsxs(Q,{onClick:U,variant:"outline",className:"flex items-center gap-2",children:[e.jsx(Ge,{className:"h-4 w-4"}),"تسجيل الخروج"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsxs(k,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(D,{className:"text-sm font-medium",children:"الرصيد النقدي"}),e.jsx(De,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(W,{children:e.jsxs("div",{className:"text-2xl font-bold",children:[X.toLocaleString()," جنيه"]})})]}),e.jsxs(k,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(D,{className:"text-sm font-medium",children:"الأرصدة علي المحافظ"}),e.jsx(Ye,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(W,{children:e.jsxs("div",{className:"text-2xl font-bold",children:[Object.values(v).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})})]}),e.jsxs(k,{className:"relative",children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(D,{className:"text-sm font-medium",children:"المعاملات اليوم"}),e.jsx(He,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(W,{className:O?"filter blur-sm pointer-events-none":"",children:e.jsx("div",{className:"text-2xl font-bold",children:f.length})}),O&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(Q,{size:"sm",variant:"ghost",onClick:()=>z(!0),className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير اليوم",children:[e.jsx(Ee,{className:"h-5 w-5"}),e.jsx("span",{className:"text-xs",children:"عرض تقارير اليوم"})]})})]}),e.jsxs(k,{className:"relative",children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(D,{className:"text-sm font-medium",children:"إجمالي اليوم"}),e.jsx(De,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(W,{className:O?"filter blur-sm pointer-events-none":"",children:e.jsxs("div",{className:"text-2xl font-bold",children:[f.reduce((t,a)=>t+a.amount,0).toLocaleString()," جنيه"]})}),O&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(Q,{size:"sm",variant:"ghost",onClick:()=>z(!0),className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير اليوم",children:[e.jsx(Ee,{className:"h-5 w-5"}),e.jsx("span",{className:"text-xs",children:"عرض تقارير اليوم"})]})})]}),e.jsx(qe,{open:Be,onOpenChange:z,mode:"verify",title:"قفل تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{pe(!1),z(!1)}})]}),e.jsxs(k,{className:N&&$e?"sticky top-0 z-40 shadow-lg bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/70":"",children:[e.jsx(I,{children:e.jsx(D,{children:"إجراء معاملة جديدة"})}),e.jsx(W,{children:e.jsxs("form",{onSubmit:Te,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"نوع المعاملة"}),e.jsxs(le,{value:x,onValueChange:t=>ue(t),children:[e.jsx(ne,{children:e.jsx(ie,{})}),e.jsxs(oe,{children:[e.jsx(h,{value:"transfer",children:"تحويل"}),e.jsx(h,{value:"withdraw",children:"سحب"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رقم المرسل"}),e.jsx(E,{type:"tel",value:u,onChange:t=>F(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("receiverPhoneInput");if(a)a.focus();else{const n=document.getElementById("amountInput");n==null||n.focus()}}},placeholder:"01xxxxxxxxx"})]}),x==="transfer"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رقم المستقبل"}),e.jsx(E,{id:"receiverPhoneInput",type:"tel",value:m,onChange:t=>V(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("amountInput");a==null||a.focus()}},placeholder:"01xxxxxxxxx"})]}),x==="withdraw"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"اسم الراسل (اختياري)"}),e.jsx(E,{id:"senderNameInput",type:"text",value:J,onChange:t=>de(t.target.value),placeholder:"مثال: أحمد عبد الرحمن"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"شركة المرسل"}),e.jsxs(le,{value:Z,onValueChange:t=>me(t),children:[e.jsx(ne,{children:e.jsx(ie,{})}),e.jsxs(oe,{children:[e.jsx(h,{value:"vodafone_cash",children:"فودافون"}),e.jsx(h,{value:"etisalat_cash",children:"اتصالات"}),e.jsx(h,{value:"orange_cash",children:"أورانج"}),e.jsx(h,{value:"instapay",children:"إنستاباي"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"شركة المستقبل"}),e.jsxs(le,{value:q,onValueChange:t=>he(t),children:[e.jsx(ne,{children:e.jsx(ie,{})}),e.jsxs(oe,{children:[e.jsx(h,{value:"vodafone_cash",children:"فودافون"}),e.jsx(h,{value:"etisalat_cash",children:"اتصالات"}),e.jsx(h,{value:"orange_cash",children:"أورانج"}),e.jsx(h,{value:"instapay",children:"إنستاباي"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"المبلغ"}),e.jsx(E,{id:"amountInput",type:"number",value:B,onChange:t=>_(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("txSubmitButton");a==null||a.focus()}},placeholder:"0.00"})]}),x==="withdraw"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"اسم الراسل (اختياري)"}),e.jsx(E,{id:"senderNameInput",type:"text",value:J,onChange:t=>de(t.target.value),placeholder:"مثال: أحمد عبد الرحمن"})]}),x==="transfer"&&(o(u||"").replace(/\D/g,"").startsWith("010")&&(o(m||"").replace(/\D/g,"").startsWith("011")||o(m||"").replace(/\D/g,"").startsWith("012")||o(m||"").replace(/\D/g,"").startsWith("015"))||o(u||"").replace(/\D/g,"").startsWith("012")&&o(m||"").replace(/\D/g,"").startsWith("010")||o(u||"").replace(/\D/g,"").startsWith("011")&&o(m||"").replace(/\D/g,"").startsWith("010")||o(u||"").replace(/\D/g,"").startsWith("015")&&o(m||"").replace(/\D/g,"").startsWith("010"))&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رسوم التحويل"}),e.jsx(E,{type:"number",value:xe,onChange:t=>Y(t.target.value),placeholder:"0.00"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"تُخصم من المحفظة وتضاف للدرج"})]})]}),e.jsx(Q,{id:"txSubmitButton",type:"submit",className:`w-full ${x==="transfer"?"btn-transfer-confirm":"btn-withdraw-confirm"}`,children:x==="transfer"?"إرسال التحويل":"تنفيذ السحب"})]})})]}),e.jsxs(k,{children:[e.jsx(I,{children:e.jsx(D,{children:"المعاملات الأخيرة"})}),e.jsx(W,{children:f.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"لا توجد معاملات حديثة."}):e.jsx("div",{className:N||H?"receipts-list space-y-4 max-h-[310px] overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400":"receipts-list space-y-4",children:f.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(Xe,{className:`h-5 w-5 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(Je,{className:"h-5 w-5 text-yellow-500"}),t.status==="failed"&&e.jsx(et,{className:"h-5 w-5 text-red-500"})]}),e.jsxs("div",{children:[e.jsxs("p",{className:`font-medium ${t.type==="send"?"text-green-700":"text-red-700"}`,children:[t.type==="send"?"تحويل":"سحب"," - ",t.amount.toLocaleString()," جنيه"]}),t.type==="send"?e.jsxs("p",{className:"text-sm text-green-600",children:["من ",t.senderPhone," إلى ",t.receiverPhone]}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-sm text-red-500",children:["من ",t.senderPhone]}),t.senderName&&e.jsxs("p",{className:"text-xs text-red-400",children:["اسم الراسل: ",t.senderName]})]})]})]}),e.jsx(Ze,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})})]})]})]})},Jt=()=>{const g=_e(),[d,U]=s.useState(!1),[l,w]=s.useState(!0);return s.useEffect(()=>{(()=>{const ce=localStorage.getItem("dashboardAuth"),G=localStorage.getItem("dashboardUser");if(ce==="true"&&G)try{const N=JSON.parse(G),H=new Date(N.loginTime);(new Date().getTime()-H.getTime())/(1e3*60*60)<24?U(!0):(localStorage.removeItem("dashboardAuth"),localStorage.removeItem("dashboardUser"),g("/dashboard/login"))}catch(N){console.error("Error parsing user data:",N),g("/dashboard/login")}else g("/dashboard/login");w(!1)})()},[g]),l?e.jsx(Se,{}):d?e.jsx(tt,{}):e.jsx(Se,{})};export{Jt as default};
//# sourceMappingURL=ProtectedDashboard-C8t-KjRB-DudbAKrz.js.map
