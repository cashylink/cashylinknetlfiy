const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./UserDashboardPage-B-nZi7Q8.js","./index-DKHjTn06.js","./index-VBQ-m3Jj.css","./card-CdZ89wHA.js","./badge-dOZ4uC2s.js","./select-CNUPPz9r.js","./label-xK2gNCpt.js","./MasterPinDialog-CZFMuEah.js","./shield-BpPPeTvJ.js","./circle-alert--64_gie4.js","./walletDailyLimitsService-DdjjL_Zn.js","./wallet-CcB5ksMi.js","./star-Busk5wlQ.js","./square-pen-DmKhyk8U.js","./progress-CZUZSHBo.js","./phone-Bfk7DEDM.js","./arrow-left-Dg0WTfXV.js","./separator-hqlx8nZp.js","./commissionCalculator-DbNVJv5a.js","./calendar-n6d7WDHa.js","./chart-column-u2WPvv2c.js","./dollar-sign-CpfSiT3v.js","./ProfileIcon-iQttrBlC.js","./dropdown-menu-C65evTPM.js","./index-DyzQfDCv.js","./switch-XqQIkNpM.js","./circle-x-DCthG7Az.js","./circle-check-big-zx-PzrIn.js","./MaintenanceDialog-BuCRnuhC.js","./whatsappService-Ch9FyFNb.js","./download-C6bsx04M.js","./profitService-DRDD-Fph.js","./store-CgAhD43e.js","./broadcastService-C3ebSkVb.js","./textarea-BczUxm2s.js","./WalletsManagement-BI1Chrrb.js","./freeTrialService-ntIHdrwZ.js","./walletSelectionPinService-CdDSQUNH.js","./crown-BorW8ZAE.js"])))=>i.map(i=>d[i]);
import{u as F,r as u,$ as K,a as J,y as _,i as L,z as q,j as a,av as z,O as G,aw as Y,c as Q,ai as B,am as U,R as M,ae as H}from"./index-DKHjTn06.js";import{s as W,E as X}from"./broadcastService-C3ebSkVb.js";import{L as Z}from"./link-Q_kgv9mk.js";import{M as R}from"./MasterPinDialog-CZFMuEah.js";import"./label-xK2gNCpt.js";import"./shield-BpPPeTvJ.js";import"./circle-alert--64_gie4.js";const D="dismissedBroadcastIds",ee=()=>{const{user:t,profile:e,isSubscriptionActive:r,userSubscription:d}=F(),[g,f]=u.useState(null),[s,v]=u.useState(!1),[k,m]=u.useState(!1),[w,x]=u.useState([]),I=K(),b=J(),p=u.useMemo(()=>`dismissedBroadcastIds:${(t==null?void 0:t.uid)||"global"}`,[t==null?void 0:t.uid]),P=u.useMemo(()=>{const i=["global"];return e!=null&&e.shopId&&i.push(`shop:${e.shopId}`),t!=null&&t.uid&&i.push(`user:${t.uid}`),i},[e==null?void 0:e.shopId,t==null?void 0:t.uid]),E=I.pathname.startsWith("/admin");u.useEffect(()=>{if(!(t!=null&&t.uid))return;const i=_(L,"users",t.uid),l=q(i,o=>{const c=o.data(),h=Array.isArray(c==null?void 0:c.dismissedBroadcastIds)?c.dismissedBroadcastIds:[];x(h);try{const A=localStorage.getItem(p),S=A?JSON.parse(A):[],y=Array.from(new Set([...Array.isArray(S)?S:[],...h]));localStorage.setItem(p,JSON.stringify(y)),localStorage.setItem(D,JSON.stringify(y))}catch{}},o=>{console.error("UserBroadcastModal: onSnapshot user error",o)});return()=>l()},[t==null?void 0:t.uid,p]),u.useEffect(()=>{if(!t||E||!((e==null?void 0:e.approved)===!0||r||(d==null?void 0:d.isOnFreeTrial)===!0))return;const l=W(P,o=>{if(o){f(o);try{const c=localStorage.getItem(p),h=localStorage.getItem(D),A=c?JSON.parse(c):[],S=h?JSON.parse(h):[],y=Array.isArray(A)?[...A]:[];if(Array.isArray(S))for(const N of S)y.includes(N)||y.push(N);if(Array.isArray(w))for(const N of w)y.includes(N)||y.push(N);const V=o.id&&y.includes(o.id);v(!V),m(!1),requestAnimationFrame(()=>m(!0))}catch{v(!0),m(!0)}}});return()=>l()},[t,P,E,e==null?void 0:e.approved,r,d,w]);const n=async()=>{v(!1);try{const i=localStorage.getItem(p),l=i?JSON.parse(i):[],o=g==null?void 0:g.id;if(o&&!l.includes(o)){l.push(o),localStorage.setItem(p,JSON.stringify(l));try{localStorage.setItem(D,JSON.stringify(l))}catch{}try{t!=null&&t.uid&&await G(_(L,"users",t.uid),{dismissedBroadcastIds:Y(o)})}catch(c){console.warn("UserBroadcastModal: failed to update dismissedBroadcastIds in Firestore",c)}}}catch{}};return!s||!g?null:a.jsxs("div",{className:"fixed inset-0 z-[9999]",children:[a.jsx("div",{className:`absolute inset-0 transition-opacity duration-300 ease-out ${k?"opacity-100":"opacity-0"} bg-black/20 dark:bg-black/20`}),a.jsxs("div",{className:`absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] sm:w-auto sm:min-w-[380px] sm:max-w-md md:max-w-lg bg-white shadow-2xl rounded-2xl border border-gray-100 ring-1 ring-black/5 transition-all duration-300 ease-out ${k?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:[a.jsx("div",{className:"relative overflow-hidden rounded-t-2xl",children:a.jsxs("div",{className:"bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 relative",children:[a.jsx("button",{"aria-label":"Ø¥ØºÙ„Ø§Ù‚",onClick:n,className:"absolute top-3 right-3 p-2 rounded-full bg-white/10 hover:bg-white/20",children:a.jsx(z,{className:"w-5 h-5 text-white"})}),a.jsx("div",{className:"p-4",children:a.jsx("h3",{className:"text-base sm:text-lg font-semibold text-white tracking-wide text-center",children:g.title||"Ø¥Ø´Ø¹Ø§Ø±"})})]})}),a.jsx("div",{className:"p-5",children:a.jsxs("div",{className:"flex items-start justify-between gap-3",children:[a.jsx("p",{className:"text-gray-700 leading-relaxed text-sm sm:text-base",children:g.message}),g.linkUrl&&a.jsxs("button",{"aria-label":"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·",title:"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·",onClick:()=>{const i=g.linkUrl;/^https?:\/\//i.test(i)?window.open(i,"_blank","noopener"):b(i)},className:"shrink-0 inline-flex items-center gap-2 px-3 py-2 rounded-md bg-indigo-600 text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 whitespace-nowrap",children:[/^https?:\/\//i.test(g.linkUrl)?a.jsx(X,{className:"w-6 h-6"}):a.jsx(Z,{className:"w-6 h-6"}),a.jsx("span",{className:"text-xs sm:text-sm font-semibold",children:"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·"})]})]})})]})]})},T="quick_login_enabled",$="quick_login_session_verified";function C(t){return t?`${T}_${t}`:T}function O(t){return t?`${$}_${t}`:$}const j={isEnabled(t){try{return localStorage.getItem(C(t))==="true"}catch{return!1}},setEnabled(t,e){try{localStorage.setItem(C(e),t?"true":"false"),sessionStorage.removeItem(O(e))}catch{}},isSessionVerified(t){try{return sessionStorage.getItem(O(t))==="true"}catch{return!1}},markSessionVerified(t){try{sessionStorage.setItem(O(t),"true")}catch{}}},te=M.lazy(()=>H(()=>import("./UserDashboardPage-B-nZi7Q8.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38]),import.meta.url)),de=()=>{var E;const t=J(),{user:e,profile:r,loading:d,refreshProfile:g,isSubscriptionActive:f,userSubscription:s,checkSubscriptionStatus:v}=F(),[k,m]=u.useState(!1),[w,x]=u.useState(!1),{toast:I}=Q(),[b,p]=u.useState(!1);u.useEffect(()=>{const n=async i=>{const{userId:l,isActive:o}=i.detail;console.log("ðŸ”” ProtectedUserDashboard: Subscription update event received:",{userId:l,isActive:o,currentUserId:e==null?void 0:e.uid}),l===(e==null?void 0:e.uid)&&o&&(console.log("âœ… ProtectedUserDashboard: Subscription activated for current user, refreshing status"),await v(),m(!0),I({title:"ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ",description:"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…!"}))};return window.addEventListener("userSubscriptionUpdated",n),()=>{window.removeEventListener("userSubscriptionUpdated",n)}},[e==null?void 0:e.uid,v,I]),u.useEffect(()=>{var n,i;if(console.log("ProtectedUserDashboard - useEffect triggered",{loading:d,user:e?"exists":"null",profile:r?{role:r.role,approved:r.approved}:"null",isSubscriptionActive:f,userSubscription:s?"exists":"null"}),!d){if(!e)console.log("ProtectedUserDashboard - No user, redirecting to login"),t("/user/login");else if(r){if(console.log("ProtectedUserDashboard - Profile found:",{role:r.role,approved:r.approved,isSubscriptionActive:f,hasSubscription:!!(s!=null&&s.subscription)}),s){const c=((n=s==null?void 0:s.branchPackage)==null?void 0:n.status)==="active",h=(s==null?void 0:s.isOnFreeTrial)===!0;if(!(!!f||((i=s==null?void 0:s.subscription)==null?void 0:i.isActive)===!0||h)&&!c){try{t("/user/pending-approval",{replace:!0})}catch{}return}}r.role==="user"&&m(!0),console.log("ProtectedUserDashboard - User approved or admin, checking quick-login gate");const l=j.isEnabled(e==null?void 0:e.uid),o=j.isSessionVerified(e==null?void 0:e.uid);if(l&&!o){try{j.markSessionVerified(e==null?void 0:e.uid)}catch{}x(!1),m(!0)}else m(!0)}}},[e,r,d,t,f,s]),u.useEffect(()=>{let n=null;return!d&&e?p(!0):e&&(n=setTimeout(()=>p(!0),3e3)),()=>{try{clearTimeout(n)}catch{}}},[d,e]),u.useEffect(()=>{var o,c;if(d||!e||!b||!s)return;const n=((o=s==null?void 0:s.branchPackage)==null?void 0:o.status)==="active",i=(s==null?void 0:s.isOnFreeTrial)===!0;if(!(!!f||((c=s==null?void 0:s.subscription)==null?void 0:c.isActive)===!0||i)&&!n)try{t("/user/pending-approval")}catch{}},[d,e,s,f,t,b]),u.useEffect(()=>{if(d||!e||!b)return;const n=setInterval(async()=>{var c,h;try{await v()}catch{}const i=((c=s==null?void 0:s.branchPackage)==null?void 0:c.status)==="active",l=(s==null?void 0:s.isOnFreeTrial)===!0;if(!(!!f||((h=s==null?void 0:s.subscription)==null?void 0:h.isActive)===!0||l)&&!i)try{t("/user/pending-approval",{replace:!0})}catch{}},1e3);return()=>clearInterval(n)},[d,e,s,f,v,t,b]);const P=typeof window<"u"&&(window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:");return(E=B)!=null&&E.isNativePlatform&&B.getPlatform(),d&&(P||!e)?a.jsx(U,{}):b?k?(console.log("ProtectedUserDashboard - Render state:",{isAuthenticated:k,profileRole:r==null?void 0:r.role,profileApproved:r==null?void 0:r.approved,isSubscriptionActive:f,hasSubscription:!!(s!=null&&s.subscription)}),console.log("ðŸ”¥ ProtectedUserDashboard - user:",e?{uid:e.uid,email:e.email}:"null"),console.log("ðŸ”¥ ProtectedUserDashboard - profile:",r?{userId:r.userId,role:r.role}:"null"),console.log("ðŸ”¥ ProtectedUserDashboard - loading:",d),console.log("ðŸ”¥ ProtectedUserDashboard - About to render UserDashboardPage"),a.jsxs("div",{className:"relative",children:[a.jsx(M.Suspense,{fallback:a.jsx(U,{}),children:a.jsx(te,{})}),a.jsx(ee,{}),a.jsx(R,{open:w,onOpenChange:n=>x(n),mode:"verify",title:"Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹",description:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",onSuccess:()=>{j.markSessionVerified(e==null?void 0:e.uid),x(!1),m(!0)}})]})):a.jsxs(a.Fragment,{children:[a.jsx(U,{}),a.jsx(R,{open:w,onOpenChange:n=>x(n),mode:"verify",title:"Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹",description:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",onSuccess:()=>{j.markSessionVerified(e==null?void 0:e.uid),x(!1),m(!0)}})]}):a.jsx(U,{})};export{de as default};
//# sourceMappingURL=ProtectedUserDashboard-DSRaUmSn.js.map
