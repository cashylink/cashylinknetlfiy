const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-DhbnydJl.js","./index-DLaPizfT.css","./UserDashboardPage-XbIVMTiD.js","./SimCardsAccessDialog-Z5OgVyJn.js","./select-Bn8RCTk-.js","./VideoModal-w5Ot-7KI.js","./ProfileSettingsPage-DnVs4YJB.js","./switch-klIFyYmY.js","./square-pen-CSLFtBCt.js","./users-D9PlfCO2.js","./dollar-sign-AUKMnGdi.js","./circle-check-big-Dtvck6_a.js","./save-DZuHrrpv.js","./crown-D1WD830B.js","./arrow-left-DTf_k4UZ.js","./tabs-VyDQ-WsJ.js","./index-xL9tDy8r.js","./dropdown-menu-DhUxXtWv.js","./ProfileIcon-IxzO755X.js","./freeTrialService-u-lJSTVe.js","./broadcastService-BQWgcmoe.js","./bell-C-d1sJAh.js","./profitService-QTJQLMA0.js","./calendar-4dCWv1Gk.js","./arrow-down-left-DcYD3MrR.js","./wallet--cZcBirk.js","./printer-DeiqlOce.js","./star-BSPZIAqJ.js"])))=>i.map(i=>d[i]);
import{u as z,r as d,a6 as Z,a as Q,j as i,aq as ee,W as F,t as J,aN as W,an as te,bi as se,m as ae,b5 as R,bh as E,aG as K,R as H}from"./index-DhbnydJl.js";import{s as ie,E as re}from"./broadcastService-BQWgcmoe.js";import{L as ne}from"./link-Dfi0T6IH.js";const V="dismissedBroadcastIds",oe=()=>{const{user:t,profile:e,isSubscriptionActive:c,userSubscription:l}=z(),[v,y]=d.useState(null),[s,k]=d.useState(!1),[S,x]=d.useState(!1),[P,w]=d.useState([]),D=Z(),N=Q(),A=d.useMemo(()=>`dismissedBroadcastIds:${(t==null?void 0:t.uid)||"global"}`,[t==null?void 0:t.uid]),j=d.useMemo(()=>{const f=["global"];return e!=null&&e.shopId&&f.push(`shop:${e.shopId}`),t!=null&&t.uid&&f.push(`user:${t.uid}`),f},[e==null?void 0:e.shopId,t==null?void 0:t.uid]),_=D.pathname.startsWith("/admin");d.useEffect(()=>{if(!(t!=null&&t.uid))return;(async()=>{try{const h=F(J,"users",t.uid),r=await W(()=>import("./index-DhbnydJl.js").then(n=>n.cP),__vite__mapDeps([0,1]),import.meta.url).then(n=>n.getDoc(h));if(r.exists()){const n=r.data(),a=Array.isArray(n==null?void 0:n.dismissedBroadcastIds)?n.dismissedBroadcastIds:[];w(a);try{const m=localStorage.getItem(A),p=m?JSON.parse(m):[],u=Array.from(new Set([...Array.isArray(p)?p:[],...a]));localStorage.setItem(A,JSON.stringify(u)),localStorage.setItem(V,JSON.stringify(u))}catch{}}}catch(h){console.error("UserBroadcastModal: fetch user error",h)}})()},[t==null?void 0:t.uid,A]),d.useEffect(()=>{if(!t||_||!((e==null?void 0:e.approved)===!0||c||(l==null?void 0:l.isOnFreeTrial)===!0))return;const h=ie(j,r=>{if(r){y(r);try{const n=localStorage.getItem(A),a=localStorage.getItem(V),m=n?JSON.parse(n):[],p=a?JSON.parse(a):[],u=Array.isArray(m)?[...m]:[];if(Array.isArray(p))for(const o of p)u.includes(o)||u.push(o);if(Array.isArray(P))for(const o of P)u.includes(o)||u.push(o);const g=r.id&&u.includes(r.id);k(!g),x(!1),requestAnimationFrame(()=>x(!0))}catch{k(!0),x(!0)}}});return()=>h()},[t,j,_,e==null?void 0:e.approved,c,l,P]);const $=async()=>{k(!1);try{const f=localStorage.getItem(A),h=f?JSON.parse(f):[],r=v==null?void 0:v.id;if(r&&!h.includes(r)){h.push(r),localStorage.setItem(A,JSON.stringify(h));try{localStorage.setItem(V,JSON.stringify(h))}catch{}try{t!=null&&t.uid&&await te(F(J,"users",t.uid),{dismissedBroadcastIds:se(r)})}catch(n){console.warn("UserBroadcastModal: failed to update dismissedBroadcastIds in Firestore",n)}}}catch{}};return!s||!v?null:i.jsxs("div",{className:"fixed inset-0 z-[9999]",children:[i.jsx("div",{className:`absolute inset-0 transition-opacity duration-300 ease-out ${S?"opacity-100":"opacity-0"} bg-black/20 dark:bg-black/20`}),i.jsxs("div",{className:`absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] sm:w-auto sm:min-w-[380px] sm:max-w-md md:max-w-lg bg-white shadow-2xl rounded-2xl border border-gray-100 ring-1 ring-black/5 transition-all duration-300 ease-out ${S?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:[i.jsx("div",{className:"relative overflow-hidden rounded-t-2xl",children:i.jsxs("div",{className:"bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 relative",children:[i.jsx("button",{"aria-label":"Ø¥ØºÙ„Ø§Ù‚",onClick:$,className:"absolute top-3 right-3 p-2 rounded-full bg-white/10 hover:bg-white/20",children:i.jsx(ee,{className:"w-5 h-5 text-white"})}),i.jsx("div",{className:"p-4",children:i.jsx("h3",{className:"text-base sm:text-lg font-semibold text-white tracking-wide text-center",children:v.title||"Ø¥Ø´Ø¹Ø§Ø±"})})]})}),i.jsx("div",{className:"p-5",children:i.jsxs("div",{className:"flex items-start justify-between gap-3",children:[i.jsx("p",{className:"text-gray-700 leading-relaxed text-sm sm:text-base",children:v.message}),v.linkUrl&&i.jsxs("button",{"aria-label":"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·",title:"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·",onClick:()=>{const f=v.linkUrl;/^https?:\/\//i.test(f)?window.open(f,"_blank","noopener"):N(f)},className:"shrink-0 inline-flex items-center gap-2 px-3 py-2 rounded-md bg-indigo-600 text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 whitespace-nowrap",children:[/^https?:\/\//i.test(v.linkUrl)?i.jsx(re,{className:"w-6 h-6"}):i.jsx(ne,{className:"w-6 h-6"}),i.jsx("span",{className:"text-xs sm:text-sm font-semibold",children:v.actionText||"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·"})]})]})})]})]})},M="quick_login_enabled",G="quick_login_session_verified";function Y(t){return t?`${M}_${t}`:M}function B(t){return t?`${G}_${t}`:G}const I={isEnabled(t){try{return localStorage.getItem(Y(t))==="true"}catch{return!1}},setEnabled(t,e){try{localStorage.setItem(Y(e),t?"true":"false"),sessionStorage.removeItem(B(e))}catch{}},isSessionVerified(t){try{return sessionStorage.getItem(B(t))==="true"}catch{return!1}},markSessionVerified(t){try{sessionStorage.setItem(B(t),"true")}catch{}}},ce=H.lazy(()=>W(()=>import("./UserDashboardPage-XbIVMTiD.js").then(t=>t.U),__vite__mapDeps([2,0,1,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27]),import.meta.url)),fe=()=>{var f,h;const t=Q(),{user:e,profile:c,loading:l,refreshProfile:v,isSubscriptionActive:y,userSubscription:s,checkSubscriptionStatus:k}=z(),[S,x]=d.useState(!1),[P,w]=d.useState(!1);ae();const[D,N]=d.useState(!1);d.useEffect(()=>{S&&e&&(async()=>{var n;try{if(!(((n=R)==null?void 0:n.isNativePlatform)&&R.getPlatform()==="android")||localStorage.getItem("hasRequestedSmsPermissionAfterLogin")==="true")return;localStorage.setItem("hasRequestedSmsPermissionAfterLogin","true"),setTimeout(()=>{try{window.location.href="cashy://openNotificationSettings"}catch{}},1500)}catch{}})()},[S,e]),d.useEffect(()=>{if(!(e!=null&&e.uid)||!s)return;const n=setInterval(()=>{var o,O,U,T,L;const a=s;if(!a)return;const m=new Date;let p=!1;if(a!=null&&a.isOnFreeTrial){const b=(o=a.freeTrialEndDate)!=null&&o.toDate?a.freeTrialEndDate.toDate():a.freeTrialEndDate?new Date(a.freeTrialEndDate):null;p=b&&m<b}let u=!1;if((O=a==null?void 0:a.subscription)!=null&&O.isActive){const b=(U=a.subscription.endDate)!=null&&U.toDate?a.subscription.endDate.toDate():a.subscription.endDate?new Date(a.subscription.endDate):null;u=!b||m<b}let g=!1;if(((T=a==null?void 0:a.branchPackage)==null?void 0:T.status)==="active"){const b=(L=a.branchPackage.endDate)!=null&&L.toDate?a.branchPackage.endDate.toDate():a.branchPackage.endDate?new Date(a.branchPackage.endDate):null;g=!b||m<b}!p&&!u&&!g&&(console.log("ProtectedUserDashboard: All access methods expired client-side."),t("/user/pending-approval"))},60*60*1e3);return()=>clearInterval(n)},[e==null?void 0:e.uid,s,t]),d.useEffect(()=>()=>{},[]),d.useEffect(()=>{var r;if(console.log("ProtectedUserDashboard - useEffect triggered",{loading:l,user:e?"exists":"null",profile:c?{role:c.role,approved:c.approved}:"null",isSubscriptionActive:y,userSubscription:s?"exists":"null"}),!l){if(!e)console.log("ProtectedUserDashboard - No user, redirecting to login"),t("/user/login");else if(c)if(console.log("ProtectedUserDashboard - Profile found:",{role:c.role,approved:c.approved,isSubscriptionActive:y,hasSubscription:!!(s!=null&&s.subscription)}),s){const n=((r=s==null?void 0:s.branchPackage)==null?void 0:r.status)==="active",a=(s==null?void 0:s.isOnFreeTrial)===!0;if(!(!!y||a)&&!n){try{t("/user/pending-approval",{replace:!0})}catch{}return}c.role==="user"&&x(!0);const u=I.isEnabled(e==null?void 0:e.uid),g=I.isSessionVerified(e==null?void 0:e.uid);if(u&&!g){try{I.markSessionVerified(e==null?void 0:e.uid)}catch{}w(!1),x(!0)}else x(!0)}else{try{k()}catch{}return}}},[e,c,l,t,y,s]),d.useEffect(()=>{let r=null;return!l&&e?N(!0):e&&(r=setTimeout(()=>N(!0),3e3)),()=>{try{clearTimeout(r)}catch{}}},[l,e]),d.useEffect(()=>{var u;if(l||!e||!D||!s)return;const r=(s==null?void 0:s.isActive)!==!1,n=((u=s==null?void 0:s.branchPackage)==null?void 0:u.status)==="active",a=(s==null?void 0:s.isOnFreeTrial)===!0,m=!!y||a,p=g=>{var q,C;if(!g)return"null";const o=g.subscription,O=o!=null&&o.activatedAt?o.activatedAt.toDate?o.activatedAt.toDate().toISOString():new Date(o.activatedAt).toISOString():"null",U=(o==null?void 0:o.planType)||"null",T=g.isActive!==!1,L=(o==null?void 0:o.isActive)===!0,b=((q=g.branchPackage)==null?void 0:q.status)==="active",X=(C=g.branchPackage)!=null&&C.activatedAt?g.branchPackage.activatedAt.toDate?g.branchPackage.activatedAt.toDate().toISOString():new Date(g.branchPackage.activatedAt).toISOString():"null";return`${T}|${L}|${U}|${O}|${b}|${X}`};if(!r){console.log("â›” ProtectedUserDashboard: Account is deactivated, redirecting to pending approval");try{sessionStorage.setItem("dashboard_kick_signature",p(s)),t("/user/pending-approval",{replace:!0})}catch{}return}if(!m&&!n)try{sessionStorage.setItem("dashboard_kick_signature",p(s)),t("/user/pending-approval")}catch{}},[l,e,s,y,t,D]),d.useEffect(()=>{},[l,e,s,y,k,t,D]);const A=typeof window<"u"&&(window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:");if((f=R)!=null&&f.isNativePlatform&&R.getPlatform(),l&&(A||!e))return i.jsx(E,{});if(!D)return i.jsx(E,{});if(e&&!l&&!s)return i.jsx(E,{});const j=(s==null?void 0:s.isOnFreeTrial)===!0,_=((h=s==null?void 0:s.branchPackage)==null?void 0:h.status)==="active";return e&&!l&&s&&!(!!y||j||_)?i.jsx(E,{}):S?(console.log("ProtectedUserDashboard - Render state:",{isAuthenticated:S,profileRole:c==null?void 0:c.role,profileApproved:c==null?void 0:c.approved,isSubscriptionActive:y,hasSubscription:!!(s!=null&&s.subscription)}),console.log("ðŸ”¥ ProtectedUserDashboard - user:",e?{uid:e.uid,email:e.email}:"null"),console.log("ðŸ”¥ ProtectedUserDashboard - profile:",c?{userId:c.userId,role:c.role}:"null"),console.log("ðŸ”¥ ProtectedUserDashboard - loading:",l),console.log("ðŸ”¥ ProtectedUserDashboard - About to render UserDashboardPage"),i.jsxs("div",{className:"relative",children:[i.jsx(H.Suspense,{fallback:i.jsx(E,{}),children:i.jsx(ce,{})}),i.jsx(oe,{}),i.jsx(K,{open:P,onOpenChange:r=>w(r),mode:"verify",title:"Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹",description:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",onSuccess:()=>{I.markSessionVerified(e==null?void 0:e.uid),w(!1),x(!0)}})]})):i.jsxs(i.Fragment,{children:[i.jsx(E,{}),i.jsx(K,{open:P,onOpenChange:r=>w(r),mode:"verify",title:"Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹",description:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",onSuccess:()=>{I.markSessionVerified(e==null?void 0:e.uid),w(!1),x(!0)}})]})};export{fe as default};
//# sourceMappingURL=ProtectedUserDashboard-c6O-i0ck.js.map
