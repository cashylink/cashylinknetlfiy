{"version":3,"file":"ChangePinDialog-B49Baih-.js","sources":["../../src/components/ChangePinDialog.tsx"],"sourcesContent":["import React, { useState, useEffect } from 'react';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Lock, Eye, EyeOff, AlertCircle, Settings } from 'lucide-react';\nimport { MasterPinService } from '@/utils/masterPinService';\nimport { useToast } from '@/hooks/use-toast';\n\ninterface ChangePinDialogProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  userId?: string;\n}\n\nexport function ChangePinDialog({ open, onOpenChange, userId }: ChangePinDialogProps) {\n  const [currentPin, setCurrentPin] = useState('');\n  const [newPin, setNewPin] = useState('');\n  const [confirmPin, setConfirmPin] = useState('');\n  const [showCurrentPin, setShowCurrentPin] = useState(false);\n  const [showNewPin, setShowNewPin] = useState(false);\n  const [showConfirmPin, setShowConfirmPin] = useState(false);\n  const [error, setError] = useState('');\n  const [isLoading, setIsLoading] = useState(false);\n  const [hasExistingPin, setHasExistingPin] = useState(false);\n  const { toast } = useToast();\n  const formRef = React.useRef<HTMLFormElement>(null);\n\n  useEffect(() => {\n    let mounted = true;\n    (async () => {\n      const has = await MasterPinService.hasMasterPin(userId);\n      if (mounted) setHasExistingPin(has);\n    })();\n    return () => { mounted = false; };\n  }, [userId, open]);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setError('');\n    setIsLoading(true);\n\n    try {\n      // التحقق من صحة البيانات المدخلة\n      if (!newPin || newPin.length < 4) {\n        setError('يجب أن يكون الرقم السري 4 أرقام على الأقل');\n        setIsLoading(false);\n        return;\n      }\n\n      if (newPin !== confirmPin) {\n        setError('الرقم السري الجديد وتأكيده غير متطابقين');\n        setIsLoading(false);\n        return;\n      }\n\n      // إذا كان هناك رقم سري موجود، يجب التحقق منه أولاً\n      if (hasExistingPin) {\n        if (!currentPin) {\n          setError('يرجى إدخال الرقم السري الحالي');\n          setIsLoading(false);\n          return;\n        }\n\n        const ok = await MasterPinService.verifyMasterPin(currentPin, userId);\n        if (!ok) {\n          setError('الرقم السري الحالي غير صحيح');\n          setIsLoading(false);\n          return;\n        }\n      }\n\n      // حفظ الرقم السري الجديد\n      const changed = hasExistingPin\n        ? await MasterPinService.changeMasterPin(currentPin, newPin, userId)\n        : await MasterPinService.createMasterPin(newPin, userId);\n\n      if (!changed) {\n        setError('تعذر حفظ الرقم السري');\n        setIsLoading(false);\n        return;\n      }\n\n      // إظهار رسالة نجاح\n      toast({\n        title: hasExistingPin ? \"تم تغيير الرقم السري\" : \"تم تعيين الرقم السري\",\n        description: hasExistingPin \n          ? \"تم تغيير الرقم السري بنجاح (سيتم تطبيقه على جميع النوافذ)\" \n          : \"تم تعيين الرقم السري بنجاح (سيتم تطبيقه على جميع النوافذ)\",\n      });\n\n      // إغلاق النافذة وإعادة تعيين الحقول\n      handleClose();\n    } catch (error) {\n      setError('حدث خطأ أثناء حفظ الرقم السري');\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleClose = () => {\n    setCurrentPin('');\n    setNewPin('');\n    setConfirmPin('');\n    setError('');\n    setShowCurrentPin(false);\n    setShowNewPin(false);\n    setShowConfirmPin(false);\n    onOpenChange(false);\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={handleClose}>\n      <DialogContent className=\"sm:max-w-[425px]\" dir=\"rtl\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2 text-right\">\n            <Settings className=\"h-5 w-5 text-gray-600\" />\n            {hasExistingPin ? \"تغيير الرقم السري الرئيسي\" : \"تعيين الرقم السري الرئيسي\"}\n          </DialogTitle>\n        </DialogHeader>\n\n        <form ref={formRef} onSubmit={handleSubmit} className=\"space-y-4 py-4\">\n          <div className=\"bg-blue-50 p-3 rounded-md text-sm text-blue-700 mb-4 flex items-start gap-2\">\n            <AlertCircle className=\"h-4 w-4 mt-0.5 shrink-0\" />\n            <p>\n              هذا الرقم السري موحد لجميع العمليات الحساسة في التطبيق.\n            </p>\n          </div>\n\n          {error && (\n            <div className=\"bg-red-50 text-red-600 p-3 rounded-md text-sm flex items-center gap-2\">\n              <AlertCircle className=\"h-4 w-4\" />\n              {error}\n            </div>\n          )}\n\n          {hasExistingPin && (\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"current-pin\">الرقم السري الحالي</Label>\n              <div className=\"relative\">\n                <Lock className=\"absolute right-3 top-2.5 h-4 w-4 text-gray-500\" />\n                <Input\n                  id=\"current-pin\"\n                  type={showCurrentPin ? \"text\" : \"password\"}\n                  value={currentPin}\n                  onChange={(e) => setCurrentPin(e.target.value)}\n                  onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); formRef.current?.requestSubmit(); } }}\n                  className=\"pr-10 pl-10 text-left\"\n                  dir=\"ltr\"\n                  placeholder=\"****\"\n                />\n                <button\n                  type=\"button\"\n                  onClick={() => setShowCurrentPin(!showCurrentPin)}\n                  className=\"absolute left-3 top-2.5 text-gray-500 hover:text-gray-700\"\n                >\n                  {showCurrentPin ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n                </button>\n              </div>\n            </div>\n          )}\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"new-pin\">الرقم السري الجديد</Label>\n            <div className=\"relative\">\n              <Lock className=\"absolute right-3 top-2.5 h-4 w-4 text-gray-500\" />\n              <Input\n                id=\"new-pin\"\n                type={showNewPin ? \"text\" : \"password\"}\n                value={newPin}\n                onChange={(e) => setNewPin(e.target.value)}\n                onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); formRef.current?.requestSubmit(); } }}\n                className=\"pr-10 pl-10 text-left\"\n                dir=\"ltr\"\n                placeholder=\"****\"\n              />\n              <button\n                type=\"button\"\n                onClick={() => setShowNewPin(!showNewPin)}\n                className=\"absolute left-3 top-2.5 text-gray-500 hover:text-gray-700\"\n              >\n                {showNewPin ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n              </button>\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"confirm-pin\">تأكيد الرقم السري الجديد</Label>\n            <div className=\"relative\">\n              <Lock className=\"absolute right-3 top-2.5 h-4 w-4 text-gray-500\" />\n              <Input\n                id=\"confirm-pin\"\n                type={showConfirmPin ? \"text\" : \"password\"}\n                value={confirmPin}\n                onChange={(e) => setConfirmPin(e.target.value)}\n                onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); formRef.current?.requestSubmit(); } }}\n                className=\"pr-10 pl-10 text-left\"\n                dir=\"ltr\"\n                placeholder=\"****\"\n              />\n              <button\n                type=\"button\"\n                onClick={() => setShowConfirmPin(!showConfirmPin)}\n                className=\"absolute left-3 top-2.5 text-gray-500 hover:text-gray-700\"\n              >\n                {showConfirmPin ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n              </button>\n            </div>\n          </div>\n\n          <div className=\"flex justify-end gap-3 mt-6\">\n            <Button type=\"button\" variant=\"outline\" onClick={handleClose}>\n              إلغاء\n            </Button>\n            <Button type=\"submit\" disabled={isLoading} className=\"bg-blue-600 hover:bg-blue-700 text-white\">\n              {isLoading ? 'جاري الحفظ...' : (hasExistingPin ? 'تغيير الرقم السري' : 'تعيين الرقم السري')}\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n"],"names":["ChangePinDialog","open","onOpenChange","userId","currentPin","setCurrentPin","useState","newPin","setNewPin","confirmPin","setConfirmPin","showCurrentPin","setShowCurrentPin","showNewPin","setShowNewPin","showConfirmPin","setShowConfirmPin","error","setError","isLoading","setIsLoading","hasExistingPin","setHasExistingPin","toast","useToast","formRef","React","useEffect","mounted","has","MasterPinService","handleSubmit","e","handleClose","jsx","Dialog","DialogContent","DialogHeader","jsxs","DialogTitle","Settings","AlertCircle","Label","Lock","Input","_a","EyeOff","Eye","Button"],"mappings":"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"}