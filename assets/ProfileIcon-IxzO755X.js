const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./ProfileSettingsPage-DnVs4YJB.js","./index-DhbnydJl.js","./index-DLaPizfT.css","./switch-klIFyYmY.js","./square-pen-CSLFtBCt.js","./VideoModal-w5Ot-7KI.js","./select-Bn8RCTk-.js","./users-D9PlfCO2.js","./dollar-sign-AUKMnGdi.js","./circle-check-big-Dtvck6_a.js","./save-DZuHrrpv.js","./crown-D1WD830B.js","./arrow-left-DTf_k4UZ.js"])))=>i.map(i=>d[i]);
import{a0 as me,u as se,m as te,r as a,j as e,aa as Y,ab as q,ac as re,ad as ne,aI as we,y as z,I as W,B as j,J as $,K as H,aR as ge,bb as ae,aG as pe,bB as xe,bC as ve,bD as be,a as je,aM as Pe,bE as Se,bF as Ne,aE as ye,aW as ke,R as Ce,aN as _e}from"./index-DhbnydJl.js";import{g as Ee}from"./switch-klIFyYmY.js";import{FreeTrialService as Ie}from"./freeTrialService-u-lJSTVe.js";/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=[["path",{d:"M12 13v8l-4-4",key:"1f5nwf"}],["path",{d:"m12 21 4-4",key:"1lfcce"}],["path",{d:"M4.393 15.269A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.436 8.284",key:"ui1hmy"}]],Oe=me("cloud-download",Ue);function De({open:k,onOpenChange:r}){const{user:o,profile:P}=se(),{toast:h}=te(),[p,I]=a.useState(!1),[T,V]=a.useState(!1),[c,J]=a.useState(!1),[L,X]=a.useState(!1),[Q,U]=a.useState(!1),[Z,O]=a.useState(!1),[w,C]=a.useState({currentPassword:"",newPassword:"",confirmPassword:""}),[m,i]=a.useState({currentPassword:"",newPassword:"",confirmPassword:""}),S=()=>{const n={currentPassword:"",newPassword:"",confirmPassword:""};return w.currentPassword||(n.currentPassword="كلمة المرور الحالية مطلوبة"),w.newPassword?w.newPassword.length<6&&(n.newPassword="كلمة المرور يجب أن تكون 6 أحرف على الأقل"):n.newPassword="كلمة المرور الجديدة مطلوبة",w.confirmPassword?w.newPassword!==w.confirmPassword&&(n.confirmPassword="كلمات المرور غير متطابقة"):n.confirmPassword="تأكيد كلمة المرور مطلوب",i(n),!Object.values(n).some(d=>d!=="")},D=async n=>{if(n.preventDefault(),!(!S()||!o||!o.email)){I(!0);try{const d=xe.credential(o.email,w.currentPassword);await ve(o,d),O(!0),U(!0),h({title:"تأكيد الهوية",description:"أدخل الرقم السري الرئيسي لتأكيد تغيير كلمة المرور"})}catch(d){console.error("خطأ في تغيير كلمة المرور:",d);let y="حدث خطأ أثناء تغيير كلمة المرور";if(d.code==="auth/wrong-password"){i(_=>({..._,currentPassword:"كلمة المرور الحالية غير صحيحة"}));return}else if(d.code==="auth/weak-password"){i(_=>({..._,newPassword:"كلمة المرور ضعيفة جداً"}));return}else d.code==="auth/requires-recent-login"&&(y="يجب تسجيل الدخول مرة أخرى لتغيير كلمة المرور");h({title:"خطأ في تغيير كلمة المرور",description:y,variant:"destructive"})}finally{I(!1)}}},x=async()=>{if(o){I(!0);try{await be(o,w.newPassword),h({title:"تم تغيير كلمة المرور بنجاح",description:"تم تحديث كلمة المرور الخاصة بك بنجاح"}),C({currentPassword:"",newPassword:"",confirmPassword:""}),i({currentPassword:"",newPassword:"",confirmPassword:""}),U(!1),O(!1),r(!1)}catch(n){console.error("خطأ في تحديث كلمة المرور:",n);let d="حدث خطأ أثناء تغيير كلمة المرور";n.code==="auth/requires-recent-login"&&(d="انتهت جلسة المصادقة. يرجى إعادة إدخال كلمة المرور الحالية"),h({title:"خطأ في تغيير كلمة المرور",description:d,variant:"destructive"})}finally{I(!1)}}},F=n=>d=>{C(y=>({...y,[n]:d.target.value})),m[n]&&i(y=>({...y,[n]:""}))},N=()=>{C({currentPassword:"",newPassword:"",confirmPassword:""}),i({currentPassword:"",newPassword:"",confirmPassword:""}),U(!1),O(!1),r(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(Y,{open:k,onOpenChange:N,children:e.jsxs(q,{className:"sm:max-w-[425px]",children:[e.jsxs(re,{children:[e.jsx(ne,{children:"تغيير كلمة المرور"}),e.jsx(we,{children:"أدخل كلمة المرور الحالية وكلمة المرور الجديدة لتحديث حسابك"})]}),e.jsxs("form",{onSubmit:D,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"currentPassword",children:"كلمة المرور الحالية"}),e.jsxs("div",{className:"relative",children:[e.jsx(W,{id:"currentPassword",type:T?"text":"password",value:w.currentPassword,onChange:F("currentPassword"),className:m.currentPassword?"border-red-500":"",autoComplete:"off",disabled:p}),e.jsx(j,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>V(!T),disabled:p,children:T?e.jsx($,{className:"h-4 w-4"}):e.jsx(H,{className:"h-4 w-4"})})]}),m.currentPassword&&e.jsx("p",{className:"text-sm text-red-500",children:m.currentPassword})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"newPassword",children:"كلمة المرور الجديدة"}),e.jsxs("div",{className:"relative",children:[e.jsx(W,{id:"newPassword",type:c?"text":"password",value:w.newPassword,onChange:F("newPassword"),className:m.newPassword?"border-red-500":"",autoComplete:"new-password",disabled:p}),e.jsx(j,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>J(!c),disabled:p,children:c?e.jsx($,{className:"h-4 w-4"}):e.jsx(H,{className:"h-4 w-4"})})]}),m.newPassword&&e.jsx("p",{className:"text-sm text-red-500",children:m.newPassword})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"confirmPassword",children:"تأكيد كلمة المرور الجديدة"}),e.jsxs("div",{className:"relative",children:[e.jsx(W,{id:"confirmPassword",type:L?"text":"password",value:w.confirmPassword,onChange:F("confirmPassword"),className:m.confirmPassword?"border-red-500":"",autoComplete:"new-password",disabled:p}),e.jsx(j,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>X(!L),disabled:p,children:L?e.jsx($,{className:"h-4 w-4"}):e.jsx(H,{className:"h-4 w-4"})})]}),m.confirmPassword&&e.jsx("p",{className:"text-sm text-red-500",children:m.confirmPassword})]}),e.jsxs(ge,{children:[e.jsx(j,{type:"button",variant:"outline",onClick:N,disabled:p,children:"إلغاء"}),e.jsxs(j,{type:"submit",disabled:p,children:[p&&e.jsx(ae,{className:"mr-2 h-4 w-4 animate-spin"}),"تغيير كلمة المرور"]})]})]})]})}),e.jsx(pe,{open:Q&&Z,onOpenChange:n=>{U(n),n||O(!1)},mode:"verify",title:"التحقق من الرقم السري الرئيسي",description:"لا يمكن تغيير كلمة المرور إلا بعد التحقق من الرقم السري الرئيسي",userId:o==null?void 0:o.uid,userRole:P==null?void 0:P.role,onSuccess:x,onCancel:()=>{U(!1),O(!1)}})]})}const Re="cashy.google.accessToken",Te="cashy.google.email",Ve="cashy.google.expiresAt";function Fe(){try{const k=localStorage.getItem(Re),r=localStorage.getItem(Te),o=localStorage.getItem(Ve),P=o?Number(o):null;return{token:k,email:r,expiresAt:P}}catch{return{token:null,email:null,expiresAt:null}}}async function Le(k,r,o){try{const P=await fetch("/user/google-backup-token",{method:"POST",headers:{"Content-Type":"application/json","X-USER-ID":k},body:JSON.stringify({email:r,refresh_token:o})}),h=await P.json().catch(()=>({}));return!!(P.ok&&(h!=null&&h.ok))}catch{return!1}}const Ae=Ce.lazy(()=>_e(()=>import("./ProfileSettingsPage-DnVs4YJB.js").then(k=>k.b),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12]),import.meta.url));function He({className:k}){const{user:r,profile:o,signOut:P,updateUserProfile:h}=se();je();const[p,I]=a.useState(!1),{isShiftActive:T,shiftUser:V}=Pe(),{toast:c}=te(),[J,L]=a.useState(!1),[X,Q]=a.useState(!1),[U,Z]=a.useState(!1),[{token:O},w]=a.useState(()=>Fe()),[C,m]=a.useState(!1),i=typeof window<"u"?window.electronAPI:void 0,S=!!i,[D,x]=a.useState(!1),[F,N]=a.useState(!1),[n,d]=a.useState(""),[y,_]=a.useState(""),[E,ee]=a.useState(!1),[v,G]=a.useState(0),[B,A]=a.useState(!1),[ie,oe]=a.useState(""),[f,ce]=a.useState(""),[Me,Ge]=a.useState(!1),[Be,le]=a.useState(0),[Ke,de]=a.useState(!1),[ue,K]=a.useState(!1);a.useEffect(()=>{(async()=>{if(!(r!=null&&r.uid))return;const t=await Ie.checkTrialValidity(r.uid);de(t.isValid&&!t.isExpired),le(t.hoursRemaining)})()},[r==null?void 0:r.uid]);const b=(s,t)=>{const l=String(s||"").split(".").map(u=>parseInt(u,10)||0),g=String(t||"").split(".").map(u=>parseInt(u,10)||0);for(let u=0;u<Math.max(l.length,g.length);u++){const R=l[u]||0,M=g[u]||0;if(R>M)return 1;if(R<M)return-1}return 0};a.useEffect(()=>{if(!(!S||!i))try{i.onUpdateAvailable(s=>{var l,g,u;const t=String(((l=s==null?void 0:s.info)==null?void 0:l.version)||"");d(t),_(String(((g=s==null?void 0:s.info)==null?void 0:g.notes)||"")),ee(!!((u=s==null?void 0:s.info)!=null&&u.force)),b(t,f)>0?x(!0):x(!1)}),i.onUpdateDownloaded(s=>{var l,g;const t=String(((l=s==null?void 0:s.info)==null?void 0:l.version)||"");d(t),_(String(((g=s==null?void 0:s.info)==null?void 0:g.notes)||"")),A(!1),G(100),b(t,f)>0?x(!0):x(!1);try{S&&(r!=null&&r.uid)&&t&&(h==null||h({lastAckDesktopVersion:t}))}catch{}}),i.onUpdateError(s=>{try{c({title:"فشل التحديث",description:String((s==null?void 0:s.message)||(s==null?void 0:s.code)||"تعذر التحميل"),variant:"destructive"})}catch{}}),typeof i.onUpdateProgress=="function"&&i.onUpdateProgress(s=>{const t=(s==null?void 0:s.percent)==null?0:Number(s.percent);A(!0),G(Math.max(0,Math.min(100,isNaN(t)?0:t)))}),typeof i.appVersion=="function"&&i.appVersion().then(s=>{typeof s=="string"&&ce(s);try{S&&(r!=null&&r.uid)&&typeof s=="string"&&s&&(h==null||h({desktopInstalledVersion:s}))}catch{}}).catch(()=>{})}catch{}},[S,i]),a.useEffect(()=>{S&&v>=100&&N(!0)},[S,v]),a.useEffect(()=>{const s=Se(t=>{const l=String((t==null?void 0:t.version)||""),u=`desktop_update_seen_${String((r==null?void 0:r.uid)||"anon")}`;let R="";try{R=localStorage.getItem(u)||""}catch{}d(l),_(String((t==null?void 0:t.notes)||"")),ee((t==null?void 0:t.force)||!1);const M=Ne({downloadURL_64:t==null?void 0:t.downloadURL_64,downloadURL_32:t==null?void 0:t.downloadURL_32})||"";oe(M),l&&f&&(b(l,f)>0?(x(!0),R===l&&!(t!=null&&t.force)||N(!0)):(x(!1),N(!1)))});return()=>{try{s()}catch{}}},[f,r==null?void 0:r.uid]);const he=async()=>{var s;try{if(i){try{await i.checkUpdate()}catch{}N(!0),A(!0),G(0);const t=await((s=i.downloadUpdate)==null?void 0:s.call(i,ie))??await i.downloadUpdate();if(typeof t=="string"&&t.startsWith("err:")){try{c({title:"فشل التحديث",description:t.slice(4),variant:"destructive"})}catch{}A(!1)}else if(t==="noop")try{c({title:"لا يوجد تحديث",description:"لا تتوفر نسخة أحدث حالياً."})}catch{}else if(t==="manual")try{c({title:"جارٍ تنزيل التحديث",description:"سيتم تطبيق التحديث تلقائيًا بعد اكتمال التنزيل."})}catch{}else if(t==="autoUpdater")try{c({title:"تنزيل تلقائي",description:"سيتم تطبيق التحديث تلقائياً بواسطة النظام."})}catch{}}}catch(t){try{c({title:"فشل التحديث",description:(t==null?void 0:t.message)||"حدث خطأ أثناء التنزيل",variant:"destructive"})}catch{}}};if(o!=null&&o.avatarId&&Ee(o.avatarId),a.useEffect(()=>{console.log("Profile updated in ProfileIcon:",o==null?void 0:o.avatarId)},[o==null?void 0:o.avatarId]),a.useEffect(()=>{const s=async t=>{try{if(!(t!=null&&t.data)||typeof t.data!="object"||t.origin!=="https://cashy.link")return;const{type:l,email:g,refresh_token:u}=t.data||{};l==="cashy_oauth_token"&&(r!=null&&r.uid)&&g&&u&&await Le(r.uid,String(g),String(u))&&c({title:"تم ربط جوجل",description:"تم حفظ توكن النسخ الاحتياطي عبر الخادم."})}catch{}};return window.addEventListener("message",s),()=>window.removeEventListener("message",s)},[r==null?void 0:r.uid]),!r)return null;const fe=async()=>{if(!C){m(!0);try{await P()}catch(s){console.error("خطأ في تسجيل الخروج:",s);try{c({title:"فشل تسجيل الخروج",description:"حدث خطأ أثناء محاولة تسجيل الخروج، حاول مرة أخرى.",variant:"destructive"})}catch{}}finally{m(!1)}}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[S&&e.jsxs(j,{type:"button",onClick:()=>{N(!0),b(n,f)>0&&x(!0)},title:"تحديث التطبيق",className:"relative inline-flex items-center justify-center w-9 h-9 rounded-md bg-transparent text-blue-600 hover:bg-blue-500/10 focus:outline-none dark:text-blue-400 dark:hover:bg-blue-400/10",variant:"ghost",children:[e.jsx(Oe,{className:"w-5 h-5"}),D&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 inline-block w-2 h-2 rounded-full bg-red-500"})]}),e.jsx(j,{type:"button",onClick:()=>{var s;if(T&&((s=V==null?void 0:V.permissions)==null?void 0:s.settings)===!1){c({title:"تم رفض الوصول",description:"ليس لديك صلاحية للوصول إلى هذا القسم. يرجى مراجعة المسؤول.",variant:"destructive"});return}K(!0)},title:"إعدادات البروفيل",className:"relative inline-flex items-center justify-center w-9 h-9 rounded-md bg-transparent text-slate-700 hover:bg-slate-100 focus:outline-none dark:text-slate-100 dark:hover:bg-slate-800 mr-1",variant:"ghost",children:e.jsx(ye,{className:"w-5 h-5"})}),e.jsx(j,{type:"button",onClick:fe,title:"تسجيل الخروج",disabled:C,className:"h-8 w-8 rounded-full bg-red-500 hover:bg-red-600 text-white flex items-center justify-center shadow disabled:opacity-70 disabled:cursor-not-allowed",variant:"ghost",children:C?e.jsx(ae,{className:"w-4 h-4 animate-spin"}):e.jsx(ke,{className:"w-4 h-4"})})]}),S&&e.jsx(Y,{open:F,onOpenChange:s=>{if(!(!s&&E&&(D||v>=100))&&(N(s),!s&&v<100)){const l=`desktop_update_seen_${String((r==null?void 0:r.uid)||"anon")}`;try{n&&localStorage.setItem(l,n)}catch{}x(!1)}},children:e.jsxs(q,{className:"sm:max-w-md",hideClose:E&&(b(n,f)>0||v>=100),disableOutsideClose:E&&(b(n,f)>0||v>=100),disableEscClose:E&&(b(n,f)>0||v>=100),children:[e.jsx(re,{children:e.jsx(ne,{children:b(n,f)<=0?"حالة التحديث":E?"تحديث إجباري مطلوب":"يوجد تحديث جديد للبرنامج"})}),e.jsx("div",{className:"text-sm",children:B?"جارٍ تنزيل التحديث...":D&&b(n,f)>0?"هل ترغب في تنزيله الآن؟":"التطبيق مُحدَّث لآخر إصدار"}),n&&e.jsxs("div",{className:"mt-2 text-xs",children:["الإصدار الجديد: ",e.jsxs("span",{className:"font-semibold",children:["v",n]})]}),f&&e.jsxs("div",{className:"mt-1 text-xs text-muted-foreground",children:["إصدار التطبيق لديك: ",e.jsxs("span",{className:"font-semibold",children:["v",f]})]}),y&&e.jsx("div",{className:"mt-2 text-xs text-muted-foreground whitespace-pre-line",children:y}),B&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"w-full h-2 bg-gray-200 rounded",children:e.jsx("div",{className:"h-2 bg-blue-600 rounded",style:{width:`${v}%`}})}),e.jsxs("div",{className:"mt-1 text-xs text-muted-foreground",children:[Math.round(v),"%"]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-3",children:[(!E||b(n,f)<=0)&&e.jsx(j,{variant:"outline",onClick:()=>{const t=`desktop_update_seen_${String((r==null?void 0:r.uid)||"anon")}`;try{n&&localStorage.setItem(t,n)}catch{}x(!1),N(!1)},children:"إلغاء"}),!B&&v<100&&D&&b(n,f)>0&&e.jsx(j,{className:"bg-blue-600 hover:bg-blue-700",onClick:he,children:E?"تحديث الآن (إجباري)":"بدء التنزيل"}),v>=100&&e.jsx(j,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{try{if(i!=null&&i.applyUpdate){c({title:"جاري التحديث",description:"سيتم إغلاق التطبيق وتثبيت التحديث فوراً..."});const s=await i.applyUpdate();typeof s=="string"&&s.startsWith("err:")&&c({title:"فشل التحديث",description:s.slice(4),variant:"destructive"})}else if(i!=null&&i.openUpdateFolder){const s=await i.openUpdateFolder();typeof s=="string"&&s.startsWith("err:")?c({title:"تعذر فتح مجلد التحديث",description:s.slice(4),variant:"destructive"}):c({title:"افتح ملف التثبيت",description:"تم فتح مجلد التحديث — اضغط على الملف لتثبيت."})}}catch(s){c({title:"فشل التحديث",description:(s==null?void 0:s.message)||"حدث خطأ غير متوقع",variant:"destructive"})}},children:"تحديث الآن"})]})]})}),e.jsx(Y,{open:ue,onOpenChange:K,children:e.jsx(q,{className:"sm:max-w-5xl w-full h-[90vh] max-h-[90vh] p-0 overflow-hidden shadow-[0_0_40px_rgba(15,23,42,0.45)] border border-gray-200",children:e.jsx("div",{className:"h-full overflow-y-auto scrollbar-hide",children:e.jsx(a.Suspense,{fallback:e.jsx("div",{className:"p-4 text-sm text-muted-foreground",children:"جارٍ تحميل إعدادات البروفيل..."}),children:e.jsx(Ae,{onBack:()=>K(!1)})})})})}),e.jsx(De,{open:p,onOpenChange:I})]})}export{He as P};
//# sourceMappingURL=ProfileIcon-IxzO755X.js.map
