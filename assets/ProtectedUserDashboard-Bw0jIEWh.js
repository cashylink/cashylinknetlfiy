const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-CWTdLx7E.js","./index-Dd7n0Un2.css","./UserDashboardPage-C8E2BvSp.js","./ProfileSettingsPage-JYQlk0op.js","./switch-P5M31eDV.js","./MasterPinDialog-BwapmE19.js","./circle-alert-NzwhoXxt.js","./square-pen-DcDaycsB.js","./textarea-Iv9lg92g.js","./select-CQoGb_cR.js","./dollar-sign-DFJExlvM.js","./users-DTFR_sXy.js","./circle-x-Cc6eogP3.js","./trash-2-BKuXmImO.js","./circle-check-big-C85Ma9-W.js","./crown-eH9728mc.js","./refresh-cw-C3jRi4Z9.js","./arrow-left-BnhAVXv5.js","./badge-Dkne3qZK.js","./ProfileIcon-BlwDaKTr.js","./dropdown-menu-CwogjdTa.js","./index-3bJ5wXi7.js","./freeTrialService-Bh07mM2p.js","./broadcastService-DNYztVcb.js","./bell-9FJpIPx_.js","./profitService-oNUfz-Yd.js","./calendar-B6wCJ-48.js","./arrow-down-left-CCb1RSBR.js","./formatters-Bxe0AUcL.js","./wallet-CXLK-p8Q.js","./search-hg-NjxH6.js","./printer-B9qPCfB-.js","./phone-CsW_Skzd.js"])))=>i.map(i=>d[i]);
import{u as M,r as u,a1 as H,a as q,j as i,aj as W,K as B,o as V,aA as G,ah as X,aT as Z,i as ee,aD as R,aI as O,R as Y}from"./index-CWTdLx7E.js";import{s as te,E as ae}from"./broadcastService-DNYztVcb.js";import{L as se}from"./link-Byxj5llr.js";import{a as C}from"./MasterPinDialog-BwapmE19.js";import"./circle-alert-NzwhoXxt.js";const U="dismissedBroadcastIds",ie=()=>{const{user:t,profile:e,isSubscriptionActive:n,userSubscription:f}=M(),[p,v]=u.useState(null),[a,k]=u.useState(!1),[P,x]=u.useState(!1),[E,S]=u.useState([]),D=H(),_=q(),A=u.useMemo(()=>`dismissedBroadcastIds:${(t==null?void 0:t.uid)||"global"}`,[t==null?void 0:t.uid]),j=u.useMemo(()=>{const s=["global"];return e!=null&&e.shopId&&s.push(`shop:${e.shopId}`),t!=null&&t.uid&&s.push(`user:${t.uid}`),s},[e==null?void 0:e.shopId,t==null?void 0:t.uid]),g=D.pathname.startsWith("/admin");u.useEffect(()=>{if(!(t!=null&&t.uid))return;(async()=>{try{const d=B(V,"users",t.uid),c=await G(()=>import("./index-CWTdLx7E.js").then(o=>o.ck),__vite__mapDeps([0,1]),import.meta.url).then(o=>o.getDoc(d));if(c.exists()){const o=c.data(),h=Array.isArray(o==null?void 0:o.dismissedBroadcastIds)?o.dismissedBroadcastIds:[];S(h);try{const l=localStorage.getItem(A),r=l?JSON.parse(l):[],m=Array.from(new Set([...Array.isArray(r)?r:[],...h]));localStorage.setItem(A,JSON.stringify(m)),localStorage.setItem(U,JSON.stringify(m))}catch{}}}catch(d){console.error("UserBroadcastModal: fetch user error",d)}})()},[t==null?void 0:t.uid,A]),u.useEffect(()=>{if(!t||g||!((e==null?void 0:e.approved)===!0||n||(f==null?void 0:f.isOnFreeTrial)===!0))return;const d=te(j,c=>{if(c){v(c);try{const o=localStorage.getItem(A),h=localStorage.getItem(U),l=o?JSON.parse(o):[],r=h?JSON.parse(h):[],m=Array.isArray(l)?[...l]:[];if(Array.isArray(r))for(const y of r)m.includes(y)||m.push(y);if(Array.isArray(E))for(const y of E)m.includes(y)||m.push(y);const I=c.id&&m.includes(c.id);k(!I),x(!1),requestAnimationFrame(()=>x(!0))}catch{k(!0),x(!0)}}});return()=>d()},[t,j,g,e==null?void 0:e.approved,n,f,E]);const w=async()=>{k(!1);try{const s=localStorage.getItem(A),d=s?JSON.parse(s):[],c=p==null?void 0:p.id;if(c&&!d.includes(c)){d.push(c),localStorage.setItem(A,JSON.stringify(d));try{localStorage.setItem(U,JSON.stringify(d))}catch{}try{t!=null&&t.uid&&await X(B(V,"users",t.uid),{dismissedBroadcastIds:Z(c)})}catch(o){console.warn("UserBroadcastModal: failed to update dismissedBroadcastIds in Firestore",o)}}}catch{}};return!a||!p?null:i.jsxs("div",{className:"fixed inset-0 z-[9999]",children:[i.jsx("div",{className:`absolute inset-0 transition-opacity duration-300 ease-out ${P?"opacity-100":"opacity-0"} bg-black/20 dark:bg-black/20`}),i.jsxs("div",{className:`absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] sm:w-auto sm:min-w-[380px] sm:max-w-md md:max-w-lg bg-white shadow-2xl rounded-2xl border border-gray-100 ring-1 ring-black/5 transition-all duration-300 ease-out ${P?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:[i.jsx("div",{className:"relative overflow-hidden rounded-t-2xl",children:i.jsxs("div",{className:"bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 relative",children:[i.jsx("button",{"aria-label":"Ø¥ØºÙ„Ø§Ù‚",onClick:w,className:"absolute top-3 right-3 p-2 rounded-full bg-white/10 hover:bg-white/20",children:i.jsx(W,{className:"w-5 h-5 text-white"})}),i.jsx("div",{className:"p-4",children:i.jsx("h3",{className:"text-base sm:text-lg font-semibold text-white tracking-wide text-center",children:p.title||"Ø¥Ø´Ø¹Ø§Ø±"})})]})}),i.jsx("div",{className:"p-5",children:i.jsxs("div",{className:"flex items-start justify-between gap-3",children:[i.jsx("p",{className:"text-gray-700 leading-relaxed text-sm sm:text-base",children:p.message}),p.linkUrl&&i.jsxs("button",{"aria-label":"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·",title:"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·",onClick:()=>{const s=p.linkUrl;/^https?:\/\//i.test(s)?window.open(s,"_blank","noopener"):_(s)},className:"shrink-0 inline-flex items-center gap-2 px-3 py-2 rounded-md bg-indigo-600 text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 whitespace-nowrap",children:[/^https?:\/\//i.test(p.linkUrl)?i.jsx(ae,{className:"w-6 h-6"}):i.jsx(se,{className:"w-6 h-6"}),i.jsx("span",{className:"text-xs sm:text-sm font-semibold",children:p.actionText||"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·"})]})]})})]})]})},F="quick_login_enabled",J="quick_login_session_verified";function K(t){return t?`${F}_${t}`:F}function T(t){return t?`${J}_${t}`:J}const N={isEnabled(t){try{return localStorage.getItem(K(t))==="true"}catch{return!1}},setEnabled(t,e){try{localStorage.setItem(K(e),t?"true":"false"),sessionStorage.removeItem(T(e))}catch{}},isSessionVerified(t){try{return sessionStorage.getItem(T(t))==="true"}catch{return!1}},markSessionVerified(t){try{sessionStorage.setItem(T(t),"true")}catch{}}},re=Y.lazy(()=>G(()=>import("./UserDashboardPage-C8E2BvSp.js").then(t=>t.U),__vite__mapDeps([2,0,1,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32]),import.meta.url)),ue=()=>{var j;const t=q(),{user:e,profile:n,loading:f,refreshProfile:p,isSubscriptionActive:v,userSubscription:a,checkSubscriptionStatus:k}=M(),[P,x]=u.useState(!1),[E,S]=u.useState(!1);ee();const[D,_]=u.useState(!1);u.useEffect(()=>{if(!(e!=null&&e.uid)||!a)return;const w=setInterval(()=>{var l,r,m,I,y;const s=a;if(!s)return;const d=new Date;let c=!1;if(s!=null&&s.isOnFreeTrial){const b=(l=s.freeTrialEndDate)!=null&&l.toDate?s.freeTrialEndDate.toDate():s.freeTrialEndDate?new Date(s.freeTrialEndDate):null;c=b&&d<b}let o=!1;if((r=s==null?void 0:s.subscription)!=null&&r.isActive){const b=(m=s.subscription.endDate)!=null&&m.toDate?s.subscription.endDate.toDate():s.subscription.endDate?new Date(s.subscription.endDate):null;o=!b||d<b}let h=!1;if(((I=s==null?void 0:s.branchPackage)==null?void 0:I.status)==="active"){const b=(y=s.branchPackage.endDate)!=null&&y.toDate?s.branchPackage.endDate.toDate():s.branchPackage.endDate?new Date(s.branchPackage.endDate):null;h=!b||d<b}!c&&!o&&!h&&(console.log("ProtectedUserDashboard: All access methods expired client-side."),t("/user/pending-approval"))},5*1e3);return()=>clearInterval(w)},[e==null?void 0:e.uid,a,t]),u.useEffect(()=>()=>{},[]),u.useEffect(()=>{var g,w;if(console.log("ProtectedUserDashboard - useEffect triggered",{loading:f,user:e?"exists":"null",profile:n?{role:n.role,approved:n.approved}:"null",isSubscriptionActive:v,userSubscription:a?"exists":"null"}),!f){if(!e)console.log("ProtectedUserDashboard - No user, redirecting to login"),t("/user/login");else if(n)if(console.log("ProtectedUserDashboard - Profile found:",{role:n.role,approved:n.approved,isSubscriptionActive:v,hasSubscription:!!(a!=null&&a.subscription)}),a){const s=((g=a==null?void 0:a.branchPackage)==null?void 0:g.status)==="active",d=(a==null?void 0:a.isOnFreeTrial)===!0;if(!(!!v||((w=a==null?void 0:a.subscription)==null?void 0:w.isActive)===!0||d)&&!s){try{t("/user/pending-approval",{replace:!0})}catch{}return}n.role==="user"&&x(!0);const h=N.isEnabled(e==null?void 0:e.uid),l=N.isSessionVerified(e==null?void 0:e.uid);if(h&&!l){try{N.markSessionVerified(e==null?void 0:e.uid)}catch{}S(!1),x(!0)}else x(!0)}else{try{k()}catch{}return}}},[e,n,f,t,v,a]),u.useEffect(()=>{let g=null;return!f&&e?_(!0):e&&(g=setTimeout(()=>_(!0),3e3)),()=>{try{clearTimeout(g)}catch{}}},[f,e]),u.useEffect(()=>{var o,h;if(f||!e||!D||!a)return;const g=(a==null?void 0:a.isActive)!==!1,w=((o=a==null?void 0:a.branchPackage)==null?void 0:o.status)==="active",s=(a==null?void 0:a.isOnFreeTrial)===!0,d=!!v||((h=a==null?void 0:a.subscription)==null?void 0:h.isActive)===!0||s,c=l=>{var L,$;if(!l)return"null";const r=l.subscription,m=r!=null&&r.activatedAt?r.activatedAt.toDate?r.activatedAt.toDate().toISOString():new Date(r.activatedAt).toISOString():"null",I=(r==null?void 0:r.planType)||"null",y=l.isActive!==!1,b=(r==null?void 0:r.isActive)===!0,z=((L=l.branchPackage)==null?void 0:L.status)==="active",Q=($=l.branchPackage)!=null&&$.activatedAt?l.branchPackage.activatedAt.toDate?l.branchPackage.activatedAt.toDate().toISOString():new Date(l.branchPackage.activatedAt).toISOString():"null";return`${y}|${b}|${I}|${m}|${z}|${Q}`};if(!g){console.log("â›” ProtectedUserDashboard: Account is deactivated, redirecting to pending approval");try{sessionStorage.setItem("dashboard_kick_signature",c(a)),t("/user/pending-approval",{replace:!0})}catch{}return}if(!d&&!w)try{sessionStorage.setItem("dashboard_kick_signature",c(a)),t("/user/pending-approval")}catch{}},[f,e,a,v,t,D]),u.useEffect(()=>{},[f,e,a,v,k,t,D]);const A=typeof window<"u"&&(window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:");return(j=R)!=null&&j.isNativePlatform&&R.getPlatform(),f&&(A||!e)?i.jsx(O,{}):D?P?(console.log("ProtectedUserDashboard - Render state:",{isAuthenticated:P,profileRole:n==null?void 0:n.role,profileApproved:n==null?void 0:n.approved,isSubscriptionActive:v,hasSubscription:!!(a!=null&&a.subscription)}),console.log("ðŸ”¥ ProtectedUserDashboard - user:",e?{uid:e.uid,email:e.email}:"null"),console.log("ðŸ”¥ ProtectedUserDashboard - profile:",n?{userId:n.userId,role:n.role}:"null"),console.log("ðŸ”¥ ProtectedUserDashboard - loading:",f),console.log("ðŸ”¥ ProtectedUserDashboard - About to render UserDashboardPage"),i.jsxs("div",{className:"relative",children:[i.jsx(Y.Suspense,{fallback:i.jsx(O,{}),children:i.jsx(re,{})}),i.jsx(ie,{}),i.jsx(C,{open:E,onOpenChange:g=>S(g),mode:"verify",title:"Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹",description:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",onSuccess:()=>{N.markSessionVerified(e==null?void 0:e.uid),S(!1),x(!0)}})]})):i.jsxs(i.Fragment,{children:[i.jsx(O,{}),i.jsx(C,{open:E,onOpenChange:g=>S(g),mode:"verify",title:"Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹",description:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",onSuccess:()=>{N.markSessionVerified(e==null?void 0:e.uid),S(!1),x(!0)}})]}):i.jsx(O,{})};export{ue as default};
//# sourceMappingURL=ProtectedUserDashboard-Bw0jIEWh.js.map
