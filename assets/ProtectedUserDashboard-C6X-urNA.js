const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-DvnSb1Lh.js","./index-DFE28tXP.css","./UserDashboardPage-CqrufyR-.js","./card-CJ-6ser-.js","./badge-BfGzgZeY.js","./select-Bt20No4d.js","./label-B6P4HKsh.js","./MasterPinDialog-DoxZ0TSE.js","./circle-alert-CyhKuebD.js","./wallet-ByY_xMmx.js","./star-Ch3gEF67.js","./square-pen-B5j1QbHd.js","./progress-ClqSX7Ze.js","./phone-DA7H39xo.js","./arrow-left-pEhiR2Bz.js","./separator-CqHV39r0.js","./dollar-sign-gI21wJou.js","./ProfileIcon-9WiQiAPK.js","./dropdown-menu-Cr2CyYbi.js","./index-BQ7U6Bzi.js","./switch-C0JIfFYU.js","./circle-x-BPdk9KzK.js","./circle-check-big-B7qPpE3T.js","./MaintenanceDialog-DvbiVjcH.js","./whatsappService-DIUnbVu6.js","./download-BI83ceFZ.js","./profitService-CJzdybxg.js","./refresh-cw-ByDjU7ZC.js","./store-Co9tXbi6.js","./broadcastService-CDwMeI4U.js","./textarea-CMDxbUyO.js","./WalletsManagement-DcPipKxN.js","./freeTrialService-ag8hxyeR.js","./walletSelectionPinService-G3WPHaj1.js","./crown-CuelULZ5.js"])))=>i.map(i=>d[i]);
import{u as M,r as d,Y as Q,a as K,j as a,av as W,D as $,i as B,_ as q,H as X,aw as Z,c as ee,ae as R,aj as P,R as Y}from"./index-DvnSb1Lh.js";import{s as te,E as se}from"./broadcastService-CDwMeI4U.js";import{L as ae}from"./link-F8b_CoQn.js";import{M as V}from"./MasterPinDialog-DoxZ0TSE.js";import"./label-B6P4HKsh.js";import"./circle-alert-CyhKuebD.js";const O="dismissedBroadcastIds",ie=()=>{const{user:t,profile:e,isSubscriptionActive:n,userSubscription:u}=M(),[h,p]=d.useState(null),[s,D]=d.useState(!1),[E,y]=d.useState(!1),[k,b]=d.useState([]),w=Q(),N=K(),x=d.useMemo(()=>`dismissedBroadcastIds:${(t==null?void 0:t.uid)||"global"}`,[t==null?void 0:t.uid]),I=d.useMemo(()=>{const i=["global"];return e!=null&&e.shopId&&i.push(`shop:${e.shopId}`),t!=null&&t.uid&&i.push(`user:${t.uid}`),i},[e==null?void 0:e.shopId,t==null?void 0:t.uid]),g=w.pathname.startsWith("/admin");d.useEffect(()=>{if(!(t!=null&&t.uid))return;(async()=>{try{const f=$(B,"users",t.uid),o=await q(()=>import("./index-DvnSb1Lh.js").then(c=>c.c3),__vite__mapDeps([0,1]),import.meta.url).then(c=>c.getDoc(f));if(o.exists()){const c=o.data(),m=Array.isArray(c==null?void 0:c.dismissedBroadcastIds)?c.dismissedBroadcastIds:[];b(m);try{const r=localStorage.getItem(x),l=r?JSON.parse(r):[],v=Array.from(new Set([...Array.isArray(l)?l:[],...m]));localStorage.setItem(x,JSON.stringify(v)),localStorage.setItem(O,JSON.stringify(v))}catch{}}}catch(f){console.error("UserBroadcastModal: fetch user error",f)}})()},[t==null?void 0:t.uid,x]),d.useEffect(()=>{if(!t||g||!((e==null?void 0:e.approved)===!0||n||(u==null?void 0:u.isOnFreeTrial)===!0))return;const f=te(I,o=>{if(o){p(o);try{const c=localStorage.getItem(x),m=localStorage.getItem(O),r=c?JSON.parse(c):[],l=m?JSON.parse(m):[],v=Array.isArray(r)?[...r]:[];if(Array.isArray(l))for(const S of l)v.includes(S)||v.push(S);if(Array.isArray(k))for(const S of k)v.includes(S)||v.push(S);const _=o.id&&v.includes(o.id);D(!_),y(!1),requestAnimationFrame(()=>y(!0))}catch{D(!0),y(!0)}}});return()=>f()},[t,I,g,e==null?void 0:e.approved,n,u,k]);const A=async()=>{D(!1);try{const i=localStorage.getItem(x),f=i?JSON.parse(i):[],o=h==null?void 0:h.id;if(o&&!f.includes(o)){f.push(o),localStorage.setItem(x,JSON.stringify(f));try{localStorage.setItem(O,JSON.stringify(f))}catch{}try{t!=null&&t.uid&&await X($(B,"users",t.uid),{dismissedBroadcastIds:Z(o)})}catch(c){console.warn("UserBroadcastModal: failed to update dismissedBroadcastIds in Firestore",c)}}}catch{}};return!s||!h?null:a.jsxs("div",{className:"fixed inset-0 z-[9999]",children:[a.jsx("div",{className:`absolute inset-0 transition-opacity duration-300 ease-out ${E?"opacity-100":"opacity-0"} bg-black/20 dark:bg-black/20`}),a.jsxs("div",{className:`absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] sm:w-auto sm:min-w-[380px] sm:max-w-md md:max-w-lg bg-white shadow-2xl rounded-2xl border border-gray-100 ring-1 ring-black/5 transition-all duration-300 ease-out ${E?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:[a.jsx("div",{className:"relative overflow-hidden rounded-t-2xl",children:a.jsxs("div",{className:"bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 relative",children:[a.jsx("button",{"aria-label":"Ø¥ØºÙ„Ø§Ù‚",onClick:A,className:"absolute top-3 right-3 p-2 rounded-full bg-white/10 hover:bg-white/20",children:a.jsx(W,{className:"w-5 h-5 text-white"})}),a.jsx("div",{className:"p-4",children:a.jsx("h3",{className:"text-base sm:text-lg font-semibold text-white tracking-wide text-center",children:h.title||"Ø¥Ø´Ø¹Ø§Ø±"})})]})}),a.jsx("div",{className:"p-5",children:a.jsxs("div",{className:"flex items-start justify-between gap-3",children:[a.jsx("p",{className:"text-gray-700 leading-relaxed text-sm sm:text-base",children:h.message}),h.linkUrl&&a.jsxs("button",{"aria-label":"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·",title:"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·",onClick:()=>{const i=h.linkUrl;/^https?:\/\//i.test(i)?window.open(i,"_blank","noopener"):N(i)},className:"shrink-0 inline-flex items-center gap-2 px-3 py-2 rounded-md bg-indigo-600 text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 whitespace-nowrap",children:[/^https?:\/\//i.test(h.linkUrl)?a.jsx(se,{className:"w-6 h-6"}):a.jsx(ae,{className:"w-6 h-6"}),a.jsx("span",{className:"text-xs sm:text-sm font-semibold",children:"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·"})]})]})})]})]})},C="quick_login_enabled",F="quick_login_session_verified";function J(t){return t?`${C}_${t}`:C}function U(t){return t?`${F}_${t}`:F}const j={isEnabled(t){try{return localStorage.getItem(J(t))==="true"}catch{return!1}},setEnabled(t,e){try{localStorage.setItem(J(e),t?"true":"false"),sessionStorage.removeItem(U(e))}catch{}},isSessionVerified(t){try{return sessionStorage.getItem(U(t))==="true"}catch{return!1}},markSessionVerified(t){try{sessionStorage.setItem(U(t),"true")}catch{}}},re=Y.lazy(()=>q(()=>import("./UserDashboardPage-CqrufyR-.js"),__vite__mapDeps([2,0,1,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34]),import.meta.url)),fe=()=>{var I;const t=K(),{user:e,profile:n,loading:u,refreshProfile:h,isSubscriptionActive:p,userSubscription:s,checkSubscriptionStatus:D}=M(),[E,y]=d.useState(!1),[k,b]=d.useState(!1);ee();const[w,N]=d.useState(!1);d.useEffect(()=>{if(!(e!=null&&e.uid)||!s)return;const A=setInterval(()=>{var c,m;const i=s,f=(i==null?void 0:i.isOnFreeTrial)===!0;let o=null;if(f)o=(c=i.freeTrialEndDate)!=null&&c.toDate?i.freeTrialEndDate.toDate():i.freeTrialEndDate?new Date(i.freeTrialEndDate):null;else{const r=(m=i==null?void 0:i.subscription)==null?void 0:m.endDate;o=r!=null&&r.toDate?r.toDate():r?new Date(r):null}o&&new Date().getTime()>o.getTime()&&(console.log("ProtectedUserDashboard: Subscription/Trial expired client-side."),t("/user/pending-approval"))},60*1e3);return()=>clearInterval(A)},[e==null?void 0:e.uid,s,t]),d.useEffect(()=>()=>{},[]),d.useEffect(()=>{var g,A;if(console.log("ProtectedUserDashboard - useEffect triggered",{loading:u,user:e?"exists":"null",profile:n?{role:n.role,approved:n.approved}:"null",isSubscriptionActive:p,userSubscription:s?"exists":"null"}),!u){if(!e)console.log("ProtectedUserDashboard - No user, redirecting to login"),t("/user/login");else if(n)if(console.log("ProtectedUserDashboard - Profile found:",{role:n.role,approved:n.approved,isSubscriptionActive:p,hasSubscription:!!(s!=null&&s.subscription)}),s){const i=((g=s==null?void 0:s.branchPackage)==null?void 0:g.status)==="active",f=(s==null?void 0:s.isOnFreeTrial)===!0;if(!(!!p||((A=s==null?void 0:s.subscription)==null?void 0:A.isActive)===!0||f)&&!i){try{t("/user/pending-approval",{replace:!0})}catch{}return}n.role==="user"&&y(!0);const m=j.isEnabled(e==null?void 0:e.uid),r=j.isSessionVerified(e==null?void 0:e.uid);if(m&&!r){try{j.markSessionVerified(e==null?void 0:e.uid)}catch{}b(!1),y(!0)}else y(!0)}else{try{D()}catch{}return}}},[e,n,u,t,p,s]),d.useEffect(()=>{let g=null;return!u&&e?N(!0):e&&(g=setTimeout(()=>N(!0),3e3)),()=>{try{clearTimeout(g)}catch{}}},[u,e]),d.useEffect(()=>{var c,m;if(u||!e||!w||!s)return;const g=(s==null?void 0:s.isActive)!==!1,A=((c=s==null?void 0:s.branchPackage)==null?void 0:c.status)==="active",i=(s==null?void 0:s.isOnFreeTrial)===!0,f=!!p||((m=s==null?void 0:s.subscription)==null?void 0:m.isActive)===!0||i,o=r=>{var T,L;if(!r)return"null";const l=r.subscription,v=l!=null&&l.activatedAt?l.activatedAt.toDate?l.activatedAt.toDate().toISOString():new Date(l.activatedAt).toISOString():"null",_=(l==null?void 0:l.planType)||"null",S=r.isActive!==!1,G=(l==null?void 0:l.isActive)===!0,z=((T=r.branchPackage)==null?void 0:T.status)==="active",H=(L=r.branchPackage)!=null&&L.activatedAt?r.branchPackage.activatedAt.toDate?r.branchPackage.activatedAt.toDate().toISOString():new Date(r.branchPackage.activatedAt).toISOString():"null";return`${S}|${G}|${_}|${v}|${z}|${H}`};if(!g){console.log("â›” ProtectedUserDashboard: Account is deactivated, redirecting to pending approval");try{sessionStorage.setItem("dashboard_kick_signature",o(s)),t("/user/pending-approval",{replace:!0})}catch{}return}if(!f&&!A)try{sessionStorage.setItem("dashboard_kick_signature",o(s)),t("/user/pending-approval")}catch{}},[u,e,s,p,t,w]),d.useEffect(()=>{},[u,e,s,p,D,t,w]);const x=typeof window<"u"&&(window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:");return(I=R)!=null&&I.isNativePlatform&&R.getPlatform(),u&&(x||!e)?a.jsx(P,{}):w?E?(console.log("ProtectedUserDashboard - Render state:",{isAuthenticated:E,profileRole:n==null?void 0:n.role,profileApproved:n==null?void 0:n.approved,isSubscriptionActive:p,hasSubscription:!!(s!=null&&s.subscription)}),console.log("ðŸ”¥ ProtectedUserDashboard - user:",e?{uid:e.uid,email:e.email}:"null"),console.log("ðŸ”¥ ProtectedUserDashboard - profile:",n?{userId:n.userId,role:n.role}:"null"),console.log("ðŸ”¥ ProtectedUserDashboard - loading:",u),console.log("ðŸ”¥ ProtectedUserDashboard - About to render UserDashboardPage"),a.jsxs("div",{className:"relative",children:[a.jsx(Y.Suspense,{fallback:a.jsx(P,{}),children:a.jsx(re,{})}),a.jsx(ie,{}),a.jsx(V,{open:k,onOpenChange:g=>b(g),mode:"verify",title:"Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹",description:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",onSuccess:()=>{j.markSessionVerified(e==null?void 0:e.uid),b(!1),y(!0)}})]})):a.jsxs(a.Fragment,{children:[a.jsx(P,{}),a.jsx(V,{open:k,onOpenChange:g=>b(g),mode:"verify",title:"Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹",description:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",onSuccess:()=>{j.markSessionVerified(e==null?void 0:e.uid),b(!1),y(!0)}})]}):a.jsx(P,{})};export{fe as default};
//# sourceMappingURL=ProtectedUserDashboard-C6X-urNA.js.map
