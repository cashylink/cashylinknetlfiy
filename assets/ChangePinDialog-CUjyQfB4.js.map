{"version":3,"file":"ChangePinDialog-CUjyQfB4.js","sources":["../../src/utils/securityService.ts","../../src/components/ChangePinDialog.tsx"],"sourcesContent":["// خدمة إدارة الرقم السري لتصفير المعاملات\r\nexport class SecurityService {\r\n  private static readonly SECRET_KEY_BASE = 'dashboard_secret_pin';\r\n  private static secretCache: Map<string, string> = new Map();\r\n\r\n  // الحصول على مفتاح localStorage المناسب للمستخدم\r\n  private static getSecretKey(userId?: string): string {\r\n    return userId ? `${this.SECRET_KEY_BASE}_${userId}` : this.SECRET_KEY_BASE;\r\n  }\r\n\r\n  // حفظ الرقم السري (يتم تشفيره بسيط)\r\n  static setSecretPin(pin: string, userId?: string): void {\r\n    const encodedPin = btoa(pin); // تشفير بسيط\r\n    this.secretCache.set(this.getSecretKey(userId), encodedPin);\r\n  }\r\n\r\n  // التحقق من وجود رقم سري محفوظ\r\n  static hasSecretPin(userId?: string): boolean {\r\n    return this.secretCache.has(this.getSecretKey(userId));\r\n  }\r\n\r\n  // التحقق من صحة الرقم السري\r\n  static verifySecretPin(pin: string, userId?: string): boolean {\r\n    const savedPin = this.secretCache.get(this.getSecretKey(userId));\r\n    if (!savedPin) return false;\r\n    \r\n    try {\r\n      const decodedPin = atob(savedPin);\r\n      return decodedPin === pin;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // إزالة الرقم السري (للاختبار فقط)\r\n  static clearSecretPin(userId?: string): void {\r\n    this.secretCache.delete(this.getSecretKey(userId));\r\n  }\r\n}","import React, { useState } from 'react';\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Lock, Eye, EyeOff, AlertCircle, Settings } from 'lucide-react';\r\nimport { SecurityService } from '@/utils/securityService';\r\nimport { useToast } from '@/hooks/use-toast';\r\n\r\ninterface ChangePinDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  userId?: string;\r\n}\r\n\r\nexport function ChangePinDialog({ open, onOpenChange, userId }: ChangePinDialogProps) {\r\n  const [currentPin, setCurrentPin] = useState('');\r\n  const [newPin, setNewPin] = useState('');\r\n  const [confirmPin, setConfirmPin] = useState('');\r\n  const [showCurrentPin, setShowCurrentPin] = useState(false);\r\n  const [showNewPin, setShowNewPin] = useState(false);\r\n  const [showConfirmPin, setShowConfirmPin] = useState(false);\r\n  const [error, setError] = useState('');\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const { toast } = useToast();\r\n\r\n  const hasExistingPin = SecurityService.hasSecretPin(userId);\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setError('');\r\n    setIsLoading(true);\r\n\r\n    try {\r\n      // التحقق من صحة البيانات المدخلة\r\n      if (!newPin || newPin.length < 4) {\r\n        setError('يجب أن يكون الرقم السري 4 أرقام على الأقل');\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n\r\n      if (newPin !== confirmPin) {\r\n        setError('الرقم السري الجديد وتأكيده غير متطابقين');\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n\r\n      // إذا كان هناك رقم سري موجود، يجب التحقق منه أولاً\r\n      if (hasExistingPin) {\r\n        if (!currentPin) {\r\n          setError('يرجى إدخال الرقم السري الحالي');\r\n          setIsLoading(false);\r\n          return;\r\n        }\r\n\r\n        if (!SecurityService.verifySecretPin(currentPin, userId)) {\r\n          setError('الرقم السري الحالي غير صحيح');\r\n          setIsLoading(false);\r\n          return;\r\n        }\r\n      }\r\n\r\n      // حفظ الرقم السري الجديد\r\n      SecurityService.setSecretPin(newPin, userId);\r\n\r\n      // إظهار رسالة نجاح\r\n      toast({\r\n        title: hasExistingPin ? \"تم تغيير الرقم السري\" : \"تم تعيين الرقم السري\",\r\n        description: hasExistingPin \r\n          ? \"تم تغيير الرقم السري بنجاح\" \r\n          : \"تم تعيين الرقم السري بنجاح\",\r\n      });\r\n\r\n      // إغلاق النافذة وإعادة تعيين الحقول\r\n      handleClose();\r\n    } catch (error) {\r\n      setError('حدث خطأ أثناء حفظ الرقم السري');\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleClose = () => {\r\n    setCurrentPin('');\r\n    setNewPin('');\r\n    setConfirmPin('');\r\n    setError('');\r\n    setShowCurrentPin(false);\r\n    setShowNewPin(false);\r\n    setShowConfirmPin(false);\r\n    onOpenChange(false);\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={handleClose}>\r\n      <DialogContent className=\"sm:max-w-md\" dir=\"rtl\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"flex items-center gap-2 text-right\">\r\n            <Settings className=\"h-5 w-5\" />\r\n            {hasExistingPin ? \"تغيير الرقم السري\" : \"تعيين الرقم السري\"}\r\n          </DialogTitle>\r\n        </DialogHeader>\r\n        \r\n        <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n          <div className=\"text-sm text-muted-foreground text-right\">\r\n            {hasExistingPin \r\n              ? \"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره\"\r\n              : \"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل\"\r\n            }\r\n          </div>\r\n\r\n          {/* الرقم السري الحالي (إذا كان موجوداً) */}\r\n          {hasExistingPin && (\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"currentPin\" className=\"text-right block\">\r\n                الرقم السري الحالي\r\n              </Label>\r\n              <div className=\"relative\">\r\n                <Input\r\n                  id=\"currentPin\"\r\n                  type={showCurrentPin ? \"text\" : \"password\"}\r\n                  autoComplete=\"off\"\r\n                  value={currentPin}\r\n                  onChange={(e) => setCurrentPin(e.target.value)}\r\n                  placeholder=\"أدخل الرقم السري الحالي\"\r\n                  className=\"pr-10\"\r\n                  dir=\"ltr\"\r\n                />\r\n                <Button\r\n                  type=\"button\"\r\n                  variant=\"ghost\"\r\n                  size=\"sm\"\r\n                  className=\"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent\"\r\n                  onClick={() => setShowCurrentPin(!showCurrentPin)}\r\n                >\r\n                  {showCurrentPin ? (\r\n                    <EyeOff className=\"h-4 w-4\" />\r\n                  ) : (\r\n                    <Eye className=\"h-4 w-4\" />\r\n                  )}\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* الرقم السري الجديد */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"newPin\" className=\"text-right block\">\r\n              الرقم السري الجديد\r\n            </Label>\r\n            <div className=\"relative\">\r\n              <Input\r\n                id=\"newPin\"\r\n                type={showNewPin ? \"text\" : \"password\"}\r\n                autoComplete=\"off\"\r\n                value={newPin}\r\n                onChange={(e) => setNewPin(e.target.value)}\r\n                placeholder=\"أدخل الرقم السري الجديد\"\r\n                className=\"pr-10\"\r\n                dir=\"ltr\"\r\n              />\r\n              <Button\r\n                type=\"button\"\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                className=\"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent\"\r\n                onClick={() => setShowNewPin(!showNewPin)}\r\n              >\r\n                {showNewPin ? (\r\n                  <EyeOff className=\"h-4 w-4\" />\r\n                ) : (\r\n                  <Eye className=\"h-4 w-4\" />\r\n                )}\r\n              </Button>\r\n            </div>\r\n          </div>\r\n\r\n          {/* تأكيد الرقم السري الجديد */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"confirmPin\" className=\"text-right block\">\r\n              تأكيد الرقم السري الجديد\r\n            </Label>\r\n            <div className=\"relative\">\r\n              <Input\r\n                id=\"confirmPin\"\r\n                type={showConfirmPin ? \"text\" : \"password\"}\r\n                autoComplete=\"off\"\r\n                value={confirmPin}\r\n                onChange={(e) => setConfirmPin(e.target.value)}\r\n                placeholder=\"أعد إدخال الرقم السري الجديد\"\r\n                className=\"pr-10\"\r\n                dir=\"ltr\"\r\n              />\r\n              <Button\r\n                type=\"button\"\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                className=\"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent\"\r\n                onClick={() => setShowConfirmPin(!showConfirmPin)}\r\n              >\r\n                {showConfirmPin ? (\r\n                  <EyeOff className=\"h-4 w-4\" />\r\n                ) : (\r\n                  <Eye className=\"h-4 w-4\" />\r\n                )}\r\n              </Button>\r\n            </div>\r\n          </div>\r\n\r\n          {/* رسالة الخطأ */}\r\n          {error && (\r\n            <div className=\"flex items-center gap-2 text-red-600 text-sm\">\r\n              <AlertCircle className=\"h-4 w-4\" />\r\n              {error}\r\n            </div>\r\n          )}\r\n\r\n          {/* أزرار التحكم */}\r\n          <div className=\"flex gap-2 pt-4\">\r\n            <Button\r\n              type=\"submit\"\r\n              disabled={isLoading}\r\n              className=\"flex-1\"\r\n            >\r\n              <Lock className=\"h-4 w-4 mr-2\" />\r\n              {isLoading ? \"جاري الحفظ...\" : (hasExistingPin ? \"تغيير الرقم السري\" : \"تعيين الرقم السري\")}\r\n            </Button>\r\n            <Button\r\n              type=\"button\"\r\n              variant=\"outline\"\r\n              onClick={handleClose}\r\n              disabled={isLoading}\r\n            >\r\n              إلغاء\r\n            </Button>\r\n          </div>\r\n        </form>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}"],"names":["SecurityService","userId","pin","encodedPin","savedPin","__publicField","ChangePinDialog","open","onOpenChange","currentPin","setCurrentPin","useState","newPin","setNewPin","confirmPin","setConfirmPin","showCurrentPin","setShowCurrentPin","showNewPin","setShowNewPin","showConfirmPin","setShowConfirmPin","error","setError","isLoading","setIsLoading","toast","useToast","hasExistingPin","handleSubmit","e","handleClose","jsx","Dialog","DialogContent","DialogHeader","jsxs","DialogTitle","Settings","Label","Input","Button","EyeOff","Eye","AlertCircle","Lock"],"mappings":"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"}