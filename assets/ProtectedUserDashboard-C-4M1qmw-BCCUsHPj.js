const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./UserDashboardPage-BRKQ-meY-DFVE24QD.js","./index-BsVRzvOf.js","./index-Bpuv6Nub.css","./card-SlwaggFS-BswsJdJN.js","./badge-Cq-GDK1F-DqoYRGyo.js","./select-QKdc2TYn-4nnF_b5r.js","./label-_mnIMROJ-DudSd8Mh.js","./MasterPinDialog-CDin1iyv-BfIYYvfI.js","./shield-DSoskD-c-BzN5L-qY.js","./circle-alert-BbiXZQj6-CJFrf0QN.js","./wallet-MP5ofXFw-D9yNqwpS.js","./star-CXUVfJ8s-BEjrWAgM.js","./square-pen-CHl7RpbW-B-WGGV3A.js","./progress-BOoGedvV-DsOOhwhn.js","./phone-fkjnGVtI-DdQgMhKa.js","./arrow-left-BDVMu6ut-7df8sdbj.js","./separator-Dk6MyxBB-Dcj4B0Mo.js","./calendar-DYpYXkMW-DdYk4Ijy.js","./chart-column-DoUryAXS-DMSN4BLc.js","./dollar-sign-bNLkxbzG-Dyq9Naiu.js","./ProfileIcon-DCyirBaq-gWw1xk4p.js","./dropdown-menu-MkPhHRIa-C3szlXVH.js","./index-CS8iiUxP-o3s-AvoK.js","./switch-CNGODERG-eTw8K7Ad.js","./circle-x-CAZlwHZs-PgSdbLi6.js","./circle-check-big-DcMEd0KV-CypIUhpt.js","./MaintenanceDialog-BLQvmu15-CR1GbJWU.js","./whatsappService-D7s14JCG-CtNQG8BW.js","./download-DFIibxe--CsopZRn5.js","./profitService-4r9FqAF7-Hn6SWIj-.js","./store-i3EEOQHb-C0UUted8.js","./broadcastService-DGqqg97J-ssfrjid5.js","./textarea-DK4Tmvmm-BQX2-U1-.js","./WalletsManagement-B4QYl-Sx-DcCx9Zs8.js","./freeTrialService-BwabY7bi-CphYVBZa.js","./walletSelectionPinService-DoL5ZSmj-C12144ZO.js","./crown-Bkdmlc37-DgP56dVa.js"])))=>i.map(i=>d[i]);
import{C as J,W as T,S as u,d as L,I as r,x as B,s as P,j as q,Z as R,_ as W,u as X,v as O,G as C,L as Q,a1 as Y,a0 as H,a2 as K}from"./index-BsVRzvOf.js";import{L as Z,B as z}from"./broadcastService-DGqqg97J-ssfrjid5.js";import{o as ee}from"./link-BcnlpFfX-BmxnLns2.js";import{E as M}from"./MasterPinDialog-CDin1iyv-BfIYYvfI.js";import"./label-_mnIMROJ-DudSd8Mh.js";import"./shield-DSoskD-c-BzN5L-qY.js";import"./circle-alert-BbiXZQj6-CJFrf0QN.js";const G=(e,o=G,s=o.f||(o.f=["./UserDashboardPage-BRKQ-meY.js","./index-tnWDkOuX.js","./index-Bpuv6Nub.css","./card-SlwaggFS.js","./badge-Cq-GDK1F.js","./select-QKdc2TYn.js","./label-_mnIMROJ.js","./MasterPinDialog-CDin1iyv.js","./shield-DSoskD-c.js","./circle-alert-BbiXZQj6.js","./wallet-MP5ofXFw.js","./star-CXUVfJ8s.js","./square-pen-CHl7RpbW.js","./progress-BOoGedvV.js","./phone-fkjnGVtI.js","./arrow-left-BDVMu6ut.js","./separator-Dk6MyxBB.js","./calendar-DYpYXkMW.js","./chart-column-DoUryAXS.js","./dollar-sign-bNLkxbzG.js","./ProfileIcon-DCyirBaq.js","./dropdown-menu-MkPhHRIa.js","./index-CS8iiUxP.js","./switch-CNGODERG.js","./circle-x-CAZlwHZs.js","./circle-check-big-DcMEd0KV.js","./MaintenanceDialog-BLQvmu15.js","./whatsappService-D7s14JCG.js","./download-DFIibxe-.js","./profitService-4r9FqAF7.js","./store-i3EEOQHb.js","./broadcastService-DGqqg97J.js","./textarea-DK4Tmvmm.js","./WalletsManagement-B4QYl-Sx.js","./freeTrialService-BwabY7bi.js","./walletSelectionPinService-DoL5ZSmj.js","./crown-Bkdmlc37.js"]))=>e.map(a=>s[a]),U="dismissedBroadcastIds",se=()=>{const{user:e,profile:o,isSubscriptionActive:s,userSubscription:a}=T(),[n,_]=u.useState(null),[v,t]=u.useState(!1),[h,j]=u.useState(!1),[m,k]=u.useState([]),b=X(),D=J(),p=u.useMemo(()=>`dismissedBroadcastIds:${(e==null?void 0:e.uid)||"global"}`,[e==null?void 0:e.uid]),x=u.useMemo(()=>{const i=["global"];return o!=null&&o.shopId&&i.push(`shop:${o.shopId}`),e!=null&&e.uid&&i.push(`user:${e.uid}`),i},[o==null?void 0:o.shopId,e==null?void 0:e.uid]),A=b.pathname.startsWith("/admin");u.useEffect(()=>{if(!(e!=null&&e.uid))return;const i=O(C,"users",e.uid),l=Q(i,c=>{const f=c.data(),S=Array.isArray(f==null?void 0:f.dismissedBroadcastIds)?f.dismissedBroadcastIds:[];k(S);try{const w=localStorage.getItem(p),g=w?JSON.parse(w):[],N=Array.from(new Set([...Array.isArray(g)?g:[],...S]));localStorage.setItem(p,JSON.stringify(N)),localStorage.setItem(U,JSON.stringify(N))}catch{}},c=>{console.error("UserBroadcastModal: onSnapshot user error",c)});return()=>l()},[e==null?void 0:e.uid,p]),u.useEffect(()=>{if(!e||A||!((o==null?void 0:o.approved)===!0||s||(a==null?void 0:a.isOnFreeTrial)===!0))return;const i=Z(x,l=>{if(l){_(l);try{const c=localStorage.getItem(p),f=localStorage.getItem(U),S=c?JSON.parse(c):[],w=f?JSON.parse(f):[],g=Array.isArray(S)?[...S]:[];if(Array.isArray(w))for(const y of w)g.includes(y)||g.push(y);if(Array.isArray(m))for(const y of m)g.includes(y)||g.push(y);const N=l.id&&g.includes(l.id);t(!N),j(!1),requestAnimationFrame(()=>j(!0))}catch{t(!0),j(!0)}}});return()=>i()},[e,x,A,o==null?void 0:o.approved,s,a,m]);const d=async()=>{t(!1);try{const i=localStorage.getItem(p),l=i?JSON.parse(i):[],c=n==null?void 0:n.id;if(c&&!l.includes(c)){l.push(c),localStorage.setItem(p,JSON.stringify(l));try{localStorage.setItem(U,JSON.stringify(l))}catch{}try{e!=null&&e.uid&&await H(O(C,"users",e.uid),{dismissedBroadcastIds:K(c)})}catch(f){console.warn("UserBroadcastModal: failed to update dismissedBroadcastIds in Firestore",f)}}}catch{}};return!v||!n?null:r.jsxs("div",{className:"fixed inset-0 z-[9999]",children:[r.jsx("div",{className:`absolute inset-0 transition-opacity duration-300 ease-out ${h?"opacity-100":"opacity-0"} bg-black/20 dark:bg-black/20`}),r.jsxs("div",{className:`absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] sm:w-auto sm:min-w-[380px] sm:max-w-md md:max-w-lg bg-white shadow-2xl rounded-2xl border border-gray-100 ring-1 ring-black/5 transition-all duration-300 ease-out ${h?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:[r.jsx("div",{className:"relative overflow-hidden rounded-t-2xl",children:r.jsxs("div",{className:"bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 relative",children:[r.jsx("button",{"aria-label":"Ø¥ØºÙ„Ø§Ù‚",onClick:d,className:"absolute top-3 right-3 p-2 rounded-full bg-white/10 hover:bg-white/20",children:r.jsx(Y,{className:"w-5 h-5 text-white"})}),r.jsx("div",{className:"p-4",children:r.jsx("h3",{className:"text-base sm:text-lg font-semibold text-white tracking-wide text-center",children:n.title||"Ø¥Ø´Ø¹Ø§Ø±"})})]})}),r.jsx("div",{className:"p-5",children:r.jsxs("div",{className:"flex items-start justify-between gap-3",children:[r.jsx("p",{className:"text-gray-700 leading-relaxed text-sm sm:text-base",children:n.message}),n.linkUrl&&r.jsxs("button",{"aria-label":"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·",title:"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·",onClick:()=>{const i=n.linkUrl;/^https?:\/\//i.test(i)?window.open(i,"_blank","noopener"):D(i)},className:"shrink-0 inline-flex items-center gap-2 px-3 py-2 rounded-md bg-indigo-600 text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 whitespace-nowrap",children:[/^https?:\/\//i.test(n.linkUrl)?r.jsx(z,{className:"w-6 h-6"}):r.jsx(ee,{className:"w-6 h-6"}),r.jsx("span",{className:"text-xs sm:text-sm font-semibold",children:"ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·"})]})]})})]})]})},F="quick_login_enabled",V="quick_login_session_verified";function $(e){return e?`${F}_${e}`:F}function E(e){return e?`${V}_${e}`:V}const I={isEnabled(e){try{return localStorage.getItem($(e))==="true"}catch{return!1}},setEnabled(e,o){try{localStorage.setItem($(o),e?"true":"false"),sessionStorage.removeItem(E(o))}catch{}},isSessionVerified(e){try{return sessionStorage.getItem(E(e))==="true"}catch{return!1}},markSessionVerified(e){try{sessionStorage.setItem(E(e),"true")}catch{}}},te=q.lazy(()=>R(()=>W(()=>import("./UserDashboardPage-BRKQ-meY-DFVE24QD.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36]),import.meta.url),G([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36]),import.meta.url)),de=()=>{var e;const o=J(),{user:s,profile:a,loading:n,refreshProfile:_,isSubscriptionActive:v,userSubscription:t,checkSubscriptionStatus:h}=T(),[j,m]=u.useState(!1),[k,b]=u.useState(!1),{toast:D}=L(),[p,x]=u.useState(!1);u.useEffect(()=>{const d=async i=>{const{userId:l,isActive:c}=i.detail;console.log("ðŸ”” ProtectedUserDashboard: Subscription update event received:",{userId:l,isActive:c,currentUserId:s==null?void 0:s.uid}),l===(s==null?void 0:s.uid)&&c&&(console.log("âœ… ProtectedUserDashboard: Subscription activated for current user, refreshing status"),await h(),m(!0),D({title:"ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ",description:"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…!"}))};return window.addEventListener("userSubscriptionUpdated",d),()=>{window.removeEventListener("userSubscriptionUpdated",d)}},[s==null?void 0:s.uid,h,D]),u.useEffect(()=>{var d,i;if(console.log("ProtectedUserDashboard - useEffect triggered",{loading:n,user:s?"exists":"null",profile:a?{role:a.role,approved:a.approved}:"null",isSubscriptionActive:v,userSubscription:t?"exists":"null"}),!n){if(!s)console.log("ProtectedUserDashboard - No user, redirecting to login"),o("/user/login");else if(a){if(console.log("ProtectedUserDashboard - Profile found:",{role:a.role,approved:a.approved,isSubscriptionActive:v,hasSubscription:!!(t!=null&&t.subscription)}),t){const f=((d=t==null?void 0:t.branchPackage)==null?void 0:d.status)==="active",S=(t==null?void 0:t.isOnFreeTrial)===!0;if(!(v||((i=t==null?void 0:t.subscription)==null?void 0:i.isActive)===!0||S)&&!f){try{o("/user/pending-approval",{replace:!0})}catch{}return}}a.role==="user"&&m(!0),console.log("ProtectedUserDashboard - User approved or admin, checking quick-login gate");const l=I.isEnabled(s==null?void 0:s.uid),c=I.isSessionVerified(s==null?void 0:s.uid);if(l&&!c){try{I.markSessionVerified(s==null?void 0:s.uid)}catch{}b(!1),m(!0)}else m(!0)}}},[s,a,n,o,v,t]),u.useEffect(()=>{let d=null;return!n&&s?x(!0):s&&(d=setTimeout(()=>x(!0),3e3)),()=>{try{clearTimeout(d)}catch{}}},[n,s]),u.useEffect(()=>{var d,i;if(n||!s||!p||!t)return;const l=((d=t==null?void 0:t.branchPackage)==null?void 0:d.status)==="active",c=(t==null?void 0:t.isOnFreeTrial)===!0;if(!(v||((i=t==null?void 0:t.subscription)==null?void 0:i.isActive)===!0||c)&&!l)try{o("/user/pending-approval")}catch{}},[n,s,t,v,o,p]),u.useEffect(()=>{if(n||!s||!p)return;const d=setInterval(async()=>{var i,l;try{await h()}catch{}const c=((i=t==null?void 0:t.branchPackage)==null?void 0:i.status)==="active",f=(t==null?void 0:t.isOnFreeTrial)===!0;if(!(v||((l=t==null?void 0:t.subscription)==null?void 0:l.isActive)===!0||f)&&!c)try{o("/user/pending-approval",{replace:!0})}catch{}},1e3);return()=>clearInterval(d)},[n,s,t,v,h,o,p]);const A=typeof window<"u"&&(window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:");return(e=B)!=null&&e.isNativePlatform&&B.getPlatform(),n&&(A||!s)?r.jsx(P,{}):p?j?(console.log("ProtectedUserDashboard - Render state:",{isAuthenticated:j,profileRole:a==null?void 0:a.role,profileApproved:a==null?void 0:a.approved,isSubscriptionActive:v,hasSubscription:!!(t!=null&&t.subscription)}),console.log("ðŸ”¥ ProtectedUserDashboard - user:",s?{uid:s.uid,email:s.email}:"null"),console.log("ðŸ”¥ ProtectedUserDashboard - profile:",a?{userId:a.userId,role:a.role}:"null"),console.log("ðŸ”¥ ProtectedUserDashboard - loading:",n),console.log("ðŸ”¥ ProtectedUserDashboard - About to render UserDashboardPage"),r.jsxs("div",{className:"relative",children:[r.jsx(q.Suspense,{fallback:r.jsx(P,{}),children:r.jsx(te,{})}),r.jsx(se,{}),r.jsx(M,{open:k,onOpenChange:d=>b(d),mode:"verify",title:"Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹",description:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",onSuccess:()=>{I.markSessionVerified(s==null?void 0:s.uid),b(!1),m(!0)}})]})):r.jsxs(r.Fragment,{children:[r.jsx(P,{}),r.jsx(M,{open:k,onOpenChange:d=>b(d),mode:"verify",title:"Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹",description:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",onSuccess:()=>{I.markSessionVerified(s==null?void 0:s.uid),b(!1),m(!0)}})]}):r.jsx(P,{})};export{de as default};
//# sourceMappingURL=ProtectedUserDashboard-C-4M1qmw-BCCUsHPj.js.map
