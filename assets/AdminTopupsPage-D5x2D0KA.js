import{c as v,r,j as e,B as g,q as S,h as w,i as T,o as b,l as B,k,f as m}from"./index-5OsgE1a1.js";import{S as C,a as _,b as A,c as D,d}from"./select-CyMPOmWC.js";import"./index-BCZLaB78.js";const P=()=>{const{toast:n}=v(),[p,u]=r.useState([]),[j,h]=r.useState(!1),[o,y]=r.useState("all"),[l,f]=r.useState(null);r.useEffect(()=>{(async()=>{h(!0);try{const a=S(w(T,"topups"),b("created_at","desc"),B(100)),i=(await k(a)).docs.map(t=>({id:t.id,...t.data()}));u(i)}catch(a){console.error("Failed to fetch topups:",a),n({title:"خطأ",description:"تعذر تحميل العمليات",variant:"destructive"})}finally{h(!1)}})()},[n]),r.useEffect(()=>{(async()=>{var a;try{const c=await((a=m.currentUser)==null?void 0:a.getIdToken()),t=await(await fetch("/api/reloadly/balance",{headers:c?{Authorization:`Bearer ${c}`}:{}})).json().catch(()=>null);f((t==null?void 0:t.raw)??t)}catch{}})()},[]);const x=r.useMemo(()=>o==="all"?p:p.filter(s=>String(s.status).toLowerCase()===o),[p,o]),N=async s=>{var a;try{const c=await((a=m.currentUser)==null?void 0:a.getIdToken()),i=await fetch("/api/topup/retry",{method:"POST",headers:{"Content-Type":"application/json",...c?{Authorization:`Bearer ${c}`}:{}},body:JSON.stringify({id:s.id})}),t=await i.json().catch(()=>({success:!1,message:"فشل قراءة استجابة الخادم"}));i.ok&&(t!=null&&t.success)?n({title:"أُعيدت المحاولة",description:"تم إعادة محاولة العملية بنجاح"}):n({title:"فشل إعادة المحاولة",description:(t==null?void 0:t.message)||"حدث خطأ أثناء إعادة المحاولة",variant:"destructive"})}catch(c){console.error("Retry error:",c),n({title:"خطأ في الاتصال",description:"تعذر الاتصال بالخادم. حاول لاحقاً.",variant:"destructive"})}};return e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"لوحة تقارير الشحن"}),e.jsxs("div",{className:"text-sm text-gray-600",children:["رصيد Reloadly: ",(l==null?void 0:l.balance)??(l==null?void 0:l.availableBalance)??"غير متاح"]})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("span",{children:"الحالة:"}),e.jsxs(C,{value:o,onValueChange:s=>y(s),children:[e.jsx(_,{className:"w-40",children:e.jsx(A,{placeholder:"اختر الحالة"})}),e.jsxs(D,{children:[e.jsx(d,{value:"all",children:"الكل"}),e.jsx(d,{value:"pending",children:"في الانتظار"}),e.jsx(d,{value:"success",children:"ناجحة"}),e.jsx(d,{value:"failed",children:"فاشلة"})]})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-right",children:[e.jsx("th",{className:"px-2 py-1",children:"ID"}),e.jsx("th",{className:"px-2 py-1",children:"User"}),e.jsx("th",{className:"px-2 py-1",children:"Phone"}),e.jsx("th",{className:"px-2 py-1",children:"Operator"}),e.jsx("th",{className:"px-2 py-1",children:"Amount"}),e.jsx("th",{className:"px-2 py-1",children:"Status"}),e.jsx("th",{className:"px-2 py-1",children:"ProviderTxn"}),e.jsx("th",{className:"px-2 py-1",children:"Created"}),e.jsx("th",{className:"px-2 py-1",children:"Actions"})]})}),e.jsx("tbody",{children:j?e.jsx("tr",{children:e.jsx("td",{className:"p-4",colSpan:9,children:"جارٍ التحميل..."})}):x.length===0?e.jsx("tr",{children:e.jsx("td",{className:"p-4",colSpan:9,children:"لا يوجد بيانات"})}):x.map(s=>{var a;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-2 py-1 font-mono",children:s.id}),e.jsx("td",{className:"px-2 py-1",children:s.user_id||"-"}),e.jsx("td",{className:"px-2 py-1",children:s.phone}),e.jsx("td",{className:"px-2 py-1",children:s.operator}),e.jsx("td",{className:"px-2 py-1",children:s.amount_local}),e.jsx("td",{className:"px-2 py-1",children:s.status}),e.jsx("td",{className:"px-2 py-1",children:s.provider_txn_id||"-"}),e.jsx("td",{className:"px-2 py-1",children:(a=s.created_at)!=null&&a.toDate?s.created_at.toDate().toLocaleString():"-"}),e.jsx("td",{className:"px-2 py-1",children:String(s.status).toLowerCase()==="failed"&&e.jsx(g,{variant:"outline",onClick:()=>N(s),children:"Retry"})})]},s.id)})})]})})]})};export{P as default};
