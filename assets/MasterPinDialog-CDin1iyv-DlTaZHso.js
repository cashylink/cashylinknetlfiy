import{S as o,d as Y,W as oe,I as e,aI as ee,aJ as te,aK as se,aL as ae,t as U,a as y,P as q,m as H,N as re,aM as ue,aZ as de,A as he,bF as me,bG as fe,U as z,F as xe,v as L,G as Q,a0 as pe,as as ye,B as ge}from"./index-C_crvORM.js";import{u as _}from"./label-_mnIMROJ-DCx9a6ad.js";import{c as ve}from"./shield-DSoskD-c-Cy9u9Dod.js";import{r as je}from"./circle-alert-BbiXZQj6-CYYPNIuO.js";const X="master_pin",p=new Map;function b(l){return l?`${X}_${l}`:X}async function Ne(l){try{const t=await ye.getUserData(l),s=(t==null?void 0:t.security)&&t.security.masterPin||(t==null?void 0:t.masterPin)||null;return typeof s=="string"&&s.length>0?s:null}catch{try{const t=L(Q,"users",l),s=await ge(t);if(s.exists()){const a=s.data(),r=(a==null?void 0:a.security)&&a.security.masterPin||(a==null?void 0:a.masterPin)||null;return typeof r=="string"&&r.length>0?r:null}}catch{}return null}}function V(l){try{const t=localStorage.getItem(b(l));return t&&t.length>0?t:null}catch{return null}}async function J(l,t){try{const s={security:{masterPin:t||null,masterPinUpdatedAt:z()},updatedAt:z()};await xe(L(Q,"users",l),s,{merge:!0})}catch{try{await pe(L(Q,"users",l),{security:{masterPin:t||null,masterPinUpdatedAt:z()},updatedAt:z()})}catch{}}}function M(l,t){try{const s=b(l);t?localStorage.setItem(s,t):localStorage.removeItem(s)}catch{}}class w{static async hasMasterPin(t){const s=b(t);if(p.has(s)){const r=p.get(s);return r!==""&&r!=null}const a=V(t);if(a)return p.set(s,a),!0;if(t){const r=V(void 0);if(r){p.set(s,r),M(t,r);try{M(void 0,null)}catch{}return await J(t,r),!0}}if(t){const r=await Ne(t);if(r){p.set(s,r),M(t,r);try{M(void 0,null)}catch{}return!0}}return!1}static async createMasterPin(t,s){try{if(!t||t.length<4)return!1;const a=btoa(t),r=b(s);return p.set(r,a),M(s,a),s&&await J(s,a),!0}catch(a){return console.error("Error creating master PIN:",a),!1}}static async verifyMasterPin(t,s){try{const a=b(s);if(!await this.hasMasterPin(s))return!1;const r=p.get(a);return r?atob(r)===t:!1}catch(a){return console.error("Error verifying master PIN:",a),!1}}static async changeMasterPin(t,s,a){try{return await this.verifyMasterPin(t,a)?await this.createMasterPin(s,a):!1}catch(r){return console.error("Error changing master PIN:",r),!1}}static async deleteMasterPin(t){try{const s=b(t);return p.delete(s),M(t,null),t&&await J(t,null),!0}catch(s){return console.error("Error deleting master PIN:",s),!1}}static async getMasterPin(t){try{const s=b(t);if(!await this.hasMasterPin(t))return null;const a=p.get(s);return a?atob(a):null}catch(s){return console.error("Error getting master PIN:",s),null}}}const we=({open:l,onOpenChange:t,title:s="تأكيد كلمة المرور",description:a="أدخل كلمة مرور تسجيل الدخول للمتابعة",onSuccess:r})=>{const{toast:n}=Y(),[m,P]=o.useState(""),[u,g]=o.useState(!1),[S,v]=o.useState(null),k=async()=>{v(null);try{const c=he.currentUser;if(!c||!c.email){v("لا يوجد مستخدم مسجل حالياً. يرجى تسجيل الدخول أولاً.");return}g(!0);const j=me.credential(c.email,m);await fe(c,j),g(!1),P(""),n({title:"تم التأكيد",description:"تم التحقق من كلمة المرور بنجاح"}),r(),t&&t(!1)}catch(c){console.error("إعادة التحقق بكلمة المرور فشلت:",c),g(!1);const j=(c==null?void 0:c.code)||"";v(j==="auth/wrong-password"?"كلمة المرور غير صحيحة. حاول مرة أخرى.":j==="auth/too-many-requests"?"تمت محاولات كثيرة. يرجى الانتظار قليلاً ثم المحاولة.":"حدث خطأ أثناء التحقق. حاول مرة أخرى.")}},I=c=>{t&&t(c),c||(P(""),v(null),g(!1))};return e.jsx(ee,{open:l,onOpenChange:I,children:e.jsxs(te,{className:"sm:max-w-[400px]",dir:"rtl",children:[e.jsxs(se,{children:[e.jsx(ae,{className:"text-right",children:s}),e.jsx(ue,{className:"text-right",children:a})]}),e.jsxs("div",{className:"grid gap-4 py-2",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-2",children:[e.jsx("label",{htmlFor:"password",className:"text-right col-span-1 text-sm",children:"كلمة المرور"}),e.jsxs("div",{className:"col-span-3 relative",children:[e.jsx(re,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(U,{id:"password",type:"password",value:m,onChange:c=>P(c.target.value),placeholder:"نفس كلمة مرور تسجيل الدخول",autoComplete:"off"})]})]}),S&&e.jsx("div",{className:"text-red-600 text-xs text-right",children:S})]}),e.jsxs(de,{className:"flex justify-end gap-2",children:[e.jsx(y,{variant:"outline",onClick:()=>I(!1),disabled:u,children:"إلغاء"}),e.jsx(y,{onClick:k,disabled:u||!m,className:"bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",children:u?"جاري التحقق...":"تأكيد"})]})]})})},Me=({open:l,onOpenChange:t,onSuccess:s,title:a="الرقم السري الرئيسي",description:r="رقم سري موحد لإدارة جميع عناصر الموقع",mode:n="verify"})=>{const[m,P]=o.useState(""),[u,g]=o.useState(""),[S,v]=o.useState(""),[k,I]=o.useState(!1),[c,j]=o.useState(!1),[G,R]=o.useState(!1),[W,d]=o.useState(""),[Z,h]=o.useState(!1),{toast:O}=Y(),{user:B,profile:A}=oe(),x=B==null?void 0:B.uid,[N,ne]=o.useState(!1),[E,le]=o.useState(!1),K=(A==null?void 0:A.role)==="admin"||(A==null?void 0:A.role)==="staff",[ie,$]=o.useState(!1),[C,T]=o.useState(!1),D=o.useRef(null);o.useEffect(()=>{let i=!0;return l&&(async()=>{try{const f=await w.hasMasterPin(x);i&&ne(f)}catch{}})(),()=>{i=!1}},[x,l]);const ce=async i=>{i.preventDefault(),d(""),h(!0);try{if(n==="verify"){if(!m){d("يرجى إدخال الرقم السري الرئيسي"),h(!1);return}if(!await w.verifyMasterPin(m,x)){d("الرقم السري غير صحيح"),h(!1);return}O({title:"تم التأكيد",description:"تم التحقق من الرقم السري بنجاح"}),s==null||s(),F()}else if(n==="create"){if(!u||u.length<4){d("يجب أن يكون الرقم السري الجديد 4 أرقام على الأقل"),h(!1);return}if(u!==S){d("الرقم السري الجديد وتأكيده غير متطابقين"),h(!1);return}if(!await w.createMasterPin(u,x)){d("تعذر إنشاء الرقم السري الرئيسي"),h(!1);return}O({title:"تم تعيين الرقم السري الرئيسي",description:"تم تعيين الرقم السري الرئيسي بنجاح"}),s==null||s(),F()}else if(n==="change"){if(!x){d("لا يمكن تغيير الرقم السري قبل تحميل حساب المستخدم. الرجاء إعادة المحاولة بعد تسجيل الدخول أو انتظار التحميل."),h(!1);return}if(N&&!E&&!C){if(!m){d("يرجى إدخال الرقم السري الحالي أو تأكيد كلمة الدخول"),h(!1);return}if(!await w.verifyMasterPin(m,x)){d("الرقم السري الحالي غير صحيح"),h(!1);return}}if(!u||u.length<4){d("يجب أن يكون الرقم السري الجديد 4 أرقام على الأقل"),h(!1);return}if(u!==S){d("الرقم السري الجديد وتأكيده غير متطابقين"),h(!1);return}if(!(N?E&&K||C?await w.createMasterPin(u,x):await w.changeMasterPin(m,u,x):await w.createMasterPin(u,x))){d("تعذر تغيير الرقم السري الرئيسي"),h(!1);return}O({title:N?E&&K||C?"تم إعادة تعيين الرقم السري الرئيسي":"تم تغيير الرقم السري الرئيسي":"تم تعيين الرقم السري الرئيسي",description:N?E&&K||C?"تمت إعادة التعيين بدون الحاجة للرقم الحالي":"تم تغيير الرقم السري الرئيسي بنجاح":"تم تعيين الرقم السري الرئيسي بنجاح"}),s==null||s(),F()}}catch{d("حدث خطأ أثناء معالجة الرقم السري")}finally{h(!1)}},F=()=>{P(""),g(""),v(""),d(""),I(!1),j(!1),R(!1),T(!1),$(!1),t(!1)};return e.jsx(ee,{open:l,onOpenChange:F,children:e.jsxs(te,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(se,{children:e.jsxs(ae,{className:"flex items-center gap-2 text-center justify-center",children:[e.jsx(ve,{className:"h-5 w-5 text-blue-600"}),a]})}),e.jsx("div",{className:"text-center text-sm text-gray-600 mb-4",children:r}),e.jsxs("form",{ref:D,onSubmit:ce,className:"space-y-4",children:[(n==="verify"||n==="change"&&N)&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"currentPin",className:"text-right block",children:n==="verify"?"الرقم السري الرئيسي":"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"currentPin",type:k?"text":"password",autoComplete:"off",value:m,onChange:i=>P(i.target.value),onKeyDown:i=>{var f;if(i.key==="Enter")try{(f=D.current)==null||f.requestSubmit()}catch{}},placeholder:n==="verify"?"أدخل الرقم السري الرئيسي":"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr",disabled:n==="change"&&C}),e.jsx(y,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>I(!k),children:k?e.jsx(q,{className:"h-4 w-4"}):e.jsx(H,{className:"h-4 w-4"})})]}),n==="change"&&N&&K&&e.jsxs("div",{className:"text-xs text-gray-600 mt-2 flex items-center justify-between",children:[e.jsx("span",{children:"نسيت الرقم السري؟"}),e.jsx(y,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2",onClick:()=>{le(i=>!i)},children:E?"إلغاء إعادة التعيين الإدارية":"إعادة تعيين بدون الرقم الحالي"})]}),n==="change"&&N&&e.jsxs("div",{className:"text-xs text-gray-600 mt-2 flex items-center justify-between",children:[e.jsx("span",{children:"لا تعرف الرقم الحالي؟ يمكنك تأكيد بكلمة الدخول"}),e.jsx(y,{type:"button",variant:"secondary",size:"sm",className:"h-7 px-2",onClick:()=>$(!0),children:"تأكيد بكلمة الدخول"})]}),n==="change"&&C&&e.jsx("div",{className:"text-[11px] text-green-600",children:"تم التحقق من كلمة الدخول — يمكنك المتابعة بدون الرقم الحالي"})]}),(n==="create"||n==="change")&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"newPin",className:"text-right block",children:n==="create"?"الرقم السري الرئيسي الجديد":"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"newPin",type:c?"text":"password",autoComplete:"off",value:u,onChange:i=>g(i.target.value),onKeyDown:i=>{var f;if(i.key==="Enter")try{(f=D.current)==null||f.requestSubmit()}catch{}},placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(y,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>j(!c),children:c?e.jsx(q,{className:"h-4 w-4"}):e.jsx(H,{className:"h-4 w-4"})})]})]}),(n==="create"||n==="change")&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:G?"text":"password",autoComplete:"off",value:S,onChange:i=>v(i.target.value),onKeyDown:i=>{var f;if(i.key==="Enter")try{(f=D.current)==null||f.requestSubmit()}catch{}},placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(y,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>R(!G),children:G?e.jsx(q,{className:"h-4 w-4"}):e.jsx(H,{className:"h-4 w-4"})})]})]}),W&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm bg-red-50 p-3 rounded-lg",children:[e.jsx(je,{className:"h-4 w-4"}),W]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(y,{type:"button",variant:"outline",onClick:F,className:"flex-1",children:"إلغاء"}),e.jsx(y,{type:"submit",disabled:Z,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:Z?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري المعالجة..."]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),n==="verify"?"تحقق":n==="create"?"إنشاء":"تغيير"]})})]})]}),e.jsx(we,{open:ie,onOpenChange:$,title:"تأكيد بكلمة دخول الحساب",description:"أدخل كلمة المرور المستخدمة لتسجيل الدخول للسماح بتغيير الرقم السري",onSuccess:()=>{T(!0),$(!1),d("")}})]})})};export{Me as E,we as N,w as P};
//# sourceMappingURL=MasterPinDialog-CDin1iyv-DlTaZHso.js.map
