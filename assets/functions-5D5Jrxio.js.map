{"version":3,"file":"functions-5D5Jrxio.js","sources":["../../src/integrations/firebase/functions.ts"],"sourcesContent":["import { getFunctions, httpsCallable } from 'firebase/functions';\r\nimport { functions } from '../../firebase';\r\nimport { Transaction } from './types';\r\n\r\n// واجهة بيانات الحصول على آخر المعاملات\r\ninterface GetLastTransactionsData {\r\n  limit?: number;\r\n  walletId?: string;\r\n  lineId?: string;\r\n  merchantUserId?: string;\r\n}\r\n\r\n// واجهة نتيجة الحصول على آخر المعاملات\r\ninterface GetLastTransactionsResult {\r\n  transactions: Transaction[];\r\n}\r\n\r\n// واجهات البيانات للوظائف الإضافية\r\ninterface CancelTransactionData {\r\n  transactionId: string;\r\n  reason: string;\r\n  cancelledBy: string;\r\n}\r\n\r\ninterface UpdateTransactionStatusData {\r\n  transactionId: string;\r\n  status: 'pending' | 'completed' | 'failed' | 'cancelled';\r\n  updatedBy: string;\r\n  note?: string;\r\n}\r\n\r\n// واجهات النتائج للوظائف الإضافية\r\ninterface CancelTransactionResult {\r\n  success: boolean;\r\n  message?: string;\r\n}\r\n\r\ninterface UpdateTransactionStatusResult {\r\n  success: boolean;\r\n  message?: string;\r\n}\r\n\r\n// استخدام خدمة Functions المُهيأة مسبقاً\r\n// const functions = getFunctions(app); // تم استيرادها من firebase.ts\r\n\r\n// واجهة بيانات تسجيل المعاملة\r\ninterface RecordTransactionData {\r\n  lineId: string;\r\n  walletId: string;\r\n  txnType: 'send' | 'receive';\r\n  amount: number;\r\n  senderMsisdn?: string;\r\n  receiverMsisdn?: string;\r\n  reference?: string;\r\n  fee?: number;\r\n}\r\n\r\n// واجهة نتيجة تسجيل المعاملة\r\ninterface RecordTransactionResult {\r\n  id: string;\r\n  shopId: string;\r\n  lineId: string;\r\n  walletId: string;\r\n  merchantUserId: string;\r\n  provider: string;\r\n  txnType: 'send' | 'receive';\r\n  amount: number;\r\n  commission: number;\r\n  profit: number;\r\n  sender_msisdn: string;\r\n  receiver_msisdn: string;\r\n  reference: string | null;\r\n  status: 'confirmed';\r\n  createdAt: string;\r\n  fee?: number;\r\n}\r\n\r\n/**\r\n * تسجيل معاملة جديدة باستخدام Cloud Function\r\n * @param data بيانات المعاملة\r\n * @returns وعد بنتيجة المعاملة\r\n */\r\nexport const recordTransaction = async (data: RecordTransactionData): Promise<RecordTransactionResult> => {\r\n  try {\r\n    // استدعاء دالة Cloud Function\r\n    const recordTransactionFn = httpsCallable<RecordTransactionData, RecordTransactionResult>(\r\n      functions,\r\n      'recordTransaction'\r\n    );\r\n\r\n    // تنفيذ الاستدعاء\r\n    const result = await recordTransactionFn(data);\r\n    \r\n    // إرجاع البيانات\r\n    return result.data;\r\n  } catch (error: any) {\r\n    console.error('Error recording transaction:', error);\r\n    \r\n    // إعادة رمي الخطأ مع رسالة مناسبة\r\n    if (error.code === 'functions/unauthenticated') {\r\n      throw new Error('يجب تسجيل الدخول لتسجيل المعاملة');\r\n    } else if (error.code === 'functions/invalid-argument') {\r\n      throw new Error('بيانات المعاملة غير صالحة: ' + error.message);\r\n    } else if (error.code === 'functions/resource-exhausted') {\r\n      throw new Error('تم تجاوز الحد: ' + error.message);\r\n    } else if (error.code === 'functions/failed-precondition') {\r\n      throw new Error('شرط مسبق غير محقق: ' + error.message);\r\n    } else {\r\n      throw new Error('حدث خطأ أثناء تسجيل المعاملة: ' + (error.message || 'خطأ غير معروف'));\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * إلغاء معاملة باستخدام Cloud Function\r\n * @param data بيانات إلغاء المعاملة\r\n * @returns وعد بنتيجة العملية\r\n */\r\nexport const cancelTransaction = async (data: CancelTransactionData): Promise<CancelTransactionResult> => {\r\n  try {\r\n    // استدعاء دالة Cloud Function\r\n    const cancelTransactionFn = httpsCallable<CancelTransactionData, CancelTransactionResult>(\r\n      functions,\r\n      'cancelTransaction'\r\n    );\r\n\r\n    // تنفيذ الاستدعاء\r\n    const result = await cancelTransactionFn(data);\r\n    \r\n    // إرجاع البيانات\r\n    return result.data;\r\n  } catch (error: any) {\r\n    console.error('Error cancelling transaction:', error);\r\n    \r\n    // إعادة رمي الخطأ مع رسالة مناسبة\r\n    if (error.code === 'functions/unauthenticated') {\r\n      throw new Error('يجب تسجيل الدخول لإلغاء المعاملة');\r\n    } else if (error.code === 'functions/invalid-argument') {\r\n      throw new Error('بيانات الإلغاء غير صالحة: ' + error.message);\r\n    } else if (error.code === 'functions/not-found') {\r\n      throw new Error('المعاملة غير موجودة: ' + error.message);\r\n    } else if (error.code === 'functions/permission-denied') {\r\n      throw new Error('ليس لديك صلاحية لإلغاء هذه المعاملة: ' + error.message);\r\n    } else {\r\n      throw new Error('حدث خطأ أثناء إلغاء المعاملة: ' + (error.message || 'خطأ غير معروف'));\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * تحديث حالة معاملة باستخدام Cloud Function\r\n * @param data بيانات تحديث الحالة\r\n * @returns وعد بنتيجة العملية\r\n */\r\n/**\r\n * الحصول على آخر المعاملات باستخدام Cloud Function\r\n * @param data بيانات الاستعلام\r\n * @returns وعد بقائمة المعاملات\r\n */\r\nexport const getLastTransactions = async (data: GetLastTransactionsData = {}): Promise<GetLastTransactionsResult> => {\r\n  try {\r\n    // استدعاء دالة Cloud Function\r\n    const getLastTransactionsFn = httpsCallable<GetLastTransactionsData, GetLastTransactionsResult>(\r\n      functions,\r\n      'getLastTransactions'\r\n    );\r\n\r\n    // تنفيذ الاستدعاء\r\n    const result = await getLastTransactionsFn(data);\r\n    \r\n    // إرجاع البيانات\r\n    return result.data;\r\n  } catch (error: any) {\r\n    console.error('Error getting last transactions:', error);\r\n    \r\n    // إعادة رمي الخطأ مع رسالة مناسبة\r\n    if (error.code === 'functions/unauthenticated') {\r\n      throw new Error('يجب تسجيل الدخول للوصول إلى المعاملات');\r\n    } else if (error.code === 'functions/invalid-argument') {\r\n      throw new Error('بيانات الاستعلام غير صالحة: ' + error.message);\r\n    } else if (error.code === 'functions/permission-denied') {\r\n      throw new Error('ليس لديك صلاحية للوصول إلى هذه المعاملات: ' + error.message);\r\n    } else {\r\n      throw new Error('حدث خطأ أثناء جلب المعاملات: ' + (error.message || 'خطأ غير معروف'));\r\n    }\r\n  }\r\n};\r\n\r\nexport const updateTransactionStatus = async (data: UpdateTransactionStatusData): Promise<UpdateTransactionStatusResult> => {\r\n  try {\r\n    // استدعاء دالة Cloud Function\r\n    const updateStatusFn = httpsCallable<UpdateTransactionStatusData, UpdateTransactionStatusResult>(\r\n      functions,\r\n      'updateTransactionStatus'\r\n    );\r\n\r\n    // تنفيذ الاستدعاء\r\n    const result = await updateStatusFn(data);\r\n    \r\n    // إرجاع البيانات\r\n    return result.data;\r\n  } catch (error: any) {\r\n    console.error('Error updating transaction status:', error);\r\n    \r\n    // إعادة رمي الخطأ مع رسالة مناسبة\r\n    if (error.code === 'functions/unauthenticated') {\r\n      throw new Error('يجب تسجيل الدخول لتحديث حالة المعاملة');\r\n    } else if (error.code === 'functions/invalid-argument') {\r\n      throw new Error('بيانات التحديث غير صالحة: ' + error.message);\r\n    } else if (error.code === 'functions/not-found') {\r\n      throw new Error('المعاملة غير موجودة: ' + error.message);\r\n    } else if (error.code === 'functions/permission-denied') {\r\n      throw new Error('ليس لديك صلاحية لتحديث حالة هذه المعاملة: ' + error.message);\r\n    } else {\r\n      throw new Error('حدث خطأ أثناء تحديث حالة المعاملة: ' + (error.message || 'خطأ غير معروف'));\r\n    }\r\n  }\r\n};\r\n\r\nexport const sendTelegramMessage = async (data: { chatId: string; text: string }): Promise<{ ok: boolean }> => {\r\n  const fn = httpsCallable<typeof data, { ok: boolean }>(functions, 'sendTelegramMessage');\r\n  const res = await fn(data);\r\n  return res.data;\r\n};\r\n\r\nexport const sendTelegramDailySummary = async (data: { userId?: string; chatId: string; text: string }): Promise<{ ok: boolean }> => {\r\n  return sendTelegramMessage({ chatId: data.chatId, text: data.text });\r\n};\r\n"],"names":["getLastTransactions","data","httpsCallable","functions","error","sendTelegramMessage"],"mappings":"+CA+JO,MAAMA,EAAsB,MAAOC,EAAgC,KAA2C,CACnH,GAAI,CAWF,OAHe,MANeC,EAC5BC,EACA,qBAAA,EAIyCF,CAAI,GAGjC,IAChB,OAASG,EAAY,CAInB,MAHA,QAAQ,MAAM,mCAAoCA,CAAK,EAGnDA,EAAM,OAAS,4BACX,IAAI,MAAM,uCAAuC,EAC9CA,EAAM,OAAS,6BAClB,IAAI,MAAM,+BAAiCA,EAAM,OAAO,EACrDA,EAAM,OAAS,8BAClB,IAAI,MAAM,6CAA+CA,EAAM,OAAO,EAEtE,IAAI,MAAM,iCAAmCA,EAAM,SAAW,gBAAgB,CAExF,CACF,EAiCaC,EAAsB,MAAOJ,IAE5B,MADDC,EAA4CC,EAAW,qBAAqB,EAClEF,CAAI,GACd"}