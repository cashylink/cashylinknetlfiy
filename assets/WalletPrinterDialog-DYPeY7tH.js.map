{"version":3,"file":"WalletPrinterDialog-DYPeY7tH.js","sources":["../../src/components/WalletPrinterDialog.tsx"],"sourcesContent":["import React, { useState, useRef } from 'react';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Printer, Save, ArrowLeft, Wallet, Download } from 'lucide-react';\nimport { useShop } from '@/hooks/useShop';\nimport { useToast } from '@/hooks/use-toast';\nimport html2canvas from 'html2canvas';\n\ninterface Wallet {\n  id: string;\n  name: string;\n  phone: string;\n  walletProvider?: string;\n}\n\ninterface WalletPrinterDialogProps {\n  isOpen: boolean;\n  onClose: () => void;\n  wallets: Wallet[];\n  initialWalletId?: string;\n}\n\nconst WalletPrinterDialog: React.FC<WalletPrinterDialogProps> = ({ isOpen, onClose, wallets, initialWalletId }) => {\n  const { shopName } = useShop();\n  const { toast } = useToast();\n  const [selectedWallet, setSelectedWallet] = useState<Wallet | null>(null);\n  const [customMessage, setCustomMessage] = useState<string>('هذا الرقم خاص بالمحل، يرجى التأكد من الرقم قبل التحويل.');\n  const [isEditingMessage, setIsEditingMessage] = useState(false);\n  const cardRef = useRef<HTMLDivElement>(null);\n\n  React.useEffect(() => {\n    if (isOpen && initialWalletId) {\n      const wallet = wallets.find(w => w.id === initialWalletId);\n      if (wallet) {\n        setSelectedWallet(wallet);\n      }\n    } else if (isOpen && !initialWalletId) {\n        setSelectedWallet(null);\n    }\n  }, [isOpen, initialWalletId, wallets]);\n\n  const handlePrint = () => {\n    if (!selectedWallet) return;\n\n    const printContent = `\n      <div style=\"direction: rtl; font-family: 'Cairo', sans-serif; text-align: center; width: 100%; margin: 0 auto; padding: 5px;\">\n        <h2 style=\"margin: 0 0 5px 0; font-size: 20px; font-weight: 800;\">${shopName || 'المحل'}</h2>\n        <div style=\"margin: 10px 0; font-size: 40px; font-weight: 900; letter-spacing: 1px; line-height: 1;\">${selectedWallet.phone}</div>\n        <p style=\"margin: 5px 0 15px 0; font-size: 16px; font-weight: 700;\">المسجل باسم: ${selectedWallet.name}</p>\n        \n        <div style=\"border-top: 2px dashed #000; margin: 10px 0;\"></div>\n        \n        <p style=\"margin: 10px 0; font-size: 16px; font-weight: 700; line-height: 1.4; white-space: pre-wrap;\">${customMessage}</p>\n        \n        <div style=\"border-top: 2px dashed #000; margin: 10px 0;\"></div>\n        \n        <p style=\"margin: 10px 0 5px 0; font-size: 12px; font-family: monospace; font-weight: bold;\">cashy-link.com</p>\n      </div>\n    `;\n\n    const iframe = document.createElement('iframe');\n    iframe.style.display = 'none';\n    document.body.appendChild(iframe);\n    \n    const doc = iframe.contentWindow?.document;\n    if (doc) {\n      doc.open();\n      doc.write(`\n        <html>\n          <head>\n            <title>Print Wallet</title>\n            <style>\n              @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800;900&display=swap');\n              body { \n                margin: 0; \n                padding: 0; \n                width: 76mm; /* Safe width for 80mm paper */\n              }\n              @page { \n                size: 80mm auto; \n                margin: 0mm; \n              }\n            </style>\n          </head>\n          <body>\n            ${printContent}\n            <script>\n              window.onload = function() {\n                window.print();\n                window.onafterprint = function() {\n                  window.parent.document.body.removeChild(window.frameElement);\n                }\n              }\n            </script>\n          </body>\n        </html>\n      `);\n      doc.close();\n    }\n  };\n\n  const handleSaveMessage = () => {\n    localStorage.setItem('wallet_printer_message', customMessage);\n    setIsEditingMessage(false);\n    toast({\n      title: \"تم الحفظ\",\n      description: \"تم حفظ الرسالة بنجاح\",\n    });\n  };\n\n  const handleDownloadImage = async () => {\n    if (!cardRef.current || !selectedWallet) return;\n    \n    try {\n      // انتظر تحميل الخطوط لتفادي مشاكل العرض\n      try { await (document as any).fonts?.ready; } catch {}\n\n      const canvas = await html2canvas(cardRef.current, {\n        scale: 2,\n        useCORS: true,\n        allowTaint: true,\n        backgroundColor: '#ffffff',\n      });\n      \n      const url = canvas.toDataURL('image/png');\n      const link = document.createElement('a');\n      link.download = `wallet-${selectedWallet.phone}.png`;\n      link.href = url;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      \n      toast({\n        title: \"تم الحفظ\",\n        description: \"تم حفظ صورة المحفظة بنجاح\",\n      });\n    } catch (error) {\n      console.error('Error saving image:', error);\n      toast({\n        title: \"خطأ\",\n        description: \"حدث خطأ أثناء حفظ الصورة\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Load saved message on mount\n  React.useEffect(() => {\n    const savedMessage = localStorage.getItem('wallet_printer_message');\n    if (savedMessage) {\n      setCustomMessage(savedMessage);\n    }\n  }, []);\n\n  return (\n    <Dialog open={isOpen} onOpenChange={(open) => !open && onClose()}>\n      <DialogContent className=\"sm:max-w-md\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Printer className=\"h-5 w-5\" />\n            طباعة رقم المحفظة\n          </DialogTitle>\n        </DialogHeader>\n\n        {!selectedWallet ? (\n          <div className=\"grid gap-4 py-4\">\n            <p className=\"text-sm text-muted-foreground text-center mb-2\">\n              اختر المحفظة المراد طباعتها\n            </p>\n            <div className=\"grid grid-cols-1 gap-2 max-h-[300px] overflow-y-auto pr-1\">\n              {wallets.map((wallet) => (\n                <Button\n                  key={wallet.id}\n                  variant=\"outline\"\n                  className=\"justify-start h-auto py-3 px-4\"\n                  onClick={() => setSelectedWallet(wallet)}\n                >\n                  <Wallet className=\"h-4 w-4 ml-2 text-primary\" />\n                  <div className=\"flex flex-col items-start gap-1\">\n                    <span className=\"font-bold\">{wallet.name}</span>\n                    <span className=\"text-xs text-muted-foreground dir-ltr\">{wallet.phone}</span>\n                  </div>\n                </Button>\n              ))}\n              {wallets.length === 0 && (\n                <div className=\"text-center py-8 text-muted-foreground border rounded-lg border-dashed\">\n                  لا توجد محافظ مضافة\n                </div>\n              )}\n            </div>\n          </div>\n        ) : (\n          <div className=\"space-y-6 py-4\">\n            <Button \n              variant=\"ghost\" \n              size=\"sm\" \n              onClick={() => setSelectedWallet(null)}\n              className=\"mb-2 h-8 px-2\"\n            >\n              <ArrowLeft className=\"h-4 w-4 ml-1\" />\n              عودة للقائمة\n            </Button>\n\n            <div ref={cardRef} className=\"border rounded-lg p-6 bg-white shadow-sm text-center space-y-4\">\n              <h3 className=\"font-bold text-xl\">{shopName || 'المحل'}</h3>\n              \n              <div className=\"py-4 bg-gray-50 rounded-lg border border-gray-100\">\n                <div className=\"text-4xl font-black tracking-widest font-mono text-primary\">\n                  {selectedWallet.phone}\n                </div>\n                <div className=\"text-lg text-gray-900 mt-2 font-bold\">\n                  المسجل باسم: {selectedWallet.name}\n                </div>\n              </div>\n\n              <div className=\"relative\">\n                {isEditingMessage ? (\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"message\">رسالة مخصصة</Label>\n                    <Textarea\n                      id=\"message\"\n                      value={customMessage}\n                      onChange={(e) => setCustomMessage(e.target.value)}\n                      className=\"min-h-[80px] text-center font-bold text-base\"\n                    />\n                    <Button size=\"sm\" onClick={handleSaveMessage} className=\"w-full\">\n                      <Save className=\"h-3 w-3 ml-2\" />\n                      حفظ النص\n                    </Button>\n                  </div>\n                ) : (\n                  <div \n                    className=\"p-3 border border-dashed rounded bg-gray-50 text-base font-bold cursor-pointer hover:bg-gray-100 transition-colors\"\n                    onClick={() => setIsEditingMessage(true)}\n                    title=\"انقر للتعديل\"\n                  >\n                    {customMessage}\n                  </div>\n                )}\n              </div>\n\n              <div className=\"pt-4 border-t border-gray-100 mt-4\">\n                 <p className=\"text-xs text-gray-400 font-mono font-semibold tracking-wider\">cashy-link.com</p>\n              </div>\n            </div>\n\n            <div className=\"flex flex-col gap-3 pt-2\">\n              <Button onClick={handlePrint} className=\"w-full h-12 text-lg font-bold shadow-sm bg-slate-900 text-white hover:bg-slate-800\" variant=\"default\">\n                <Printer className=\"h-5 w-5 ml-2\" />\n                طباعة الرقم (كاشير)\n              </Button>\n              <Button onClick={handleDownloadImage} variant=\"secondary\" className=\"w-full h-10 border border-gray-200 bg-white hover:bg-gray-50 text-gray-700\">\n                <Download className=\"h-4 w-4 ml-2\" />\n                حفظ صورة للمشاركة\n              </Button>\n            </div>\n          </div>\n        )}\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default WalletPrinterDialog;\n"],"names":["WalletPrinterDialog","isOpen","onClose","wallets","initialWalletId","shopName","useShop","toast","useToast","selectedWallet","setSelectedWallet","useState","customMessage","setCustomMessage","isEditingMessage","setIsEditingMessage","cardRef","useRef","React","wallet","w","handlePrint","printContent","iframe","doc","_a","handleSaveMessage","handleDownloadImage","url","html2canvas","link","error","savedMessage","jsx","Dialog","open","jsxs","DialogContent","DialogHeader","DialogTitle","Printer","Button","ArrowLeft","Label","Textarea","e","Save","Download","Wallet"],"mappings":"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"}