import{v as o,G as T,B as f,F as w,U as h,a6 as S,a0 as E}from"./index-BsVRzvOf.js";var p=Object.defineProperty,U=(g,r,e)=>r in g?p(g,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):g[r]=e,A=(g,r,e)=>U(g,r+"",e);class O{static async startFreeTrialFromAdmin(r){var e,i,s,n;try{const t=o(T,"users",r),c=await f(t);if(!c.exists())return{success:!1,message:"المستخدم غير موجود"};const a=c.data(),l=!!a.hasUsedFreeTrial,d=(i=(e=a.freeTrialStartDate)==null?void 0:e.toDate)!=null&&i.call(e)?a.freeTrialStartDate.toDate():a.freeTrialStartDate?new Date(a.freeTrialStartDate):null,D=(n=(s=a.freeTrialEndDate)==null?void 0:s.toDate)!=null&&n.call(s)?a.freeTrialEndDate.toDate():a.freeTrialEndDate?new Date(a.freeTrialEndDate):null;if(l&&!(l&&!d&&!D))return{success:!1,message:"لقد استخدم هذا المستخدم التجربة المجانية من قبل"};const m=new Date,u=await this.getTrialDurationHours(),v=new Date(m.getTime()+u*60*60*1e3);return await w(t,{hasUsedFreeTrial:!0,freeTrialStartDate:m,freeTrialEndDate:v,isOnFreeTrial:!0,isActive:!0,approved:!0,updatedAt:h()},{merge:!0}),{success:!0,message:`تم تفعيل التجربة المجانية لمدة ${u} ${u>=3&&u<=10?"ساعات":u===2?"ساعتين":"ساعة"}`}}catch(t){return console.error("Error starting admin free trial:",t),{success:!1,message:"حدث خطأ أثناء تفعيل التجربة المجانية"}}}static async startFreeTrial(r){var e,i,s,n;try{const t=o(T,"users",r),c=await f(t);if(!c.exists())return{success:!1,message:"المستخدم غير موجود"};const a=c.data(),l=!!a.hasUsedFreeTrial,d=(i=(e=a.freeTrialStartDate)==null?void 0:e.toDate)!=null&&i.call(e)?a.freeTrialStartDate.toDate():a.freeTrialStartDate?new Date(a.freeTrialStartDate):null,D=(n=(s=a.freeTrialEndDate)==null?void 0:s.toDate)!=null&&n.call(s)?a.freeTrialEndDate.toDate():a.freeTrialEndDate?new Date(a.freeTrialEndDate):null;if(l&&!(l&&!d&&!D))return{success:!1,message:"لقد استخدمت التجربة المجانية من قبل"};const m=new Date,u=await this.getTrialDurationHours(),v=new Date(m.getTime()+u*60*60*1e3);return await w(t,{hasUsedFreeTrial:!0,freeTrialStartDate:m,freeTrialEndDate:v,isOnFreeTrial:!0,isActive:!0,approved:!0,updatedAt:h()},{merge:!0}),{success:!0,message:`تم تفعيل التجربة المجانية لمدة ${u} ${u>=3&&u<=10?"ساعات":u===2?"ساعتين":"ساعة"}`}}catch(t){return console.error("خطأ في بدء التجربة المجانية:",t),{success:!1,message:"حدث خطأ أثناء تفعيل التجربة المجانية"}}}static async checkTrialValidity(r){var e,i,s,n;try{const t=o(T,"users",r),c=await f(t);if(!c.exists())return{isValid:!1,isExpired:!1,hoursRemaining:0,hasUsedTrial:!1};const a=c.data(),l=a.hasUsedFreeTrial||!1,d=a.isOnFreeTrial||!1;let D=(i=(e=a.freeTrialEndDate)==null?void 0:e.toDate)!=null&&i.call(e)?a.freeTrialEndDate.toDate():a.freeTrialEndDate?new Date(a.freeTrialEndDate):null;const m=(n=(s=a.freeTrialStartDate)==null?void 0:s.toDate)!=null&&n.call(s)?a.freeTrialStartDate.toDate():a.freeTrialStartDate?new Date(a.freeTrialStartDate):null;if(!l||!d||!D)return{isValid:!1,isExpired:!1,hoursRemaining:0,hasUsedTrial:l};const u=new Date;if(u>D){const F=S(a.subscription);return await E(t,{isOnFreeTrial:!1,isActive:F,approved:F,updatedAt:h()}),{isValid:!1,isExpired:!0,hoursRemaining:0,hasUsedTrial:l}}const v=D.getTime()-u.getTime();return{isValid:!0,isExpired:!1,hoursRemaining:Math.ceil(v/(1e3*3600)),hasUsedTrial:l}}catch(t){return console.error("خطأ في التحقق من صلاحية التجربة المجانية:",t),{isValid:!1,isExpired:!1,hoursRemaining:0,hasUsedTrial:!1}}}static async getTrialData(r){var e,i;try{const s=o(T,"users",r),n=await f(s);if(!n.exists())return{hasUsedFreeTrial:!1,freeTrialStartDate:null,freeTrialEndDate:null,isOnFreeTrial:!1};const t=n.data();return{hasUsedFreeTrial:t.hasUsedFreeTrial||!1,freeTrialStartDate:((e=t.freeTrialStartDate)==null?void 0:e.toDate())||null,freeTrialEndDate:((i=t.freeTrialEndDate)==null?void 0:i.toDate())||null,isOnFreeTrial:t.isOnFreeTrial||!1}}catch(s){return console.error("خطأ في الحصول على بيانات التجربة المجانية:",s),{hasUsedFreeTrial:!1,freeTrialStartDate:null,freeTrialEndDate:null,isOnFreeTrial:!1}}}static async getTrialDurationHours(){try{const r=o(T,"config","freeTrial"),e=await f(r);if(e.exists()){const i=e.data(),s=typeof(i==null?void 0:i.durationHours)=="number"?i.durationHours:this.TRIAL_DURATION_HOURS;return!Number.isFinite(s)||s<1?this.TRIAL_DURATION_HOURS:s}return this.TRIAL_DURATION_HOURS}catch(r){return console.warn("getTrialDurationHours: fallback to default due to error",r),this.TRIAL_DURATION_HOURS}}static async updateTrialDurationHours(r){try{if(!Number.isFinite(r)||r<1)return{success:!1,message:"المدة يجب أن تكون ساعة واحدة على الأقل"};const e=o(T,"config","freeTrial");return await w(e,{durationHours:r,updatedAt:h()},{merge:!0}),{success:!0,message:"تم تحديث مدة التجربة المجانية بنجاح"}}catch(e){return console.error("Error updating trial duration hours:",e),{success:!1,message:"تعذر تحديث مدة التجربة المجانية"}}}static async resetActiveTrialToCurrentDuration(r){var e,i;try{const s=o(T,"users",r),n=await f(s);if(!n.exists())return{success:!1,message:"المستخدم غير موجود"};const t=n.data(),c=!!t.isOnFreeTrial,a=(i=(e=t.freeTrialStartDate)==null?void 0:e.toDate)!=null&&i.call(e)?t.freeTrialStartDate.toDate():t.freeTrialStartDate?new Date(t.freeTrialStartDate):null;if(!c||!a)return{success:!1,message:"لا توجد تجربة نشطة لإعادة ضبطها"};const l=await this.getTrialDurationHours(),d=new Date(a.getTime()+l*60*60*1e3);return await E(s,{freeTrialEndDate:d,updatedAt:h()}),{success:!0,message:`تم ضبط نهاية التجربة إلى ${l} ${l>=3&&l<=10?"ساعات":l===2?"ساعتين":"ساعة"}`}}catch(s){return console.error("Error resetting active trial duration:",s),{success:!1,message:"تعذر إعادة ضبط مدة التجربة"}}}static async cancelActiveFreeTrial(r){try{const e=o(T,"users",r),i=await f(e);return i.exists()?i.data().isOnFreeTrial?(await E(e,{isOnFreeTrial:!1,isActive:!1,approved:!1,freeTrialEndDate:new Date,updatedAt:h()}),{success:!0,message:"تم إلغاء التجربة المجانية وحُوّل الحساب إلى طلب تفعيل"}):{success:!1,message:"لا توجد تجربة مجانية نشطة لهذا المستخدم"}:{success:!1,message:"المستخدم غير موجود"}}catch(e){return console.error("Error cancelling active free trial:",e),{success:!1,message:"تعذر إلغاء التجربة المجانية الآن"}}}}A(O,"TRIAL_DURATION_HOURS",4);export{O as FreeTrialService};
//# sourceMappingURL=freeTrialService-BwabY7bi-CphYVBZa.js.map
