{"version":3,"file":"TopUpPage-D1sGJ46Q.js","sources":["../../src/pages/TopUpPage.tsx"],"sourcesContent":["import React, { useState } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { useToast } from '@/hooks/use-toast';\nimport { auth } from '@/firebase';\n\nconst egyptOperators = [\n  { label: 'Vodafone', value: 'Vodafone' },\n  { label: 'Orange', value: 'Orange' },\n  { label: 'Etisalat', value: 'Etisalat' },\n  { label: 'WE', value: 'WE' },\n];\n\nconst isValidEgyptPhone = (phone: string) => {\n  const digits = phone.replace(/\\D/g, '');\n  return digits.length === 10 || digits.length === 11;\n};\n\nconst TopUpPage: React.FC = () => {\n  const navigate = useNavigate();\n  const { toast } = useToast();\n  const [phone, setPhone] = useState('');\n  const [countryCode, setCountryCode] = useState('EG');\n  const [operator, setOperator] = useState<string>('Vodafone');\n  const [amount, setAmount] = useState<string>('');\n  const [loading, setLoading] = useState(false);\n  const [showConfirm, setShowConfirm] = useState(false);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!isValidEgyptPhone(phone)) {\n      toast({ title: 'رقم غير صالح', description: 'من فضلك أدخل رقم مصري صحيح (10 أو 11 رقم)', variant: 'destructive' });\n      return;\n    }\n    const amt = Number(amount);\n    if (!Number.isFinite(amt) || amt <= 0) {\n      toast({ title: 'قيمة غير صالحة', description: 'من فضلك أدخل مبلغ صحيح بالجنيه المصري', variant: 'destructive' });\n      return;\n    }\n    setShowConfirm(true);\n  };\n\n  const confirmTopup = async () => {\n    setShowConfirm(false);\n    // تقييد استخدام زر الشحن على حساب محدد فقط\n    const allowedEmail = 'alkaptin678678@gmail.com';\n    const userEmail = auth.currentUser?.email?.toLowerCase();\n    if (!userEmail || userEmail !== allowedEmail) {\n      toast({ title: 'قيد الإنشاء', description: 'ميزة الشحن متاحة لهذا الحساب فقط حالياً.' });\n      return;\n    }\n    setLoading(true);\n    try {\n      // إضافة مهلة للطلب لتجنب الانتظار اللانهائي\n      const controller = new AbortController();\n      const timeout = setTimeout(() => controller.abort(), 15000);\n\n      const idToken = await auth.currentUser?.getIdToken();\n      const resp = await fetch('/api/topup', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          ...(idToken ? { Authorization: `Bearer ${idToken}` } : {}),\n        },\n        body: JSON.stringify({\n          phone,\n          countryCode,\n          operator,\n          amount: Number(amount),\n          useLocalAmount: true,\n        }),\n        signal: controller.signal,\n      });\n      clearTimeout(timeout);\n\n      // محاولة قراءة النص أولاً ثم تحويله إلى JSON إن أمكن\n      const rawText = await resp.text();\n      let data: any;\n      try {\n        data = JSON.parse(rawText);\n      } catch {\n        data = { success: false, message: rawText || 'فشل قراءة استجابة الخادم' };\n      }\n\n      if (resp.ok && data?.success) {\n        toast({ title: 'تم الشحن', description: data?.message || 'تم تنفيذ عملية الشحن بنجاح' });\n      } else {\n        toast({ title: 'فشل الشحن', description: data?.message || 'حدث خطأ أثناء طلب الشحن', variant: 'destructive' });\n      }\n    } catch (err: any) {\n      console.error('Topup request error:', err);\n      if (err?.name === 'AbortError') {\n        toast({ title: 'انتهت المهلة', description: 'الخادم لم يستجب في الوقت المحدد. تأكد أن السيرفر يعمل.', variant: 'destructive' });\n      } else {\n        toast({ title: 'خطأ في الاتصال', description: 'تعذر الاتصال بالخادم. حاول لاحقاً.', variant: 'destructive' });\n      }\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen p-4\">\n      <Card className=\"max-w-md mx-auto\">\n        <CardHeader>\n          <CardTitle className=\"text-right\">شحن رصيد الموبايل</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div>\n              <label className=\"block text-right mb-1\">رقم الموبايل</label>\n              <Input\n                value={phone}\n                onChange={(e) => setPhone(e.target.value)}\n                placeholder=\"01XXXXXXXXX\"\n                dir=\"ltr\"\n              />\n              {!isValidEgyptPhone(phone) && phone.length > 0 && (\n                <p className=\"text-xs text-red-600 mt-1 text-right\">رقم غير صالح (10 أو 11 رقم)</p>\n              )}\n            </div>\n\n            <div>\n              <label className=\"block text-right mb-1\">الشركة</label>\n              <Select value={operator} onValueChange={setOperator}>\n                <SelectTrigger className=\"w-full\">\n                  <SelectValue placeholder=\"اختر الشركة\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {egyptOperators.map((op) => (\n                    <SelectItem key={op.value} value={op.value}>{op.label}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <label className=\"block text-right mb-1\">المبلغ بالجنيه (EGP)</label>\n              <Input\n                type=\"number\"\n                inputMode=\"decimal\"\n                value={amount}\n                onChange={(e) => setAmount(e.target.value)}\n                placeholder=\"مثال: 10\"\n                dir=\"ltr\"\n              />\n            </div>\n\n            <div className=\"flex items-center justify-between\">\n              <Button type=\"button\" variant=\"outline\" onClick={() => navigate(-1)}>\n                رجوع\n              </Button>\n              <Button type=\"submit\" disabled={loading}>\n                {loading ? 'جارٍ التنفيذ...' : 'شحن'}\n              </Button>\n            </div>\n          </form>\n        </CardContent>\n      </Card>\n\n      {showConfirm && (\n        <div className=\"fixed inset-0 bg-black/40 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-lg p-4 w-[90%] max-w-md\">\n            <h2 className=\"text-lg font-semibold text-right mb-2\">تأكيد العملية</h2>\n            <p className=\"text-right mb-4\">هتشحن رقم {phone} مبلغ {amount} جنيه — تأكيد؟</p>\n            <div className=\"flex gap-2 justify-end\">\n              <Button variant=\"outline\" onClick={() => setShowConfirm(false)}>إلغاء</Button>\n              <Button onClick={confirmTopup} disabled={loading}>{loading ? 'جارٍ التنفيذ...' : 'تأكيد'}</Button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default TopUpPage;"],"names":["egyptOperators","isValidEgyptPhone","phone","digits","TopUpPage","navigate","useNavigate","toast","useToast","setPhone","useState","countryCode","setCountryCode","operator","setOperator","amount","setAmount","loading","setLoading","showConfirm","setShowConfirm","handleSubmit","e","amt","confirmTopup","allowedEmail","userEmail","_b","_a","auth","controller","timeout","idToken","_c","resp","rawText","data","err","jsxs","Card","jsx","CardHeader","CardTitle","CardContent","Input","Select","SelectTrigger","SelectValue","SelectContent","op","SelectItem","Button"],"mappings":"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"}