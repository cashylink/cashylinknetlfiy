{"version":3,"file":"ShiftProfileDialog-DViQNVlG.js","sources":["../../src/components/ShiftProfileDialog.tsx"],"sourcesContent":["import React, { useEffect, useState } from 'react';\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Button } from '@/components/ui/button';\r\nimport { useShift } from '@/contexts/ShiftContext';\r\nimport { useFirebaseAuth } from '@/contexts/FirebaseAuthContext';\r\nimport { db } from '@/firebase';\r\nimport { doc, getDoc } from 'firebase/firestore';\r\n\r\ninterface Props {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n}\r\n\r\ntype CashierUser = { name: string; username: string; password: string };\r\n\r\nconst ShiftProfileDialog: React.FC<Props> = ({ open, onOpenChange }) => {\r\n  const { shiftUser, endShift, setShiftUser } = useShift();\r\n  const [enteredPassword, setEnteredPassword] = useState('');\r\n  const [error, setError] = useState('');\r\n  const [users, setUsers] = useState<CashierUser[]>([]);\r\n  const { user } = useFirebaseAuth();\r\n\r\n  useEffect(() => {\r\n    (async () => {\r\n      // حاول القراءة من السحابة أولاً لضمان ظهور المستخدمين عبر الموبايل والكمبيوتر، ثم fallback للمحلي\r\n      try {\r\n        if (user?.uid) {\r\n          const ref = doc(db, 'profiles', user.uid, 'cashierUsers', 'list');\r\n          const snap = await getDoc(ref);\r\n          if (snap.exists()) {\r\n            const data = snap.data() as any;\r\n            const cloudUsers: CashierUser[] = Array.isArray(data?.users) ? data.users : [];\r\n            if (cloudUsers && cloudUsers.length > 0) {\r\n              setUsers(cloudUsers);\r\n              return;\r\n            }\r\n          }\r\n        }\r\n      } catch {}\r\n      try {\r\n        const key = `cashierUsers_${user?.uid || 'default'}`;\r\n        let saved = localStorage.getItem(key);\r\n        // دعم المفتاح القديم غير المربوط بالمستخدم إن لم توجد بيانات تحت المفتاح الجديد\r\n        if (!saved) {\r\n          const legacy = localStorage.getItem('cashierUsers');\r\n          if (legacy) saved = legacy;\r\n        }\r\n        setUsers(saved ? JSON.parse(saved) : []);\r\n      } catch {\r\n        setUsers([]);\r\n      }\r\n    })();\r\n  }, [open, user?.uid]);\r\n\r\n  // جلب البيانات مرة واحدة عند فتح النافذة\r\n  useEffect(() => {\r\n    if (!open || !user?.uid) return;\r\n    \r\n    const fetchCashierUsers = async () => {\r\n      try {\r\n        const ref = doc(db, 'profiles', user.uid, 'cashierUsers', 'list');\r\n        const snap = await getDoc(ref);\r\n        if (snap.exists()) {\r\n          const data = snap.data() as any;\r\n          const cloudUsers: CashierUser[] = Array.isArray(data?.users) ? data.users : [];\r\n          if (cloudUsers && cloudUsers.length > 0) {\r\n            setUsers(cloudUsers);\r\n          } else {\r\n             // Fallback to local storage\r\n             loadFromLocal();\r\n          }\r\n        } else {\r\n          loadFromLocal();\r\n        }\r\n      } catch (err) {\r\n        console.warn('ShiftProfileDialog cashierUsers fetch error:', err);\r\n        loadFromLocal();\r\n      }\r\n    };\r\n\r\n    const loadFromLocal = () => {\r\n      try {\r\n        const key = `cashierUsers_${user?.uid || 'default'}`;\r\n        let saved = localStorage.getItem(key);\r\n        if (!saved) {\r\n          const legacy = localStorage.getItem('cashierUsers');\r\n          if (legacy) saved = legacy;\r\n        }\r\n        setUsers(saved ? JSON.parse(saved) : []);\r\n      } catch {\r\n        setUsers([]);\r\n      }\r\n    };\r\n\r\n    fetchCashierUsers();\r\n  }, [open, user?.uid]);\r\n\r\n  const handleEndShift = async () => {\r\n    setError('');\r\n    if (!shiftUser) return;\r\n    const match = users.find(u => u.username === shiftUser.username);\r\n    if (!match) {\r\n      setError('لا يوجد مستخدم مطابق لهذه الوردية');\r\n      return;\r\n    }\r\n    if (enteredPassword.trim() !== match.password) {\r\n      setError('الرقم السري غير صحيح');\r\n      return;\r\n    }\r\n    // إنهاء الوردية والعودة إلى بروفيل المستخدم الرئيسي\r\n    endShift();\r\n    setShiftUser(null);\r\n    setEnteredPassword('');\r\n    onOpenChange(false);\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={(o) => { setEnteredPassword(''); setError(''); onOpenChange(o); }}>\r\n      <DialogContent className=\"sm:max-w-md\">\r\n        <DialogHeader>\r\n          <DialogTitle>بروفيل الوردية</DialogTitle>\r\n        </DialogHeader>\r\n\r\n        {shiftUser ? (\r\n          <div className=\"space-y-3\">\r\n            <div className=\"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50\">\r\n              <div className=\"text-sm font-semibold text-gray-800\">{shiftUser.name}</div>\r\n              <div className=\"text-xs text-gray-600\">{shiftUser.username}</div>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label className=\"block\">أدخل الرقم السري لتسليم الوردية</Label>\r\n              <Input\r\n                type=\"password\"\r\n                value={enteredPassword}\r\n                onChange={(e) => setEnteredPassword(e.target.value)}\r\n                placeholder=\"الرقم السري للمستخدم\"\r\n                dir=\"ltr\"\r\n              />\r\n              {error && (\r\n                <div className=\"text-red-600 text-xs\">{error}</div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        ) : (\r\n          <div className=\"text-sm text-gray-600\">لا يوجد مستخدم وردية نشط حالياً</div>\r\n        )}\r\n\r\n        <DialogFooter className=\"flex justify-between\">\r\n          <Button variant=\"outline\" onClick={() => onOpenChange(false)}>إغلاق</Button>\r\n          <Button onClick={handleEndShift} disabled={!shiftUser}>تسليم الوردية</Button>\r\n        </DialogFooter>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n};\r\n\r\nexport default ShiftProfileDialog;"],"names":["ShiftProfileDialog","open","onOpenChange","shiftUser","endShift","setShiftUser","useShift","enteredPassword","setEnteredPassword","useState","error","setError","users","setUsers","user","useFirebaseAuth","useEffect","ref","doc","db","snap","getDoc","data","cloudUsers","key","saved","legacy","fetchCashierUsers","loadFromLocal","err","handleEndShift","match","u","jsx","Dialog","o","jsxs","DialogContent","DialogHeader","DialogTitle","Label","Input","e","DialogFooter","Button"],"mappings":"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"}