const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-tnWDkOuX.js","./index-Bpuv6Nub.css","./dailyOperationCountService-BuoXgFag.js","./profitService-4r9FqAF7.js"])))=>i.map(i=>d[i]);
var Zh=Object.defineProperty;var zc=r=>{throw TypeError(r)};var Xh=(r,m,o)=>m in r?Zh(r,m,{enumerable:!0,configurable:!0,writable:!0,value:o}):r[m]=o;var Ll=(r,m,o)=>Xh(r,typeof m!="symbol"?m+"":m,o),Fl=(r,m,o)=>m.has(r)||zc("Cannot "+o);var oe=(r,m,o)=>(Fl(r,m,"read from private field"),o?o.call(r):m.get(r)),js=(r,m,o)=>m.has(r)?zc("Cannot add the same private member more than once"):m instanceof WeakSet?m.add(r):m.set(r,o),qt=(r,m,o,f)=>(Fl(r,m,"write to private field"),f?f.call(r,o):m.set(r,o),o),ss=(r,m,o)=>(Fl(r,m,"access private method"),o);import{J as Sa,bo as eu,bp as qc,bq as xa,br as Vl,bs as Nn,bt as Jl,bu as Kl,bv as Vc,bw as tu,bx as Di,by as su,bz as au,bA as Jc,bB as dd,r as i,bC as ru,bD as md,m as hd,n as ud,u as Da,c as da,j as e,W as Ne,X as je,Y as Se,Z as De,B as u,aq as pa,as as An,bE as Ei,au as la,bF as Kc,ac as jn,Q as La,S as Gs,a as xd,w as Ut,ar as ks,I as q,an as pd,aw as gd,ad as bt,bG as Tn,U as Sn,A as nu,R as He,E as Cs,v as yr,aK as xr,y as Ve,i as V,H as oa,s as ft,f as Fr,bH as hr,K as Na,q as Ke,h as Ce,av as me,k as et,$ as fd,z as Fs,bI as iu,aC as Ss,_ as ht,ah as Dn,p as ca,af as _n,aT as Oi,a1 as ve,l as xn,bJ as ur,at as no,O as Wt,bl as Ws,bK as yd,bL as lu,bM as ou,a7 as bd,bN as cu,a2 as du,bO as mu,a6 as hu,bP as uu,bQ as xu,bR as pu,bS as vd,bT as gu,bU as fu,T as br,bV as wd,a0 as Ps,aS as Yc,aY as Nd,bW as yu,ag as bu,bX as pn,F as vu,bY as gn,am as wu,aj as fn,aW as Nu,aX as ju,bi as Hc,M as Qc,aV as yn,bZ as Gc,aQ as Su,b_ as Du}from"./index-tnWDkOuX.js";import{C as Lt,a as ms,b as Bs,d as Bt}from"./card-SlwaggFS.js";import{B as Gt}from"./badge-Cq-GDK1F.js";import{S as Ga,a as Za,b as Xa,c as er,d as ua,C as Cn,e as Ii}from"./select-QKdc2TYn.js";import{L as te}from"./label-_mnIMROJ.js";import{M as Ds,a as _s,P as Cu}from"./MasterPinDialog-CDin1iyv.js";import{W as ja}from"./wallet-MP5ofXFw.js";import{S as jd,a as Iu}from"./star-CXUVfJ8s.js";import{S as Sd}from"./square-pen-CHl7RpbW.js";import{T as ds,P as Zc}from"./progress-BOoGedvV.js";import{P as $a}from"./phone-fkjnGVtI.js";import{A as Dd}from"./arrow-left-BDVMu6ut.js";import{a as Yl,S as Au}from"./separator-Dk6MyxBB.js";import{C as rr}from"./calendar-DYpYXkMW.js";import{C as Ti}from"./chart-column-DoUryAXS.js";import{D as Ht}from"./dollar-sign-bNLkxbzG.js";import{A as Ci,P as Tu}from"./ProfileIcon-DCyirBaq.js";import{C as vr}from"./circle-alert-BbiXZQj6.js";import{C as Pi}from"./circle-x-CAZlwHZs.js";import{C as nr}from"./circle-check-big-DcMEd0KV.js";import{f as Es,P as Pu,C as Cd,a as io,A as ki,b as Xc,I as ku,R as _u,c as Eu,M as Ou}from"./MaintenanceDialog-BLQvmu15.js";import{S as Id}from"./store-i3EEOQHb.js";import{R as Mu,S as Ru}from"./switch-CNGODERG.js";import{a as $u,E as Lu}from"./broadcastService-DGqqg97J.js";import{B as ed,T as Fu}from"./textarea-DK4Tmvmm.js";import{D as Wu,a as Bu,b as Uu,c as zu,d as qu}from"./dropdown-menu-MkPhHRIa.js";import{ProfitService as tr}from"./profitService-4r9FqAF7.js";import{W as Vu}from"./WalletsManagement-B4QYl-Sx.js";import{FreeTrialService as Ju}from"./freeTrialService-BwabY7bi.js";import{P as Ku,w as Yu}from"./walletSelectionPinService-DoL5ZSmj.js";import{C as Hu}from"./crown-Bkdmlc37.js";import"./shield-DSoskD-c.js";import"./whatsappService-D7s14JCG.js";import"./download-DFIibxe-.js";import"./index-CS8iiUxP.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qu=Sa("Award",[["path",{d:"m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526",key:"1yiouv"}],["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const td=Sa("Banknote",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gu=Sa("BookOpen",[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ad=Sa("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _i=Sa("IdCard",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Hl=Sa("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wl=Sa("ListChecks",[["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}],["path",{d:"M13 6h8",key:"15sg57"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 18h8",key:"oe0vm4"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zu=Sa("Notebook",[["path",{d:"M2 6h4",key:"aawbzj"}],["path",{d:"M2 10h4",key:"l0bgd4"}],["path",{d:"M2 14h4",key:"1gsvsf"}],["path",{d:"M2 18h4",key:"1bu2t1"}],["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["path",{d:"M16 2v20",key:"rotuqe"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vn=Sa("Package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["path",{d:"m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7",key:"yx3hmr"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ai=Sa("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]);var Qs,gt,Pn,Ls,pr,Ur,Ra,sr,kn,zr,qr,gr,fr,ar,Vr,At,wn,Ql,Gl,Zl,Xl,eo,to,so,Td,cd,Xu=(cd=class extends eu{constructor(m,o){super();js(this,At);js(this,Qs);js(this,gt);js(this,Pn);js(this,Ls);js(this,pr);js(this,Ur);js(this,Ra);js(this,sr);js(this,kn);js(this,zr);js(this,qr);js(this,gr);js(this,fr);js(this,ar);js(this,Vr,new Set);this.options=o,qt(this,Qs,m),qt(this,sr,null),qt(this,Ra,qc()),this.bindMethods(),this.setOptions(o)}bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(oe(this,gt).addObserver(this),sd(oe(this,gt),this.options)?ss(this,At,wn).call(this):this.updateResult(),ss(this,At,Xl).call(this))}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return ao(oe(this,gt),this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return ao(oe(this,gt),this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,ss(this,At,eo).call(this),ss(this,At,to).call(this),oe(this,gt).removeObserver(this)}setOptions(m){const o=this.options,f=oe(this,gt);if(this.options=oe(this,Qs).defaultQueryOptions(m),this.options.enabled!==void 0&&typeof this.options.enabled!="boolean"&&typeof this.options.enabled!="function"&&typeof xa(this.options.enabled,oe(this,gt))!="boolean")throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");ss(this,At,so).call(this),oe(this,gt).setOptions(this.options),o._defaulted&&!Vl(this.options,o)&&oe(this,Qs).getQueryCache().notify({type:"observerOptionsUpdated",query:oe(this,gt),observer:this});const N=this.hasListeners();N&&ad(oe(this,gt),f,this.options,o)&&ss(this,At,wn).call(this),this.updateResult(),N&&(oe(this,gt)!==f||xa(this.options.enabled,oe(this,gt))!==xa(o.enabled,oe(this,gt))||Nn(this.options.staleTime,oe(this,gt))!==Nn(o.staleTime,oe(this,gt)))&&ss(this,At,Ql).call(this);const S=ss(this,At,Gl).call(this);N&&(oe(this,gt)!==f||xa(this.options.enabled,oe(this,gt))!==xa(o.enabled,oe(this,gt))||S!==oe(this,ar))&&ss(this,At,Zl).call(this,S)}getOptimisticResult(m){const o=oe(this,Qs).getQueryCache().build(oe(this,Qs),m),f=this.createResult(o,m);return tx(this,f)&&(qt(this,Ls,f),qt(this,Ur,this.options),qt(this,pr,oe(this,gt).state)),f}getCurrentResult(){return oe(this,Ls)}trackResult(m,o){return new Proxy(m,{get:(f,N)=>(this.trackProp(N),o==null||o(N),N==="promise"&&(this.trackProp("data"),!this.options.experimental_prefetchInRender&&oe(this,Ra).status==="pending"&&oe(this,Ra).reject(new Error("experimental_prefetchInRender feature flag is not enabled"))),Reflect.get(f,N))})}trackProp(m){oe(this,Vr).add(m)}getCurrentQuery(){return oe(this,gt)}refetch({...m}={}){return this.fetch({...m})}fetchOptimistic(m){const o=oe(this,Qs).defaultQueryOptions(m),f=oe(this,Qs).getQueryCache().build(oe(this,Qs),o);return f.fetch().then(()=>this.createResult(f,o))}fetch(m){return ss(this,At,wn).call(this,{...m,cancelRefetch:m.cancelRefetch??!0}).then(()=>(this.updateResult(),oe(this,Ls)))}createResult(m,o){var ye;const f=oe(this,gt),N=this.options,S=oe(this,Ls),t=oe(this,pr),j=oe(this,Ur),C=m!==f?m.state:oe(this,Pn),{state:$}=m;let k={...$},y=!1,v;if(o._optimisticResults){const se=this.hasListeners(),Fe=!se&&sd(m,o),We=se&&ad(m,f,o,N);(Fe||We)&&(k={...k,...au($.data,m.options)}),o._optimisticResults==="isRestoring"&&(k.fetchStatus="idle")}let{error:_,errorUpdatedAt:G,status:L}=k;v=k.data;let Y=!1;if(o.placeholderData!==void 0&&v===void 0&&L==="pending"){let se;S!=null&&S.isPlaceholderData&&o.placeholderData===(j==null?void 0:j.placeholderData)?(se=S.data,Y=!0):se=typeof o.placeholderData=="function"?o.placeholderData((ye=oe(this,qr))==null?void 0:ye.state.data,oe(this,qr)):o.placeholderData,se!==void 0&&(L="success",v=Jc(S==null?void 0:S.data,se,o),y=!0)}if(o.select&&v!==void 0&&!Y)if(S&&v===(t==null?void 0:t.data)&&o.select===oe(this,kn))v=oe(this,zr);else try{qt(this,kn,o.select),v=o.select(v),v=Jc(S==null?void 0:S.data,v,o),qt(this,zr,v),qt(this,sr,null)}catch(se){qt(this,sr,se)}oe(this,sr)&&(_=oe(this,sr),v=oe(this,zr),G=Date.now(),L="error");const ne=k.fetchStatus==="fetching",ce=L==="pending",M=L==="error",F=ce&&ne,ie=v!==void 0,he={status:L,fetchStatus:k.fetchStatus,isPending:ce,isSuccess:L==="success",isError:M,isInitialLoading:F,isLoading:F,data:v,dataUpdatedAt:k.dataUpdatedAt,error:_,errorUpdatedAt:G,failureCount:k.fetchFailureCount,failureReason:k.fetchFailureReason,errorUpdateCount:k.errorUpdateCount,isFetched:k.dataUpdateCount>0||k.errorUpdateCount>0,isFetchedAfterMount:k.dataUpdateCount>C.dataUpdateCount||k.errorUpdateCount>C.errorUpdateCount,isFetching:ne,isRefetching:ne&&!ce,isLoadingError:M&&!ie,isPaused:k.fetchStatus==="paused",isPlaceholderData:y,isRefetchError:M&&ie,isStale:lo(m,o),refetch:this.refetch,promise:oe(this,Ra),isEnabled:xa(o.enabled,m)!==!1};if(this.options.experimental_prefetchInRender){const se=_e=>{he.status==="error"?_e.reject(he.error):he.data!==void 0&&_e.resolve(he.data)},Fe=()=>{const _e=qt(this,Ra,he.promise=qc());se(_e)},We=oe(this,Ra);switch(We.status){case"pending":m.queryHash===f.queryHash&&se(We);break;case"fulfilled":(he.status==="error"||he.data!==We.value)&&Fe();break;case"rejected":(he.status!=="error"||he.error!==We.reason)&&Fe();break}}return he}updateResult(){const m=oe(this,Ls),o=this.createResult(oe(this,gt),this.options);if(qt(this,pr,oe(this,gt).state),qt(this,Ur,this.options),oe(this,pr).data!==void 0&&qt(this,qr,oe(this,gt)),Vl(o,m))return;qt(this,Ls,o);const f=()=>{if(!m)return!0;const{notifyOnChangeProps:N}=this.options,S=typeof N=="function"?N():N;if(S==="all"||!S&&!oe(this,Vr).size)return!0;const t=new Set(S??oe(this,Vr));return this.options.throwOnError&&t.add("error"),Object.keys(oe(this,Ls)).some(j=>{const R=j;return oe(this,Ls)[R]!==m[R]&&t.has(R)})};ss(this,At,Td).call(this,{listeners:f()})}onQueryUpdate(){this.updateResult(),this.hasListeners()&&ss(this,At,Xl).call(this)}},Qs=new WeakMap,gt=new WeakMap,Pn=new WeakMap,Ls=new WeakMap,pr=new WeakMap,Ur=new WeakMap,Ra=new WeakMap,sr=new WeakMap,kn=new WeakMap,zr=new WeakMap,qr=new WeakMap,gr=new WeakMap,fr=new WeakMap,ar=new WeakMap,Vr=new WeakMap,At=new WeakSet,wn=function(m){ss(this,At,so).call(this);let o=oe(this,gt).fetch(this.options,m);return m!=null&&m.throwOnError||(o=o.catch(Jl)),o},Ql=function(){ss(this,At,eo).call(this);const m=Nn(this.options.staleTime,oe(this,gt));if(Kl||oe(this,Ls).isStale||!Vc(m))return;const f=tu(oe(this,Ls).dataUpdatedAt,m)+1;qt(this,gr,Di.setTimeout(()=>{oe(this,Ls).isStale||this.updateResult()},f))},Gl=function(){return(typeof this.options.refetchInterval=="function"?this.options.refetchInterval(oe(this,gt)):this.options.refetchInterval)??!1},Zl=function(m){ss(this,At,to).call(this),qt(this,ar,m),!(Kl||xa(this.options.enabled,oe(this,gt))===!1||!Vc(oe(this,ar))||oe(this,ar)===0)&&qt(this,fr,Di.setInterval(()=>{(this.options.refetchIntervalInBackground||su.isFocused())&&ss(this,At,wn).call(this)},oe(this,ar)))},Xl=function(){ss(this,At,Ql).call(this),ss(this,At,Zl).call(this,ss(this,At,Gl).call(this))},eo=function(){oe(this,gr)&&(Di.clearTimeout(oe(this,gr)),qt(this,gr,void 0))},to=function(){oe(this,fr)&&(Di.clearInterval(oe(this,fr)),qt(this,fr,void 0))},so=function(){const m=oe(this,Qs).getQueryCache().build(oe(this,Qs),this.options);if(m===oe(this,gt))return;const o=oe(this,gt);qt(this,gt,m),qt(this,Pn,m.state),this.hasListeners()&&(o==null||o.removeObserver(this),m.addObserver(this))},Td=function(m){dd.batch(()=>{m.listeners&&this.listeners.forEach(o=>{o(oe(this,Ls))}),oe(this,Qs).getQueryCache().notify({query:oe(this,gt),type:"observerResultsUpdated"})})},cd);function ex(r,m){return xa(m.enabled,r)!==!1&&r.state.data===void 0&&!(r.state.status==="error"&&m.retryOnMount===!1)}function sd(r,m){return ex(r,m)||r.state.data!==void 0&&ao(r,m,m.refetchOnMount)}function ao(r,m,o){if(xa(m.enabled,r)!==!1&&Nn(m.staleTime,r)!=="static"){const f=typeof o=="function"?o(r):o;return f==="always"||f!==!1&&lo(r,m)}return!1}function ad(r,m,o,f){return(r!==m||xa(f.enabled,r)===!1)&&(!o.suspense||r.state.status!=="error")&&lo(r,o)}function lo(r,m){return xa(m.enabled,r)!==!1&&r.isStaleByTime(Nn(m.staleTime,r))}function tx(r,m){return!Vl(r.getCurrentResult(),m)}var Pd=i.createContext(!1),sx=()=>i.useContext(Pd);Pd.Provider;function ax(){let r=!1;return{clearReset:()=>{r=!1},reset:()=>{r=!0},isReset:()=>r}}var rx=i.createContext(ax()),nx=()=>i.useContext(rx),ix=(r,m)=>{(r.suspense||r.throwOnError||r.experimental_prefetchInRender)&&(m.isReset()||(r.retryOnMount=!1))},lx=r=>{i.useEffect(()=>{r.clearReset()},[r])},ox=({result:r,errorResetBoundary:m,throwOnError:o,query:f,suspense:N})=>r.isError&&!m.isReset()&&!r.isFetching&&f&&(N&&r.data===void 0||ru(o,[r.error,f])),cx=r=>{if(r.suspense){const o=N=>N==="static"?N:Math.max(N??1e3,1e3),f=r.staleTime;r.staleTime=typeof f=="function"?(...N)=>o(f(...N)):o(f),typeof r.gcTime=="number"&&(r.gcTime=Math.max(r.gcTime,1e3))}},dx=(r,m)=>r.isLoading&&r.isFetching&&!m,mx=(r,m)=>(r==null?void 0:r.suspense)&&m.isPending,rd=(r,m,o)=>m.fetchOptimistic(r).catch(()=>{o.clearReset()});function hx(r,m,o){var k,y,v,_,G;const f=sx(),N=nx(),S=md(),t=S.defaultQueryOptions(r);(y=(k=S.getDefaultOptions().queries)==null?void 0:k._experimental_beforeQuery)==null||y.call(k,t),t._optimisticResults=f?"isRestoring":"optimistic",cx(t),ix(t,N),lx(N);const j=!S.getQueryCache().get(t.queryHash),[R]=i.useState(()=>new m(S,t)),C=R.getOptimisticResult(t),$=!f&&r.subscribed!==!1;if(i.useSyncExternalStore(i.useCallback(L=>{const Y=$?R.subscribe(dd.batchCalls(L)):Jl;return R.updateResult(),Y},[R,$]),()=>R.getCurrentResult(),()=>R.getCurrentResult()),i.useEffect(()=>{R.setOptions(t)},[t,R]),mx(t,C))throw rd(t,R,N);if(ox({result:C,errorResetBoundary:N,throwOnError:t.throwOnError,query:S.getQueryCache().get(t.queryHash),suspense:t.suspense}))throw C.error;if((_=(v=S.getDefaultOptions().queries)==null?void 0:v._experimental_afterQuery)==null||_.call(v,t,C),t.experimental_prefetchInRender&&!Kl&&dx(C,f)){const L=j?rd(t,R,N):(G=S.getQueryCache().get(t.queryHash))==null?void 0:G.promise;L==null||L.catch(Jl).finally(()=>{R.updateResult()})}return t.notifyOnChangeProps?C:R.trackResult(C)}function nd(r,m){return hx(r,Xu)}const kd=async(r={})=>{try{return(await hd(ud,"getLastTransactions")(r)).data}catch(m){throw console.error("Error getting last transactions:",m),m.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):m.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+m.message):m.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+m.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(m.message||"خطأ غير معروف"))}},ux=async r=>(await hd(ud,"sendTelegramMessage")(r)).data,xx=Object.freeze(Object.defineProperty({__proto__:null,getLastTransactions:kd,sendTelegramMessage:ux},Symbol.toStringTag,{value:"Module"})),px=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],gx=({isOpen:r,onClose:m,onWalletSelect:o,onEditWallet:f,onDeleteWallet:N})=>{const{user:S}=Da(),[t,j]=i.useState([]),[R,C]=i.useState(!1),[$,k]=i.useState([]),[y,v]=i.useState(!1),{toast:_}=da(),G=async(M,F)=>{const ie=new Date().getMonth(),Te=new Date().getFullYear(),he=F.filter(_e=>{const Qe=new Date(_e.createdAt);return Qe.getMonth()===ie&&Qe.getFullYear()===Te&&(_e.lineId===M||_e.fromWallet===M)}),ye=_e=>{const Qe=_e.type;return _e.txnType==="receive"||Qe==="withdraw"||Qe==="withdrawal"||Qe==="receive"},se=_e=>{const Qe=_e.type;return _e.txnType==="send"||Qe==="send"||Qe==="transfer"},Fe=he.filter(ye).reduce((_e,Qe)=>{const Ge=Qe.withdrawnAmount!==void 0?Qe.withdrawnAmount:Qe.amount;return _e+(Ge||0)},0),We=he.filter(se).reduce((_e,Qe)=>{const Ge=Qe.sentAmount!==void 0?Qe.sentAmount:Qe.amount;return _e+(Ge||0)},0);return{withdrawalUsage:Fe,transferUsage:We}},L=M=>{const F=new Date().toISOString().split("T")[0],ie=M.lastResetDate;if(!ie)return{...M,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:F};const Te=new Date(ie),he=new Date;return Te.getMonth()!==he.getMonth()||Te.getFullYear()!==he.getFullYear()?{...M,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:F}:M};i.useEffect(()=>{if(!(S!=null&&S.uid)||!r)return;(async()=>{v(!0);try{const F=await pa.getByMerchantId(S.uid),ie=await Ei.getByUserId(S.uid),he=(await Promise.all(F.map(async ye=>{const{withdrawalUsage:se,transferUsage:Fe}=await G(ye.id,ie),We=await la.getWalletLimits(ye.id);return{id:ye.id,name:ye.label||"محفظة بدون اسم",phone:ye.msisdn,nationalId:ye.nationalId||"",isDefault:!1,isActive:ye.isActive===!0,monthlyWithdrawalLimit:(We==null?void 0:We.monthlyWithdrawLimit)??ye.withdrawLimit??2e5,monthlyTransferLimit:(We==null?void 0:We.monthlyTransferLimit)??ye.transferLimit??2e5,monthlyWithdrawalUsage:(We==null?void 0:We.monthlyWithdrawUsed)??se??0,monthlyTransferUsage:(We==null?void 0:We.monthlyTransferUsed)??Fe??0,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:ye.walletProvider||""}}))).map(L);j(he)}catch(F){console.error("Error loading wallets:",F),_({title:"فشل جلب بيانات المحافظ",description:"قد تكون المشكلة بسبب الصلاحيات أو الاتصال. سيتم عرض البيانات المحلية إن وُجدت. جرّب تسجيل الدخول مجددًا أو افتح صفحة اختبار المصادقة من القائمة.",variant:"destructive"})}finally{v(!1)}})()},[S==null?void 0:S.uid,r]);const Y=M=>px.find(F=>F.id===M),ne=(M,F)=>F>0?Math.min(M/F*100,100):0,ce=M=>new Intl.NumberFormat("ar-EG").format(M);return e.jsx(Ne,{open:r,onOpenChange:m,children:e.jsxs(je,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(Se,{className:"pb-4",children:[e.jsxs(De,{className:"flex items-center gap-2 text-lg",children:[e.jsx(ja,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(Gt,{variant:"secondary",className:"mr-2",children:[t.length," محفظة"]})]}),e.jsx("div",{className:"flex items-center gap-2 mt-2",children:R?e.jsxs(e.Fragment,{children:[e.jsx(u,{size:"sm",onClick:async()=>{try{if(!(S!=null&&S.uid))return;const M=t.map(F=>pa.update(F.id,{isActive:$.includes(F.id)}));await Promise.all(M),j(F=>F.map(ie=>({...ie,isActive:$.includes(ie.id)}))),C(!1),_({title:"تم تفعيل المحافظ",description:"فقط المحافظ المحددة ستظهر في الاختيار الخارجي"});try{window.dispatchEvent(new CustomEvent("wallets:activation-updated"))}catch{}}catch(M){console.error("Error activating wallets:",M),_({title:"فشل التفعيل",description:"تعذر تفعيل المحافظ المحددة",variant:"destructive"})}},className:"h-7",children:"تفعيل المحافظ"}),e.jsx(u,{variant:"ghost",size:"sm",onClick:()=>{C(!1),k([])},className:"h-7",children:"إلغاء"})]}):e.jsx(u,{variant:"outline",size:"sm",onClick:()=>C(!0),className:"h-7",children:"تحديد المحافظ"})})]}),y?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):t.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ja,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:t.map(M=>{const F=Y(M.walletProvider||"");ne(M.monthlyWithdrawalUsage||0,M.monthlyWithdrawalLimit),ne(M.monthlyTransferUsage||0,M.monthlyTransferLimit);const ie=$.includes(M.id),Te=R?`cursor-pointer transition-shadow border-2 ${ie?"border-blue-500 shadow-lg":"hover:border-blue-300"}`:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300";return e.jsxs(Lt,{className:Te,onClick:()=>{R?k(he=>he.includes(M.id)?he.filter(ye=>ye!==M.id):[...he,M.id]):o(M)},children:[e.jsx(ms,{className:"pb-3",children:e.jsxs(Bs,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(An,{className:"h-4 w-4"}),e.jsx("span",{children:M.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[M.isActive&&e.jsx(Gt,{variant:"default",className:"text-xs",children:"نشطة"}),M.isDefault&&e.jsxs(Gt,{variant:"default",className:"text-xs",children:[e.jsx(jd,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(u,{variant:"ghost",size:"sm",onClick:he=>{he.stopPropagation(),f==null||f(M)},className:"h-7 px-2",children:e.jsx(Sd,{className:"h-4 w-4"})}),e.jsx(u,{variant:"ghost",size:"sm",onClick:he=>{he.stopPropagation(),N==null||N(M.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(ds,{className:"h-4 w-4"})})]})]})}),e.jsxs(Bt,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx($a,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:M.phone})]}),M.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(_i,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:M.nationalId})]}),F&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ad,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:F.name})]})]}),(()=>{const he=M.monthlyWithdrawalLimit,ye=M.monthlyTransferLimit,se=M.monthlyWithdrawalUsage||0,Fe=M.monthlyTransferUsage||0,We=Math.max(he-se,0),_e=Math.max(ye-Fe,0);return e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{className:"text-xs text-gray-600 font-medium text-center",children:["الحدود الشهرية: ",(F==null?void 0:F.name)||M.walletProvider," - ",M.phone]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(se/Math.max(he,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Fe/Math.max(ye,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",ce(We)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",ce(_e)," جنيه"]})]})]})})(),e.jsx(u,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:he=>{he.stopPropagation(),o(M)},children:"عرض التفاصيل الكاملة"})]})]},M.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(u,{onClick:m,variant:"outline",children:[e.jsx(Dd,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},fx=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],yx=({wallet:r,isOpen:m,onClose:o,onBack:f})=>{const{user:N}=Da(),[S,t]=i.useState([]),[j,R]=i.useState(!1),[C,$]=i.useState("month"),{toast:k}=da();if(i.useEffect(()=>{if(!r||!(N!=null&&N.uid)||!m)return;(async()=>{R(!0);try{const nt=(await Ei.getByUserId(N.uid)).filter(ue=>ue.walletId===r.id).sort((ue,Pe)=>new Date(Pe.createdAt).getTime()-new Date(ue.createdAt).getTime());t(nt)}catch(Ie){console.error("Error loading transactions:",Ie),k({title:"فشل جلب معاملات المحفظة",description:"قد تكون المشكلة بسبب صلاحيات Firestore أو الاتصال. تم عرض ما أمكن محليًا. جرّب تسجيل الدخول مجددًا أو صفحة اختبار المصادقة.",variant:"destructive"})}finally{R(!1)}})()},[r,N==null?void 0:N.uid,m]),!r)return null;const y=re=>fx.find(Ie=>Ie.id===re),v=(re,Ie)=>Ie>0?Math.min(re/Ie*100,100):0,_=re=>new Intl.NumberFormat("ar-EG").format(re),G=re=>new Date(re).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),Y=(()=>{const re=new Date;let Ie;switch(C){case"week":Ie=new Date(re.getTime()-7*24*60*60*1e3);break;case"month":Ie=new Date(re.getFullYear(),re.getMonth(),1);break;default:return S}return S.filter(nt=>new Date(nt.createdAt)>=Ie)})(),ne=re=>{const Ie=re.type,nt=re.txnType;return Ie==="withdraw"||Ie==="withdrawal"||Ie==="receive"||nt==="receive"},ce=re=>{const Ie=re.type,nt=re.txnType;return Ie==="send"||Ie==="transfer"||nt==="send"},M=Y.filter(re=>ne(re)&&re.status==="completed").reduce((re,Ie)=>{const nt=Ie.withdrawnAmount!==void 0?Ie.withdrawnAmount:Ie.amount;return re+(nt||0)},0),F=Y.filter(re=>ce(re)&&re.status==="completed").reduce((re,Ie)=>{const nt=Ie.sentAmount!==void 0?Ie.sentAmount:Ie.amount;return re+(nt||0)},0),ie=Y.filter(re=>re.type==="deposit"&&re.status==="completed").reduce((re,Ie)=>re+Ie.amount,0),Te=Y.filter(re=>re.status==="completed"),he=Te.length,ye=Te.reduce((re,Ie)=>{if(ne(Ie)){const nt=Ie.withdrawnAmount??Ie.receivedAmount??Ie.amount??0;return re+Kc(Number(nt)||0,"receive")}if(ce(Ie)){const nt=Ie.sentAmount??Ie.transferredAmount??Ie.amount??0;return re+Kc(Number(nt)||0,"send")}return re},0),se=y(r.walletProvider||""),Fe=v(r.monthlyWithdrawalUsage||0,r.monthlyWithdrawalLimit),We=v(r.monthlyTransferUsage||0,r.monthlyTransferLimit),_e=re=>{switch(re){case"withdrawal":return e.jsx(Ai,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(jn,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx(Ht,{className:"h-4 w-4 text-green-500"});default:return e.jsx(Ci,{className:"h-4 w-4 text-gray-500"})}},Qe=re=>{switch(re){case"completed":return e.jsx(nr,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(La,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(Pi,{className:"h-4 w-4 text-red-500"});default:return e.jsx(vr,{className:"h-4 w-4 text-gray-500"})}},Ge=re=>{switch(re){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},Nt=re=>{switch(re){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(Ne,{open:m,onOpenChange:o,children:e.jsxs(je,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Se,{className:"pb-4",children:e.jsxs(De,{className:"flex items-center gap-2 text-lg",children:[e.jsx(An,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",r.name,r.isDefault&&e.jsxs(Gt,{variant:"default",className:"mr-2",children:[e.jsx(jd,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(Lt,{children:[e.jsx(ms,{children:e.jsxs(Bs,{className:"text-sm flex items-center gap-2",children:[e.jsx(_i,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(Bt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx($a,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:r.phone})]}),r.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(_i,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:r.nationalId})]}),se&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ad,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:se.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",se.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",se.nationalId]})]})]}),r.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(rr,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(r.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs(Lt,{children:[e.jsx(ms,{children:e.jsxs(Bs,{className:"text-sm flex items-center gap-2",children:[e.jsx(Ti,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(Bt,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Ai,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[_(r.monthlyWithdrawalUsage||0)," / ",_(r.monthlyWithdrawalLimit)]})]}),e.jsx(Zc,{value:Fe,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",_(r.monthlyWithdrawalLimit-(r.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(Yl,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(jn,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[_(r.monthlyTransferUsage||0)," / ",_(r.monthlyTransferLimit)]})]}),e.jsx(Zc,{value:We,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",_(r.monthlyTransferLimit-(r.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(Lt,{children:e.jsxs(Bt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Ai,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:_(M)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx(Lt,{children:e.jsxs(Bt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(jn,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:_(F)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx(Lt,{children:e.jsxs(Bt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Ht,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:_(ie)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})}),e.jsx(Lt,{children:e.jsxs(Bt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Ti,{className:"h-5 w-5 text-emerald-600"})}),e.jsx("div",{className:"text-lg font-bold",children:_(ye)}),e.jsx("div",{className:"text-xs text-gray-600",children:"أرباح الفترة"})]})}),e.jsx(Lt,{children:e.jsxs(Bt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Ci,{className:"h-5 w-5 text-purple-600"})}),e.jsx("div",{className:"text-lg font-bold",children:_(he)}),e.jsx("div",{className:"text-xs text-gray-600",children:"عدد العمليات"})]})})]}),e.jsxs(Lt,{children:[e.jsx(ms,{children:e.jsxs(Bs,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Ci,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{size:"sm",variant:C==="week"?"default":"outline",onClick:()=>$("week"),className:"text-xs",children:"أسبوع"}),e.jsx(u,{size:"sm",variant:C==="month"?"default":"outline",onClick:()=>$("month"),className:"text-xs",children:"شهر"}),e.jsx(u,{size:"sm",variant:C==="all"?"default":"outline",onClick:()=>$("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(Bt,{children:j?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):Y.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ci,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:Y.map(re=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[_e(re.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[Ge(re.type)," - ",_(re.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:G(re.createdAt)}),re.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:re.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[Qe(re.status),e.jsx("span",{className:"text-xs",children:Nt(re.status)})]})]},re.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(u,{onClick:f,variant:"outline",children:[e.jsx(Dd,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(u,{onClick:o,variant:"outline",children:"إغلاق"})]})]})})},Bl=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],bx=({isOpen:r,onClose:m,onWalletUpdate:o,initialEditingWallet:f})=>{const{toast:N}=da(),{user:S,userSubscription:t}=Da();(()=>{var ke,ut;const W=((ke=t==null?void 0:t.subscription)==null?void 0:ke.planType)??((ut=t==null?void 0:t.subscription)==null?void 0:ut.plan)??(t==null?void 0:t.planType)??(t==null?void 0:t.plan)??null,be=typeof W=="string"?String(W).trim().toLowerCase():null;return W===Gs.TAHWEELA||be==="tahweela"||be==="تحويله"})();const j=xd(),[R,C]=i.useState([]),[$,k]=i.useState(!1),[y,v]=i.useState(null),[_,G]=i.useState(""),[L,Y]=i.useState(""),[ne,ce]=i.useState(""),[M,F]=i.useState(""),[ie,Te]=i.useState("200000"),[he,ye]=i.useState("200000"),[se,Fe]=i.useState("100000"),[We,_e]=i.useState("60000"),[Qe,Ge]=i.useState(!1),[Nt,re]=i.useState(null),[Ie,nt]=i.useState(!1),[ue,Pe]=i.useState(!1),[Dt,Ft]=i.useState(!1),[Rt,Zt]=i.useState(null),Me=()=>`wallets_${(S==null?void 0:S.uid)||"default"}`;i.useEffect(()=>{f&&(v(f),k(!0),G(f.name||""),Y(f.phone||""),ce(f.nationalId||""),F(f.walletProvider||""),Te((f.monthlyWithdrawalLimit||2e5).toString()),ye((f.monthlyTransferLimit||2e5).toString()),Fe((f.dailyWithdrawalLimit||1e5).toString()),_e((f.dailyTransferLimit||6e4).toString()),Ge(!!f.isDefault))},[f]);const Ye=W=>{const be=new Date,ke=be.getMonth(),ut=be.getFullYear();if(!W.lastResetDate)return{...W,monthlyWithdrawalUsage:W.monthlyWithdrawalUsage||0,monthlyTransferUsage:W.monthlyTransferUsage||0,lastResetDate:be.toISOString().split("T")[0]};const xt=new Date(W.lastResetDate),ns=xt.getMonth(),hs=xt.getFullYear();return ke!==ns||ut!==hs?{...W,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:be.toISOString().split("T")[0]}:W},ct=async(W,be)=>{const ke=new Date().getMonth(),ut=new Date().getFullYear(),xt=be.filter(Ot=>{const st=new Date(Ot.createdAt);return st.getMonth()===ke&&st.getFullYear()===ut&&Ot.lineId===W}),ns=xt.filter(Ot=>Ot.txnType==="receive").reduce((Ot,st)=>Ot+(st.amount||0),0),hs=xt.filter(Ot=>Ot.txnType==="send").reduce((Ot,st)=>Ot+(st.amount||0),0);return{withdrawalUsage:ns,transferUsage:hs}},Re=async(W,be)=>{const ke=new Date,ut=ke.getDate(),xt=ke.getMonth(),ns=ke.getFullYear(),hs=be.filter(Ct=>{const Jt=new Date(Ct.createdAt);return Jt.getDate()===ut&&Jt.getMonth()===xt&&Jt.getFullYear()===ns&&Ct.lineId===W}),Ot=hs.filter(Ct=>Ct.txnType==="receive").reduce((Ct,Jt)=>Ct+(Jt.amount||0),0),st=hs.filter(Ct=>Ct.txnType==="send").reduce((Ct,Jt)=>Ct+(Jt.amount||0),0);return{withdrawalUsage:Ot,transferUsage:st}};i.useEffect(()=>{(async()=>{if(!(S!=null&&S.uid)){console.log("No user authenticated, skipping wallet loading"),nt(!1);return}console.log("Loading wallets for user:",S.uid),nt(!0);try{const{auth:be}=await bt(async()=>{const{auth:st}=await import("./index-tnWDkOuX.js").then(Ct=>Ct.c3);return{auth:st}},__vite__mapDeps([0,1]),import.meta.url);let ke=0;const ut=5;for(;!be.currentUser&&ke<ut;)console.log(`Waiting for auth state... attempt ${ke+1}`),await new Promise(st=>setTimeout(st,1e3)),ke++;if(!be.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",be.currentUser.uid),console.log("Context User:",S.uid),console.log("Fetching wallets from Firebase...");const xt=await pa.getByMerchantId(S.uid);console.log("Fetched wallets:",xt),console.log("Fetching transactions from Firebase...");const ns=await Ei.getByUserId(S.uid);console.log("Fetched transactions:",ns);const Ot=(await Promise.all(xt.map(async st=>{const{withdrawalUsage:Ct,transferUsage:Jt}=await ct(st.id,ns),{withdrawalUsage:Os,transferUsage:is}=await Re(st.id,ns);return{id:st.id,name:st.label||"محفظة بدون اسم",phone:st.msisdn,isDefault:!1,monthlyWithdrawalLimit:st.withdrawLimit||2e5,monthlyTransferLimit:st.transferLimit||2e5,dailyWithdrawalLimit:st.dailyWithdrawLimit||1e5,dailyTransferLimit:st.dailyTransferLimit||6e4,monthlyWithdrawalUsage:Ct,monthlyTransferUsage:Jt,dailyWithdrawalUsage:Os,dailyTransferUsage:is,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:st.defaultTransferCommission!=null?Number(st.defaultTransferCommission):null,defaultWithdrawCommission:st.defaultWithdrawCommission!=null?Number(st.defaultWithdrawCommission):null}}))).map(Ye);C(Ot),console.log("Wallets loaded successfully:",Ot)}catch(be){console.error("Error loading wallets:",be),C([])}finally{nt(!1)}})()},[S==null?void 0:S.uid]);const Xe=()=>{G(""),Y(""),ce(""),F(""),Te("200000"),ye("200000"),Fe("100000"),_e("60000"),Ge(!1),v(null),k(!1)},ee=async()=>{if(!_.trim()||!L.trim()||!M.trim()){N({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(S!=null&&S.uid)){N({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}nt(!0);try{if(y){await pa.update(y.id,{label:_.trim(),msisdn:L.trim(),withdrawLimit:parseInt(ie),transferLimit:parseInt(he),dailyWithdrawLimit:parseInt(se),dailyTransferLimit:parseInt(We)}),await la.setLimits(y.id,{dailyTransferLimit:parseInt(We||"0"),dailyWithdrawLimit:parseInt(se||"0"),monthlyTransferLimit:parseInt(he||"0"),monthlyWithdrawLimit:parseInt(ie||"0")});const W=R.map(be=>be.id===y.id?{...be,name:_.trim(),phone:L.trim(),nationalId:ne.trim(),walletProvider:M,monthlyWithdrawalLimit:parseInt(ie),monthlyTransferLimit:parseInt(he),dailyWithdrawalLimit:parseInt(se),dailyTransferLimit:parseInt(We)}:be);C(W),localStorage.setItem(Me(),JSON.stringify(W)),N({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const W={merchantUserId:S.uid,provider:M,msisdn:L.trim(),label:_.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(ie),transferLimit:parseInt(he),dailyTransferLimit:parseInt(We),dailyWithdrawLimit:parseInt(se),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},be=await pa.create(W);await la.setLimits(be,{dailyTransferLimit:parseInt(We||"0"),dailyWithdrawLimit:parseInt(se||"0"),monthlyTransferLimit:parseInt(he||"0"),monthlyWithdrawLimit:parseInt(ie||"0")});const ke=new Date().toISOString().split("T")[0],ut={id:be,name:_.trim(),phone:L.trim(),nationalId:ne.trim(),walletProvider:M,isDefault:Qe,monthlyWithdrawalLimit:parseInt(ie),monthlyTransferLimit:parseInt(he),dailyWithdrawalLimit:parseInt(se),dailyTransferLimit:parseInt(We),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:ke,defaultTransferCommission:null,defaultWithdrawCommission:null},xt=[...R,ut];C(xt),localStorage.setItem(Me(),JSON.stringify(xt)),N({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}o&&o(),Xe(),k(!1),v(null)}catch(W){console.error("Error saving wallet:",W),N({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{nt(!1)}},U=W=>{v(W),G(W.name),Y(W.phone),ce(W.nationalId||""),F(W.walletProvider||""),Te(W.monthlyWithdrawalLimit.toString()),ye(W.monthlyTransferLimit.toString()),Ge(W.isDefault),k(!0)},Et=async W=>{const be=R.find(ke=>ke.id===W);if(be!=null&&be.isDefault){N({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(S!=null&&S.uid)){N({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}nt(!0);try{await pa.delete(W);const ke=R.filter(ut=>ut.id!==W);C(ke),localStorage.setItem(Me(),JSON.stringify(ke)),o&&o(),N({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(ke){console.error("Error deleting wallet:",ke),N({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{nt(!1)}},kt=W=>{const be=R.map(ke=>({...ke,isDefault:ke.id===W}));C(be),localStorage.setItem(Me(),JSON.stringify(be)),o&&o(),N({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(Ne,{open:r,onOpenChange:m,children:[e.jsxs(je,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(Se,{className:"pb-2",children:e.jsxs(De,{className:"flex items-center gap-1 text-sm",children:[e.jsx(ja,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",R.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(u,{onClick:()=>{Ft(!0)},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(Ut,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(u,{onClick:()=>{m(),j("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(ks,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),($||y)&&e.jsxs(Lt,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx(ms,{className:"pb-1",children:e.jsx(Bs,{className:"text-sm",children:y?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(Bt,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(Ga,{value:M,onValueChange:F,children:[e.jsx(Za,{className:"h-6 text-xs flex-1",children:e.jsx(Xa,{placeholder:"اختر شركة المحفظة"})}),e.jsx(er,{children:Bl.map(W=>e.jsx(ua,{value:W.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:W.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:be=>{be.preventDefault(),be.stopPropagation(),re(W.id)},children:e.jsx(Hl,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},W.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx(q,{value:_,onChange:W=>G(W.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx($a,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{value:L,onChange:W=>Y(W.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx(_i,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{value:ne,onChange:W=>ce(W.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ht,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{type:"number",value:ie,onChange:W=>Te(W.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ht,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{type:"number",value:he,onChange:W=>ye(W.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ai,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx(q,{type:"number",value:se,onChange:W=>Fe(W.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(jn,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx(q,{type:"number",value:We,onChange:W=>_e(W.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:Qe,onChange:W=>Ge(W.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(pd,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(u,{onClick:ee,className:"flex-1 h-6 text-xs",size:"sm",children:y?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(u,{variant:"outline",onClick:Xe,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:R.map(W=>{var be;return e.jsxs(Lt,{className:`${W.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx(ms,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Bs,{className:"text-sm flex items-center gap-1",children:[e.jsx(ja,{className:"h-3 w-3"}),W.name]}),W.isDefault&&e.jsx(Gt,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(Bt,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx($a,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:W.phone})]}),W.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((be=Bl.find(ke=>ke.id===W.walletProvider))==null?void 0:be.name)||W.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.monthlyWithdrawalUsage||0)/W.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.monthlyTransferUsage||0)/W.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(W.monthlyWithdrawalLimit-(W.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(W.monthlyTransferLimit-(W.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.dailyWithdrawalUsage||0)/W.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.dailyTransferUsage||0)/W.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify بين items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(W.dailyWithdrawalLimit-(W.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(W.dailyTransferLimit-(W.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(u,{size:"sm",variant:"outline",onClick:()=>U(W),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(Sd,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!W.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(u,{size:"sm",variant:"outline",onClick:()=>kt(W.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(u,{size:"sm",variant:"destructive",onClick:()=>Et(W.id),className:"h-5 px-1",children:e.jsx(ds,{className:"h-2 w-2"})})]})]})]})]},W.id)})}),R.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),Nt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>re(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(gd,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const W=Bl.find(be=>be.id===Nt);return W?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:W.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:W.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:W.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(Hl,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(Ds,{open:Dt,onOpenChange:Ft,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Ft(!1),Pe(!0)}}),e.jsx(gx,{isOpen:ue,onClose:()=>Pe(!1),onWalletSelect:W=>{Zt(W),Pe(!1)},onEditWallet:W=>{j(`/user/add-wallet?edit=1&id=${W.id}`),Pe(!1)},onDeleteWallet:async W=>{try{if(await pa.delete(W),C(be=>{const ke=be.filter(ut=>ut.id!==W);try{localStorage.setItem(Me(),JSON.stringify(ke))}catch(ut){console.error("Failed to update localStorage wallets after delete:",ut)}return ke}),o)try{await o()}catch(be){console.error("onWalletUpdate callback failed:",be)}}catch(be){console.error("Error deleting wallet:",be)}}}),e.jsx(yx,{wallet:Rt,isOpen:!!Rt,onClose:()=>Zt(null),onBack:()=>{Zt(null),Pe(!0)}})]})},vx=({isOpen:r,onClose:m,transaction:o,onDelete:f})=>{if(!o)return null;const N=C=>{switch(C){case"completed":return e.jsx(nr,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(La,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(Pi,{className:"h-5 w-5 text-red-500"});default:return e.jsx(La,{className:"h-5 w-5 text-gray-500"})}},S=C=>{switch(C){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},t=C=>{switch(C){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},j=()=>{const C=!!o.senderNumber,$=!!o.senderName,k=C?"الرقم المرسل:":$?"الرقم الراسل:":"رقم المحفظة:",y=C?o.senderNumber:$?o.senderName:o.senderPhone,v=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${o.transactionReference||o.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${o.merchantShopName||o.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${t(o.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${o.status==="completed"?"#16a34a":o.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${S(o.status)}
            </span>
          </div>

          ${o!=null&&o.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${o.cashierName}</span>
            </div>
          `:""}
          
          ${o.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${k}</span>
              <span style="color: #1e293b;">${y}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${o.receiverNumber||o.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${Es(o.transferredAmount||o.amount)} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${o.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${Es(o.withdrawnAmountDetailed||o.withdrawnAmount||o.amount)} جنيه</span>
            </div>
          `}
          
          ${o.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${Es(o.commission||0)} جنيه</span>
            </div>
          `:""}
          ${o.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الربح:</span>
              <span style="color: #16a34a; font-weight: 600;">${Es(o.commission||0)} جنيه</span>
            </div>
          `:""}
          ${o!=null&&o.fee&&Number(o.fee)>0?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرسوم:</span>
              <span style="color: #64748b; font-weight: 600;">${Es(o.fee||0)} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${o.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${o.type==="withdraw"?"-":""}${Es(o.amount)} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,_=window.open("","_blank");_&&(_.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${o.transactionReference||o.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${v}
          </body>
        </html>
      `),_.document.close(),_.print())},R=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(f(o.id),m())};return e.jsx(Ne,{open:r,onOpenChange:m,children:e.jsxs(je,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Se,{children:e.jsxs(De,{className:"flex items-center gap-2 text-xl",children:[e.jsx(Tn,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(Lt,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs(ms,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[N(o.status),e.jsx(Gt,{variant:o.status==="completed"?"default":"secondary",className:"text-sm",children:S(o.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[o.type==="withdraw"?"-":"",Es(o.amount)," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",o.transactionReference||o.id]})]})}),e.jsxs(Lt,{children:[e.jsx(ms,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Id,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(Bt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:o.merchantShopName||o.shopName||"غير محدد"})]}),(o==null?void 0:o.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:o.cashierName})]})]})]}),e.jsxs(Lt,{children:[e.jsx(ms,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(An,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(Bt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(Gt,{variant:"outline",className:"bg-blue-100 text-blue-800",children:t(o.type)})]}),o.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const C=!!o.senderNumber,$=!!o.senderName,k=C?"الرقم المرسل:":$?"الرقم الراسل:":"رقم المحفظة:",y=C?o.senderNumber:$?o.senderName:o.senderPhone,v=C?Sn:$a;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:k})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:y})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(nu,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Sn,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:o.receiverNumber||o.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ht,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[Es(o.transferredAmount||o.amount)," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($a,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:o.senderPhone})]}),(o==null?void 0:o.senderName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Sn,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("span",{className:"text-gray-900",children:o.senderName})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ht,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[Es(o.withdrawnAmountDetailed||o.withdrawnAmount||o.amount)," جنيه"]})]})]}),o.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[o.commission," جنيه"]})]}),o.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-green-700",children:"الربح:"}),e.jsxs("span",{className:"text-green-900 font-semibold",children:[o.commission," جنيه"]})]}),(o==null?void 0:o.fee)&&Number(o.fee)>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الرسوم:"}),e.jsxs("span",{className:"text-gray-900 font-semibold",children:[o.fee," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(rr,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:o.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(u,{onClick:j,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx(Pu,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(u,{onClick:R,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(ds,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(u,{onClick:m,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function id({open:r,onOpenChange:m,onSuccess:o,title:f,description:N,currentBalance:S,balanceLabel:t,userId:j}){const[R,C]=i.useState(""),[$,k]=i.useState(S.toString()),[y,v]=i.useState(!1),[_,G]=i.useState(""),[L,Y]=i.useState(!1),ne=async M=>{M.preventDefault(),G(""),Y(!0);try{const F=parseFloat($);if(isNaN(F)||F<0){G("يرجى إدخال مبلغ صحيح"),Y(!1);return}await _s.hasMasterPin(j)?await _s.verifyMasterPin(R,j)?(o(F),m(!1),C(""),k("")):G("الرقم السري غير صحيح"):G("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{G("حدث خطأ أثناء التحقق من الرقم السري")}finally{Y(!1)}},ce=()=>{C(""),k(S.toString()),G(""),m(!1)};return He.useEffect(()=>{r&&k(S.toString())},[S,r]),e.jsx(Ne,{open:r,onOpenChange:ce,children:e.jsxs(je,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Se,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[e.jsx(Ht,{className:"h-5 w-5"}),f]})}),e.jsxs("form",{onSubmit:ne,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:N}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(te,{className:"text-sm font-medium text-gray-700",children:[t," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[S.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx(q,{id:"newAmount",type:"number",step:"0.01",min:"0",value:$,onChange:M=>k(M.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"pin",type:y?"text":"password",value:R,onChange:M=>C(M.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(u,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>v(!y),children:y?e.jsx(Cs,{className:"h-4 w-4"}):e.jsx(Ut,{className:"h-4 w-4"})})]})]}),_&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(vr,{className:"h-4 w-4"}),_]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(u,{type:"button",variant:"outline",onClick:ce,className:"flex-1",children:"إلغاء"}),e.jsx(u,{type:"submit",disabled:L||!R||!$,className:"flex-1",children:L?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(yr,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class In{static getSecretKey(m){return m?`${this.SECRET_KEY_BASE}_${m}`:this.SECRET_KEY_BASE}static setSecretPin(m,o){const f=btoa(m);this.secretCache.set(this.getSecretKey(o),f)}static hasSecretPin(m){return this.secretCache.has(this.getSecretKey(m))}static verifySecretPin(m,o){const f=this.secretCache.get(this.getSecretKey(o));if(!f)return!1;try{return atob(f)===m}catch{return!1}}static clearSecretPin(m){this.secretCache.delete(this.getSecretKey(m))}}Ll(In,"SECRET_KEY_BASE","dashboard_secret_pin"),Ll(In,"secretCache",new Map);function wx({open:r,onOpenChange:m,userId:o}){const[f,N]=i.useState(""),[S,t]=i.useState(""),[j,R]=i.useState(""),[C,$]=i.useState(!1),[k,y]=i.useState(!1),[v,_]=i.useState(!1),[G,L]=i.useState(""),[Y,ne]=i.useState(!1),{toast:ce}=da(),M=In.hasSecretPin(o),F=async Te=>{Te.preventDefault(),L(""),ne(!0);try{if(!S||S.length<4){L("يجب أن يكون الرقم السري 4 أرقام على الأقل"),ne(!1);return}if(S!==j){L("الرقم السري الجديد وتأكيده غير متطابقين"),ne(!1);return}if(M){if(!f){L("يرجى إدخال الرقم السري الحالي"),ne(!1);return}if(!In.verifySecretPin(f,o)){L("الرقم السري الحالي غير صحيح"),ne(!1);return}}In.setSecretPin(S,o),ce({title:M?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:M?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),ie()}catch{L("حدث خطأ أثناء حفظ الرقم السري")}finally{ne(!1)}},ie=()=>{N(""),t(""),R(""),L(""),$(!1),y(!1),_(!1),m(!1)};return e.jsx(Ne,{open:r,onOpenChange:ie,children:e.jsxs(je,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Se,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[e.jsx(pd,{className:"h-5 w-5"}),M?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:F,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:M?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),M&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"currentPin",type:C?"text":"password",autoComplete:"off",value:f,onChange:Te=>N(Te.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(u,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>$(!C),children:C?e.jsx(Cs,{className:"h-4 w-4"}):e.jsx(Ut,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"newPin",type:k?"text":"password",autoComplete:"off",value:S,onChange:Te=>t(Te.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(u,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!k),children:k?e.jsx(Cs,{className:"h-4 w-4"}):e.jsx(Ut,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:v?"text":"password",autoComplete:"off",value:j,onChange:Te=>R(Te.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(u,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>_(!v),children:v?e.jsx(Cs,{className:"h-4 w-4"}):e.jsx(Ut,{className:"h-4 w-4"})})]})]}),G&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(vr,{className:"h-4 w-4"}),G]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(u,{type:"submit",disabled:Y,className:"flex-1",children:[e.jsx(yr,{className:"h-4 w-4 mr-2"}),Y?"جاري الحفظ...":M?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(u,{type:"button",variant:"outline",onClick:ie,disabled:Y,children:"إلغاء"})]})]})]})})}const Ul=new Map;function Nx({open:r,onOpenChange:m,userId:o}){const[f,N]=i.useState(""),[S,t]=i.useState(""),[j,R]=i.useState(""),[C,$]=i.useState(!1),[k,y]=i.useState(!1),[v,_]=i.useState(!1),[G,L]=i.useState(""),[Y,ne]=i.useState(!1),{toast:ce}=da(),M=o?`cash_drawer_pin_${o}`:"cash_drawer_pin",F=()=>Ul.has(M),ie=se=>{const Fe=Ul.get(M);if(!Fe)return!1;try{return atob(Fe)===se}catch{return!1}},Te=se=>{const Fe=btoa(se);Ul.set(M,Fe)},he=async se=>{se.preventDefault(),L(""),ne(!0);try{if(!S||S.length<4){L("يجب أن يكون الرقم السري 4 أرقام على الأقل"),ne(!1);return}if(S!==j){L("الرقم السري الجديد وتأكيده غير متطابقين"),ne(!1);return}if(F()){if(!f){L("يرجى إدخال الرقم السري الحالي لدرج النقدية"),ne(!1);return}if(!ie(f)){L("الرقم السري الحالي لدرج النقدية غير صحيح"),ne(!1);return}}Te(S),ce({title:F()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:F()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),ye()}catch{L("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{ne(!1)}},ye=()=>{N(""),t(""),R(""),L(""),$(!1),y(!1),_(!1),m(!1)};return e.jsx(Ne,{open:r,onOpenChange:ye,children:e.jsxs(je,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Se,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[e.jsx(Ht,{className:"h-5 w-5 text-green-600"}),F()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:he,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:F()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),F()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"currentPin",type:C?"text":"password",autoComplete:"off",value:f,onChange:se=>N(se.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(u,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>$(!C),children:C?e.jsx(Cs,{className:"h-4 w-4"}):e.jsx(Ut,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"newPin",type:k?"text":"password",autoComplete:"off",value:S,onChange:se=>t(se.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(u,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!k),children:k?e.jsx(Cs,{className:"h-4 w-4"}):e.jsx(Ut,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:v?"text":"password",autoComplete:"off",value:j,onChange:se=>R(se.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(u,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>_(!v),children:v?e.jsx(Cs,{className:"h-4 w-4"}):e.jsx(Ut,{className:"h-4 w-4"})})]})]}),G&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(vr,{className:"h-4 w-4"}),G]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(u,{type:"submit",disabled:Y,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(yr,{className:"h-4 w-4 mr-2"}),Y?"جاري الحفظ...":F()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(u,{type:"button",variant:"outline",onClick:ye,disabled:Y,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}const zl=new Map;function jx({open:r,onOpenChange:m,userId:o}){const[f,N]=i.useState(""),[S,t]=i.useState(""),[j,R]=i.useState(""),[C,$]=i.useState(!1),[k,y]=i.useState(!1),[v,_]=i.useState(!1),[G,L]=i.useState(""),[Y,ne]=i.useState(!1),{toast:ce}=da(),M=o?`wallet_total_pin_${o}`:"wallet_total_pin",F=()=>zl.has(M),ie=se=>{const Fe=zl.get(M);if(!Fe)return!1;try{return atob(Fe)===se}catch{return!1}},Te=se=>{const Fe=btoa(se);zl.set(M,Fe)},he=async se=>{se.preventDefault(),L(""),ne(!0);try{if(!S||S.length<4){L("يجب أن يكون الرقم السري 4 أرقام على الأقل"),ne(!1);return}if(S!==j){L("الرقم السري الجديد وتأكيده غير متطابقين"),ne(!1);return}if(F()){if(!f){L("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),ne(!1);return}if(!ie(f)){L("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),ne(!1);return}}Te(S),ce({title:F()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:F()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),ye()}catch{L("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{ne(!1)}},ye=()=>{N(""),t(""),R(""),L(""),$(!1),y(!1),_(!1),m(!1)};return e.jsx(Ne,{open:r,onOpenChange:ye,children:e.jsxs(je,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Se,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[e.jsx(ja,{className:"h-5 w-5 text-blue-600"}),F()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:he,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:F()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),F()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"currentPin",type:C?"text":"password",autoComplete:"off",value:f,onChange:se=>N(se.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(u,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>$(!C),children:C?e.jsx(Cs,{className:"h-4 w-4"}):e.jsx(Ut,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"newPin",type:k?"text":"password",autoComplete:"off",value:S,onChange:se=>t(se.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(u,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!k),children:k?e.jsx(Cs,{className:"h-4 w-4"}):e.jsx(Ut,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:v?"text":"password",autoComplete:"off",value:j,onChange:se=>R(se.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(u,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>_(!v),children:v?e.jsx(Cs,{className:"h-4 w-4"}):e.jsx(Ut,{className:"h-4 w-4"})})]})]}),G&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(vr,{className:"h-4 w-4"}),G]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(u,{type:"submit",disabled:Y,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(yr,{className:"h-4 w-4 mr-2"}),Y?"جاري الحفظ...":F()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(u,{type:"button",variant:"outline",onClick:ye,disabled:Y,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function Sx({open:r,onOpenChange:m,onSuccess:o,title:f,description:N,currentBalance:S,balanceLabel:t,userId:j}){const[R,C]=i.useState(""),[$,k]=i.useState(""),[y,v]=i.useState("add"),[_,G]=i.useState(!1),[L,Y]=i.useState(""),[ne,ce]=i.useState(!1),[M,F]=i.useState(!1);i.useEffect(()=>{let ye=!0;return(async()=>{const se=await _s.hasMasterPin(j);ye&&F(se)})(),()=>{ye=!1}},[j,r]);const ie=async ye=>{ye.preventDefault(),Y(""),ce(!0);try{const se=parseFloat($);if(isNaN(se)||se<=0){Y("يرجى إدخال مبلغ صحيح أكبر من صفر"),ce(!1);return}if(y==="subtract"&&se>S){Y("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),ce(!1);return}if(M)if(await _s.verifyMasterPin(R,j)){const We=y==="add"?se:-se;Te(),o(We)}else Y("الرقم السري غير صحيح");else Y("لم يتم تعيين الرقم السري الرئيسي. يرجى تعيينه من إعدادات البروفيل أولاً")}catch{Y("حدث خطأ أثناء التحقق من الرقم السري")}finally{ce(!1)}},Te=()=>{C(""),k(""),v("add"),Y(""),m(!1)},he=()=>{const ye=parseFloat($)||0;return y==="add"?S+ye:S-ye};return e.jsx(Ne,{open:r,onOpenChange:Te,children:e.jsxs(je,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Se,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[y==="add"?e.jsx(ks,{className:"h-5 w-5 text-green-600"}):e.jsx(xr,{className:"h-5 w-5 text-red-600"}),f]})}),e.jsxs("form",{onSubmit:ie,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:N}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(te,{className:"text-sm font-medium text-gray-700",children:[t," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[S.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(u,{type:"button",variant:y==="add"?"default":"outline",onClick:()=>v("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(ks,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(u,{type:"button",variant:y==="subtract"?"default":"outline",onClick:()=>v("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(xr,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(te,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",y==="add"?"إضافته":"خصمه"]}),e.jsx(q,{id:"amount",type:"number",step:"0.01",min:"0.01",value:$,onChange:ye=>k(ye.target.value),placeholder:`أدخل المبلغ المراد ${y==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),$&&!isNaN(parseFloat($))&&e.jsxs("div",{className:`p-3 rounded-lg ${y==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(te,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${y==="add"?"text-green-700":"text-red-700"}`,children:[he().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"pin",type:_?"text":"password",autoComplete:"off",value:R,onChange:ye=>C(ye.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(u,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>G(!_),children:_?e.jsx(Cs,{className:"h-4 w-4"}):e.jsx(Ut,{className:"h-4 w-4"})})]})]}),L&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(vr,{className:"h-4 w-4"}),L]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(u,{type:"button",variant:"outline",onClick:Te,className:"flex-1",children:"إلغاء"}),e.jsx(u,{type:"submit",disabled:ne||!R||!$,className:`flex-1 ${y==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:ne?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(yr,{className:"h-4 w-4 mr-2"}),y==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}const ld={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_APP_VERSION:"0.0.0",VITE_DEV_MODE:"true",VITE_ENABLE_OFFLINE_PERSISTENCE:"false",VITE_FIREBASE_API_KEY:"AIzaSyA33RTf43u2QE2OsK1RepQHSKrSet9ZI0s",VITE_FIREBASE_APP_ID:"1:483702062341:web:b1ff06ad175cb7ae428b6c",VITE_FIREBASE_AUTH_DOMAIN:"voda-c6abd.firebaseapp.com",VITE_FIREBASE_AUTH_EMULATOR_URL:"http://localhost:9099",VITE_FIREBASE_FIRESTORE_EMULATOR_HOST:"localhost:8080",VITE_FIREBASE_FUNCTIONS_EMULATOR_HOST:"localhost:5001",VITE_FIREBASE_MEASUREMENT_ID:"G-CV6QGH7G7P",VITE_FIREBASE_MESSAGING_SENDER_ID:"483702062341",VITE_FIREBASE_PROJECT_ID:"voda-c6abd",VITE_FIREBASE_STORAGE_BUCKET:"voda-c6abd.appspot.com",VITE_FORCE_HASH_ROUTER:"true",VITE_SHOP_ID:"demo-shop-001",VITE_SHOP_NAME:"محل كاشي لينك التجريبي",VITE_SHOW_ENV_BANNER:"true",VITE_USE_EMULATORS:"false",VITE_USE_FIREBASE_EMULATOR:"false"},Ha=r=>typeof r=="string"&&r.trim().length>0,Dx={getCurrentMonthId(){const r=new Date;return`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`},async getWalletUsage(r){var m;try{if(!Ha(r))return console.error("Error getting wallet usage: invalid walletId",r),null;const o=Ve(V,"walletLimits",r),f=await Na(o);if(f.exists()){const S=f.data();return{walletId:r,used_transfer:S.monthlyTransferUsed??S.used_transfer??0,used_withdraw:S.monthlyWithdrawUsed??S.used_withdraw??0,monthly_limit:S.monthlyLimit??S.monthlyTransferLimit??S.monthlyWithdrawLimit??2e5,last_reset:S.lastMonthlyReset??S.last_reset??null,updatedAt:S.updatedAt||hr.now()}}const N={walletId:r,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:hr.now()};return await oa(o,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,monthlyTransferLimit:2e5,monthlyWithdrawLimit:2e5,lastMonthlyReset:null,updatedAt:ft(),ownerId:(m=Fr.currentUser)==null?void 0:m.uid}),N}catch(o){return console.error("Error getting wallet usage:",o),{walletId:r,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:hr.now()}}},shouldResetLimits(r){const m=new Date,o=m.getDate();if(!r)return o===1;if(o===1){const f=r.toDate(),N=m.getMonth(),S=m.getFullYear();return f.getMonth()!==N||f.getFullYear()!==S}return!1},async autoResetLimitsIfNeeded(r){try{if(!Ha(r))return console.error("خطأ في التصفير التلقائي للحدود: walletId غير صالح",r),!1;typeof import.meta<"u";const m=await this.getWalletUsage(r);return m&&this.shouldResetLimits(m.last_reset)?(console.log(`🔄 تصفير تلقائي للحدود للمحفظة ${r} - اليوم الأول من الشهر`),await this.resetWalletUsage(r)):!1}catch(m){return console.error("خطأ في التصفير التلقائي للحدود:",m),!1}},async resetWalletUsage(r){try{if(!Ha(r))return console.error("خطأ في تصفير استخدام المحفظة: walletId غير صالح",r),!1;const m=Ve(V,"walletLimits",r);return await oa(m,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:ft(),updatedAt:ft()},{merge:!0}),console.log(`🔄 تم تصفير استخدام المحفظة ${r} بنجاح`),!0}catch(m){return console.error("خطأ في تصفير استخدام المحفظة:",m),!1}},async calculateUsageFromTransactions(r){var m,o;try{if(!Ha(r))return console.error("خطأ في حساب الاستخدام من المعاملات: walletId غير صالح",r),{used_transfer:0,used_withdraw:0};const f=Ve(V,"walletLimits",r),N=new Date;let S=hr.fromDate(new Date(N.getFullYear(),N.getMonth(),1));try{const $=await Na(f);S=$.exists()?((m=$.data())==null?void 0:m.lastMonthlyReset)??((o=$.data())==null?void 0:o.last_reset)??S:S}catch{}const t=Ke(Ce(V,"tx"),me("uid","==",r),...S?[me("createdAt",">=",S)]:[]),j=await et(t);let R=0,C=0;return j.forEach($=>{const k=$.data();k.status==="completed"&&(k.type==="transfer"?R+=k.amount:k.type==="withdraw"&&(C+=k.amount))}),{used_transfer:R,used_withdraw:C}}catch(f){return console.error("خطأ في حساب الاستخدام من المعاملات:",f),{used_transfer:0,used_withdraw:0}}},async getWalletUsageWithRefresh(r){var m,o;try{if(!Ha(r))return console.error("خطأ في الحصول على الاستخدام مع التحديث: walletId غير صالح",r),null;typeof import.meta<"u";const f=await this.getWalletUsage(r);if(!f){const S=await this.calculateUsageFromTransactions(r),t=Ve(V,"walletLimits",r);try{await oa(t,{monthlyTransferUsed:S.used_transfer,monthlyWithdrawUsed:S.used_withdraw,updatedAt:ft(),ownerId:(m=Fr.currentUser)==null?void 0:m.uid},{merge:!0})}catch{}return{walletId:r,used_transfer:S.used_transfer,used_withdraw:S.used_withdraw,monthly_limit:2e5,last_reset:null,updatedAt:hr.now()}}const N=await this.calculateUsageFromTransactions(r);if(f.used_transfer!==N.used_transfer||f.used_withdraw!==N.used_withdraw){const S=Ve(V,"walletLimits",r);try{await oa(S,{monthlyTransferUsed:N.used_transfer,monthlyWithdrawUsed:N.used_withdraw,updatedAt:ft(),ownerId:(o=Fr.currentUser)==null?void 0:o.uid},{merge:!0})}catch{}return await this.getWalletUsage(r)}return f}catch(f){return console.error("خطأ في الحصول على الاستخدام مع التحديث:",f),{walletId:r,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:hr.now()}}},calculateRemaining(r){return{remainingTransfer:Math.max(0,r.monthly_limit-r.used_transfer),remainingWithdraw:Math.max(0,r.monthly_limit-r.used_withdraw)}},async canPerformOperation(r,m,o){try{if(!Ha(r))return console.error("Error checking operation limits: invalid walletId",r),{canPerform:!1,message:"walletId غير صالح"};const f=await this.getWalletUsageWithRefresh(r);if(!f)return{canPerform:!1,message:"لا يمكن العثور على بيانات الاستخدام للمحفظة"};const N=this.calculateRemaining(f);return o==="transfer"&&m>N.remainingTransfer?{canPerform:!1,message:`تجاوز حد التحويل المسموح. المتبقي: ${N.remainingTransfer.toLocaleString()} ج.م من أصل ${f.monthly_limit.toLocaleString()} ج.م`,remaining:N.remainingTransfer}:o==="withdraw"&&m>N.remainingWithdraw?{canPerform:!1,message:`تجاوز حد السحب المسموح. المتبقي: ${N.remainingWithdraw.toLocaleString()} ج.م من أصل ${f.monthly_limit.toLocaleString()} ج.م`,remaining:N.remainingWithdraw}:{canPerform:!0}}catch(f){return console.error("Error checking operation limits:",f),{canPerform:!1,message:"خطأ في التحقق من الحدود"}}},async updateUsage(r,m,o){var f;try{if(!Ha(r))throw new Error("walletId غير صالح");const N=await this.getWalletUsageWithRefresh(r);if(!N)throw new Error("لا يمكن العثور على بيانات الاستخدام للمحفظة");const S=await this.canPerformOperation(r,m,o);if(!S.canPerform)throw new Error(S.message||"لا يمكن إجراء العملية");const t=o==="transfer"?N.used_transfer+m:N.used_transfer,j=o==="withdraw"?N.used_withdraw+m:N.used_withdraw,R=Ve(V,"walletLimits",N.walletId);try{await oa(R,{monthlyTransferUsed:t,monthlyWithdrawUsed:j,updatedAt:ft(),ownerId:(f=Fr.currentUser)==null?void 0:f.uid},{merge:!0})}catch{}let C=await this.getWalletUsageWithRefresh(r);return C||(C={walletId:r,used_transfer:t,used_withdraw:j,monthly_limit:N.monthly_limit,last_reset:N.last_reset,updatedAt:hr.now()}),C}catch(N){throw console.error("Error updating wallet usage:",N),N}},async resetWalletUsageManually(r){try{if(!Ha(r))throw new Error("walletId غير صالح");const m=Ve(V,"walletLimits",r),o={walletId:r,used_transfer:0,used_withdraw:0,monthly_limit:0,last_reset:null,updatedAt:new Date};return oa(m,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:ft(),updatedAt:ft()},{merge:!0}).catch(f=>{console.error("خطأ في حفظ تصفير الاستخدام في Firebase:",f)}),console.log(`✅ تم تصفير استخدام المحفظة ${r} بنجاح`),o}catch(m){throw console.error("Error resetting wallet usage:",m),m}},async getAllWalletsUsage(r){try{const o=(await pa.getByMerchantId(r)).map(N=>this.getWalletUsageWithRefresh(N.id));return(await Promise.all(o)).filter(N=>N!==null)}catch(m){return console.error("Error getting all wallets usage:",m),[]}}};function Cx(r){return r?`readBroadcastIds_${r}`:"readBroadcastIds_guest"}function Ix({className:r}){const{user:m,profile:o,isSubscriptionActive:f}=Da(),N=fd(),[S,t]=i.useState([]),[j,R]=i.useState(new Set),[C,$]=i.useState(!1),[k,y]=i.useState(""),[v,_]=i.useState(!1),[G,L]=i.useState(null),[Y,ne]=i.useState("none"),[ce,M]=i.useState(null),[F,ie]=i.useState(!1);i.useRef(new Set),i.useRef(!1);const Te=i.useRef(null),he=i.useRef(null);i.useRef(null);const[ye,se]=i.useState({position:"fixed",top:0,left:0,zIndex:1e4}),Fe=!1,We=i.useMemo(()=>{const ue=["global"];return m!=null&&m.uid&&ue.push(`user:${m.uid}`),o!=null&&o.shopId&&ue.push(`shop:${o.shopId}`),ue},[m==null?void 0:m.uid,o==null?void 0:o.shopId]),_e=Cx(m==null?void 0:m.uid),Qe=i.useMemo(()=>{var Dt;const ue=(Dt=N==null?void 0:N.pathname)==null?void 0:Dt.includes("/user/pending-approval");return!!(m!=null&&m.uid)&&!ue},[m==null?void 0:m.uid,N==null?void 0:N.pathname]);i.useEffect(()=>{try{const ue=localStorage.getItem(_e);if(ue){const Pe=JSON.parse(ue);Array.isArray(Pe)&&R(new Set(Pe.filter(Boolean)))}else R(new Set)}catch(ue){console.warn("Failed to load read ids",ue),R(new Set)}},[_e]),i.useEffect(()=>{if(!Qe){t([]);return}const ue=$u(We,Pe=>{t(Pe)});return()=>ue()},[We,Qe]),i.useEffect(()=>{},[S]),i.useEffect(()=>()=>{Te.current&&clearTimeout(Te.current)},[]);const Ge=S.reduce((ue,Pe)=>ue+(Pe.id&&!j.has(Pe.id)?1:0),0),Nt=ue=>{if(!ue||j.has(ue))return;const Pe=new Set(j);Pe.add(ue),R(Pe);try{localStorage.setItem(_e,JSON.stringify(Array.from(Pe)))}catch{}},re=()=>{const ue=S.map(Dt=>Dt.id).filter(Boolean),Pe=new Set(j);ue.forEach(Dt=>Pe.add(Dt)),R(Pe);try{localStorage.setItem(_e,JSON.stringify(Array.from(Pe)))}catch{}},Ie=(ue,Pe)=>{var Dt;if(ue)try{const Ft=((Dt=Dn)==null?void 0:Dt.isNativePlatform)&&Dn.getPlatform()==="android",Rt=/\.apk(\?|$)/i.test(ue);if(Ft&&Rt){const Zt=`cashy://update?url=${encodeURIComponent(ue)}`;window.location.href=Zt}else window.open(ue,"_blank")}catch{try{window.open(ue,"_blank")}catch{}}Pe&&Nt(Pe)};i.useEffect(()=>{},[F]);const nt=async()=>{if(!(m!=null&&m.uid)){alert("يرجى تسجيل الدخول لإرسال الطلب.");return}const ue=k.trim();if(!ue){alert("يرجى كتابة سبب طلب التحدث.");return}try{_(!0),L(null);const Pe=o!=null&&o.fullName&&o.fullName.trim()?o.fullName.trim():m.email?m.email.split("@")[0]:"مستخدم",Dt=(o==null?void 0:o.phone)||null;await ca(Ce(V,"waiting_list"),{userId:m.uid,name:Pe,phone:Dt,reason:ue,status:"pending",createdAt:ft()}),L("تم إرسال طلبك إلى قائمة الانتظار بنجاح ✅"),y(""),setTimeout(()=>$(!1),900)}catch(Pe){console.error("فشل إرسال طلب قائمة الانتظار:",Pe),alert("حدث خطأ أثناء إرسال الطلب. حاول مرة أخرى.")}finally{_(!1)}};return i.useEffect(()=>{if(!(m!=null&&m.uid)){ne("none");return}let ue=null;try{const Pe=Ke(Ce(V,"waiting_list"),me("userId","==",m.uid));ue=Fs(Pe,Dt=>{const Ft=Dt.docs.map(Me=>({id:Me.id,...Me.data()})).sort((Me,Ye)=>{var Xe,ee,U,Et,kt,W;const ct=((ee=(Xe=Me==null?void 0:Me.createdAt)==null?void 0:Xe.toMillis)==null?void 0:ee.call(Xe))??((U=Me==null?void 0:Me.createdAt)==null?void 0:U.seconds)*1e3??0;return(((kt=(Et=Ye==null?void 0:Ye.createdAt)==null?void 0:Et.toMillis)==null?void 0:kt.call(Et))??((W=Ye==null?void 0:Ye.createdAt)==null?void 0:W.seconds)*1e3??0)-ct});if(Ft.length===0){ne("none");return}const Rt=Ft[0],Zt=(Rt==null?void 0:Rt.contacted)===!0||(Rt==null?void 0:Rt.status)==="contacted";ne(Zt?"contacted":"pending")})}catch(Pe){console.warn("⚠️ فشل الاشتراك في waiting_list للمستخدم:",Pe),ne("none")}return()=>{ue&&ue()}},[m==null?void 0:m.uid]),Qe?e.jsxs("div",{className:`relative inline-flex items-center gap-2 ${r||""}`,ref:he,children:[e.jsxs(Wu,{onOpenChange:ue=>{ue&&Ge>0&&re()},children:[e.jsx(Bu,{asChild:!0,children:e.jsx(u,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:e.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[e.jsx(ed,{className:"h-4 w-4 text-primary"}),Ge>0&&e.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:Ge})]})})}),e.jsxs(Uu,{className:"w-80",align:"end",forceMount:!0,children:[e.jsxs(zu,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"الإشعارات"}),S.length>0&&e.jsxs(u,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:re,children:[e.jsx(nr,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),e.jsx(qu,{}),S.length===0?e.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):e.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:S.map(ue=>{const Pe=ue.id?!j.has(ue.id):!1;return e.jsx("div",{className:`px-2 py-2 rounded-md ${Pe?"bg-primary/5":""}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(ed,{className:`h-4 w-4 ${Pe?"text-primary":"text-muted-foreground"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium",children:ue.title||"إشعار"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:ue.message}),ue.linkUrl&&e.jsxs(u,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>Ie(ue.linkUrl,ue.id),children:["فتح الرابط ",e.jsx(Lu,{className:"h-3 w-3 ml-1"})]})]}),Pe?e.jsx(u,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Nt(ue.id),title:"تمييز كمقروء",children:e.jsx(nr,{className:"h-4 w-4 text-primary"})}):e.jsx(u,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:e.jsx(nr,{className:"h-4 w-4 text-muted-foreground"})})]})},ue.id)})})]})]}),e.jsxs(Ne,{open:C,onOpenChange:$,children:[e.jsx(iu,{asChild:!0,children:e.jsx(u,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full hover:bg-transparent focus:ring-1 focus:ring-primary/60 focus:ring-offset-1",title:"قائمة الانتظار",children:e.jsx(La,{className:`h-4 w-4 ${Y==="pending"?"text-red-600":Y==="contacted"?"text-green-600":"text-muted-foreground"}`})})}),e.jsxs(je,{className:"max-w-md border border-purple-200/50 shadow-xl bg-gradient-to-br from-purple-50 to-blue-50",children:[e.jsxs(Se,{children:[e.jsx(De,{children:"طلب التحدث"}),e.jsx(Ss,{children:"يرجى كتابة سبب طلب التحدث ليصل للإدارة في قسم قائمة الانتظار."})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"سبب الطلب"}),e.jsx(Fu,{value:k,onChange:ue=>y(ue.target.value),placeholder:"اكتب سبب طلب التحدث هنا...",className:"min-h-[120px] text-right"}),G&&e.jsx("div",{className:"text-sm text-green-700 bg-green-50 border border-green-200 rounded-md p-2",children:G})]}),e.jsxs(ht,{children:[e.jsx(u,{variant:"outline",onClick:()=>$(!1),disabled:v,children:"إلغاء"}),e.jsx(u,{onClick:nt,disabled:v,className:"bg-gradient-to-r from-green-600 to-emerald-600 text-white",children:v?"جارٍ الإرسال...":"إرسال"})]})]})]}),Fe]}):null}function Ax({isOpen:r,onClose:m}){const[o,f]=i.useState("0"),[N,S]=i.useState(null),[t,j]=i.useState(null),[R,C]=i.useState(!1),$=M=>{R?(f(M),C(!1)):f(o==="0"?M:o+M)},k=M=>{const F=parseFloat(o);if(N===null)S(F);else if(t){const Te=y(N||0,F,t);f(String(Te)),S(Te)}C(!0),j(M)},y=(M,F,ie)=>{switch(ie){case"+":return M+F;case"-":return M-F;case"×":return M*F;case"÷":return F===0?0:M/F;case"=":return F;default:return F}},v=()=>{const M=parseFloat(o);if(N!==null&&t){const F=y(N,M,t);f(String(F)),S(null),j(null),C(!0)}},_=()=>{f("0"),S(null),j(null),C(!1)},G=()=>{f("0")},L=()=>{R?(f("0."),C(!1)):o.indexOf(".")===-1&&f(o+".")},Y=()=>{o!=="0"&&f(o.charAt(0)==="-"?o.slice(1):"-"+o)},ne=()=>{const M=parseFloat(o);f(String(M/100))},ce=M=>{const F=M.key;M.preventDefault(),F>="0"&&F<="9"?$(F):F==="+"?k("+"):F==="-"?k("-"):F==="*"?k("×"):F==="/"?k("÷"):F==="Enter"||F==="="?v():F==="Escape"||F==="c"||F==="C"?_():F==="Backspace"?G():F==="."?L():F==="%"&&ne()};return i.useEffect(()=>(r?document.addEventListener("keydown",ce):document.removeEventListener("keydown",ce),()=>{document.removeEventListener("keydown",ce)}),[r,o,N,t,R]),e.jsx(Ne,{open:r,onOpenChange:M=>!M&&m(),children:e.jsxs(je,{className:"sm:max-w-md",children:[e.jsx(Se,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[e.jsx(Cd,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:o})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(u,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:_,children:"AC"}),e.jsx(u,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:G,children:"CE"}),e.jsx(u,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:ne,children:"%"}),e.jsx(u,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>k("÷"),children:"÷"}),e.jsx(u,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>$("7"),children:"7"}),e.jsx(u,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>$("8"),children:"8"}),e.jsx(u,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>$("9"),children:"9"}),e.jsx(u,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>k("×"),children:"×"}),e.jsx(u,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>$("4"),children:"4"}),e.jsx(u,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>$("5"),children:"5"}),e.jsx(u,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>$("6"),children:"6"}),e.jsx(u,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>k("-"),children:"-"}),e.jsx(u,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>$("1"),children:"1"}),e.jsx(u,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>$("2"),children:"2"}),e.jsx(u,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>$("3"),children:"3"}),e.jsx(u,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>k("+"),children:"+"}),e.jsx(u,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>$("0"),children:"0"}),e.jsx(u,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:L,children:"."}),e.jsx(u,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:v,children:"="})]}),e.jsx(u,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:Y,children:"+/-"})]})]})})}function Tx({isOpen:r,onClose:m,initialBarcode:o}){const[f,N]=i.useState([]),[S,t]=i.useState({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),[j,R]=i.useState(!1),[C,$]=i.useState(null),{toast:k}=da(),{user:y,profile:v}=Da(),{isShiftActive:_,shiftUser:G}=_n(),{shopId:L}=Oi(),[Y,ne]=i.useState([]),[ce,M]=i.useState({}),[F,ie]=i.useState({}),[Te,he]=i.useState({}),[ye,se]=i.useState(""),[Fe,We]=i.useState(!1),[_e,Qe]=i.useState({}),[Ge,Nt]=i.useState(!1),[re,Ie]=i.useState(!0),[nt,ue]=i.useState(!1),Pe=He.useRef(""),Dt=He.useRef(0),[Ft,Rt]=i.useState(0),[Zt,Me]=i.useState(0),[Ye,ct]=i.useState(!1),[Re,Xe]=i.useState(!0),[ee,U]=i.useState(!1),[Et,kt]=i.useState(!1),[W,be]=i.useState(!0),[ke,ut]=i.useState(!0),[xt,ns]=i.useState({}),[hs,Ot]=i.useState(!1),[st,Ct]=i.useState("التحقق قبل العملية"),[Jt,Os]=i.useState("أدخل الرقم السري الرئيسي للمتابعة"),is=He.useRef(null),Xt=(d,I,O)=>{Ct(d),Os(I),is.current=O,Ot(!0)},[Ca,Us]=i.useState([]),[ga,us]=i.useState(!1),[E,ge]=i.useState(""),[pe,Ee]=i.useState(""),[Be,yt]=i.useState(""),[vt,H]=i.useState(null);i.useEffect(()=>{(async()=>{try{if(!r||!(y!=null&&y.uid))return;const d=await ve.getUserData(y.uid),I=Array.isArray(d==null?void 0:d.customers)?d.customers.map(O=>({id:String(O.id||""),name:String(O.name||""),mobile:O.mobile||void 0})):[];Us(I)}catch{}})()},[r,y==null?void 0:y.uid]);const[fe,Z]=i.useState(!1),[dt,jt]=i.useState(null),[es,xs]=i.useState(null),Zs=(d,I)=>{jt(d),xs(I),Z(!0)},[ra,wr]=i.useState(""),Ms=i.useMemo(()=>{const d=ra.trim().toLowerCase();return d?Y.filter(I=>I.name.toLowerCase().includes(d)):Y},[Y,ra]),Jr=()=>new Date().toISOString().split("T")[0];i.useEffect(()=>{r&&(y!=null&&y.uid)&&(wt(),Re||Kt())},[r,y==null?void 0:y.uid,Re]),i.useEffect(()=>{if(!(!r||!(y!=null&&y.uid)))try{const d=Jr(),I=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date),O=K=>{try{const Ae=K.docs.map(qe=>{const xe=qe.data();return{id:String(xe.clientId||qe.id),productName:String(xe.productName||""),price:Number(xe.sellingPrice||0),wholesalePrice:typeof xe.wholesalePrice=="number"?xe.wholesalePrice:Number(xe.wholesalePrice||0),quantity:Number(xe.quantity||0),date:String(xe.date||d),time:String(xe.time||""),performedByType:xe.performedByType||void 0,performedByName:xe.performedByName||void 0,performedByUsername:xe.performedByUsername||null,serialNumber:xe.serialNumber||void 0,barcode:xe.barcode||void 0,firestoreId:qe.id}}),ze=(f||[]).filter(qe=>!qe.firestoreId),Ue={};[...Ae,...ze].forEach(qe=>{Ue[qe.id]=qe});const Oe=Object.values(Ue);pt(Oe)}catch{}};let X;try{const K=L||(v==null?void 0:v.shopId)||null,Ae=Ke(Ce(V,"dailySales"),me("userId","==",y.uid),...K?[me("shopId","==",K)]:[]);X=Fs(Ae,O,()=>{try{X&&X()}catch{}const ze=Ke(Ce(V,"users",y.uid,"dailySales"),...K?[me("shopId","==",K)]:[]);X=Fs(ze,O)})}catch{const K=L||(v==null?void 0:v.shopId)||null,Ae=Ke(Ce(V,"users",y.uid,"dailySales"),...K?[me("shopId","==",K)]:[]);X=Fs(Ae,O)}return()=>{try{X&&X()}catch{}}}catch{}},[r,y==null?void 0:y.uid]),i.useEffect(()=>{if(!r)return;const d=I=>{const O=Date.now();if(I.key==="Enter"){const X=(Pe.current||"").trim();Pe.current="",X&&Ua(X);return}I.key.length===1&&(O-(Dt.current||0)>100&&(Pe.current=""),Pe.current+=I.key,Dt.current=O)};return window.addEventListener("keydown",d),()=>window.removeEventListener("keydown",d)},[r,Y]),i.useEffect(()=>{r&&o&&Ua(o)},[r,o]);const Ia=async()=>{if(y!=null&&y.uid)try{const d=v==null?void 0:v.shopId;let I,O=[];if(d){const X=Ke(Ce(V,"products"),me("shopId","==",d),me("userId","==",y.uid));if(I=await et(X),O=I.docs.map(K=>({id:K.id,name:String(K.data().name??""),sellingPrice:Number(K.data().sellingPrice??0),wholesalePrice:Number(K.data().wholesalePrice??0),quantity:Number(K.data().quantity??0),barcode:String(K.data().barcode??""),serialNumber:String(K.data().serialNumber??"")})),O.length===0){const K=Ke(Ce(V,"products"),me("userId","==",y.uid)),ze=(await et(K)).docs.map(Ue=>({id:Ue.id,name:String(Ue.data().name??""),sellingPrice:Number(Ue.data().sellingPrice??0),wholesalePrice:Number(Ue.data().wholesalePrice??0),quantity:Number(Ue.data().quantity??0),barcode:String(Ue.data().barcode??""),serialNumber:String(Ue.data().serialNumber??"")}));ze.length>0&&(O=ze,k({title:"تم استرجاع المنتجات",description:"عثرنا على منتجات محفوظة لك خارج المتجر الحالي وقمنا بعرضها."}))}}else{const X=Ke(Ce(V,"products"),me("userId","==",y.uid));I=await et(X),O=I.docs.map(K=>({id:K.id,name:String(K.data().name??""),sellingPrice:Number(K.data().sellingPrice??0),wholesalePrice:Number(K.data().wholesalePrice??0),quantity:Number(K.data().quantity??0),barcode:String(K.data().barcode??""),serialNumber:String(K.data().serialNumber??"")}))}if(ne(O),v!=null&&v.shopId&&O.length>0){const X=O.filter(K=>{const Ae=((I==null?void 0:I.docs)||[]).find(Ue=>Ue.id===K.id);return!(!!Ae&&!!Ae.data().shopId)});if(X.length>0)try{await Promise.all(X.map(K=>Wt(Ve(V,"products",K.id),{shopId:v.shopId,updatedAt:ft()}))),k({title:"تم ترتيب المنتجات",description:"تم ربط بعض المنتجات غير المربوطة بمتجرك الحالي تلقائياً."})}catch(K){console.warn("تعذّر ترحيل shopId لبعض المنتجات:",K)}}}catch(d){console.error("Error loading shop products:",d)}};i.useEffect(()=>{r&&(y!=null&&y.uid)&&(Ia(),Kt(),wt(),it())},[r,y==null?void 0:y.uid,v==null?void 0:v.shopId]);const z=()=>{const d=new Date,I=d.getFullYear(),O=String(d.getMonth()+1).padStart(2,"0"),X=String(d.getDate()).padStart(2,"0");return`${I}-${O}-${X}`},we=d=>{const I=O=>{if(typeof O.createdAtMs=="number")return O.createdAtMs;const X=parseInt(O.id,10);if(!isNaN(X))return X;const K=new Date(O.date);return isNaN(K.getTime())?0:K.getTime()};return[...d].sort((O,X)=>I(X)-I(O))},wt=()=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot load sales data");return}const d=L||(v==null?void 0:v.shopId)||"main",I=`salesData_all_${y.uid}_${d}`,O=localStorage.getItem(I);if(O)try{const qe=JSON.parse(O);N(Array.isArray(qe)?we(qe):[]);return}catch{}const X=z(),K=`salesData_${y.uid}_${d}_${X}`,Ae=localStorage.getItem(K);if(Ae){const qe=JSON.parse(Ae),xe=Array.isArray(qe)?we(qe):[];N(xe);try{localStorage.setItem(I,JSON.stringify(xe))}catch{}return}const ze=new Date().toISOString().split("T")[0],Ue=`salesData_${y.uid}_${d}_${ze}`,Oe=localStorage.getItem(Ue);if(Oe){const qe=JSON.parse(Oe),xe=Array.isArray(qe)?we(qe):[];N(xe);try{localStorage.setItem(K,JSON.stringify(xe)),localStorage.setItem(I,JSON.stringify(xe))}catch{}return}ts()},pt=d=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot save sales data");return}const I=L||(v==null?void 0:v.shopId)||"main",O=z(),X=`salesData_${y.uid}_${I}_${O}`,K=`salesData_all_${y.uid}_${I}`,Ae=we(d);localStorage.setItem(X,JSON.stringify(Ae));try{const ze=localStorage.getItem(K),Ue=ze?JSON.parse(ze):[],Oe={};[...Array.isArray(Ue)?Ue:[],...Ae].forEach(It=>{Oe[It.id]=It});const qe=Object.values(Oe),xe=we(qe);localStorage.setItem(K,JSON.stringify(xe))}catch{}N(Ae)},ps=d=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot save sales data");return}const I=L||(v==null?void 0:v.shopId)||"main",O=`salesData_all_${y.uid}_${I}`;try{const K=localStorage.getItem(O),Ae=K?JSON.parse(K):[],ze={};[...Array.isArray(Ae)?Ae:[],...d].forEach(qe=>{ze[qe.id]=qe});const Ue=Object.values(ze),Oe=we(Ue);localStorage.setItem(O,JSON.stringify(Oe))}catch{}const X=we(d);N(X)},ts=async()=>{if(y!=null&&y.uid)try{const d=L||(v==null?void 0:v.shopId)||null,I=new Date().toISOString().split("T")[0],O=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date);let X,K;try{const qe=Ke(Ce(V,"dailySales"),me("userId","==",y.uid),...d?[me("shopId","==",d)]:[]);X=await et(qe)}catch{}try{const qe=Ke(Ce(V,"users",y.uid,"dailySales"),...d?[me("shopId","==",d)]:[]);K=await et(qe)}catch{}const ze=[...X?X.docs:[],...K?K.docs:[]].map(qe=>{var It,Is;const xe=qe.data();return{id:String(xe.clientId||qe.id),firestoreId:qe.id,productName:String(xe.productName||""),price:Number(xe.sellingPrice||0),wholesalePrice:xe.wholesalePrice!==void 0?Number(xe.wholesalePrice):null,quantity:Number(xe.quantity||0),date:String(xe.date||I),time:String(xe.time||""),serialNumber:xe.serialNumber||void 0,barcode:xe.barcode||void 0,performedByType:xe.performedByType||void 0,performedByName:xe.performedByName||void 0,performedByUsername:xe.performedByUsername||void 0,isDeferred:!!xe.isDeferred,customerName:xe.customerName||void 0,customerMobile:xe.customerMobile||void 0,customerId:xe.customerId||void 0,createdAtMs:(Is=(It=xe==null?void 0:xe.createdAt)==null?void 0:It.toDate)!=null&&Is.call(It)?xe.createdAt.toDate().getTime():new Date(String(xe.date||I)).getTime()}}),Ue={};[...f,...ze].forEach(qe=>{Ue[qe.id]=qe});const Oe=Object.values(Ue);ps(Oe)}catch{}},Kt=async()=>{if(y!=null&&y.uid)try{const d=new Date,I=new Date(d.getFullYear(),d.getMonth(),1),O=new Date(d.getFullYear(),d.getMonth()+1,0),X=xe=>xe.toISOString().split("T")[0],K=X(I),Ae=X(O),ze=L||(v==null?void 0:v.shopId)||null;let Ue;try{const xe=Ke(Ce(V,"dailySales"),me("userId","==",y.uid),...ze?[me("shopId","==",ze)]:[]);Ue=await et(xe)}catch{const xe=Ke(Ce(V,"users",y.uid,"dailySales"),...ze?[me("shopId","==",ze)]:[]);Ue=await et(xe)}let Oe=0,qe=0;Ue.forEach(xe=>{const It=xe.data(),Is=String(It.date??"").slice(0,10);if(!It.isDeferred&&Is>=K&&Is<=Ae){const Xs=Number(It.sellingPrice??0),ma=Number(It.quantity??0),fs=Number(It.profit??(Number(It.sellingPrice??0)-Number(It.wholesalePrice??0))*ma);Oe+=Xs*ma,qe+=fs}}),Rt(Oe),Me(qe)}catch(d){console.error("Error loading monthly stats:",d)}},Wa=async d=>{if(!(y!=null&&y.uid))return null;try{const I=((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0),O=_&&G?"cashier":"admin",X=O==="cashier"?(G==null?void 0:G.name)||"كاشير":(v==null?void 0:v.fullName)||(y==null?void 0:y.displayName)||"الحساب الرئيسي",K=O==="cashier"&&(G==null?void 0:G.username)||null,Ae=await ca(Ce(V,"dailySales"),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit:I,date:d.date,time:d.time,performedByType:O,performedByName:X,performedByUsername:K,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...v!=null&&v.shopId?{shopId:v.shopId}:L?{shopId:L}:{},createdAt:ft()});try{await oa(Ve(V,"users",y.uid,"dailySales",Ae.id),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit:I,date:d.date,time:d.time,performedByType:O,performedByName:X,performedByUsername:K,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...v!=null&&v.shopId?{shopId:v.shopId}:L?{shopId:L}:{},createdAt:ft()})}catch{}return Ae.id}catch{try{const I=await ca(Ce(V,"users",y.uid,"dailySales"),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit,date:d.date,time:d.time,performedByType,performedByName,performedByUsername,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...v!=null&&v.shopId?{shopId:v.shopId}:L?{shopId:L}:{},createdAt:ft()});try{await oa(Ve(V,"dailySales",I.id),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit,date:d.date,time:d.time,performedByType,performedByName,performedByUsername,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...v!=null&&v.shopId?{shopId:v.shopId}:L?{shopId:L}:{},createdAt:ft()})}catch{}return I.id}catch(I){return console.error("Error saving sale:",I),null}}},fa=()=>{const d=L||(v==null?void 0:v.shopId)||"main";return`cashBalance_${(y==null?void 0:y.uid)||"default"}_${d}`},Kr=async(d,I)=>{if(y!=null&&y.uid)try{const O=Ve(V,"dailySales",d);await Wt(O,I)}catch{try{const O=Ve(V,"users",y.uid,"dailySales",d);await Wt(O,I)}catch(O){console.error("Error updating sale:",O)}}},En=async d=>{try{const I=d.firestoreId;if(I)await Kr(I,{isDeferred:!1});else try{const O=Ke(Ce(V,"dailySales"),me("userId","==",(y==null?void 0:y.uid)||""),me("date","==",d.date),me("productName","==",d.productName),xn(5)),K=(await et(O)).docs[0];K&&await Wt(K.ref,{isDeferred:!1})}catch{}N(O=>O.map(X=>X.id===d.id?{...X,isDeferred:!1}:X));try{await Kt()}catch{}k({title:"تم التسديد",description:`تم تسديد أجل ${d.productName}`})}catch(I){console.error("Error marking deferred sale as paid:",I),k({title:"فشل التسديد",description:"تعذّر تحديث حالة البيع المؤجّل",variant:"destructive"})}},it=async()=>{if(!(y!=null&&y.uid))return;const d=f.filter(I=>!I.firestoreId);if(d.length!==0)for(const I of d)try{let O;try{const K=Ke(Ce(V,"dailySales"),me("userId","==",y.uid),me("clientId","==",I.id),xn(1));O=await et(K)}catch{const K=Ke(Ce(V,"users",y.uid,"dailySales"),me("clientId","==",I.id),xn(1));O=await et(K)}if(!O.empty){const K=O.docs[0].id,Ae=f.map(ze=>ze.id===I.id?{...ze,firestoreId:K}:ze);pt(Ae);continue}const X=await Wa(I);if(X){const K=f.map(Ae=>Ae.id===I.id?{...Ae,firestoreId:X}:Ae);pt(K)}}catch{}},at=async d=>{try{if(y!=null&&y.uid)try{const Oe=Ce(V,"deficiencies"),qe=await ca(Oe,{shopId:(v==null?void 0:v.shopId)||y.uid||"default-shop",name:d,quantity:1,status:"pending",createdAt:ft()});try{const xe=`deficiencies_${(v==null?void 0:v.shopId)||(y==null?void 0:y.uid)||"default-shop"}`,It=localStorage.getItem(xe),Is=It?JSON.parse(It):[],Xs=Array.isArray(Is)?Is:[],ma=Xs.some(As=>String((As==null?void 0:As.id)||"")===qe.id),fs={id:qe.id,name:d,quantity:1,status:"pending",createdAt:new Date().toISOString()},Aa=ma?Xs:[...Xs,fs];localStorage.setItem(xe,JSON.stringify(Aa))}catch{}k({title:"تمت الإضافة للنواقص",description:`المنتج ${d} نفد من المخزون وتمت إضافته للنواقص`});return}catch(Oe){console.warn("Failed to add deficiency to Firestore, falling back to local storage:",Oe)}const I=`deficiencies_${(v==null?void 0:v.shopId)||(y==null?void 0:y.uid)||"default-shop"}`,O=localStorage.getItem(I),X=O?JSON.parse(O):[],K=Array.isArray(X)?X:[];if(K.some(Oe=>String((Oe==null?void 0:Oe.name)||"").trim()===d&&String((Oe==null?void 0:Oe.status)||"pending")==="pending"))return;const ze={id:Date.now().toString(),name:d,quantity:1,status:"pending",createdAt:new Date().toISOString()},Ue=[...K,ze];localStorage.setItem(I,JSON.stringify(Ue)),k({title:"تمت الإضافة للنواقص",description:`المنتج ${d} نفد من المخزون وتمت إضافته للنواقص`})}catch(I){console.error("Error adding deficiency for out-of-stock:",I)}},zs=async(d,I=!1,O)=>{const X=ce[d.id]||"",K=parseInt(X);if(isNaN(K)||K<=0){k({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(K>d.quantity){k({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const Ae=new Date,ze=_&&G?"cashier":"admin",Ue=ze==="cashier"?(G==null?void 0:G.name)||"كاشير":(v==null?void 0:v.fullName)||(y==null?void 0:y.displayName)||"الحساب الرئيسي",Oe=ze==="cashier"&&(G==null?void 0:G.username)||null,qe=(d.serialNumber||"").trim(),xe=xt[d.id]||"",It=parseFloat(xe),Is=!isNaN(It)&&It>0?It:d.sellingPrice,Xs={id:Date.now().toString(),productName:d.name,price:Is,wholesalePrice:d.wholesalePrice,quantity:K,date:Ae.toISOString().split("T")[0],time:Ae.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),createdAtMs:Ae.getTime(),performedByType:ze,performedByName:Ue,performedByUsername:Oe,serialNumber:qe||void 0,barcode:d.barcode,isDeferred:I,customerName:O==null?void 0:O.name,customerMobile:O==null?void 0:O.mobile,customerId:O==null?void 0:O.id};try{const ma=await Wa(Xs),fs=ma?{...Xs,firestoreId:ma}:Xs;pt([...f,fs]);const Aa=d.quantity-K;if(await Wt(Ve(V,"products",d.id),{quantity:Aa,updatedAt:ft()}),ne(As=>As.map(Ta=>Ta.id===d.id?{...Ta,quantity:Aa}:Ta)),M(As=>({...As,[d.id]:""})),ns(As=>({...As,[d.id]:""})),Aa===0&&at(d.name),!I)try{const As=Is*K,Ta=fa(),Mn=localStorage.getItem(Ta),Nr=(Mn?parseFloat(Mn):0)+As;localStorage.setItem(Ta,Nr.toString());const jr=`userData_${y==null?void 0:y.uid}`,Rn={cashBalance:Nr,lastUpdated:new Date().toISOString()};localStorage.setItem(jr,JSON.stringify(Rn)),y!=null&&y.uid&&ve.updateUserData(y.uid,Rn).catch(()=>{});const Sr=(v==null?void 0:v.shopId)||L;if(Sr)try{await Wt(Ve(V,"dashboardData",Sr),{cashBalance:Nr})}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:Nr}}))}catch{}try{if(y!=null&&y.uid){const $n=`SALECASH-${y.uid}-${Date.now()}`,Yr={txnType:"cash_addition",type:"cash_addition",amount:As,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:$n,title:"إيصال إضافة نقدية",merchantUserId:y.uid,createdBy:y.uid,shopId:(v==null?void 0:v.shopId)||L||void 0,cashierName:Ue,performedByType:ze,performedByUsername:Oe,createdAt:new Date};await ve.saveUserTransaction(y.uid,Yr)}}catch{}}catch(As){console.warn("تعذر تحديث رصيد الدرج النقدي بعد البيع:",As)}k({title:"تم البيع",description:`تم بيع ${K} قطعة من ${d.name}`})}catch(ma){console.error("Error selling product:",ma),k({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},oo=async d=>{if(y!=null&&y.uid){if(_){k({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف إيصالات البيع أثناء الورديه",variant:"destructive"});return}Xt("تأكيد حذف إيصال بيع","أدخل الرقم السري الرئيسي لحذف الإيصال وعكس الآثار",async()=>{try{if(!d.isDeferred)try{const I=(d.price??0)*(d.quantity??0),O=fa(),X=localStorage.getItem(O),Ae=(X?parseFloat(X):0)-I;localStorage.setItem(O,Ae.toString());const ze=`userData_${y==null?void 0:y.uid}`,Ue={cashBalance:Ae,lastUpdated:new Date().toISOString()};localStorage.setItem(ze,JSON.stringify(Ue)),y!=null&&y.uid&&ve.updateUserData(y.uid,Ue).catch(()=>{});const Oe=(v==null?void 0:v.shopId)||L;if(Oe)try{await Wt(Ve(V,"dashboardData",Oe),{cashBalance:Ae})}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:Ae}}))}catch{}}catch(I){console.warn("تعذر عكس رصيد الدرج النقدي عند حذف الإيصال:",I)}try{const I=Y.find(O=>d.barcode&&O.barcode===d.barcode||O.name===d.productName);if(I){const O=(I.quantity||0)+(d.quantity||0);await Wt(Ve(V,"products",I.id),{quantity:O,updatedAt:ft()}),ne(X=>X.map(K=>K.id===I.id?{...K,quantity:O}:K))}}catch(I){console.warn("تعذر عكس المخزون عند حذف الإيصال:",I)}try{if(d.firestoreId){try{await Ws(Ve(V,"dailySales",d.firestoreId))}catch{}try{await Ws(Ve(V,"users",y.uid,"dailySales",d.firestoreId))}catch{}}else{let I;try{const O=Ke(Ce(V,"dailySales"),me("userId","==",y.uid),me("date","==",d.date),me("productName","==",d.productName),xn(5));I=await et(O)}catch{const O=Ke(Ce(V,"users",y.uid,"dailySales"),me("date","==",d.date),me("productName","==",d.productName),xn(5));I=await et(O)}if(!I.empty){const O=I.docs.find(X=>{const K=X.data();return Number((K==null?void 0:K.sellingPrice)??0)===Number(d.price??0)&&Number((K==null?void 0:K.quantity)??0)===Number(d.quantity??0)&&String((K==null?void 0:K.time)??"")===String(d.time??"")})||I.docs[0];O&&await Ws(O.ref)}}}catch(I){console.warn("تعذر حذف سجل البيع من Firestore:",I)}try{const I=z(),O=`salesData_${y.uid}_${I}`,X=`salesData_all_${y.uid}`,K=f.filter(Oe=>Oe.id!==d.id);localStorage.setItem(O,JSON.stringify(K));const Ae=localStorage.getItem(X),ze=Ae?JSON.parse(Ae):[],Ue=(Array.isArray(ze)?ze:[]).filter(Oe=>(Oe==null?void 0:Oe.id)!==d.id);localStorage.setItem(X,JSON.stringify(Ue)),N(K)}catch(I){console.warn("تعذر تحديث التخزين المحلي بعد الحذف:",I)}try{Re||await Kt()}catch{}k({title:"تم حذف الإيصال",description:`تم حذف إيصال بيع للمنتج ${d.productName} وتم عكس الآثار`})}catch(I){console.error("Error deleting sale:",I),k({title:"فشل حذف الإيصال",description:"تعذّر حذف إيصال البيع",variant:"destructive"})}})}},On=async d=>{try{M(I=>({...I,[d.id]:"1"})),await zs(d)}catch(I){console.error("Error selling by barcode:",I)}},qs=async d=>{if(_){k({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة قطع أثناء الورديه",variant:"destructive"});return}const I=F[d.id]||"",O=parseInt(I);if(isNaN(O)||O<=0){k({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للإضافة",variant:"destructive"});return}Xt("تأكيد إضافة قطع","لا يمكن إضافة قطع إلا بإدخال الرقم السري الرئيسي",async()=>{try{const X=d.quantity+O;await Wt(Ve(V,"products",d.id),{quantity:X,updatedAt:ft()}),ne(K=>K.map(Ae=>Ae.id===d.id?{...Ae,quantity:X}:Ae)),ie(K=>({...K,[d.id]:""})),k({title:"تمت الإضافة",description:`تمت إضافة ${O} قطعة إلى ${d.name}`})}catch(X){console.error("Error adding pieces:",X),k({title:"فشل الإضافة",description:"تعذّر إضافة الكمية إلى المخزون",variant:"destructive"})}})},Ba=async d=>{if(!(y!=null&&y.uid))return;if(_){k({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف المنتجات أثناء الورديه",variant:"destructive"});return}window.confirm(`هل تريد حذف المنتج "${d.name}"؟`)&&Xt("تأكيد حذف منتج","لا يمكن حذف المنتجات إلا بإدخال الرقم السري الرئيسي",async()=>{try{await Ws(Ve(V,"products",d.id)),ne(O=>O.filter(X=>X.id!==d.id)),k({title:"تم الحذف",description:`تم حذف المنتج ${d.name}`})}catch(O){console.error("Error deleting product:",O),k({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}})},gs=async()=>{try{if(!(y!=null&&y.uid)){k({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}if(_){k({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتجات أثناء الورديه",variant:"destructive"});return}const d=S.productName.trim(),I=parseFloat(S.price),O=parseFloat(S.wholesalePrice||"0"),X=parseInt(S.quantity);if(!d||isNaN(I)||isNaN(X)){k({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const K={name:d,sellingPrice:I,wholesalePrice:isNaN(O)?0:O,quantity:isNaN(X)?0:X,userId:y.uid,createdAt:ft(),updatedAt:ft()},Ae=(S.barcode||"").trim();Ae&&(K.barcode=Ae);const ze=(S.serialNumber||"").trim();ze&&(K.serialNumber=ze),v!=null&&v.shopId&&(K.shopId=v.shopId);const Ue=await ca(Ce(V,"products"),K);ne(Oe=>[{id:Ue.id,name:d,sellingPrice:I,wholesalePrice:isNaN(O)?0:O,quantity:isNaN(X)?0:X,barcode:(S.barcode||"").trim()||"",serialNumber:(S.serialNumber||"").trim()||""},...Oe]),t({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),k({title:"تمت الإضافة",description:`تم إضافة المنتج ${d} بنجاح`})}catch(d){console.error("createProduct error",d),k({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}},Ua=async d=>{const I=(d||"").trim();if(!I)return;const O=Y.find(X=>(X.barcode||"")===I);if(!O){k({title:"باركود غير معروف",description:"لم يتم العثور على منتج بهذا الباركود"});return}await On(O)},as=()=>{const d=Object.entries(_e).map(([Oe,qe])=>{const xe=Number(qe),It=Y.find(Is=>Is.id===Oe);return!It||!xe||xe<=0?null:{name:It.name,qty:xe,price:It.sellingPrice,total:xe*It.sellingPrice}}).filter(Boolean);if(d.length===0){k({title:"لم يتم اختيار منتجات",description:"فعّل وضع الفاتورة واختر منتجات وكميات للطباعة"});return}const I=(v==null?void 0:v.shopName)||(y==null?void 0:y.displayName)||"المحل",O=(v==null?void 0:v.phone)||(y==null?void 0:y.phoneNumber)||"",X=d.reduce((Oe,qe)=>Oe+qe.total,0),K=new Date().toLocaleString("ar-EG"),Ae=d.map(Oe=>`
        <tr>
          <td style="border:1px solid #ddd;padding:6px">${Oe.name}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${Oe.qty}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${Vt(Oe.price)}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center;font-weight:bold;color:#0a7">${Vt(Oe.total)}</td>
        </tr>
      `).join(""),ze=`
      <html>
        <head>
          <meta charset="utf-8" />
          <title>فاتورة</title>
          <style>
            body { font-family: Tahoma, Arial, sans-serif; direction: rtl; }
            .header { text-align: center; margin-bottom: 12px; }
            .header h2 { margin: 0; }
            .meta { text-align: center; color: #555; margin-bottom: 8px; }
            table { width: 100%; border-collapse: collapse; }
            .total { text-align: left; font-weight: bold; margin-top: 10px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>${I}</h2>
            ${O?`<div class="meta">رقم التليفون: ${O}</div>`:""}
            <div class="meta">التاريخ: ${K}</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="border:1px solid #ddd;padding:6px">المنتج</th>
                <th style="border:1px solid #ddd;padding:6px">الكمية</th>
                <th style="border:1px solid #ddd;padding:6px">السعر</th>
                <th style="border:1px solid #ddd;padding:6px">الإجمالي</th>
              </tr>
            </thead>
            <tbody>
              ${Ae}
            </tbody>
          </table>
          <div class="total">الإجمالي الكلي: ${Vt(X)}</div>
        </body>
      </html>
    `,Ue=window.open("","_blank");Ue&&(Ue.document.write(ze),Ue.document.close(),Ue.focus(),Ue.print(),Ue.close())};return e.jsxs(Ne,{open:r,onOpenChange:m,children:[e.jsxs(je,{className:"max-w-none w-[100vw] md:w-[100vw] lg:w-[100vw] max-h-[85vh] md:h-[100dvh] md:max-h-[100dvh] p-0 overflow-y-auto",children:[e.jsx(Se,{className:"px-3 md:px-6 py-3 md:py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-blue-100 rounded-lg",children:e.jsx(Ti,{className:"h-5 w-5 md:h-6 md:w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(De,{className:"text-lg md:text-xl font-bold text-gray-800",children:"📊 قسم المبيعات"}),e.jsx("p",{className:"text-xs md:text-sm text-gray-600 mt-1 hidden sm:block",children:"إدارة وتتبع المبيعات"})]})]}),e.jsxs("div",{className:"flex items-center gap-1 md:gap-2",children:[e.jsx(u,{variant:"outline",size:"sm",onClick:()=>it(),className:"text-xs md:text-sm",children:"استرجاع الإيصالات"}),e.jsx(u,{variant:"ghost",size:"sm",onClick:m,className:"h-8 w-8 md:h-9 md:w-9",children:e.jsx(gd,{className:"h-4 w-4"})})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row h-full",dir:"rtl",children:[e.jsxs("div",{className:"w-full md:w-72 lg:w-80 bg-white/50 border-r",children:[e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(Ht,{className:"h-4 w-4 text-green-600"}),"ملخص المبيعات"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:gap-3",children:[e.jsxs("div",{className:"bg-blue-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-blue-600",children:Vt(f.filter(d=>!d.isDeferred).reduce((d,I)=>d+I.price*I.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-blue-600",children:"إجمالي المبيعات"})]}),e.jsxs("div",{className:"relative bg-green-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsxs("div",{className:re?"filter blur-sm pointer-events-none":"",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-green-600",children:Vt(f.filter(d=>!d.isDeferred).reduce((d,I)=>d+(I.price-(I.wholesalePrice??0))*I.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-green-600",children:"إجمالي الأرباح"})]}),re&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(u,{size:"sm",variant:"ghost",onClick:()=>ue(!0),className:"bg-white/80 hover:bg-white text-green-700 border border-green-200",children:"عرض الأرباح"})})]}),e.jsxs("div",{className:"bg-yellow-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-yellow-600",children:Qa(Y.length)}),e.jsx("div",{className:"text-xs md:text-sm text-yellow-600",children:"عدد المنتجات"})]}),e.jsxs("div",{className:"bg-purple-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-purple-600",children:Qa(f.filter(d=>!d.isDeferred).length)}),e.jsx("div",{className:"text-xs md:text-sm text-purple-600",children:"عدد المبيعات"})]})]}),e.jsxs("div",{className:"relative mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1 md:gap-2 text-xs md:text-sm font-semibold text-indigo-700",children:[e.jsx(rr,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx(Ti,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{children:"تقارير الشهر"})]}),e.jsx(u,{size:"sm",variant:"ghost",onClick:()=>U(d=>!d),className:"h-6 w-6 p-0 rounded-full",title:ee?"إظهار التقارير":"إخفاء التقارير",children:ee?e.jsx(Cn,{className:"h-4 w-4"}):e.jsx(Ii,{className:"h-4 w-4"})})]}),e.jsx("div",{className:ee?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]",children:e.jsxs("div",{className:Re?"grid grid-cols-2 gap-2 md:gap-4 filter blur-sm pointer-events-none":"grid grid-cols-2 gap-2 md:gap-4",children:[e.jsxs("div",{className:"bg-indigo-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-indigo-600",children:Vt(Ft)}),e.jsx("div",{className:"text-xs md:text-sm text-indigo-600",children:"مبيعات الشهر"})]}),e.jsxs("div",{className:"bg-pink-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-pink-600",children:Vt(Zt)}),e.jsx("div",{className:"text-xs md:text-sm text-pink-600",children:"أرباح الشهر"})]})]})}),!ee&&Re&&e.jsx("div",{className:"absolute left-0 right-0 top-7 md:top-10 bottom-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(u,{size:"sm",variant:"ghost",onClick:async()=>{try{if(await isZeroPlan()){k({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}ct(!0)},className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all btn-monthly-reports",title:"عرض تقارير الشهر",children:[e.jsx(Ut,{className:"h-5 w-5 md:h-7 md:w-7"}),e.jsx("span",{className:"text-xs md:text-sm",children:"عرض تقارير الشهر"})]})})]})]}),e.jsx("div",{className:"flex justify-end mb-3",children:e.jsxs(u,{size:"sm",variant:"ghost",onClick:()=>kt(!0),className:"h-7 px-3 rounded-full bg-green-50 hover:bg-green-100 text-green-700",title:"إيصالات البيع",children:[e.jsx(Tn,{className:"h-4 w-4 mr-1"}),"إيصالات البيع"]})}),e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(vn,{className:"h-4 w-4 text-indigo-600"}),"إحصائيات المنتجات"]}),e.jsx(u,{size:"sm",variant:"ghost",onClick:()=>be(d=>!d),className:"h-6 w-6 p-0 rounded-full",title:W?"إظهار القسم":"إخفاء القسم",children:W?e.jsx(Cn,{className:"h-4 w-4"}):e.jsx(Ii,{className:"h-4 w-4"})})]}),e.jsx("div",{className:W?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]}),e.jsxs("div",{className:"p-3 md:p-4 flex-1 hidden md:block",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Hl,{className:"h-4 w-4 text-blue-600"}),"نصائح للمبيعات"]}),e.jsx(u,{size:"sm",variant:"ghost",onClick:()=>ut(d=>!d),className:"h-6 w-6 p-0 rounded-full",title:ke?"إظهار القسم":"إخفاء القسم",children:ke?e.jsx(Cn,{className:"h-4 w-4"}):e.jsx(Ii,{className:"h-4 w-4"})})]}),e.jsx("div",{className:ke?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-visible transition-all duration-300 ease-in-out",children:e.jsxs("div",{className:"p-3 md:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-2",children:[e.jsxs("h2",{className:"text-base md:text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Gu,{className:"h-4 w-4 md:h-5 md:w-5 text-blue-600"}),"سجل المبيعات (",f.filter(d=>!d.isDeferred).length," عنصر)"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm text-gray-600",children:[e.jsx(rr,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(La,{className:"h-3 w-3 md:h-4 md:w-4 ml-2"}),e.jsx("span",{children:new Date().toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 md:p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(ks,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج جديد"]}),e.jsxs(u,{size:"sm",variant:"ghost",className:"h-8",onClick:()=>{if(_){k({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتج أثناء الورديه",variant:"destructive"});return}Xt("فتح نموذج إضافة منتج","أدخل الرقم السري الرئيسي لفتح نموذج الإضافة",()=>R(!0))},children:[e.jsx(ks,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج"]})]}),j&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(te,{htmlFor:"new-product-name",className:"text-xs md:text-sm",children:"اسم المنتج"}),e.jsx(q,{id:"new-product-name",value:S.productName,onChange:d=>t(I=>({...I,productName:d.target.value})),placeholder:"أدخل اسم المنتج"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(te,{htmlFor:"new-product-price",className:"text-xs md:text-sm",children:"سعر البيع (ج.م)"}),e.jsx(q,{type:"number",id:"new-product-price",value:S.price,onChange:d=>t(I=>({...I,price:d.target.value})),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(te,{htmlFor:"new-product-wholesale",className:"text-xs md:text-sm",children:"سعر الجملة (ج.م)"}),e.jsx(q,{type:"number",id:"new-product-wholesale",value:S.wholesalePrice||"",onChange:d=>t(I=>({...I,wholesalePrice:d.target.value})),placeholder:"0.00"})]})]}),e.jsxs("div",{children:[e.jsx(te,{htmlFor:"new-product-qty",className:"text-xs md:text-sm",children:"الكمية"}),e.jsx(q,{type:"number",id:"new-product-qty",value:S.quantity,onChange:d=>t(I=>({...I,quantity:d.target.value})),placeholder:"1"})]}),e.jsxs("div",{children:[e.jsx(te,{htmlFor:"new-product-barcode",className:"text-xs md:text-sm",children:"باركود المنتج (اختياري)"}),e.jsx(q,{id:"new-product-barcode",value:S.barcode||"",onChange:d=>t(I=>({...I,barcode:d.target.value})),placeholder:"أدخل/امسح الباركود"})]}),e.jsxs("div",{children:[e.jsx(te,{htmlFor:"new-product-serial",className:"text-xs md:text-sm",children:"سيريال الجهاز (اختياري)"}),e.jsx(q,{id:"new-product-serial",value:S.serialNumber||"",onChange:d=>t(I=>({...I,serialNumber:d.target.value})),placeholder:"أدخل سيريال الجهاز"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(u,{className:"h-9 w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white",onClick:gs,children:"إضافة المنتج"}),e.jsx(u,{variant:"outline",className:"h-9 w-full md:w-auto",onClick:()=>R(!1),children:"إغلاق"})]})]})]}),e.jsx("div",{id:"shop-products-section",className:"bg-white rounded-lg border border-gray-200 overflow-hidden mb-4",children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 mb-2 flex items-center gap-2",children:[e.jsx(vn,{className:"h-4 w-4 text-green-600"}),"منتجات المحل"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(u,{variant:Fe?"default":"outline",size:"sm",onClick:()=>We(d=>!d),children:Fe?"وضع الفاتورة: مفعل":"تفعيل وضع الفاتورة"}),e.jsx(u,{size:"sm",className:"bg-indigo-600 hover:bg-indigo-700 text-white",disabled:Object.keys(_e).filter(d=>(_e[d]||0)>0).length===0,onClick:as,children:"طباعة فاتورة"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(q,{value:ra,onChange:d=>wr(d.target.value),placeholder:"ابحث عن منتج...",className:"h-9 w-full md:w-72 text-sm","aria-label":"البحث عن منتج من منتجات المحل"}),e.jsx(q,{value:ye,onChange:d=>se(d.target.value),onKeyDown:async d=>{if(d.key!=="Enter")return;const I=ye.trim();I&&(await Ua(I),se(""))},placeholder:"مرّر ماسح الباركود هنا (اختياري)",className:"h-9 w-full md:w-64 text-sm","aria-label":"مسح الباركود لإضافة المنتج تلقائياً"}),ra&&e.jsx(u,{variant:"ghost",size:"sm",className:"h-9",onClick:()=>wr(""),children:"مسح"})]}),e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg hidden md:block",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(u,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Nt(d=>!d),"aria-label":Ge?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Ge?e.jsx(Cs,{className:"h-4 w-4"}):e.jsx(Ut,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المتاح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"بيع"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:Ms.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-3 py-3 text-center text-gray-500",children:Y.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"})}):Ms.map(d=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:d.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Vt(d.sellingPrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:e.jsx("span",{className:Ge?"":"blur-sm select-none",children:Vt(d.wholesalePrice)})}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Qa(d.quantity)}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 flex-nowrap",children:[e.jsx(q,{value:ce[d.id]||"",onChange:I=>M(O=>({...O,[d.id]:I.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-8 w-28 text-sm"}),e.jsx(q,{value:xt[d.id]||"",onChange:I=>ns(O=>({...O,[d.id]:I.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-8 w-32 text-sm","aria-label":`سعر بيع اختياري لـ ${d.name}`}),e.jsx(u,{size:"sm",className:"h-8 min-w-[64px] bg-indigo-600 hover:bg-indigo-700 text-white",onClick:()=>zs(d),children:"بيع"}),e.jsx(u,{size:"sm",className:"h-8 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>{H(d),us(!0)},children:"بيع أجل"}),Fe&&e.jsx(q,{value:_e[d.id]??"",onChange:I=>{const O=parseInt(I.target.value||"0");Qe(X=>({...X,[d.id]:isNaN(O)?0:O}))},type:"number",placeholder:"كمية للفاتورة",className:"h-8 w-24 text-sm"}),e.jsx(q,{value:F[d.id]||"",onChange:I=>ie(O=>({...O,[d.id]:I.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-8 w-28 text-sm",disabled:_}),e.jsxs("div",{className:"inline-flex items-center gap-2 flex-nowrap",children:[e.jsx(u,{size:"sm",variant:"outline",className:"h-8 whitespace-nowrap",onClick:()=>qs(d),disabled:_,title:_?"غير مسموح في وضع الكاشير":void 0,children:"إضافة قطع جديدة"}),e.jsx(u,{size:"sm",variant:"destructive",className:"h-8",onClick:()=>Ba(d),title:"حذف المنتج",disabled:_,children:e.jsx(ds,{className:"h-4 w-4"})})]})]})})]},d.id))})]})}),e.jsx("div",{className:"block md:hidden space-y-3",children:Ms.length===0?e.jsx("div",{className:"text-center text-gray-500 text-sm",children:Y.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"}):Ms.map(d=>e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm break-words",children:d.name}),e.jsx(u,{size:"sm",variant:"destructive",className:"h-8 min-w-[44px] touch-manipulation",onClick:()=>Ba(d),title:"حذف المنتج",disabled:_,children:e.jsx(ds,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-700",children:[e.jsx("div",{className:"text-gray-600",children:"سعر البيع"}),e.jsx("div",{className:"text-right font-medium",children:Vt(d.sellingPrice)}),e.jsxs("div",{className:"text-gray-600 inline-flex items-center gap-1",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(u,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>Nt(I=>!I),"aria-label":Ge?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Ge?e.jsx(Cs,{className:"h-4 w-4"}):e.jsx(Ut,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:Ge?"":"blur-sm select-none",children:Vt(d.wholesalePrice)})}),e.jsx("div",{className:"text-gray-600",children:"المتاح"}),e.jsx("div",{className:"text-right font-medium",children:Qa(d.quantity)})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{value:ce[d.id]||"",onChange:I=>M(O=>({...O,[d.id]:I.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للبيع لـ ${d.name}`}),e.jsx(q,{value:xt[d.id]||"",onChange:I=>ns(O=>({...O,[d.id]:I.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-9 w-28 text-sm","aria-label":`سعر بيع اختياري لـ ${d.name}`}),e.jsx(u,{size:"sm",className:"h-9 min-w-[64px] bg-indigo-600 hover:bg-indigo-700 text-white",onClick:()=>zs(d),children:"بيع"}),e.jsx(u,{size:"sm",className:"h-9 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>{H(d),us(!0)},children:"بيع أجل"})]}),Fe&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(q,{value:_e[d.id]??"",onChange:I=>{const O=parseInt(I.target.value||"0");Qe(X=>({...X,[d.id]:isNaN(O)?0:O}))},type:"number",placeholder:"كمية للفاتورة",className:"h-9 flex-1 text-sm","aria-label":`كمية للفاتورة لـ ${d.name}`})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{value:F[d.id]||"",onChange:I=>ie(O=>({...O,[d.id]:I.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للإضافة لـ ${d.name}`,disabled:_}),e.jsx(u,{size:"sm",variant:"outline",className:"h-9 min-w-[64px]",onClick:()=>qs(d),disabled:_,title:_?"غير مسموح في وضع الكاشير":void 0,children:"إضافة"})]})]})]},d.id))})]})}),f.length===0?e.jsxs("div",{className:"text-center py-8 md:py-12",children:[e.jsx("div",{className:"w-16 h-16 md:w-24 md:h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx(vn,{className:"h-8 w-8 md:h-12 md:w-12 text-gray-400"})}),e.jsx("h3",{className:"text-base md:text-lg font-medium text-gray-900 mb-2",children:"لا توجد مبيعات اليوم"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ابدأ ببيع منتج من القائمة أعلاه"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"block md:hidden",children:e.jsx("div",{className:"max-h-[70vh] overflow-y-auto space-y-3 p-3",children:f.map(d=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-200 shadow-sm",children:[e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-base break-words",children:d.productName}),d.isDeferred&&e.jsx("span",{className:"px-2 py-0.5 rounded bg-amber-100 text-amber-700 text-[11px]",children:"مؤجّل"})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ht,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر البيع"})]}),e.jsx("div",{className:"text-right font-medium",children:Vt(d.price)}),typeof d.wholesalePrice=="number"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ht,{className:"h-4 w-4 text-indigo-600"}),e.jsxs("span",{className:"text-gray-600 inline-flex items-center gap-1",children:["سعر الجملة",e.jsx(u,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>Nt(I=>!I),"aria-label":Ge?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Ge?e.jsx(Cs,{className:"h-4 w-4"}):e.jsx(Ut,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:Ge?"":"blur-sm select-none",children:Vt(d.wholesalePrice)})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(vn,{className:"h-4 w-4 text-emerald-600"}),e.jsx("span",{className:"text-gray-600",children:"الكمية"})]}),e.jsx("div",{className:"text-right font-medium",children:Qa(d.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(jn,{className:"h-4 w-4 text-indigo-600"}),e.jsx("span",{className:"text-gray-600",children:"الربح"})]}),e.jsx("div",{className:"text-right font-semibold text-indigo-600",children:e.jsx("span",{className:Ge?"":"blur-sm select-none",children:Vt(((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0))})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ht,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"الإجمالي"})]}),e.jsx("div",{className:"text-right font-bold text-green-700",children:Vt(d.price*d.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qu,{className:"h-4 w-4 text-amber-600"}),e.jsx("span",{className:"text-gray-600",children:"المنفذ"})]}),e.jsx("div",{className:"text-right text-gray-700",children:d.performedByName??"-"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(rr,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"التاريخ"})]}),e.jsx("div",{className:"text-right text-gray-600",children:ql(d.date)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(La,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"الوقت"})]}),e.jsx("div",{className:"text-right text-gray-600",children:d.time})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[d.isDeferred&&e.jsx(u,{size:"sm",className:"h-8 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>En(d),title:"تم التسديد",children:"تم التسديد"}),e.jsx(u,{size:"sm",variant:"outline",onClick:()=>Zs(d,"return"),disabled:_,title:_?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsxs(u,{size:"sm",variant:"destructive",onClick:()=>Zs(d,"delete"),disabled:_,title:_?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:[e.jsx(ds,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-1",children:"حذف الإيصال"})]})]})]},d.id))})}),e.jsx("div",{className:"hidden md:block overflow-x-auto max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-green-300 scrollbar-track-green-100 hover:scrollbar-thumb-green-400",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر البيع (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة (ج.م)"}),e.jsx(u,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Nt(d=>!d),"aria-label":Ge?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Ge?e.jsx(Cs,{className:"h-4 w-4"}):e.jsx(Ut,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الإجمالي (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الربح (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الوقت"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنفذ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"إجراءات"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:f.map((d,I)=>e.jsxs("tr",{className:I%2===0?"bg-white":"bg-gray-50/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:e.jsxs("div",{className:"flex items-center gap-2 justify-end md:justify-start",children:[e.jsx("span",{children:d.productName}),d.isDeferred&&e.jsx("span",{className:"px-2 py-0.5 rounded bg-amber-100 text-amber-700 text-xs",children:"مؤجّل"})]})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Vt(d.price)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:typeof d.wholesalePrice=="number"?e.jsx("span",{className:Ge?"":"blur-sm select-none",children:Vt(d.wholesalePrice)}):"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Qa(d.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-green-600",children:Vt(d.price*d.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-indigo-600",children:e.jsx("span",{className:Ge?"":"blur-sm select-none",children:Vt(((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0))})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:ql(d.date)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:d.time}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:d.performedByName??"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[d.isDeferred&&e.jsx(u,{size:"sm",className:"h-8 min-w-[64px] bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>En(d),title:"تم التسديد",children:"تم التسديد"}),e.jsx(u,{size:"sm",variant:"outline",onClick:()=>Zs(d,"return"),disabled:_,title:_?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsx(u,{size:"sm",variant:"destructive",onClick:()=>Zs(d,"delete"),disabled:_,title:_?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:e.jsx(ds,{className:"h-4 w-4"})})]})})]},d.id))})]})})]})]})})]})]}),e.jsx(Ne,{open:ga,onOpenChange:us,children:e.jsxs(je,{className:"max-w-sm mx-auto bg-white border border-gray-200 shadow-2xl rounded-2xl sm:max-w-md",children:[e.jsx(Se,{className:"text-center",children:e.jsx(De,{className:"text-base md:text-lg font-bold text-gray-900",children:"بيع أجل"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsx(te,{className:"text-sm",children:"اختيار عميل (اختياري)"}),e.jsxs("select",{className:"h-9 border rounded px-2 text-sm",value:E,onChange:d=>{const I=d.target.value;ge(I);const O=Ca.find(X=>X.id===I);O&&(Ee(O.name),yt(O.mobile||""))},children:[e.jsx("option",{value:"",children:"-- بدون اختيار --"}),Ca.map(d=>e.jsxs("option",{value:d.id,children:[d.name,d.mobile?` - ${d.mobile}`:""]},d.id))]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsx(te,{className:"text-sm",children:"اسم العميل"}),e.jsx(q,{value:pe,onChange:d=>Ee(d.target.value),placeholder:"اسم العميل",className:"h-9 text-sm"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsx(te,{className:"text-sm",children:"رقم التليفون (اختياري)"}),e.jsx(q,{value:Be,onChange:d=>yt(d.target.value),placeholder:"رقم التليفون",className:"h-9 text-sm"})]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-3 mt-3",children:[e.jsx(u,{variant:"outline",className:"h-8 min-w-[80px]",onClick:()=>us(!1),children:"إلغاء"}),e.jsx(u,{className:"h-8 min-w-[100px] bg-amber-600 hover:bg-amber-700 text-white",onClick:async()=>{try{const d=vt;if(!d){us(!1);return}const I=pe.trim(),O=Be.trim()||void 0,X=E||void 0;if(!I){k({title:"بيانات مطلوبة",description:"أدخل اسم العميل",variant:"destructive"});return}await zs(d,!0,{id:X,name:I,mobile:O});try{if(y!=null&&y.uid){const K=d.sellingPrice*(parseInt(ce[d.id]||"0")||0),Ae=await ve.getUserData(y.uid),ze=Array.isArray(Ae==null?void 0:Ae.debts)?Ae.debts:[],Ue={id:Date.now().toString(),debtorName:I,customerId:X||null,mobile:O||null,amount:K,reason:`بيع أجل للمنتج ${d.name}`,status:"pending",createdAt:new Date,partialPayments:[]},Oe=[Ue,...ze];await ve.updateUserData(y.uid,{debts:Oe});try{const qe=L||(v==null?void 0:v.shopId)||"main";localStorage.setItem(`debts_${y.uid}_${qe}`,JSON.stringify(Oe)),localStorage.setItem(`debts_default_${qe}`,JSON.stringify(Oe)),localStorage.setItem(`debts_last_write_${y.uid}_${qe}`,Date.now().toString())}catch{}try{window.dispatchEvent(new CustomEvent("debtsUpdated",{detail:{count:Oe.length}}))}catch{}try{await ur.send(y.uid,`تم إضافة دين على ${Ue.debtorName} بمبلغ ${Ue.amount} جنيه`)}catch{}}}catch{}us(!1),H(null)}catch{}},children:"تأكيد البيع الآجل"})]})]})}),e.jsx(Ne,{open:Et,onOpenChange:kt,children:e.jsxs(je,{className:"sm:max-w-3xl",children:[e.jsx(Se,{children:e.jsx(De,{children:"إيصالات البيع"})}),f.filter(d=>!d.isDeferred).length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا توجد إيصالات بيع حتى الآن."}):e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg max-h-[70vh] overflow-y-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر الجملة"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الإجمالي"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الربح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"الوقت"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنفذ"})]})}),e.jsx("tbody",{children:f.filter(d=>!d.isDeferred).map(d=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:d.productName}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Vt(d.price)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Vt(d.wholesalePrice??0)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Qa(d.quantity)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Vt((d.price??0)*(d.quantity??0))}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Vt(((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0))}),e.jsx("td",{className:"px-3 py-2 text-gray-500",children:ql(d.date)}),e.jsx("td",{className:"px-3 py-2 text-gray-500",children:d.time}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:d.executedBy||"-"})]},d.id))})]})}),e.jsx("div",{className:"flex justify-end mt-3",children:e.jsx(u,{variant:"outline",onClick:()=>kt(!1),children:"إغلاق"})})]})}),e.jsx(Ne,{open:fe,onOpenChange:Z,children:e.jsxs(je,{className:"max-w-sm mx-auto bg-white border border-gray-200 shadow-2xl rounded-2xl sm:max-w-md",children:[e.jsx(Se,{className:"text-center",children:e.jsx(De,{className:"text-base md:text-lg font-bold text-gray-900",children:es==="return"?"تأكيد المرتجع":"تأكيد حذف الإيصال"})}),e.jsxs("div",{className:"space-y-3 text-center px-2",children:[e.jsxs("p",{className:"text-sm text-gray-700",children:["هل تريد ",es==="return"?"عمل مرتجع":"حذف الإيصال"," للمنتج:",e.jsxs("span",{className:"font-semibold text-gray-900",children:[" ",dt==null?void 0:dt.productName," "]}),"بكمية",e.jsxs("span",{className:"font-semibold text-gray-900",children:[" ",Qa((dt==null?void 0:dt.quantity)||0)," "]}),"؟"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"سيتم عكس المخزون والرصيد حسب الحالة."})]}),e.jsxs("div",{className:"flex items-center justify-center gap-3 mt-2",children:[e.jsx(u,{variant:"outline",className:"h-8 min-w-[80px]",onClick:()=>Z(!1),children:"إلغاء"}),e.jsx(u,{className:"h-8 min-w-[100px] bg-red-600 hover:bg-red-700 text-white",onClick:()=>{const d=dt;Z(!1),d&&oo(d)},children:"تأكيد"})]})]})}),e.jsx(Ds,{open:nt,onOpenChange:ue,mode:"verify",title:"قفل إجمالي الأرباح",description:"أدخل الرقم السري الرئيسي لعرض إجمالي الأرباح",onSuccess:()=>{Ie(!1),ue(!1)}}),e.jsx(Ds,{open:Ye,onOpenChange:ct,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const d=y==null?void 0:y.uid;if(d){const I=await no(d),O=(I==null?void 0:I.planType)??(I==null?void 0:I.plan)??null,X=typeof O=="string"?O.toLowerCase():null;if(O===Gs.ZERO||X==="zero"){k({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}Xe(!1),ct(!1),Kt()}}),e.jsx(Ds,{open:hs,onOpenChange:Ot,mode:"verify",title:st,description:Jt,onSuccess:()=>{const d=is.current;is.current=null,Ot(!1),d&&d()}})]})}const Qa=r=>new Intl.NumberFormat("ar-EG").format(Number(r||0)),Vt=r=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(r||0))} ج.م`,ql=r=>{try{const m=new Date(r);return isNaN(m.getTime())?new Date(`${r}T00:00:00`).toLocaleDateString("ar-EG"):m.toLocaleDateString("ar-EG")}catch{return r}},Px=({open:r,onOpenChange:m,userId:o,cashBalance:f,walletBalances:N,transactions:S})=>{const[t,j]=He.useState(0),[R,C]=He.useState(0),[$,k]=He.useState(0),[y,v]=He.useState(0),[_,G]=He.useState(f||0),[L,Y]=He.useState(!1),[ne,ce]=He.useState(null),{toast:M}=da(),{shopId:F}=Oi()||{},{profile:ie}=Da(),[Te,he]=He.useState(!1),[ye,se]=He.useState(""),[Fe,We]=He.useState(!1),[_e,Qe]=He.useState(!1),[Ge,Nt]=He.useState(""),re=()=>`cashBalance_${o||"default"}_${F||(ie==null?void 0:ie.shopId)||"main"}`,Ie=Me=>`${new Intl.NumberFormat("ar-EG").format(Number(Me||0))} جنيه`;He.useEffect(()=>{const Me=async()=>{try{if(!o){j(0);return}const Re=new Date,Xe=Re.getFullYear(),ee=String(Re.getMonth()+1).padStart(2,"0"),U=String(Re.getDate()).padStart(2,"0"),Et=`${Xe}-${ee}-${U}`;let kt;try{const be=Ke(Ce(V,"dailySales"),me("userId","==",o),...F?[me("shopId","==",F)]:[],me("date","==",Et));kt=await et(be)}catch{const be=Ke(Ce(V,"users",o,"dailySales"),...F?[me("shopId","==",F)]:[],me("date","==",Et));kt=await et(be)}let W=0;kt.forEach(be=>{const ke=be.data(),ut=Number(ke.sellingPrice??0),xt=Number(ke.quantity??0);ut>0&&xt>0&&(W+=ut*xt)}),j(W)}catch(Re){console.warn("فشل تحميل مبيعات الإكسسوار لليوم:",Re)}},Ye=async()=>{try{if(!o){setMaintenanceProfitToday(0);return}const Re=new Date,Xe=new Date(Re.getFullYear(),Re.getMonth(),Re.getDate(),0,0,0,0),ee=new Date(Re.getFullYear(),Re.getMonth(),Re.getDate(),23,59,59,999);let U;try{const kt=Ke(Ce(V,"maintenance_items"),me("userId","==",o),me("status","==","completed"));U=await et(kt)}catch{U=await et(Ke(Ce(V,"maintenance_items"),me("userId","==",o)))}let Et=0;U.forEach(kt=>{var ke,ut;const W=kt.data();if((W.status||"in_progress")!=="completed")return;const be=(ut=(ke=W.completedAt)==null?void 0:ke.toDate)==null?void 0:ut.call(ke);if(be&&be.getTime()>=Xe.getTime()&&be.getTime()<=ee.getTime()){const xt=Number(W.repairPrice||0);Number.isFinite(xt)&&xt>0&&(Et+=xt)}}),k(Math.max(0,Et))}catch(Re){console.warn("فشل تحميل إجمالي فلوس الصيانة لليوم:",Re)}},ct=async()=>{var Re;try{if(!o){C(0);return}const Xe=await ve.getUserData(o),ee=new Date().toISOString().slice(0,10),U=(Xe==null?void 0:Xe.dailyReceipts)||{};U!=null&&U.date&&String(U.date).slice(0,10)===ee?(C(Number(U.accessory||0)),v(Number(U.maintenance||0))):(C(0),v(0));try{const Et=F||(ie==null?void 0:ie.shopId)||"main",kt=await Na(Ve(V,"dashboardData",Et));if(kt.exists()){const W=Number(((Re=kt.data())==null?void 0:Re.cashBalance)||0);G(W);try{localStorage.setItem(`cashBalance_${o}`,String(W)),localStorage.setItem(re(),String(W))}catch{}}else G(Number((Xe==null?void 0:Xe.cashBalance)||f||0))}catch{G(Number((Xe==null?void 0:Xe.cashBalance)||f||0))}}catch{C(0),v(0)}};r&&(Me(),Ye(),ct())},[r,o,S,f,F]),He.useEffect(()=>{const Me=Ye=>{var ct;try{const Re=Number((ct=Ye==null?void 0:Ye.detail)==null?void 0:ct.value);Number.isFinite(Re)&&G(Re)}catch{}};return window.addEventListener("cashBalanceChanged",Me),()=>window.removeEventListener("cashBalanceChanged",Me)},[r]),He.useEffect(()=>{if(!r||!o)return;const Me=F||(ie==null?void 0:ie.shopId)||"main";let Ye=null;try{Ye=Fs(Ve(V,"dashboardData",Me),ct=>{var Re;try{if(ct.exists()){const Xe=Number(((Re=ct.data())==null?void 0:Re.cashBalance)||0);G(Xe);try{localStorage.setItem(`cashBalance_${o}`,String(Xe)),localStorage.setItem(re(),String(Xe))}catch{}}}catch{}})}catch{}return()=>{try{typeof Ye=="function"&&Ye()}catch{}}},[r,o,F]);const nt=Math.max(0,Number(t)-Number(R)),ue=Math.max(0,Number($)-Number(y)),Pe=async Me=>{if(!o)return;const Ye=new Date().toISOString().slice(0,10);try{const ct=Me==="accessory"?nt:ue;if(ct<=0){M({title:"لا يوجد مبلغ لتأكيد استلامه",variant:"default"});return}const Re=Math.max(0,Number(_)-ct);G(Re),Me==="accessory"?C(Xe=>Xe+ct):v(Xe=>Xe+ct),await ve.updateUserData(o,{cashBalance:Re,dailyReceipts:{date:Ye,accessory:Me==="accessory"?R+ct:R,maintenance:Me==="maintenance"?y+ct:y}});try{const Xe=F||(ie==null?void 0:ie.shopId)||"main";await Wt(Ve(V,"dashboardData",Xe),{cashBalance:Re,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${o}`,String(Re)),localStorage.setItem(re(),String(Re))}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:Re}}))}catch{}M({title:"تم الاستلام",description:`تم خصم ${ct.toFixed(2)} من الدرج وتصفير بند ${Me==="accessory"?"الإكسسوار":"الصيانة"}`})}catch{M({title:"خطأ",description:"تعذر تنفيذ عملية تم الاستلام",variant:"destructive"})}},Dt=()=>{se(""),Nt(""),he(!0)},Ft=()=>{if(!ye.trim()){M({title:"سبب الخصم مطلوب",variant:"destructive"});return}he(!1),We(!0)},Rt=()=>{We(!1),Qe(!0)},Zt=async()=>{try{if(!o)return;const Me=Math.max(0,Number(Ge||0));if(!Number.isFinite(Me)||Me<=0){M({title:"مبلغ غير صالح",description:"أدخل مبلغ خصم صحيح أكبر من الصفر",variant:"destructive"});return}const Ye=Math.max(0,Number(_)-Me);G(Ye),await ve.updateUserData(o,{cashBalance:Ye});try{const Re=F||(ie==null?void 0:ie.shopId)||"main";await Wt(Ve(V,"dashboardData",Re),{cashBalance:Ye,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${o}`,String(Ye))}catch{}try{localStorage.setItem(re(),String(Ye))}catch{}const ct={title:"ايصال خصم من الفلوس النقديه",type:"cash_deduction",amount:Me,status:"completed",createdAt:new Date,note:ye,cashierName:"الحساب الرئيسي"};try{await ve.saveUserTransaction(o,ct)}catch{}M({title:"تم الخصم",description:`تم خصم ${Me.toFixed(2)} من الدرج`}),Qe(!1),Nt(""),se("")}catch{M({title:"فشل الخصم",description:"تعذر تنفيذ عملية الخصم",variant:"destructive"})}};return e.jsx(Ne,{open:r,onOpenChange:m,children:e.jsxs(je,{className:"sm:max-w-lg animate-in fade-in-90 zoom-in-95 slide-in-from-top-4",dir:"rtl",children:[e.jsx(Se,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[e.jsx(Ht,{className:"h-5 w-5 text-emerald-600"}),"تفاصيل الفلوس النقدية"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between bg-amber-50 border border-amber-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 font-bold text-sm",children:[e.jsx(Ht,{className:"h-4 w-4"}),"مجموع الفلوس النقدية (الدرج)"]}),e.jsx("div",{className:"text-amber-700 font-extrabold text-sm",children:Ie(_)})]}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 font-bold text-sm",children:[e.jsx(vn,{className:"h-4 w-4"}),"فلوس الاكسسوار"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-blue-700 font-extrabold text-sm",children:Ie(nt)}),e.jsx(u,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800",onClick:()=>{ce("accessory"),Y(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-emerald-50 border border-emerald-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-800 font-bold text-sm",children:[e.jsx(io,{className:"h-4 w-4"}),"فلوس الصيانة"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-emerald-700 font-extrabold text-sm",children:Ie(ue)}),e.jsx(u,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800",onClick:()=>{ce("maintenance"),Y(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-red-800 font-bold text-sm",children:"خصم فلوس من الفلوس النقديه"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(u,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800",onClick:Dt,children:"خصم"})})]})]}),e.jsx(Ds,{open:L,onOpenChange:Y,mode:"verify",title:"تأكيد الرقم السري لعملية تم الاستلام",description:"يرجى إدخال الرقم السري الرئيسي لتأكيد استلام المبلغ",onSuccess:()=>{ne&&(Pe(ne),ce(null)),Y(!1)}}),e.jsx(Ne,{open:Te,onOpenChange:he,children:e.jsxs(je,{className:"sm:max-w-sm",children:[e.jsx(Se,{children:e.jsx(De,{children:"سبب الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"deduct-reason",children:"اكتب سبب الخصم"}),e.jsx(q,{id:"deduct-reason",value:ye,onChange:Me=>se(Me.target.value),placeholder:"سبب الخصم"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(u,{variant:"outline",onClick:()=>he(!1),children:"إلغاء"}),e.jsx(u,{onClick:Ft,className:"bg-red-600 hover:bg-red-700",children:"متابعة"})]})]})}),e.jsx(Ds,{open:Fe,onOpenChange:We,mode:"verify",title:"تأكيد الرقم السري لعملية الخصم",description:"يرجى إدخال الرقم السري الرئيسي لمتابعة الخصم",onSuccess:Rt}),e.jsx(Ne,{open:_e,onOpenChange:Qe,children:e.jsxs(je,{className:"sm:max-w-sm",children:[e.jsx(Se,{children:e.jsx(De,{children:"مبلغ الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"deduct-amount",children:"أدخل مبلغ الخصم"}),e.jsx(q,{id:"deduct-amount",type:"number",value:Ge,onChange:Me=>Nt(Me.target.value),placeholder:"0.00"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(u,{variant:"outline",onClick:()=>Qe(!1),children:"إلغاء"}),e.jsx(u,{onClick:Zt,className:"bg-red-600 hover:bg-red-700",children:"تأكيد الخصم"})]})]})})]})})};function _d({size:r=24,className:m,...o}){return e.jsxs("svg",{width:r,height:r,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:m,...o,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}var Ed="AlertDialog",[kx]=du(Ed,[yd]),Fa=yd(),Od=r=>{const{__scopeAlertDialog:m,...o}=r,f=Fa(m);return e.jsx(lu,{...f,...o,modal:!0})};Od.displayName=Ed;var _x="AlertDialogTrigger",Ex=i.forwardRef((r,m)=>{const{__scopeAlertDialog:o,...f}=r,N=Fa(o);return e.jsx(fu,{...N,...f,ref:m})});Ex.displayName=_x;var Ox="AlertDialogPortal",Md=r=>{const{__scopeAlertDialog:m,...o}=r,f=Fa(m);return e.jsx(ou,{...f,...o})};Md.displayName=Ox;var Mx="AlertDialogOverlay",Rd=i.forwardRef((r,m)=>{const{__scopeAlertDialog:o,...f}=r,N=Fa(o);return e.jsx(gu,{...N,...f,ref:m})});Rd.displayName=Mx;var Br="AlertDialogContent",[Rx,$x]=kx(Br),Lx=uu("AlertDialogContent"),$d=i.forwardRef((r,m)=>{const{__scopeAlertDialog:o,children:f,...N}=r,S=Fa(o),t=i.useRef(null),j=bd(m,t),R=i.useRef(null);return e.jsx(cu,{contentName:Br,titleName:Ld,docsSlug:"alert-dialog",children:e.jsx(Rx,{scope:o,cancelRef:R,children:e.jsxs(mu,{role:"alertdialog",...S,...N,ref:j,onOpenAutoFocus:hu(N.onOpenAutoFocus,C=>{var $;C.preventDefault(),($=R.current)==null||$.focus({preventScroll:!0})}),onPointerDownOutside:C=>C.preventDefault(),onInteractOutside:C=>C.preventDefault(),children:[e.jsx(Lx,{children:f}),e.jsx(Wx,{contentRef:t})]})})})});$d.displayName=Br;var Ld="AlertDialogTitle",Fd=i.forwardRef((r,m)=>{const{__scopeAlertDialog:o,...f}=r,N=Fa(o);return e.jsx(xu,{...N,...f,ref:m})});Fd.displayName=Ld;var Wd="AlertDialogDescription",Bd=i.forwardRef((r,m)=>{const{__scopeAlertDialog:o,...f}=r,N=Fa(o);return e.jsx(pu,{...N,...f,ref:m})});Bd.displayName=Wd;var Fx="AlertDialogAction",Ud=i.forwardRef((r,m)=>{const{__scopeAlertDialog:o,...f}=r,N=Fa(o);return e.jsx(vd,{...N,...f,ref:m})});Ud.displayName=Fx;var zd="AlertDialogCancel",qd=i.forwardRef((r,m)=>{const{__scopeAlertDialog:o,...f}=r,{cancelRef:N}=$x(zd,o),S=Fa(o),t=bd(m,N);return e.jsx(vd,{...S,...f,ref:t})});qd.displayName=zd;var Wx=({contentRef:r})=>{const m=`\`${Br}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${Br}\` by passing a \`${Wd}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${Br}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return i.useEffect(()=>{var f;document.getElementById((f=r.current)==null?void 0:f.getAttribute("aria-describedby"))||console.warn(m)},[m,r]),null},Bx=Od,Ux=Md,Vd=Rd,Jd=$d,Kd=Ud,Yd=qd,Hd=Fd,Qd=Bd;const zx=Bx,qx=Ux,Gd=i.forwardRef(({className:r,...m},o)=>e.jsx(Vd,{className:br("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",r),...m,ref:o}));Gd.displayName=Vd.displayName;const Zd=i.forwardRef(({className:r,...m},o)=>e.jsxs(qx,{children:[e.jsx(Gd,{}),e.jsx(Jd,{ref:o,className:br("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",r),...m})]}));Zd.displayName=Jd.displayName;const Xd=({className:r,...m})=>e.jsx("div",{className:br("flex flex-col space-y-2 text-center sm:text-left",r),...m});Xd.displayName="AlertDialogHeader";const em=i.forwardRef(({className:r,...m},o)=>e.jsx(Hd,{ref:o,className:br("text-lg font-semibold",r),...m}));em.displayName=Hd.displayName;const tm=i.forwardRef(({className:r,...m},o)=>e.jsx(Qd,{ref:o,className:br("text-sm text-muted-foreground",r),...m}));tm.displayName=Qd.displayName;const ro=i.forwardRef(({className:r,...m},o)=>e.jsx(Kd,{ref:o,className:br(wd(),r),...m}));ro.displayName=Kd.displayName;const sm=i.forwardRef(({className:r,...m},o)=>e.jsx(Yd,{ref:o,className:br(wd({variant:"outline"}),"mt-2 sm:mt-0",r),...m}));sm.displayName=Yd.displayName;const $t=r=>{try{return r.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(r)}},od=r=>{try{return(r?new Date(r):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},Oa="machine_daily_opening_values",Ma="machine_daily_opening_snapshot";function Vx({open:r,onOpenChange:m}){const{toast:o}=da(),{shiftUser:f}=_n(),{shopId:N,shopName:S}=Oi(),t=()=>{try{const E=Object.keys(localStorage||{}).filter(ge=>ge.startsWith("selectedShopId_"));for(const ge of E){const pe=localStorage.getItem(ge);if(pe)return pe}return null}catch{return null}};i.useEffect(()=>{try{if(r){const E=document.body.style.overflow;document.body.setAttribute("data-prev-overflow",E),document.body.style.overflow="hidden"}else{const E=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=E,document.body.removeAttribute("data-prev-overflow")}}catch{}return()=>{try{const E=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=E,document.body.removeAttribute("data-prev-overflow")}catch{}}},[r]);const[j,R]=i.useState(""),[C,$]=i.useState(""),[k,y]=i.useState(""),[v,_]=i.useState(null),[G,L]=i.useState(null),[Y,ne]=i.useState(null),[ce,M]=i.useState(null),[F,ie]=i.useState(!1),[Te,he]=i.useState(!1),[ye,se]=i.useState(""),[Fe,We]=i.useState(""),[_e,Qe]=i.useState(null),[Ge,Nt]=i.useState([]),[re,Ie]=i.useState([]),[nt,ue]=i.useState(!1),[Pe,Dt]=i.useState(""),[Ft,Rt]=i.useState(""),[Zt,Me]=i.useState(!1),[Ye,ct]=i.useState(null),[Re,Xe]=i.useState([]),[ee,U]=i.useState(null),[Et,kt]=i.useState(""),[W,be]=i.useState(!1),[ke,ut]=i.useState(!1);i.useEffect(()=>{if(r)try{const E=ee?`${Oa}_${ee}`:Oa,ge=ee?`${Ma}_${ee}`:Ma,pe=localStorage.getItem(E);if(pe){const Be=JSON.parse(pe);typeof(Be==null?void 0:Be.openingBase)=="number"&&_(Be.openingBase),typeof(Be==null?void 0:Be.openingAir)=="number"&&L(Be.openingAir),typeof(Be==null?void 0:Be.drawerCash)=="number"&&ne(Be.drawerCash)}else _(null),L(null),ne(null);const Ee=localStorage.getItem(ge);if(Ee){const Be=JSON.parse(Ee);typeof(Be==null?void 0:Be.openingBase)=="number"&&typeof(Be==null?void 0:Be.openingAir)=="number"?M({openingBase:Be.openingBase,openingAir:Be.openingAir,drawerCash:Be.drawerCash||0}):M(null)}else M(null)}catch{}},[r,ee]),i.useEffect(()=>{(async()=>{try{const E=N||t();if(!r||!E)return;const{getDocs:ge}=await bt(async()=>{const{getDocs:yt}=await import("./index-tnWDkOuX.js").then(vt=>vt.c2);return{getDocs:yt}},__vite__mapDeps([0,1]),import.meta.url),pe=Ce(V,"shops",E,"machines"),Be=(await ge(Ke(pe))).docs.map(yt=>({id:yt.id,name:String(yt.data().name||"ماكينة")}));Xe(Be);try{const yt=localStorage.getItem(`machineDaily_selected_${E}`);yt&&Be.some(H=>H.id===yt)?U(yt):!ee&&Be.length>0&&(U(Be[0].id),localStorage.setItem(`machineDaily_selected_${E}`,Be[0].id))}catch{}}catch(E){console.error("Load machines error:",E)}})()},[r,N]);const xt=i.useMemo(()=>(f==null?void 0:f.displayName)||(f==null?void 0:f.name)||(f==null?void 0:f.username)||void 0,[f]),ns=i.useMemo(()=>re.reduce((E,ge)=>E+(ge.profit||0),0),[re]),hs=i.useMemo(()=>re.reduce((E,ge)=>E+(ge.wholesalePrice||0),0),[re]),Ot=async()=>{try{const E=N||t();if(E&&ee){const ge=Ce(V,"shops",E,"machines",ee,"transfers"),pe=await et(Ke(ge));await Promise.all(pe.docs.map(Ee=>Ws(Ee.ref)));try{localStorage.setItem(`machineDaily_transfers_${E}_${ee}`,JSON.stringify([]))}catch{}}}catch{}Ie([]),o({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."})},st=async()=>{try{const E=N||t();if(E&&ee){const ge=Ce(V,"shops",E,"machines",ee,"deliveries"),pe=await et(Ke(ge));await Promise.all(pe.docs.map(Ee=>Ws(Ee.ref)));try{localStorage.setItem(`machineDaily_deliveries_${E}_${ee}`,JSON.stringify([]))}catch{}}}catch{}Nt([]),o({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."})},Ct=E=>{Nt(ge=>ge.filter(pe=>pe.id!==E)),o({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},Jt=()=>{_(null),L(null),ne(null),M(null),R(""),$(""),y("");try{const E=ee?`${Oa}_${ee}`:Oa,ge=ee?`${Ma}_${ee}`:Ma;localStorage.removeItem(E),localStorage.removeItem(ge)}catch{}o({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},Os=async()=>{var Ee;const E=parseFloat(j||"0"),ge=parseFloat(C||"0"),pe=parseFloat(k||"0");if(isNaN(E)||isNaN(ge)||isNaN(pe)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(E<0||ge<0||pe<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}_(E),L(ge),ne(pe);try{const Be=ee?`${Oa}_${ee}`:Oa,yt=ee?`${Ma}_${ee}`:Ma;localStorage.setItem(Be,JSON.stringify({openingBase:E,openingAir:ge,drawerCash:pe})),localStorage.setItem(yt,JSON.stringify({openingBase:E,openingAir:ge,drawerCash:pe})),M({openingBase:E,openingAir:ge,drawerCash:pe});const vt=N||t();if(vt&&ee){const H=Ve(V,"shops",vt,"machines",ee);await oa(H,{name:((Ee=Re.find(fe=>fe.id===ee))==null?void 0:Ee.name)||"ماكينة",openingBase:E,openingAir:ge,drawerCash:pe,cashierName:xt,shopName:S||null,updatedAt:ft()},{merge:!0})}}catch{}o({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${$t(E)}، الهواء: ${$t(ge)}، فلوس الدرج: ${$t(pe)}`})},is=()=>{if(v==null||G==null){o({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}he(!0)},Xt=()=>{const E=parseFloat(ye||"0"),ge=parseFloat(Fe||"0");if(isNaN(E)||isNaN(ge)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(E<0||ge<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const pe=(ce==null?void 0:ce.openingBase)??(v||0),Ee=(ce==null?void 0:ce.openingAir)??(G||0),Be=pe+Ee,vt=E+ge-Be;Qe(vt);const H={id:`${Date.now()}`,openingBase:pe,openingAir:Ee,deliveryBase:E,deliveryAir:ge,netResult:vt,createdAt:new Date().toISOString(),cashierName:xt,requiredDrawerNoProfit:vt<0?Math.round(-vt*100)/100:0};(async()=>{try{const fe=N||t();fe&&ee&&(await ca(Ce(V,"shops",fe,"machines",ee,"deliveries"),{cashierName:xt,openingBase:pe,openingAir:Ee,deliveryBase:E,deliveryAir:ge,netResult:vt,createdAt:ft()}),await oa(Ve(V,"shops",fe,"machines",ee),{lastDeliveryAt:ft(),updatedAt:ft()},{merge:!0}))}catch(fe){console.error("Persist delivery error:",fe)}})(),Nt(fe=>[H,...fe]);try{const fe=N||t(),Z=fe&&ee?`machineDaily_deliveries_${fe}_${ee}`:`machineDaily_deliveries_${ee}`,dt=localStorage.getItem(Z),jt=dt?JSON.parse(dt):[],es=[H,...Array.isArray(jt)?jt:[]];localStorage.setItem(Z,JSON.stringify(es))}catch{}o({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${$t(vt)}`})},Ca=()=>{const E=parseFloat(Pe||"0"),ge=parseFloat(Ft||"0");if(!Number.isFinite(E)||!Number.isFinite(ge)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if(E<0||ge<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(v==null||G==null){o({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const pe=Math.round((ge-E)*100)/100;ct({wholesalePrice:E,retailPrice:ge,profit:pe}),Me(!0)},Us=async E=>{if(!Ye)return;const ge={id:`transfer_${Date.now()}`,wholesalePrice:Ye.wholesalePrice,retailPrice:Ye.retailPrice,profit:Ye.profit,createdAt:new Date().toISOString(),cashierName:xt,deductFrom:E},pe=Ye.wholesalePrice,Ee=v??0,Be=G??0,yt=Y??0;if(pe>(E==="base"?Ee:Be)){o({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const H=E==="base"?Math.round((Ee-pe)*100)/100:Ee,fe=E==="air"?Math.round((Be-pe)*100)/100:Be,Z=Ye.retailPrice,dt=Math.round((yt+Z)*100)/100;_(H),L(fe),ne(dt);try{const jt=ee?`${Oa}_${ee}`:Oa,es=ee?`${Ma}_${ee}`:Ma;localStorage.setItem(jt,JSON.stringify({openingBase:H,openingAir:fe,drawerCash:dt})),localStorage.setItem(es,JSON.stringify({openingBase:H,openingAir:fe,drawerCash:dt}));const xs=N||t();if(xs&&ee){const Zs=Ve(V,"shops",xs,"machines",ee);await oa(Zs,{openingBase:H,openingAir:fe,drawerCash:dt,cashierName:xt,updatedAt:ft()},{merge:!0}),await ca(Ce(V,"shops",xs,"machines",ee,"transfers"),{wholesalePrice:Ye.wholesalePrice,retailPrice:Ye.retailPrice,profit:Ye.profit,deductFrom:E,cashierName:xt,createdAt:ft()})}}catch{}Ie(jt=>[ge,...jt]);try{const jt=N||t(),es=jt&&ee?`machineDaily_transfers_${jt}_${ee}`:"machineDaily_transfers",xs=localStorage.getItem(es),Zs=xs?JSON.parse(xs):[],ra=[ge,...Array.isArray(Zs)?Zs:[]];localStorage.setItem(es,JSON.stringify(ra))}catch{}ue(!1),Dt(""),Rt(""),ct(null),Me(!1),o({title:"تم تسجيل تحويل",description:`الربح الفوري: ${$t(ge.profit)} | خصم المخزون: -${$t(pe)} (${E==="base"?"الأساسي":"الهواء"}) | درج (المباع فقط): +${$t(Z)}`})},ga=()=>{R(""),$(""),he(!1),se(""),We(""),Qe(null)};i.useEffect(()=>{const E=N||t();if(!(!r||!E||!ee))try{const ge=Ce(V,"shops",E,"machines",ee,"transfers"),pe=Fs(ge,async Ee=>{const yt=[...Ee.docs.map(vt=>{var dt,jt;const H=vt.data(),fe=(jt=(dt=H==null?void 0:H.createdAt)==null?void 0:dt.toDate)!=null&&jt.call(dt)?H.createdAt.toDate():new Date,Z=H==null?void 0:H.deductFrom;return{id:vt.id,wholesalePrice:Number((H==null?void 0:H.wholesalePrice)||0),retailPrice:Number((H==null?void 0:H.retailPrice)||0),profit:Number((H==null?void 0:H.profit)??(Number((H==null?void 0:H.retailPrice)||0)-Number((H==null?void 0:H.wholesalePrice)||0)||0)),createdAt:fe.toISOString(),cashierName:(H==null?void 0:H.cashierName)||void 0,deductFrom:Z==="base"||Z==="air"?Z:void 0}})].sort((vt,H)=>{const fe=new Date(vt.createdAt).getTime();return new Date(H.createdAt).getTime()-fe});if(yt.length>0){Ie(yt),be(!0);try{localStorage.setItem(`machineDaily_transfers_${E}_${ee}`,JSON.stringify(yt))}catch{}}else if(W){Ie([]);try{localStorage.setItem(`machineDaily_transfers_${E}_${ee}`,JSON.stringify([]))}catch{}}});return()=>{try{pe()}catch{}}}catch{}},[r,N,ee,W]),i.useEffect(()=>{const E=N||t();if(!(!r||!E||!ee))try{const ge=Ce(V,"shops",E,"machines",ee,"deliveries"),pe=Fs(ge,Ee=>{const yt=[...Ee.docs.map(vt=>{var Z,dt;const H=vt.data(),fe=(dt=(Z=H==null?void 0:H.createdAt)==null?void 0:Z.toDate)!=null&&dt.call(Z)?H.createdAt.toDate():new Date;return{id:vt.id,openingBase:Number((H==null?void 0:H.openingBase)||0),openingAir:Number((H==null?void 0:H.openingAir)||0),deliveryBase:Number((H==null?void 0:H.deliveryBase)||0),deliveryAir:Number((H==null?void 0:H.deliveryAir)||0),netResult:typeof(H==null?void 0:H.netResult)=="number"?Number(H.netResult):Math.round((Number((H==null?void 0:H.deliveryBase)||0)+Number((H==null?void 0:H.deliveryAir)||0)-(Number((H==null?void 0:H.openingBase)||0)+Number((H==null?void 0:H.openingAir)||0)))*100)/100,createdAt:fe.toISOString(),cashierName:(H==null?void 0:H.cashierName)||void 0,requiredDrawerNoProfit:typeof(H==null?void 0:H.requiredDrawerNoProfit)=="number"?H.requiredDrawerNoProfit:void 0}})].sort((vt,H)=>new Date(H.createdAt).getTime()-new Date(vt.createdAt).getTime());if(yt.length>0){Nt(yt),ut(!0);try{localStorage.setItem(`machineDaily_deliveries_${E}_${ee}`,JSON.stringify(yt))}catch{}}else if(ke){Nt([]);try{localStorage.setItem(`machineDaily_deliveries_${E}_${ee}`,JSON.stringify([]))}catch{}}});return()=>{try{pe()}catch{}}}catch{}},[r,N,ee,ke]),i.useEffect(()=>{if(!(!r||!ee))try{const E=N||t(),ge=E?`machineDaily_deliveries_${E}_${ee}`:`machineDaily_deliveries_${ee}`,pe=localStorage.getItem(ge);if(pe){const Ee=JSON.parse(pe);Array.isArray(Ee)&&Ee.length>0&&Nt(Ee)}(async()=>{try{const Ee=N||t();if(!Ee)return;const Be=Ce(V,"shops",Ee,"machines",ee,"deliveries"),H=[...(await et(Ke(Be))).docs.map(fe=>{var jt,es;const Z=fe.data(),dt=(es=(jt=Z==null?void 0:Z.createdAt)==null?void 0:jt.toDate)!=null&&es.call(jt)?Z.createdAt.toDate():new Date;return{id:fe.id,openingBase:Number((Z==null?void 0:Z.openingBase)||0),openingAir:Number((Z==null?void 0:Z.openingAir)||0),deliveryBase:Number((Z==null?void 0:Z.deliveryBase)||0),deliveryAir:Number((Z==null?void 0:Z.deliveryAir)||0),netResult:typeof(Z==null?void 0:Z.netResult)=="number"?Number(Z.netResult):Math.round((Number((Z==null?void 0:Z.deliveryBase)||0)+Number((Z==null?void 0:Z.deliveryAir)||0)-(Number((Z==null?void 0:Z.openingBase)||0)+Number((Z==null?void 0:Z.openingAir)||0)))*100)/100,createdAt:dt.toISOString(),cashierName:(Z==null?void 0:Z.cashierName)||void 0,requiredDrawerNoProfit:typeof(Z==null?void 0:Z.requiredDrawerNoProfit)=="number"?Z.requiredDrawerNoProfit:void 0}})].sort((fe,Z)=>new Date(Z.createdAt).getTime()-new Date(fe.createdAt).getTime());if(H.length>0){Nt(H);try{localStorage.setItem(`machineDaily_deliveries_${Ee}_${ee}`,JSON.stringify(H))}catch{}}}catch{}})()}catch{}},[r,N,ee]),i.useEffect(()=>{if(!(!r||!ee))try{const E=N||t(),ge=E?`machineDaily_transfers_${E}_${ee}`:`machineDaily_transfers_${ee}`,pe=localStorage.getItem(ge);if(pe){const Ee=JSON.parse(pe);Array.isArray(Ee)&&Ee.length>0&&Ie(Ee)}(async()=>{try{const Ee=N||t();if(!Ee)return;const Be=Ce(V,"shops",Ee,"machines",ee,"transfers"),H=[...(await et(Ke(Be))).docs.map(fe=>{var es,xs;const Z=fe.data(),dt=(xs=(es=Z==null?void 0:Z.createdAt)==null?void 0:es.toDate)!=null&&xs.call(es)?Z.createdAt.toDate():new Date,jt=Z==null?void 0:Z.deductFrom;return{id:fe.id,wholesalePrice:Number((Z==null?void 0:Z.wholesalePrice)||0),retailPrice:Number((Z==null?void 0:Z.retailPrice)||0),profit:Number((Z==null?void 0:Z.profit)??(Number((Z==null?void 0:Z.retailPrice)||0)-Number((Z==null?void 0:Z.wholesalePrice)||0)||0)),createdAt:dt.toISOString(),cashierName:(Z==null?void 0:Z.cashierName)||void 0,deductFrom:jt==="base"||jt==="air"?jt:void 0}})].sort((fe,Z)=>new Date(Z.createdAt).getTime()-new Date(fe.createdAt).getTime());if(H.length>0){Ie(H);try{localStorage.setItem(`machineDaily_transfers_${Ee}_${ee}`,JSON.stringify(H))}catch{}}}catch{}})()}catch{}},[r,N,ee]);const us=E=>{E||ga(),m(E)};return e.jsxs(Ne,{open:r,onOpenChange:us,children:[e.jsxs(je,{className:"w-screen h-[100vh] overflow-hidden rounded-none p-0 flex flex-col dark:bg-[#121212]",children:[e.jsxs(Se,{className:"sticky top-0 bg-white dark:bg-[#0F0F0F] z-20 border-b border-gray-200 dark:border-[#333] px-4 py-3",children:[e.jsx(De,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(_d,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(Ss,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"px-4 py-3 overflow-y-auto flex-1 grid grid-cols-1 gap-6",children:[e.jsxs(Lt,{children:[e.jsx(ms,{className:"pb-2",children:e.jsxs(Bs,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"اختيار ماكينة"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(u,{variant:"destructive",onClick:async()=>{try{if(!N||!ee)return;const E=Ve(V,"shops",N,"machines",ee);try{const pe=await et(Ce(V,"shops",N,"machines",ee,"transfers"));await Promise.all(pe.docs.map(Ee=>Ws(Ee.ref)))}catch{}try{const pe=await et(Ce(V,"shops",N,"machines",ee,"deliveries"));await Promise.all(pe.docs.map(Ee=>Ws(Ee.ref)))}catch{}await Ws(E),Xe(pe=>pe.filter(Ee=>Ee.id!==ee));const ge=Re.find(pe=>pe.id!==ee);U(ge?ge.id:null);try{const pe=`${Oa}_${ee}`,Ee=`${Ma}_${ee}`;localStorage.removeItem(pe),localStorage.removeItem(Ee)}catch{}o({title:"تم حذف الماكينة",description:"تمت الإزالة نهائيًا."})}catch{o({title:"فشل الحذف",description:"تعذر حذف الماكينة.",variant:"destructive"})}},disabled:!ee,title:"حذف الماكينة",children:e.jsx(ds,{className:"h-4 w-4"})})})]})}),e.jsx(Bt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الماكينة الحالية"}),e.jsxs(Ga,{value:ee??"",onValueChange:E=>{U(E);try{const ge=N||t();ge&&localStorage.setItem(`machineDaily_selected_${ge}`,E)}catch{}},children:[e.jsx(Za,{className:"text-right",children:e.jsx(Xa,{placeholder:"اختر ماكينة"})}),e.jsx(er,{children:Re.map(E=>e.jsx(ua,{value:E.id,children:E.name},E.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"إنشاء ماكينة جديدة"}),e.jsx(q,{value:Et,onChange:E=>kt(E.target.value),placeholder:"اسم الماكينة",className:"text-right"})]}),e.jsx("div",{className:"flex justify-end md:justify-start",children:e.jsx(u,{onClick:async()=>{try{if(!N){o({title:"لا يوجد محل",description:"يرجى التأكد من تحميل بيانات المحل.",variant:"destructive"});return}const E=(Et||"").trim();if(!E){o({title:"اسم الماكينة مطلوب",description:"أدخل اسم للماكينة الجديدة.",variant:"destructive"});return}const ge=await ca(Ce(V,"shops",N,"machines"),{name:E,shopId:N,createdAt:ft(),updatedAt:ft(),isActive:!0}),pe={id:ge.id,name:E};Xe(Ee=>[pe,...Ee]),U(ge.id),kt(""),o({title:"تم إنشاء ماكينة",description:`تمت إضافة ${E}`})}catch(E){console.error("Create machine error:",E),o({title:"خطأ في الإنشاء",description:"تعذر إنشاء الماكينة.",variant:"destructive"})}},className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})})]})]})})]}),e.jsxs(Lt,{children:[e.jsx(ms,{className:"pb-2",children:e.jsxs(Bs,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"}),e.jsx(u,{variant:"ghost",size:"sm",onClick:()=>ie(E=>!E),className:"flex items-center gap-1",children:e.jsx(Cn,{className:`h-4 w-4 transition-transform ${F?"rotate-180":""}`})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(u,{variant:"outline",onClick:()=>ue(!0),disabled:v==null||G==null,className:"border-violet-300 text-violet-700",children:"تحويل"})}),v!=null&&G!=null&&e.jsxs(Gt,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",$t(v)," | هواء ",$t(G)," | درج ",$t(Y??0)]})]}),e.jsxs(Bt,{className:`space-y-4 ${F?"":"hidden"}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:j,onChange:E=>R(E.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:C,onChange:E=>$(E.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:k,onChange:E=>y(E.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(u,{variant:"outline",className:"mr-2",onClick:Jt,children:"تصفير"}),e.jsx(u,{onClick:Os,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),e.jsxs(Lt,{children:[e.jsx(ms,{className:"pb-2",children:e.jsxs(Bs,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات تحويل"}),e.jsxs(Gt,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",$t(ns)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{variant:"outline",size:"sm",onClick:Ot,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(Tn,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Bt,{className:"space-y-3",children:re.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-3 max-h-52 overflow-y-auto pr-1",children:re.map(E=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر الجملة"}),e.jsx("p",{className:"text-sm",children:$t(E.wholesalePrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر التجزئة"}),e.jsx("p",{className:"text-sm",children:$t(E.retailPrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الربح الفوري"}),e.jsx("p",{className:"text-sm text-green-700",children:$t(E.profit)}),E.deductFrom&&e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"text-[11px] bg-violet-100 text-violet-700 border border-violet-200 rounded px-2 py-0.5",children:["الخصم من: ",E.deductFrom==="base"?"الأساسي":"الهواء"]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(rr,{className:"h-3 w-3"}),e.jsx("span",{children:od(E.createdAt)}),E.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Yl,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",E.cashierName]})]})]})]})]},E.id))})})]}),e.jsxs(Lt,{children:[e.jsx(ms,{className:"pb-2",children:e.jsx(Bs,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(Bt,{className:"space-y-4",children:Te?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:ye,onChange:E=>se(E.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Fe,onChange:E=>We(E.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(u,{variant:"secondary",onClick:()=>he(!1),children:"إلغاء"}),e.jsx(u,{onClick:Xt,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),_e!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(Gt,{className:_e>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",$t(_e)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(Gt,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",$t(parseFloat(ye||"0")+parseFloat(Fe||"0"))]}),e.jsxs(Gt,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",$t(hs)]})]})]})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(u,{variant:"outline",onClick:is,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs(Lt,{children:[e.jsx(ms,{className:"pb-2",children:e.jsxs(Bs,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{variant:"outline",size:"sm",onClick:st,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(Tn,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Bt,{className:"space-y-3",children:Ge.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:Ge.map(E=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",$t(E.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",$t(E.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",$t(E.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",$t(E.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(u,{variant:"outline",size:"sm",onClick:()=>Ct(E.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(ds,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${E.netResult>=0?"text-green-700":"text-red-700"}`,children:$t(E.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",$t(E.deliveryBase+E.deliveryAir)]}),typeof E.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",$t(E.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(rr,{className:"h-3 w-3"}),e.jsx("span",{children:od(E.createdAt)}),E.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Yl,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",E.cashierName]})]})]})]})]},E.id))})})]})]}),e.jsxs(ht,{className:"sticky bottom-0 bg-white dark:bg-[#0F0F0F] z-20 border-t border-gray-200 dark:border-[#333] px-4 py-3 flex items-center justify-between",children:[e.jsx(u,{variant:"outline",onClick:()=>us(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(La,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(Ne,{open:nt,onOpenChange:ue,children:e.jsxs(je,{className:"sm:max-w-sm",children:[e.jsx(Se,{children:e.jsx(De,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Pe,onChange:E=>Dt(E.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Ft,onChange:E=>Rt(E.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(Gt,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",$t(parseFloat(Ft||"0")-parseFloat(Pe||"0")||0)]})})]}),e.jsxs(ht,{className:"flex items-center justify-end gap-2",children:[e.jsx(u,{variant:"secondary",onClick:()=>ue(!1),children:"إلغاء"}),e.jsx(u,{onClick:Ca,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(zx,{open:Zt,onOpenChange:Me,children:e.jsxs(Zd,{children:[e.jsxs(Xd,{children:[e.jsx(em,{children:"اختيار مصدر الخصم"}),e.jsx(tm,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(sm,{onClick:()=>Me(!1),children:"رجوع"}),e.jsx(ro,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>Us("base"),children:"خصم من الأساسي"}),e.jsx(ro,{className:"bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>Us("air"),children:"خصم من الهواء"})]})]})})]})}function Jx(r,m=300){const[o,f]=He.useState(r);return He.useEffect(()=>{const N=setTimeout(()=>f(r),m);return()=>clearTimeout(N)},[r,m]),o}const Kx=({userId:r,transactions:m})=>{const[o,f]=i.useState(!1),[N,S]=i.useState(!1),[t,j]=i.useState(!1),[R,C]=i.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:$}=Da();i.useEffect(()=>{r&&o&&t&&k()},[r,o,t]);const k=async()=>{if(r)try{if(Array.isArray(m)&&m.length>0){const Y=new Date,ne=Y.getMonth(),ce=Y.getFullYear(),M=Ps.filterVisibleTransactions(m,"monthly",r);let F=0,ie=0;M.forEach(Te=>{const he=new Date(Te.createdAt),ye=String(Te.status||"confirmed").toLowerCase();if(he.getMonth()!==ne||he.getFullYear()!==ce||ye!=="completed"&&ye!=="confirmed")return;const se=(Te.type||Te.txnType||"").toLowerCase(),Fe={type:se==="withdrawal"?"withdraw":se,amount:Number(Te.amount||0),commission:Te.commission};Fe.type==="withdraw"?F+=tr.calculateProfitFromTransaction(Fe):(Fe.type==="send"||Fe.type==="receive"||Fe.type==="transfer")&&(ie+=tr.calculateProfitFromTransaction(Fe))}),C({monthlyWithdrawalProfit:Math.round(F*100)/100,monthlyTransferProfit:Math.round(ie*100)/100,lastUpdated:new Date});return}const L=tr.getWithdrawTransferProfits(r);C({monthlyWithdrawalProfit:L.monthlyWithdrawProfit||0,monthlyTransferProfit:L.monthlyTransferProfit||0,lastUpdated:new Date})}catch(L){console.error("Error loading profit data:",L)}},y=L=>`${L.toFixed(2)} ج.م`,v=async()=>{try{const L=($==null?void 0:$.subscription)||null,Y=(L==null?void 0:L.planType)??(L==null?void 0:L.plan)??null,ne=typeof Y=="string"?Y.toLowerCase():null;if(Y===Gs.ZERO||ne==="zero"||ne==="0"||Y===0)return!0}catch{}try{if(r){const L=await no(r),Y=(L==null?void 0:L.planType)??(L==null?void 0:L.plan)??null,ne=typeof Y=="string"?Y.toLowerCase():null;if(Y===Gs.ZERO||ne==="zero"||ne==="0"||Y===0)return!0}}catch{}return!1},_=async()=>{try{if(await v()){Yc({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}S(!0)},G=async()=>{try{if(await v()){Yc({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),S(!1);return}}catch{}j(!0),f(!0),S(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(u,{size:"sm",variant:"ghost",onClick:_,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح الشهرية",children:e.jsx(Ut,{className:"h-1.5 w-1.5"})}),e.jsx(Ne,{open:o,onOpenChange:f,children:e.jsxs(je,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(Se,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:e.jsxs(De,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(rr,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"شهري"]})}),e.jsx("div",{className:"py-0 sm:py-3",children:e.jsxs("div",{className:"rounded-xl border border-purple-300 bg-white overflow-hidden",children:[e.jsx("div",{className:"p-2 sm:p-3 bg-red-50 border-b border-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ki,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800 text-xs",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-2 py-0.5 rounded",children:y(R.monthlyWithdrawalProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-blue-50 border-b border-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(io,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-blue-900 bg-white px-2 py-0.5 rounded",children:y(R.monthlyTransferProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ht,{className:"h-3 w-3 text-purple-600"}),e.jsx("span",{className:"font-medium text-purple-800 text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"font-bold text-sm text-purple-900 bg-white px-2 py-0.5 rounded",children:y(R.monthlyWithdrawalProfit+R.monthlyTransferProfit)})]})})]})}),!t&&e.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:e.jsx(u,{size:"sm",variant:"ghost",onClick:()=>S(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:e.jsx(Ut,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:e.jsx(u,{onClick:()=>f(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),e.jsx(Ds,{open:N,onOpenChange:S,onSuccess:G,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},Yx=r=>e.jsx(Kx,{...r});function Hx({open:r,onOpenChange:m,onSuccess:o,userId:f}){const[N,S]=i.useState(""),[t,j]=i.useState(""),[R,C]=i.useState(!1),[$,k]=i.useState(!1),[y,v]=i.useState(""),[_,G]=i.useState(!1),[L,Y]=i.useState(!1),{toast:ne}=da();i.useEffect(()=>{let F=!0;return(async()=>{const ie=await _s.hasMasterPin(f);F&&Y(ie)})(),()=>{F=!1}},[f,r]);const ce=()=>{S(""),j(""),v(""),C(!1),k(!1),m(!1)},M=async F=>{F.preventDefault(),v(""),G(!0);try{if(L){if(!await _s.verifyMasterPin(N,f)){v("الرقم السري غير صحيح"),G(!1);return}}else{if(N.length<4){v("يجب أن يكون الرقم السري 4 أرقام على الأقل"),G(!1);return}if(N!==t){v("الرقم السري غير متطابق"),G(!1);return}if(!await _s.createMasterPin(N,f)){v("تعذر إنشاء الرقم السري الرئيسي"),G(!1);return}}ne({title:"نجح العملية",description:L?"تم التحقق من الرقم السري الرئيسي بنجاح":"تم إنشاء الرقم السري الرئيسي بنجاح"}),o(),ce()}catch{v("حدث خطأ أثناء معالجة الرقم السري")}finally{G(!1)}};return e.jsx(Ne,{open:r,onOpenChange:m,children:e.jsxs(je,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Se,{children:e.jsxs(De,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(yr,{className:"h-5 w-5 text-green-600"}),L?"أدخل الرقم السري الرئيسي":"إنشاء الرقم السري الرئيسي"]})}),e.jsxs("form",{onSubmit:M,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:L?"أدخل الرقم السري الرئيسي لعرض بيانات الأرباح":"قم بإنشاء الرقم السري الرئيسي لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"pin",children:L?"الرقم السري الرئيسي":"الرقم السري الرئيسي الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"pin",type:R?"text":"password",value:N,onChange:F=>S(F.target.value),placeholder:L?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(u,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>C(!R),children:R?e.jsx(Cs,{className:"h-4 w-4"}):e.jsx(Ut,{className:"h-4 w-4"})})]})]}),!L&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:$?"text":"password",value:t,onChange:F=>j(F.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(u,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>k(!$),children:$?e.jsx(Cs,{className:"h-4 w-4"}):e.jsx(Ut,{className:"h-4 w-4"})})]})]}),y&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(vr,{className:"h-4 w-4"}),y]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(u,{type:"submit",disabled:_,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(yr,{className:"h-4 w-4 mr-2"}),_?"جاري المعالجة...":L?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(u,{type:"button",variant:"outline",onClick:ce,disabled:_,children:"إلغاء"})]})]})]})})}const Qx=({userId:r,transactions:m})=>{const[o,f]=i.useState(!1),[N,S]=i.useState(!1),[t,j]=i.useState(!1),[R,C]=i.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});i.useEffect(()=>{r&&o&&t&&$()},[r,o,t,m]);const $=async()=>{if(r)try{if(Array.isArray(m)&&m.length>0){const G=new Date,L=Ps.filterVisibleTransactions(m,"daily",r);let Y=0,ne=0;L.forEach(ce=>{const M=new Date(ce.createdAt),F=String(ce.status||"confirmed").toLowerCase();if(M.toDateString()!==G.toDateString())return;const ie=(ce.type||ce.txnType||"").toLowerCase(),Te=String(ce.title||"");if(ie==="cash_addition"||Te.includes("إيصال إضافة نقدية"))return;const he={type:ie==="withdrawal"?"withdraw":ie,amount:Number(ce.amount||0),commission:ce.commission};he.type==="withdraw"?Y+=tr.calculateProfitFromTransaction(he):(he.type==="send"||he.type==="receive"||he.type==="transfer")&&(ne+=tr.calculateProfitFromTransaction(he))}),C({dailyWithdrawalProfit:Math.round(Y*100)/100,dailyTransferProfit:Math.round(ne*100)/100,lastUpdated:new Date});try{tr.updateProfitsFromTransactions(m,r)}catch{}return}const _=tr.getWithdrawTransferProfits(r);C({dailyWithdrawalProfit:_.dailyWithdrawProfit||0,dailyTransferProfit:_.dailyTransferProfit||0,lastUpdated:new Date})}catch(_){console.error("Error loading profit data:",_)}},k=_=>`${_.toFixed(2)} ج.م`,y=()=>{tr.hasProfitPin(r),S(!0)},v=()=>{j(!0),f(!0),S(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(u,{size:"sm",variant:"ghost",onClick:y,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح اليومية",children:e.jsx(Ut,{className:"h-1.5 w-1.5"})}),e.jsx(Ne,{open:o,onOpenChange:f,children:e.jsxs(je,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-blue-50 sm:to-white sm:border-2 sm:border-blue-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(Se,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-blue-200",children:e.jsxs(De,{className:"text-xs font-bold text-blue-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-sm sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(Ht,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),"يومي"]})}),e.jsx("div",{className:"py-0 sm:py-3",children:e.jsxs("div",{className:"rounded-xl border border-blue-300 bg-white overflow-hidden",children:[e.jsx("div",{className:"p-2 sm:p-3 bg-red-50 border-b border-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ki,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800 text-xs",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-2 py-0.5 rounded",children:k(R.dailyWithdrawalProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-green-50 border-b border-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(io,{className:"h-3 w-3 text-green-600"}),e.jsx("span",{className:"font-medium text-green-800 text-xs",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-green-900 bg-white px-2 py-0.5 rounded",children:k(R.dailyTransferProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-blue-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ht,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"font-bold text-sm text-blue-900 bg-white px-2 py-0.5 rounded",children:k(R.dailyWithdrawalProfit+R.dailyTransferProfit)})]})})]})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-blue-200",children:e.jsx(u,{onClick:()=>f(!1),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-blue-600 sm:to-blue-700 sm:hover:from-blue-700 sm:hover:to-blue-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300 sm:text-xs",children:"إغلاق"})})]})}),e.jsx(Hx,{open:N,onOpenChange:S,onSuccess:v,userId:r})]})},Gx=r=>e.jsx(Qx,{...r}),Zx=({open:r,onOpenChange:m})=>{var Ia;const{shiftUser:o,isShiftActive:f,shiftStartAt:N,setShiftUser:S,startShift:t,endShift:j}=_n(),{userSubscription:R,user:C,signIn:$,profile:k}=Da(),{toast:y}=da(),[v,_]=i.useState((o==null?void 0:o.name)||""),[G,L]=i.useState((o==null?void 0:o.username)||""),[Y,ne]=i.useState(""),[ce,M]=i.useState(!1),[F,ie]=i.useState(null),[Te,he]=i.useState(""),[ye,se]=i.useState(""),[Fe,We]=i.useState(!1),[_e,Qe]=i.useState(null),[Ge,Nt]=i.useState(""),[re,Ie]=i.useState(""),[nt,ue]=i.useState(!1),[Pe,Dt]=i.useState(!1),[Ft,Rt]=i.useState({totalTransfers:0,totalWithdrawals:0}),[Zt,Me]=i.useState(null),[Ye,ct]=i.useState(""),[Re,Xe]=i.useState(""),[ee,U]=i.useState(0),[Et,kt]=i.useState({}),[W,be]=i.useState(0),[ke,ut]=i.useState(0),[xt,ns]=i.useState({}),[hs,Ot]=i.useState(""),[st,Ct]=i.useState(!1),Jt=z=>{const we={"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9","۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9","٫":".","،":".","٬":"."," ":""};return z.split("").map(wt=>we[wt]??wt).join("")},Os=()=>`cashierUsers_${(C==null?void 0:C.uid)||"default"}`,[is,Xt]=i.useState(()=>{try{let z=localStorage.getItem(Os());if(!z){const we=localStorage.getItem("cashierUsers");we&&(z=we)}return z?JSON.parse(z):[]}catch{return[]}});i.useEffect(()=>{(async()=>{try{if(!(C!=null&&C.uid))return;const z=Ve(V,"profiles",C.uid,"cashierUsers","list"),we=await Na(z);if(we.exists()){const wt=we.data(),pt=Array.isArray(wt==null?void 0:wt.users)?wt.users:[];pt&&pt.length>0&&Xt(pt)}}catch{}})()},[C==null?void 0:C.uid]),i.useEffect(()=>{if(!(C!=null&&C.uid))return;const z=Ve(V,"profiles",C.uid,"cashierUsers","list"),we=Fs(z,wt=>{try{if(wt.exists()){const pt=wt.data(),ps=Array.isArray(pt==null?void 0:pt.users)?pt.users:[];if(ps&&ps.length>0)Xt(ps);else try{const ts=localStorage.getItem(Os()),Kt=ts?JSON.parse(ts):[];Xt(Kt)}catch{Xt([])}}}catch{}},wt=>{console.warn("cashierUsers realtime subscription error:",wt)});return()=>we()},[C==null?void 0:C.uid]);const Ca=(Ia=R==null?void 0:R.subscription)==null?void 0:Ia.planType,Us=Ca==="yearly"?2:Ca==="lifetime"?4:Number.POSITIVE_INFINITY;i.useEffect(()=>{try{localStorage.setItem(Os(),JSON.stringify(is));try{localStorage.removeItem("cashierUsers")}catch{}}catch{}(async()=>{try{if(!(C!=null&&C.uid))return;const z=Ve(V,"profiles",C.uid,"cashierUsers","list");await oa(z,{users:is},{merge:!0})}catch{}})()},[is]);const[ga,us]=i.useState(!1),[E,ge]=i.useState(""),[pe,Ee]=i.useState(null),[Be,yt]=i.useState([]),[vt,H]=i.useState(!1),[fe,Z]=i.useState(null),[dt,jt]=i.useState(!1),[es,xs]=i.useState(!1),Zs=z=>{const we=(o==null?void 0:o.username)===z;let wt=!1;try{wt=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(we&&!(we&&!f&&(hs==="الأدمن الرئيسي"||wt))){y({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const ts=`هل أنت متأكد من حذف المستخدم ${z}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(ts)&&(Xt(Kt=>Kt.filter(Wa=>Wa.username!==z)),we&&S(null),y({title:"تم حذف المستخدم",description:z}))},ra=()=>{if(!v.trim()||!G.trim()||!Y.trim())return;if(is.length>=Us){y({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(Us)?Us:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const z={name:v.trim(),username:G.trim(),password:Y.trim()};Xt(we=>[z,...we]),_(""),L(""),ne("")},wr=()=>{M(!0),ie(null),Qe(null),Nt(""),Ie("")},Ms=async()=>{try{let z=[];try{C!=null&&C.uid&&(z=await ve.getUserTransactions(C.uid))}catch{}if(!z||z.length===0)try{const it=await kd({merchantUserId:C==null?void 0:C.uid,limit:200});z=(it==null?void 0:it.transactions)||[]}catch{}const we=N?new Date(N):null,wt=new Date,pt=it=>{const at=it.type,zs=it.txnType;return at==="withdraw"||at==="withdrawal"||at==="receive"||zs==="receive"},ps=it=>{const at=it.type,zs=it.txnType;return at==="send"||at==="transfer"||zs==="send"},ts=it=>{if(!it)return null;if(it instanceof Date)return it;try{const at=new Date(it);return Number.isNaN(at.getTime())?null:at}catch{return null}},Kt=it=>{const at=ts(it.createdAt||it.created_at||it.timestamp);return!at||we&&at<we?!1:at<=wt},Wa=it=>it==="completed"||it==="confirmed",fa=z.filter(it=>Wa(it.status)&&Kt(it)),Kr=fa.filter(it=>pt(it)).reduce((it,at)=>{const zs=at.withdrawnAmount??at.receivedAmount??at.amount??0;return it+(Number(zs)||0)},0);return{totalTransfers:fa.filter(it=>ps(it)).reduce((it,at)=>{const zs=at.sentAmount??at.transferredAmount??at.amount??0;return it+(Number(zs)||0)},0),totalWithdrawals:Kr}}catch{return{totalTransfers:0,totalWithdrawals:0}}};i.useEffect(()=>{if(Pe){try{const z=localStorage.getItem("shiftInitialReceivedDrawerFunds");z!==null&&Xe(z)}catch{}try{const z=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(z!==null){const we=parseFloat(z);U(Number.isFinite(we)?we:0)}}catch{}}},[Pe]),i.useEffect(()=>{ce&&(async()=>{try{const z=await Ms();Rt(z)}catch{}})()},[ce]),i.useEffect(()=>{if(!r&&!vt)return;(async()=>{try{const wt=((C!=null&&C.uid?await ve.getUserTransactions(C.uid):[])||[]).filter(pt=>(pt==null?void 0:pt.type)==="report"||((pt==null?void 0:pt.title)||"").includes("إيصال تسليم وردية"));wt.sort((pt,ps)=>{const ts=new Date(pt.createdAt||0).getTime();return new Date(ps.createdAt||0).getTime()-ts}),yt(wt)}catch{yt([])}})()},[r,Pe,vt,C==null?void 0:C.uid]);const Jr=async(z,we,wt)=>{try{let pt=0,ps=0;try{const Kt=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");pt=Number.isFinite(Kt)?Kt:0}catch{}try{const Kt=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");ps=Number.isFinite(Kt)?Kt:0}catch{}const ts={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(o==null?void 0:o.username)||"cashier",receiverPhone:hs||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(o==null?void 0:o.name)||(o==null?void 0:o.username)||null,deficit:we,deficitAmount:we?wt:0,shiftStartAt:N,receivedDrawerFunds:pt,receivedWalletBalancesTotal:ps,receivedWalletBalances:Et,deliveredDrawerFunds:W||0,deliveredWalletBalancesTotal:ke||0,deliveredWalletBalances:xt,shiftProfit:Math.round(((W||0)+(ke||0)-(pt+ps))*100)/100};C!=null&&C.uid&&await ve.saveUserTransaction(C.uid,ts),yt(Kt=>[ts,...Kt||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(Ne,{open:r,onOpenChange:m,children:e.jsxs(je,{className:"sm:max-w-md",children:[e.jsx(Se,{children:e.jsx(De,{children:f?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),f?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[o==null?void 0:o.name," (",o==null?void 0:o.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),is.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:is.map((z,we)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:z.name}),e.jsx("div",{className:"text-xs text-gray-500",children:z.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(u,{size:"sm",className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>{Ee(z),us(!0)},children:"دخول"}),e.jsx(u,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>Zs(z.username),children:"حذف"})]})]},we))})]})]}),e.jsx(ht,{className:"flex flex-wrap gap-2 justify-between",children:f?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(u,{className:"w-full sm:w-auto",variant:"destructive",onClick:wr,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(u,{className:"w-full sm:w-auto bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>xs(!0),children:"إضافة مستخدم جديد"}),e.jsx(u,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>H(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(Ne,{open:es,onOpenChange:xs,children:e.jsxs(je,{className:"sm:max-w-md",children:[e.jsx(Se,{children:e.jsx(De,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(te,{className:"mb-1 block",children:"الاسم"}),e.jsx(q,{value:v,onChange:z=>_(z.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(te,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(q,{value:G,onChange:z=>L(z.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(te,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(q,{type:"password",autoComplete:"new-password",value:Y,onChange:z=>ne(z.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(ht,{className:"flex gap-2 justify-between",children:[e.jsx(u,{variant:"secondary",onClick:()=>{xs(!1)},children:"إلغاء"}),e.jsx(u,{onClick:()=>{!v.trim()||!G.trim()||!Y.trim()||(ra(),xs(!1))},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"حفظ المستخدم"})]})]})}),e.jsx(Ne,{open:vt,onOpenChange:H,children:e.jsxs(je,{className:"sm:max-w-lg",children:[e.jsx(Se,{children:e.jsx(De,{children:"إيصالات التسليم"})}),Be.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:Be.map(z=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{Z(z),jt(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(z.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",z.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",z.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",z.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",z.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",z.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",z.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",z.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",z.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",z.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(z.shiftProfit??(z.deliveredDrawerFunds??0)+(z.deliveredWalletBalancesTotal??0)-(z.receivedDrawerFunds??0)-(z.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",z.shiftProfit??(z.deliveredDrawerFunds??0)+(z.deliveredWalletBalancesTotal??0)-(z.receivedDrawerFunds??0)-(z.receivedWalletBalancesTotal??0)]})]}),z.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",z.deficitAmount??0]})]},z.id))}),e.jsx(ht,{className:"flex gap-2 justify-between",children:e.jsx(u,{variant:"secondary",onClick:()=>H(!1),children:"إغلاق"})})]})}),e.jsx(Ne,{open:dt,onOpenChange:jt,children:e.jsxs(je,{className:"sm:max-w-md",children:[e.jsx(Se,{children:e.jsx(De,{children:"إيصال تسليم وردية"})}),fe?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(fe.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",fe.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",fe.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",fe.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",fe.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",fe.deliveredWalletBalancesTotal??0]})]})]}),fe.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",fe.deficitAmount??0]})]}),fe.receivedWalletBalances&&Object.keys(fe.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(fe.receivedWalletBalances).map(([z,we])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:z}),e.jsx("span",{className:"font-semibold",children:we})]},z))})]}),fe.deliveredWalletBalances&&Object.keys(fe.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(fe.deliveredWalletBalances).map(([z,we])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:z}),e.jsx("span",{className:"font-semibold",children:we})]},z))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(ht,{className:"flex gap-2 justify-between",children:e.jsx(u,{variant:"secondary",onClick:()=>jt(!1),children:"إغلاق"})})]})}),e.jsx(Ne,{open:ga,onOpenChange:us,children:e.jsxs(je,{className:"sm:max-w-md",children:[e.jsx(Se,{children:e.jsx(De,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:pe?`${pe.name} (${pe.username})`:""}),e.jsx(q,{type:"password",autoComplete:"off",value:E,onChange:z=>ge(z.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(ht,{className:"flex gap-2 justify-between",children:[e.jsx(u,{variant:"secondary",onClick:()=>{ge(""),Ee(null),us(!1)},children:"إلغاء"}),e.jsx(u,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{if(pe){if(E.trim()!==pe.password){y({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}S({name:pe.name,username:pe.username}),ge(""),us(!1),m(!1),t(),Ct(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(Ne,{open:st,onOpenChange:Ct,children:e.jsxs(je,{className:"sm:max-w-md",children:[e.jsx(Se,{children:e.jsx(De,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(te,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(q,{type:"text",inputMode:"decimal",value:Re,onChange:z=>Xe(Jt(z.target.value)),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(te,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(q,{type:"text",inputMode:"decimal",value:Number.isFinite(ee)?ee:0,onChange:z=>{const we=parseFloat(Jt(z.target.value));U(Number.isFinite(we)?we:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(ht,{className:"flex gap-2 justify-between",children:e.jsx(u,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{const z=parseFloat(Re),we=ee,wt=Number.isFinite(z)&&z>=0,pt=Number.isFinite(we)&&we>=0;if(!wt||!pt){y({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(z)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(we))}catch{}y({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),Ct(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(Ne,{open:ce,onOpenChange:z=>{z&&M(!0)},children:e.jsxs(je,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(Se,{children:e.jsx(De,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{variant:F==="toUser"?"default":"secondary",onClick:()=>ie("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(u,{variant:F==="toAdmin"?"default":"secondary",onClick:()=>ie("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),F==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[is.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:is.map((z,we)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(_e==null?void 0:_e.username)===z.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>Qe(z),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:z.name}),e.jsx("div",{className:"text-xs text-gray-500",children:z.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},we))})]}),e.jsxs("div",{children:[e.jsx(te,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(q,{type:"password",autoComplete:"off",value:Ge,onChange:z=>Nt(z.target.value),placeholder:"أدخل كلمة السر"})]}),re&&e.jsx("div",{className:"text-xs text-red-600",children:re})]}),F==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(q,{type:"password",autoComplete:"off",value:Te,onChange:z=>he(z.target.value),placeholder:"كلمة المرور"}),ye&&e.jsx("div",{className:"text-xs text-red-600",children:ye})]})]}),e.jsx(ht,{className:"flex gap-2 justify-between",children:e.jsx(u,{disabled:nt||!F,onClick:async()=>{if(F){ue(!0);try{const z=Ft;if(Ms().then(Rt).catch(()=>{}),F==="toUser"){if(!_e){Ie("يرجى اختيار المستخدم أولاً"),ue(!1);return}if(Ge.trim()!==_e.password){Ie("كلمة السر غير صحيحة"),ue(!1);return}j(),S({name:_e.name,username:_e.username}),t(),Ot(`${_e.name} (${_e.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}M(!1),ie(null),Qe(null),Nt(""),Ie(""),m(!1),Rt(z),Me(null),ct(""),Dt(!0)}else if(F==="toAdmin"){se("");const we=(C==null?void 0:C.email)||"";if(!we){se("لا يوجد بريد للمستخدم الرئيسي للتحقق"),ue(!1);return}const{error:wt}=await $(we,Te);if(wt){se("كلمة المرور غير صحيحة"),ue(!1);return}j(),S(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}he(""),M(!1),m(!1),Ot("الأدمن الرئيسي"),Rt(z),Me(null),ct(""),Dt(!0)}}catch{Ie("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{ue(!1)}}},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"تأكيد التسليم"})})]})}),e.jsx(Ne,{open:Pe,onOpenChange:Dt,children:e.jsxs(je,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(Se,{children:e.jsx(De,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:hs})]}),N&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(N).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(te,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(q,{type:"number",value:Re,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(te,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(q,{type:"number",value:ee,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(te,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(q,{type:"text",inputMode:"decimal",value:W,onChange:z=>{const we=parseFloat(Jt(z.target.value));be(Number.isFinite(we)?we:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(te,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(q,{type:"text",inputMode:"decimal",value:ke,onChange:z=>{const we=parseFloat(Jt(z.target.value));ut(Number.isFinite(we)?we:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(W??0)+(ke??0)-((parseFloat(Re||"0")||0)+(ee??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((W??0)+(ke??0)-((parseFloat(Re||"0")||0)+(ee??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"}),e.jsx("div",{className:"mt-2 grid grid-cols-1 gap-2",children:e.jsxs("div",{className:"rounded border p-2 bg-gray-50",children:[e.jsx("div",{className:"text-xs text-gray-700",children:"مطلوب من الدرج (بدون أرباح)"}),e.jsx("div",{className:"text-sm font-semibold text-gray-900",children:Math.round(((W??0)-(parseFloat(Re||"0")||0))*100)/100})]})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{variant:Zt==="no"?"default":"secondary",onClick:()=>Me("no"),children:"لا"}),e.jsx(u,{variant:Zt==="yes"?"default":"secondary",onClick:()=>Me("yes"),children:"نعم"})]}),Zt==="yes"&&e.jsxs("div",{children:[e.jsx(te,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(q,{type:"number",value:Ye,onChange:z=>ct(z.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(ht,{className:"flex gap-2 justify-between",children:e.jsx(u,{onClick:()=>{const z=Zt==="yes",we=parseFloat(Ye)||0;(async()=>await Jr(Ft,z,we))(),y({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),Dt(!1)},className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:"تأكيد وحفظ الإيصال"})})]})})]})},Xx=({open:r,onOpenChange:m})=>{const{shiftUser:o,endShift:f,setShiftUser:N}=_n(),[S,t]=i.useState(""),[j,R]=i.useState(""),[C,$]=i.useState([]),{user:k}=Da();i.useEffect(()=>{(async()=>{try{if(k!=null&&k.uid){const v=Ve(V,"profiles",k.uid,"cashierUsers","list"),_=await Na(v);if(_.exists()){const G=_.data(),L=Array.isArray(G==null?void 0:G.users)?G.users:[];if(L&&L.length>0){$(L);return}}}}catch{}try{const v=`cashierUsers_${(k==null?void 0:k.uid)||"default"}`;let _=localStorage.getItem(v);if(!_){const G=localStorage.getItem("cashierUsers");G&&(_=G)}$(_?JSON.parse(_):[])}catch{$([])}})()},[r,k==null?void 0:k.uid]),i.useEffect(()=>{if(!r||!(k!=null&&k.uid))return;const v=Ve(V,"profiles",k.uid,"cashierUsers","list"),_=Fs(v,G=>{if(G.exists()){const L=G.data(),Y=Array.isArray(L==null?void 0:L.users)?L.users:[];if(Y&&Y.length>0)$(Y);else try{const ne=`cashierUsers_${(k==null?void 0:k.uid)||"default"}`;let ce=localStorage.getItem(ne);if(!ce){const M=localStorage.getItem("cashierUsers");M&&(ce=M)}$(ce?JSON.parse(ce):[])}catch{$([])}}},G=>{console.warn("ShiftProfileDialog cashierUsers snapshot error:",G)});return()=>_()},[r,k==null?void 0:k.uid]);const y=async()=>{if(R(""),!o)return;const v=C.find(_=>_.username===o.username);if(!v){R("لا يوجد مستخدم مطابق لهذه الوردية");return}if(S.trim()!==v.password){R("الرقم السري غير صحيح");return}f(),N(null),t(""),m(!1)};return e.jsx(Ne,{open:r,onOpenChange:v=>{t(""),R(""),m(v)},children:e.jsxs(je,{className:"sm:max-w-md",children:[e.jsx(Se,{children:e.jsx(De,{children:"بروفيل الوردية"})}),o?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:o.name}),e.jsx("div",{className:"text-xs text-gray-600",children:o.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx(q,{type:"password",value:S,onChange:v=>t(v.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),j&&e.jsx("div",{className:"text-red-600 text-xs",children:j})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(ht,{className:"flex justify-between",children:[e.jsx(u,{variant:"outline",onClick:()=>m(!1),children:"إغلاق"}),e.jsx(u,{onClick:y,disabled:!o,children:"تسليم الوردية"})]})]})})},ep=({open:r,onOpenChange:m})=>e.jsx(Ne,{open:r,onOpenChange:m,children:e.jsxs(je,{className:"sm:max-w-lg rounded-2xl",children:[e.jsxs(Se,{children:[e.jsxs(De,{className:"text-right flex items-center gap-2 justify-end",children:[e.jsx(Wl,{className:"w-5 h-5"}),"سجل التغييرات الأخيرة"]}),e.jsx(Ss,{className:"text-right",children:"هذه أبرز التحسينات التي تمت مؤخرًا في الواجهة."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Nd,{className:"w-5 h-5 text-amber-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحسين نافذة تعديل المديونية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"استبدال نافذة الإدخال القديمة (prompt) بحوار أنيق لإدخال المبلغ مع تأكيد."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Iu,{className:"w-5 h-5 text-violet-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحديث شاشة التحميل"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:'تغيير النص إلى "صلي علي النبي" مع خط عربي جميل ونبض لطيف.'})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Wl,{className:"w-5 h-5 text-green-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"بطاقات الأرباح وعدد العمليات"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"إضافة بطاقات عرض أرباح الفترة الحالية وعدد العمليات في تفاصيل المحفظة."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Wl,{className:"w-5 h-5 text-blue-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"إصلاح تمرير نافذة اليومية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"منع تمرير الصفحة الخلفية عند فتح نافذة اليومية لراحة الاستخدام."})]})]})]}),e.jsx("div",{className:"flex justify-end gap-2 mt-6",children:e.jsx(u,{variant:"secondary",onClick:()=>m(!1),children:"إغلاق"})})]})});class Wr{static async processTransfer(m){const{amount:o,currentCashBalance:f,currentWalletBalances:N,wallets:S,selectedWalletId:t}=m;if(o<=0)return{success:!1,newCashBalance:f,newWalletBalances:N,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(t&&!m.skipRemoteLimitsCheck)try{const $=await la.canPerformOperation(t,o,"transfer");if(!$.canPerform)return{success:!1,newCashBalance:f,newWalletBalances:N,message:$.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch($){return console.error("خطأ في التحقق من حدود التحويل:",$),{success:!1,newCashBalance:f,newWalletBalances:N,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(o<=0)return{success:!1,newCashBalance:f,newWalletBalances:N,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(t){const $=Math.max(N[t]||0,0);if($<o){const k=S.find(y=>y.id===t);return{success:!1,newCashBalance:f,newWalletBalances:N,message:`رصيد غير كافي في المحفظة${k?` ${k.name}`:""}. المتاح: ${$} جنيه، المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const $=Wr.calculateTotalWalletBalance(N);if($<o)return{success:!1,newCashBalance:f,newWalletBalances:N,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${$} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const j={...N};if(t){const $=j[t]||0;j[t]=$-o}else{let $=o;for(const k of S){if($<=0)break;const y=Math.max(j[k.id]||0,0),v=Math.min(y,$);v>0&&(j[k.id]=(j[k.id]||0)-v,$-=v)}}const R=f+o;let C="تم التحويل بنجاح";if(t){const $=j[t]||0;$<0&&(C=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${t} أصبح ${$} جنيه.`)}return{success:!0,newCashBalance:R,newWalletBalances:j,message:C}}static processDeposit(m){const{amount:o,currentCashBalance:f,currentWalletBalances:N,wallets:S}=m;if(o<=0)return{success:!1,newCashBalance:f,newWalletBalances:N,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const t=this.calculateTotalWalletBalance(N);if(t<o)return{success:!1,newCashBalance:f,newWalletBalances:N,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${t} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const j=f+o,R={...N};let C=o;const $=S.find(y=>y.isDefault);if($&&R[$.id]>=C)R[$.id]-=C,C=0;else for(const y of S){if(C<=0)break;const v=R[y.id]||0;if(v>0){const _=Math.min(v,C);R[y.id]=v-_,C-=_}}const k=C>0?`تم الإيداع جزئياً. تم إيداع ${o-C} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${o} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:j,newWalletBalances:R,message:k}}static async processWithdraw(m){const{amount:o,currentCashBalance:f,currentWalletBalances:N,wallets:S,selectedWalletId:t}=m;if(o<=0)return{success:!1,newCashBalance:f,newWalletBalances:N,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(t&&!m.skipRemoteLimitsCheck)try{const $=await la.canPerformOperation(t,o,"withdraw");if(!$.canPerform)return{success:!1,newCashBalance:f,newWalletBalances:N,message:$.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch($){return console.error("خطأ في التحقق من حدود السحب:",$),{success:!1,newCashBalance:f,newWalletBalances:N,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(f<o)return{success:!1,newCashBalance:f,newWalletBalances:N,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${f} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const j=f-o,R={...N},C=t?S.find($=>$.id===t):S.find($=>$.isDefault)||S[0];if(C){const $=R[C.id]||0;R[C.id]=$+o}else return{success:!1,newCashBalance:f,newWalletBalances:N,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};return{success:!0,newCashBalance:j,newWalletBalances:R,message:`تم السحب بنجاح. تم إضافة ${o} جنيه إلى محفظة ${(C==null?void 0:C.name)||""}`}}static validateOperation(m,o){return m<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!o||o.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(m){return Object.values(m).reduce((o,f)=>o+Math.max(f,0),0)}static deductFromWalletsAddToCash(m,o,f,N){return this.processTransfer({amount:m,currentCashBalance:o,currentWalletBalances:f,wallets:N})}static deductFromWalletsAddToCashDeposit(m,o,f,N){return this.processDeposit({amount:m,currentCashBalance:o,currentWalletBalances:f,wallets:N})}static deductFromCashAddToWallets(m,o,f,N){return this.processWithdraw({amount:m,currentCashBalance:o,currentWalletBalances:f,wallets:N})}static applyTransactionResult(m,o,f){m.success&&(o(m.newCashBalance),f(m.newWalletBalances))}static validateTransaction(m,o,f,N){if(m<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(o==="transfer"){const S=this.calculateTotalWalletBalance(N);if(S<m)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${S} جنيه) غير كافي للمبلغ المطلوب (${m} جنيه)`}}else if(o==="withdraw"){if(f<m)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${f} جنيه) غير كافي للمبلغ المطلوب (${m} جنيه)`}}else if(o==="deposit"){const S=this.calculateTotalWalletBalance(N);if(S<m)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${S} جنيه) غير كافي للمبلغ المطلوب (${m} جنيه)`}}return{isValid:!0}}static getDeductionPreview(m,o,f){const N=[];let S=m;for(const t of f){if(S<=0)break;const j=o[t.id]||0,R=Math.min(Math.max(j,0),S);R>0&&(N.push({walletId:t.id,walletName:t.name,currentBalance:j,deductedAmount:R,newBalance:j-R}),S-=R)}return N}}let bn=null;function tp(){const r=window;if(!bn){const m=r.AudioContext||r.webkitAudioContext;bn=new m}return bn.state==="suspended"&&bn.resume(),bn}function sp(r,m,o){const f=o/1e3,N=Math.floor(r.sampleRate*f),S=r.createBuffer(1,N,r.sampleRate),t=S.getChannelData(0);for(let $=0;$<N;$++)t[$]=(Math.random()*2-1)*.6;const j=r.createBufferSource();j.buffer=S;const R=r.createBiquadFilter();R.type="highpass",R.frequency.value=1500,R.Q.value=.7;const C=r.createGain();C.gain.setValueAtTime(1e-4,m),C.gain.exponentialRampToValueAtTime(.4,m+.015),C.gain.exponentialRampToValueAtTime(1e-4,m+f),j.connect(R),R.connect(C),C.connect(r.destination),j.start(m),j.stop(m+f+.01)}function ap(r,m,o,f,N,S="triangle"){const t=r.createOscillator(),j=r.createGain();t.type=S;const R=N/1e3;t.frequency.setValueAtTime(o,m),t.frequency.linearRampToValueAtTime(f,m+R),j.gain.setValueAtTime(1e-4,m),j.gain.exponentialRampToValueAtTime(.25,m+.02),j.gain.exponentialRampToValueAtTime(1e-4,m+R),t.connect(j),j.connect(r.destination),t.start(m),t.stop(m+R+.02)}function rp(){try{const r=tp(),m=r.currentTime;sp(r,m,90),ap(r,m+.12,1900,1100,180,"sawtooth")}catch{}}function np(r){if(!r)return!1;const o=r.replace(/[^0-9٠-٩]/g,"").replace(/[٠-٩]/g,f=>"0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(f)]);return/^(010|011|012|015)[0-9]{8}$/.test(o)}function ip({userId:r}){const[m,o]=He.useState(null),[f,N]=He.useState("");return null}const n0=()=>{var Rc,$c,Lc,Fc,Wc,Bc;console.log("🔥 UserDashboardPage component is loading...");const{toast:r}=da(),m=i.useRef(null),[o,f]=i.useState(0),N=async()=>{var n,l,c;const s="alkaptin678678@gmail.com",a=(l=(n=Fr.currentUser)==null?void 0:n.email)==null?void 0:l.toLowerCase();if(!a||a!==s){r({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}if(!li||!oi||!ci){r({title:"بيانات ناقصة",description:"أدخل رقم الموبايل، الشركة والمبلغ",variant:"destructive"});return}try{hc(!0);const h=await((c=Fr.currentUser)==null?void 0:c.getIdToken()),x=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...h?{Authorization:`Bearer ${h}`}:{}},body:JSON.stringify({phone:li,countryCode:"EG",operator:oi,amount:Number(ci),useLocalAmount:!0})}),g=await x.json().catch(()=>({}));x.ok&&(g!=null&&g.success)?(r({title:"تم الشحن",description:(g==null?void 0:g.message)||"تم تنفيذ عملية الشحن بنجاح"}),wl(!1),oc(""),cc(""),dc("")):r({title:"فشل الشحن",description:(g==null?void 0:g.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(h){console.error("Topup request error:",h),r({title:"خطأ غير متوقع",description:"تعذّر تنفيذ عملية الشحن. حاول لاحقاً.",variant:"destructive"})}finally{hc(!1)}},{signOut:S,user:t,profile:j}=Da(),R=((t==null?void 0:t.email)||"").toLowerCase()==="vodafonecash00@gmail.com",C=fd(),$=xd(),k=yu(),{isShiftActive:y,shiftUser:v}=_n(),{shopId:_,shopName:G}=Oi(),L=md(),Y=bu();(()=>{try{return!!window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:"}catch{return!1}})();const[ne,ce]=i.useState(!1),[M,F]=i.useState(!1),[ie,Te]=i.useState(!1),[he,ye]=i.useState(!1),[se,Fe]=i.useState([]),[We,_e]=i.useState(""),[Qe,Ge]=i.useState(""),[Nt,re]=i.useState(""),[Ie,nt]=i.useState(""),[ue,Pe]=i.useState(!1),[Dt,Ft]=i.useState(!1),[Rt,Zt]=i.useState(null),[Me,Ye]=i.useState(""),[ct,Re]=i.useState(""),[Xe,ee]=i.useState(!1),[U,Et]=i.useState("");i.useEffect(()=>{const s=k==null?void 0:k.shopId;if(s&&(t!=null&&t.uid))try{const a=`selectedShopId_${t.uid}`;localStorage.setItem(a,String(s)),window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}},[k==null?void 0:k.shopId,t==null?void 0:t.uid]);const[kt,W]=i.useState([]),[be,ke]=i.useState(()=>{try{return localStorage.getItem("cashySelectedDevice")||null}catch{return null}});i.useEffect(()=>{(()=>{if(Dn.isNativePlatform()){const a=()=>{var n,l;if((l=(n=window.cordova)==null?void 0:n.plugins)!=null&&l.permissions){const c=window.cordova.plugins.permissions,h=[c.RECEIVE_SMS];c.checkPermission(h,x=>{x.hasPermission?console.log("SMS permissions already granted"):c.requestPermissions(h,g=>{g.hasPermission?console.log("SMS permissions granted"):(console.warn("SMS permissions denied"),r({title:"تنبيه",description:"يرجى منح صلاحيات الرسائل لعمل التطبيق بشكل صحيح",variant:"destructive"}))},()=>{console.error("Error requesting SMS permissions")})},null)}else console.warn("Cordova permissions plugin not found yet, retrying..."),setTimeout(a,1e3)};document.addEventListener("deviceready",a,!1),a()}})()},[]),i.useEffect(()=>{(async()=>{if(U)try{await gn.set({key:"selected_wallet_id",value:U}),console.log("📱 Synced selected_wallet_id to Native:",U)}catch(a){console.error("Failed to sync wallet to native:",a)}else await gn.remove({key:"selected_wallet_id"})})()},[U]),i.useEffect(()=>{(async()=>{if(_)try{await gn.set({key:"shopId",value:_}),console.log("📱 Synced shopId to Native:",_)}catch(a){console.error("Failed to sync shopId to native:",a)}})()},[_]);const ut=s=>!!(s&&kt.some(a=>a.id===s));async function xt(){const s=window.electronAPI,a=be||"";if(!s||typeof s.sendUssd!="function")return null;if(!a)return r({title:"الجهاز غير محدد",description:"اتصل بالموبايل أولاً ثم اختر الجهاز من القائمة",variant:"destructive"}),null;if(ut(a))return a;try{const h=kt.find(x=>x&&x.id&&!String(x.id).includes(":"));if(h&&h.id)return ke(h.id),h.id}catch{}const n=a.includes(":")?a.split(":").slice(0,2).join(":"):"";if(n&&typeof s.connectWifi=="function"){try{await s.connectWifi(n)}catch{}if(await new Promise(h=>setTimeout(h,250)),ut(a))return a}const l=a.split(":")[0],c=kt.find(h=>(h.id.startsWith(l)||h.id.includes(l))&&h.id.includes(":"));if(c!=null&&c.id){const h=c.id.split(":").slice(0,2).join(":");if(!ut(c.id)&&typeof s.connectWifi=="function"){try{await s.connectWifi(h)}catch{}await new Promise(x=>setTimeout(x,250))}if(ut(c.id))return ke(c.id),c.id}return r({title:"الجهاز غير متصل",description:"فعّل Wireless debugging أو استخدم اتصال Wi‑Fi ثم أعد المحاولة",variant:"destructive"}),null}i.useEffect(()=>{const s=window.electronAPI;s&&typeof s.onAdbDevices=="function"&&s.onAdbDevices(a=>{var c;const n=Array.isArray(a)?a:[];W(n);const l=(()=>{try{return localStorage.getItem("cashySelectedDevice")||""}catch{return""}})();l&&n.some(h=>h.id===l)?ke(l):(c=n[0])!=null&&c.id?ke(h=>h||n[0].id):ke(null)})},[]);function ns(s,a){try{const n=ls==null?void 0:ls(),l=(n==null?void 0:n.phone)||"";if(!l){r({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"});return}Du(l,s,a),r({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),ir(!1),Ar(!1)}catch(n){const l=(n==null?void 0:n.message)||"تعذر إرسال الكود — تحقق من البيانات";throw r({title:"فشل الإرسال",description:l,variant:"destructive"}),n}}const hs=async()=>{var n;if(!Vs||!Vs.receiver||!Vs.amount){r({title:"بيانات غير مكتملة",description:"تأكد من إدخال رقم المستقبل والمبلغ قبل الإرسال",variant:"destructive"});return}const s=String(Vs.receiver),a=Math.round(Number(Vs.amount));lr(!0);try{if((n=Dn)!=null&&n.isNativePlatform&&Dn.getPlatform()==="android"){const c=ls==null?void 0:ls(),h=(c==null?void 0:c.phone)||"";if(!h){r({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),lr(!1);return}const x=Gc(h,s,a);if(!x){r({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),lr(!1);return}Su(x),r({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),ir(!1),Ar(!1);return}const l=window.electronAPI;if(l&&typeof l.sendUssd=="function"&&be){const c=ls==null?void 0:ls(),h=(c==null?void 0:c.phone)||"";if(!h){r({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),lr(!1);return}const x=await xt();if(!x){lr(!1);return}const g=Gc(h,s,a);if(!g){r({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),lr(!1);return}try{const D=typeof l.pickSimAutomatically=="function"?await l.pickSimAutomatically(x,h):{deviceId:x,slot:0},p=`${D.deviceId}:sim${D.slot}`;Cm(p),await l.sendUssd(p,g)}catch{try{await l.sendUssd(x,g)}catch(p){const w=x.includes(":")?x.split(":").slice(0,2).join(":"):"";if(w&&typeof l.connectWifi=="function")await l.connectWifi(w),await l.sendUssd(x,g);else throw p}}r({title:"تم إرسال كود التحويل",description:"تم التنفيذ بنجاح"}),ir(!1),Ar(!0)}else ns(s,a)}catch(l){const c=l&&l.message?l.message:"حدث خطأ غير متوقع أثناء الإرسال";r({title:"خطأ أثناء الإرسال",description:`الجهاز: ${Ao||be||"غير معروف"} — ${c}`,variant:"destructive"})}finally{lr(!1)}},Ot=async(s,a)=>{const n=window.electronAPI;try{if(n&&typeof n.enterPin=="function"&&s){await n.enterPin(s,a),Ar(!1);return}const l=String((j==null?void 0:j.bridgeLink)||"").trim(),c=String((j==null?void 0:j.bridgeDeviceId)||"").trim()||void 0;if(!l){r({title:"الرابط غير مُعدّ",description:"احفظ رابط الجسر أولاً",variant:"destructive"});return}const h=String((Vs==null?void 0:Vs.receiver)||gs||"").replace(/\D/g,""),x=Math.max(1,Math.round(Number((Vs==null?void 0:Vs.amount)||as||0))||0),g=String(a||"").replace(/\D/g,""),p=(w=>{let A=(w||"").trim();return A=A.replace(/\/+$/,""),/^https?:\/\//i.test(A)||(A=`https://${A}`),A})(l);Ar(!1)}catch(l){const c=(l==null?void 0:l.message)||"حدث خطأ أثناء إدخال الرقم السري";r({title:"فشل الإدخال",description:c,variant:"destructive"})}};console.log("🔥 UserDashboardPage - user:",t?"exists":"null");const[st,Ct]=i.useState(!0),[Jt,Os]=i.useState(!0),[is,Xt]=i.useState(!1),[Ca,Us]=i.useState(!1),[ga,us]=i.useState(""),[E,ge]=i.useState(""),[pe,Ee]=i.useState(""),[Be,yt]=i.useState([]),[vt,H]=i.useState(!1),[fe,Z]=i.useState(null),[dt,jt]=i.useState(""),[es,xs]=i.useState(!1),[Zs,ra]=i.useState(!1),[wr,Ms]=i.useState(!1),[Jr,Ia]=i.useState(!1),[z,we]=i.useState(""),[wt,pt]=i.useState(""),[ps,ts]=i.useState([]),[Kt,Wa]=i.useState(!1),[fa,Kr]=i.useState(0),[En,it]=i.useState(!1),[at,zs]=i.useState(null),[oo,On]=i.useState(!1),[qs,Ba]=i.useState(""),[gs,Ua]=i.useState(""),[as,d]=i.useState(""),[I,O]=i.useState(""),[X,K]=i.useState(""),[Ae,ze]=i.useState(!1),[Ue,Oe]=i.useState(""),[qe,xe]=i.useState(""),[It,Is]=i.useState(""),[Xs,ma]=i.useState(""),[fs,Aa]=i.useState(null),[As,Ta]=i.useState(!1),[Mn,Mi]=i.useState(!1),[Nr,jr]=i.useState(!1),[Rn,Sr]=i.useState(!1),[$n,Yr]=i.useState(null),[ys,Ri]=i.useState(""),[bs,$i]=i.useState(""),[co,am]=i.useState(""),[rm,Ln]=i.useState(!1),[lp,op]=i.useState(null),[na,mo]=i.useState(null),[nm,Li]=i.useState(!1);i.useEffect(()=>{(async()=>{try{const a=t!=null&&t.uid?`withdrawSenderNameInputEnabled_${t==null?void 0:t.uid}`:"withdrawSenderNameInputEnabled";let n=null;try{n=localStorage.getItem(a)??localStorage.getItem("withdrawSenderNameInputEnabled")}catch{}if(t!=null&&t.uid)try{const l=await Mr(()=>ve.getUserData(t.uid)),c=l==null?void 0:l.withdrawSenderNameInputEnabled;if(typeof c=="boolean"){Li(c);try{localStorage.setItem(a,c?"true":"false")}catch{}return}}catch{}Li(n==="true")}catch{Li(!1)}})()},[t==null?void 0:t.uid]);const Fn=s=>{const a="٠١٢٣٤٥٦٧٨٩",n="۰۱۲۳۴۵۶۷۸۹";return(s||"").split("").map(l=>{const c=a.indexOf(l);if(c>-1)return String(c);const h=n.indexOf(l);return h>-1?String(h):l}).join("")},[St,Fi]=i.useState(()=>{try{const s=localStorage.getItem("commissionMode")||localStorage.getItem("commissionMode_default");return s?s==="add":!0}catch{return!0}}),[le,ho]=i.useState("transfer"),[Ze,ya]=i.useState([]),[Pa,Wi]=i.useState("all"),[Tt,vs]=i.useState([]),Bi=nd({enabled:!!(t!=null&&t.uid),queryKey:["recentTransactions",t==null?void 0:t.uid,_||"main"],queryFn:async()=>{const{collection:s,query:a,where:n,orderBy:l,limit:c,getDocs:h}=await bt(async()=>{const{collection:B,query:J,where:ae,orderBy:Yt,limit:ws,getDocs:Ns}=await import("./index-tnWDkOuX.js").then(va=>va.c2);return{collection:B,query:J,where:ae,orderBy:Yt,limit:ws,getDocs:Ns}},__vite__mapDeps([0,1]),import.meta.url),{db:x}=await bt(async()=>{const{db:B}=await import("./index-tnWDkOuX.js").then(J=>J.c3);return{db:B}},__vite__mapDeps([0,1]),import.meta.url),g=a(s(x,"userTransactions"),n("userId","==",String((t==null?void 0:t.uid)||"")),l("createdAt","desc"),c(100)),w=(await h(g)).docs.map(B=>{var ia;const J=B.data(),ae=(ia=J.createdAt)!=null&&ia.toDate?J.createdAt.toDate():new Date(J.createdAt),Yt=String(J.transactionType||J.txnType||J.type||"").toLowerCase(),ws=Yt==="withdraw"||Yt==="receive"?"withdraw":"send",Ns=J.status==="confirmed"?"completed":J.status||"completed",va=J.senderMsisdn||J.senderPhone||"",Ka=J.receiverMsisdn||J.receiverPhone||"",wa=Number(J.amount??J.transferredAmount??J.withdrawnAmount??0);return{id:B.id,...J,type:ws,status:Ns,senderPhone:va,receiverPhone:Ka,amount:wa,createdAt:ae}}).filter(B=>!((B==null?void 0:B.type)==="report"||String((B==null?void 0:B.title)||"").includes("إيصال تسليم وردية"))),A=new Set((Gr||[]).map(B=>String(B.id||B.originalTransactionId||""))),T=w.filter(B=>!A.has(String(B.id||""))),P=B=>{var J;return String(B.transactionId||B.id||B.reference||((J=B.receipt)==null?void 0:J.reference)||`${new Date(B.createdAt).getTime()}`)},Q=new Set,$e=[];for(const B of T){const J=P(B);Q.has(J)||(Q.add(J),$e.push(B))}return $e},staleTime:6e4,gcTime:3e5,refetchOnWindowFocus:!1,refetchOnReconnect:!0});i.useEffect(()=>{const s=Bi.data;s&&Array.isArray(s)&&ya(s)},[Bi.data]),i.useEffect(()=>{try{if(localStorage.setItem("commissionMode",St?"add":"deduct"),t!=null&&t.uid){const s=`commissionMode_${t.uid}`;localStorage.setItem(s,St?"add":"deduct")}}catch{}},[St,t==null?void 0:t.uid]),i.useEffect(()=>{try{const s=new Set((Ze||[]).filter(l=>String((l==null?void 0:l.status)||"")==="completed"&&(l==null?void 0:l.linkedDebtId)).map(l=>String(l.linkedDebtId)));if(s.size===0)return;const a=Tt.map(l=>{if(s.has(String(l.id))){const c=Number(l.amount||0),h=Number(l.paidAmount||0);if(l.status!=="paid"||h<c)return{...l,status:"paid",paidAmount:c}}return l});if(a.some((l,c)=>l!==Tt[c])){vs(a),(async()=>await sa(a))();try{t!=null&&t.uid&&a.filter((c,h)=>c!==Tt[h]&&c.status==="paid").forEach(c=>{try{ur.send(t.uid,`تم سداد الدين بالكامل للعميل ${c.debtorName}: المدفوع ${Number(c.paidAmount||c.amount||0)} جنيه`)}catch{}})}catch{}}}catch{}},[Ze,Tt,t==null?void 0:t.uid]),i.useEffect(()=>{try{const s=t!=null&&t.uid?localStorage.getItem(`commissionMode_${t.uid}`):null,a=localStorage.getItem("commissionMode"),n=localStorage.getItem("commissionMode_default"),l=s??a??n;l&&Fi(l==="add")}catch{}},[t==null?void 0:t.uid]);const[Ui,Hr]=i.useState(!1),[im,lm]=i.useState(null),Wn=He.useRef(""),uo=He.useRef(0);i.useEffect(()=>{const s=a=>{var l;if(Ui)return;try{const c=document.activeElement;if(c){const h=(l=c.tagName)==null?void 0:l.toLowerCase();if(h==="input"||h==="textarea"||h==="select"||h==="button"||c.isContentEditable===!0)return}}catch{}const n=Date.now();if(a.key==="Enter"){const c=(Wn.current||"").trim();Wn.current="",c&&(lm(c),Hr(!0));return}a.key.length===1&&(n-(uo.current||0)>100&&(Wn.current=""),Wn.current+=a.key,uo.current=n)};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[Ui]);const[om,cm]=i.useState(!1),[dm,cp]=i.useState(null);i.useEffect(()=>{if(!Ae)return;const s=ls(),a=parseFloat(as||"0")||0;let n=0;if(le==="transfer"){if((s==null?void 0:s.defaultTransferCommission)!=null){const c=Number(s.defaultTransferCommission)||0;n=Math.round(c*a/1e3*100)/100}else{const c=bs&&bs.trim()!==""?parseFloat(bs):0;n=Math.max(0,c)}const l=a+n;xe((l||0).toString())}else{if((s==null?void 0:s.defaultWithdrawCommission)!=null){const c=Number(s.defaultWithdrawCommission)||0;n=Math.round(c*a/1e3*100)/100}else{const c=ys&&ys.trim()!==""?parseFloat(ys):Math.round(a*.01*100)/100;n=Math.max(0,c)}const l=St?a:Math.max(0,Math.round((a-n)*100)/100);xe((l||0).toString())}},[Ae,as,bs,ys,U,St,le]);const ls=()=>{var a,n;let s=Je.find(l=>l.id===U);if(!s)try{const l=localStorage.getItem(Al());if(l){const c=JSON.parse(l);if(Array.isArray(c)&&c.length>0){const x=localStorage.getItem(Or())||((a=c.find(g=>g.isDefault))==null?void 0:a.id)||((n=c[0])==null?void 0:n.id);s=c.find(g=>g.id===x)}}}catch{}return s};i.useLayoutEffect(()=>{try{const s=`wallets_${(t==null?void 0:t.uid)||"default"}`;let a=localStorage.getItem(s);if(!a){const n=Object.keys(localStorage).find(l=>l.startsWith("wallets_"));n&&(a=localStorage.getItem(n)||null)}if(a){const n=JSON.parse(a);if(Array.isArray(n)&&n.length>0){Dr(n);const l=localStorage.getItem(Or()),c=l&&n.find(h=>h.id===l)||n.find(h=>h.isDefault)||n[0];c&&(Et(c.id),Ba(c.phone))}}}catch(s){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",s)}},[]),i.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",U)},[U]),i.useEffect(()=>{fc()},[t==null?void 0:t.uid]),i.useEffect(()=>{yh()},[]);const[Je,Dr]=i.useState(()=>{try{const s=Object.keys(localStorage).find(n=>n.startsWith("wallets_")),a=s?localStorage.getItem(s):null;if(a){const n=JSON.parse(a);if(Array.isArray(n))return n}}catch{}return[]}),Bn=nd({enabled:!!(t!=null&&t.uid),queryKey:["wallets",t==null?void 0:t.uid],queryFn:async()=>{const{merchantWalletService:s}=await bt(async()=>{const{merchantWalletService:l}=await import("./index-tnWDkOuX.js").then(c=>c.c4);return{merchantWalletService:l}},__vite__mapDeps([0,1]),import.meta.url),a=await s.getByMerchantId(String((t==null?void 0:t.uid)||""));return(Array.isArray(a)?a:[]).filter(l=>l.isActive===!0).map(l=>({id:l.id,name:l.label||"محفظة بدون اسم",phone:l.msisdn,isDefault:!!l.isDefault,monthlyWithdrawalLimit:l.monthlyWithdrawalLimit??l.withdrawLimit??2e5,monthlyTransferLimit:l.monthlyTransferLimit??l.transferLimit??2e5,defaultTransferCommission:l.defaultTransferCommission!=null?Number(l.defaultTransferCommission):null,defaultWithdrawCommission:l.defaultWithdrawCommission!=null?Number(l.defaultWithdrawCommission):null}))},staleTime:6e4,gcTime:3e5,refetchOnReconnect:!0});i.useEffect(()=>{var a;const s=Bn.data;if(s&&Array.isArray(s)){Dr(s);const n=localStorage.getItem(Or());if(!!!(U&&s.find(c=>c.id===U))){const c=n&&s.find(h=>h.id===n)?n:((a=s[0])==null?void 0:a.id)||"";if(c){Et(c);const h=s.find(x=>x.id===c);Ba(String((h==null?void 0:h.phone)||""))}}}},[Bn.data]);const[xo,mm]=i.useState(""),po=(()=>{const s=xo.replace(/\D/g,"");return s?Je.filter(a=>(a.phone||"").replace(/\D/g,"").includes(s)):Je})(),[hm,dp]=i.useState(null),[um,go]=i.useState(!1),[xm,Un]=i.useState(!1),[pm,gm]=i.useState(null),[mp,fm]=i.useState([]),[hp,up]=i.useState([]),[ym,Qr]=i.useState(!1),[zi,fo]=i.useState("daily"),[Gr,Cr]=i.useState([]),[yo,bm]=i.useState(!1),za=He.useRef(new Set),bo=He.useRef(new Set),vo=He.useRef([]);i.useEffect(()=>{vo.current=Ze},[Ze]);const wo=async s=>{try{if(!t)return;const a=Ks(),n=Rs(),l=localStorage.getItem(a),c=localStorage.getItem(n);let h=l?parseFloat(l):Mt,x=c?JSON.parse(c):{...lt};const g=Number(s.withdrawnAmount??s.sentAmount??s.transferredAmount??s.amount??0);if(s.type==="send"&&(s.fromWallet||U)){h-=g;const w=s.fromWallet||U;x[w]=(x[w]||0)+g}else if(s.type==="withdraw"&&(s.fromWallet||U)){h+=g;const w=s.fromWallet||U;x[w]=Math.max(0,(x[w]||0)-g)}Qt(h),cs(x),localStorage.setItem(a,h.toString()),localStorage.setItem(n,JSON.stringify(x));const D={cashBalance:h,walletBalances:x,lastUpdated:new Date().toISOString()},p=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(p,JSON.stringify(D));try{await ve.updateUserData(t.uid,D),localStorage.removeItem(p),tt(!1)}catch(w){console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف (مزامنة تلقائية):",w),tt(!0)}try{const w=s.fromWallet||U,A=await la.getWalletLimits(t.uid,w);if(A){const T={...A};s.type==="send"?(T.dailyTransferUsed=Math.max(0,(A.dailyTransferUsed||0)-g),T.monthlyTransferUsed=Math.max(0,(A.monthlyTransferUsed||0)-g)):(T.dailyWithdrawUsed=Math.max(0,(A.dailyWithdrawUsed||0)-g),T.monthlyWithdrawUsed=Math.max(0,(A.monthlyWithdrawUsed||0)-g)),await la.updateWalletLimits(t.uid,w,T)}}catch(w){console.warn("تعذر تحديث حدود المحفظة بعد الحذف (مزامنة):",w)}try{Ps.removeTransactionEffects(s,t.uid)}catch(w){console.warn("تعذر تحديث التقارير بعد الحذف (مزامنة):",w)}}catch(a){console.warn("خطأ أثناء تطبيق تأثيرات الحذف محليًا:",a)}},vm=async s=>{try{const a=Ze.find(x=>x.id===s);if(!a||!t)return;const n=String(s),l=String((a==null?void 0:a.transactionId)||(a==null?void 0:a.reference)||""),c=za.current.has(n)||l&&za.current.has(l),h=Ze.filter(x=>x.id!==s);ya(h);try{await ve.removeUserTransaction(t.uid,s),await yn.permanentlyDeleteTransaction(s,t.uid)}catch(x){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",x)}if(!c){za.current.add(n),l&&za.current.add(l),await wo(a);try{t!=null&&t.uid&&ve.removeLocalReceiptById(t.uid,s)}catch{}}r({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),Un(!1)}catch(a){console.error("خطأ أثناء حذف الإيصال:",a),r({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},wm=async s=>{var a;try{const n=Ze.find(l=>l.id===s);if(!n||!t)return;try{const l=(a=at==null?void 0:at.subscription)==null?void 0:a.planType;if(l===Gs.ZERO){const{dailyOperationCountService:c}=await bt(async()=>{const{dailyOperationCountService:g}=await import("./dailyOperationCountService-BuoXgFag.js");return{dailyOperationCountService:g}},__vite__mapDeps([2,0,1]),import.meta.url),h=n.type==="send"?"transfer":"withdraw";if(!(await c.checkAndIncrement(t.uid,h,5)).allowed){r({title:"تم بلوغ حد باقة الزيرو",description:"مسموح بحد أقصى 5 تأكيدات يوميًا للتحويل/السحب. جرّب غدًا أو قم بالترقية.",variant:"destructive"});return}}else if(l===Gs.TAHWEELA){const{dailyOperationCountService:c}=await bt(async()=>{const{dailyOperationCountService:g}=await import("./dailyOperationCountService-BuoXgFag.js");return{dailyOperationCountService:g}},__vite__mapDeps([2,0,1]),import.meta.url),h=n.type==="send"?"transfer":"withdraw";if(!(await c.checkAndIncrementCombined(t.uid,h,40)).allowed){r({title:"تم بلوغ حد باقة تحويله",description:"هذه الباقة تسمح بحد أقصى 40 عملية تحويل/سحب يومياً.",variant:"destructive"});return}}}catch(l){console.warn("تعذر التحقق من حد التأكيد اليومي:",l)}await Wt(Ve(V,"userTransactions",s),{status:"completed",confirmedAt:new Date}),ya(l=>l.map(c=>c.id===s?{...c,status:"completed"}:c)),r({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),Un(!1)}catch(n){console.error("خطأ أثناء إكمال الإيصال:",n),r({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}};i.useEffect(()=>{if(t)try{const s=Ke(Ce(V,"deletedTransactions"),me("userId","==",t.uid)),a=Fs(s,n=>{n.docChanges().forEach(l=>{if(l.type!=="added")return;const c=l.doc.data(),h=String((c==null?void 0:c.originalTransactionId)||""),x=String((c==null?void 0:c.transactionId)||""),g=String((c==null?void 0:c.reference)||""),D=h||x||g||String(l.doc.id);D&&(za.current.has(D)||(za.current.add(D),ya(p=>{const w=p.find(T=>T.id===h);return w?((async()=>await wo(w))(),p.filter(T=>T.id!==h)):p})))})},n=>{console.warn("فشل الاشتراك في deletedTransactions:",n)});return()=>a()}catch(s){console.warn("تعذر إنشاء مستمع deletedTransactions:",s)}},[t==null?void 0:t.uid]),i.useEffect(()=>{if(t)try{const s=Ve(V,"users",t.uid),a=Fs(s,async n=>{if(!n.exists())return;const l=n.data();if(l!=null&&l.reportsData)try{await Ps.syncReportsDataFromFirebase(t.uid),fm(hn())}catch(c){console.warn("تعذر مزامنة reportsData من السحابة:",c)}},n=>{console.warn("فشل الاشتراك في users.reportsData:",n)});return()=>a()}catch(s){console.warn("تعذر إنشاء مستمع users.reportsData:",s)}},[t==null?void 0:t.uid]);const[No,Nm]=i.useState(""),jo=Jx(No,300),[zn,So]=i.useState(""),[qn,Do]=i.useState(""),[ka,xp]=i.useState(""),[qi,Ir]=i.useState(!1),[Co,Zr]=i.useState(!1),[jm,ir]=i.useState(!1),[os,Vi]=i.useState(null),[Vs,Sm]=i.useState(null),[Io,lr]=i.useState(!1),[Dm,Ar]=i.useState(!1),[Ao,Cm]=i.useState(""),[Im,Ji]=i.useState(!1),To=!1,[Am,Vn]=i.useState(!1),[Tm,Po]=i.useState(!1),[Pm,Jn]=i.useState(!1),[km,Kn]=i.useState(!1),[_m,Yn]=i.useState(!1),[Em,ko]=i.useState(!0),[Xr,Om]=i.useState(!1),[Mm,Hn]=i.useState(!1),[Rm,_o]=i.useState(!1),[Qn,$m]=i.useState(""),[Eo,Lm]=i.useState(!1),[Fm,Ki]=i.useState(!1),[Wm,Oo]=i.useState(()=>{try{const s=t!=null&&t.uid?`dailyReportsLockEnabled_${t==null?void 0:t.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(s)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[Bm,Yi]=i.useState(!1);i.useEffect(()=>{try{const s=t!=null&&t.uid?`dailyReportsLockEnabled_${t==null?void 0:t.uid}`:"dailyReportsLockEnabled",a=localStorage.getItem(s)??localStorage.getItem("dailyReportsLockEnabled");Oo(a==="true")}catch{}},[t==null?void 0:t.uid]);const[Um,Tr]=i.useState(!1),[zm,Hi]=i.useState(!1),[qm,Mo]=i.useState(()=>{try{const s=t==null?void 0:t.uid,a=s?`debtsPinRequired_${s}`:"debtsPinRequired";return(localStorage.getItem(a)??localStorage.getItem("debtsPinRequired"))==="true"}catch{return!1}}),[Vm,Ro]=i.useState(!1),[$o,Jm]=i.useState(null),[Qi,Lo]=i.useState(""),[Gi,Fo]=i.useState(""),[Zi,Wo]=i.useState(""),[Pr,Bo]=i.useState(null),[de,or]=i.useState(null),[Km,qa]=i.useState(!1),[Ym,en]=i.useState(!1),[cr,Uo]=i.useState(null),[zo,Xi]=i.useState(""),[Gn,qo]=i.useState(null),[pp,gp]=i.useState(!1),[Hm,el]=i.useState(!1),[Vo,tl]=i.useState(""),[sl,kr]=i.useState(!1),[Jo,al]=i.useState(1),Qm=Y?10:20,rl=He.useMemo(()=>Tt.slice(0,Jo*Qm),[Tt,Jo]);i.useEffect(()=>{sl&&al(1)},[sl]);const nl=async()=>{if(Pt){r({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}try{const s=await _s.hasMasterPin(t==null?void 0:t.uid);qm&&s?Hi(!0):Tr(!0)}catch{Tr(!0)}};i.useEffect(()=>{try{const s=t==null?void 0:t.uid,a=s?`debtsPinRequired_${s}`:"debtsPinRequired",n=localStorage.getItem(a)??localStorage.getItem("debtsPinRequired");(n==="true"||n==="false")&&Mo(n==="true")}catch{}},[t==null?void 0:t.uid]),i.useEffect(()=>{const s=()=>{try{rc()}catch{}};try{window.addEventListener("debtsUpdated",s)}catch{}return()=>{try{window.removeEventListener("debtsUpdated",s)}catch{}}},[t==null?void 0:t.uid,_,j==null?void 0:j.shopId]);const[Gm,il]=i.useState(!1),[ea,ll]=i.useState([]),[ol,Ko]=i.useState(""),[cl,Yo]=i.useState(""),[Zn,Ho]=i.useState(""),[Qo,Zm]=i.useState(""),[Xm,Xn]=i.useState(!1),[eh,Go]=i.useState(""),[Zo,dl]=i.useState(""),[Xo,ml]=i.useState(""),[th,ei]=i.useState(!1),[sh,hl]=i.useState(""),[ec,ul]=i.useState(""),[ah,_r]=i.useState(!1),[Va,ti]=i.useState(null),[Js,tn]=i.useState(null),[si,xl]=i.useState(""),[rh,Er]=i.useState(!1),[tc,ai]=i.useState(0),[ta,Ja]=i.useState(null),[dr,pl]=i.useState(""),[rt,gl]=i.useState(null),[sc,ac]=i.useState(""),sa=async s=>{try{const a=JSON.stringify(s);localStorage.setItem(an(),a);try{localStorage.setItem(pc(),a)}catch{}try{localStorage.setItem(gc(),Date.now().toString())}catch{}t!=null&&t.uid&&ve.updateUserData(t.uid,{debts:s}).then(()=>{try{localStorage.removeItem(`debts_unsynced_${t.uid}`)}catch{}}).catch(()=>{tt(!0);try{localStorage.setItem(`debts_unsynced_${t.uid}`,"true")}catch{}})}catch(a){console.error("خطأ في حفظ الديون:",a)}},rc=async()=>{try{const s=an(),a=pc(),n=gc(),l=localStorage.getItem(s),c=localStorage.getItem(a),h=localStorage.getItem(n),x=h?Number(h):0,g=p=>{if(!p)return null;try{const w=JSON.parse(p);return Array.isArray(w)?w.map(A=>{var T;return{...A,createdAt:(T=A.createdAt)!=null&&T.toDate?A.createdAt.toDate():new Date(A.createdAt),partialPayments:Array.isArray(A.partialPayments)?A.partialPayments.map(P=>{var Q;return{amount:Number(P.amount)||0,paidAt:(Q=P.paidAt)!=null&&Q.toDate?P.paidAt.toDate():new Date(P.paidAt)}}):[]}}):[]}catch(w){return console.warn("فشل في تحليل ديون localStorage:",w),null}};let D=g(l);if(!D||D.length===0){const p=g(c);if(p&&p.length>0){D=p,vs(p);try{localStorage.setItem(an(),JSON.stringify(p)),localStorage.removeItem(a)}catch(w){console.warn("تعذر ترحيل الديون محلياً من المفتاح الافتراضي:",w)}}}if(D&&D.length>0&&vs(D),t!=null&&t.uid)try{const p=`debts_unsynced_${t.uid}`,w=localStorage.getItem(p)==="true",A=await Na(Ve(V,"users",t.uid));if(A.exists()){const T=A.data(),P=T.debts&&Array.isArray(T.debts)?T.debts.map(B=>{var J;return{...B,amount:Number(B.amount||0),paidAmount:Number(B.paidAmount||0),createdAt:(J=B.createdAt)!=null&&J.toDate?B.createdAt.toDate():new Date(B.createdAt),partialPayments:Array.isArray(B.partialPayments)?B.partialPayments.map(ae=>{var Yt;return{amount:Number(ae.amount)||0,paidAt:(Yt=ae.paidAt)!=null&&Yt.toDate?ae.paidAt.toDate():new Date(ae.paidAt)}}):[]}}):[];if(!!T.debtsDeletedAt){vs([]);try{localStorage.setItem(s,JSON.stringify([])),localStorage.setItem(a,JSON.stringify([]))}catch{}return}if(((P==null?void 0:P.length)||0)>0){vs(P);try{localStorage.setItem(s,JSON.stringify(P))}catch{}}}else D&&D.length>0}catch(p){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",p)}}catch(s){console.error("خطأ في تحميل الديون:",s)}};i.useEffect(()=>{try{window.exportDebts=()=>{try{return JSON.stringify(Tt||[])}catch{return"[]"}},window.importDebts=async s=>{try{const a=JSON.parse(s);if(!Array.isArray(a))throw new Error("صيغة غير صحيحة — يجب أن تكون مصفوفة");return await sa(a),{ok:!0,count:a.length}}catch(a){return console.error("فشل استيراد الديون:",a),{ok:!1,error:String(a)}}},window.fixWalletsForCurrentUser=async s=>{try{if(!(t!=null&&t.uid))throw new Error("يجب تسجيل الدخول أولاً");return await(await bt(async()=>{const{merchantWalletService:n}=await import("./index-tnWDkOuX.js").then(l=>l.c4);return{merchantWalletService:n}},__vite__mapDeps([0,1]),import.meta.url)).merchantWalletService.reassignByMsisdns(s,t.uid)}catch(a){return console.error("فشل إصلاح المحافظ للمستخدم الحالي:",a),{updated:0,failed:(s==null?void 0:s.length)||0,error:String(a)}}}}catch{}},[Tt,t==null?void 0:t.uid]),i.useEffect(()=>{if(!(t!=null&&t.uid))return;const s=Ve(V,"users",t.uid),a=Fs(s,n=>{if(!n.exists())return;const l=n.data(),c=Array.isArray(l==null?void 0:l.debts)?l.debts:[];try{const h=c.map(x=>{var g;return{...x,createdAt:(g=x.createdAt)!=null&&g.toDate?x.createdAt.toDate():new Date(x.createdAt),partialPayments:Array.isArray(x.partialPayments)?x.partialPayments.map(D=>{var p;return{amount:Number(D.amount)||0,paidAt:(p=D.paidAt)!=null&&p.toDate?D.paidAt.toDate():new Date(D.paidAt)}}):[]}});vs(h);try{localStorage.setItem(an(),JSON.stringify(h))}catch{}}catch(h){console.warn("تعذر تحليل الديون من التحديثات الحية:",h)}},n=>{console.warn("خطأ في الاشتراك الحي لديون المستخدم:",n)});return()=>a()},[t==null?void 0:t.uid]);const nh=async()=>{if(t!=null&&t.uid)try{On(!0);const s=await no(t.uid);zs(s)}catch(s){console.error("خطأ في جلب بيانات الاشتراك:",s)}finally{On(!1)}},[fp,yp]=i.useState(!1),[ih,fl]=i.useState(!1),[Mt,Qt]=i.useState(0),[lt,cs]=i.useState({}),[lh,nc]=i.useState(!1),[oh,ic]=i.useState(!1),[ch,yl]=i.useState(!1),[dh,ri]=i.useState(!1),[lc,bl]=i.useState(""),[mh,sn]=i.useState(!1),[hh,ni]=i.useState(!1),[vl,ii]=i.useState(""),[uh,wl]=i.useState(!1),[li,oc]=i.useState(""),[oi,cc]=i.useState(""),[ci,dc]=i.useState(""),[mc,hc]=i.useState(!1),[Nl,jl]=i.useState(!1),[xh,uc]=i.useState(!1),[xc,ph]=i.useState([]);i.useEffect(()=>{(async()=>{try{if(!(t!=null&&t.uid)||!Nl)return;try{await pn.trimToMaxCount(t.uid,30)}catch{}const s=await pn.getByUser(t.uid,30);ph(s)}catch{}})()},[t==null?void 0:t.uid,Nl]);const Rs=()=>{const s=_||(j==null?void 0:j.shopId)||"main";return`walletBalances_${(t==null?void 0:t.uid)||"default"}_${s}`},Ks=()=>{const s=_||(j==null?void 0:j.shopId)||"main";return`cashBalance_${(t==null?void 0:t.uid)||"default"}_${s}`},an=()=>{const s=_||(j==null?void 0:j.shopId)||"main";return`debts_${(t==null?void 0:t.uid)||"default"}_${s}`},gh=()=>{const s=_||(j==null?void 0:j.shopId)||"main";return`customers_${(t==null?void 0:t.uid)||"default"}_${s}`},pc=()=>`debts_default_${_||(j==null?void 0:j.shopId)||"main"}`,gc=()=>{const s=_||(j==null?void 0:j.shopId)||"main";return`debts_last_write_${(t==null?void 0:t.uid)||"default"}_${s}`},Sl=()=>`shopExpenses_${_||(j==null?void 0:j.shopId)||(t==null?void 0:t.uid)||"default"}`,fc=()=>{try{const s=localStorage.getItem(Sl());if(s){const a=JSON.parse(s);yt(a.map(n=>({...n,createdAt:new Date(n.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",s)}},yc=async s=>{try{localStorage.setItem(Sl(),JSON.stringify(s)),yt(s)}catch(a){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",a)}},fh=async s=>{try{const a=Be.filter(n=>n.id!==s);await yc(a);try{if(t!=null&&t.uid&&s){const{doc:n,deleteDoc:l}=await bt(async()=>{const{doc:x,deleteDoc:g}=await import("./index-tnWDkOuX.js").then(D=>D.c2);return{doc:x,deleteDoc:g}},__vite__mapDeps([0,1]),import.meta.url),{db:c}=await bt(async()=>{const{db:x}=await import("./index-tnWDkOuX.js").then(g=>g.c3);return{db:x}},__vite__mapDeps([0,1]),import.meta.url),h=n(c,"shop_expenses",s);await l(h)}}catch(n){console.warn("تعذر حذف المصروف من السحابة الآن، تم الحذف محليًا وسيبقى مخزّنًا دون هذا الإيصال:",n)}r({title:"تم الحذف",description:"تم حذف إيصال المصروف نهائيًا."})}catch(a){console.error("خطأ أثناء الحذف النهائي لإيصال المصروف:",a),r({title:"فشل الحذف",description:"تعذر حذف الإيصال. حاول مرة أخرى.",variant:"destructive"})}};He.useEffect(()=>{let s;return(async()=>{try{if(!(t!=null&&t.uid)){fc();return}const{collection:a,query:n,where:l,onSnapshot:c}=await bt(async()=>{const{collection:D,query:p,where:w,onSnapshot:A}=await import("./index-tnWDkOuX.js").then(T=>T.c2);return{collection:D,query:p,where:w,onSnapshot:A}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await bt(async()=>{const{db:D}=await import("./index-tnWDkOuX.js").then(p=>p.c3);return{db:D}},__vite__mapDeps([0,1]),import.meta.url),x=_||(j==null?void 0:j.shopId),g=x?n(a(h,"shop_expenses"),l("shopId","==",x)):n(a(h,"shop_expenses"),l("userId","==",t.uid));s=c(g,async D=>{const w=D.docs.map(A=>{var Q;const T=A.data(),P=(Q=T.createdAt)!=null&&Q.toDate?T.createdAt.toDate():T.createdAt?new Date(T.createdAt):new Date;return{id:A.id,name:String(T.name||""),amount:Number(T.amount||0),notes:T.notes?String(T.notes):void 0,source:T.source==="wallet"?"wallet":"cash",walletId:T.walletId?String(T.walletId):void 0,createdAt:P}}).sort((A,T)=>T.createdAt.getTime()-A.createdAt.getTime());yt(w);try{localStorage.setItem(Sl(),JSON.stringify(w))}catch{}})}catch(a){console.error("خطأ في مزامنة مصروفات المحل من Firestore:",a)}})(),()=>s==null?void 0:s()},[t==null?void 0:t.uid,j==null?void 0:j.shopId,_]);const di=()=>`deficiencies_${_||(j==null?void 0:j.shopId)||(t==null?void 0:t.uid)||"default-shop"}`,yh=()=>{try{const s=di(),a=`deficiencies_${(t==null?void 0:t.uid)||"default"}`;if(a!==s){const l=localStorage.getItem(a),c=localStorage.getItem(s);if(l)try{const h=JSON.parse(l)||[],x=c?JSON.parse(c):[],g=Array.isArray(x)?[...x]:[],D=(p,w)=>p.some(A=>(A==null?void 0:A.id)&&(w==null?void 0:w.id)&&String(A.id)===String(w.id)||String((A==null?void 0:A.name)||"")===String((w==null?void 0:w.name)||"")&&String((A==null?void 0:A.status)||"pending")===String((w==null?void 0:w.status)||"pending"));if(Array.isArray(h))for(const p of h)D(g,p)||g.push(p);localStorage.setItem(s,JSON.stringify(g));try{localStorage.removeItem(a)}catch{}}catch{}}const n=localStorage.getItem(s);if(n){const l=JSON.parse(n);ts(l.map(c=>({...c,createdAt:new Date(c.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل النواقص من التخزين:",s)}},Dl=async s=>{try{localStorage.setItem(di(),JSON.stringify(s)),ts(s)}catch(a){console.error("خطأ أثناء حفظ النواقص في التخزين:",a)}};He.useEffect(()=>{let s;return(async()=>{try{if(!(t!=null&&t.uid))return;const{collection:a,query:n,where:l,orderBy:c,onSnapshot:h}=await bt(async()=>{const{collection:p,query:w,where:A,orderBy:T,onSnapshot:P}=await import("./index-tnWDkOuX.js").then(Q=>Q.c2);return{collection:p,query:w,where:A,orderBy:T,onSnapshot:P}},__vite__mapDeps([0,1]),import.meta.url),{db:x}=await bt(async()=>{const{db:p}=await import("./index-tnWDkOuX.js").then(w=>w.c3);return{db:p}},__vite__mapDeps([0,1]),import.meta.url),g=_||(j==null?void 0:j.shopId)||t.uid||"default-shop",D=n(a(x,"deficiencies"),l("shopId","==",g),c("createdAt","desc"));s=h(D,async p=>{const w=p.docs.map(A=>{var Q;const T=A.data(),P=(Q=T.createdAt)!=null&&Q.toDate?T.createdAt.toDate():T.createdAt?new Date(T.createdAt):new Date;return{id:A.id,name:String(T.name||""),quantity:Number(T.quantity||1),status:T.status==="purchased"?"purchased":"pending",createdAt:P}});ts(w);try{localStorage.setItem(di(),JSON.stringify(w))}catch{}},p=>{console.warn("فشل الاشتراك في النواقص من Firestore:",p)})}catch(a){console.warn("فشل إعداد مزامنة النواقص من Firestore:",a)}})(),()=>{try{s&&s()}catch{}}},[t==null?void 0:t.uid,j==null?void 0:j.shopId,_]);const Cl=async s=>{try{localStorage.setItem(gh(),JSON.stringify(s)),ll(s),t!=null&&t.uid&&await ve.updateUserData(t.uid,{customers:s})}catch(a){console.error("خطأ أثناء حفظ العملاء في التخزين:",a)}},bh=async()=>{try{if(t!=null&&t.uid){const s=await Na(Ve(V,"users",t.uid));if(s.exists()){const a=s.data();if(a.customers&&Array.isArray(a.customers)){const n=a.customers.map(l=>{var c;return{...l,createdAt:(c=l.createdAt)!=null&&c.toDate?l.createdAt.toDate():new Date(l.createdAt)}});ll(n);return}}}ll([])}catch(s){console.error("خطأ أثناء تحميل العملاء من Firestore:",s)}},Il=()=>{const s=_||(j==null?void 0:j.shopId)||"main";return`transactions_${(t==null?void 0:t.uid)||"default"}_${s}`},Al=()=>{const s=_||(j==null?void 0:j.shopId)||"main";return`wallets_${(t==null?void 0:t.uid)||"default"}_${s}`},Or=()=>{const s=_||(j==null?void 0:j.shopId)||"main";return`selectedWallet_${(t==null?void 0:t.uid)||"default"}_${s}`};i.useEffect(()=>{let s;return(async()=>{try{if(!(t!=null&&t.uid))return;const{collection:a,query:n,where:l,orderBy:c,limit:h,onSnapshot:x}=await bt(async()=>{const{collection:p,query:w,where:A,orderBy:T,limit:P,onSnapshot:Q}=await import("./index-tnWDkOuX.js").then($e=>$e.c2);return{collection:p,query:w,where:A,orderBy:T,limit:P,onSnapshot:Q}},__vite__mapDeps([0,1]),import.meta.url),{db:g}=await bt(async()=>{const{db:p}=await import("./index-tnWDkOuX.js").then(w=>w.c3);return{db:p}},__vite__mapDeps([0,1]),import.meta.url),D=n(a(g,"userTransactions"),l("userId","==",t.uid),c("createdAt","desc"),h(100));s=x(D,p=>{yo||bm(!0);const A=p.docs.map(J=>{var ia;const ae=J.data(),Yt=(ia=ae.createdAt)!=null&&ia.toDate?ae.createdAt.toDate():new Date(ae.createdAt),ws=ae.txnType==="send"?"send":ae.txnType==="receive"?"withdraw":ae.type||"withdraw",Ns=ae.status==="confirmed"?"completed":ae.status||"completed",va=ae.senderMsisdn||ae.senderPhone||"",Ka=ae.receiverMsisdn||ae.receiverPhone||"",wa=Number(ae.amount??ae.transferredAmount??ae.withdrawnAmount??0);return{id:J.id,...ae,type:ws,status:Ns,senderPhone:va,receiverPhone:Ka,amount:wa,createdAt:Yt}}).filter(J=>!((J==null?void 0:J.type)==="report"||String((J==null?void 0:J.title)||"").includes("إيصال تسليم وردية"))),T=new Set((Gr||[]).map(J=>String(J.id||J.originalTransactionId||""))),P=A.filter(J=>!T.has(String(J.id||""))),Q=J=>{var ae;return String(J.transactionId||J.id||J.reference||((ae=J.receipt)==null?void 0:ae.reference)||`${new Date(J.createdAt).getTime()}`)},$e=new Set,B=[];for(const J of P){const ae=Q(J);$e.has(ae)||($e.add(ae),B.push(J))}ya(B)})}catch{}})(),()=>{try{s&&s()}catch{}}},[t==null?void 0:t.uid,Gr.length]),i.useEffect(()=>{if(!(t!=null&&t.uid))return;let s=null;return(async()=>{try{const{collection:a,query:n,where:l,onSnapshot:c}=await bt(async()=>{const{collection:g,query:D,where:p,onSnapshot:w}=await import("./index-tnWDkOuX.js").then(A=>A.c2);return{collection:g,query:D,where:p,onSnapshot:w}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await bt(async()=>{const{db:g}=await import("./index-tnWDkOuX.js").then(D=>D.c3);return{db:g}},__vite__mapDeps([0,1]),import.meta.url),x=n(a(h,"deletedTransactions"),l("userId","==",t.uid));s=c(x,g=>{try{g.docChanges().forEach(p=>{const w=p.doc.data(),A=[w.originalTransactionId,w.transactionId,w.reference,p.doc.id].filter(Boolean).map(Q=>String(Q));if(A.find(Q=>bo.current.has(Q)))return;const P=vo.current.find(Q=>{const $e=String(Q.id||""),B=String(Q.transactionId||""),J=String(Q.reference||"");return A.includes($e)||A.includes(B)||A.includes(J)});if(P){const Q=P.fromWallet||U||"",$e=Number(P.withdrawnAmount??P.sentAmount??P.amount??0),B=P.type==="send"?"transfer":"withdraw";Q&&$e>0&&(la.rollbackUsage(Q,$e,B).catch(()=>{}),A.forEach(J=>bo.current.add(J)))}});const D=g.docs.map(p=>{var T;const w=p.data(),A=(T=w.createdAt)!=null&&T.toDate?w.createdAt.toDate():new Date(w.createdAt||Date.now());return{id:p.id,...w,createdAt:A}});Cr(D),(async()=>{try{const p=_||(j==null?void 0:j.shopId);if(!p)return;const w=Ve(h,"dashboardData",p),A=await Na(w);if(A.exists()){const T=A.data();typeof T.cashBalance=="number"&&Qt(Number(T.cashBalance||0)),T.walletBalances&&typeof T.walletBalances=="object"&&cs(T.walletBalances||{})}}catch{}})()}catch{}},g=>{console.warn("deletedTransactions subscription error (Dashboard):",g)})}catch{}})(),()=>{try{s&&s()}catch{}}},[t==null?void 0:t.uid]);const[Tl,mi]=i.useState(""),[Ys,bc]=i.useState(""),ba=He.useMemo(()=>{const s=at;if(!s)return!1;const a=vu(s),n=s.planType??s.plan??null,l=typeof n=="string"?n.toLowerCase():null,c=l==="monthly"||l==="quarterly"||l==="yearly"||l==="lifetime"||n===Gs.MONTHLY||n===Gs.QUARTERLY||n===Gs.YEARLY||n===Gs.LIFETIME;return a&&c},[at]),Pt=He.useMemo(()=>{var l,c;const s=at;if(!s)return!1;const a=((l=s.subscription)==null?void 0:l.planType)??((c=s.subscription)==null?void 0:c.plan)??s.planType??s.plan??null,n=typeof a=="string"?a.toLowerCase():null;return a===Gs.ZERO||n==="zero"},[at]),zt=He.useMemo(()=>{var l,c;const s=at;if(!s)return!1;const a=((l=s.subscription)==null?void 0:l.planType)??((c=s.subscription)==null?void 0:c.plan)??s.planType??s.plan??null,n=typeof a=="string"?String(a).trim().toLowerCase():null;return a===Gs.TAHWEELA||n==="tahweela"||n==="تحويله"},[at]),vh=()=>{if(!ba){r({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}ce(!0)},[bp,vp]=i.useState(!1),[wh,Nh]=i.useState(!1),[jh,Sh]=i.useState(!1),[Dh,Ch]=i.useState(!1),[Ih,rn]=i.useState(!1),[mr,hi]=i.useState(""),[nn,ui]=i.useState(""),[vc,xi]=i.useState(!1),[ln,on]=i.useState(null),[Pl,pi]=i.useState(""),[Ah,wc]=i.useState(!1),[wp,Np]=i.useState(!1),[Th,gi]=i.useState(!1),[Nc,kl]=i.useState(""),[jc,_l]=i.useState(""),[Sc,Dc]=i.useState(!1),Cc=async()=>{var s;if(t!=null&&t.uid)try{const a=`userData_${t.uid}`,n=localStorage.getItem(a),l=`debts_unsynced_${t.uid}`,c=localStorage.getItem(an()),h=localStorage.getItem(l)==="true";if(n){const x=JSON.parse(n);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",x);const g={lastSynced:new Date().toISOString()};typeof x.cashBalance=="number"&&(g.cashBalance=x.cashBalance),x.walletBalances&&typeof x.walletBalances=="object"&&(g.walletBalances=x.walletBalances),await ve.updateUserData(t.uid,g),localStorage.removeItem(a),tt(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة");if(h&&c)try{const x=JSON.parse(c)||[],g=B=>B instanceof Date?B:typeof(B==null?void 0:B.toDate)=="function"?B.toDate():B?new Date(String(B)):new Date,D=B=>(Array.isArray(B)?B:[]).map(J=>({...J,amount:Number(J.amount||0),paidAmount:Number(J.paidAmount||0),createdAt:g(J.createdAt),partialPayments:Array.isArray(J.partialPayments)?J.partialPayments.map(ae=>({amount:Number(ae.amount||0),paidAt:g(ae.paidAt)})):[]})),p=await Na(Ve(V,"users",t.uid)),w=p.exists()?((s=p.data())==null?void 0:s.debts)||[]:[],A=D(w),T=D(x),P={};for(const B of A)P[String(B.id||"")]=B;const Q=[],$e=new Set;for(const B of T){const J=String(B.id||""),ae=P[J];if(ae){const Yt=Number(ae.paidAmount||0)+(Array.isArray(ae.partialPayments)?ae.partialPayments.reduce((wa,ia)=>wa+Number(ia.amount||0),0):0),ws=Number(B.paidAmount||0)+(Array.isArray(B.partialPayments)?B.partialPayments.reduce((wa,ia)=>wa+Number(ia.amount||0),0):0),Ns=String(ae.status||"pending"),va=String(B.status||"pending"),Ka=Ns==="paid"||Yt>=Number(ae.amount||0)?ae:va==="paid"?{...ae,paidAmount:Number(B.paidAmount||0),partialPayments:B.partialPayments,status:"paid"}:ws>Yt?{...ae,paidAmount:Number(B.paidAmount||0),partialPayments:B.partialPayments,status:ws>=Number(ae.amount||0)?"paid":"pending"}:ae;Q.push(Ka),$e.add(J)}else Q.push(B),$e.add(J)}for(const B of A){const J=String(B.id||"");$e.has(J)||Q.push(B)}await ve.updateUserData(t.uid,{debts:Q});try{localStorage.removeItem(l)}catch{}tt(!1)}catch{tt(!0)}}catch(a){console.error("❌ فشل في مزامنة البيانات:",a),r({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},[Ic,fi]=i.useState({keepLastCount:30,intervalDays:7,lastResetAt:null});i.useEffect(()=>{(async()=>{if(t!=null&&t.uid)try{const a=await ve.getUserData(t.uid),n=(a==null?void 0:a.recentReset)||{},l=Number(n==null?void 0:n.keepLastCount)>0?Number(n.keepLastCount):30,c=Number(n==null?void 0:n.intervalDays)>0?Number(n.intervalDays):7,h=p=>p instanceof Date?p:typeof(p==null?void 0:p.toDate)=="function"?p.toDate():p?new Date(String(p)):null,x=n!=null&&n.lastResetAt?h(n.lastResetAt):null,g=new Date;!x||g.getTime()-x.getTime()>=c*24*60*60*1e3?(await ve.updateUserData(t.uid,{recentReset:{keepLastCount:l,intervalDays:c,lastResetAt:g}}),fi({keepLastCount:l,intervalDays:c,lastResetAt:g})):fi({keepLastCount:l,intervalDays:c,lastResetAt:x})}catch{fi({keepLastCount:30,intervalDays:7,lastResetAt:null})}})()},[t==null?void 0:t.uid]);const Ac=He.useMemo(()=>{const s=Ze||[],a=x=>x instanceof Date?x:typeof(x==null?void 0:x.toDate)=="function"?x.toDate():new Date(String(x)),n=new Date,l=new Date(n.getFullYear(),n.getMonth(),1),c=new Date(n.getFullYear(),n.getMonth()+1,1);return[...s].sort((x,g)=>a(g.createdAt).getTime()-a(x.createdAt).getTime()).filter(x=>{const g=a(x.createdAt);return g>=l&&g<c})},[Ze]),Ph=He.useMemo(()=>{const s=Ze||[],a=x=>x instanceof Date?x:typeof(x==null?void 0:x.toDate)=="function"?x.toDate():new Date(String(x)),n=new Date,l=new Date(n.getFullYear(),n.getMonth(),1),c=new Date(n.getFullYear(),n.getMonth()+1,1),h=s.filter(x=>{const g=a(x.createdAt);return g>=l&&g<c}).length;return Math.max(0,((Ze==null?void 0:Ze.length)||0)-h)},[Ze==null?void 0:Ze.length]),yi=He.useMemo(()=>{const s=new Date,a=new Date(s.getFullYear(),s.getMonth(),1),n=new Date(s.getFullYear(),s.getMonth()+1,1),l={};for(const h of Ze){const x=new Date(h.createdAt||0);if(!(x>=a&&x<n))continue;const g=String(h.type||h.txnType||"").toLowerCase();if(!(g==="send"||g==="withdraw"||g==="transfer"))continue;const D=String(h.receiverPhone||h.senderPhone||"").trim();if(!D)continue;const p=Es(D),w=Number(h.amount||h.withdrawnAmount||h.sentAmount||0)||0;l[p]||(l[p]={phone:p,count:0,total:0}),l[p].count+=1,l[p].total+=w}return Object.values(l).sort((h,x)=>x.count!==h.count?x.count-h.count:x.total-h.total).slice(0,10)},[Ze]),kh=s=>{const a=Es(String(s));return a.startsWith("+20")?"20"+a.slice(3):a.startsWith("0")?"20"+a.slice(1):a.replace(/[^0-9]/g,"")},_h=s=>{const a=kh(s.phone),n=`عميل VIP هذا الشهر
عدد العمليات: ${s.count}
الإجمالي: ${s.total} جنيه`,l=`https://wa.me/${a}?text=${encodeURIComponent(n)}`;try{window.open(l,"_blank")}catch{}};i.useEffect(()=>{(async()=>{try{if(!(t!=null&&t.uid))return;const s=`${new Date().getFullYear()}-${new Date().getMonth()+1}`;await ve.updateUserData(t.uid,{vipTop10:yi,vipMonthTag:s})}catch{}})()},[t==null?void 0:t.uid,yi]);async function Eh(){const s=new Date,a=new Intl.DateTimeFormat("ar-EG",{timeZone:"Africa/Cairo",year:"numeric",month:"2-digit",day:"2-digit"}).format(s),n=new Date(s.getFullYear(),s.getMonth(),s.getDate(),0,0,0,0),l=new Date(s.getFullYear(),s.getMonth(),s.getDate(),23,59,59,999),c=(Ze||[]).filter(P=>{const Q=new Date(P.createdAt||0);return Q>=n&&Q<=l}),h=c.length,x=c.filter(P=>String(P.type||P.txnType||"").toLowerCase()==="withdraw"||String(P.type||"").toLowerCase()==="receive").reduce((P,Q)=>P+(Q.withdrawnAmount!=null?Number(Q.withdrawnAmount):Number(Q.amount||0)),0),g=c.filter(P=>String(P.type||P.txnType||"").toLowerCase()==="send"||String(P.type||"").toLowerCase()==="transfer").reduce((P,Q)=>P+(Q.sentAmount!=null?Number(Q.sentAmount):Number(Q.amount||0)),0);let D=0;try{D=c.reduce((P,Q)=>P+Ps.calculateTransactionProfit(Q),0)}catch{}let p=0;try{const P=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(s),Q=Ke(Ce(V,"dailySales"),me("userId","==",(t==null?void 0:t.uid)||""));p=(await et(Q)).docs.map(J=>J.data()).filter(J=>String(J.date||P)===P).reduce((J,ae)=>J+Number(ae.sellingPrice||ae.price||0)*Number(ae.quantity||1),0)}catch{}let w=0;try{w=(Tt||[]).filter(Q=>String(Q.status||"")==="pending").reduce((Q,$e)=>{const B=Number($e.paidAmount||0)+(Array.isArray($e.partialPayments)?$e.partialPayments:[]).reduce((J,ae)=>J+Number(ae.amount||0),0);return Q+Math.max(0,Number($e.amount||0)-B)},0)}catch{}let A="";try{const P=_||(j==null?void 0:j.shopId)||null,Q=P?Ke(Ce(V,"deficiencies"),me("shopId","==",P)):Ke(Ce(V,"deficiencies"),me("userId","==",(t==null?void 0:t.uid)||""));A=(await et(Q)).docs.map(ae=>ae.data()).filter(ae=>String(ae.status||"pending")==="pending").slice(0,10).map((ae,Yt)=>`${Yt+1}- ${String(ae.name||ae.productName||"عنصر")} × ${Number(ae.quantity||ae.qty||0)}`).join(`
`)}catch{}return[`تقرير يومي - ${a}`,`عدد العمليات: ${h}`,`إجمالي المسحوبات: ${x} جنيه`,`إجمالي الإرسال: ${g} جنيه`,`الأرباح: ${D} جنيه`,`إجمالي مبيعات الاكسسوار: ${p} جنيه`,`إجمالي الديون: ${w} جنيه`,"نواقص الاكسسوار:",A||"لا توجد عناصر مسجلة"].join(`
`)}const Tc=He.useCallback(()=>{let s=Ac;const a=jo.trim();if(a&&(s=s.filter(n=>{const l=n;return String(l.type||"").toLowerCase()==="cash_addition"||String(l.txnType||"").toLowerCase()==="cash_addition"||String(l.title||"").includes("إيصال إضافة نقدية")?!0:n.senderPhone&&n.senderPhone.includes(a)||n.receiverPhone&&n.receiverPhone.includes(a)})),zn){const n=new Date(zn);s=s.filter(l=>{const c=new Date(l.createdAt);if(qn){const[h,x]=qn.split(":"),g=new Date(n);g.setHours(parseInt(h),parseInt(x),0,0);const D=new Date(g);return D.setHours(D.getHours()+1),c>=g&&c<D}else return c.toDateString()===n.toDateString()})}try{s=[...s].sort((n,l)=>{const c=new Date(n.createdAt||0).getTime();return new Date(l.createdAt||0).getTime()-c})}catch{}return s},[Ac,jo,zn,qn]),[Oh,bi]=i.useState(!1),[Pc,vi]=i.useState(""),[Mh,wi]=i.useState(!1),[El,Ol]=i.useState(""),[Rh,tt]=i.useState(!1),Mr=async(s,a=2,n=700)=>{let l;for(let c=0;c<=a;c++)try{return await s()}catch(h){if(l=h,c===a)break;await new Promise(x=>setTimeout(x,n*Math.pow(2,c)))}throw l};Je.reduce((s,a)=>s+(lt[a.id]||0),0);const $h=async s=>await _s.verifyMasterPin(s,t==null?void 0:t.uid),Ni=async s=>await _s.verifyMasterPin(s,t==null?void 0:t.uid);i.useEffect(()=>{if(t!=null&&t.uid){try{const s=Rs(),a=`walletBalances_${t.uid}`,n=localStorage.getItem(s)??localStorage.getItem(a);if(n){const l=JSON.parse(n);cs(l&&typeof l=="object"?l:{});try{localStorage.setItem(s,JSON.stringify(l||{}))}catch{}}}catch{}try{const s=Ks(),a=`cashBalance_${t.uid}`,n=`userCashBalance_${t.uid}`;let l=localStorage.getItem(s)??localStorage.getItem(a)??localStorage.getItem(n);if(l!=null){const c=parseFloat(l);Qt(Number.isFinite(c)?c:0);try{localStorage.setItem(s,String(Number.isFinite(c)?c:0)),localStorage.removeItem(a),localStorage.removeItem(n)}catch{}}}catch{}}},[t==null?void 0:t.uid,_,j==null?void 0:j.shopId]),i.useEffect(()=>{const s=a=>{var n;try{const l=Number((n=a==null?void 0:a.detail)==null?void 0:n.value);if(Number.isFinite(l))Qt(l);else{const c=localStorage.getItem(Ks());c!=null&&Qt(parseFloat(c)||0)}}catch{const l=localStorage.getItem(Ks());l!=null&&Qt(parseFloat(l)||0)}};return window.addEventListener("cashBalanceChanged",s),()=>window.removeEventListener("cashBalanceChanged",s)},[t==null?void 0:t.uid,_,j==null?void 0:j.shopId]),i.useEffect(()=>{try{if(!(t!=null&&t.uid))return;const s=_||(j==null?void 0:j.shopId);if(!s)return;const a=Ve(V,"dashboardData",s);let n=null;return n=Fs(a,l=>{if(!l.exists())return;const c=l.data(),h=Number((c==null?void 0:c.cashBalance)||0),x=c!=null&&c.walletBalances&&typeof c.walletBalances=="object"?c.walletBalances:{};Qt(h),cs(x);try{localStorage.setItem(Ks(),String(h)),localStorage.setItem(Rs(),JSON.stringify(x))}catch{}},l=>{console.warn("dashboardData subscription error:",l)}),()=>{try{n&&n()}catch{}}}catch{}},[t==null?void 0:t.uid,_,j==null?void 0:j.shopId]);const kc=s=>`walletLimits_${(t==null?void 0:t.uid)||"default"}_${s||"none"}`;i.useEffect(()=>{if(!U)return;try{const n=kc(U),l=localStorage.getItem(n);if(l){const c=JSON.parse(l);gl(c)}}catch{}const s=Ve(V,"walletLimits",String(U));let a=null;try{a=Fs(s,n=>{if(!n.exists())return;const l=n.data(),c={walletId:U,dailyTransferLimit:l.dailyTransferLimit??6e4,dailyWithdrawLimit:l.dailyWithdrawLimit??1e5,dailyTransferUsed:l.dailyTransferUsed??0,dailyWithdrawUsed:l.dailyWithdrawUsed??0,monthlyTransferLimit:l.monthlyTransferLimit??2e5,monthlyWithdrawLimit:l.monthlyWithdrawLimit??2e5,monthlyTransferUsed:l.monthlyTransferUsed??0,monthlyWithdrawUsed:l.monthlyWithdrawUsed??0};gl(c);try{localStorage.setItem(kc(U),JSON.stringify(c))}catch{}})}catch{}return()=>{a&&a()}},[U]),i.useEffect(()=>{if(!U)return;const s=Je.find(a=>a.id===U);if(s!=null&&s.name){ac(String(s.name));try{localStorage.setItem(`walletName_${(t==null?void 0:t.uid)||"default"}_${U}`,String(s.name))}catch{}return}try{const a=localStorage.getItem(`walletName_${(t==null?void 0:t.uid)||"default"}_${U}`);a&&ac(String(a))}catch{}},[U,Je]);const Ml=async()=>{try{if(!U)return;const s=await la.autoResetLimitsIfNeeded(U);gl(s)}catch(s){console.error("خطأ في جلب حدود المحفظة المختارة:",s)}};i.useEffect(()=>{Ml()},[U]),i.useEffect(()=>{const s=a=>{var n;(n=a==null?void 0:a.detail)!=null&&n.walletId&&a.detail.walletId===U&&Ml()};return window.addEventListener("walletLimitsUpdated",s),()=>window.removeEventListener("walletLimitsUpdated",s)},[U]),i.useEffect(()=>{const s=a=>{var n;try{const l=String(((n=a==null?void 0:a.detail)==null?void 0:n.walletId)||"");l&&cn(l,"sms:auto")}catch{}};return window.addEventListener("walletSelection:update",s),()=>window.removeEventListener("walletSelection:update",s)},[Je]),i.useEffect(()=>{if(C.state){if(console.log("Location state:",C.state),C.state.openDebtDialog&&(nl(),window.history.replaceState({},document.title)),C.state.openSalesDialog&&(Pt||zt?r({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Hr(!0),window.history.replaceState({},document.title)),C.state.openMaintenanceDialog&&(Pt||zt?r({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Kn(!0),window.history.replaceState({},document.title)),C.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),Pt||zt?r({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Jn(!0),window.history.replaceState({},document.title)),C.state.openShopExpensesDialog&&(Pt||zt?r({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):_s.hasMasterPin()?Us(!0):Xt(!0),window.history.replaceState({},document.title)),C.state.openDeficienciesDialog&&(Pt||zt?r({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ia(!0),window.history.replaceState({},document.title)),C.state.openInstallment&&(Pt||zt?r({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"}):Vn(!0),window.history.replaceState({},document.title)),C.state.openTransactionSection){const s=document.getElementById("transaction-section");s&&s.scrollIntoView({behavior:"smooth"}),C.state.transactionType&&ho(C.state.transactionType),C.state.startNewTransaction&&(Ua(""),d(""),Ri(""),$i(""),console.log("🔒 Starting new transaction without changing wallet selection")),C.state.focusWalletSelection&&setTimeout(()=>{const a=document.querySelector('[data-testid="wallet-select"]');a&&a.focus()},500),window.history.replaceState({},document.title)}C.state.openCashierShiftModal&&(!ba||zt?r({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):ce(!0),window.history.replaceState({},document.title)),C.state.openMachineDailyDialog&&(!ba||zt?r({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):Yn(!0),window.history.replaceState({},document.title))}},[C.state,Je,zt]),i.useEffect(()=>{C.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),Rl(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",C.pathname)},[C.pathname,t==null?void 0:t.uid]),i.useEffect(()=>{if(!(t!=null&&t.uid))return;console.log("🔥 Setting up real-time user activation listener for:",t.uid);const s=Ve(V,"users",t.uid),a=Fs(s,n=>{if(n.exists()){const l=n.data(),c=l.isActive===!0;console.log("🔥 Real-time user status update:",{userId:t.uid,isActive:c,subscription:l.subscription}),c&&!st?(console.log("🎉 User activated! Redirecting to dashboard..."),Ct(!0),Ms(!1),Os(!1)):!c&&st&&(console.log("❌ User deactivated! Showing activation modal..."),Ct(!1),Ms(!0))}},n=>{console.error("❌ Error in real-time user listener:",n)});return()=>{console.log("🔥 Cleaning up real-time user listener"),a()}},[t==null?void 0:t.uid,st]),i.useEffect(()=>{if(!(t!=null&&t.uid))return;const s=n=>{const{userId:l}=n.detail;l===t.uid&&(console.log("🎉 Subscription activation event received for current user!"),Ct(!0),Ms(!1),Os(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},a=n=>{const{userId:l,isActive:c}=n.detail;l===t.uid&&(console.log("🔄 User subscription update event received:",{userId:l,isActive:c}),c&&!st&&(Ct(!0),Ms(!1),Os(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",s),window.addEventListener("userSubscriptionUpdated",a),()=>{window.removeEventListener("subscriptionActivated",s),window.removeEventListener("userSubscriptionUpdated",a)}},[t==null?void 0:t.uid,st]),i.useEffect(()=>{const s=a=>{var h;const n=a.target,l=(h=n==null?void 0:n.tagName)==null?void 0:h.toLowerCase();if(!(l==="input"||l==="textarea"||l==="select"||((n==null?void 0:n.isContentEditable)??!1))&&!(a.ctrlKey||a.altKey||a.metaKey)&&!a.repeat){if((Pt||zt)&&a.key>="1"&&a.key<="9"){a.preventDefault();return}switch(a.key){case"1":break;case"2":Ji(!0);break;case"3":Pt||zt?r({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Jn(!0);break;case"4":ba?ce(!0):r({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"5":Pt||zt?r({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Hr(!0);break;case"6":nl();break;case"7":Pt||zt?r({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Kn(!0);break;case"8":ba?Yn(!0):r({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"9":Pt||zt?r({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):_s.hasMasterPin()?Us(!0):Xt(!0);break}}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[Pt,zt,ba]),i.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:t==null?void 0:t.uid,isCheckingActivation:Jt}),(async()=>{try{if(!(t!=null&&t.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),Os(!1);return}try{const h=await Na(Ve(V,"users",t.uid));if(h.exists()){const g=h.data().isActive===!0,D=await Ju.checkTrialValidity(t.uid),p=D.isValid&&!D.isExpired;Ct(g||p),Wa(p),Kr(D.hoursRemaining),it(D.hasUsedTrial),Ms(!g&&!p),console.log("📊 حالة المستخدم:",{isActive:g,isOnTrial:p,hoursRemaining:D.hoursRemaining,hasUsedTrial:D.hasUsedTrial})}else Ct(!1),Ms(!0)}catch(h){console.error("خطأ في فحص حالة تفعيل المستخدم:",h),Ct(!1),Ms(!0)}finally{Os(!1)}if(console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:t==null?void 0:t.uid}),t!=null&&t.uid){const h=await Mr(()=>ve.getUserData(t.uid));if(h){const x=(h==null?void 0:h.walletBalances)||{};cs(x),(h==null?void 0:h.cashBalance)!==void 0&&Qt(h.cashBalance);try{const g=t!=null&&t.uid?await Mr(()=>yn.getDeletedTransactionsByUser(t.uid)):[];Cr(g||[])}catch{Cr([])}}else{cs({});try{const x=t!=null&&t.uid?await yn.getDeletedTransactionsByUser(t.uid):[];Cr(x||[])}catch{Cr([])}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const h=await Mr(()=>pa.getByMerchantId((t==null?void 0:t.uid)||""));if(h&&h.length>0){console.log("✅ تم العثور على محافظ في Firebase:",h.length);const g=h.filter(w=>w.isActive===!0).map(w=>({id:w.id,name:w.label||"محفظة بدون اسم",phone:w.msisdn,isDefault:!1,monthlyWithdrawalLimit:w.monthlyWithdrawalLimit??w.withdrawLimit??2e5,monthlyTransferLimit:w.monthlyTransferLimit??w.transferLimit??2e5,defaultTransferCommission:w.defaultTransferCommission!=null?Number(w.defaultTransferCommission):null,defaultWithdrawCommission:w.defaultWithdrawCommission!=null?Number(w.defaultWithdrawCommission):null}));Dr(g);const D=localStorage.getItem(Or());let p=null;D&&g.find(w=>w.id===D)?p=g.find(w=>w.id===D):p=g[0],p&&(Et(p.id),Ba(p.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else console.log("⚠️ لا توجد محافظ في Firebase. سيتم عرض قائمة فارغة بدون أي استرجاع محلي."),Dr([])}catch(h){console.error("خطأ في تحميل المحافظ من Firebase:",h),Dr([])}const c=t!=null&&t.uid?await Mr(()=>ve.getUserTransactions(t.uid)):[];if(c&&c.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",c.length);const h=c.map(w=>({...w,createdAt:new Date(w.createdAt),senderPhone:w.senderMsisdn||w.senderPhone||"",receiverPhone:w.receiverMsisdn||w.receiverPhone||"",type:w.txnType==="send"?"send":w.txnType==="receive"?"withdraw":w.type||"withdraw",status:w.status==="confirmed"?"completed":w.status||"completed"})),x=Gr.map(w=>w.id||w.originalTransactionId);let g=[];try{const w=Ke(Ce(V,"deletedTransactions"),me("userId","==",(t==null?void 0:t.uid)||""),me("permanent","==",!0));g=(await et(w)).docs.map(T=>{const P=T.data();return String(P.originalTransactionId||P.transactionId||T.id||"")}).filter(Boolean)}catch{}const D=new Set(g),p=h.filter(w=>{var B;const A=String(w.id||""),T=String(w.transactionId||""),P=String(w.reference||w.transactionReference||((B=w.receipt)==null?void 0:B.reference)||""),Q=x.includes(A),$e=D.has(A)||T&&D.has(T);return!Q&&!$e});console.log("✅ تم فلترة المعاملات المحذوفة:",{total:c.length,deleted:x.length,active:p.length});{const w=P=>{var Q;return String((P==null?void 0:P.transactionId)||(P==null?void 0:P.id)||`${(P==null?void 0:P.transactionReference)||((Q=P==null?void 0:P.receipt)==null?void 0:Q.reference)||"ref"}-${new Date((P==null?void 0:P.createdAt)||0).getTime()}`)},A=new Set,T=[];for(const P of p){const Q=w(P);A.has(Q)||(A.add(Q),T.push(P))}yo||ya(T)}}await Cc()}catch(c){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",c)}})().then(async()=>{await l(),await a(),await n()});const a=async()=>{try{if(!(t!=null&&t.uid))return;const c=await pa.getByMerchantId(t.uid);await Promise.all(c.map(h=>Dx.autoResetLimitsIfNeeded(h.id)))}catch(c){console.error("خطأ في التصفير التلقائي للحدود:",c)}},n=async()=>{try{await Ps.syncReportsDataFromFirebase(t==null?void 0:t.uid);const c=Ps.getReportsData(t==null?void 0:t.uid);if((c.lastDailyResetDate?Ps.shouldResetDailyReports(c.lastDailyResetDate):!1)&&(t!=null&&t.uid)&&c.lastDailyResetDate){const g=new Date(c.lastDailyResetDate),D=g.toDateString(),p=Ze.filter(B=>new Date(B.createdAt).toDateString()===D&&B.status==="completed"),w=p.length,A=p.reduce((B,J)=>B+J.amount,0),T=p.filter(dn).reduce((B,J)=>{const ae=J.withdrawnAmount!==void 0?J.withdrawnAmount:J.amount;return B+ae},0),P=p.filter(mn).reduce((B,J)=>{const ae=J.sentAmount!==void 0?J.sentAmount:J.amount;return B+ae},0),Q=p.reduce((B,J)=>B+Ps.calculateTransactionProfit(J),0),$e=new Date(g).toISOString().slice(0,10);await pn.add({userId:t.uid,reportDate:$e,totalTransactions:w,totalAmount:Number(A.toFixed(2)),totalWithdrawn:Number(T.toFixed(2)),totalSent:Number(P.toFixed(2)),profit:Number(Q.toFixed(2)),walletId:null})}const x=Ps.autoResetReportsIfNeeded(t==null?void 0:t.uid);(x.dailyReset||x.monthlyReset)&&console.log("تم التصفير التلقائي:",x)}catch(c){console.error("خطأ في التصفير التلقائي للتقارير:",c)}},l=async()=>{try{if(!(t!=null&&t.uid))return;const c=new Date;if(c.getDate()!==1)return;const h=`${c.getFullYear()}-${c.getMonth()+1}`,x=`lastMonthlyDbCleanup:${t.uid}`;if(localStorage.getItem(x)===h)return;const D=new Date(c.getFullYear(),c.getMonth(),1,0,0,0,0),p=T=>T instanceof Date?T:typeof(T==null?void 0:T.toDate)=="function"?T.toDate():new Date(String(T));let w=[];try{const T=Ke(Ce(V,"userTransactions"),me("userId","==",t.uid),me("createdAt","<",D));w=(await et(T)).docs}catch{const T=Ke(Ce(V,"userTransactions"),me("userId","==",t.uid));w=(await et(T)).docs.filter(Q=>{var $e;return p(($e=Q.data())==null?void 0:$e.createdAt)<D})}await Promise.allSettled(w.map(T=>Ws(T.ref)));let A=[];try{const T=Ke(Ce(V,"transactions"),me("userId","==",t.uid),me("createdAt","<",D));A=(await et(T)).docs}catch{const T=Ke(Ce(V,"transactions"),me("userId","==",t.uid));A=(await et(T)).docs.filter(Q=>{var $e;return p(($e=Q.data())==null?void 0:$e.createdAt)<D})}await Promise.allSettled(A.map(T=>Ws(T.ref)));try{localStorage.setItem(x,h)}catch{}console.log("✅ تم تنظيف قاعدة البيانات شهريًا (Firebase فقط):",{userTransactionsDeleted:w.length,globalTransactionsDeleted:A.length,monthStart:D})}catch(c){console.error("فشل التنظيف الشهري التلقائي لقاعدة البيانات:",c)}};nh(),rc(),bh(),console.log("🔥 useEffect loadUserData completed")},[t==null?void 0:t.uid]);const Rl=async()=>{var s;if(t!=null&&t.uid)try{const a=await Mr(()=>pa.getByMerchantId(t.uid));if(a&&a.length>0){const l=a.filter(c=>c.isActive===!0).map(c=>({id:c.id,name:c.label||"محفظة بدون اسم",phone:c.msisdn,isDefault:!1,monthlyWithdrawalLimit:c.monthlyWithdrawalLimit??c.withdrawLimit??2e5,monthlyTransferLimit:c.monthlyTransferLimit??c.transferLimit??2e5,defaultTransferCommission:c.defaultTransferCommission!=null?Number(c.defaultTransferCommission):void 0,defaultWithdrawCommission:c.defaultWithdrawCommission!=null?Number(c.defaultWithdrawCommission):void 0}));if(Dr(l),t!=null&&t.uid){const c=localStorage.getItem(Or());if(!!(U&&l.find(x=>x.id===U)))console.log("🔒 Preserving current wallet selection:",U);else{const g=(c&&l.find(D=>D.id===c)?c:null)||((s=l[0])==null?void 0:s.id);g&&(console.log("🔄 Fixing invalid wallet selection:",g),cn(g))}}console.log("🔄 تم تحديث المحافظ من Firebase:",l.length)}}catch(a){console.error("خطأ في تحميل المحافظ من Firebase:",a)}};i.useEffect(()=>{const s=C.pathname;if(sessionStorage.getItem("previousPath")==="/user/add-wallet"&&s==="/user/dashboard"){L.invalidateQueries({queryKey:["wallets",t==null?void 0:t.uid]});try{Bn.refetch()}catch{}sessionStorage.removeItem("previousPath")}sessionStorage.setItem("previousPath",s)},[C.pathname,t==null?void 0:t.uid]),i.useEffect(()=>{const s=()=>{L.invalidateQueries({queryKey:["wallets",t==null?void 0:t.uid]});try{Bn.refetch()}catch{}};return window.addEventListener("focus",s),()=>{window.removeEventListener("focus",s)}},[t==null?void 0:t.uid,U,Je]);const cn=async(s,a="unknown")=>{console.log(`🎯 setWalletSelection called from ${a} with walletId:`,s),console.log("🔍 Previous selectedWallet:",U),Et(s);const n=Je.find(l=>l.id===s);if(n&&(Ba(n.phone),console.log("✅ Wallet set successfully:",s,"Phone:",n.phone)),t!=null&&t.uid){localStorage.setItem(Or(),s),console.log("💾 Saved wallet to localStorage:",s);try{await gn.set({key:"selected_wallet_id",value:s}),await gn.set({key:"current_user_id",value:t.uid}),console.log("📱 Saved wallet and user ID to Capacitor Preferences:",s,t.uid)}catch(l){console.error("❌ Failed to save to Capacitor Preferences:",l)}}};i.useEffect(()=>{const s=()=>{Rl()};try{window.addEventListener("wallets:activation-updated",s)}catch{}return()=>{try{window.removeEventListener("wallets:activation-updated",s)}catch{}}},[t==null?void 0:t.uid]);const Lh=s=>{if(s==="__add_wallet"){$("/user/add-wallet");return}if(s==="__view_wallets"){jr(!0);return}Yu.isEnabled(t==null?void 0:t.uid)?(Yr(s),Sr(!0)):cn(s,"walletSelectionNoPin")},ji=s=>{console.log("🔄 handleTransactionTypeChange called with type:",s),console.log("🔍 Current selectedWallet before change:",U),console.log("🔍 Available wallets count:",Je.length),ho(s),Ua(""),d(""),Ri(""),$i(""),console.log("✅ Transaction type changed to:",s,"- Wallet selection preserved:",U),setTimeout(()=>{const a=document.getElementById("transaction-section");a&&a.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)};i.useEffect(()=>{const s=a=>{const n=a.target;if(!!n&&(n.tagName==="INPUT"||n.tagName==="TEXTAREA"||n.tagName==="SELECT"||n.isContentEditable)||(a.key==="ArrowLeft"?(a.preventDefault(),ji("withdraw")):a.key==="ArrowRight"&&(a.preventDefault(),ji("transfer"))),a.key==="Enter"){const c=le==="transfer"?"transferSubmitButton":"withdrawSubmitButton",h=document.getElementById(c);h&&!h.disabled&&(a.preventDefault(),h.click())}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[le]);const _c=s=>{gm((n=>({id:n.id,type:n.type==="send"?"transfer":"withdraw",sender_msisdn:n.senderPhone,receiver_msisdn:n.receiverPhone,amount:n.amount,commission:n.commission||0,fee:(n==null?void 0:n.fee)??0,status:n.status==="failed"?"failed":n.status==="completed"?"completed":"pending",createdAt:new Date(n.createdAt).toISOString(),updatedAt:new Date(n.createdAt).toISOString(),shopName:G??(j==null?void 0:j.shopName)??(t==null?void 0:t.displayName)??"المحل",cashierName:(n==null?void 0:n.cashierName)??null,commissionMode:(n==null?void 0:n.commissionMode)??(n.type==="send"||St?"add":"deduct"),totalCharged:(n==null?void 0:n.totalCharged)??(n.type==="send"?Number(n.amount||0)+Number(n.commission||0)+Number((n==null?void 0:n.fee)||0):St?Number(n.amount||0)+Number(n.commission||0):Number(n.amount||0)),note:(n==null?void 0:n.note)??(n==null?void 0:n.notes)??void 0,senderName:(n==null?void 0:n.senderName)??void 0}))(s)),Un(!0)},Fh=async s=>{var c;if(!(t!=null&&t.uid)){r({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const a=Ze.find(h=>h.id===s);if(!a){r({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}const n=String(s),l=String((a==null?void 0:a.transactionId)||(a==null?void 0:a.reference)||"");za.current.add(n),l&&za.current.add(l);try{console.log("🗑️ بدء عملية حذف المعاملة:",s),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:a.id,userId:t.uid,transactionData:a}),await ve.removeUserTransaction(t.uid,a.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await yn.saveDeletedTransaction({...a,userId:t.uid,originalTransactionId:a.id,transactionId:a.transactionId||a.id,reference:a.reference||a.transactionReference||((c=a.receipt)==null?void 0:c.reference),deletedAt:new Date().toISOString(),permanent:!0}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(g){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",g)}try{await yn.permanentlyDeleteTransaction(a.id,t.uid)}catch(g){console.warn("⚠️ فشل وسم الحذف النهائي أو التنظيف الإضافي:",g)}const h=[...Gr,a],x=Ze.filter(g=>g.id!==s);Cr(h),ya(x),go(!1),console.log("✅ تم تحديث الحالة بعد الحذف من Firebase (بدون نسخ محلية)");try{const g=a.fromWallet;if(g){const{walletDailyLimitsService:D}=await bt(async()=>{const{walletDailyLimitsService:w}=await import("./index-tnWDkOuX.js").then(A=>A.c8);return{walletDailyLimitsService:w}},__vite__mapDeps([0,1]),import.meta.url),p=await D.getWalletLimits(g);if(p){const w=a.type==="send",A={updatedAt:(await bt(async()=>{const{serverTimestamp:B}=await import("./index-tnWDkOuX.js").then(J=>J.c2);return{serverTimestamp:B}},__vite__mapDeps([0,1]),import.meta.url)).serverTimestamp()};w?(A.dailyTransferUsed=Math.max(0,(p.dailyTransferUsed||0)-a.amount),A.monthlyTransferUsed=Math.max(0,(p.monthlyTransferUsed||0)-a.amount)):(A.dailyWithdrawUsed=Math.max(0,(p.dailyWithdrawUsed||0)-a.amount),A.monthlyWithdrawUsed=Math.max(0,(p.monthlyWithdrawUsed||0)-a.amount));const{doc:T,setDoc:P}=await bt(async()=>{const{doc:B,setDoc:J}=await import("./index-tnWDkOuX.js").then(ae=>ae.c2);return{doc:B,setDoc:J}},__vite__mapDeps([0,1]),import.meta.url),{db:Q}=await bt(async()=>{const{db:B}=await import("./index-tnWDkOuX.js").then(J=>J.c3);return{db:B}},__vite__mapDeps([0,1]),import.meta.url),$e=T(Q,"walletLimits",g);await P($e,A,{merge:!0})}}}catch(g){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",g)}try{const{ProfitService:g}=await bt(async()=>{const{ProfitService:T}=await import("./profitService-4r9FqAF7.js");return{ProfitService:T}},__vite__mapDeps([3,0,1]),import.meta.url),{ReportsService:D}=await bt(async()=>{const{ReportsService:T}=await import("./index-tnWDkOuX.js").then(P=>P.c7);return{ReportsService:T}},__vite__mapDeps([0,1]),import.meta.url),w={txnType:a.type==="send"?"send":"receive",amount:a.amount,commission:a.commission||0,createdAt:a.createdAt,status:"confirmed"},A=g.calculateProfitFromTransaction(w);A>0&&g.addProfit(-A,t.uid);try{D.removeTransactionEffects(a,t.uid)}catch{}}catch(g){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",g)}r({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(h){console.error("❌ خطأ في حذف المعاملة من Firebase:",h);let x="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";h instanceof Error&&(h.message.includes("network")||h.message.includes("offline")?x="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":h.message.includes("permission")||h.message.includes("unauthorized")?x="ليس لديك صلاحية لحذف هذه المعاملة":h.message.includes("not-found")&&(x="المعاملة غير موجودة أو تم حذفها مسبقاً")),r({title:"خطأ في الحذف",description:x,variant:"destructive"})}},dn=s=>{const a=s.type,n=s.txnType;return a==="withdraw"||a==="withdrawal"||a==="receive"||n==="receive"},mn=s=>{const a=s.type,n=s.txnType;return a==="send"||a==="transfer"||n==="send"},hn=(s,a)=>{const n=new Date().toDateString();let l=Ze.filter(p=>{const w=new Date(p.createdAt).toDateString()===n,A=String(p.status||"").toLowerCase();return w&&(A==="completed"||A==="confirmed"||A==="pending")});ka&&ka.trim()!==""&&(l=l.filter(p=>p.senderPhone&&p.senderPhone.includes(ka)||p.receiverPhone&&p.receiverPhone.includes(ka)));const c=Ps.filterVisibleTransactions(l,"daily",t==null?void 0:t.uid),h=c.length,x=c.reduce((p,w)=>p+w.amount,0),g=c.filter(dn).reduce((p,w)=>{const A=w.withdrawnAmount!==void 0?w.withdrawnAmount:w.amount;return p+A},0),D=c.filter(mn).reduce((p,w)=>{const A=w.sentAmount!==void 0?w.sentAmount:w.amount;return p+A},0);return{totalTransactions:h,totalAmount:x,totalWithdrawn:g,totalSent:D}},un=s=>{const a=new Date().getMonth(),n=new Date().getFullYear();let l=Ze.filter(p=>{const w=new Date(p.createdAt);return w.getMonth()===a&&w.getFullYear()===n&&p.status==="completed"});ka&&ka.trim()!==""&&(l=l.filter(p=>p.senderPhone&&p.senderPhone.includes(ka)||p.receiverPhone&&p.receiverPhone.includes(ka)));const c=Ps.filterVisibleTransactions(l,"monthly",t==null?void 0:t.uid),h=c.length,x=c.reduce((p,w)=>p+w.amount,0),g=c.filter(dn).reduce((p,w)=>{const A=w.withdrawnAmount!==void 0?w.withdrawnAmount:w.amount;return p+A},0),D=c.filter(mn).reduce((p,w)=>{const A=w.sentAmount!==void 0?w.sentAmount:w.amount;return p+A},0);return{totalTransactions:h,totalAmount:x,totalWithdrawn:g,totalSent:D}},Wh=s=>{const a=new Date().getMonth(),n=new Date().getFullYear(),l=Ze.filter(x=>{const g=new Date(x.createdAt);return g.getMonth()===a&&g.getFullYear()===n&&x.status==="completed"&&x.fromWallet===s}),c=l.filter(dn).reduce((x,g)=>{const D=g.withdrawnAmount||g.amount;return x+D},0),h=l.filter(mn).reduce((x,g)=>{const D=g.sentAmount||g.amount;return x+D},0);return{totalWithdrawn:c,totalTransferred:h}},Bh=s=>{const a=new Date,n=a.getDate(),l=a.getMonth(),c=a.getFullYear(),h=Ze.filter(D=>{const p=new Date(D.createdAt);return p.getDate()===n&&p.getMonth()===l&&p.getFullYear()===c&&D.status==="completed"&&D.fromWallet===s}),x=h.filter(dn).reduce((D,p)=>{const w=p.withdrawnAmount||p.amount;return D+w},0),g=h.filter(mn).reduce((D,p)=>{const w=p.sentAmount||p.amount;return D+w},0);return{totalWithdrawn:x,totalTransferred:g}},Ec=He.useMemo(()=>un(),[Ze,U,ka]);Ec.totalWithdrawn,Ec.totalSent;const _a=He.useMemo(()=>Wh(U),[Ze,U]);i.useEffect(()=>{try{if(!U||Je.length===0)return;const s=Je.find(P=>P.id===U);if(!s)return;const a=(rt==null?void 0:rt.monthlyWithdrawLimit)??(s==null?void 0:s.monthlyWithdrawalLimit)??2e5,n=(rt==null?void 0:rt.monthlyTransferLimit)??(s==null?void 0:s.monthlyTransferLimit)??2e5,l=parseFloat(as||"0")||0,c=(_a==null?void 0:_a.totalWithdrawn)??(rt==null?void 0:rt.monthlyWithdrawUsed)??0,h=(_a==null?void 0:_a.totalTransferred)??(rt==null?void 0:rt.monthlyTransferUsed)??0,x=c+(le==="withdraw"?l:0),g=h+(le==="transfer"?l:0),D=.85,p=Math.floor(Math.max(a,1)*D),w=Math.floor(Math.max(n,1)*D),A=(()=>{const P=new Date;return`${P.getFullYear()}-${String(P.getMonth()+1).padStart(2,"0")}`})(),T=`monthlyLimitWarnShown:${U}:${A}`;if(x>=p){const P=`${T}:withdraw`;if(!(localStorage.getItem(P)==="true")){mo({type:"withdraw",used:x,limit:a,walletName:s.name}),Ln(!0);try{localStorage.setItem(P,"true")}catch{}return}}if(g>=w){const P=`${T}:transfer`;if(!(localStorage.getItem(P)==="true")){mo({type:"transfer",used:g,limit:n,walletName:s.name}),Ln(!0);try{localStorage.setItem(P,"true")}catch{}return}}}catch{}},[U,Je,rt,_a,le,as]);const Oc=async()=>{var Ka,wa,ia,Uc;rp(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:qs,receiverPhone:gs,amount:as,transactionType:le});const s=()=>{le==="transfer"?Ir(!0):Zr(!0)},a=()=>{le==="transfer"?Ir(!1):Zr(!1)};if(s(),!qs||!as){console.log("❌ خطأ: بيانات ناقصة"),r({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),a();return}if(le==="transfer"&&!gs&&!R){console.log("❌ خطأ: رقم المستقبل مفقود"),r({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),a();return}if(le==="transfer"&&!R&&(String(gs||"").replace(/[^0-9٠-٩]/g,""),!/[^0-9٠-٩\s]/.test(String(gs||""))&&!np(gs))){r({title:"رقم المستقبل غير صالح",description:"اكتب رقم صحيح مكون من 11 رقم ويبدأ بـ 015 أو 010 أو 012 أو 011",variant:"destructive"}),a();return}const n=parseFloat(as);if(console.log("💰 المبلغ المحول:",n),n<=0){console.log("❌ خطأ: مبلغ غير صحيح"),r({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),a();return}if(Pt)try{const Le=new Date,ot=Le.getFullYear(),_t=String(Le.getMonth()+1).padStart(2,"0"),rs=String(Le.getDate()).padStart(2,"0"),Hs=`zeroPlanDailyConfirmCount:${(t==null?void 0:t.uid)||"default"}:${ot}-${_t}-${rs}`,$s=localStorage.getItem(Hs);if(($s&&parseInt($s,10)||0)>=10){r({title:"حد التأكيد اليومي",description:"باقة زيرو تسمح بـ 10 تأكيدات تحويل/سحب يومياً فقط.",variant:"destructive"}),a();return}}catch(Le){console.warn("فشل قراءة عداد تأكيدات باقة زيرو من التخزين المحلي:",Le)}const l=Je.find(Le=>Le.id===U);if(!l){r({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),a();return}const c=_a;if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:U,walletName:l.name,currentWithdrawn:c.totalWithdrawn,currentTransferred:c.totalTransferred,withdrawalLimit:l.monthlyWithdrawalLimit,transferLimit:l.monthlyTransferLimit}),le==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${c.totalWithdrawn}, المبلغ الجديد: ${n}, الحد الأقصى: ${l.monthlyWithdrawalLimit}`),c.totalWithdrawn+n>l.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),r({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${l.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${c.totalTransferred}, المبلغ الجديد: ${n}, الحد الأقصى: ${l.monthlyTransferLimit}`),c.totalTransferred+n>l.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),r({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${l.monthlyTransferLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}const h=(j==null?void 0:j.shopName)||(t==null?void 0:t.displayName)||"محل كاشي لينك",x={id:Date.now().toString(),type:le==="transfer"?"send":le==="deposit"?"deposit":"withdraw",senderPhone:qs,receiverPhone:le==="transfer"?gs:qs,amount:n,status:"completed",createdAt:new Date,withdrawnAmount:le==="withdraw"?n:void 0,sentAmount:le==="transfer"?n:void 0,depositedAmount:void 0,fromWallet:U,senderNumber:qs,senderName:le==="withdraw"&&X.trim()!==""?X.trim():void 0,shopName:(l==null?void 0:l.name)||"المحفظة الرئيسية",transferredAmount:le==="transfer"?n:void 0,receiverNumber:le==="transfer"?gs:void 0,withdrawnAmountDetailed:le==="withdraw"?n:void 0,depositedAmountDetailed:void 0,merchantShopName:h,transactionReference:`TXN-${Date.now()}`,commission:0,notes:le==="transfer"?void 0:I&&I.trim()!==""?I.trim():void 0};y&&(v!=null&&v.name||v!=null&&v.username)&&(x.cashierName=(v==null?void 0:v.name)||(v==null?void 0:v.username));const g=Wr.validateTransaction(n,le,Mt,lt);if(!g.isValid){r({title:"خطأ في العملية",description:g.error,variant:"destructive"}),a();return}g.warning&&r({title:"تحذير",description:g.warning,variant:"destructive"});let D;if(le==="transfer")if((l==null?void 0:l.defaultTransferCommission)!=null){const Le=Number(l.defaultTransferCommission)||0;D=Math.round(Le*n/1e3*100)/100}else bs&&bs.trim()!==""?D=Math.max(0,parseFloat(bs)):D=0;else if((l==null?void 0:l.defaultWithdrawCommission)!=null){const Le=Number(l.defaultWithdrawCommission)||0;D=Math.round(Le*n/1e3*100)/100}else ys&&ys.trim()!==""?D=Math.max(0,parseFloat(ys)):D=Math.round(n*.01*100)/100;if(x.commission=D,le!=="transfer"&&!St&&D>=n){r({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),a();return}const p=le==="transfer"||St?n:Math.round((n-D)*100)/100;x.amount=p,x.withdrawnAmount=le==="withdraw"?p:void 0,x.sentAmount=le==="transfer"?p:void 0,x.transferredAmount=le==="transfer"?p:void 0,x.withdrawnAmountDetailed=le==="withdraw"?p:void 0;let w;const A=le==="transfer"&&!!fs,T=le==="withdraw"&&!!fs,P=A||T;let Q=null;const $e=Fn(qs||"").replace(/\D/g,""),B=Fn(gs||"").replace(/\D/g,""),J=le==="transfer"&&($e.startsWith("010")&&(B.startsWith("011")||B.startsWith("012")||B.startsWith("015"))||$e.startsWith("012")&&B.startsWith("010")||$e.startsWith("011")&&B.startsWith("010")||$e.startsWith("015")&&B.startsWith("010")),ae=J?Math.max(0,parseFloat(co||"0")):0,Yt=Math.round(D*100)/100;if(x.commission=Yt,x.fee=ae,x.totalCharged=le==="transfer"?Number(p)+Number(Yt)+Number(ae):St?Number(p)+Number(Yt):Number(p),J&&!P&&ae<=0){r({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"}),a();return}if(le==="transfer"&&!P){const Le=Number(lt[U]||0),ot=Number(p)+Number(ae);if(Le<ot){r({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${Le} لا يكفي لخصم ${ot}`,variant:"destructive"}),a();return}}if(P)if(A){const Le=Wr.validateTransaction(p,"transfer",Mt,lt);if(!Le.isValid)w={success:!1,newCashBalance:Mt,newWalletBalances:lt,message:Le.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"};else{const ot=U||((Ka=Je.find(mt=>mt.isDefault))==null?void 0:Ka.id)||((wa=Je[0])==null?void 0:wa.id),_t=rt??await la.getWalletLimits(ot),rs=new Date().toDateString(),Hs=Ze.filter(mt=>mt.type==="send"&&String(mt.status||"").toLowerCase()==="pending"&&mt.fromWallet===ot&&new Date(mt.createdAt).toDateString()===rs).reduce((mt,Ts)=>mt+Number(Ts.sentAmount??Ts.transferredAmount??Ts.amount??0),0),$s=Number((_t==null?void 0:_t.dailyTransferLimit)??6e4),aa=Number((_t==null?void 0:_t.dailyTransferUsed)??0);if(aa+Hs+Number(p)>$s){r({title:"تجاوز الحد اليومي للتحويل",description:`المتبقي اليوم: ${($s-aa-Hs).toLocaleString()} ج.م`,variant:"destructive"}),a();return}const ha=new Date,Ya=Ze.filter(mt=>mt.type==="send"&&String(mt.status||"").toLowerCase()==="pending"&&mt.fromWallet===ot&&new Date(mt.createdAt).getMonth()===ha.getMonth()&&new Date(mt.createdAt).getFullYear()===ha.getFullYear()).reduce((mt,Ts)=>mt+Number(Ts.sentAmount??Ts.transferredAmount??Ts.amount??0),0),Ea=Number((_t==null?void 0:_t.monthlyTransferLimit)??2e5),Rr=Number((_t==null?void 0:_t.monthlyTransferUsed)??0);if(Rr+Ya+Number(p)>Ea){r({title:"تجاوز الحد الشهري للتحويل",description:`المتبقي هذا الشهر: ${(Ea-Rr-Ya).toLocaleString()} ج.م`,variant:"destructive"}),a();return}w={success:!0,newCashBalance:Mt,newWalletBalances:lt}}}else{const Le=U||((ia=Je.find(mt=>mt.isDefault))==null?void 0:ia.id)||((Uc=Je[0])==null?void 0:Uc.id),ot=rt??await la.getWalletLimits(Le),_t=new Date().toDateString(),rs=Ze.filter(mt=>mt.type==="withdraw"&&String(mt.status||"").toLowerCase()==="pending"&&mt.fromWallet===Le&&new Date(mt.createdAt).toDateString()===_t).reduce((mt,Ts)=>mt+Number(Ts.withdrawnAmount??Ts.amount??0),0),Hs=Number((ot==null?void 0:ot.dailyWithdrawLimit)??1e5),$s=Number((ot==null?void 0:ot.dailyWithdrawUsed)??0);if($s+rs+Number(p)>Hs){r({title:"تجاوز الحد اليومي للسحب",description:`المتبقي اليوم: ${(Hs-$s-rs).toLocaleString()} ج.م`,variant:"destructive"}),a();return}const aa=new Date,ha=Ze.filter(mt=>mt.type==="withdraw"&&String(mt.status||"").toLowerCase()==="pending"&&mt.fromWallet===Le&&new Date(mt.createdAt).getMonth()===aa.getMonth()&&new Date(mt.createdAt).getFullYear()===aa.getFullYear()).reduce((mt,Ts)=>mt+Number(Ts.withdrawnAmount??Ts.amount??0),0),Ya=Number((ot==null?void 0:ot.monthlyWithdrawLimit)??2e5),Ea=Number((ot==null?void 0:ot.monthlyWithdrawUsed)??0);if(Ea+ha+Number(p)>Ya){r({title:"تجاوز الحد الشهري للسحب",description:`المتبقي هذا الشهر: ${(Ya-Ea-ha).toLocaleString()} ج.م`,variant:"destructive"}),a();return}w={success:!0,newCashBalance:Math.round((Number(Mt)-Number(p))*100)/100,newWalletBalances:lt}}else le==="transfer"?w=await Wr.processTransfer({amount:p,currentCashBalance:Mt,currentWalletBalances:lt,wallets:Je,selectedWalletId:U,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0}):w=await Wr.processWithdraw({amount:p,currentCashBalance:Mt,currentWalletBalances:lt,wallets:Je,selectedWalletId:U,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0});if(!w.success){r({title:"فشل في العملية",description:w.error||w.message,variant:"destructive"}),a();return}let ws=P?T?w.newCashBalance:Mt:w.newCashBalance,Ns=P?lt:w.newWalletBalances;if(!P&&le==="transfer"&&ae>0){const Le=Number(Ns[U]||0);Ns={...Ns,[U]:Math.round((Le-Number(ae))*100)/100}}if(P&&A){const Le=Je.find(rs=>rs.id===U)??Je.find(rs=>rs.isDefault)??Je[0],ot=(Le==null?void 0:Le.id)||U;if(ot!==U)try{cn(ot)}catch{}const _t=Number(lt[ot]||0);Ns={...lt,[ot]:Math.round((_t-Number(p)-Number(ae))*100)/100}}if((A||T)&&fs&&!As){const Le={id:`DEBT-${Date.now()}`,debtorName:fs.debtorName,amount:fs.amount,reason:fs.notes||"",customerId:fs.customerId,mobile:fs.mobile,status:"pending",createdAt:new Date};Q=Le.id;const ot=[Le,...Tt];vs(ot);try{await sa(ot)}catch(_t){console.error("⚠️ فشل حفظ الدين المؤجل محلياً:",_t)}r({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}if(!P){const Le=Math.max(0,Number(D))+Math.max(0,Number(ae));Le>0&&(ws=Math.round((ws+Le)*100)/100,console.log(`💰 تم إضافة عمولة/رسوم ${Le} جنيه لدرج النقدية`))}console.log("⚡ تحديث الواجهة فوراً بدون حجب باستخدام startTransition...");const va=[x,...Ze];He.startTransition(()=>{Qt(ws),cs(Ns),P&&(x.status="pending"),ya(va)});try{setTimeout(()=>{try{localStorage.setItem(Il(),JSON.stringify(va))}catch{}},0)}catch{}if(Pt)try{const Le=new Date,ot=Le.getFullYear(),_t=String(Le.getMonth()+1).padStart(2,"0"),rs=String(Le.getDate()).padStart(2,"0"),Hs=`zeroPlanDailyConfirmCount:${(t==null?void 0:t.uid)||"default"}:${ot}-${_t}-${rs}`,$s=localStorage.getItem(Hs),aa=$s&&parseInt($s,10)||0;localStorage.setItem(Hs,String(aa+1))}catch{}setTimeout(()=>{try{localStorage.setItem(Ks(),ws.toString()),localStorage.setItem(Rs(),JSON.stringify(Ns))}catch{}},0);try{if(t!=null&&t.uid){const Le=Je.find($r=>$r.id===U)??Je.find($r=>$r.isDefault)??Je[0],ot=(Le==null?void 0:Le.id)||U,_t=Number(Ns[ot]||0),rs=String((Le==null?void 0:Le.phone)||qs||"").trim(),Hs=String(gs||"").trim(),$s=Number(ae)>0,aa=le==="transfer"?"🟢":"🔴",ha=Number(Yt)>0?`${Number(Yt)} جنيه`:"0 جنيه",Ya=$s?` و رسوم ${Number(ae)} جنيه`:"",Ea=le==="transfer"?`${aa} تم تحويل مبلغ ${Number(p)} جنيه من رقم المحفظة ${rs} إلى رقم المحفظة ${Hs} وتم أخذ عمولة ${ha}${Ya}. الرصيد المتبقي في المحفظة: ${_t} جنيه. الفلوس النقدية المتبقية: ${Number(ws)} جنيه.`:`${aa} تم السحب مبلغ ${Number(p)} جنيه من الدرج إلى رقم المحفظة ${rs} وتم أخذ عمولة ${ha}${Ya}. الرصيد المتبقي في المحفظة: ${_t} جنيه. الفلوس النقدية المتبقية: ${Number(ws)} جنيه.`,Rr=t!=null&&t.uid?`tg_last_msg_${t.uid}`:"tg_last_msg",mt=Date.now();let Ts=!0;try{const $r=localStorage.getItem(Rr);if($r){const Lr=JSON.parse($r),Qh=String((Lr==null?void 0:Lr.text)||""),Gh=Number((Lr==null?void 0:Lr.at)||0);Qh===Ea&&mt-Gh<5e3&&(Ts=!1)}}catch{}if(Ts){Promise.resolve(ur.send(t.uid,Ea)).catch(()=>{});try{localStorage.setItem(Rr,JSON.stringify({text:Ea,at:mt}))}catch{}}}}catch{}if((async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const Le={shopId:_||(j==null?void 0:j.shopId)||(t==null?void 0:t.uid)||"default-shop",lineId:U||"default-line",walletId:U||void 0,merchantUserId:(t==null?void 0:t.uid)||null,provider:"vodafone_cash",txnType:le==="transfer"?"send":"receive",originType:le==="transfer"?"transfer":"withdraw",amount:p,commission:Yt,fee:ae,profit:0,senderMsisdn:qs,receiverMsisdn:le==="transfer"?gs:qs,note:le==="transfer"?void 0:I&&I.trim()!==""?I.trim():void 0,status:P?"pending":"confirmed",linkedDebtId:Q||void 0,createdBy:(t==null?void 0:t.uid)||null,walletEffectAppliedOnCreation:!1,cashEffectAppliedOnCreation:!!(P&&T),limitsReservedOnCreation:!!P,limitReservedType:le==="transfer"?"transfer":"withdraw",profitAddedOnCreation:!1},ot={...Le,status:P?"pending":"completed",commissionMode:le==="transfer"||St?"add":"deduct",totalCharged:le==="transfer"?p+Yt+ae:St?p+D:p,walletEffectAppliedOnCreation:!1,cashEffectAppliedOnCreation:!!(P&&T),limitsReservedOnCreation:!!P,limitReservedType:le==="transfer"?"transfer":"withdraw",sentAmount:le==="transfer"?p:void 0,transferredAmount:le==="transfer"?p:void 0,withdrawnAmount:le==="withdraw"?p:void 0,senderName:le==="withdraw"&&X.trim()!==""?X.trim():void 0,createdAt:new Date},{ProfitService:_t}=await bt(async()=>{const{ProfitService:ha}=await import("./profitService-4r9FqAF7.js");return{ProfitService:ha}},__vite__mapDeps([3,0,1]),import.meta.url),rs=_t.calculateProfitFromTransaction({...ot,status:"confirmed"});rs>0&&(_t.addProfit(rs,t==null?void 0:t.uid),Le.profitAddedOnCreation=!0,ot.profitAddedOnCreation=!0,console.log("✅ تم إضافة الربح:",rs,"جنيه"));const Hs=await Ei.create(Le);if(U)try{await la.updateUsage(U,p,le==="transfer"?"transfer":"withdraw");try{window.dispatchEvent(new CustomEvent("walletLimitsUpdated",{detail:{walletId:U}}))}catch{}try{await Ml()}catch{}}catch{}await Promise.all([...t!=null&&t.uid?[ve.updateUserData(t.uid,{cashBalance:ws,walletBalances:Ns,lastUpdated:new Date().toISOString()})]:[],...t!=null&&t.uid?[ve.saveUserTransaction(t.uid,{...ot,transactionType:le,fromWallet:U,toWallet:le==="transfer"?A?null:"cash":null,cashierName:y&&((v==null?void 0:v.name)||(v==null?void 0:v.username))||"الحساب الرئيسي",linkedDebtId:Q||void 0,transactionId:Hs,description:`${le==="transfer"?"تحويل":"سحب"} ${p} من ${U} ${le==="transfer"?A?"":"إلى الدرج النقدي":""} — عمولة: ${D} (${le==="transfer"||St?"مضافة":"مخصومة"})${ae>0?` — رسوم: ${ae}`:""}${P?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");try{L.invalidateQueries({queryKey:["recentTransactions",t==null?void 0:t.uid,_||"main"]})}catch{}try{await Bi.refetch()}catch{}const $s=`userData_${t==null?void 0:t.uid}`,aa={cashBalance:ws,walletBalances:Ns,lastUpdated:new Date().toISOString()};localStorage.setItem($s,JSON.stringify(aa))}catch(Le){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",Le);try{t!=null&&t.uid&&ve.saveLocalReceipt(t.uid,{...transactionDataForUser,transactionType:le,fromWallet:U,toWallet:le==="transfer"?A?null:"cash":null,cashierName:y&&((v==null?void 0:v.name)||(v==null?void 0:v.username))||"الحساب الرئيسي",linkedDebtId:Q||void 0,description:`${le==="transfer"?"تحويل":"سحب"} ${p} من ${U} ${le==="transfer"?A?"":"إلى الدرج النقدي":""} — عمولة: ${D} (${le==="transfer"||St?"مضافة":"مخصومة"})${ae>0?` — رسوم: ${ae}`:""}${P?" — دين مؤجل (قيد المراجعة)":""}`})}catch{}r({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),le==="transfer"){Ir(!0);const Le=Number(n)+Number(D)+Math.max(0,Number(ae));Vi({type:"transfer",amount:Math.max(0,Math.round(Le*100)/100)}),Sm({receiver:gs,amount:n}),ir(!0),setTimeout(()=>{Ir(!1)},2e3)}else{Zr(!0);const Le=St?Number(n):Math.max(0,Math.round((Number(n)-Number(D))*100)/100);Vi({type:"withdraw",amount:Math.max(0,Math.round(Le*100)/100)}),ir(!0),setTimeout(()=>{Zr(!1)},2e3)}Ua(""),d(""),O(""),K(""),Aa(null),Oe(""),xe(""),Is(""),Ta(!1)},Si=He.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),Mc=He.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),Uh=He.useMemo(()=>{try{return Tt.reduce((s,a)=>{const n=Number(a.paidAmount||0),l=Math.max(0,Number(a.amount||0)-n);return s+l},0)}catch{return 0}},[Tt]),$l=He.useMemo(()=>Tc().filter(a=>Pa==="all"?!0:Pa==="send"?a.type==="send":Pa==="receive"?a.type==="receive":Pa==="withdraw"?a.type==="withdraw":Pa!=="deleted"),[Tc,Pa]),zh=()=>{if(zi==="daily"){const s=Ps.resetReportsManually("daily",Ze,t==null?void 0:t.uid);Qr(!1),r({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${s.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const s=Ps.resetReportsManually("monthly",Ze,t==null?void 0:t.uid);Qr(!1),r({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${s.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},qh=()=>zi==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",Vh=()=>zi==="daily"?"أدخل الرقم السري الرئيسي لتصفير جميع معاملات اليوم":"أدخل الرقم السري الرئيسي لتصفير جميع معاملات الشهر",Jh=s=>{bc(s),yl(!0)},Kh=s=>{const a=Mt,n=Number(s)-Number(a);Qt(s),localStorage.setItem(Ks(),s.toString()),nc(!1);const l={cashBalance:s,lastUpdated:new Date().toISOString()},c=`userData_${t==null?void 0:t.uid}`;try{localStorage.setItem(c,JSON.stringify(l))}catch{}const h=[];if(t!=null&&t.uid){h.push(ve.updateUserData(t.uid,l).then(()=>{try{localStorage.removeItem(c)}catch{}}).catch(()=>{}));const x=`${n>0?"CASHADD":"CASHDEDUCT"}-${(t==null?void 0:t.uid)||"anon"}-${Date.now()}`,g=n>0?{txnType:"cash_addition",type:"cash_addition",amount:n,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:x,title:"إيصال إضافة نقدية",merchantUserId:t.uid,createdBy:t.uid,shopId:(j==null?void 0:j.shopId)||void 0}:n<0?{amount:Math.abs(n),status:"completed",title:"ايصال خصم من الفلوس النقديه",merchantUserId:t.uid,createdBy:t.uid,shopId:(j==null?void 0:j.shopId)||void 0}:null;g&&h.push(ve.saveUserTransaction(t.uid,g));const D=j==null?void 0:j.shopId;if(D){const p=Ve(V,"dashboardData",D);h.push(Wt(p,{cashBalance:s}))}}Promise.allSettled(h).then(()=>{}).catch(()=>{}),r({title:n>0?"تم إضافة نقدية":n<0?"تم خصم نقدية":"تم تحديث الرصيد النقدي",description:n!==0?`التغيير: ${Math.abs(n)} جنيه، الرصيد الجديد: ${s} جنيه`:`تم تحديث الرصيد النقدي إلى ${s} جنيه`})},Yh=async s=>{var x;if(!Ys){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const a={...lt,[Ys]:s};cs(a);const n=new Date().toISOString(),l={walletBalances:a,lastUpdated:n},c=`userData_${t==null?void 0:t.uid}`;try{localStorage.setItem(c,JSON.stringify(l)),localStorage.setItem(Rs(),JSON.stringify(a)),localStorage.setItem(`walletBalances_backup_${n}`,JSON.stringify(a))}catch{}try{t!=null&&t.uid&&await ve.updateUserData(t.uid,l)}catch(g){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",g)}ic(!1);const h=((x=Je.find(g=>g.id===Ys))==null?void 0:x.name)||"المحفظة";r({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${h} إلى ${s.toLocaleString()} جنيه`})},Hh=async s=>{var a;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",Ys),console.log("💵 المبلغ المضاف/المخصوم:",s),Ys){const n=lt[Ys]||0;console.log("💰 الرصيد الحالي:",n);const l=n+s;console.log("💰 الرصيد الجديد:",l);const c={...lt,[Ys]:l};console.log("📊 الأرصدة المحدثة:",c),cs(c);const h=new Date().toISOString(),x={walletBalances:c,lastUpdated:h},g=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(g,JSON.stringify(x)),localStorage.setItem(Rs(),JSON.stringify(c)),localStorage.setItem(`walletBalances_backup_${h}`,JSON.stringify(c));try{if(t!=null&&t.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await ve.updateUserData(t.uid,x),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(g),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(A){console.error("❌ فشل في حفظ البيانات في Firebase:",A),tt(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(Rs(),JSON.stringify(c));const D=((a=Je.find(A=>A.id===Ys))==null?void 0:a.name)||"المحفظة",p=s>0?"إضافة":"خصم",w=Math.abs(s);r({title:`تم ${p} مبلغ ${p==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${p} ${w} جنيه ${p==="إضافة"?"إلى":"من"} رصيد ${D}. الرصيد الجديد: ${l.toLocaleString()} جنيه`})}catch(D){if(console.error("❌ فشل في حفظ البيانات في Firebase:",D),localStorage.setItem(Rs(),JSON.stringify(c)),t!=null&&t.uid){const p=`userData_${t.uid}`,w={walletBalances:c,lastUpdated:new Date().toISOString()};localStorage.setItem(p,JSON.stringify(w)),tt(!0)}r({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const l=Object.keys(localStorage).filter(c=>c.startsWith("walletBalances_backup_")).sort();l.length>5&&l.slice(0,l.length-5).forEach(h=>{localStorage.removeItem(h),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",h)})},5e3),yl(!1),bc("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:Jt,isUserActive:st,showActivationModal:wr}),Jt?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx(wu,{})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"user-dashboard min-h-screen px-2 sm:px-4 py-2 sm:py-4 relative bg-gray-50 bg-[radial-gradient(140%_140%_at_10%_10%,#f3f4f6_0%,#e5e7eb_45%,#d1d5db_100%)]",children:[e.jsx(ip,{userId:t==null?void 0:t.uid}),e.jsxs("div",{className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!Xr&&e.jsxs(Lt,{className:"monthly-stats-card bg-gradient-to-br from-purple-50 via-purple-25 to-white border border-purple-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-500/5 to-purple-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-purple-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(ms,{className:"monthly-stats-header pb-2 sm:pb-1 lg:pb-1 px-3 sm:px-3 lg:px-2 pt-3 sm:pt-2 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Bs,{className:"text-xs font-bold text-purple-800 flex items-center gap-1.5 sm:gap-1",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-2 h-2.5 sm:h-2 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-2 h-2.5 sm:h-2 bg-purple-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1",children:[e.jsx("div",{className:"hidden"}),e.jsx(u,{size:"sm",variant:"ghost",onClick:()=>{fo("monthly"),Qr(!0)},className:"monthly-stat-action h-7 w-7 sm:h-6 sm:w-6 p-0 bg-white/60 backdrop-blur-md border border-white/50 text-purple-700 hover:bg-white hover:text-purple-900 rounded-xl transition-all duration-300 hover:scale-110 shadow-[0_8px_16px_-6px_rgba(124,58,237,0.35)] ring-1 ring-purple-200",title:"تصفير معاملات الشهر",children:e.jsx(ds,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5"})}),e.jsx("div",{className:"monthly-stat-action p-1.5 sm:p-1 bg-gradient-to-br from-purple-500/20 to-pink-500/20 border border-white/50 backdrop-blur-md rounded-xl shadow-[0_8px_16px_-6px_rgba(236,72,153,0.35)]",children:e.jsx(fn,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5 text-purple-700"})})]})]})}),!Xr&&e.jsxs(Bt,{className:"space-y-0.5 sm:space-y-1 lg:space-y-0 pt-0 px-2 sm:px-3 lg:px-2 pb-1.5 sm:pb-2 lg:pb-1 relative z-10",children:[e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:un().totalTransactions})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:un().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"المسحوب:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:un().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"المرسل:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:un().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"الأرباح:"}),e.jsx(Yx,{userId:t==null?void 0:t.uid,transactions:Ze})]})]}),Em&&e.jsx("div",{className:"monthly-overlay absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(u,{size:"sm",variant:"ghost",onClick:async()=>{if(Pt){r({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}Hn(!0)},className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-black hover:from-yellow-600 hover:to-yellow-700 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(Ut,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(Ds,{open:Mm,onOpenChange:Hn,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(Pt){r({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),Hn(!1),ko(!0);return}ko(!1),Hn(!1)},userId:t==null?void 0:t.uid}),((Rc=at==null?void 0:at.subscription)==null?void 0:Rc.planType)!==Gs.TAHWEELA&&e.jsxs(Lt,{className:"daily-stats-card bg-gradient-to-br from-blue-50 via-blue-25 to-white border border-blue-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 to-blue-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-blue-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(ms,{className:"daily-stats-header pb-2 sm:pb-3 lg:pb-1 px-3 sm:px-4 lg:px-2 pt-3 sm:pt-4 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Bs,{className:"text-sm sm:text-base font-bold text-blue-800 flex items-center gap-1.5 sm:gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-3 h-2.5 sm:h-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-3 h-2.5 sm:h-3 bg-blue-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs sm:text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5",children:[e.jsx(u,{size:"sm",variant:"ghost",onClick:()=>{fo("daily"),Qr(!0)},className:"daily-stat-action h-7 w-7 sm:h-8 sm:w-8 p-0 bg-white/60 backdrop-blur-md border border-white/50 text-blue-700 hover:bg-white hover:text-blue-900 rounded-xl transition-all duration-300 hover:scale-110 shadow-[0_8px_16px_-6px_rgba(59,130,246,0.35)] ring-1 ring-blue-200",title:"تصفير معاملات اليوم",children:e.jsx(ds,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(u,{size:"sm",variant:"ghost",onClick:()=>Om(s=>!s),className:"daily-stat-action h-7 w-7 sm:h-8 sm:w-8 p-0 bg-white/60 backdrop-blur-md border border-white/50 text-blue-700 hover:bg-white hover:text-blue-900 rounded-xl transition-all duration-300 hover:scale-110 shadow-[0_8px_16px_-6px_rgba(59,130,246,0.35)] ring-1 ring-blue-200",title:Xr?"توسيع اليوم والشهر":"طي اليوم والشهر",children:Xr?e.jsx(Cn,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"}):e.jsx(Ii,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-br from-blue-500/20 to-emerald-500/20 border border-white/50 backdrop-blur-md rounded-xl shadow-[0_8px_16px_-6px_rgba(16,185,129,0.35)]",children:e.jsx(fn,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-blue-700"})})]})]})}),!Xr&&e.jsxs(Bt,{className:"space-y-0 pt-0 px-2 pb-1 relative z-10",children:[e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:hn().totalTransactions})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:hn().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"المسحوب:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:hn().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from_gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"المرسل:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:hn().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"الأرباح:"}),e.jsx(Gx,{userId:t==null?void 0:t.uid,transactions:Ze})]})]}),Wm&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(u,{size:"sm",variant:"ghost",onClick:()=>Yi(!0),className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير اليوم (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير اليوم"}),e.jsx(Ut,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(Ds,{open:Bm,onOpenChange:Yi,mode:"verify",title:"الرقم السري لفتح تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Oo(!1),Yi(!1)},userId:t==null?void 0:t.uid})]}),e.jsxs(Lt,{className:"balance-bar bg-white border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(Bt,{className:"p-3 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-emerald-50 border-2 border-emerald-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/cash relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx(Ht,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-emerald-800",children:"الفلوس النقدية"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-emerald-700 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Mt.toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(u,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>rn(!0),children:e.jsx(ks,{className:"h-2 w-2"})}),e.jsx(u,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>wc(!0),title:"تفاصيل الفلوس النقدية",children:e.jsx(td,{className:"h-2 w-2"})}),e.jsx(u,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>wi(!0),children:e.jsx(ds,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/wallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(ja,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-blue-800",children:"الأرصدة علي المحافظ"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-blue-700 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Object.values(lt).reduce((s,a)=>s+a,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(u,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>gi(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(ks,{className:"h-2 w-2"})}),e.jsx(u,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{bi(!0),vi("")},title:"تصفير إجمالي المحفظة",children:e.jsx(ds,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-indigo-50 border-2 border-indigo-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/selwallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(ja,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-indigo-800",children:"رصيد المحفظه"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-indigo-700 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm",children:[(U&&lt[U]||0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(u,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>{if(!U){r({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}Jh(U)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(ks,{className:"h-2 w-2"})}),e.jsx(u,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{if(!U){r({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}ri(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(ds,{className:"h-2 w-2"})})]})]})]})]})})]}),e.jsxs(Lt,{className:"bg-gradient-to-br from-gray-50 via-white to-slate-50 border border-gray-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-500/5 to-slate-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsxs(ms,{className:`pb-2 px-4 pt-4 relative z-10 ${Y?"sticky top-0 z-20 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/60":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Bs,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[!Y&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-gray-100 to-slate-200 rounded-lg",children:e.jsx(fn,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-600"})}),e.jsx("span",{className:"bg-gradient-to-r from-gray-600 to-slate-600 bg-clip-text text-transparent",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!Y&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(Au,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx(q,{placeholder:"بحث...",value:No,onChange:s=>Nm(s.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!Y&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"تقسيط"}),e.jsx(u,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{if(Pt||zt){r({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"});return}Vn(!0)},title:"إدارة التقسيط",children:e.jsx(Nu,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-green-600 mb-1",children:"شحن"}),e.jsx(u,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 ring-3 ring-green-300 transition-all duration-200 hover:scale-105 active:bg-green-600 active:text-white active:border-green-600",onClick:()=>{r({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."})},title:"شحن الرصيد",children:e.jsx(An,{className:"h-5 w-5 text-green-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(u,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>Ji(!0),title:"آلة حاسبة",children:e.jsx(Cd,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(u,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{Pt||zt?r({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Jn(!0)},title:"كروت الائتمان",children:e.jsx(An,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"تقاريرك"}),e.jsx(u,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:()=>{if(Pt||zt){r({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"});return}uc(!0)},title:"تقاريرك",children:e.jsx(Zu,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(u,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:vh,title:y&&(v!=null&&v.name||v!=null&&v.username)?`بروفيل الوردية: ${(v==null?void 0:v.name)||(v==null?void 0:v.username)}`:"وردية الكاشير",children:e.jsx(Sn,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(u,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{Pt||zt?r({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Hr(!0)},title:"بيانات المبيعات",children:e.jsx(Xc,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),Tt.filter(s=>s.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:Tt.filter(s=>s.status==="pending").length})]}),e.jsx(u,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{nl()},title:"الديون",children:e.jsx(ju,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(u,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105 active:bg-amber-600 active:text-white active:border-amber-600",onClick:()=>{Pt||zt?r({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Kn(!0)},title:"الصيانة",children:e.jsx(Nd,{className:"h-5 w-5 text-amber-700"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(u,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-50 text-violet-700 hover:bg-violet-100 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105 active:bg-violet-700 active:text-white active:border-violet-700",onClick:()=>{!ba||zt?r({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Yn(!0)},title:"يومية المكنة",children:e.jsx(_d,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(u,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105 active:bg-orange-600 active:text-white active:border-orange-600",onClick:()=>{Pt||zt?r({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):_s.hasMasterPin()?Us(!0):Xt(!0)},title:"مصروفات المحل",children:e.jsx(Tn,{className:"h-5 w-5 text-orange-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-rose-600 mb-1",children:"النواقص"}),e.jsx(u,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-rose-50 text-rose-600 hover:bg-rose-100 border border-rose-200 ring-3 ring-rose-300 transition-all duration-200 hover:scale-105 active:bg-rose-600 active:text-white active:border-rose-600",onClick:()=>{Pt||zt?r({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Ia(!0)},title:"النواقص",children:e.jsx(Hc,{className:"h-5 w-5 text-rose-600"})})]})]})]})]}),!Y&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"filters-bar flex items-center justify-center gap-3 bg-gray-50 rounded-md p-3 border border-gray-200",children:[e.jsx(u,{variant:"ghost",size:"sm",className:`btn-filter-send h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${Pa==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>Wi("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(u,{variant:"ghost",size:"sm",className:`btn-filter-withdraw h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${Pa==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-50"}`,onClick:()=>Wi("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(u,{variant:"ghost",size:"sm",className:`btn-filter-all h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${Pa==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>Wi("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(u,{variant:"ghost",size:"sm",className:"h-8 px-3 text-[12px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>sn(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(ds,{className:"h-3.5 w-3.5 mr-1"}),"تصفير"]}),Ph>0&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),e.jsx(Ds,{open:Am,onOpenChange:Vn,mode:"verify",title:"فتح إدارة التقسيط",description:"أدخل الرقم السري الرئيسي للوصول إلى إدارة التقسيط",onSuccess:()=>{Vn(!1),Po(!0)}}),e.jsx(ku,{open:Tm,onOpenChange:Po}),To,e.jsxs(Bt,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:[$l.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(fn,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):Y?e.jsx("div",{className:"overflow-y-auto overscroll-contain scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[310px]",children:e.jsx("div",{className:"space-y-2 pr-2",children:$l.map(s=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-colors duration-100 hover:bg-gray-50",onClick:()=>_c(s),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.status==="completed"&&e.jsx(nr,{className:`h-4 w-4 ${s.type==="withdraw"?"text-red-500":"text-green-500"}`}),s.status==="pending"&&e.jsx(La,{className:"h-4 w-4 text-yellow-500"}),s.status==="failed"&&e.jsx(Pi,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const a=s,n=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`font-medium text-sm ${n||l?"text-gray-800":s.type==="send"?"text-green-700":"text-red-700"}`,children:n?"إيصال تسليم وردية":l?`إيصال إضافة نقدية - ${Es(s.amount)} جنيه`:(s.type==="send"?"تحويل":"سحب")+` - ${Es(s.amount)} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(s==null?void 0:s.cashierName)??"الحساب الرئيسي"]}),(()=>{const a=s,n=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية"),c=(a==null?void 0:a.note)||(a==null?void 0:a.notes)||"";return e.jsx("p",{className:`text-xs ${n||l?"text-gray-500":s.type==="send"?"text-green-600":"text-red-500"}`,children:n?`تم التسليم إلى: ${s.receiverPhone}`:l?c?`ملاحظة: ${c}`:"تمت إضافة نقدية للدرج":`من ${s.senderPhone}${s.type==="send"?` إلى ${s.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[Si.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))," - ",Mc.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))]})]})]}),e.jsx(Gt,{variant:s.status==="completed"?"default":s.status==="pending"?"secondary":"destructive",className:`text-xs ${s.status==="completed"?s.type==="withdraw"?"bg-red-100 text-red-700 border-red-300":s.type==="send"?"bg-green-100 text-green-700 border-green-300":"":""}`,children:s.status==="completed"?"مكتمل":s.status==="pending"?"قيد المعالجة":"فشل"})]},s.id))})}):e.jsx("div",{className:"overflow-y-auto overscroll-contain scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[calc(100dvh-300px)]",children:e.jsx("div",{className:"space-y-2 pr-2",children:$l.map(s=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-colors duration-100 hover:bg-gray-50",onClick:()=>_c(s),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.status==="completed"&&e.jsx(nr,{className:`h-4 w-4 ${s.type==="withdraw"?"text-red-500":"text-green-500"}`}),s.status==="pending"&&e.jsx(La,{className:"h-4 w-4 text-yellow-500"}),s.status==="failed"&&e.jsx(Pi,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const a=s,n=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`font-medium text-sm ${n||l?"text-gray-800":s.type==="send"?"text-green-700":"text-red-700"}`,children:n?"إيصال تسليم وردية":l?`إيصال إضافة نقدية - ${Es(s.amount)} جنيه`:(s.type==="send"?"تحويل":"سحب")+` - ${Es(s.amount)} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(s==null?void 0:s.cashierName)??"الحساب الرئيسي"]}),(()=>{const a=s,n=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية"),c=(a==null?void 0:a.note)||(a==null?void 0:a.notes)||"";return e.jsx("p",{className:`text-xs ${n||l?"text-gray-500":s.type==="send"?"text-green-600":"text-red-500"}`,children:n?`تم التسليم إلى: ${s.receiverPhone}`:l?c?`ملاحظة: ${c}`:"تمت إضافة نقدية للدرج":`من ${s.senderPhone}${s.type==="send"?` إلى ${s.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[Si.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))," - ",Mc.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))]})]})]}),e.jsx(Gt,{variant:s.status==="completed"?"default":s.status==="pending"?"secondary":"destructive",className:`text-xs ${s.status==="completed"?s.type==="withdraw"?"bg-red-100 text-red-700 border-red-300":s.type==="send"?"bg-green-100 text-green-700 border-green-300":"":""}`,children:s.status==="completed"?"مكتمل":s.status==="pending"?"قيد المعالجة":"فشل"})]},s.id))})}),Y&&e.jsxs("div",{className:"mt-2 flex justify-end",children:[e.jsxs(u,{variant:"ghost",size:"sm",className:"h-7 px-2 text-[11px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>sn(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(ds,{className:"h-3 w-3 mr-1"}),"تصفير"]}),(t==null?void 0:t.uid)&&localStorage.getItem(`recentTransactionsResetAt:${t.uid}`)&&e.jsx("span",{className:"inline-block h-1.5 w-1.5 rounded-full bg-red-500 ml-1 align-middle"})]})]})]})]}),e.jsx(_u,{isOpen:xm,onClose:()=>Un(!1),transaction:pm,onPrint:()=>window.print(),onDelete:vm,onComplete:wm}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full lg:w-[92%] xl:w-[95%] mx-auto",children:[e.jsxs(Lt,{id:"transaction-section",className:"bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/50 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx(ms,{className:"sticky top-0 z-20 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Bs,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(nr,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[Kt&&e.jsx("div",{className:"hidden md:flex items-center gap-1 bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 border border-emerald-200 text-emerald-800 text-sm transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:e.jsxs("span",{className:"text-sm font-semibold whitespace-nowrap",children:["تجربة: ",fa," ",fa>=3&&fa<=10?"ساعات":fa===2?"ساعتين":"ساعة"]})}),e.jsxs("div",{className:"top-icons-bar hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:[e.jsx(Ix,{}),e.jsx(u,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"VIP",onClick:()=>Ki(!0),children:e.jsx(Hu,{className:"h-5 w-5 text-yellow-500"})}),e.jsx(u,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"إدارة الفروع",onClick:()=>{r({title:"قيد التطوير",description:"إدارة الفرع قيد التطوير حالياً"})},children:e.jsx(Id,{className:"h-5 w-5"})}),e.jsx(Tu,{})]})]}),Rh&&e.jsxs(u,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:Cc,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx(Mu,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsx(Ne,{open:Fm,onOpenChange:Ki,children:e.jsxs(je,{className:"sm:max-w-md",children:[e.jsx(Se,{children:e.jsx(De,{children:"أفضل 10 عملاء هذا الشهر"})}),e.jsx("div",{className:"space-y-2",children:yi.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا توجد بيانات لهذا الشهر"}):yi.map((s,a)=>e.jsxs("div",{className:`flex items-center justify-between border rounded-md px-3 py-2 bg-white ${a===0?"bg-yellow-50 border-yellow-300":""}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Gt,{variant:"outline",className:`min-w-[28px] justify-center ${a===0?"border-yellow-300 text-yellow-700 bg-yellow-50":""}`,children:a+1}),e.jsx("span",{className:`font-semibold ${a===0?"text-yellow-700":""}`,children:s.phone})]}),e.jsxs("div",{className:"text-sm text-gray-700 flex items-center gap-3",children:[e.jsxs("span",{children:["عدد: ",s.count]}),e.jsxs("span",{children:["إجمالي: ",s.total]}),e.jsx(u,{variant:"outline",size:"sm",className:"h-8",onClick:()=>_h(s),title:"إرسال واتساب",children:e.jsx(Qc,{className:"h-4 w-4"})})]})]},s.phone+a))}),e.jsx(ht,{children:e.jsx(u,{onClick:()=>Ki(!1),children:"إغلاق"})})]})}),e.jsx(Ne,{open:Rm,onOpenChange:_o,children:e.jsxs(je,{className:"sm:max-w-md",children:[e.jsx(Se,{children:e.jsx(De,{children:"ربط بوت التلجرام"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(te,{children:"Telegram Chat ID"}),e.jsx(q,{value:Qn,onChange:s=>$m(s.target.value),placeholder:"اكتب رقم المحادثة"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(te,{children:"إرسال يومي 12 صباحاً"}),e.jsx(Ru,{checked:Eo,onCheckedChange:s=>Lm(!!s)})]})]}),e.jsxs(ht,{children:[e.jsx(u,{variant:"outline",onClick:()=>_o(!1),children:"إغلاق"}),e.jsx(u,{onClick:async()=>{t!=null&&t.uid&&(await ve.updateUserData(t.uid,{telegramChatId:Qn,telegramDailyEnabled:Eo}),r({title:"تم الحفظ"}))},children:"حفظ"}),e.jsx(u,{onClick:async()=>{if(!(t!=null&&t.uid)||!Qn){r({title:"أدخل Chat ID"});return}const s=await Eh();try{const{sendTelegramMessage:a}=await bt(async()=>{const{sendTelegramMessage:n}=await Promise.resolve().then(()=>xx);return{sendTelegramMessage:n}},void 0,import.meta.url);await a({chatId:Qn,text:s}),r({title:"تم الإرسال"})}catch{r({title:"تعذر الإرسال",description:"تحقق من ربط البوت",variant:"destructive"})}},children:"إرسال الآن"})]})]})}),e.jsx(Ne,{open:he,onOpenChange:ye,children:e.jsxs(je,{className:"sm:max-w-lg",children:[e.jsxs(Se,{children:[e.jsx(De,{children:"إدارة الفروع"}),e.jsx(Ss,{children:"أضف فروع جديدة وأدِر الدخول لكل فرع"}),e.jsx("div",{className:"flex items-center justify-end gap-2 mt-2",children:e.jsx(u,{variant:"outline",size:"sm",onClick:()=>{try{const s=t!=null&&t.uid?`selectedShopId_${t.uid}`:"selectedShopId";localStorage.removeItem(s);try{window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}r({title:"تم الخروج من الفرع"}),$(`/branch/${String(b.shopId)}/dashboard`)}catch{}},children:"الخروج من الفرع"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(te,{children:"اسم المدير"}),e.jsx(q,{value:We,onChange:s=>_e(s.target.value),placeholder:"اكتب اسم المدير"})]}),e.jsxs("div",{children:[e.jsx(te,{children:"اسم الفرع"}),e.jsx(q,{value:Qe,onChange:s=>Ge(s.target.value),placeholder:"اكتب اسم الفرع"})]}),e.jsxs("div",{children:[e.jsx(te,{children:"اسم المستخدم للدخول"}),e.jsx(q,{value:Nt,onChange:s=>re(s.target.value),placeholder:"مثال: branch1"})]}),e.jsxs("div",{children:[e.jsx(te,{children:"كلمة السر"}),e.jsx(q,{type:"password",value:Ie,onChange:s=>nt(s.target.value),placeholder:"••••••"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(u,{variant:"outline",onClick:()=>{_e(""),Ge(""),re(""),nt("")},children:"مسح"}),e.jsx(u,{className:"bg-indigo-600 hover:bg-indigo-700",disabled:ue,onClick:async()=>{if(!(t!=null&&t.uid))return;const s=We.trim(),a=Qe.trim(),n=Nt.trim(),l=Ie.trim();if(!s||!a||!n||!l){r({title:"يرجى ملء جميع الحقول"});return}if(se.length>=3){r({title:"عفواً",description:"لقد وصلت للحد الأقصى من الفروع (3 فروع)",variant:"destructive"});return}try{Pe(!0);let c="";try{c=(await ca(Ce(V,"shops"),{name:a,ownerId:t.uid,createdAt:ft(),updatedAt:ft(),isActive:!0})).id}catch{c=(await ca(Ce(V,"users",t.uid,"shops"),{name:a,ownerId:t.uid,createdAt:ft(),updatedAt:ft(),isActive:!0})).id}const h=x=>{try{return btoa(unescape(encodeURIComponent(x)))}catch{return btoa(x)}};try{await ca(Ce(V,"branches"),{ownerId:t.uid,shopId:c,branchName:a,managerName:s,loginUsername:n,passwordEncoded:h(l),createdAt:ft()})}catch{await ca(Ce(V,"users",t.uid,"branches"),{ownerId:t.uid,shopId:c,branchName:a,managerName:s,loginUsername:n,passwordEncoded:h(l),createdAt:ft()})}try{const x=Ke(Ce(V,"branches"),me("ownerId","==",t.uid));let D=(await et(x)).docs.map(p=>({id:p.id,...p.data()}));if(D.length===0){const p=Ke(Ce(V,"users",t.uid,"branches"));D=(await et(p)).docs.map(A=>({id:A.id,...A.data()}))}Fe(D)}catch{try{const x=Ke(Ce(V,"users",t.uid,"branches")),D=(await et(x)).docs.map(p=>({id:p.id,...p.data()}));Fe(D)}catch{}}_e(""),Ge(""),re(""),nt(""),r({title:"تم إضافة الفرع بنجاح"})}catch{r({title:"تعذّر إضافة الفرع"})}finally{Pe(!1)}},children:"إضافة فرع"})]}),e.jsxs("div",{className:"border-t pt-3",children:[e.jsx("h4",{className:"text-sm font-semibold mb-2",children:"الفروع الحالية"}),ue?e.jsx("div",{className:"text-sm text-gray-500",children:"جارٍ التحميل..."}):se.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"لا يوجد فروع بعد"}):e.jsx("div",{className:"space-y-2",children:se.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-lg bg-white",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:s.branchName}),e.jsxs("div",{className:"text-gray-600",children:["مدير: ",s.managerName]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{size:"sm",className:"bg-blue-600 hover:bg-blue-700",onClick:()=>{Zt(s),Ye(String(s.loginUsername||"")),Re(""),Ft(!0)},children:"دخول الفرع"}),e.jsx(u,{size:"sm",variant:"destructive",onClick:async()=>{if(confirm("هل أنت متأكد من حذف الفرع؟ سيتم حذف بيانات الفرع المرتبطة."))try{try{await Ws(Ve(V,"branches",s.id))}catch{}try{await Ws(Ve(V,"users",(t==null?void 0:t.uid)||"","branches",s.id))}catch{}if(s.shopId){try{await Ws(Ve(V,"shops",String(s.shopId)))}catch{}try{await Ws(Ve(V,"users",(t==null?void 0:t.uid)||"","shops",String(s.shopId)))}catch{}}Fe(a=>a.filter(n=>n.id!==s.id)),r({title:"تم حذف الفرع"})}catch{r({title:"تعذّر حذف الفرع"})}},children:"حذف الفرع"})]})]},s.id))})]})]})]})}),e.jsx(Ne,{open:Dt,onOpenChange:Ft,children:e.jsxs(je,{className:"sm:max-w-md",children:[e.jsxs(Se,{children:[e.jsx(De,{children:"دخول الفرع"}),e.jsx(Ss,{children:"أدخل بيانات الدخول للفرع المحدد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(te,{children:"اسم المستخدم"}),e.jsx(q,{value:Me,onChange:s=>Ye(s.target.value),placeholder:"اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(te,{children:"كلمة السر"}),e.jsx(q,{type:"password",value:ct,onChange:s=>Re(s.target.value),placeholder:"••••••"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(u,{variant:"outline",onClick:()=>{Ye(""),Re("")},children:"مسح"}),e.jsx(u,{className:"bg-blue-600 hover:bg-blue-700",disabled:Xe,onClick:async()=>{const s=Rt;if(!s){Ft(!1);return}const a=String(s.loginUsername||"");let n="";try{const h=String(s.passwordEncoded||"");n=h?decodeURIComponent(escape(atob(h))):""}catch{try{n=s.passwordEncoded?atob(String(s.passwordEncoded)):""}catch{n=""}}const l=Me.trim(),c=ct.trim();if(!l||!c){r({title:"يرجى إدخال اسم المستخدم وكلمة السر"});return}if(l!==a||c!==n){r({title:"بيانات الدخول غير صحيحة",variant:"destructive"});return}try{ee(!0);const h=t!=null&&t.uid?`selectedShopId_${t.uid}`:"selectedShopId";localStorage.setItem(h,String(s.shopId)),r({title:"تم الدخول إلى الفرع",description:String(s.branchName||"")}),Ft(!1),ye(!1),$("/user/dashboard")}catch{}ee(!1)},children:"دخول"})]})]})]})}),e.jsxs(Bt,{ref:m,className:"space-y-1 px-2 pb-2 relative z-10 transition-transform duration-200 ease-out will-change-transform",style:{transform:o?`translateY(${o}px)`:void 0},onFocusCapture:s=>{const a=s.target;if(!((a==null?void 0:a.id)==="transferExtraFeeInput")){f(0);return}const l=document.getElementById("transferSubmitButton");if(l){const c=l.getBoundingClientRect(),h=window.innerHeight;if(c.bottom>h){const x=c.bottom-h,g=Math.min(x,220);f(-g)}else f(0)}else f(0)},onBlurCapture:s=>{s.currentTarget.contains(s.relatedTarget)||f(0)},children:[e.jsxs("div",{className:"transaction-type-tabs grid grid-cols-2 gap-0.5 p-0.5 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-200/50 fade-in-up w-full lg:w-[92%] xl:w-[95%] mx-auto ",children:[e.jsxs(u,{variant:le==="transfer"?"default":"ghost",onClick:()=>ji("transfer"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${le==="transfer"?"bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg hover:shadow-md hover:from-blue-600 hover:to-indigo-700":"text-gray-600 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-700 hover:border-blue-200"}`,children:[e.jsx(fn,{className:"h-1 w-1 mr-1"}),"تحويل"]}),e.jsxs(u,{variant:le==="withdraw"?"default":"ghost",onClick:()=>ji("withdraw"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${le==="withdraw"?"bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-lg hover:shadow-md hover:from-emerald-600 hover:to-green-700":"text-gray-600 hover:bg-gradient-to-r hover:from-emerald-50 hover:to-green-50 hover:text-emerald-700 hover:border-emerald-200"}`,children:[e.jsx(ki,{className:"h-1 w-1 mr-1"}),"سحب"]})]}),e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(ja,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(u,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>$("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(ks,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(u,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>{jr(!0)},title:"المحافظ",children:[e.jsx(ja,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),Je.length>0?e.jsxs(Ga,{value:U,onValueChange:Lh,children:[e.jsx(Za,{"data-testid":"wallet-select",className:"selected-number-card w-full h-12 text-sm bg-gradient-to-r from-white to-gray-50 border-2 border-gray-200 hover:border-blue-400 focus:border-blue-500 rounded-xl transition-all duration-300 hover:shadow-md focus:shadow-lg",children:e.jsx(Xa,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-600"})}),e.jsxs(er,{className:"rounded-xl border-2 border-gray-200 shadow-md z-[9999]",children:[e.jsx("div",{"data-fixed-header":"true",className:"sticky top-0 z-10 bg-white p-2 border-b border-gray-200",children:e.jsx(q,{value:xo,onChange:s=>mm(s.target.value),placeholder:"ابحث برقم المحفظة",className:"h-6 text-xs"})}),e.jsx("div",{className:"pr-1",children:po.length===0?e.jsx("div",{className:"text-xs text-gray-500 p-2",children:"لا توجد نتائج مطابقة"}):po.map(s=>e.jsx(ua,{value:s.id,className:"rounded-lg hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200",children:e.jsxs("div",{className:"flex items-center gap-1 py-1 w-full justify-between",children:[e.jsx("div",{className:"p-1 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg",children:e.jsx(ja,{className:"h-1 w-1 text-blue-600"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-800",children:s.name}),e.jsxs("span",{className:"text-sm font-semibold text-red-600",children:["(",s.phone,")"]})]}),s.isDefault&&e.jsx(Gt,{variant:"secondary",className:"text-[10px] bg-gradient-to-r from-emerald-100 to-green-100 text-emerald-700 border-emerald-200",children:"افتراضي"})]}),e.jsx("div",{className:"ml-auto flex flex-col items-end gap-1"})]})},s.id))})]})]}):e.jsx("div",{className:"rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 px-3 py-3 text-xs text-gray-600",children:"لا توجد محافظ حتى الآن. اضغط “إضافة محفظة” لإضافة أول محفظة."})]}),e.jsx(Ne,{open:Mn,onOpenChange:Mi,children:e.jsxs(je,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(Se,{children:e.jsx(De,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(Vu,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),e.jsx(Ds,{open:Nr,onOpenChange:jr,mode:"verify",title:"الرقم السري لفتح المحافظ",description:"أدخل الرقم السري الرئيسي لعرض وإدارة المحافظ",onSuccess:()=>{jr(!1),Mi(!0)},userId:t==null?void 0:t.uid}),e.jsx(Ds,{open:Rn,onOpenChange:s=>{Sr(s),s||Yr(null)},mode:"verify",title:"تأكيد تغيير المحفظة",description:"أدخل الرقم السري الرئيسي لتغيير المحفظة المختارة",onSuccess:()=>{$n&&(cn($n,"walletSelectionPin"),Yr(null)),Sr(!1)},userId:t==null?void 0:t.uid}),e.jsx(Ne,{open:rm,onOpenChange:Ln,children:e.jsxs(je,{className:"sm:max-w-md",children:[e.jsx(Se,{children:e.jsxs(De,{className:"flex items-center gap-2 text-red-700",children:[e.jsx(Hc,{className:"h-5 w-5 text-red-600"}),"تحذير حد شهري للمحفظة"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded-md border bg-red-50 border-red-200",children:[e.jsxs("p",{className:"text-sm text-red-800",children:["المحفظة: ",e.jsx("span",{className:"font-semibold",children:(na==null?void 0:na.walletName)||""})]}),e.jsxs("p",{className:"text-sm text-red-800",children:["الاستخدام الشهري (",(na==null?void 0:na.type)==="withdraw"?"سحب":"تحويل","):",e.jsxs("span",{className:"font-mono",children:[" ",Number((na==null?void 0:na.used)||0).toLocaleString("en-US")," "]})," جنيه"]}),e.jsxs("p",{className:"text-sm text-red-800",children:["الحد الشهري: ",e.jsx("span",{className:"font-mono",children:Number((na==null?void 0:na.limit)||0).toLocaleString("en-US")})," جنيه"]}),e.jsx("p",{className:"text-sm font-semibold text-red-900 mt-1",children:"تم الوصول إلى 85% من الحد الشهري — يرجى الحذر قبل الاستمرار."})]}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsx(u,{variant:"outline",onClick:()=>Ln(!1),children:"حسناً"})})]})]})}),U&&Je.length>0&&(()=>{var J;const s=Je.find(ae=>ae.id===U),a=_a,n=Bh(U),l=(rt==null?void 0:rt.monthlyWithdrawLimit)??(s==null?void 0:s.monthlyWithdrawalLimit)??2e5,c=(rt==null?void 0:rt.monthlyTransferLimit)??(s==null?void 0:s.monthlyTransferLimit)??2e5,h=(rt==null?void 0:rt.monthlyWithdrawUsed)??a.totalWithdrawn??0,x=(rt==null?void 0:rt.monthlyTransferUsed)??a.totalTransferred??0,g=((J=at==null?void 0:at.subscription)==null?void 0:J.planType)===Gs.TAHWEELA,D=g?0:(rt==null?void 0:rt.dailyWithdrawLimit)??1e5,p=g?0:(rt==null?void 0:rt.dailyTransferLimit)??6e4,w=g?0:(rt==null?void 0:rt.dailyWithdrawUsed)??n.totalWithdrawn??0,A=g?0:(rt==null?void 0:rt.dailyTransferUsed)??n.totalTransferred??0,T=parseFloat(as||"0")||0,P=h+(le==="withdraw"?T:0),Q=x+(le==="transfer"?T:0),$e=w+(le==="withdraw"?T:0),B=A+(le==="transfer"?T:0);return s?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود الشهرية: ",sc||(s==null?void 0:s.name)||"المحفظة المختارة"]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(P/Math.max(l,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Q/Math.max(c,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-red-600 font-medium",children:["متبقي سحب: ",Math.max(l-P,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(c-Q,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود اليومية: ",sc||(s==null?void 0:s.name)||"المحفظة المختارة"]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min($e/Math.max(D,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(B/Math.max(p,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(D-$e,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(p-B,0).toLocaleString("en-US")," جنيه"]})]})]})]}):null})(),le==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative",children:[e.jsx($a,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(q,{value:qs,onChange:s=>Ba(s.target.value),onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("receiverPhoneInput");if(a)a.focus();else{const n=document.getElementById("amountInput");n==null||n.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),!R&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx($a,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(q,{id:"receiverPhoneInput",value:gs,onChange:s=>{Ua(s.target.value),qi&&Ir(!1)},onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("amountInput");a==null||a.focus()}},inputMode:"numeric",maxLength:11,placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx($a,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(q,{value:U&&(($c=Je.find(s=>s.id===U))==null?void 0:$c.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base bg-gray-50 transition-all duration-300"})]})]}),le==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(Ht,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(q,{id:"amountInput",value:as,onChange:s=>{d(s.target.value),qi&&Ir(!1)},onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("transferCommissionInput");if(a)a.focus();else{const n=document.getElementById("quickDebtButton");n==null||n.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),fs?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",fs.debtorName," بمبلغ ",fs.amount," جنيه"]}),e.jsx(u,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>Aa(null),children:"إلغاء"})]}):null]}),(()=>{if(R)return null;const s=ls();return s&&s.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",s==null?void 0:s.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(u,{id:"quickDebtButton",type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const n=ls(),l=(n==null?void 0:n.defaultTransferCommission)!=null?Number(n.defaultTransferCommission):0,c=parseFloat(as||"0")||0,h=Math.round((l||0)*c/1e3*100)/100,x=c+h;xe((x||0).toString()),Pt?r({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ze(!0)},children:"أجل"}),e.jsx(u,{type:"button",variant:"outline",size:"icon",className:"hidden",title:St?"العمولة تُضاف":"العمولة تُخصم",children:St?e.jsx(ks,{className:"h-4 w-4 text-green-600"}):e.jsx(xr,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:St?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Ht,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(q,{id:"transferCommissionInput",value:bs,onChange:n=>$i(n.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx(u,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const n=ls(),l=parseFloat(as||"0")||0;let c=0;if((n==null?void 0:n.defaultTransferCommission)!=null){const x=Number(n.defaultTransferCommission)||0;c=Math.round(x*l/1e3*100)/100}else{const x=bs&&bs.trim()!==""?parseFloat(bs):0;c=Math.max(0,x)}const h=l+c;xe((h||0).toString()),Pt?r({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ze(!0)},children:"أجل"}),e.jsx(u,{type:"button",variant:"outline",size:"icon",className:"hidden",title:St?"العمولة تُضاف":"العمولة تُخصم",children:St?e.jsx(ks,{className:"h-4 w-4 text-green-600"}):e.jsx(xr,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:St?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),(()=>{const s=Fn(qs||"").replace(/\D/g,""),a=Fn(gs||"").replace(/\D/g,"");return le==="transfer"&&(s.startsWith("010")&&(a.startsWith("011")||a.startsWith("012")||a.startsWith("015"))||s.startsWith("012")&&a.startsWith("010")||s.startsWith("011")&&a.startsWith("010")||s.startsWith("015")&&a.startsWith("010"))?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رسوم التحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ht,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(q,{id:"transferExtraFeeInput",value:co,onChange:l=>am(l.target.value),placeholder:"أدخل رسوم التحويل",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"hidden",children:"تُخصم من المحفظة وتضاف للدرج — لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010"})]}):null})(),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(u,{id:"transferSubmitButton",onClick:Oc,className:"btn-transfer-confirm w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 text-white",children:qi?"تم التحويل بنجاح":"تأكيد التحويل"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(ki,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-green-500"}),e.jsx(q,{id:"amountInput",value:as,onChange:s=>{d(s.target.value),Co&&Zr(!1)},onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("manualWithdrawCommissionInput");if(a)a.focus();else{const n=document.getElementById("withdrawSubmitButton");n==null||n.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),nm&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"اسم الراسل (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Sn,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-500"}),e.jsx(q,{id:"withdrawSenderNameInput",value:X,onChange:s=>K(s.target.value),onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("manualWithdrawCommissionInput");a==null||a.focus()}},placeholder:"أدخل اسم الراسل إن وجد",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500",type:"text"})]})]}),(()=>{const s=ls();return s&&s.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",s==null?void 0:s.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(u,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const n=ls(),l=parseFloat(as||"0")||0,c=(n==null?void 0:n.defaultWithdrawCommission)!=null&&Number(n.defaultWithdrawCommission)||0,h=Math.round(c*l/1e3*100)/100,x=St?l+h:l;xe((x||0).toString()),Pt?r({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ze(!0)},children:"أجل"}),e.jsx(u,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>Fi(n=>!n),title:St?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:St?e.jsx(ks,{className:"h-4 w-4"}):e.jsx(xr,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:St?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ht,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(q,{id:"manualWithdrawCommissionInput",value:ys,onChange:n=>Ri(n.target.value),onKeyDown:n=>{if(n.key==="Enter"){const l=document.getElementById("withdrawSubmitButton");l==null||l.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(u,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const n=ls(),l=parseFloat(as||"0")||0;let c=0;if((n==null?void 0:n.defaultWithdrawCommission)!=null){const x=Number(n.defaultWithdrawCommission)||0;c=Math.round(x*l/1e3*100)/100}else{const x=ys&&ys.trim()!==""?parseFloat(ys):Math.round(l*.01*100)/100;c=Math.max(0,x)}const h=St?l+c:l;xe((h||0).toString()),Pt?r({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ze(!0)},children:"أجل"}),e.jsx(u,{type:"button",variant:"outline",size:"icon",title:St?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>Fi(n=>!n),children:St?e.jsx(ks,{className:"h-4 w-4 text-green-600"}):e.jsx(xr,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:St?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),(j==null?void 0:j.showWithdrawNote)&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"ملاحظة السحب (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Qc,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(q,{id:"withdrawNoteInput",value:I,onChange:s=>O(s.target.value),onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("withdrawSubmitButton");a==null||a.focus()}},placeholder:"أدخل ملاحظة للسحب (اختياري)",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(u,{id:"withdrawSubmitButton",onClick:Oc,className:"w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:Co?"تم السحب بنجاح":"تأكيد السحب"})})]}),e.jsx(Ne,{open:Ae,onOpenChange:ze,children:e.jsxs(je,{children:[e.jsxs(Se,{children:[e.jsx(De,{children:"تحويل مؤجل"}),e.jsx(Ss,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[ea&&ea.length>0?e.jsxs("div",{children:[e.jsx(te,{children:"اختيار عميل"}),e.jsxs(Ga,{value:Xs,onValueChange:s=>{ma(s);const a=ea.find(n=>n.id===s);a&&Oe(a.name)},children:[e.jsx(Za,{className:"w-full",children:e.jsx(Xa,{placeholder:"اختر عميل"})}),e.jsx(er,{children:ea.map(s=>e.jsxs(ua,{value:s.id,children:[s.name,s.mobile?` — ${s.mobile}`:""]},s.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(te,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx(q,{id:"quickDebtName",value:Ue,onChange:s=>Oe(s.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(te,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx(q,{id:"quickDebtAmount",type:"number",value:qe,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(te,{htmlFor:"quickDebtCommission",children:"العمولة (محسوبة تلقائياً)"}),e.jsx(q,{id:"quickDebtCommission",type:"number",value:function(){const s=ls(),a=parseFloat((as||"0").toString())||0;let n=0;if(le==="transfer")if((s==null?void 0:s.defaultTransferCommission)!=null){const l=Number(s.defaultTransferCommission)||0;n=Math.round(l*a/1e3*100)/100}else{const l=bs&&bs.trim()!==""?parseFloat(bs):0;n=Math.max(0,l)}else if((s==null?void 0:s.defaultWithdrawCommission)!=null){const l=Number(s.defaultWithdrawCommission)||0;n=Math.round(l*a/1e3*100)/100}else{const l=ys&&ys.trim()!==""?parseFloat(ys):Math.round(a*.01*100)/100;n=Math.max(0,l)}return String(n||0)}(),readOnly:!0,placeholder:"قيمة العمولة"})]}),e.jsxs("div",{children:[e.jsx(te,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx(q,{id:"quickDebtNotes",value:It,onChange:s=>Is(s.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(ht,{children:e.jsx(u,{type:"button",variant:"default",className:"bg-green-600 text-white hover:bg-green-700",onClick:()=>{const s=ls(),a=parseFloat((as||"").toString())||0;let n=0;if(le==="transfer")if((s==null?void 0:s.defaultTransferCommission)!=null){const h=Number(s.defaultTransferCommission)||0;n=Math.round(h*a/1e3*100)/100}else{const h=bs&&bs.trim()!==""?parseFloat(bs):0;n=Math.max(0,h)}else if((s==null?void 0:s.defaultWithdrawCommission)!=null){const h=Number(s.defaultWithdrawCommission)||0;n=Math.round(h*a/1e3*100)/100}else{const h=ys&&ys.trim()!==""?parseFloat(ys):Math.round(a*.01*100)/100;n=Math.max(0,h)}let l=0;if(le==="withdraw"?l=St?a:Math.max(0,Math.round((a-n)*100)/100):l=Math.max(0,Math.round((a+n)*100)/100),!Ue||isNaN(l)||l<=0){r({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const c=ea.find(h=>h.id===Xs);Aa({debtorName:Ue,amount:l,notes:It,customerId:Xs||void 0,mobile:c==null?void 0:c.mobile}),Ta(!1),ze(!1),r({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx(Lt,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(Bt,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(bx,{isOpen:om,onClose:()=>cm(!1),initialEditingWallet:dm,onWalletUpdate:async()=>{try{await Rl()}catch(s){console.error("Error reloading wallets after update:",s)}}}),e.jsx(vx,{isOpen:um,onClose:()=>go(!1),transaction:hm,onDelete:Fh}),e.jsx(Ds,{open:ym,onOpenChange:Qr,onSuccess:zh,title:qh(),description:Vh(),mode:"verify"}),e.jsx(id,{open:lh,onOpenChange:nc,onSuccess:Kh,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:Mt,balanceLabel:"الرصيد النقدي",userId:t==null?void 0:t.uid}),e.jsx(id,{open:oh,onOpenChange:ic,onSuccess:Yh,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:Ys&&lt[Ys]||0,balanceLabel:`رصيد ${((Lc=Je.find(s=>s.id===Ys))==null?void 0:Lc.name)||"المحفظة"}`,userId:t==null?void 0:t.uid}),e.jsx(Sx,{open:ch,onOpenChange:yl,onSuccess:Hh,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:Ys&&lt[Ys]||0,balanceLabel:`رصيد ${((Fc=Je.find(s=>s.id===Ys))==null?void 0:Fc.name)||"المحفظة"}`,userId:t==null?void 0:t.uid}),e.jsx(wx,{open:wh,onOpenChange:Nh,userId:t==null?void 0:t.uid}),e.jsx(Nx,{open:jh,onOpenChange:Sh,userId:t==null?void 0:t.uid}),e.jsx(jx,{open:Dh,onOpenChange:Ch}),e.jsx(Ne,{open:hh,onOpenChange:ni,children:e.jsxs(je,{className:"sm:max-w-md",children:[e.jsx(Se,{children:e.jsx(De,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(te,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(q,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:vl,onChange:s=>ii(s.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(u,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:async()=>{if(!await Ni(Tl)){r({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const s=parseFloat(vl);if(isNaN(s)||s<=0){r({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Mt+s;Qt(a);const n={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(l,JSON.stringify(n)),t!=null&&t.uid?ve.updateUserData(t.uid,n).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),tt(!1)}).catch(c=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",c),tt(!0)}):tt(!0),r({title:"تم بنجاح",description:`تم إضافة ${s} جنيه إلى الدرج النقدية وحفظه في السحابة`}),ni(!1),ii(""),mi("")},children:[e.jsx(ks,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(u,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:async()=>{if(!await Ni(Tl)){r({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const s=parseFloat(vl);if(isNaN(s)||s<=0){r({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Mt-s;Qt(a);const n={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(l,JSON.stringify(n)),t!=null&&t.uid?ve.updateUserData(t.uid,n).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),tt(!1)}).catch(c=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",c),tt(!0)}):tt(!0),r({title:"تم بنجاح",description:`تم خصم ${s} جنيه من الدرج النقدية وحفظه في السحابة`}),ni(!1),ii(""),mi("")},children:[e.jsx(xr,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",Mt.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(te,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx(q,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:Tl,onChange:s=>mi(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(ht,{className:"flex gap-2",children:e.jsx(u,{variant:"outline",onClick:()=>{ni(!1),ii(""),mi("")},children:"إلغاء"})})]})}),e.jsx(Ne,{open:Oh,onOpenChange:bi,children:e.jsxs(je,{className:"sm:max-w-md",children:[e.jsx(Se,{children:e.jsx(De,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(lt).reduce((s,a)=>s+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(te,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(q,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل الرقم السري الرئيسي",value:Pc,onChange:s=>vi(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(ht,{className:"flex gap-2",children:[e.jsx(u,{variant:"outline",onClick:()=>{bi(!1),vi("")},children:"إلغاء"}),e.jsx(u,{variant:"destructive",onClick:async()=>{if(!await _s.verifyMasterPin(Pc,t==null?void 0:t.uid)){r({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const a={};Object.keys(lt).forEach(h=>{a[h]=0}),cs(a),localStorage.setItem(Rs(),JSON.stringify(a)),bi(!1),vi("");const n=new Date().toISOString(),l={walletBalances:a,lastUpdated:n},c=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(c,JSON.stringify(l)),t!=null&&t.uid?ve.updateUserData(t.uid,l).then(()=>{localStorage.removeItem(c),tt(!1)}).catch(h=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",h),tt(!0),r({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):tt(!0),setTimeout(()=>{cs({...a})},100)}catch(a){console.error("خطأ في تصفير أرصدة المحافظ:",a),r({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(Ne,{open:dh,onOpenChange:ri,children:e.jsxs(je,{className:"sm:max-w-md",children:[e.jsx(Se,{children:e.jsx(De,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((Wc=Je.find(s=>s.id===U))==null?void 0:Wc.name)||U]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(U&&lt[U]?lt[U]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(te,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(q,{id:"resetSelectedWalletPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:lc,onChange:s=>bl(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(ht,{className:"flex gap-2",children:[e.jsx(u,{variant:"outline",onClick:()=>{ri(!1),bl("")},children:"إلغاء"}),e.jsx(u,{variant:"destructive",onClick:async()=>{var a;if(!U){r({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await _s.verifyMasterPin(lc,t==null?void 0:t.uid)){r({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const n={...lt};n[U]=0,cs(n),localStorage.setItem(Rs(),JSON.stringify(n)),ri(!1),bl("");const l=new Date().toISOString(),c={walletBalances:n,lastUpdated:l},h=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(h,JSON.stringify(c)),t!=null&&t.uid?ve.updateUserData(t.uid,c).then(()=>{localStorage.removeItem(h),tt(!1)}).catch(x=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",x),tt(!0),r({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):tt(!0),r({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((a=Je.find(x=>x.id===U))==null?void 0:a.name)||U}`})}catch(n){console.error("خطأ في تصفير رصيد المحفظة المختارة:",n),r({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(Ne,{open:Th,onOpenChange:gi,children:e.jsxs(je,{className:"sm:max-w-md",children:[e.jsx(Se,{children:e.jsxs(De,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(ks,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(lt).reduce((s,a)=>s+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx(q,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:Nc,onChange:s=>kl(s.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx(q,{id:"addWalletTotalPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري",value:jc,onChange:s=>_l(s.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(ht,{className:"flex gap-2",children:[e.jsx(u,{variant:"outline",onClick:()=>{gi(!1),kl(""),_l("")},children:"إلغاء"}),e.jsx(u,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:Sc,onClick:async()=>{const s=parseFloat(Nc);if(!s||s<=0){r({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!await $h(jc)){r({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}Dc(!0);try{const a=Object.values(lt).reduce((n,l)=>n+l,0);if(a===0){const n=Object.keys(lt),l=s/n.length,c={};n.forEach(h=>{c[h]=l}),cs(c),localStorage.setItem(Rs(),JSON.stringify(c)),t!=null&&t.uid?await ve.updateUserData(t.uid,{walletBalances:c,lastUpdated:new Date().toISOString()}):tt(!0)}else{const n={};Object.entries(lt).forEach(([l,c])=>{const h=c/a,x=s*h;n[l]=c+x}),cs(n),localStorage.setItem(Rs(),JSON.stringify(n)),t!=null&&t.uid?await ve.updateUserData(t.uid,{walletBalances:n,lastUpdated:new Date().toISOString()}):tt(!0)}setTimeout(()=>{cs(n=>({...n}))},100),gi(!1),kl(""),_l("")}catch(a){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",a),r({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{Dc(!1)}},children:Sc?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(Ne,{open:Mh,onOpenChange:wi,children:e.jsxs(je,{className:"sm:max-w-[425px]",children:[e.jsx(Se,{children:e.jsxs(De,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(ds,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(te,{htmlFor:"resetCashPin",children:"الرقم السري الرئيسي"}),e.jsx(q,{id:"resetCashPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:El,onChange:s=>Ol(s.target.value)})]})]}),e.jsxs(ht,{children:[e.jsx(u,{variant:"outline",onClick:()=>{wi(!1),Ol("")},children:"إلغاء"}),e.jsx(u,{variant:"destructive",onClick:async()=>{if(!El){r({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await _s.verifyMasterPin(El,t==null?void 0:t.uid)){r({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{Qt(0),wi(!1),Ol("");const a={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem(Ks(),"0");const n=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(n,JSON.stringify(a)),t!=null&&t.uid?ve.updateUserData(t.uid,a).then(()=>{localStorage.removeItem(n),tt(!1)}).catch(l=>{console.error("خطأ في حفظ الرصيد في Firebase:",l),tt(!0),r({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):tt(!0)}catch(a){console.error("خطأ في تصفير الرصيد النقدي:",a),r({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(Px,{open:Ah,onOpenChange:wc,userId:t==null?void 0:t.uid,cashBalance:Mt,walletBalances:lt,transactions:Ze}),e.jsx(Ne,{open:Ih,onOpenChange:rn,children:e.jsxs(je,{className:"sm:max-w-[425px]",children:[e.jsx(Se,{children:e.jsxs(De,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(ks,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx(q,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:mr,onChange:s=>hi(s.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{className:"text-right",children:"هل تريد إضافة ملاحظة؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{type:"button",variant:ln==="yes"?"default":"outline",onClick:()=>on("yes"),className:"flex-1",children:"نعم"}),e.jsx(u,{type:"button",variant:ln==="no"?"default":"outline",onClick:async()=>{if(on("no"),!mr||parseFloat(mr)<=0){r({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!nn){r({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await Ni(nn)){r({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}xi(!0);try{const s=parseFloat(mr),a=Mt+s;Qt(a),localStorage.setItem(Ks(),a.toString());const n={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(l,JSON.stringify(n));const c=`CASHADD-${(t==null?void 0:t.uid)||"anon"}-${Date.now()}`;rn(!1),hi(""),ui(""),on(null),pi("");const h=[];if(t!=null&&t.uid){h.push(ve.updateUserData(t.uid,n).then(()=>{localStorage.removeItem(l),tt(!1)}).catch(()=>{tt(!0)}));const x={txnType:"cash_addition",type:"cash_addition",amount:s,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:c,title:"إيصال إضافة نقدية",merchantUserId:t.uid,createdBy:t.uid,shopId:(j==null?void 0:j.shopId)||void 0};h.push(ve.saveUserTransaction(t.uid,x));const g=j==null?void 0:j.shopId;if(g){const D=Ve(V,"dashboardData",g);h.push(Wt(D,{cashBalance:a}))}}Promise.allSettled(h).then(()=>{}).catch(()=>{})}catch{Qt(Mt),localStorage.setItem("cashBalance",Mt.toString()),r({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{xi(!1)}},className:"flex-1",children:"لا"})]})]}),ln==="yes"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"addCashNote",children:"الملاحظة"}),e.jsx(q,{id:"addCashNote",type:"text",placeholder:"اكتب الملاحظة",value:Pl,onChange:s=>pi(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx(q,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:nn,onChange:s=>ui(s.target.value)})]})]}),e.jsxs(ht,{children:[e.jsx(u,{variant:"outline",onClick:()=>{rn(!1),hi(""),ui(""),on(null),pi("")},children:"إلغاء"}),e.jsx(u,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:vc,onClick:async()=>{if(!mr||parseFloat(mr)<=0){r({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!nn){r({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await Ni(nn)){r({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}if(ln==="yes"&&Pl.trim().length===0){r({title:"تنبيه",description:"أدخل الملاحظة أو اختر لا",variant:"destructive"});return}xi(!0);try{const s=parseFloat(mr),a=Mt+s;Qt(a),localStorage.setItem(Ks(),a.toString());const n={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(l,JSON.stringify(n));const c=`CASHADD-${(t==null?void 0:t.uid)||"anon"}-${Date.now()}`;rn(!1),hi(""),ui(""),on(null),pi("");const h=[];if(t!=null&&t.uid){h.push(ve.updateUserData(t.uid,n).then(()=>{localStorage.removeItem(l),tt(!1)}).catch(()=>{tt(!0)}));const x={txnType:"cash_addition",type:"cash_addition",amount:s,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:c,note:ln==="yes"?Pl.trim():void 0,title:"إيصال إضافة نقدية",merchantUserId:t.uid,createdBy:t.uid,shopId:(j==null?void 0:j.shopId)||void 0};h.push(ve.saveUserTransaction(t.uid,x));const g=j==null?void 0:j.shopId;if(g){const D=Ve(V,"dashboardData",g);h.push(Wt(D,{cashBalance:a}))}}Promise.allSettled(h).then(()=>{}).catch(()=>{})}catch{Qt(Mt),localStorage.setItem("cashBalance",Mt.toString()),r({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{xi(!1)}},children:vc?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(Ne,{open:ih,onOpenChange:fl,children:e.jsxs(je,{className:"sm:max-w-md",children:[e.jsx(Se,{children:e.jsx(De,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(te,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx(q,{id:"search-date",type:"date",value:zn,onChange:s=>So(s.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(te,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx(q,{id:"search-time",type:"time",value:qn,onChange:s=>Do(s.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(ht,{className:"flex justify-between",children:[e.jsx(u,{variant:"outline",onClick:()=>{So(""),Do(""),fl(!1)},children:"مسح"}),e.jsx(u,{onClick:()=>fl(!1),children:"تطبيق"})]})]})}),e.jsx(Ax,{isOpen:Im,onClose:()=>Ji(!1)}),e.jsx(Tx,{isOpen:Ui,onClose:()=>Hr(!1),initialBarcode:im}),e.jsx(Eu,{isOpen:Pm,onClose:()=>Jn(!1)}),e.jsx(Ou,{open:km,onOpenChange:Kn}),e.jsx(Vx,{open:_m,onOpenChange:s=>{if(s&&!ba){r({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}Yn(s)}}),e.jsx(Zx,{open:ne,onOpenChange:s=>{if(s&&!ba){r({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}ce(s)}}),e.jsx(Xx,{open:M,onOpenChange:s=>{if(s&&!ba){r({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}F(s)}}),e.jsx(Ds,{open:xh,onOpenChange:uc,onSuccess:()=>jl(!0),title:"تقاريرك",description:"أدخل الرقم السري الرئيسي للوصول إلى تقاريرك",mode:"verify"}),e.jsx(Ne,{open:Nl,onOpenChange:jl,children:e.jsxs(je,{className:"sm:max-w-xl",children:[e.jsxs(Se,{children:[e.jsxs(De,{className:"flex items-center gap-2",children:[e.jsx(Xc,{className:"h-4 w-4 text-blue-600"}),"تقارير اليوم"]}),e.jsx(Ss,{children:"ملخص معاملات اليوم محفوظ لآخر 30 يومًا مع أرشفة في السحابة"})]}),e.jsxs("div",{className:"space-y-4",children:[(()=>{const s=new Date().toDateString(),a=Ze.filter(g=>{const D=new Date(g.createdAt).toDateString(),p=String(g.status||"completed").toLowerCase();return D===s&&(p==="completed"||p==="confirmed")}),n=a.length,l=a.reduce((g,D)=>g+Number(D.amount||0),0),c=a.filter(g=>g.type==="withdraw").reduce((g,D)=>g+Number(D.amount||0),0),h=a.filter(g=>g.type==="send").reduce((g,D)=>g+Number(D.amount||0),0),x=a.reduce((g,D)=>g+Number(Ps.calculateTransactionProfit(D)||0),0);return e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-blue-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-blue-700",children:"عدد المعاملات"}),e.jsx("div",{className:"text-lg font-bold text-blue-800",children:n})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-indigo-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-indigo-700",children:"إجمالي المبالغ"}),e.jsx("div",{className:"text-lg font-bold text-indigo-800",children:Number(l).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-red-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-red-700",children:"المبالغ المسحوبة"}),e.jsx("div",{className:"text-lg font-bold text-red-800",children:Number(c).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-green-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-green-700",children:"المبالغ المرسلة"}),e.jsx("div",{className:"text-lg font-bold text-green-800",children:Number(h).toFixed(2)})]}),e.jsxs("div",{className:"col-span-2 rounded-lg p-3 bg-gradient-to-r from-amber-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-amber-700",children:"الأرباح"}),e.jsx("div",{className:"text-lg font-bold text-amber-800",children:Number(x).toFixed(2)})]})]})})(),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(u,{variant:"default",onClick:async()=>{try{if(!(t!=null&&t.uid))return;const s=new Date,a=s.getFullYear(),n=String(s.getMonth()+1).padStart(2,"0"),l=String(s.getDate()).padStart(2,"0"),c=`${a}-${n}-${l}`,h=s.toDateString(),x=Ze.filter(T=>{const P=new Date(T.createdAt).toDateString(),Q=String(T.status||"completed").toLowerCase();return P===h&&(Q==="completed"||Q==="confirmed")}),g=x.length,D=x.reduce((T,P)=>T+Number(P.amount||0),0),p=x.filter(T=>T.type==="withdraw").reduce((T,P)=>T+Number(P.amount||0),0),w=x.filter(T=>T.type==="send").reduce((T,P)=>T+Number(P.amount||0),0),A=x.reduce((T,P)=>T+Number(Ps.calculateTransactionProfit(P)||0),0);await pn.add({userId:t.uid,reportDate:c,totalTransactions:g,totalAmount:Number(D.toFixed(2)),totalWithdrawn:Number(p.toFixed(2)),totalSent:Number(w.toFixed(2)),profit:Number(A.toFixed(2)),walletId:null});try{await pn.trimToMaxCount(t.uid,30)}catch{}r({title:"تم الأرشفة",description:`تم حفظ تقرير ${c}`})}catch{r({title:"فشل الأرشفة",description:"تعذر حفظ التقرير",variant:"destructive"})}},children:"أرشفة اليوم"}),e.jsx(u,{variant:"outline",onClick:()=>jl(!1),children:"إغلاق"})]}),e.jsx("div",{className:"mt-2 border-t pt-2",children:e.jsx("div",{className:"space-y-2 max-h-[40vh] overflow-auto",children:xc.length===0?e.jsx("div",{className:"text-xs text-muted-foreground",children:"لا توجد تقارير محفوظة"}):xc.map(s=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:s.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",s.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:Number(s.totalAmount).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:Number(s.totalWithdrawn).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:Number(s.totalSent).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:Number(s.profit??0).toFixed(2)})]})]})]},s.id||`${s.userId}-${s.reportDate}`))})})]})]})}),e.jsx(Ne,{open:uh,onOpenChange:s=>{if(s){r({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}wl(!1)},children:e.jsxs(je,{dir:"rtl",className:"sm:max-w-md w-[95vw] sm:w-auto rounded-2xl border border-emerald-200 shadow-xl bg-gradient-to-br from-white via-green-50 to-emerald-50 backdrop-blur-md data-[state=open]:animate-in data-[state=open]:fade-in-0 data-[state=open]:zoom-in-90 data-[state=open]:slide-in-from-bottom-8 duration-300",children:[e.jsxs(Se,{children:[e.jsx(De,{className:"text-right text-green-700",children:"شحن رصيد الموبايل"}),e.jsx(Ss,{className:"text-right text-gray-600",children:"أدخل البيانات ثم اضغط تأكيد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(te,{htmlFor:"topupPhone",className:"text-right block",children:"رقم الموبايل"}),e.jsx(q,{id:"topupPhone",value:li,onChange:s=>oc(s.target.value),placeholder:"010xxxxxxx",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx(te,{className:"text-right block",children:"شركة التشغيل"}),e.jsxs(Ga,{value:oi,onValueChange:cc,children:[e.jsx(Za,{className:"text-right",children:e.jsx(Xa,{placeholder:"اختر الشركة"})}),e.jsxs(er,{children:[e.jsx(ua,{value:"vodafone",children:"فودافون"}),e.jsx(ua,{value:"orange",children:"أورنج"}),e.jsx(ua,{value:"etisalat",children:"اتصالات"}),e.jsx(ua,{value:"we",children:"WE"})]})]})]}),e.jsxs("div",{children:[e.jsx(te,{htmlFor:"topupAmount",className:"text-right block",children:"المبلغ بالجنيه"}),e.jsx(q,{id:"topupAmount",type:"number",value:ci,onChange:s=>dc(s.target.value?Number(s.target.value):""),placeholder:"50",className:"text-right"})]})]}),e.jsxs(ht,{className:"flex gap-2 justify-between",children:[e.jsx(u,{variant:"outline",onClick:()=>wl(!1),className:"border-gray-300",children:"إلغاء"}),e.jsx(u,{onClick:N,disabled:mc||!li||!oi||!ci,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:mc?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})}),e.jsx(Ds,{open:zm,onOpenChange:Hi,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{Hi(!1),Tr(!0)}}),e.jsx(Ds,{open:Vm,onOpenChange:Ro,mode:"verify",title:"تأكيد تغيير طلب الرقم السري للديون",description:"أدخل الرقم السري الرئيسي لتفعيل أو إلغاء طلب الرقم السري عند فتح الديون",onSuccess:async()=>{if($o!==null){const s=$o;Mo(s);try{const a=t==null?void 0:t.uid,n=a?`debtsPinRequired_${a}`:"debtsPinRequired";localStorage.setItem(n,String(s)),a&&await ve.updateUserData(a,{debtsPinRequired:s})}catch{}r({title:s?"تم تفعيل طلب الرقم السري للديون":"تم إلغاء طلب الرقم السري للديون",description:s?"سيُطلب الرقم السري الرئيسي عند فتح نافذة الديون.":"يمكن فتح نافذة الديون بدون طلب الرقم السري."})}Jm(null),Ro(!1)}}),e.jsx(Cu,{open:mh,onOpenChange:sn,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"سيتم حذف كل المعاملات السابقة نهائيًا من حسابك وFirebase.",onSuccess:async()=>{try{if(!(t!=null&&t.uid)){sn(!1);return}const s=new Date,a=l=>l instanceof Date?l:typeof(l==null?void 0:l.toDate)=="function"?l.toDate():new Date(String(l)),n=Ze.filter(l=>a(l.createdAt)<s);await ve.updateUserData(t.uid,{recentReset:{keepLastCount:Ic.keepLastCount??30,intervalDays:Ic.intervalDays??7,lastResetAt:s}}),fi(l=>({...l,lastResetAt:s})),r({title:"تم إخفاء المعاملات السابقة",description:"تم إخفاء كل الإيصالات الأقدم من وقت التصفير من العرض بدون التأثير على تقارير اليوم/الشهر أو الحدود."})}catch(s){console.error("فشل تنفيذ التصفير النهائي:",s),r({title:"فشل التصفير",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}finally{sn(!1)}}}),e.jsx(Ds,{open:Ca,onOpenChange:Us,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{Us(!1),Xt(!0)}}),e.jsx(Ne,{open:Um,onOpenChange:Tr,children:e.jsxs(je,{className:"sm:max-w-[425px]",children:[e.jsxs(Se,{className:"flex items-center justify-between",children:[e.jsx(De,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx(td,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[Uh," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(u,{variant:Pr==="debtor"?"default":"outline",onClick:()=>Bo("debtor"),children:"مدين"}),e.jsx(u,{variant:Pr==="creditor"?"default":"outline",onClick:()=>Bo("creditor"),children:"دائن"})]}),Pr==="creditor"&&e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(te,{htmlFor:"debtorName",className:"text-right col-span-1",children:"اسم المديون"}),e.jsx(q,{id:"debtorName",value:Qi,onChange:s=>Lo(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل اسم المديون"})]}),Pr&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(te,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(q,{id:"debtAmount",type:"number",value:Gi,onChange:s=>Fo(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(te,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx(q,{id:"debtReason",value:Zi,onChange:s=>Wo(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]})]}),e.jsx(ht,{children:e.jsx(u,{onClick:()=>{const s=Pr==="debtor",a=Pr==="creditor";if(!s&&!a){r({title:"اختر نوع الدين",description:"يرجى اختيار مدين أو دائن أولاً",variant:"destructive"});return}if(!Gi||!Zi||a&&!Qi){r({title:"بيانات غير مكتملة",description:a?"يرجى إدخال الاسم والمبلغ والسبب":"يرجى إدخال المبلغ والسبب",variant:"destructive"});return}const n={id:Date.now().toString(),debtorName:s?"مدين":Qi,amount:parseFloat(Gi),reason:Zi,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};ti(n),_r(!0)},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(u,{variant:"outline",className:"w-full",onClick:()=>kr(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(u,{variant:"outline",className:"w-full",onClick:()=>il(!0),children:"إضافة عميل"})})]})}),e.jsx(Ne,{open:sl,onOpenChange:kr,children:e.jsxs(je,{className:"sm:max-w-[520px]",children:[e.jsxs(Se,{children:[e.jsx(De,{className:"text-right",children:"إيصالات الديون"}),e.jsx(Ss,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),Tt.length>0?e.jsxs("div",{className:"max-h-64 overflow-y-auto space-y-2",onScroll:s=>{const a=s.currentTarget;rl.length<Tt.length&&a.scrollTop+a.clientHeight>=a.scrollHeight-50&&al(n=>n+1)},children:[rl.map(s=>e.jsx("div",{onClick:()=>{or(s),qa(!0),kr(!1),Tr(!1)},className:"p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium",children:s.debtorName}),e.jsx("p",{className:"text-sm text-gray-600",children:s.reason}),e.jsx("p",{className:"text-sm text-gray-500",children:Si.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-lg",children:[s.amount," جنيه"]}),e.jsx(Gt,{variant:s.status==="paid"?"default":"secondary",className:s.status==="paid"?"bg-green-500":"bg-yellow-500",children:s.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},s.id)),rl.length<Tt.length&&e.jsx("div",{className:"flex justify-center pt-1",children:e.jsx(u,{variant:"outline",size:"sm",onClick:()=>al(s=>s+1),children:"تحميل المزيد"})})]}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"}),e.jsxs(ht,{className:"flex justify-between mt-3",children:[e.jsx(u,{variant:"destructive",onClick:async()=>{try{if(!Tt||Tt.length===0){r({title:"لا توجد ديون",description:"القائمة فارغة بالفعل."});return}if(!window.confirm("هل تريد حذف كل إيصالات الديون؟ هذا الإجراء لا يمكن التراجع عنه."))return;const a=[];if(vs(a),or(null),await sa(a),t!=null&&t.uid)try{await ve.updateUserData(t.uid,{debts:[],debtsDeletedAt:ft()});try{localStorage.removeItem(`debts_unsynced_${t.uid}`)}catch{}}catch(n){console.error("تعذر حذف الديون من Firebase:",n),r({title:"فشل الحذف من السحابة",description:"تعذر حذف الإيصالات من Firebase، حاول مرة أخرى.",variant:"destructive"});return}r({title:"تم حذف كل إيصالات الديون",description:"تم تفريغ القائمة بالكامل."}),kr(!1)}catch(s){console.error("تعذر حذف كل إيصالات الديون:",s),r({title:"فشل الحذف",description:"حدث خطأ أثناء الحذف، حاول مرة أخرى.",variant:"destructive"})}},children:"حذف كل الإيصالات"}),e.jsx(u,{variant:"outline",onClick:()=>kr(!1),children:"إغلاق"})]})]})}),e.jsx(Ne,{open:Gm,onOpenChange:il,children:e.jsxs(je,{className:"sm:max-w-[480px]",children:[e.jsxs(Se,{children:[e.jsx(De,{className:"text-right",children:"إضافة عميل"}),e.jsx(Ss,{className:"text-right",children:"أدخل بيانات العميل ثم يمكنك تسجيل مبلغ دين عليه"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(te,{htmlFor:"customerName",className:"text-right col-span-1",children:"اسم العميل"}),e.jsx(q,{id:"customerName",value:ol,onChange:s=>Ko(s.target.value),className:"col-span-3 text-right",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(te,{htmlFor:"customerMobile",className:"text-right col-span-1",children:"رقم الموبايل"}),e.jsx(q,{id:"customerMobile",value:cl,onChange:s=>Yo(s.target.value),className:"col-span-3 text-right",placeholder:"اكتب رقم الموبايل"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(u,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!ol||!cl){r({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const s={id:Date.now().toString(),name:ol.trim(),mobile:cl.trim(),createdAt:new Date},a=[s,...ea];await Cl(a),Ko(""),Yo(""),r({title:"تمت إضافة العميل",description:`تم إضافة ${s.name}`})},children:"إضافة"})}),e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx(te,{className:"text-right block",children:"إضافة مبلغ على عميل"}),ea.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(Ga,{value:Zn,onValueChange:Ho,children:[e.jsx(Za,{className:"w-full",children:e.jsx(Xa,{placeholder:"اختر عميل"})}),e.jsx(er,{children:ea.map(s=>e.jsxs(ua,{value:s.id,children:[s.name," — ",s.mobile]},s.id))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(te,{htmlFor:"customerDebtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(q,{id:"customerDebtAmount",type:"number",value:Qo,onChange:s=>Zm(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(u,{className:"bg-orange-600 hover:bg-orange-700",onClick:async()=>{const s=parseFloat(Qo);if(!Zn){r({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(s)||s<=0){r({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=ea.find(l=>l.id===Zn);if(!a)return;const n={id:Date.now().toString(),debtorName:a.name,customerId:a.id,mobile:a.mobile,amount:Number(s.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};ti(n),_r(!0)},children:"إضافة المبلغ"})})]}):e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد عملاء مسجلين. أضف عميلًا أولاً."})]}),e.jsxs("div",{className:"border-t pt-4 space-y-2",children:[e.jsx(te,{className:"text-right block",children:"إدارة العملاء"}),ea.length>0?e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:ea.map(s=>e.jsxs("div",{className:"p-2 border rounded-md flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium text-sm",children:s.name}),e.jsx("div",{className:"text-xs text-gray-600",children:s.mobile})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{variant:"outline",size:"sm",onClick:()=>{Go(s.id),dl(s.name||""),ml(s.mobile||""),Xn(!0)},children:"تعديل"}),e.jsx(u,{variant:"destructive",size:"sm",onClick:()=>{hl(s.id),ul(s.name||""),ei(!0)},children:"حذف نهائي"})]})]},s.id))}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً."})]})]}),e.jsx(ht,{className:"flex justify-end",children:e.jsx(u,{variant:"outline",onClick:()=>il(!1),children:"إغلاق"})})]})}),e.jsx(Ne,{open:th,onOpenChange:ei,children:e.jsxs(je,{hideClose:!0,className:"sm:max-w-[420px] rounded-2xl bg-gradient-to-br from-white via-rose-50 to-red-50 shadow-2xl border border-red-100 text-center",children:[e.jsxs(Se,{children:[e.jsx(De,{className:"text-center text-xl font-bold text-red-700",children:"تأكيد حذف العميل"}),e.jsxs(Ss,{className:"text-center text-gray-600",children:["سيتم حذف العميل نهائيًا: ",ec]})]}),e.jsx("div",{className:"py-2 text-sm text-gray-700",children:"لا يمكن التراجع عن هذا الإجراء."}),e.jsxs(ht,{className:"flex justify-center gap-3",children:[e.jsx(u,{variant:"outline",onClick:()=>{ei(!1),hl(""),ul("")},children:"إلغاء"}),e.jsx(u,{variant:"destructive",className:"bg-red-600 hover:bg-red-700",onClick:async()=>{const s=sh,a=ea.filter(n=>n.id!==s);await Cl(a),Zn===s&&Ho(""),ei(!1),hl(""),ul(""),r({title:"تم حذف العميل",description:ec})},children:"حذف نهائي"})]})]})}),e.jsx(Ne,{open:Xm,onOpenChange:Xn,children:e.jsxs(je,{className:"sm:max-w-[420px]",children:[e.jsx(Se,{children:e.jsx(De,{className:"text-right",children:"تعديل بيانات العميل"})}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(te,{htmlFor:"editCustomerName",className:"text-right col-span-1",children:"الاسم"}),e.jsx(q,{id:"editCustomerName",value:Zo,onChange:s=>dl(s.target.value),className:"col-span-3 text-right"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(te,{htmlFor:"editCustomerMobile",className:"text-right col-span-1",children:"الموبايل"}),e.jsx(q,{id:"editCustomerMobile",value:Xo,onChange:s=>ml(s.target.value),className:"col-span-3 text-right"})]})]}),e.jsxs(ht,{className:"flex justify-between",children:[e.jsx(u,{variant:"outline",onClick:()=>Xn(!1),children:"إلغاء"}),e.jsx(u,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const s=eh,a=Zo.trim(),n=Xo.trim();if(!s||!a||!n){r({title:"بيانات غير مكتملة",description:"أدخل الاسم ورقم الموبايل",variant:"destructive"});return}const l=ea.map(h=>h.id===s?{...h,name:a,mobile:n}:h);await Cl(l);const c=Tt.map(h=>h.customerId===s?{...h,debtorName:a,mobile:n}:h);c!==Tt&&(vs(c),await sa(c)),Xn(!1),Go(""),dl(""),ml(""),r({title:"تم تحديث العميل",description:a})},children:"حفظ"})]})]})}),e.jsx(Ne,{open:is,onOpenChange:Xt,children:e.jsxs(je,{className:"sm:max-w-[520px]",children:[e.jsxs(Se,{children:[e.jsx(De,{className:"text-right",children:"مصروفات المحل"}),e.jsx(Ss,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(te,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx(q,{id:"expenseName",value:ga,onChange:s=>us(s.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(te,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx(q,{id:"expenseAmount",type:"number",value:E,onChange:s=>ge(s.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(te,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx(q,{id:"expenseNotes",value:pe,onChange:s=>Ee(s.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(ht,{className:"flex justify-between",children:[e.jsx(u,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!ga||!E){r({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}H(!0)},children:"إضافة مصروف"}),e.jsx(u,{variant:"outline",onClick:()=>ra(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(Ne,{open:Zs,onOpenChange:ra,children:e.jsxs(je,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(Se,{children:[e.jsx(De,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(Ss,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),Be.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:Be.map(s=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:s.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:s.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(s.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left flex items-start gap-2",children:[e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[s.amount," جنيه"]}),e.jsx(Gt,{variant:"secondary",className:s.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:s.source==="cash"?"من النقدية":`من المحفظة${s.walletId?` (${s.walletId})`:""}`})]}),e.jsxs(u,{variant:"destructive",size:"sm",className:"shrink-0",onClick:()=>fh(s.id),title:"حذف نهائي",children:[e.jsx(ds,{className:"w-4 h-4 ml-1"}),"حذف"]})]})]})},s.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(Ne,{open:vt,onOpenChange:H,children:e.jsxs(je,{className:"sm:max-w-[480px]",children:[e.jsx(Se,{children:e.jsx(De,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(u,{variant:fe==="cash"?"default":"outline",className:fe==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>Z("cash"),children:"الفلوس النقدية"}),e.jsx(u,{variant:fe==="wallet"?"default":"outline",className:fe==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>Z("wallet"),children:"أرصدة المحافظ"}),e.jsx(u,{variant:fe==="fawry"?"default":"outline",className:fe==="fawry"?"bg-amber-600 hover:bg-amber-700 text-white":"",onClick:()=>Z("fawry"),children:"فوري"})]}),fe==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(Ga,{value:dt,onValueChange:jt,children:[e.jsx(Za,{className:"w-full",children:e.jsx(Xa,{placeholder:"اختر محفظة"})}),e.jsx(er,{children:Je.map(s=>e.jsx(ua,{value:s.id,children:s.phone||s.name||s.id},s.id))})]})]})]}),e.jsxs(ht,{className:"flex justify-between",children:[e.jsx(u,{variant:"outline",onClick:()=>{H(!1),Z(null),jt("")},children:"إلغاء"}),e.jsx(u,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const s=Number(E);if(isNaN(s)||s<=0){r({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!fe){r({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(fe==="cash"){const c=Number((Mt-s).toFixed(2));Qt(c),localStorage.setItem(Ks(),c.toString());const h={cashBalance:c,lastUpdated:new Date().toISOString()},x=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(x,JSON.stringify(h)),t!=null&&t.uid?(await ve.updateUserData(t.uid,h),localStorage.removeItem(x),tt(!1)):tt(!0)}else if(fe==="wallet"){if(!dt){r({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const c=lt[dt]||0,h=Number((c-s).toFixed(2)),x={...lt,[dt]:h};cs(x);const g=new Date().toISOString(),D={walletBalances:x,lastUpdated:g},p=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(p,JSON.stringify(D)),localStorage.setItem(Rs(),JSON.stringify(x)),localStorage.setItem(`walletBalances_backup_${g}`,JSON.stringify(x)),t!=null&&t.uid&&await ve.updateUserData(t.uid,D)}}catch(c){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",c)}let a=Date.now().toString();try{if(t!=null&&t.uid){const{addDoc:c,collection:h,serverTimestamp:x}=await bt(async()=>{const{addDoc:p,collection:w,serverTimestamp:A}=await import("./index-tnWDkOuX.js").then(T=>T.c2);return{addDoc:p,collection:w,serverTimestamp:A}},__vite__mapDeps([0,1]),import.meta.url),{db:g}=await bt(async()=>{const{db:p}=await import("./index-tnWDkOuX.js").then(w=>w.c3);return{db:p}},__vite__mapDeps([0,1]),import.meta.url);a=(await c(h(g,"shop_expenses"),{userId:t.uid,shopId:_||(j==null?void 0:j.shopId)||t.uid||"default-shop",name:ga,amount:s,notes:pe||"",source:fe,walletId:fe==="wallet"?dt:null,createdAt:x()})).id}}catch(c){console.error("خطأ أثناء حفظ المصروف في Firestore:",c)}const n={id:a,name:ga,amount:s,notes:pe,source:fe,walletId:fe==="wallet"?dt:void 0,createdAt:new Date},l=[...Be,n];await yc(l),us(""),ge(""),Ee(""),Z(null),jt(""),H(!1),Xt(!0),ra(!0),r({title:"تم إضافة المصروف",description:fe==="cash"?"تم الخصم من النقدية":fe==="wallet"?"تم الخصم من أرصدة المحافظ":"تم تسجيل الدفع عبر فوري"})},children:"تأكيد الخصم"})]})]})}),e.jsx(Ne,{open:Jr,onOpenChange:Ia,children:e.jsxs(je,{className:"sm:max-w-[520px]",children:[e.jsxs(Se,{children:[e.jsx(De,{className:"text-right",children:"النواقص"}),e.jsx(Ss,{className:"text-right",children:"سجل العناصر الناقصة التي تحتاج شراء وتابع حالتها."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(te,{htmlFor:"deficiencyName",className:"text-right col-span-1",children:"اسم العنصر"}),e.jsx(q,{id:"deficiencyName",value:z,onChange:s=>we(s.target.value),className:"col-span-3 text-right",placeholder:"مثال: سكر، زيت، مناديل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(te,{htmlFor:"deficiencyQuantity",className:"text-right col-span-1",children:"الكمية"}),e.jsx(q,{id:"deficiencyQuantity",type:"number",value:wt,onChange:s=>pt(s.target.value),className:"col-span-3 text-right",placeholder:"1"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(u,{className:"bg-rose-600 hover:bg-rose-700",onClick:()=>{if(Pt){r({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}const s=parseInt(wt||"1",10);if(!z){r({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العنصر",variant:"destructive"});return}if(isNaN(s)||s<=0){r({title:"كمية غير صحيحة",description:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}(async()=>{if(t!=null&&t.uid)try{const{collection:n,addDoc:l,serverTimestamp:c}=await bt(async()=>{const{collection:g,addDoc:D,serverTimestamp:p}=await import("./index-tnWDkOuX.js").then(w=>w.c2);return{collection:g,addDoc:D,serverTimestamp:p}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await bt(async()=>{const{db:g}=await import("./index-tnWDkOuX.js").then(D=>D.c3);return{db:g}},__vite__mapDeps([0,1]),import.meta.url),x=await l(n(h,"deficiencies"),{userId:t.uid,shopId:_||(j==null?void 0:j.shopId)||t.uid||"default-shop",name:z,quantity:s,status:"pending",createdAt:c()});try{const g=di(),D=localStorage.getItem(g),p=D?JSON.parse(D):[],w=Array.isArray(p)?p:[],A=w.some(Q=>String((Q==null?void 0:Q.id)||"")===x.id),T={id:x.id,name:z,quantity:s,status:"pending",createdAt:new Date().toISOString()},P=A?w:[...w,T];localStorage.setItem(g,JSON.stringify(P))}catch{}we(""),pt(""),r({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"});return}catch(n){console.warn("فشل حفظ النواقص إلى Firestore، سيُستخدم التخزين المحلي:",n)}const a={id:Date.now().toString(),name:z,quantity:s,status:"pending",createdAt:new Date};ts(n=>{const l=[...n,a];return Dl(l),l}),we(""),pt(""),r({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"})})()},children:"إضافة للنواقص"})}),ps.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:ps.map(s=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:s.name}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["الكمية: ",s.quantity]}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(s.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Gt,{variant:"secondary",className:s.status==="pending"?"bg-rose-100 text-rose-700":"bg-green-100 text-green-700",children:s.status==="pending"?"قيد الشراء":"تم الشراء"}),e.jsx(u,{variant:"outline",className:s.status==="pending"?"text-green-700 border-green-300 hover:bg-green-50":"text-rose-700 border-rose-300 hover:bg-rose-50",onClick:()=>{(async()=>{const a=s.status==="pending"?"purchased":"pending";if(t!=null&&t.uid)try{const{doc:n,updateDoc:l,serverTimestamp:c}=await bt(async()=>{const{doc:x,updateDoc:g,serverTimestamp:D}=await import("./index-tnWDkOuX.js").then(p=>p.c2);return{doc:x,updateDoc:g,serverTimestamp:D}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await bt(async()=>{const{db:x}=await import("./index-tnWDkOuX.js").then(g=>g.c3);return{db:x}},__vite__mapDeps([0,1]),import.meta.url);await l(n(h,"deficiencies",s.id),{status:a,updatedAt:c()});return}catch(n){console.warn("فشل تحديث حالة النواقص على Firestore، استخدام التخزين المحلي:",n)}ts(n=>{const l=n.map(c=>c.id===s.id?{...c,status:a}:c);return Dl(l),l})})()},title:s.status==="pending"?"تم الشراء":"إلغاء الشراء",children:s.status==="pending"?"تم الشراء":"إلغاء الشراء"}),e.jsx(u,{variant:"outline",className:"text-red-700 border-red-300 hover:bg-red-50",onClick:()=>{(async()=>{if(t!=null&&t.uid)try{const{doc:a,deleteDoc:n}=await bt(async()=>{const{doc:c,deleteDoc:h}=await import("./index-tnWDkOuX.js").then(x=>x.c2);return{doc:c,deleteDoc:h}},__vite__mapDeps([0,1]),import.meta.url),{db:l}=await bt(async()=>{const{db:c}=await import("./index-tnWDkOuX.js").then(h=>h.c3);return{db:c}},__vite__mapDeps([0,1]),import.meta.url);await n(a(l,"deficiencies",s.id));return}catch(a){console.warn("فشل حذف عنصر النواقص من Firestore، استخدام التخزين المحلي:",a)}ts(a=>{const n=a.filter(l=>l.id!==s.id);return Dl(n),n})})()},title:"حذف",children:"حذف"})]})]})},s.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد عناصر مسجلة في النواقص"})]}),e.jsx(ht,{className:"flex justify-end",children:e.jsx(u,{variant:"outline",onClick:()=>Ia(!1),children:"إغلاق"})})]})}),e.jsx(Ne,{open:ah,onOpenChange:_r,children:e.jsxs(je,{className:"sm:max-w-[480px]",children:[e.jsx(Se,{children:e.jsx(De,{className:"text-right",children:"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(u,{variant:Js==="cash"?"default":"outline",className:Js==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>tn("cash"),children:"الفلوس النقدية"}),e.jsx(u,{variant:Js==="wallet"?"default":"outline",className:Js==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>tn("wallet"),children:"أرصدة المحافظ"}),e.jsx(u,{variant:Js==="none"?"default":"outline",className:Js==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>tn("none"),children:"بدون خصم"})]}),Js==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(Ga,{value:si,onValueChange:xl,children:[e.jsx(Za,{className:"w-full",children:e.jsx(Xa,{placeholder:"اختر محفظة"})}),e.jsx(er,{children:Je.map(s=>e.jsx(ua,{value:s.id,children:s.phone||s.name||s.id},s.id))})]})]})]}),e.jsxs(ht,{className:"flex justify-between",children:[e.jsx(u,{variant:"outline",onClick:()=>{_r(!1),ti(null),tn(null),xl("")},children:"إلغاء"}),e.jsx(u,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const s=!!Gn&&!Va,a=Number(s?Gn.delta:(Va==null?void 0:Va.amount)||0);if(!Js){r({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(Js==="cash"){const n=Number((Mt-a).toFixed(2));Qt(n),localStorage.setItem(Ks(),n.toString());const l=new Date().toISOString(),c={cashBalance:n,lastUpdated:l},h=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(h,JSON.stringify(c)),t!=null&&t.uid?await ve.updateUserData(t.uid,c).then(()=>{localStorage.removeItem(h),tt(!1)}).catch(()=>{tt(!0)}):tt(!0)}else if(Js==="wallet"){if(!si){r({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const n=lt[si]||0,l=Number((n-a).toFixed(2)),c={...lt,[si]:l};cs(c);const h=new Date().toISOString(),x={walletBalances:c,lastUpdated:h},g=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(g,JSON.stringify(x)),localStorage.setItem(Rs(),JSON.stringify(c)),localStorage.setItem(`walletBalances_backup_${h}`,JSON.stringify(c)),t!=null&&t.uid&&await ve.updateUserData(t.uid,x)}}catch(n){console.error("خطأ أثناء تحديث الأرصدة عند حفظ/تعديل الدين:",n)}if(s){if(!de)return;const n=Number(de.amount||0),l=Number(de.paidAmount||0),c=Number(Gn.delta||0);if(Gn.type==="decrease"){const h=Number((n-c).toFixed(2)),x=l>=h,g={...de,amount:h,status:x?"paid":"pending"},D=Tt.map(p=>p.id===de.id?g:p);vs(D),or(g),await sa(D);try{x&&(t!=null&&t.uid)&&(async()=>{const p=Ke(Ce(V,"userTransactions"),me("userId","==",t.uid),me("linkedDebtId","==",de.id),me("status","==","pending")),w=await et(p);await Promise.allSettled(w.docs.map($e=>Wt($e.ref,{status:"completed",confirmedAt:new Date})));try{const $e=w.docs.map(B=>{var J;return String(((J=B.data())==null?void 0:J.transactionId)||"")});t!=null&&t.uid&&$e.forEach(B=>B&&ve.removeLocalReceiptById(t.uid,B))}catch{}const A=Ke(Ce(V,"transactions"),me("userId","==",t.uid),me("linkedDebtId","==",de.id),me("status","==","pending")),T=await et(A);await Promise.allSettled(T.docs.map($e=>Wt($e.ref,{status:"completed",confirmedAt:new Date})));try{const $e=T.docs.map(B=>{var J;return String(B.id||((J=B.data())==null?void 0:J.transactionId)||"")});t!=null&&t.uid&&$e.forEach(B=>B&&ve.removeLocalReceiptById(t.uid,B))}catch{}const P=Ke(Ce(V,"transactions"),me("merchantUserId","==",t.uid),me("linkedDebtId","==",de.id),me("status","==","pending")),Q=await et(P);await Promise.allSettled(Q.docs.map($e=>Wt($e.ref,{status:"completed",confirmedAt:new Date})));try{const $e=Q.docs.map(B=>{var J;return String(B.id||((J=B.data())==null?void 0:J.transactionId)||"")});t!=null&&t.uid&&$e.forEach(B=>B&&ve.removeLocalReceiptById(t.uid,B))}catch{}})().catch(p=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين بعد الإنقاص:",p),r({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(p){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة بعد الإنقاص:",p)}r({title:"تم إنقاص المبلغ",description:`المبلغ الجديد: ${h} جنيه`})}else{const h=n+c,x=l>=h,g={...de,amount:Number(h.toFixed(2)),status:x?"paid":"pending"},D=Tt.map(p=>p.id===de.id?g:p);vs(D),or(g),await sa(D),r({title:"تم زيادة المبلغ",description:`المبلغ الجديد: ${h} جنيه`})}}else if(Va){const n=[...Tt,Va];vs(n),await sa(n);try{t!=null&&t.uid&&await ur.send(t.uid,`تم إضافة دين على ${Va.debtorName} بمبلغ ${Va.amount} جنيه`)}catch{}}Lo(""),Fo(""),Wo(""),Tr(!1),_r(!1),ti(null),qo(null),tn(null),xl(""),r({title:s?"تم تطبيق الخصم وتعديل الدين":Js==="none"?"تم حفظ الدين بدون خصم":"تم حفظ الدين وخصم المبلغ",description:Js==="none"?"لم يتم الخصم من الدرج أو المحافظ":Js==="cash"?`تم خصم ${a} من الرصيد النقدي`:`تم خصم ${a} من رصيد المحفظة`})},children:"تأكيد الخصم"})]})]})}),e.jsx(Ne,{open:Km,onOpenChange:qa,children:e.jsxs(je,{className:"sm:max-w-[425px]",children:[e.jsx(Se,{children:e.jsx(De,{className:"text-right",children:"إيصال الدين"})}),de&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:Si.format(de.createdAt instanceof Date?de.createdAt:new Date(de.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:de.debtorName})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{variant:"outline",className:"h-8 w-8 p-0","aria-label":"إنقاص الدين",onClick:()=>{Uo("decrease"),Xi(""),qa(!1),en(!0)},children:"−"}),e.jsxs("span",{className:"font-bold text-lg",children:[de.amount," جنيه"]}),e.jsx(u,{variant:"outline",className:"h-8 w-8 p-0","aria-label":"زيادة الدين",onClick:()=>{Uo("increase"),Xi(""),qa(!1),en(!0)},children:"+"})]})]}),(()=>{try{const s=(Ze||[]).filter(a=>String((a==null?void 0:a.linkedDebtId)||"")===String(de.id)).reduce((a,n)=>a+Math.max(0,Number((n==null?void 0:n.commission)||0)),0);return s>0?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الربح:"}),e.jsxs("span",{className:"text-green-700 font-semibold",children:[s," جنيه"]})]}):null}catch{return null}})(),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:de.reason})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(Gt,{variant:de.status==="paid"?"default":"secondary",className:de.status==="paid"?"bg-green-500":"bg-yellow-500",children:de.status==="paid"?"مدفوع":"مؤجل"})]}),(()=>{try{const s=(Ze||[]).filter(D=>String((D==null?void 0:D.linkedDebtId)||"")===String(de.id)),a=s.reduce((D,p)=>D+Math.max(0,Number((p==null?void 0:p.commission)||0)),0),n=s.reduce((D,p)=>D+Math.max(0,Number(((p==null?void 0:p.sentAmount)??(p==null?void 0:p.transferredAmount)??(p==null?void 0:p.withdrawnAmount)??(p==null?void 0:p.amount))||0)),0),l=Number(de.amount||0),c=Number(de.paidAmount||0),x=l<n+a?l+a:l,g=Math.max(0,Number(x)-c);return e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[g," جنيه"]})]})}catch{return e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[Number(de.amount||0)-Number(de.paidAmount||0)," جنيه"]})]})}})(),de.paidAmount?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[de.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-3 border rounded-lg bg-gray-50",children:[Hm?e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx(q,{id:"partialAmount",type:"number",value:Vo,onChange:s=>tl(s.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{variant:"outline",onClick:()=>{el(!1),tl("")},children:"إلغاء"}),e.jsx(u,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const s=parseFloat(Vo);if(!de||isNaN(s)||s<=0){r({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Math.max(0,Number(de.amount||0)-Number(de.paidAmount||0));if(s>a){r({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const n=Number(((de.paidAmount||0)+s).toFixed(2)),l=n>=Number(de.amount||0),c={...de,amount:Number(de.amount||0),paidAmount:n,status:l?"paid":"pending",partialPayments:[...de.partialPayments||[],{amount:s,paidAt:new Date}]},h=Tt.map(x=>x.id===de.id?c:x);vs(h),or(c),await sa(h);try{if(t!=null&&t.uid){const x=Math.max(0,Number(c.amount||0)-Number(c.paidAmount||0));await ur.send(t.uid,`تم سداد جزء من دين ${c.debtorName}: المدفوع ${s} جنيه، المتبقي ${x} جنيه`)}}catch{}try{c.status==="paid"&&(t!=null&&t.uid)&&(async()=>{const x=Ke(Ce(V,"userTransactions"),me("userId","==",t.uid),me("linkedDebtId","==",de.id),me("status","==","pending")),g=await et(x);await Promise.allSettled(g.docs.map(T=>Wt(T.ref,{status:"completed",confirmedAt:new Date})));try{const T=g.docs.map(P=>{var Q;return String(((Q=P.data())==null?void 0:Q.transactionId)||"")});t!=null&&t.uid&&T.forEach(P=>P&&ve.removeLocalReceiptById(t.uid,P))}catch{}const D=Ke(Ce(V,"transactions"),me("userId","==",t.uid),me("linkedDebtId","==",de.id),me("status","==","pending")),p=await et(D);await Promise.allSettled(p.docs.map(T=>Wt(T.ref,{status:"completed",confirmedAt:new Date})));try{const T=p.docs.map(P=>{var Q;return String(P.id||((Q=P.data())==null?void 0:Q.transactionId)||"")});t!=null&&t.uid&&T.forEach(P=>P&&ve.removeLocalReceiptById(t.uid,P))}catch{}const w=Ke(Ce(V,"transactions"),me("merchantUserId","==",t.uid),me("linkedDebtId","==",de.id),me("status","==","pending")),A=await et(w);await Promise.allSettled(A.docs.map(T=>Wt(T.ref,{status:"completed",confirmedAt:new Date})));try{const T=A.docs.map(P=>{var Q;return String(P.id||((Q=P.data())==null?void 0:Q.transactionId)||"")});t!=null&&t.uid&&T.forEach(P=>P&&ve.removeLocalReceiptById(t.uid,P))}catch{}})().catch(x=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",x),r({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(x){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",x)}try{const x=Il(),g=localStorage.getItem(x);if(g){const p=(JSON.parse(g)||[]).map(w=>(w==null?void 0:w.linkedDebtId)===de.id&&(w==null?void 0:w.status)==="pending"?{...w,status:"completed",confirmedAt:new Date}:w);localStorage.setItem(x,JSON.stringify(p)),ya(w=>w.map(A=>(A==null?void 0:A.linkedDebtId)===de.id&&(A==null?void 0:A.status)==="pending"?{...A,status:"completed",confirmedAt:new Date}:A))}}catch(x){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",x)}ai(s),Ja("none"),Er(!0),el(!1),tl(""),r({title:"تم تسجيل دفع جزء",description:`تم دفع ${s} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(u,{variant:"outline",className:"w-full",onClick:()=>el(!0),children:"دفع جزء"}),de.partialPayments&&de.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-24 overflow-y-auto",children:de.partialPayments.map((s,a)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["دفع: ",s.amount," جنيه"]}),e.jsx("span",{children:new Date(s.paidAt).toLocaleString("ar-EG")})]},a))})]})]})]})]}),e.jsxs(ht,{className:"flex gap-2 justify-center",children:[e.jsx(u,{onClick:async()=>{if(de){const s=Tt.map(a=>a.id===de.id?{...a,status:"pending"}:a);vs(s),await sa(s);try{if(t!=null&&t.uid){const a=computedRemaining;await ur.send(t.uid,`تم سداد الدين بالكامل للعميل ${de.debtorName}: المدفوع ${a} جنيه`)}}catch{}qa(!1),r({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(u,{onClick:async()=>{if(de){const s=Number(de.amount||0),a=Number(de.paidAmount||0);let n=Math.max(0,s-a);try{const h=(Ze||[]).filter(w=>String((w==null?void 0:w.linkedDebtId)||"")===String(de.id)),x=h.reduce((w,A)=>w+Math.max(0,Number((A==null?void 0:A.commission)||0)),0),g=h.reduce((w,A)=>w+Math.max(0,Number(((A==null?void 0:A.sentAmount)??(A==null?void 0:A.transferredAmount)??(A==null?void 0:A.withdrawnAmount)??(A==null?void 0:A.amount))||0)),0),p=s<g+x?s+x:s;n=Math.max(0,Number(p)-a)}catch{}const l=n,c=Tt.map(h=>{if(h.id!==de.id)return h;const x=Number(h.amount||0),g=Number(h.paidAmount||0),D=Number((g+l).toFixed(2)),p=D>=x;return{...h,amount:x,paidAmount:p?x:D,status:"paid",partialPayments:[...h.partialPayments||[],...l>0?[{amount:l,paidAt:new Date}]:[]]}});vs(c);try{or(c.find(h=>h.id===de.id)||null)}catch{}ai(l),Ja("none"),Er(!0),await sa(c);try{t!=null&&t.uid&&(de!=null&&de.id)&&(async()=>{const h=Ke(Ce(V,"userTransactions"),me("userId","==",t.uid),me("linkedDebtId","==",de.id),me("status","==","pending")),x=await et(h);await Promise.allSettled(x.docs.map(A=>Wt(A.ref,{status:"completed",confirmedAt:new Date})));try{const A=x.docs.map(T=>{var P;return String(((P=T.data())==null?void 0:P.transactionId)||"")});t!=null&&t.uid&&A.forEach(T=>T&&ve.removeLocalReceiptById(t.uid,T))}catch{}const g=Ke(Ce(V,"transactions"),me("userId","==",t.uid),me("linkedDebtId","==",de.id),me("status","==","pending")),D=await et(g);await Promise.allSettled(D.docs.map(A=>Wt(A.ref,{status:"completed",confirmedAt:new Date})));try{const A=D.docs.map(T=>{var P;return String(T.id||((P=T.data())==null?void 0:P.transactionId)||"")});t!=null&&t.uid&&A.forEach(T=>T&&ve.removeLocalReceiptById(t.uid,T))}catch{}const p=Ke(Ce(V,"transactions"),me("merchantUserId","==",t.uid),me("linkedDebtId","==",de.id),me("status","==","pending")),w=await et(p);await Promise.allSettled(w.docs.map(A=>Wt(A.ref,{status:"completed",confirmedAt:new Date})));try{const A=w.docs.map(T=>{var P;return String(T.id||((P=T.data())==null?void 0:P.transactionId)||"")});t!=null&&t.uid&&A.forEach(T=>T&&ve.removeLocalReceiptById(t.uid,T))}catch{}})().catch(h=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",h),r({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(h){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",h)}try{const h=Il(),x=localStorage.getItem(h);if(x){const D=(JSON.parse(x)||[]).map(p=>(p==null?void 0:p.linkedDebtId)===de.id&&(p==null?void 0:p.status)==="pending"?{...p,status:"completed",confirmedAt:new Date}:p);localStorage.setItem(h,JSON.stringify(D)),ya(p=>p.map(w=>(w==null?void 0:w.linkedDebtId)===de.id&&(w==null?void 0:w.status)==="pending"?{...w,status:"completed",confirmedAt:new Date}:w))}}catch(h){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",h)}qa(!1),r({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(u,{onClick:async()=>{if(de){const s=Tt.filter(a=>a.id!==de.id);vs(s),await sa(s),qa(!1),r({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(Ne,{open:Ym,onOpenChange:en,children:e.jsxs(je,{className:"sm:max-w-md rounded-2xl shadow-elegant border border-gray-200",children:[e.jsxs(Se,{children:[e.jsx(De,{className:`text-right ${cr==="decrease"?"text-red-600":"text-green-600"}`,children:cr==="decrease"?"إنقاص مبلغ الدين":cr==="increase"?"زيادة مبلغ الدين":"تعديل مبلغ الدين"}),e.jsxs(Ss,{className:"text-right",children:["أدخل المبلغ ثم اضغط تأكيد لإتمام ",cr==="decrease"?"الإنقاص":"الزيادة","."]})]}),e.jsxs("div",{className:"grid gap-4 py-2",children:[e.jsx(te,{htmlFor:"debtAdjustAmount",className:"text-right",children:"المبلغ (جنيه)"}),e.jsx(q,{id:"debtAdjustAmount",type:"number",placeholder:"0.00",value:zo,onChange:s=>Xi(s.target.value)}),de&&e.jsxs("div",{className:"text-right text-sm text-muted-foreground",children:["المبلغ الحالي: ",e.jsx("span",{className:"font-semibold",children:Number(de.amount||0).toFixed(2)})," جنيه"]})]}),e.jsxs(ht,{className:"flex gap-2",children:[e.jsx(u,{variant:"secondary",onClick:()=>{en(!1),qa(!0)},children:"إلغاء"}),e.jsx(u,{className:cr==="decrease"?"bg-red-600 hover:bg-red-700":"bg-green-600 hover:bg-green-700",onClick:async()=>{try{if(!de||!cr)return;const s=Number(parseFloat(zo||"0").toFixed(2));if(!s||isNaN(s)||s<=0){r({title:"قيمة غير صالحة",description:"يرجى إدخال مبلغ أكبر من صفر",variant:"destructive"});return}qo({debtId:de.id,delta:s,type:cr}),en(!1),_r(!0)}catch(s){console.error("فشل تجهيز تعديل مبلغ الدين:",s),r({title:"خطأ",description:"تعذّر تجهيز تعديل مبلغ الدين",variant:"destructive"})}},children:"تأكيد"})]})]})}),e.jsx(Ne,{open:rh,onOpenChange:Er,children:e.jsxs(je,{className:"sm:max-w-[480px]",children:[e.jsxs(Se,{children:[e.jsx(De,{className:"text-right",children:"اختيار إضافة مبلغ السداد"}),e.jsx(Ss,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 justify-center",children:[e.jsx(u,{variant:ta==="cash"?"default":"outline",className:ta==="cash"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>Ja("cash"),children:"الفلوس النقدية"}),e.jsx(u,{variant:ta==="wallet"?"default":"outline",className:ta==="wallet"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>Ja("wallet"),children:"أرصدة المحافظ"}),e.jsx(u,{variant:ta==="fawry"?"default":"outline",className:ta==="fawry"?"bg-amber-600 text-white":"",size:"sm",onClick:()=>Ja("fawry"),children:"فوري"}),e.jsx(u,{variant:ta==="none"?"default":"outline",className:ta==="none"?"bg-gray-600 text-white":"",size:"sm",onClick:()=>Ja("none"),children:"بدون إضافة"})]}),ta==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:dr,onChange:s=>pl(s.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),Je&&Je.length>0?Je.map(s=>e.jsx("option",{value:s.id,children:s.phone||s.name||s.id},s.id)):Object.keys(lt||{}).map(s=>{var a,n,l,c,h,x;return e.jsx("option",{value:s,children:((a=Je.find(g=>g.id===s))==null?void 0:a.phone)||((l=(n=JSON.parse(localStorage.getItem(Al())||"[]"))==null?void 0:n.find(g=>g.id===s))==null?void 0:l.phone)||((h=(c=JSON.parse(localStorage.getItem(Al())||"[]"))==null?void 0:c.find(g=>g.id===s))==null?void 0:h.name)||((x=Je.find(g=>g.id===s))==null?void 0:x.name)||s},s)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[tc," جنيه"]})]})]}),e.jsxs(ht,{className:"flex flex-wrap justify-between gap-2",children:[e.jsx(u,{variant:"outline",onClick:()=>{Er(!1),ai(0),Ja(null),pl("")},children:"إلغاء"}),e.jsx(u,{onClick:async()=>{var s,a;try{const n=tc;if(!n||n<=0){Er(!1);return}if(ta==="cash"){const l=Mt+n;Qt(l),localStorage.setItem(Ks(),l.toString());const c={cashBalance:l,lastUpdated:new Date().toISOString()},h=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(h,JSON.stringify(c)),t!=null&&t.uid?(ve.updateUserData(t.uid,c).catch(()=>tt(!0)),localStorage.removeItem(h),tt(!1)):tt(!0),r({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${n} جنيه إلى الفلوس النقدية`})}else if(ta==="wallet"){if(!dr){r({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const l={...lt,[dr]:(lt[dr]||0)+n};cs(l);const c=(Mt||0)-n;Qt(c),localStorage.setItem(Ks(),c.toString());const h=new Date().toISOString(),x={walletBalances:l,cashBalance:c,lastUpdated:h},g=`userData_${t==null?void 0:t.uid}`;if(localStorage.setItem(g,JSON.stringify(x)),localStorage.setItem(Rs(),JSON.stringify(l)),localStorage.setItem(`walletBalances_backup_${h}`,JSON.stringify(l)),t!=null&&t.uid){ve.updateUserData(t.uid,x).catch(()=>tt(!0));try{localStorage.removeItem(g)}catch{}tt(!1)}else tt(!0);r({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${n} جنيه إلى المحفظة ${((s=Je.find(D=>D.id===dr))==null?void 0:s.phone)||((a=Je.find(D=>D.id===dr))==null?void 0:a.name)||dr} وتم خصم نفس المبلغ من درج النقدية`})}else if(ta==="none"){r({title:"تم تسجيل السداد",description:`تم تسجيل ${n} جنيه بدون تعديل الأرصدة`});try{if(de){const l=Tt.map(c=>c.id===de.id?{...c,status:"paid",paidAmount:Math.max(Number(c.paidAmount||0),Number(c.amount||0))}:c);vs(l);try{or(l.find(c=>c.id===de.id)||null)}catch{}try{await sa(l)}catch{}}}catch{}}else if(ta==="fawry")r({title:"تم تسجيل سداد عبر فوري",description:`تم تسجيل ${n} جنيه كسداد عبر فوري بدون تعديل الأرصدة`});else{r({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}try{const l=n>0?n:Number((de==null?void 0:de.amount)||0);t!=null&&t.uid&&de&&await ur.send(t.uid,`تم سداد الدين بالكامل للعميل ${de.debtorName}: المدفوع ${l} جنيه`)}catch{}}catch(n){console.error("خطأ أثناء إضافة مبلغ السداد:",n),r({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{Er(!1),ai(0),Ja(null),pl("");try{kr(!0)}catch{}}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(Ne,{open:jm,onOpenChange:ir,children:e.jsxs(je,{hideClose:!0,className:"post-confirm-card sm:max-w-[420px] w-[90vw] rounded-2xl bg-gradient-to-br from-white via-indigo-50 to-blue-50 shadow-2xl border border-indigo-100",children:[e.jsxs(Se,{children:[e.jsx(De,{className:"text-right text-2xl font-bold",children:(os==null?void 0:os.type)==="transfer"?"مبلغ يجب استلامه":"مبلغ يجب تسليمه"}),e.jsx(Ss,{className:"text-right text-gray-600",children:(os==null?void 0:os.type)==="transfer"?"هذا هو المبلغ الواجب استلامه من العميل بعد التأكيد.":"هذا هو المبلغ الواجب تسليمه للعميل بعد التأكيد."})]}),e.jsxs("div",{className:"py-3 flex flex-col items-center gap-1.5",children:[e.jsxs("div",{className:"text-xl sm:text-2xl font-bold text-blue-700 tracking-wide",children:[Es((os==null?void 0:os.amount)||0)," جنيه"]}),e.jsx("div",{className:"text-sm text-gray-500 text-right w-full",children:(os==null?void 0:os.type)==="transfer"?"المبلغ المعروض شامل عمولة التحويل.":St?"العمولة مضافة ولا تؤثر على قيمة التسليم.":"العمولة مخصومة من المبلغ المسلّم للعميل."})]}),e.jsxs(ht,{className:"flex justify-end gap-2",children:[(os==null?void 0:os.type)==="transfer"&&e.jsx(u,{variant:"outline",id:"sendCodeBtn",onClick:hs,disabled:Io,className:"btn-transfer-confirm",children:Io?"جارٍ الإرسال...":"إرسال كود التحويل"}),e.jsx(u,{onClick:()=>{ir(!1),Vi(null)},className:"bg-green-600 hover:bg-green-700 text-white",children:(os==null?void 0:os.type)==="transfer"?"تم الاستلام":"تم التسليم"})]})]})}),e.jsx(Ku,{open:Dm,onClose:()=>Ar(!1),onSubmit:Ot,deviceId:Ao||be||"",recipientMsisdn:String(le==="transfer"?(Vs==null?void 0:Vs.receiver)||gs||"":((Bc=Je.find(s=>s.id===U))==null?void 0:Bc.phone)||"").replace(/\D/g,"")}),e.jsx(ep,{open:ie,onOpenChange:Te}),To]}))};export{n0 as default};
//# sourceMappingURL=UserDashboardPage-BRKQ-meY.js.map
