{"version":3,"mappings":"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","names":["formatNumber","n","formatDateTime","iso","STORAGE_KEY_OPENING","STORAGE_KEY_OPENING_SNAPSHOT","MachineDailyDialog","open","onOpenChange","toast","useToast","shiftUser","useShift","user","useFirebaseAuth","shopId","shopName","useShop","getFallbackShopId","key","val","keys","k","v","useEffect","prev","openingBase","setOpeningBase","useState","openingAir","setOpeningAir","drawerCash","setDrawerCash","savedOpeningBase","setSavedOpeningBase","savedOpeningAir","setSavedOpeningAir","savedDrawerCash","setSavedDrawerCash","openingSnapshot","setOpeningSnapshot","activeSection","setActiveSection","deliveryBase","setDeliveryBase","deliveryAir","setDeliveryAir","netResult","setNetResult","receipts","setReceipts","withdrawalReceipts","setWithdrawalReceipts","transferReceipts","setTransferReceipts","transferDialogOpen","setTransferDialogOpen","isVideoModalOpen","setIsVideoModalOpen","wholesalePrice","setWholesalePrice","retailPrice","setRetailPrice","deductDialogOpen","setDeductDialogOpen","pendingTransfer","setPendingTransfer","machines","setMachines","selectedMachineId","setSelectedMachineId","newMachineName","setNewMachineName","transferServerHydrated","setTransferServerHydrated","deliveriesServerHydrated","setDeliveriesServerHydrated","withdrawalAmount","setWithdrawalAmount","commissionMode","setCommissionMode","commissionRate","setCommissionRate","fixedCommissionAmount","setFixedCommissionAmount","monthlyWithdrawalsUsed","setMonthlyWithdrawalsUsed","dailyWithdrawalsUsed","setDailyWithdrawalsUsed","monthlyWithdrawalsProfit","setMonthlyWithdrawalsProfit","dailyWithdrawalsProfit","setDailyWithdrawalsProfit","deductFromDrawer","setDeductFromDrawer","isProcessing","setIsProcessing","isProcessingRef","React","latestTransferId","latestDeliveryId","keyOpening","keySnap","savedOpening","obj","savedSnap","snap","sid","getDocs","__vitePreload","getDocs2","col","collection","db","list","query","d","savedId","m","err","cashierName","useMemo","totalTransferProfit","sum","t","totalWholesaleTransferred","handleClearTransferReceipts","deleteDoc","handleClearMachineReceipts","handleDeleteTransferReceipt","receipt","oldReceipts","currentBase","currentAir","currentDrawer","newBase","newAir","newDrawer","keyTrans","nextReceipts","receiptRef","doc","machineRef","setDoc","serverTimestamp","selectedMachineName","_a","userDataService","userDoc","newCash","error","handleDeleteMachineReceipt","id","r","handleResetOpening","handleAddOpening","base","air","dc","sid0","ref","handleDoDelivery","dBase","dAir","openingBaseForReceipt","openingAirForReceipt","openingSum","result","sid1","addDoc","current","arr","next","handleTransferConfirm","w","profit","finalizeTransfer","from","nowTs","tempId","referenceId","stockDeductAmount","prevBase","prevAir","prevDrawer","totalDrawerAdded","sid2","transferAmount","dashRef","dashSnap","dashCash","optimisticTx","sidKey","resetDialogState","refreshMachineData","sorted","x","created","_b","a","b","local","item","index","self","e","ded","keyDel","cachedDel","parsed","cachedTrans","fetchMonthlyWithdrawals","now","startOfMonth","startOfDay","q","orderBy","mSum","dSum","mProfit","dProfit","amount","handleDeleteWithdrawalReceipt","docRef","getDoc","getDoc2","data","updateDoc","updateDoc2","shopDocRef","handleCashWithdrawal","commission","rateUsed","rate","fixed","updatedCashBalance","txData","docId","finalTxData","txError","handleClose","nextOpen","jsxs","Dialog","DialogContent","DialogHeader","DialogTitle","jsx","FawryMachineIcon","Button","PlayCircle","RefreshCcw","DialogDescription","Card","CardHeader","CardTitle","baseRef","transSnap","delSnap","Trash2","CardContent","Select","sidSel","SelectTrigger","SelectValue","SelectContent","SelectItem","Input","name","Badge","Fragment","Separator","Checkbox","c","Calendar","DialogFooter","Clock","AlertDialog","AlertDialogContent","AlertDialogHeader","AlertDialogTitle","AlertDialogDescription","VideoModal"],"ignoreList":[],"sources":["../../src/components/MachineDailyDialog.tsx"],"sourcesContent":["import React, { useEffect, useMemo, useState } from 'react';\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from '@/components/ui/dialog';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Separator } from '@/components/ui/separator';\r\nimport { Progress } from '@/components/ui/progress';\r\nimport { Receipt, Calendar, Clock, ChevronDown, Trash2, RefreshCcw, PlayCircle } from 'lucide-react';\r\nimport FawryMachineIcon from '@/components/icons/FawryMachineIcon';\r\nimport { useToast } from '@/hooks/use-toast';\r\nimport { useShift } from '@/contexts/ShiftContext';\r\nimport { AlertDialog, AlertDialogContent, AlertDialogHeader, AlertDialogTitle, AlertDialogDescription, AlertDialogAction, AlertDialogCancel } from '@/components/ui/alert-dialog';\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\r\nimport { Checkbox } from '@/components/ui/checkbox';\r\nimport { db } from '@/firebase';\r\nimport { addDoc, collection, doc, setDoc, serverTimestamp, deleteDoc, getDocs, orderBy, query } from 'firebase/firestore';\r\nimport { useShop } from '@/hooks/useShop';\r\nimport { useFirebaseAuth } from '@/contexts/FirebaseAuthContext';\r\nimport { userDataService } from '@/integrations/firebase/services';\r\nimport { ProfitService } from '@/utils/profitService';\r\nimport { VideoModal } from '@/components/VideoModal';\r\n\r\ninterface MachineDailyDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n}\r\n\r\ninterface MachineReceipt {\r\n  id: string;\r\n  openingBase: number; // الرصيد الأساسي الافتتاحي\r\n  openingAir: number;  // رصيد الهواء الافتتاحي\r\n  deliveryBase: number; // الرصيد الأساسي عند التسليم\r\n  deliveryAir: number;  // رصيد الهواء عند التسليم\r\n  netResult: number;    // الناتج النهائي: (تسليم) - (افتتاحي)\r\n  createdAt: string;    // التاريخ والوقت\r\n  cashierName?: string; // اسم الكاشير إن وجد\r\n  requiredDrawerNoProfit?: number; // المطلوب من الدرج بدون أرباح\r\n}\r\n\r\ninterface TransferReceipt {\r\n  id: string;\r\n  wholesalePrice: number; // سعر الجملة للرصيد المحوّل\r\n  retailPrice: number;    // سعر التجزئة للرصيد المحوّل\r\n  profit: number;         // الربح الفوري: التجزئة - الجملة\r\n  createdAt: string;\r\n  cashierName?: string;\r\n  deductFrom?: 'base' | 'air'; // مصدر الخصم: الأساسي أو الهواء\r\n}\r\n\r\nconst formatNumber = (n: number) => {\r\n  try { return Math.round(Number(n || 0)).toLocaleString('en-US', { maximumFractionDigits: 0 }); } catch { return String(n); }\r\n};\r\n\r\nconst formatDateTime = (iso?: string) => {\r\n  try {\r\n    const d = iso ? new Date(iso) : new Date();\r\n    return d.toLocaleString('en-GB', {\r\n      year: 'numeric', month: '2-digit', day: '2-digit',\r\n      hour: '2-digit', minute: '2-digit', second: '2-digit',\r\n      hour12: false,\r\n    });\r\n  } catch {\r\n    return new Date().toISOString();\r\n  }\r\n};\r\n\r\n// مفاتيح التخزين المحلي للحفاظ على القيم أثناء فتح النافذة\r\nconst STORAGE_KEY_OPENING = 'machine_daily_opening_values';\r\nconst STORAGE_KEY_OPENING_SNAPSHOT = 'machine_daily_opening_snapshot';\r\n\r\nexport default function MachineDailyDialog({ open, onOpenChange }: MachineDailyDialogProps) {\r\n  const { toast } = useToast();\r\n  const { shiftUser } = useShift();\r\n  const { user } = useFirebaseAuth();\r\n  const { shopId, shopName } = useShop();\r\n  const getFallbackShopId = () => {\r\n    try {\r\n      if (user?.uid) {\r\n        const key = `selectedShopId_${user.uid}`;\r\n        const val = localStorage.getItem(key);\r\n        if (val) return val;\r\n      }\r\n      const keys = Object.keys(localStorage || {}).filter(k => k.startsWith('selectedShopId_'));\r\n      for (const k of keys) {\r\n        const v = localStorage.getItem(k);\r\n        if (v) return v;\r\n      }\r\n      return null;\r\n    } catch {\r\n      return null;\r\n    }\r\n  };\r\n\r\n  // منع تمرير الصفحة عند فتح نافذة اليومية وإعادة الحالة عند الإغلاق\r\n  useEffect(() => {\r\n    try {\r\n      if (open) {\r\n        const prev = document.body.style.overflow;\r\n        document.body.setAttribute('data-prev-overflow', prev);\r\n        document.body.style.overflow = 'hidden';\r\n      } else {\r\n        const prev = document.body.getAttribute('data-prev-overflow') || '';\r\n        document.body.style.overflow = prev;\r\n        document.body.removeAttribute('data-prev-overflow');\r\n      }\r\n    } catch {}\r\n    return () => {\r\n      try {\r\n        const prev = document.body.getAttribute('data-prev-overflow') || '';\r\n        document.body.style.overflow = prev;\r\n        document.body.removeAttribute('data-prev-overflow');\r\n      } catch {}\r\n    };\r\n  }, [open]);\r\n\r\n  // إدخالات الرصيد الافتتاحي\r\n  const [openingBase, setOpeningBase] = useState<string>('');\r\n  const [openingAir, setOpeningAir] = useState<string>('');\r\n  const [drawerCash, setDrawerCash] = useState<string>('');\r\n\r\n  // القيم المسجلة للرصيد الافتتاحي\r\n  const [savedOpeningBase, setSavedOpeningBase] = useState<number | null>(null);\r\n  const [savedOpeningAir, setSavedOpeningAir] = useState<number | null>(null);\r\n  const [savedDrawerCash, setSavedDrawerCash] = useState<number | null>(null);\r\n  const [openingSnapshot, setOpeningSnapshot] = useState<{ openingBase: number; openingAir: number; drawerCash: number } | null>(null);\r\n\r\n  const [activeSection, setActiveSection] = useState<'opening' | 'transfer' | 'transferReceipts' | 'delivery' | 'deliveryReceipts' | 'machines' | 'cashWithdrawal' | 'withdrawalReceipts'>('opening');\r\n\r\n  // قسم التسليم اليومي\r\n  const [deliveryBase, setDeliveryBase] = useState<string>('');\r\n  const [deliveryAir, setDeliveryAir] = useState<string>('');\r\n  const [netResult, setNetResult] = useState<number | null>(null);\r\n\r\n  // إيصالات داخل النافذة (بدون تخزين محلي)\r\n  const [receipts, setReceipts] = useState<MachineReceipt[]>([]);\r\n  \r\n  // إيصالات سحب الكاش\r\n  const [withdrawalReceipts, setWithdrawalReceipts] = useState<any[]>([]);\r\n\r\n  // إيصالات تحويل الرصيد (بدون تخزين محلي)\r\n  const [transferReceipts, setTransferReceipts] = useState<TransferReceipt[]>([]);\r\n\r\n  // حالة نافذة التحويل وأسعار الجملة/التجزئة\r\n  const [transferDialogOpen, setTransferDialogOpen] = useState(false);\r\n  const [isVideoModalOpen, setIsVideoModalOpen] = useState(false);\r\n  const [wholesalePrice, setWholesalePrice] = useState<string>('');\r\n  const [retailPrice, setRetailPrice] = useState<string>('');\r\n\r\n  // نافذة اختيار الخصم بعد إدخال الأسعار\r\n  const [deductDialogOpen, setDeductDialogOpen] = useState(false);\r\n  const [pendingTransfer, setPendingTransfer] = useState<{\r\n    wholesalePrice: number;\r\n    retailPrice: number;\r\n    profit: number;\r\n  } | null>(null);\r\n\r\n  // إدارة الماكينات (اختيار/إنشاء)\r\n  const [machines, setMachines] = useState<{ id: string; name: string; monthlyLimit?: number }[]>([]);\r\n  const [selectedMachineId, setSelectedMachineId] = useState<string | null>(null);\r\n  const [newMachineName, setNewMachineName] = useState<string>('');\r\n  const [transferServerHydrated, setTransferServerHydrated] = useState(false);\r\n  const [deliveriesServerHydrated, setDeliveriesServerHydrated] = useState(false);\r\n\r\n  // Cash Withdrawal State\r\n  const [withdrawalAmount, setWithdrawalAmount] = useState<string>('');\r\n  const [commissionMode, setCommissionMode] = useState<'rate' | 'fixed'>('rate');\r\n  const [commissionRate, setCommissionRate] = useState<string>('2'); // Default 2 per 1000\r\n  const [fixedCommissionAmount, setFixedCommissionAmount] = useState<string>('');\r\n  const [monthlyWithdrawalsUsed, setMonthlyWithdrawalsUsed] = useState<number>(0);\r\n  const [dailyWithdrawalsUsed, setDailyWithdrawalsUsed] = useState<number>(0);\r\n  const [monthlyWithdrawalsProfit, setMonthlyWithdrawalsProfit] = useState<number>(0);\r\n  const [dailyWithdrawalsProfit, setDailyWithdrawalsProfit] = useState<number>(0);\r\n  const [deductFromDrawer, setDeductFromDrawer] = useState<boolean>(false);\r\n  const [isProcessing, setIsProcessing] = useState(false);\r\n  const isProcessingRef = React.useRef(false);\r\n\r\n  // لتجنب الكتابة فوق البيانات الجديدة إذا تأخر السيرفر\r\n  const latestTransferId = React.useRef<string | null>(null);\r\n  const latestDeliveryId = React.useRef<string | null>(null);\r\n\r\n  // Reset processing state when dialog opens\r\n  useEffect(() => {\r\n    if (open) {\r\n      isProcessingRef.current = false;\r\n      setIsProcessing(false);\r\n    }\r\n  }, [open]);\r\n\r\n  // Hydrate per-machine opening values when dialog opens or machine changes\r\n  useEffect(() => {\r\n    if (!open) return;\r\n    try {\r\n      const keyOpening = selectedMachineId ? `${STORAGE_KEY_OPENING}_${selectedMachineId}` : STORAGE_KEY_OPENING;\r\n      const keySnap = selectedMachineId ? `${STORAGE_KEY_OPENING_SNAPSHOT}_${selectedMachineId}` : STORAGE_KEY_OPENING_SNAPSHOT;\r\n      const savedOpening = localStorage.getItem(keyOpening);\r\n      if (savedOpening) {\r\n        const obj = JSON.parse(savedOpening);\r\n        if (typeof obj?.openingBase === 'number') setSavedOpeningBase(obj.openingBase);\r\n        if (typeof obj?.openingAir === 'number') setSavedOpeningAir(obj.openingAir);\r\n        if (typeof obj?.drawerCash === 'number') setSavedDrawerCash(obj.drawerCash);\r\n      } else {\r\n        setSavedOpeningBase(null);\r\n        setSavedOpeningAir(null);\r\n        setSavedDrawerCash(null);\r\n      }\r\n\r\n      const savedSnap = localStorage.getItem(keySnap);\r\n      if (savedSnap) {\r\n        const snap = JSON.parse(savedSnap);\r\n        if (typeof snap?.openingBase === 'number' && typeof snap?.openingAir === 'number') {\r\n          setOpeningSnapshot({ openingBase: snap.openingBase, openingAir: snap.openingAir, drawerCash: snap.drawerCash || 0 });\r\n        } else {\r\n          setOpeningSnapshot(null);\r\n        }\r\n      } else {\r\n        setOpeningSnapshot(null);\r\n      }\r\n      \r\n      // Clear inputs on machine change\r\n      setOpeningBase('');\r\n      setOpeningAir('');\r\n      setDrawerCash('');\r\n    } catch {}\r\n  }, [open, selectedMachineId]);\r\n\r\n  // تحميل قائمة الماكينات عند فتح النافذة\r\n  useEffect(() => {\r\n    (async () => {\r\n      try {\r\n        const sid = shopId || getFallbackShopId();\r\n        if (!open || !sid) return;\r\n        const { getDocs } = await import('firebase/firestore');\r\n        const col = collection(db, 'shops', sid, 'machines');\r\n        const snap = await getDocs(query(col));\r\n        const list = snap.docs.map(d => ({ \r\n          id: d.id, \r\n          name: String(d.data().name || 'ماكينة'),\r\n          monthlyLimit: Number(d.data().monthlyLimit || 50000) \r\n        }));\r\n        setMachines(list);\r\n        try {\r\n          const savedId = localStorage.getItem(`machineDaily_selected_${sid}`);\r\n          const exists = savedId && list.some(m => m.id === savedId);\r\n          if (exists) {\r\n            setSelectedMachineId(savedId as string);\r\n          } else if (!selectedMachineId && list.length > 0) {\r\n            setSelectedMachineId(list[0].id);\r\n            localStorage.setItem(`machineDaily_selected_${sid}`, list[0].id);\r\n          }\r\n        } catch {}\r\n      } catch (err) {\r\n        console.error('Load machines error:', err);\r\n      }\r\n    })();\r\n  }, [open, shopId]);\r\n\r\n  // تم إلغاء مزامنة الإيصالات إلى التخزين المحلي\r\n\r\n  const cashierName = useMemo(() => {\r\n    return shiftUser?.displayName || shiftUser?.name || shiftUser?.username || undefined;\r\n  }, [shiftUser]);\r\n\r\n  const totalTransferProfit = useMemo(() => transferReceipts.reduce((sum, t) => sum + (t.profit || 0), 0), [transferReceipts]);\r\n  const totalWholesaleTransferred = useMemo(() => transferReceipts.reduce((sum, t) => sum + (t.wholesalePrice || 0), 0), [transferReceipts]);\r\n\r\n  const handleClearTransferReceipts = async () => {\r\n    try {\r\n      const sid = shopId || getFallbackShopId();\r\n      if (sid && selectedMachineId) {\r\n        const col = collection(db, 'shops', sid, 'machines', selectedMachineId, 'transfers');\r\n        const snap = await getDocs(query(col));\r\n        await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));\r\n        try { localStorage.setItem(`machineDaily_transfers_${sid}_${selectedMachineId}`, JSON.stringify([])); } catch {}\r\n      }\r\n    } catch {}\r\n    setTransferReceipts([]);\r\n    toast({ title: 'تم حذف الإيصالات', description: 'تم مسح كل إيصالات التحويل.' });\r\n  };\r\n\r\n  const handleClearMachineReceipts = async () => {\r\n    try {\r\n      const sid = shopId || getFallbackShopId();\r\n      if (sid && selectedMachineId) {\r\n        const col = collection(db, 'shops', sid, 'machines', selectedMachineId, 'deliveries');\r\n        const snap = await getDocs(query(col));\r\n        await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));\r\n        try { localStorage.setItem(`machineDaily_deliveries_${sid}_${selectedMachineId}`, JSON.stringify([])); } catch {}\r\n      }\r\n    } catch {}\r\n    setReceipts([]);\r\n    toast({ title: 'تم حذف الإيصالات', description: 'تم مسح كل إيصالات الماكينة.' });\r\n  };\r\n\r\n  const handleDeleteTransferReceipt = async (receipt: TransferReceipt) => {\r\n    if (!selectedMachineId) return;\r\n    const sid = shopId || getFallbackShopId();\r\n    if (!sid) return;\r\n\r\n    // 1. Remove from state immediately (optimistic)\r\n    const oldReceipts = [...transferReceipts];\r\n    setTransferReceipts(prev => prev.filter(t => t.id !== receipt.id));\r\n\r\n    try {\r\n      // 2. Restore Balances\r\n      const currentBase = savedOpeningBase || 0;\r\n      const currentAir = savedOpeningAir || 0;\r\n      const currentDrawer = savedDrawerCash || 0;\r\n\r\n      let newBase = currentBase;\r\n      let newAir = currentAir;\r\n      let newDrawer = currentDrawer;\r\n\r\n      // استرجاع الرصيد للمصدر (أساسي أو هواء)\r\n      if (receipt.deductFrom === 'base') {\r\n        newBase = Math.round((currentBase + receipt.wholesalePrice) * 100) / 100;\r\n      } else if (receipt.deductFrom === 'air') {\r\n        newAir = Math.round((currentAir + receipt.wholesalePrice) * 100) / 100;\r\n      }\r\n      \r\n      // خصم المبلغ الذي تم إضافته للدرج (سعر التجزئة)\r\n      newDrawer = Math.round((currentDrawer - receipt.retailPrice) * 100) / 100;\r\n\r\n      // Update state\r\n      setSavedOpeningBase(newBase);\r\n      setSavedOpeningAir(newAir);\r\n      setSavedDrawerCash(newDrawer);\r\n      \r\n      if (openingSnapshot) {\r\n         setOpeningSnapshot({\r\n            openingBase: newBase,\r\n            openingAir: newAir,\r\n            drawerCash: newDrawer\r\n         });\r\n      }\r\n\r\n      // 3. Update Local Storage\r\n      const keyOpening = `${STORAGE_KEY_OPENING}_${selectedMachineId}`;\r\n      const keySnap = `${STORAGE_KEY_OPENING_SNAPSHOT}_${selectedMachineId}`;\r\n      localStorage.setItem(keyOpening, JSON.stringify({ openingBase: newBase, openingAir: newAir, drawerCash: newDrawer }));\r\n      localStorage.setItem(keySnap, JSON.stringify({ openingBase: newBase, openingAir: newAir, drawerCash: newDrawer }));\r\n      \r\n      const keyTrans = `machineDaily_transfers_${sid}_${selectedMachineId}`;\r\n      const nextReceipts = oldReceipts.filter(t => t.id !== receipt.id);\r\n      localStorage.setItem(keyTrans, JSON.stringify(nextReceipts));\r\n\r\n      // 4. Update Firestore\r\n      const receiptRef = doc(db, 'shops', sid, 'machines', selectedMachineId, 'transfers', receipt.id);\r\n      await deleteDoc(receiptRef);\r\n\r\n      const machineRef = doc(db, 'shops', sid, 'machines', selectedMachineId);\r\n      await setDoc(machineRef, {\r\n          openingBase: newBase,\r\n          openingAir: newAir,\r\n          drawerCash: newDrawer,\r\n          updatedAt: serverTimestamp(),\r\n      }, { merge: true });\r\n      \r\n      // 5. Revert User Transaction (Cash Balance)\r\n      if (user?.uid) {\r\n         const selectedMachineName = machines.find(m => m.id === selectedMachineId)?.name || 'ماكينة';\r\n         \r\n         await userDataService.saveUserTransaction(user.uid, {\r\n            type: 'expense', \r\n            amount: receipt.retailPrice, \r\n            senderName: selectedMachineName,\r\n            title: 'حذف إيصال تحويل',\r\n            description: `إلغاء تحويل من ${selectedMachineName}`,\r\n            shopId: sid,\r\n            status: 'completed',\r\n            createdAt: new Date(),\r\n            transactionId: `del_mtr_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\r\n            cashierName: cashierName || 'Unknown'\r\n         });\r\n\r\n         const userDoc = await userDataService.getUserData(user.uid);\r\n         const currentCash = Number(userDoc?.cashBalance || 0);\r\n         const newCash = currentCash - receipt.retailPrice;\r\n         await userDataService.updateUserData(user.uid, { cashBalance: newCash });\r\n      }\r\n\r\n      toast({ title: 'تم الحذف', description: 'تم حذف الإيصال واسترجاع الأرصدة.' });\r\n\r\n    } catch (error) {\r\n      console.error(\"Error deleting transfer receipt:\", error);\r\n      setTransferReceipts(oldReceipts);\r\n      toast({ title: 'خطأ', description: 'فشل حذف الإيصال.', variant: 'destructive' });\r\n    }\r\n  };\r\n\r\n  const handleDeleteMachineReceipt = (id: string) => {\r\n    setReceipts(prev => prev.filter(r => r.id !== id));\r\n    toast({ title: 'تم حذف الإيصال', description: 'تم إزالة إيصال الماكينة المحدد.' });\r\n  };\r\n\r\n  // زر تصفير الرصيد الافتتاحي لتغييره\r\n  const handleResetOpening = () => {\r\n    setSavedOpeningBase(null);\r\n    setSavedOpeningAir(null);\r\n    setSavedDrawerCash(null);\r\n    setOpeningSnapshot(null);\r\n  \r\n    setOpeningBase('');\r\n    setOpeningAir('');\r\n    setDrawerCash('');\r\n  \r\n    try {\r\n      const keyOpening = selectedMachineId ? `${STORAGE_KEY_OPENING}_${selectedMachineId}` : STORAGE_KEY_OPENING;\r\n      const keySnap = selectedMachineId ? `${STORAGE_KEY_OPENING_SNAPSHOT}_${selectedMachineId}` : STORAGE_KEY_OPENING_SNAPSHOT;\r\n      localStorage.removeItem(keyOpening);\r\n      localStorage.removeItem(keySnap);\r\n    } catch {}\r\n  \r\n    toast({ title: 'تم التصفير', description: 'يمكنك الآن إدخال رصيد افتتاحي جديد.' });\r\n  };\r\n  const handleAddOpening = async () => {\r\n    const base = parseFloat(openingBase || '0');\r\n    const air = parseFloat(openingAir || '0');\r\n    const dc = parseFloat(drawerCash || '0');\r\n\r\n    if (isNaN(base) || isNaN(air) || isNaN(dc)) {\r\n      toast({ title: 'قيمة غير صالحة', description: 'يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.', variant: 'destructive' });\r\n      return;\r\n    }\r\n    if (base < 0 || air < 0 || dc < 0) {\r\n      toast({ title: 'قيمة سالبة', description: 'لا يمكن إدخال قيم سالبة.', variant: 'destructive' });\r\n      return;\r\n    }\r\n\r\n    setSavedOpeningBase(base);\r\n    setSavedOpeningAir(air);\r\n    setSavedDrawerCash(dc);\r\n    try {\r\n      const keyOpening = selectedMachineId ? `${STORAGE_KEY_OPENING}_${selectedMachineId}` : STORAGE_KEY_OPENING;\r\n      const keySnap = selectedMachineId ? `${STORAGE_KEY_OPENING_SNAPSHOT}_${selectedMachineId}` : STORAGE_KEY_OPENING_SNAPSHOT;\r\n      localStorage.setItem(keyOpening, JSON.stringify({ openingBase: base, openingAir: air, drawerCash: dc }));\r\n      localStorage.setItem(keySnap, JSON.stringify({ openingBase: base, openingAir: air, drawerCash: dc }));\r\n      setOpeningSnapshot({ openingBase: base, openingAir: air, drawerCash: dc });\r\n      // حفظ في Firestore تحت الماكينة المحددة\r\n      const sid0 = shopId || getFallbackShopId();\r\n      if (sid0 && selectedMachineId) {\r\n        const ref = doc(db, 'shops', sid0, 'machines', selectedMachineId);\r\n        await setDoc(ref, {\r\n          name: machines.find(m => m.id === selectedMachineId)?.name || 'ماكينة',\r\n          openingBase: base,\r\n          openingAir: air,\r\n          drawerCash: dc,\r\n          cashierName: cashierName || 'Unknown',\r\n          shopName: shopName || null,\r\n          updatedAt: serverTimestamp(),\r\n        }, { merge: true });\r\n      }\r\n    } catch {}\r\n\r\n    toast({ title: 'تم تسجيل البيانات', description: `الافتتاحي الأساسي: ${formatNumber(base)}، الهواء: ${formatNumber(air)}، فلوس الدرج: ${formatNumber(dc)}` });\r\n  };\r\n\r\n  const handleStartDelivery = () => {\r\n    if (savedOpeningBase == null || savedOpeningAir == null) {\r\n      toast({ title: 'سجل الرصيد الافتتاحي أولاً', description: 'يرجى الضغط على زر \"إضافة\" بعد إدخال الافتتاحي.' });\r\n      return;\r\n    }\r\n    setActiveSection('delivery');\r\n  };\r\n\r\n  const handleDoDelivery = () => {\r\n    const dBase = parseFloat(deliveryBase || '0');\r\n    const dAir = parseFloat(deliveryAir || '0');\r\n\r\n    if (isNaN(dBase) || isNaN(dAir)) {\r\n      toast({ title: 'قيمة غير صالحة', description: 'يرجى إدخال أرقام صحيحة لرصيد التسليم.', variant: 'destructive' });\r\n      return;\r\n    }\r\n    if (dBase < 0 || dAir < 0) {\r\n      toast({ title: 'قيمة سالبة', description: 'لا يمكن إدخال قيم سالبة.', variant: 'destructive' });\r\n      return;\r\n    }\r\n\r\n    const openingBaseForReceipt = openingSnapshot?.openingBase ?? (savedOpeningBase || 0);\r\n    const openingAirForReceipt = openingSnapshot?.openingAir ?? (savedOpeningAir || 0);\r\n\r\n    const openingSum = (openingBaseForReceipt) + (openingAirForReceipt);\r\n    const deliverySum = dBase + dAir;\r\n    const result = deliverySum - openingSum;\r\n\r\n    setNetResult(result);\r\n\r\n    const receipt: MachineReceipt = {\r\n      id: `${Date.now()}`,\r\n      openingBase: openingBaseForReceipt,\r\n      openingAir: openingAirForReceipt,\r\n      deliveryBase: dBase,\r\n      deliveryAir: dAir,\r\n      netResult: result,\r\n      createdAt: new Date().toISOString(),\r\n      cashierName: cashierName || 'Unknown',\r\n      requiredDrawerNoProfit: result < 0 ? Math.round(-result * 100) / 100 : 0,\r\n    };\r\n    latestDeliveryId.current = receipt.id;\r\n\r\n    // حفظ التسليم في Firestore تحت الماكينة المحددة\r\n    void (async () => {\r\n      try {\r\n        const sid1 = shopId || getFallbackShopId();\r\n        if (sid1 && selectedMachineId) {\r\n          await addDoc(collection(db, 'shops', sid1, 'machines', selectedMachineId, 'deliveries'), {\r\n            cashierName: cashierName || 'Unknown',\r\n            userId: user?.uid, // إضافة معرف المستخدم للصلاحيات\r\n            openingBase: openingBaseForReceipt,\r\n            openingAir: openingAirForReceipt,\r\n            deliveryBase: dBase,\r\n            deliveryAir: dAir,\r\n            netResult: result,\r\n            createdAt: serverTimestamp(),\r\n          });\r\n          await setDoc(doc(db, 'shops', sid1, 'machines', selectedMachineId), {\r\n            lastDeliveryAt: serverTimestamp(),\r\n            updatedAt: serverTimestamp(),\r\n          }, { merge: true });\r\n\r\n          // تسجيل تسليم الوردية في المعاملات الأخيرة\r\n          if (user?.uid) {\r\n            const selectedMachineName = machines.find(m => m.id === selectedMachineId)?.name || 'ماكينة';\r\n            await userDataService.saveUserTransaction(user.uid, {\r\n              type: 'machine_delivery',\r\n              amount: result,\r\n              senderName: selectedMachineName,\r\n              title: 'تسليم وردية مكنه',\r\n              description: `تسليم وردية مكنه: ${selectedMachineName}`,\r\n              shopId: sid1,\r\n              status: 'completed',\r\n              createdAt: new Date(),\r\n              transactionId: `mdel_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\r\n              reference: `MDL-${Date.now()}`,\r\n              cashierName: cashierName || 'Unknown',\r\n              details: {\r\n                openingBase: openingBaseForReceipt,\r\n                openingAir: openingAirForReceipt,\r\n                deliveryBase: dBase,\r\n                deliveryAir: dAir\r\n              }\r\n            });\r\n          }\r\n\r\n          // تحديث الحالة المحلية فقط بعد نجاح الحفظ في السيرفر\r\n          setReceipts((prev) => [receipt, ...prev]);\r\n          try {\r\n            const sid = shopId || getFallbackShopId();\r\n            const key = sid && selectedMachineId ? `machineDaily_deliveries_${sid}_${selectedMachineId}` : `machineDaily_deliveries_${selectedMachineId}`;\r\n            const current = localStorage.getItem(key);\r\n            const arr = current ? JSON.parse(current) : [];\r\n            const next = [receipt, ...(Array.isArray(arr) ? arr : [])];\r\n            localStorage.setItem(key, JSON.stringify(next));\r\n          } catch {}\r\n\r\n          toast({ title: 'تم إنشاء إيصال تسليم', description: `الناتج النهائي: ${formatNumber(result)}` });\r\n        }\r\n      } catch (err) {\r\n        console.error('Persist delivery error:', err);\r\n        toast({ title: 'خطأ', description: 'حدث خطأ أثناء حفظ التسليم. تأكد من الصلاحيات.', variant: 'destructive' });\r\n      }\r\n    })();\r\n\r\n    // إزالة التحديث المحلي المتفائل (Optimistic Update) من هنا لأنه يسبب \"ظهور ثم اختفاء\" إذا فشل السيرفر\r\n    // سيتم التحديث داخل الـ try block أعلاه\r\n    /*\r\n    setReceipts((prev) => [receipt, ...prev]);\r\n    try {\r\n      const sid = shopId || getFallbackShopId();\r\n      const key = sid && selectedMachineId ? `machineDaily_deliveries_${sid}_${selectedMachineId}` : `machineDaily_deliveries_${selectedMachineId}`;\r\n      const current = localStorage.getItem(key);\r\n      const arr = current ? JSON.parse(current) : [];\r\n      const next = [receipt, ...(Array.isArray(arr) ? arr : [])];\r\n      localStorage.setItem(key, JSON.stringify(next));\r\n    } catch {}\r\n    \r\n    toast({ title: 'تم إنشاء إيصال تسليم', description: `الناتج النهائي: ${formatNumber(result)}` });\r\n    */\r\n  };\r\n\r\n  const handleTransferConfirm = () => {\r\n    const w = parseFloat(wholesalePrice || '0');\r\n    const r = parseFloat(retailPrice || '0');\r\n    if (!Number.isFinite(w) || !Number.isFinite(r)) {\r\n      toast({ title: 'قيمة غير صالحة', description: 'يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.', variant: 'destructive' });\r\n      return;\r\n    }\r\n    if (w < 0 || r < 0) {\r\n      toast({ title: 'قيمة سالبة', description: 'لا يمكن إدخال قيم سالبة.', variant: 'destructive' });\r\n      return;\r\n    }\r\n\r\n    if (savedOpeningBase == null || savedOpeningAir == null) {\r\n      toast({ title: 'سجل الرصيد الافتتاحي أولاً', description: 'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط \"إضافة\".' });\r\n      return;\r\n    }\r\n\r\n    const profit = Math.round((r - w) * 100) / 100;\r\n    setPendingTransfer({ wholesalePrice: w, retailPrice: r, profit });\r\n    setDeductDialogOpen(true);\r\n  };\r\n\r\n  const finalizeTransfer = async (from: 'base' | 'air') => {\r\n    if (isProcessingRef.current) return;\r\n    if (!pendingTransfer) return;\r\n    \r\n    isProcessingRef.current = true;\r\n    setIsProcessing(true);\r\n\r\n    try {\r\n      const nowTs = Date.now();\r\n      const tempId = `temp_mtr_${nowTs}`;\r\n      const referenceId = `MTR-${nowTs}`;\r\n      const receipt: TransferReceipt = {\r\n        id: `transfer_${Date.now()}`,\r\n        wholesalePrice: pendingTransfer.wholesalePrice,\r\n        retailPrice: pendingTransfer.retailPrice,\r\n        profit: pendingTransfer.profit,\r\n        createdAt: new Date().toISOString(),\r\n        cashierName: cashierName || 'Unknown',\r\n        deductFrom: from,\r\n      };\r\n      latestTransferId.current = receipt.id;\r\n\r\n      // تحديث أرصدة الافتتاحي وفلوس الدرج\r\n      const stockDeductAmount = pendingTransfer.wholesalePrice; // خصم من المخزون بسعر الجملة\r\n      const prevBase = savedOpeningBase ?? 0;\r\n      const prevAir = savedOpeningAir ?? 0;\r\n      const prevDrawer = savedDrawerCash ?? 0;\r\n\r\n      // تحقق من كفاية الرصيد قبل الخصم\r\n      const availableStock = from === 'base' ? prevBase : prevAir;\r\n      if (stockDeductAmount > availableStock) {\r\n        toast({ title: 'رصيد غير كافٍ', description: 'لا يوجد رصيد كافٍ للخصم بسعر الجملة.', variant: 'destructive' });\r\n        return;\r\n      }\r\n\r\n      const newBase = from === 'base' ? Math.round((prevBase - stockDeductAmount) * 100) / 100 : prevBase;\r\n      const newAir = from === 'air' ? Math.round((prevAir - stockDeductAmount) * 100) / 100 : prevAir;\r\n      const totalDrawerAdded = pendingTransfer.retailPrice;\r\n      const newDrawer = Math.round((prevDrawer + totalDrawerAdded) * 100) / 100;\r\n\r\n      setSavedOpeningBase(newBase);\r\n      setSavedOpeningAir(newAir);\r\n      setSavedDrawerCash(newDrawer);\r\n      try {\r\n        const keyOpening = selectedMachineId ? `${STORAGE_KEY_OPENING}_${selectedMachineId}` : STORAGE_KEY_OPENING;\r\n        const keySnap = selectedMachineId ? `${STORAGE_KEY_OPENING_SNAPSHOT}_${selectedMachineId}` : STORAGE_KEY_OPENING_SNAPSHOT;\r\n        localStorage.setItem(keyOpening, JSON.stringify({ openingBase: newBase, openingAir: newAir, drawerCash: newDrawer }));\r\n        localStorage.setItem(keySnap, JSON.stringify({ openingBase: newBase, openingAir: newAir, drawerCash: newDrawer }));\r\n        // تحديث الماكينة في Firestore + إضافة إيصال تحويل\r\n        const sid2 = shopId || getFallbackShopId();\r\n        if (sid2 && selectedMachineId) {\r\n          const machineRef = doc(db, 'shops', sid2, 'machines', selectedMachineId);\r\n          await setDoc(machineRef, {\r\n            openingBase: newBase,\r\n            openingAir: newAir,\r\n            drawerCash: newDrawer,\r\n            cashierName: cashierName || 'Unknown',\r\n            updatedAt: serverTimestamp(),\r\n          }, { merge: true });\r\n          await addDoc(collection(db, 'shops', sid2, 'machines', selectedMachineId, 'transfers'), {\r\n            wholesalePrice: pendingTransfer.wholesalePrice,\r\n            retailPrice: pendingTransfer.retailPrice,\r\n            profit: pendingTransfer.profit,\r\n            deductFrom: from,\r\n            cashierName: cashierName || 'Unknown',\r\n            userId: user?.uid, // إضافة معرف المستخدم للصلاحيات\r\n            createdAt: serverTimestamp(),\r\n          });\r\n          \r\n          // تسجيل المعاملة في \"المعاملات الأخيرة\"\r\n          if (user?.uid) {\r\n            const selectedMachineName = machines.find(m => m.id === selectedMachineId)?.name || 'ماكينة';\r\n            const transferAmount = pendingTransfer.retailPrice;\r\n            \r\n            await userDataService.saveUserTransaction(user.uid, {\r\n              type: 'transfer',\r\n              amount: transferAmount,\r\n              senderName: selectedMachineName, // اسم المكنه الي حول منها\r\n              title: 'إيصال تحويل مكينه',\r\n              description: `تحويل مكنه من ${selectedMachineName}`,\r\n              shopId: sid2,\r\n              status: 'completed',\r\n              createdAt: new Date(),\r\n              transactionId: `mtr_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\r\n              reference: referenceId,\r\n              cashierName: cashierName || 'Unknown'\r\n            });\r\n\r\n            // تحديث رصيد الدرج (الفلوس النقدية)\r\n            try {\r\n              // جلب الرصيد الحالي أولاً لتجنب الكتابة فوق تحديثات أخرى\r\n              const userDoc = await userDataService.getUserData(user.uid);\r\n              const currentCash = Number(userDoc?.cashBalance || 0);\r\n              const newCash = currentCash + transferAmount;\r\n              \r\n              await userDataService.updateUserData(user.uid, { cashBalance: newCash });\r\n              \r\n              // تحديث dashboardData أيضاً إذا كان موجوداً\r\n              try {\r\n                if (sid2) {\r\n                   const dashRef = doc(db, 'dashboardData', sid2);\r\n                   const dashSnap = await getDoc(dashRef);\r\n                   if (dashSnap.exists()) {\r\n                     const dashCash = Number(dashSnap.data().cashBalance || 0);\r\n                     await updateDoc(dashRef, { \r\n                       cashBalance: dashCash + transferAmount,\r\n                       lastUpdated: new Date().toISOString()\r\n                     } as any);\r\n                   }\r\n                }\r\n              } catch {}\r\n              \r\n              // تحديث التخزين المحلي\r\n              try {\r\n                localStorage.setItem(`cashBalance_${user.uid}`, String(newCash));\r\n                window.dispatchEvent(new CustomEvent('cashBalanceChanged', { detail: { value: newCash } }));\r\n              } catch {}\r\n              \r\n              // إشعار لوحة المستخدم فورًا بإضافة معاملة جديدة (تفادي الحاجة لتحديث الصفحة)\r\n              try {\r\n                const optimisticTx: any = {\r\n                  id: tempId,\r\n                  type: 'transfer',\r\n                  amount: transferAmount,\r\n                  status: 'completed',\r\n                  createdAt: new Date(),\r\n                  title: 'إيصال تحويل مكينه',\r\n                  description: `تحويل مكنه من ${selectedMachineName}`,\r\n                  reference: referenceId,\r\n                  senderName: selectedMachineName,\r\n                  shopId: sid2,\r\n                  cashierName: cashierName || 'Unknown'\r\n                };\r\n                window.dispatchEvent(new CustomEvent('dashboard:external-update', { detail: { newTransaction: optimisticTx } }));\r\n                window.dispatchEvent(new CustomEvent('transaction-created'));\r\n              } catch {}\r\n              \r\n            } catch (err) {\r\n              console.error('Error updating cash balance for machine transfer:', err);\r\n            }\r\n          }\r\n\r\n          toast({ title: 'تم الحفظ', description: 'تم حفظ التحويل بنجاح وإضافته للدرج' });\r\n          \r\n          setTransferReceipts(prev => [receipt, ...prev]);\r\n          try {\r\n            const sidKey = shopId || getFallbackShopId();\r\n            const key = sidKey && selectedMachineId ? `machineDaily_transfers_${sidKey}_${selectedMachineId}` : 'machineDaily_transfers';\r\n            const current = localStorage.getItem(key);\r\n            const arr = current ? JSON.parse(current) : [];\r\n            const next = [receipt, ...(Array.isArray(arr) ? arr : [])];\r\n            localStorage.setItem(key, JSON.stringify(next));\r\n          } catch {}\r\n          setTransferDialogOpen(false);\r\n          setWholesalePrice('');\r\n          setRetailPrice('');\r\n          setPendingTransfer(null);\r\n          setDeductDialogOpen(false);\r\n          toast({ title: 'تم تسجيل تحويل', description: `الربح الفوري: ${formatNumber(receipt.profit)} | خصم المخزون: -${formatNumber(stockDeductAmount)} (${from === 'base' ? 'الأساسي' : 'الهواء'}) | درج (المباع فقط): +${formatNumber(totalDrawerAdded)}` });\r\n\r\n        } else {\r\n          console.error(\"Missing shopId or selectedMachineId\", { sid2, selectedMachineId });\r\n          toast({ title: 'تنبيه', description: 'قد لا يتم حفظ البيانات في السيرفر لعدم توفر معرف المحل أو الماكينة', variant: 'destructive' });\r\n        }\r\n      } catch (error) {\r\n        console.error(\"Error finalizing transfer:\", error);\r\n        toast({ title: 'خطأ', description: 'حدث خطأ أثناء حفظ التحويل في قاعدة البيانات', variant: 'destructive' });\r\n      }\r\n    } finally {\r\n      isProcessingRef.current = false;\r\n      setIsProcessing(false);\r\n    }\r\n  };\r\n\r\n  const resetDialogState = () => {\r\n    setOpeningBase('');\r\n    setOpeningAir('');\r\n    setDeliveryBase('');\r\n    setDeliveryAir('');\r\n    setNetResult(null);\r\n  };\r\n\r\n\r\n  const refreshMachineData = async () => {\r\n    if (!open || !selectedMachineId) return;\r\n    const sid = shopId || getFallbackShopId();\r\n    if (!sid) return;\r\n\r\n    // Fetch Deliveries\r\n    try {\r\n      const col = collection(db, 'shops', sid, 'machines', selectedMachineId, 'deliveries');\r\n      console.log(`Fetching deliveries from: shops/${sid}/machines/${selectedMachineId}/deliveries`);\r\n      const snap = await getDocs(query(col));\r\n      console.log(`Found ${snap.docs.length} delivery documents`);\r\n      const list: MachineReceipt[] = snap.docs.map((d) => {\r\n        const x: any = d.data();\r\n        const created = x?.createdAt?.toDate?.() ? x.createdAt.toDate() : new Date();\r\n        return {\r\n          id: d.id,\r\n          openingBase: Number(x?.openingBase || 0),\r\n          openingAir: Number(x?.openingAir || 0),\r\n          deliveryBase: Number(x?.deliveryBase || 0),\r\n          deliveryAir: Number(x?.deliveryAir || 0),\r\n          netResult: typeof x?.netResult === 'number'\r\n            ? Number(x.netResult)\r\n            : Math.round(((Number(x?.deliveryBase || 0) + Number(x?.deliveryAir || 0)) - (Number(x?.openingBase || 0) + Number(x?.openingAir || 0))) * 100) / 100,\r\n          createdAt: created.toISOString(),\r\n          cashierName: x?.cashierName || undefined,\r\n          requiredDrawerNoProfit: typeof x?.requiredDrawerNoProfit === 'number' ? x.requiredDrawerNoProfit : undefined,\r\n        } as MachineReceipt;\r\n      });\r\n      const sorted = [...list].sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\r\n\r\n      // دمج الإيصال الأخير إذا لم يكن موجوداً في القائمة القادمة من السيرفر (بسبب تأخر الفهرسة)\r\n      setReceipts(prev => {\r\n        // إذا كان لدينا إيصال تم إنشاؤه محلياً مؤخراً\r\n        if (latestDeliveryId.current) {\r\n          const inServer = sorted.find(r => r.id === latestDeliveryId.current);\r\n          if (!inServer) {\r\n            // نبحث عنه في الحالة الحالية\r\n            const local = prev.find(r => r.id === latestDeliveryId.current);\r\n            if (local) {\r\n              // نضيفه للقائمة الجديدة\r\n              const merged = [local, ...sorted].sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\r\n              // إزالة التكرار إن وجد\r\n              const unique = merged.filter((item, index, self) => index === self.findIndex((t) => (t.id === item.id)));\r\n              return unique;\r\n            }\r\n          }\r\n        }\r\n        return sorted;\r\n      });\r\n\r\n      try { localStorage.setItem(`machineDaily_deliveries_${sid}_${selectedMachineId}`, JSON.stringify(sorted)); } catch {}\r\n    } catch (e) {\r\n      console.error('Error fetching deliveries:', e);\r\n    }\r\n\r\n    // Fetch Transfers\r\n    try {\r\n      const col = collection(db, 'shops', sid, 'machines', selectedMachineId, 'transfers');\r\n      console.log(`Fetching transfers from: shops/${sid}/machines/${selectedMachineId}/transfers`);\r\n      const snap = await getDocs(query(col));\r\n      console.log(`Found ${snap.docs.length} transfer documents`);\r\n      const list: TransferReceipt[] = snap.docs.map((d) => {\r\n        const x: any = d.data();\r\n        const created = x?.createdAt?.toDate?.() ? x.createdAt.toDate() : new Date();\r\n        const ded: any = x?.deductFrom;\r\n        return {\r\n          id: d.id,\r\n          wholesalePrice: Number(x?.wholesalePrice || 0),\r\n          retailPrice: Number(x?.retailPrice || 0),\r\n          profit: Number(x?.profit ?? ((Number(x?.retailPrice || 0) - Number(x?.wholesalePrice || 0)) || 0)),\r\n          createdAt: created.toISOString(),\r\n          cashierName: x?.cashierName || undefined,\r\n          deductFrom: ded === 'base' || ded === 'air' ? ded : undefined,\r\n        } as TransferReceipt;\r\n      });\r\n      const sorted = [...list].sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\r\n      \r\n      // دمج الإيصال الأخير إذا لم يكن موجوداً في القائمة القادمة من السيرفر\r\n      setTransferReceipts(prev => {\r\n        if (latestTransferId.current) {\r\n          const inServer = sorted.find(r => r.id === latestTransferId.current);\r\n          if (!inServer) {\r\n            const local = prev.find(r => r.id === latestTransferId.current);\r\n            if (local) {\r\n              const merged = [local, ...sorted].sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\r\n              const unique = merged.filter((item, index, self) => index === self.findIndex((t) => (t.id === item.id)));\r\n              return unique;\r\n            }\r\n          }\r\n        }\r\n        return sorted;\r\n      });\r\n\r\n      try { localStorage.setItem(`machineDaily_transfers_${sid}_${selectedMachineId}`, JSON.stringify(sorted)); } catch {}\r\n    } catch (e) {\r\n      console.error('Error fetching transfers:', e);\r\n      toast({ title: 'خطأ', description: 'فشل في جلب التحويلات من السيرفر', variant: 'destructive' });\r\n    }\r\n    \r\n    toast({ title: 'تم التحديث', description: 'تم جلب أحدث البيانات.' });\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (!open || !selectedMachineId) return;\r\n    const sid = shopId || getFallbackShopId();\r\n    // Load from cache first\r\n    try {\r\n      const keyDel = sid ? `machineDaily_deliveries_${sid}_${selectedMachineId}` : `machineDaily_deliveries_${selectedMachineId}`;\r\n      const cachedDel = localStorage.getItem(keyDel);\r\n      if (cachedDel) {\r\n        const parsed = JSON.parse(cachedDel);\r\n        if (Array.isArray(parsed)) setReceipts(parsed);\r\n      }\r\n      \r\n      const keyTrans = sid ? `machineDaily_transfers_${sid}_${selectedMachineId}` : `machineDaily_transfers_${selectedMachineId}`;\r\n      const cachedTrans = localStorage.getItem(keyTrans);\r\n      if (cachedTrans) {\r\n        const parsed = JSON.parse(cachedTrans);\r\n        if (Array.isArray(parsed)) setTransferReceipts(parsed);\r\n      }\r\n    } catch {}\r\n\r\n    // Initial Fetch\r\n    refreshMachineData();\r\n  }, [open, shopId, selectedMachineId]);\r\n\r\n\r\n  // جلب مسحوبات الشهر الحالي واليومي\r\n  const fetchMonthlyWithdrawals = async () => {\r\n    if (!selectedMachineId || !shopId) return;\r\n    try {\r\n      const now = new Date();\r\n      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\r\n      const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // 12:00 AM today\r\n      \r\n      const col = collection(db, 'shops', shopId, 'machines', selectedMachineId, 'withdrawals');\r\n      const q = query(col, orderBy('createdAt', 'desc'));\r\n      const snap = await getDocs(q);\r\n      \r\n      const list = snap.docs.map(doc => {\r\n        const d = doc.data();\r\n        return { \r\n            id: doc.id, \r\n            ...d,\r\n            createdAt: d.createdAt?.toDate ? d.createdAt.toDate() : new Date(d.createdAt)\r\n        };\r\n      });\r\n      setWithdrawalReceipts(list);\r\n\r\n      let mSum = 0;\r\n      let dSum = 0;\r\n      let mProfit = 0;\r\n      let dProfit = 0;\r\n\r\n      list.forEach((item) => {\r\n        const created = item.createdAt;\r\n        const amount = Number(item.amount) || 0;\r\n        const profit = Number(item.commission) || 0;\r\n        \r\n        if (created >= startOfMonth) {\r\n          mSum += amount;\r\n          mProfit += profit;\r\n        }\r\n        if (created >= startOfDay) {\r\n          dSum += amount;\r\n          dProfit += profit;\r\n        }\r\n      });\r\n      \r\n      setMonthlyWithdrawalsUsed(mSum);\r\n      setDailyWithdrawalsUsed(dSum);\r\n      setMonthlyWithdrawalsProfit(mProfit);\r\n      setDailyWithdrawalsProfit(dProfit);\r\n    } catch (err) {\r\n      console.error('Error fetching monthly withdrawals:', err);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    if ((activeSection === 'cashWithdrawal' || activeSection === 'withdrawalReceipts') && selectedMachineId) {\r\n      fetchMonthlyWithdrawals();\r\n    }\r\n  }, [activeSection, selectedMachineId, shopId]);\r\n\r\n  const handleDeleteWithdrawalReceipt = async (id: string) => {\r\n    if (!selectedMachineId || !shopId) return;\r\n    try {\r\n        const docRef = doc(db, 'shops', shopId, 'machines', selectedMachineId, 'withdrawals', id);\r\n        // التحقق مما إذا كان قد تم الخصم من الدرج لاسترجاع المبلغ\r\n        const { getDoc } = await import('firebase/firestore');\r\n        const snap = await getDoc(docRef);\r\n        \r\n        if (snap.exists()) {\r\n           const data = snap.data();\r\n           if (data.deductedFromDrawer && data.userId && data.amount) {\r\n              // استرجاع المبلغ للدرج\r\n              const userDoc = await userDataService.getUserData(data.userId);\r\n              const currentCash = Number(userDoc?.cashBalance || 0);\r\n              const newCash = currentCash + Number(data.amount);\r\n              \r\n              await userDataService.updateUserData(data.userId, { cashBalance: newCash });\r\n              try {\r\n                  const { updateDoc } = await import('firebase/firestore');\r\n                  const shopDocRef = doc(db, 'dashboardData', shopId);\r\n                  await updateDoc(shopDocRef, { cashBalance: newCash } as any);\r\n              } catch (e) { console.error('Error updating shop cash balance:', e); }\r\n           }\r\n        }\r\n\r\n        await deleteDoc(docRef);\r\n        toast({ title: 'تم الحذف', description: 'تم حذف إيصال السحب' });\r\n        fetchMonthlyWithdrawals();\r\n    } catch (err) {\r\n        console.error('Delete withdrawal error:', err);\r\n        toast({ title: 'خطأ', description: 'فشل الحذف', variant: 'destructive' });\r\n    }\r\n  };\r\n\r\n  const handleCashWithdrawal = async () => {\r\n    if (isProcessingRef.current) return;\r\n    isProcessingRef.current = true;\r\n    setIsProcessing(true);\r\n\r\n    try {\r\n      const amount = parseFloat(withdrawalAmount);\r\n      \r\n      if (isNaN(amount) || amount <= 0) {\r\n        toast({ title: 'خطأ', description: 'يرجى إدخال مبلغ صحيح', variant: 'destructive' });\r\n        return;\r\n      }\r\n      \r\n      let commission = 0;\r\n      let rateUsed = 0;\r\n  \r\n      if (commissionMode === 'rate') {\r\n          const rate = parseFloat(commissionRate);\r\n          if (isNaN(rate) || rate < 0) {\r\n            toast({ title: 'خطأ', description: 'يرجى إدخال عمولة صحيحة', variant: 'destructive' });\r\n            return;\r\n          }\r\n          commission = (amount / 1000) * rate;\r\n          rateUsed = rate;\r\n      } else {\r\n          const fixed = parseFloat(fixedCommissionAmount);\r\n          if (isNaN(fixed) || fixed < 0) {\r\n              toast({ title: 'خطأ', description: 'يرجى إدخال مبلغ عمولة صحيح', variant: 'destructive' });\r\n              return;\r\n          }\r\n          commission = fixed;\r\n      }\r\n  \r\n      if (!selectedMachineId || !shopId) {\r\n        toast({ title: 'خطأ', description: 'بيانات المحل أو الماكينة غير متوفرة', variant: 'destructive' });\r\n        return;\r\n      }\r\n  \r\n      let updatedCashBalance: number | null = null;\r\n  \r\n      try {\r\n        // خصم من درج النقدية إذا تم اختياره\r\n        if (deductFromDrawer && user?.uid) {\r\n           const userDoc = await userDataService.getUserData(user.uid);\r\n           const currentCash = Number(userDoc?.cashBalance || 0);\r\n           const newCash = currentCash - amount;\r\n           updatedCashBalance = newCash;\r\n           \r\n           await userDataService.updateUserData(user.uid, { cashBalance: newCash });\r\n           try {\r\n               const { updateDoc } = await import('firebase/firestore');\r\n               const shopDocRef = doc(db, 'dashboardData', shopId);\r\n               await updateDoc(shopDocRef, { cashBalance: newCash } as any);\r\n           } catch (e) { console.error('Error updating shop cash balance:', e); }\r\n        }\r\n  \r\n        // حفظ المعاملة\r\n        await addDoc(collection(db, 'shops', shopId, 'machines', selectedMachineId, 'withdrawals'), {\r\n          amount,\r\n          commissionMode, \r\n          commissionRate: commissionMode === 'rate' ? rateUsed : 0,\r\n          fixedCommission: commissionMode === 'fixed' ? commission : 0,\r\n          commission,\r\n          createdAt: serverTimestamp(),\r\n          userId: user?.uid,\r\n          cashierName: cashierName || 'Unknown',\r\n          deductedFromDrawer: deductFromDrawer\r\n        });\r\n  \r\n        // تسجيل المعاملة في لوحة المستخدم\r\n        if (user?.uid) {\r\n          try {\r\n              const selectedMachineName = machines.find(m => m.id === selectedMachineId)?.name || 'ماكينة';\r\n              const txData = {\r\n                  type: 'machine_withdrawal',\r\n                  amount: amount,\r\n                  commission: commission,\r\n                  senderName: selectedMachineName,\r\n                  title: 'إيصال سحب فوري',\r\n                  description: `سحب كاش بقيمة ${formatNumber(amount)} وعمولة ${formatNumber(commission)}${deductFromDrawer ? ' (تم الخصم من الدرج)' : ''}`,\r\n                  shopId: shopId,\r\n                  status: 'completed',\r\n                  createdAt: new Date(),\r\n                  transactionId: `mwd_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\r\n                  reference: `MWD-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,\r\n                  cashierName: cashierName || 'Unknown'\r\n              };\r\n\r\n              const docId = await userDataService.saveUserTransaction(user.uid, txData);\r\n\r\n              // تحديث كائن المعاملة بالمعرف الحقيقي من Firestore\r\n              const finalTxData = { ...txData, id: docId };\r\n  \r\n              // إضافة الربح للتقارير\r\n              // if (commission > 0) {\r\n              //    ProfitService.addProfit(commission, user.uid);\r\n              // }\r\n  \r\n              // Dispatch events for real-time updates\r\n              try {\r\n                window.dispatchEvent(new CustomEvent('dashboard:external-update', { detail: { newTransaction: finalTxData } }));\r\n                window.dispatchEvent(new CustomEvent('transaction-created'));\r\n                // window.dispatchEvent(new CustomEvent('newTransactionAdded', { detail: { transaction: finalTxData } }));\r\n  \r\n                if (updatedCashBalance !== null) {\r\n                   window.dispatchEvent(new CustomEvent('cashBalanceChanged', { detail: { value: updatedCashBalance } }));\r\n                }\r\n              } catch (e) { console.error('Error dispatching events:', e); }\r\n  \r\n          } catch (txError) {\r\n              console.error('Failed to save user transaction log:', txError);\r\n          }\r\n        }\r\n  \r\n        toast({ title: 'تم السحب', description: `تم سحب ${formatNumber(amount)} وعمولة ${formatNumber(commission)}` });\r\n        setWithdrawalAmount('');\r\n        fetchMonthlyWithdrawals(); \r\n        \r\n      } catch (err) {\r\n        console.error('Withdrawal error:', err);\r\n        toast({ title: 'خطأ', description: 'فشل في تنفيذ السحب', variant: 'destructive' });\r\n      }\r\n    } finally {\r\n        isProcessingRef.current = false;\r\n        setIsProcessing(false);\r\n    }\r\n  };\r\n\r\n  const handleClose = (nextOpen: boolean) => {\r\n    if (!nextOpen) {\r\n      // عند الغلق، لا نمسح القيم المسجلة حتى لا يفقد المستخدم الافتتاحي\r\n      resetDialogState();\r\n    }\r\n    onOpenChange(nextOpen);\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={handleClose}>\r\n      <DialogContent className=\"w-screen h-[100vh] overflow-hidden rounded-none p-0 flex flex-col dark:bg-[#121212]\">\r\n        <DialogHeader className=\"sticky top-0 bg-white dark:bg-[#0F0F0F] z-20 border-b border-gray-200 dark:border-[#333] px-4 py-3\">\r\n          <DialogTitle className=\"flex items-center justify-between text-right\">\r\n            <span className=\"flex items-center gap-2\">\r\n              <FawryMachineIcon className=\"h-5 w-5 text-yellow-500\" />\r\n              يومية المكنة {selectedMachineId && machines.find(m => m.id === selectedMachineId)?.name ? `- ${machines.find(m => m.id === selectedMachineId)?.name}` : ''}\r\n            </span>\r\n            <div className=\"flex items-center gap-1\">\r\n              <Button variant=\"ghost\" onClick={() => setIsVideoModalOpen(true)} title=\"شرح فيديو\" className=\"gap-1 px-2 text-rose-600 hover:text-rose-700 hover:bg-rose-50\">\r\n                <PlayCircle className=\"h-5 w-5\" />\r\n                <span className=\"font-medium\">شرح قسم المكن فديو</span>\r\n              </Button>\r\n              <Button variant=\"ghost\" size=\"icon\" onClick={refreshMachineData} title=\"تحديث البيانات\">\r\n                <RefreshCcw className=\"h-4 w-4\" />\r\n              </Button>\r\n            </div>\r\n          </DialogTitle>\r\n          <DialogDescription className=\"text-right\">\r\n            أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم \"إيصالات ماكينة\".\r\n          </DialogDescription>\r\n          <div className=\"mt-2 grid grid-cols-2 sm:flex sm:flex-wrap sm:justify-end gap-2\">\r\n            <Button\r\n              size=\"sm\"\r\n              variant=\"outline\"\r\n              className={`w-full sm:w-auto ${activeSection === 'machines' ? 'bg-violet-600 text-white hover:bg-violet-700' : 'border-violet-300 text-violet-700'}`}\r\n              onClick={() => setActiveSection('machines')}\r\n            >\r\n              الماكينات\r\n            </Button>\r\n            <Button\r\n              size=\"sm\"\r\n              variant=\"outline\"\r\n              className={`w-full sm:w-auto ${activeSection === 'cashWithdrawal' ? 'bg-violet-600 text-white hover:bg-violet-700' : 'border-violet-300 text-violet-700'}`}\r\n              onClick={() => setActiveSection('cashWithdrawal')}\r\n            >\r\n              سحب كاش\r\n            </Button>\r\n            <Button\r\n              size=\"sm\"\r\n              variant=\"outline\"\r\n              className={`w-full sm:w-auto ${activeSection === 'withdrawalReceipts' ? 'bg-violet-600 text-white hover:bg-violet-700' : 'border-violet-300 text-violet-700'}`}\r\n              onClick={() => setActiveSection('withdrawalReceipts')}\r\n            >\r\n              إيصالات سحب مكنة\r\n            </Button>\r\n            <Button\r\n              size=\"sm\"\r\n              variant=\"outline\"\r\n              className={`w-full sm:w-auto ${activeSection === 'opening' ? 'bg-violet-600 text-white hover:bg-violet-700' : 'border-violet-300 text-violet-700'}`}\r\n              onClick={() => setActiveSection('opening')}\r\n            >\r\n              الرصيد الافتتاحي\r\n            </Button>\r\n            <Button\r\n              size=\"sm\"\r\n              variant=\"outline\"\r\n              className={`w-full sm:w-auto ${activeSection === 'transfer' ? 'bg-violet-600 text-white hover:bg-violet-700' : 'border-violet-300 text-violet-700'}`}\r\n              onClick={() => setActiveSection('transfer')}\r\n            >\r\n              التحويل\r\n            </Button>\r\n            <Button\r\n              size=\"sm\"\r\n              variant=\"outline\"\r\n              className={`w-full sm:w-auto ${activeSection === 'transferReceipts' ? 'bg-violet-600 text-white hover:bg-violet-700' : 'border-violet-300 text-violet-700'}`}\r\n              onClick={() => setActiveSection('transferReceipts')}\r\n            >\r\n              إيصالات التحويل\r\n            </Button>\r\n            <Button\r\n              size=\"sm\"\r\n              variant=\"outline\"\r\n              className={`w-full sm:w-auto ${activeSection === 'delivery' ? 'bg-violet-600 text-white hover:bg-violet-700' : 'border-violet-300 text-violet-700'}`}\r\n              onClick={() => setActiveSection('delivery')}\r\n            >\r\n              تسليم الوردية\r\n            </Button>\r\n            <Button\r\n              size=\"sm\"\r\n              variant=\"outline\"\r\n              className={`w-full sm:w-auto col-span-2 sm:col-auto ${activeSection === 'deliveryReceipts' ? 'bg-violet-600 text-white hover:bg-violet-700' : 'border-violet-300 text-violet-700'}`}\r\n              onClick={() => setActiveSection('deliveryReceipts')}\r\n            >\r\n              إيصالات التسليم\r\n            </Button>\r\n          </div>\r\n        </DialogHeader>\r\n\r\n        <div className=\"px-4 py-3 overflow-y-auto flex-1 grid grid-cols-1 gap-6\">\r\n          {/* إدارة الماكينات */}\r\n          {activeSection === 'machines' && (\r\n          <Card>\r\n            <CardHeader className=\"pb-2\">\r\n          <CardTitle className=\"flex items-center justify-between\">\r\n            <span className=\"text-right\">إدارة الماكينات</span>\r\n            <div className=\"flex items-center gap-2\">\r\n              <Button\r\n                variant=\"destructive\"\r\n                onClick={async () => {\r\n                  try {\r\n                    if (!shopId || !selectedMachineId) return;\r\n                    const baseRef = doc(db, 'shops', shopId, 'machines', selectedMachineId);\r\n                    try {\r\n                      const transSnap = await getDocs(collection(db, 'shops', shopId, 'machines', selectedMachineId, 'transfers'));\r\n                      await Promise.all(transSnap.docs.map(d => deleteDoc(d.ref)));\r\n                    } catch {}\r\n                    try {\r\n                      const delSnap = await getDocs(collection(db, 'shops', shopId, 'machines', selectedMachineId, 'deliveries'));\r\n                      await Promise.all(delSnap.docs.map(d => deleteDoc(d.ref)));\r\n                    } catch {}\r\n                    await deleteDoc(baseRef);\r\n                    setMachines(prev => prev.filter(m => m.id !== selectedMachineId));\r\n                    const next = machines.find(m => m.id !== selectedMachineId);\r\n                    setSelectedMachineId(next ? next.id : null);\r\n                    try {\r\n                      const keyOpening = `${STORAGE_KEY_OPENING}_${selectedMachineId}`;\r\n                      const keySnap = `${STORAGE_KEY_OPENING_SNAPSHOT}_${selectedMachineId}`;\r\n                      localStorage.removeItem(keyOpening);\r\n                      localStorage.removeItem(keySnap);\r\n                    } catch {}\r\n                    toast({ title: 'تم حذف الماكينة', description: 'تمت الإزالة نهائيًا.' });\r\n                  } catch (err) {\r\n                    toast({ title: 'فشل الحذف', description: 'تعذر حذف الماكينة.' , variant: 'destructive' });\r\n                  }\r\n                }}\r\n                disabled={!selectedMachineId}\r\n                title=\"حذف الماكينة\"\r\n              >\r\n                <Trash2 className=\"h-4 w-4\" />\r\n              </Button>\r\n            </div>\r\n          </CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-3\">\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 items-end\">\r\n                <div>\r\n                  <label className=\"text-sm font-medium block text-right\">الماكينة الحالية</label>\r\n                  <Select value={selectedMachineId ?? ''} onValueChange={(v) => { setSelectedMachineId(v); try { const sidSel = shopId || getFallbackShopId(); if (sidSel) localStorage.setItem(`machineDaily_selected_${sidSel}`, v); } catch {} }}>\r\n                    <SelectTrigger className=\"text-right\">\r\n                      <SelectValue placeholder=\"اختر ماكينة\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      {machines.map(m => (\r\n                        <SelectItem key={m.id} value={m.id}>{m.name}</SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-2\">\r\n                  <div className=\"md:col-span-2\">\r\n                    <label className=\"text-sm font-medium block text-right\">إنشاء ماكينة جديدة</label>\r\n                    <Input value={newMachineName} onChange={(e) => setNewMachineName(e.target.value)} placeholder=\"اسم الماكينة\" className=\"text-right\" />\r\n                  </div>\r\n                  <div className=\"flex justify-end md:justify-start\">\r\n                    <Button\r\n                      onClick={async () => {\r\n                        try {\r\n                          if (!shopId) {\r\n                            toast({ title: 'لا يوجد محل', description: 'يرجى التأكد من تحميل بيانات المحل.', variant: 'destructive' });\r\n                            return;\r\n                          }\r\n                          const name = (newMachineName || '').trim();\r\n                          if (!name) {\r\n                            toast({ title: 'اسم الماكينة مطلوب', description: 'أدخل اسم للماكينة الجديدة.', variant: 'destructive' });\r\n                            return;\r\n                          }\r\n                          const ref = await addDoc(collection(db, 'shops', shopId, 'machines'), {\r\n                            name,\r\n                            shopId,\r\n                            createdAt: serverTimestamp(),\r\n                            updatedAt: serverTimestamp(),\r\n                            isActive: true,\r\n                          });\r\n                          const created = { id: ref.id, name };\r\n                          setMachines(prev => [created, ...prev]);\r\n                          setSelectedMachineId(ref.id);\r\n                          setNewMachineName('');\r\n                          toast({ title: 'تم إنشاء ماكينة', description: `تمت إضافة ${name}` });\r\n                        } catch (err) {\r\n                          console.error('Create machine error:', err);\r\n                          toast({ title: 'خطأ في الإنشاء', description: 'تعذر إنشاء الماكينة.', variant: 'destructive' });\r\n                        }\r\n                      }}\r\n                      className=\"bg-violet-600 hover:bg-violet-700\"\r\n                    >\r\n                      إضافة\r\n                    </Button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n          )}\r\n          {activeSection === 'opening' && (\r\n          <Card>\r\n            <CardHeader className=\"pb-2\">\r\n              <CardTitle className=\"flex items-center justify-between\">\r\n                <span className=\"text-right\">الرصيد الافتتاحي</span>\r\n              </CardTitle>\r\n            </CardHeader>\r\n            {/* شارة التسجيل */}\r\n            <div className=\"flex items-center justify-between px-6\">\r\n              {savedOpeningBase != null && savedOpeningAir != null && (\r\n                <Badge className=\"bg-violet-100 text-violet-700 border border-violet-200\">\r\n                  تم التسجيل: أساسي {formatNumber(savedOpeningBase)} | هواء {formatNumber(savedOpeningAir)} | درج {formatNumber(savedDrawerCash ?? 0)}\r\n                </Badge>\r\n              )}\r\n            </div>\r\n            <CardContent className=\"space-y-4\">\r\n              {/* Machine Selection Dropdown */}\r\n              <div className=\"space-y-1\">\r\n                <label className=\"text-sm font-medium block text-right\">اختيار الماكينة</label>\r\n                <Select value={selectedMachineId || ''} onValueChange={setSelectedMachineId}>\r\n                  <SelectTrigger className=\"w-full text-right flex-row-reverse\" dir=\"rtl\">\r\n                    <SelectValue placeholder=\"اختر الماكينة\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent dir=\"rtl\">\r\n                    {machines.map((m) => (\r\n                      <SelectItem key={m.id} value={m.id} className=\"text-right cursor-pointer justify-end\">\r\n                        {m.name}\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                <div className=\"space-y-1\">\r\n                  <label className=\"text-sm font-medium block text-right\">الرصيد الأساسي</label>\r\n                  <Input\r\n                    inputMode=\"decimal\"\r\n                    type=\"number\"\r\n                    min={0}\r\n                    step=\"0.01\"\r\n                    value={openingBase}\r\n                    onChange={(e) => setOpeningBase(e.target.value)}\r\n                    placeholder=\"0.00\"\r\n                    className=\"text-right\"\r\n                  />\r\n                </div>\r\n                <div className=\"space-y-1\">\r\n                  <label className=\"text-sm font-medium block text-right\">رصيد الهواء</label>\r\n                  <Input\r\n                    inputMode=\"decimal\"\r\n                    type=\"number\"\r\n                    min={0}\r\n                    step=\"0.01\"\r\n                    value={openingAir}\r\n                    onChange={(e) => setOpeningAir(e.target.value)}\r\n                    placeholder=\"0.00\"\r\n                    className=\"text-right\"\r\n                  />\r\n                </div>\r\n                <div className=\"space-y-1\">\r\n                  <label className=\"text-sm font-medium block text-right\">فلوس الدرج</label>\r\n                  <Input\r\n                    inputMode=\"decimal\"\r\n                    type=\"number\"\r\n                    min={0}\r\n                    step=\"0.01\"\r\n                    value={drawerCash}\r\n                    onChange={(e) => setDrawerCash(e.target.value)}\r\n                    placeholder=\"0.00\"\r\n                    className=\"text-right\"\r\n                  />\r\n                </div>\r\n              </div>\r\n              <div className=\"flex items-center justify-end\">\r\n                <Button variant=\"outline\" className=\"mr-2\" onClick={handleResetOpening}>\r\n                  تصفير\r\n                </Button>\r\n                <Button onClick={handleAddOpening} className=\"bg-violet-600 hover:bg-violet-700\">\r\n                  إضافة\r\n                </Button>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n          )}\r\n          {activeSection === 'transfer' && (\r\n          <Card>\r\n            <CardHeader className=\"pb-2\">\r\n              <CardTitle className=\"flex items-center justify-between\">\r\n                <span className=\"text-right\">التحويل</span>\r\n              </CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-3\">\r\n              <div>\r\n                <label className=\"text-sm font-medium block text-right\">سعر الجملة</label>\r\n                <Input\r\n                  inputMode=\"decimal\"\r\n                  type=\"number\"\r\n                  min={0}\r\n                  step=\"0.01\"\r\n                  value={wholesalePrice}\r\n                  onChange={(e) => setWholesalePrice(e.target.value)}\r\n                  placeholder=\"0.00\"\r\n                  className=\"text-right\"\r\n                />\r\n              </div>\r\n              <div>\r\n                <label className=\"text-sm font-medium block text-right\">سعر التجزئة</label>\r\n                <Input\r\n                  inputMode=\"decimal\"\r\n                  type=\"number\"\r\n                  min={0}\r\n                  step=\"0.01\"\r\n                  value={retailPrice}\r\n                  onChange={(e) => setRetailPrice(e.target.value)}\r\n                  placeholder=\"0.00\"\r\n                  className=\"text-right\"\r\n                />\r\n              </div>\r\n              <div className=\"flex items-center justify-between\">\r\n                <Badge className=\"bg-green-100 text-green-700 border border-green-200\">\r\n                  الربح الفوري: {formatNumber((parseFloat(retailPrice || '0') - parseFloat(wholesalePrice || '0')) || 0)}\r\n                </Badge>\r\n                <Button onClick={handleTransferConfirm} disabled={savedOpeningBase == null || savedOpeningAir == null} className=\"bg-violet-600 hover:bg-violet-700\">\r\n                  تحويل\r\n                </Button>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n          )}\r\n          {activeSection === 'transferReceipts' && (\r\n          <Card>\r\n            <CardHeader className=\"pb-2\">\r\n              <CardTitle className=\"flex items-center justify-between\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <span className=\"text-right\">إيصالات التحويل</span>\r\n                  <Badge className=\"bg-green-100 text-green-700 border border-green-200\">ربح: {formatNumber(totalTransferProfit)}</Badge>\r\n                </div>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <Button variant=\"outline\" size=\"sm\" onClick={handleClearTransferReceipts} className=\"border-red-300 text-red-700 hover:bg-red-50\">حذف الإيصالات</Button>\r\n                </div>\r\n              </CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-3\">\r\n              {transferReceipts.length === 0 ? (\r\n                <p className=\"text-sm text-gray-500 text-right\">لا توجد تحويلات مسجلة.</p>\r\n              ) : (\r\n                <div className=\"space-y-2 max-h-64 overflow-y-auto pr-1\">\r\n                  {transferReceipts.map((t) => (\r\n                    <div key={t.id} className=\"flex items-center justify-between p-3 rounded-lg border border-gray-100 bg-white dark:bg-gray-800 dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow\">\r\n                      {/* Right: Prices */}\r\n                      <div className=\"flex items-center gap-4 sm:gap-6\">\r\n                        <div className=\"text-center min-w-[3rem]\">\r\n                          <span className=\"block text-[10px] text-gray-500 mb-0.5\">جملة</span>\r\n                          <span className=\"block text-sm font-bold text-gray-900 dark:text-gray-100\">{formatNumber(t.wholesalePrice)}</span>\r\n                        </div>\r\n                        <div className=\"h-8 w-px bg-gray-100 dark:bg-gray-700\"></div>\r\n                        <div className=\"text-center min-w-[3rem]\">\r\n                          <span className=\"block text-[10px] text-gray-500 mb-0.5\">تجزئة</span>\r\n                          <span className=\"block text-sm font-bold text-gray-900 dark:text-gray-100\">{formatNumber(t.retailPrice)}</span>\r\n                        </div>\r\n                        <div className=\"h-8 w-px bg-gray-100 dark:bg-gray-700\"></div>\r\n                        <div className=\"text-center min-w-[3rem]\">\r\n                          <span className=\"block text-[10px] text-gray-500 mb-0.5\">ربح</span>\r\n                          <span className=\"block text-sm font-bold text-green-600\">{formatNumber(t.profit)}</span>\r\n                        </div>\r\n                      </div>\r\n\r\n                      <div className=\"flex items-center gap-3\">\r\n                        <Button\r\n                          variant=\"ghost\"\r\n                          size=\"icon\"\r\n                          className=\"h-7 w-7 text-red-400 hover:text-red-600 hover:bg-red-50\"\r\n                          onClick={() => handleDeleteTransferReceipt(t)}\r\n                          title=\"حذف واسترجاع الرصيد\"\r\n                        >\r\n                          <Trash2 className=\"h-4 w-4\" />\r\n                        </Button>\r\n\r\n                        {/* Left: Info */}\r\n                        <div className=\"flex flex-col items-end gap-1.5\">\r\n                          {t.deductFrom && (\r\n                            <span className={`text-[10px] px-2 py-0.5 rounded-full border ${\r\n                              t.deductFrom === 'base' \r\n                                ? 'bg-blue-50 text-blue-700 border-blue-100' \r\n                               : 'bg-amber-50 text-amber-700 border-amber-100'\r\n                            }`}>\r\n                              {t.deductFrom === 'base' ? 'من الأساسي' : 'من الهواء'}\r\n                            </span>\r\n                          )}\r\n                          <div className=\"flex items-center gap-2 text-[10px] text-gray-400\">\r\n                            <span>{formatDateTime(t.createdAt)}</span>\r\n                            {t.cashierName && (\r\n                              <>\r\n                                <Separator orientation=\"vertical\" className=\"h-3\" />\r\n                                <span title={t.cashierName}>{t.cashierName.split(' ')[0]}</span>\r\n                              </>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n          )}\r\n          {activeSection === 'cashWithdrawal' && (\r\n          <Card>\r\n            <CardHeader className=\"pb-2\">\r\n              <CardTitle className=\"text-right\">سحب كاش</CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n              {/* احصائيات السحب */}\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                 <div className=\"bg-blue-50 p-3 rounded border border-blue-100 flex flex-col justify-between\">\r\n                    <div className=\"space-y-1\">\r\n                        <span className=\"text-xs text-blue-600 block\">سحب اليوم (يصفر 12 ليلاً)</span>\r\n                        <span className=\"text-lg font-bold text-blue-800\">{formatNumber(dailyWithdrawalsUsed)}</span>\r\n                    </div>\r\n                    <div className=\"pt-2 mt-2 border-t border-blue-200 flex justify-between items-center\">\r\n                        <span className=\"text-[10px] text-blue-500 font-medium\">الربح اليومي</span>\r\n                        <span className=\"text-sm font-bold text-blue-700\">{formatNumber(dailyWithdrawalsProfit)}</span>\r\n                    </div>\r\n                 </div>\r\n                 <div className=\"bg-green-50 p-3 rounded border border-green-100 flex flex-col justify-between\">\r\n                    <div className=\"space-y-1\">\r\n                        <span className=\"text-xs text-green-600 block\">سحب الشهر (يصفر أول الشهر)</span>\r\n                        <span className=\"text-lg font-bold text-green-800\">{formatNumber(monthlyWithdrawalsUsed)}</span>\r\n                    </div>\r\n                    <div className=\"pt-2 mt-2 border-t border-green-200 flex justify-between items-center\">\r\n                        <span className=\"text-[10px] text-green-500 font-medium\">الربح الشهري</span>\r\n                        <span className=\"text-sm font-bold text-green-700\">{formatNumber(monthlyWithdrawalsProfit)}</span>\r\n                    </div>\r\n                 </div>\r\n              </div>\r\n\r\n              <div className=\"grid grid-cols-1 gap-4\">\r\n                <div className=\"space-y-1\">\r\n                  <label className=\"text-sm font-medium block text-right\">مبلغ السحب</label>\r\n                  <Input\r\n                    type=\"number\"\r\n                    min={0}\r\n                    value={withdrawalAmount}\r\n                    onChange={(e) => setWithdrawalAmount(e.target.value)}\r\n                    placeholder=\"0.00\"\r\n                    className=\"text-right\"\r\n                  />\r\n                </div>\r\n                \r\n                <div className=\"space-y-2 border p-3 rounded bg-gray-50\">\r\n                    <label className=\"text-sm font-medium block text-right mb-2\">طريقة حساب العمولة</label>\r\n                    <div className=\"flex justify-end gap-2 mb-3\">\r\n                         <Button \r\n                            variant={commissionMode === 'fixed' ? 'default' : 'outline'} \r\n                            size=\"sm\"\r\n                            onClick={() => setCommissionMode('fixed')}\r\n                            className={commissionMode === 'fixed' ? 'bg-violet-600' : ''}\r\n                         >\r\n                            مبلغ ثابت\r\n                         </Button>\r\n                         <Button \r\n                            variant={commissionMode === 'rate' ? 'default' : 'outline'} \r\n                            size=\"sm\"\r\n                            onClick={() => setCommissionMode('rate')}\r\n                            className={commissionMode === 'rate' ? 'bg-violet-600' : ''}\r\n                         >\r\n                            نسبة لكل ألف\r\n                         </Button>\r\n                    </div>\r\n\r\n                    {commissionMode === 'rate' ? (\r\n                        <div className=\"space-y-1\">\r\n                          <label className=\"text-sm font-medium block text-right\">العمولة (لكل ألف)</label>\r\n                          <Input\r\n                            type=\"number\"\r\n                            min={0}\r\n                            value={commissionRate}\r\n                            onChange={(e) => setCommissionRate(e.target.value)}\r\n                            placeholder=\"2\"\r\n                            className=\"text-right\"\r\n                          />\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"space-y-1\">\r\n                          <label className=\"text-sm font-medium block text-right\">مبلغ العمولة الكلي</label>\r\n                          <Input\r\n                            type=\"number\"\r\n                            min={0}\r\n                            value={fixedCommissionAmount}\r\n                            onChange={(e) => setFixedCommissionAmount(e.target.value)}\r\n                            placeholder=\"0.00\"\r\n                            className=\"text-right\"\r\n                          />\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                <div className=\"flex items-center space-x-2 space-x-reverse mt-2 justify-end\">\r\n                    <label htmlFor=\"deductDrawer\" className=\"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer\">\r\n                        خصم من درج النقدية\r\n                    </label>\r\n                    <Checkbox \r\n                        id=\"deductDrawer\" \r\n                        checked={deductFromDrawer}\r\n                        onCheckedChange={(c) => setDeductFromDrawer(!!c)} \r\n                    />\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex items-center justify-between bg-gray-50 p-3 rounded-lg\">\r\n                <div className=\"text-sm text-gray-600\">\r\n                  سيتم تسجيل عمولة: <span className=\"font-bold text-green-600\">\r\n                    {formatNumber(\r\n                        commissionMode === 'rate' \r\n                        ? (parseFloat(withdrawalAmount || '0') / 1000) * parseFloat(commissionRate || '0')\r\n                        : parseFloat(fixedCommissionAmount || '0')\r\n                    )}\r\n                  </span>\r\n                </div>\r\n                <Button onClick={handleCashWithdrawal} disabled={isProcessing} className=\"bg-violet-600 hover:bg-violet-700 disabled:opacity-70\">\r\n                  {isProcessing ? 'جاري السحب...' : 'سحب'}\r\n                </Button>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n          )}\r\n          {activeSection === 'withdrawalReceipts' && (\r\n          <Card>\r\n            <CardHeader className=\"pb-2\">\r\n              <CardTitle className=\"flex items-center justify-between\">\r\n                <span className=\"text-right\">إيصالات سحب مكنة</span>\r\n                <Badge variant=\"outline\" className=\"text-violet-700 border-violet-200 bg-violet-50\">\r\n                   عدد الإيصالات: {withdrawalReceipts.length}\r\n                </Badge>\r\n              </CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-3\">\r\n              {withdrawalReceipts.length === 0 ? (\r\n                <p className=\"text-sm text-gray-500 text-right\">لا توجد سحوبات مسجلة لهذا الشهر.</p>\r\n              ) : (\r\n                <div className=\"space-y-2 max-h-[60vh] overflow-y-auto pr-1\">\r\n                  {withdrawalReceipts.map((w) => (\r\n                    <div key={w.id} className=\"flex items-center justify-between p-3 rounded-lg border border-gray-100 bg-white dark:bg-gray-800 dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow\">\r\n                      <div className=\"flex items-center gap-4\">\r\n                         <div className=\"text-right min-w-[4rem]\">\r\n                            <span className=\"block text-[10px] text-gray-500 mb-0.5\">المبلغ</span>\r\n                            <span className=\"block text-sm font-bold text-gray-900 dark:text-gray-100\">{formatNumber(w.amount)}</span>\r\n                         </div>\r\n                         <div className=\"h-8 w-px bg-gray-100 dark:bg-gray-700\"></div>\r\n                         <div className=\"text-right min-w-[3rem]\">\r\n                            <span className=\"block text-[10px] text-gray-500 mb-0.5\">العمولة</span>\r\n                            <span className=\"block text-sm font-bold text-green-600\">{formatNumber(w.commission)}</span>\r\n                         </div>\r\n                      </div>\r\n\r\n                      <div className=\"flex items-center gap-3\">\r\n                        <Button\r\n                          variant=\"ghost\"\r\n                          size=\"icon\"\r\n                          className=\"h-7 w-7 text-red-400 hover:text-red-600 hover:bg-red-50\"\r\n                          onClick={() => handleDeleteWithdrawalReceipt(w.id)}\r\n                          title=\"حذف الإيصال\"\r\n                        >\r\n                          <Trash2 className=\"h-4 w-4\" />\r\n                        </Button>\r\n\r\n                        <div className=\"flex flex-col items-end gap-1.5\">\r\n                          <div className=\"flex items-center gap-2 text-[10px] text-gray-400\">\r\n                            <span>{formatDateTime(w.createdAt?.toISOString ? w.createdAt.toISOString() : w.createdAt)}</span>\r\n                            {w.cashierName && (\r\n                              <>\r\n                                <Separator orientation=\"vertical\" className=\"h-3\" />\r\n                                <span title={w.cashierName}>{w.cashierName.split(' ')[0]}</span>\r\n                              </>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n          )}\r\n          {activeSection === 'delivery' && (\r\n          <Card>\r\n            <CardHeader className=\"pb-2\">\r\n              <CardTitle className=\"text-right\">تسليم الوردية</CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                <div className=\"space-y-1\">\r\n                  <label className=\"text-sm font-medium block text-right\">الرصيد الأساسي الحالي</label>\r\n                  <Input\r\n                    inputMode=\"decimal\"\r\n                    type=\"number\"\r\n                    min={0}\r\n                    step=\"0.01\"\r\n                    value={deliveryBase}\r\n                    onChange={(e) => setDeliveryBase(e.target.value)}\r\n                    placeholder=\"0.00\"\r\n                    className=\"text-right\"\r\n                  />\r\n                </div>\r\n                <div className=\"space-y-1\">\r\n                  <label className=\"text-sm font-medium block text-right\">رصيد الهواء الحالي</label>\r\n                  <Input\r\n                    inputMode=\"decimal\"\r\n                    type=\"number\"\r\n                    min={0}\r\n                    step=\"0.01\"\r\n                    value={deliveryAir}\r\n                    onChange={(e) => setDeliveryAir(e.target.value)}\r\n                    placeholder=\"0.00\"\r\n                    className=\"text-right\"\r\n                  />\r\n                </div>\r\n              </div>\r\n              <div className=\"flex items-center justify-end gap-2\">\r\n                <Button onClick={handleDoDelivery} className=\"bg-violet-600 hover:bg-violet-700\">تسليم</Button>\r\n              </div>\r\n\r\n              {netResult != null && (\r\n                <div className=\"mt-3\">\r\n                  <div className=\"text-right\">\r\n                    <Badge className={netResult >= 0 ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-red-100 text-red-700 border border-red-200'}>\r\n                      الناتج النهائي: {formatNumber(netResult)}\r\n                    </Badge>\r\n                  </div>\r\n                  <div className=\"mt-2 flex items-center justify-end gap-2\">\r\n                    <Badge className=\"bg-blue-100 text-blue-700 border border-blue-200\">\r\n                      المجموع النهائي: {formatNumber(parseFloat(deliveryBase || '0') + parseFloat(deliveryAir || '0'))}\r\n                    </Badge>\r\n                    <Badge className=\"bg-amber-100 text-amber-700 border border-amber-200\">\r\n                      مطلوب من الدرج (بدون أرباح): {formatNumber(totalWholesaleTransferred)}\r\n                    </Badge>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n          )}\r\n          {activeSection === 'deliveryReceipts' && (\r\n          <Card>\r\n            <CardHeader className=\"pb-2\">\r\n              <CardTitle className=\"flex items-center justify-between\">\r\n                <span className=\"text-right\">إيصالات التسليم</span>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <Button variant=\"outline\" size=\"sm\" onClick={handleClearMachineReceipts} className=\"border-red-300 text-red-700 hover:bg-red-50\">حذف الإيصالات</Button>\r\n                </div>\r\n              </CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-3\">\r\n              {receipts.length === 0 ? (\r\n                <p className=\"text-sm text-gray-500 text-right\">لا توجد إيصالات حتى الآن.</p>\r\n              ) : (\r\n                <div className=\"space-y-3\">\r\n                  {receipts.map((r) => (\r\n                    <div key={r.id} className=\"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3\">\r\n                      <div className=\"text-right space-y-1\">\r\n                        <p className=\"text-xs text-gray-500\">الافتتاحي</p>\r\n                        <p className=\"text-sm\">أساسي: {formatNumber(r.openingBase)}</p>\r\n                        <p className=\"text-sm\">هواء: {formatNumber(r.openingAir)}</p>\r\n                      </div>\r\n                      <div className=\"text-right space-y-1\">\r\n                        <p className=\"text-xs text-gray-500\">التسليم</p>\r\n                        <p className=\"text-sm\">أساسي: {formatNumber(r.deliveryBase)}</p>\r\n                        <p className=\"text-sm\">هواء: {formatNumber(r.deliveryAir)}</p>\r\n                      </div>\r\n                      <div className=\"text-right space-y-1\">\r\n                        <div className=\"flex items-center justify-end\">\r\n                          <Button variant=\"outline\" size=\"sm\" onClick={() => handleDeleteMachineReceipt(r.id)} className=\"border-red-300 text-red-700 hover:bg-red-50\">\r\n                            <Trash2 className=\"h-3 w-3 mr-1\" /> حذف\r\n                          </Button>\r\n                        </div>\r\n                        <p className=\"text-xs text-gray-500\">النتيجة</p>\r\n                        <p className={`text-sm ${r.netResult >= 0 ? 'text-green-700' : 'text-red-700'}`}>{formatNumber(r.netResult)}</p>\r\n                        <div className=\"mt-1 flex items-center justify-end gap-2\">\r\n                          <span className=\"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5\">\r\n                            المجموع النهائي: {formatNumber(r.deliveryBase + r.deliveryAir)}\r\n                          </span>\r\n                          {typeof r.requiredDrawerNoProfit === 'number' && (\r\n                            <span className=\"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5\">\r\n                              مطلوب من الدرج (بدون أرباح): {formatNumber(r.requiredDrawerNoProfit || 0)}\r\n                            </span>\r\n                          )}\r\n                        </div>\r\n                        <div className=\"flex items-center justify-end gap-2 text-xs text-gray-500\">\r\n                          <Calendar className=\"h-3 w-3\" />\r\n                          <span>{formatDateTime(r.createdAt)}</span>\r\n                          {r.cashierName && (\r\n                            <>\r\n                              <Separator orientation=\"vertical\" className=\"h-3\" />\r\n                              <span>الكاشير: {r.cashierName}</span>\r\n                            </>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n          )}\r\n        </div>\r\n\r\n        <DialogFooter className=\"sticky bottom-0 bg-white dark:bg-[#0F0F0F] z-20 border-t border-gray-200 dark:border-[#333] px-4 py-3 flex items-center justify-between\">\r\n          <Button variant=\"outline\" onClick={() => handleClose(false)}>إغلاق</Button>\r\n          <div className=\"text-xs text-gray-500 flex items-center gap-1\">\r\n            <Clock className=\"h-3 w-3\" />\r\n            <span>يسجل التاريخ والوقت تلقائياً لكل إيصال</span>\r\n          </div>\r\n        </DialogFooter>\r\n      </DialogContent>\r\n\r\n      {/* نافذة تحويل الرصيد */}\r\n      <Dialog open={transferDialogOpen} onOpenChange={setTransferDialogOpen}>\r\n        <DialogContent className=\"sm:max-w-sm\">\r\n          <DialogHeader>\r\n            <DialogTitle>تحويل رصيد</DialogTitle>\r\n          </DialogHeader>\r\n          <div className=\"space-y-3\">\r\n            <div>\r\n              <label className=\"text-sm font-medium block text-right\">سعر الجملة</label>\r\n              <Input\r\n                inputMode=\"decimal\"\r\n                type=\"number\"\r\n                min={0}\r\n                step=\"0.01\"\r\n                value={wholesalePrice}\r\n                onChange={(e) => setWholesalePrice(e.target.value)}\r\n                placeholder=\"0.00\"\r\n                className=\"text-right\"\r\n              />\r\n            </div>\r\n            <div>\r\n              <label className=\"text-sm font-medium block text-right\">سعر التجزئة</label>\r\n              <Input\r\n                inputMode=\"decimal\"\r\n                type=\"number\"\r\n                min={0}\r\n                step=\"0.01\"\r\n                value={retailPrice}\r\n                onChange={(e) => setRetailPrice(e.target.value)}\r\n                placeholder=\"0.00\"\r\n                className=\"text-right\"\r\n              />\r\n            </div>\r\n            <div className=\"text-right\">\r\n              <Badge className=\"bg-green-100 text-green-700 border border-green-200\">\r\n                الربح الفوري: {formatNumber((parseFloat(retailPrice || '0') - parseFloat(wholesalePrice || '0')) || 0)}\r\n              </Badge>\r\n            </div>\r\n          </div>\r\n          <DialogFooter className=\"flex items-center justify-end gap-2\">\r\n            <Button variant=\"secondary\" onClick={() => setTransferDialogOpen(false)}>إلغاء</Button>\r\n            <Button onClick={handleTransferConfirm} className=\"bg-violet-600 hover:bg-violet-700\">تحويل</Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n      {/* نافذة اختيار مصدر الخصم */}\r\n      <AlertDialog open={deductDialogOpen} onOpenChange={setDeductDialogOpen}>\r\n        <AlertDialogContent>\r\n          <AlertDialogHeader>\r\n            <AlertDialogTitle>اختيار مصدر الخصم</AlertDialogTitle>\r\n            <AlertDialogDescription>هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟</AlertDialogDescription>\r\n          </AlertDialogHeader>\r\n          <div className=\"flex items-center justify-end gap-2 mt-4\">\r\n            <Button variant=\"ghost\" onClick={() => setDeductDialogOpen(false)} disabled={isProcessing}>رجوع</Button>\r\n            <Button \r\n              className=\"bg-emerald-600 hover:bg-emerald-700 text-white\" \r\n              onClick={() => finalizeTransfer('base')}\r\n              disabled={isProcessing}\r\n            >\r\n              {isProcessing ? 'جاري التحويل...' : 'خصم من الأساسي'}\r\n            </Button>\r\n            <Button \r\n              className=\"bg-blue-600 hover:bg-blue-700 text-white\" \r\n              onClick={() => finalizeTransfer('air')}\r\n              disabled={isProcessing}\r\n            >\r\n              {isProcessing ? 'جاري التحويل...' : 'خصم من الهواء'}\r\n            </Button>\r\n          </div>\r\n        </AlertDialogContent>\r\n      </AlertDialog>\r\n      \r\n      <VideoModal\r\n        isOpen={isVideoModalOpen}\r\n        onClose={() => setIsVideoModalOpen(false)}\r\n        videoUrl=\"https://www.youtube.com/watch?v=sHWKmqAmxic\"\r\n        title=\"شرح قسم مكن الشحن وتسجيل اليومية\"\r\n      />\r\n    </Dialog>\r\n  );\r\n}\r\n"],"file":"assets/MachineDailyDialog-bYSTPv0Q.js"}