const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-DvnSb1Lh.js","./index-DFE28tXP.css","./dailyOperationCountService-BD4JP70l.js","./profitService-CJzdybxg.js"])))=>i.map(i=>d[i]);
var Ih=Object.defineProperty;var Ah=(i,p,c)=>p in i?Ih(i,p,{enumerable:!0,configurable:!0,writable:!0,value:c}):i[p]=c;var _l=(i,p,c)=>Ah(i,typeof p!="symbol"?p+"":p,c);import{F as ga,m as Wc,n as Fc,u as Ia,r as n,c as da,j as e,Q as je,T as Se,V as Te,W as De,B as x,an as xa,ap as Dn,bl as wi,as as Sa,bm as bc,aa as Nn,K as Da,aq as Qs,a as Rc,v as us,ao as Ut,I as z,ak as Bc,av as Cn,_ as bt,bn as pa,U as Er,A as Th,R as Ke,E as Zs,t as Fa,a$ as hr,D as Ue,i as V,C as sa,s as yt,f as Pr,bo as dr,G as Ps,q as Ge,h as ke,at as me,k as He,Y as Uc,b8 as kh,bp as Ph,ax as rs,X as mt,ae as yi,p as ca,O as hs,ac as In,aD as Ni,$ as Ie,l as kr,bq as Ja,ar as Bl,H as Xt,bi as Bs,br as qc,bs as _h,bt as Oh,a5 as zc,bu as Eh,a0 as Lh,bv as Mh,a4 as $h,bw as Wh,bx as Fh,by as Rh,bz as Vc,bA as Bh,bB as Uh,bC as Jc,Z as ks,aC as vc,aI as wn,aH as Kc,bD as qh,bE as zh,ad as Vh,bF as pn,x as Jh,bG as gn,aj as Kh,ag as fn,aF as Yh,aG as Hh,bd as wc,bc as Nc,bH as Qh,o as Gh,aE as yn,bI as jc,b5 as Zh,bJ as Xh}from"./index-DvnSb1Lh.js";import{C as vt,a as Ht,b as ms,d as St}from"./card-CJ-6ser-.js";import{B as Mt}from"./badge-BfGzgZeY.js";import{S as Ka,a as Ya,b as Ha,c as Qa,d as ua,C as jn,e as Yc,f as eu}from"./select-Bt20No4d.js";import{L as Z}from"./label-B6P4HKsh.js";import{M as Ns,a as Cs,P as tu}from"./MasterPinDialog-DoxZ0TSE.js";import{W as aa}from"./wallet-ByY_xMmx.js";import{a as Hc,C as Fl,S as su}from"./star-Ch3gEF67.js";import{S as Ul}from"./square-pen-B5j1QbHd.js";import{T as ds,P as Sc}from"./progress-ClqSX7Ze.js";import{P as Ca}from"./phone-DA7H39xo.js";import{A as Qc}from"./arrow-left-pEhiR2Bz.js";import{C as $r,a as bi,S as Gc}from"./separator-CqHV39r0.js";import{D as es,A as _r}from"./dollar-sign-gI21wJou.js";import{A as xi,P as au}from"./ProfileIcon-9WiQiAPK.js";import{C as ur}from"./circle-alert-CyhKuebD.js";import{C as ql}from"./circle-x-BPdk9KzK.js";import{C as Lr}from"./circle-check-big-B7qPpE3T.js";import{f as Gs,P as Zc,C as Xc,T as ru,b as nu,c as Dc,d as Cc,A as zl,u as bn,a as Ic,I as iu,e as Ac,R as lu,g as ou,M as cu}from"./MaintenanceDialog-DvbiVjcH.js";import{S as ed}from"./store-Co9tXbi6.js";import{S as du}from"./switch-C0JIfFYU.js";import{E as mu,a as hu}from"./broadcastService-CDwMeI4U.js";import{B as Ol,T as uu}from"./textarea-CMDxbUyO.js";import{D as xu,a as pu,b as gu,c as fu,d as yu}from"./dropdown-menu-Cr2CyYbi.js";import{R as td}from"./refresh-cw-ByDjU7ZC.js";import{ProfitService as Ga}from"./profitService-CJzdybxg.js";import{W as bu}from"./WalletsManagement-DcPipKxN.js";import{FreeTrialService as vu}from"./freeTrialService-ag8hxyeR.js";import{P as wu,w as Nu}from"./walletSelectionPinService-G3WPHaj1.js";import{C as ju}from"./crown-CuelULZ5.js";import"./index-BQ7U6Bzi.js";import"./whatsappService-DIUnbVu6.js";import"./download-BI83ceFZ.js";/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Su=[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]],Tc=ga("banknote",Su);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Du=[["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M9 22v-3a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3",key:"cabbwy"}],["rect",{x:"4",y:"2",width:"16",height:"20",rx:"2",key:"1uxh74"}]],sd=ga("building",Du);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Cu=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]],kc=ga("calendar-days",Cu);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Iu=[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]],vi=ga("id-card",Iu);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Au=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],Pc=ga("info",Au);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Tu=[["path",{d:"M13 5h8",key:"a7qcls"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 19h8",key:"c3s6r1"}],["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}]],El=ga("list-checks",Tu);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ku=[["path",{d:"M2 6h4",key:"aawbzj"}],["path",{d:"M2 10h4",key:"l0bgd4"}],["path",{d:"M2 14h4",key:"1gsvsf"}],["path",{d:"M2 18h4",key:"1bu2t1"}],["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["path",{d:"M16 2v20",key:"rotuqe"}]],_c=ga("notebook",ku);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pu=[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["polyline",{points:"3.29 7 12 12 20.71 7",key:"ousv84"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]],ad=ga("package",Pu);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _u=[["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}],["path",{d:"M8 7v10",key:"23sfjj"}],["path",{d:"M12 7v10",key:"jspqdw"}],["path",{d:"M17 7v10",key:"578dap"}]],Ll=ga("scan-barcode",_u);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ou=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],Eu=ga("send",Ou);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lu=[["path",{d:"M16 17h6v-6",key:"t6n2it"}],["path",{d:"m22 17-8.5-8.5-5 5L2 7",key:"x473p"}]],Za=ga("trending-down",Lu),rd=async(i={})=>{try{return(await Wc(Fc,"getLastTransactions")(i)).data}catch(p){throw console.error("Error getting last transactions:",p),p.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):p.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+p.message):p.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+p.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(p.message||"خطأ غير معروف"))}},Mu=async i=>(await Wc(Fc,"sendTelegramMessage")(i)).data,$u=Object.freeze(Object.defineProperty({__proto__:null,getLastTransactions:rd,sendTelegramMessage:Mu},Symbol.toStringTag,{value:"Module"})),Wu=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Fu=({isOpen:i,onClose:p,onWalletSelect:c,onEditWallet:j,onDeleteWallet:D})=>{const{user:I}=Ia(),[s,w]=n.useState([]),[W,C]=n.useState(!1),[O,M]=n.useState([]),[y,N]=n.useState(!1),{toast:P}=da(),Q=async(L,F)=>{const ae=new Date().getMonth(),Le=new Date().getFullYear(),fe=F.filter(Ve=>{const Ze=new Date(Ve.createdAt);return Ze.getMonth()===ae&&Ze.getFullYear()===Le&&(Ve.lineId===L||Ve.fromWallet===L)}),oe=Ve=>{const Ze=Ve.type;return Ve.txnType==="receive"||Ze==="withdraw"||Ze==="withdrawal"||Ze==="receive"},ne=Ve=>{const Ze=Ve.type;return Ve.txnType==="send"||Ze==="send"||Ze==="transfer"},Re=fe.filter(oe).reduce((Ve,Ze)=>{const ht=Ze.withdrawnAmount!==void 0?Ze.withdrawnAmount:Ze.amount;return Ve+(ht||0)},0),Ye=fe.filter(ne).reduce((Ve,Ze)=>{const ht=Ze.sentAmount!==void 0?Ze.sentAmount:Ze.amount;return Ve+(ht||0)},0);return{withdrawalUsage:Re,transferUsage:Ye}},$=L=>{const F=new Date().toISOString().split("T")[0],ae=L.lastResetDate;if(!ae)return{...L,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:F};const Le=new Date(ae),fe=new Date;return Le.getMonth()!==fe.getMonth()||Le.getFullYear()!==fe.getFullYear()?{...L,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:F}:L};n.useEffect(()=>{if(!(I!=null&&I.uid)||!i)return;(async()=>{N(!0);try{const F=await xa.getByMerchantId(I.uid),ae=await wi.getByUserId(I.uid),fe=(await Promise.all(F.map(async oe=>{const{withdrawalUsage:ne,transferUsage:Re}=await Q(oe.id,ae),Ye=await Sa.getWalletLimits(oe.id);return{id:oe.id,name:oe.label||"محفظة بدون اسم",phone:oe.msisdn,nationalId:oe.nationalId||"",isDefault:!1,isActive:oe.isActive===!0,monthlyWithdrawalLimit:(Ye==null?void 0:Ye.monthlyWithdrawLimit)??oe.withdrawLimit??2e5,monthlyTransferLimit:(Ye==null?void 0:Ye.monthlyTransferLimit)??oe.transferLimit??2e5,monthlyWithdrawalUsage:(Ye==null?void 0:Ye.monthlyWithdrawUsed)??ne??0,monthlyTransferUsage:(Ye==null?void 0:Ye.monthlyTransferUsed)??Re??0,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:oe.walletProvider||""}}))).map($);w(fe)}catch(F){console.error("Error loading wallets:",F),P({title:"فشل جلب بيانات المحافظ",description:"قد تكون المشكلة بسبب الصلاحيات أو الاتصال. سيتم عرض البيانات المحلية إن وُجدت. جرّب تسجيل الدخول مجددًا أو افتح صفحة اختبار المصادقة من القائمة.",variant:"destructive"})}finally{N(!1)}})()},[I==null?void 0:I.uid,i]);const Y=L=>Wu.find(F=>F.id===L),se=(L,F)=>F>0?Math.min(L/F*100,100):0,de=L=>new Intl.NumberFormat("ar-EG").format(L);return e.jsx(je,{open:i,onOpenChange:p,children:e.jsxs(Se,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(Te,{className:"pb-4",children:[e.jsxs(De,{className:"flex items-center gap-2 text-lg",children:[e.jsx(aa,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(Mt,{variant:"secondary",className:"mr-2",children:[s.length," محفظة"]})]}),e.jsx("div",{className:"flex items-center gap-2 mt-2",children:W?e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",onClick:async()=>{try{if(!(I!=null&&I.uid))return;const L=s.map(F=>xa.update(F.id,{isActive:O.includes(F.id)}));await Promise.all(L),w(F=>F.map(ae=>({...ae,isActive:O.includes(ae.id)}))),C(!1),P({title:"تم تفعيل المحافظ",description:"فقط المحافظ المحددة ستظهر في الاختيار الخارجي"});try{window.dispatchEvent(new CustomEvent("wallets:activation-updated"))}catch{}}catch(L){console.error("Error activating wallets:",L),P({title:"فشل التفعيل",description:"تعذر تفعيل المحافظ المحددة",variant:"destructive"})}},className:"h-7",children:"تفعيل المحافظ"}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>{C(!1),M([])},className:"h-7",children:"إلغاء"})]}):e.jsx(x,{variant:"outline",size:"sm",onClick:()=>C(!0),className:"h-7",children:"تحديد المحافظ"})})]}),y?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):s.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(aa,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:s.map(L=>{const F=Y(L.walletProvider||"");se(L.monthlyWithdrawalUsage||0,L.monthlyWithdrawalLimit),se(L.monthlyTransferUsage||0,L.monthlyTransferLimit);const ae=O.includes(L.id),Le=W?`cursor-pointer transition-shadow border-2 ${ae?"border-blue-500 shadow-lg":"hover:border-blue-300"}`:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300";return e.jsxs(vt,{className:Le,onClick:()=>{W?M(fe=>fe.includes(L.id)?fe.filter(oe=>oe!==L.id):[...fe,L.id]):c(L)},children:[e.jsx(Ht,{className:"pb-3",children:e.jsxs(ms,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Dn,{className:"h-4 w-4"}),e.jsx("span",{children:L.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[L.isActive&&e.jsx(Mt,{variant:"default",className:"text-xs",children:"نشطة"}),L.isDefault&&e.jsxs(Mt,{variant:"default",className:"text-xs",children:[e.jsx(Hc,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(x,{variant:"ghost",size:"sm",onClick:fe=>{fe.stopPropagation(),j==null||j(L)},className:"h-7 px-2",children:e.jsx(Ul,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",onClick:fe=>{fe.stopPropagation(),D==null||D(L.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(ds,{className:"h-4 w-4"})})]})]})}),e.jsxs(St,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ca,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:L.phone})]}),L.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(vi,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:L.nationalId})]}),F&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(sd,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:F.name})]})]}),(()=>{const fe=L.monthlyWithdrawalLimit,oe=L.monthlyTransferLimit,ne=L.monthlyWithdrawalUsage||0,Re=L.monthlyTransferUsage||0,Ye=Math.max(fe-ne,0),Ve=Math.max(oe-Re,0);return e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{className:"text-xs text-gray-600 font-medium text-center",children:["الحدود الشهرية: ",(F==null?void 0:F.name)||L.walletProvider," - ",L.phone]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(ne/Math.max(fe,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Re/Math.max(oe,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",de(Ye)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",de(Ve)," جنيه"]})]})]})})(),e.jsx(x,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:fe=>{fe.stopPropagation(),c(L)},children:"عرض التفاصيل الكاملة"})]})]},L.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(x,{onClick:p,variant:"outline",children:[e.jsx(Qc,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},Ru=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Bu=({wallet:i,isOpen:p,onClose:c,onBack:j})=>{const{user:D}=Ia(),[I,s]=n.useState([]),[w,W]=n.useState(!1),[C,O]=n.useState("month"),{toast:M}=da();if(n.useEffect(()=>{if(!i||!(D!=null&&D.uid)||!p)return;(async()=>{W(!0);try{const st=(await wi.getByUserId(D.uid)).filter(Dt=>Dt.walletId===i.id).sort((Dt,Pt)=>new Date(Pt.createdAt).getTime()-new Date(Dt.createdAt).getTime());s(st)}catch(Ae){console.error("Error loading transactions:",Ae),M({title:"فشل جلب معاملات المحفظة",description:"قد تكون المشكلة بسبب صلاحيات Firestore أو الاتصال. تم عرض ما أمكن محليًا. جرّب تسجيل الدخول مجددًا أو صفحة اختبار المصادقة.",variant:"destructive"})}finally{W(!1)}})()},[i,D==null?void 0:D.uid,p]),!i)return null;const y=X=>Ru.find(Ae=>Ae.id===X),N=(X,Ae)=>Ae>0?Math.min(X/Ae*100,100):0,P=X=>new Intl.NumberFormat("ar-EG").format(X),Q=X=>new Date(X).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),Y=(()=>{const X=new Date;let Ae;switch(C){case"week":Ae=new Date(X.getTime()-7*24*60*60*1e3);break;case"month":Ae=new Date(X.getFullYear(),X.getMonth(),1);break;default:return I}return I.filter(st=>new Date(st.createdAt)>=Ae)})(),se=X=>{const Ae=X.type,st=X.txnType;return Ae==="withdraw"||Ae==="withdrawal"||Ae==="receive"||st==="receive"},de=X=>{const Ae=X.type,st=X.txnType;return Ae==="send"||Ae==="transfer"||st==="send"},L=Y.filter(X=>se(X)&&X.status==="completed").reduce((X,Ae)=>{const st=Ae.withdrawnAmount!==void 0?Ae.withdrawnAmount:Ae.amount;return X+(st||0)},0),F=Y.filter(X=>de(X)&&X.status==="completed").reduce((X,Ae)=>{const st=Ae.sentAmount!==void 0?Ae.sentAmount:Ae.amount;return X+(st||0)},0),ae=Y.filter(X=>X.type==="deposit"&&X.status==="completed").reduce((X,Ae)=>X+Ae.amount,0),Le=Y.filter(X=>X.status==="completed"),fe=Le.length,oe=Le.reduce((X,Ae)=>{if(se(Ae)){const st=Ae.withdrawnAmount??Ae.receivedAmount??Ae.amount??0;return X+bc(Number(st)||0,"receive")}if(de(Ae)){const st=Ae.sentAmount??Ae.transferredAmount??Ae.amount??0;return X+bc(Number(st)||0,"send")}return X},0),ne=y(i.walletProvider||""),Re=N(i.monthlyWithdrawalUsage||0,i.monthlyWithdrawalLimit),Ye=N(i.monthlyTransferUsage||0,i.monthlyTransferLimit),Ve=X=>{switch(X){case"withdrawal":return e.jsx(Za,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(Nn,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx(es,{className:"h-4 w-4 text-green-500"});default:return e.jsx(xi,{className:"h-4 w-4 text-gray-500"})}},Ze=X=>{switch(X){case"completed":return e.jsx(Lr,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(Da,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(ql,{className:"h-4 w-4 text-red-500"});default:return e.jsx(ur,{className:"h-4 w-4 text-gray-500"})}},ht=X=>{switch(X){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},Ot=X=>{switch(X){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(je,{open:p,onOpenChange:c,children:e.jsxs(Se,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Te,{className:"pb-4",children:e.jsxs(De,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Dn,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",i.name,i.isDefault&&e.jsxs(Mt,{variant:"default",className:"mr-2",children:[e.jsx(Hc,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(vt,{children:[e.jsx(Ht,{children:e.jsxs(ms,{className:"text-sm flex items-center gap-2",children:[e.jsx(vi,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(St,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ca,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.phone})]}),i.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(vi,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.nationalId})]}),ne&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(sd,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:ne.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",ne.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",ne.nationalId]})]})]}),i.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx($r,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(i.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs(vt,{children:[e.jsx(Ht,{children:e.jsxs(ms,{className:"text-sm flex items-center gap-2",children:[e.jsx(Fl,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(St,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Za,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[P(i.monthlyWithdrawalUsage||0)," / ",P(i.monthlyWithdrawalLimit)]})]}),e.jsx(Sc,{value:Re,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",P(i.monthlyWithdrawalLimit-(i.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(bi,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Nn,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[P(i.monthlyTransferUsage||0)," / ",P(i.monthlyTransferLimit)]})]}),e.jsx(Sc,{value:Ye,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",P(i.monthlyTransferLimit-(i.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(vt,{children:e.jsxs(St,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Za,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:P(L)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx(vt,{children:e.jsxs(St,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Nn,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:P(F)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx(vt,{children:e.jsxs(St,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(es,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:P(ae)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})}),e.jsx(vt,{children:e.jsxs(St,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Fl,{className:"h-5 w-5 text-emerald-600"})}),e.jsx("div",{className:"text-lg font-bold",children:P(oe)}),e.jsx("div",{className:"text-xs text-gray-600",children:"أرباح الفترة"})]})}),e.jsx(vt,{children:e.jsxs(St,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(xi,{className:"h-5 w-5 text-purple-600"})}),e.jsx("div",{className:"text-lg font-bold",children:P(fe)}),e.jsx("div",{className:"text-xs text-gray-600",children:"عدد العمليات"})]})})]}),e.jsxs(vt,{children:[e.jsx(Ht,{children:e.jsxs(ms,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(xi,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{size:"sm",variant:C==="week"?"default":"outline",onClick:()=>O("week"),className:"text-xs",children:"أسبوع"}),e.jsx(x,{size:"sm",variant:C==="month"?"default":"outline",onClick:()=>O("month"),className:"text-xs",children:"شهر"}),e.jsx(x,{size:"sm",variant:C==="all"?"default":"outline",onClick:()=>O("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(St,{children:w?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):Y.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(xi,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:Y.map(X=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[Ve(X.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[ht(X.type)," - ",P(X.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:Q(X.createdAt)}),X.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:X.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[Ze(X.status),e.jsx("span",{className:"text-xs",children:Ot(X.status)})]})]},X.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(x,{onClick:j,variant:"outline",children:[e.jsx(Qc,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(x,{onClick:c,variant:"outline",children:"إغلاق"})]})]})})},Ml=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Uu=({isOpen:i,onClose:p,onWalletUpdate:c,initialEditingWallet:j})=>{const{toast:D}=da(),{user:I,userSubscription:s}=Ia();(()=>{var We,ut;const U=((We=s==null?void 0:s.subscription)==null?void 0:We.planType)??((ut=s==null?void 0:s.subscription)==null?void 0:ut.plan)??(s==null?void 0:s.planType)??(s==null?void 0:s.plan)??null,xe=typeof U=="string"?String(U).trim().toLowerCase():null;return U===Qs.TAHWEELA||xe==="tahweela"||xe==="تحويله"})();const w=Rc(),[W,C]=n.useState([]),[O,M]=n.useState(!1),[y,N]=n.useState(null),[P,Q]=n.useState(""),[$,Y]=n.useState(""),[se,de]=n.useState(""),[L,F]=n.useState(""),[ae,Le]=n.useState("200000"),[fe,oe]=n.useState("200000"),[ne,Re]=n.useState("100000"),[Ye,Ve]=n.useState("60000"),[Ze,ht]=n.useState(!1),[Ot,X]=n.useState(null),[Ae,st]=n.useState(!1),[Dt,Pt]=n.useState(!1),[xs,le]=n.useState(!1),[Me,$e]=n.useState(null),ve=()=>`wallets_${(I==null?void 0:I.uid)||"default"}`;n.useEffect(()=>{j&&(N(j),M(!0),Q(j.name||""),Y(j.phone||""),de(j.nationalId||""),F(j.walletProvider||""),Le((j.monthlyWithdrawalLimit||2e5).toString()),oe((j.monthlyTransferLimit||2e5).toString()),Re((j.dailyWithdrawalLimit||1e5).toString()),Ve((j.dailyTransferLimit||6e4).toString()),ht(!!j.isDefault))},[j]);const Be=U=>{const xe=new Date,We=xe.getMonth(),ut=xe.getFullYear();if(!U.lastResetDate)return{...U,monthlyWithdrawalUsage:U.monthlyWithdrawalUsage||0,monthlyTransferUsage:U.monthlyTransferUsage||0,lastResetDate:xe.toISOString().split("T")[0]};const gt=new Date(U.lastResetDate),ps=gt.getMonth(),ns=gt.getFullYear();return We!==ps||ut!==ns?{...U,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:xe.toISOString().split("T")[0]}:U},tt=async(U,xe)=>{const We=new Date().getMonth(),ut=new Date().getFullYear(),gt=xe.filter(Lt=>{const ot=new Date(Lt.createdAt);return ot.getMonth()===We&&ot.getFullYear()===ut&&Lt.lineId===U}),ps=gt.filter(Lt=>Lt.txnType==="receive").reduce((Lt,ot)=>Lt+(ot.amount||0),0),ns=gt.filter(Lt=>Lt.txnType==="send").reduce((Lt,ot)=>Lt+(ot.amount||0),0);return{withdrawalUsage:ps,transferUsage:ns}},re=async(U,xe)=>{const We=new Date,ut=We.getDate(),gt=We.getMonth(),ps=We.getFullYear(),ns=xe.filter(It=>{const qt=new Date(It.createdAt);return qt.getDate()===ut&&qt.getMonth()===gt&&qt.getFullYear()===ps&&It.lineId===U}),Lt=ns.filter(It=>It.txnType==="receive").reduce((It,qt)=>It+(qt.amount||0),0),ot=ns.filter(It=>It.txnType==="send").reduce((It,qt)=>It+(qt.amount||0),0);return{withdrawalUsage:Lt,transferUsage:ot}};n.useEffect(()=>{(async()=>{if(!(I!=null&&I.uid)){console.log("No user authenticated, skipping wallet loading"),st(!1);return}console.log("Loading wallets for user:",I.uid),st(!0);try{const{auth:xe}=await bt(async()=>{const{auth:ot}=await import("./index-DvnSb1Lh.js").then(It=>It.c4);return{auth:ot}},__vite__mapDeps([0,1]),import.meta.url);let We=0;const ut=5;for(;!xe.currentUser&&We<ut;)console.log(`Waiting for auth state... attempt ${We+1}`),await new Promise(ot=>setTimeout(ot,1e3)),We++;if(!xe.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",xe.currentUser.uid),console.log("Context User:",I.uid),console.log("Fetching wallets from Firebase...");const gt=await xa.getByMerchantId(I.uid);console.log("Fetched wallets:",gt),console.log("Fetching transactions from Firebase...");const ps=await wi.getByUserId(I.uid);console.log("Fetched transactions:",ps);const Lt=(await Promise.all(gt.map(async ot=>{const{withdrawalUsage:It,transferUsage:qt}=await tt(ot.id,ps),{withdrawalUsage:_s,transferUsage:gs}=await re(ot.id,ps);return{id:ot.id,name:ot.label||"محفظة بدون اسم",phone:ot.msisdn,isDefault:!1,monthlyWithdrawalLimit:ot.withdrawLimit||2e5,monthlyTransferLimit:ot.transferLimit||2e5,dailyWithdrawalLimit:ot.dailyWithdrawLimit||1e5,dailyTransferLimit:ot.dailyTransferLimit||6e4,monthlyWithdrawalUsage:It,monthlyTransferUsage:qt,dailyWithdrawalUsage:_s,dailyTransferUsage:gs,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:ot.defaultTransferCommission!=null?Number(ot.defaultTransferCommission):null,defaultWithdrawCommission:ot.defaultWithdrawCommission!=null?Number(ot.defaultWithdrawCommission):null}}))).map(Be);C(Lt),console.log("Wallets loaded successfully:",Lt)}catch(xe){console.error("Error loading wallets:",xe),C([])}finally{st(!1)}})()},[I==null?void 0:I.uid]);const Je=()=>{Q(""),Y(""),de(""),F(""),Le("200000"),oe("200000"),Re("100000"),Ve("60000"),ht(!1),N(null),M(!1)},ee=async()=>{if(!P.trim()||!$.trim()||!L.trim()){D({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(I!=null&&I.uid)){D({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}st(!0);try{if(y){await xa.update(y.id,{label:P.trim(),msisdn:$.trim(),withdrawLimit:parseInt(ae),transferLimit:parseInt(fe),dailyWithdrawLimit:parseInt(ne),dailyTransferLimit:parseInt(Ye)}),await Sa.setLimits(y.id,{dailyTransferLimit:parseInt(Ye||"0"),dailyWithdrawLimit:parseInt(ne||"0"),monthlyTransferLimit:parseInt(fe||"0"),monthlyWithdrawLimit:parseInt(ae||"0")});const U=W.map(xe=>xe.id===y.id?{...xe,name:P.trim(),phone:$.trim(),nationalId:se.trim(),walletProvider:L,monthlyWithdrawalLimit:parseInt(ae),monthlyTransferLimit:parseInt(fe),dailyWithdrawalLimit:parseInt(ne),dailyTransferLimit:parseInt(Ye)}:xe);C(U),localStorage.setItem(ve(),JSON.stringify(U)),D({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const U={merchantUserId:I.uid,provider:L,msisdn:$.trim(),label:P.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(ae),transferLimit:parseInt(fe),dailyTransferLimit:parseInt(Ye),dailyWithdrawLimit:parseInt(ne),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},xe=await xa.create(U);await Sa.setLimits(xe,{dailyTransferLimit:parseInt(Ye||"0"),dailyWithdrawLimit:parseInt(ne||"0"),monthlyTransferLimit:parseInt(fe||"0"),monthlyWithdrawLimit:parseInt(ae||"0")});const We=new Date().toISOString().split("T")[0],ut={id:xe,name:P.trim(),phone:$.trim(),nationalId:se.trim(),walletProvider:L,isDefault:Ze,monthlyWithdrawalLimit:parseInt(ae),monthlyTransferLimit:parseInt(fe),dailyWithdrawalLimit:parseInt(ne),dailyTransferLimit:parseInt(Ye),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:We,defaultTransferCommission:null,defaultWithdrawCommission:null},gt=[...W,ut];C(gt),localStorage.setItem(ve(),JSON.stringify(gt)),D({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}c&&c(),Je(),M(!1),N(null)}catch(U){console.error("Error saving wallet:",U),D({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{st(!1)}},R=U=>{N(U),Q(U.name),Y(U.phone),de(U.nationalId||""),F(U.walletProvider||""),Le(U.monthlyWithdrawalLimit.toString()),oe(U.monthlyTransferLimit.toString()),ht(U.isDefault),M(!0)},Ct=async U=>{const xe=W.find(We=>We.id===U);if(xe!=null&&xe.isDefault){D({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(I!=null&&I.uid)){D({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}st(!0);try{await xa.delete(U);const We=W.filter(ut=>ut.id!==U);C(We),localStorage.setItem(ve(),JSON.stringify(We)),c&&c(),D({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(We){console.error("Error deleting wallet:",We),D({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{st(!1)}},_t=U=>{const xe=W.map(We=>({...We,isDefault:We.id===U}));C(xe),localStorage.setItem(ve(),JSON.stringify(xe)),c&&c(),D({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(je,{open:i,onOpenChange:p,children:[e.jsxs(Se,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(Te,{className:"pb-2",children:e.jsxs(De,{className:"flex items-center gap-1 text-sm",children:[e.jsx(aa,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",W.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(x,{onClick:()=>{le(!0)},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(us,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(x,{onClick:()=>{p(),w("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(Ut,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),(O||y)&&e.jsxs(vt,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx(Ht,{className:"pb-1",children:e.jsx(ms,{className:"text-sm",children:y?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(St,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(Ka,{value:L,onValueChange:F,children:[e.jsx(Ya,{className:"h-6 text-xs flex-1",children:e.jsx(Ha,{placeholder:"اختر شركة المحفظة"})}),e.jsx(Qa,{children:Ml.map(U=>e.jsx(ua,{value:U.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:U.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:xe=>{xe.preventDefault(),xe.stopPropagation(),X(U.id)},children:e.jsx(Pc,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},U.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx(z,{value:P,onChange:U=>Q(U.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ca,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(z,{value:$,onChange:U=>Y(U.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx(vi,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(z,{value:se,onChange:U=>de(U.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(es,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(z,{type:"number",value:ae,onChange:U=>Le(U.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(es,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(z,{type:"number",value:fe,onChange:U=>oe(U.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Za,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx(z,{type:"number",value:ne,onChange:U=>Re(U.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Nn,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx(z,{type:"number",value:Ye,onChange:U=>Ve(U.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:Ze,onChange:U=>ht(U.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(Bc,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(x,{onClick:ee,className:"flex-1 h-6 text-xs",size:"sm",children:y?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(x,{variant:"outline",onClick:Je,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:W.map(U=>{var xe;return e.jsxs(vt,{className:`${U.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx(Ht,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ms,{className:"text-sm flex items-center gap-1",children:[e.jsx(aa,{className:"h-3 w-3"}),U.name]}),U.isDefault&&e.jsx(Mt,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(St,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ca,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:U.phone})]}),U.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((xe=Ml.find(We=>We.id===U.walletProvider))==null?void 0:xe.name)||U.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((U.monthlyWithdrawalUsage||0)/U.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((U.monthlyTransferUsage||0)/U.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(U.monthlyWithdrawalLimit-(U.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(U.monthlyTransferLimit-(U.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((U.dailyWithdrawalUsage||0)/U.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((U.dailyTransferUsage||0)/U.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify بين items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(U.dailyWithdrawalLimit-(U.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(U.dailyTransferLimit-(U.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(x,{size:"sm",variant:"outline",onClick:()=>R(U),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(Ul,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!U.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",variant:"outline",onClick:()=>_t(U.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(x,{size:"sm",variant:"destructive",onClick:()=>Ct(U.id),className:"h-5 px-1",children:e.jsx(ds,{className:"h-2 w-2"})})]})]})]})]},U.id)})}),W.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),Ot&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>X(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(Cn,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const U=Ml.find(xe=>xe.id===Ot);return U?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:U.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:U.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:U.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(Pc,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(Ns,{open:xs,onOpenChange:le,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{le(!1),Pt(!0)}}),e.jsx(Fu,{isOpen:Dt,onClose:()=>Pt(!1),onWalletSelect:U=>{$e(U),Pt(!1)},onEditWallet:U=>{w(`/user/add-wallet?edit=1&id=${U.id}`),Pt(!1)},onDeleteWallet:async U=>{try{if(await xa.delete(U),C(xe=>{const We=xe.filter(ut=>ut.id!==U);try{localStorage.setItem(ve(),JSON.stringify(We))}catch(ut){console.error("Failed to update localStorage wallets after delete:",ut)}return We}),c)try{await c()}catch(xe){console.error("onWalletUpdate callback failed:",xe)}}catch(xe){console.error("Error deleting wallet:",xe)}}}),e.jsx(Bu,{wallet:Me,isOpen:!!Me,onClose:()=>$e(null),onBack:()=>{$e(null),Pt(!0)}})]})},qu=({isOpen:i,onClose:p,transaction:c,onDelete:j})=>{if(!c)return null;const D=C=>{switch(C){case"completed":return e.jsx(Lr,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(Da,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(ql,{className:"h-5 w-5 text-red-500"});default:return e.jsx(Da,{className:"h-5 w-5 text-gray-500"})}},I=C=>{switch(C){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},s=C=>{switch(C){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},w=()=>{const C=!!c.senderNumber,O=!!c.senderName,M=C?"الرقم المرسل:":O?"الرقم الراسل:":"رقم المحفظة:",y=C?c.senderNumber:O?c.senderName:c.senderPhone,N=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${c.transactionReference||c.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${c.merchantShopName||c.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${s(c.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${c.status==="completed"?"#16a34a":c.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${I(c.status)}
            </span>
          </div>

          ${c!=null&&c.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${c.cashierName}</span>
            </div>
          `:""}
          
          ${c.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${M}</span>
              <span style="color: #1e293b;">${y}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${c.receiverNumber||c.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${Gs(c.transferredAmount||c.amount)} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${c.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${Gs(c.withdrawnAmountDetailed||c.withdrawnAmount||c.amount)} جنيه</span>
            </div>
          `}
          
          ${c.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${Gs(c.commission||0)} جنيه</span>
            </div>
          `:""}
          ${c.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الربح:</span>
              <span style="color: #16a34a; font-weight: 600;">${Gs(c.commission||0)} جنيه</span>
            </div>
          `:""}
          ${c!=null&&c.fee&&Number(c.fee)>0?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرسوم:</span>
              <span style="color: #64748b; font-weight: 600;">${Gs(c.fee||0)} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${c.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${c.type==="withdraw"?"-":""}${Gs(c.amount)} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,P=window.open("","_blank");P&&(P.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${c.transactionReference||c.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${N}
          </body>
        </html>
      `),P.document.close(),P.print())},W=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(j(c.id),p())};return e.jsx(je,{open:i,onOpenChange:p,children:e.jsxs(Se,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Te,{children:e.jsxs(De,{className:"flex items-center gap-2 text-xl",children:[e.jsx(pa,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(vt,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs(Ht,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[D(c.status),e.jsx(Mt,{variant:c.status==="completed"?"default":"secondary",className:"text-sm",children:I(c.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[c.type==="withdraw"?"-":"",Gs(c.amount)," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",c.transactionReference||c.id]})]})}),e.jsxs(vt,{children:[e.jsx(Ht,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ed,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(St,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:c.merchantShopName||c.shopName||"غير محدد"})]}),(c==null?void 0:c.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:c.cashierName})]})]})]}),e.jsxs(vt,{children:[e.jsx(Ht,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Dn,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(St,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(Mt,{variant:"outline",className:"bg-blue-100 text-blue-800",children:s(c.type)})]}),c.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const C=!!c.senderNumber,O=!!c.senderName,M=C?"الرقم المرسل:":O?"الرقم الراسل:":"رقم المحفظة:",y=C?c.senderNumber:O?c.senderName:c.senderPhone,N=C?Er:Ca;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:M})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:y})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(Th,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Er,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:c.receiverNumber||c.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(es,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[Gs(c.transferredAmount||c.amount)," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ca,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:c.senderPhone})]}),(c==null?void 0:c.senderName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Er,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("span",{className:"text-gray-900",children:c.senderName})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(es,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[Gs(c.withdrawnAmountDetailed||c.withdrawnAmount||c.amount)," جنيه"]})]})]}),c.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[c.commission," جنيه"]})]}),c.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-green-700",children:"الربح:"}),e.jsxs("span",{className:"text-green-900 font-semibold",children:[c.commission," جنيه"]})]}),(c==null?void 0:c.fee)&&Number(c.fee)>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الرسوم:"}),e.jsxs("span",{className:"text-gray-900 font-semibold",children:[c.fee," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($r,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:c.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(x,{onClick:w,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx(Zc,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(x,{onClick:W,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(ds,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(x,{onClick:p,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function Oc({open:i,onOpenChange:p,onSuccess:c,title:j,description:D,currentBalance:I,balanceLabel:s,userId:w}){const[W,C]=n.useState(""),[O,M]=n.useState(I.toString()),[y,N]=n.useState(!1),[P,Q]=n.useState(""),[$,Y]=n.useState(!1),se=async L=>{L.preventDefault(),Q(""),Y(!0);try{const F=parseFloat(O);if(isNaN(F)||F<0){Q("يرجى إدخال مبلغ صحيح"),Y(!1);return}await Cs.hasMasterPin(w)?await Cs.verifyMasterPin(W,w)?(c(F),p(!1),C(""),M("")):Q("الرقم السري غير صحيح"):Q("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{Q("حدث خطأ أثناء التحقق من الرقم السري")}finally{Y(!1)}},de=()=>{C(""),M(I.toString()),Q(""),p(!1)};return Ke.useEffect(()=>{i&&M(I.toString())},[I,i]),e.jsx(je,{open:i,onOpenChange:de,children:e.jsxs(Se,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Te,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[e.jsx(es,{className:"h-5 w-5"}),j]})}),e.jsxs("form",{onSubmit:se,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:D}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(Z,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[I.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx(z,{id:"newAmount",type:"number",step:"0.01",min:"0",value:O,onChange:L=>M(L.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"pin",type:y?"text":"password",value:W,onChange:L=>C(L.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>N(!y),children:y?e.jsx(Zs,{className:"h-4 w-4"}):e.jsx(us,{className:"h-4 w-4"})})]})]}),P&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(ur,{className:"h-4 w-4"}),P]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(x,{type:"button",variant:"outline",onClick:de,className:"flex-1",children:"إلغاء"}),e.jsx(x,{type:"submit",disabled:$||!W||!O,className:"flex-1",children:$?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Fa,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class Sn{static getSecretKey(p){return p?`${this.SECRET_KEY_BASE}_${p}`:this.SECRET_KEY_BASE}static setSecretPin(p,c){const j=btoa(p);this.secretCache.set(this.getSecretKey(c),j)}static hasSecretPin(p){return this.secretCache.has(this.getSecretKey(p))}static verifySecretPin(p,c){const j=this.secretCache.get(this.getSecretKey(c));if(!j)return!1;try{return atob(j)===p}catch{return!1}}static clearSecretPin(p){this.secretCache.delete(this.getSecretKey(p))}}_l(Sn,"SECRET_KEY_BASE","dashboard_secret_pin"),_l(Sn,"secretCache",new Map);function zu({open:i,onOpenChange:p,userId:c}){const[j,D]=n.useState(""),[I,s]=n.useState(""),[w,W]=n.useState(""),[C,O]=n.useState(!1),[M,y]=n.useState(!1),[N,P]=n.useState(!1),[Q,$]=n.useState(""),[Y,se]=n.useState(!1),{toast:de}=da(),L=Sn.hasSecretPin(c),F=async Le=>{Le.preventDefault(),$(""),se(!0);try{if(!I||I.length<4){$("يجب أن يكون الرقم السري 4 أرقام على الأقل"),se(!1);return}if(I!==w){$("الرقم السري الجديد وتأكيده غير متطابقين"),se(!1);return}if(L){if(!j){$("يرجى إدخال الرقم السري الحالي"),se(!1);return}if(!Sn.verifySecretPin(j,c)){$("الرقم السري الحالي غير صحيح"),se(!1);return}}Sn.setSecretPin(I,c),de({title:L?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:L?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),ae()}catch{$("حدث خطأ أثناء حفظ الرقم السري")}finally{se(!1)}},ae=()=>{D(""),s(""),W(""),$(""),O(!1),y(!1),P(!1),p(!1)};return e.jsx(je,{open:i,onOpenChange:ae,children:e.jsxs(Se,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Te,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[e.jsx(Bc,{className:"h-5 w-5"}),L?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:F,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:L?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),L&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"currentPin",type:C?"text":"password",autoComplete:"off",value:j,onChange:Le=>D(Le.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>O(!C),children:C?e.jsx(Zs,{className:"h-4 w-4"}):e.jsx(us,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"newPin",type:M?"text":"password",autoComplete:"off",value:I,onChange:Le=>s(Le.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!M),children:M?e.jsx(Zs,{className:"h-4 w-4"}):e.jsx(us,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"confirmPin",type:N?"text":"password",autoComplete:"off",value:w,onChange:Le=>W(Le.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>P(!N),children:N?e.jsx(Zs,{className:"h-4 w-4"}):e.jsx(us,{className:"h-4 w-4"})})]})]}),Q&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(ur,{className:"h-4 w-4"}),Q]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:Y,className:"flex-1",children:[e.jsx(Fa,{className:"h-4 w-4 mr-2"}),Y?"جاري الحفظ...":L?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(x,{type:"button",variant:"outline",onClick:ae,disabled:Y,children:"إلغاء"})]})]})]})})}const $l=new Map;function Vu({open:i,onOpenChange:p,userId:c}){const[j,D]=n.useState(""),[I,s]=n.useState(""),[w,W]=n.useState(""),[C,O]=n.useState(!1),[M,y]=n.useState(!1),[N,P]=n.useState(!1),[Q,$]=n.useState(""),[Y,se]=n.useState(!1),{toast:de}=da(),L=c?`cash_drawer_pin_${c}`:"cash_drawer_pin",F=()=>$l.has(L),ae=ne=>{const Re=$l.get(L);if(!Re)return!1;try{return atob(Re)===ne}catch{return!1}},Le=ne=>{const Re=btoa(ne);$l.set(L,Re)},fe=async ne=>{ne.preventDefault(),$(""),se(!0);try{if(!I||I.length<4){$("يجب أن يكون الرقم السري 4 أرقام على الأقل"),se(!1);return}if(I!==w){$("الرقم السري الجديد وتأكيده غير متطابقين"),se(!1);return}if(F()){if(!j){$("يرجى إدخال الرقم السري الحالي لدرج النقدية"),se(!1);return}if(!ae(j)){$("الرقم السري الحالي لدرج النقدية غير صحيح"),se(!1);return}}Le(I),de({title:F()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:F()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),oe()}catch{$("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{se(!1)}},oe=()=>{D(""),s(""),W(""),$(""),O(!1),y(!1),P(!1),p(!1)};return e.jsx(je,{open:i,onOpenChange:oe,children:e.jsxs(Se,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Te,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[e.jsx(es,{className:"h-5 w-5 text-green-600"}),F()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:fe,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:F()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),F()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"currentPin",type:C?"text":"password",autoComplete:"off",value:j,onChange:ne=>D(ne.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>O(!C),children:C?e.jsx(Zs,{className:"h-4 w-4"}):e.jsx(us,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"newPin",type:M?"text":"password",autoComplete:"off",value:I,onChange:ne=>s(ne.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!M),children:M?e.jsx(Zs,{className:"h-4 w-4"}):e.jsx(us,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"confirmPin",type:N?"text":"password",autoComplete:"off",value:w,onChange:ne=>W(ne.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>P(!N),children:N?e.jsx(Zs,{className:"h-4 w-4"}):e.jsx(us,{className:"h-4 w-4"})})]})]}),Q&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(ur,{className:"h-4 w-4"}),Q]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:Y,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Fa,{className:"h-4 w-4 mr-2"}),Y?"جاري الحفظ...":F()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(x,{type:"button",variant:"outline",onClick:oe,disabled:Y,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}const Wl=new Map;function Ju({open:i,onOpenChange:p,userId:c}){const[j,D]=n.useState(""),[I,s]=n.useState(""),[w,W]=n.useState(""),[C,O]=n.useState(!1),[M,y]=n.useState(!1),[N,P]=n.useState(!1),[Q,$]=n.useState(""),[Y,se]=n.useState(!1),{toast:de}=da(),L=c?`wallet_total_pin_${c}`:"wallet_total_pin",F=()=>Wl.has(L),ae=ne=>{const Re=Wl.get(L);if(!Re)return!1;try{return atob(Re)===ne}catch{return!1}},Le=ne=>{const Re=btoa(ne);Wl.set(L,Re)},fe=async ne=>{ne.preventDefault(),$(""),se(!0);try{if(!I||I.length<4){$("يجب أن يكون الرقم السري 4 أرقام على الأقل"),se(!1);return}if(I!==w){$("الرقم السري الجديد وتأكيده غير متطابقين"),se(!1);return}if(F()){if(!j){$("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),se(!1);return}if(!ae(j)){$("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),se(!1);return}}Le(I),de({title:F()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:F()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),oe()}catch{$("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{se(!1)}},oe=()=>{D(""),s(""),W(""),$(""),O(!1),y(!1),P(!1),p(!1)};return e.jsx(je,{open:i,onOpenChange:oe,children:e.jsxs(Se,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Te,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[e.jsx(aa,{className:"h-5 w-5 text-blue-600"}),F()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:fe,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:F()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),F()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"currentPin",type:C?"text":"password",autoComplete:"off",value:j,onChange:ne=>D(ne.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>O(!C),children:C?e.jsx(Zs,{className:"h-4 w-4"}):e.jsx(us,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"newPin",type:M?"text":"password",autoComplete:"off",value:I,onChange:ne=>s(ne.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!M),children:M?e.jsx(Zs,{className:"h-4 w-4"}):e.jsx(us,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"confirmPin",type:N?"text":"password",autoComplete:"off",value:w,onChange:ne=>W(ne.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>P(!N),children:N?e.jsx(Zs,{className:"h-4 w-4"}):e.jsx(us,{className:"h-4 w-4"})})]})]}),Q&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(ur,{className:"h-4 w-4"}),Q]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:Y,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(Fa,{className:"h-4 w-4 mr-2"}),Y?"جاري الحفظ...":F()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(x,{type:"button",variant:"outline",onClick:oe,disabled:Y,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function Ku({open:i,onOpenChange:p,onSuccess:c,title:j,description:D,currentBalance:I,balanceLabel:s,userId:w}){const[W,C]=n.useState(""),[O,M]=n.useState(""),[y,N]=n.useState("add"),[P,Q]=n.useState(!1),[$,Y]=n.useState(""),[se,de]=n.useState(!1),[L,F]=n.useState(!1);n.useEffect(()=>{let oe=!0;return(async()=>{const ne=await Cs.hasMasterPin(w);oe&&F(ne)})(),()=>{oe=!1}},[w,i]);const ae=async oe=>{oe.preventDefault(),Y(""),de(!0);try{const ne=parseFloat(O);if(isNaN(ne)||ne<=0){Y("يرجى إدخال مبلغ صحيح أكبر من صفر"),de(!1);return}if(y==="subtract"&&ne>I){Y("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),de(!1);return}if(L)if(await Cs.verifyMasterPin(W,w)){const Ye=y==="add"?ne:-ne;Le(),c(Ye)}else Y("الرقم السري غير صحيح");else Y("لم يتم تعيين الرقم السري الرئيسي. يرجى تعيينه من إعدادات البروفيل أولاً")}catch{Y("حدث خطأ أثناء التحقق من الرقم السري")}finally{de(!1)}},Le=()=>{C(""),M(""),N("add"),Y(""),p(!1)},fe=()=>{const oe=parseFloat(O)||0;return y==="add"?I+oe:I-oe};return e.jsx(je,{open:i,onOpenChange:Le,children:e.jsxs(Se,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Te,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[y==="add"?e.jsx(Ut,{className:"h-5 w-5 text-green-600"}):e.jsx(hr,{className:"h-5 w-5 text-red-600"}),j]})}),e.jsxs("form",{onSubmit:ae,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:D}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(Z,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[I.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(x,{type:"button",variant:y==="add"?"default":"outline",onClick:()=>N("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(Ut,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(x,{type:"button",variant:y==="subtract"?"default":"outline",onClick:()=>N("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(hr,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Z,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",y==="add"?"إضافته":"خصمه"]}),e.jsx(z,{id:"amount",type:"number",step:"0.01",min:"0.01",value:O,onChange:oe=>M(oe.target.value),placeholder:`أدخل المبلغ المراد ${y==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),O&&!isNaN(parseFloat(O))&&e.jsxs("div",{className:`p-3 rounded-lg ${y==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(Z,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${y==="add"?"text-green-700":"text-red-700"}`,children:[fe().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"pin",type:P?"text":"password",autoComplete:"off",value:W,onChange:oe=>C(oe.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>Q(!P),children:P?e.jsx(Zs,{className:"h-4 w-4"}):e.jsx(us,{className:"h-4 w-4"})})]})]}),$&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(ur,{className:"h-4 w-4"}),$]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(x,{type:"button",variant:"outline",onClick:Le,className:"flex-1",children:"إلغاء"}),e.jsx(x,{type:"submit",disabled:se||!W||!O,className:`flex-1 ${y==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:se?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Fa,{className:"h-4 w-4 mr-2"}),y==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}const Ec={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_APP_VERSION:"0.0.0",VITE_DEV_MODE:"true",VITE_ENABLE_OFFLINE_PERSISTENCE:"false",VITE_FIREBASE_API_KEY:["AI","za","SyA33RTf43u2QE2OsK1RepQHSKrSet9ZI0s"].join(""),VITE_FIREBASE_APP_ID:"1:483702062341:web:b1ff06ad175cb7ae428b6c",VITE_FIREBASE_AUTH_DOMAIN:"voda-c6abd.firebaseapp.com",VITE_FIREBASE_AUTH_EMULATOR_URL:"http://localhost:9099",VITE_FIREBASE_FIRESTORE_EMULATOR_HOST:"localhost:8080",VITE_FIREBASE_FUNCTIONS_EMULATOR_HOST:"localhost:5001",VITE_FIREBASE_MEASUREMENT_ID:"G-CV6QGH7G7P",VITE_FIREBASE_MESSAGING_SENDER_ID:"483702062341",VITE_FIREBASE_PROJECT_ID:"voda-c6abd",VITE_FIREBASE_STORAGE_BUCKET:"voda-c6abd.appspot.com",VITE_FORCE_HASH_ROUTER:"true",VITE_SHOP_ID:"demo-shop-001",VITE_SHOP_NAME:"محل كاشي لينك التجريبي",VITE_SHOW_ENV_BANNER:"true",VITE_USE_EMULATORS:"false",VITE_USE_FIREBASE_EMULATOR:"false"},Va=i=>typeof i=="string"&&i.trim().length>0,Yu={getCurrentMonthId(){const i=new Date;return`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}`},async getWalletUsage(i){var p;try{if(!Va(i))return console.error("Error getting wallet usage: invalid walletId",i),null;const c=Ue(V,"walletLimits",i),j=await Ps(c);if(j.exists()){const I=j.data();return{walletId:i,used_transfer:I.monthlyTransferUsed??I.used_transfer??0,used_withdraw:I.monthlyWithdrawUsed??I.used_withdraw??0,monthly_limit:I.monthlyLimit??I.monthlyTransferLimit??I.monthlyWithdrawLimit??2e5,last_reset:I.lastMonthlyReset??I.last_reset??null,updatedAt:I.updatedAt||dr.now()}}const D={walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:dr.now()};return await sa(c,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,monthlyTransferLimit:2e5,monthlyWithdrawLimit:2e5,lastMonthlyReset:null,updatedAt:yt(),ownerId:(p=Pr.currentUser)==null?void 0:p.uid}),D}catch(c){return console.error("Error getting wallet usage:",c),{walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:dr.now()}}},shouldResetLimits(i){const p=new Date,c=p.getDate();if(!i)return c===1;if(c===1){const j=i.toDate(),D=p.getMonth(),I=p.getFullYear();return j.getMonth()!==D||j.getFullYear()!==I}return!1},async autoResetLimitsIfNeeded(i){try{if(!Va(i))return console.error("خطأ في التصفير التلقائي للحدود: walletId غير صالح",i),!1;typeof import.meta<"u";const p=await this.getWalletUsage(i);return p&&this.shouldResetLimits(p.last_reset)?(console.log(`🔄 تصفير تلقائي للحدود للمحفظة ${i} - اليوم الأول من الشهر`),await this.resetWalletUsage(i)):!1}catch(p){return console.error("خطأ في التصفير التلقائي للحدود:",p),!1}},async resetWalletUsage(i){try{if(!Va(i))return console.error("خطأ في تصفير استخدام المحفظة: walletId غير صالح",i),!1;const p=Ue(V,"walletLimits",i);return await sa(p,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:yt(),updatedAt:yt()},{merge:!0}),console.log(`🔄 تم تصفير استخدام المحفظة ${i} بنجاح`),!0}catch(p){return console.error("خطأ في تصفير استخدام المحفظة:",p),!1}},async calculateUsageFromTransactions(i){var p,c;try{if(!Va(i))return console.error("خطأ في حساب الاستخدام من المعاملات: walletId غير صالح",i),{used_transfer:0,used_withdraw:0};const j=Ue(V,"walletLimits",i),D=new Date;let I=dr.fromDate(new Date(D.getFullYear(),D.getMonth(),1));try{const O=await Ps(j);I=O.exists()?((p=O.data())==null?void 0:p.lastMonthlyReset)??((c=O.data())==null?void 0:c.last_reset)??I:I}catch{}const s=Ge(ke(V,"tx"),me("uid","==",i),...I?[me("createdAt",">=",I)]:[]),w=await He(s);let W=0,C=0;return w.forEach(O=>{const M=O.data();M.status==="completed"&&(M.type==="transfer"?W+=M.amount:M.type==="withdraw"&&(C+=M.amount))}),{used_transfer:W,used_withdraw:C}}catch(j){return console.error("خطأ في حساب الاستخدام من المعاملات:",j),{used_transfer:0,used_withdraw:0}}},async getWalletUsageWithRefresh(i){var p,c;try{if(!Va(i))return console.error("خطأ في الحصول على الاستخدام مع التحديث: walletId غير صالح",i),null;typeof import.meta<"u";const j=await this.getWalletUsage(i);if(!j){const I=await this.calculateUsageFromTransactions(i),s=Ue(V,"walletLimits",i);try{await sa(s,{monthlyTransferUsed:I.used_transfer,monthlyWithdrawUsed:I.used_withdraw,updatedAt:yt(),ownerId:(p=Pr.currentUser)==null?void 0:p.uid},{merge:!0})}catch{}return{walletId:i,used_transfer:I.used_transfer,used_withdraw:I.used_withdraw,monthly_limit:2e5,last_reset:null,updatedAt:dr.now()}}const D=await this.calculateUsageFromTransactions(i);if(j.used_transfer!==D.used_transfer||j.used_withdraw!==D.used_withdraw){const I=Ue(V,"walletLimits",i);try{await sa(I,{monthlyTransferUsed:D.used_transfer,monthlyWithdrawUsed:D.used_withdraw,updatedAt:yt(),ownerId:(c=Pr.currentUser)==null?void 0:c.uid},{merge:!0})}catch{}return await this.getWalletUsage(i)}return j}catch(j){return console.error("خطأ في الحصول على الاستخدام مع التحديث:",j),{walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:dr.now()}}},calculateRemaining(i){return{remainingTransfer:Math.max(0,i.monthly_limit-i.used_transfer),remainingWithdraw:Math.max(0,i.monthly_limit-i.used_withdraw)}},async canPerformOperation(i,p,c){try{if(!Va(i))return console.error("Error checking operation limits: invalid walletId",i),{canPerform:!1,message:"walletId غير صالح"};const j=await this.getWalletUsageWithRefresh(i);if(!j)return{canPerform:!1,message:"لا يمكن العثور على بيانات الاستخدام للمحفظة"};const D=this.calculateRemaining(j);return c==="transfer"&&p>D.remainingTransfer?{canPerform:!1,message:`تجاوز حد التحويل المسموح. المتبقي: ${D.remainingTransfer.toLocaleString()} ج.م من أصل ${j.monthly_limit.toLocaleString()} ج.م`,remaining:D.remainingTransfer}:c==="withdraw"&&p>D.remainingWithdraw?{canPerform:!1,message:`تجاوز حد السحب المسموح. المتبقي: ${D.remainingWithdraw.toLocaleString()} ج.م من أصل ${j.monthly_limit.toLocaleString()} ج.م`,remaining:D.remainingWithdraw}:{canPerform:!0}}catch(j){return console.error("Error checking operation limits:",j),{canPerform:!1,message:"خطأ في التحقق من الحدود"}}},async updateUsage(i,p,c){var j;try{if(!Va(i))throw new Error("walletId غير صالح");const D=await this.getWalletUsageWithRefresh(i);if(!D)throw new Error("لا يمكن العثور على بيانات الاستخدام للمحفظة");const I=await this.canPerformOperation(i,p,c);if(!I.canPerform)throw new Error(I.message||"لا يمكن إجراء العملية");const s=c==="transfer"?D.used_transfer+p:D.used_transfer,w=c==="withdraw"?D.used_withdraw+p:D.used_withdraw,W=Ue(V,"walletLimits",D.walletId);try{await sa(W,{monthlyTransferUsed:s,monthlyWithdrawUsed:w,updatedAt:yt(),ownerId:(j=Pr.currentUser)==null?void 0:j.uid},{merge:!0})}catch{}let C=await this.getWalletUsageWithRefresh(i);return C||(C={walletId:i,used_transfer:s,used_withdraw:w,monthly_limit:D.monthly_limit,last_reset:D.last_reset,updatedAt:dr.now()}),C}catch(D){throw console.error("Error updating wallet usage:",D),D}},async resetWalletUsageManually(i){try{if(!Va(i))throw new Error("walletId غير صالح");const p=Ue(V,"walletLimits",i),c={walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:0,last_reset:null,updatedAt:new Date};return sa(p,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:yt(),updatedAt:yt()},{merge:!0}).catch(j=>{console.error("خطأ في حفظ تصفير الاستخدام في Firebase:",j)}),console.log(`✅ تم تصفير استخدام المحفظة ${i} بنجاح`),c}catch(p){throw console.error("Error resetting wallet usage:",p),p}},async getAllWalletsUsage(i){try{const c=(await xa.getByMerchantId(i)).map(D=>this.getWalletUsageWithRefresh(D.id));return(await Promise.all(c)).filter(D=>D!==null)}catch(p){return console.error("Error getting all wallets usage:",p),[]}}};function Hu(i){return i?`readBroadcastIds_${i}`:"readBroadcastIds_guest"}function Qu({className:i}){const{user:p,profile:c,isSubscriptionActive:j}=Ia(),D=Uc(),[I,s]=n.useState([]),[w,W]=n.useState(new Set),[C,O]=n.useState(!1),[M,y]=n.useState(""),[N,P]=n.useState(!1),[Q,$]=n.useState(null),[Y,se]=n.useState("none"),[de,L]=n.useState(null),[F,ae]=n.useState(!1),Le=n.useRef(new Set);n.useRef(!1);const fe=n.useRef(!0),oe=n.useRef(null),ne=n.useRef(null),Re=n.useRef(null),[Ye,Ve]=n.useState({position:"fixed",top:0,left:0,zIndex:1e4}),Ze=n.useMemo(()=>{const le=["global"];return p!=null&&p.uid&&le.push(`user:${p.uid}`),c!=null&&c.shopId&&le.push(`shop:${c.shopId}`),le},[p==null?void 0:p.uid,c==null?void 0:c.shopId]),ht=Hu(p==null?void 0:p.uid),Ot=n.useMemo(()=>{var $e;const le=($e=D==null?void 0:D.pathname)==null?void 0:$e.includes("/user/pending-approval");return!!(p!=null&&p.uid)&&!le},[p==null?void 0:p.uid,D==null?void 0:D.pathname]);n.useEffect(()=>{try{const le=localStorage.getItem(ht);if(le){const Me=JSON.parse(le);Array.isArray(Me)&&W(new Set(Me.filter(Boolean)))}else W(new Set)}catch(le){console.warn("Failed to load read ids",le),W(new Set)}},[ht]),n.useEffect(()=>{if(!Ot){s([]);return}fe.current=!0;const le=()=>{hu(Ze,$e=>{if(fe.current){const ve=Date.now(),Be=60*1e3,tt=$e.filter(re=>{var R,Ct;const Je=(R=re.createdAt)!=null&&R.toMillis?re.createdAt.toMillis():(Ct=re.createdAt)!=null&&Ct.seconds?re.createdAt.seconds*1e3:0;return!(ve-Je<Be)}).map(re=>re.id).filter(Boolean);Le.current=new Set(tt),fe.current=!1}s($e)})};le();const Me=$e=>{console.log("🔔 OneSignal Notification received",$e);try{const ve=$e.notification||$e;if(ve&&(ve.title||ve.body)){const Be={id:`temp_${Date.now()}`,title:ve.title||"إشعار جديد",message:ve.body||ve.message||"",audienceKey:"global",active:!0,createdAt:{toMillis:()=>Date.now(),seconds:Math.floor(Date.now()/1e3),nanoseconds:0}};L(Be),ae(!0),oe.current&&clearTimeout(oe.current),oe.current=window.setTimeout(()=>{ae(!1),L(null)},5e3)}}catch(ve){console.error("Error parsing OneSignal event for instant alert",ve)}le()};try{const $e=window.OneSignal;$e&&$e.Notifications&&$e.Notifications.addEventListener&&$e.Notifications.addEventListener("foregroundWillDisplay",Me)}catch($e){console.error("Failed to add OneSignal listener",$e)}return()=>{try{const $e=window.OneSignal;$e&&$e.Notifications&&$e.Notifications.removeEventListener&&$e.Notifications.removeEventListener("foregroundWillDisplay",Me)}catch{}}},[Ze,Ot]),n.useEffect(()=>{const le=new Set(I.map($e=>$e.id).filter(Boolean)),Me=I.filter($e=>$e.id&&!Le.current.has($e.id));Me.length>0&&(L(Me[0]),ae(!0),oe.current&&clearTimeout(oe.current),oe.current=window.setTimeout(()=>{ae(!1),L(null)},5e3)),Le.current=le},[I]),n.useEffect(()=>()=>{oe.current&&clearTimeout(oe.current)},[]);const X=I.reduce((le,Me)=>le+(Me.id&&!w.has(Me.id)?1:0),0),Ae=le=>{if(!le||w.has(le))return;const Me=new Set(w);Me.add(le),W(Me);try{localStorage.setItem(ht,JSON.stringify(Array.from(Me)))}catch{}},st=()=>{const le=I.map($e=>$e.id).filter(Boolean),Me=new Set(w);le.forEach($e=>Me.add($e)),W(Me);try{localStorage.setItem(ht,JSON.stringify(Array.from(Me)))}catch{}},Dt=(le,Me)=>{var $e;if(le)try{const ve=(($e=yi)==null?void 0:$e.isNativePlatform)&&yi.getPlatform()==="android",Be=/\.apk(\?|$)/i.test(le);if(ve&&Be){const tt=`cashy://update?url=${encodeURIComponent(le)}`;window.location.href=tt}else window.open(le,"_blank")}catch{try{window.open(le,"_blank")}catch{}}Me&&Ae(Me)},Pt=()=>{if(!ne.current||!Re.current)return;const le=ne.current.getBoundingClientRect(),Me=8,$e=Re.current.offsetWidth||320,ve=le.bottom+Me;let Be=le.right-$e;const tt=window.innerWidth;Be=Math.min(Math.max(Be,Me),tt-$e-Me),Ve(re=>({...re,top:ve,left:Be}))};n.useEffect(()=>{if(!F)return;Pt();const le=()=>Pt();return window.addEventListener("resize",le),window.addEventListener("scroll",le,!0),()=>{window.removeEventListener("resize",le),window.removeEventListener("scroll",le,!0)}},[F]);const xs=async()=>{if(!(p!=null&&p.uid)){alert("يرجى تسجيل الدخول لإرسال الطلب.");return}const le=M.trim();if(!le){alert("يرجى كتابة سبب طلب التحدث.");return}try{P(!0),$(null);const Me=c!=null&&c.fullName&&c.fullName.trim()?c.fullName.trim():p.email?p.email.split("@")[0]:"مستخدم",$e=(c==null?void 0:c.phone)||null;await ca(ke(V,"waiting_list"),{userId:p.uid,name:Me,phone:$e,reason:le,status:"pending",createdAt:yt()}),$("تم إرسال طلبك إلى قائمة الانتظار بنجاح ✅"),y(""),setTimeout(()=>O(!1),900)}catch(Me){console.error("فشل إرسال طلب قائمة الانتظار:",Me),alert("حدث خطأ أثناء إرسال الطلب. حاول مرة أخرى.")}finally{P(!1)}};return n.useEffect(()=>{if(!(p!=null&&p.uid)){se("none");return}(async()=>{try{const Me=Ge(ke(V,"waiting_list"),me("userId","==",p.uid)),ve=(await He(Me)).docs.map(re=>({id:re.id,...re.data()})).sort((re,Je)=>{var Ct,_t,U,xe,We,ut;const ee=((_t=(Ct=re==null?void 0:re.createdAt)==null?void 0:Ct.toMillis)==null?void 0:_t.call(Ct))??((U=re==null?void 0:re.createdAt)==null?void 0:U.seconds)*1e3??0;return(((We=(xe=Je==null?void 0:Je.createdAt)==null?void 0:xe.toMillis)==null?void 0:We.call(xe))??((ut=Je==null?void 0:Je.createdAt)==null?void 0:ut.seconds)*1e3??0)-ee});if(ve.length===0){se("none");return}const Be=ve[0],tt=(Be==null?void 0:Be.contacted)===!0||(Be==null?void 0:Be.status)==="contacted";se(tt?"contacted":"pending")}catch(Me){console.warn("⚠️ فشل جلب حالة waiting_list:",Me),se("none")}})()},[p==null?void 0:p.uid]),Ot?e.jsxs("div",{className:`relative inline-flex items-center gap-2 ${i||""}`,ref:ne,children:[e.jsxs(xu,{onOpenChange:le=>{le&&X>0&&st()},children:[e.jsx(pu,{asChild:!0,children:e.jsx(x,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:e.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[e.jsx(Ol,{className:"h-4 w-4 text-primary"}),X>0&&e.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:X})]})})}),e.jsxs(gu,{className:"w-80",align:"end",forceMount:!0,children:[e.jsxs(fu,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"الإشعارات"}),I.length>0&&e.jsxs(x,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:st,children:[e.jsx(Lr,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),e.jsx(yu,{}),I.length===0?e.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):e.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:I.map(le=>{const Me=le.id?!w.has(le.id):!1;return e.jsx("div",{className:`px-2 py-2 rounded-md ${Me?"bg-primary/5":""}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Ol,{className:`h-4 w-4 ${Me?"text-primary":"text-muted-foreground"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium",children:le.title||"إشعار"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:le.message}),le.linkUrl&&e.jsxs(x,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>Dt(le.linkUrl,le.id),children:["فتح الرابط ",e.jsx(mu,{className:"h-3 w-3 ml-1"})]})]}),Me?e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Ae(le.id),title:"تمييز كمقروء",children:e.jsx(Lr,{className:"h-4 w-4 text-primary"})}):e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:e.jsx(Lr,{className:"h-4 w-4 text-muted-foreground"})})]})},le.id)})})]})]}),e.jsxs(je,{open:C,onOpenChange:O,children:[e.jsx(Ph,{asChild:!0,children:e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full hover:bg-transparent focus:ring-1 focus:ring-primary/60 focus:ring-offset-1",title:"قائمة الانتظار",children:e.jsx(Da,{className:`h-4 w-4 ${Y==="pending"?"text-red-600":Y==="contacted"?"text-green-600":"text-muted-foreground"}`})})}),e.jsxs(Se,{className:"max-w-md border border-purple-200/50 shadow-xl bg-gradient-to-br from-purple-50 to-blue-50",children:[e.jsxs(Te,{children:[e.jsx(De,{children:"طلب التحدث"}),e.jsx(rs,{children:"يرجى كتابة سبب طلب التحدث ليصل للإدارة في قسم قائمة الانتظار."})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"سبب الطلب"}),e.jsx(uu,{value:M,onChange:le=>y(le.target.value),placeholder:"اكتب سبب طلب التحدث هنا...",className:"min-h-[120px] text-right"}),Q&&e.jsx("div",{className:"text-sm text-green-700 bg-green-50 border border-green-200 rounded-md p-2",children:Q})]}),e.jsxs(mt,{children:[e.jsx(x,{variant:"outline",onClick:()=>O(!1),disabled:N,children:"إلغاء"}),e.jsx(x,{onClick:xs,disabled:N,className:"bg-gradient-to-r from-green-600 to-emerald-600 text-white",children:N?"جارٍ الإرسال...":"إرسال"})]})]})]}),de&&kh.createPortal(e.jsx("div",{ref:Re,style:Ye,className:`pointer-events-auto transition-all duration-300 ${F?"opacity-100 translate-y-0":"opacity-0 -translate-y-3"}`,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl border border-gray-200 p-4 w-80 max-w-[calc(100vw-16px)] flex items-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(Ol,{className:"w-4 h-4 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-semibold",children:de.title||"إشعار جديد"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:de.message}),de.linkUrl&&e.jsx(x,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>Dt(de.linkUrl,de.id),children:"فتح الرابط"})]})]})}),document.body)]}):null}function Gu({isOpen:i,onClose:p}){const[c,j]=n.useState("0"),[D,I]=n.useState(null),[s,w]=n.useState(null),[W,C]=n.useState(!1),O=L=>{W?(j(L),C(!1)):j(c==="0"?L:c+L)},M=L=>{const F=parseFloat(c);if(D===null)I(F);else if(s){const Le=y(D||0,F,s);j(String(Le)),I(Le)}C(!0),w(L)},y=(L,F,ae)=>{switch(ae){case"+":return L+F;case"-":return L-F;case"×":return L*F;case"÷":return F===0?0:L/F;case"=":return F;default:return F}},N=()=>{const L=parseFloat(c);if(D!==null&&s){const F=y(D,L,s);j(String(F)),I(null),w(null),C(!0)}},P=()=>{j("0"),I(null),w(null),C(!1)},Q=()=>{j("0")},$=()=>{W?(j("0."),C(!1)):c.indexOf(".")===-1&&j(c+".")},Y=()=>{c!=="0"&&j(c.charAt(0)==="-"?c.slice(1):"-"+c)},se=()=>{const L=parseFloat(c);j(String(L/100))},de=L=>{const F=L.key;L.preventDefault(),F>="0"&&F<="9"?O(F):F==="+"?M("+"):F==="-"?M("-"):F==="*"?M("×"):F==="/"?M("÷"):F==="Enter"||F==="="?N():F==="Escape"||F==="c"||F==="C"?P():F==="Backspace"?Q():F==="."?$():F==="%"&&se()};return n.useEffect(()=>(i?document.addEventListener("keydown",de):document.removeEventListener("keydown",de),()=>{document.removeEventListener("keydown",de)}),[i,c,D,s,W]),e.jsx(je,{open:i,onOpenChange:L=>!L&&p(),children:e.jsxs(Se,{className:"sm:max-w-md",children:[e.jsx(Te,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[e.jsx(Xc,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:c})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:P,children:"AC"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:Q,children:"CE"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:se,children:"%"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>M("÷"),children:"÷"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>O("7"),children:"7"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>O("8"),children:"8"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>O("9"),children:"9"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>M("×"),children:"×"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>O("4"),children:"4"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>O("5"),children:"5"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>O("6"),children:"6"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>M("-"),children:"-"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>O("1"),children:"1"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>O("2"),children:"2"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>O("3"),children:"3"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>M("+"),children:"+"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>O("0"),children:"0"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:$,children:"."}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:N,children:"="})]}),e.jsx(x,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:Y,children:"+/-"})]})]})})}const pi=n.forwardRef(({className:i,...p},c)=>e.jsx("div",{className:"relative w-full overflow-auto",children:e.jsx("table",{ref:c,className:hs("w-full caption-bottom text-sm",i),...p})}));pi.displayName="Table";const gi=n.forwardRef(({className:i,...p},c)=>e.jsx("thead",{ref:c,className:hs("[&_tr]:border-b",i),...p}));gi.displayName="TableHeader";const fi=n.forwardRef(({className:i,...p},c)=>e.jsx("tbody",{ref:c,className:hs("[&_tr:last-child]:border-0",i),...p}));fi.displayName="TableBody";const Zu=n.forwardRef(({className:i,...p},c)=>e.jsx("tfoot",{ref:c,className:hs("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",i),...p}));Zu.displayName="TableFooter";const mr=n.forwardRef(({className:i,...p},c)=>e.jsx("tr",{ref:c,className:hs("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",i),...p}));mr.displayName="TableRow";const Kt=n.forwardRef(({className:i,...p},c)=>e.jsx("th",{ref:c,className:hs("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",i),...p}));Kt.displayName="TableHead";const Yt=n.forwardRef(({className:i,...p},c)=>e.jsx("td",{ref:c,className:hs("p-4 align-middle [&:has([role=checkbox])]:pr-0",i),...p}));Yt.displayName="TableCell";const Xu=n.forwardRef(({className:i,...p},c)=>e.jsx("caption",{ref:c,className:hs("mt-4 text-sm text-muted-foreground",i),...p}));Xu.displayName="TableCaption";function ex({isOpen:i,onClose:p,initialBarcode:c}){const[j,D]=n.useState([]),[I,s]=n.useState({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),[w,W]=n.useState(!1),[C,O]=n.useState(null),{toast:M}=da(),{user:y,profile:N}=Ia(),{isShiftActive:P,shiftUser:Q}=In(),{shopId:$}=Ni(),[Y,se]=n.useState([]),[de,L]=n.useState({}),[F,ae]=n.useState({}),[Le,fe]=n.useState({}),[oe,ne]=n.useState(""),[Re,Ye]=n.useState(!1),[Ve,Ze]=n.useState({}),[ht,Ot]=n.useState(!1),[X,Ae]=n.useState(!0),[st,Dt]=n.useState(!1),Pt=Ke.useRef(""),xs=Ke.useRef(0),[le,Me]=n.useState(0),[$e,ve]=n.useState(0),[Be,tt]=n.useState(!1),[re,Je]=n.useState(!0),[ee,R]=n.useState(!1),[Ct,_t]=n.useState(!1),[U,xe]=n.useState(!0),[We,ut]=n.useState(!0),[gt,ps]=n.useState({}),[ns,Lt]=n.useState(!1),[ot,It]=n.useState("التحقق قبل العملية"),[qt,_s]=n.useState("أدخل الرقم السري الرئيسي للمتابعة"),gs=Ke.useRef(null),ts=(d,_,B)=>{It(d),_s(_),gs.current=B,Lt(!0)},[Aa,Us]=n.useState([]),[fa,Is]=n.useState(!1),[ra,k]=n.useState(""),[ie,_e]=n.useState(""),[Xe,Fe]=n.useState(""),[ct,H]=n.useState(null);n.useEffect(()=>{(async()=>{try{if(!i||!(y!=null&&y.uid))return;const d=await Ie.getUserData(y.uid),_=Array.isArray(d==null?void 0:d.customers)?d.customers.map(B=>({id:String(B.id||""),name:String(B.name||""),mobile:B.mobile||void 0})):[];Us(_)}catch{}})()},[i,y==null?void 0:y.uid]);const[qe,rt]=n.useState(!1),[At,ss]=n.useState(null),[is,qs]=n.useState(null),Os=(d,_)=>{ss(d),qs(_),rt(!0)},[zs,Xa]=n.useState(""),Vs=n.useMemo(()=>{const d=zs.trim().toLowerCase();return d?Y.filter(_=>_.name.toLowerCase().includes(d)):Y},[Y,zs]),[Wr,na]=n.useState(!1),[q,Oe]=n.useState(null),[Tt,ft]=n.useState("1"),fs=d=>{Oe(d),ft("1"),na(!0)},Qt=()=>{if(!q)return;const d=parseInt(Tt);d>0&&(na(!1),ts("إضافة مخزون",`إضافة ${d} قطع للمنتج ${q.name}`,async()=>{try{const _=q.quantity+d;await Xt(Ue(V,"products",q.id),{quantity:_,updatedAt:yt()}),se(B=>B.map(te=>te.id===q.id?{...te,quantity:_}:te)),M({title:"تمت الإضافة",description:`تمت إضافة ${d} قطعة`})}catch(_){console.error(_)}}))};n.useEffect(()=>{i&&(y!=null&&y.uid)&&(xr(),re||Ls())},[i,y==null?void 0:y.uid,re]),n.useEffect(()=>{if(!i)return;const d=_=>{var we;const B=_.target,te=(we=B==null?void 0:B.tagName)==null?void 0:we.toLowerCase();if(te==="input"||te==="textarea"||!!(B&&B.isContentEditable)||ns||Be||st)return;const ce=Date.now();if(_.key==="Enter"){const Pe=(Pt.current||"").trim();Pt.current="",Pe&&gr(Pe);return}_.key.length===1&&(ce-(xs.current||0)>100&&(Pt.current=""),Pt.current+=_.key,xs.current=ce)};return window.addEventListener("keydown",d),()=>window.removeEventListener("keydown",d)},[i,Y,ns,Be,st]),n.useEffect(()=>{i&&c&&gr(c)},[i,c]);const ys=async()=>{if(!(y!=null&&y.uid))return;const d=(N==null?void 0:N.shopId)||$||"main",_=`shopProducts_${y.uid}_${d}`;try{const B=localStorage.getItem(_);if(B){const te=JSON.parse(B);Array.isArray(te)&&te.length>0&&se(te)}}catch(B){console.warn("Failed to load products from cache",B)}try{let B,te=[];if(N!=null&&N.shopId){const he=Ge(ke(V,"products"),me("shopId","==",N.shopId),me("userId","==",y.uid));if(B=await He(he),te=B.docs.map(ce=>({id:ce.id,name:String(ce.data().name??""),sellingPrice:Number(ce.data().sellingPrice??0),wholesalePrice:Number(ce.data().wholesalePrice??0),quantity:Number(ce.data().quantity??0),barcode:String(ce.data().barcode??""),serialNumber:String(ce.data().serialNumber??"")})),te.length===0){const ce=Ge(ke(V,"products"),me("userId","==",y.uid)),Pe=(await He(ce)).docs.map(ye=>({id:ye.id,name:String(ye.data().name??""),sellingPrice:Number(ye.data().sellingPrice??0),wholesalePrice:Number(ye.data().wholesalePrice??0),quantity:Number(ye.data().quantity??0),barcode:String(ye.data().barcode??""),serialNumber:String(ye.data().serialNumber??"")}));Pe.length>0&&(te=Pe,M({title:"تم استرجاع المنتجات",description:"عثرنا على منتجات محفوظة لك خارج المتجر الحالي وقمنا بعرضها."}))}}else{const he=Ge(ke(V,"products"),me("userId","==",y.uid));B=await He(he),te=B.docs.map(ce=>({id:ce.id,name:String(ce.data().name??""),sellingPrice:Number(ce.data().sellingPrice??0),wholesalePrice:Number(ce.data().wholesalePrice??0),quantity:Number(ce.data().quantity??0),barcode:String(ce.data().barcode??""),serialNumber:String(ce.data().serialNumber??"")}))}se(te);try{localStorage.setItem(_,JSON.stringify(te))}catch{}if(N!=null&&N.shopId&&te.length>0){const he=te.filter(ce=>{const we=((B==null?void 0:B.docs)||[]).find(ye=>ye.id===ce.id);return!(!!we&&!!we.data().shopId)});if(he.length>0)try{await Promise.all(he.map(ce=>Xt(Ue(V,"products",ce.id),{shopId:N.shopId,updatedAt:yt()}))),M({title:"تم ترتيب المنتجات",description:"تم ربط بعض المنتجات غير المربوطة بمتجرك الحالي تلقائياً."})}catch(ce){console.warn("تعذّر ترحيل shopId لبعض المنتجات:",ce)}}}catch(B){console.error("Error loading shop products:",B)}};n.useEffect(()=>{i&&(y!=null&&y.uid)&&(ys(),Ls(),xr(),js())},[i,y==null?void 0:y.uid,N==null?void 0:N.shopId]);const Ta=()=>{const d=new Date,_=d.getFullYear(),B=String(d.getMonth()+1).padStart(2,"0"),te=String(d.getDate()).padStart(2,"0");return`${_}-${B}-${te}`},Es=d=>{const _=B=>{if(typeof B.createdAtMs=="number")return B.createdAtMs;const te=parseInt(B.id,10);if(!isNaN(te))return te;const he=new Date(B.date);return isNaN(he.getTime())?0:he.getTime()};return[...d].sort((B,te)=>_(te)-_(B))},xr=()=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot load sales data");return}const d=$||(N==null?void 0:N.shopId)||"main",_=`salesData_all_${y.uid}_${d}`,B=localStorage.getItem(_);if(B)try{const Ce=JSON.parse(B);D(Array.isArray(Ce)?Es(Ce):[]);return}catch{}const te=Ta(),he=`salesData_${y.uid}_${d}_${te}`,ce=localStorage.getItem(he);if(ce){const Ce=JSON.parse(ce),pe=Array.isArray(Ce)?Es(Ce):[];D(pe);try{localStorage.setItem(_,JSON.stringify(pe))}catch{}return}const we=new Date().toISOString().split("T")[0],Pe=`salesData_${y.uid}_${d}_${we}`,ye=localStorage.getItem(Pe);if(ye){const Ce=JSON.parse(ye),pe=Array.isArray(Ce)?Es(Ce):[];D(pe);try{localStorage.setItem(he,JSON.stringify(pe)),localStorage.setItem(_,JSON.stringify(pe))}catch{}return}nt()},Fr=d=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot save sales data");return}const _=$||(N==null?void 0:N.shopId)||"main",B=Ta(),te=`salesData_${y.uid}_${_}_${B}`,he=`salesData_all_${y.uid}_${_}`,ce=Es(d);localStorage.setItem(te,JSON.stringify(ce));try{const we=localStorage.getItem(he),Pe=we?JSON.parse(we):[],ye={};[...Array.isArray(Pe)?Pe:[],...ce].forEach(Nt=>{ye[Nt.id]=Nt});const Ce=Object.values(ye),pe=Es(Ce);localStorage.setItem(he,JSON.stringify(pe))}catch{}D(ce)},xt=d=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot save sales data");return}const _=$||(N==null?void 0:N.shopId)||"main",B=`salesData_all_${y.uid}_${_}`;try{const he=localStorage.getItem(B),ce=he?JSON.parse(he):[],we={};[...Array.isArray(ce)?ce:[],...d].forEach(Ce=>{we[Ce.id]=Ce});const Pe=Object.values(we),ye=Es(Pe);localStorage.setItem(B,JSON.stringify(ye))}catch{}const te=Es(d);D(te)},nt=async()=>{if(y!=null&&y.uid)try{const d=$||(N==null?void 0:N.shopId)||null,_=new Date().toISOString().split("T")[0],B=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date);let te,he;try{const Ce=Ge(ke(V,"dailySales"),me("userId","==",y.uid),...d?[me("shopId","==",d)]:[]);te=await He(Ce)}catch{}try{const Ce=Ge(ke(V,"users",y.uid,"dailySales"),...d?[me("shopId","==",d)]:[]);he=await He(Ce)}catch{}const we=[...te?te.docs:[],...he?he.docs:[]].map(Ce=>{var Nt,ls;const pe=Ce.data();return{id:String(pe.clientId||Ce.id),firestoreId:Ce.id,productName:String(pe.productName||""),price:Number(pe.sellingPrice||0),wholesalePrice:pe.wholesalePrice!==void 0?Number(pe.wholesalePrice):null,quantity:Number(pe.quantity||0),date:String(pe.date||_),time:String(pe.time||""),serialNumber:pe.serialNumber||void 0,barcode:pe.barcode||void 0,performedByType:pe.performedByType||void 0,performedByName:pe.performedByName||void 0,performedByUsername:pe.performedByUsername||void 0,isDeferred:!!pe.isDeferred,customerName:pe.customerName||void 0,customerMobile:pe.customerMobile||void 0,customerId:pe.customerId||void 0,createdAtMs:(ls=(Nt=pe==null?void 0:pe.createdAt)==null?void 0:Nt.toDate)!=null&&ls.call(Nt)?pe.createdAt.toDate().getTime():new Date(String(pe.date||_)).getTime()}}),Pe={};[...j,...we].forEach(Ce=>{Pe[Ce.id]=Ce});const ye=Object.values(Pe);xt(ye)}catch{}},Ls=async()=>{if(y!=null&&y.uid)try{const d=new Date,_=new Date(d.getFullYear(),d.getMonth(),1),B=new Date(d.getFullYear(),d.getMonth()+1,0),te=pe=>pe.toISOString().split("T")[0],he=te(_),ce=te(B),we=$||(N==null?void 0:N.shopId)||null;let Pe;try{const pe=Ge(ke(V,"dailySales"),me("userId","==",y.uid),...we?[me("shopId","==",we)]:[]);Pe=await He(pe)}catch{const pe=Ge(ke(V,"users",y.uid,"dailySales"),...we?[me("shopId","==",we)]:[]);Pe=await He(pe)}let ye=0,Ce=0;Pe.forEach(pe=>{const Nt=pe.data(),ls=String(Nt.date??"").slice(0,10);if(!Nt.isDeferred&&ls>=he&&ls<=ce){const Js=Number(Nt.sellingPrice??0),ia=Number(Nt.quantity??0),sr=Number(Nt.profit??(Number(Nt.sellingPrice??0)-Number(Nt.wholesalePrice??0))*ia);ye+=Js*ia,Ce+=sr}}),Me(ye),ve(Ce)}catch(d){console.error("Error loading monthly stats:",d)}},ji=async d=>{if(!(y!=null&&y.uid))return null;try{const _=((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0),B=P&&Q?"cashier":"admin",te=B==="cashier"?(Q==null?void 0:Q.name)||"كاشير":(N==null?void 0:N.fullName)||(y==null?void 0:y.displayName)||"الحساب الرئيسي",he=B==="cashier"&&(Q==null?void 0:Q.username)||null,ce=await ca(ke(V,"dailySales"),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit:_,date:d.date,time:d.time,performedByType:B,performedByName:te,performedByUsername:he,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:$?{shopId:$}:{},createdAt:yt()});try{await sa(Ue(V,"users",y.uid,"dailySales",ce.id),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit:_,date:d.date,time:d.time,performedByType:B,performedByName:te,performedByUsername:he,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:$?{shopId:$}:{},createdAt:yt()})}catch{}return ce.id}catch{try{const _=await ca(ke(V,"users",y.uid,"dailySales"),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit,date:d.date,time:d.time,performedByType,performedByName,performedByUsername,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:$?{shopId:$}:{},createdAt:yt()});try{await sa(Ue(V,"dailySales",_.id),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit,date:d.date,time:d.time,performedByType,performedByName,performedByUsername,serialNumber:d.serialNumber??null,barcode:d.barcode??null,isDeferred:!!d.isDeferred,customerName:d.customerName||null,customerMobile:d.customerMobile||null,customerId:d.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:$?{shopId:$}:{},createdAt:yt()})}catch{}return _.id}catch(_){return console.error("Error saving sale:",_),null}}},Rr=()=>{const d=$||(N==null?void 0:N.shopId)||"main";return`cashBalance_${(y==null?void 0:y.uid)||"default"}_${d}`},ma=async(d,_)=>{if(y!=null&&y.uid)try{const B=Ue(V,"dailySales",d);await Xt(B,_)}catch{try{const B=Ue(V,"users",y.uid,"dailySales",d);await Xt(B,_)}catch(B){console.error("Error updating sale:",B)}}},ka=async d=>{try{const _=d.firestoreId;if(_)await ma(_,{isDeferred:!1});else try{const B=Ge(ke(V,"dailySales"),me("userId","==",(y==null?void 0:y.uid)||""),me("date","==",d.date),me("productName","==",d.productName),kr(5)),he=(await He(B)).docs[0];he&&await Xt(he.ref,{isDeferred:!1})}catch{}D(B=>B.map(te=>te.id===d.id?{...te,isDeferred:!1}:te));try{await Ls()}catch{}M({title:"تم التسديد",description:`تم تسديد أجل ${d.productName}`})}catch(_){console.error("Error marking deferred sale as paid:",_),M({title:"فشل التسديد",description:"تعذّر تحديث حالة البيع المؤجّل",variant:"destructive"})}},js=async()=>{if(!(y!=null&&y.uid))return;const d=j.filter(_=>!_.firestoreId);if(d.length!==0)for(const _ of d)try{let B;try{const he=Ge(ke(V,"dailySales"),me("userId","==",y.uid),me("clientId","==",_.id),kr(1));B=await He(he)}catch{const he=Ge(ke(V,"users",y.uid,"dailySales"),me("clientId","==",_.id),kr(1));B=await He(he)}if(!B.empty){const he=B.docs[0].id,ce=j.map(we=>we.id===_.id?{...we,firestoreId:he}:we);Fr(ce);continue}const te=await ji(_);if(te){const he=j.map(ce=>ce.id===_.id?{...ce,firestoreId:te}:ce);Fr(he)}}catch{}},pr=async d=>{try{if(y!=null&&y.uid)try{const ye=ke(V,"deficiencies"),Ce=await ca(ye,{shopId:(N==null?void 0:N.shopId)||y.uid||"default-shop",name:d,quantity:1,status:"pending",createdAt:yt()});try{const pe=`deficiencies_${(N==null?void 0:N.shopId)||(y==null?void 0:y.uid)||"default-shop"}`,Nt=localStorage.getItem(pe),ls=Nt?JSON.parse(Nt):[],Js=Array.isArray(ls)?ls:[],ia=Js.some(As=>String((As==null?void 0:As.id)||"")===Ce.id),sr={id:Ce.id,name:d,quantity:1,status:"pending",createdAt:new Date().toISOString()},ya=ia?Js:[...Js,sr];localStorage.setItem(pe,JSON.stringify(ya))}catch{}M({title:"تمت الإضافة للنواقص",description:`المنتج ${d} نفد من المخزون وتمت إضافته للنواقص`});return}catch(ye){console.warn("Failed to add deficiency to Firestore, falling back to local storage:",ye)}const _=`deficiencies_${(N==null?void 0:N.shopId)||(y==null?void 0:y.uid)||"default-shop"}`,B=localStorage.getItem(_),te=B?JSON.parse(B):[],he=Array.isArray(te)?te:[];if(he.some(ye=>String((ye==null?void 0:ye.name)||"").trim()===d&&String((ye==null?void 0:ye.status)||"pending")==="pending"))return;const we={id:Date.now().toString(),name:d,quantity:1,status:"pending",createdAt:new Date().toISOString()},Pe=[...he,we];localStorage.setItem(_,JSON.stringify(Pe)),M({title:"تمت الإضافة للنواقص",description:`المنتج ${d} نفد من المخزون وتمت إضافته للنواقص`})}catch(_){console.error("Error adding deficiency for out-of-stock:",_)}},zt=async(d,_=!1,B)=>{const te=de[d.id]||"",he=parseInt(te);if(isNaN(he)||he<=0){M({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(he>d.quantity){M({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const ce=new Date,we=P&&Q?"cashier":"admin",Pe=we==="cashier"?(Q==null?void 0:Q.name)||"كاشير":(N==null?void 0:N.fullName)||(y==null?void 0:y.displayName)||"الحساب الرئيسي",ye=we==="cashier"&&(Q==null?void 0:Q.username)||null,Ce=(d.serialNumber||"").trim(),pe=gt[d.id]||"",Nt=parseFloat(pe),ls=!isNaN(Nt)&&Nt>0?Nt:d.sellingPrice,Js={id:Date.now().toString(),productName:d.name,price:ls,wholesalePrice:d.wholesalePrice,quantity:he,date:ce.toISOString().split("T")[0],time:ce.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),createdAtMs:ce.getTime(),performedByType:we,performedByName:Pe,performedByUsername:ye,serialNumber:Ce||void 0,barcode:d.barcode,isDeferred:_,customerName:B==null?void 0:B.name,customerMobile:B==null?void 0:B.mobile,customerId:B==null?void 0:B.id};try{const ia=await ji(Js),sr=ia?{...Js,firestoreId:ia}:Js;Fr([...j,sr]);const ya=d.quantity-he;if(await Xt(Ue(V,"products",d.id),{quantity:ya,updatedAt:yt()}),se(As=>As.map(ba=>ba.id===d.id?{...ba,quantity:ya}:ba)),L(As=>({...As,[d.id]:""})),ps(As=>({...As,[d.id]:""})),ya===0&&pr(d.name),!_)try{const As=ls*he,ba=Rr(),qr=localStorage.getItem(ba),Vt=(qr?parseFloat(qr):0)+As;localStorage.setItem(ba,Vt.toString());const zr=`userData_${y==null?void 0:y.uid}`,as={cashBalance:Vt,lastUpdated:new Date().toISOString()};localStorage.setItem(zr,JSON.stringify(as)),y!=null&&y.uid&&Ie.updateUserData(y.uid,as).catch(()=>{});const fr=(N==null?void 0:N.shopId)||$;if(fr)try{await Xt(Ue(V,"dashboardData",fr),{cashBalance:Vt})}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:Vt}}))}catch{}try{if(y!=null&&y.uid){const Tn=`SALECASH-${y.uid}-${Date.now()}`,Si={txnType:"cash_addition",type:"cash_addition",amount:As,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:Tn,title:"إيصال إضافة نقدية",merchantUserId:y.uid,createdBy:y.uid,shopId:(N==null?void 0:N.shopId)||$||void 0,cashierName:Pe,performedByType:we,performedByUsername:ye,createdAt:new Date};await Ie.saveUserTransaction(y.uid,Si)}}catch{}}catch(As){console.warn("تعذر تحديث رصيد الدرج النقدي بعد البيع:",As)}M({title:"تم البيع",description:`تم بيع ${he} قطعة من ${d.name}`})}catch(ia){console.error("Error selling product:",ia),M({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},er=async d=>{if(y!=null&&y.uid){if(P){M({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف إيصالات البيع أثناء الورديه",variant:"destructive"});return}ts("تأكيد حذف إيصال بيع","أدخل الرقم السري الرئيسي لحذف الإيصال وعكس الآثار",async()=>{try{const _=Ta(),B=`salesData_${y.uid}_${_}`,te=`salesData_all_${y.uid}`,he=j.filter(we=>we.id!==d.id);try{localStorage.setItem(B,JSON.stringify(he));const we=localStorage.getItem(te),Pe=we?JSON.parse(we):[],ye=(Array.isArray(Pe)?Pe:[]).filter(Ce=>(Ce==null?void 0:Ce.id)!==d.id);localStorage.setItem(te,JSON.stringify(ye))}catch{}D(he);const ce=[];if(!d.isDeferred)try{const we=(d.price??0)*(d.quantity??0),Pe=Rr(),ye=localStorage.getItem(Pe),pe=(ye?parseFloat(ye):0)-we;localStorage.setItem(Pe,pe.toString());const Nt=`userData_${y==null?void 0:y.uid}`,ls={cashBalance:pe,lastUpdated:new Date().toISOString()};try{localStorage.setItem(Nt,JSON.stringify(ls))}catch{}y!=null&&y.uid&&ce.push(Ie.updateUserData(y.uid,ls));const Js=(N==null?void 0:N.shopId)||$;Js&&ce.push(Xt(Ue(V,"dashboardData",Js),{cashBalance:pe}).catch(()=>{}));try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:pe}}))}catch{}}catch(we){console.warn("تعذر عكس رصيد الدرج النقدي عند حذف الإيصال:",we)}try{const we=Y.find(Pe=>d.barcode&&Pe.barcode===d.barcode||Pe.name===d.productName);if(we){const Pe=(we.quantity||0)+(d.quantity||0);se(ye=>ye.map(Ce=>Ce.id===we.id?{...Ce,quantity:Pe}:Ce)),ce.push(Xt(Ue(V,"products",we.id),{quantity:Pe,updatedAt:yt()}))}}catch(we){console.warn("تعذر عكس المخزون عند حذف الإيصال:",we)}try{d.firestoreId?(ce.push(Bs(Ue(V,"dailySales",d.firestoreId)).catch(()=>{})),ce.push(Bs(Ue(V,"users",y.uid,"dailySales",d.firestoreId)).catch(()=>{}))):ce.push((async()=>{try{const we=Ge(ke(V,"dailySales"),me("userId","==",y.uid),me("date","==",d.date),me("productName","==",d.productName),kr(5));let Pe=await He(we);if(Pe.empty){const ye=Ge(ke(V,"users",y.uid,"dailySales"),me("date","==",d.date),me("productName","==",d.productName),kr(5));Pe=await He(ye)}if(!Pe.empty){const ye=Pe.docs.find(Ce=>{const pe=Ce.data();return Number((pe==null?void 0:pe.sellingPrice)??0)===Number(d.price??0)&&Number((pe==null?void 0:pe.quantity)??0)===Number(d.quantity??0)&&String((pe==null?void 0:pe.time)??"")===String(d.time??"")})||Pe.docs[0];ye&&await Bs(ye.ref)}}catch(we){console.warn("تعذر حذف سجل البيع من Firestore (استعلام بديل):",we)}})())}catch(we){console.warn("تعذر جدولة حذف سجل البيع من Firestore:",we)}try{re||setTimeout(()=>{try{Ls()}catch{}},0)}catch{}try{await Promise.allSettled(ce)}catch{}M({title:"تم حذف الإيصال",description:`تم حذف إيصال بيع للمنتج ${d.productName} وتم عكس الآثار`})}catch(_){console.error("Error deleting sale:",_),M({title:"فشل حذف الإيصال",description:"تعذّر حذف إيصال البيع",variant:"destructive"})}})}},Pa=async d=>{try{L(_=>({..._,[d.id]:"1"})),await zt(d)}catch(_){console.error("Error selling by barcode:",_)}},Br=async d=>{if(!(y!=null&&y.uid))return;if(P){M({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف المنتجات أثناء الورديه",variant:"destructive"});return}window.confirm(`هل تريد حذف المنتج "${d.name}"؟`)&&ts("تأكيد حذف منتج","لا يمكن حذف المنتجات إلا بإدخال الرقم السري الرئيسي",async()=>{try{await Bs(Ue(V,"products",d.id)),se(B=>B.filter(te=>te.id!==d.id)),M({title:"تم الحذف",description:`تم حذف المنتج ${d.name}`})}catch(B){console.error("Error deleting product:",B),M({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}})},tr=async()=>{try{if(!(y!=null&&y.uid)){M({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}if(P){M({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتجات أثناء الورديه",variant:"destructive"});return}const d=I.productName.trim(),_=parseFloat(I.price),B=parseFloat(I.wholesalePrice||"0"),te=parseInt(I.quantity);if(!d||isNaN(_)||isNaN(te)){M({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const he={name:d,sellingPrice:_,wholesalePrice:isNaN(B)?0:B,quantity:isNaN(te)?0:te,userId:y.uid,createdAt:yt(),updatedAt:yt()},ce=(I.barcode||"").trim();ce&&(he.barcode=ce);const we=(I.serialNumber||"").trim();we&&(he.serialNumber=we),N!=null&&N.shopId&&(he.shopId=N.shopId);const Pe=await ca(ke(V,"products"),he);se(ye=>[{id:Pe.id,name:d,sellingPrice:_,wholesalePrice:isNaN(B)?0:B,quantity:isNaN(te)?0:te,barcode:(I.barcode||"").trim()||"",serialNumber:(I.serialNumber||"").trim()||""},...ye]),s({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),M({title:"تمت الإضافة",description:`تم إضافة المنتج ${d} بنجاح`})}catch(d){console.error("createProduct error",d),M({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}},gr=async d=>{const _=(d||"").trim();if(!_)return;const B=Y.find(te=>(te.barcode||"")===_);if(!B){M({title:"باركود غير معروف",description:"لم يتم العثور على منتج بهذا الباركود"});return}await Pa(B)},Ur=()=>{const d=Object.entries(Ve).map(([ye,Ce])=>{const pe=Number(Ce),Nt=Y.find(ls=>ls.id===ye);return!Nt||!pe||pe<=0?null:{name:Nt.name,qty:pe,price:Nt.sellingPrice,total:pe*Nt.sellingPrice}}).filter(Boolean);if(d.length===0){M({title:"لم يتم اختيار منتجات",description:"فعّل وضع الفاتورة واختر منتجات وكميات للطباعة"});return}const _=(N==null?void 0:N.shopName)||(y==null?void 0:y.displayName)||"المحل",B=(N==null?void 0:N.phone)||(y==null?void 0:y.phoneNumber)||"",te=d.reduce((ye,Ce)=>ye+Ce.total,0),he=new Date().toLocaleString("ar-EG"),ce=d.map(ye=>`
        <tr>
          <td style="border:1px solid #ddd;padding:6px">${ye.name}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${ye.qty}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${Bt(ye.price)}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center;font-weight:bold;color:#0a7">${Bt(ye.total)}</td>
        </tr>
      `).join(""),we=`
      <html>
        <head>
          <meta charset="utf-8" />
          <title>فاتورة</title>
          <style>
            body { font-family: Tahoma, Arial, sans-serif; direction: rtl; }
            .header { text-align: center; margin-bottom: 12px; }
            .header h2 { margin: 0; }
            .meta { text-align: center; color: #555; margin-bottom: 8px; }
            table { width: 100%; border-collapse: collapse; }
            .total { text-align: left; font-weight: bold; margin-top: 10px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>${_}</h2>
            ${B?`<div class="meta">رقم التليفون: ${B}</div>`:""}
            <div class="meta">التاريخ: ${he}</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="border:1px solid #ddd;padding:6px">المنتج</th>
                <th style="border:1px solid #ddd;padding:6px">الكمية</th>
                <th style="border:1px solid #ddd;padding:6px">السعر</th>
                <th style="border:1px solid #ddd;padding:6px">الإجمالي</th>
              </tr>
            </thead>
            <tbody>
              ${ce}
            </tbody>
          </table>
          <div class="total">الإجمالي الكلي: ${Bt(te)}</div>
        </body>
      </html>
    `,Pe=window.open("","_blank");Pe&&(Pe.document.write(we),Pe.document.close(),Pe.focus(),Pe.print(),Pe.close())};return e.jsxs(je,{open:i,onOpenChange:p,children:[e.jsx(Se,{className:"max-w-none w-[100vw] h-[100dvh] p-0 overflow-hidden bg-gray-50/50",children:e.jsxs("div",{className:"flex flex-col h-full",dir:"rtl",children:[e.jsxs("div",{className:"bg-white border-b px-3 py-2 flex items-center justify-between shrink-0 z-10 h-14 sm:h-auto",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"bg-primary/10 p-1.5 rounded-full",children:e.jsx(Fl,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{className:"flex flex-col justify-center",children:[e.jsx(De,{className:"text-sm font-bold leading-tight",children:"المبيعات والمنتجات"}),e.jsx("p",{className:"text-[10px] text-muted-foreground hidden sm:block leading-none mt-0.5",children:"إدارة عمليات البيع والمخزون"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>js(),className:"hidden sm:flex h-7 text-[10px] px-2",children:[e.jsx(td,{className:"h-3 w-3 ml-1.5"}),"مزامنة"]}),e.jsx(x,{variant:"ghost",size:"icon",onClick:p,className:"rounded-full h-8 w-8",children:e.jsx(Cn,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex-1 overflow-hidden flex flex-col md:flex-row",children:[e.jsx("div",{className:"w-full md:w-80 bg-white border-l flex flex-col overflow-y-auto shrink-0 order-2 md:order-1",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs(vt,{children:[e.jsx(Ht,{className:"p-4 pb-2",children:e.jsxs(ms,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(es,{className:"h-4 w-4 text-primary"}),"ملخص اليوم"]})}),e.jsxs(St,{className:"p-4 pt-2 space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center p-3 bg-gray-50 rounded-lg border",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"المبيعات"}),e.jsx("span",{className:"text-lg font-bold text-primary",children:Bt(j.filter(d=>!d.isDeferred).reduce((d,_)=>d+_.price*_.quantity,0))})]}),e.jsxs("div",{className:"relative overflow-hidden p-3 bg-emerald-50/50 rounded-lg border border-emerald-100",children:[e.jsxs("div",{className:`flex justify-between items-center ${X?"blur-sm":""}`,children:[e.jsx("span",{className:"text-sm text-emerald-700",children:"الأرباح"}),e.jsx("span",{className:"text-lg font-bold text-emerald-700",children:Bt(j.filter(d=>!d.isDeferred).reduce((d,_)=>d+(_.price-(_.wholesalePrice??0))*_.quantity,0))})]}),X&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white/50",children:e.jsxs(x,{size:"sm",variant:"outline",onClick:()=>Dt(!0),className:"h-7 text-xs bg-white",children:[e.jsx(Fa,{className:"h-3 w-3 ml-1"}),"عرض"]})})]})]})]}),e.jsxs(vt,{className:"shadow-none border-none bg-transparent",children:[e.jsxs("button",{onClick:()=>R(!ee),className:"flex items-center justify-between w-full p-2 text-sm font-medium text-gray-600 hover:text-primary transition-colors",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx($r,{className:"h-4 w-4"}),"تقارير الشهر"]}),ee?e.jsx(jn,{className:"h-4 w-4"}):e.jsx(Yc,{className:"h-4 w-4"})]}),!ee&&e.jsx("div",{className:"mt-2 grid grid-cols-2 gap-2 animate-in slide-in-from-top-2",children:e.jsxs("div",{className:"col-span-2 relative",children:[e.jsxs("div",{className:`grid grid-cols-2 gap-2 ${re?"blur-sm select-none":""}`,children:[e.jsxs("div",{className:"bg-indigo-50 p-3 rounded-xl border border-indigo-100 text-center",children:[e.jsx("span",{className:"text-[10px] text-indigo-600 block mb-1",children:"المبيعات"}),e.jsx("span",{className:"text-sm font-bold text-indigo-700",children:Bt(le)})]}),e.jsxs("div",{className:"bg-pink-50 p-3 rounded-xl border border-pink-100 text-center",children:[e.jsx("span",{className:"text-[10px] text-pink-600 block mb-1",children:"الأرباح"}),e.jsx("span",{className:"text-sm font-bold text-pink-700",children:Bt($e)})]})]}),re&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-10",children:e.jsxs(x,{size:"sm",variant:"outline",onClick:()=>tt(!0),className:"h-8 bg-white/80 backdrop-blur-sm",children:[e.jsx(Fa,{className:"h-3 w-3 ml-1"}),"فك القفل"]})})]})})]}),e.jsx(bi,{}),e.jsxs(x,{variant:"outline",className:"w-full justify-start h-10",onClick:()=>_t(!0),children:[e.jsx(pa,{className:"h-4 w-4 ml-2"}),"أرشيف الإيصالات"]})]})}),e.jsx("div",{className:"flex-1 overflow-hidden flex flex-col order-1 md:order-2 bg-gray-50/30",children:e.jsxs(ru,{defaultValue:"products",className:"flex-1 flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"px-2 py-1.5 bg-white border-b flex items-center justify-between shrink-0",children:[e.jsxs(nu,{className:"h-8",children:[e.jsx(Dc,{value:"products",className:"text-xs px-2 sm:px-3",children:"المنتجات والبيع"}),e.jsxs(Dc,{value:"sales-log",className:"text-xs px-2 sm:px-3",children:["سجل المبيعات",e.jsx(Mt,{variant:"secondary",className:"mr-2 h-5 px-1.5 text-[10px] hidden sm:inline-flex",children:j.filter(d=>!d.isDeferred).length})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500 font-mono",dir:"ltr",children:[e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(Da,{className:"h-3.5 w-3.5 text-gray-400"})]})]}),e.jsxs(Cc,{value:"products",className:"flex-1 overflow-y-auto p-4 m-0 space-y-4",children:[e.jsxs(vt,{className:"border-dashed border-2 border-gray-200 hover:border-gray-300 transition-all bg-gray-50/30 overflow-hidden",children:[e.jsxs("div",{className:"p-4 flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors",onClick:()=>W(!w),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-emerald-100 p-2 rounded-full",children:e.jsx(Ut,{className:"h-5 w-5 text-emerald-600"})}),e.jsxs("div",{className:"text-right",children:[e.jsx("h3",{className:"font-semibold text-gray-900 text-sm",children:"إضافة منتج جديد"}),e.jsx("p",{className:"text-xs text-gray-500",children:"تسجيل منتج جديد في المخزون"})]})]}),e.jsx(x,{variant:"ghost",size:"sm",className:"rounded-full h-8 w-8 p-0",children:e.jsx(jn,{className:`h-5 w-5 text-gray-400 transition-transform duration-200 ${w?"rotate-180":""}`})})]}),w&&e.jsxs("div",{className:"px-4 pb-4 pt-0 animate-in slide-in-from-top-2",children:[e.jsx("div",{className:"h-px bg-gray-200 mb-4"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs(Z,{className:"text-xs font-medium text-gray-700",children:["اسم المنتج ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(z,{value:I.productName,onChange:d=>s(_=>({..._,productName:d.target.value})),className:"h-9 bg-white",placeholder:"مثال: شاحن آيفون أصلي"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs(Z,{className:"text-xs font-medium text-gray-700",children:["سعر البيع ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(z,{type:"number",value:I.price,onChange:d=>s(_=>({..._,price:d.target.value})),className:"h-9 bg-white",placeholder:"0.00"})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Z,{className:"text-xs font-medium text-gray-700",children:"سعر الجملة"}),e.jsx(z,{type:"number",value:I.wholesalePrice||"",onChange:d=>s(_=>({..._,wholesalePrice:d.target.value})),className:"h-9 bg-white",placeholder:"0.00"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs(Z,{className:"text-xs font-medium text-gray-700",children:["الكمية ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(z,{type:"number",value:I.quantity,onChange:d=>s(_=>({..._,quantity:d.target.value})),className:"h-9 bg-white",placeholder:"1"})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Z,{className:"text-xs font-medium text-gray-700",children:"الباركود (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{value:I.barcode||"",onChange:d=>s(_=>({..._,barcode:d.target.value})),className:"h-9 bg-white pl-8",placeholder:"Scan..."}),e.jsx(Ll,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-gray-400"})]})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs(x,{className:"w-full h-9 bg-emerald-600 hover:bg-emerald-700 text-white shadow-sm",onClick:()=>{if(P){M({title:"غير مسموح",description:"لا يمكن إضافة منتج أثناء الوردية",variant:"destructive"});return}ts("إضافة منتج","أدخل الرقم السري للمتابعة",tr)},children:[e.jsx(Ut,{className:"h-4 w-4 ml-2"}),"حفظ المنتج الجديد"]})})]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 items-stretch sm:items-center justify-between bg-white p-2 rounded-xl border border-gray-100 shadow-sm",children:[e.jsxs("div",{className:"relative flex-1 w-full sm:max-w-md group",children:[e.jsx(Gc,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 group-focus-within:text-primary transition-colors"}),e.jsx(z,{value:zs,onChange:d=>Xa(d.target.value),placeholder:"بحث عن منتج بالاسم...",className:"pl-3 pr-9 h-10 border-0 bg-transparent focus-visible:ring-0 placeholder:text-gray-400"})]}),e.jsx("div",{className:"h-8 w-px bg-gray-200 hidden sm:block"}),e.jsxs("div",{className:"flex items-center gap-2 w-full sm:w-auto",children:[e.jsxs("div",{className:"relative flex-1 sm:w-48 group",children:[e.jsx(Ll,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 group-focus-within:text-primary transition-colors"}),e.jsx(z,{value:oe,onChange:d=>ne(d.target.value),onKeyDown:async d=>{d.key==="Enter"&&oe.trim()&&(await gr(oe.trim()),ne(""))},placeholder:"ماسح الباركود...",className:"pr-9 h-9 bg-gray-50 border-gray-200 focus:bg-white transition-all text-sm"})]}),e.jsxs("div",{className:"flex items-center gap-1 border-r pr-2 mr-1",children:[e.jsx(x,{variant:Re?"default":"ghost",size:"icon",onClick:()=>Ye(!Re),className:`h-9 w-9 shrink-0 transition-all rounded-full ${Re?"bg-primary text-primary-foreground":"text-gray-500 hover:text-primary hover:bg-primary/10"}`,title:"وضع الفاتورة",children:e.jsx(pa,{className:"h-4 w-4"})}),Re&&e.jsx(x,{variant:"outline",size:"icon",onClick:Ur,disabled:Object.values(Ve).every(d=>!d),className:"h-9 w-9 shrink-0 rounded-full border-gray-200",title:"طباعة الفاتورة",children:e.jsx(Zc,{className:"h-4 w-4 text-gray-600"})})]})]})]}),e.jsx("div",{className:"space-y-4",children:Vs.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4 bg-white rounded-xl border border-dashed border-gray-200 text-center shadow-sm",children:[e.jsx("div",{className:"bg-gray-50 p-4 rounded-full mb-4",children:e.jsx(ad,{className:"h-10 w-10 text-gray-300"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-1",children:"لا توجد منتجات"}),e.jsx("p",{className:"text-gray-500 text-sm max-w-xs mx-auto mb-4",children:"لم يتم العثور على منتجات تطابق بحثك."}),e.jsxs(x,{variant:"outline",onClick:()=>W(!0),className:"gap-2",children:[e.jsx(Ut,{className:"h-4 w-4"}),"إضافة منتج جديد"]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden md:block bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden",children:e.jsxs(pi,{children:[e.jsx(gi,{className:"bg-gray-50/80",children:e.jsxs(mr,{className:"hover:bg-transparent border-gray-100",children:[e.jsx(Kt,{className:"text-right h-11 font-semibold text-gray-700",children:"المنتج"}),e.jsx(Kt,{className:"text-center h-11 font-semibold text-gray-700 w-28",children:"السعر"}),e.jsx(Kt,{className:"text-center h-11 font-semibold text-gray-700 w-28",children:e.jsxs("div",{className:"flex items-center justify-center gap-1.5 cursor-pointer hover:text-primary transition-colors select-none",onClick:()=>Ot(!ht),children:[e.jsx("span",{children:"الجملة"}),ht?e.jsx(Zs,{className:"h-3.5 w-3.5"}):e.jsx(us,{className:"h-3.5 w-3.5"})]})}),e.jsx(Kt,{className:"text-center h-11 font-semibold text-gray-700 w-24",children:"الكمية"}),e.jsx(Kt,{className:"text-center h-11 font-semibold text-gray-700 w-[420px]",children:"إجراءات البيع"})]})}),e.jsx(fi,{children:Vs.map(d=>e.jsxs(mr,{className:"hover:bg-gray-50/60 transition-colors border-gray-100",children:[e.jsxs(Yt,{className:"font-medium py-3",children:[e.jsx("div",{className:"text-gray-900 font-bold",children:d.name}),d.barcode&&e.jsxs("div",{className:"flex items-center gap-1 text-[11px] text-gray-500 font-mono mt-0.5",children:[e.jsx(Ll,{className:"h-3 w-3"}),d.barcode]})]}),e.jsx(Yt,{className:"text-center py-3",children:e.jsx("span",{className:"font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-md",children:Bt(d.sellingPrice)})}),e.jsx(Yt,{className:"text-center py-3",children:e.jsx("span",{className:`font-medium text-xs ${ht?"text-gray-600":"blur-sm select-none text-gray-300"}`,children:Bt(d.wholesalePrice)})}),e.jsx(Yt,{className:"text-center py-3",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(Mt,{variant:d.quantity>0?"outline":"destructive",className:`font-mono ${d.quantity>0?"bg-gray-50 text-gray-700 border-gray-200":""}`,children:d.quantity}),e.jsx(x,{size:"icon",variant:"ghost",className:"h-5 w-5 rounded-full text-emerald-600 hover:bg-emerald-50 hover:text-emerald-700",onClick:()=>fs(d),title:"إضافة مخزون",children:e.jsx(Ut,{className:"h-3 w-3"})})]})}),e.jsx(Yt,{className:"py-3",children:e.jsxs("div",{className:"flex items-center gap-2 justify-end",children:[e.jsxs("div",{className:"relative group",children:[e.jsx(z,{type:"number",className:"h-8 w-14 text-center px-1 text-sm bg-white border-gray-200 focus:border-primary/50",placeholder:"1",value:de[d.id]||"",onChange:_=>L(B=>({...B,[d.id]:_.target.value}))}),e.jsx("span",{className:"absolute -top-2 -right-1 text-[9px] bg-white px-0.5 text-gray-400 group-hover:text-primary transition-colors",children:"العدد"})]}),e.jsxs("div",{className:"relative group",children:[e.jsx(z,{type:"number",className:"h-8 w-16 text-center px-1 bg-gray-50 border-gray-200 focus:border-primary/50 text-sm focus:bg-white transition-colors",placeholder:"سعر",value:gt[d.id]||"",onChange:_=>ps(B=>({...B,[d.id]:_.target.value})),title:"سعر بيع مخصص"}),e.jsx("span",{className:"absolute -top-2 -right-1 text-[9px] bg-white px-0.5 text-gray-400 group-hover:text-primary transition-colors",children:"مخصص"})]}),e.jsx(x,{size:"sm",className:"h-8 bg-indigo-600 hover:bg-indigo-700 text-white shadow-sm px-3 font-medium",onClick:()=>zt(d),children:"بيع"}),e.jsx(x,{size:"sm",variant:"secondary",className:"h-8 text-amber-700 bg-amber-50 hover:bg-amber-100 border border-amber-200 px-3 font-medium",onClick:()=>{H(d),Is(!0)},children:"أجل"}),Re&&e.jsx(z,{type:"number",className:"h-8 w-12 text-center border-indigo-200 focus:border-indigo-400 bg-indigo-50/30",placeholder:"#",value:Ve[d.id]??"",onChange:_=>{const B=parseInt(_.target.value||"0");Ze(te=>({...te,[d.id]:isNaN(B)?0:B}))}}),e.jsx("div",{className:"w-px h-4 bg-gray-200 mx-1"}),e.jsx(x,{size:"icon",variant:"ghost",className:"h-8 w-8 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full",onClick:()=>Br(d),disabled:P,children:e.jsx(ds,{className:"h-4 w-4"})})]})})]},d.id))})]})}),e.jsx("div",{className:"md:hidden grid grid-cols-1 gap-3",children:Vs.map(d=>e.jsx(vt,{className:"overflow-hidden border-gray-100 shadow-sm hover:shadow-md transition-shadow",children:e.jsxs(St,{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-gray-900 text-base",children:d.name}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-2",children:[e.jsx(Mt,{variant:"secondary",className:"bg-emerald-50 text-emerald-700 border-emerald-100",children:Bt(d.sellingPrice)}),e.jsxs("span",{className:`text-xs text-gray-500 flex items-center gap-1 ${!ht&&"blur-sm select-none"}`,children:[e.jsx("span",{className:"text-gray-400",children:"جملة:"}),Bt(d.wholesalePrice)]}),e.jsx("span",{className:"text-gray-300",children:"|"}),e.jsxs("span",{className:"text-xs text-gray-600 font-medium flex items-center gap-1",children:["متاح: ",d.quantity,e.jsx(x,{size:"icon",variant:"ghost",className:"h-5 w-5 rounded-full text-emerald-600 hover:bg-emerald-50",onClick:()=>fs(d),children:e.jsx(Ut,{className:"h-3 w-3"})})]})]})]}),e.jsx(x,{size:"icon",variant:"ghost",className:"h-8 w-8 -mt-1 -ml-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full",onClick:()=>Br(d),disabled:P,children:e.jsx(ds,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-gray-50/50 p-2 rounded-lg border border-gray-100",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(z,{type:"number",className:"h-9 w-full bg-white text-center border-gray-200 focus:border-indigo-300",placeholder:"الكمية",value:de[d.id]||"",onChange:_=>L(B=>({...B,[d.id]:_.target.value}))}),e.jsx("span",{className:"absolute inset-y-0 right-2 flex items-center text-[10px] text-gray-400 pointer-events-none",children:"عدد"})]}),e.jsxs("div",{className:"relative w-28",children:[e.jsx(z,{type:"number",className:"h-9 w-full bg-white text-center border-gray-200 focus:border-indigo-300",placeholder:"سعر مخصص",value:gt[d.id]||"",onChange:_=>ps(B=>({...B,[d.id]:_.target.value}))}),e.jsx("span",{className:"absolute inset-y-0 right-2 flex items-center text-[10px] text-gray-400 pointer-events-none",children:"سعر"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(x,{className:"h-10 bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm font-bold",onClick:()=>zt(d),children:[e.jsx(es,{className:"h-4 w-4 ml-2"}),"بيع فوري"]}),e.jsxs(x,{variant:"outline",className:"h-10 border-amber-200 text-amber-700 bg-amber-50 hover:bg-amber-100 font-bold",onClick:()=>{H(d),Is(!0)},children:[e.jsx(Da,{className:"h-4 w-4 ml-2"}),"بيع أجل"]})]}),Re&&e.jsx("div",{className:"pt-3 border-t border-dashed border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-xs font-medium text-gray-500",children:"للفاتورة:"}),e.jsx(z,{type:"number",className:"h-8 flex-1 bg-indigo-50/30 border-indigo-100",value:Ve[d.id]??"",onChange:_=>{const B=parseInt(_.target.value||"0");Ze(te=>({...te,[d.id]:isNaN(B)?0:B}))},placeholder:"العدد في الفاتورة"})]})})]})},d.id))})]})})]}),e.jsx(Cc,{value:"sales-log",className:"flex-1 overflow-y-auto p-4 m-0 space-y-4",children:j.length===0?e.jsxs("div",{className:"h-full flex flex-col items-center justify-center py-12 px-4 bg-gray-50/50 rounded-xl border border-dashed border-gray-200 text-center",children:[e.jsx("div",{className:"bg-white p-4 rounded-full shadow-sm mb-4",children:e.jsx(pa,{className:"h-8 w-8 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-1",children:"لا توجد مبيعات"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"لم يتم تسجيل أي عمليات بيع اليوم."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"hidden md:block bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden",children:e.jsxs(pi,{children:[e.jsx(gi,{className:"bg-gray-50/80",children:e.jsxs(mr,{className:"hover:bg-transparent",children:[e.jsx(Kt,{className:"text-right h-11 font-semibold text-gray-700",children:"المنتج"}),e.jsx(Kt,{className:"text-center h-11 font-semibold text-gray-700",children:"السعر"}),e.jsx(Kt,{className:"text-center h-11 font-semibold text-gray-700",children:"الكمية"}),e.jsx(Kt,{className:"text-center h-11 font-semibold text-gray-700",children:"الإجمالي"}),e.jsx(Kt,{className:"text-center h-11 font-semibold text-gray-700",children:"الربح"}),e.jsx(Kt,{className:"text-center h-11 font-semibold text-gray-700",children:"الوقت"}),e.jsx(Kt,{className:"text-center h-11 font-semibold text-gray-700",children:"إجراءات"})]})}),e.jsx(fi,{children:j.map(d=>e.jsxs(mr,{className:"hover:bg-gray-50/60 transition-colors",children:[e.jsxs(Yt,{className:"py-3",children:[e.jsx("div",{className:"font-medium text-gray-900",children:d.productName}),d.isDeferred&&e.jsx(Mt,{variant:"secondary",className:"mt-1 text-[10px] bg-amber-100 text-amber-700 border-amber-200",children:"مؤجل"})]}),e.jsx(Yt,{className:"text-center py-3",children:Bt(d.price)}),e.jsx(Yt,{className:"text-center py-3",children:e.jsx(Mt,{variant:"outline",className:"font-mono bg-gray-50",children:d.quantity})}),e.jsx(Yt,{className:"text-center font-bold text-green-600 py-3",children:Bt(d.price*d.quantity)}),e.jsx(Yt,{className:"text-center text-indigo-600 py-3",children:e.jsx("span",{className:ht?"":"blur-sm select-none text-gray-300",children:Bt(((d.price??0)-(d.wholesalePrice??0))*d.quantity)})}),e.jsx(Yt,{className:"text-center text-gray-500 text-xs py-3 font-mono",children:d.time}),e.jsx(Yt,{className:"py-3",children:e.jsxs("div",{className:"flex justify-center gap-2",children:[d.isDeferred&&e.jsx(x,{size:"sm",variant:"outline",className:"h-8 text-xs border-amber-200 text-amber-700 bg-amber-50 hover:bg-amber-100",onClick:()=>ka(d),children:"سداد"}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-8 w-8 p-0 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-full",onClick:()=>Os(d,"return"),title:"مرتجع",children:e.jsx(Za,{className:"h-4 w-4"})}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-8 w-8 p-0 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full",onClick:()=>Os(d,"delete"),title:"حذف نهائي",children:e.jsx(ql,{className:"h-4 w-4"})})]})})]},d.id))})]})}),e.jsx("div",{className:"md:hidden space-y-3",children:j.map(d=>e.jsx(vt,{className:"overflow-hidden border-gray-100 shadow-sm",children:e.jsxs(St,{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-gray-900 text-sm",children:d.productName}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 flex items-center gap-2",children:[e.jsx("span",{className:"bg-gray-100 px-1.5 py-0.5 rounded text-gray-600 font-mono",children:d.time}),d.isDeferred&&e.jsx(Mt,{variant:"outline",className:"text-[10px] bg-amber-50 text-amber-700 border-amber-100 px-1.5 py-0 h-5",children:"مؤجل"})]})]}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"font-bold text-green-600 text-sm",children:Bt(d.price*d.quantity)}),e.jsxs("div",{className:"text-xs text-gray-400 mt-0.5",children:[d.quantity," × ",Bt(d.price)]})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 pt-3 border-t border-gray-50",children:[d.isDeferred&&e.jsx(x,{size:"sm",variant:"ghost",className:"h-8 text-xs text-amber-600 bg-amber-50 hover:bg-amber-100",onClick:()=>ka(d),children:"تسديد"}),e.jsxs(x,{size:"sm",variant:"ghost",className:"h-8 text-xs text-red-600 hover:bg-red-50",onClick:()=>Os(d,"return"),children:[e.jsx(Za,{className:"h-3.5 w-3.5 ml-1.5"}),"مرتجع"]}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-8 w-8 p-0 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full",onClick:()=>Os(d,"delete"),children:e.jsx(ds,{className:"h-4 w-4"})})]})]})},d.id))})]})})]})})]})]})}),e.jsx(je,{open:fa,onOpenChange:Is,children:e.jsxs(Se,{className:"max-w-sm mx-auto bg-white border border-gray-100 shadow-xl rounded-2xl sm:max-w-md p-6 gap-5",children:[e.jsxs(Te,{className:"text-center space-y-2",children:[e.jsx("div",{className:"mx-auto bg-amber-100 p-3 rounded-full w-fit",children:e.jsx(Da,{className:"h-6 w-6 text-amber-600"})}),e.jsx(De,{className:"text-xl font-bold text-gray-900",children:"تسجيل بيع أجل"}),e.jsx(rs,{className:"text-gray-500 text-sm",children:"أدخل بيانات العميل لتسجيل عملية البيع الآجل"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-1.5",children:[e.jsx(Z,{className:"text-sm font-medium text-gray-700",children:"اختيار عميل (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{className:"flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 appearance-none",value:ra,onChange:d=>{const _=d.target.value;k(_);const B=Aa.find(te=>te.id===_);B&&(_e(B.name),Fe(B.mobile||""))},children:[e.jsx("option",{value:"",children:"-- اختر عميل مسجل --"}),Aa.map(d=>e.jsxs("option",{value:d.id,children:[d.name,d.mobile?` - ${d.mobile}`:""]},d.id))]}),e.jsx(jn,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 pointer-events-none"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-1.5",children:[e.jsxs(Z,{className:"text-sm font-medium text-gray-700",children:["اسم العميل ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(z,{value:ie,onChange:d=>_e(d.target.value),placeholder:"أدخل اسم العميل...",className:"h-10"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-1.5",children:[e.jsx(Z,{className:"text-sm font-medium text-gray-700",children:"رقم التليفون (اختياري)"}),e.jsx(z,{value:Xe,onChange:d=>Fe(d.target.value),placeholder:"أدخل رقم التليفون...",className:"h-10"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-2",children:[e.jsx(x,{variant:"outline",className:"flex-1 h-10 border-gray-200",onClick:()=>Is(!1),children:"إلغاء"}),e.jsx(x,{className:"flex-1 h-10 bg-amber-600 hover:bg-amber-700 text-white shadow-sm",onClick:async()=>{try{const d=ct;if(!d){Is(!1);return}const _=ie.trim(),B=Xe.trim()||void 0,te=ra||void 0;if(!_){M({title:"بيانات مطلوبة",description:"أدخل اسم العميل",variant:"destructive"});return}await zt(d,!0,{id:te,name:_,mobile:B});try{if(y!=null&&y.uid){const he=d.sellingPrice*(parseInt(de[d.id]||"0")||0),ce=await Ie.getUserData(y.uid),we=Array.isArray(ce==null?void 0:ce.debts)?ce.debts:[],Pe={id:Date.now().toString(),debtorName:_,customerId:te||null,mobile:B||null,amount:he,reason:`بيع أجل للمنتج ${d.name}`,status:"pending",createdAt:new Date,partialPayments:[]},ye=[Pe,...we];Ie.updateUserData(y.uid,{debts:ye}).catch(()=>{});try{const Ce=$||(N==null?void 0:N.shopId)||"main";localStorage.setItem(`debts_${y.uid}_${Ce}`,JSON.stringify(ye)),localStorage.setItem(`debts_default_${Ce}`,JSON.stringify(ye)),localStorage.setItem(`debts_last_write_${y.uid}_${Ce}`,Date.now().toString())}catch{}try{window.dispatchEvent(new CustomEvent("debtsUpdated",{detail:{count:ye.length}}))}catch{}try{Ja.send(y.uid,`تم إضافة دين على ${Pe.debtorName} بمبلغ ${Pe.amount} جنيه`).catch(()=>{})}catch{}}}catch{}Is(!1),H(null)}catch{}},children:"تأكيد البيع"})]})]})}),e.jsx(je,{open:Ct,onOpenChange:_t,children:e.jsxs(Se,{className:"sm:max-w-4xl max-h-[85vh] flex flex-col p-0 overflow-hidden gap-0",children:[e.jsxs("div",{className:"p-4 border-b flex items-center justify-between bg-gray-50/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-white p-2 rounded-full border shadow-sm",children:e.jsx(pa,{className:"h-5 w-5 text-indigo-600"})}),e.jsxs("div",{children:[e.jsx(De,{className:"text-lg font-bold",children:"سجل الإيصالات"}),e.jsx(rs,{className:"text-xs",children:"عرض تفاصيل عمليات البيع الفورية"})]})]}),e.jsx(x,{variant:"ghost",size:"icon",onClick:()=>_t(!1),className:"rounded-full",children:e.jsx(Cn,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:j.filter(d=>!d.isDeferred).length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx("div",{className:"bg-gray-50 p-4 rounded-full mb-3",children:e.jsx(pa,{className:"h-8 w-8 text-gray-300"})}),e.jsx("p",{className:"text-gray-500 font-medium",children:"لا توجد إيصالات بيع حتى الآن"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden md:block border rounded-xl overflow-hidden shadow-sm",children:e.jsxs(pi,{children:[e.jsx(gi,{className:"bg-gray-50/80",children:e.jsxs(mr,{className:"hover:bg-transparent",children:[e.jsx(Kt,{className:"text-right h-10 font-semibold text-gray-700",children:"المنتج"}),e.jsx(Kt,{className:"text-right h-10 font-semibold text-gray-700",children:"سعر البيع"}),e.jsx(Kt,{className:"text-right h-10 font-semibold text-gray-700",children:"سعر الجملة"}),e.jsx(Kt,{className:"text-right h-10 font-semibold text-gray-700",children:"الكمية"}),e.jsx(Kt,{className:"text-right h-10 font-semibold text-gray-700",children:"الإجمالي"}),e.jsx(Kt,{className:"text-right h-10 font-semibold text-gray-700",children:"الربح"}),e.jsx(Kt,{className:"text-right h-10 font-semibold text-gray-700",children:"التاريخ"}),e.jsx(Kt,{className:"text-right h-10 font-semibold text-gray-700",children:"الوقت"}),e.jsx(Kt,{className:"text-right h-10 font-semibold text-gray-700",children:"المنفذ"})]})}),e.jsx(fi,{children:j.filter(d=>!d.isDeferred).map(d=>e.jsxs(mr,{className:"hover:bg-gray-50/60",children:[e.jsx(Yt,{className:"font-medium text-gray-900 py-3",children:d.productName}),e.jsx(Yt,{className:"text-gray-700 py-3",children:Bt(d.price)}),e.jsx(Yt,{className:"text-gray-700 py-3",children:Bt(d.wholesalePrice??0)}),e.jsx(Yt,{className:"text-gray-700 py-3 font-mono",children:Lc(d.quantity)}),e.jsx(Yt,{className:"text-gray-700 py-3 font-bold text-emerald-600",children:Bt((d.price??0)*(d.quantity??0))}),e.jsx(Yt,{className:"text-gray-700 py-3 text-indigo-600",children:Bt(((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0))}),e.jsx(Yt,{className:"text-gray-500 py-3 text-xs",children:Mc(d.date)}),e.jsx(Yt,{className:"text-gray-500 py-3 text-xs font-mono",children:d.time}),e.jsx(Yt,{className:"text-gray-700 py-3 text-xs",children:d.executedBy||"-"})]},d.id))})]})}),e.jsx("div",{className:"md:hidden space-y-3",children:j.filter(d=>!d.isDeferred).map(d=>e.jsx(vt,{className:"overflow-hidden border-gray-100 shadow-sm",children:e.jsxs(St,{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-gray-900 text-sm",children:d.productName}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 flex items-center gap-2",children:[e.jsx("span",{className:"bg-gray-100 px-1.5 py-0.5 rounded text-gray-600 font-mono",children:d.time}),e.jsx("span",{className:"text-gray-400",children:"|"}),e.jsx("span",{children:Mc(d.date)})]})]}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"font-bold text-emerald-600 text-sm",children:Bt((d.price??0)*(d.quantity??0))}),e.jsxs("div",{className:"text-xs text-gray-400 mt-0.5",children:[d.quantity," × ",Bt(d.price)]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 pt-3 border-t border-dashed border-gray-100 text-xs",children:[e.jsxs("div",{className:"bg-gray-50 p-2 rounded flex flex-col items-center justify-center",children:[e.jsx("span",{className:"text-gray-400 mb-1",children:"الربح"}),e.jsx("span",{className:"font-bold text-indigo-600",children:Bt(((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0))})]}),e.jsxs("div",{className:"bg-gray-50 p-2 rounded flex flex-col items-center justify-center",children:[e.jsx("span",{className:"text-gray-400 mb-1",children:"المنفذ"}),e.jsx("span",{className:"font-medium text-gray-700 truncate max-w-full px-1",children:d.executedBy||"-"})]})]})]})},d.id))})]})}),e.jsx("div",{className:"p-4 border-t bg-gray-50/30 flex justify-end",children:e.jsx(x,{variant:"outline",onClick:()=>_t(!1),className:"px-6",children:"إغلاق"})})]})}),e.jsx(je,{open:qe,onOpenChange:rt,children:e.jsxs(Se,{className:"max-w-sm mx-auto bg-white border border-gray-100 shadow-xl rounded-2xl sm:max-w-md p-6 gap-6",children:[e.jsxs("div",{className:"flex flex-col items-center text-center gap-2",children:[e.jsx("div",{className:`p-3 rounded-full ${is==="return"?"bg-amber-100 text-amber-600":"bg-red-100 text-red-600"}`,children:is==="return"?e.jsx(Za,{className:"h-6 w-6"}):e.jsx(ds,{className:"h-6 w-6"})}),e.jsx(De,{className:"text-xl font-bold text-gray-900 mt-2",children:is==="return"?"تأكيد المرتجع":"تأكيد الحذف"}),e.jsxs("div",{className:"text-sm text-gray-500 space-y-1",children:[e.jsxs("p",{children:["هل أنت متأكد من ",is==="return"?"إرجاع":"حذف"," المنتج",e.jsx("span",{className:"font-bold text-gray-900 mx-1",children:At==null?void 0:At.productName}),"بكمية",e.jsx("span",{className:"font-bold text-gray-900 mx-1 font-mono",children:Lc((At==null?void 0:At.quantity)||0)}),"؟"]}),e.jsx("p",{className:"text-xs text-gray-400",children:"سيتم تحديث المخزون والرصيد تلقائياً."})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(x,{variant:"outline",className:"h-10 border-gray-200",onClick:()=>rt(!1),children:"إلغاء"}),e.jsx(x,{className:`h-10 ${is==="return"?"bg-amber-600 hover:bg-amber-700":"bg-red-600 hover:bg-red-700"} text-white shadow-sm`,onClick:()=>{const d=At;rt(!1),d&&er(d)},children:is==="return"?"تأكيد المرتجع":"تأكيد الحذف"})]})]})}),e.jsx(Ns,{open:st,onOpenChange:Dt,mode:"verify",title:"قفل إجمالي الأرباح",description:"أدخل الرقم السري الرئيسي لعرض إجمالي الأرباح",onSuccess:()=>{Ae(!1),Dt(!1)}}),e.jsx(Ns,{open:Be,onOpenChange:tt,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const d=y==null?void 0:y.uid;if(d){const _=await Bl(d),B=(_==null?void 0:_.planType)??(_==null?void 0:_.plan)??null,te=typeof B=="string"?B.toLowerCase():null;if(B===Qs.ZERO||te==="zero"){M({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}Je(!1),tt(!1),Ls()}}),e.jsx(Ns,{open:ns,onOpenChange:Lt,mode:"verify",title:ot,description:qt,onSuccess:()=>{const d=gs.current;gs.current=null,Lt(!1),d&&d()}}),e.jsx(je,{open:Wr,onOpenChange:na,children:e.jsxs(Se,{className:"sm:max-w-[400px]",children:[e.jsxs(Te,{children:[e.jsx(De,{className:"text-center",children:"إضافة مخزون"}),e.jsxs(rs,{className:"text-center",children:["إضافة كمية للمنتج: ",e.jsx("span",{className:"font-bold text-black",children:q==null?void 0:q.name})]})]}),e.jsx("div",{className:"py-6 flex flex-col items-center gap-4",children:e.jsxs("div",{className:"flex items-center gap-4 w-full justify-center",children:[e.jsx(x,{variant:"outline",size:"icon",onClick:()=>ft(d=>String(Math.max(1,parseInt(d||"0")-1))),children:e.jsx(Za,{className:"h-4 w-4"})}),e.jsx(z,{id:"qty",type:"number",value:Tt,onChange:d=>ft(d.target.value),className:"w-32 text-center text-2xl font-bold h-12",autoFocus:!0,onKeyDown:d=>{d.key==="Enter"&&Qt()}}),e.jsx(x,{variant:"outline",size:"icon",onClick:()=>ft(d=>String(parseInt(d||"0")+1)),children:e.jsx(Nn,{className:"h-4 w-4"})})]})}),e.jsxs(mt,{className:"flex gap-2 sm:justify-center",children:[e.jsx(x,{variant:"outline",onClick:()=>na(!1),className:"flex-1",children:"إلغاء"}),e.jsx(x,{onClick:Qt,className:"flex-1 bg-emerald-600 hover:bg-emerald-700",children:"تأكيد الإضافة"})]})]})})]})}const Lc=i=>new Intl.NumberFormat("ar-EG").format(Number(i||0)),Bt=i=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(i||0))} ج.م`,Mc=i=>{try{const p=new Date(i);return isNaN(p.getTime())?new Date(`${i}T00:00:00`).toLocaleDateString("ar-EG"):p.toLocaleDateString("ar-EG")}catch{return i}},tx=({open:i,onOpenChange:p,userId:c,cashBalance:j,walletBalances:D,transactions:I})=>{const[s,w]=Ke.useState(0),[W,C]=Ke.useState(0),[O,M]=Ke.useState(0),[y,N]=Ke.useState(0),[P,Q]=Ke.useState(j||0),[$,Y]=Ke.useState(!1),[se,de]=Ke.useState(null),{toast:L}=da(),{shopId:F}=Ni()||{},{profile:ae}=Ia(),[Le,fe]=Ke.useState(!1),[oe,ne]=Ke.useState(""),[Re,Ye]=Ke.useState(!1),[Ve,Ze]=Ke.useState(!1),[ht,Ot]=Ke.useState(""),X=()=>`cashBalance_${c||"default"}_${F||(ae==null?void 0:ae.shopId)||"main"}`,Ae=ve=>`${new Intl.NumberFormat("ar-EG").format(Number(ve||0))} جنيه`;Ke.useEffect(()=>{const ve=async()=>{try{if(!c){w(0);return}const re=new Date,Je=re.getFullYear(),ee=String(re.getMonth()+1).padStart(2,"0"),R=String(re.getDate()).padStart(2,"0"),Ct=`${Je}-${ee}-${R}`;let _t;try{const xe=Ge(ke(V,"dailySales"),me("userId","==",c),...F?[me("shopId","==",F)]:[],me("date","==",Ct));_t=await He(xe)}catch{const xe=Ge(ke(V,"users",c,"dailySales"),...F?[me("shopId","==",F)]:[],me("date","==",Ct));_t=await He(xe)}let U=0;_t.forEach(xe=>{const We=xe.data(),ut=Number(We.sellingPrice??0),gt=Number(We.quantity??0);ut>0&&gt>0&&(U+=ut*gt)}),w(U)}catch(re){console.warn("فشل تحميل مبيعات الإكسسوار لليوم:",re)}},Be=async()=>{try{if(!c){setMaintenanceProfitToday(0);return}const re=new Date,Je=new Date(re.getFullYear(),re.getMonth(),re.getDate(),0,0,0,0),ee=new Date(re.getFullYear(),re.getMonth(),re.getDate(),23,59,59,999);let R;try{const _t=Ge(ke(V,"maintenance_items"),me("userId","==",c),me("status","==","completed"));R=await He(_t)}catch{R=await He(Ge(ke(V,"maintenance_items"),me("userId","==",c)))}let Ct=0;R.forEach(_t=>{var We,ut;const U=_t.data();if((U.status||"in_progress")!=="completed")return;const xe=(ut=(We=U.completedAt)==null?void 0:We.toDate)==null?void 0:ut.call(We);if(xe&&xe.getTime()>=Je.getTime()&&xe.getTime()<=ee.getTime()){const gt=Number(U.repairPrice||0);Number.isFinite(gt)&&gt>0&&(Ct+=gt)}}),M(Math.max(0,Ct))}catch(re){console.warn("فشل تحميل إجمالي فلوس الصيانة لليوم:",re)}},tt=async()=>{var re;try{if(!c){C(0);return}const Je=await Ie.getUserData(c),ee=new Date().toISOString().slice(0,10),R=(Je==null?void 0:Je.dailyReceipts)||{};R!=null&&R.date&&String(R.date).slice(0,10)===ee?(C(Number(R.accessory||0)),N(Number(R.maintenance||0))):(C(0),N(0));try{const Ct=F||(ae==null?void 0:ae.shopId)||"main",_t=await Ps(Ue(V,"dashboardData",Ct));if(_t.exists()){const U=Number(((re=_t.data())==null?void 0:re.cashBalance)||0);Q(U);try{localStorage.setItem(`cashBalance_${c}`,String(U)),localStorage.setItem(X(),String(U))}catch{}}else Q(Number((Je==null?void 0:Je.cashBalance)||j||0))}catch{Q(Number((Je==null?void 0:Je.cashBalance)||j||0))}}catch{C(0),N(0)}};i&&(ve(),Be(),tt())},[i,c,I,j,F]),Ke.useEffect(()=>{const ve=Be=>{var tt;try{const re=Number((tt=Be==null?void 0:Be.detail)==null?void 0:tt.value);Number.isFinite(re)&&Q(re)}catch{}};return window.addEventListener("cashBalanceChanged",ve),()=>window.removeEventListener("cashBalanceChanged",ve)},[i]),Ke.useEffect(()=>{if(!i||!c)return;const ve=F||(ae==null?void 0:ae.shopId)||"main";return(async()=>{var tt;try{const re=await Ps(Ue(V,"dashboardData",ve));if(re.exists()){const Je=Number(((tt=re.data())==null?void 0:tt.cashBalance)||0);Q(Je);try{localStorage.setItem(`cashBalance_${c}`,String(Je)),localStorage.setItem(X(),String(Je))}catch{}}}catch(re){console.warn("Error fetching dashboard data:",re)}})(),()=>{}},[i,c,F]);const st=Math.max(0,Number(s)-Number(W)),Dt=Math.max(0,Number(O)-Number(y)),Pt=async ve=>{if(!c)return;const Be=new Date().toISOString().slice(0,10);try{const tt=ve==="accessory"?st:Dt;if(tt<=0){L({title:"لا يوجد مبلغ لتأكيد استلامه",variant:"default"});return}const re=Math.max(0,Number(P)-tt);Q(re),ve==="accessory"?C(Je=>Je+tt):N(Je=>Je+tt),await Ie.updateUserData(c,{cashBalance:re,dailyReceipts:{date:Be,accessory:ve==="accessory"?W+tt:W,maintenance:ve==="maintenance"?y+tt:y}});try{const Je=F||(ae==null?void 0:ae.shopId)||"main";await Xt(Ue(V,"dashboardData",Je),{cashBalance:re,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${c}`,String(re)),localStorage.setItem(X(),String(re))}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:re}}))}catch{}L({title:"تم الاستلام",description:`تم خصم ${tt.toFixed(2)} من الدرج وتصفير بند ${ve==="accessory"?"الإكسسوار":"الصيانة"}`})}catch{L({title:"خطأ",description:"تعذر تنفيذ عملية تم الاستلام",variant:"destructive"})}},xs=()=>{ne(""),Ot(""),fe(!0)},le=()=>{if(!oe.trim()){L({title:"سبب الخصم مطلوب",variant:"destructive"});return}fe(!1),Ye(!0)},Me=()=>{Ye(!1),Ze(!0)},$e=async()=>{try{if(!c)return;const ve=Math.max(0,Number(ht||0));if(!Number.isFinite(ve)||ve<=0){L({title:"مبلغ غير صالح",description:"أدخل مبلغ خصم صحيح أكبر من الصفر",variant:"destructive"});return}const Be=Math.max(0,Number(P)-ve);Q(Be),await Ie.updateUserData(c,{cashBalance:Be});try{const re=F||(ae==null?void 0:ae.shopId)||"main";await Xt(Ue(V,"dashboardData",re),{cashBalance:Be,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${c}`,String(Be))}catch{}try{const re=new Date().toISOString();localStorage.setItem(X(),String(Be)),localStorage.setItem(X()+"_lastUpdated",re)}catch{}const tt={title:"ايصال خصم من الفلوس النقديه",type:"cash_deduction",amount:ve,status:"completed",createdAt:new Date,note:oe,cashierName:"الحساب الرئيسي"};try{await Ie.saveUserTransaction(c,tt)}catch{}L({title:"تم الخصم",description:`تم خصم ${ve.toFixed(2)} من الدرج`}),Ze(!1),Ot(""),ne("")}catch{L({title:"فشل الخصم",description:"تعذر تنفيذ عملية الخصم",variant:"destructive"})}};return e.jsx(je,{open:i,onOpenChange:p,children:e.jsxs(Se,{className:"sm:max-w-lg animate-in fade-in-90 zoom-in-95 slide-in-from-top-4",dir:"rtl",children:[e.jsx(Te,{children:e.jsxs(De,{className:"flex items-center gap-2 text-right",children:[e.jsx(es,{className:"h-5 w-5 text-emerald-600"}),"تفاصيل الفلوس النقدية"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between bg-amber-50 border border-amber-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 font-bold text-sm",children:[e.jsx(es,{className:"h-4 w-4"}),"مجموع الفلوس النقدية (الدرج)"]}),e.jsx("div",{className:"text-amber-700 font-extrabold text-sm",children:Ae(P)})]}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 font-bold text-sm",children:[e.jsx(ad,{className:"h-4 w-4"}),"فلوس الاكسسوار"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-blue-700 font-extrabold text-sm",children:Ae(st)}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800",onClick:()=>{de("accessory"),Y(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-emerald-50 border border-emerald-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-800 font-bold text-sm",children:[e.jsx(zl,{className:"h-4 w-4"}),"فلوس الصيانة"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-emerald-700 font-extrabold text-sm",children:Ae(Dt)}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800",onClick:()=>{de("maintenance"),Y(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-red-800 font-bold text-sm",children:"خصم فلوس من الفلوس النقديه"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(x,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800",onClick:xs,children:"خصم"})})]})]}),e.jsx(Ns,{open:$,onOpenChange:Y,mode:"verify",title:"تأكيد الرقم السري لعملية تم الاستلام",description:"يرجى إدخال الرقم السري الرئيسي لتأكيد استلام المبلغ",onSuccess:()=>{se&&(Pt(se),de(null)),Y(!1)}}),e.jsx(je,{open:Le,onOpenChange:fe,children:e.jsxs(Se,{className:"sm:max-w-sm",children:[e.jsx(Te,{children:e.jsx(De,{children:"سبب الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"deduct-reason",children:"اكتب سبب الخصم"}),e.jsx(z,{id:"deduct-reason",value:oe,onChange:ve=>ne(ve.target.value),placeholder:"سبب الخصم"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(x,{variant:"outline",onClick:()=>fe(!1),children:"إلغاء"}),e.jsx(x,{onClick:le,className:"bg-red-600 hover:bg-red-700",children:"متابعة"})]})]})}),e.jsx(Ns,{open:Re,onOpenChange:Ye,mode:"verify",title:"تأكيد الرقم السري لعملية الخصم",description:"يرجى إدخال الرقم السري الرئيسي لمتابعة الخصم",onSuccess:Me}),e.jsx(je,{open:Ve,onOpenChange:Ze,children:e.jsxs(Se,{className:"sm:max-w-sm",children:[e.jsx(Te,{children:e.jsx(De,{children:"مبلغ الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"deduct-amount",children:"أدخل مبلغ الخصم"}),e.jsx(z,{id:"deduct-amount",type:"number",value:ht,onChange:ve=>Ot(ve.target.value),placeholder:"0.00"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(x,{variant:"outline",onClick:()=>Ze(!1),children:"إلغاء"}),e.jsx(x,{onClick:$e,className:"bg-red-600 hover:bg-red-700",children:"تأكيد الخصم"})]})]})})]})})};function nd({size:i=24,className:p,...c}){return e.jsxs("svg",{width:i,height:i,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:p,...c,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}var id="AlertDialog",[sx]=Lh(id,[qc]),Ra=qc(),ld=i=>{const{__scopeAlertDialog:p,...c}=i,j=Ra(p);return e.jsx(_h,{...j,...c,modal:!0})};ld.displayName=id;var ax="AlertDialogTrigger",rx=n.forwardRef((i,p)=>{const{__scopeAlertDialog:c,...j}=i,D=Ra(c);return e.jsx(Uh,{...D,...j,ref:p})});rx.displayName=ax;var nx="AlertDialogPortal",od=i=>{const{__scopeAlertDialog:p,...c}=i,j=Ra(p);return e.jsx(Oh,{...j,...c})};od.displayName=nx;var ix="AlertDialogOverlay",cd=n.forwardRef((i,p)=>{const{__scopeAlertDialog:c,...j}=i,D=Ra(c);return e.jsx(Bh,{...D,...j,ref:p})});cd.displayName=ix;var Mr="AlertDialogContent",[lx,ox]=sx(Mr),cx=Wh("AlertDialogContent"),dd=n.forwardRef((i,p)=>{const{__scopeAlertDialog:c,children:j,...D}=i,I=Ra(c),s=n.useRef(null),w=zc(p,s),W=n.useRef(null);return e.jsx(Eh,{contentName:Mr,titleName:md,docsSlug:"alert-dialog",children:e.jsx(lx,{scope:c,cancelRef:W,children:e.jsxs(Mh,{role:"alertdialog",...I,...D,ref:w,onOpenAutoFocus:$h(D.onOpenAutoFocus,C=>{var O;C.preventDefault(),(O=W.current)==null||O.focus({preventScroll:!0})}),onPointerDownOutside:C=>C.preventDefault(),onInteractOutside:C=>C.preventDefault(),children:[e.jsx(cx,{children:j}),e.jsx(mx,{contentRef:s})]})})})});dd.displayName=Mr;var md="AlertDialogTitle",hd=n.forwardRef((i,p)=>{const{__scopeAlertDialog:c,...j}=i,D=Ra(c);return e.jsx(Fh,{...D,...j,ref:p})});hd.displayName=md;var ud="AlertDialogDescription",xd=n.forwardRef((i,p)=>{const{__scopeAlertDialog:c,...j}=i,D=Ra(c);return e.jsx(Rh,{...D,...j,ref:p})});xd.displayName=ud;var dx="AlertDialogAction",pd=n.forwardRef((i,p)=>{const{__scopeAlertDialog:c,...j}=i,D=Ra(c);return e.jsx(Vc,{...D,...j,ref:p})});pd.displayName=dx;var gd="AlertDialogCancel",fd=n.forwardRef((i,p)=>{const{__scopeAlertDialog:c,...j}=i,{cancelRef:D}=ox(gd,c),I=Ra(c),s=zc(p,D);return e.jsx(Vc,{...I,...j,ref:s})});fd.displayName=gd;var mx=({contentRef:i})=>{const p=`\`${Mr}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${Mr}\` by passing a \`${ud}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${Mr}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return n.useEffect(()=>{var j;document.getElementById((j=i.current)==null?void 0:j.getAttribute("aria-describedby"))||console.warn(p)},[p,i]),null},hx=ld,ux=od,yd=cd,bd=dd,vd=pd,wd=fd,Nd=hd,jd=xd;const xx=hx,px=ux,Sd=n.forwardRef(({className:i,...p},c)=>e.jsx(yd,{className:hs("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",i),...p,ref:c}));Sd.displayName=yd.displayName;const Dd=n.forwardRef(({className:i,...p},c)=>e.jsxs(px,{children:[e.jsx(Sd,{}),e.jsx(bd,{ref:c,className:hs("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg rounded-2xl duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",i),...p})]}));Dd.displayName=bd.displayName;const Cd=({className:i,...p})=>e.jsx("div",{className:hs("flex flex-col space-y-2 text-center sm:text-left",i),...p});Cd.displayName="AlertDialogHeader";const Id=n.forwardRef(({className:i,...p},c)=>e.jsx(Nd,{ref:c,className:hs("text-lg font-semibold",i),...p}));Id.displayName=Nd.displayName;const Ad=n.forwardRef(({className:i,...p},c)=>e.jsx(jd,{ref:c,className:hs("text-sm text-muted-foreground",i),...p}));Ad.displayName=jd.displayName;const Rl=n.forwardRef(({className:i,...p},c)=>e.jsx(vd,{ref:c,className:hs(Jc(),i),...p}));Rl.displayName=vd.displayName;const Td=n.forwardRef(({className:i,...p},c)=>e.jsx(wd,{ref:c,className:hs(Jc({variant:"outline"}),"mt-2 sm:mt-0",i),...p}));Td.displayName=wd.displayName;const Wt=i=>{try{return i.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(i)}},$c=i=>{try{return(i?new Date(i):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},$a="machine_daily_opening_values",Wa="machine_daily_opening_snapshot";function gx({open:i,onOpenChange:p}){const{toast:c}=da(),{shiftUser:j}=In(),{shopId:D,shopName:I}=Ni(),s=()=>{try{const k=Object.keys(localStorage||{}).filter(ie=>ie.startsWith("selectedShopId_"));for(const ie of k){const _e=localStorage.getItem(ie);if(_e)return _e}return null}catch{return null}};n.useEffect(()=>{try{if(i){const k=document.body.style.overflow;document.body.setAttribute("data-prev-overflow",k),document.body.style.overflow="hidden"}else{const k=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=k,document.body.removeAttribute("data-prev-overflow")}}catch{}return()=>{try{const k=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=k,document.body.removeAttribute("data-prev-overflow")}catch{}}},[i]);const[w,W]=n.useState(""),[C,O]=n.useState(""),[M,y]=n.useState(""),[N,P]=n.useState(null),[Q,$]=n.useState(null),[Y,se]=n.useState(null),[de,L]=n.useState(null),[F,ae]=n.useState(!1),[Le,fe]=n.useState(!1),[oe,ne]=n.useState(""),[Re,Ye]=n.useState(""),[Ve,Ze]=n.useState(null),[ht,Ot]=n.useState([]),[X,Ae]=n.useState([]),[st,Dt]=n.useState(!1),[Pt,xs]=n.useState(""),[le,Me]=n.useState(""),[$e,ve]=n.useState(!1),[Be,tt]=n.useState(null),[re,Je]=n.useState([]),[ee,R]=n.useState(null),[Ct,_t]=n.useState(""),[U,xe]=n.useState(!1),[We,ut]=n.useState(!1);n.useEffect(()=>{if(i)try{const k=ee?`${$a}_${ee}`:$a,ie=ee?`${Wa}_${ee}`:Wa,_e=localStorage.getItem(k);if(_e){const Fe=JSON.parse(_e);typeof(Fe==null?void 0:Fe.openingBase)=="number"&&P(Fe.openingBase),typeof(Fe==null?void 0:Fe.openingAir)=="number"&&$(Fe.openingAir),typeof(Fe==null?void 0:Fe.drawerCash)=="number"&&se(Fe.drawerCash)}else P(null),$(null),se(null);const Xe=localStorage.getItem(ie);if(Xe){const Fe=JSON.parse(Xe);typeof(Fe==null?void 0:Fe.openingBase)=="number"&&typeof(Fe==null?void 0:Fe.openingAir)=="number"?L({openingBase:Fe.openingBase,openingAir:Fe.openingAir,drawerCash:Fe.drawerCash||0}):L(null)}else L(null)}catch{}},[i,ee]),n.useEffect(()=>{(async()=>{try{const k=D||s();if(!i||!k)return;const{getDocs:ie}=await bt(async()=>{const{getDocs:ct}=await import("./index-DvnSb1Lh.js").then(H=>H.c3);return{getDocs:ct}},__vite__mapDeps([0,1]),import.meta.url),_e=ke(V,"shops",k,"machines"),Fe=(await ie(Ge(_e))).docs.map(ct=>({id:ct.id,name:String(ct.data().name||"ماكينة")}));Je(Fe);try{const ct=localStorage.getItem(`machineDaily_selected_${k}`);ct&&Fe.some(qe=>qe.id===ct)?R(ct):!ee&&Fe.length>0&&(R(Fe[0].id),localStorage.setItem(`machineDaily_selected_${k}`,Fe[0].id))}catch{}}catch(k){console.error("Load machines error:",k)}})()},[i,D]);const gt=n.useMemo(()=>(j==null?void 0:j.displayName)||(j==null?void 0:j.name)||(j==null?void 0:j.username)||void 0,[j]),ps=n.useMemo(()=>X.reduce((k,ie)=>k+(ie.profit||0),0),[X]),ns=n.useMemo(()=>X.reduce((k,ie)=>k+(ie.wholesalePrice||0),0),[X]),Lt=async()=>{try{const k=D||s();if(k&&ee){const ie=ke(V,"shops",k,"machines",ee,"transfers"),_e=await He(Ge(ie));await Promise.all(_e.docs.map(Xe=>Bs(Xe.ref)));try{localStorage.setItem(`machineDaily_transfers_${k}_${ee}`,JSON.stringify([]))}catch{}}}catch{}Ae([]),c({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."})},ot=async()=>{try{const k=D||s();if(k&&ee){const ie=ke(V,"shops",k,"machines",ee,"deliveries"),_e=await He(Ge(ie));await Promise.all(_e.docs.map(Xe=>Bs(Xe.ref)));try{localStorage.setItem(`machineDaily_deliveries_${k}_${ee}`,JSON.stringify([]))}catch{}}}catch{}Ot([]),c({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."})},It=k=>{Ot(ie=>ie.filter(_e=>_e.id!==k)),c({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},qt=()=>{P(null),$(null),se(null),L(null),W(""),O(""),y("");try{const k=ee?`${$a}_${ee}`:$a,ie=ee?`${Wa}_${ee}`:Wa;localStorage.removeItem(k),localStorage.removeItem(ie)}catch{}c({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},_s=async()=>{var Xe;const k=parseFloat(w||"0"),ie=parseFloat(C||"0"),_e=parseFloat(M||"0");if(isNaN(k)||isNaN(ie)||isNaN(_e)){c({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(k<0||ie<0||_e<0){c({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}P(k),$(ie),se(_e);try{const Fe=ee?`${$a}_${ee}`:$a,ct=ee?`${Wa}_${ee}`:Wa;localStorage.setItem(Fe,JSON.stringify({openingBase:k,openingAir:ie,drawerCash:_e})),localStorage.setItem(ct,JSON.stringify({openingBase:k,openingAir:ie,drawerCash:_e})),L({openingBase:k,openingAir:ie,drawerCash:_e});const H=D||s();if(H&&ee){const qe=Ue(V,"shops",H,"machines",ee);await sa(qe,{name:((Xe=re.find(rt=>rt.id===ee))==null?void 0:Xe.name)||"ماكينة",openingBase:k,openingAir:ie,drawerCash:_e,cashierName:gt,shopName:I||null,updatedAt:yt()},{merge:!0})}}catch{}c({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${Wt(k)}، الهواء: ${Wt(ie)}، فلوس الدرج: ${Wt(_e)}`})},gs=()=>{if(N==null||Q==null){c({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}fe(!0)},ts=()=>{const k=parseFloat(oe||"0"),ie=parseFloat(Re||"0");if(isNaN(k)||isNaN(ie)){c({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(k<0||ie<0){c({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const _e=(de==null?void 0:de.openingBase)??(N||0),Xe=(de==null?void 0:de.openingAir)??(Q||0),Fe=_e+Xe,H=k+ie-Fe;Ze(H);const qe={id:`${Date.now()}`,openingBase:_e,openingAir:Xe,deliveryBase:k,deliveryAir:ie,netResult:H,createdAt:new Date().toISOString(),cashierName:gt,requiredDrawerNoProfit:H<0?Math.round(-H*100)/100:0};(async()=>{try{const rt=D||s();rt&&ee&&(await ca(ke(V,"shops",rt,"machines",ee,"deliveries"),{cashierName:gt,openingBase:_e,openingAir:Xe,deliveryBase:k,deliveryAir:ie,netResult:H,createdAt:yt()}),await sa(Ue(V,"shops",rt,"machines",ee),{lastDeliveryAt:yt(),updatedAt:yt()},{merge:!0}))}catch(rt){console.error("Persist delivery error:",rt)}})(),Ot(rt=>[qe,...rt]);try{const rt=D||s(),At=rt&&ee?`machineDaily_deliveries_${rt}_${ee}`:`machineDaily_deliveries_${ee}`,ss=localStorage.getItem(At),is=ss?JSON.parse(ss):[],qs=[qe,...Array.isArray(is)?is:[]];localStorage.setItem(At,JSON.stringify(qs))}catch{}c({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${Wt(H)}`})},Aa=()=>{const k=parseFloat(Pt||"0"),ie=parseFloat(le||"0");if(!Number.isFinite(k)||!Number.isFinite(ie)){c({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if(k<0||ie<0){c({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(N==null||Q==null){c({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const _e=Math.round((ie-k)*100)/100;tt({wholesalePrice:k,retailPrice:ie,profit:_e}),ve(!0)},Us=async k=>{if(!Be)return;const ie={id:`transfer_${Date.now()}`,wholesalePrice:Be.wholesalePrice,retailPrice:Be.retailPrice,profit:Be.profit,createdAt:new Date().toISOString(),cashierName:gt,deductFrom:k},_e=Be.wholesalePrice,Xe=N??0,Fe=Q??0,ct=Y??0;if(_e>(k==="base"?Xe:Fe)){c({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const qe=k==="base"?Math.round((Xe-_e)*100)/100:Xe,rt=k==="air"?Math.round((Fe-_e)*100)/100:Fe,At=Be.retailPrice,ss=Math.round((ct+At)*100)/100;P(qe),$(rt),se(ss);try{const is=ee?`${$a}_${ee}`:$a,qs=ee?`${Wa}_${ee}`:Wa;localStorage.setItem(is,JSON.stringify({openingBase:qe,openingAir:rt,drawerCash:ss})),localStorage.setItem(qs,JSON.stringify({openingBase:qe,openingAir:rt,drawerCash:ss}));const Os=D||s();if(Os&&ee){const zs=Ue(V,"shops",Os,"machines",ee);await sa(zs,{openingBase:qe,openingAir:rt,drawerCash:ss,cashierName:gt,updatedAt:yt()},{merge:!0}),await ca(ke(V,"shops",Os,"machines",ee,"transfers"),{wholesalePrice:Be.wholesalePrice,retailPrice:Be.retailPrice,profit:Be.profit,deductFrom:k,cashierName:gt,createdAt:yt()})}}catch{}Ae(is=>[ie,...is]);try{const is=D||s(),qs=is&&ee?`machineDaily_transfers_${is}_${ee}`:"machineDaily_transfers",Os=localStorage.getItem(qs),zs=Os?JSON.parse(Os):[],Xa=[ie,...Array.isArray(zs)?zs:[]];localStorage.setItem(qs,JSON.stringify(Xa))}catch{}Dt(!1),xs(""),Me(""),tt(null),ve(!1),c({title:"تم تسجيل تحويل",description:`الربح الفوري: ${Wt(ie.profit)} | خصم المخزون: -${Wt(_e)} (${k==="base"?"الأساسي":"الهواء"}) | درج (المباع فقط): +${Wt(At)}`})},fa=()=>{W(""),O(""),fe(!1),ne(""),Ye(""),Ze(null)},Is=async()=>{if(!i||!ee)return;const k=D||s();if(k){try{const ie=ke(V,"shops",k,"machines",ee,"deliveries"),Fe=[...(await He(Ge(ie))).docs.map(ct=>{var rt,At;const H=ct.data(),qe=(At=(rt=H==null?void 0:H.createdAt)==null?void 0:rt.toDate)!=null&&At.call(rt)?H.createdAt.toDate():new Date;return{id:ct.id,openingBase:Number((H==null?void 0:H.openingBase)||0),openingAir:Number((H==null?void 0:H.openingAir)||0),deliveryBase:Number((H==null?void 0:H.deliveryBase)||0),deliveryAir:Number((H==null?void 0:H.deliveryAir)||0),netResult:typeof(H==null?void 0:H.netResult)=="number"?Number(H.netResult):Math.round((Number((H==null?void 0:H.deliveryBase)||0)+Number((H==null?void 0:H.deliveryAir)||0)-(Number((H==null?void 0:H.openingBase)||0)+Number((H==null?void 0:H.openingAir)||0)))*100)/100,createdAt:qe.toISOString(),cashierName:(H==null?void 0:H.cashierName)||void 0,requiredDrawerNoProfit:typeof(H==null?void 0:H.requiredDrawerNoProfit)=="number"?H.requiredDrawerNoProfit:void 0}})].sort((ct,H)=>new Date(H.createdAt).getTime()-new Date(ct.createdAt).getTime());Ot(Fe);try{localStorage.setItem(`machineDaily_deliveries_${k}_${ee}`,JSON.stringify(Fe))}catch{}}catch(ie){console.error("Error fetching deliveries:",ie)}try{const ie=ke(V,"shops",k,"machines",ee,"transfers"),Fe=[...(await He(Ge(ie))).docs.map(ct=>{var At,ss;const H=ct.data(),qe=(ss=(At=H==null?void 0:H.createdAt)==null?void 0:At.toDate)!=null&&ss.call(At)?H.createdAt.toDate():new Date,rt=H==null?void 0:H.deductFrom;return{id:ct.id,wholesalePrice:Number((H==null?void 0:H.wholesalePrice)||0),retailPrice:Number((H==null?void 0:H.retailPrice)||0),profit:Number((H==null?void 0:H.profit)??(Number((H==null?void 0:H.retailPrice)||0)-Number((H==null?void 0:H.wholesalePrice)||0)||0)),createdAt:qe.toISOString(),cashierName:(H==null?void 0:H.cashierName)||void 0,deductFrom:rt==="base"||rt==="air"?rt:void 0}})].sort((ct,H)=>new Date(H.createdAt).getTime()-new Date(ct.createdAt).getTime());Ae(Fe);try{localStorage.setItem(`machineDaily_transfers_${k}_${ee}`,JSON.stringify(Fe))}catch{}}catch(ie){console.error("Error fetching transfers:",ie)}c({title:"تم التحديث",description:"تم جلب أحدث البيانات."})}};n.useEffect(()=>{if(!i||!ee)return;const k=D||s();try{const ie=k?`machineDaily_deliveries_${k}_${ee}`:`machineDaily_deliveries_${ee}`,_e=localStorage.getItem(ie);if(_e){const ct=JSON.parse(_e);Array.isArray(ct)&&Ot(ct)}const Xe=k?`machineDaily_transfers_${k}_${ee}`:`machineDaily_transfers_${ee}`,Fe=localStorage.getItem(Xe);if(Fe){const ct=JSON.parse(Fe);Array.isArray(ct)&&Ae(ct)}}catch{}Is()},[i,D,ee]);const ra=k=>{k||fa(),p(k)};return e.jsxs(je,{open:i,onOpenChange:ra,children:[e.jsxs(Se,{className:"w-screen h-[100vh] overflow-hidden rounded-none p-0 flex flex-col dark:bg-[#121212]",children:[e.jsxs(Te,{className:"sticky top-0 bg-white dark:bg-[#0F0F0F] z-20 border-b border-gray-200 dark:border-[#333] px-4 py-3",children:[e.jsx(De,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(nd,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(rs,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"px-4 py-3 overflow-y-auto flex-1 grid grid-cols-1 gap-6",children:[e.jsxs(vt,{children:[e.jsx(Ht,{className:"pb-2",children:e.jsxs(ms,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"اختيار ماكينة"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(x,{variant:"destructive",onClick:async()=>{try{if(!D||!ee)return;const k=Ue(V,"shops",D,"machines",ee);try{const _e=await He(ke(V,"shops",D,"machines",ee,"transfers"));await Promise.all(_e.docs.map(Xe=>Bs(Xe.ref)))}catch{}try{const _e=await He(ke(V,"shops",D,"machines",ee,"deliveries"));await Promise.all(_e.docs.map(Xe=>Bs(Xe.ref)))}catch{}await Bs(k),Je(_e=>_e.filter(Xe=>Xe.id!==ee));const ie=re.find(_e=>_e.id!==ee);R(ie?ie.id:null);try{const _e=`${$a}_${ee}`,Xe=`${Wa}_${ee}`;localStorage.removeItem(_e),localStorage.removeItem(Xe)}catch{}c({title:"تم حذف الماكينة",description:"تمت الإزالة نهائيًا."})}catch{c({title:"فشل الحذف",description:"تعذر حذف الماكينة.",variant:"destructive"})}},disabled:!ee,title:"حذف الماكينة",children:e.jsx(ds,{className:"h-4 w-4"})})})]})}),e.jsx(St,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الماكينة الحالية"}),e.jsxs(Ka,{value:ee??"",onValueChange:k=>{R(k);try{const ie=D||s();ie&&localStorage.setItem(`machineDaily_selected_${ie}`,k)}catch{}},children:[e.jsx(Ya,{className:"text-right",children:e.jsx(Ha,{placeholder:"اختر ماكينة"})}),e.jsx(Qa,{children:re.map(k=>e.jsx(ua,{value:k.id,children:k.name},k.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"إنشاء ماكينة جديدة"}),e.jsx(z,{value:Ct,onChange:k=>_t(k.target.value),placeholder:"اسم الماكينة",className:"text-right"})]}),e.jsx("div",{className:"flex justify-end md:justify-start",children:e.jsx(x,{onClick:async()=>{try{if(!D){c({title:"لا يوجد محل",description:"يرجى التأكد من تحميل بيانات المحل.",variant:"destructive"});return}const k=(Ct||"").trim();if(!k){c({title:"اسم الماكينة مطلوب",description:"أدخل اسم للماكينة الجديدة.",variant:"destructive"});return}const ie=await ca(ke(V,"shops",D,"machines"),{name:k,shopId:D,createdAt:yt(),updatedAt:yt(),isActive:!0}),_e={id:ie.id,name:k};Je(Xe=>[_e,...Xe]),R(ie.id),_t(""),c({title:"تم إنشاء ماكينة",description:`تمت إضافة ${k}`})}catch(k){console.error("Create machine error:",k),c({title:"خطأ في الإنشاء",description:"تعذر إنشاء الماكينة.",variant:"destructive"})}},className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})})]})]})})]}),e.jsxs(vt,{children:[e.jsx(Ht,{className:"pb-2",children:e.jsxs(ms,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>ae(k=>!k),className:"flex items-center gap-1",children:e.jsx(jn,{className:`h-4 w-4 transition-transform ${F?"rotate-180":""}`})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(x,{variant:"outline",onClick:()=>Dt(!0),disabled:N==null||Q==null,className:"border-violet-300 text-violet-700",children:"تحويل"})}),N!=null&&Q!=null&&e.jsxs(Mt,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",Wt(N)," | هواء ",Wt(Q)," | درج ",Wt(Y??0)]})]}),e.jsxs(St,{className:`space-y-4 ${F?"":"hidden"}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(z,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:w,onChange:k=>W(k.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(z,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:C,onChange:k=>O(k.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx(z,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:M,onChange:k=>y(k.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(x,{variant:"outline",className:"mr-2",onClick:qt,children:"تصفير"}),e.jsx(x,{onClick:_s,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),e.jsxs(vt,{children:[e.jsx(Ht,{className:"pb-2",children:e.jsxs(ms,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات تحويل"}),e.jsxs(Mt,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",Wt(ps)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:Lt,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(pa,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(St,{className:"space-y-3",children:X.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-3 max-h-52 overflow-y-auto pr-1",children:X.map(k=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر الجملة"}),e.jsx("p",{className:"text-sm",children:Wt(k.wholesalePrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر التجزئة"}),e.jsx("p",{className:"text-sm",children:Wt(k.retailPrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الربح الفوري"}),e.jsx("p",{className:"text-sm text-green-700",children:Wt(k.profit)}),k.deductFrom&&e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"text-[11px] bg-violet-100 text-violet-700 border border-violet-200 rounded px-2 py-0.5",children:["الخصم من: ",k.deductFrom==="base"?"الأساسي":"الهواء"]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx($r,{className:"h-3 w-3"}),e.jsx("span",{children:$c(k.createdAt)}),k.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(bi,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",k.cashierName]})]})]})]})]},k.id))})})]}),e.jsxs(vt,{children:[e.jsx(Ht,{className:"pb-2",children:e.jsx(ms,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(St,{className:"space-y-4",children:Le?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(z,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:oe,onChange:k=>ne(k.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(z,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Re,onChange:k=>Ye(k.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>fe(!1),children:"إلغاء"}),e.jsx(x,{onClick:ts,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),Ve!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(Mt,{className:Ve>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",Wt(Ve)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(Mt,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",Wt(parseFloat(oe||"0")+parseFloat(Re||"0"))]}),e.jsxs(Mt,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",Wt(ns)]})]})]})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(x,{variant:"outline",onClick:gs,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs(vt,{children:[e.jsx(Ht,{className:"pb-2",children:e.jsxs(ms,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:ot,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(pa,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(St,{className:"space-y-3",children:ht.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:ht.map(k=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Wt(k.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Wt(k.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Wt(k.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Wt(k.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>It(k.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(ds,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${k.netResult>=0?"text-green-700":"text-red-700"}`,children:Wt(k.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",Wt(k.deliveryBase+k.deliveryAir)]}),typeof k.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",Wt(k.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx($r,{className:"h-3 w-3"}),e.jsx("span",{children:$c(k.createdAt)}),k.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(bi,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",k.cashierName]})]})]})]})]},k.id))})})]})]}),e.jsxs(mt,{className:"sticky bottom-0 bg-white dark:bg-[#0F0F0F] z-20 border-t border-gray-200 dark:border-[#333] px-4 py-3 flex items-center justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>ra(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(Da,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(je,{open:st,onOpenChange:Dt,children:e.jsxs(Se,{className:"sm:max-w-sm",children:[e.jsx(Te,{children:e.jsx(De,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(z,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Pt,onChange:k=>xs(k.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(z,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:le,onChange:k=>Me(k.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(Mt,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",Wt(parseFloat(le||"0")-parseFloat(Pt||"0")||0)]})})]}),e.jsxs(mt,{className:"flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>Dt(!1),children:"إلغاء"}),e.jsx(x,{onClick:Aa,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(xx,{open:$e,onOpenChange:ve,children:e.jsxs(Dd,{children:[e.jsxs(Cd,{children:[e.jsx(Id,{children:"اختيار مصدر الخصم"}),e.jsx(Ad,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(Td,{onClick:()=>ve(!1),children:"رجوع"}),e.jsx(Rl,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>Us("base"),children:"خصم من الأساسي"}),e.jsx(Rl,{className:"bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>Us("air"),children:"خصم من الهواء"})]})]})})]})}function fx(i,p=300){const[c,j]=Ke.useState(i);return Ke.useEffect(()=>{const D=setTimeout(()=>j(i),p);return()=>clearTimeout(D)},[i,p]),c}const yx=({userId:i,transactions:p})=>{const[c,j]=n.useState(!1),[D,I]=n.useState(!1),[s,w]=n.useState(!1),[W,C]=n.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:O}=Ia();n.useEffect(()=>{i&&c&&s&&M()},[i,c,s]);const M=async()=>{if(i)try{if(Array.isArray(p)&&p.length>0){const Y=new Date,se=Y.getMonth(),de=Y.getFullYear(),L=ks.filterVisibleTransactions(p,"monthly",i);let F=0,ae=0;L.forEach(Le=>{const fe=new Date(Le.createdAt),oe=String(Le.status||"confirmed").toLowerCase();if(fe.getMonth()!==se||fe.getFullYear()!==de||oe!=="completed"&&oe!=="confirmed")return;const ne=(Le.type||Le.txnType||"").toLowerCase(),Re={type:ne==="withdrawal"?"withdraw":ne,amount:Number(Le.amount||0),commission:Le.commission};Re.type==="withdraw"?F+=Ga.calculateProfitFromTransaction(Re):(Re.type==="send"||Re.type==="receive"||Re.type==="transfer")&&(ae+=Ga.calculateProfitFromTransaction(Re))}),C({monthlyWithdrawalProfit:Math.round(F*100)/100,monthlyTransferProfit:Math.round(ae*100)/100,lastUpdated:new Date});return}const $=Ga.getWithdrawTransferProfits(i);C({monthlyWithdrawalProfit:$.monthlyWithdrawProfit||0,monthlyTransferProfit:$.monthlyTransferProfit||0,lastUpdated:new Date})}catch($){console.error("Error loading profit data:",$)}},y=$=>`${$.toFixed(2)} ج.م`,N=async()=>{try{const $=(O==null?void 0:O.subscription)||null,Y=($==null?void 0:$.planType)??($==null?void 0:$.plan)??null,se=typeof Y=="string"?Y.toLowerCase():null;if(Y===Qs.ZERO||se==="zero"||se==="0"||Y===0)return!0}catch{}try{if(i){const $=await Bl(i),Y=($==null?void 0:$.planType)??($==null?void 0:$.plan)??null,se=typeof Y=="string"?Y.toLowerCase():null;if(Y===Qs.ZERO||se==="zero"||se==="0"||Y===0)return!0}}catch{}return!1},P=async()=>{try{if(await N()){vc({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}I(!0)},Q=async()=>{try{if(await N()){vc({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),I(!1);return}}catch{}w(!0),j(!0),I(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:P,className:"h-6 w-6 p-0 text-gray-400 hover:text-purple-600 hover:bg-purple-50 rounded-full transition-colors duration-200",title:"عرض الأرباح الشهرية",children:e.jsx(us,{className:"h-4 w-4"})}),e.jsx(je,{open:c,onOpenChange:j,children:e.jsxs(Se,{className:"max-w-[280px] sm:max-w-[320px] mx-auto bg-white border border-gray-200 shadow-xl rounded-xl p-0 overflow-hidden",children:[e.jsx(Te,{className:"bg-gray-50 px-4 py-3 border-b border-gray-100",children:e.jsxs(De,{className:"text-sm font-bold text-gray-900 flex items-center justify-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-white rounded-full border border-gray-200",children:e.jsx($r,{className:"h-4 w-4 text-purple-600"})}),"أرباح الشهر"]})}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg border border-gray-100 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-red-50 rounded-md",children:e.jsx(_r,{className:"h-3.5 w-3.5 text-red-600"})}),e.jsx("span",{className:"font-medium text-gray-700 text-sm",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-gray-900",children:y(W.monthlyWithdrawalProfit)})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg border border-gray-100 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-green-50 rounded-md",children:e.jsx(zl,{className:"h-3.5 w-3.5 text-green-600"})}),e.jsx("span",{className:"font-medium text-gray-700 text-sm",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-gray-900",children:y(W.monthlyTransferProfit)})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-purple-50 rounded-lg border border-purple-100 mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-white rounded-md shadow-sm",children:e.jsx(es,{className:"h-3.5 w-3.5 text-purple-600"})}),e.jsx("span",{className:"font-bold text-purple-900 text-sm",children:"الإجمالي"})]}),e.jsx("span",{className:"font-bold text-base text-purple-700",children:y(W.monthlyWithdrawalProfit+W.monthlyTransferProfit)})]})]}),e.jsx("div",{className:"bg-gray-50 px-4 py-3 border-t border-gray-100 flex justify-center",children:e.jsx(x,{onClick:()=>j(!1),className:"bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 hover:text-gray-900 w-full sm:w-auto px-8 rounded-lg text-sm font-medium shadow-sm",children:"إغلاق"})})]})}),e.jsx(Ns,{open:D,onOpenChange:I,onSuccess:Q,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},bx=i=>e.jsx(yx,{...i});function vx({open:i,onOpenChange:p,onSuccess:c,userId:j}){const[D,I]=n.useState(""),[s,w]=n.useState(""),[W,C]=n.useState(!1),[O,M]=n.useState(!1),[y,N]=n.useState(""),[P,Q]=n.useState(!1),[$,Y]=n.useState(!1),{toast:se}=da();n.useEffect(()=>{let F=!0;return(async()=>{const ae=await Cs.hasMasterPin(j);F&&Y(ae)})(),()=>{F=!1}},[j,i]);const de=()=>{I(""),w(""),N(""),C(!1),M(!1),p(!1)},L=async F=>{F.preventDefault(),N(""),Q(!0);try{if($){if(!await Cs.verifyMasterPin(D,j)){N("الرقم السري غير صحيح"),Q(!1);return}}else{if(D.length<4){N("يجب أن يكون الرقم السري 4 أرقام على الأقل"),Q(!1);return}if(D!==s){N("الرقم السري غير متطابق"),Q(!1);return}if(!await Cs.createMasterPin(D,j)){N("تعذر إنشاء الرقم السري الرئيسي"),Q(!1);return}}se({title:"نجح العملية",description:$?"تم التحقق من الرقم السري الرئيسي بنجاح":"تم إنشاء الرقم السري الرئيسي بنجاح"}),c(),de()}catch{N("حدث خطأ أثناء معالجة الرقم السري")}finally{Q(!1)}};return e.jsx(je,{open:i,onOpenChange:p,children:e.jsxs(Se,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(Te,{children:e.jsxs(De,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(Fa,{className:"h-5 w-5 text-green-600"}),$?"أدخل الرقم السري الرئيسي":"إنشاء الرقم السري الرئيسي"]})}),e.jsxs("form",{onSubmit:L,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:$?"أدخل الرقم السري الرئيسي لعرض بيانات الأرباح":"قم بإنشاء الرقم السري الرئيسي لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"pin",children:$?"الرقم السري الرئيسي":"الرقم السري الرئيسي الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"pin",type:W?"text":"password",value:D,onChange:F=>I(F.target.value),placeholder:$?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>C(!W),children:W?e.jsx(Zs,{className:"h-4 w-4"}):e.jsx(us,{className:"h-4 w-4"})})]})]}),!$&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"confirmPin",type:O?"text":"password",value:s,onChange:F=>w(F.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>M(!O),children:O?e.jsx(Zs,{className:"h-4 w-4"}):e.jsx(us,{className:"h-4 w-4"})})]})]}),y&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(ur,{className:"h-4 w-4"}),y]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:P,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Fa,{className:"h-4 w-4 mr-2"}),P?"جاري المعالجة...":$?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(x,{type:"button",variant:"outline",onClick:de,disabled:P,children:"إلغاء"})]})]})]})})}const wx=({userId:i,transactions:p})=>{const[c,j]=n.useState(!1),[D,I]=n.useState(!1),[s,w]=n.useState(!1),[W,C]=n.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});n.useEffect(()=>{i&&c&&s&&O()},[i,c,s,p]);const O=async()=>{if(i)try{if(Array.isArray(p)&&p.length>0){const Q=new Date,$=ks.filterVisibleTransactions(p,"daily",i);let Y=0,se=0;$.forEach(de=>{const L=new Date(de.createdAt),F=String(de.status||"confirmed").toLowerCase();if(L.toDateString()!==Q.toDateString())return;const ae=(de.type||de.txnType||"").toLowerCase(),Le=String(de.title||"");if(ae==="cash_addition"||Le.includes("إيصال إضافة نقدية"))return;const fe={type:ae==="withdrawal"?"withdraw":ae,amount:Number(de.amount||0),commission:de.commission};fe.type==="withdraw"?Y+=Ga.calculateProfitFromTransaction(fe):(fe.type==="send"||fe.type==="receive"||fe.type==="transfer")&&(se+=Ga.calculateProfitFromTransaction(fe))}),C({dailyWithdrawalProfit:Math.round(Y*100)/100,dailyTransferProfit:Math.round(se*100)/100,lastUpdated:new Date});try{Ga.updateProfitsFromTransactions(p,i)}catch{}return}const P=Ga.getWithdrawTransferProfits(i);C({dailyWithdrawalProfit:P.dailyWithdrawProfit||0,dailyTransferProfit:P.dailyTransferProfit||0,lastUpdated:new Date})}catch(P){console.error("Error loading profit data:",P)}},M=P=>`${P.toFixed(2)} ج.م`,y=()=>{Ga.hasProfitPin(i),I(!0)},N=()=>{w(!0),j(!0),I(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:y,className:"h-6 w-6 p-0 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors duration-200",title:"عرض الأرباح اليومية",children:e.jsx(us,{className:"h-4 w-4"})}),e.jsx(je,{open:c,onOpenChange:j,children:e.jsxs(Se,{className:"max-w-[280px] sm:max-w-[320px] mx-auto bg-white border border-gray-200 shadow-xl rounded-xl p-0 overflow-hidden",children:[e.jsx(Te,{className:"bg-gray-50 px-4 py-3 border-b border-gray-100",children:e.jsxs(De,{className:"text-sm font-bold text-gray-900 flex items-center justify-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-white rounded-full border border-gray-200",children:e.jsx(es,{className:"h-4 w-4 text-blue-600"})}),"أرباح اليوم"]})}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg border border-gray-100 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-red-50 rounded-md",children:e.jsx(_r,{className:"h-3.5 w-3.5 text-red-600"})}),e.jsx("span",{className:"font-medium text-gray-700 text-sm",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-gray-900",children:M(W.dailyWithdrawalProfit)})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg border border-gray-100 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-green-50 rounded-md",children:e.jsx(zl,{className:"h-3.5 w-3.5 text-green-600"})}),e.jsx("span",{className:"font-medium text-gray-700 text-sm",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-gray-900",children:M(W.dailyTransferProfit)})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-100 mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-white rounded-md shadow-sm",children:e.jsx(es,{className:"h-3.5 w-3.5 text-blue-600"})}),e.jsx("span",{className:"font-bold text-blue-900 text-sm",children:"الإجمالي"})]}),e.jsx("span",{className:"font-bold text-base text-blue-700",children:M(W.dailyWithdrawalProfit+W.dailyTransferProfit)})]})]}),e.jsx("div",{className:"bg-gray-50 px-4 py-3 border-t border-gray-100 flex justify-center",children:e.jsx(x,{onClick:()=>j(!1),className:"bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 hover:text-gray-900 w-full sm:w-auto px-8 rounded-lg text-sm font-medium shadow-sm",children:"إغلاق"})})]})}),e.jsx(vx,{open:D,onOpenChange:I,onSuccess:N,userId:i})]})},Nx=i=>e.jsx(wx,{...i});function jx({isOpen:i,onClose:p,wallets:c,walletBalances:j,onSelectWallet:D,selectedWalletId:I}){const s=W=>{D(W),p()},w=Object.values(j).reduce((W,C)=>W+(Number(C)||0),0);return e.jsx(je,{open:i,onOpenChange:p,children:e.jsxs(Se,{className:"sm:max-w-md bg-gradient-to-br from-white to-gray-50 border-0 shadow-2xl",children:[e.jsx(Te,{className:"space-y-4 pb-4 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-blue-100 rounded-full",children:e.jsx(aa,{className:"w-6 h-6 text-blue-600"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(De,{className:"text-xl font-bold text-gray-900",children:"المحافظ المتاحة"}),e.jsxs("p",{className:"text-sm text-gray-500 font-medium",children:["إجمالي الرصيد: ",e.jsxs("span",{className:"text-blue-600 font-bold text-base",children:[w.toLocaleString("en-US")," جنيه"]})]})]})]})}),e.jsx(eu,{className:"max-h-[60vh] pr-4 -mr-4",children:e.jsx("div",{className:"grid gap-3 py-2",children:c.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200",children:e.jsx("p",{children:"لا توجد محافظ مضافة"})}):c.map(W=>{const C=j[W.id]||0,O=I===W.id;return e.jsxs("button",{onClick:()=>s(W.id),className:hs("w-full group relative flex items-center justify-between p-4 rounded-xl border-2 transition-all duration-200",O?"border-blue-500 bg-blue-50/50 shadow-md ring-1 ring-blue-200":"border-transparent bg-white hover:bg-gray-50 hover:border-gray-200 shadow-sm hover:shadow-md"),children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:hs("w-12 h-12 rounded-full flex items-center justify-center transition-colors",O?"bg-blue-100 text-blue-600":"bg-gray-100 text-gray-500 group-hover:bg-gray-200"),children:e.jsx(aa,{className:"w-6 h-6"})}),e.jsxs("div",{className:"flex flex-col items-start gap-1",children:[e.jsx("span",{className:hs("font-bold text-lg",O?"text-blue-900":"text-gray-900"),children:W.name}),e.jsxs("div",{className:"flex items-center gap-1.5 text-gray-500",children:[e.jsx(Ca,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"text-sm font-medium dir-ltr",children:W.phone})]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsxs("span",{className:hs("font-extrabold text-lg",C>0?"text-emerald-600":"text-gray-400"),children:[C.toLocaleString("en-US"),e.jsx("span",{className:"text-xs mr-1 font-medium text-gray-400",children:"جنيه"})]}),O&&e.jsxs("div",{className:"flex items-center gap-1 text-xs font-bold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full",children:[e.jsx(wn,{className:"w-3 h-3"}),"مختار"]})]})]},W.id)})})})]})})}const Sx=({open:i,onOpenChange:p})=>{var na;const{shiftUser:c,isShiftActive:j,shiftStartAt:D,setShiftUser:I,startShift:s,endShift:w}=In(),{userSubscription:W,user:C,signIn:O,profile:M}=Ia(),{toast:y}=da(),[N,P]=n.useState((c==null?void 0:c.name)||""),[Q,$]=n.useState((c==null?void 0:c.username)||""),[Y,se]=n.useState(""),[de,L]=n.useState(!1),[F,ae]=n.useState(null),[Le,fe]=n.useState(""),[oe,ne]=n.useState(""),[Re,Ye]=n.useState(!1),[Ve,Ze]=n.useState(null),[ht,Ot]=n.useState(""),[X,Ae]=n.useState(""),[st,Dt]=n.useState(!1),[Pt,xs]=n.useState(!1),[le,Me]=n.useState({totalTransfers:0,totalWithdrawals:0}),[$e,ve]=n.useState(null),[Be,tt]=n.useState(""),[re,Je]=n.useState(""),[ee,R]=n.useState(0),[Ct,_t]=n.useState({}),[U,xe]=n.useState(0),[We,ut]=n.useState(0),[gt,ps]=n.useState({}),[ns,Lt]=n.useState(""),[ot,It]=n.useState(!1),qt=q=>{const Oe={"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9","۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9","٫":".","،":".","٬":"."," ":""};return q.split("").map(Tt=>Oe[Tt]??Tt).join("")},_s=()=>`cashierUsers_${(C==null?void 0:C.uid)||"default"}`,[gs,ts]=n.useState(()=>{try{let q=localStorage.getItem(_s());if(!q){const Oe=localStorage.getItem("cashierUsers");Oe&&(q=Oe)}return q?JSON.parse(q):[]}catch{return[]}});n.useEffect(()=>{(async()=>{try{if(!(C!=null&&C.uid))return;const q=Ue(V,"profiles",C.uid,"cashierUsers","list"),Oe=await Ps(q);if(Oe.exists()){const Tt=Oe.data(),ft=Array.isArray(Tt==null?void 0:Tt.users)?Tt.users:[];ft&&ft.length>0&&ts(ft)}}catch{}})()},[C==null?void 0:C.uid]),n.useEffect(()=>{if(!(C!=null&&C.uid))return;(async()=>{try{const Oe=Ue(V,"profiles",C.uid,"cashierUsers","list"),Tt=await Ps(Oe);if(Tt.exists()){const ft=Tt.data(),fs=Array.isArray(ft==null?void 0:ft.users)?ft.users:[];if(fs&&fs.length>0)ts(fs);else try{const Qt=localStorage.getItem(_s()),ys=Qt?JSON.parse(Qt):[];ts(ys)}catch{ts([])}}}catch(Oe){console.warn("Failed to fetch cashierUsers:",Oe)}})()},[C==null?void 0:C.uid]);const Aa=(na=W==null?void 0:W.subscription)==null?void 0:na.planType,Us=Aa==="yearly"?2:Aa==="lifetime"?4:Number.POSITIVE_INFINITY;n.useEffect(()=>{try{localStorage.setItem(_s(),JSON.stringify(gs));try{localStorage.removeItem("cashierUsers")}catch{}}catch{}(async()=>{try{if(!(C!=null&&C.uid))return;const q=Ue(V,"profiles",C.uid,"cashierUsers","list");await sa(q,{users:gs},{merge:!0})}catch{}})()},[gs]);const[fa,Is]=n.useState(!1),[ra,k]=n.useState(""),[ie,_e]=n.useState(null),[Xe,Fe]=n.useState([]),[ct,H]=n.useState(!1),[qe,rt]=n.useState(null),[At,ss]=n.useState(!1),[is,qs]=n.useState(!1),Os=q=>{const Oe=(c==null?void 0:c.username)===q;let Tt=!1;try{Tt=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(Oe&&!(Oe&&!j&&(ns==="الأدمن الرئيسي"||Tt))){y({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const Qt=`هل أنت متأكد من حذف المستخدم ${q}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(Qt)&&(ts(ys=>ys.filter(Ta=>Ta.username!==q)),Oe&&I(null),y({title:"تم حذف المستخدم",description:q}))},zs=()=>{if(!N.trim()||!Q.trim()||!Y.trim())return;if(gs.length>=Us){y({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(Us)?Us:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const q={name:N.trim(),username:Q.trim(),password:Y.trim()};ts(Oe=>[q,...Oe]),P(""),$(""),se("")},Xa=()=>{L(!0),ae(null),Ze(null),Ot(""),Ae("")},Vs=async()=>{try{let q=[];try{C!=null&&C.uid&&(q=await Ie.getUserTransactions(C.uid))}catch{}if(!q||q.length===0)try{const xt=await rd({merchantUserId:C==null?void 0:C.uid,limit:200});q=(xt==null?void 0:xt.transactions)||[]}catch{}const Oe=D?new Date(D):null,Tt=new Date,ft=xt=>{const nt=xt.type,Ls=xt.txnType;return nt==="withdraw"||nt==="withdrawal"||nt==="receive"||Ls==="receive"},fs=xt=>{const nt=xt.type,Ls=xt.txnType;return nt==="send"||nt==="transfer"||Ls==="send"},Qt=xt=>{if(!xt)return null;if(xt instanceof Date)return xt;try{const nt=new Date(xt);return Number.isNaN(nt.getTime())?null:nt}catch{return null}},ys=xt=>{const nt=Qt(xt.createdAt||xt.created_at||xt.timestamp);return!nt||Oe&&nt<Oe?!1:nt<=Tt},Ta=xt=>xt==="completed"||xt==="confirmed",Es=q.filter(xt=>Ta(xt.status)&&ys(xt)),xr=Es.filter(xt=>ft(xt)).reduce((xt,nt)=>{const Ls=nt.withdrawnAmount??nt.receivedAmount??nt.amount??0;return xt+(Number(Ls)||0)},0);return{totalTransfers:Es.filter(xt=>fs(xt)).reduce((xt,nt)=>{const Ls=nt.sentAmount??nt.transferredAmount??nt.amount??0;return xt+(Number(Ls)||0)},0),totalWithdrawals:xr}}catch{return{totalTransfers:0,totalWithdrawals:0}}};n.useEffect(()=>{if(Pt){try{const q=localStorage.getItem("shiftInitialReceivedDrawerFunds");q!==null&&Je(q)}catch{}try{const q=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(q!==null){const Oe=parseFloat(q);R(Number.isFinite(Oe)?Oe:0)}}catch{}}},[Pt]),n.useEffect(()=>{de&&(async()=>{try{const q=await Vs();Me(q)}catch{}})()},[de]),n.useEffect(()=>{if(!i&&!ct)return;(async()=>{try{const Tt=((C!=null&&C.uid?await Ie.getUserTransactions(C.uid):[])||[]).filter(ft=>(ft==null?void 0:ft.type)==="report"||((ft==null?void 0:ft.title)||"").includes("إيصال تسليم وردية"));Tt.sort((ft,fs)=>{const Qt=new Date(ft.createdAt||0).getTime();return new Date(fs.createdAt||0).getTime()-Qt}),Fe(Tt)}catch{Fe([])}})()},[i,Pt,ct,C==null?void 0:C.uid]);const Wr=async(q,Oe,Tt)=>{try{let ft=0,fs=0;try{const ys=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");ft=Number.isFinite(ys)?ys:0}catch{}try{const ys=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");fs=Number.isFinite(ys)?ys:0}catch{}const Qt={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(c==null?void 0:c.username)||"cashier",receiverPhone:ns||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(c==null?void 0:c.name)||(c==null?void 0:c.username)||null,deficit:Oe,deficitAmount:Oe?Tt:0,shiftStartAt:D,receivedDrawerFunds:ft,receivedWalletBalancesTotal:fs,receivedWalletBalances:Ct,deliveredDrawerFunds:U||0,deliveredWalletBalancesTotal:We||0,deliveredWalletBalances:gt,shiftProfit:Math.round(((U||0)+(We||0)-(ft+fs))*100)/100};C!=null&&C.uid&&await Ie.saveUserTransaction(C.uid,Qt),Fe(ys=>[Qt,...ys||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(je,{open:i,onOpenChange:p,children:e.jsxs(Se,{className:"sm:max-w-md",children:[e.jsx(Te,{children:e.jsx(De,{children:j?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),j?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[c==null?void 0:c.name," (",c==null?void 0:c.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),gs.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:gs.map((q,Oe)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:q.name}),e.jsx("div",{className:"text-xs text-gray-500",children:q.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(x,{size:"sm",className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>{_e(q),Is(!0)},children:"دخول"}),e.jsx(x,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>Os(q.username),children:"حذف"})]})]},Oe))})]})]}),e.jsx(mt,{className:"flex flex-wrap gap-2 justify-between",children:j?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(x,{className:"w-full sm:w-auto",variant:"destructive",onClick:Xa,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(x,{className:"w-full sm:w-auto bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>qs(!0),children:"إضافة مستخدم جديد"}),e.jsx(x,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>H(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(je,{open:is,onOpenChange:qs,children:e.jsxs(Se,{className:"sm:max-w-md",children:[e.jsx(Te,{children:e.jsx(De,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"الاسم"}),e.jsx(z,{value:N,onChange:q=>P(q.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(z,{value:Q,onChange:q=>$(q.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(z,{type:"password",autoComplete:"new-password",value:Y,onChange:q=>se(q.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(mt,{className:"flex gap-2 justify-between",children:[e.jsx(x,{variant:"secondary",onClick:()=>{qs(!1)},children:"إلغاء"}),e.jsx(x,{onClick:()=>{!N.trim()||!Q.trim()||!Y.trim()||(zs(),qs(!1))},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"حفظ المستخدم"})]})]})}),e.jsx(je,{open:ct,onOpenChange:H,children:e.jsxs(Se,{className:"sm:max-w-lg",children:[e.jsx(Te,{children:e.jsx(De,{children:"إيصالات التسليم"})}),Xe.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:Xe.map(q=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{rt(q),ss(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(q.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",q.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",q.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",q.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",q.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",q.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",q.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",q.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",q.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",q.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(q.shiftProfit??(q.deliveredDrawerFunds??0)+(q.deliveredWalletBalancesTotal??0)-(q.receivedDrawerFunds??0)-(q.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",q.shiftProfit??(q.deliveredDrawerFunds??0)+(q.deliveredWalletBalancesTotal??0)-(q.receivedDrawerFunds??0)-(q.receivedWalletBalancesTotal??0)]})]}),q.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",q.deficitAmount??0]})]},q.id))}),e.jsx(mt,{className:"flex gap-2 justify-between",children:e.jsx(x,{variant:"secondary",onClick:()=>H(!1),children:"إغلاق"})})]})}),e.jsx(je,{open:At,onOpenChange:ss,children:e.jsxs(Se,{className:"sm:max-w-md",children:[e.jsx(Te,{children:e.jsx(De,{children:"إيصال تسليم وردية"})}),qe?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(qe.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",qe.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",qe.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",qe.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",qe.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",qe.deliveredWalletBalancesTotal??0]})]})]}),qe.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",qe.deficitAmount??0]})]}),qe.receivedWalletBalances&&Object.keys(qe.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(qe.receivedWalletBalances).map(([q,Oe])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:q}),e.jsx("span",{className:"font-semibold",children:Oe})]},q))})]}),qe.deliveredWalletBalances&&Object.keys(qe.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(qe.deliveredWalletBalances).map(([q,Oe])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:q}),e.jsx("span",{className:"font-semibold",children:Oe})]},q))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(mt,{className:"flex gap-2 justify-between",children:e.jsx(x,{variant:"secondary",onClick:()=>ss(!1),children:"إغلاق"})})]})}),e.jsx(je,{open:fa,onOpenChange:Is,children:e.jsxs(Se,{className:"sm:max-w-md",children:[e.jsx(Te,{children:e.jsx(De,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:ie?`${ie.name} (${ie.username})`:""}),e.jsx(z,{type:"password",autoComplete:"off",value:ra,onChange:q=>k(q.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(mt,{className:"flex gap-2 justify-between",children:[e.jsx(x,{variant:"secondary",onClick:()=>{k(""),_e(null),Is(!1)},children:"إلغاء"}),e.jsx(x,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{if(ie){if(ra.trim()!==ie.password){y({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}I({name:ie.name,username:ie.username}),k(""),Is(!1),p(!1),s(),It(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(je,{open:ot,onOpenChange:It,children:e.jsxs(Se,{className:"sm:max-w-md",children:[e.jsx(Te,{children:e.jsx(De,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(z,{type:"text",inputMode:"decimal",value:re,onChange:q=>Je(qt(q.target.value)),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(z,{type:"text",inputMode:"decimal",value:Number.isFinite(ee)?ee:0,onChange:q=>{const Oe=parseFloat(qt(q.target.value));R(Number.isFinite(Oe)?Oe:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(mt,{className:"flex gap-2 justify-between",children:e.jsx(x,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{const q=parseFloat(re),Oe=ee,Tt=Number.isFinite(q)&&q>=0,ft=Number.isFinite(Oe)&&Oe>=0;if(!Tt||!ft){y({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(q)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(Oe))}catch{}y({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),It(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(je,{open:de,onOpenChange:q=>{q&&L(!0)},children:e.jsxs(Se,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(Te,{children:e.jsx(De,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:F==="toUser"?"default":"secondary",onClick:()=>ae("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(x,{variant:F==="toAdmin"?"default":"secondary",onClick:()=>ae("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),F==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[gs.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:gs.map((q,Oe)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(Ve==null?void 0:Ve.username)===q.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>Ze(q),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:q.name}),e.jsx("div",{className:"text-xs text-gray-500",children:q.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},Oe))})]}),e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(z,{type:"password",autoComplete:"off",value:ht,onChange:q=>Ot(q.target.value),placeholder:"أدخل كلمة السر"})]}),X&&e.jsx("div",{className:"text-xs text-red-600",children:X})]}),F==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(z,{type:"password",autoComplete:"off",value:Le,onChange:q=>fe(q.target.value),placeholder:"كلمة المرور"}),oe&&e.jsx("div",{className:"text-xs text-red-600",children:oe})]})]}),e.jsx(mt,{className:"flex gap-2 justify-between",children:e.jsx(x,{disabled:st||!F,onClick:async()=>{if(F){Dt(!0);try{const q=le;if(Vs().then(Me).catch(()=>{}),F==="toUser"){if(!Ve){Ae("يرجى اختيار المستخدم أولاً"),Dt(!1);return}if(ht.trim()!==Ve.password){Ae("كلمة السر غير صحيحة"),Dt(!1);return}w(),I({name:Ve.name,username:Ve.username}),s(),Lt(`${Ve.name} (${Ve.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}L(!1),ae(null),Ze(null),Ot(""),Ae(""),p(!1),Me(q),ve(null),tt(""),xs(!0)}else if(F==="toAdmin"){ne("");const Oe=(C==null?void 0:C.email)||"";if(!Oe){ne("لا يوجد بريد للمستخدم الرئيسي للتحقق"),Dt(!1);return}const{error:Tt}=await O(Oe,Le);if(Tt){ne("كلمة المرور غير صحيحة"),Dt(!1);return}w(),I(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}fe(""),L(!1),p(!1),Lt("الأدمن الرئيسي"),Me(q),ve(null),tt(""),xs(!0)}}catch{Ae("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{Dt(!1)}}},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"تأكيد التسليم"})})]})}),e.jsx(je,{open:Pt,onOpenChange:xs,children:e.jsxs(Se,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(Te,{children:e.jsx(De,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:ns})]}),D&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(D).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(z,{type:"number",value:re,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(z,{type:"number",value:ee,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(z,{type:"text",inputMode:"decimal",value:U,onChange:q=>{const Oe=parseFloat(qt(q.target.value));xe(Number.isFinite(Oe)?Oe:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(z,{type:"text",inputMode:"decimal",value:We,onChange:q=>{const Oe=parseFloat(qt(q.target.value));ut(Number.isFinite(Oe)?Oe:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(U??0)+(We??0)-((parseFloat(re||"0")||0)+(ee??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((U??0)+(We??0)-((parseFloat(re||"0")||0)+(ee??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"}),e.jsx("div",{className:"mt-2 grid grid-cols-1 gap-2",children:e.jsxs("div",{className:"rounded border p-2 bg-gray-50",children:[e.jsx("div",{className:"text-xs text-gray-700",children:"مطلوب من الدرج (بدون أرباح)"}),e.jsx("div",{className:"text-sm font-semibold text-gray-900",children:Math.round(((U??0)-(parseFloat(re||"0")||0))*100)/100})]})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:$e==="no"?"default":"secondary",onClick:()=>ve("no"),children:"لا"}),e.jsx(x,{variant:$e==="yes"?"default":"secondary",onClick:()=>ve("yes"),children:"نعم"})]}),$e==="yes"&&e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(z,{type:"number",value:Be,onChange:q=>tt(q.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(mt,{className:"flex gap-2 justify-between",children:e.jsx(x,{onClick:()=>{const q=$e==="yes",Oe=parseFloat(Be)||0;(async()=>await Wr(le,q,Oe))(),y({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),xs(!1)},className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:"تأكيد وحفظ الإيصال"})})]})})]})},Dx=({open:i,onOpenChange:p})=>{const{shiftUser:c,endShift:j,setShiftUser:D}=In(),[I,s]=n.useState(""),[w,W]=n.useState(""),[C,O]=n.useState([]),{user:M}=Ia();n.useEffect(()=>{(async()=>{try{if(M!=null&&M.uid){const N=Ue(V,"profiles",M.uid,"cashierUsers","list"),P=await Ps(N);if(P.exists()){const Q=P.data(),$=Array.isArray(Q==null?void 0:Q.users)?Q.users:[];if($&&$.length>0){O($);return}}}}catch{}try{const N=`cashierUsers_${(M==null?void 0:M.uid)||"default"}`;let P=localStorage.getItem(N);if(!P){const Q=localStorage.getItem("cashierUsers");Q&&(P=Q)}O(P?JSON.parse(P):[])}catch{O([])}})()},[i,M==null?void 0:M.uid]),n.useEffect(()=>{if(!i||!(M!=null&&M.uid))return;const N=async()=>{try{const Q=Ue(V,"profiles",M.uid,"cashierUsers","list"),$=await Ps(Q);if($.exists()){const Y=$.data(),se=Array.isArray(Y==null?void 0:Y.users)?Y.users:[];se&&se.length>0?O(se):P()}else P()}catch(Q){console.warn("ShiftProfileDialog cashierUsers fetch error:",Q),P()}},P=()=>{try{const Q=`cashierUsers_${(M==null?void 0:M.uid)||"default"}`;let $=localStorage.getItem(Q);if(!$){const Y=localStorage.getItem("cashierUsers");Y&&($=Y)}O($?JSON.parse($):[])}catch{O([])}};N()},[i,M==null?void 0:M.uid]);const y=async()=>{if(W(""),!c)return;const N=C.find(P=>P.username===c.username);if(!N){W("لا يوجد مستخدم مطابق لهذه الوردية");return}if(I.trim()!==N.password){W("الرقم السري غير صحيح");return}j(),D(null),s(""),p(!1)};return e.jsx(je,{open:i,onOpenChange:N=>{s(""),W(""),p(N)},children:e.jsxs(Se,{className:"sm:max-w-md",children:[e.jsx(Te,{children:e.jsx(De,{children:"بروفيل الوردية"})}),c?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:c.name}),e.jsx("div",{className:"text-xs text-gray-600",children:c.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx(z,{type:"password",value:I,onChange:N=>s(N.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),w&&e.jsx("div",{className:"text-red-600 text-xs",children:w})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(mt,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>p(!1),children:"إغلاق"}),e.jsx(x,{onClick:y,disabled:!c,children:"تسليم الوردية"})]})]})})},Cx=({open:i,onOpenChange:p})=>e.jsx(je,{open:i,onOpenChange:p,children:e.jsxs(Se,{className:"sm:max-w-lg rounded-2xl",children:[e.jsxs(Te,{children:[e.jsxs(De,{className:"text-right flex items-center gap-2 justify-end",children:[e.jsx(El,{className:"w-5 h-5"}),"سجل التغييرات الأخيرة"]}),e.jsx(rs,{className:"text-right",children:"هذه أبرز التحسينات التي تمت مؤخرًا في الواجهة."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Kc,{className:"w-5 h-5 text-amber-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحسين نافذة تعديل المديونية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"استبدال نافذة الإدخال القديمة (prompt) بحوار أنيق لإدخال المبلغ مع تأكيد."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(su,{className:"w-5 h-5 text-violet-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحديث شاشة التحميل"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:'تغيير النص إلى "صلي علي النبي" مع خط عربي جميل ونبض لطيف.'})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(El,{className:"w-5 h-5 text-green-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"بطاقات الأرباح وعدد العمليات"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"إضافة بطاقات عرض أرباح الفترة الحالية وعدد العمليات في تفاصيل المحفظة."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(El,{className:"w-5 h-5 text-blue-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"إصلاح تمرير نافذة اليومية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"منع تمرير الصفحة الخلفية عند فتح نافذة اليومية لراحة الاستخدام."})]})]})]}),e.jsx("div",{className:"flex justify-end gap-2 mt-6",children:e.jsx(x,{variant:"secondary",onClick:()=>p(!1),children:"إغلاق"})})]})});class Or{static async processTransfer(p){const{amount:c,currentCashBalance:j,currentWalletBalances:D,wallets:I,selectedWalletId:s}=p;if(c<=0)return{success:!1,newCashBalance:j,newWalletBalances:D,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!p.skipRemoteLimitsCheck)try{const O=await Sa.canPerformOperation(s,c,"transfer");if(!O.canPerform)return{success:!1,newCashBalance:j,newWalletBalances:D,message:O.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(O){return console.error("خطأ في التحقق من حدود التحويل:",O),{success:!1,newCashBalance:j,newWalletBalances:D,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(c<=0)return{success:!1,newCashBalance:j,newWalletBalances:D,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s){const O=Math.max(D[s]||0,0);if(O<c){const M=I.find(y=>y.id===s);return{success:!1,newCashBalance:j,newWalletBalances:D,message:`رصيد غير كافي في المحفظة${M?` ${M.name}`:""}. المتاح: ${O} جنيه، المطلوب: ${c} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const O=Or.calculateTotalWalletBalance(D);if(O<c)return{success:!1,newCashBalance:j,newWalletBalances:D,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${O} جنيه، المبلغ المطلوب: ${c} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const w={...D};if(s){const O=w[s]||0;w[s]=O-c}else{let O=c;for(const M of I){if(O<=0)break;const y=Math.max(w[M.id]||0,0),N=Math.min(y,O);N>0&&(w[M.id]=(w[M.id]||0)-N,O-=N)}}const W=j+c;let C="تم التحويل بنجاح";if(s){const O=w[s]||0;O<0&&(C=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${s} أصبح ${O} جنيه.`)}return{success:!0,newCashBalance:W,newWalletBalances:w,message:C}}static processDeposit(p){const{amount:c,currentCashBalance:j,currentWalletBalances:D,wallets:I}=p;if(c<=0)return{success:!1,newCashBalance:j,newWalletBalances:D,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const s=this.calculateTotalWalletBalance(D);if(s<c)return{success:!1,newCashBalance:j,newWalletBalances:D,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${s} جنيه، المبلغ المطلوب: ${c} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const w=j+c,W={...D};let C=c;const O=I.find(y=>y.isDefault);if(O&&W[O.id]>=C)W[O.id]-=C,C=0;else for(const y of I){if(C<=0)break;const N=W[y.id]||0;if(N>0){const P=Math.min(N,C);W[y.id]=N-P,C-=P}}const M=C>0?`تم الإيداع جزئياً. تم إيداع ${c-C} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${c} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:w,newWalletBalances:W,message:M}}static async processWithdraw(p){const{amount:c,currentCashBalance:j,currentWalletBalances:D,wallets:I,selectedWalletId:s}=p;if(c<=0)return{success:!1,newCashBalance:j,newWalletBalances:D,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!p.skipRemoteLimitsCheck)try{const O=await Sa.canPerformOperation(s,c,"withdraw");if(!O.canPerform)return{success:!1,newCashBalance:j,newWalletBalances:D,message:O.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(O){return console.error("خطأ في التحقق من حدود السحب:",O),{success:!1,newCashBalance:j,newWalletBalances:D,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(j<c)return{success:!1,newCashBalance:j,newWalletBalances:D,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${j} جنيه، المبلغ المطلوب: ${c} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const w=j-c,W={...D},C=s?I.find(O=>O.id===s):I.find(O=>O.isDefault)||I[0];if(C){const O=W[C.id]||0;W[C.id]=O+c}else return{success:!1,newCashBalance:j,newWalletBalances:D,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};return{success:!0,newCashBalance:w,newWalletBalances:W,message:`تم السحب بنجاح. تم إضافة ${c} جنيه إلى محفظة ${(C==null?void 0:C.name)||""}`}}static validateOperation(p,c){return p<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!c||c.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(p){return Object.values(p).reduce((c,j)=>c+Math.max(j,0),0)}static deductFromWalletsAddToCash(p,c,j,D){return this.processTransfer({amount:p,currentCashBalance:c,currentWalletBalances:j,wallets:D})}static deductFromWalletsAddToCashDeposit(p,c,j,D){return this.processDeposit({amount:p,currentCashBalance:c,currentWalletBalances:j,wallets:D})}static deductFromCashAddToWallets(p,c,j,D){return this.processWithdraw({amount:p,currentCashBalance:c,currentWalletBalances:j,wallets:D})}static applyTransactionResult(p,c,j){p.success&&(c(p.newCashBalance),j(p.newWalletBalances))}static validateTransaction(p,c,j,D){if(p<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(c==="transfer"){const I=this.calculateTotalWalletBalance(D);if(I<p)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${I} جنيه) غير كافي للمبلغ المطلوب (${p} جنيه)`}}else if(c==="withdraw"){if(j<p)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${j} جنيه) غير كافي للمبلغ المطلوب (${p} جنيه)`}}else if(c==="deposit"){const I=this.calculateTotalWalletBalance(D);if(I<p)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${I} جنيه) غير كافي للمبلغ المطلوب (${p} جنيه)`}}return{isValid:!0}}static getDeductionPreview(p,c,j){const D=[];let I=p;for(const s of j){if(I<=0)break;const w=c[s.id]||0,W=Math.min(Math.max(w,0),I);W>0&&(D.push({walletId:s.id,walletName:s.name,currentBalance:w,deductedAmount:W,newBalance:w-W}),I-=W)}return D}}let vn=null;function Ix(){const i=window;if(!vn){const p=i.AudioContext||i.webkitAudioContext;vn=new p}return vn.state==="suspended"&&vn.resume(),vn}function Ax(i,p,c){const j=c/1e3,D=Math.floor(i.sampleRate*j),I=i.createBuffer(1,D,i.sampleRate),s=I.getChannelData(0);for(let O=0;O<D;O++)s[O]=(Math.random()*2-1)*.6;const w=i.createBufferSource();w.buffer=I;const W=i.createBiquadFilter();W.type="highpass",W.frequency.value=1500,W.Q.value=.7;const C=i.createGain();C.gain.setValueAtTime(1e-4,p),C.gain.exponentialRampToValueAtTime(.4,p+.015),C.gain.exponentialRampToValueAtTime(1e-4,p+j),w.connect(W),W.connect(C),C.connect(i.destination),w.start(p),w.stop(p+j+.01)}function Tx(i,p,c,j,D,I="triangle"){const s=i.createOscillator(),w=i.createGain();s.type=I;const W=D/1e3;s.frequency.setValueAtTime(c,p),s.frequency.linearRampToValueAtTime(j,p+W),w.gain.setValueAtTime(1e-4,p),w.gain.exponentialRampToValueAtTime(.25,p+.02),w.gain.exponentialRampToValueAtTime(1e-4,p+W),s.connect(w),w.connect(i.destination),s.start(p),s.stop(p+W+.02)}function kx(){try{const i=Ix(),p=i.currentTime;Ax(i,p,90),Tx(i,p+.12,1900,1100,180,"sawtooth")}catch{}}function Px(i){if(!i)return!1;const c=i.replace(/[^0-9٠-٩]/g,"").replace(/[٠-٩]/g,j=>"0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(j)]);return/^(010|011|012|015)[0-9]{8}$/.test(c)}function _x({userId:i}){const[p,c]=Ke.useState(null),[j,D]=Ke.useState("");return null}const Pp=()=>{var uc,xc,pc,gc,fc,yc;console.log("🔥 UserDashboardPage component is loading...");const{toast:i}=da(),p=n.useRef(null),[c,j]=n.useState(0),D=async()=>{var r,l,o;const t="alkaptin678678@gmail.com",a=(l=(r=Pr.currentUser)==null?void 0:r.email)==null?void 0:l.toLowerCase();if(!a||a!==t){i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}if(!Hn||!Qn||!Gn){i({title:"بيانات ناقصة",description:"أدخل رقم الموبايل، الشركة والمبلغ",variant:"destructive"});return}try{Uo(!0);const m=await((o=Pr.currentUser)==null?void 0:o.getIdToken()),h=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...m?{Authorization:`Bearer ${m}`}:{}},body:JSON.stringify({phone:Hn,countryCode:"EG",operator:Qn,amount:Number(Gn),useLocalAmount:!0})}),u=await h.json().catch(()=>({}));h.ok&&(u!=null&&u.success)?(i({title:"تم الشحن",description:(u==null?void 0:u.message)||"تم تنفيذ عملية الشحن بنجاح"}),dl(!1),Wo(""),Fo(""),Ro("")):i({title:"فشل الشحن",description:(u==null?void 0:u.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(m){console.error("Topup request error:",m),i({title:"خطأ غير متوقع",description:"تعذّر تنفيذ عملية الشحن. حاول لاحقاً.",variant:"destructive"})}finally{Uo(!1)}},{signOut:I,user:s,profile:w}=Ia(),W=((s==null?void 0:s.email)||"").toLowerCase()==="vodafonecash00@gmail.com",C=Uc(),O=Rc(),M=qh(),{isShiftActive:y,shiftUser:N}=In(),{shopId:P,shopName:Q}=Ni(),$=zh(),Y=Vh();(()=>{try{return!!window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:"}catch{return!1}})();const[se,de]=n.useState(!1),[L,F]=n.useState(!1),[ae,Le]=n.useState(!1),[fe,oe]=n.useState(!1),[ne,Re]=n.useState([]),[Ye,Ve]=n.useState(""),[Ze,ht]=n.useState(""),[Ot,X]=n.useState(""),[Ae,st]=n.useState(""),[Dt,Pt]=n.useState(!1),[xs,le]=n.useState(!1),[Me,$e]=n.useState(null),[ve,Be]=n.useState(""),[tt,re]=n.useState(""),[Je,ee]=n.useState(!1),[R,Ct]=n.useState("");n.useEffect(()=>{const t=M==null?void 0:M.shopId;if(t&&(s!=null&&s.uid))try{const a=`selectedShopId_${s.uid}`;localStorage.setItem(a,String(t)),window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}},[M==null?void 0:M.shopId,s==null?void 0:s.uid]);const[_t,U]=n.useState([]),[xe,We]=n.useState(()=>{try{return localStorage.getItem("cashySelectedDevice")||null}catch{return null}});n.useEffect(()=>{},[]),n.useEffect(()=>{(async()=>{if(R)try{await gn.set({key:"selected_wallet_id",value:R}),console.log("📱 Synced selected_wallet_id to Native:",R)}catch(a){console.error("Failed to sync wallet to native:",a)}else await gn.remove({key:"selected_wallet_id"})})()},[R]),n.useEffect(()=>{(async()=>{if(P)try{await gn.set({key:"shopId",value:P}),console.log("📱 Synced shopId to Native:",P)}catch(a){console.error("Failed to sync shopId to native:",a)}})()},[P]);const ut=t=>!!(t&&_t.some(a=>a.id===t));async function gt(){const t=window.electronAPI,a=xe||"";if(!t||typeof t.sendUssd!="function")return null;if(!a)return i({title:"الجهاز غير محدد",description:"اتصل بالموبايل أولاً ثم اختر الجهاز من القائمة",variant:"destructive"}),null;if(ut(a))return a;try{const m=_t.find(h=>h&&h.id&&!String(h.id).includes(":"));if(m&&m.id)return We(m.id),m.id}catch{}const r=a.includes(":")?a.split(":").slice(0,2).join(":"):"";if(r&&typeof t.connectWifi=="function"){try{await t.connectWifi(r)}catch{}if(await new Promise(m=>setTimeout(m,250)),ut(a))return a}const l=a.split(":")[0],o=_t.find(m=>(m.id.startsWith(l)||m.id.includes(l))&&m.id.includes(":"));if(o!=null&&o.id){const m=o.id.split(":").slice(0,2).join(":");if(!ut(o.id)&&typeof t.connectWifi=="function"){try{await t.connectWifi(m)}catch{}await new Promise(h=>setTimeout(h,250))}if(ut(o.id))return We(o.id),o.id}return i({title:"الجهاز غير متصل",description:"فعّل Wireless debugging أو استخدم اتصال Wi‑Fi ثم أعد المحاولة",variant:"destructive"}),null}n.useEffect(()=>{const t=window.electronAPI;t&&typeof t.onAdbDevices=="function"&&t.onAdbDevices(a=>{var o;const r=Array.isArray(a)?a:[];U(r);const l=(()=>{try{return localStorage.getItem("cashySelectedDevice")||""}catch{return""}})();l&&r.some(m=>m.id===l)?We(l):(o=r[0])!=null&&o.id?We(m=>m||r[0].id):We(null)})},[]);function ps(t,a){try{const r=bs==null?void 0:bs(),l=(r==null?void 0:r.phone)||"";if(!l){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"});return}Xh(l,t,a),i({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),ar(!1),vr(!1)}catch(r){const l=(r==null?void 0:r.message)||"تعذر إرسال الكود — تحقق من البيانات";throw i({title:"فشل الإرسال",description:l,variant:"destructive"}),r}}const ns=async()=>{var r;if(!Ks||!Ks.receiver||!Ks.amount){i({title:"بيانات غير مكتملة",description:"تأكد من إدخال رقم المستقبل والمبلغ قبل الإرسال",variant:"destructive"});return}const t=String(Ks.receiver),a=Math.round(Number(Ks.amount));rr(!0);try{if((r=yi)!=null&&r.isNativePlatform&&yi.getPlatform()==="android"){const o=bs==null?void 0:bs(),m=(o==null?void 0:o.phone)||"";if(!m){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),rr(!1);return}const h=jc(m,t,a);if(!h){i({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),rr(!1);return}Zh(h),i({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),ar(!1),vr(!1);return}const l=window.electronAPI;if(l&&typeof l.sendUssd=="function"&&xe){const o=bs==null?void 0:bs(),m=(o==null?void 0:o.phone)||"";if(!m){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),rr(!1);return}const h=await gt();if(!h){rr(!1);return}const u=jc(m,t,a);if(!u){i({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),rr(!1);return}try{const v=typeof l.pickSimAutomatically=="function"?await l.pickSimAutomatically(h,m):{deviceId:h,slot:0},g=`${v.deviceId}:sim${v.slot}`;em(g),await l.sendUssd(g,u)}catch{try{await l.sendUssd(h,u)}catch(g){const f=h.includes(":")?h.split(":").slice(0,2).join(":"):"";if(f&&typeof l.connectWifi=="function")await l.connectWifi(f),await l.sendUssd(h,u);else throw g}}i({title:"تم إرسال كود التحويل",description:"تم التنفيذ بنجاح"}),ar(!1),vr(!0)}else ps(t,a)}catch(l){const o=l&&l.message?l.message:"حدث خطأ غير متوقع أثناء الإرسال";i({title:"خطأ أثناء الإرسال",description:`الجهاز: ${no||xe||"غير معروف"} — ${o}`,variant:"destructive"})}finally{rr(!1)}},Lt=async(t,a)=>{const r=window.electronAPI;try{if(r&&typeof r.enterPin=="function"&&t){await r.enterPin(t,a),vr(!1);return}const l=String((w==null?void 0:w.bridgeLink)||"").trim(),o=String((w==null?void 0:w.bridgeDeviceId)||"").trim()||void 0;if(!l){i({title:"الرابط غير مُعدّ",description:"احفظ رابط الجسر أولاً",variant:"destructive"});return}const m=String((Ks==null?void 0:Ks.receiver)||js||"").replace(/\D/g,""),h=Math.max(1,Math.round(Number((Ks==null?void 0:Ks.amount)||zt||0))||0),u=String(a||"").replace(/\D/g,""),g=(f=>{let S=(f||"").trim();return S=S.replace(/\/+$/,""),/^https?:\/\//i.test(S)||(S=`https://${S}`),S})(l);vr(!1)}catch(l){const o=(l==null?void 0:l.message)||"حدث خطأ أثناء إدخال الرقم السري";i({title:"فشل الإدخال",description:o,variant:"destructive"})}};console.log("🔥 UserDashboardPage - user:",s?"exists":"null");const[ot,It]=n.useState(!0),[qt,_s]=n.useState(!0),[gs,ts]=n.useState(!1),[Aa,Us]=n.useState(!1),[fa,Is]=n.useState(""),[ra,k]=n.useState(""),[ie,_e]=n.useState(""),[Xe,Fe]=n.useState([]),[ct,H]=n.useState(!1),[qe,rt]=n.useState(null),[At,ss]=n.useState(""),[is,qs]=n.useState(!1),[Os,zs]=n.useState(!1),[Xa,Vs]=n.useState(!1),[Wr,na]=n.useState(!1),[q,Oe]=n.useState(""),[Tt,ft]=n.useState(""),[fs,Qt]=n.useState([]),[ys,Ta]=n.useState(!1),[Es,xr]=n.useState(0),[Fr,xt]=n.useState(!1),[nt,Ls]=n.useState(null),[ji,Rr]=n.useState(!1),[ma,ka]=n.useState(""),[js,pr]=n.useState(""),[zt,er]=n.useState(""),[Pa,Br]=n.useState(""),[tr,gr]=n.useState(""),[Ur,d]=n.useState(!1),[_,B]=n.useState(""),[te,he]=n.useState(""),[ce,we]=n.useState(""),[Pe,ye]=n.useState(""),[Ce,pe]=n.useState(null),[Nt,ls]=n.useState(!1),[Js,ia]=n.useState(!1),[sr,ya]=n.useState(!1),[As,ba]=n.useState(!1),[qr,An]=n.useState(null),[Vt,zr]=n.useState(""),[as,fr]=n.useState(""),[Tn,Si]=n.useState(""),[kd,Vl]=n.useState(!1),[Ox,Ex]=n.useState(null),[Di,Jl]=n.useState(null),[Pd,Ci]=n.useState(!1);n.useEffect(()=>{(async()=>{try{const a=s!=null&&s.uid?`withdrawSenderNameInputEnabled_${s==null?void 0:s.uid}`:"withdrawSenderNameInputEnabled";let r=null;try{r=localStorage.getItem(a)??localStorage.getItem("withdrawSenderNameInputEnabled")}catch{}if(s!=null&&s.uid)try{const l=await Dr(()=>Ie.getUserData(s.uid)),o=l==null?void 0:l.withdrawSenderNameInputEnabled;if(typeof o=="boolean"){Ci(o);try{localStorage.setItem(a,o?"true":"false")}catch{}return}}catch{}Ci(r==="true")}catch{Ci(!1)}})()},[s==null?void 0:s.uid]);const kn=t=>{const a="٠١٢٣٤٥٦٧٨٩",r="۰۱۲۳۴۵۶۷۸۹";return(t||"").split("").map(l=>{const o=a.indexOf(l);if(o>-1)return String(o);const m=r.indexOf(l);return m>-1?String(m):l}).join("")},[kt,Ii]=n.useState(()=>{try{const t=localStorage.getItem("commissionMode")||localStorage.getItem("commissionMode_default");return t?t==="add":!0}catch{return!0}}),[ge,Kl]=n.useState("transfer"),[Qe,Xs]=n.useState([]),[_a,Ai]=n.useState("all"),[wt,Ss]=n.useState([]),Oa=n.useRef([]),Vr=bn({enabled:!!(s!=null&&s.uid),queryKey:["recentTransactions",s==null?void 0:s.uid,P||"main"],queryFn:async()=>{const{collection:t,query:a,where:r,orderBy:l,limit:o,getDocs:m}=await bt(async()=>{const{collection:E,query:K,where:be,orderBy:et,limit:ws,getDocs:ja}=await import("./index-DvnSb1Lh.js").then($s=>$s.c3);return{collection:E,query:K,where:be,orderBy:et,limit:ws,getDocs:ja}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await bt(async()=>{const{db:E}=await import("./index-DvnSb1Lh.js").then(K=>K.c4);return{db:E}},__vite__mapDeps([0,1]),import.meta.url),u=a(t(h,"userTransactions"),r("userId","==",String((s==null?void 0:s.uid)||"")),l("createdAt","desc"),o(100)),f=(await m(u)).docs.map(E=>{var oa;const K=E.data(),be=(oa=K.createdAt)!=null&&oa.toDate?K.createdAt.toDate():new Date(K.createdAt),et=String(K.transactionType||K.txnType||K.type||"").toLowerCase(),ws=et==="withdraw"||et==="receive"?"withdraw":"send",ja=K.status==="confirmed"?"completed":K.status||"completed",$s=K.senderMsisdn||K.senderPhone||"",Ma=K.receiverMsisdn||K.receiverPhone||"",ha=Number(K.amount??K.transferredAmount??K.withdrawnAmount??0);return{id:E.id,...K,type:ws,status:ja,senderPhone:$s,receiverPhone:Ma,amount:ha,createdAt:be}}).filter(E=>!((E==null?void 0:E.type)==="report"||String((E==null?void 0:E.title)||"").includes("إيصال تسليم وردية"))),S=new Set((Yr||[]).map(E=>String(E.id||E.originalTransactionId||""))),A=f.filter(E=>!S.has(String(E.id||""))),T=E=>{var K;return String(E.transactionId||E.id||E.reference||((K=E.receipt)==null?void 0:K.reference)||`${new Date(E.createdAt).getTime()}`)},J=new Set,Ne=[];for(const E of A){const K=T(E);J.has(K)||(J.add(K),Ne.push(E))}return Ne},staleTime:6e4,gcTime:3e5,refetchOnWindowFocus:!1,refetchOnReconnect:!0});n.useEffect(()=>{const t=()=>{try{Vr.refetch()}catch{}};return window.addEventListener("transaction-created",t),()=>{window.removeEventListener("transaction-created",t)}},[Vr]),n.useEffect(()=>{const t=Vr.data;if(t&&Array.isArray(t)){const a=Oa.current,r=Date.now(),l=a.filter(u=>{const v=t.some(S=>S.id===u.id),g=u.reference?t.some(S=>S.reference===u.reference):!1,f=r-new Date(u.createdAt).getTime()>3e5;return!v&&!g&&!f});Oa.current=l;const o=[...l,...t].sort((u,v)=>new Date(v.createdAt).getTime()-new Date(u.createdAt).getTime()),m=new Set,h=[];for(const u of o)m.has(u.id)||(m.add(u.id),h.push(u));Xs(h)}},[Vr.data]),n.useEffect(()=>{try{if(localStorage.setItem("commissionMode",kt?"add":"deduct"),s!=null&&s.uid){const t=`commissionMode_${s.uid}`;localStorage.setItem(t,kt?"add":"deduct")}}catch{}},[kt,s==null?void 0:s.uid]),n.useEffect(()=>{try{const t=new Set((Qe||[]).filter(l=>String((l==null?void 0:l.status)||"")==="completed"&&(l==null?void 0:l.linkedDebtId)).map(l=>String(l.linkedDebtId)));if(t.size===0)return;const a=wt.map(l=>{if(t.has(String(l.id))){const o=Number(l.amount||0),m=Number(l.paidAmount||0);if(l.status!=="paid"||m<o)return{...l,status:"paid",paidAmount:o}}return l});if(a.some((l,o)=>l!==wt[o])){Ss(a),(async()=>await la(a))();try{s!=null&&s.uid&&a.filter((o,m)=>o!==wt[m]&&o.status==="paid").forEach(o=>{try{Ja.send(s.uid,`تم سداد الدين بالكامل للعميل ${o.debtorName}: المدفوع ${Number(o.paidAmount||o.amount||0)} جنيه`)}catch{}})}catch{}}}catch{}},[Qe,wt,s==null?void 0:s.uid]),n.useEffect(()=>{try{const t=s!=null&&s.uid?localStorage.getItem(`commissionMode_${s.uid}`):null,a=localStorage.getItem("commissionMode"),r=localStorage.getItem("commissionMode_default"),l=t??a??r;l&&Ii(l==="add")}catch{}},[s==null?void 0:s.uid]);const[Ti,Jr]=n.useState(!1),[_d,Od]=n.useState(null),Pn=Ke.useRef(""),Yl=Ke.useRef(0);n.useEffect(()=>{const t=a=>{var l;if(Ti)return;try{const o=document.activeElement;if(o){const m=(l=o.tagName)==null?void 0:l.toLowerCase();if(m==="input"||m==="textarea"||m==="select"||m==="button"||o.isContentEditable===!0)return}}catch{}const r=Date.now();if(a.key==="Enter"){const o=(Pn.current||"").trim();Pn.current="",o&&(Od(o),Jr(!0));return}a.key.length===1&&(r-(Yl.current||0)>100&&(Pn.current=""),Pn.current+=a.key,Yl.current=r)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[Ti]);const[Ed,Ld]=n.useState(!1),[Md,ki]=n.useState(!1),[$d,Lx]=n.useState(null);n.useEffect(()=>{if(!Ur)return;const t=bs(),a=parseFloat(zt||"0")||0;let r=0;if(ge==="transfer"){if((t==null?void 0:t.defaultTransferCommission)!=null){const o=Number(t.defaultTransferCommission)||0;r=Math.round(o*a/1e3*100)/100}else{const o=as&&as.trim()!==""?parseFloat(as):0;r=Math.max(0,o)}const l=a+r;he((l||0).toString())}else{if((t==null?void 0:t.defaultWithdrawCommission)!=null){const o=Number(t.defaultWithdrawCommission)||0;r=Math.round(o*a/1e3*100)/100}else{const o=Vt&&Vt.trim()!==""?parseFloat(Vt):Math.round(a*.01*100)/100;r=Math.max(0,o)}const l=kt?a:Math.max(0,Math.round((a-r)*100)/100);he((l||0).toString())}},[Ur,zt,as,Vt,R,kt,ge]);const bs=()=>{var a,r;let t=ze.find(l=>l.id===R);if(!t)try{const l=localStorage.getItem(bl());if(l){const o=JSON.parse(l);if(Array.isArray(o)&&o.length>0){const h=localStorage.getItem(or())||((a=o.find(u=>u.isDefault))==null?void 0:a.id)||((r=o[0])==null?void 0:r.id);t=o.find(u=>u.id===h)}}}catch{}return t};n.useLayoutEffect(()=>{try{const t=`wallets_${(s==null?void 0:s.uid)||"default"}`;let a=localStorage.getItem(t);if(!a){const r=Object.keys(localStorage).find(l=>l.startsWith("wallets_"));r&&(a=localStorage.getItem(r)||null)}if(a){const r=JSON.parse(a);if(Array.isArray(r)&&r.length>0){yr(r);const l=localStorage.getItem(or()),o=l&&r.find(m=>m.id===l)||r.find(m=>m.isDefault)||r[0];o&&(Ct(o.id),ka(o.phone))}}}catch(t){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",t)}},[]),n.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",R)},[R]),n.useEffect(()=>{Vo()},[s==null?void 0:s.uid]),n.useEffect(()=>{Km()},[]);const[ze,yr]=n.useState(()=>{try{const t=Object.keys(localStorage).find(r=>r.startsWith("wallets_")),a=t?localStorage.getItem(t):null;if(a){const r=JSON.parse(a);if(Array.isArray(r))return r}}catch{}return[]}),_n=bn({enabled:!!(s!=null&&s.uid),queryKey:["wallets",s==null?void 0:s.uid],queryFn:async()=>{const{merchantWalletService:t}=await bt(async()=>{const{merchantWalletService:l}=await import("./index-DvnSb1Lh.js").then(o=>o.c5);return{merchantWalletService:l}},__vite__mapDeps([0,1]),import.meta.url),a=await t.getByMerchantId(String((s==null?void 0:s.uid)||""));return(Array.isArray(a)?a:[]).filter(l=>l.isActive===!0).map(l=>({id:l.id,name:l.label||"محفظة بدون اسم",phone:l.msisdn,isDefault:!!l.isDefault,monthlyWithdrawalLimit:l.monthlyWithdrawalLimit??l.withdrawLimit??2e5,monthlyTransferLimit:l.monthlyTransferLimit??l.transferLimit??2e5,defaultTransferCommission:l.defaultTransferCommission!=null?Number(l.defaultTransferCommission):null,defaultWithdrawCommission:l.defaultWithdrawCommission!=null?Number(l.defaultWithdrawCommission):null}))},staleTime:6e4,gcTime:3e5,refetchOnReconnect:!0});n.useEffect(()=>{var a;const t=_n.data;if(t&&Array.isArray(t)){yr(t);const r=localStorage.getItem(or());if(!!!(R&&t.find(o=>o.id===R))){const o=r&&t.find(m=>m.id===r)?r:((a=t[0])==null?void 0:a.id)||"";if(o){Ct(o);const m=t.find(h=>h.id===o);ka(String((m==null?void 0:m.phone)||""))}}}},[_n.data]),n.useEffect(()=>{const t=a=>{const{cashBalance:r,walletBalances:l,newTransaction:o,limitUpdate:m,delta:h}=a.detail||{};if(h){const{amount:u,type:v,walletId:g,commission:f}=h,S=Number(u||0),A=Number(f||0);Gt(T=>{let J=0;v==="withdraw"?J=-S+A:(v==="send"||v==="transfer")&&(J=S+A);const Ne=T+J;try{const E=Ft();localStorage.setItem(E,String(Ne)),localStorage.setItem(E+"_lastUpdated",new Date().toISOString())}catch{}return Ne}),g&&os(T=>{const J=Number(T[g]||0);let Ne=0;v==="withdraw"?Ne=S:(v==="send"||v==="transfer")&&(Ne=-S);const E=J+Ne,K={...T,[g]:E};try{const be=Zt();localStorage.setItem(be,JSON.stringify(K)),localStorage.setItem(be+"_lastUpdated",new Date().toISOString())}catch{}return K})}if(typeof r=="number"){Gt(r);try{const u=Ft();localStorage.setItem(u,String(r)),localStorage.setItem(u+"_lastUpdated",new Date().toISOString())}catch{}}if(l&&typeof l=="object"){os(l);try{const u=Zt();localStorage.setItem(u,JSON.stringify(l)),localStorage.setItem(u+"_lastUpdated",new Date().toISOString())}catch{}}if(m&&m.walletId===R&&Sr(u=>{if(!u)return u;const v=Number(m.amount||0),g=m.type==="transfer",f={...u};return g?(f.dailyTransferUsed=(f.dailyTransferUsed||0)+v,f.monthlyTransferUsed=(f.monthlyTransferUsed||0)+v):(f.dailyWithdrawUsed=(f.dailyWithdrawUsed||0)+v,f.monthlyWithdrawUsed=(f.monthlyWithdrawUsed||0)+v),f}),o){try{Oa.current&&(Oa.current.some(u=>u.id===o.id)||Oa.current.push(o))}catch{}Xs(u=>u.some(v=>v.id===o.id)?u:[o,...u]),i({title:"تم تسجيل عملية خارجية",description:"تم تحديث الأرصدة والسجلات بنجاح"});try{Vr.refetch()}catch{}}};return window.addEventListener("dashboard:external-update",t),()=>window.removeEventListener("dashboard:external-update",t)},[R]);const[Hl,Wd]=n.useState(""),Ql=(()=>{const t=Hl.replace(/\D/g,"");return t?ze.filter(a=>(a.phone||"").replace(/\D/g,"").includes(t)):ze})(),[Fd,Mx]=n.useState(null),[Rd,Gl]=n.useState(!1),[Bd,On]=n.useState(!1),[Ud,qd]=n.useState(null),[$x,zd]=n.useState([]),[Wx,Fx]=n.useState([]),[Vd,Kr]=n.useState(!1),[Pi,Zl]=n.useState("daily"),[Yr,Hr]=n.useState([]),[Jd,Rx]=n.useState(!1),va=Ke.useRef(new Set);Ke.useRef(new Set);const Kd=Ke.useRef([]);n.useEffect(()=>{Kd.current=Qe},[Qe]);const _i=async t=>{try{if(!s)return;const a=Ft(),r=Zt(),l=localStorage.getItem(a),o=localStorage.getItem(r);let m=l?parseFloat(l):Et,h=o?JSON.parse(o):{...it};const u=Number(t.withdrawnAmount??t.sentAmount??t.transferredAmount??t.amount??0);if(t.type==="send"&&(t.fromWallet||R)){m-=u;const S=t.fromWallet||R;h[S]=(h[S]||0)+u}else if(t.type==="withdraw"&&(t.fromWallet||R)){m+=u;const S=t.fromWallet||R;h[S]=Math.max(0,(h[S]||0)-u)}Gt(m),os(h);const v=new Date().toISOString();localStorage.setItem(a,m.toString()),localStorage.setItem(a+"_lastUpdated",v),localStorage.setItem(r,JSON.stringify(h)),localStorage.setItem(r+"_lastUpdated",v);const g={cashBalance:m,walletBalances:h,lastUpdated:new Date().toISOString()},f=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(f,JSON.stringify(g));try{await Ie.updateUserData(s.uid,g),localStorage.removeItem(f),lt(!1)}catch(S){console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف (مزامنة تلقائية):",S),lt(!0)}try{const S=t.fromWallet||R,A=t.type==="send"?"transfer":"withdraw";await Sa.rollbackUsage(S,u,A,t.createdAt)}catch(S){console.warn("تعذر تحديث حدود المحفظة بعد الحذف (مزامنة):",S)}try{ks.removeTransactionEffects(t,s.uid)}catch(S){console.warn("تعذر تحديث التقارير بعد الحذف (مزامنة):",S)}}catch(a){console.warn("خطأ أثناء تطبيق تأثيرات الحذف محليًا:",a)}},Yd=async t=>{try{const a=Qe.find(h=>h.id===t);if(!a||!s)return;const r=String(t),l=String((a==null?void 0:a.transactionId)||(a==null?void 0:a.reference)||""),o=va.current.has(r)||l&&va.current.has(l),m=Qe.filter(h=>h.id!==t);Xs(m);try{await Ie.removeUserTransaction(s.uid,t),await yn.permanentlyDeleteTransaction(t,s.uid)}catch(h){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",h)}if(!o){va.current.add(r),l&&va.current.add(l),await _i(a);try{s!=null&&s.uid&&Ie.removeLocalReceiptById(s.uid,t)}catch{}}i({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),On(!1)}catch(a){console.error("خطأ أثناء حذف الإيصال:",a),i({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},Hd=async t=>{var a;try{const r=Qe.find(l=>l.id===t);if(!r||!s)return;try{const l=(a=nt==null?void 0:nt.subscription)==null?void 0:a.planType;if(l===Qs.ZERO){const{dailyOperationCountService:o}=await bt(async()=>{const{dailyOperationCountService:u}=await import("./dailyOperationCountService-BD4JP70l.js");return{dailyOperationCountService:u}},__vite__mapDeps([2,0,1]),import.meta.url),m=r.type==="send"?"transfer":"withdraw";if(!(await o.checkAndIncrement(s.uid,m,5)).allowed){i({title:"تم بلوغ حد باقة الزيرو",description:"مسموح بحد أقصى 5 تأكيدات يوميًا للتحويل/السحب. جرّب غدًا أو قم بالترقية.",variant:"destructive"});return}}else if(l===Qs.TAHWEELA){const{dailyOperationCountService:o}=await bt(async()=>{const{dailyOperationCountService:u}=await import("./dailyOperationCountService-BD4JP70l.js");return{dailyOperationCountService:u}},__vite__mapDeps([2,0,1]),import.meta.url),m=r.type==="send"?"transfer":"withdraw";if(!(await o.checkAndIncrementCombined(s.uid,m,40)).allowed){i({title:"تم بلوغ حد باقة تحويله",description:"هذه الباقة تسمح بحد أقصى 40 عملية تحويل/سحب يومياً.",variant:"destructive"});return}}}catch(l){console.warn("تعذر التحقق من حد التأكيد اليومي:",l)}await Xt(Ue(V,"userTransactions",t),{status:"completed",confirmedAt:new Date}),Xs(l=>l.map(o=>o.id===t?{...o,status:"completed"}:o)),i({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),On(!1)}catch(r){console.error("خطأ أثناء إكمال الإيصال:",r),i({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}};n.useEffect(()=>{if(!s)return;(async()=>{try{const a=Ge(ke(V,"deletedTransactions"),me("userId","==",s.uid),Gh("createdAt","desc"),kr(50));(await He(a)).docs.forEach(l=>{const o=l.data(),m=String((o==null?void 0:o.originalTransactionId)||""),h=String((o==null?void 0:o.transactionId)||""),u=String((o==null?void 0:o.reference)||""),v=m||h||u||String(l.id);v&&(va.current.has(v)||(va.current.add(v),Xs(g=>{const f=g.find(S=>S.id===m);return f?((async()=>await _i(f))(),g.filter(S=>S.id!==m)):g})))})}catch(a){console.warn("تعذر جلب المعاملات المحذوفة:",a)}})()},[s==null?void 0:s.uid]),n.useEffect(()=>{if(!s)return;(async()=>{try{const a=Ue(V,"users",s.uid),r=await Ps(a);if(!r.exists())return;const l=r.data();if(!(l!=null&&l.reportsData))return;try{await ks.syncReportsDataFromFirebase(s.uid),zd(hn())}catch(o){console.warn("تعذر مزامنة reportsData من السحابة:",o)}}catch(a){console.warn("تعذر جلب users.reportsData:",a)}})()},[s==null?void 0:s.uid]);const[Xl,Qd]=n.useState(""),eo=fx(Xl,300),[En,to]=n.useState(""),[Ln,so]=n.useState(""),[Ea,Bx]=n.useState(""),[Oi,br]=n.useState(!1),[ao,Qr]=n.useState(!1),[Gd,ar]=n.useState(!1),[vs,Ei]=n.useState(null),[Ks,Zd]=n.useState(null),[ro,rr]=n.useState(!1),[Xd,vr]=n.useState(!1),[no,em]=n.useState(""),[tm,Li]=n.useState(!1),io=!1,[sm,Mn]=n.useState(!1),[am,lo]=n.useState(!1),[rm,$n]=n.useState(!1),[nm,Wn]=n.useState(!1),[im,Fn]=n.useState(!1),[lm,oo]=n.useState(!0),[Gr,om]=n.useState(!1),[cm,Rn]=n.useState(!1),[dm,co]=n.useState(!1),[Bn,mm]=n.useState(""),[mo,hm]=n.useState(!1),[um,Mi]=n.useState(!1),[xm,ho]=n.useState(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[pm,$i]=n.useState(!1);n.useEffect(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled",a=localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled");ho(a==="true")}catch{}},[s==null?void 0:s.uid]);const[gm,wr]=n.useState(!1),[fm,Wi]=n.useState(!1),[ym,uo]=n.useState(()=>{try{const t=s==null?void 0:s.uid,a=t?`debtsPinRequired_${t}`:"debtsPinRequired";return(localStorage.getItem(a)??localStorage.getItem("debtsPinRequired"))==="true"}catch{return!1}}),[bm,xo]=n.useState(!1),[po,vm]=n.useState(null),[Fi,go]=n.useState(""),[Ri,fo]=n.useState(""),[Bi,yo]=n.useState(""),[wa,bo]=n.useState(null),[G,Ba]=n.useState(null),[wm,Ua]=n.useState(!1),[Nm,Zr]=n.useState(!1),[nr,vo]=n.useState(null),[wo,Ui]=n.useState(""),[Jt,No]=n.useState(null),[Ux,qx]=n.useState(!1),[jm,qi]=n.useState(!1),[jo,zi]=n.useState(""),[Vi,ir]=n.useState(!1),[So,Ji]=n.useState(1),Sm=Y?10:20,Ki=Ke.useMemo(()=>wt.slice(0,So*Sm),[wt,So]);n.useEffect(()=>{Vi&&Ji(1)},[Vi]);const Yi=async()=>{if(jt){i({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}try{const t=await Cs.hasMasterPin(s==null?void 0:s.uid);ym&&t?Wi(!0):wr(!0)}catch{wr(!0)}};n.useEffect(()=>{try{const t=s==null?void 0:s.uid,a=t?`debtsPinRequired_${t}`:"debtsPinRequired",r=localStorage.getItem(a)??localStorage.getItem("debtsPinRequired");(r==="true"||r==="false")&&uo(r==="true")}catch{}},[s==null?void 0:s.uid]),n.useEffect(()=>{const t=()=>{try{nl()}catch{}};try{window.addEventListener("debtsUpdated",t)}catch{}return()=>{try{window.removeEventListener("debtsUpdated",t)}catch{}}},[s==null?void 0:s.uid,P,w==null?void 0:w.shopId]);const[Dm,Hi]=n.useState(!1),[Ys,Qi]=n.useState([]),[Gi,Do]=n.useState(""),[Zi,Co]=n.useState(""),[Un,Io]=n.useState(""),[Ao,Cm]=n.useState(""),[Im,qn]=n.useState(!1),[Am,To]=n.useState(""),[ko,Xi]=n.useState(""),[Po,el]=n.useState(""),[Tm,zn]=n.useState(!1),[km,tl]=n.useState(""),[_o,sl]=n.useState(""),[Pm,Nr]=n.useState(!1),[lr,Xr]=n.useState(null),[Ms,en]=n.useState(null),[tn,al]=n.useState(""),[_m,jr]=n.useState(!1),[Oo,Vn]=n.useState(0),[ea,qa]=n.useState(null),[za,rl]=n.useState(""),[at,Sr]=n.useState(null),[Om,Eo]=n.useState(""),la=async t=>{try{const a=JSON.stringify(t);localStorage.setItem(an(),a);try{localStorage.setItem(ul(),a)}catch{}try{localStorage.setItem(xl(),Date.now().toString())}catch{}if(s!=null&&s.uid){try{localStorage.setItem(`debts_unsynced_${s.uid}`,"true")}catch{}const r=[];r.push(Ie.updateUserData(s.uid,{debts:t,debtsDeletedAt:null})),Promise.all(r).then(()=>{try{localStorage.removeItem(`debts_unsynced_${s.uid}`)}catch{}}).catch(l=>{console.error("فشل مزامنة الديون:",l),lt(!0)})}}catch(a){console.error("خطأ في حفظ الديون:",a)}},nl=async()=>{try{const t=an(),a=ul(),r=xl(),l=localStorage.getItem(t),o=localStorage.getItem(a),m=localStorage.getItem(r),h=m?Number(m):0,u=g=>{if(!g)return null;try{const f=JSON.parse(g);return Array.isArray(f)?f.map(S=>{var A;return{...S,createdAt:(A=S.createdAt)!=null&&A.toDate?S.createdAt.toDate():new Date(S.createdAt),partialPayments:Array.isArray(S.partialPayments)?S.partialPayments.map(T=>{var J;return{amount:Number(T.amount)||0,paidAt:(J=T.paidAt)!=null&&J.toDate?T.paidAt.toDate():new Date(T.paidAt)}}):[]}}):[]}catch(f){return console.warn("فشل في تحليل ديون localStorage:",f),null}};let v=u(l);if(!v||v.length===0){const g=u(o);if(g&&g.length>0){v=g,Ss(g);try{localStorage.setItem(an(),JSON.stringify(g)),localStorage.removeItem(a)}catch(f){console.warn("تعذر ترحيل الديون محلياً من المفتاح الافتراضي:",f)}}}if(v&&v.length>0&&Ss(v),s!=null&&s.uid)try{const g=`debts_unsynced_${s.uid}`,f=localStorage.getItem(g)==="true",S=await Ps(Ue(V,"users",s.uid)),A=[];try{const T=query(ke(V,"debts"),me("userId","==",s.uid));(await He(T)).forEach(Ne=>{var K;const E=Ne.data();A.push({id:Ne.id,...E,amount:Number(E.amount||0),paidAmount:Number(E.paidAmount||0),createdAt:(K=E.createdAt)!=null&&K.toDate?E.createdAt.toDate():new Date(E.createdAt||Date.now()),partialPayments:Array.isArray(E.partialPayments)?E.partialPayments:[]})})}catch(T){console.warn("Failed to fetch from debts collection:",T)}if(S.exists()){const T=S.data();let J=T.debts&&Array.isArray(T.debts)?T.debts.map(K=>{var be;return{...K,amount:Number(K.amount||0),paidAmount:Number(K.paidAmount||0),createdAt:(be=K.createdAt)!=null&&be.toDate?K.createdAt.toDate():new Date(K.createdAt),partialPayments:Array.isArray(K.partialPayments)?K.partialPayments.map(et=>{var ws;return{amount:Number(et.amount)||0,paidAt:(ws=et.paidAt)!=null&&ws.toDate?et.paidAt.toDate():new Date(et.paidAt)}}):[]}}):[];if(!!T.debtsDeletedAt){Ss([]);try{localStorage.setItem(t,JSON.stringify([])),localStorage.setItem(a,JSON.stringify([]))}catch{}return}if(((J==null?void 0:J.length)||0)>0)if(f)console.log("⚠️ تم اكتشاف ديون غير متزامنة محلياً، سيتم تجاهل نسخة السحابة مؤقتاً للحفاظ على البيانات الجديدة.");else{Ss(J);try{localStorage.setItem(t,JSON.stringify(J))}catch{}}}else if(A.length>0){Ss(A);try{localStorage.setItem(t,JSON.stringify(A))}catch{}}else v&&v.length>0}catch(g){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",g)}}catch(t){console.error("خطأ في تحميل الديون:",t)}};n.useEffect(()=>{try{window.exportDebts=()=>{try{return JSON.stringify(wt||[])}catch{return"[]"}},window.importDebts=async t=>{try{const a=JSON.parse(t);if(!Array.isArray(a))throw new Error("صيغة غير صحيحة — يجب أن تكون مصفوفة");return await la(a),{ok:!0,count:a.length}}catch(a){return console.error("فشل استيراد الديون:",a),{ok:!1,error:String(a)}}},window.fixWalletsForCurrentUser=async t=>{try{if(!(s!=null&&s.uid))throw new Error("يجب تسجيل الدخول أولاً");return await(await bt(async()=>{const{merchantWalletService:r}=await import("./index-DvnSb1Lh.js").then(l=>l.c5);return{merchantWalletService:r}},__vite__mapDeps([0,1]),import.meta.url)).merchantWalletService.reassignByMsisdns(t,s.uid)}catch(a){return console.error("فشل إصلاح المحافظ للمستخدم الحالي:",a),{updated:0,failed:(t==null?void 0:t.length)||0,error:String(a)}}}}catch{}},[wt,s==null?void 0:s.uid]),n.useEffect(()=>{s!=null&&s.uid&&nl()},[s==null?void 0:s.uid]);const Em=async()=>{if(s!=null&&s.uid)try{Rr(!0);const t=await Bl(s.uid);Ls(t)}catch(t){console.error("خطأ في جلب بيانات الاشتراك:",t)}finally{Rr(!1)}},[zx,Vx]=n.useState(!1),[Lm,il]=n.useState(!1),[Et,Gt]=n.useState(0),[it,os]=n.useState({}),[Mm,Lo]=n.useState(!1),[$m,Mo]=n.useState(!1),[Wm,ll]=n.useState(!1),[Fm,Jn]=n.useState(!1),[$o,ol]=n.useState(""),[Rm,sn]=n.useState(!1),[Bm,Kn]=n.useState(!1),[cl,Yn]=n.useState(""),[Um,dl]=n.useState(!1),[Hn,Wo]=n.useState(""),[Qn,Fo]=n.useState(""),[Gn,Ro]=n.useState(""),[Bo,Uo]=n.useState(!1),[ml,hl]=n.useState(!1),[qm,qo]=n.useState(!1),[zo,zm]=n.useState([]);n.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid)||!ml)return;try{await pn.trimToMaxCount(s.uid,30)}catch{}const t=await pn.getByUser(s.uid,30);zm(t)}catch{}})()},[s==null?void 0:s.uid,ml]);const Zt=()=>{const t=P||(w==null?void 0:w.shopId)||"main";return`walletBalances_${(s==null?void 0:s.uid)||"default"}_${t}`},Ft=()=>{const t=P||(w==null?void 0:w.shopId)||"main";return`cashBalance_${(s==null?void 0:s.uid)||"default"}_${t}`},an=()=>{const t=P||(w==null?void 0:w.shopId)||"main";return`debts_${(s==null?void 0:s.uid)||"default"}_${t}`},Vm=()=>{const t=P||(w==null?void 0:w.shopId)||"main";return`customers_${(s==null?void 0:s.uid)||"default"}_${t}`},ul=()=>`debts_default_${P||(w==null?void 0:w.shopId)||"main"}`,xl=()=>{const t=P||(w==null?void 0:w.shopId)||"main";return`debts_last_write_${(s==null?void 0:s.uid)||"default"}_${t}`},pl=()=>`shopExpenses_${P||(w==null?void 0:w.shopId)||(s==null?void 0:s.uid)||"default"}`,Vo=()=>{try{const t=localStorage.getItem(pl());if(t){const a=JSON.parse(t);Fe(a.map(r=>({...r,createdAt:new Date(r.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",t)}},Jo=async t=>{try{localStorage.setItem(pl(),JSON.stringify(t)),Fe(t)}catch(a){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",a)}},Jm=async t=>{try{const a=Xe.filter(r=>r.id!==t);await Jo(a);try{if(s!=null&&s.uid&&t){const{doc:r,deleteDoc:l}=await bt(async()=>{const{doc:h,deleteDoc:u}=await import("./index-DvnSb1Lh.js").then(v=>v.c3);return{doc:h,deleteDoc:u}},__vite__mapDeps([0,1]),import.meta.url),{db:o}=await bt(async()=>{const{db:h}=await import("./index-DvnSb1Lh.js").then(u=>u.c4);return{db:h}},__vite__mapDeps([0,1]),import.meta.url),m=r(o,"shop_expenses",t);await l(m)}}catch(r){console.warn("تعذر حذف المصروف من السحابة الآن، تم الحذف محليًا وسيبقى مخزّنًا دون هذا الإيصال:",r)}i({title:"تم الحذف",description:"تم حذف إيصال المصروف نهائيًا."})}catch(a){console.error("خطأ أثناء الحذف النهائي لإيصال المصروف:",a),i({title:"فشل الحذف",description:"تعذر حذف الإيصال. حاول مرة أخرى.",variant:"destructive"})}};Ke.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid)){Vo();return}const{collection:a,query:r,where:l,getDocs:o}=await bt(async()=>{const{collection:S,query:A,where:T,getDocs:J}=await import("./index-DvnSb1Lh.js").then(Ne=>Ne.c3);return{collection:S,query:A,where:T,getDocs:J}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await bt(async()=>{const{db:S}=await import("./index-DvnSb1Lh.js").then(A=>A.c4);return{db:S}},__vite__mapDeps([0,1]),import.meta.url),h=P||(w==null?void 0:w.shopId),u=h?r(a(m,"shop_expenses"),l("shopId","==",h)):r(a(m,"shop_expenses"),l("userId","==",s.uid)),f=(await o(u)).docs.map(S=>{var J;const A=S.data(),T=(J=A.createdAt)!=null&&J.toDate?A.createdAt.toDate():A.createdAt?new Date(A.createdAt):new Date;return{id:S.id,name:String(A.name||""),amount:Number(A.amount||0),notes:A.notes?String(A.notes):void 0,source:A.source==="wallet"?"wallet":"cash",walletId:A.walletId?String(A.walletId):void 0,createdAt:T}}).sort((S,A)=>A.createdAt.getTime()-S.createdAt.getTime());Fe(f);try{localStorage.setItem(pl(),JSON.stringify(f))}catch{}}catch(a){console.error("خطأ في مزامنة مصروفات المحل من Firestore:",a)}})(),()=>t==null?void 0:t()},[s==null?void 0:s.uid,w==null?void 0:w.shopId,P]);const Zn=()=>`deficiencies_${P||(w==null?void 0:w.shopId)||(s==null?void 0:s.uid)||"default-shop"}`,Km=()=>{try{const t=Zn(),a=`deficiencies_${(s==null?void 0:s.uid)||"default"}`;if(a!==t){const l=localStorage.getItem(a),o=localStorage.getItem(t);if(l)try{const m=JSON.parse(l)||[],h=o?JSON.parse(o):[],u=Array.isArray(h)?[...h]:[],v=(g,f)=>g.some(S=>(S==null?void 0:S.id)&&(f==null?void 0:f.id)&&String(S.id)===String(f.id)||String((S==null?void 0:S.name)||"")===String((f==null?void 0:f.name)||"")&&String((S==null?void 0:S.status)||"pending")===String((f==null?void 0:f.status)||"pending"));if(Array.isArray(m))for(const g of m)v(u,g)||u.push(g);localStorage.setItem(t,JSON.stringify(u));try{localStorage.removeItem(a)}catch{}}catch{}}const r=localStorage.getItem(t);if(r){const l=JSON.parse(r);Qt(l.map(o=>({...o,createdAt:new Date(o.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل النواقص من التخزين:",t)}},gl=async t=>{try{localStorage.setItem(Zn(),JSON.stringify(t)),Qt(t)}catch(a){console.error("خطأ أثناء حفظ النواقص في التخزين:",a)}};Ke.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid))return;const{collection:a,query:r,where:l,orderBy:o,getDocs:m}=await bt(async()=>{const{collection:S,query:A,where:T,orderBy:J,getDocs:Ne}=await import("./index-DvnSb1Lh.js").then(E=>E.c3);return{collection:S,query:A,where:T,orderBy:J,getDocs:Ne}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await bt(async()=>{const{db:S}=await import("./index-DvnSb1Lh.js").then(A=>A.c4);return{db:S}},__vite__mapDeps([0,1]),import.meta.url),u=P||(w==null?void 0:w.shopId)||s.uid||"default-shop",v=r(a(h,"deficiencies"),l("shopId","==",u),o("createdAt","desc")),f=(await m(v)).docs.map(S=>{var J;const A=S.data(),T=(J=A.createdAt)!=null&&J.toDate?A.createdAt.toDate():A.createdAt?new Date(A.createdAt):new Date;return{id:S.id,name:String(A.name||""),quantity:Number(A.quantity||1),status:A.status==="purchased"?"purchased":"pending",createdAt:T}});Qt(f);try{localStorage.setItem(Zn(),JSON.stringify(f))}catch{}}catch(a){console.warn("فشل جلب النواقص من Firestore:",a)}})()},[s==null?void 0:s.uid,w==null?void 0:w.shopId,P]);const fl=async t=>{try{localStorage.setItem(Vm(),JSON.stringify(t)),Qi(t),s!=null&&s.uid&&await Ie.updateUserData(s.uid,{customers:t})}catch(a){console.error("خطأ أثناء حفظ العملاء في التخزين:",a)}},Ym=async()=>{try{if(s!=null&&s.uid){const t=await Ps(Ue(V,"users",s.uid));if(t.exists()){const a=t.data();if(a.customers&&Array.isArray(a.customers)){const r=a.customers.map(l=>{var o;return{...l,createdAt:(o=l.createdAt)!=null&&o.toDate?l.createdAt.toDate():new Date(l.createdAt)}});Qi(r);return}}}Qi([])}catch(t){console.error("خطأ أثناء تحميل العملاء من Firestore:",t)}},yl=()=>{const t=P||(w==null?void 0:w.shopId)||"main";return`transactions_${(s==null?void 0:s.uid)||"default"}_${t}`},bl=()=>{const t=P||(w==null?void 0:w.shopId)||"main";return`wallets_${(s==null?void 0:s.uid)||"default"}_${t}`},or=()=>{const t=P||(w==null?void 0:w.shopId)||"main";return`selectedWallet_${(s==null?void 0:s.uid)||"default"}_${t}`},Ko=t=>{var o;const a=String((t==null?void 0:t.transactionId)||(t==null?void 0:t.id)||""),r=String((t==null?void 0:t.reference)||(t==null?void 0:t.transactionReference)||((o=t==null?void 0:t.receipt)==null?void 0:o.reference)||""),l=new Date((t==null?void 0:t.createdAt)||0).getTime();return a||r||`${r||"ref"}-${l}`},{data:vl,refetch:Jx}=bn({queryKey:["userTransactions",s==null?void 0:s.uid],queryFn:async()=>{if(!(s!=null&&s.uid))return[];const{collection:t,query:a,where:r,orderBy:l,limit:o,getDocs:m}=await bt(async()=>{const{collection:g,query:f,where:S,orderBy:A,limit:T,getDocs:J}=await import("./index-DvnSb1Lh.js").then(Ne=>Ne.c3);return{collection:g,query:f,where:S,orderBy:A,limit:T,getDocs:J}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await bt(async()=>{const{db:g}=await import("./index-DvnSb1Lh.js").then(f=>f.c4);return{db:g}},__vite__mapDeps([0,1]),import.meta.url),u=a(t(h,"userTransactions"),r("userId","==",s.uid),l("createdAt","desc"),o(100));return(await m(u)).docs.map(g=>{var K;const f=g.data(),S=(K=f.createdAt)!=null&&K.toDate?f.createdAt.toDate():new Date(f.createdAt),A=f.txnType==="send"?"send":f.txnType==="receive"?"withdraw":f.type||"withdraw",T=f.status==="confirmed"?"completed":f.status||"completed",J=f.senderMsisdn||f.senderPhone||"",Ne=f.receiverMsisdn||f.receiverPhone||"",E=Number(f.amount??f.transferredAmount??f.withdrawnAmount??0);return{id:g.id,...f,type:A,status:T,senderPhone:J,receiverPhone:Ne,amount:E,createdAt:S,provider:f.provider||void 0}})},enabled:!!(s!=null&&s.uid),staleTime:1e3*60*5,gcTime:1e3*60*10});n.useEffect(()=>{if(vl){const a=vl.filter(h=>!((h==null?void 0:h.type)==="report"||String((h==null?void 0:h.title)||"").includes("إيصال تسليم وردية"))),r=new Set((Yr||[]).map(h=>String(h.id||h.originalTransactionId||""))),l=a.filter(h=>!r.has(String(h.id||""))),o=new Set,m=[];for(const h of l){const u=Ko(h);o.has(u)||(o.add(u),m.push(h))}Xs(m)}},[vl,Yr]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;let t=!0;return(async()=>{try{const{collection:r,query:l,where:o,getDocs:m,orderBy:h,limit:u}=await bt(async()=>{const{collection:S,query:A,where:T,getDocs:J,orderBy:Ne,limit:E}=await import("./index-DvnSb1Lh.js").then(K=>K.c3);return{collection:S,query:A,where:T,getDocs:J,orderBy:Ne,limit:E}},__vite__mapDeps([0,1]),import.meta.url),{db:v}=await bt(async()=>{const{db:S}=await import("./index-DvnSb1Lh.js").then(A=>A.c4);return{db:S}},__vite__mapDeps([0,1]),import.meta.url),g=l(r(v,"deletedTransactions"),o("userId","==",s.uid),h("createdAt","desc"),u(50)),f=await m(g);if(!t)return;f.docs.forEach(S=>{const A=S.data(),T=String((A==null?void 0:A.originalTransactionId)||""),J=String((A==null?void 0:A.transactionId)||""),Ne=String((A==null?void 0:A.reference)||""),E=T||J||Ne||String(S.id);E&&(va.current.has(E)||(va.current.add(E),Xs(K=>{const be=K.find(et=>et.id===T);return be?((async()=>await _i(be))(),K.filter(et=>et.id!==T)):K})))})}catch(r){console.warn("تعذر جلب المعاملات المحذوفة:",r)}})(),()=>{t=!1}},[s==null?void 0:s.uid]);const[wl,Xn]=n.useState(""),[Hs,Yo]=n.useState(""),Na=Ke.useMemo(()=>{const t=nt;if(!t)return!1;const a=Jh(t),r=t.planType??t.plan??null,l=typeof r=="string"?r.toLowerCase():null,o=l==="monthly"||l==="quarterly"||l==="yearly"||l==="lifetime"||r===Qs.MONTHLY||r===Qs.QUARTERLY||r===Qs.YEARLY||r===Qs.LIFETIME;return a&&o},[nt]),jt=Ke.useMemo(()=>{var l,o;const t=nt;if(!t)return!1;const a=((l=t.subscription)==null?void 0:l.planType)??((o=t.subscription)==null?void 0:o.plan)??t.planType??t.plan??null,r=typeof a=="string"?a.toLowerCase():null;return a===Qs.ZERO||r==="zero"},[nt]),$t=Ke.useMemo(()=>{var l,o;const t=nt;if(!t)return!1;const a=((l=t.subscription)==null?void 0:l.planType)??((o=t.subscription)==null?void 0:o.plan)??t.planType??t.plan??null,r=typeof a=="string"?String(a).trim().toLowerCase():null;return a===Qs.TAHWEELA||r==="tahweela"||r==="تحويله"},[nt]),Hm=()=>{if(!Na){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}de(!0)},[Kx,Yx]=n.useState(!1),[Qm,Gm]=n.useState(!1),[Zm,Xm]=n.useState(!1),[eh,th]=n.useState(!1),[sh,rn]=n.useState(!1),[cr,ei]=n.useState(""),[nn,ti]=n.useState(""),[Ho,si]=n.useState(!1),[ln,on]=n.useState(null),[Nl,ai]=n.useState(""),[ah,Qo]=n.useState(!1),[Hx,Qx]=n.useState(!1),[rh,ri]=n.useState(!1),[Go,jl]=n.useState(""),[Zo,Sl]=n.useState(""),[Xo,ec]=n.useState(!1),tc=async()=>{var t;if(s!=null&&s.uid)try{const a=`userData_${s.uid}`,r=localStorage.getItem(a),l=`debts_unsynced_${s.uid}`,o=localStorage.getItem(an()),m=localStorage.getItem(l)==="true";if(r){const h=JSON.parse(r);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",h);const u={lastSynced:new Date().toISOString()};typeof h.cashBalance=="number"&&(u.cashBalance=h.cashBalance),h.walletBalances&&typeof h.walletBalances=="object"&&(u.walletBalances=h.walletBalances),await Ie.updateUserData(s.uid,u),localStorage.removeItem(a),lt(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة");if(m&&o)try{const h=JSON.parse(o)||[],u=E=>E instanceof Date?E:typeof(E==null?void 0:E.toDate)=="function"?E.toDate():E?new Date(String(E)):new Date,v=E=>(Array.isArray(E)?E:[]).map(K=>({...K,amount:Number(K.amount||0),paidAmount:Number(K.paidAmount||0),createdAt:u(K.createdAt),partialPayments:Array.isArray(K.partialPayments)?K.partialPayments.map(be=>({amount:Number(be.amount||0),paidAt:u(be.paidAt)})):[]})),g=await Ps(Ue(V,"users",s.uid)),f=g.exists()?((t=g.data())==null?void 0:t.debts)||[]:[],S=v(f),A=v(h),T={};for(const E of S)T[String(E.id||"")]=E;const J=[],Ne=new Set;for(const E of A){const K=String(E.id||""),be=T[K];if(be){const et=Number(be.paidAmount||0)+(Array.isArray(be.partialPayments)?be.partialPayments.reduce((ha,oa)=>ha+Number(oa.amount||0),0):0),ws=Number(E.paidAmount||0)+(Array.isArray(E.partialPayments)?E.partialPayments.reduce((ha,oa)=>ha+Number(oa.amount||0),0):0),ja=String(be.status||"pending"),$s=String(E.status||"pending"),Ma=ja==="paid"||et>=Number(be.amount||0)?be:$s==="paid"?{...be,paidAmount:Number(E.paidAmount||0),partialPayments:E.partialPayments,status:"paid"}:ws>et?{...be,paidAmount:Number(E.paidAmount||0),partialPayments:E.partialPayments,status:ws>=Number(be.amount||0)?"paid":"pending"}:be;J.push(Ma),Ne.add(K)}else J.push(E),Ne.add(K)}for(const E of S){const K=String(E.id||"");Ne.has(K)||J.push(E)}await Ie.updateUserData(s.uid,{debts:J});try{localStorage.removeItem(l)}catch{}lt(!1)}catch{lt(!0)}}catch(a){console.error("❌ فشل في مزامنة البيانات:",a),i({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},[sc,ni]=n.useState({keepLastCount:30,intervalDays:7,lastResetAt:null});n.useEffect(()=>{(async()=>{if(s!=null&&s.uid)try{const a=await Ie.getUserData(s.uid),r=(a==null?void 0:a.recentReset)||{},l=Number(r==null?void 0:r.keepLastCount)>0?Number(r.keepLastCount):30,o=Number(r==null?void 0:r.intervalDays)>0?Number(r.intervalDays):7,m=g=>g instanceof Date?g:typeof(g==null?void 0:g.toDate)=="function"?g.toDate():g?new Date(String(g)):null,h=r!=null&&r.lastResetAt?m(r.lastResetAt):null,u=new Date;!h||u.getTime()-h.getTime()>=o*24*60*60*1e3?(await Ie.updateUserData(s.uid,{recentReset:{keepLastCount:l,intervalDays:o,lastResetAt:u}}),ni({keepLastCount:l,intervalDays:o,lastResetAt:u})):ni({keepLastCount:l,intervalDays:o,lastResetAt:h})}catch{ni({keepLastCount:30,intervalDays:7,lastResetAt:null})}})()},[s==null?void 0:s.uid]);const ac=Ke.useMemo(()=>{const t=Qe||[],a=h=>h instanceof Date?h:typeof(h==null?void 0:h.toDate)=="function"?h.toDate():new Date(String(h)),r=new Date,l=new Date(r.getFullYear(),r.getMonth(),1),o=new Date(r.getFullYear(),r.getMonth()+1,1);return[...t].sort((h,u)=>a(u.createdAt).getTime()-a(h.createdAt).getTime()).filter(h=>{const u=a(h.createdAt);return u>=l&&u<o})},[Qe]),nh=Ke.useMemo(()=>{const t=Qe||[],a=h=>h instanceof Date?h:typeof(h==null?void 0:h.toDate)=="function"?h.toDate():new Date(String(h)),r=new Date,l=new Date(r.getFullYear(),r.getMonth(),1),o=new Date(r.getFullYear(),r.getMonth()+1,1),m=t.filter(h=>{const u=a(h.createdAt);return u>=l&&u<o}).length;return Math.max(0,((Qe==null?void 0:Qe.length)||0)-m)},[Qe==null?void 0:Qe.length]),ii=Ke.useMemo(()=>{const t=new Date,a=new Date(t.getFullYear(),t.getMonth(),1),r=new Date(t.getFullYear(),t.getMonth()+1,1),l={};for(const m of Qe){const h=new Date(m.createdAt||0);if(!(h>=a&&h<r))continue;const u=String(m.type||m.txnType||"").toLowerCase();if(!(u==="send"||u==="withdraw"||u==="transfer"))continue;const v=String(m.receiverPhone||m.senderPhone||"").trim();if(!v)continue;const g=Gs(v),f=Number(m.amount||m.withdrawnAmount||m.sentAmount||0)||0;l[g]||(l[g]={phone:g,count:0,total:0}),l[g].count+=1,l[g].total+=f}return Object.values(l).sort((m,h)=>h.count!==m.count?h.count-m.count:h.total-m.total).slice(0,10)},[Qe]),ih=t=>{const a=Gs(String(t));return a.startsWith("+20")?"20"+a.slice(3):a.startsWith("0")?"20"+a.slice(1):a.replace(/[^0-9]/g,"")},lh=t=>{const a=ih(t.phone),r=`عميل VIP هذا الشهر
عدد العمليات: ${t.count}
الإجمالي: ${t.total} جنيه`,l=`https://wa.me/${a}?text=${encodeURIComponent(r)}`;try{window.open(l,"_blank")}catch{}};n.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid))return;const t=`${new Date().getFullYear()}-${new Date().getMonth()+1}`;await Ie.updateUserData(s.uid,{vipTop10:ii,vipMonthTag:t})}catch{}})()},[s==null?void 0:s.uid,ii]);async function rc(){const t=new Date,a=new Intl.DateTimeFormat("ar-EG",{timeZone:"Africa/Cairo",year:"numeric",month:"2-digit",day:"2-digit"}).format(t),r=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0,0),l=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59,999),o=(Qe||[]).filter(T=>{const J=new Date(T.createdAt||0);return J>=r&&J<=l}),m=o.length,h=o.filter(T=>String(T.type||T.txnType||"").toLowerCase()==="withdraw"||String(T.type||"").toLowerCase()==="receive").reduce((T,J)=>T+(J.withdrawnAmount!=null?Number(J.withdrawnAmount):Number(J.amount||0)),0),u=o.filter(T=>String(T.type||T.txnType||"").toLowerCase()==="send"||String(T.type||"").toLowerCase()==="transfer").reduce((T,J)=>T+(J.sentAmount!=null?Number(J.sentAmount):Number(J.amount||0)),0);let v=0;try{v=o.reduce((T,J)=>T+ks.calculateTransactionProfit(J),0)}catch{}let g=0;try{const T=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(t),J=Ge(ke(V,"dailySales"),me("userId","==",(s==null?void 0:s.uid)||""));g=(await He(J)).docs.map(K=>K.data()).filter(K=>String(K.date||T)===T).reduce((K,be)=>K+Number(be.sellingPrice||be.price||0)*Number(be.quantity||1),0)}catch{}let f=0;try{f=(wt||[]).filter(J=>String(J.status||"")==="pending").reduce((J,Ne)=>{const E=Number(Ne.paidAmount||0)+(Array.isArray(Ne.partialPayments)?Ne.partialPayments:[]).reduce((K,be)=>K+Number(be.amount||0),0);return J+Math.max(0,Number(Ne.amount||0)-E)},0)}catch{}let S="";try{const T=P||(w==null?void 0:w.shopId)||null,J=T?Ge(ke(V,"deficiencies"),me("shopId","==",T)):Ge(ke(V,"deficiencies"),me("userId","==",(s==null?void 0:s.uid)||""));S=(await He(J)).docs.map(be=>be.data()).filter(be=>String(be.status||"pending")==="pending").slice(0,10).map((be,et)=>`${et+1}- ${String(be.name||be.productName||"عنصر")} × ${Number(be.quantity||be.qty||0)}`).join(`
`)}catch{}return[`تقرير يومي - ${a}`,`عدد العمليات: ${m}`,`إجمالي المسحوبات: ${h} جنيه`,`إجمالي الإرسال: ${u} جنيه`,`الأرباح: ${v} جنيه`,`إجمالي مبيعات الاكسسوار: ${g} جنيه`,`إجمالي الديون: ${f} جنيه`,"نواقص الاكسسوار:",S||"لا توجد عناصر مسجلة"].join(`
`)}const nc=Ke.useCallback(()=>{let t=ac;const a=eo.trim();if(a&&(t=t.filter(r=>{const l=r;return String(l.type||"").toLowerCase()==="cash_addition"||String(l.txnType||"").toLowerCase()==="cash_addition"||String(l.title||"").includes("إيصال إضافة نقدية")?!0:r.senderPhone&&r.senderPhone.includes(a)||r.receiverPhone&&r.receiverPhone.includes(a)})),En){const r=new Date(En);t=t.filter(l=>{const o=new Date(l.createdAt);if(Ln){const[m,h]=Ln.split(":"),u=new Date(r);u.setHours(parseInt(m),parseInt(h),0,0);const v=new Date(u);return v.setHours(v.getHours()+1),o>=u&&o<v}else return o.toDateString()===r.toDateString()})}try{t=[...t].sort((r,l)=>{const o=new Date(r.createdAt||0).getTime();return new Date(l.createdAt||0).getTime()-o})}catch{}return t},[ac,eo,En,Ln]),ic=async()=>{if(jt||$t){i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"});return}if(!(s!=null&&s.uid)){i({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}try{const t=await rc(),a=s!=null&&s.uid?`tg_daily_report_last_${s.uid}`:"tg_daily_report_last",r=Date.now();let l=!0;try{const o=localStorage.getItem(a);if(o){const m=JSON.parse(o),h=Number((m==null?void 0:m.at)||0);r-h<3e4&&(l=!1)}}catch{}if(l){await Ja.send(s.uid,t);try{localStorage.setItem(a,JSON.stringify({at:r}))}catch{}}i({title:"تم الإرسال",description:"تم إرسال التقرير اليومي إلى تليجرام",variant:"default"})}catch{i({title:"فشل الإرسال",description:"تعذّر إرسال التقرير اليومي إلى تليجرام",variant:"destructive"})}},[oh,li]=n.useState(!1),[lc,oi]=n.useState(""),[ch,ci]=n.useState(!1),[Dl,Cl]=n.useState(""),[dh,lt]=n.useState(!1),[mh,Il]=n.useState(!1),Dr=async(t,a=2,r=700)=>{let l;for(let o=0;o<=a;o++)try{return await t()}catch(m){if(l=m,o===a)break;await new Promise(h=>setTimeout(h,r*Math.pow(2,o)))}throw l};ze.reduce((t,a)=>t+(it[a.id]||0),0);const hh=async t=>await Cs.verifyMasterPin(t,s==null?void 0:s.uid),di=async t=>await Cs.verifyMasterPin(t,s==null?void 0:s.uid);n.useEffect(()=>{if(s!=null&&s.uid){try{const t=Zt(),a=`walletBalances_${s.uid}`,r=localStorage.getItem(t)??localStorage.getItem(a);if(r){const l=JSON.parse(r);os(l&&typeof l=="object"?l:{});try{localStorage.setItem(t,JSON.stringify(l||{}))}catch{}}}catch{}try{const t=Ft(),a=`cashBalance_${s.uid}`,r=`userCashBalance_${s.uid}`;let l=localStorage.getItem(t)??localStorage.getItem(a)??localStorage.getItem(r);if(l!=null){const o=parseFloat(l);Gt(Number.isFinite(o)?o:0);try{localStorage.setItem(t,String(Number.isFinite(o)?o:0)),localStorage.removeItem(a),localStorage.removeItem(r)}catch{}}}catch{}}},[s==null?void 0:s.uid,P,w==null?void 0:w.shopId]),n.useEffect(()=>{const t=a=>{var r;try{const l=Number((r=a==null?void 0:a.detail)==null?void 0:r.value);if(Number.isFinite(l))Gt(l);else{const o=localStorage.getItem(Ft());o!=null&&Gt(parseFloat(o)||0)}}catch{const l=localStorage.getItem(Ft());l!=null&&Gt(parseFloat(l)||0)}};return window.addEventListener("cashBalanceChanged",t),()=>window.removeEventListener("cashBalanceChanged",t)},[s==null?void 0:s.uid,P,w==null?void 0:w.shopId]);const{data:Al}=bn({queryKey:["dashboardData",P||(w==null?void 0:w.shopId)],queryFn:async()=>{const t=P||(w==null?void 0:w.shopId);if(!t)return null;const a=Ue(V,"dashboardData",t),r=await Ps(a);return r.exists()?r.data():null},enabled:!!(s!=null&&s.uid&&(P||w!=null&&w.shopId)),staleTime:1e3*60*5,refetchInterval:1e3*60*5});n.useEffect(()=>{if(Al){const t=Al,a=Number((t==null?void 0:t.cashBalance)||0),r=t!=null&&t.walletBalances&&typeof t.walletBalances=="object"?t.walletBalances:{};try{const l=t!=null&&t.lastUpdated?new Date(t.lastUpdated).getTime():0,o=localStorage.getItem(Ft()+"_lastUpdated"),m=o?new Date(o).getTime():0;l>=m&&(Gt(a),os(r),localStorage.setItem(Ft(),String(a)),localStorage.setItem(Zt(),JSON.stringify(r)),t!=null&&t.lastUpdated&&(localStorage.setItem(Ft()+"_lastUpdated",t.lastUpdated),localStorage.setItem(Zt()+"_lastUpdated",t.lastUpdated)))}catch{}}},[Al]);const oc=t=>`walletLimits_${(s==null?void 0:s.uid)||"default"}_${t||"none"}`,{data:mi}=bn({queryKey:["walletLimits",R],queryFn:async()=>{if(!R)return null;const t=Ue(V,"walletLimits",String(R)),a=await Ps(t);return a.exists()?a.data():null},enabled:!!R,staleTime:1e3*60*5});n.useEffect(()=>{if(R)try{const t=oc(R),a=localStorage.getItem(t);if(a&&!mi){const r=JSON.parse(a);Sr(r)}if(mi){const r=mi,l={walletId:R,dailyTransferLimit:r.dailyTransferLimit??6e4,dailyWithdrawLimit:r.dailyWithdrawLimit??1e5,dailyTransferUsed:r.dailyTransferUsed??0,dailyWithdrawUsed:r.dailyWithdrawUsed??0,monthlyTransferLimit:r.monthlyTransferLimit??2e5,monthlyWithdrawLimit:r.monthlyWithdrawLimit??2e5,monthlyTransferUsed:r.monthlyTransferUsed??0,monthlyWithdrawUsed:r.monthlyWithdrawUsed??0};Sr(l);try{localStorage.setItem(oc(R),JSON.stringify(l))}catch{}}}catch{}},[R,mi]),n.useEffect(()=>{if(!R)return;const t=ze.find(a=>a.id===R);if(t!=null&&t.name){Eo(String(t.name));try{localStorage.setItem(`walletName_${(s==null?void 0:s.uid)||"default"}_${R}`,String(t.name))}catch{}return}try{const a=localStorage.getItem(`walletName_${(s==null?void 0:s.uid)||"default"}_${R}`);a&&Eo(String(a))}catch{}},[R,ze]);const Tl=async()=>{try{if(!R)return;const t=await Sa.autoResetLimitsIfNeeded(R);Sr(t)}catch(t){console.error("خطأ في جلب حدود المحفظة المختارة:",t)}};n.useEffect(()=>{Tl()},[R]),n.useEffect(()=>{const t=a=>{var r;(r=a==null?void 0:a.detail)!=null&&r.walletId&&a.detail.walletId===R&&Tl()};return window.addEventListener("walletLimitsUpdated",t),()=>window.removeEventListener("walletLimitsUpdated",t)},[R]),n.useEffect(()=>{const t=a=>{var r;try{const l=String(((r=a==null?void 0:a.detail)==null?void 0:r.walletId)||"");l&&cn(l,"sms:auto")}catch{}};return window.addEventListener("walletSelection:update",t),()=>window.removeEventListener("walletSelection:update",t)},[ze]),n.useEffect(()=>{if(C.state){if(console.log("Location state:",C.state),C.state.openDebtDialog&&(Yi(),window.history.replaceState({},document.title)),C.state.openSalesDialog&&(jt||$t?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Jr(!0),window.history.replaceState({},document.title)),C.state.openMaintenanceDialog&&(jt||$t?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Wn(!0),window.history.replaceState({},document.title)),C.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),jt||$t?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):$n(!0),window.history.replaceState({},document.title)),C.state.openShopExpensesDialog&&(jt||$t?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Cs.hasMasterPin()?Us(!0):ts(!0),window.history.replaceState({},document.title)),C.state.openDeficienciesDialog&&(jt||$t?i({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):na(!0),window.history.replaceState({},document.title)),C.state.openInstallment&&(jt||$t?i({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"}):Mn(!0),window.history.replaceState({},document.title)),C.state.openTransactionSection){const t=document.getElementById("transaction-section");t&&t.scrollIntoView({behavior:"smooth"}),C.state.transactionType&&Kl(C.state.transactionType),C.state.startNewTransaction&&(pr(""),er(""),zr(""),fr(""),console.log("🔒 Starting new transaction without changing wallet selection")),C.state.focusWalletSelection&&setTimeout(()=>{const a=document.querySelector('[data-testid="wallet-select"]');a&&a.focus()},500),window.history.replaceState({},document.title)}C.state.openCashierShiftModal&&(!Na||$t?i({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):de(!0),window.history.replaceState({},document.title)),C.state.openMachineDailyDialog&&(!Na||$t?i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):Fn(!0),window.history.replaceState({},document.title))}},[C.state,ze,$t]),n.useEffect(()=>{C.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),kl(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",C.pathname)},[C.pathname,s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;(async()=>{try{const a=Ue(V,"users",s.uid),r=await Ps(a);if(r.exists()){const o=r.data().isActive===!0;o&&!ot?(It(!0),Vs(!1),_s(!1)):!o&&ot&&(It(!1),Vs(!0))}}catch(a){console.error("Check user status error",a)}})()},[s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;const t=r=>{const{userId:l}=r.detail;l===s.uid&&(console.log("🎉 Subscription activation event received for current user!"),It(!0),Vs(!1),_s(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},a=r=>{const{userId:l,isActive:o}=r.detail;l===s.uid&&(console.log("🔄 User subscription update event received:",{userId:l,isActive:o}),o&&!ot&&(It(!0),Vs(!1),_s(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",t),window.addEventListener("userSubscriptionUpdated",a),()=>{window.removeEventListener("subscriptionActivated",t),window.removeEventListener("userSubscriptionUpdated",a)}},[s==null?void 0:s.uid,ot]),n.useEffect(()=>{const t=a=>{var m;const r=a.target,l=(m=r==null?void 0:r.tagName)==null?void 0:m.toLowerCase();if(!(l==="input"||l==="textarea"||l==="select"||((r==null?void 0:r.isContentEditable)??!1))&&!(a.ctrlKey||a.altKey||a.metaKey)&&!a.repeat){if((jt||$t)&&a.key>="1"&&a.key<="9"){a.preventDefault();return}switch(a.key){case"1":break;case"2":Li(!0);break;case"3":jt||$t?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):$n(!0);break;case"4":Na?de(!0):i({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"5":jt||$t?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Jr(!0);break;case"6":Yi();break;case"7":jt||$t?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Wn(!0);break;case"8":Na?Fn(!0):i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"9":jt||$t?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Cs.hasMasterPin()?Us(!0):ts(!0);break}}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[jt,$t,Na]),n.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:s==null?void 0:s.uid,isCheckingActivation:qt}),(async()=>{try{if(!(s!=null&&s.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),_s(!1);return}try{const m=await Ps(Ue(V,"users",s.uid));if(m.exists()){const u=m.data().isActive===!0,v=await vu.checkTrialValidity(s.uid),g=v.isValid&&!v.isExpired;It(u||g),Ta(g),xr(v.hoursRemaining),xt(v.hasUsedTrial),Vs(!u&&!g),console.log("📊 حالة المستخدم:",{isActive:u,isOnTrial:g,hoursRemaining:v.hoursRemaining,hasUsedTrial:v.hasUsedTrial})}else It(!1),Vs(!0)}catch(m){console.error("خطأ في فحص حالة تفعيل المستخدم:",m),It(!1),Vs(!0)}finally{_s(!1)}if(console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:s==null?void 0:s.uid}),s!=null&&s.uid){const m=await Dr(()=>Ie.getUserData(s.uid)),h=`userData_${s==null?void 0:s.uid}`;let u=null;try{const v=localStorage.getItem(h);v&&(u=JSON.parse(v))}catch{}if(m){let v=(m==null?void 0:m.walletBalances)||{},g=m==null?void 0:m.cashBalance;if(u){const f=u.lastUpdated?new Date(u.lastUpdated).getTime():0,S=m.lastUpdated?new Date(m.lastUpdated).getTime():0;f>=S&&(u.walletBalances&&(v=u.walletBalances),u.cashBalance!==void 0&&(g=u.cashBalance))}os(v),g!==void 0&&Gt(g);try{const f=s!=null&&s.uid?await Dr(()=>yn.getDeletedTransactionsByUser(s.uid)):[];Hr(f||[])}catch{Hr([])}}else{os({});try{const v=s!=null&&s.uid?await yn.getDeletedTransactionsByUser(s.uid):[];Hr(v||[])}catch{Hr([])}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const m=await Dr(()=>xa.getByMerchantId((s==null?void 0:s.uid)||""));if(m&&m.length>0){console.log("✅ تم العثور على محافظ في Firebase:",m.length);const u=m.filter(f=>f.isActive===!0).map(f=>({id:f.id,name:f.label||"محفظة بدون اسم",phone:f.msisdn,isDefault:!1,monthlyWithdrawalLimit:f.monthlyWithdrawalLimit??f.withdrawLimit??2e5,monthlyTransferLimit:f.monthlyTransferLimit??f.transferLimit??2e5,defaultTransferCommission:f.defaultTransferCommission!=null?Number(f.defaultTransferCommission):null,defaultWithdrawCommission:f.defaultWithdrawCommission!=null?Number(f.defaultWithdrawCommission):null}));yr(u);const v=localStorage.getItem(or());let g=null;v&&u.find(f=>f.id===v)?g=u.find(f=>f.id===v):g=u[0],g&&(Ct(g.id),ka(g.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else console.log("⚠️ لا توجد محافظ في Firebase. سيتم عرض قائمة فارغة بدون أي استرجاع محلي."),yr([])}catch(m){console.error("خطأ في تحميل المحافظ من Firebase:",m),yr([])}const o=s!=null&&s.uid?await Dr(()=>Ie.getUserTransactions(s.uid)):[];if(o&&o.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",o.length);const m=o.map(f=>({...f,createdAt:new Date(f.createdAt),senderPhone:f.senderMsisdn||f.senderPhone||"",receiverPhone:f.receiverMsisdn||f.receiverPhone||"",type:f.txnType==="send"?"send":f.txnType==="receive"?"withdraw":f.type||"withdraw",status:f.status==="confirmed"?"completed":f.status||"completed"})),h=Yr.map(f=>f.id||f.originalTransactionId);let u=[];try{const f=Ge(ke(V,"deletedTransactions"),me("userId","==",(s==null?void 0:s.uid)||""),me("permanent","==",!0));u=(await He(f)).docs.map(A=>{const T=A.data();return String(T.originalTransactionId||T.transactionId||A.id||"")}).filter(Boolean)}catch{}const v=new Set(u),g=m.filter(f=>{var E;const S=String(f.id||""),A=String(f.transactionId||""),T=String(f.reference||f.transactionReference||((E=f.receipt)==null?void 0:E.reference)||""),J=h.includes(S),Ne=v.has(S)||A&&v.has(A);return!J&&!Ne});console.log("✅ تم فلترة المعاملات المحذوفة:",{total:o.length,deleted:h.length,active:g.length});{const f=new Set,S=[];for(const A of g){const T=Ko(A);f.has(T)||(f.add(T),S.push(A))}Jd||Xs(S)}}await tc()}catch(o){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",o)}})().then(async()=>{await l(),await a(),await r()});const a=async()=>{try{if(!(s!=null&&s.uid))return;const o=await xa.getByMerchantId(s.uid);await Promise.all(o.map(m=>Yu.autoResetLimitsIfNeeded(m.id)))}catch(o){console.error("خطأ في التصفير التلقائي للحدود:",o)}},r=async()=>{try{await ks.syncReportsDataFromFirebase(s==null?void 0:s.uid);const o=ks.getReportsData(s==null?void 0:s.uid);if((o.lastDailyResetDate?ks.shouldResetDailyReports(o.lastDailyResetDate):!1)&&(s!=null&&s.uid)&&o.lastDailyResetDate){const u=new Date(o.lastDailyResetDate),v=u.toDateString(),g=Qe.filter(E=>new Date(E.createdAt).toDateString()===v&&E.status==="completed"),f=g.length,S=g.reduce((E,K)=>E+K.amount,0),A=g.filter(dn).reduce((E,K)=>{const be=K.withdrawnAmount!==void 0?K.withdrawnAmount:K.amount;return E+be},0),T=g.filter(mn).reduce((E,K)=>{const be=K.sentAmount!==void 0?K.sentAmount:K.amount;return E+be},0),J=g.reduce((E,K)=>E+ks.calculateTransactionProfit(K),0),Ne=new Date(u).toISOString().slice(0,10);await pn.add({userId:s.uid,reportDate:Ne,totalTransactions:f,totalAmount:Number(S.toFixed(2)),totalWithdrawn:Number(A.toFixed(2)),totalSent:Number(T.toFixed(2)),profit:Number(J.toFixed(2)),walletId:null})}const h=ks.autoResetReportsIfNeeded(s==null?void 0:s.uid);(h.dailyReset||h.monthlyReset)&&console.log("تم التصفير التلقائي:",h)}catch(o){console.error("خطأ في التصفير التلقائي للتقارير:",o)}},l=async()=>{try{if(!(s!=null&&s.uid))return;const o=new Date;if(o.getDate()!==1)return;const m=`${o.getFullYear()}-${o.getMonth()+1}`,h=`lastMonthlyDbCleanup:${s.uid}`;if(localStorage.getItem(h)===m)return;const v=new Date(o.getFullYear(),o.getMonth(),1,0,0,0,0),g=A=>A instanceof Date?A:typeof(A==null?void 0:A.toDate)=="function"?A.toDate():new Date(String(A));let f=[];try{const A=Ge(ke(V,"userTransactions"),me("userId","==",s.uid),me("createdAt","<",v));f=(await He(A)).docs}catch{const A=Ge(ke(V,"userTransactions"),me("userId","==",s.uid));f=(await He(A)).docs.filter(J=>{var Ne;return g((Ne=J.data())==null?void 0:Ne.createdAt)<v})}await Promise.allSettled(f.map(A=>Bs(A.ref)));let S=[];try{const A=Ge(ke(V,"transactions"),me("userId","==",s.uid),me("createdAt","<",v));S=(await He(A)).docs}catch{const A=Ge(ke(V,"transactions"),me("userId","==",s.uid));S=(await He(A)).docs.filter(J=>{var Ne;return g((Ne=J.data())==null?void 0:Ne.createdAt)<v})}await Promise.allSettled(S.map(A=>Bs(A.ref)));try{localStorage.setItem(h,m)}catch{}console.log("✅ تم تنظيف قاعدة البيانات شهريًا (Firebase فقط):",{userTransactionsDeleted:f.length,globalTransactionsDeleted:S.length,monthStart:v})}catch(o){console.error("فشل التنظيف الشهري التلقائي لقاعدة البيانات:",o)}};Em(),nl(),Ym(),console.log("🔥 useEffect loadUserData completed")},[s==null?void 0:s.uid]);const kl=async()=>{var t;if(s!=null&&s.uid)try{const a=await Dr(()=>xa.getByMerchantId(s.uid));if(a&&a.length>0){const l=a.filter(o=>o.isActive===!0).map(o=>({id:o.id,name:o.label||"محفظة بدون اسم",phone:o.msisdn,isDefault:!1,monthlyWithdrawalLimit:o.monthlyWithdrawalLimit??o.withdrawLimit??2e5,monthlyTransferLimit:o.monthlyTransferLimit??o.transferLimit??2e5,defaultTransferCommission:o.defaultTransferCommission!=null?Number(o.defaultTransferCommission):void 0,defaultWithdrawCommission:o.defaultWithdrawCommission!=null?Number(o.defaultWithdrawCommission):void 0}));if(yr(l),s!=null&&s.uid){const o=localStorage.getItem(or());if(!!(R&&l.find(h=>h.id===R)))console.log("🔒 Preserving current wallet selection:",R);else{const u=(o&&l.find(v=>v.id===o)?o:null)||((t=l[0])==null?void 0:t.id);u&&(console.log("🔄 Fixing invalid wallet selection:",u),cn(u))}}console.log("🔄 تم تحديث المحافظ من Firebase:",l.length)}}catch(a){console.error("خطأ في تحميل المحافظ من Firebase:",a)}};n.useEffect(()=>{const t=C.pathname;if(sessionStorage.getItem("previousPath")==="/user/add-wallet"&&t==="/user/dashboard"){$.invalidateQueries({queryKey:["wallets",s==null?void 0:s.uid]});try{_n.refetch()}catch{}sessionStorage.removeItem("previousPath")}sessionStorage.setItem("previousPath",t)},[C.pathname,s==null?void 0:s.uid]),n.useEffect(()=>{const t=()=>{$.invalidateQueries({queryKey:["wallets",s==null?void 0:s.uid]});try{_n.refetch()}catch{}};return window.addEventListener("focus",t),()=>{window.removeEventListener("focus",t)}},[s==null?void 0:s.uid,R,ze]);const cn=async(t,a="unknown")=>{console.log(`🎯 setWalletSelection called from ${a} with walletId:`,t),console.log("🔍 Previous selectedWallet:",R),Ct(t);const r=ze.find(l=>l.id===t);if(r&&(ka(r.phone),console.log("✅ Wallet set successfully:",t,"Phone:",r.phone)),s!=null&&s.uid){localStorage.setItem(or(),t),console.log("💾 Saved wallet to localStorage:",t);try{await gn.set({key:"selected_wallet_id",value:t}),await gn.set({key:"current_user_id",value:s.uid}),console.log("📱 Saved wallet and user ID to Capacitor Preferences:",t,s.uid)}catch(l){console.error("❌ Failed to save to Capacitor Preferences:",l)}}};n.useEffect(()=>{const t=()=>{kl()};try{window.addEventListener("wallets:activation-updated",t)}catch{}return()=>{try{window.removeEventListener("wallets:activation-updated",t)}catch{}}},[s==null?void 0:s.uid]);const uh=t=>{if(t==="__add_wallet"){O("/user/add-wallet");return}if(t==="__view_wallets"){ya(!0);return}Nu.isEnabled(s==null?void 0:s.uid)?(An(t),ba(!0)):cn(t,"walletSelectionNoPin")},hi=t=>{console.log("🔄 handleTransactionTypeChange called with type:",t),console.log("🔍 Current selectedWallet before change:",R),console.log("🔍 Available wallets count:",ze.length),Kl(t),pr(""),er(""),zr(""),fr(""),console.log("✅ Transaction type changed to:",t,"- Wallet selection preserved:",R),setTimeout(()=>{const a=document.getElementById("transaction-section");a&&a.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)};n.useEffect(()=>{const t=a=>{const r=a.target;if(!!r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"||r.tagName==="SELECT"||r.isContentEditable)||(a.key==="ArrowLeft"?(a.preventDefault(),hi("withdraw")):a.key==="ArrowRight"&&(a.preventDefault(),hi("transfer"))),a.key==="Enter"){const o=ge==="transfer"?"transferSubmitButton":"withdrawSubmitButton",m=document.getElementById(o);m&&!m.disabled&&(a.preventDefault(),m.click())}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[ge]);const cc=t=>{qd((r=>({id:r.id,type:r.type==="send"?"transfer":"withdraw",sender_msisdn:r.senderPhone,receiver_msisdn:r.receiverPhone,amount:r.amount,commission:r.commission||0,fee:(r==null?void 0:r.fee)??0,status:r.status==="failed"?"failed":r.status==="completed"?"completed":"pending",createdAt:new Date(r.createdAt).toISOString(),updatedAt:new Date(r.createdAt).toISOString(),shopName:Q??(w==null?void 0:w.shopName)??(s==null?void 0:s.displayName)??"المحل",cashierName:(r==null?void 0:r.cashierName)??null,commissionMode:(r==null?void 0:r.commissionMode)??(r.type==="send"||kt?"add":"deduct"),totalCharged:(r==null?void 0:r.totalCharged)??(r.type==="send"?Number(r.amount||0)+Number(r.commission||0)+Number((r==null?void 0:r.fee)||0):kt?Number(r.amount||0)+Number(r.commission||0):Number(r.amount||0)),note:(r==null?void 0:r.note)??(r==null?void 0:r.notes)??void 0,senderName:(r==null?void 0:r.senderName)??void 0,provider:(r==null?void 0:r.provider)??void 0,title:(()=>{const l=String((r==null?void 0:r.provider)||"").toLowerCase(),o=l.includes("vodafone")?"vf-cash":l.includes("instapay")?"instapay":"",m=r.type==="send"?"تحويل":"سحب";return r.type==="withdraw"&&o?`${m} ${o}`:m})()}))(t)),On(!0)},xh=async t=>{var o;if(!(s!=null&&s.uid)){i({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const a=Qe.find(m=>m.id===t);if(!a){i({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}const r=String(t),l=String((a==null?void 0:a.transactionId)||(a==null?void 0:a.reference)||"");va.current.add(r),l&&va.current.add(l);try{console.log("🗑️ بدء عملية حذف المعاملة:",t),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:a.id,userId:s.uid,transactionData:a}),await Ie.removeUserTransaction(s.uid,a.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await yn.saveDeletedTransaction({...a,userId:s.uid,originalTransactionId:a.id,transactionId:a.transactionId||a.id,reference:a.reference||a.transactionReference||((o=a.receipt)==null?void 0:o.reference),deletedAt:new Date().toISOString(),permanent:!0}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(u){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",u)}try{await yn.permanentlyDeleteTransaction(a.id,s.uid)}catch(u){console.warn("⚠️ فشل وسم الحذف النهائي أو التنظيف الإضافي:",u)}const m=[...Yr,a],h=Qe.filter(u=>u.id!==t);Hr(m),Xs(h),Gl(!1),console.log("✅ تم تحديث الحالة بعد الحذف من Firebase (بدون نسخ محلية)");try{const u=a.fromWallet;if(u){const{walletDailyLimitsService:v}=await bt(async()=>{const{walletDailyLimitsService:f}=await import("./index-DvnSb1Lh.js").then(S=>S.c9);return{walletDailyLimitsService:f}},__vite__mapDeps([0,1]),import.meta.url),g=await v.getWalletLimits(u);if(g){const f=a.type==="send",S={updatedAt:(await bt(async()=>{const{serverTimestamp:E}=await import("./index-DvnSb1Lh.js").then(K=>K.c3);return{serverTimestamp:E}},__vite__mapDeps([0,1]),import.meta.url)).serverTimestamp()};f?(S.dailyTransferUsed=Math.max(0,(g.dailyTransferUsed||0)-a.amount),S.monthlyTransferUsed=Math.max(0,(g.monthlyTransferUsed||0)-a.amount)):(S.dailyWithdrawUsed=Math.max(0,(g.dailyWithdrawUsed||0)-a.amount),S.monthlyWithdrawUsed=Math.max(0,(g.monthlyWithdrawUsed||0)-a.amount));const{doc:A,setDoc:T}=await bt(async()=>{const{doc:E,setDoc:K}=await import("./index-DvnSb1Lh.js").then(be=>be.c3);return{doc:E,setDoc:K}},__vite__mapDeps([0,1]),import.meta.url),{db:J}=await bt(async()=>{const{db:E}=await import("./index-DvnSb1Lh.js").then(K=>K.c4);return{db:E}},__vite__mapDeps([0,1]),import.meta.url),Ne=A(J,"walletLimits",u);await T(Ne,S,{merge:!0})}}}catch(u){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",u)}try{const{ProfitService:u}=await bt(async()=>{const{ProfitService:A}=await import("./profitService-CJzdybxg.js");return{ProfitService:A}},__vite__mapDeps([3,0,1]),import.meta.url),{ReportsService:v}=await bt(async()=>{const{ReportsService:A}=await import("./index-DvnSb1Lh.js").then(T=>T.c8);return{ReportsService:A}},__vite__mapDeps([0,1]),import.meta.url),f={txnType:a.type==="send"?"send":"receive",amount:a.amount,commission:a.commission||0,createdAt:a.createdAt,status:"confirmed"},S=u.calculateProfitFromTransaction(f);S>0&&u.addProfit(-S,s.uid);try{v.removeTransactionEffects(a,s.uid)}catch{}}catch(u){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",u)}i({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(m){console.error("❌ خطأ في حذف المعاملة من Firebase:",m);let h="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";m instanceof Error&&(m.message.includes("network")||m.message.includes("offline")?h="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":m.message.includes("permission")||m.message.includes("unauthorized")?h="ليس لديك صلاحية لحذف هذه المعاملة":m.message.includes("not-found")&&(h="المعاملة غير موجودة أو تم حذفها مسبقاً")),i({title:"خطأ في الحذف",description:h,variant:"destructive"})}},dn=t=>{const a=t.type,r=t.txnType;return a==="withdraw"||a==="withdrawal"||a==="receive"||r==="receive"},mn=t=>{const a=t.type,r=t.txnType;return a==="send"||a==="transfer"||r==="send"},hn=(t,a)=>{const r=new Date().toDateString();let l=Qe.filter(g=>{const f=new Date(g.createdAt).toDateString()===r,S=String(g.status||"").toLowerCase();return f&&(S==="completed"||S==="confirmed"||S==="pending")});Ea&&Ea.trim()!==""&&(l=l.filter(g=>g.senderPhone&&g.senderPhone.includes(Ea)||g.receiverPhone&&g.receiverPhone.includes(Ea)));const o=ks.filterVisibleTransactions(l,"daily",s==null?void 0:s.uid),m=o.length,h=o.reduce((g,f)=>g+f.amount,0),u=o.filter(dn).reduce((g,f)=>{const S=f.withdrawnAmount!==void 0?f.withdrawnAmount:f.amount;return g+S},0),v=o.filter(mn).reduce((g,f)=>{const S=f.sentAmount!==void 0?f.sentAmount:f.amount;return g+S},0);return{totalTransactions:m,totalAmount:h,totalWithdrawn:u,totalSent:v}},un=t=>{const a=new Date().getMonth(),r=new Date().getFullYear();let l=Qe.filter(g=>{const f=new Date(g.createdAt);return f.getMonth()===a&&f.getFullYear()===r&&g.status==="completed"});Ea&&Ea.trim()!==""&&(l=l.filter(g=>g.senderPhone&&g.senderPhone.includes(Ea)||g.receiverPhone&&g.receiverPhone.includes(Ea)));const o=ks.filterVisibleTransactions(l,"monthly",s==null?void 0:s.uid),m=o.length,h=o.reduce((g,f)=>g+f.amount,0),u=o.filter(dn).reduce((g,f)=>{const S=f.withdrawnAmount!==void 0?f.withdrawnAmount:f.amount;return g+S},0),v=o.filter(mn).reduce((g,f)=>{const S=f.sentAmount!==void 0?f.sentAmount:f.amount;return g+S},0);return{totalTransactions:m,totalAmount:h,totalWithdrawn:u,totalSent:v}},ph=t=>{const a=new Date().getMonth(),r=new Date().getFullYear(),l=Qe.filter(h=>{const u=new Date(h.createdAt);return u.getMonth()===a&&u.getFullYear()===r&&h.status==="completed"&&h.fromWallet===t}),o=l.filter(dn).reduce((h,u)=>{const v=u.withdrawnAmount||u.amount;return h+v},0),m=l.filter(mn).reduce((h,u)=>{const v=u.sentAmount||u.amount;return h+v},0);return{totalWithdrawn:o,totalTransferred:m}},gh=t=>{const a=new Date,r=a.getDate(),l=a.getMonth(),o=a.getFullYear(),m=Qe.filter(v=>{const g=new Date(v.createdAt);return g.getDate()===r&&g.getMonth()===l&&g.getFullYear()===o&&v.status==="completed"&&v.fromWallet===t}),h=m.filter(dn).reduce((v,g)=>{const f=g.withdrawnAmount||g.amount;return v+f},0),u=m.filter(mn).reduce((v,g)=>{const f=g.sentAmount||g.amount;return v+f},0);return{totalWithdrawn:h,totalTransferred:u}},dc=Ke.useMemo(()=>un(),[Qe,R,Ea]);dc.totalWithdrawn,dc.totalSent;const La=Ke.useMemo(()=>ph(R),[Qe,R]);n.useEffect(()=>{try{if(!R||ze.length===0)return;const t=ze.find(T=>T.id===R);if(!t)return;const a=(at==null?void 0:at.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,r=(at==null?void 0:at.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,l=parseFloat(zt||"0")||0,o=(La==null?void 0:La.totalWithdrawn)??(at==null?void 0:at.monthlyWithdrawUsed)??0,m=(La==null?void 0:La.totalTransferred)??(at==null?void 0:at.monthlyTransferUsed)??0,h=o+(ge==="withdraw"?l:0),u=m+(ge==="transfer"?l:0),v=.85,g=Math.floor(Math.max(a,1)*v),f=Math.floor(Math.max(r,1)*v),S=(()=>{const T=new Date;return`${T.getFullYear()}-${String(T.getMonth()+1).padStart(2,"0")}`})(),A=`monthlyLimitWarnShown:${R}:${S}`;if(h>=g){const T=`${A}:withdraw`;if(!(localStorage.getItem(T)==="true")){Jl({type:"withdraw",used:h,limit:a,walletName:t.name}),Vl(!0);try{localStorage.setItem(T,"true")}catch{}return}}if(u>=f){const T=`${A}:transfer`;if(!(localStorage.getItem(T)==="true")){Jl({type:"transfer",used:u,limit:r,walletName:t.name}),Vl(!0);try{localStorage.setItem(T,"true")}catch{}return}}}catch{}},[R,ze,at,La,ge,zt]);const mc=async()=>{var ha,oa,xn,Cr;kx(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:ma,receiverPhone:js,amount:zt,transactionType:ge});const t=()=>{ge==="transfer"?br(!0):Qr(!0)},a=()=>{ge==="transfer"?br(!1):Qr(!1)};if(t(),!ma||!zt){console.log("❌ خطأ: بيانات ناقصة"),i({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),a();return}if(ge==="transfer"&&!js&&!W){console.log("❌ خطأ: رقم المستقبل مفقود"),i({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),a();return}if(ge==="transfer"&&!W&&(String(js||"").replace(/[^0-9٠-٩]/g,""),!/[^0-9٠-٩\s]/.test(String(js||""))&&!Px(js))){i({title:"رقم المستقبل غير صالح",description:"اكتب رقم صحيح مكون من 11 رقم ويبدأ بـ 015 أو 010 أو 012 أو 011",variant:"destructive"}),a();return}const r=parseFloat(zt);if(console.log("💰 المبلغ المحول:",r),r<=0){console.log("❌ خطأ: مبلغ غير صحيح"),i({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),a();return}if(jt)try{const ue=new Date,Ee=ue.getFullYear(),dt=String(ue.getMonth()+1).padStart(2,"0"),cs=String(ue.getDate()).padStart(2,"0"),Ws=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${Ee}-${dt}-${cs}`,Fs=localStorage.getItem(Ws);if((Fs&&parseInt(Fs,10)||0)>=10){i({title:"حد التأكيد اليومي",description:"باقة زيرو تسمح بـ 10 تأكيدات تحويل/سحب يومياً فقط.",variant:"destructive"}),a();return}}catch(ue){console.warn("فشل قراءة عداد تأكيدات باقة زيرو من التخزين المحلي:",ue)}const l=ze.find(ue=>ue.id===R);if(!l){i({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),a();return}const o=La;if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:R,walletName:l.name,currentWithdrawn:o.totalWithdrawn,currentTransferred:o.totalTransferred,withdrawalLimit:l.monthlyWithdrawalLimit,transferLimit:l.monthlyTransferLimit}),ge==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${o.totalWithdrawn}, المبلغ الجديد: ${r}, الحد الأقصى: ${l.monthlyWithdrawalLimit}`),o.totalWithdrawn+r>l.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),i({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${l.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${o.totalTransferred}, المبلغ الجديد: ${r}, الحد الأقصى: ${l.monthlyTransferLimit}`),o.totalTransferred+r>l.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),i({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${l.monthlyTransferLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}w!=null&&w.shopName||s!=null&&s.displayName,Date.now().toString(),ge==="withdraw"&&tr.trim()!==""&&tr.trim(),l!=null&&l.name,ge==="transfer"||Pa&&Pa.trim()!==""&&Pa.trim(),y&&(N!=null&&N.name||N!=null&&N.username)&&(N!=null&&N.name||(N==null||N.username));const m=Or.validateTransaction(r,ge,Et,it);if(!m.isValid){i({title:"خطأ في العملية",description:m.error,variant:"destructive"}),a();return}m.warning&&i({title:"تحذير",description:m.warning,variant:"destructive"});let h;if(ge==="transfer")if((l==null?void 0:l.defaultTransferCommission)!=null){const ue=Number(l.defaultTransferCommission)||0;h=Math.round(ue*r/1e3*100)/100}else as&&as.trim()!==""?h=Math.max(0,parseFloat(as)):h=0;else if((l==null?void 0:l.defaultWithdrawCommission)!=null){const ue=Number(l.defaultWithdrawCommission)||0;h=Math.round(ue*r/1e3*100)/100}else Vt&&Vt.trim()!==""?h=Math.max(0,parseFloat(Vt)):h=Math.round(r*.01*100)/100;if(ge!=="transfer"&&!kt&&h>=r){i({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),a();return}const u=ge==="transfer"||kt?r:Math.round((r-h)*100)/100;let v;const g=ge==="transfer"&&!!Ce,f=ge==="withdraw"&&!!Ce,S=g||f;let A=null;const T=kn(ma||"").replace(/\D/g,""),J=kn(js||"").replace(/\D/g,""),Ne=ge==="transfer"&&(T.startsWith("010")&&(J.startsWith("011")||J.startsWith("012")||J.startsWith("015"))||T.startsWith("012")&&J.startsWith("010")||T.startsWith("011")&&J.startsWith("010")||T.startsWith("015")&&J.startsWith("010")),E=Math.max(0,parseFloat(Tn||"0")),K=Math.round(h*100)/100;if(Ne&&!S&&E<=0){i({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"}),a();return}if(ge==="transfer"&&!S){const ue=Number(it[R]||0),Ee=Number(u)+Number(E);if(ue<Ee){i({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${ue} لا يكفي لخصم ${Ee}`,variant:"destructive"}),a();return}}if(S)if(g){const ue=Or.validateTransaction(u,"transfer",Et,it);if(!ue.isValid)v={success:!1,newCashBalance:Et,newWalletBalances:it,message:ue.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"};else{const Ee=R||((ha=ze.find(pt=>pt.isDefault))==null?void 0:ha.id)||((oa=ze[0])==null?void 0:oa.id),dt=at??await Sa.getWalletLimits(Ee),cs=new Date().toDateString(),Ws=Qe.filter(pt=>pt.type==="send"&&String(pt.status||"").toLowerCase()==="pending"&&pt.fromWallet===Ee&&new Date(pt.createdAt).toDateString()===cs).reduce((pt,Ts)=>pt+Number(Ts.sentAmount??Ts.transferredAmount??Ts.amount??0),0),Fs=Number((dt==null?void 0:dt.dailyTransferLimit)??6e4),ta=Number((dt==null?void 0:dt.dailyTransferUsed)??0);if(ta+Ws+Number(u)>Fs){i({title:"تجاوز الحد اليومي للتحويل",description:`المتبقي اليوم: ${(Fs-ta-Ws).toLocaleString()} ج.م`,variant:"destructive"}),a();return}const Rt=new Date,Ds=Qe.filter(pt=>pt.type==="send"&&String(pt.status||"").toLowerCase()==="pending"&&pt.fromWallet===Ee&&new Date(pt.createdAt).getMonth()===Rt.getMonth()&&new Date(pt.createdAt).getFullYear()===Rt.getFullYear()).reduce((pt,Ts)=>pt+Number(Ts.sentAmount??Ts.transferredAmount??Ts.amount??0),0),Rs=Number((dt==null?void 0:dt.monthlyTransferLimit)??2e5),Ir=Number((dt==null?void 0:dt.monthlyTransferUsed)??0);if(Ir+Ds+Number(u)>Rs){i({title:"تجاوز الحد الشهري للتحويل",description:`المتبقي هذا الشهر: ${(Rs-Ir-Ds).toLocaleString()} ج.م`,variant:"destructive"}),a();return}v={success:!0,newCashBalance:Et,newWalletBalances:it}}}else{const ue=R||((xn=ze.find(pt=>pt.isDefault))==null?void 0:xn.id)||((Cr=ze[0])==null?void 0:Cr.id),Ee=at??await Sa.getWalletLimits(ue),dt=new Date().toDateString(),cs=Qe.filter(pt=>pt.type==="withdraw"&&String(pt.status||"").toLowerCase()==="pending"&&pt.fromWallet===ue&&new Date(pt.createdAt).toDateString()===dt).reduce((pt,Ts)=>pt+Number(Ts.withdrawnAmount??Ts.amount??0),0),Ws=Number((Ee==null?void 0:Ee.dailyWithdrawLimit)??1e5),Fs=Number((Ee==null?void 0:Ee.dailyWithdrawUsed)??0);if(Fs+cs+Number(u)>Ws){i({title:"تجاوز الحد اليومي للسحب",description:`المتبقي اليوم: ${(Ws-Fs-cs).toLocaleString()} ج.م`,variant:"destructive"}),a();return}const ta=new Date,Rt=Qe.filter(pt=>pt.type==="withdraw"&&String(pt.status||"").toLowerCase()==="pending"&&pt.fromWallet===ue&&new Date(pt.createdAt).getMonth()===ta.getMonth()&&new Date(pt.createdAt).getFullYear()===ta.getFullYear()).reduce((pt,Ts)=>pt+Number(Ts.withdrawnAmount??Ts.amount??0),0),Ds=Number((Ee==null?void 0:Ee.monthlyWithdrawLimit)??2e5),Rs=Number((Ee==null?void 0:Ee.monthlyWithdrawUsed)??0);if(Rs+Rt+Number(u)>Ds){i({title:"تجاوز الحد الشهري للسحب",description:`المتبقي هذا الشهر: ${(Ds-Rs-Rt).toLocaleString()} ج.م`,variant:"destructive"}),a();return}v={success:!0,newCashBalance:Math.round((Number(Et)-Number(u))*100)/100,newWalletBalances:it}}else ge==="transfer"?v=await Or.processTransfer({amount:u,currentCashBalance:Et,currentWalletBalances:it,wallets:ze,selectedWalletId:R,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0}):v=await Or.processWithdraw({amount:u,currentCashBalance:Et,currentWalletBalances:it,wallets:ze,selectedWalletId:R,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0});if(!v.success){i({title:"فشل في العملية",description:v.error||v.message,variant:"destructive"}),a();return}let be=S?f?v.newCashBalance:Et:v.newCashBalance,et=S?it:v.newWalletBalances;if(!S&&ge==="transfer"&&E>0){const ue=Number(et[R]||0);et={...et,[R]:Math.round((ue-Number(E))*100)/100}}if(S&&g){const ue=ze.find(cs=>cs.id===R)??ze.find(cs=>cs.isDefault)??ze[0],Ee=(ue==null?void 0:ue.id)||R;if(Ee!==R)try{cn(Ee)}catch{}const dt=Number(it[Ee]||0);et={...it,[Ee]:Math.round((dt-Number(u)-Number(E))*100)/100}}if((g||f)&&Ce&&!Nt){const ue={id:`DEBT-${Date.now()}`,debtorName:Ce.debtorName,amount:Ce.amount,reason:Ce.notes||"",customerId:Ce.customerId,mobile:Ce.mobile,status:"pending",createdAt:new Date};A=ue.id;const Ee=[ue,...wt];Ss(Ee);try{await la(Ee)}catch(dt){console.error("⚠️ فشل حفظ الدين المؤجل محلياً:",dt)}i({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}if(!S){const ue=Math.max(0,Number(h))+Math.max(0,Number(E));ue>0&&(be=Math.round((be+ue)*100)/100,console.log(`💰 تم إضافة عمولة/رسوم ${ue} جنيه لدرج النقدية`))}console.log("⚡ تحديث الواجهة فوراً بدون حجب باستخدام startTransition...");const ws="temp_"+Date.now()+"_"+Math.random().toString(36).substring(7),ja={shopId:P||(w==null?void 0:w.shopId)||(s==null?void 0:s.uid)||"default-shop",lineId:R||"default-line",walletId:R||void 0,merchantUserId:(s==null?void 0:s.uid)||null,provider:"vodafone_cash",txnType:ge==="transfer"?"send":"receive",originType:ge==="transfer"?"transfer":"withdraw",amount:u,commission:K,fee:E,profit:0,senderMsisdn:ma,receiverMsisdn:ge==="transfer"?js:ma,note:ge==="transfer"?void 0:Pa&&Pa.trim()!==""?Pa.trim():void 0,status:S?"pending":"confirmed",linkedDebtId:A||void 0,createdBy:(s==null?void 0:s.uid)||null,walletEffectAppliedOnCreation:!1,cashEffectAppliedOnCreation:!!(S&&f),limitsReservedOnCreation:!!S,limitReservedType:ge==="transfer"?"transfer":"withdraw",profitAddedOnCreation:!1},$s={...ja,id:ws,status:S?"pending":"completed",commissionMode:ge==="transfer"||kt?"add":"deduct",totalCharged:ge==="transfer"?u+K+E:kt?u+h:u,walletEffectAppliedOnCreation:!1,cashEffectAppliedOnCreation:!!(S&&f),limitsReservedOnCreation:!!S,limitReservedType:ge==="transfer"?"transfer":"withdraw",sentAmount:ge==="transfer"?u:void 0,transferredAmount:ge==="transfer"?u:void 0,withdrawnAmount:ge==="withdraw"?u:void 0,senderName:ge==="withdraw"&&tr.trim()!==""?tr.trim():void 0,createdAt:new Date,type:ge==="transfer"?"send":"withdraw",senderPhone:ma||"",receiverPhone:js||""};try{Oa.current=[$s,...Oa.current],$.setQueryData(["recentTransactions",s==null?void 0:s.uid,P||"main"],ue=>!ue||!Array.isArray(ue)?[$s]:[$s,...ue])}catch(ue){console.error("Error in optimistic update:",ue)}if(R&&at)try{const ue=ge==="transfer",Ee={...at};ue?(Ee.dailyTransferUsed=(Ee.dailyTransferUsed||0)+u,Ee.monthlyTransferUsed=(Ee.monthlyTransferUsed||0)+u):(Ee.dailyWithdrawUsed=(Ee.dailyWithdrawUsed||0)+u,Ee.monthlyWithdrawUsed=(Ee.monthlyWithdrawUsed||0)+u),Sr(Ee)}catch(ue){console.error("Error in optimistic limit update:",ue)}const Ma=[$s,...Qe];Ke.startTransition(()=>{Gt(be),os(et),Xs(Ma)});try{setTimeout(()=>{try{localStorage.setItem(yl(),JSON.stringify(Ma))}catch{}},0)}catch{}if(jt)try{const ue=new Date,Ee=ue.getFullYear(),dt=String(ue.getMonth()+1).padStart(2,"0"),cs=String(ue.getDate()).padStart(2,"0"),Ws=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${Ee}-${dt}-${cs}`,Fs=localStorage.getItem(Ws),ta=Fs&&parseInt(Fs,10)||0;localStorage.setItem(Ws,String(ta+1))}catch{}setTimeout(()=>{try{const ue=new Date().toISOString();localStorage.setItem(Ft(),be.toString()),localStorage.setItem(Ft()+"_lastUpdated",ue),localStorage.setItem(Zt(),JSON.stringify(et)),localStorage.setItem(Zt()+"_lastUpdated",ue)}catch{}},0);try{if(s!=null&&s.uid){const ue=ze.find(Ar=>Ar.id===R)??ze.find(Ar=>Ar.isDefault)??ze[0],Ee=(ue==null?void 0:ue.id)||R,dt=Number(et[Ee]||0),cs=String((ue==null?void 0:ue.phone)||ma||"").trim(),Ws=String(js||"").trim(),Fs=Number(E)>0,ta=ge==="transfer"?"🟢":"🔴",Rt=Number(K)>0?`${Number(K)} جنيه`:"0 جنيه",Ds=Fs?` و رسوم ${Number(E)} جنيه`:"",Rs=ge==="transfer"?`${ta} تم تحويل مبلغ ${Number(u)} جنيه من رقم المحفظة ${cs} إلى رقم المحفظة ${Ws} وتم أخذ عمولة ${Rt}${Ds}. الرصيد المتبقي في المحفظة: ${dt} جنيه. الفلوس النقدية المتبقية: ${Number(be)} جنيه.`:`${ta} تم السحب مبلغ ${Number(u)} جنيه من الدرج إلى رقم المحفظة ${cs} وتم أخذ عمولة ${Rt}${Ds}. الرصيد المتبقي في المحفظة: ${dt} جنيه. الفلوس النقدية المتبقية: ${Number(be)} جنيه.`,Ir=s!=null&&s.uid?`tg_last_msg_${s.uid}`:"tg_last_msg",pt=Date.now();let Ts=!0;try{const Ar=localStorage.getItem(Ir);if(Ar){const Tr=JSON.parse(Ar),Dh=String((Tr==null?void 0:Tr.text)||""),Ch=Number((Tr==null?void 0:Tr.at)||0);Dh===Rs&&pt-Ch<5e3&&(Ts=!1)}}catch{}if(Ts){Promise.resolve(Ja.send(s.uid,Rs)).catch(()=>{});try{localStorage.setItem(Ir,JSON.stringify({text:Rs,at:pt}))}catch{}}}}catch{}if((async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const ue={...ja},Ee={...$s},{ProfitService:dt}=await bt(async()=>{const{ProfitService:Rt}=await import("./profitService-CJzdybxg.js");return{ProfitService:Rt}},__vite__mapDeps([3,0,1]),import.meta.url),cs=dt.calculateProfitFromTransaction({...Ee,status:"confirmed"});cs>0&&(dt.addProfit(cs,s==null?void 0:s.uid),ue.profitAddedOnCreation=!0,Ee.profitAddedOnCreation=!0,console.log("✅ تم إضافة الربح:",cs,"جنيه"));const Ws=await wi.create(ue);if(R)try{const Rt=await Sa.updateUsage(R,u,ge==="transfer"?"transfer":"withdraw");Rt&&Sr(Rt);try{window.dispatchEvent(new CustomEvent("walletLimitsUpdated",{detail:{walletId:R}}))}catch{}}catch{}await Promise.all([...s!=null&&s.uid?[Ie.updateUserData(s.uid,{cashBalance:be,walletBalances:et,lastUpdated:new Date().toISOString()})]:[],...s!=null&&s.uid?[Ie.saveUserTransaction(s.uid,{...Ee,transactionId:Ws,transactionType:ge,fromWallet:R,toWallet:ge==="transfer"?g?null:"cash":null,cashierName:y&&((N==null?void 0:N.name)||(N==null?void 0:N.username))||"الحساب الرئيسي",linkedDebtId:A||void 0,description:`${ge==="transfer"?"تحويل":"سحب"} ${u} من ${R} ${ge==="transfer"?g?"":"إلى الدرج النقدي":""} — عمولة: ${h} (${ge==="transfer"||kt?"مضافة":"مخصومة"})${E>0?` — رسوم: ${E}`:""}${S?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");try{const Rt={...$s,id:Ws};Oa.current=Oa.current.map(Ds=>Ds.id===ws?Rt:Ds),$.setQueryData(["recentTransactions",s==null?void 0:s.uid,P||"main"],Ds=>!Ds||!Array.isArray(Ds)?[Rt]:Ds.map(Rs=>Rs.id===ws?Rt:Rs)),Ke.startTransition(()=>{Xs(Ds=>Ds.map(Rs=>Rs.id===ws?Rt:Rs))})}catch(Rt){console.error("Error updating query cache with real ID:",Rt)}setTimeout(()=>{try{console.log("🔄 تنفيذ التحديث المؤجل (10 ثواني) لضمان تطابق البيانات..."),$.invalidateQueries({queryKey:["recentTransactions",s==null?void 0:s.uid,P||"main"]}),$.invalidateQueries({queryKey:["dashboardData",P||(w==null?void 0:w.shopId)]}),R&&($.invalidateQueries({queryKey:["walletLimits",R]}),Tl())}catch(Rt){console.error("Error in delayed refresh:",Rt)}},1e4);const Fs=`userData_${s==null?void 0:s.uid}`,ta={cashBalance:be,walletBalances:et,lastUpdated:new Date().toISOString()};localStorage.setItem(Fs,JSON.stringify(ta))}catch(ue){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",ue);try{s!=null&&s.uid&&Ie.saveLocalReceipt(s.uid,{...transactionDataForUser,transactionType:ge,fromWallet:R,toWallet:ge==="transfer"?g?null:"cash":null,cashierName:y&&((N==null?void 0:N.name)||(N==null?void 0:N.username))||"الحساب الرئيسي",linkedDebtId:A||void 0,description:`${ge==="transfer"?"تحويل":"سحب"} ${u} من ${R} ${ge==="transfer"?g?"":"إلى الدرج النقدي":""} — عمولة: ${h} (${ge==="transfer"||kt?"مضافة":"مخصومة"})${E>0?` — رسوم: ${E}`:""}${S?" — دين مؤجل (قيد المراجعة)":""}`})}catch{}i({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),ge==="transfer"){br(!0);const ue=Number(r)+Number(h)+Math.max(0,Number(E));Ei({type:"transfer",amount:Math.max(0,Math.round(ue*100)/100)}),Zd({receiver:js,amount:r}),ar(!0),setTimeout(()=>{br(!1)},2e3)}else{Qr(!0);const ue=kt?Number(r):Math.max(0,Math.round((Number(r)-Number(h))*100)/100);Ei({type:"withdraw",amount:Math.max(0,Math.round(ue*100)/100)}),ar(!0),setTimeout(()=>{Qr(!1)},2e3)}pr(""),er(""),Br(""),gr(""),pe(null),B(""),he(""),we(""),ls(!1)},ui=Ke.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),hc=Ke.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),fh=Ke.useMemo(()=>{try{return wt.reduce((t,a)=>{if(a.type==="debtor")return t;const r=Number(a.paidAmount||0),l=Math.max(0,Number(a.amount||0)-r);return t+l},0)}catch{return 0}},[wt]),Pl=Ke.useMemo(()=>nc().filter(a=>_a==="all"?!0:_a==="send"?a.type==="send":_a==="receive"?a.type==="receive":_a==="withdraw"?a.type==="withdraw":_a!=="deleted"),[nc,_a]),yh=()=>{if(Pi==="daily"){const t=ks.resetReportsManually("daily",Qe,s==null?void 0:s.uid);Kr(!1),i({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${t.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const t=ks.resetReportsManually("monthly",Qe,s==null?void 0:s.uid);Kr(!1),i({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${t.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},bh=()=>Pi==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",vh=()=>Pi==="daily"?"أدخل الرقم السري الرئيسي لتصفير جميع معاملات اليوم":"أدخل الرقم السري الرئيسي لتصفير جميع معاملات الشهر",wh=t=>{Yo(t),ll(!0)},Nh=t=>{const a=Et,r=Number(t)-Number(a);Gt(t);const l=new Date().toISOString();localStorage.setItem(Ft(),t.toString()),localStorage.setItem(Ft()+"_lastUpdated",l),Lo(!1);const o={cashBalance:t,lastUpdated:l},m=`userData_${s==null?void 0:s.uid}`;try{localStorage.setItem(m,JSON.stringify(o))}catch{}const h=[];if(s!=null&&s.uid){h.push(Ie.updateUserData(s.uid,o).then(()=>{try{localStorage.removeItem(m)}catch{}}).catch(()=>{}));const u=`${r>0?"CASHADD":"CASHDEDUCT"}-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`,v=r>0?{txnType:"cash_addition",type:"cash_addition",amount:r,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:u,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(w==null?void 0:w.shopId)||void 0}:r<0?{amount:Math.abs(r),status:"completed",title:"ايصال خصم من الفلوس النقديه",merchantUserId:s.uid,createdBy:s.uid,shopId:(w==null?void 0:w.shopId)||void 0}:null;v&&h.push(Ie.saveUserTransaction(s.uid,v));const g=w==null?void 0:w.shopId;if(g){const f=Ue(V,"dashboardData",g);h.push(Xt(f,{cashBalance:t}))}}Promise.allSettled(h).then(()=>{}).catch(()=>{}),i({title:r>0?"تم إضافة نقدية":r<0?"تم خصم نقدية":"تم تحديث الرصيد النقدي",description:r!==0?`التغيير: ${Math.abs(r)} جنيه، الرصيد الجديد: ${t} جنيه`:`تم تحديث الرصيد النقدي إلى ${t} جنيه`})},jh=async t=>{var h;if(!Hs){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const a={...it,[Hs]:t};os(a);const r=new Date().toISOString(),l={walletBalances:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;try{localStorage.setItem(o,JSON.stringify(l)),localStorage.setItem(Zt(),JSON.stringify(a)),localStorage.setItem(Zt()+"_lastUpdated",r),localStorage.setItem(`walletBalances_backup_${r}`,JSON.stringify(a))}catch{}try{s!=null&&s.uid&&await Ie.updateUserData(s.uid,l)}catch(u){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",u)}Mo(!1);const m=((h=ze.find(u=>u.id===Hs))==null?void 0:h.name)||"المحفظة";i({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${m} إلى ${t.toLocaleString()} جنيه`})},Sh=async t=>{var a;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",Hs),console.log("💵 المبلغ المضاف/المخصوم:",t),Hs){const r=it[Hs]||0;console.log("💰 الرصيد الحالي:",r);const l=r+t;console.log("💰 الرصيد الجديد:",l);const o={...it,[Hs]:l};console.log("📊 الأرصدة المحدثة:",o),os(o);const m=new Date().toISOString(),h={walletBalances:o,lastUpdated:m},u=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(u,JSON.stringify(h)),localStorage.setItem(Zt(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${m}`,JSON.stringify(o));try{if(s!=null&&s.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await Ie.updateUserData(s.uid,h),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(u),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(S){console.error("❌ فشل في حفظ البيانات في Firebase:",S),lt(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(Zt(),JSON.stringify(o));const v=((a=ze.find(S=>S.id===Hs))==null?void 0:a.name)||"المحفظة",g=t>0?"إضافة":"خصم",f=Math.abs(t);i({title:`تم ${g} مبلغ ${g==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${g} ${f} جنيه ${g==="إضافة"?"إلى":"من"} رصيد ${v}. الرصيد الجديد: ${l.toLocaleString()} جنيه`})}catch(v){if(console.error("❌ فشل في حفظ البيانات في Firebase:",v),localStorage.setItem(Zt(),JSON.stringify(o)),s!=null&&s.uid){const g=`userData_${s.uid}`,f={walletBalances:o,lastUpdated:new Date().toISOString()};localStorage.setItem(g,JSON.stringify(f)),lt(!0)}i({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const l=Object.keys(localStorage).filter(o=>o.startsWith("walletBalances_backup_")).sort();l.length>5&&l.slice(0,l.length-5).forEach(m=>{localStorage.removeItem(m),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",m)})},5e3),ll(!1),Yo("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:qt,isUserActive:ot,showActivationModal:Xa}),qt?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx(Kh,{})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"user-dashboard min-h-screen px-2 sm:px-4 py-2 sm:py-4 relative bg-gray-100 bg-[radial-gradient(140%_140%_at_10%_10%,#e5e7eb_0%,#d1d5db_45%,#9ca3af_100%)]",children:[e.jsx(_x,{userId:s==null?void 0:s.uid}),e.jsxs("div",{className:"max-w-screen-2xl mx-auto grid grid-cols-1 xl:grid-cols-3 gap-4 xl:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!Gr&&e.jsxs(vt,{className:"bg-gray-100 border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-200 relative overflow-hidden",children:[e.jsx(Ht,{className:"pb-2 px-3 pt-3 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ms,{className:"text-xs font-bold text-gray-900 flex items-center gap-1.5",children:[e.jsx("div",{className:"p-1 rounded-md bg-gradient-to-br from-gray-100 to-gray-200",children:e.jsx(kc,{className:"h-3.5 w-3.5 text-gray-700"})}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>{Zl("monthly"),Kr(!0)},className:"h-7 w-7 p-0 bg-transparent hover:bg-red-50 text-red-600 hover:text-red-700 rounded-full transition-colors duration-200",title:"تصفير معاملات الشهر",children:e.jsx(ds,{className:"h-3 w-3"})}),e.jsx("div",{className:"p-1 bg-green-50 rounded-full border border-green-100",children:e.jsx(fn,{className:"h-3 w-3 text-green-600"})})]})]})}),!Gr&&e.jsxs(St,{className:"pt-0 px-2 pb-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-0 rounded-lg overflow-hidden border border-gray-200 divide-x divide-y divide-gray-200 bg-white",children:[e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-blue-600",children:"عدد المعاملات"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-blue-800 mt-0.5 sm:mt-0",children:un().totalTransactions})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-gray-600",children:"إجمالي المبالغ"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-gray-900 mt-0.5 sm:mt-0",children:un().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-red-600",children:"المسحوب"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-red-800 mt-0.5 sm:mt-0",children:un().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-green-600",children:"المرسل"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-green-800 mt-0.5 sm:mt-0",children:un().totalSent.toFixed(2)})]})]}),e.jsxs("div",{className:"mt-2 rounded-lg border border-gray-100 bg-white px-2 py-1.5 flex items-center justify-between",children:[e.jsx("span",{className:"text-[12px] font-bold text-yellow-600",children:"الأرباح"}),e.jsx(bx,{userId:s==null?void 0:s.uid,transactions:Qe})]})]}),lm&&e.jsx("div",{className:"absolute inset-0 z-20 backdrop-blur-sm bg-amber-50/60 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(x,{size:"sm",variant:"ghost",onClick:async()=>{if(jt){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}Rn(!0)},className:"px-4 py-2 rounded-full bg-white border border-gray-100 text-gray-900 shadow-sm hover:bg-gray-50 hover:shadow-md transition-all duration-200 flex items-center gap-2 text-xs font-medium",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(us,{className:"h-3.5 w-3.5 text-gray-600"})]})})]}),e.jsx(Ns,{open:cm,onOpenChange:Rn,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(jt){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),Rn(!1),oo(!0);return}oo(!1),Rn(!1)},userId:s==null?void 0:s.uid}),((uc=nt==null?void 0:nt.subscription)==null?void 0:uc.planType)!==Qs.TAHWEELA&&e.jsxs(vt,{className:"bg-gray-50 border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-200 relative overflow-hidden",children:[e.jsx(Ht,{className:"pb-2 px-3 pt-3 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ms,{className:"text-sm font-bold text-gray-900 flex items-center gap-2",children:[e.jsx("div",{className:"p-1 rounded-md bg-gradient-to-br from-gray-100 to-gray-200",children:e.jsx(kc,{className:"h-4 w-4 text-gray-700"})}),e.jsx("span",{className:"text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>{Zl("daily"),Kr(!0)},className:"h-8 w-8 p-0 bg-transparent hover:bg-red-50 text-red-600 hover:text-red-700 rounded-full transition-colors duration-200",title:"تصفير معاملات اليوم",children:e.jsx(ds,{className:"h-3.5 w-3.5"})}),e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>om(t=>!t),className:"h-8 w-8 p-0 bg-transparent hover:bg-gray-100 text-gray-600 hover:text-blue-600 rounded-full transition-colors duration-200",title:Gr?"توسيع اليوم والشهر":"طي اليوم والشهر",children:Gr?e.jsx(jn,{className:"h-3.5 w-3.5"}):e.jsx(Yc,{className:"h-3.5 w-3.5"})}),e.jsx("div",{className:"p-2 bg-green-50 rounded-full border border-green-100",children:e.jsx(fn,{className:"h-3.5 w-3.5 text-green-600"})})]})]})}),!Gr&&e.jsxs(St,{className:"pt-0 px-2 pb-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-0 rounded-lg overflow-hidden border border-gray-200 divide-x divide-y divide-gray-200 bg-white",children:[e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-blue-600",children:"عدد المعاملات"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-blue-800 mt-0.5 sm:mt-0",children:hn().totalTransactions})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-gray-600",children:"إجمالي المبالغ"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-gray-900 mt-0.5 sm:mt-0",children:hn().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-red-600",children:"المسحوب"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-red-800 mt-0.5 sm:mt-0",children:hn().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-green-600",children:"المرسل"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-green-800 mt-0.5 sm:mt-0",children:hn().totalSent.toFixed(2)})]})]}),e.jsxs("div",{className:"mt-2 rounded-lg border border-gray-100 bg-white px-2 py-1.5 flex items-center justify-between",children:[e.jsx("span",{className:"text-[12px] font-bold text-yellow-600",children:"الأرباح"}),e.jsx(Nx,{userId:s==null?void 0:s.uid,transactions:Qe})]})]}),xm&&e.jsx("div",{className:"absolute inset-0 z-20 backdrop-blur-sm bg-white/60 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(x,{size:"sm",variant:"ghost",onClick:()=>$i(!0),className:"px-4 py-2 rounded-full bg-white border border-gray-100 text-gray-900 shadow-sm hover:bg-gray-50 hover:shadow-md transition-all duration-200 flex items-center gap-2 text-xs font-medium",title:"عرض تقارير اليوم (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير اليوم"}),e.jsx(us,{className:"h-3.5 w-3.5 text-gray-600"})]})})]}),e.jsx(Ns,{open:pm,onOpenChange:$i,mode:"verify",title:"الرقم السري لفتح تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{ho(!1),$i(!1)},userId:s==null?void 0:s.uid})]}),e.jsxs(vt,{className:"balance-bar bg-gray-200 border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(St,{className:"p-2 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"bg-white border border-gray-200 p-1 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 group/cash relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex flex-col relative z-10 w-full",children:[e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx(es,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsx("span",{className:"text-[11px] font-extrabold text-emerald-800",children:"الفلوس النقدية"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-green-600 hover:bg-green-50 transition-colors",onClick:()=>rn(!0),children:e.jsx(Ut,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-emerald-600 hover:bg-emerald-50 transition-colors",onClick:()=>Qo(!0),title:"تفاصيل الفلوس النقدية",children:e.jsx(Tc,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-red-600 hover:bg-red-50 transition-colors",onClick:()=>ci(!0),children:e.jsx(ds,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"mt-0.5",children:e.jsxs("span",{className:"text-[14px] sm:text-xl font-bold text-emerald-800 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm block w-fit",children:[Et.toLocaleString("en-US")," جنيه"]})})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 p-1 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 group/wallet relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex flex-col relative z-10 w-full",children:[e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(aa,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsx("span",{className:"text-[11px] font-extrabold text-blue-800",children:"الأرصدة علي المحافظ"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-green-600 hover:bg-green-50 transition-colors",onClick:()=>ri(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(Ut,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-blue-600 hover:bg-blue-50 transition-colors",onClick:()=>ki(!0),title:"عرض المحافظ",children:e.jsx(aa,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-red-600 hover:bg-red-50 transition-colors",onClick:()=>{li(!0),oi("")},title:"تصفير إجمالي المحفظة",children:e.jsx(ds,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"mt-0.5",children:e.jsxs("span",{className:"text-[14px] sm:text-xl font-bold text-blue-800 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm block w-fit",children:[Object.values(it).reduce((t,a)=>t+a,0).toLocaleString("en-US")," جنيه"]})})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-white border border-gray-200 p-1 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 group/selwallet relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex flex-col relative z-10 w-full",children:[e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(aa,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsx("span",{className:"text-[11px] font-extrabold text-indigo-800",children:"رصيد المحفظه"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-green-600 hover:bg-green-50 transition-colors",onClick:()=>{if(!R){i({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}wh(R)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(Ut,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-red-600 hover:bg-red-50 transition-colors",onClick:()=>{if(!R){i({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}Jn(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(ds,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"mt-0.5",children:e.jsxs("span",{className:"text-[14px] sm:text-xl font-bold text-indigo-800 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm block w-fit",children:[(R&&it[R]||0).toLocaleString("en-US")," جنيه"]})})]})]})]})})]}),e.jsxs(vt,{className:"bg-gray-100 border border-gray-200 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsxs(Ht,{className:`pb-2 px-4 pt-4 relative z-10 ${Y?"sticky top-0 z-20 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/60":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ms,{className:"text-sm font-bold flex items-center gap-2 text-gray-900",children:[!Y&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gray-100 rounded-lg",children:e.jsx(fn,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-700"})}),e.jsx("span",{className:"text-gray-900",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!Y&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-100 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(Gc,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx(z,{placeholder:"بحث...",value:Xl,onChange:t=>Qd(t.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!Y&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"تقسيط"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{if(jt||$t){i({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"});return}Mn(!0)},title:"إدارة التقسيط",children:e.jsx(Yh,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-green-600 mb-1",children:"شحن"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-green-100 text-green-600 hover:bg-green-200 border border-green-200 ring-3 ring-green-300 transition-all duration-200 hover:scale-105 active:bg-green-600 active:text-white active:border-green-600",onClick:()=>{i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."})},title:"شحن الرصيد",children:e.jsx(Dn,{className:"h-5 w-5 text-green-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>Li(!0),title:"آلة حاسبة",children:e.jsx(Xc,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{jt||$t?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):$n(!0)},title:"كروت الائتمان",children:e.jsx(Dn,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"تقاريرك"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:()=>{if(jt||$t){i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"});return}qo(!0)},title:"تقاريرك",children:e.jsx(_c,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-sky-600 mb-1",children:"تلجرام"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-sky-100 text-sky-600 hover:bg-sky-200 border border-sky-200 ring-3 ring-sky-300 transition-all duration-200 hover:scale-105 active:bg-sky-600 active:text-white active:border-sky-600",onClick:()=>{jt||$t?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Cs.hasMasterPin()?Il(!0):ic()},title:"إرسال تقرير يومي إلى تليجرام",children:e.jsx(Eu,{className:"h-5 w-5 text-sky-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:Hm,title:y&&(N!=null&&N.name||N!=null&&N.username)?`بروفيل الوردية: ${(N==null?void 0:N.name)||(N==null?void 0:N.username)}`:"وردية الكاشير",children:e.jsx(Er,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{jt||$t?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Jr(!0)},title:"بيانات المبيعات",children:e.jsx(Ic,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),wt.filter(t=>t.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:wt.filter(t=>t.status==="pending").length})]}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{Yi()},title:"الديون",children:e.jsx(Hh,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-100 text-amber-700 hover:bg-amber-200 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105 active:bg-amber-600 active:text-white active:border-amber-600",onClick:()=>{jt||$t?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Wn(!0)},title:"الصيانة",children:e.jsx(Kc,{className:"h-5 w-5 text-amber-700"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-100 text-violet-700 hover:bg-violet-200 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105 active:bg-violet-700 active:text-white active:border-violet-700",onClick:()=>{!Na||$t?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Fn(!0)},title:"يومية المكنة",children:e.jsx(nd,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-100 text-orange-600 hover:bg-orange-200 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105 active:bg-orange-600 active:text-white active:border-orange-600",onClick:()=>{jt||$t?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Cs.hasMasterPin()?Us(!0):ts(!0)},title:"مصروفات المحل",children:e.jsx(pa,{className:"h-5 w-5 text-orange-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-rose-600 mb-1",children:"النواقص"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-rose-100 text-rose-600 hover:bg-rose-200 border border-rose-200 ring-3 ring-rose-300 transition-all duration-200 hover:scale-105 active:bg-rose-600 active:text-white active:border-rose-600",onClick:()=>{jt||$t?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):na(!0)},title:"النواقص",children:e.jsx(wc,{className:"h-5 w-5 text-rose-600"})})]})]})]})]}),!Y&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"filters-bar flex items-center justify-center gap-3 bg-gray-100 rounded-md p-3 border border-gray-200",children:[e.jsx(x,{variant:"ghost",size:"sm",className:`btn-filter-send h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${_a==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-100"}`,onClick:()=>Ai("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(x,{variant:"ghost",size:"sm",className:`btn-filter-withdraw h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${_a==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-100"}`,onClick:()=>Ai("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(x,{variant:"ghost",size:"sm",className:`btn-filter-all h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${_a==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-100"}`,onClick:()=>Ai("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(x,{variant:"ghost",size:"sm",className:"h-auto px-2 py-1 text-xs text-red-600 hover:bg-red-50 rounded-md font-medium",onClick:()=>sn(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(ds,{className:"h-3 w-3 mr-1"}),"تصفير"]}),nh>0&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),e.jsx(Ns,{open:sm,onOpenChange:Mn,mode:"verify",title:"فتح إدارة التقسيط",description:"أدخل الرقم السري الرئيسي للوصول إلى إدارة التقسيط",onSuccess:()=>{Mn(!1),lo(!0)}}),e.jsx(iu,{open:am,onOpenChange:lo}),e.jsx(Ns,{open:mh,onOpenChange:Il,mode:"verify",title:"إرسال تقرير يومي إلى تليجرام",description:"أدخل الرقم السري الرئيسي لإرسال التقرير اليومي إلى تليجرام",onSuccess:()=>{Il(!1),ic()}}),io,e.jsxs(St,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:[Pl.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(fn,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):Y?e.jsx("div",{className:"overflow-y-auto overscroll-contain scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[310px]",children:e.jsx("div",{className:"space-y-2 pr-2",children:Pl.map(t=>e.jsxs("div",{className:"relative flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer",onClick:()=>cc(t),children:[e.jsx("div",{className:`h-10 w-10 rounded-full flex items-center justify-center shrink-0 ${t.type==="withdraw"?"bg-red-100":"bg-green-100"}`,children:(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return r?e.jsx(pa,{className:"h-5 w-5 text-gray-600"}):l?e.jsx(Ut,{className:"h-5 w-5 text-green-600"}):t.type==="withdraw"?e.jsx(_r,{className:"h-5 w-5 text-red-600"}):e.jsx(Ac,{className:"h-5 w-5 text-green-600"})})()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h4",{className:"text-base font-bold truncate",children:(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return r?e.jsx("span",{className:"text-foreground",children:"تسليم وردية"}):l?e.jsx("span",{className:"text-foreground",children:"إضافة نقدية"}):t.type==="send"?e.jsx("span",{className:"text-green-600",children:"تحويل أموال"}):e.jsx("span",{className:"text-red-600",children:"سحب نقدي"})})()}),e.jsxs("span",{className:`text-base font-bold whitespace-nowrap ${t.type==="withdraw"?"text-red-600":"text-green-600"}`,children:[t.type==="withdraw"||t.type==="cash_addition"||t.txnType==="cash_addition"?"+":"-"," ",Gs(t.amount)," ج.م"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-0.5",children:[e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية"),o=(a==null?void 0:a.note)||(a==null?void 0:a.notes)||"";return r?`إلى: ${t.receiverPhone}`:l?o||"إضافة يدوية":t.type==="send"?e.jsx("span",{dir:"ltr",children:t.receiverPhone}):e.jsx("span",{dir:"ltr",children:t.senderPhone})})()}),e.jsxs("p",{className:"text-sm font-medium text-gray-500 mt-0.5",children:[ui.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",hc.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]}),e.jsxs("div",{className:`px-2 py-0.5 rounded-full text-[10px] font-medium flex items-center gap-1 ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700":"bg-green-100 text-green-700":t.status==="pending"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:[t.status==="completed"&&e.jsx(wn,{className:"h-3 w-3"}),t.status==="pending"&&e.jsx(Da,{className:"h-3 w-3"}),t.status==="failed"&&e.jsx(Cn,{className:"h-3 w-3"}),e.jsx("span",{children:t.status==="completed"?"ناجحة":t.status==="pending"?"معالجة":"فشلت"})]})]})]})]},t.id))})}):e.jsx("div",{className:"overflow-y-auto overscroll-contain scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[calc(100dvh-300px)]",children:e.jsx("div",{className:"space-y-2 pr-2",children:Pl.map(t=>e.jsxs("div",{className:"relative flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer",onClick:()=>cc(t),children:[e.jsx("div",{className:`h-10 w-10 rounded-full flex items-center justify-center shrink-0 ${t.type==="withdraw"?"bg-red-100":"bg-green-100"}`,children:(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return r?e.jsx(pa,{className:"h-5 w-5 text-gray-600"}):l?e.jsx(Ut,{className:"h-5 w-5 text-green-600"}):t.type==="withdraw"?e.jsx(_r,{className:"h-5 w-5 text-red-600"}):e.jsx(Ac,{className:"h-5 w-5 text-green-600"})})()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h4",{className:"text-base font-bold truncate",children:(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return r?e.jsx("span",{className:"text-foreground",children:"تسليم وردية"}):l?e.jsx("span",{className:"text-foreground",children:"إضافة نقدية"}):t.type==="send"?e.jsx("span",{className:"text-green-600",children:"تحويل أموال"}):e.jsx("span",{className:"text-red-600",children:"سحب نقدي"})})()}),e.jsxs("span",{className:`text-base font-bold whitespace-nowrap ${t.type==="withdraw"?"text-red-600":"text-green-600"}`,children:[t.type==="withdraw"||t.type==="cash_addition"||t.txnType==="cash_addition"?"+":"-"," ",Gs(t.amount)," ج.م"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-0.5",children:[e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية"),o=(a==null?void 0:a.note)||(a==null?void 0:a.notes)||"";return r?`إلى: ${t.receiverPhone}`:l?o||"إضافة يدوية":t.type==="send"?e.jsx("span",{dir:"ltr",children:t.receiverPhone}):e.jsx("span",{dir:"ltr",children:t.senderPhone})})()}),e.jsxs("p",{className:"text-sm font-medium text-gray-500 mt-0.5",children:[ui.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",hc.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]}),e.jsxs("div",{className:`px-2 py-0.5 rounded-full text-[10px] font-medium flex items-center gap-1 ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700":"bg-green-100 text-green-700":t.status==="pending"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:[t.status==="completed"&&e.jsx(wn,{className:"h-3 w-3"}),t.status==="pending"&&e.jsx(Da,{className:"h-3 w-3"}),t.status==="failed"&&e.jsx(Cn,{className:"h-3 w-3"}),e.jsx("span",{children:t.status==="completed"?"ناجحة":t.status==="pending"?"معالجة":"فشلت"})]})]})]})]},t.id))})}),Y&&e.jsxs("div",{className:"mt-2 flex justify-end",children:[e.jsxs(x,{variant:"ghost",size:"sm",className:"h-7 px-2 text-[11px] rounded-full border bg-red-100 text-red-700 border-red-300 hover:bg-red-200",onClick:()=>sn(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(ds,{className:"h-3 w-3 mr-1"}),"تصفير"]}),(s==null?void 0:s.uid)&&localStorage.getItem(`recentTransactionsResetAt:${s.uid}`)&&e.jsx("span",{className:"inline-block h-1.5 w-1.5 rounded-full bg-red-500 ml-1 align-middle"})]})]})]})]}),e.jsx(lu,{isOpen:Bd,onClose:()=>On(!1),transaction:Ud,onPrint:()=>window.print(),onDelete:Yd,onComplete:Hd}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full",children:[e.jsxs(vt,{id:"transaction-section",className:"bg-gray-100 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx(Ht,{className:"sticky top-0 z-20 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ms,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Lr,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[ys&&e.jsx("div",{className:"hidden md:flex items-center gap-1 bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 border border-emerald-200 text-emerald-800 text-sm transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:e.jsxs("span",{className:"text-sm font-semibold whitespace-nowrap",children:["تجربة: ",Es," ",Es>=3&&Es<=10?"ساعات":Es===2?"ساعتين":"ساعة"]})}),e.jsxs("div",{className:"top-icons-bar hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:[e.jsx(Qu,{}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"VIP",onClick:()=>Mi(!0),children:e.jsx(ju,{className:"h-5 w-5 text-yellow-500"})}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"إدارة الفروع",onClick:()=>{i({title:"قيد التطوير",description:"إدارة الفرع قيد التطوير حالياً"})},children:e.jsx(ed,{className:"h-5 w-5"})}),e.jsx(au,{})]})]}),dh&&e.jsxs(x,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:tc,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx(td,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsx(je,{open:um,onOpenChange:Mi,children:e.jsxs(Se,{className:"sm:max-w-md",children:[e.jsx(Te,{children:e.jsx(De,{children:"أفضل 10 عملاء هذا الشهر"})}),e.jsx("div",{className:"space-y-2",children:ii.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا توجد بيانات لهذا الشهر"}):ii.map((t,a)=>e.jsxs("div",{className:`flex items-center justify-between border rounded-md px-3 py-2 bg-white ${a===0?"bg-yellow-50 border-yellow-300":""}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Mt,{variant:"outline",className:`min-w-[28px] justify-center ${a===0?"border-yellow-300 text-yellow-700 bg-yellow-50":""}`,children:a+1}),e.jsx("span",{className:`font-semibold ${a===0?"text-yellow-700":""}`,children:t.phone})]}),e.jsxs("div",{className:"text-sm text-gray-700 flex items-center gap-3",children:[e.jsxs("span",{children:["عدد: ",t.count]}),e.jsxs("span",{children:["إجمالي: ",t.total]}),e.jsx(x,{variant:"outline",size:"sm",className:"h-8",onClick:()=>lh(t),title:"إرسال واتساب",children:e.jsx(Nc,{className:"h-4 w-4"})})]})]},t.phone+a))}),e.jsx(mt,{children:e.jsx(x,{onClick:()=>Mi(!1),children:"إغلاق"})})]})}),e.jsx(je,{open:dm,onOpenChange:co,children:e.jsxs(Se,{className:"sm:max-w-md",children:[e.jsx(Te,{children:e.jsx(De,{children:"ربط بوت التلجرام"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{children:"Telegram Chat ID"}),e.jsx(z,{value:Bn,onChange:t=>mm(t.target.value),placeholder:"اكتب رقم المحادثة"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Z,{children:"إرسال يومي 12 صباحاً"}),e.jsx(du,{checked:mo,onCheckedChange:t=>hm(!!t)})]})]}),e.jsxs(mt,{children:[e.jsx(x,{variant:"outline",onClick:()=>co(!1),children:"إغلاق"}),e.jsx(x,{onClick:async()=>{s!=null&&s.uid&&(await Ie.updateUserData(s.uid,{telegramChatId:Bn,telegramDailyEnabled:mo}),i({title:"تم الحفظ"}))},children:"حفظ"}),e.jsx(x,{onClick:async()=>{if(!(s!=null&&s.uid)||!Bn){i({title:"أدخل Chat ID"});return}const t=await rc();try{const{sendTelegramMessage:a}=await bt(async()=>{const{sendTelegramMessage:r}=await Promise.resolve().then(()=>$u);return{sendTelegramMessage:r}},void 0,import.meta.url);await a({chatId:Bn,text:t}),i({title:"تم الإرسال"})}catch{i({title:"تعذر الإرسال",description:"تحقق من ربط البوت",variant:"destructive"})}},children:"إرسال الآن"})]})]})}),e.jsx(je,{open:fe,onOpenChange:oe,children:e.jsxs(Se,{className:"sm:max-w-lg",children:[e.jsxs(Te,{children:[e.jsx(De,{children:"إدارة الفروع"}),e.jsx(rs,{children:"أضف فروع جديدة وأدِر الدخول لكل فرع"}),e.jsx("div",{className:"flex items-center justify-end gap-2 mt-2",children:e.jsx(x,{variant:"outline",size:"sm",onClick:()=>{try{const t=s!=null&&s.uid?`selectedShopId_${s.uid}`:"selectedShopId";localStorage.removeItem(t);try{window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}i({title:"تم الخروج من الفرع"}),O(`/branch/${String(b.shopId)}/dashboard`)}catch{}},children:"الخروج من الفرع"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(Z,{children:"اسم المدير"}),e.jsx(z,{value:Ye,onChange:t=>Ve(t.target.value),placeholder:"اكتب اسم المدير"})]}),e.jsxs("div",{children:[e.jsx(Z,{children:"اسم الفرع"}),e.jsx(z,{value:Ze,onChange:t=>ht(t.target.value),placeholder:"اكتب اسم الفرع"})]}),e.jsxs("div",{children:[e.jsx(Z,{children:"اسم المستخدم للدخول"}),e.jsx(z,{value:Ot,onChange:t=>X(t.target.value),placeholder:"مثال: branch1"})]}),e.jsxs("div",{children:[e.jsx(Z,{children:"كلمة السر"}),e.jsx(z,{type:"password",value:Ae,onChange:t=>st(t.target.value),placeholder:"••••••"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{Ve(""),ht(""),X(""),st("")},children:"مسح"}),e.jsx(x,{className:"bg-indigo-600 hover:bg-indigo-700",disabled:Dt,onClick:async()=>{if(!(s!=null&&s.uid))return;const t=Ye.trim(),a=Ze.trim(),r=Ot.trim(),l=Ae.trim();if(!t||!a||!r||!l){i({title:"يرجى ملء جميع الحقول"});return}if(ne.length>=3){i({title:"عفواً",description:"لقد وصلت للحد الأقصى من الفروع (3 فروع)",variant:"destructive"});return}try{Pt(!0);let o="";try{o=(await ca(ke(V,"shops"),{name:a,ownerId:s.uid,createdAt:yt(),updatedAt:yt(),isActive:!0})).id}catch{o=(await ca(ke(V,"users",s.uid,"shops"),{name:a,ownerId:s.uid,createdAt:yt(),updatedAt:yt(),isActive:!0})).id}const m=h=>{try{return btoa(unescape(encodeURIComponent(h)))}catch{return btoa(h)}};try{await ca(ke(V,"branches"),{ownerId:s.uid,shopId:o,branchName:a,managerName:t,loginUsername:r,passwordEncoded:m(l),createdAt:yt()})}catch{await ca(ke(V,"users",s.uid,"branches"),{ownerId:s.uid,shopId:o,branchName:a,managerName:t,loginUsername:r,passwordEncoded:m(l),createdAt:yt()})}try{const h=Ge(ke(V,"branches"),me("ownerId","==",s.uid));let v=(await He(h)).docs.map(g=>({id:g.id,...g.data()}));if(v.length===0){const g=Ge(ke(V,"users",s.uid,"branches"));v=(await He(g)).docs.map(S=>({id:S.id,...S.data()}))}Re(v)}catch{try{const h=Ge(ke(V,"users",s.uid,"branches")),v=(await He(h)).docs.map(g=>({id:g.id,...g.data()}));Re(v)}catch{}}Ve(""),ht(""),X(""),st(""),i({title:"تم إضافة الفرع بنجاح"})}catch{i({title:"تعذّر إضافة الفرع"})}finally{Pt(!1)}},children:"إضافة فرع"})]}),e.jsxs("div",{className:"border-t pt-3",children:[e.jsx("h4",{className:"text-sm font-semibold mb-2",children:"الفروع الحالية"}),Dt?e.jsx("div",{className:"text-sm text-gray-500",children:"جارٍ التحميل..."}):ne.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"لا يوجد فروع بعد"}):e.jsx("div",{className:"space-y-2",children:ne.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-lg bg-white",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:t.branchName}),e.jsxs("div",{className:"text-gray-600",children:["مدير: ",t.managerName]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{size:"sm",className:"bg-blue-600 hover:bg-blue-700",onClick:()=>{$e(t),Be(String(t.loginUsername||"")),re(""),le(!0)},children:"دخول الفرع"}),e.jsx(x,{size:"sm",variant:"destructive",onClick:async()=>{if(confirm("هل أنت متأكد من حذف الفرع؟ سيتم حذف بيانات الفرع المرتبطة."))try{try{await Bs(Ue(V,"branches",t.id))}catch{}try{await Bs(Ue(V,"users",(s==null?void 0:s.uid)||"","branches",t.id))}catch{}if(t.shopId){try{await Bs(Ue(V,"shops",String(t.shopId)))}catch{}try{await Bs(Ue(V,"users",(s==null?void 0:s.uid)||"","shops",String(t.shopId)))}catch{}}Re(a=>a.filter(r=>r.id!==t.id)),i({title:"تم حذف الفرع"})}catch{i({title:"تعذّر حذف الفرع"})}},children:"حذف الفرع"})]})]},t.id))})]})]})]})}),e.jsx(je,{open:xs,onOpenChange:le,children:e.jsxs(Se,{className:"sm:max-w-md",children:[e.jsxs(Te,{children:[e.jsx(De,{children:"دخول الفرع"}),e.jsx(rs,{children:"أدخل بيانات الدخول للفرع المحدد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(Z,{children:"اسم المستخدم"}),e.jsx(z,{value:ve,onChange:t=>Be(t.target.value),placeholder:"اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(Z,{children:"كلمة السر"}),e.jsx(z,{type:"password",value:tt,onChange:t=>re(t.target.value),placeholder:"••••••"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{Be(""),re("")},children:"مسح"}),e.jsx(x,{className:"bg-blue-600 hover:bg-blue-700",disabled:Je,onClick:async()=>{const t=Me;if(!t){le(!1);return}const a=String(t.loginUsername||"");let r="";try{const m=String(t.passwordEncoded||"");r=m?decodeURIComponent(escape(atob(m))):""}catch{try{r=t.passwordEncoded?atob(String(t.passwordEncoded)):""}catch{r=""}}const l=ve.trim(),o=tt.trim();if(!l||!o){i({title:"يرجى إدخال اسم المستخدم وكلمة السر"});return}if(l!==a||o!==r){i({title:"بيانات الدخول غير صحيحة",variant:"destructive"});return}try{ee(!0);const m=s!=null&&s.uid?`selectedShopId_${s.uid}`:"selectedShopId";localStorage.setItem(m,String(t.shopId)),i({title:"تم الدخول إلى الفرع",description:String(t.branchName||"")}),le(!1),oe(!1),O("/user/dashboard")}catch{}ee(!1)},children:"دخول"})]})]})]})}),e.jsxs(St,{ref:p,className:"space-y-1 px-2 pb-2 relative z-10 transition-transform duration-200 ease-out will-change-transform",style:{transform:c?`translateY(${c}px)`:void 0},onFocusCapture:t=>{const a=t.target;if(!((a==null?void 0:a.id)==="transferExtraFeeInput")){j(0);return}const l=document.getElementById("transferSubmitButton");if(l){const o=l.getBoundingClientRect(),m=window.innerHeight;if(o.bottom>m){const h=o.bottom-m,u=Math.min(h,220);j(-u)}else j(0)}else j(0)},onBlurCapture:t=>{t.currentTarget.contains(t.relatedTarget)||j(0)},children:[e.jsxs("div",{className:"transaction-type-tabs flex w-full rounded-full border border-gray-300 overflow-hidden bg-surface fade-in-up",children:[e.jsxs("button",{type:"button",onClick:()=>hi("transfer"),className:`flex-1 h-10 text-sm font-medium transition-colors duration-200 flex items-center justify-center gap-2 ${ge==="transfer"?"bg-blue-100 text-blue-900":"bg-transparent text-gray-600 hover:bg-gray-50"}`,children:[ge==="transfer"&&e.jsx(wn,{className:"h-4 w-4"}),e.jsx(fn,{className:"h-4 w-4"}),"تحويل"]}),e.jsx("div",{className:"w-[1px] bg-gray-300"}),e.jsxs("button",{type:"button",onClick:()=>hi("withdraw"),className:`flex-1 h-10 text-sm font-medium transition-colors duration-200 flex items-center justify-center gap-2 ${ge==="withdraw"?"bg-red-100 text-red-900":"bg-transparent text-gray-600 hover:bg-gray-50"}`,children:[ge==="withdraw"&&e.jsx(wn,{className:"h-4 w-4"}),e.jsx(_r,{className:"h-4 w-4"}),"سحب"]})]}),e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(aa,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(x,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>O("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(Ut,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(x,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>{ya(!0)},title:"المحافظ",children:[e.jsx(aa,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),ze.length>0?e.jsxs(Ka,{value:R,onValueChange:uh,children:[e.jsx(Ya,{"data-testid":"wallet-select",className:"w-full h-14 text-base bg-surface border border-gray-400 hover:border-gray-800 focus:border-primary rounded-xl transition-colors duration-200 flex items-center",children:e.jsx(Ha,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-700"})}),e.jsxs(Qa,{className:"rounded-xl border border-gray-200 shadow-md z-[9999] bg-white dark:bg-gray-900",children:[e.jsx("div",{"data-fixed-header":"true",className:"sticky top-0 z-10 bg-white dark:bg-gray-900 p-2 border-b border-gray-100 dark:border-gray-800",children:e.jsx(z,{value:Hl,onChange:t=>Wd(t.target.value),placeholder:"ابحث برقم المحفظة",className:"h-10 text-sm border-gray-300 rounded-lg"})}),e.jsx("div",{className:"p-1",children:Ql.length===0?e.jsx("div",{className:"text-sm text-gray-500 p-3 text-center",children:"لا توجد نتائج مطابقة"}):Ql.map(t=>e.jsx(ua,{value:t.id,className:"rounded-lg my-1 cursor-pointer hover:bg-gray-100 focus:bg-blue-50 transition-colors duration-200",children:e.jsxs("div",{className:"flex items-center gap-3 py-2 w-full",children:[e.jsx(aa,{className:"h-5 w-5 text-gray-500"}),e.jsxs("div",{className:"flex items-center gap-2 text-right",children:[e.jsx("span",{className:"text-base font-medium text-gray-900",children:t.name}),e.jsx("span",{className:"text-sm font-bold text-red-600",children:t.phone})]}),t.isDefault&&e.jsx("span",{className:"mr-auto text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full border border-gray-200",children:"افتراضي"})]})},t.id))})]})]}):e.jsx("div",{className:"rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 px-3 py-3 text-xs text-gray-600",children:"لا توجد محافظ حتى الآن. اضغط “إضافة محفظة” لإضافة أول محفظة."})]}),e.jsx(je,{open:Js,onOpenChange:ia,children:e.jsxs(Se,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(Te,{children:e.jsx(De,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(bu,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),e.jsx(Ns,{open:sr,onOpenChange:ya,mode:"verify",title:"الرقم السري لفتح المحافظ",description:"أدخل الرقم السري الرئيسي لعرض وإدارة المحافظ",onSuccess:()=>{ya(!1),ia(!0)},userId:s==null?void 0:s.uid}),e.jsx(Ns,{open:As,onOpenChange:t=>{ba(t),t||An(null)},mode:"verify",title:"تأكيد تغيير المحفظة",description:"أدخل الرقم السري الرئيسي لتغيير المحفظة المختارة",onSuccess:()=>{qr&&(cn(qr,"walletSelectionPin"),An(null)),ba(!1)},userId:s==null?void 0:s.uid}),R&&ze.length>0&&(()=>{var K;const t=ze.find(be=>be.id===R),a=La,r=gh(R),l=(at==null?void 0:at.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,o=(at==null?void 0:at.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,m=(at==null?void 0:at.monthlyWithdrawUsed)??a.totalWithdrawn??0,h=(at==null?void 0:at.monthlyTransferUsed)??a.totalTransferred??0,u=((K=nt==null?void 0:nt.subscription)==null?void 0:K.planType)===Qs.TAHWEELA,v=u?0:(at==null?void 0:at.dailyWithdrawLimit)??1e5,g=u?0:(at==null?void 0:at.dailyTransferLimit)??6e4,f=u?0:(at==null?void 0:at.dailyWithdrawUsed)??r.totalWithdrawn??0,S=u?0:(at==null?void 0:at.dailyTransferUsed)??r.totalTransferred??0,A=parseFloat(zt||"0")||0,T=m+(ge==="withdraw"?A:0),J=h+(ge==="transfer"?A:0),Ne=f+(ge==="withdraw"?A:0),E=S+(ge==="transfer"?A:0);return t?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2 p-2 bg-gray-50 rounded-xl border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-gray-200 pb-1",children:[e.jsx("span",{className:"text-sm font-bold text-gray-800",children:"الحدود الشهرية"}),e.jsx("span",{className:"text-xs font-medium text-gray-500 bg-white px-2 py-0.5 rounded-full border border-gray-200",children:Om||(t==null?void 0:t.name)})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-1 font-medium",children:[e.jsx("span",{className:"text-gray-700",children:"سحب شهري"}),e.jsxs("span",{className:"text-gray-600 dir-ltr",children:[Math.max(l-T,0).toLocaleString("en-US",{maximumFractionDigits:0})," متبقي"]})]}),e.jsx("div",{className:"h-1.5 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner ring-1 ring-gray-200/50",children:e.jsx("div",{className:"h-full bg-gradient-to-l from-red-500 to-red-600 rounded-full transition-all duration-500 ease-out shadow-sm",style:{width:`${Math.min(T/Math.max(l,1)*100,100)}%`}})}),e.jsxs("div",{className:"flex justify-between mt-0.5",children:[e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["المستخدم: ",T.toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["الحد: ",l.toLocaleString("en-US",{maximumFractionDigits:0})]})]})]}),e.jsx("div",{className:"w-[1px] bg-gray-200 self-stretch"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-1 font-medium",children:[e.jsx("span",{className:"text-gray-700",children:"تحويل شهري"}),e.jsxs("span",{className:"text-gray-600 dir-ltr",children:[Math.max(o-J,0).toLocaleString("en-US",{maximumFractionDigits:0})," متبقي"]})]}),e.jsx("div",{className:"h-1.5 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner ring-1 ring-gray-200/50",children:e.jsx("div",{className:"h-full bg-gradient-to-l from-blue-500 to-blue-600 rounded-full transition-all duration-500 ease-out shadow-sm",style:{width:`${Math.min(J/Math.max(o,1)*100,100)}%`}})}),e.jsxs("div",{className:"flex justify-between mt-0.5",children:[e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["المستخدم: ",J.toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["الحد: ",o.toLocaleString("en-US",{maximumFractionDigits:0})]})]})]})]})]}),e.jsxs("div",{className:"space-y-1 pt-1.5 border-t border-gray-200",children:[e.jsx("div",{className:"flex items-center justify-between mb-0.5",children:e.jsx("span",{className:"text-sm font-bold text-gray-800",children:"الحدود اليومية"})}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-1 font-medium",children:[e.jsx("span",{className:"text-gray-700",children:"سحب يومي"}),e.jsxs("span",{className:"text-gray-600 dir-ltr",children:[Math.max(v-Ne,0).toLocaleString("en-US",{maximumFractionDigits:0})," متبقي"]})]}),e.jsx("div",{className:"h-1.5 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner ring-1 ring-gray-200/50",children:e.jsx("div",{className:"h-full bg-gradient-to-l from-orange-400 to-orange-500 rounded-full transition-all duration-500 ease-out",style:{width:`${Math.min(Ne/Math.max(v,1)*100,100)}%`}})}),e.jsxs("div",{className:"flex justify-between mt-0.5",children:[e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["المستخدم: ",Ne.toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["الحد: ",v.toLocaleString("en-US",{maximumFractionDigits:0})]})]})]}),e.jsx("div",{className:"w-[1px] bg-gray-200 self-stretch"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-1 font-medium",children:[e.jsx("span",{className:"text-gray-700",children:"تحويل يومي"}),e.jsxs("span",{className:"text-gray-600 dir-ltr",children:[Math.max(g-E,0).toLocaleString("en-US",{maximumFractionDigits:0})," متبقي"]})]}),e.jsx("div",{className:"h-1.5 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner ring-1 ring-gray-200/50",children:e.jsx("div",{className:"h-full bg-gradient-to-l from-green-500 to-green-600 rounded-full transition-all duration-500 ease-out",style:{width:`${Math.min(E/Math.max(g,1)*100,100)}%`}})}),e.jsxs("div",{className:"flex justify-between mt-0.5",children:[e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["المستخدم: ",E.toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["الحد: ",g.toLocaleString("en-US",{maximumFractionDigits:0})]})]})]})]})]})]}):null})(),ge==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative group",children:[e.jsx(Ca,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-green-600 group-focus-within:text-green-700 transition-colors"}),e.jsx(z,{value:ma,onChange:t=>ka(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("receiverPhoneInput");if(a)a.focus();else{const r=document.getElementById("amountInput");r==null||r.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-blue-600 focus:ring-1 focus:ring-blue-600 transition-all duration-200"})]})]}),!W&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative group",children:[e.jsx(Ca,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-green-600 group-focus-within:text-green-700 transition-colors"}),e.jsx(z,{id:"receiverPhoneInput",value:js,onChange:t=>{pr(t.target.value),Oi&&br(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("amountInput");a==null||a.focus()}},inputMode:"numeric",maxLength:11,placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-blue-600 focus:ring-1 focus:ring-blue-600 transition-all duration-200"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ca,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(z,{value:R&&((xc=ze.find(t=>t.id===R))==null?void 0:xc.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 text-sm lg:text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl transition-all duration-300"})]})]}),ge==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2 group",children:[e.jsx(es,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-yellow-600 group-focus-within:text-yellow-700 transition-colors"}),e.jsx(z,{id:"amountInput",value:zt,onChange:t=>{er(t.target.value),Oi&&br(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("transferCommissionInput");if(a)a.focus();else{const r=document.getElementById("quickDebtButton");r==null||r.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-blue-600 focus:ring-1 focus:ring-blue-600 transition-all duration-200"})]}),Ce?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",Ce.debtorName," بمبلغ ",Ce.amount," جنيه"]}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>pe(null),children:"إلغاء"})]}):null]}),(()=>{if(W)return null;const t=bs();return t&&t.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",t==null?void 0:t.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(x,{id:"quickDebtButton",type:"button",variant:"destructive",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-medium",onClick:()=>{const r=bs(),l=(r==null?void 0:r.defaultTransferCommission)!=null?Number(r.defaultTransferCommission):0,o=parseFloat(zt||"0")||0,m=Math.round((l||0)*o/1e3*100)/100,h=o+m;he((h||0).toString()),jt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):d(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",className:"hidden",title:kt?"العمولة تُضاف":"العمولة تُخصم",children:kt?e.jsx(Ut,{className:"h-4 w-4 text-green-600"}):e.jsx(hr,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:kt?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1 group",children:[e.jsx(es,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-yellow-600 group-focus-within:text-yellow-700 transition-colors"}),e.jsx(z,{id:"transferCommissionInput",value:as,onChange:r=>fr(r.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all duration-200"})]}),e.jsx(x,{type:"button",variant:"destructive",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-medium",onClick:()=>{const r=bs(),l=parseFloat(zt||"0")||0;let o=0;if((r==null?void 0:r.defaultTransferCommission)!=null){const h=Number(r.defaultTransferCommission)||0;o=Math.round(h*l/1e3*100)/100}else{const h=as&&as.trim()!==""?parseFloat(as):0;o=Math.max(0,h)}const m=l+o;he((m||0).toString()),jt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):d(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",className:"hidden",title:kt?"العمولة تُضاف":"العمولة تُخصم",children:kt?e.jsx(Ut,{className:"h-4 w-4 text-green-600"}):e.jsx(hr,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:kt?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),(()=>{const t=kn(ma||"").replace(/\D/g,""),a=kn(js||"").replace(/\D/g,"");return ge==="transfer"&&(t.startsWith("010")&&a.startsWith("010")||t.startsWith("010")&&(a.startsWith("011")||a.startsWith("012")||a.startsWith("015"))||t.startsWith("012")&&a.startsWith("010")||t.startsWith("011")&&a.startsWith("010")||t.startsWith("015")&&a.startsWith("010"))?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رسوم التحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(es,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-yellow-600"}),e.jsx(z,{id:"transferExtraFeeInput",value:Tn,onChange:l=>Si(l.target.value),placeholder:"أدخل رسوم التحويل",type:"number",className:"pl-10 h-10 text-sm lg:text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"hidden",children:"تُخصم من المحفظة وتضاف للدرج — لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010"})]}):null})(),e.jsxs("div",{className:"sticky bottom-0 z-20 pt-2 pb-2 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 backdrop-blur supports-[backdrop-filter]:bg-white/90 dark:supports-[backdrop-filter]:bg-gray-900/90",children:[e.jsx(x,{id:"transferSubmitButton",onClick:mc,className:"w-full h-12 text-base font-medium rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-none hover:shadow-md transition-all duration-200",children:Oi?"تم التحويل بنجاح":"تأكيد التحويل"}),kd&&e.jsxs("div",{className:"flex items-start gap-2 mt-2 px-1 animate-in fade-in slide-in-from-bottom-2",children:[e.jsx(wc,{className:"h-4 w-4 text-amber-500 shrink-0 mt-0.5"}),e.jsxs("p",{className:"text-xs text-gray-500 leading-tight",children:["تم الوصول إلى 85% من الحد الشهري للمحفظة ",Di==null?void 0:Di.walletName]})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative group",children:[e.jsx(_r,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400 group-focus-within:text-primary transition-colors"}),e.jsx(z,{id:"amountInput",value:zt,onChange:t=>{er(t.target.value),ao&&Qr(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("manualWithdrawCommissionInput");if(a)a.focus();else{const r=document.getElementById("withdrawSubmitButton");r==null||r.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-primary focus:ring-1 focus:ring-primary transition-all duration-200"})]})]}),Pd&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"اسم الراسل (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Er,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-500"}),e.jsx(z,{id:"withdrawSenderNameInput",value:tr,onChange:t=>gr(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("manualWithdrawCommissionInput");a==null||a.focus()}},placeholder:"أدخل اسم الراسل إن وجد",className:"pl-10 h-10 text-sm lg:text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white transition-all duration-300 hover:border-blue-400 focus:border-blue-500",type:"text"})]})]}),(()=>{const t=bs();return t&&t.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",t==null?void 0:t.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(x,{type:"button",variant:"destructive",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-medium",onClick:()=>{const r=bs(),l=parseFloat(zt||"0")||0,o=(r==null?void 0:r.defaultWithdrawCommission)!=null&&Number(r.defaultWithdrawCommission)||0,m=Math.round(o*l/1e3*100)/100,h=kt?l+m:l;he((h||0).toString()),jt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):d(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>Ii(r=>!r),title:kt?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:kt?e.jsx(Ut,{className:"h-4 w-4"}):e.jsx(hr,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:kt?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(es,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-yellow-600"}),e.jsx(z,{id:"manualWithdrawCommissionInput",value:Vt,onChange:r=>zr(r.target.value),onKeyDown:r=>{if(r.key==="Enter"){const l=document.getElementById("withdrawSubmitButton");l==null||l.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(x,{type:"button",variant:"destructive",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-medium",onClick:()=>{const r=bs(),l=parseFloat(zt||"0")||0;let o=0;if((r==null?void 0:r.defaultWithdrawCommission)!=null){const h=Number(r.defaultWithdrawCommission)||0;o=Math.round(h*l/1e3*100)/100}else{const h=Vt&&Vt.trim()!==""?parseFloat(Vt):Math.round(l*.01*100)/100;o=Math.max(0,h)}const m=kt?l+o:l;he((m||0).toString()),jt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):d(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",title:kt?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>Ii(r=>!r),children:kt?e.jsx(Ut,{className:"h-4 w-4 text-green-600"}):e.jsx(hr,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:kt?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),(w==null?void 0:w.showWithdrawNote)&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"ملاحظة السحب (اختياري)"}),e.jsxs("div",{className:"relative group",children:[e.jsx(Nc,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400 group-focus-within:text-primary transition-colors"}),e.jsx(z,{id:"withdrawNoteInput",value:Pa,onChange:t=>Br(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("withdrawSubmitButton");a==null||a.focus()}},placeholder:"أدخل ملاحظة للسحب (اختياري)",className:"pl-10 h-10 text-base border-gray-400 rounded-xl focus:border-primary focus:ring-1 focus:ring-primary transition-all duration-200"})]})]}),e.jsx("div",{className:"sticky bottom-0 z-20 pt-2 pb-2 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 backdrop-blur supports-[backdrop-filter]:bg-white/90 dark:supports-[backdrop-filter]:bg-gray-900/90",children:e.jsx(x,{id:"withdrawSubmitButton",onClick:mc,className:"w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:ao?"تم السحب بنجاح":"تأكيد السحب"})})]}),e.jsx(je,{open:Ur,onOpenChange:d,children:e.jsxs(Se,{children:[e.jsxs(Te,{children:[e.jsx(De,{children:"تحويل مؤجل"}),e.jsx(rs,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[Ys&&Ys.length>0?e.jsxs("div",{children:[e.jsx(Z,{children:"اختيار عميل"}),e.jsxs(Ka,{value:Pe,onValueChange:t=>{ye(t);const a=Ys.find(r=>r.id===t);a&&B(a.name)},children:[e.jsx(Ya,{className:"w-full",children:e.jsx(Ha,{placeholder:"اختر عميل"})}),e.jsx(Qa,{children:Ys.map(t=>e.jsxs(ua,{value:t.id,children:[t.name,t.mobile?` — ${t.mobile}`:""]},t.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx(z,{id:"quickDebtName",value:_,onChange:t=>B(t.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx(z,{id:"quickDebtAmount",type:"number",value:te,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"quickDebtCommission",children:"العمولة (محسوبة تلقائياً)"}),e.jsx(z,{id:"quickDebtCommission",type:"number",value:function(){const t=bs(),a=parseFloat((zt||"0").toString())||0;let r=0;if(ge==="transfer")if((t==null?void 0:t.defaultTransferCommission)!=null){const l=Number(t.defaultTransferCommission)||0;r=Math.round(l*a/1e3*100)/100}else{const l=as&&as.trim()!==""?parseFloat(as):0;r=Math.max(0,l)}else if((t==null?void 0:t.defaultWithdrawCommission)!=null){const l=Number(t.defaultWithdrawCommission)||0;r=Math.round(l*a/1e3*100)/100}else{const l=Vt&&Vt.trim()!==""?parseFloat(Vt):Math.round(a*.01*100)/100;r=Math.max(0,l)}return String(r||0)}(),readOnly:!0,placeholder:"قيمة العمولة"})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx(z,{id:"quickDebtNotes",value:ce,onChange:t=>we(t.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(mt,{children:e.jsx(x,{type:"button",variant:"default",className:"bg-green-600 text-white hover:bg-green-700",onClick:()=>{const t=bs(),a=parseFloat((zt||"").toString())||0;let r=0;if(ge==="transfer")if((t==null?void 0:t.defaultTransferCommission)!=null){const m=Number(t.defaultTransferCommission)||0;r=Math.round(m*a/1e3*100)/100}else{const m=as&&as.trim()!==""?parseFloat(as):0;r=Math.max(0,m)}else if((t==null?void 0:t.defaultWithdrawCommission)!=null){const m=Number(t.defaultWithdrawCommission)||0;r=Math.round(m*a/1e3*100)/100}else{const m=Vt&&Vt.trim()!==""?parseFloat(Vt):Math.round(a*.01*100)/100;r=Math.max(0,m)}let l=0;if(ge==="withdraw"?l=kt?a:Math.max(0,Math.round((a-r)*100)/100):l=Math.max(0,Math.round((a+r)*100)/100),!_||isNaN(l)||l<=0){i({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const o=Ys.find(m=>m.id===Pe);pe({debtorName:_,amount:l,notes:ce,customerId:Pe||void 0,mobile:o==null?void 0:o.mobile}),ls(!1),d(!1),i({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx(vt,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(St,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(Uu,{isOpen:Ed,onClose:()=>Ld(!1),initialEditingWallet:$d,onWalletUpdate:async()=>{try{await kl()}catch(t){console.error("Error reloading wallets after update:",t)}}}),e.jsx(qu,{isOpen:Rd,onClose:()=>Gl(!1),transaction:Fd,onDelete:xh}),e.jsx(Ns,{open:Vd,onOpenChange:Kr,onSuccess:yh,title:bh(),description:vh(),mode:"verify"}),e.jsx(Oc,{open:Mm,onOpenChange:Lo,onSuccess:Nh,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:Et,balanceLabel:"الرصيد النقدي",userId:s==null?void 0:s.uid}),e.jsx(Oc,{open:$m,onOpenChange:Mo,onSuccess:jh,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:Hs&&it[Hs]||0,balanceLabel:`رصيد ${((pc=ze.find(t=>t.id===Hs))==null?void 0:pc.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(Ku,{open:Wm,onOpenChange:ll,onSuccess:Sh,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:Hs&&it[Hs]||0,balanceLabel:`رصيد ${((gc=ze.find(t=>t.id===Hs))==null?void 0:gc.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(zu,{open:Qm,onOpenChange:Gm,userId:s==null?void 0:s.uid}),e.jsx(Vu,{open:Zm,onOpenChange:Xm,userId:s==null?void 0:s.uid}),e.jsx(Ju,{open:eh,onOpenChange:th}),e.jsx(je,{open:Bm,onOpenChange:Kn,children:e.jsxs(Se,{className:"sm:max-w-md",children:[e.jsx(Te,{children:e.jsx(De,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(z,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:cl,onChange:t=>Yn(t.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(x,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:async()=>{if(!await di(wl)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(cl);if(isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Et+t;Gt(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?Ie.updateUserData(s.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),lt(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),lt(!0)}):lt(!0),i({title:"تم بنجاح",description:`تم إضافة ${t} جنيه إلى الدرج النقدية وحفظه في السحابة`}),Kn(!1),Yn(""),Xn("")},children:[e.jsx(Ut,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(x,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:async()=>{if(!await di(wl)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(cl);if(isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Et-t;Gt(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?Ie.updateUserData(s.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),lt(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),lt(!0)}):lt(!0),i({title:"تم بنجاح",description:`تم خصم ${t} جنيه من الدرج النقدية وحفظه في السحابة`}),Kn(!1),Yn(""),Xn("")},children:[e.jsx(hr,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",Et.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx(z,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:wl,onChange:t=>Xn(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(mt,{className:"flex gap-2",children:e.jsx(x,{variant:"outline",onClick:()=>{Kn(!1),Yn(""),Xn("")},children:"إلغاء"})})]})}),e.jsx(je,{open:oh,onOpenChange:li,children:e.jsxs(Se,{className:"sm:max-w-md",children:[e.jsx(Te,{children:e.jsx(De,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(it).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(z,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل الرقم السري الرئيسي",value:lc,onChange:t=>oi(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(mt,{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{li(!1),oi("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",onClick:async()=>{if(!await Cs.verifyMasterPin(lc,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const a={};Object.keys(it).forEach(m=>{a[m]=0}),os(a),localStorage.setItem(Zt(),JSON.stringify(a)),li(!1),oi("");const r=new Date().toISOString(),l={walletBalances:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(o,JSON.stringify(l)),s!=null&&s.uid?Ie.updateUserData(s.uid,l).then(()=>{localStorage.removeItem(o),lt(!1)}).catch(m=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",m),lt(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):lt(!0),setTimeout(()=>{os({...a})},100)}catch(a){console.error("خطأ في تصفير أرصدة المحافظ:",a),i({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(je,{open:Fm,onOpenChange:Jn,children:e.jsxs(Se,{className:"sm:max-w-md",children:[e.jsx(Te,{children:e.jsx(De,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((fc=ze.find(t=>t.id===R))==null?void 0:fc.name)||R]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(R&&it[R]?it[R]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(z,{id:"resetSelectedWalletPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:$o,onChange:t=>ol(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(mt,{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{Jn(!1),ol("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",onClick:async()=>{var a;if(!R){i({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await Cs.verifyMasterPin($o,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const r={...it};r[R]=0,os(r),localStorage.setItem(Zt(),JSON.stringify(r)),Jn(!1),ol("");const l=new Date().toISOString(),o={walletBalances:r,lastUpdated:l},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(o)),s!=null&&s.uid?Ie.updateUserData(s.uid,o).then(()=>{localStorage.removeItem(m),lt(!1)}).catch(h=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",h),lt(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):lt(!0),i({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((a=ze.find(h=>h.id===R))==null?void 0:a.name)||R}`})}catch(r){console.error("خطأ في تصفير رصيد المحفظة المختارة:",r),i({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(je,{open:rh,onOpenChange:ri,children:e.jsxs(Se,{className:"sm:max-w-md",children:[e.jsx(Te,{children:e.jsxs(De,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(Ut,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(it).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx(z,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:Go,onChange:t=>jl(t.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx(z,{id:"addWalletTotalPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري",value:Zo,onChange:t=>Sl(t.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(mt,{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{ri(!1),jl(""),Sl("")},children:"إلغاء"}),e.jsx(x,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:Xo,onClick:async()=>{const t=parseFloat(Go);if(!t||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!await hh(Zo)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}ec(!0);try{const a=Object.values(it).reduce((r,l)=>r+l,0);if(a===0){const r=Object.keys(it),l=t/r.length,o={};r.forEach(m=>{o[m]=l}),os(o),localStorage.setItem(Zt(),JSON.stringify(o)),s!=null&&s.uid?await Ie.updateUserData(s.uid,{walletBalances:o,lastUpdated:new Date().toISOString()}):lt(!0)}else{const r={};Object.entries(it).forEach(([l,o])=>{const m=o/a,h=t*m;r[l]=o+h}),os(r),localStorage.setItem(Zt(),JSON.stringify(r)),s!=null&&s.uid?await Ie.updateUserData(s.uid,{walletBalances:r,lastUpdated:new Date().toISOString()}):lt(!0)}setTimeout(()=>{os(r=>({...r}))},100),ri(!1),jl(""),Sl("")}catch(a){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",a),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{ec(!1)}},children:Xo?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(je,{open:ch,onOpenChange:ci,children:e.jsxs(Se,{className:"sm:max-w-[425px]",children:[e.jsx(Te,{children:e.jsxs(De,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(ds,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"resetCashPin",children:"الرقم السري الرئيسي"}),e.jsx(z,{id:"resetCashPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:Dl,onChange:t=>Cl(t.target.value)})]})]}),e.jsxs(mt,{children:[e.jsx(x,{variant:"outline",onClick:()=>{ci(!1),Cl("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",onClick:async()=>{if(!Dl){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await Cs.verifyMasterPin(Dl,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{Gt(0),ci(!1),Cl("");const a={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem(Ft(),"0"),localStorage.setItem(Ft()+"_lastUpdated",a.lastUpdated);const r=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(r,JSON.stringify(a)),s!=null&&s.uid?Ie.updateUserData(s.uid,a).then(()=>{localStorage.removeItem(r),lt(!1)}).catch(l=>{console.error("خطأ في حفظ الرصيد في Firebase:",l),lt(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):lt(!0)}catch(a){console.error("خطأ في تصفير الرصيد النقدي:",a),i({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(tx,{open:ah,onOpenChange:Qo,userId:s==null?void 0:s.uid,cashBalance:Et,walletBalances:it,transactions:Qe}),e.jsx(je,{open:sh,onOpenChange:rn,children:e.jsxs(Se,{className:"sm:max-w-[425px]",children:[e.jsx(Te,{children:e.jsxs(De,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(Ut,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx(z,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:cr,onChange:t=>ei(t.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-right",children:"هل تريد إضافة ملاحظة؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{type:"button",variant:ln==="yes"?"default":"outline",onClick:()=>on("yes"),className:"flex-1",children:"نعم"}),e.jsx(x,{type:"button",variant:ln==="no"?"default":"outline",onClick:async()=>{if(on("no"),!cr||parseFloat(cr)<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!nn){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await di(nn)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}si(!0);try{const t=parseFloat(cr),a=Et+t;Gt(a);const r=new Date().toISOString();localStorage.setItem(Ft(),a.toString()),localStorage.setItem(Ft()+"_lastUpdated",r);const l={cashBalance:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(o,JSON.stringify(l));const m=`CASHADD-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`;rn(!1),ei(""),ti(""),on(null),ai("");const h=[];if(s!=null&&s.uid){h.push(Ie.updateUserData(s.uid,l).then(()=>{localStorage.removeItem(o),lt(!1)}).catch(()=>{lt(!0)}));const u={txnType:"cash_addition",type:"cash_addition",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:m,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(w==null?void 0:w.shopId)||void 0};h.push(Ie.saveUserTransaction(s.uid,u));const v=w==null?void 0:w.shopId;if(v){const g=Ue(V,"dashboardData",v);h.push(Xt(g,{cashBalance:a}))}}Promise.allSettled(h).then(()=>{}).catch(()=>{})}catch{Gt(Et),localStorage.setItem("cashBalance",Et.toString()),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{si(!1)}},className:"flex-1",children:"لا"})]})]}),ln==="yes"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"addCashNote",children:"الملاحظة"}),e.jsx(z,{id:"addCashNote",type:"text",placeholder:"اكتب الملاحظة",value:Nl,onChange:t=>ai(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx(z,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:nn,onChange:t=>ti(t.target.value)})]})]}),e.jsxs(mt,{children:[e.jsx(x,{variant:"outline",onClick:()=>{rn(!1),ei(""),ti(""),on(null),ai("")},children:"إلغاء"}),e.jsx(x,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:Ho,onClick:async()=>{if(!cr||parseFloat(cr)<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!nn){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await di(nn)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}if(ln==="yes"&&Nl.trim().length===0){i({title:"تنبيه",description:"أدخل الملاحظة أو اختر لا",variant:"destructive"});return}si(!0);try{const t=parseFloat(cr),a=Et+t;Gt(a);const r=new Date().toISOString();localStorage.setItem(Ft(),a.toString()),localStorage.setItem(Ft()+"_lastUpdated",r);const l={cashBalance:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(o,JSON.stringify(l));const m=`CASHADD-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`;rn(!1),ei(""),ti(""),on(null),ai("");const h=[];if(s!=null&&s.uid){h.push(Ie.updateUserData(s.uid,l).then(()=>{localStorage.removeItem(o),lt(!1)}).catch(()=>{lt(!0)}));const u={txnType:"cash_addition",type:"cash_addition",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:m,note:ln==="yes"?Nl.trim():void 0,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(w==null?void 0:w.shopId)||void 0};h.push(Ie.saveUserTransaction(s.uid,u));const v=w==null?void 0:w.shopId;if(v){const g=Ue(V,"dashboardData",v);h.push(Xt(g,{cashBalance:a}))}}Promise.allSettled(h).then(()=>{}).catch(()=>{})}catch{Gt(Et),localStorage.setItem("cashBalance",Et.toString()),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{si(!1)}},children:Ho?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(je,{open:Lm,onOpenChange:il,children:e.jsxs(Se,{className:"sm:max-w-md",children:[e.jsx(Te,{children:e.jsx(De,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx(z,{id:"search-date",type:"date",value:En,onChange:t=>to(t.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx(z,{id:"search-time",type:"time",value:Ln,onChange:t=>so(t.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(mt,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>{to(""),so(""),il(!1)},children:"مسح"}),e.jsx(x,{onClick:()=>il(!1),children:"تطبيق"})]})]})}),e.jsx(Gu,{isOpen:tm,onClose:()=>Li(!1)}),e.jsx(ex,{isOpen:Ti,onClose:()=>Jr(!1),initialBarcode:_d}),e.jsx(ou,{isOpen:rm,onClose:()=>$n(!1)}),e.jsx(cu,{open:nm,onOpenChange:Wn}),e.jsx(gx,{open:im,onOpenChange:t=>{if(t&&!Na){i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}Fn(t)}}),e.jsx(Sx,{open:se,onOpenChange:t=>{if(t&&!Na){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}de(t)}}),e.jsx(Dx,{open:L,onOpenChange:t=>{if(t&&!Na){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}F(t)}}),e.jsx(Ns,{open:qm,onOpenChange:qo,onSuccess:()=>hl(!0),title:"تقاريرك",description:"أدخل الرقم السري الرئيسي للوصول إلى تقاريرك",mode:"verify"}),e.jsx(je,{open:ml,onOpenChange:hl,children:e.jsxs(Se,{className:"sm:max-w-xl",children:[e.jsxs(Te,{children:[e.jsxs(De,{className:"flex items-center gap-2",children:[e.jsx(Ic,{className:"h-4 w-4 text-blue-600"}),"تقارير اليوم"]}),e.jsx(rs,{children:"ملخص معاملات اليوم محفوظ لآخر 30 يومًا مع أرشفة في السحابة"})]}),e.jsxs("div",{className:"space-y-4",children:[(()=>{const t=new Date().toDateString(),a=Qe.filter(u=>{const v=new Date(u.createdAt).toDateString(),g=String(u.status||"completed").toLowerCase();return v===t&&(g==="completed"||g==="confirmed")}),r=a.length,l=a.reduce((u,v)=>u+Number(v.amount||0),0),o=a.filter(u=>u.type==="withdraw").reduce((u,v)=>u+Number(v.amount||0),0),m=a.filter(u=>u.type==="send").reduce((u,v)=>u+Number(v.amount||0),0),h=a.reduce((u,v)=>u+Number(ks.calculateTransactionProfit(v)||0),0);return e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-blue-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-blue-700",children:"عدد المعاملات"}),e.jsx("div",{className:"text-lg font-bold text-blue-800",children:r})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-indigo-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-indigo-700",children:"إجمالي المبالغ"}),e.jsx("div",{className:"text-lg font-bold text-indigo-800",children:Number(l).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-red-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-red-700",children:"المبالغ المسحوبة"}),e.jsx("div",{className:"text-lg font-bold text-red-800",children:Number(o).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-green-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-green-700",children:"المبالغ المرسلة"}),e.jsx("div",{className:"text-lg font-bold text-green-800",children:Number(m).toFixed(2)})]}),e.jsxs("div",{className:"col-span-2 rounded-lg p-3 bg-gradient-to-r from-amber-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-amber-700",children:"الأرباح"}),e.jsx("div",{className:"text-lg font-bold text-amber-800",children:Number(h).toFixed(2)})]})]})})(),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(x,{variant:"default",onClick:async()=>{try{if(!(s!=null&&s.uid))return;const t=new Date,a=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0"),o=`${a}-${r}-${l}`,m=t.toDateString(),h=Qe.filter(A=>{const T=new Date(A.createdAt).toDateString(),J=String(A.status||"completed").toLowerCase();return T===m&&(J==="completed"||J==="confirmed")}),u=h.length,v=h.reduce((A,T)=>A+Number(T.amount||0),0),g=h.filter(A=>A.type==="withdraw").reduce((A,T)=>A+Number(T.amount||0),0),f=h.filter(A=>A.type==="send").reduce((A,T)=>A+Number(T.amount||0),0),S=h.reduce((A,T)=>A+Number(ks.calculateTransactionProfit(T)||0),0);await pn.add({userId:s.uid,reportDate:o,totalTransactions:u,totalAmount:Number(v.toFixed(2)),totalWithdrawn:Number(g.toFixed(2)),totalSent:Number(f.toFixed(2)),profit:Number(S.toFixed(2)),walletId:null});try{await pn.trimToMaxCount(s.uid,30)}catch{}i({title:"تم الأرشفة",description:`تم حفظ تقرير ${o}`})}catch{i({title:"فشل الأرشفة",description:"تعذر حفظ التقرير",variant:"destructive"})}},children:"أرشفة اليوم"}),e.jsx(x,{variant:"outline",onClick:()=>hl(!1),children:"إغلاق"})]}),e.jsx("div",{className:"mt-2 border-t pt-2",children:e.jsx("div",{className:"space-y-2 max-h-[40vh] overflow-auto",children:zo.length===0?e.jsx("div",{className:"text-xs text-muted-foreground",children:"لا توجد تقارير محفوظة"}):zo.map(t=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:t.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",t.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalAmount).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalWithdrawn).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalSent).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:Number(t.profit??0).toFixed(2)})]})]})]},t.id||`${t.userId}-${t.reportDate}`))})})]})]})}),e.jsx(je,{open:Um,onOpenChange:t=>{if(t){i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}dl(!1)},children:e.jsxs(Se,{dir:"rtl",className:"sm:max-w-md w-[95vw] sm:w-auto rounded-2xl border border-emerald-200 shadow-xl bg-gradient-to-br from-white via-green-50 to-emerald-50 backdrop-blur-md data-[state=open]:animate-in data-[state=open]:fade-in-0 data-[state=open]:zoom-in-90 data-[state=open]:slide-in-from-bottom-8 duration-300",children:[e.jsxs(Te,{children:[e.jsx(De,{className:"text-right text-green-700",children:"شحن رصيد الموبايل"}),e.jsx(rs,{className:"text-right text-gray-600",children:"أدخل البيانات ثم اضغط تأكيد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"topupPhone",className:"text-right block",children:"رقم الموبايل"}),e.jsx(z,{id:"topupPhone",value:Hn,onChange:t=>Wo(t.target.value),placeholder:"010xxxxxxx",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx(Z,{className:"text-right block",children:"شركة التشغيل"}),e.jsxs(Ka,{value:Qn,onValueChange:Fo,children:[e.jsx(Ya,{className:"text-right",children:e.jsx(Ha,{placeholder:"اختر الشركة"})}),e.jsxs(Qa,{children:[e.jsx(ua,{value:"vodafone",children:"فودافون"}),e.jsx(ua,{value:"orange",children:"أورنج"}),e.jsx(ua,{value:"etisalat",children:"اتصالات"}),e.jsx(ua,{value:"we",children:"WE"})]})]})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"topupAmount",className:"text-right block",children:"المبلغ بالجنيه"}),e.jsx(z,{id:"topupAmount",type:"number",value:Gn,onChange:t=>Ro(t.target.value?Number(t.target.value):""),placeholder:"50",className:"text-right"})]})]}),e.jsxs(mt,{className:"flex gap-2 justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>dl(!1),className:"border-gray-300",children:"إلغاء"}),e.jsx(x,{onClick:D,disabled:Bo||!Hn||!Qn||!Gn,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:Bo?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})}),e.jsx(Ns,{open:fm,onOpenChange:Wi,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{Wi(!1),wr(!0)}}),e.jsx(Ns,{open:bm,onOpenChange:xo,mode:"verify",title:"تأكيد تغيير طلب الرقم السري للديون",description:"أدخل الرقم السري الرئيسي لتفعيل أو إلغاء طلب الرقم السري عند فتح الديون",onSuccess:async()=>{if(po!==null){const t=po;uo(t);try{const a=s==null?void 0:s.uid,r=a?`debtsPinRequired_${a}`:"debtsPinRequired";localStorage.setItem(r,String(t)),a&&await Ie.updateUserData(a,{debtsPinRequired:t})}catch{}i({title:t?"تم تفعيل طلب الرقم السري للديون":"تم إلغاء طلب الرقم السري للديون",description:t?"سيُطلب الرقم السري الرئيسي عند فتح نافذة الديون.":"يمكن فتح نافذة الديون بدون طلب الرقم السري."})}vm(null),xo(!1)}}),e.jsx(tu,{open:Rm,onOpenChange:sn,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"سيتم حذف كل المعاملات السابقة نهائيًا من حسابك وFirebase.",onSuccess:async()=>{try{if(!(s!=null&&s.uid)){sn(!1);return}const t=new Date,a=l=>l instanceof Date?l:typeof(l==null?void 0:l.toDate)=="function"?l.toDate():new Date(String(l)),r=Qe.filter(l=>a(l.createdAt)<t);await Ie.updateUserData(s.uid,{recentReset:{keepLastCount:sc.keepLastCount??30,intervalDays:sc.intervalDays??7,lastResetAt:t}}),ni(l=>({...l,lastResetAt:t})),i({title:"تم إخفاء المعاملات السابقة",description:"تم إخفاء كل الإيصالات الأقدم من وقت التصفير من العرض بدون التأثير على تقارير اليوم/الشهر أو الحدود."})}catch(t){console.error("فشل تنفيذ التصفير النهائي:",t),i({title:"فشل التصفير",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}finally{sn(!1)}}}),e.jsx(Ns,{open:Aa,onOpenChange:Us,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{Us(!1),ts(!0)}}),e.jsx(je,{open:gm,onOpenChange:wr,children:e.jsxs(Se,{className:"sm:max-w-[425px]",children:[e.jsxs(Te,{className:"flex items-center justify-between",children:[e.jsx(De,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx(Tc,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[fh," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(x,{variant:wa==="debtor"?"default":"outline",onClick:()=>bo("debtor"),children:"مدين"}),e.jsx(x,{variant:wa==="creditor"?"default":"outline",onClick:()=>bo("creditor"),children:"دائن"})]}),(wa==="creditor"||wa==="debtor")&&e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"debtorName",className:"text-right col-span-1",children:wa==="creditor"?"اسم المديون":"اسم الدائن"}),e.jsx(z,{id:"debtorName",value:Fi,onChange:t=>go(t.target.value),className:"col-span-3 text-right",placeholder:wa==="creditor"?"أدخل اسم المديون":"أدخل اسم الدائن"})]}),wa&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(z,{id:"debtAmount",type:"number",value:Ri,onChange:t=>fo(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx(z,{id:"debtReason",value:Bi,onChange:t=>yo(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]})]}),e.jsx(mt,{children:e.jsx(x,{onClick:()=>{if(!(wa==="debtor")&&!(wa==="creditor")){i({title:"اختر نوع الدين",description:"يرجى اختيار مدين أو دائن أولاً",variant:"destructive"});return}if(!Ri||!Bi||!Fi){i({title:"بيانات غير مكتملة",description:"يرجى إدخال الاسم والمبلغ والسبب",variant:"destructive"});return}const r={id:Date.now().toString(),debtorName:Fi,amount:parseFloat(Ri),reason:Bi,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[],type:wa||"creditor"};Xr(r),Nr(!0)},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(x,{variant:"outline",className:"w-full",onClick:()=>ir(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(x,{variant:"outline",className:"w-full",onClick:()=>Hi(!0),children:"إضافة عميل"})})]})}),e.jsx(je,{open:Vi,onOpenChange:ir,children:e.jsxs(Se,{className:"w-[95vw] sm:w-auto sm:max-w-[520px] rounded-2xl",children:[e.jsxs(Te,{children:[e.jsx(De,{className:"text-right",children:"إيصالات الديون"}),e.jsx(rs,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),wt.length>0?e.jsxs("div",{className:"max-h-[70vh] overflow-y-auto overscroll-contain scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 space-y-2 px-1 -mx-1 sm:mx-0 sm:px-0",style:{contain:"layout paint"},onScroll:t=>{const a=t.currentTarget;Ki.length<wt.length&&a.scrollTop+a.clientHeight>=a.scrollHeight-50&&Ji(r=>r+1)},children:[Ki.map(t=>e.jsx("div",{onClick:()=>{Ba(t),Ua(!0),ir(!1),wr(!1)},className:`p-4 sm:p-3 border rounded-xl cursor-pointer hover:bg-gray-50 transition-colors min-h-[64px] ${t.type==="debtor"?"border-r-4 border-r-red-500 bg-red-50/10":"border-r-4 border-r-emerald-500"}`,children:e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:justify-between sm:items-center",children:[e.jsxs("div",{className:"text-right space-y-0.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"font-medium text-[14px] sm:text-sm",children:t.debtorName}),t.type==="debtor"&&e.jsx(Mt,{variant:"destructive",className:"h-5 text-[10px] px-1",children:"علينا"}),(!t.type||t.type==="creditor")&&e.jsx(Mt,{variant:"outline",className:"h-5 text-[10px] px-1 text-emerald-700 border-emerald-200 bg-emerald-50",children:"لنا"})]}),e.jsx("p",{className:"text-[13px] sm:text-sm text-gray-600",children:t.reason}),e.jsx("p",{className:"text-[12px] sm:text-sm text-gray-500",children:ui.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-xl sm:text-lg",children:[t.amount," جنيه"]}),e.jsx(Mt,{variant:t.status==="paid"?"default":"secondary",className:`${t.status==="paid"?"bg-green-500":"bg-yellow-500"} text-[12px] sm:text-xs`,children:t.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},t.id)),Ki.length<wt.length&&e.jsx("div",{className:"flex justify-center pt-1",children:e.jsx(x,{variant:"outline",size:"sm",onClick:()=>Ji(t=>t+1),children:"تحميل المزيد"})})]}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"}),e.jsxs(mt,{className:"flex justify-between mt-3",children:[e.jsx(x,{variant:"destructive",onClick:async()=>{try{if(!wt||wt.length===0){i({title:"لا توجد ديون",description:"القائمة فارغة بالفعل."});return}if(!window.confirm("هل تريد حذف كل إيصالات الديون؟ هذا الإجراء لا يمكن التراجع عنه."))return;const a=[];if(Ss(a),Ba(null),await la(a),s!=null&&s.uid)try{await Ie.updateUserData(s.uid,{debts:[],debtsDeletedAt:yt()});try{localStorage.removeItem(`debts_unsynced_${s.uid}`)}catch{}}catch(r){console.error("تعذر حذف الديون من Firebase:",r),i({title:"فشل الحذف من السحابة",description:"تعذر حذف الإيصالات من Firebase، حاول مرة أخرى.",variant:"destructive"});return}i({title:"تم حذف كل إيصالات الديون",description:"تم تفريغ القائمة بالكامل."}),ir(!1)}catch(t){console.error("تعذر حذف كل إيصالات الديون:",t),i({title:"فشل الحذف",description:"حدث خطأ أثناء الحذف، حاول مرة أخرى.",variant:"destructive"})}},children:"حذف كل الإيصالات"}),e.jsx(x,{variant:"outline",onClick:()=>ir(!1),children:"إغلاق"})]})]})}),e.jsx(je,{open:Dm,onOpenChange:Hi,children:e.jsxs(Se,{className:"sm:max-w-[500px] w-full max-h-[90vh] overflow-hidden flex flex-col p-0 gap-0 bg-gray-50/50",children:[e.jsx("div",{className:"p-4 border-b bg-white",children:e.jsxs(Te,{children:[e.jsxs(De,{className:"text-right flex items-center justify-end gap-2",children:[e.jsx(Er,{className:"w-5 h-5 text-primary"}),"إدارة العملاء والديون"]}),e.jsx(rs,{className:"text-right",children:"سجل بيانات العملاء والديون بسهولة"})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[e.jsxs(vt,{className:"border shadow-sm bg-white",children:[e.jsx(Ht,{className:"pb-2 pt-4 px-4",children:e.jsxs(ms,{className:"text-sm font-medium text-right text-gray-700 flex items-center justify-end gap-2",children:[e.jsx(Ut,{className:"w-4 h-4"}),"إضافة عميل جديد"]})}),e.jsxs(St,{className:"p-4 pt-2 space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{className:"text-right block text-xs text-gray-500",children:"اسم العميل"}),e.jsx(z,{value:Gi,onChange:t=>Do(t.target.value),className:"text-right h-9",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{className:"text-right block text-xs text-gray-500",children:"رقم الموبايل"}),e.jsx(z,{value:Zi,onChange:t=>Co(t.target.value),className:"text-right h-9",placeholder:"اكتب رقم الموبايل"})]}),e.jsxs(x,{className:"w-full bg-emerald-600 hover:bg-emerald-700 text-white h-9 mt-2",onClick:async()=>{if(!Gi||!Zi){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const t={id:Date.now().toString(),name:Gi.trim(),mobile:Zi.trim(),createdAt:new Date},a=[t,...Ys];await fl(a),Do(""),Co(""),i({title:"تمت إضافة العميل",description:`تم إضافة ${t.name}`})},children:[e.jsx(Ut,{className:"w-4 h-4 mr-2"}),"إضافة العميل"]})]})]}),e.jsxs(vt,{className:"border shadow-sm bg-white",children:[e.jsx(Ht,{className:"pb-2 pt-4 px-4",children:e.jsxs(ms,{className:"text-sm font-medium text-right text-gray-700 flex items-center justify-end gap-2",children:[e.jsx(es,{className:"w-4 h-4 text-orange-600"}),"تسجيل مبلغ دين"]})}),e.jsx(St,{className:"p-4 pt-2 space-y-3",children:Ys.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{className:"text-right block text-xs text-gray-500",children:"اختر العميل"}),e.jsxs(Ka,{value:Un,onValueChange:Io,children:[e.jsx(Ya,{className:"w-full h-9 text-right",dir:"rtl",children:e.jsx(Ha,{placeholder:"اختر عميل"})}),e.jsx(Qa,{children:Ys.map(t=>e.jsxs(ua,{value:t.id,className:"text-right justify-end",children:[t.name," — ",t.mobile]},t.id))})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{className:"text-right block text-xs text-gray-500",children:"المبلغ"}),e.jsx(z,{type:"number",value:Ao,onChange:t=>Cm(t.target.value),className:"text-right h-9",placeholder:"0.00"})]}),e.jsx(x,{className:"w-full bg-orange-600 hover:bg-orange-700 text-white h-9 mt-2",onClick:async()=>{const t=parseFloat(Ao);if(!Un){i({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(t)||t<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Ys.find(l=>l.id===Un);if(!a)return;const r={id:Date.now().toString(),debtorName:a.name,customerId:a.id,mobile:a.mobile,amount:Number(t.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};Xr(r),Nr(!0)},children:"متابعة وإضافة المبلغ"})]}):e.jsx("div",{className:"text-center py-4 text-gray-500 text-sm bg-gray-50 rounded border border-dashed",children:"لا يوجد عملاء مسجلين. أضف عميلاً أولاً."})})]}),e.jsxs(vt,{className:"border shadow-sm bg-white",children:[e.jsx(Ht,{className:"pb-2 pt-4 px-4",children:e.jsxs(ms,{className:"text-sm font-medium text-right text-gray-700 flex items-center justify-end gap-2",children:[e.jsx(_c,{className:"w-4 h-4"}),"العملاء المسجلين (",Ys.length,")"]})}),e.jsx(St,{className:"p-4 pt-2",children:Ys.length>0?e.jsx("div",{className:"space-y-2",children:Ys.map(t=>e.jsxs("div",{className:"p-3 border rounded-lg flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition-colors",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8 text-blue-600 hover:text-blue-700 hover:bg-blue-50",onClick:()=>{To(t.id),Xi(t.name||""),el(t.mobile||""),qn(!0)},children:e.jsx(Ul,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8 text-red-600 hover:text-red-700 hover:bg-red-50",onClick:()=>{tl(t.id),sl(t.name||""),zn(!0)},children:e.jsx(ds,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium text-sm text-gray-900",children:t.name}),e.jsx("div",{className:"text-xs text-gray-500 font-mono",children:t.mobile})]})]},t.id))}):e.jsx("div",{className:"text-center py-4 text-gray-400 text-sm",children:"لا توجد بيانات لعرضها"})})]})]}),e.jsx(mt,{className:"p-4 border-t bg-white",children:e.jsx(x,{variant:"outline",className:"w-full sm:w-auto",onClick:()=>Hi(!1),children:"إغلاق"})})]})}),e.jsx(je,{open:Tm,onOpenChange:zn,children:e.jsxs(Se,{hideClose:!0,className:"sm:max-w-[420px] rounded-2xl bg-gradient-to-br from-white via-rose-50 to-red-50 shadow-2xl border border-red-100 text-center",children:[e.jsxs(Te,{children:[e.jsx(De,{className:"text-center text-xl font-bold text-red-700",children:"تأكيد حذف العميل"}),e.jsxs(rs,{className:"text-center text-gray-600",children:["سيتم حذف العميل نهائيًا: ",_o]})]}),e.jsx("div",{className:"py-2 text-sm text-gray-700",children:"لا يمكن التراجع عن هذا الإجراء."}),e.jsxs(mt,{className:"flex justify-center gap-3",children:[e.jsx(x,{variant:"outline",onClick:()=>{zn(!1),tl(""),sl("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",className:"bg-red-600 hover:bg-red-700",onClick:async()=>{const t=km,a=Ys.filter(r=>r.id!==t);await fl(a),Un===t&&Io(""),zn(!1),tl(""),sl(""),i({title:"تم حذف العميل",description:_o})},children:"حذف نهائي"})]})]})}),e.jsx(je,{open:Im,onOpenChange:qn,children:e.jsxs(Se,{className:"sm:max-w-[420px]",children:[e.jsx(Te,{children:e.jsx(De,{className:"text-right",children:"تعديل بيانات العميل"})}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"editCustomerName",className:"text-right col-span-1",children:"الاسم"}),e.jsx(z,{id:"editCustomerName",value:ko,onChange:t=>Xi(t.target.value),className:"col-span-3 text-right"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"editCustomerMobile",className:"text-right col-span-1",children:"الموبايل"}),e.jsx(z,{id:"editCustomerMobile",value:Po,onChange:t=>el(t.target.value),className:"col-span-3 text-right"})]})]}),e.jsxs(mt,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>qn(!1),children:"إلغاء"}),e.jsx(x,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=Am,a=ko.trim(),r=Po.trim();if(!t||!a||!r){i({title:"بيانات غير مكتملة",description:"أدخل الاسم ورقم الموبايل",variant:"destructive"});return}const l=Ys.map(m=>m.id===t?{...m,name:a,mobile:r}:m);await fl(l);const o=wt.map(m=>m.customerId===t?{...m,debtorName:a,mobile:r}:m);o!==wt&&(Ss(o),await la(o)),qn(!1),To(""),Xi(""),el(""),i({title:"تم تحديث العميل",description:a})},children:"حفظ"})]})]})}),e.jsx(je,{open:gs,onOpenChange:ts,children:e.jsxs(Se,{className:"sm:max-w-[520px]",children:[e.jsxs(Te,{children:[e.jsx(De,{className:"text-right",children:"مصروفات المحل"}),e.jsx(rs,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx(z,{id:"expenseName",value:fa,onChange:t=>Is(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx(z,{id:"expenseAmount",type:"number",value:ra,onChange:t=>k(t.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx(z,{id:"expenseNotes",value:ie,onChange:t=>_e(t.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(mt,{className:"flex justify-between",children:[e.jsx(x,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!fa||!ra){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}H(!0)},children:"إضافة مصروف"}),e.jsx(x,{variant:"outline",onClick:()=>zs(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(je,{open:Os,onOpenChange:zs,children:e.jsxs(Se,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(Te,{children:[e.jsx(De,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(rs,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),Xe.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:Xe.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:t.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left flex items-start gap-2",children:[e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[t.amount," جنيه"]}),e.jsx(Mt,{variant:"secondary",className:t.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:t.source==="cash"?"من النقدية":`من المحفظة${t.walletId?` (${t.walletId})`:""}`})]}),e.jsxs(x,{variant:"destructive",size:"sm",className:"shrink-0",onClick:()=>Jm(t.id),title:"حذف نهائي",children:[e.jsx(ds,{className:"w-4 h-4 ml-1"}),"حذف"]})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(je,{open:ct,onOpenChange:H,children:e.jsxs(Se,{className:"sm:max-w-[480px]",children:[e.jsx(Te,{children:e.jsx(De,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(x,{variant:qe==="cash"?"default":"outline",className:qe==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>rt("cash"),children:"الفلوس النقدية"}),e.jsx(x,{variant:qe==="wallet"?"default":"outline",className:qe==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>rt("wallet"),children:"أرصدة المحافظ"}),e.jsx(x,{variant:qe==="fawry"?"default":"outline",className:qe==="fawry"?"bg-amber-600 hover:bg-amber-700 text-white":"",onClick:()=>rt("fawry"),children:"فوري"})]}),qe==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(Ka,{value:At,onValueChange:ss,children:[e.jsx(Ya,{className:"w-full",children:e.jsx(Ha,{placeholder:"اختر محفظة"})}),e.jsx(Qa,{children:ze.map(t=>e.jsx(ua,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(mt,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>{H(!1),rt(null),ss("")},children:"إلغاء"}),e.jsx(x,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=Number(ra);if(isNaN(t)||t<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!qe){i({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(qe==="cash"){const o=Number((Et-t).toFixed(2));Gt(o),localStorage.setItem(Ft(),o.toString());const m={cashBalance:o,lastUpdated:new Date().toISOString()},h=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(h,JSON.stringify(m)),s!=null&&s.uid?(await Ie.updateUserData(s.uid,m),localStorage.removeItem(h),lt(!1)):lt(!0)}else if(qe==="wallet"){if(!At){i({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const o=it[At]||0,m=Number((o-t).toFixed(2)),h={...it,[At]:m};os(h);const u=new Date().toISOString(),v={walletBalances:h,lastUpdated:u},g=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(g,JSON.stringify(v)),localStorage.setItem(Zt(),JSON.stringify(h)),localStorage.setItem(`walletBalances_backup_${u}`,JSON.stringify(h)),s!=null&&s.uid&&Ie.updateUserData(s.uid,v).catch(()=>{})}}catch(o){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",o)}let a=Date.now().toString();try{if(s!=null&&s.uid){const{addDoc:o,collection:m,serverTimestamp:h}=await bt(async()=>{const{addDoc:g,collection:f,serverTimestamp:S}=await import("./index-DvnSb1Lh.js").then(A=>A.c3);return{addDoc:g,collection:f,serverTimestamp:S}},__vite__mapDeps([0,1]),import.meta.url),{db:u}=await bt(async()=>{const{db:g}=await import("./index-DvnSb1Lh.js").then(f=>f.c4);return{db:g}},__vite__mapDeps([0,1]),import.meta.url);a=(await o(m(u,"shop_expenses"),{userId:s.uid,shopId:P||(w==null?void 0:w.shopId)||s.uid||"default-shop",name:fa,amount:t,notes:ie||"",source:qe,walletId:qe==="wallet"?At:null,createdAt:h()})).id}}catch(o){console.error("خطأ أثناء حفظ المصروف في Firestore:",o)}const r={id:a,name:fa,amount:t,notes:ie,source:qe,walletId:qe==="wallet"?At:void 0,createdAt:new Date},l=[...Xe,r];await Jo(l),Is(""),k(""),_e(""),rt(null),ss(""),H(!1),ts(!0),zs(!0),i({title:"تم إضافة المصروف",description:qe==="cash"?"تم الخصم من النقدية":qe==="wallet"?"تم الخصم من أرصدة المحافظ":"تم تسجيل الدفع عبر فوري"})},children:"تأكيد الخصم"})]})]})}),e.jsx(je,{open:Wr,onOpenChange:na,children:e.jsxs(Se,{className:"sm:max-w-[520px]",children:[e.jsxs(Te,{children:[e.jsx(De,{className:"text-right",children:"النواقص"}),e.jsx(rs,{className:"text-right",children:"سجل العناصر الناقصة التي تحتاج شراء وتابع حالتها."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"deficiencyName",className:"text-right col-span-1",children:"اسم العنصر"}),e.jsx(z,{id:"deficiencyName",value:q,onChange:t=>Oe(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: سكر، زيت، مناديل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"deficiencyQuantity",className:"text-right col-span-1",children:"الكمية"}),e.jsx(z,{id:"deficiencyQuantity",type:"number",value:Tt,onChange:t=>ft(t.target.value),className:"col-span-3 text-right",placeholder:"1"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(x,{className:"bg-rose-600 hover:bg-rose-700",onClick:()=>{if(jt){i({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}const t=parseInt(Tt||"1",10);if(!q){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العنصر",variant:"destructive"});return}if(isNaN(t)||t<=0){i({title:"كمية غير صحيحة",description:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}(async()=>{if(s!=null&&s.uid)try{const{collection:r,addDoc:l,serverTimestamp:o}=await bt(async()=>{const{collection:u,addDoc:v,serverTimestamp:g}=await import("./index-DvnSb1Lh.js").then(f=>f.c3);return{collection:u,addDoc:v,serverTimestamp:g}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await bt(async()=>{const{db:u}=await import("./index-DvnSb1Lh.js").then(v=>v.c4);return{db:u}},__vite__mapDeps([0,1]),import.meta.url),h=await l(r(m,"deficiencies"),{userId:s.uid,shopId:P||(w==null?void 0:w.shopId)||s.uid||"default-shop",name:q,quantity:t,status:"pending",createdAt:o()});try{const u=Zn(),v=localStorage.getItem(u),g=v?JSON.parse(v):[],f=Array.isArray(g)?g:[],S=f.some(J=>String((J==null?void 0:J.id)||"")===h.id),A={id:h.id,name:q,quantity:t,status:"pending",createdAt:new Date().toISOString()},T=S?f:[...f,A];localStorage.setItem(u,JSON.stringify(T))}catch{}Oe(""),ft(""),i({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"});return}catch(r){console.warn("فشل حفظ النواقص إلى Firestore، سيُستخدم التخزين المحلي:",r)}const a={id:Date.now().toString(),name:q,quantity:t,status:"pending",createdAt:new Date};Qt(r=>{const l=[...r,a];return gl(l),l}),Oe(""),ft(""),i({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"})})()},children:"إضافة للنواقص"})}),fs.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:fs.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["الكمية: ",t.quantity]}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Mt,{variant:"secondary",className:t.status==="pending"?"bg-rose-100 text-rose-700":"bg-green-100 text-green-700",children:t.status==="pending"?"قيد الشراء":"تم الشراء"}),e.jsx(x,{variant:"outline",className:t.status==="pending"?"text-green-700 border-green-300 hover:bg-green-50":"text-rose-700 border-rose-300 hover:bg-rose-50",onClick:()=>{(async()=>{const a=t.status==="pending"?"purchased":"pending";if(s!=null&&s.uid)try{const{doc:r,updateDoc:l,serverTimestamp:o}=await bt(async()=>{const{doc:h,updateDoc:u,serverTimestamp:v}=await import("./index-DvnSb1Lh.js").then(g=>g.c3);return{doc:h,updateDoc:u,serverTimestamp:v}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await bt(async()=>{const{db:h}=await import("./index-DvnSb1Lh.js").then(u=>u.c4);return{db:h}},__vite__mapDeps([0,1]),import.meta.url);await l(r(m,"deficiencies",t.id),{status:a,updatedAt:o()});return}catch(r){console.warn("فشل تحديث حالة النواقص على Firestore، استخدام التخزين المحلي:",r)}Qt(r=>{const l=r.map(o=>o.id===t.id?{...o,status:a}:o);return gl(l),l})})()},title:t.status==="pending"?"تم الشراء":"إلغاء الشراء",children:t.status==="pending"?"تم الشراء":"إلغاء الشراء"}),e.jsx(x,{variant:"outline",className:"text-red-700 border-red-300 hover:bg-red-50",onClick:()=>{(async()=>{if(s!=null&&s.uid)try{const{doc:a,deleteDoc:r}=await bt(async()=>{const{doc:o,deleteDoc:m}=await import("./index-DvnSb1Lh.js").then(h=>h.c3);return{doc:o,deleteDoc:m}},__vite__mapDeps([0,1]),import.meta.url),{db:l}=await bt(async()=>{const{db:o}=await import("./index-DvnSb1Lh.js").then(m=>m.c4);return{db:o}},__vite__mapDeps([0,1]),import.meta.url);await r(a(l,"deficiencies",t.id));return}catch(a){console.warn("فشل حذف عنصر النواقص من Firestore، استخدام التخزين المحلي:",a)}Qt(a=>{const r=a.filter(l=>l.id!==t.id);return gl(r),r})})()},title:"حذف",children:"حذف"})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد عناصر مسجلة في النواقص"})]}),e.jsx(mt,{className:"flex justify-end",children:e.jsx(x,{variant:"outline",onClick:()=>na(!1),children:"إغلاق"})})]})}),e.jsx(je,{open:Pm,onOpenChange:Nr,children:e.jsxs(Se,{className:"sm:max-w-[480px]",children:[e.jsx(Te,{children:e.jsx(De,{className:"text-right",children:(Jt==null?void 0:Jt.type)==="decrease"?"اختيار مكان إضافة مبلغ السداد":"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:(Jt==null?void 0:Jt.type)==="decrease"?"اختر هل تريد إضافة مبلغ السداد إلى الرصيد النقدي أم إلى إحدى المحافظ أو تسجيله بدون خصم.":"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(x,{variant:Ms==="cash"?"default":"outline",className:Ms==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>en("cash"),children:"الفلوس النقدية"}),e.jsx(x,{variant:Ms==="wallet"?"default":"outline",className:Ms==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>en("wallet"),children:"أرصدة المحافظ"}),e.jsx(x,{variant:Ms==="none"?"default":"outline",className:Ms==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>en("none"),children:(Jt==null?void 0:Jt.type)==="decrease"?"بدون إضافة":"بدون خصم"})]}),Ms==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-right block",children:(Jt==null?void 0:Jt.type)==="decrease"?"اختر المحفظة للإضافة":"اختر المحفظة للخصم"}),e.jsxs(Ka,{value:tn,onValueChange:al,children:[e.jsx(Ya,{className:"w-full",children:e.jsx(Ha,{placeholder:"اختر محفظة"})}),e.jsx(Qa,{children:ze.map(t=>e.jsx(ua,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(mt,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>{Nr(!1),Xr(null),en(null),al("")},children:"إلغاء"}),e.jsx(x,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=!!Jt,a=t&&(Jt==null?void 0:Jt.type)==="decrease",r=Number(t?Jt.delta:(lr==null?void 0:lr.amount)||0);if(!Ms){i({title:a?"اختر مكان الإضافة":"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}const l=new Date().toISOString();let o=Et,m=it,h=!1,u=!1;try{if(Ms==="cash")o=Number(a?(Et+r).toFixed(2):(Et-r).toFixed(2)),h=!0;else if(Ms==="wallet"){if(!tn){i({title:"اختر محفظة",description:a?"يرجى اختيار محفظة للإضافة":"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const T=it[tn]||0,J=Number(a?(T+r).toFixed(2):(T-r).toFixed(2));m={...it,[tn]:J},u=!0}}catch(T){console.error("Error calculating balances:",T);return}let v=[...wt],g=G,f=!1;if(t){if(!G)return;const T=Number(G.amount||0),J=Number(G.paidAmount||0),Ne=Number(Jt.delta||0);if(Jt.type==="decrease"){const E=Number((T-Ne).toFixed(2)),K=J>=E,be={...G,amount:E,status:K?"paid":"pending"};if(v=wt.map(et=>et.id===G.id?be:et),g=be,f=!0,K&&(s!=null&&s.uid)&&(async()=>{try{const[et,ws,ja]=[Ge(ke(V,"userTransactions"),me("userId","==",s.uid),me("linkedDebtId","==",G.id),me("status","==","pending")),Ge(ke(V,"transactions"),me("userId","==",s.uid),me("linkedDebtId","==",G.id),me("status","==","pending")),Ge(ke(V,"transactions"),me("merchantUserId","==",s.uid),me("linkedDebtId","==",G.id),me("status","==","pending"))],[$s,Ma,ha]=await Promise.all([He(et),He(ws),He(ja)]),oa=Qh(V);let xn=0;const Cr=ue=>{ue.docs.forEach(Ee=>{oa.update(Ee.ref,{status:"completed",confirmedAt:new Date}),xn++})};Cr($s),Cr(Ma),Cr(ha),xn>0&&await oa.commit(),s!=null&&s.uid&&[...$s.docs.map(Ee=>{var dt;return String(((dt=Ee.data())==null?void 0:dt.transactionId)||"")}),...Ma.docs.map(Ee=>{var dt;return String(Ee.id||((dt=Ee.data())==null?void 0:dt.transactionId)||"")}),...ha.docs.map(Ee=>{var dt;return String(Ee.id||((dt=Ee.data())==null?void 0:dt.transactionId)||"")})].filter(Boolean).forEach(Ee=>Ie.removeLocalReceiptById(s.uid,Ee))}catch(et){console.error("Batch update failed for linked transactions:",et)}})().catch(et=>{console.error("Transaction update error:",et)}),s!=null&&s.uid&&Ms!=="none")try{const ws={transactionId:Ue(ke(V,"dummy_collection")).id,amount:Ne,transactionType:"cash_addition",type:"cash_addition",status:"completed",createdAt:new Date,senderName:G.debtorName,receiverName:"المحل",description:`سداد دين من العميل ${G.debtorName}`,paymentMethod:Ms,walletId:Ms==="wallet"?tn:null,linkedDebtId:G.id,isDebtRepayment:!0};await Ie.saveUserTransaction(s.uid,ws);try{$.invalidateQueries({queryKey:["recentTransactions",s==null?void 0:s.uid]})}catch{}}catch(et){console.error("Failed to create repayment receipt:",et)}i({title:"تم إنقاص المبلغ",description:`المبلغ الجديد: ${E} جنيه`})}else{const E=T+Ne,K=J>=E,be={...G,amount:Number(E.toFixed(2)),status:K?"paid":"pending"};v=wt.map(et=>et.id===G.id?be:et),g=be,f=!0,i({title:"تم زيادة المبلغ",description:`المبلغ الجديد: ${E} جنيه`})}}else if(lr){v=[{...lr,userId:s==null?void 0:s.uid,shopId:P||(w==null?void 0:w.shopId)||null},...wt],f=!0;try{s!=null&&s.uid&&Ja.send(s.uid,`تم إضافة دين على ${lr.debtorName} بمبلغ ${lr.amount} جنيه`).catch(()=>{})}catch{}}h&&Gt(o),u&&os(m),f&&(Ss(v),t&&Ba(g)),go(""),fo(""),yo(""),wr(!1),Nr(!1),!t&&f&&ir(!0),Xr(null),No(null),en(null),al(""),i({title:t?"تم تعديل الدين":"تم حفظ الدين",description:Ms==="none"?"لم يتم تعديل الأرصدة":Ms==="cash"?a?`تمت إضافة ${r} إلى الرصيد النقدي`:`تم خصم ${r} من الرصيد النقدي`:a?`تمت إضافة ${r} إلى رصيد المحفظة`:`تم خصم ${r} من رصيد المحفظة`});const S={lastUpdated:l};if(h&&(S.cashBalance=o),u&&(S.walletBalances=m),f&&(S.debts=v,S.debtsDeletedAt=null),h&&(localStorage.setItem(Ft(),o.toString()),localStorage.setItem(Ft()+"_lastUpdated",l)),u&&(localStorage.setItem(Zt(),JSON.stringify(m)),localStorage.setItem(Zt()+"_lastUpdated",l)),f){localStorage.setItem(an(),JSON.stringify(v));try{localStorage.setItem(ul(),JSON.stringify(v))}catch{}try{localStorage.setItem(xl(),Date.now().toString())}catch{}}const A=`userData_${s==null?void 0:s.uid}`;if(localStorage.setItem(A,JSON.stringify(S)),s!=null&&s.uid){if(f)try{localStorage.setItem(`debts_unsynced_${s.uid}`,"true")}catch{}const T=[];T.push(Ie.updateUserData(s.uid,S).then(()=>{(h||u)&&(localStorage.removeItem(A),lt(!1))}));const J=P||(w==null?void 0:w.shopId);if(J&&(h||u)){const Ne={lastUpdated:l};h&&(Ne.cashBalance=o),u&&(Ne.walletBalances=m),T.push(sa(Ue(V,"dashboardData",J),Ne,{merge:!0}).catch(E=>console.error("Failed to sync to dashboardData",E)))}Promise.all(T).then(()=>{if(f)try{localStorage.removeItem(`debts_unsynced_${s.uid}`)}catch{}}).catch(Ne=>{console.error("Sync error:",Ne),lt(!0)})}},children:(Jt==null?void 0:Jt.type)==="decrease"?"تأكيد الإضافة":"تأكيد الخصم"})]})]})}),e.jsx(je,{open:wm,onOpenChange:Ua,children:e.jsxs(Se,{className:"w-[95vw] sm:w-auto sm:max-w-[425px] rounded-2xl",children:[e.jsx(Te,{children:e.jsx(De,{className:"text-right",children:"إيصال الدين"})}),G&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:ui.format(G.createdAt instanceof Date?G.createdAt:new Date(G.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:G.debtorName})]}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:justify-between sm:items-center",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"outline",className:"h-10 w-10 sm:h-8 sm:w-8 p-0","aria-label":"إنقاص الدين",onClick:()=>{vo("decrease"),Ui(""),Ua(!1),Zr(!0)},children:"−"}),e.jsxs("span",{className:"font-bold text-xl sm:text-lg",children:[G.amount," جنيه"]}),e.jsx(x,{variant:"outline",className:"h-10 w-10 sm:h-8 sm:w-8 p-0","aria-label":"زيادة الدين",onClick:()=>{vo("increase"),Ui(""),Ua(!1),Zr(!0)},children:"+"})]})]}),(()=>{try{const t=(Qe||[]).filter(a=>String((a==null?void 0:a.linkedDebtId)||"")===String(G.id)).reduce((a,r)=>a+Math.max(0,Number((r==null?void 0:r.commission)||0)),0);return t>0?e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"الربح:"}),e.jsxs("span",{className:"text-green-700 font-semibold",children:[t," جنيه"]})]}):null}catch{return null}})(),e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:G.reason})]}),e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(Mt,{variant:G.status==="paid"?"default":"secondary",className:`${G.status==="paid"?"bg-green-500":"bg-yellow-500"} w-fit text-[12px] sm:text-xs`,children:G.status==="paid"?"مدفوع":"مؤجل"})]}),(()=>{try{const t=(Qe||[]).filter(v=>String((v==null?void 0:v.linkedDebtId)||"")===String(G.id)),a=t.reduce((v,g)=>v+Math.max(0,Number((g==null?void 0:g.commission)||0)),0),r=t.reduce((v,g)=>v+Math.max(0,Number(((g==null?void 0:g.sentAmount)??(g==null?void 0:g.transferredAmount)??(g==null?void 0:g.withdrawnAmount)??(g==null?void 0:g.amount))||0)),0),l=Number(G.amount||0),o=Number(G.paidAmount||0),h=l<r+a?l+a:l,u=Math.max(0,Number(h)-o);return e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-xl sm:text-lg",children:[u," جنيه"]})]})}catch{return e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-xl sm:text-lg",children:[Number(G.amount||0)-Number(G.paidAmount||0)," جنيه"]})]})}})(),G.paidAmount?e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[G.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-4 border rounded-xl bg-gray-50",children:[jm?e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx(z,{id:"partialAmount",type:"number",value:jo,onChange:t=>zi(t.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{qi(!1),zi("")},children:"إلغاء"}),e.jsx(x,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const t=parseFloat(jo);if(!G||isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Math.max(0,Number(G.amount||0)-Number(G.paidAmount||0));if(t>a){i({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const r=Number(((G.paidAmount||0)+t).toFixed(2)),l=r>=Number(G.amount||0),o={...G,amount:Number(G.amount||0),paidAmount:r,status:l?"paid":"pending",partialPayments:[...G.partialPayments||[],{amount:t,paidAt:new Date}]},m=wt.map(h=>h.id===G.id?o:h);Ss(m),Ba(o),await la(m);try{if(s!=null&&s.uid){const h=Math.max(0,Number(o.amount||0)-Number(o.paidAmount||0));await Ja.send(s.uid,`تم سداد جزء من دين ${o.debtorName}: المدفوع ${t} جنيه، المتبقي ${h} جنيه`)}}catch{}try{o.status==="paid"&&(s!=null&&s.uid)&&(async()=>{const h=Ge(ke(V,"userTransactions"),me("userId","==",s.uid),me("linkedDebtId","==",G.id),me("status","==","pending")),u=await He(h);await Promise.allSettled(u.docs.map(A=>Xt(A.ref,{status:"completed",confirmedAt:new Date})));try{const A=u.docs.map(T=>{var J;return String(((J=T.data())==null?void 0:J.transactionId)||"")});s!=null&&s.uid&&A.forEach(T=>T&&Ie.removeLocalReceiptById(s.uid,T))}catch{}const v=Ge(ke(V,"transactions"),me("userId","==",s.uid),me("linkedDebtId","==",G.id),me("status","==","pending")),g=await He(v);await Promise.allSettled(g.docs.map(A=>Xt(A.ref,{status:"completed",confirmedAt:new Date})));try{const A=g.docs.map(T=>{var J;return String(T.id||((J=T.data())==null?void 0:J.transactionId)||"")});s!=null&&s.uid&&A.forEach(T=>T&&Ie.removeLocalReceiptById(s.uid,T))}catch{}const f=Ge(ke(V,"transactions"),me("merchantUserId","==",s.uid),me("linkedDebtId","==",G.id),me("status","==","pending")),S=await He(f);await Promise.allSettled(S.docs.map(A=>Xt(A.ref,{status:"completed",confirmedAt:new Date})));try{const A=S.docs.map(T=>{var J;return String(T.id||((J=T.data())==null?void 0:J.transactionId)||"")});s!=null&&s.uid&&A.forEach(T=>T&&Ie.removeLocalReceiptById(s.uid,T))}catch{}})().catch(h=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",h),i({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(h){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",h)}try{const h=yl(),u=localStorage.getItem(h);if(u){const g=(JSON.parse(u)||[]).map(f=>(f==null?void 0:f.linkedDebtId)===G.id&&(f==null?void 0:f.status)==="pending"?{...f,status:"completed",confirmedAt:new Date}:f);localStorage.setItem(h,JSON.stringify(g)),Xs(f=>f.map(S=>(S==null?void 0:S.linkedDebtId)===G.id&&(S==null?void 0:S.status)==="pending"?{...S,status:"completed",confirmedAt:new Date}:S))}}catch(h){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",h)}Vn(t),qa("none"),jr(!0),qi(!1),zi(""),i({title:"تم تسجيل دفع جزء",description:`تم دفع ${t} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(x,{variant:"outline",className:"w-full",onClick:()=>qi(!0),children:"دفع جزء"}),G.partialPayments&&G.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-[12px] sm:text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-[30vh] sm:max-h-24 overflow-y-auto",children:G.partialPayments.map((t,a)=>e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsxs("span",{children:["دفع: ",t.amount," جنيه"]}),e.jsx("span",{children:new Date(t.paidAt).toLocaleString("ar-EG")})]},a))})]})]})]})]}),e.jsxs(mt,{className:"flex gap-2 justify-center",children:[e.jsx(x,{onClick:async()=>{if(G){const t=wt.map(a=>a.id===G.id?{...a,status:"pending"}:a);Ss(t),await la(t);try{if(s!=null&&s.uid){const a=computedRemaining;await Ja.send(s.uid,`تم سداد الدين بالكامل للعميل ${G.debtorName}: المدفوع ${a} جنيه`)}}catch{}Ua(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(x,{onClick:async()=>{if(G){const t=Number(G.amount||0),a=Number(G.paidAmount||0);let r=Math.max(0,t-a);try{const m=(Qe||[]).filter(f=>String((f==null?void 0:f.linkedDebtId)||"")===String(G.id)),h=m.reduce((f,S)=>f+Math.max(0,Number((S==null?void 0:S.commission)||0)),0),u=m.reduce((f,S)=>f+Math.max(0,Number(((S==null?void 0:S.sentAmount)??(S==null?void 0:S.transferredAmount)??(S==null?void 0:S.withdrawnAmount)??(S==null?void 0:S.amount))||0)),0),g=t<u+h?t+h:t;r=Math.max(0,Number(g)-a)}catch{}const l=r,o=wt.map(m=>{if(m.id!==G.id)return m;const h=Number(m.amount||0),u=Number(m.paidAmount||0),v=Number((u+l).toFixed(2)),g=v>=h;return{...m,amount:h,paidAmount:g?h:v,status:"paid",partialPayments:[...m.partialPayments||[],...l>0?[{amount:l,paidAt:new Date}]:[]]}});Ss(o);try{Ba(o.find(m=>m.id===G.id)||null)}catch{}Vn(l),qa("none"),jr(!0),await la(o);try{s!=null&&s.uid&&(G!=null&&G.id)&&(async()=>{const m=Ge(ke(V,"userTransactions"),me("userId","==",s.uid),me("linkedDebtId","==",G.id),me("status","==","pending")),h=await He(m);await Promise.allSettled(h.docs.map(S=>Xt(S.ref,{status:"completed",confirmedAt:new Date})));try{const S=h.docs.map(A=>{var T;return String(((T=A.data())==null?void 0:T.transactionId)||"")});s!=null&&s.uid&&S.forEach(A=>A&&Ie.removeLocalReceiptById(s.uid,A))}catch{}const u=Ge(ke(V,"transactions"),me("userId","==",s.uid),me("linkedDebtId","==",G.id),me("status","==","pending")),v=await He(u);await Promise.allSettled(v.docs.map(S=>Xt(S.ref,{status:"completed",confirmedAt:new Date})));try{const S=v.docs.map(A=>{var T;return String(A.id||((T=A.data())==null?void 0:T.transactionId)||"")});s!=null&&s.uid&&S.forEach(A=>A&&Ie.removeLocalReceiptById(s.uid,A))}catch{}const g=Ge(ke(V,"transactions"),me("merchantUserId","==",s.uid),me("linkedDebtId","==",G.id),me("status","==","pending")),f=await He(g);await Promise.allSettled(f.docs.map(S=>Xt(S.ref,{status:"completed",confirmedAt:new Date})));try{const S=f.docs.map(A=>{var T;return String(A.id||((T=A.data())==null?void 0:T.transactionId)||"")});s!=null&&s.uid&&S.forEach(A=>A&&Ie.removeLocalReceiptById(s.uid,A))}catch{}})().catch(m=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",m),i({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(m){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",m)}try{const m=yl(),h=localStorage.getItem(m);if(h){const v=(JSON.parse(h)||[]).map(g=>(g==null?void 0:g.linkedDebtId)===G.id&&(g==null?void 0:g.status)==="pending"?{...g,status:"completed",confirmedAt:new Date}:g);localStorage.setItem(m,JSON.stringify(v)),Xs(g=>g.map(f=>(f==null?void 0:f.linkedDebtId)===G.id&&(f==null?void 0:f.status)==="pending"?{...f,status:"completed",confirmedAt:new Date}:f))}}catch(m){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",m)}Ua(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(x,{onClick:async()=>{if(G){const t=wt.filter(a=>a.id!==G.id);Ss(t),await la(t),Ua(!1),i({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(je,{open:Nm,onOpenChange:Zr,children:e.jsxs(Se,{className:"sm:max-w-md rounded-2xl shadow-elegant border border-gray-200",children:[e.jsxs(Te,{children:[e.jsx(De,{className:`text-right ${nr==="decrease"?"text-red-600":"text-green-600"}`,children:nr==="decrease"?"إنقاص مبلغ الدين":nr==="increase"?"زيادة مبلغ الدين":"تعديل مبلغ الدين"}),e.jsxs(rs,{className:"text-right",children:["أدخل المبلغ ثم اضغط تأكيد لإتمام ",nr==="decrease"?"الإنقاص":"الزيادة","."]})]}),e.jsxs("div",{className:"grid gap-4 py-2",children:[e.jsx(Z,{htmlFor:"debtAdjustAmount",className:"text-right",children:"المبلغ (جنيه)"}),e.jsx(z,{id:"debtAdjustAmount",type:"number",placeholder:"0.00",value:wo,onChange:t=>Ui(t.target.value)}),G&&e.jsxs("div",{className:"text-right text-sm text-muted-foreground",children:["المبلغ الحالي: ",e.jsx("span",{className:"font-semibold",children:Number(G.amount||0).toFixed(2)})," جنيه"]})]}),e.jsxs(mt,{className:"flex gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>{Zr(!1),Ua(!0)},children:"إلغاء"}),e.jsx(x,{className:nr==="decrease"?"bg-red-600 hover:bg-red-700":"bg-green-600 hover:bg-green-700",onClick:async()=>{try{if(!G||!nr)return;const t=Number(parseFloat(wo||"0").toFixed(2));if(!t||isNaN(t)||t<=0){i({title:"قيمة غير صالحة",description:"يرجى إدخال مبلغ أكبر من صفر",variant:"destructive"});return}Xr(null),No({debtId:G.id,delta:t,type:nr}),Zr(!1),Nr(!0)}catch(t){console.error("فشل تجهيز تعديل مبلغ الدين:",t),i({title:"خطأ",description:"تعذّر تجهيز تعديل مبلغ الدين",variant:"destructive"})}},children:"تأكيد"})]})]})}),e.jsx(je,{open:_m,onOpenChange:jr,children:e.jsxs(Se,{className:"sm:max-w-[480px]",children:[e.jsxs(Te,{children:[e.jsx(De,{className:"text-right",children:"اختيار مكان إضافة مبلغ السداد"}),e.jsx(rs,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 justify-center",children:[e.jsx(x,{variant:ea==="cash"?"default":"outline",className:ea==="cash"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>qa("cash"),children:"الفلوس النقدية"}),e.jsx(x,{variant:ea==="wallet"?"default":"outline",className:ea==="wallet"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>qa("wallet"),children:"أرصدة المحافظ"}),e.jsx(x,{variant:ea==="fawry"?"default":"outline",className:ea==="fawry"?"bg-amber-600 text-white":"",size:"sm",onClick:()=>qa("fawry"),children:"فوري"}),e.jsx(x,{variant:ea==="none"?"default":"outline",className:ea==="none"?"bg-gray-600 text-white":"",size:"sm",onClick:()=>qa("none"),children:"بدون إضافة"})]}),ea==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة للإضافة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:za,onChange:t=>rl(t.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),ze&&ze.length>0?ze.map(t=>e.jsx("option",{value:t.id,children:t.phone||t.name||t.id},t.id)):Object.keys(it||{}).map(t=>{var a,r,l,o,m,h;return e.jsx("option",{value:t,children:((a=ze.find(u=>u.id===t))==null?void 0:a.phone)||((l=(r=JSON.parse(localStorage.getItem(bl())||"[]"))==null?void 0:r.find(u=>u.id===t))==null?void 0:l.phone)||((m=(o=JSON.parse(localStorage.getItem(bl())||"[]"))==null?void 0:o.find(u=>u.id===t))==null?void 0:m.name)||((h=ze.find(u=>u.id===t))==null?void 0:h.name)||t},t)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[Oo," جنيه"]})]})]}),e.jsxs(mt,{className:"flex flex-wrap justify-between gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{jr(!1),Vn(0),qa(null),rl("")},children:"إلغاء"}),e.jsx(x,{onClick:async()=>{var t,a;try{const r=Oo;if(!r||r<=0){jr(!1);return}const l=async(o,m)=>{if(s!=null&&s.uid&&G)try{const u={transactionId:Ue(ke(V,"dummy_collection")).id,amount:r,transactionType:"cash_addition",type:"cash_addition",status:"completed",createdAt:new Date,senderName:G.debtorName,receiverName:"المحل",description:`سداد دين من العميل ${G.debtorName}`,paymentMethod:o,walletId:m||null,linkedDebtId:G.id,isDebtRepayment:!0};await Ie.saveUserTransaction(s.uid,u);try{$.invalidateQueries({queryKey:["recentTransactions",s==null?void 0:s.uid]})}catch{}}catch(h){console.error("Failed to create repayment receipt:",h)}};if(ea==="cash"){const o=Et+r;Gt(o),localStorage.setItem(Ft(),o.toString());const m={cashBalance:o,lastUpdated:new Date().toISOString()},h=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(h,JSON.stringify(m)),s!=null&&s.uid?(Ie.updateUserData(s.uid,m).catch(()=>lt(!0)),localStorage.removeItem(h),lt(!1)):lt(!0),i({title:"تم إضافة مبلغ السداد",description:`تم إضافة ${r} جنيه إلى الفلوس النقدية`}),await l("cash");try{if(G){const u=wt.map(v=>v.id===G.id?{...v,status:"paid",paidAmount:Math.max(Number(v.paidAmount||0),Number(v.amount||0))}:v);Ss(u);try{Ba(u.find(v=>v.id===G.id)||null)}catch{}try{await la(u)}catch{}}}catch{}}else if(ea==="wallet"){if(!za){i({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const o={...it,[za]:(it[za]||0)+r};os(o);const m=new Date().toISOString(),h={walletBalances:o,lastUpdated:m},u=`userData_${s==null?void 0:s.uid}`;if(localStorage.setItem(u,JSON.stringify(h)),localStorage.setItem(Zt(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${m}`,JSON.stringify(o)),s!=null&&s.uid){Ie.updateUserData(s.uid,h).catch(()=>lt(!0));try{localStorage.removeItem(u)}catch{}lt(!1)}else lt(!0);i({title:"تم إضافة مبلغ السداد",description:`تم إضافة ${r} جنيه إلى المحفظة ${((t=ze.find(v=>v.id===za))==null?void 0:t.phone)||((a=ze.find(v=>v.id===za))==null?void 0:a.name)||za}`}),await l("wallet",za);try{if(G){const v=wt.map(g=>g.id===G.id?{...g,status:"paid",paidAmount:Math.max(Number(g.paidAmount||0),Number(g.amount||0))}:g);Ss(v);try{Ba(v.find(g=>g.id===G.id)||null)}catch{}try{await la(v)}catch{}}}catch{}}else if(ea==="none"){i({title:"تم تسجيل السداد",description:`تم تسجيل ${r} جنيه بدون تعديل الأرصدة`});try{if(G){const o=wt.map(m=>m.id===G.id?{...m,status:"paid",paidAmount:Math.max(Number(m.paidAmount||0),Number(m.amount||0))}:m);Ss(o);try{Ba(o.find(m=>m.id===G.id)||null)}catch{}try{await la(o)}catch{}}}catch{}}else if(ea==="fawry")i({title:"تم تسجيل سداد عبر فوري",description:`تم تسجيل ${r} جنيه كسداد عبر فوري بدون تعديل الأرصدة`}),await l("fawry");else{i({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}try{const o=r>0?r:Number((G==null?void 0:G.amount)||0);s!=null&&s.uid&&G&&await Ja.send(s.uid,`تم سداد الدين بالكامل للعميل ${G.debtorName}: المدفوع ${o} جنيه`)}catch{}}catch(r){console.error("خطأ أثناء إضافة مبلغ السداد:",r),i({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{jr(!1),Vn(0),qa(null),rl("");try{ir(!0)}catch{}}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(je,{open:Gd,onOpenChange:ar,children:e.jsxs(Se,{hideClose:!0,className:"post-confirm-card sm:max-w-[420px] w-[90vw] rounded-2xl bg-gradient-to-br from-white via-indigo-50 to-blue-50 shadow-2xl border border-indigo-100",children:[e.jsxs(Te,{children:[e.jsx(De,{className:"text-right text-2xl font-bold",children:(vs==null?void 0:vs.type)==="transfer"?"مبلغ يجب استلامه":"مبلغ يجب تسليمه"}),e.jsx(rs,{className:"text-right text-gray-600",children:(vs==null?void 0:vs.type)==="transfer"?"هذا هو المبلغ الواجب استلامه من العميل بعد التأكيد.":"هذا هو المبلغ الواجب تسليمه للعميل بعد التأكيد."})]}),e.jsxs("div",{className:"py-3 flex flex-col items-center gap-1.5",children:[e.jsxs("div",{className:"text-xl sm:text-2xl font-bold text-blue-700 tracking-wide",children:[Gs((vs==null?void 0:vs.amount)||0)," جنيه"]}),e.jsx("div",{className:"text-sm text-gray-500 text-right w-full",children:(vs==null?void 0:vs.type)==="transfer"?"المبلغ المعروض شامل عمولة التحويل.":kt?"العمولة مضافة ولا تؤثر على قيمة التسليم.":"العمولة مخصومة من المبلغ المسلّم للعميل."})]}),e.jsxs(mt,{className:"flex justify-end gap-2",children:[(vs==null?void 0:vs.type)==="transfer"&&e.jsx(x,{variant:"outline",id:"sendCodeBtn",onClick:ns,disabled:ro,className:"btn-transfer-confirm",children:ro?"جارٍ الإرسال...":"إرسال كود التحويل"}),e.jsx(x,{onClick:()=>{ar(!1),Ei(null)},className:"bg-green-600 hover:bg-green-700 text-white",children:(vs==null?void 0:vs.type)==="transfer"?"تم الاستلام":"تم التسليم"})]})]})}),e.jsx(wu,{open:Xd,onClose:()=>vr(!1),onSubmit:Lt,deviceId:no||xe||"",recipientMsisdn:String(ge==="transfer"?(Ks==null?void 0:Ks.receiver)||js||"":((yc=ze.find(t=>t.id===R))==null?void 0:yc.phone)||"").replace(/\D/g,"")}),e.jsx(jx,{isOpen:Md,onClose:()=>ki(!1),wallets:ze,walletBalances:it,onSelectWallet:t=>{Ct(t);const a=ze.find(r=>r.id===t);if(a){ka(a.phone);try{localStorage.setItem(or(),t)}catch{}}ki(!1)},selectedWalletId:R||void 0}),e.jsx(Cx,{open:ae,onOpenChange:Le}),io]}))};export{Pp as default};
//# sourceMappingURL=UserDashboardPage-CqrufyR-.js.map
