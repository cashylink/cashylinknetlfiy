import{u as Se,a4 as Ie,r as x,j as e,a5 as _e,a6 as Te,a7 as Fe,a8 as $e,ar as Me,B as h,aj as Be,E as Ee,F as ze,C as K,b as O,c as H,e as U,I as y,_ as Re,q as k,n as g,o as m,as as D,p as qe,t as C,z as N,y as T,a3 as pe,at as xe,ah as he,K as j,s as V,au as F}from"./index-CWTdLx7E.js";import{B as A}from"./badge-Dkne3qZK.js";import{S as We}from"./separator-B89kj3pz.js";import{ProfitService as ue}from"./profitService-oNUfz-Yd.js";import{a as Ke}from"./MasterPinDialog-BwapmE19.js";import{R as Oe}from"./refresh-cw-C3jRi4Z9.js";import{T as ge}from"./trash-2-BKuXmImO.js";import{C as He}from"./circle-check-big-C85Ma9-W.js";import"./circle-alert-NzwhoXxt.js";const aa=({open:$,onOpenChange:G})=>{const{user:r}=Se(),{shopId:M}=Ie()||{},[v,B]=x.useState([]),[E,X]=x.useState(""),[Y,J]=x.useState(""),[L,Q]=x.useState(""),[Z,ee]=x.useState(""),[S,ae]=x.useState(""),[w,te]=x.useState(""),[z,se]=x.useState(""),[b,re]=x.useState(!1),[fe,I]=x.useState(!1),[ie,R]=x.useState(!1),[ne,ce]=x.useState(!1),oe=a=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(a||0))} ج.م`,ye=()=>{const a=new Date,t=new Date(a);return t.setHours(2,0,0,0),a.getTime()<t.getTime()&&t.setDate(t.getDate()-1),t},Ne=()=>{const a=new Date;return new Date(a.getFullYear(),a.getMonth(),1,0,0,0,0)},be=ye(),je=Ne(),ve=v.filter(a=>a.status==="completed"&&a.completedAt&&a.completedAt.getTime()>=be.getTime()).reduce((a,t)=>a+(typeof t.profit=="number"?t.profit:0),0),we=v.filter(a=>a.status==="completed"&&a.completedAt&&a.completedAt.getTime()>=je.getTime()).reduce((a,t)=>a+(typeof t.profit=="number"?t.profit:0),0),le=async()=>{if(!(r!=null&&r.uid))return;ce(!0);const a=t=>{const n=t.docs.map(c=>{var s,l,d,p;const i=c.data();return{id:c.id,productName:i.productName,faultType:i.faultType,customerName:i.customerName,mobile:i.mobile,repairPrice:Number(i.repairPrice??i.customerPrice??0),wholesalePrice:i.wholesalePrice!==void 0?Number(i.wholesalePrice):void 0,profit:i.profit!==void 0?Number(i.profit):void 0,partialPayment:i.partialPayment!==void 0?Number(i.partialPayment):void 0,remainingDue:i.remainingDue!==void 0?Number(i.remainingDue):i.partialPayment!==void 0?Math.max(0,Math.round((Number(i.repairPrice??i.customerPrice??0)-Number(i.partialPayment))*100)/100):void 0,profitAdded:!!i.profitAdded,status:i.status||"in_progress",createdAt:((l=(s=i.createdAt)==null?void 0:s.toDate)==null?void 0:l.call(s))||new Date,completedAt:(p=(d=i.completedAt)==null?void 0:d.toDate)==null?void 0:p.call(d),userId:i.userId||r.uid}});B(n)};try{const t=k(g(m,"maintenance_items"),D("userId","==",r.uid),qe("createdAt","desc")),n=await C(t);a(n)}catch(t){console.warn("Failed to fetch with ordering, falling back without orderBy:",t);try{const n=k(g(m,"maintenance_items"),D("userId","==",r.uid)),i=(await C(n)).docs.sort((s,l)=>{var f,o,u,P;const d=((o=(f=s.data().createdAt)==null?void 0:f.toDate)==null?void 0:o.call(f))||new Date(0);return(((P=(u=l.data().createdAt)==null?void 0:u.toDate)==null?void 0:P.call(u))||new Date(0)).getTime()-d.getTime()});a({docs:i})}catch(n){console.warn("Failed to fetch maintenance items (fallback):",n)}}finally{ce(!1)}};x.useEffect(()=>{$&&le()},[r==null?void 0:r.uid,$]);const Pe=()=>{X(""),J(""),Q(""),ee(""),ae(""),te(""),se("")},de=async a=>{if(!(r!=null&&r.uid)){alert("يرجى تسجيل الدخول قبل إضافة عنصر الصيانة");return}const t=Number(S),n=w?Number(w):void 0,c=z?Number(z):void 0;if(!E.trim()||!t||Number.isNaN(t)||t<=0){alert("يرجى إدخال اسم المنتج وسعر التصليح بشكل صحيح");return}try{const i=n!==void 0?Math.round((t-n)*100)/100:void 0,s={productName:E.trim(),repairPrice:t,status:a,createdAt:N(),userId:r.uid,profitAdded:a==="completed"?i!==void 0:!1},l=Y.trim(),d=L.trim(),p=Z.trim();l&&(s.faultType=l),d&&(s.customerName=d),p&&(s.mobile=p),n!==void 0&&(s.wholesalePrice=n),i!==void 0&&(s.profit=i),a==="completed"&&(s.completedAt=N()),c!==void 0&&(s.partialPayment=c),c!==void 0&&(s.remainingDue=Math.max(0,Math.round((t-c)*100)/100));const f=await T(g(m,"maintenance_items"),s);try{const o={linkedId:f.id,productName:s.productName,faultType:s.faultType,customerName:s.customerName,mobile:s.mobile,repairPrice:s.repairPrice,wholesalePrice:s.wholesalePrice,profit:s.profit,partialPayment:s.partialPayment,remainingDue:s.remainingDue,userId:r.uid};a==="in_progress"?await T(g(m,"maintenance_pending"),{...o,status:"in_progress",createdAt:N()}):await T(g(m,"maintenance_done"),{...o,status:"completed",profitAdded:o.profit!==void 0,createdAt:N(),completedAt:N()})}catch(o){console.warn("تعذر مزامنة عنصر الصيانة مع مجموعات الموبايل/الكمبيوتر:",o)}if(B(o=>[{id:f.id,productName:s.productName,faultType:s.faultType,customerName:s.customerName,mobile:s.mobile,repairPrice:s.repairPrice,wholesalePrice:s.wholesalePrice,profit:s.profit,partialPayment:s.partialPayment,remainingDue:s.remainingDue,profitAdded:!!s.profitAdded,status:s.status,createdAt:new Date,completedAt:s.status==="completed"?new Date:void 0,userId:r.uid},...o]),a==="completed"&&i!==void 0)try{ue.addProfit(i,r.uid)}catch{}if(a==="completed")try{const o=Math.max(0,Number(t||0)),u=`cashBalance_${(r==null?void 0:r.uid)||"default"}`,P=`cashBalance_${(r==null?void 0:r.uid)||"default"}_${M||"main"}`,Ae=localStorage.getItem(P)??localStorage.getItem(u)??"0",_=(parseFloat(Ae||"0")||0)+o;try{localStorage.setItem(u,String(_))}catch{}try{localStorage.setItem(P,String(_))}catch{}try{await pe.updateUserData(r.uid,{cashBalance:_})}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:_}}))}catch{}}catch{}Pe();try{if(r!=null&&r.uid){const o=s.partialPayment!==void 0?`، المدفوع مقدمًا ${s.partialPayment} جنيه`:"",u=s.mobile?`، رقم تليفون ${s.mobile}`:"";await xe.send(r.uid,`تم استلام جهاز صيانة باسم ${s.customerName||"بدون اسم"}، الجهاز ${s.productName}${u}، سعر التصليح ${s.repairPrice} جنيه${o}`)}}catch{}}catch(i){console.error("Failed to add maintenance item:",i);const s=i||{},d=[s.code,s.message].filter(Boolean).join(" — ")||"غير معروف";alert(`حدث خطأ أثناء إضافة عنصر الصيانة: ${d}`)}},ke=async a=>{try{const t=v.find(s=>s.id===a),n=(t==null?void 0:t.wholesalePrice)!==void 0?Math.round(((t.repairPrice||0)-(t.wholesalePrice||0))*100)/100:void 0,c={status:"completed",completedAt:N(),profitAdded:n!==void 0?!0:(t==null?void 0:t.profitAdded)||!1};n!==void 0&&(c.profit=n);const i=Math.round(((t==null?void 0:t.repairPrice)||0)*100)/100;if(c.partialPayment=i,c.remainingDue=0,await he(j(m,"maintenance_items",a),c),n!==void 0&&!(t!=null&&t.profitAdded)&&(r!=null&&r.uid))try{ue.addProfit(n,r.uid)}catch{}try{const s=Math.max(0,Number((t==null?void 0:t.repairPrice)||0)),l=`cashBalance_${(r==null?void 0:r.uid)||"default"}`,d=`cashBalance_${(r==null?void 0:r.uid)||"default"}_${M||"main"}`,p=localStorage.getItem(d)??localStorage.getItem(l)??"0",o=(parseFloat(p||"0")||0)+s;try{localStorage.setItem(l,String(o))}catch{}try{localStorage.setItem(d,String(o))}catch{}if(r!=null&&r.uid)try{await pe.updateUserData(r.uid,{cashBalance:o})}catch{}try{const u=(profile==null?void 0:profile.shopId)||M;u&&await he(j(m,"dashboardData",u),{cashBalance:o,lastUpdated:new Date().toISOString()})}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:o}}))}catch{}}catch{}try{const s={linkedId:a,productName:t==null?void 0:t.productName,faultType:t==null?void 0:t.faultType,customerName:t==null?void 0:t.customerName,mobile:t==null?void 0:t.mobile,repairPrice:t==null?void 0:t.repairPrice,wholesalePrice:t==null?void 0:t.wholesalePrice,profit:n,partialPayment:i,remainingDue:0,userId:(r==null?void 0:r.uid)||(t==null?void 0:t.userId),status:"completed",createdAt:t!=null&&t.createdAt?t.createdAt:N(),completedAt:N(),profitAdded:n!==void 0};await T(g(m,"maintenance_done"),s);try{const l=k(g(m,"maintenance_pending"),D("linkedId","==",a),V(1)),p=(await C(l)).docs[0];p!=null&&p.id&&await F(j(m,"maintenance_pending",p.id))}catch(l){console.warn("تعذر حذف العنصر من مجموعة جاري التصليح:",l)}}catch(s){console.warn("تعذر مزامنة حالة الصيانة المكتملة مع مجموعات الموبايل/الكمبيوتر:",s)}try{if(r!=null&&r.uid){const s=t!=null&&t.mobile?`، رقم تليفون ${t.mobile}`:"";await xe.send(r.uid,`تم تصليح الجهاز ${(t==null?void 0:t.productName)||""} للعميل ${(t==null?void 0:t.customerName)||"بدون اسم"}${s}، مبلغ التصليح الكامل ${(t==null?void 0:t.repairPrice)||0} جنيه`)}}catch{}}catch{alert("حدث خطأ أثناء تحديث حالة الصيانة إلى تم التصليح")}},me=async a=>{var t,n;try{await F(j(m,"maintenance_items",a));try{const c=k(g(m,"maintenance_pending"),D("linkedId","==",a),V(1)),i=await C(c);(t=i.docs[0])!=null&&t.id&&await F(j(m,"maintenance_pending",i.docs[0].id))}catch{}try{const c=k(g(m,"maintenance_done"),D("linkedId","==",a),V(1)),i=await C(c);(n=i.docs[0])!=null&&n.id&&await F(j(m,"maintenance_done",i.docs[0].id))}catch{}B(c=>c.filter(i=>i.id!==a))}catch{alert("حدث خطأ أثناء حذف عنصر الصيانة")}},q=v.filter(a=>a.status==="in_progress"),W=v.filter(a=>a.status==="completed"),De=(()=>{const a=w?Number(w):void 0,t=S?Number(S):void 0;if(a===void 0||t===void 0)return"";const n=Math.round((t-a)*100)/100;return isNaN(n)?"":String(n)})(),Ce=a=>{if(typeof a.profit=="number")return a.profit;const t=a.repairPrice??0,n=a.wholesalePrice??0;return Math.round((t-n)*100)/100};return e.jsxs(e.Fragment,{children:[e.jsx(_e,{open:$,onOpenChange:G,children:e.jsxs(Te,{className:"maintenance-dialog sm:max-w-3xl w-screen sm:w-auto h-[90vh] sm:h-auto overflow-hidden rounded-none sm:rounded-lg p-0 dark:bg-[#121212]",children:[e.jsx(Fe,{className:"sticky top-0 bg-white dark:bg-[#0F0F0F] z-20 border-b border-gray-200 dark:border-[#333] px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs($e,{className:"flex items-center gap-2",children:[e.jsx(Me,{className:"h-4 w-4 text-amber-600"}),"إدارة الصيانة",e.jsx(h,{size:"sm",variant:"ghost",className:"mr-2 p-1 h-auto rounded-full",onClick:le,disabled:ne,title:"تحديث البيانات",children:e.jsx(Oe,{className:`h-4 w-4 ${ne?"animate-spin":""}`})})]}),e.jsx(h,{size:"sm",variant:"ghost",className:"ml-auto",onClick:()=>G(!1),title:"إغلاق",children:e.jsx(Be,{className:"h-4 w-4"})})]})}),e.jsxs("div",{className:"px-4 py-3 space-y-3 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:b?"":"filter blur-sm pointer-events-none select-none",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-gray-700 dark:text-gray-300 font-medium",children:"أرباح الصيانة"}),e.jsx(A,{variant:"secondary",className:"text-[10px]",children:"اليوم"}),e.jsx("span",{className:"text-sm text-green-700 dark:text-green-400 font-semibold",children:oe(ve)}),e.jsx(A,{variant:"secondary",className:"text-[10px] ml-2",children:"الشهر"}),e.jsx("span",{className:"text-sm text-green-700 dark:text-green-400 font-semibold",children:oe(we)})]})}),!b&&e.jsx("button",{type:"button",onClick:()=>I(!0),className:"absolute inset-0 rounded bg-white/30 dark:bg-black/30 backdrop-blur-sm cursor-pointer","aria-label":"أدخل الرقم السري لعرض أرباح الصيانة"})]}),e.jsxs("div",{className:"flex items-center gap-2 z-10",children:[b?e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>re(!1),title:"إخفاء الأرباح",children:e.jsx(Ee,{className:"h-4 w-4"})}):e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>I(!0),title:"عرض أرباح الصيانة",children:e.jsx(ze,{className:"h-4 w-4"})}),e.jsx(h,{size:"sm",variant:"outline",onClick:()=>I(!0),className:"text-xs",children:"عرض أرباح الصيانة"})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:!ie&&e.jsx(h,{className:"bg-amber-600 hover:bg-amber-700",onClick:()=>R(!0),children:"إضافة جهاز صيانة"})})]}),ie&&e.jsxs(K,{className:"mb-3",children:[e.jsx(O,{className:"pb-2",children:e.jsx(H,{className:"text-sm",children:"إضافة منتج للصيانة"})}),e.jsxs(U,{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-700 dark:text-gray-300",children:"اسم المنتج"}),e.jsx(y,{value:E,onChange:a=>X(a.target.value),placeholder:"اسم المنتج"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-700 dark:text-gray-300",children:"نوع العطل - اختياري"}),e.jsx(y,{value:Y,onChange:a=>J(a.target.value),placeholder:"نوع العطل"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-700 dark:text-gray-300",children:"اسم العميل - اختياري"}),e.jsx(y,{value:L,onChange:a=>Q(a.target.value),placeholder:"اسم العميل"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-700 dark:text-gray-300",children:"رقم الموبايل - اختياري"}),e.jsx(y,{value:Z,onChange:a=>ee(a.target.value),placeholder:"01xxxxxxxxx"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-700 dark:text-gray-300",children:"سعر التصليح"}),e.jsx(y,{value:S,onChange:a=>ae(a.target.value),placeholder:"سعر التصليح بالجنيه"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-700 dark:text-gray-300",children:"سعر الجملة"}),e.jsx(y,{value:w,onChange:a=>te(a.target.value),placeholder:"سعر الجملة بالجنيه"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-700 dark:text-gray-300",children:"دفع جزء من التصليح"}),e.jsx(y,{value:z,onChange:a=>se(a.target.value),placeholder:"المبلغ المدفوع مقدمًا"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-700 dark:text-gray-300",children:"الأرباح: سعر التصليح - سعر الجملة"}),e.jsx(y,{value:De,readOnly:!0,placeholder:b?"":"أدخل الرقم السري لعرض الأرباح"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[e.jsx(h,{className:"bg-amber-600 hover:bg-amber-700",onClick:()=>de("in_progress"),children:"جاري التصليح"}),e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:()=>de("completed"),children:"تم التصليح"}),e.jsx(h,{variant:"outline",onClick:()=>R(!1),children:"إخفاء النموذج"})]})]})]}),e.jsx(We,{}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3",children:[e.jsxs(K,{children:[e.jsx(O,{className:"pb-2",children:e.jsxs(H,{className:"text-sm flex items-center gap-2",children:[e.jsx(Re,{className:"h-4 w-4 text-amber-600"}),"جاري التصليح",e.jsx(A,{variant:"secondary",className:"ml-auto text-[10px]",children:q.length})]})}),e.jsx(U,{className:"space-y-2 sm:max-h-[280px] sm:overflow-y-auto",children:q.length===0?e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"لا توجد عناصر قيد التصليح"}):q.map(a=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-white dark:bg-[#1A1A1A] rounded border border-gray-200 dark:border-[#333]",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-semibold",children:[a.productName," ",e.jsxs("span",{className:"text-gray-600 dark:text-gray-300",children:["— ",a.repairPrice," جنيه"]})]}),e.jsxs("p",{className:"text-[11px] text-gray-600 dark:text-gray-300",children:[a.faultType||"بدون",a.customerName&&e.jsxs("span",{children:[" • ",a.customerName]}),a.mobile&&e.jsxs("span",{children:[" • ",a.mobile]})]}),typeof a.remainingDue=="number"&&e.jsxs("p",{className:"text-[11px] text-orange-700 dark:text-orange-400",children:["المتبقي على العميل: ",a.remainingDue," جنيه"]}),b&&e.jsxs("p",{className:"text-[11px] text-green-700 dark:text-green-400",children:["الأرباح المتوقعة: ",a.wholesalePrice!==void 0&&a.repairPrice!==void 0?Math.round(((a.repairPrice||0)-(a.wholesalePrice||0))*100)/100:0," جنيه"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{size:"sm",className:"h-7 bg-green-600 hover:bg-green-700",onClick:()=>ke(a.id),children:"تم التصليح"}),e.jsx(h,{size:"sm",variant:"outline",className:"h-7",onClick:()=>me(a.id),children:e.jsx(ge,{className:"h-3 w-3"})})]})]},a.id))})]}),e.jsxs(K,{children:[e.jsx(O,{className:"pb-2",children:e.jsxs(H,{className:"text-sm flex items-center gap-2",children:[e.jsx(He,{className:"h-4 w-4 text-green-600"}),"تم التصليح",e.jsx(A,{variant:"secondary",className:"ml-auto text-[10px]",children:W.length})]})}),e.jsx(U,{className:"space-y-2 sm:max-h-[280px] sm:overflow-y-auto",children:W.length===0?e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"لا توجد عناصر منتهية"}):W.map(a=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-white dark:bg-[#1A1A1A] rounded border border-gray-200 dark:border-[#333]",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-semibold",children:[a.productName," ",e.jsxs("span",{className:"text-gray-600 dark:text-gray-300",children:["— ",a.repairPrice," جنيه"]})]}),e.jsxs("p",{className:"text-[11px] text-gray-600 dark:text-gray-300",children:[a.faultType||"بدون",a.customerName&&e.jsxs("span",{children:[" • ",a.customerName]}),a.mobile&&e.jsxs("span",{children:[" • ",a.mobile]})]}),typeof a.partialPayment=="number"&&e.jsxs("p",{className:"text-[11px] text-emerald-700 dark:text-emerald-400",children:["المدفوع: ",a.partialPayment," جنيه"]}),typeof a.remainingDue=="number"&&e.jsxs("p",{className:"text-[11px] text-orange-700 dark:text-orange-400",children:["المتبقي على العميل: ",a.remainingDue," جنيه"]}),b&&e.jsxs("p",{className:"text-[11px] text-green-700 dark:text-green-400",children:["الأرباح: ",Ce(a)," جنيه"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(A,{className:"text-[10px] bg-green-100 text-green-800",children:"مكتمل"}),e.jsx(h,{size:"sm",variant:"outline",className:"h-7",onClick:()=>me(a.id),title:"حذف",children:e.jsx(ge,{className:"h-3 w-3"})})]})]},a.id))})]})]}),e.jsx("div",{className:"sm:hidden sticky bottom-0 left-0 right-0 bg-white dark:bg-[#0F0F0F] border-t border-gray-200 dark:border-[#333] p-3 z-20",children:e.jsx(h,{className:"w-full bg-amber-600 hover:bg-amber-700",onClick:()=>R(!0),children:"إضافة جهاز صيانة"})})]})]})}),e.jsx(Ke,{open:fe,onOpenChange:I,mode:"verify",title:"تأكيد الرقم السري الرئيسي",description:"أدخل الرقم السري لعرض خانة الأرباح",onSuccess:()=>re(!0)})]})};export{aa as default};
//# sourceMappingURL=MaintenanceDialog-Dy_IYtNd.js.map
