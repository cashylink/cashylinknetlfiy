{"version":3,"file":"DailyArchiveHistoryDialog-CixX5AvI.js","sources":["../../src/components/DailyArchiveHistoryDialog.tsx"],"sourcesContent":["import React from 'react';\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from '@/components/ui/dialog';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Input } from '@/components/ui/input';\r\nimport { useToast } from '@/hooks/use-toast';\r\nimport { dailyReportsArchiveService } from '@/integrations/firebase/services';\r\nimport { DailyReportArchive } from '@/integrations/firebase/types';\r\n\r\ninterface DailyArchiveHistoryDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  userId?: string;\r\n}\r\n\r\nconst formatNumber = (n: number) => Math.round(Number(n || 0)).toLocaleString('en-US');\r\n\r\nexport const DailyArchiveHistoryDialog: React.FC<DailyArchiveHistoryDialogProps> = ({ open, onOpenChange, userId }) => {\r\n  const { toast } = useToast();\r\n  const [archives, setArchives] = React.useState<DailyReportArchive[]>([]);\r\n  const [isLoading, setIsLoading] = React.useState(false);\r\n  const [query, setQuery] = React.useState('');\r\n  const [isDeletingAll, setIsDeletingAll] = React.useState(false);\r\n  const getCacheKey = React.useCallback(() => `daily_archive_history_${userId || 'default'}`, [userId]);\r\n\r\n  React.useEffect(() => {\r\n    const fetchArchives = async () => {\r\n      if (!open || !userId) return;\r\n      try {\r\n        setIsLoading(true);\r\n        const data = await dailyReportsArchiveService.getByUser(userId, 1000);\n        // sort desc by date\r\n        const sorted = [...data].sort((a, b) => (a.reportDate < b.reportDate ? 1 : -1));\r\n        setArchives(sorted);\r\n        try { localStorage.setItem(getCacheKey(), JSON.stringify(sorted)); } catch {}\r\n      } catch (error) {\r\n        console.error('Failed to load daily archive history:', error);\r\n        toast({ title: 'فشل تحميل الأرشيف', description: 'تعذر تحميل أرشيف التقارير اليومية', variant: 'destructive' });\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    };\r\n    fetchArchives();\r\n  }, [open, userId]);\r\n\r\n  const filtered = React.useMemo(() => {\r\n    if (!query) return archives;\r\n    const q = query.trim();\r\n    return archives.filter(a => a.reportDate.includes(q));\r\n  }, [archives, query]);\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"sm:max-w-xl\">\r\n        <DialogHeader>\r\n          <DialogTitle>آخر التقارير</DialogTitle>\r\n          <DialogDescription>\r\n            يعرض تقارير جميع الأيام المؤرشفة مع التاريخ وملخص كل يوم.\n          </DialogDescription>\r\n        </DialogHeader>\r\n\r\n        <div className=\"space-y-2\">\r\n          <Label htmlFor=\"archive-search\">بحث بالتاريخ (YYYY-MM-DD)</Label>\r\n          <Input id=\"archive-search\" placeholder=\"مثال: 2025-10-19\" value={query} onChange={(e) => setQuery(e.target.value)} />\r\n        </div>\r\n\r\n        <div className=\"mt-3 space-y-2 max-h-[50vh] overflow-auto\">\r\n          {isLoading ? (\r\n            <div className=\"text-sm text-muted-foreground\">جاري التحميل...</div>\r\n          ) : filtered.length === 0 ? (\r\n            <div className=\"text-sm text-muted-foreground\">لا توجد تقارير مؤرشفة حتى الآن</div>\r\n          ) : (\r\n            filtered.map((a) => (\r\n              <div key={a.id || `${a.userId}-${a.reportDate}`} className=\"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70\">\r\n                <div className=\"flex justify-between items-center mb-1\">\r\n                  <div className=\"font-bold text-blue-800\">{a.reportDate}</div>\r\n                  <div className=\"text-xs text-blue-700\">المعاملات: {a.totalTransactions}</div>\r\n                </div>\r\n                <div className=\"grid grid-cols-2 gap-2 mt-1\">\r\n                  <div className=\"text-xs text-blue-800\">الاجمالي: <span className=\"font-semibold\">{formatNumber(a.totalAmount)}</span></div>\r\n                  <div className=\"text-xs text-blue-800\">المسحوب: <span className=\"font-semibold\">{formatNumber(a.totalWithdrawn)}</span></div>\r\n                  <div className=\"text-xs text-blue-800\">المرسل: <span className=\"font-semibold\">{formatNumber(a.totalSent)}</span></div>\r\n                  <div className=\"text-xs text-green-700\">الأرباح: <span className=\"font-semibold\">{formatNumber(a.profit)}</span></div>\r\n                </div>\r\n              </div>\r\n            ))\r\n          )}\r\n        </div>\r\n\r\n        <DialogFooter>\r\n          <Button\r\n            variant=\"destructive\"\r\n            onClick={async () => {\r\n              if (!userId) return;\r\n              try {\r\n                setIsDeletingAll(true);\r\n                await dailyReportsArchiveService.deleteAllByUser(userId);\r\n                setArchives([]);\r\n                try { localStorage.setItem(getCacheKey(), JSON.stringify([])); } catch {}\r\n                toast({ title: 'تم حذف جميع إيصالات الأرشيف', description: 'تم الحذف من السحابة والكاش المحلي.' });\r\n              } catch (e) {\r\n                toast({ title: 'تعذر حذف الأرشيف بالكامل', description: 'تم إخفاء السجلات الحديثة وقد لا تظهر بعد التحديث.', variant: 'destructive' });\r\n              } finally {\r\n                setIsDeletingAll(false);\r\n              }\r\n            }}\r\n            disabled={isDeletingAll || !archives.length}\r\n          >حذف جميع إيصالات الأرشيف</Button>\r\n          <Button variant=\"outline\" onClick={() => onOpenChange(false)}>إغلاق</Button>\r\n        </DialogFooter>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n};\r\n\r\nexport default DailyArchiveHistoryDialog;\n"],"names":["formatNumber","n","DailyArchiveHistoryDialog","open","onOpenChange","userId","toast","useToast","archives","setArchives","React","isLoading","setIsLoading","query","setQuery","isDeletingAll","setIsDeletingAll","getCacheKey","sorted","dailyReportsArchiveService","a","b","error","filtered","q","Dialog","jsxs","DialogContent","DialogHeader","jsx","DialogTitle","DialogDescription","Label","Input","e","DialogFooter","Button"],"mappings":"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"}