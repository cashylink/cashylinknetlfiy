const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-CZwBW8vR.js","./index-QuU6lc3e.css"])))=>i.map(i=>d[i]);
import{m as Ht,aL as Vt,u as Gt,ae as Yt,r as d,R as ze,aM as we,s as _,t as N,q as oe,j as e,af as ut,ag as pt,ah as gt,ai as xt,aN as Kt,B as v,aO as Qt,aH as Xt,c as q,d as L,e as H,at as je,V as M,x as te,aJ as se,g as V,I as S,D as De,E,aP as Zt,aQ as ft,C as es,_ as Se,ad as $,v as ts}from"./index-CZwBW8vR.js";import{B as G}from"./badge-DziRw6yR.js";import{S as Je}from"./separator-DqjOD3lx.js";import{A as ss,a as as,b as rs,c as is,d as ns}from"./alert-dialog-U7gr_XyE.js";import{S as cs,a as ls,b as os,c as ds,d as ms}from"./select-C1gLQVXw.js";import{C as hs}from"./calendar-DdlfWvl7.js";const p=j=>{try{return j.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(j)}},qe=j=>{try{return(j?new Date(j):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},T="machine_daily_opening_values",U="machine_daily_opening_snapshot";function js({open:j,onOpenChange:Le}){var ot,dt;const{toast:u}=Ht(),{shiftUser:O}=Vt(),{user:h}=Gt(),{shopId:x,shopName:vt}=Yt(),A=()=>{try{if(h!=null&&h.uid){const a=`selectedShopId_${h.uid}`,i=localStorage.getItem(a);if(i)return i}const t=Object.keys(localStorage||{}).filter(a=>a.startsWith("selectedShopId_"));for(const a of t){const i=localStorage.getItem(a);if(i)return i}return null}catch{return null}};d.useEffect(()=>{try{if(j){const t=document.body.style.overflow;document.body.setAttribute("data-prev-overflow",t),document.body.style.overflow="hidden"}else{const t=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=t,document.body.removeAttribute("data-prev-overflow")}}catch{}return()=>{try{const t=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=t,document.body.removeAttribute("data-prev-overflow")}catch{}}},[j]);const[He,Ae]=d.useState(""),[Ve,ke]=d.useState(""),[Ge,Ye]=d.useState(""),[Y,ae]=d.useState(null),[K,re]=d.useState(null),[Ce,ie]=d.useState(null),[Q,ne]=d.useState(null),[w,J]=d.useState("opening"),[_e,Ke]=d.useState(""),[$e,Qe]=d.useState(""),[Ie,Xe]=d.useState(null),[Ze,de]=d.useState([]),[Be,bt]=d.useState([]),[X,ce]=d.useState([]),[Nt,Oe]=d.useState(!1),[me,Pe]=d.useState(""),[he,Re]=d.useState(""),[yt,fe]=d.useState(!1),[P,et]=d.useState(null),[W,Fe]=d.useState([]),[r,ue]=d.useState(null),[tt,st]=d.useState(""),[us,ps]=d.useState(!1),[gs,xs]=d.useState(!1),[Me,at]=d.useState(""),[R,rt]=d.useState("rate"),[Ee,wt]=d.useState("2"),[Te,jt]=d.useState(""),[Dt,St]=d.useState(0),[At,kt]=d.useState(0),[Ct,_t]=d.useState(0),[$t,It]=d.useState(0),[ve,Bt]=d.useState(!1),[Z,pe]=d.useState(!1),ee=ze.useRef(!1),be=ze.useRef(null),Ne=ze.useRef(null);d.useEffect(()=>{j&&(ee.current=!1,pe(!1))},[j]),d.useEffect(()=>{if(j)try{const t=r?`${T}_${r}`:T,a=r?`${U}_${r}`:U,i=localStorage.getItem(t);if(i){const n=JSON.parse(i);typeof(n==null?void 0:n.openingBase)=="number"&&ae(n.openingBase),typeof(n==null?void 0:n.openingAir)=="number"&&re(n.openingAir),typeof(n==null?void 0:n.drawerCash)=="number"&&ie(n.drawerCash)}else ae(null),re(null),ie(null);const m=localStorage.getItem(a);if(m){const n=JSON.parse(m);typeof(n==null?void 0:n.openingBase)=="number"&&typeof(n==null?void 0:n.openingAir)=="number"?ne({openingBase:n.openingBase,openingAir:n.openingAir,drawerCash:n.drawerCash||0}):ne(null)}else ne(null)}catch{}},[j,r]),d.useEffect(()=>{(async()=>{try{const t=x||A();if(!j||!t)return;const{getDocs:a}=await we(async()=>{const{getDocs:c}=await import("./index-CZwBW8vR.js").then(s=>s.cE);return{getDocs:c}},__vite__mapDeps([0,1]),import.meta.url),i=_(N,"shops",t,"machines"),n=(await a(oe(i))).docs.map(c=>({id:c.id,name:String(c.data().name||"ماكينة"),monthlyLimit:Number(c.data().monthlyLimit||5e4)}));Fe(n);try{const c=localStorage.getItem(`machineDaily_selected_${t}`);c&&n.some(l=>l.id===c)?ue(c):!r&&n.length>0&&(ue(n[0].id),localStorage.setItem(`machineDaily_selected_${t}`,n[0].id))}catch{}}catch(t){console.error("Load machines error:",t)}})()},[j,x]);const k=d.useMemo(()=>(O==null?void 0:O.displayName)||(O==null?void 0:O.name)||(O==null?void 0:O.username)||void 0,[O]),Ot=d.useMemo(()=>X.reduce((t,a)=>t+(a.profit||0),0),[X]),Pt=d.useMemo(()=>X.reduce((t,a)=>t+(a.wholesalePrice||0),0),[X]),Rt=async()=>{try{const t=x||A();if(t&&r){const a=_(N,"shops",t,"machines",r,"transfers"),i=await te(oe(a));await Promise.all(i.docs.map(m=>se(m.ref)));try{localStorage.setItem(`machineDaily_transfers_${t}_${r}`,JSON.stringify([]))}catch{}}}catch{}ce([]),u({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."})},Ft=async()=>{try{const t=x||A();if(t&&r){const a=_(N,"shops",t,"machines",r,"deliveries"),i=await te(oe(a));await Promise.all(i.docs.map(m=>se(m.ref)));try{localStorage.setItem(`machineDaily_deliveries_${t}_${r}`,JSON.stringify([]))}catch{}}}catch{}de([]),u({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."})},Mt=async t=>{var m;if(!r)return;const a=x||A();if(!a)return;const i=[...X];ce(n=>n.filter(c=>c.id!==t.id));try{const n=Y||0,c=K||0,s=Ce||0;let l=n,o=c,g=s;t.deductFrom==="base"?l=Math.round((n+t.wholesalePrice)*100)/100:t.deductFrom==="air"&&(o=Math.round((c+t.wholesalePrice)*100)/100),g=Math.round((s-t.retailPrice)*100)/100,ae(l),re(o),ie(g),Q&&ne({openingBase:l,openingAir:o,drawerCash:g});const b=`${T}_${r}`,f=`${U}_${r}`;localStorage.setItem(b,JSON.stringify({openingBase:l,openingAir:o,drawerCash:g})),localStorage.setItem(f,JSON.stringify({openingBase:l,openingAir:o,drawerCash:g}));const y=`machineDaily_transfers_${a}_${r}`,D=i.filter(le=>le.id!==t.id);localStorage.setItem(y,JSON.stringify(D));const I=M(N,"shops",a,"machines",r,"transfers",t.id);await se(I);const ge=M(N,"shops",a,"machines",r);if(await Se(ge,{openingBase:l,openingAir:o,drawerCash:g,updatedAt:E()},{merge:!0}),h!=null&&h.uid){const le=((m=W.find(z=>z.id===r))==null?void 0:m.name)||"ماكينة";await $.saveUserTransaction(h.uid,{type:"expense",amount:t.retailPrice,senderName:le,title:"حذف إيصال تحويل",description:`إلغاء تحويل من ${le}`,shopId:a,status:"completed",createdAt:new Date,transactionId:`del_mtr_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,cashierName:k||"Unknown"});const C=await $.getUserData(h.uid),B=Number((C==null?void 0:C.cashBalance)||0)-t.retailPrice;await $.updateUserData(h.uid,{cashBalance:B})}u({title:"تم الحذف",description:"تم حذف الإيصال واسترجاع الأرصدة."})}catch(n){console.error("Error deleting transfer receipt:",n),ce(i),u({title:"خطأ",description:"فشل حذف الإيصال.",variant:"destructive"})}},Et=t=>{de(a=>a.filter(i=>i.id!==t)),u({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},Tt=()=>{ae(null),re(null),ie(null),ne(null),Ae(""),ke(""),Ye("");try{const t=r?`${T}_${r}`:T,a=r?`${U}_${r}`:U;localStorage.removeItem(t),localStorage.removeItem(a)}catch{}u({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},Ut=async()=>{var m;const t=parseFloat(He||"0"),a=parseFloat(Ve||"0"),i=parseFloat(Ge||"0");if(isNaN(t)||isNaN(a)||isNaN(i)){u({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(t<0||a<0||i<0){u({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}ae(t),re(a),ie(i);try{const n=r?`${T}_${r}`:T,c=r?`${U}_${r}`:U;localStorage.setItem(n,JSON.stringify({openingBase:t,openingAir:a,drawerCash:i})),localStorage.setItem(c,JSON.stringify({openingBase:t,openingAir:a,drawerCash:i})),ne({openingBase:t,openingAir:a,drawerCash:i});const s=x||A();if(s&&r){const l=M(N,"shops",s,"machines",r);await Se(l,{name:((m=W.find(o=>o.id===r))==null?void 0:m.name)||"ماكينة",openingBase:t,openingAir:a,drawerCash:i,cashierName:k||"Unknown",shopName:vt||null,updatedAt:E()},{merge:!0})}}catch{}u({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${p(t)}، الهواء: ${p(a)}، فلوس الدرج: ${p(i)}`})},Wt=()=>{const t=parseFloat(_e||"0"),a=parseFloat($e||"0");if(isNaN(t)||isNaN(a)){u({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(t<0||a<0){u({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const i=(Q==null?void 0:Q.openingBase)??(Y||0),m=(Q==null?void 0:Q.openingAir)??(K||0),n=i+m,s=t+a-n;Xe(s);const l={id:`${Date.now()}`,openingBase:i,openingAir:m,deliveryBase:t,deliveryAir:a,netResult:s,createdAt:new Date().toISOString(),cashierName:k||"Unknown",requiredDrawerNoProfit:s<0?Math.round(-s*100)/100:0};Ne.current=l.id,(async()=>{var o;try{const g=x||A();if(g&&r){if(await De(_(N,"shops",g,"machines",r,"deliveries"),{cashierName:k||"Unknown",userId:h==null?void 0:h.uid,openingBase:i,openingAir:m,deliveryBase:t,deliveryAir:a,netResult:s,createdAt:E()}),await Se(M(N,"shops",g,"machines",r),{lastDeliveryAt:E(),updatedAt:E()},{merge:!0}),h!=null&&h.uid){const b=((o=W.find(f=>f.id===r))==null?void 0:o.name)||"ماكينة";await $.saveUserTransaction(h.uid,{type:"machine_delivery",amount:s,senderName:b,title:"تسليم وردية مكنه",description:`تسليم وردية مكنه: ${b}`,shopId:g,status:"completed",createdAt:new Date,transactionId:`mdel_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,reference:`MDL-${Date.now()}`,cashierName:k||"Unknown",details:{openingBase:i,openingAir:m,deliveryBase:t,deliveryAir:a}})}de(b=>[l,...b]);try{const b=x||A(),f=b&&r?`machineDaily_deliveries_${b}_${r}`:`machineDaily_deliveries_${r}`,y=localStorage.getItem(f),D=y?JSON.parse(y):[],I=[l,...Array.isArray(D)?D:[]];localStorage.setItem(f,JSON.stringify(I))}catch{}u({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${p(s)}`})}}catch(g){console.error("Persist delivery error:",g),u({title:"خطأ",description:"حدث خطأ أثناء حفظ التسليم. تأكد من الصلاحيات.",variant:"destructive"})}})()},it=()=>{const t=parseFloat(me||"0"),a=parseFloat(he||"0");if(!Number.isFinite(t)||!Number.isFinite(a)){u({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if(t<0||a<0){u({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(Y==null||K==null){u({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const i=Math.round((a-t)*100)/100;et({wholesalePrice:t,retailPrice:a,profit:i}),fe(!0)},nt=async t=>{var a;if(!ee.current&&P){ee.current=!0,pe(!0);try{const i=Date.now(),m=`temp_mtr_${i}`,n=`MTR-${i}`,c={id:`transfer_${Date.now()}`,wholesalePrice:P.wholesalePrice,retailPrice:P.retailPrice,profit:P.profit,createdAt:new Date().toISOString(),cashierName:k||"Unknown",deductFrom:t};be.current=c.id;const s=P.wholesalePrice,l=Y??0,o=K??0,g=Ce??0;if(s>(t==="base"?l:o)){u({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const f=t==="base"?Math.round((l-s)*100)/100:l,y=t==="air"?Math.round((o-s)*100)/100:o,D=P.retailPrice,I=Math.round((g+D)*100)/100;ae(f),re(y),ie(I);try{const ge=r?`${T}_${r}`:T,le=r?`${U}_${r}`:U;localStorage.setItem(ge,JSON.stringify({openingBase:f,openingAir:y,drawerCash:I})),localStorage.setItem(le,JSON.stringify({openingBase:f,openingAir:y,drawerCash:I}));const C=x||A();if(C&&r){const mt=M(N,"shops",C,"machines",r);if(await Se(mt,{openingBase:f,openingAir:y,drawerCash:I,cashierName:k||"Unknown",updatedAt:E()},{merge:!0}),await De(_(N,"shops",C,"machines",r,"transfers"),{wholesalePrice:P.wholesalePrice,retailPrice:P.retailPrice,profit:P.profit,deductFrom:t,cashierName:k||"Unknown",userId:h==null?void 0:h.uid,createdAt:E()}),h!=null&&h.uid){const B=((a=W.find(F=>F.id===r))==null?void 0:a.name)||"ماكينة",z=P.retailPrice;await $.saveUserTransaction(h.uid,{type:"transfer",amount:z,senderName:B,title:"إيصال تحويل مكينه",description:`تحويل مكنه من ${B}`,shopId:C,status:"completed",createdAt:new Date,transactionId:`mtr_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,reference:n,cashierName:k||"Unknown"});try{const F=await $.getUserData(h.uid),xe=Number((F==null?void 0:F.cashBalance)||0)+z;await $.updateUserData(h.uid,{cashBalance:xe});try{if(C){const ye=M(N,"dashboardData",C),ht=await getDoc(ye);if(ht.exists()){const Lt=Number(ht.data().cashBalance||0);await updateDoc(ye,{cashBalance:Lt+z,lastUpdated:new Date().toISOString()})}}}catch{}try{localStorage.setItem(`cashBalance_${h.uid}`,String(xe)),window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:xe}}))}catch{}try{const ye={id:m,type:"transfer",amount:z,status:"completed",createdAt:new Date,title:"إيصال تحويل مكينه",description:`تحويل مكنه من ${B}`,reference:n,senderName:B,shopId:C,cashierName:k||"Unknown"};window.dispatchEvent(new CustomEvent("dashboard:external-update",{detail:{newTransaction:ye}})),window.dispatchEvent(new CustomEvent("transaction-created"))}catch{}}catch(F){console.error("Error updating cash balance for machine transfer:",F)}}u({title:"تم الحفظ",description:"تم حفظ التحويل بنجاح وإضافته للدرج"}),ce(B=>[c,...B]);try{const B=x||A(),z=B&&r?`machineDaily_transfers_${B}_${r}`:"machineDaily_transfers",F=localStorage.getItem(z),We=F?JSON.parse(F):[],xe=[c,...Array.isArray(We)?We:[]];localStorage.setItem(z,JSON.stringify(xe))}catch{}Oe(!1),Pe(""),Re(""),et(null),fe(!1),u({title:"تم تسجيل تحويل",description:`الربح الفوري: ${p(c.profit)} | خصم المخزون: -${p(s)} (${t==="base"?"الأساسي":"الهواء"}) | درج (المباع فقط): +${p(D)}`})}else console.error("Missing shopId or selectedMachineId",{sid2:C,selectedMachineId:r}),u({title:"تنبيه",description:"قد لا يتم حفظ البيانات في السيرفر لعدم توفر معرف المحل أو الماكينة",variant:"destructive"})}catch(ge){console.error("Error finalizing transfer:",ge),u({title:"خطأ",description:"حدث خطأ أثناء حفظ التحويل في قاعدة البيانات",variant:"destructive"})}}finally{ee.current=!1,pe(!1)}}},zt=()=>{Ae(""),ke(""),Ke(""),Qe(""),Xe(null)},ct=async()=>{if(!j||!r)return;const t=x||A();if(t){try{const a=_(N,"shops",t,"machines",r,"deliveries");console.log(`Fetching deliveries from: shops/${t}/machines/${r}/deliveries`);const i=await te(oe(a));console.log(`Found ${i.docs.length} delivery documents`);const n=[...i.docs.map(c=>{var o,g;const s=c.data(),l=(g=(o=s==null?void 0:s.createdAt)==null?void 0:o.toDate)!=null&&g.call(o)?s.createdAt.toDate():new Date;return{id:c.id,openingBase:Number((s==null?void 0:s.openingBase)||0),openingAir:Number((s==null?void 0:s.openingAir)||0),deliveryBase:Number((s==null?void 0:s.deliveryBase)||0),deliveryAir:Number((s==null?void 0:s.deliveryAir)||0),netResult:typeof(s==null?void 0:s.netResult)=="number"?Number(s.netResult):Math.round((Number((s==null?void 0:s.deliveryBase)||0)+Number((s==null?void 0:s.deliveryAir)||0)-(Number((s==null?void 0:s.openingBase)||0)+Number((s==null?void 0:s.openingAir)||0)))*100)/100,createdAt:l.toISOString(),cashierName:(s==null?void 0:s.cashierName)||void 0,requiredDrawerNoProfit:typeof(s==null?void 0:s.requiredDrawerNoProfit)=="number"?s.requiredDrawerNoProfit:void 0}})].sort((c,s)=>new Date(s.createdAt).getTime()-new Date(c.createdAt).getTime());de(c=>{if(Ne.current&&!n.find(l=>l.id===Ne.current)){const l=c.find(o=>o.id===Ne.current);if(l)return[l,...n].sort((b,f)=>new Date(f.createdAt).getTime()-new Date(b.createdAt).getTime()).filter((b,f,y)=>f===y.findIndex(D=>D.id===b.id))}return n});try{localStorage.setItem(`machineDaily_deliveries_${t}_${r}`,JSON.stringify(n))}catch{}}catch(a){console.error("Error fetching deliveries:",a)}try{const a=_(N,"shops",t,"machines",r,"transfers");console.log(`Fetching transfers from: shops/${t}/machines/${r}/transfers`);const i=await te(oe(a));console.log(`Found ${i.docs.length} transfer documents`);const n=[...i.docs.map(c=>{var g,b;const s=c.data(),l=(b=(g=s==null?void 0:s.createdAt)==null?void 0:g.toDate)!=null&&b.call(g)?s.createdAt.toDate():new Date,o=s==null?void 0:s.deductFrom;return{id:c.id,wholesalePrice:Number((s==null?void 0:s.wholesalePrice)||0),retailPrice:Number((s==null?void 0:s.retailPrice)||0),profit:Number((s==null?void 0:s.profit)??(Number((s==null?void 0:s.retailPrice)||0)-Number((s==null?void 0:s.wholesalePrice)||0)||0)),createdAt:l.toISOString(),cashierName:(s==null?void 0:s.cashierName)||void 0,deductFrom:o==="base"||o==="air"?o:void 0}})].sort((c,s)=>new Date(s.createdAt).getTime()-new Date(c.createdAt).getTime());ce(c=>{if(be.current&&!n.find(l=>l.id===be.current)){const l=c.find(o=>o.id===be.current);if(l)return[l,...n].sort((b,f)=>new Date(f.createdAt).getTime()-new Date(b.createdAt).getTime()).filter((b,f,y)=>f===y.findIndex(D=>D.id===b.id))}return n});try{localStorage.setItem(`machineDaily_transfers_${t}_${r}`,JSON.stringify(n))}catch{}}catch(a){console.error("Error fetching transfers:",a),u({title:"خطأ",description:"فشل في جلب التحويلات من السيرفر",variant:"destructive"})}u({title:"تم التحديث",description:"تم جلب أحدث البيانات."})}};d.useEffect(()=>{if(!j||!r)return;const t=x||A();try{const a=t?`machineDaily_deliveries_${t}_${r}`:`machineDaily_deliveries_${r}`,i=localStorage.getItem(a);if(i){const c=JSON.parse(i);Array.isArray(c)&&de(c)}const m=t?`machineDaily_transfers_${t}_${r}`:`machineDaily_transfers_${r}`,n=localStorage.getItem(m);if(n){const c=JSON.parse(n);Array.isArray(c)&&ce(c)}}catch{}ct()},[j,x,r]);const Ue=async()=>{if(!(!r||!x))try{const t=new Date,a=new Date(t.getFullYear(),t.getMonth(),1),i=new Date(t.getFullYear(),t.getMonth(),t.getDate()),m=_(N,"shops",x,"machines",r,"withdrawals"),n=oe(m,ts("createdAt","desc")),s=(await te(n)).docs.map(f=>{var D;const y=f.data();return{id:f.id,...y,createdAt:(D=y.createdAt)!=null&&D.toDate?y.createdAt.toDate():new Date(y.createdAt)}});bt(s);let l=0,o=0,g=0,b=0;s.forEach(f=>{const y=f.createdAt,D=Number(f.amount)||0,I=Number(f.commission)||0;y>=a&&(l+=D,g+=I),y>=i&&(o+=D,b+=I)}),St(l),kt(o),_t(g),It(b)}catch(t){console.error("Error fetching monthly withdrawals:",t)}};d.useEffect(()=>{(w==="cashWithdrawal"||w==="withdrawalReceipts")&&r&&Ue()},[w,r,x]);const Jt=async t=>{if(!(!r||!x))try{const a=M(N,"shops",x,"machines",r,"withdrawals",t),{getDoc:i}=await we(async()=>{const{getDoc:n}=await import("./index-CZwBW8vR.js").then(c=>c.cE);return{getDoc:n}},__vite__mapDeps([0,1]),import.meta.url),m=await i(a);if(m.exists()){const n=m.data();if(n.deductedFromDrawer&&n.userId&&n.amount){const c=await $.getUserData(n.userId),l=Number((c==null?void 0:c.cashBalance)||0)+Number(n.amount);await $.updateUserData(n.userId,{cashBalance:l});try{const{updateDoc:o}=await we(async()=>{const{updateDoc:b}=await import("./index-CZwBW8vR.js").then(f=>f.cE);return{updateDoc:b}},__vite__mapDeps([0,1]),import.meta.url),g=M(N,"dashboardData",x);await o(g,{cashBalance:l})}catch(o){console.error("Error updating shop cash balance:",o)}}}await se(a),u({title:"تم الحذف",description:"تم حذف إيصال السحب"}),Ue()}catch(a){console.error("Delete withdrawal error:",a),u({title:"خطأ",description:"فشل الحذف",variant:"destructive"})}},qt=async()=>{var t;if(!ee.current){ee.current=!0,pe(!0);try{const a=parseFloat(Me);if(isNaN(a)||a<=0){u({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}let i=0,m=0;if(R==="rate"){const c=parseFloat(Ee);if(isNaN(c)||c<0){u({title:"خطأ",description:"يرجى إدخال عمولة صحيحة",variant:"destructive"});return}i=a/1e3*c,m=c}else{const c=parseFloat(Te);if(isNaN(c)||c<0){u({title:"خطأ",description:"يرجى إدخال مبلغ عمولة صحيح",variant:"destructive"});return}i=c}if(!r||!x){u({title:"خطأ",description:"بيانات المحل أو الماكينة غير متوفرة",variant:"destructive"});return}let n=null;try{if(ve&&(h!=null&&h.uid)){const c=await $.getUserData(h.uid),l=Number((c==null?void 0:c.cashBalance)||0)-a;n=l,await $.updateUserData(h.uid,{cashBalance:l});try{const{updateDoc:o}=await we(async()=>{const{updateDoc:b}=await import("./index-CZwBW8vR.js").then(f=>f.cE);return{updateDoc:b}},__vite__mapDeps([0,1]),import.meta.url),g=M(N,"dashboardData",x);await o(g,{cashBalance:l})}catch(o){console.error("Error updating shop cash balance:",o)}}if(await De(_(N,"shops",x,"machines",r,"withdrawals"),{amount:a,commissionMode:R,commissionRate:R==="rate"?m:0,fixedCommission:R==="fixed"?i:0,commission:i,createdAt:E(),userId:h==null?void 0:h.uid,cashierName:k||"Unknown",deductedFromDrawer:ve}),h!=null&&h.uid)try{const c=((t=W.find(g=>g.id===r))==null?void 0:t.name)||"ماكينة",s={type:"machine_withdrawal",amount:a,commission:i,senderName:c,title:"إيصال سحب فوري",description:`سحب كاش بقيمة ${p(a)} وعمولة ${p(i)}${ve?" (تم الخصم من الدرج)":""}`,shopId:x,status:"completed",createdAt:new Date,transactionId:`mwd_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,reference:`MWD-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,cashierName:k||"Unknown"},l=await $.saveUserTransaction(h.uid,s),o={...s,id:l};try{window.dispatchEvent(new CustomEvent("dashboard:external-update",{detail:{newTransaction:o}})),window.dispatchEvent(new CustomEvent("transaction-created")),n!==null&&window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:n}}))}catch(g){console.error("Error dispatching events:",g)}}catch(c){console.error("Failed to save user transaction log:",c)}u({title:"تم السحب",description:`تم سحب ${p(a)} وعمولة ${p(i)}`}),at(""),Ue()}catch(c){console.error("Withdrawal error:",c),u({title:"خطأ",description:"فشل في تنفيذ السحب",variant:"destructive"})}}finally{ee.current=!1,pe(!1)}}},lt=t=>{t||zt(),Le(t)};return e.jsxs(ut,{open:j,onOpenChange:lt,children:[e.jsxs(pt,{className:"w-screen h-[100vh] overflow-hidden rounded-none p-0 flex flex-col dark:bg-[#121212]",children:[e.jsxs(gt,{className:"sticky top-0 bg-white dark:bg-[#0F0F0F] z-20 border-b border-gray-200 dark:border-[#333] px-4 py-3",children:[e.jsxs(xt,{className:"flex items-center justify-between text-right",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Kt,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة ",r&&((ot=W.find(t=>t.id===r))!=null&&ot.name)?`- ${(dt=W.find(t=>t.id===r))==null?void 0:dt.name}`:""]}),e.jsx(v,{variant:"ghost",size:"icon",onClick:ct,title:"تحديث البيانات",children:e.jsx(Qt,{className:"h-4 w-4"})})]}),e.jsx(Xt,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'}),e.jsxs("div",{className:"mt-2 grid grid-cols-2 sm:flex sm:flex-wrap sm:justify-end gap-2",children:[e.jsx(v,{size:"sm",variant:"outline",className:`w-full sm:w-auto ${w==="machines"?"bg-violet-600 text-white hover:bg-violet-700":"border-violet-300 text-violet-700"}`,onClick:()=>J("machines"),children:"الماكينات"}),e.jsx(v,{size:"sm",variant:"outline",className:`w-full sm:w-auto ${w==="cashWithdrawal"?"bg-violet-600 text-white hover:bg-violet-700":"border-violet-300 text-violet-700"}`,onClick:()=>J("cashWithdrawal"),children:"سحب كاش"}),e.jsx(v,{size:"sm",variant:"outline",className:`w-full sm:w-auto ${w==="withdrawalReceipts"?"bg-violet-600 text-white hover:bg-violet-700":"border-violet-300 text-violet-700"}`,onClick:()=>J("withdrawalReceipts"),children:"إيصالات سحب مكنة"}),e.jsx(v,{size:"sm",variant:"outline",className:`w-full sm:w-auto ${w==="opening"?"bg-violet-600 text-white hover:bg-violet-700":"border-violet-300 text-violet-700"}`,onClick:()=>J("opening"),children:"الرصيد الافتتاحي"}),e.jsx(v,{size:"sm",variant:"outline",className:`w-full sm:w-auto ${w==="transfer"?"bg-violet-600 text-white hover:bg-violet-700":"border-violet-300 text-violet-700"}`,onClick:()=>J("transfer"),children:"التحويل"}),e.jsx(v,{size:"sm",variant:"outline",className:`w-full sm:w-auto ${w==="transferReceipts"?"bg-violet-600 text-white hover:bg-violet-700":"border-violet-300 text-violet-700"}`,onClick:()=>J("transferReceipts"),children:"إيصالات التحويل"}),e.jsx(v,{size:"sm",variant:"outline",className:`w-full sm:w-auto ${w==="delivery"?"bg-violet-600 text-white hover:bg-violet-700":"border-violet-300 text-violet-700"}`,onClick:()=>J("delivery"),children:"تسليم الوردية"}),e.jsx(v,{size:"sm",variant:"outline",className:`w-full sm:w-auto col-span-2 sm:col-auto ${w==="deliveryReceipts"?"bg-violet-600 text-white hover:bg-violet-700":"border-violet-300 text-violet-700"}`,onClick:()=>J("deliveryReceipts"),children:"إيصالات التسليم"})]})]}),e.jsxs("div",{className:"px-4 py-3 overflow-y-auto flex-1 grid grid-cols-1 gap-6",children:[w==="machines"&&e.jsxs(q,{children:[e.jsx(L,{className:"pb-2",children:e.jsxs(H,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إدارة الماكينات"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(v,{variant:"destructive",onClick:async()=>{try{if(!x||!r)return;const t=M(N,"shops",x,"machines",r);try{const i=await te(_(N,"shops",x,"machines",r,"transfers"));await Promise.all(i.docs.map(m=>se(m.ref)))}catch{}try{const i=await te(_(N,"shops",x,"machines",r,"deliveries"));await Promise.all(i.docs.map(m=>se(m.ref)))}catch{}await se(t),Fe(i=>i.filter(m=>m.id!==r));const a=W.find(i=>i.id!==r);ue(a?a.id:null);try{const i=`${T}_${r}`,m=`${U}_${r}`;localStorage.removeItem(i),localStorage.removeItem(m)}catch{}u({title:"تم حذف الماكينة",description:"تمت الإزالة نهائيًا."})}catch{u({title:"فشل الحذف",description:"تعذر حذف الماكينة.",variant:"destructive"})}},disabled:!r,title:"حذف الماكينة",children:e.jsx(je,{className:"h-4 w-4"})})})]})}),e.jsx(V,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الماكينة الحالية"}),e.jsxs(cs,{value:r??"",onValueChange:t=>{ue(t);try{const a=x||A();a&&localStorage.setItem(`machineDaily_selected_${a}`,t)}catch{}},children:[e.jsx(ls,{className:"text-right",children:e.jsx(os,{placeholder:"اختر ماكينة"})}),e.jsx(ds,{children:W.map(t=>e.jsx(ms,{value:t.id,children:t.name},t.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"إنشاء ماكينة جديدة"}),e.jsx(S,{value:tt,onChange:t=>st(t.target.value),placeholder:"اسم الماكينة",className:"text-right"})]}),e.jsx("div",{className:"flex justify-end md:justify-start",children:e.jsx(v,{onClick:async()=>{try{if(!x){u({title:"لا يوجد محل",description:"يرجى التأكد من تحميل بيانات المحل.",variant:"destructive"});return}const t=(tt||"").trim();if(!t){u({title:"اسم الماكينة مطلوب",description:"أدخل اسم للماكينة الجديدة.",variant:"destructive"});return}const a=await De(_(N,"shops",x,"machines"),{name:t,shopId:x,createdAt:E(),updatedAt:E(),isActive:!0}),i={id:a.id,name:t};Fe(m=>[i,...m]),ue(a.id),st(""),u({title:"تم إنشاء ماكينة",description:`تمت إضافة ${t}`})}catch(t){console.error("Create machine error:",t),u({title:"خطأ في الإنشاء",description:"تعذر إنشاء الماكينة.",variant:"destructive"})}},className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})})]})]})})]}),w==="opening"&&e.jsxs(q,{children:[e.jsx(L,{className:"pb-2",children:e.jsx(H,{className:"flex items-center justify-between",children:e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"})})}),e.jsx("div",{className:"flex items-center justify-between px-6",children:Y!=null&&K!=null&&e.jsxs(G,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",p(Y)," | هواء ",p(K)," | درج ",p(Ce??0)]})}),e.jsxs(V,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(S,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:He,onChange:t=>Ae(t.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(S,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Ve,onChange:t=>ke(t.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx(S,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Ge,onChange:t=>Ye(t.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(v,{variant:"outline",className:"mr-2",onClick:Tt,children:"تصفير"}),e.jsx(v,{onClick:Ut,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),w==="transfer"&&e.jsxs(q,{children:[e.jsx(L,{className:"pb-2",children:e.jsx(H,{className:"flex items-center justify-between",children:e.jsx("span",{className:"text-right",children:"التحويل"})})}),e.jsxs(V,{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(S,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:me,onChange:t=>Pe(t.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(S,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:he,onChange:t=>Re(t.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(G,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",p(parseFloat(he||"0")-parseFloat(me||"0")||0)]}),e.jsx(v,{onClick:it,disabled:Y==null||K==null,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})]}),w==="transferReceipts"&&e.jsxs(q,{children:[e.jsx(L,{className:"pb-2",children:e.jsxs(H,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات التحويل"}),e.jsxs(G,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",p(Ot)]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(v,{variant:"outline",size:"sm",onClick:Rt,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"})})]})}),e.jsx(V,{className:"space-y-3",children:X.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto pr-1",children:X.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg border border-gray-100 bg-white dark:bg-gray-800 dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex items-center gap-4 sm:gap-6",children:[e.jsxs("div",{className:"text-center min-w-[3rem]",children:[e.jsx("span",{className:"block text-[10px] text-gray-500 mb-0.5",children:"جملة"}),e.jsx("span",{className:"block text-sm font-bold text-gray-900 dark:text-gray-100",children:p(t.wholesalePrice)})]}),e.jsx("div",{className:"h-8 w-px bg-gray-100 dark:bg-gray-700"}),e.jsxs("div",{className:"text-center min-w-[3rem]",children:[e.jsx("span",{className:"block text-[10px] text-gray-500 mb-0.5",children:"تجزئة"}),e.jsx("span",{className:"block text-sm font-bold text-gray-900 dark:text-gray-100",children:p(t.retailPrice)})]}),e.jsx("div",{className:"h-8 w-px bg-gray-100 dark:bg-gray-700"}),e.jsxs("div",{className:"text-center min-w-[3rem]",children:[e.jsx("span",{className:"block text-[10px] text-gray-500 mb-0.5",children:"ربح"}),e.jsx("span",{className:"block text-sm font-bold text-green-600",children:p(t.profit)})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(v,{variant:"ghost",size:"icon",className:"h-7 w-7 text-red-400 hover:text-red-600 hover:bg-red-50",onClick:()=>Mt(t),title:"حذف واسترجاع الرصيد",children:e.jsx(je,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex flex-col items-end gap-1.5",children:[t.deductFrom&&e.jsx("span",{className:`text-[10px] px-2 py-0.5 rounded-full border ${t.deductFrom==="base"?"bg-blue-50 text-blue-700 border-blue-100":"bg-amber-50 text-amber-700 border-amber-100"}`,children:t.deductFrom==="base"?"من الأساسي":"من الهواء"}),e.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-gray-400",children:[e.jsx("span",{children:qe(t.createdAt)}),t.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Je,{orientation:"vertical",className:"h-3"}),e.jsx("span",{title:t.cashierName,children:t.cashierName.split(" ")[0]})]})]})]})]})]},t.id))})})]}),w==="cashWithdrawal"&&e.jsxs(q,{children:[e.jsx(L,{className:"pb-2",children:e.jsx(H,{className:"text-right",children:"سحب كاش"})}),e.jsxs(V,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-blue-50 p-3 rounded border border-blue-100 flex flex-col justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-blue-600 block",children:"سحب اليوم (يصفر 12 ليلاً)"}),e.jsx("span",{className:"text-lg font-bold text-blue-800",children:p(At)})]}),e.jsxs("div",{className:"pt-2 mt-2 border-t border-blue-200 flex justify-between items-center",children:[e.jsx("span",{className:"text-[10px] text-blue-500 font-medium",children:"الربح اليومي"}),e.jsx("span",{className:"text-sm font-bold text-blue-700",children:p($t)})]})]}),e.jsxs("div",{className:"bg-green-50 p-3 rounded border border-green-100 flex flex-col justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-green-600 block",children:"سحب الشهر (يصفر أول الشهر)"}),e.jsx("span",{className:"text-lg font-bold text-green-800",children:p(Dt)})]}),e.jsxs("div",{className:"pt-2 mt-2 border-t border-green-200 flex justify-between items-center",children:[e.jsx("span",{className:"text-[10px] text-green-500 font-medium",children:"الربح الشهري"}),e.jsx("span",{className:"text-sm font-bold text-green-700",children:p(Ct)})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"مبلغ السحب"}),e.jsx(S,{type:"number",min:0,value:Me,onChange:t=>at(t.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-2 border p-3 rounded bg-gray-50",children:[e.jsx("label",{className:"text-sm font-medium block text-right mb-2",children:"طريقة حساب العمولة"}),e.jsxs("div",{className:"flex justify-end gap-2 mb-3",children:[e.jsx(v,{variant:R==="fixed"?"default":"outline",size:"sm",onClick:()=>rt("fixed"),className:R==="fixed"?"bg-violet-600":"",children:"مبلغ ثابت"}),e.jsx(v,{variant:R==="rate"?"default":"outline",size:"sm",onClick:()=>rt("rate"),className:R==="rate"?"bg-violet-600":"",children:"نسبة لكل ألف"})]}),R==="rate"?e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"العمولة (لكل ألف)"}),e.jsx(S,{type:"number",min:0,value:Ee,onChange:t=>wt(t.target.value),placeholder:"2",className:"text-right"})]}):e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"مبلغ العمولة الكلي"}),e.jsx(S,{type:"number",min:0,value:Te,onChange:t=>jt(t.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse mt-2 justify-end",children:[e.jsx("label",{htmlFor:"deductDrawer",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer",children:"خصم من درج النقدية"}),e.jsx(Zt,{id:"deductDrawer",checked:ve,onCheckedChange:t=>Bt(!!t)})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 p-3 rounded-lg",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["سيتم تسجيل عمولة: ",e.jsx("span",{className:"font-bold text-green-600",children:p(R==="rate"?parseFloat(Me||"0")/1e3*parseFloat(Ee||"0"):parseFloat(Te||"0"))})]}),e.jsx(v,{onClick:qt,disabled:Z,className:"bg-violet-600 hover:bg-violet-700 disabled:opacity-70",children:Z?"جاري السحب...":"سحب"})]})]})]}),w==="withdrawalReceipts"&&e.jsxs(q,{children:[e.jsx(L,{className:"pb-2",children:e.jsxs(H,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات سحب مكنة"}),e.jsxs(G,{variant:"outline",className:"text-violet-700 border-violet-200 bg-violet-50",children:["عدد الإيصالات: ",Be.length]})]})}),e.jsx(V,{className:"space-y-3",children:Be.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد سحوبات مسجلة لهذا الشهر."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-y-auto pr-1",children:Be.map(t=>{var a;return e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg border border-gray-100 bg-white dark:bg-gray-800 dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-right min-w-[4rem]",children:[e.jsx("span",{className:"block text-[10px] text-gray-500 mb-0.5",children:"المبلغ"}),e.jsx("span",{className:"block text-sm font-bold text-gray-900 dark:text-gray-100",children:p(t.amount)})]}),e.jsx("div",{className:"h-8 w-px bg-gray-100 dark:bg-gray-700"}),e.jsxs("div",{className:"text-right min-w-[3rem]",children:[e.jsx("span",{className:"block text-[10px] text-gray-500 mb-0.5",children:"العمولة"}),e.jsx("span",{className:"block text-sm font-bold text-green-600",children:p(t.commission)})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(v,{variant:"ghost",size:"icon",className:"h-7 w-7 text-red-400 hover:text-red-600 hover:bg-red-50",onClick:()=>Jt(t.id),title:"حذف الإيصال",children:e.jsx(je,{className:"h-4 w-4"})}),e.jsx("div",{className:"flex flex-col items-end gap-1.5",children:e.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-gray-400",children:[e.jsx("span",{children:qe((a=t.createdAt)!=null&&a.toISOString?t.createdAt.toISOString():t.createdAt)}),t.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Je,{orientation:"vertical",className:"h-3"}),e.jsx("span",{title:t.cashierName,children:t.cashierName.split(" ")[0]})]})]})})]})]},t.id)})})})]}),w==="delivery"&&e.jsxs(q,{children:[e.jsx(L,{className:"pb-2",children:e.jsx(H,{className:"text-right",children:"تسليم الوردية"})}),e.jsxs(V,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(S,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:_e,onChange:t=>Ke(t.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(S,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:$e,onChange:t=>Qe(t.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsx("div",{className:"flex items-center justify-end gap-2",children:e.jsx(v,{onClick:Wt,className:"bg-violet-600 hover:bg-violet-700",children:"تسليم"})}),Ie!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(G,{className:Ie>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",p(Ie)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(G,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",p(parseFloat(_e||"0")+parseFloat($e||"0"))]}),e.jsxs(G,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",p(Pt)]})]})]})]})]}),w==="deliveryReceipts"&&e.jsxs(q,{children:[e.jsx(L,{className:"pb-2",children:e.jsxs(H,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات التسليم"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(v,{variant:"outline",size:"sm",onClick:Ft,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"})})]})}),e.jsx(V,{className:"space-y-3",children:Ze.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:Ze.map(t=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",p(t.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",p(t.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",p(t.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",p(t.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(v,{variant:"outline",size:"sm",onClick:()=>Et(t.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(je,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${t.netResult>=0?"text-green-700":"text-red-700"}`,children:p(t.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",p(t.deliveryBase+t.deliveryAir)]}),typeof t.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",p(t.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(hs,{className:"h-3 w-3"}),e.jsx("span",{children:qe(t.createdAt)}),t.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Je,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",t.cashierName]})]})]})]})]},t.id))})})]})]}),e.jsxs(ft,{className:"sticky bottom-0 bg-white dark:bg-[#0F0F0F] z-20 border-t border-gray-200 dark:border-[#333] px-4 py-3 flex items-center justify-between",children:[e.jsx(v,{variant:"outline",onClick:()=>lt(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(es,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(ut,{open:Nt,onOpenChange:Oe,children:e.jsxs(pt,{className:"sm:max-w-sm",children:[e.jsx(gt,{children:e.jsx(xt,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(S,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:me,onChange:t=>Pe(t.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(S,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:he,onChange:t=>Re(t.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(G,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",p(parseFloat(he||"0")-parseFloat(me||"0")||0)]})})]}),e.jsxs(ft,{className:"flex items-center justify-end gap-2",children:[e.jsx(v,{variant:"secondary",onClick:()=>Oe(!1),children:"إلغاء"}),e.jsx(v,{onClick:it,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(ss,{open:yt,onOpenChange:fe,children:e.jsxs(as,{children:[e.jsxs(rs,{children:[e.jsx(is,{children:"اختيار مصدر الخصم"}),e.jsx(ns,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(v,{variant:"ghost",onClick:()=>fe(!1),disabled:Z,children:"رجوع"}),e.jsx(v,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>nt("base"),disabled:Z,children:Z?"جاري التحويل...":"خصم من الأساسي"}),e.jsx(v,{className:"bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>nt("air"),disabled:Z,children:Z?"جاري التحويل...":"خصم من الهواء"})]})]})})]})}export{js as default};
//# sourceMappingURL=MachineDailyDialog-DZzSVmtZ.js.map
