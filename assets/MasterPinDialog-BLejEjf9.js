import{s as U,F as ue,G as W,i as Y,K as fe,a1 as he,J as de,c as ee,r as o,j as e,V as te,W as se,X as ae,Y as re,ay as me,t as ne,I as z,Z as xe,B as p,f as ye,az as ge,aA as pe,u as ve,S as we,E as _,v as q}from"./index-DA5EGBVC.js";import{L as B}from"./label-DGcgSfhx.js";import{C as je}from"./circle-alert-CRivym9p.js";const Q="master_pin",g=new Map;function N(i){return i?`${Q}_${i}`:Q}async function Pe(i){try{const t=await he.getUserData(i),s=(t==null?void 0:t.security)&&t.security.masterPin||(t==null?void 0:t.masterPin)||null;return typeof s=="string"&&s.length>0?s:null}catch{try{const t=W(Y,"users",i),s=await de(t);if(s.exists()){const a=s.data(),r=(a==null?void 0:a.security)&&a.security.masterPin||(a==null?void 0:a.masterPin)||null;return typeof r=="string"&&r.length>0?r:null}}catch{}return null}}function I(i){try{const t=localStorage.getItem(N(i));return t&&t.length>0?t:null}catch{return null}}async function H(i,t){try{const s={security:{masterPin:t||null,masterPinUpdatedAt:U()},updatedAt:U()};await ue(W(Y,"users",i),s,{merge:!0})}catch{try{await fe(W(Y,"users",i),{security:{masterPin:t||null,masterPinUpdatedAt:U()},updatedAt:U()})}catch{}}}function E(i,t){try{const s=N(i);t?localStorage.setItem(s,t):localStorage.removeItem(s)}catch{}}class P{static async hasMasterPin(t){const s=N(t);if(g.has(s)){const r=g.get(s);return r!==""&&r!=null}const a=I(t);if(a)return g.set(s,a),!0;if(t){const r=I(void 0);if(r){g.set(s,r),E(t,r);try{E(void 0,null)}catch{}return await H(t,r),!0}}if(t){const r=await Pe(t);if(r){g.set(s,r),E(t,r);try{E(void 0,null)}catch{}return!0}}return!1}static async createMasterPin(t,s){try{if(!t||t.length<4)return!1;const a=btoa(t),r=N(s);return g.set(r,a),E(s,a),s&&await H(s,a),!0}catch(a){return console.error("Error creating master PIN:",a),!1}}static async verifyMasterPin(t,s){try{const a=N(s);if(!await this.hasMasterPin(s))return!1;const r=g.get(a);return r?atob(r)===t:!1}catch(a){return console.error("Error verifying master PIN:",a),!1}}static async changeMasterPin(t,s,a){try{return await this.verifyMasterPin(t,a)?await this.createMasterPin(s,a):!1}catch(r){return console.error("Error changing master PIN:",r),!1}}static async deleteMasterPin(t){try{const s=N(t);return g.delete(s),E(t,null),t&&await H(t,null),!0}catch(s){return console.error("Error deleting master PIN:",s),!1}}static async getMasterPin(t){try{const s=N(t);if(!await this.hasMasterPin(t))return null;const a=g.get(s);return a?atob(a):null}catch(s){return console.error("Error getting master PIN:",s),null}}}const Ne=({open:i,onOpenChange:t,title:s="تأكيد كلمة المرور",description:a="أدخل كلمة مرور تسجيل الدخول للمتابعة",onSuccess:r})=>{const{toast:n}=ee(),[m,b]=o.useState(""),[u,v]=o.useState(!1),[C,x]=o.useState(null),S=async()=>{x(null);try{const l=ye.currentUser;if(!l||!l.email){x("لا يوجد مستخدم مسجل حالياً. يرجى تسجيل الدخول أولاً.");return}v(!0);const w=ge.credential(l.email,m);await pe(l,w),v(!1),b(""),n({title:"تم التأكيد",description:"تم التحقق من كلمة المرور بنجاح"}),r(),t&&t(!1)}catch(l){console.error("إعادة التحقق بكلمة المرور فشلت:",l),v(!1);const w=(l==null?void 0:l.code)||"";x(w==="auth/wrong-password"?"كلمة المرور غير صحيحة. حاول مرة أخرى.":w==="auth/too-many-requests"?"تمت محاولات كثيرة. يرجى الانتظار قليلاً ثم المحاولة.":"حدث خطأ أثناء التحقق. حاول مرة أخرى.")}},D=l=>{t&&t(l),l||(b(""),x(null),v(!1))};return e.jsx(te,{open:i,onOpenChange:D,children:e.jsxs(se,{className:"sm:max-w-[400px]",dir:"rtl",children:[e.jsxs(ae,{children:[e.jsx(re,{className:"text-right",children:s}),e.jsx(me,{className:"text-right",children:a})]}),e.jsxs("div",{className:"grid gap-4 py-2",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-2",children:[e.jsx("label",{htmlFor:"password",className:"text-right col-span-1 text-sm",children:"كلمة المرور"}),e.jsxs("div",{className:"col-span-3 relative",children:[e.jsx(ne,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(z,{id:"password",type:"password",value:m,onChange:l=>b(l.target.value),placeholder:"نفس كلمة مرور تسجيل الدخول",autoComplete:"off"})]})]}),C&&e.jsx("div",{className:"text-red-600 text-xs text-right",children:C})]}),e.jsxs(xe,{className:"flex justify-end gap-2",children:[e.jsx(p,{variant:"outline",onClick:()=>D(!1),disabled:u,children:"إلغاء"}),e.jsx(p,{onClick:S,disabled:u||!m,className:"bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",children:u?"جاري التحقق...":"تأكيد"})]})]})})},Me=({open:i,onOpenChange:t,onSuccess:s,title:a="الرقم السري الرئيسي",description:r="رقم سري موحد لإدارة جميع عناصر الموقع",mode:n="verify"})=>{const[m,b]=o.useState(""),[u,v]=o.useState(""),[C,x]=o.useState(""),[S,D]=o.useState(!1),[l,w]=o.useState(!1),[O,$]=o.useState(!1),[G,f]=o.useState(""),[J,h]=o.useState(!1),{toast:T}=ee(),{user:V,profile:k}=ve(),y=V==null?void 0:V.uid,[j,ie]=o.useState(!1),[F,le]=o.useState(!1),L=(k==null?void 0:k.role)==="admin"||(k==null?void 0:k.role)==="staff",[ce,R]=o.useState(!1),[M,X]=o.useState(!1),K=o.useRef(null);o.useEffect(()=>{let c=!0;return i&&(async()=>{try{const Z=await P.hasMasterPin(y);c&&ie(Z)}catch{}})(),()=>{c=!1}},[y,i]);const oe=async c=>{c.preventDefault(),f(""),h(!0);try{if(n==="verify"){if(!m){f("يرجى إدخال الرقم السري الرئيسي"),h(!1);return}if(!await P.verifyMasterPin(m,y)){f("الرقم السري غير صحيح"),h(!1);return}T({title:"تم التأكيد",description:"تم التحقق من الرقم السري بنجاح"}),s==null||s(),A()}else if(n==="create"){if(!u||u.length<4){f("يجب أن يكون الرقم السري الجديد 4 أرقام على الأقل"),h(!1);return}if(u!==C){f("الرقم السري الجديد وتأكيده غير متطابقين"),h(!1);return}if(!await P.createMasterPin(u,y)){f("تعذر إنشاء الرقم السري الرئيسي"),h(!1);return}T({title:"تم تعيين الرقم السري الرئيسي",description:"تم تعيين الرقم السري الرئيسي بنجاح"}),s==null||s(),A()}else if(n==="change"){if(!y){f("لا يمكن تغيير الرقم السري قبل تحميل حساب المستخدم. الرجاء إعادة المحاولة بعد تسجيل الدخول أو انتظار التحميل."),h(!1);return}if(j&&!F&&!M){if(!m){f("يرجى إدخال الرقم السري الحالي أو تأكيد كلمة الدخول"),h(!1);return}if(!await P.verifyMasterPin(m,y)){f("الرقم السري الحالي غير صحيح"),h(!1);return}}if(!u||u.length<4){f("يجب أن يكون الرقم السري الجديد 4 أرقام على الأقل"),h(!1);return}if(u!==C){f("الرقم السري الجديد وتأكيده غير متطابقين"),h(!1);return}if(!(j?F&&L||M?await P.createMasterPin(u,y):await P.changeMasterPin(m,u,y):await P.createMasterPin(u,y))){f("تعذر تغيير الرقم السري الرئيسي"),h(!1);return}T({title:j?F&&L||M?"تم إعادة تعيين الرقم السري الرئيسي":"تم تغيير الرقم السري الرئيسي":"تم تعيين الرقم السري الرئيسي",description:j?F&&L||M?"تمت إعادة التعيين بدون الحاجة للرقم الحالي":"تم تغيير الرقم السري الرئيسي بنجاح":"تم تعيين الرقم السري الرئيسي بنجاح"}),s==null||s(),A()}}catch{f("حدث خطأ أثناء معالجة الرقم السري")}finally{h(!1)}},A=()=>{b(""),v(""),x(""),f(""),D(!1),w(!1),$(!1),X(!1),R(!1),t(!1)};return e.jsx(te,{open:i,onOpenChange:A,children:e.jsxs(se,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ae,{children:e.jsxs(re,{className:"flex items-center gap-2 text-center justify-center",children:[e.jsx(we,{className:"h-5 w-5 text-blue-600"}),a]})}),e.jsx("div",{className:"text-center text-sm text-gray-600 mb-4",children:r}),e.jsxs("form",{ref:K,onSubmit:oe,className:"space-y-4",children:[(n==="verify"||n==="change"&&j)&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"currentPin",className:"text-right block",children:n==="verify"?"الرقم السري الرئيسي":"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"currentPin",type:S?"text":"password",autoComplete:"off",value:m,onChange:c=>b(c.target.value),onKeyDown:c=>{var d;if(c.key==="Enter")try{(d=K.current)==null||d.requestSubmit()}catch{}},placeholder:n==="verify"?"أدخل الرقم السري الرئيسي":"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr",inputMode:"numeric",autoFocus:!0,disabled:n==="change"&&M}),e.jsx(p,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>D(!S),children:S?e.jsx(_,{className:"h-4 w-4"}):e.jsx(q,{className:"h-4 w-4"})})]}),n==="change"&&j&&L&&e.jsxs("div",{className:"text-xs text-gray-600 mt-2 flex items-center justify-between",children:[e.jsx("span",{children:"نسيت الرقم السري؟"}),e.jsx(p,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2",onClick:()=>{le(c=>!c)},children:F?"إلغاء إعادة التعيين الإدارية":"إعادة تعيين بدون الرقم الحالي"})]}),n==="change"&&j&&e.jsxs("div",{className:"text-xs text-gray-600 mt-2 flex items-center justify-between",children:[e.jsx("span",{children:"لا تعرف الرقم الحالي؟ يمكنك تأكيد بكلمة الدخول"}),e.jsx(p,{type:"button",variant:"secondary",size:"sm",className:"h-7 px-2",onClick:()=>R(!0),children:"تأكيد بكلمة الدخول"})]}),n==="change"&&M&&e.jsx("div",{className:"text-[11px] text-green-600",children:"تم التحقق من كلمة الدخول — يمكنك المتابعة بدون الرقم الحالي"})]}),(n==="create"||n==="change")&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"newPin",className:"text-right block",children:n==="create"?"الرقم السري الرئيسي الجديد":"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"newPin",type:l?"text":"password",autoComplete:"off",value:u,onChange:c=>v(c.target.value),onKeyDown:c=>{var d;if(c.key==="Enter")try{(d=K.current)==null||d.requestSubmit()}catch{}},placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr",inputMode:"numeric"}),e.jsx(p,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>w(!l),children:l?e.jsx(_,{className:"h-4 w-4"}):e.jsx(q,{className:"h-4 w-4"})})]})]}),(n==="create"||n==="change")&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"confirmPin",type:O?"text":"password",autoComplete:"off",value:C,onChange:c=>x(c.target.value),onKeyDown:c=>{var d;if(c.key==="Enter")try{(d=K.current)==null||d.requestSubmit()}catch{}},placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr",inputMode:"numeric"}),e.jsx(p,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>$(!O),children:O?e.jsx(_,{className:"h-4 w-4"}):e.jsx(q,{className:"h-4 w-4"})})]})]}),G&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm bg-red-50 p-3 rounded-lg",children:[e.jsx(je,{className:"h-4 w-4"}),G]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(p,{type:"button",variant:"outline",onClick:A,className:"flex-1",children:"إلغاء"}),e.jsx(p,{type:"submit",disabled:J,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:J?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري المعالجة..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),n==="verify"?"تحقق":n==="create"?"إنشاء":"تغيير"]})})]})]}),e.jsx(Ne,{open:ce,onOpenChange:R,title:"تأكيد بكلمة دخول الحساب",description:"أدخل كلمة المرور المستخدمة لتسجيل الدخول للسماح بتغيير الرقم السري",onSuccess:()=>{X(!0),R(!1),f("")}})]})})};export{Me as M,Ne as P,P as a};
//# sourceMappingURL=MasterPinDialog-BLejEjf9.js.map
