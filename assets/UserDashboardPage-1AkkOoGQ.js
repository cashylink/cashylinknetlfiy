const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-DCCNgGPW.js","./index-CS_QnlXg.css","./dailyOperationCountService-Br8p3Ou7.js","./profitService-Bwg-yNfl.js"])))=>i.map(i=>d[i]);
var uu=Object.defineProperty;var xu=(i,f,d)=>f in i?uu(i,f,{enumerable:!0,configurable:!0,writable:!0,value:d}):i[f]=d;var ro=(i,f,d)=>xu(i,typeof f!="symbol"?f+"":f,d);import{W as la,w as wd,x as Nd,u as _a,r as n,i as da,j as e,aC as be,aD as ve,aE as De,aF as we,B as x,at as ga,C as bt,b as ns,c as js,av as Jn,e as At,bD as Ui,ay as Ta,bE as ad,ae as qn,$ as qa,aw as Xs,a as jd,D as Ss,au as Vt,I as q,ap as Sd,aA as Kn,af as yt,bF as fa,S as Rn,U as or,F as pu,R as Ye,v as G,E as ea,A as ba,bi as ar,J as $e,o as U,V as Ps,z as gt,m as Hr,bG as Sr,X as Ws,q as Je,n as ye,az as le,t as Ue,a1 as Dd,br as gu,aj as Wi,ah as Yn,aL as qi,a3 as Ce,s as Yr,aO as fo,aG as us,bH as sr,ax as wo,aH as it,Y as Xt,y as ka,be as ya,bI as Id,bJ as fu,bK as yu,a9 as Cd,bL as bu,a4 as vu,bM as wu,a8 as Nu,bN as ju,bO as Su,bP as Du,bQ as Ad,bR as Iu,bS as Cu,Z as va,bT as Td,a2 as Rs,aK as rd,aQ as Un,aP as yo,bU as Au,bV as Tu,ai as ku,k as Pu,H as _u,bW as Mn,K as Ou,bX as $n,ao as Eu,al as Ln,aN as Mu,b7 as nd,bv as no,b8 as $u,b9 as Lu,ba as Wu,bb as Fu,bc as Bu,P as Ru,bd as id,bY as Uu,aq as qu,p as zu,aM as Wn,bZ as ld,bo as Vu,b_ as Ju}from"./index-DCCNgGPW.js";import{B as Bt}from"./badge-DfJ_Cd6V.js";import{S as rr,a as nr,b as ir,c as lr,d as pa,C as zn,e as kd,f as Ku}from"./select-DGlsBkiO.js";import{M as ks,a as Ls,P as Yu}from"./MasterPinDialog-BxzQrVxp.js";import{W as ia}from"./wallet-DWHebgmj.js";import{a as Pd,C as bo,S as Hu}from"./star-OBsEMadB.js";import{S as Fi}from"./square-pen-C4KnS8Ce.js";import{T as Ns}from"./trash-2-DcC1U_Hc.js";import{P as Pa}from"./phone-CFLT9Th1.js";import{A as _d}from"./arrow-left-CaId6H0o.js";import{P as od}from"./progress-D56HxldF.js";import{C as Dr,d as Bi,T as Qu,a as Gu,b as cd,c as dd,S as Od}from"./tabs-sXmhEuOx.js";import{D as is}from"./dollar-sign-Cx5pdup0.js";import{A as Ei,T as io,a as lo,b as Kr,c as ss,d as oo,e as as,P as Zu}from"./table-Dcug6DJe.js";import{C as Ir}from"./circle-alert-Dp4UJch_.js";import{C as No}from"./circle-x-kanmRERm.js";import{C as Zr}from"./circle-check-big-BoX_IbGj.js";import{f as rs,P as Ed,C as Md,A as jo,u as Fn,a as co,I as Xu,b as md,R as ex,c as tx,M as sx}from"./MaintenanceDialog-DgzlfQZR.js";import{S as ax}from"./switch-BF7eo6Gr.js";import{E as rx,a as nx}from"./broadcastService-B0YvnSDq.js";import{D as ix,a as lx,b as ox,c as cx,d as dx}from"./dropdown-menu-Cnglh8kr.js";import{B as mo}from"./bell-CZi6ERVz.js";import{R as Li}from"./refresh-cw-BB3NaMkG.js";import{ProfitService as cr}from"./profitService-Bwg-yNfl.js";import{A as Qr}from"./arrow-down-left-DACJ6E-y.js";import{W as mx}from"./WalletsManagement-BRF77ef_.js";import{FreeTrialService as hd}from"./freeTrialService-CSiXFwUm.js";import{C as hx,P as ux,w as xx}from"./walletSelectionPinService-DObvrOOL.js";import{C as px}from"./crown-2KbebdC6.js";import"./index-TUMzqYWw.js";import"./whatsappService-B1cIRXDd.js";import"./download-o2Ens89R.js";/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gx=[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]],ud=la("banknote",gx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fx=[["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M9 22v-3a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3",key:"cabbwy"}],["rect",{x:"4",y:"2",width:"16",height:"20",rx:"2",key:"1uxh74"}]],$d=la("building",fx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yx=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]],xd=la("calendar-days",yx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bx=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]],vx=la("circle-plus",bx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wx=[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]],Ri=la("id-card",wx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nx=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],pd=la("info",Nx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const jx=[["path",{d:"M13 5h8",key:"a7qcls"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 19h8",key:"c3s6r1"}],["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}]],ho=la("list-checks",jx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Sx=[["path",{d:"M2 6h4",key:"aawbzj"}],["path",{d:"M2 10h4",key:"l0bgd4"}],["path",{d:"M2 14h4",key:"1gsvsf"}],["path",{d:"M2 18h4",key:"1bu2t1"}],["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["path",{d:"M16 2v20",key:"rotuqe"}]],gd=la("notebook",Sx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Dx=[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["polyline",{points:"3.29 7 12 12 20.71 7",key:"ousv84"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]],Ld=la("package",Dx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ix=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],Mi=la("rotate-ccw",Ix);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Cx=[["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}],["path",{d:"M8 7v10",key:"23sfjj"}],["path",{d:"M12 7v10",key:"jspqdw"}],["path",{d:"M17 7v10",key:"578dap"}]],uo=la("scan-barcode",Cx);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ax=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],Tx=la("send",Ax);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kx=[["path",{d:"M16 17h6v-6",key:"t6n2it"}],["path",{d:"m22 17-8.5-8.5-5 5L2 7",key:"x473p"}]],dr=la("trending-down",kx),Wd=async(i={})=>{try{return(await wd(Nd,"getLastTransactions")(i)).data}catch(f){throw console.error("Error getting last transactions:",f),f.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):f.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+f.message):f.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+f.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(f.message||"خطأ غير معروف"))}},Px=async i=>(await wd(Nd,"sendTelegramMessage")(i)).data,_x=Object.freeze(Object.defineProperty({__proto__:null,getLastTransactions:Wd,sendTelegramMessage:Px},Symbol.toStringTag,{value:"Module"})),Ox=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Ex=({isOpen:i,onClose:f,onWalletSelect:d,onEditWallet:j,onDeleteWallet:S})=>{const{user:I}=_a(),[s,v]=n.useState([]),[W,D]=n.useState(!1),[$,M]=n.useState([]),[y,N]=n.useState(!1),{toast:O}=da(),H=async(E,F)=>{const re=new Date().getMonth(),_e=new Date().getFullYear(),Ne=F.filter(ze=>{const Ke=new Date(ze.createdAt);return Ke.getMonth()===re&&Ke.getFullYear()===_e&&(ze.lineId===E||ze.fromWallet===E)}),de=ze=>{const Ke=ze.type;return ze.txnType==="receive"||Ke==="withdraw"||Ke==="withdrawal"||Ke==="receive"},ae=ze=>{const Ke=ze.type;return ze.txnType==="send"||Ke==="send"||Ke==="transfer"},Le=Ne.filter(de).reduce((ze,Ke)=>{const mt=Ke.withdrawnAmount!==void 0?Ke.withdrawnAmount:Ke.amount;return ze+(mt||0)},0),Qe=Ne.filter(ae).reduce((ze,Ke)=>{const mt=Ke.sentAmount!==void 0?Ke.sentAmount:Ke.amount;return ze+(mt||0)},0);return{withdrawalUsage:Le,transferUsage:Qe}},L=E=>{const F=new Date().toISOString().split("T")[0],re=E.lastResetDate;if(!re)return{...E,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:F};const _e=new Date(re),Ne=new Date;return _e.getMonth()!==Ne.getMonth()||_e.getFullYear()!==Ne.getFullYear()?{...E,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:F}:E};n.useEffect(()=>{if(!(I!=null&&I.uid)||!i)return;(async()=>{N(!0);try{const F=await ga.getByMerchantId(I.uid),re=await Ui.getByUserId(I.uid),Ne=(await Promise.all(F.map(async de=>{const{withdrawalUsage:ae,transferUsage:Le}=await H(de.id,re),Qe=await Ta.getWalletLimits(de.id);return{id:de.id,name:de.label||"محفظة بدون اسم",phone:de.msisdn,nationalId:de.nationalId||"",isDefault:!1,isActive:de.isActive===!0,monthlyWithdrawalLimit:(Qe==null?void 0:Qe.monthlyWithdrawLimit)??de.withdrawLimit??2e5,monthlyTransferLimit:(Qe==null?void 0:Qe.monthlyTransferLimit)??de.transferLimit??2e5,monthlyWithdrawalUsage:(Qe==null?void 0:Qe.monthlyWithdrawUsed)??ae??0,monthlyTransferUsage:(Qe==null?void 0:Qe.monthlyTransferUsed)??Le??0,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:de.walletProvider||""}}))).map(L);v(Ne)}catch(F){console.error("Error loading wallets:",F),O({title:"فشل جلب بيانات المحافظ",description:"قد تكون المشكلة بسبب الصلاحيات أو الاتصال. سيتم عرض البيانات المحلية إن وُجدت. جرّب تسجيل الدخول مجددًا أو افتح صفحة اختبار المصادقة من القائمة.",variant:"destructive"})}finally{N(!1)}})()},[I==null?void 0:I.uid,i]);const Y=E=>Ox.find(F=>F.id===E),te=(E,F)=>F>0?Math.min(E/F*100,100):0,me=E=>new Intl.NumberFormat("ar-EG").format(E);return e.jsx(be,{open:i,onOpenChange:f,children:e.jsxs(ve,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(De,{className:"pb-4",children:[e.jsxs(we,{className:"flex items-center gap-2 text-lg",children:[e.jsx(ia,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(Bt,{variant:"secondary",className:"mr-2",children:[s.length," محفظة"]})]}),e.jsx("div",{className:"flex items-center gap-2 mt-2",children:W?e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",onClick:async()=>{try{if(!(I!=null&&I.uid))return;const E=s.map(F=>ga.update(F.id,{isActive:$.includes(F.id)}));await Promise.all(E),v(F=>F.map(re=>({...re,isActive:$.includes(re.id)}))),D(!1),O({title:"تم تفعيل المحافظ",description:"فقط المحافظ المحددة ستظهر في الاختيار الخارجي"});try{window.dispatchEvent(new CustomEvent("wallets:activation-updated"))}catch{}}catch(E){console.error("Error activating wallets:",E),O({title:"فشل التفعيل",description:"تعذر تفعيل المحافظ المحددة",variant:"destructive"})}},className:"h-7",children:"تفعيل المحافظ"}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>{D(!1),M([])},className:"h-7",children:"إلغاء"})]}):e.jsx(x,{variant:"outline",size:"sm",onClick:()=>D(!0),className:"h-7",children:"تحديد المحافظ"})})]}),y?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):s.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ia,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:s.map(E=>{const F=Y(E.walletProvider||"");te(E.monthlyWithdrawalUsage||0,E.monthlyWithdrawalLimit),te(E.monthlyTransferUsage||0,E.monthlyTransferLimit);const re=$.includes(E.id),_e=W?`cursor-pointer transition-shadow border-2 ${re?"border-blue-500 shadow-lg":"hover:border-blue-300"}`:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300";return e.jsxs(bt,{className:_e,onClick:()=>{W?M(Ne=>Ne.includes(E.id)?Ne.filter(de=>de!==E.id):[...Ne,E.id]):d(E)},children:[e.jsx(ns,{className:"pb-3",children:e.jsxs(js,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Jn,{className:"h-4 w-4"}),e.jsx("span",{children:E.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[E.isActive&&e.jsx(Bt,{variant:"default",className:"text-xs",children:"نشطة"}),E.isDefault&&e.jsxs(Bt,{variant:"default",className:"text-xs",children:[e.jsx(Pd,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(x,{variant:"ghost",size:"sm",onClick:Ne=>{Ne.stopPropagation(),j==null||j(E)},className:"h-7 px-2",children:e.jsx(Fi,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",onClick:Ne=>{Ne.stopPropagation(),S==null||S(E.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(Ns,{className:"h-4 w-4"})})]})]})}),e.jsxs(At,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Pa,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:E.phone})]}),E.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ri,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:E.nationalId})]}),F&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx($d,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:F.name})]})]}),(()=>{const Ne=E.monthlyWithdrawalLimit,de=E.monthlyTransferLimit,ae=E.monthlyWithdrawalUsage||0,Le=E.monthlyTransferUsage||0,Qe=Math.max(Ne-ae,0),ze=Math.max(de-Le,0);return e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{className:"text-xs text-gray-600 font-medium text-center",children:["الحدود الشهرية: ",(F==null?void 0:F.name)||E.walletProvider," - ",E.phone]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(ae/Math.max(Ne,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Le/Math.max(de,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",me(Qe)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",me(ze)," جنيه"]})]})]})})(),e.jsx(x,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:Ne=>{Ne.stopPropagation(),d(E)},children:"عرض التفاصيل الكاملة"})]})]},E.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(x,{onClick:f,variant:"outline",children:[e.jsx(_d,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},Mx=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],$x=({wallet:i,isOpen:f,onClose:d,onBack:j})=>{const{user:S}=_a(),[I,s]=n.useState([]),[v,W]=n.useState(!1),[D,$]=n.useState("month"),{toast:M}=da();if(n.useEffect(()=>{if(!i||!(S!=null&&S.uid)||!f)return;(async()=>{W(!0);try{const st=(await Ui.getByUserId(S.uid)).filter(St=>St.walletId===i.id).sort((St,Tt)=>new Date(Tt.createdAt).getTime()-new Date(St.createdAt).getTime());s(st)}catch(Ae){console.error("Error loading transactions:",Ae),M({title:"فشل جلب معاملات المحفظة",description:"قد تكون المشكلة بسبب صلاحيات Firestore أو الاتصال. تم عرض ما أمكن محليًا. جرّب تسجيل الدخول مجددًا أو صفحة اختبار المصادقة.",variant:"destructive"})}finally{W(!1)}})()},[i,S==null?void 0:S.uid,f]),!i)return null;const y=ee=>Mx.find(Ae=>Ae.id===ee),N=(ee,Ae)=>Ae>0?Math.min(ee/Ae*100,100):0,O=ee=>new Intl.NumberFormat("ar-EG").format(ee),H=ee=>new Date(ee).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),Y=(()=>{const ee=new Date;let Ae;switch(D){case"week":Ae=new Date(ee.getTime()-7*24*60*60*1e3);break;case"month":Ae=new Date(ee.getFullYear(),ee.getMonth(),1);break;default:return I}return I.filter(st=>new Date(st.createdAt)>=Ae)})(),te=ee=>{const Ae=ee.type,st=ee.txnType;return Ae==="withdraw"||Ae==="withdrawal"||Ae==="receive"||st==="receive"},me=ee=>{const Ae=ee.type,st=ee.txnType;return Ae==="send"||Ae==="transfer"||st==="send"},E=Y.filter(ee=>te(ee)&&ee.status==="completed").reduce((ee,Ae)=>{const st=Ae.withdrawnAmount!==void 0?Ae.withdrawnAmount:Ae.amount;return ee+(st||0)},0),F=Y.filter(ee=>me(ee)&&ee.status==="completed").reduce((ee,Ae)=>{const st=Ae.sentAmount!==void 0?Ae.sentAmount:Ae.amount;return ee+(st||0)},0),re=Y.filter(ee=>ee.type==="deposit"&&ee.status==="completed").reduce((ee,Ae)=>ee+Ae.amount,0),_e=Y.filter(ee=>ee.status==="completed"),Ne=_e.length,de=_e.reduce((ee,Ae)=>{if(te(Ae)){const st=Ae.withdrawnAmount??Ae.receivedAmount??Ae.amount??0;return ee+ad(Number(st)||0,"receive")}if(me(Ae)){const st=Ae.sentAmount??Ae.transferredAmount??Ae.amount??0;return ee+ad(Number(st)||0,"send")}return ee},0),ae=y(i.walletProvider||""),Le=N(i.monthlyWithdrawalUsage||0,i.monthlyWithdrawalLimit),Qe=N(i.monthlyTransferUsage||0,i.monthlyTransferLimit),ze=ee=>{switch(ee){case"withdrawal":return e.jsx(dr,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(qn,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx(is,{className:"h-4 w-4 text-green-500"});default:return e.jsx(Ei,{className:"h-4 w-4 text-gray-500"})}},Ke=ee=>{switch(ee){case"completed":return e.jsx(Zr,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(qa,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(No,{className:"h-4 w-4 text-red-500"});default:return e.jsx(Ir,{className:"h-4 w-4 text-gray-500"})}},mt=ee=>{switch(ee){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},Et=ee=>{switch(ee){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(be,{open:f,onOpenChange:d,children:e.jsxs(ve,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(De,{className:"pb-4",children:e.jsxs(we,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Jn,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",i.name,i.isDefault&&e.jsxs(Bt,{variant:"default",className:"mr-2",children:[e.jsx(Pd,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(bt,{children:[e.jsx(ns,{children:e.jsxs(js,{className:"text-sm flex items-center gap-2",children:[e.jsx(Ri,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(At,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Pa,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.phone})]}),i.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ri,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.nationalId})]}),ae&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx($d,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:ae.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",ae.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",ae.nationalId]})]})]}),i.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Dr,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(i.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs(bt,{children:[e.jsx(ns,{children:e.jsxs(js,{className:"text-sm flex items-center gap-2",children:[e.jsx(bo,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(At,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(dr,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[O(i.monthlyWithdrawalUsage||0)," / ",O(i.monthlyWithdrawalLimit)]})]}),e.jsx(od,{value:Le,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",O(i.monthlyWithdrawalLimit-(i.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(Bi,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(qn,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[O(i.monthlyTransferUsage||0)," / ",O(i.monthlyTransferLimit)]})]}),e.jsx(od,{value:Qe,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",O(i.monthlyTransferLimit-(i.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(bt,{children:e.jsxs(At,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(dr,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:O(E)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx(bt,{children:e.jsxs(At,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(qn,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:O(F)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx(bt,{children:e.jsxs(At,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(is,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:O(re)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})}),e.jsx(bt,{children:e.jsxs(At,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(bo,{className:"h-5 w-5 text-emerald-600"})}),e.jsx("div",{className:"text-lg font-bold",children:O(de)}),e.jsx("div",{className:"text-xs text-gray-600",children:"أرباح الفترة"})]})}),e.jsx(bt,{children:e.jsxs(At,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Ei,{className:"h-5 w-5 text-purple-600"})}),e.jsx("div",{className:"text-lg font-bold",children:O(Ne)}),e.jsx("div",{className:"text-xs text-gray-600",children:"عدد العمليات"})]})})]}),e.jsxs(bt,{children:[e.jsx(ns,{children:e.jsxs(js,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Ei,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{size:"sm",variant:D==="week"?"default":"outline",onClick:()=>$("week"),className:"text-xs",children:"أسبوع"}),e.jsx(x,{size:"sm",variant:D==="month"?"default":"outline",onClick:()=>$("month"),className:"text-xs",children:"شهر"}),e.jsx(x,{size:"sm",variant:D==="all"?"default":"outline",onClick:()=>$("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(At,{children:v?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):Y.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ei,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:Y.map(ee=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[ze(ee.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[mt(ee.type)," - ",O(ee.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:H(ee.createdAt)}),ee.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:ee.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[Ke(ee.status),e.jsx("span",{className:"text-xs",children:Et(ee.status)})]})]},ee.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(x,{onClick:j,variant:"outline",children:[e.jsx(_d,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(x,{onClick:d,variant:"outline",children:"إغلاق"})]})]})})},xo=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Lx=({isOpen:i,onClose:f,onWalletUpdate:d,initialEditingWallet:j})=>{const{toast:S}=da(),{user:I,userSubscription:s}=_a();(()=>{var Fe,kt;const B=((Fe=s==null?void 0:s.subscription)==null?void 0:Fe.planType)??((kt=s==null?void 0:s.subscription)==null?void 0:kt.plan)??(s==null?void 0:s.planType)??(s==null?void 0:s.plan)??null,ge=typeof B=="string"?String(B).trim().toLowerCase():null;return B===Xs.TAHWEELA||ge==="tahweela"||ge==="تحويله"})();const v=jd(),[W,D]=n.useState([]),[$,M]=n.useState(!1),[y,N]=n.useState(null),[O,H]=n.useState(""),[L,Y]=n.useState(""),[te,me]=n.useState(""),[E,F]=n.useState(""),[re,_e]=n.useState("200000"),[Ne,de]=n.useState("200000"),[ae,Le]=n.useState("100000"),[Qe,ze]=n.useState("60000"),[Ke,mt]=n.useState(!1),[Et,ee]=n.useState(null),[Ae,st]=n.useState(!1),[St,Tt]=n.useState(!1),[pe,Me]=n.useState(!1),[Oe,rt]=n.useState(null),Se=()=>`wallets_${(I==null?void 0:I.uid)||"default"}`;n.useEffect(()=>{j&&(N(j),M(!0),H(j.name||""),Y(j.phone||""),me(j.nationalId||""),F(j.walletProvider||""),_e((j.monthlyWithdrawalLimit||2e5).toString()),de((j.monthlyTransferLimit||2e5).toString()),Le((j.dailyWithdrawalLimit||1e5).toString()),ze((j.dailyTransferLimit||6e4).toString()),mt(!!j.isDefault))},[j]);const Ze=B=>{const ge=new Date,Fe=ge.getMonth(),kt=ge.getFullYear();if(!B.lastResetDate)return{...B,monthlyWithdrawalUsage:B.monthlyWithdrawalUsage||0,monthlyTransferUsage:B.monthlyTransferUsage||0,lastResetDate:ge.toISOString().split("T")[0]};const vt=new Date(B.lastResetDate),_t=vt.getMonth(),ps=vt.getFullYear();return Fe!==_t||kt!==ps?{...B,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:ge.toISOString().split("T")[0]}:B},We=async(B,ge)=>{const Fe=new Date().getMonth(),kt=new Date().getFullYear(),vt=ge.filter(Dt=>{const dt=new Date(Dt.createdAt);return dt.getMonth()===Fe&&dt.getFullYear()===kt&&Dt.lineId===B}),_t=vt.filter(Dt=>Dt.txnType==="receive").reduce((Dt,dt)=>Dt+(dt.amount||0),0),ps=vt.filter(Dt=>Dt.txnType==="send").reduce((Dt,dt)=>Dt+(dt.amount||0),0);return{withdrawalUsage:_t,transferUsage:ps}},Ie=async(B,ge)=>{const Fe=new Date,kt=Fe.getDate(),vt=Fe.getMonth(),_t=Fe.getFullYear(),ps=ge.filter(Mt=>{const xs=new Date(Mt.createdAt);return xs.getDate()===kt&&xs.getMonth()===vt&&xs.getFullYear()===_t&&Mt.lineId===B}),Dt=ps.filter(Mt=>Mt.txnType==="receive").reduce((Mt,xs)=>Mt+(xs.amount||0),0),dt=ps.filter(Mt=>Mt.txnType==="send").reduce((Mt,xs)=>Mt+(xs.amount||0),0);return{withdrawalUsage:Dt,transferUsage:dt}};n.useEffect(()=>{(async()=>{if(!(I!=null&&I.uid)){console.log("No user authenticated, skipping wallet loading"),st(!1);return}console.log("Loading wallets for user:",I.uid),st(!0);try{const{auth:ge}=await yt(async()=>{const{auth:dt}=await import("./index-DCCNgGPW.js").then(Mt=>Mt.cl);return{auth:dt}},__vite__mapDeps([0,1]),import.meta.url);let Fe=0;const kt=5;for(;!ge.currentUser&&Fe<kt;)console.log(`Waiting for auth state... attempt ${Fe+1}`),await new Promise(dt=>setTimeout(dt,1e3)),Fe++;if(!ge.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",ge.currentUser.uid),console.log("Context User:",I.uid),console.log("Fetching wallets from Firebase...");const vt=await ga.getByMerchantId(I.uid);console.log("Fetched wallets:",vt),console.log("Fetching transactions from Firebase...");const _t=await Ui.getByUserId(I.uid);console.log("Fetched transactions:",_t);const Dt=(await Promise.all(vt.map(async dt=>{const{withdrawalUsage:Mt,transferUsage:xs}=await We(dt.id,_t),{withdrawalUsage:Ot,transferUsage:Fs}=await Ie(dt.id,_t);return{id:dt.id,name:dt.label||"محفظة بدون اسم",phone:dt.msisdn,isDefault:!1,monthlyWithdrawalLimit:dt.withdrawLimit||2e5,monthlyTransferLimit:dt.transferLimit||2e5,dailyWithdrawalLimit:dt.dailyWithdrawLimit||1e5,dailyTransferLimit:dt.dailyTransferLimit||6e4,monthlyWithdrawalUsage:Mt,monthlyTransferUsage:xs,dailyWithdrawalUsage:Ot,dailyTransferUsage:Fs,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:dt.defaultTransferCommission!=null?Number(dt.defaultTransferCommission):null,defaultWithdrawCommission:dt.defaultWithdrawCommission!=null?Number(dt.defaultWithdrawCommission):null}}))).map(Ze);D(Dt),console.log("Wallets loaded successfully:",Dt)}catch(ge){console.error("Error loading wallets:",ge),D([])}finally{st(!1)}})()},[I==null?void 0:I.uid]);const He=()=>{H(""),Y(""),me(""),F(""),_e("200000"),de("200000"),Le("100000"),ze("60000"),mt(!1),N(null),M(!1)},Z=async()=>{if(!O.trim()||!L.trim()||!E.trim()){S({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(I!=null&&I.uid)){S({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}st(!0);try{if(y){await ga.update(y.id,{label:O.trim(),msisdn:L.trim(),withdrawLimit:parseInt(re),transferLimit:parseInt(Ne),dailyWithdrawLimit:parseInt(ae),dailyTransferLimit:parseInt(Qe)}),await Ta.setLimits(y.id,{dailyTransferLimit:parseInt(Qe||"0"),dailyWithdrawLimit:parseInt(ae||"0"),monthlyTransferLimit:parseInt(Ne||"0"),monthlyWithdrawLimit:parseInt(re||"0")});const B=W.map(ge=>ge.id===y.id?{...ge,name:O.trim(),phone:L.trim(),nationalId:te.trim(),walletProvider:E,monthlyWithdrawalLimit:parseInt(re),monthlyTransferLimit:parseInt(Ne),dailyWithdrawalLimit:parseInt(ae),dailyTransferLimit:parseInt(Qe)}:ge);D(B),localStorage.setItem(Se(),JSON.stringify(B)),S({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const B={merchantUserId:I.uid,provider:E,msisdn:L.trim(),label:O.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(re),transferLimit:parseInt(Ne),dailyTransferLimit:parseInt(Qe),dailyWithdrawLimit:parseInt(ae),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},ge=await ga.create(B);await Ta.setLimits(ge,{dailyTransferLimit:parseInt(Qe||"0"),dailyWithdrawLimit:parseInt(ae||"0"),monthlyTransferLimit:parseInt(Ne||"0"),monthlyWithdrawLimit:parseInt(re||"0")});const Fe=new Date().toISOString().split("T")[0],kt={id:ge,name:O.trim(),phone:L.trim(),nationalId:te.trim(),walletProvider:E,isDefault:Ke,monthlyWithdrawalLimit:parseInt(re),monthlyTransferLimit:parseInt(Ne),dailyWithdrawalLimit:parseInt(ae),dailyTransferLimit:parseInt(Qe),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:Fe,defaultTransferCommission:null,defaultWithdrawCommission:null},vt=[...W,kt];D(vt),localStorage.setItem(Se(),JSON.stringify(vt)),S({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}d&&d(),He(),M(!1),N(null)}catch(B){console.error("Error saving wallet:",B),S({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{st(!1)}},ht=B=>{N(B),H(B.name),Y(B.phone),me(B.nationalId||""),F(B.walletProvider||""),_e(B.monthlyWithdrawalLimit.toString()),de(B.monthlyTransferLimit.toString()),mt(B.isDefault),M(!0)},Jt=async B=>{const ge=W.find(Fe=>Fe.id===B);if(ge!=null&&ge.isDefault){S({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(I!=null&&I.uid)){S({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}st(!0);try{await ga.delete(B);const Fe=W.filter(kt=>kt.id!==B);D(Fe),localStorage.setItem(Se(),JSON.stringify(Fe)),d&&d(),S({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(Fe){console.error("Error deleting wallet:",Fe),S({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{st(!1)}},Kt=B=>{const ge=W.map(Fe=>({...Fe,isDefault:Fe.id===B}));D(ge),localStorage.setItem(Se(),JSON.stringify(ge)),d&&d(),S({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(be,{open:i,onOpenChange:f,children:[e.jsxs(ve,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(De,{className:"pb-2",children:e.jsxs(we,{className:"flex items-center gap-1 text-sm",children:[e.jsx(ia,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",W.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(x,{onClick:()=>{Me(!0)},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(Ss,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(x,{onClick:()=>{f(),v("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(Vt,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),($||y)&&e.jsxs(bt,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx(ns,{className:"pb-1",children:e.jsx(js,{className:"text-sm",children:y?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(At,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(rr,{value:E,onValueChange:F,children:[e.jsx(nr,{className:"h-6 text-xs flex-1",children:e.jsx(ir,{placeholder:"اختر شركة المحفظة"})}),e.jsx(lr,{children:xo.map(B=>e.jsx(pa,{value:B.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:B.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:ge=>{ge.preventDefault(),ge.stopPropagation(),ee(B.id)},children:e.jsx(pd,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},B.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx(q,{value:O,onChange:B=>H(B.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx(Pa,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{value:L,onChange:B=>Y(B.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ri,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{value:te,onChange:B=>me(B.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(is,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{type:"number",value:re,onChange:B=>_e(B.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(is,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(q,{type:"number",value:Ne,onChange:B=>de(B.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(dr,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx(q,{type:"number",value:ae,onChange:B=>Le(B.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(qn,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx(q,{type:"number",value:Qe,onChange:B=>ze(B.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:Ke,onChange:B=>mt(B.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(Sd,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(x,{onClick:Z,className:"flex-1 h-6 text-xs",size:"sm",children:y?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(x,{variant:"outline",onClick:He,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:W.map(B=>{var ge;return e.jsxs(bt,{className:`${B.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx(ns,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(js,{className:"text-sm flex items-center gap-1",children:[e.jsx(ia,{className:"h-3 w-3"}),B.name]}),B.isDefault&&e.jsx(Bt,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(At,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Pa,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:B.phone})]}),B.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((ge=xo.find(Fe=>Fe.id===B.walletProvider))==null?void 0:ge.name)||B.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((B.monthlyWithdrawalUsage||0)/B.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((B.monthlyTransferUsage||0)/B.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(B.monthlyWithdrawalLimit-(B.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(B.monthlyTransferLimit-(B.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((B.dailyWithdrawalUsage||0)/B.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((B.dailyTransferUsage||0)/B.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify بين items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(B.dailyWithdrawalLimit-(B.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(B.dailyTransferLimit-(B.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(x,{size:"sm",variant:"outline",onClick:()=>ht(B),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(Fi,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!B.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",variant:"outline",onClick:()=>Kt(B.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(x,{size:"sm",variant:"destructive",onClick:()=>Jt(B.id),className:"h-5 px-1",children:e.jsx(Ns,{className:"h-2 w-2"})})]})]})]})]},B.id)})}),W.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),Et&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>ee(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(Kn,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const B=xo.find(ge=>ge.id===Et);return B?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:B.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:B.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:B.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(pd,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(ks,{open:pe,onOpenChange:Me,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Me(!1),Tt(!0)}}),e.jsx(Ex,{isOpen:St,onClose:()=>Tt(!1),onWalletSelect:B=>{rt(B),Tt(!1)},onEditWallet:B=>{v(`/user/add-wallet?edit=1&id=${B.id}`),Tt(!1)},onDeleteWallet:async B=>{try{if(await ga.delete(B),D(ge=>{const Fe=ge.filter(kt=>kt.id!==B);try{localStorage.setItem(Se(),JSON.stringify(Fe))}catch(kt){console.error("Failed to update localStorage wallets after delete:",kt)}return Fe}),d)try{await d()}catch(ge){console.error("onWalletUpdate callback failed:",ge)}}catch(ge){console.error("Error deleting wallet:",ge)}}}),e.jsx($x,{wallet:Oe,isOpen:!!Oe,onClose:()=>rt(null),onBack:()=>{rt(null),Tt(!0)}})]})},Wx=({isOpen:i,onClose:f,transaction:d,onDelete:j})=>{if(!d)return null;const S=D=>{switch(D){case"completed":return e.jsx(Zr,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(qa,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(No,{className:"h-5 w-5 text-red-500"});default:return e.jsx(qa,{className:"h-5 w-5 text-gray-500"})}},I=D=>{switch(D){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},s=D=>{switch(D){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},v=()=>{const D=!!d.senderNumber,$=!!d.senderName,M=D?"الرقم المرسل:":$?"الرقم الراسل:":"رقم المحفظة:",y=D?d.senderNumber:$?d.senderName:d.senderPhone,N=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${d.transactionReference||d.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${d.merchantShopName||d.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${s(d.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${d.status==="completed"?"#16a34a":d.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${I(d.status)}
            </span>
          </div>

          ${d!=null&&d.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${d.cashierName}</span>
            </div>
          `:""}
          
          ${d.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${M}</span>
              <span style="color: #1e293b;">${y}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${d.receiverNumber||d.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${rs(d.transferredAmount||d.amount)} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${d.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${rs(d.withdrawnAmountDetailed||d.withdrawnAmount||d.amount)} جنيه</span>
            </div>
          `}
          
          ${d.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${rs(d.commission||0)} جنيه</span>
            </div>
          `:""}
          ${d.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الربح:</span>
              <span style="color: #16a34a; font-weight: 600;">${rs(d.commission||0)} جنيه</span>
            </div>
          `:""}
          ${d!=null&&d.fee&&Number(d.fee)>0?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرسوم:</span>
              <span style="color: #64748b; font-weight: 600;">${rs(d.fee||0)} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${d.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${d.type==="withdraw"?"-":""}${rs(d.amount)} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,O=window.open("","_blank");O&&(O.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${d.transactionReference||d.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${N}
          </body>
        </html>
      `),O.document.close(),O.print())},W=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(j(d.id),f())};return e.jsx(be,{open:i,onOpenChange:f,children:e.jsxs(ve,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(De,{children:e.jsxs(we,{className:"flex items-center gap-2 text-xl",children:[e.jsx(fa,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(bt,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs(ns,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[S(d.status),e.jsx(Bt,{variant:d.status==="completed"?"default":"secondary",className:"text-sm",children:I(d.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[d.type==="withdraw"?"-":"",rs(d.amount)," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",d.transactionReference||d.id]})]})}),e.jsxs(bt,{children:[e.jsx(ns,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Rn,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(At,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:d.merchantShopName||d.shopName||"غير محدد"})]}),(d==null?void 0:d.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:d.cashierName})]})]})]}),e.jsxs(bt,{children:[e.jsx(ns,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Jn,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(At,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(Bt,{variant:"outline",className:"bg-blue-100 text-blue-800",children:s(d.type)})]}),d.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const D=!!d.senderNumber,$=!!d.senderName,M=D?"الرقم المرسل:":$?"الرقم الراسل:":"رقم المحفظة:",y=D?d.senderNumber:$?d.senderName:d.senderPhone,N=D?or:Pa;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:M})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:y})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(pu,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(or,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:d.receiverNumber||d.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(is,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[rs(d.transferredAmount||d.amount)," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Pa,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:d.senderPhone})]}),(d==null?void 0:d.senderName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(or,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("span",{className:"text-gray-900",children:d.senderName})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(is,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[rs(d.withdrawnAmountDetailed||d.withdrawnAmount||d.amount)," جنيه"]})]})]}),d.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[d.commission," جنيه"]})]}),d.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-green-700",children:"الربح:"}),e.jsxs("span",{className:"text-green-900 font-semibold",children:[d.commission," جنيه"]})]}),(d==null?void 0:d.fee)&&Number(d.fee)>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الرسوم:"}),e.jsxs("span",{className:"text-gray-900 font-semibold",children:[d.fee," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Dr,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:d.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(x,{onClick:v,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx(Ed,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(x,{onClick:W,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(Ns,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(x,{onClick:f,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function fd({open:i,onOpenChange:f,onSuccess:d,title:j,description:S,currentBalance:I,balanceLabel:s,userId:v}){const[W,D]=n.useState(""),[$,M]=n.useState(I.toString()),[y,N]=n.useState(!1),[O,H]=n.useState(""),[L,Y]=n.useState(!1),te=async E=>{E.preventDefault(),H(""),Y(!0);try{const F=parseFloat($);if(isNaN(F)||F<0){H("يرجى إدخال مبلغ صحيح"),Y(!1);return}await Ls.hasMasterPin(v)?await Ls.verifyMasterPin(W,v)?(d(F),f(!1),D(""),M("")):H("الرقم السري غير صحيح"):H("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{H("حدث خطأ أثناء التحقق من الرقم السري")}finally{Y(!1)}},me=()=>{D(""),M(I.toString()),H(""),f(!1)};return Ye.useEffect(()=>{i&&M(I.toString())},[I,i]),e.jsx(be,{open:i,onOpenChange:me,children:e.jsxs(ve,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(De,{children:e.jsxs(we,{className:"flex items-center gap-2 text-right",children:[e.jsx(is,{className:"h-5 w-5"}),j]})}),e.jsxs("form",{onSubmit:te,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:S}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(G,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[I.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx(q,{id:"newAmount",type:"number",step:"0.01",min:"0",value:$,onChange:E=>M(E.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"pin",type:y?"text":"password",value:W,onChange:E=>D(E.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>N(!y),children:y?e.jsx(ea,{className:"h-4 w-4"}):e.jsx(Ss,{className:"h-4 w-4"})})]})]}),O&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(Ir,{className:"h-4 w-4"}),O]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(x,{type:"button",variant:"outline",onClick:me,className:"flex-1",children:"إلغاء"}),e.jsx(x,{type:"submit",disabled:L||!W||!$,className:"flex-1",children:L?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ba,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class Vn{static getSecretKey(f){return f?`${this.SECRET_KEY_BASE}_${f}`:this.SECRET_KEY_BASE}static setSecretPin(f,d){const j=btoa(f);this.secretCache.set(this.getSecretKey(d),j)}static hasSecretPin(f){return this.secretCache.has(this.getSecretKey(f))}static verifySecretPin(f,d){const j=this.secretCache.get(this.getSecretKey(d));if(!j)return!1;try{return atob(j)===f}catch{return!1}}static clearSecretPin(f){this.secretCache.delete(this.getSecretKey(f))}}ro(Vn,"SECRET_KEY_BASE","dashboard_secret_pin"),ro(Vn,"secretCache",new Map);function Fx({open:i,onOpenChange:f,userId:d}){const[j,S]=n.useState(""),[I,s]=n.useState(""),[v,W]=n.useState(""),[D,$]=n.useState(!1),[M,y]=n.useState(!1),[N,O]=n.useState(!1),[H,L]=n.useState(""),[Y,te]=n.useState(!1),{toast:me}=da(),E=Vn.hasSecretPin(d),F=async _e=>{_e.preventDefault(),L(""),te(!0);try{if(!I||I.length<4){L("يجب أن يكون الرقم السري 4 أرقام على الأقل"),te(!1);return}if(I!==v){L("الرقم السري الجديد وتأكيده غير متطابقين"),te(!1);return}if(E){if(!j){L("يرجى إدخال الرقم السري الحالي"),te(!1);return}if(!Vn.verifySecretPin(j,d)){L("الرقم السري الحالي غير صحيح"),te(!1);return}}Vn.setSecretPin(I,d),me({title:E?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:E?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),re()}catch{L("حدث خطأ أثناء حفظ الرقم السري")}finally{te(!1)}},re=()=>{S(""),s(""),W(""),L(""),$(!1),y(!1),O(!1),f(!1)};return e.jsx(be,{open:i,onOpenChange:re,children:e.jsxs(ve,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(De,{children:e.jsxs(we,{className:"flex items-center gap-2 text-right",children:[e.jsx(Sd,{className:"h-5 w-5"}),E?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:F,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:E?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),E&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"currentPin",type:D?"text":"password",autoComplete:"off",value:j,onChange:_e=>S(_e.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>$(!D),children:D?e.jsx(ea,{className:"h-4 w-4"}):e.jsx(Ss,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"newPin",type:M?"text":"password",autoComplete:"off",value:I,onChange:_e=>s(_e.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!M),children:M?e.jsx(ea,{className:"h-4 w-4"}):e.jsx(Ss,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:N?"text":"password",autoComplete:"off",value:v,onChange:_e=>W(_e.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>O(!N),children:N?e.jsx(ea,{className:"h-4 w-4"}):e.jsx(Ss,{className:"h-4 w-4"})})]})]}),H&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ir,{className:"h-4 w-4"}),H]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:Y,className:"flex-1",children:[e.jsx(ba,{className:"h-4 w-4 mr-2"}),Y?"جاري الحفظ...":E?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(x,{type:"button",variant:"outline",onClick:re,disabled:Y,children:"إلغاء"})]})]})]})})}const po=new Map;function Bx({open:i,onOpenChange:f,userId:d}){const[j,S]=n.useState(""),[I,s]=n.useState(""),[v,W]=n.useState(""),[D,$]=n.useState(!1),[M,y]=n.useState(!1),[N,O]=n.useState(!1),[H,L]=n.useState(""),[Y,te]=n.useState(!1),{toast:me}=da(),E=d?`cash_drawer_pin_${d}`:"cash_drawer_pin",F=()=>po.has(E),re=ae=>{const Le=po.get(E);if(!Le)return!1;try{return atob(Le)===ae}catch{return!1}},_e=ae=>{const Le=btoa(ae);po.set(E,Le)},Ne=async ae=>{ae.preventDefault(),L(""),te(!0);try{if(!I||I.length<4){L("يجب أن يكون الرقم السري 4 أرقام على الأقل"),te(!1);return}if(I!==v){L("الرقم السري الجديد وتأكيده غير متطابقين"),te(!1);return}if(F()){if(!j){L("يرجى إدخال الرقم السري الحالي لدرج النقدية"),te(!1);return}if(!re(j)){L("الرقم السري الحالي لدرج النقدية غير صحيح"),te(!1);return}}_e(I),me({title:F()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:F()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),de()}catch{L("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{te(!1)}},de=()=>{S(""),s(""),W(""),L(""),$(!1),y(!1),O(!1),f(!1)};return e.jsx(be,{open:i,onOpenChange:de,children:e.jsxs(ve,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(De,{children:e.jsxs(we,{className:"flex items-center gap-2 text-right",children:[e.jsx(is,{className:"h-5 w-5 text-green-600"}),F()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:Ne,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:F()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),F()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"currentPin",type:D?"text":"password",autoComplete:"off",value:j,onChange:ae=>S(ae.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>$(!D),children:D?e.jsx(ea,{className:"h-4 w-4"}):e.jsx(Ss,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"newPin",type:M?"text":"password",autoComplete:"off",value:I,onChange:ae=>s(ae.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!M),children:M?e.jsx(ea,{className:"h-4 w-4"}):e.jsx(Ss,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:N?"text":"password",autoComplete:"off",value:v,onChange:ae=>W(ae.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>O(!N),children:N?e.jsx(ea,{className:"h-4 w-4"}):e.jsx(Ss,{className:"h-4 w-4"})})]})]}),H&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ir,{className:"h-4 w-4"}),H]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:Y,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(ba,{className:"h-4 w-4 mr-2"}),Y?"جاري الحفظ...":F()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(x,{type:"button",variant:"outline",onClick:de,disabled:Y,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}const go=new Map;function Rx({open:i,onOpenChange:f,userId:d}){const[j,S]=n.useState(""),[I,s]=n.useState(""),[v,W]=n.useState(""),[D,$]=n.useState(!1),[M,y]=n.useState(!1),[N,O]=n.useState(!1),[H,L]=n.useState(""),[Y,te]=n.useState(!1),{toast:me}=da(),E=d?`wallet_total_pin_${d}`:"wallet_total_pin",F=()=>go.has(E),re=ae=>{const Le=go.get(E);if(!Le)return!1;try{return atob(Le)===ae}catch{return!1}},_e=ae=>{const Le=btoa(ae);go.set(E,Le)},Ne=async ae=>{ae.preventDefault(),L(""),te(!0);try{if(!I||I.length<4){L("يجب أن يكون الرقم السري 4 أرقام على الأقل"),te(!1);return}if(I!==v){L("الرقم السري الجديد وتأكيده غير متطابقين"),te(!1);return}if(F()){if(!j){L("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),te(!1);return}if(!re(j)){L("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),te(!1);return}}_e(I),me({title:F()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:F()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),de()}catch{L("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{te(!1)}},de=()=>{S(""),s(""),W(""),L(""),$(!1),y(!1),O(!1),f(!1)};return e.jsx(be,{open:i,onOpenChange:de,children:e.jsxs(ve,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(De,{children:e.jsxs(we,{className:"flex items-center gap-2 text-right",children:[e.jsx(ia,{className:"h-5 w-5 text-blue-600"}),F()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:Ne,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:F()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),F()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"currentPin",type:D?"text":"password",autoComplete:"off",value:j,onChange:ae=>S(ae.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>$(!D),children:D?e.jsx(ea,{className:"h-4 w-4"}):e.jsx(Ss,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"newPin",type:M?"text":"password",autoComplete:"off",value:I,onChange:ae=>s(ae.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!M),children:M?e.jsx(ea,{className:"h-4 w-4"}):e.jsx(Ss,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:N?"text":"password",autoComplete:"off",value:v,onChange:ae=>W(ae.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>O(!N),children:N?e.jsx(ea,{className:"h-4 w-4"}):e.jsx(Ss,{className:"h-4 w-4"})})]})]}),H&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ir,{className:"h-4 w-4"}),H]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:Y,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(ba,{className:"h-4 w-4 mr-2"}),Y?"جاري الحفظ...":F()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(x,{type:"button",variant:"outline",onClick:de,disabled:Y,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function Ux({open:i,onOpenChange:f,onSuccess:d,title:j,description:S,currentBalance:I,balanceLabel:s,userId:v}){const[W,D]=n.useState(""),[$,M]=n.useState(""),[y,N]=n.useState("add"),[O,H]=n.useState(!1),[L,Y]=n.useState(""),[te,me]=n.useState(!1),[E,F]=n.useState(!1);n.useEffect(()=>{let de=!0;return(async()=>{const ae=await Ls.hasMasterPin(v);de&&F(ae)})(),()=>{de=!1}},[v,i]);const re=async de=>{de.preventDefault(),Y(""),me(!0);try{const ae=parseFloat($);if(isNaN(ae)||ae<=0){Y("يرجى إدخال مبلغ صحيح أكبر من صفر"),me(!1);return}if(y==="subtract"&&ae>I){Y("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),me(!1);return}if(E)if(await Ls.verifyMasterPin(W,v)){const Qe=y==="add"?ae:-ae;_e(),d(Qe)}else Y("الرقم السري غير صحيح");else Y("لم يتم تعيين الرقم السري الرئيسي. يرجى تعيينه من إعدادات البروفيل أولاً")}catch{Y("حدث خطأ أثناء التحقق من الرقم السري")}finally{me(!1)}},_e=()=>{D(""),M(""),N("add"),Y(""),f(!1)},Ne=()=>{const de=parseFloat($)||0;return y==="add"?I+de:I-de};return e.jsx(be,{open:i,onOpenChange:_e,children:e.jsxs(ve,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(De,{children:e.jsxs(we,{className:"flex items-center gap-2 text-right",children:[y==="add"?e.jsx(Vt,{className:"h-5 w-5 text-green-600"}):e.jsx(ar,{className:"h-5 w-5 text-red-600"}),j]})}),e.jsxs("form",{onSubmit:re,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:S}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(G,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[I.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(x,{type:"button",variant:y==="add"?"default":"outline",onClick:()=>N("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(Vt,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(x,{type:"button",variant:y==="subtract"?"default":"outline",onClick:()=>N("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(ar,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(G,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",y==="add"?"إضافته":"خصمه"]}),e.jsx(q,{id:"amount",type:"number",step:"0.01",min:"0.01",value:$,onChange:de=>M(de.target.value),placeholder:`أدخل المبلغ المراد ${y==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),$&&!isNaN(parseFloat($))&&e.jsxs("div",{className:`p-3 rounded-lg ${y==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(G,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${y==="add"?"text-green-700":"text-red-700"}`,children:[Ne().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"pin",type:O?"text":"password",autoComplete:"off",value:W,onChange:de=>D(de.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>H(!O),children:O?e.jsx(ea,{className:"h-4 w-4"}):e.jsx(Ss,{className:"h-4 w-4"})})]})]}),L&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(Ir,{className:"h-4 w-4"}),L]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(x,{type:"button",variant:"outline",onClick:_e,className:"flex-1",children:"إلغاء"}),e.jsx(x,{type:"submit",disabled:te||!W||!$,className:`flex-1 ${y==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:te?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ba,{className:"h-4 w-4 mr-2"}),y==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}const yd={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_APP_VERSION:"0.0.0",VITE_DEV_MODE:"true",VITE_ENABLE_OFFLINE_PERSISTENCE:"false",VITE_FIREBASE_API_KEY:["AI","za","SyA33RTf43u2QE2OsK1RepQHSKrSet9ZI0s"].join(""),VITE_FIREBASE_APP_ID:"1:483702062341:web:b1ff06ad175cb7ae428b6c",VITE_FIREBASE_AUTH_DOMAIN:"voda-c6abd.firebaseapp.com",VITE_FIREBASE_AUTH_EMULATOR_URL:"http://localhost:9099",VITE_FIREBASE_FIRESTORE_EMULATOR_HOST:"localhost:8080",VITE_FIREBASE_FUNCTIONS_EMULATOR_HOST:"localhost:5001",VITE_FIREBASE_MEASUREMENT_ID:"G-CV6QGH7G7P",VITE_FIREBASE_MESSAGING_SENDER_ID:"483702062341",VITE_FIREBASE_PROJECT_ID:"voda-c6abd",VITE_FIREBASE_STORAGE_BUCKET:"voda-c6abd.appspot.com",VITE_FORCE_HASH_ROUTER:"true",VITE_SHOP_ID:"demo-shop-001",VITE_SHOP_NAME:"محل كاشي لينك التجريبي",VITE_SHOW_ENV_BANNER:"true",VITE_USE_EMULATORS:"false",VITE_USE_FIREBASE_EMULATOR:"false"},tr=i=>typeof i=="string"&&i.trim().length>0,qx={getCurrentMonthId(){const i=new Date;return`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}`},async getWalletUsage(i){var f;try{if(!tr(i))return console.error("Error getting wallet usage: invalid walletId",i),null;const d=$e(U,"walletLimits",i),j=await Ws(d);if(j.exists()){const I=j.data();return{walletId:i,used_transfer:I.monthlyTransferUsed??I.used_transfer??0,used_withdraw:I.monthlyWithdrawUsed??I.used_withdraw??0,monthly_limit:I.monthlyLimit??I.monthlyTransferLimit??I.monthlyWithdrawLimit??2e5,last_reset:I.lastMonthlyReset??I.last_reset??null,updatedAt:I.updatedAt||Sr.now()}}const S={walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:Sr.now()};return await Ps(d,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,monthlyTransferLimit:2e5,monthlyWithdrawLimit:2e5,lastMonthlyReset:null,updatedAt:gt(),ownerId:(f=Hr.currentUser)==null?void 0:f.uid}),S}catch(d){return console.error("Error getting wallet usage:",d),{walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:Sr.now()}}},shouldResetLimits(i){const f=new Date,d=f.getDate();if(!i)return d===1;if(d===1){const j=i.toDate(),S=f.getMonth(),I=f.getFullYear();return j.getMonth()!==S||j.getFullYear()!==I}return!1},async autoResetLimitsIfNeeded(i){try{if(!tr(i))return console.error("خطأ في التصفير التلقائي للحدود: walletId غير صالح",i),!1;typeof import.meta<"u";const f=await this.getWalletUsage(i);return f&&this.shouldResetLimits(f.last_reset)?(console.log(`🔄 تصفير تلقائي للحدود للمحفظة ${i} - اليوم الأول من الشهر`),await this.resetWalletUsage(i)):!1}catch(f){return console.error("خطأ في التصفير التلقائي للحدود:",f),!1}},async resetWalletUsage(i){try{if(!tr(i))return console.error("خطأ في تصفير استخدام المحفظة: walletId غير صالح",i),!1;const f=$e(U,"walletLimits",i);return await Ps(f,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:gt(),updatedAt:gt()},{merge:!0}),console.log(`🔄 تم تصفير استخدام المحفظة ${i} بنجاح`),!0}catch(f){return console.error("خطأ في تصفير استخدام المحفظة:",f),!1}},async calculateUsageFromTransactions(i){var f,d;try{if(!tr(i))return console.error("خطأ في حساب الاستخدام من المعاملات: walletId غير صالح",i),{used_transfer:0,used_withdraw:0};const j=$e(U,"walletLimits",i),S=new Date;let I=Sr.fromDate(new Date(S.getFullYear(),S.getMonth(),1));try{const $=await Ws(j);I=$.exists()?((f=$.data())==null?void 0:f.lastMonthlyReset)??((d=$.data())==null?void 0:d.last_reset)??I:I}catch{}const s=Je(ye(U,"tx"),le("uid","==",i),...I?[le("createdAt",">=",I)]:[]),v=await Ue(s);let W=0,D=0;return v.forEach($=>{const M=$.data();M.status==="completed"&&(M.type==="transfer"?W+=M.amount:M.type==="withdraw"&&(D+=M.amount))}),{used_transfer:W,used_withdraw:D}}catch(j){return console.error("خطأ في حساب الاستخدام من المعاملات:",j),{used_transfer:0,used_withdraw:0}}},async getWalletUsageWithRefresh(i){var f,d;try{if(!tr(i))return console.error("خطأ في الحصول على الاستخدام مع التحديث: walletId غير صالح",i),null;typeof import.meta<"u";const j=await this.getWalletUsage(i);if(!j){const I=await this.calculateUsageFromTransactions(i),s=$e(U,"walletLimits",i);try{await Ps(s,{monthlyTransferUsed:I.used_transfer,monthlyWithdrawUsed:I.used_withdraw,updatedAt:gt(),ownerId:(f=Hr.currentUser)==null?void 0:f.uid},{merge:!0})}catch{}return{walletId:i,used_transfer:I.used_transfer,used_withdraw:I.used_withdraw,monthly_limit:2e5,last_reset:null,updatedAt:Sr.now()}}const S=await this.calculateUsageFromTransactions(i);if(j.used_transfer!==S.used_transfer||j.used_withdraw!==S.used_withdraw){const I=$e(U,"walletLimits",i);try{await Ps(I,{monthlyTransferUsed:S.used_transfer,monthlyWithdrawUsed:S.used_withdraw,updatedAt:gt(),ownerId:(d=Hr.currentUser)==null?void 0:d.uid},{merge:!0})}catch{}return await this.getWalletUsage(i)}return j}catch(j){return console.error("خطأ في الحصول على الاستخدام مع التحديث:",j),{walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:Sr.now()}}},calculateRemaining(i){return{remainingTransfer:Math.max(0,i.monthly_limit-i.used_transfer),remainingWithdraw:Math.max(0,i.monthly_limit-i.used_withdraw)}},async canPerformOperation(i,f,d){try{if(!tr(i))return console.error("Error checking operation limits: invalid walletId",i),{canPerform:!1,message:"walletId غير صالح"};const j=await this.getWalletUsageWithRefresh(i);if(!j)return{canPerform:!1,message:"لا يمكن العثور على بيانات الاستخدام للمحفظة"};const S=this.calculateRemaining(j);return d==="transfer"&&f>S.remainingTransfer?{canPerform:!1,message:`تجاوز حد التحويل المسموح. المتبقي: ${S.remainingTransfer.toLocaleString()} ج.م من أصل ${j.monthly_limit.toLocaleString()} ج.م`,remaining:S.remainingTransfer}:d==="withdraw"&&f>S.remainingWithdraw?{canPerform:!1,message:`تجاوز حد السحب المسموح. المتبقي: ${S.remainingWithdraw.toLocaleString()} ج.م من أصل ${j.monthly_limit.toLocaleString()} ج.م`,remaining:S.remainingWithdraw}:{canPerform:!0}}catch(j){return console.error("Error checking operation limits:",j),{canPerform:!1,message:"خطأ في التحقق من الحدود"}}},async updateUsage(i,f,d){var j;try{if(!tr(i))throw new Error("walletId غير صالح");const S=await this.getWalletUsageWithRefresh(i);if(!S)throw new Error("لا يمكن العثور على بيانات الاستخدام للمحفظة");const I=await this.canPerformOperation(i,f,d);if(!I.canPerform)throw new Error(I.message||"لا يمكن إجراء العملية");const s=d==="transfer"?S.used_transfer+f:S.used_transfer,v=d==="withdraw"?S.used_withdraw+f:S.used_withdraw,W=$e(U,"walletLimits",S.walletId);try{await Ps(W,{monthlyTransferUsed:s,monthlyWithdrawUsed:v,updatedAt:gt(),ownerId:(j=Hr.currentUser)==null?void 0:j.uid},{merge:!0})}catch{}let D=await this.getWalletUsageWithRefresh(i);return D||(D={walletId:i,used_transfer:s,used_withdraw:v,monthly_limit:S.monthly_limit,last_reset:S.last_reset,updatedAt:Sr.now()}),D}catch(S){throw console.error("Error updating wallet usage:",S),S}},async resetWalletUsageManually(i){try{if(!tr(i))throw new Error("walletId غير صالح");const f=$e(U,"walletLimits",i),d={walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:0,last_reset:null,updatedAt:new Date};return Ps(f,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:gt(),updatedAt:gt()},{merge:!0}).catch(j=>{console.error("خطأ في حفظ تصفير الاستخدام في Firebase:",j)}),console.log(`✅ تم تصفير استخدام المحفظة ${i} بنجاح`),d}catch(f){throw console.error("Error resetting wallet usage:",f),f}},async getAllWalletsUsage(i){try{const d=(await ga.getByMerchantId(i)).map(S=>this.getWalletUsageWithRefresh(S.id));return(await Promise.all(d)).filter(S=>S!==null)}catch(f){return console.error("Error getting all wallets usage:",f),[]}}};function zx(i){return i?`readBroadcastIds_${i}`:"readBroadcastIds_guest"}function Vx({className:i}){const{user:f,profile:d,isSubscriptionActive:j}=_a(),S=Dd(),[I,s]=n.useState([]),[v,W]=n.useState(new Set),[D,$]=n.useState(!1),[M,y]=n.useState(""),[N,O]=n.useState(!1),[H,L]=n.useState(null),[Y,te]=n.useState("none"),[me,E]=n.useState(null),[F,re]=n.useState(!1),_e=n.useRef(new Set);n.useRef(!1);const Ne=n.useRef(!0),de=n.useRef(null),ae=n.useRef(null),Le=n.useRef(null),[Qe,ze]=n.useState({position:"fixed",top:0,left:0,zIndex:1e4}),Ke=n.useMemo(()=>{const pe=["global"];return f!=null&&f.uid&&pe.push(`user:${f.uid}`),d!=null&&d.shopId&&pe.push(`shop:${d.shopId}`),pe},[f==null?void 0:f.uid,d==null?void 0:d.shopId]),mt=zx(f==null?void 0:f.uid),Et=n.useMemo(()=>{var Oe;const pe=(Oe=S==null?void 0:S.pathname)==null?void 0:Oe.includes("/user/pending-approval");return!!(f!=null&&f.uid)&&!pe},[f==null?void 0:f.uid,S==null?void 0:S.pathname]);n.useEffect(()=>{try{const pe=localStorage.getItem(mt);if(pe){const Me=JSON.parse(pe);Array.isArray(Me)&&W(new Set(Me.filter(Boolean)))}else W(new Set)}catch(pe){console.warn("Failed to load read ids",pe),W(new Set)}},[mt]),n.useEffect(()=>{if(!Et){s([]);return}Ne.current=!0;const pe=()=>{nx(Ke,Oe=>{if(Ne.current){const rt=Date.now(),Se=60*1e3,Ze=Oe.filter(We=>{var Z,ht;const Ie=(Z=We.createdAt)!=null&&Z.toMillis?We.createdAt.toMillis():(ht=We.createdAt)!=null&&ht.seconds?We.createdAt.seconds*1e3:0;return!(rt-Ie<Se)}).map(We=>We.id).filter(Boolean);_e.current=new Set(Ze),Ne.current=!1}s(Oe)})};pe();const Me=Oe=>{console.log("🔔 OneSignal Notification received",Oe);try{const rt=Oe.notification||Oe;if(rt&&(rt.title||rt.body)){const Se={id:`temp_${Date.now()}`,title:rt.title||"إشعار جديد",message:rt.body||rt.message||"",audienceKey:"global",active:!0,createdAt:{toMillis:()=>Date.now(),seconds:Math.floor(Date.now()/1e3),nanoseconds:0}};E(Se),re(!0),de.current&&clearTimeout(de.current),de.current=window.setTimeout(()=>{re(!1),E(null)},5e3)}}catch(rt){console.error("Error parsing OneSignal event for instant alert",rt)}pe()};try{const Oe=window.OneSignal;Oe&&Oe.Notifications&&Oe.Notifications.addEventListener&&Oe.Notifications.addEventListener("foregroundWillDisplay",Me)}catch(Oe){console.error("Failed to add OneSignal listener",Oe)}return()=>{try{const Oe=window.OneSignal;Oe&&Oe.Notifications&&Oe.Notifications.removeEventListener&&Oe.Notifications.removeEventListener("foregroundWillDisplay",Me)}catch{}}},[Ke,Et]),n.useEffect(()=>{const pe=new Set(I.map(Oe=>Oe.id).filter(Boolean)),Me=I.filter(Oe=>Oe.id&&!_e.current.has(Oe.id));Me.length>0&&(E(Me[0]),re(!0),de.current&&clearTimeout(de.current),de.current=window.setTimeout(()=>{re(!1),E(null)},5e3)),_e.current=pe},[I]),n.useEffect(()=>()=>{de.current&&clearTimeout(de.current)},[]);const ee=I.reduce((pe,Me)=>pe+(Me.id&&!v.has(Me.id)?1:0),0),Ae=pe=>{if(!pe||v.has(pe))return;const Me=new Set(v);Me.add(pe),W(Me);try{localStorage.setItem(mt,JSON.stringify(Array.from(Me)))}catch{}},st=()=>{const pe=I.map(Oe=>Oe.id).filter(Boolean),Me=new Set(v);pe.forEach(Oe=>Me.add(Oe)),W(Me);try{localStorage.setItem(mt,JSON.stringify(Array.from(Me)))}catch{}},St=(pe,Me)=>{var Oe;if(pe)try{const rt=((Oe=Wi)==null?void 0:Oe.isNativePlatform)&&Wi.getPlatform()==="android",Se=/\.apk(\?|$)/i.test(pe);if(rt&&Se){const Ze=`cashy://update?url=${encodeURIComponent(pe)}`;window.location.href=Ze}else window.open(pe,"_blank")}catch{try{window.open(pe,"_blank")}catch{}}Me&&Ae(Me)},Tt=()=>{if(!ae.current||!Le.current)return;const pe=ae.current.getBoundingClientRect(),Me=8,Oe=Le.current.offsetWidth||320,rt=pe.bottom+Me;let Se=pe.right-Oe;const Ze=window.innerWidth;Se=Math.min(Math.max(Se,Me),Ze-Oe-Me),ze(We=>({...We,top:rt,left:Se}))};return n.useEffect(()=>{if(!F)return;Tt();const pe=()=>Tt();return window.addEventListener("resize",pe),window.addEventListener("scroll",pe,!0),()=>{window.removeEventListener("resize",pe),window.removeEventListener("scroll",pe,!0)}},[F]),n.useEffect(()=>{if(!(f!=null&&f.uid)){te("none");return}(async()=>{try{const Me=Je(ye(U,"waiting_list"),le("userId","==",f.uid)),rt=(await Ue(Me)).docs.map(We=>({id:We.id,...We.data()})).sort((We,Ie)=>{var ht,Jt,Kt,B,ge,Fe;const He=((Jt=(ht=We==null?void 0:We.createdAt)==null?void 0:ht.toMillis)==null?void 0:Jt.call(ht))??((Kt=We==null?void 0:We.createdAt)==null?void 0:Kt.seconds)*1e3??0;return(((ge=(B=Ie==null?void 0:Ie.createdAt)==null?void 0:B.toMillis)==null?void 0:ge.call(B))??((Fe=Ie==null?void 0:Ie.createdAt)==null?void 0:Fe.seconds)*1e3??0)-He});if(rt.length===0){te("none");return}const Se=rt[0],Ze=(Se==null?void 0:Se.contacted)===!0||(Se==null?void 0:Se.status)==="contacted";te(Ze?"contacted":"pending")}catch(Me){console.warn("⚠️ فشل جلب حالة waiting_list:",Me),te("none")}})()},[f==null?void 0:f.uid]),Et?e.jsxs("div",{className:`relative inline-flex items-center gap-2 ${i||""}`,ref:ae,children:[e.jsxs(ix,{onOpenChange:pe=>{pe&&ee>0&&st()},children:[e.jsx(lx,{asChild:!0,children:e.jsx(x,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:e.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[e.jsx(mo,{className:"h-4 w-4 text-primary"}),ee>0&&e.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:ee})]})})}),e.jsxs(ox,{className:"w-80",align:"end",forceMount:!0,children:[e.jsxs(cx,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"الإشعارات"}),I.length>0&&e.jsxs(x,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:st,children:[e.jsx(Zr,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),e.jsx(dx,{}),I.length===0?e.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):e.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:I.map(pe=>{const Me=pe.id?!v.has(pe.id):!1;return e.jsx("div",{className:`px-2 py-2 rounded-md ${Me?"bg-primary/5":""}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(mo,{className:`h-4 w-4 ${Me?"text-primary":"text-muted-foreground"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium",children:pe.title||"إشعار"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:pe.message}),pe.linkUrl&&e.jsxs(x,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>St(pe.linkUrl,pe.id),children:["فتح الرابط ",e.jsx(rx,{className:"h-3 w-3 ml-1"})]})]}),Me?e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Ae(pe.id),title:"تمييز كمقروء",children:e.jsx(Zr,{className:"h-4 w-4 text-primary"})}):e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:e.jsx(Zr,{className:"h-4 w-4 text-muted-foreground"})})]})},pe.id)})})]})]}),me&&gu.createPortal(e.jsx("div",{ref:Le,style:Qe,className:`pointer-events-auto transition-all duration-300 ${F?"opacity-100 translate-y-0":"opacity-0 -translate-y-3"}`,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl border border-gray-200 p-4 w-80 max-w-[calc(100vw-16px)] flex items-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(mo,{className:"w-4 h-4 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-semibold",children:me.title||"إشعار جديد"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:me.message}),me.linkUrl&&e.jsx(x,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>St(me.linkUrl,me.id),children:"فتح الرابط"})]})]})}),document.body)]}):null}function Jx({isOpen:i,onClose:f}){const[d,j]=n.useState("0"),[S,I]=n.useState(null),[s,v]=n.useState(null),[W,D]=n.useState(!1),$=E=>{W?(j(E),D(!1)):j(d==="0"?E:d+E)},M=E=>{const F=parseFloat(d);if(S===null)I(F);else if(s){const _e=y(S||0,F,s);j(String(_e)),I(_e)}D(!0),v(E)},y=(E,F,re)=>{switch(re){case"+":return E+F;case"-":return E-F;case"×":return E*F;case"÷":return F===0?0:E/F;case"=":return F;default:return F}},N=()=>{const E=parseFloat(d);if(S!==null&&s){const F=y(S,E,s);j(String(F)),I(null),v(null),D(!0)}},O=()=>{j("0"),I(null),v(null),D(!1)},H=()=>{j("0")},L=()=>{W?(j("0."),D(!1)):d.indexOf(".")===-1&&j(d+".")},Y=()=>{d!=="0"&&j(d.charAt(0)==="-"?d.slice(1):"-"+d)},te=()=>{const E=parseFloat(d);j(String(E/100))},me=E=>{const F=E.key;E.preventDefault(),F>="0"&&F<="9"?$(F):F==="+"?M("+"):F==="-"?M("-"):F==="*"?M("×"):F==="/"?M("÷"):F==="Enter"||F==="="?N():F==="Escape"||F==="c"||F==="C"?O():F==="Backspace"?H():F==="."?L():F==="%"&&te()};return n.useEffect(()=>(i?document.addEventListener("keydown",me):document.removeEventListener("keydown",me),()=>{document.removeEventListener("keydown",me)}),[i,d,S,s,W]),e.jsx(be,{open:i,onOpenChange:E=>!E&&f(),children:e.jsxs(ve,{className:"sm:max-w-md",children:[e.jsx(De,{children:e.jsxs(we,{className:"flex items-center gap-2 text-right",children:[e.jsx(Md,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:d})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:O,children:"AC"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:H,children:"CE"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:te,children:"%"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>M("÷"),children:"÷"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>$("7"),children:"7"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>$("8"),children:"8"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>$("9"),children:"9"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>M("×"),children:"×"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>$("4"),children:"4"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>$("5"),children:"5"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>$("6"),children:"6"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>M("-"),children:"-"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>$("1"),children:"1"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>$("2"),children:"2"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>$("3"),children:"3"}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>M("+"),children:"+"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>$("0"),children:"0"}),e.jsx(x,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:L,children:"."}),e.jsx(x,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:N,children:"="})]}),e.jsx(x,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:Y,children:"+/-"})]})]})})}function Kx({isOpen:i,onClose:f,initialBarcode:d}){const[j,S]=n.useState([]),[I,s]=n.useState({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),[v,W]=n.useState(!1),[D,$]=n.useState(null),{toast:M}=da(),{user:y,profile:N}=_a(),{isShiftActive:O,shiftUser:H}=Yn(),{shopId:L}=qi(),[Y,te]=n.useState([]),[me,E]=n.useState({}),[F,re]=n.useState({}),[_e,Ne]=n.useState({}),[de,ae]=n.useState(""),[Le,Qe]=n.useState(!1),[ze,Ke]=n.useState({}),[mt,Et]=n.useState(!1),[ee,Ae]=n.useState(!0),[st,St]=n.useState(!1),Tt=Ye.useRef(""),pe=Ye.useRef(0),[Me,Oe]=n.useState(0),[rt,Se]=n.useState(0),[Ze,We]=n.useState(!1),[Ie,He]=n.useState(!1),[Z,ht]=n.useState(!0),[Jt,Kt]=n.useState(!1),[B,ge]=n.useState(!1),[Fe,kt]=n.useState(!0),[vt,_t]=n.useState(!0),[ps,Dt]=n.useState({}),[dt,Mt]=n.useState(!1),[xs,Ot]=n.useState("التحقق قبل العملية"),[Fs,ta]=n.useState("أدخل الرقم السري الرئيسي للمتابعة"),wa=Ye.useRef(null),gs=(c,T,P)=>{Ot(c),ta(T),wa.current=P,Mt(!0)},[Va,sa]=n.useState([]),[Ks,k]=n.useState(!1),[ne,Ee]=n.useState(""),[Xe,Be]=n.useState(""),[ct,Q]=n.useState(""),[ut,ft]=n.useState(null);n.useEffect(()=>{(async()=>{try{if(!i||!(y!=null&&y.uid))return;const c=await Ce.getUserData(y.uid),T=Array.isArray(c==null?void 0:c.customers)?c.customers.map(P=>({id:String(P.id||""),name:String(P.name||""),mobile:P.mobile||void 0})):[];sa(T)}catch{}})()},[i,y==null?void 0:y.uid]);const[fs,ls]=n.useState(!1),[os,J]=n.useState(null),[cs,oa]=n.useState(null),Na=(c,T)=>{J(c),oa(T),ls(!0)},[ma,ja]=n.useState(""),Sa=n.useMemo(()=>{const c=ma.trim().toLowerCase();return c?Y.filter(T=>T.name.toLowerCase().includes(c)):Y},[Y,ma]),[V,ke]=n.useState(!1),[nt,Nt]=n.useState(null),[_s,Ds]=n.useState("1"),Qt=c=>{Nt(c),Ds("1"),ke(!0)},Us=()=>{if(!nt)return;const c=parseInt(_s);c>0&&(ke(!1),gs("إضافة مخزون",`إضافة ${c} قطع للمنتج ${nt.name}`,async()=>{try{const T=nt.quantity+c;await Xt($e(U,"products",nt.id),{quantity:T,updatedAt:gt()}),te(P=>P.map(K=>K.id===nt.id?{...K,quantity:T}:K)),M({title:"تمت الإضافة",description:`تمت إضافة ${c} قطعة`})}catch(T){console.error(T)}}))};n.useEffect(()=>{i&&(y!=null&&y.uid)&&(tt(),Z||Ka())},[i,y==null?void 0:y.uid,Z]),n.useEffect(()=>{if(!i)return;const c=T=>{var se;const P=T.target,K=(se=P==null?void 0:P.tagName)==null?void 0:se.toLowerCase();if(K==="input"||K==="textarea"||!!(P&&P.isContentEditable)||dt||Ie||st)return;const ce=Date.now();if(T.key==="Enter"){const Te=(Tt.current||"").trim();Tt.current="",Te&&hr(Te);return}T.key.length===1&&(ce-(pe.current||0)>100&&(Tt.current=""),Tt.current+=T.key,pe.current=ce)};return window.addEventListener("keydown",c),()=>window.removeEventListener("keydown",c)},[i,Y,dt,Ie,st]),n.useEffect(()=>{i&&d&&hr(d)},[i,d]);const Ja=async()=>{if(!(y!=null&&y.uid))return;const c=(N==null?void 0:N.shopId)||L||"main",T=`shopProducts_${y.uid}_${c}`;try{const P=localStorage.getItem(T);if(P){const K=JSON.parse(P);Array.isArray(K)&&K.length>0&&te(K)}}catch(P){console.warn("Failed to load products from cache",P)}try{let P,K=[];if(N!=null&&N.shopId){const ue=Je(ye(U,"products"),le("shopId","==",N.shopId),le("userId","==",y.uid));if(P=await Ue(ue),K=P.docs.map(ce=>({id:ce.id,name:String(ce.data().name??""),sellingPrice:Number(ce.data().sellingPrice??0),wholesalePrice:Number(ce.data().wholesalePrice??0),quantity:Number(ce.data().quantity??0),barcode:String(ce.data().barcode??""),serialNumber:String(ce.data().serialNumber??"")})),K.length===0){const ce=Je(ye(U,"products"),le("userId","==",y.uid)),Te=(await Ue(ce)).docs.map(ie=>({id:ie.id,name:String(ie.data().name??""),sellingPrice:Number(ie.data().sellingPrice??0),wholesalePrice:Number(ie.data().wholesalePrice??0),quantity:Number(ie.data().quantity??0),barcode:String(ie.data().barcode??""),serialNumber:String(ie.data().serialNumber??"")}));Te.length>0&&(K=Te,M({title:"تم استرجاع المنتجات",description:"عثرنا على منتجات محفوظة لك خارج المتجر الحالي وقمنا بعرضها."}))}}else{const ue=Je(ye(U,"products"),le("userId","==",y.uid));P=await Ue(ue),K=P.docs.map(ce=>({id:ce.id,name:String(ce.data().name??""),sellingPrice:Number(ce.data().sellingPrice??0),wholesalePrice:Number(ce.data().wholesalePrice??0),quantity:Number(ce.data().quantity??0),barcode:String(ce.data().barcode??""),serialNumber:String(ce.data().serialNumber??"")}))}te(K);try{localStorage.setItem(T,JSON.stringify(K))}catch{}if(N!=null&&N.shopId&&K.length>0){const ue=K.filter(ce=>{const se=((P==null?void 0:P.docs)||[]).find(ie=>ie.id===ce.id);return!(!!se&&!!se.data().shopId)});if(ue.length>0)try{await Promise.all(ue.map(ce=>Xt($e(U,"products",ce.id),{shopId:N.shopId,updatedAt:gt()}))),M({title:"تم ترتيب المنتجات",description:"تم ربط بعض المنتجات غير المربوطة بمتجرك الحالي تلقائياً."})}catch(ce){console.warn("تعذّر ترحيل shopId لبعض المنتجات:",ce)}}}catch(P){console.error("Error loading shop products:",P)}};n.useEffect(()=>{i&&(y!=null&&y.uid)&&(Ja(),Ka(),tt(),mr())},[i,y==null?void 0:y.uid,N==null?void 0:N.shopId]);const ha=()=>{const c=new Date,T=c.getFullYear(),P=String(c.getMonth()+1).padStart(2,"0"),K=String(c.getDate()).padStart(2,"0");return`${T}-${P}-${K}`},Da=c=>{const T=P=>{if(typeof P.createdAtMs=="number")return P.createdAtMs;const K=parseInt(P.id,10);if(!isNaN(K))return K;const ue=new Date(P.date);return isNaN(ue.getTime())?0:ue.getTime()};return[...c].sort((P,K)=>T(K)-T(P))},tt=()=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot load sales data");return}const c=L||(N==null?void 0:N.shopId)||"main",T=`salesData_all_${y.uid}_${c}`,P=localStorage.getItem(T);if(P)try{const Re=JSON.parse(P);S(Array.isArray(Re)?Da(Re):[]);return}catch{}const K=ha(),ue=`salesData_${y.uid}_${c}_${K}`,ce=localStorage.getItem(ue);if(ce){const Re=JSON.parse(ce),je=Array.isArray(Re)?Da(Re):[];S(je);try{localStorage.setItem(T,JSON.stringify(je))}catch{}return}const se=new Date().toISOString().split("T")[0],Te=`salesData_${y.uid}_${c}_${se}`,ie=localStorage.getItem(Te);if(ie){const Re=JSON.parse(ie),je=Array.isArray(Re)?Da(Re):[];S(je);try{localStorage.setItem(ue,JSON.stringify(je)),localStorage.setItem(T,JSON.stringify(je))}catch{}return}Cr()},$t=c=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot save sales data");return}const T=L||(N==null?void 0:N.shopId)||"main",P=ha(),K=`salesData_${y.uid}_${T}_${P}`,ue=`salesData_all_${y.uid}_${T}`,ce=Da(c);localStorage.setItem(K,JSON.stringify(ce));try{const se=localStorage.getItem(ue),Te=se?JSON.parse(se):[],ie={};[...Array.isArray(Te)?Te:[],...ce].forEach(jt=>{ie[jt.id]=jt});const Re=Object.values(ie),je=Da(Re);localStorage.setItem(ue,JSON.stringify(je))}catch{}S(ce)},qs=c=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot save sales data");return}const T=L||(N==null?void 0:N.shopId)||"main",P=`salesData_all_${y.uid}_${T}`;try{const ue=localStorage.getItem(P),ce=ue?JSON.parse(ue):[],se={};[...Array.isArray(ce)?ce:[],...c].forEach(Re=>{se[Re.id]=Re});const Te=Object.values(se),ie=Da(Te);localStorage.setItem(P,JSON.stringify(ie))}catch{}const K=Da(c);S(K)},Cr=async()=>{if(y!=null&&y.uid)try{const c=L||(N==null?void 0:N.shopId)||null,T=new Date().toISOString().split("T")[0],P=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date);let K,ue;try{const Re=Je(ye(U,"dailySales"),le("userId","==",y.uid),...c?[le("shopId","==",c)]:[]);K=await Ue(Re)}catch{}try{const Re=Je(ye(U,"users",y.uid,"dailySales"),...c?[le("shopId","==",c)]:[]);ue=await Ue(Re)}catch{}const se=[...K?K.docs:[],...ue?ue.docs:[]].map(Re=>{var jt,Lt;const je=Re.data();return{id:String(je.clientId||Re.id),firestoreId:Re.id,productName:String(je.productName||""),price:Number(je.sellingPrice||0),wholesalePrice:je.wholesalePrice!==void 0?Number(je.wholesalePrice):null,quantity:Number(je.quantity||0),date:String(je.date||T),time:String(je.time||""),serialNumber:je.serialNumber||void 0,barcode:je.barcode||void 0,performedByType:je.performedByType||void 0,performedByName:je.performedByName||void 0,performedByUsername:je.performedByUsername||void 0,isDeferred:!!je.isDeferred,customerName:je.customerName||void 0,customerMobile:je.customerMobile||void 0,customerId:je.customerId||void 0,createdAtMs:(Lt=(jt=je==null?void 0:je.createdAt)==null?void 0:jt.toDate)!=null&&Lt.call(jt)?je.createdAt.toDate().getTime():new Date(String(je.date||T)).getTime()}}),Te={};[...j,...se].forEach(Re=>{Te[Re.id]=Re});const ie=Object.values(Te);qs(ie)}catch{}},Ka=async()=>{if(y!=null&&y.uid)try{const c=new Date,T=new Date(c.getFullYear(),c.getMonth(),1),P=new Date(c.getFullYear(),c.getMonth()+1,0),K=je=>je.toISOString().split("T")[0],ue=K(T),ce=K(P),se=L||(N==null?void 0:N.shopId)||null;let Te;try{const je=Je(ye(U,"dailySales"),le("userId","==",y.uid),...se?[le("shopId","==",se)]:[]);Te=await Ue(je)}catch{const je=Je(ye(U,"users",y.uid,"dailySales"),...se?[le("shopId","==",se)]:[]);Te=await Ue(je)}let ie=0,Re=0;Te.forEach(je=>{const jt=je.data(),Lt=String(jt.date??"").slice(0,10);if(!jt.isDeferred&&Lt>=ue&&Lt<=ce){const bs=Number(jt.sellingPrice??0),Rt=Number(jt.quantity??0),Ys=Number(jt.profit??(Number(jt.sellingPrice??0)-Number(jt.wholesalePrice??0))*Rt);ie+=bs*Rt,Re+=Ys}}),Oe(ie),Se(Re)}catch(c){console.error("Error loading monthly stats:",c)}},Ar=async c=>{if(!(y!=null&&y.uid))return null;try{const T=((c.price??0)-(c.wholesalePrice??0))*(c.quantity??0),P=O&&H?"cashier":"admin",K=P==="cashier"?(H==null?void 0:H.name)||"كاشير":(N==null?void 0:N.fullName)||(y==null?void 0:y.displayName)||"الحساب الرئيسي",ue=P==="cashier"&&(H==null?void 0:H.username)||null,ce=await ka(ye(U,"dailySales"),{userId:y.uid,clientId:c.id,productName:c.productName,quantity:c.quantity,wholesalePrice:c.wholesalePrice??null,sellingPrice:c.price,profit:T,date:c.date,time:c.time,performedByType:P,performedByName:K,performedByUsername:ue,serialNumber:c.serialNumber??null,barcode:c.barcode??null,isDeferred:!!c.isDeferred,customerName:c.customerName||null,customerMobile:c.customerMobile||null,customerId:c.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:L?{shopId:L}:{},createdAt:gt()});try{await Ps($e(U,"users",y.uid,"dailySales",ce.id),{userId:y.uid,clientId:c.id,productName:c.productName,quantity:c.quantity,wholesalePrice:c.wholesalePrice??null,sellingPrice:c.price,profit:T,date:c.date,time:c.time,performedByType:P,performedByName:K,performedByUsername:ue,serialNumber:c.serialNumber??null,barcode:c.barcode??null,isDeferred:!!c.isDeferred,customerName:c.customerName||null,customerMobile:c.customerMobile||null,customerId:c.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:L?{shopId:L}:{},createdAt:gt()})}catch{}return ce.id}catch{try{const T=await ka(ye(U,"users",y.uid,"dailySales"),{userId:y.uid,clientId:c.id,productName:c.productName,quantity:c.quantity,wholesalePrice:c.wholesalePrice??null,sellingPrice:c.price,profit,date:c.date,time:c.time,performedByType,performedByName,performedByUsername,serialNumber:c.serialNumber??null,barcode:c.barcode??null,isDeferred:!!c.isDeferred,customerName:c.customerName||null,customerMobile:c.customerMobile||null,customerId:c.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:L?{shopId:L}:{},createdAt:gt()});try{await Ps($e(U,"dailySales",T.id),{userId:y.uid,clientId:c.id,productName:c.productName,quantity:c.quantity,wholesalePrice:c.wholesalePrice??null,sellingPrice:c.price,profit,date:c.date,time:c.time,performedByType,performedByName,performedByUsername,serialNumber:c.serialNumber??null,barcode:c.barcode??null,isDeferred:!!c.isDeferred,customerName:c.customerName||null,customerMobile:c.customerMobile||null,customerId:c.customerId||null,...N!=null&&N.shopId?{shopId:N.shopId}:L?{shopId:L}:{},createdAt:gt()})}catch{}return T.id}catch(T){return console.error("Error saving sale:",T),null}}},en=()=>{const c=L||(N==null?void 0:N.shopId)||"main";return`cashBalance_${(y==null?void 0:y.uid)||"default"}_${c}`},tn=async(c,T)=>{if(y!=null&&y.uid)try{const P=$e(U,"dailySales",c);await Xt(P,T)}catch{try{const P=$e(U,"users",y.uid,"dailySales",c);await Xt(P,T)}catch(P){console.error("Error updating sale:",P)}}},sn=async c=>{try{const T=c.firestoreId;if(T)await tn(T,{isDeferred:!1});else try{const P=Je(ye(U,"dailySales"),le("userId","==",(y==null?void 0:y.uid)||""),le("date","==",c.date),le("productName","==",c.productName),Yr(5)),ue=(await Ue(P)).docs[0];ue&&await Xt(ue.ref,{isDeferred:!1})}catch{}S(P=>P.map(K=>K.id===c.id?{...K,isDeferred:!1}:K));try{await Ka()}catch{}M({title:"تم التسديد",description:`تم تسديد أجل ${c.productName}`})}catch(T){console.error("Error marking deferred sale as paid:",T),M({title:"فشل التسديد",description:"تعذّر تحديث حالة البيع المؤجّل",variant:"destructive"})}},mr=async()=>{if(!(y!=null&&y.uid))return;const c=j.filter(T=>!T.firestoreId);if(c.length!==0)for(const T of c)try{let P;try{const ue=Je(ye(U,"dailySales"),le("userId","==",y.uid),le("clientId","==",T.id),Yr(1));P=await Ue(ue)}catch{const ue=Je(ye(U,"users",y.uid,"dailySales"),le("clientId","==",T.id),Yr(1));P=await Ue(ue)}if(!P.empty){const ue=P.docs[0].id,ce=j.map(se=>se.id===T.id?{...se,firestoreId:ue}:se);$t(ce);continue}const K=await Ar(T);if(K){const ue=j.map(ce=>ce.id===T.id?{...ce,firestoreId:K}:ce);$t(ue)}}catch{}},an=async c=>{try{if(y!=null&&y.uid)try{const ie=ye(U,"deficiencies"),Re=await ka(ie,{shopId:(N==null?void 0:N.shopId)||y.uid||"default-shop",name:c,quantity:1,status:"pending",createdAt:gt()});try{const je=`deficiencies_${(N==null?void 0:N.shopId)||(y==null?void 0:y.uid)||"default-shop"}`,jt=localStorage.getItem(je),Lt=jt?JSON.parse(jt):[],bs=Array.isArray(Lt)?Lt:[],Rt=bs.some(ds=>String((ds==null?void 0:ds.id)||"")===Re.id),Ys={id:Re.id,name:c,quantity:1,status:"pending",createdAt:new Date().toISOString()},Gt=Rt?bs:[...bs,Ys];localStorage.setItem(je,JSON.stringify(Gt))}catch{}M({title:"تمت الإضافة للنواقص",description:`المنتج ${c} نفد من المخزون وتمت إضافته للنواقص`});return}catch(ie){console.warn("Failed to add deficiency to Firestore, falling back to local storage:",ie)}const T=`deficiencies_${(N==null?void 0:N.shopId)||(y==null?void 0:y.uid)||"default-shop"}`,P=localStorage.getItem(T),K=P?JSON.parse(P):[],ue=Array.isArray(K)?K:[];if(ue.some(ie=>String((ie==null?void 0:ie.name)||"").trim()===c&&String((ie==null?void 0:ie.status)||"pending")==="pending"))return;const se={id:Date.now().toString(),name:c,quantity:1,status:"pending",createdAt:new Date().toISOString()},Te=[...ue,se];localStorage.setItem(T,JSON.stringify(Te)),M({title:"تمت الإضافة للنواقص",description:`المنتج ${c} نفد من المخزون وتمت إضافته للنواقص`})}catch(T){console.error("Error adding deficiency for out-of-stock:",T)}},Tr=async(c,T=!1,P)=>{const K=me[c.id]||"",ue=parseInt(K);if(isNaN(ue)||ue<=0){M({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(ue>c.quantity){M({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const ce=new Date,se=O&&H?"cashier":"admin",Te=se==="cashier"?(H==null?void 0:H.name)||"كاشير":(N==null?void 0:N.fullName)||(y==null?void 0:y.displayName)||"الحساب الرئيسي",ie=se==="cashier"&&(H==null?void 0:H.username)||null,Re=(c.serialNumber||"").trim(),je=ps[c.id]||"",jt=parseFloat(je),Lt=!isNaN(jt)&&jt>0?jt:c.sellingPrice,bs={id:Date.now().toString(),productName:c.name,price:Lt,wholesalePrice:c.wholesalePrice,quantity:ue,date:ce.toISOString().split("T")[0],time:ce.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),createdAtMs:ce.getTime(),performedByType:se,performedByName:Te,performedByUsername:ie,serialNumber:Re||void 0,barcode:c.barcode,isDeferred:T,customerName:P==null?void 0:P.name,customerMobile:P==null?void 0:P.mobile,customerId:P==null?void 0:P.id};try{const Rt=await Ar(bs),Ys=Rt?{...bs,firestoreId:Rt}:bs;$t([...j,Ys]);const Gt=c.quantity-ue;if(await Xt($e(U,"products",c.id),{quantity:Gt,updatedAt:gt()}),te(ds=>ds.map(Hs=>Hs.id===c.id?{...Hs,quantity:Gt}:Hs)),E(ds=>({...ds,[c.id]:""})),Dt(ds=>({...ds,[c.id]:""})),Gt===0&&an(c.name),!T)try{const ds=Lt*ue,Hs=en(),dn=localStorage.getItem(Hs),pr=(dn?parseFloat(dn):0)+ds;localStorage.setItem(Hs,pr.toString());const mn=`userData_${y==null?void 0:y.uid}`,Ma={cashBalance:pr,lastUpdated:new Date().toISOString()};localStorage.setItem(mn,JSON.stringify(Ma)),y!=null&&y.uid&&Ce.updateUserData(y.uid,Ma).catch(()=>{});const Or=(N==null?void 0:N.shopId)||L;if(Or)try{await Xt($e(U,"dashboardData",Or),{cashBalance:pr})}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:pr}}))}catch{}try{if(y!=null&&y.uid){const gr=`SALECASH-${y.uid}-${Date.now()}`,$a={txnType:"cash_addition",type:"cash_addition",amount:ds,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:gr,title:"إيصال إضافة نقدية",merchantUserId:y.uid,createdBy:y.uid,shopId:(N==null?void 0:N.shopId)||L||void 0,cashierName:Te,performedByType:se,performedByUsername:ie,createdAt:new Date};await Ce.saveUserTransaction(y.uid,$a)}}catch{}Oe(gr=>gr+ds);const hn=(Lt-(c.wholesalePrice||0))*ue;Se(gr=>gr+hn)}catch(ds){console.warn("تعذر تحديث رصيد الدرج النقدي بعد البيع:",ds)}M({title:"تم البيع",description:`تم بيع ${ue} قطعة من ${c.name}`})}catch(Rt){console.error("Error selling product:",Rt),M({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},kr=async c=>{if(y!=null&&y.uid){if(O){M({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف إيصالات البيع أثناء الورديه",variant:"destructive"});return}gs("تأكيد حذف إيصال بيع","أدخل الرقم السري الرئيسي لحذف الإيصال وعكس الآثار",async()=>{try{const T=ha(),P=`salesData_${y.uid}_${T}`,K=`salesData_all_${y.uid}`,ue=j.filter(se=>se.id!==c.id);try{localStorage.setItem(P,JSON.stringify(ue));const se=localStorage.getItem(K),Te=se?JSON.parse(se):[],ie=(Array.isArray(Te)?Te:[]).filter(Re=>(Re==null?void 0:Re.id)!==c.id);localStorage.setItem(K,JSON.stringify(ie))}catch{}S(ue);const ce=[];if(!c.isDeferred)try{const se=(c.price??0)*(c.quantity??0),Te=en(),ie=localStorage.getItem(Te),je=(ie?parseFloat(ie):0)-se;localStorage.setItem(Te,je.toString());const jt=`userData_${y==null?void 0:y.uid}`,Lt={cashBalance:je,lastUpdated:new Date().toISOString()};try{localStorage.setItem(jt,JSON.stringify(Lt))}catch{}y!=null&&y.uid&&ce.push(Ce.updateUserData(y.uid,Lt));const bs=(N==null?void 0:N.shopId)||L;bs&&ce.push(Xt($e(U,"dashboardData",bs),{cashBalance:je}).catch(()=>{}));try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:je}}))}catch{}const Rt=((c.price??0)-(c.wholesalePrice??0))*(c.quantity??0);Oe(Ys=>Ys-se),Se(Ys=>Ys-Rt)}catch(se){console.warn("تعذر عكس رصيد الدرج النقدي عند حذف الإيصال:",se)}try{const se=Y.find(Te=>c.barcode&&Te.barcode===c.barcode||Te.name===c.productName);if(se){const Te=(se.quantity||0)+(c.quantity||0);te(ie=>ie.map(Re=>Re.id===se.id?{...Re,quantity:Te}:Re)),ce.push(Xt($e(U,"products",se.id),{quantity:Te,updatedAt:gt()}))}}catch(se){console.warn("تعذر عكس المخزون عند حذف الإيصال:",se)}try{c.firestoreId?(ce.push(ya($e(U,"dailySales",c.firestoreId)).catch(()=>{})),ce.push(ya($e(U,"users",y.uid,"dailySales",c.firestoreId)).catch(()=>{}))):ce.push((async()=>{try{const se=Je(ye(U,"dailySales"),le("userId","==",y.uid),le("date","==",c.date),le("productName","==",c.productName),Yr(5));let Te=await Ue(se);if(Te.empty){const ie=Je(ye(U,"users",y.uid,"dailySales"),le("date","==",c.date),le("productName","==",c.productName),Yr(5));Te=await Ue(ie)}if(!Te.empty){const ie=Te.docs.find(Re=>{const je=Re.data();return Number((je==null?void 0:je.sellingPrice)??0)===Number(c.price??0)&&Number((je==null?void 0:je.quantity)??0)===Number(c.quantity??0)&&String((je==null?void 0:je.time)??"")===String(c.time??"")})||Te.docs[0];ie&&await ya(ie.ref)}}catch(se){console.warn("تعذر حذف سجل البيع من Firestore (استعلام بديل):",se)}})())}catch(se){console.warn("تعذر جدولة حذف سجل البيع من Firestore:",se)}try{Z||setTimeout(()=>{try{Ka()}catch{}},0)}catch{}try{await Promise.allSettled(ce)}catch{}M({title:"تم حذف الإيصال",description:`تم حذف إيصال بيع للمنتج ${c.productName} وتم عكس الآثار`})}catch(T){console.error("Error deleting sale:",T),M({title:"فشل حذف الإيصال",description:"تعذّر حذف إيصال البيع",variant:"destructive"})}})}},ys=async c=>{try{E(T=>({...T,[c.id]:"1"})),await Tr(c)}catch(T){console.error("Error selling by barcode:",T)}},Ya=async c=>{if(!(y!=null&&y.uid))return;if(O){M({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف المنتجات أثناء الورديه",variant:"destructive"});return}window.confirm(`هل تريد حذف المنتج "${c.name}"؟`)&&gs("تأكيد حذف منتج","لا يمكن حذف المنتجات إلا بإدخال الرقم السري الرئيسي",async()=>{try{await ya($e(U,"products",c.id)),te(P=>P.filter(K=>K.id!==c.id)),M({title:"تم الحذف",description:`تم حذف المنتج ${c.name}`})}catch(P){console.error("Error deleting product:",P),M({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}})},Ha=async()=>{try{if(!(y!=null&&y.uid)){M({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}if(O){M({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتجات أثناء الورديه",variant:"destructive"});return}const c=I.productName.trim(),T=parseFloat(I.price),P=parseFloat(I.wholesalePrice||"0"),K=parseInt(I.quantity);if(!c||isNaN(T)||isNaN(K)){M({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const ue={name:c,sellingPrice:T,wholesalePrice:isNaN(P)?0:P,quantity:isNaN(K)?0:K,userId:y.uid,createdAt:gt(),updatedAt:gt()},ce=(I.barcode||"").trim();ce&&(ue.barcode=ce);const se=(I.serialNumber||"").trim();se&&(ue.serialNumber=se),N!=null&&N.shopId&&(ue.shopId=N.shopId);const Te=await ka(ye(U,"products"),ue);te(ie=>[{id:Te.id,name:c,sellingPrice:T,wholesalePrice:isNaN(P)?0:P,quantity:isNaN(K)?0:K,barcode:(I.barcode||"").trim()||"",serialNumber:(I.serialNumber||"").trim()||""},...ie]),s({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),M({title:"تمت الإضافة",description:`تم إضافة المنتج ${c} بنجاح`})}catch(c){console.error("createProduct error",c),M({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}},hr=async c=>{const T=(c||"").trim();if(!T)return;const P=Y.find(K=>(K.barcode||"")===T);if(!P){M({title:"باركود غير معروف",description:"لم يتم العثور على منتج بهذا الباركود"});return}await ys(P)},So=()=>{const c=Object.entries(ze).map(([ie,Re])=>{const je=Number(Re),jt=Y.find(Lt=>Lt.id===ie);return!jt||!je||je<=0?null:{name:jt.name,qty:je,price:jt.sellingPrice,total:je*jt.sellingPrice}}).filter(Boolean);if(c.length===0){M({title:"لم يتم اختيار منتجات",description:"فعّل وضع الفاتورة واختر منتجات وكميات للطباعة"});return}const T=(N==null?void 0:N.shopName)||(y==null?void 0:y.displayName)||"المحل",P=(N==null?void 0:N.phone)||(y==null?void 0:y.phoneNumber)||"",K=c.reduce((ie,Re)=>ie+Re.total,0),ue=new Date().toLocaleString("ar-EG"),ce=c.map(ie=>`
        <tr>
          <td style="border:1px solid #ddd;padding:6px">${ie.name}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${ie.qty}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${Ft(ie.price)}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center;font-weight:bold;color:#0a7">${Ft(ie.total)}</td>
        </tr>
      `).join(""),se=`
      <html>
        <head>
          <meta charset="utf-8" />
          <title>فاتورة</title>
          <style>
            body { font-family: Tahoma, Arial, sans-serif; direction: rtl; }
            .header { text-align: center; margin-bottom: 12px; }
            .header h2 { margin: 0; }
            .meta { text-align: center; color: #555; margin-bottom: 8px; }
            table { width: 100%; border-collapse: collapse; }
            .total { text-align: left; font-weight: bold; margin-top: 10px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>${T}</h2>
            ${P?`<div class="meta">رقم التليفون: ${P}</div>`:""}
            <div class="meta">التاريخ: ${ue}</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="border:1px solid #ddd;padding:6px">المنتج</th>
                <th style="border:1px solid #ddd;padding:6px">الكمية</th>
                <th style="border:1px solid #ddd;padding:6px">السعر</th>
                <th style="border:1px solid #ddd;padding:6px">الإجمالي</th>
              </tr>
            </thead>
            <tbody>
              ${ce}
            </tbody>
          </table>
          <div class="total">الإجمالي الكلي: ${Ft(K)}</div>
        </body>
      </html>
    `,Te=window.open("","_blank");Te&&(Te.document.write(se),Te.document.close(),Te.focus(),Te.print(),Te.close())},[zi,rn]=n.useState(0),[Pr,nn]=n.useState(0),[ua,ln]=n.useState(0),[ur,Oa]=n.useState(0),xr=()=>{const c=L||(N==null?void 0:N.shopId)||"main",T=(y==null?void 0:y.uid)||"guest",P=new Date,K=P.getFullYear(),ue=String(P.getMonth()+1).padStart(2,"0"),ce=String(P.getDate()).padStart(2,"0"),se=`${K}-${ue}-${ce}`,Te=`${K}-${ue}`;return{daily:`dailyOffset_${T}_${c}_${se}`,monthly:`monthlyOffset_${T}_${c}_${Te}`}};n.useEffect(()=>{if(!(y!=null&&y.uid))return;const c=xr();try{const T=localStorage.getItem(c.daily);if(T){const{sales:K,profit:ue}=JSON.parse(T);rn(Number(K)||0),nn(Number(ue)||0)}else rn(0),nn(0);const P=localStorage.getItem(c.monthly);if(P){const{sales:K,profit:ue}=JSON.parse(P);ln(Number(K)||0),Oa(Number(ue)||0)}else ln(0),Oa(0)}catch(T){console.error("Failed to load offsets",T)}},[y==null?void 0:y.uid,L,N==null?void 0:N.shopId,i]);const Hn=(c,T)=>{const P=xr();localStorage.setItem(P.daily,JSON.stringify({sales:c,profit:T}))},on=(c,T)=>{const P=xr();localStorage.setItem(P.monthly,JSON.stringify({sales:c,profit:T}))},cn=()=>{gs("بدء وردية جديدة (تصفير العرض)","هل تريد تصفير عدادات اليوم وبدء جلسة جديدة؟ (لن يتم حذف البيانات من السجل)",async()=>{try{const c=j.filter(P=>!P.isDeferred).reduce((P,K)=>P+K.price*K.quantity,0),T=j.filter(P=>!P.isDeferred).reduce((P,K)=>P+(K.price-(K.wholesalePrice??0))*K.quantity,0);rn(c),nn(T),Hn(c,T),M({title:"تم التصفير",description:"تم تصفير عدادات اليوم بنجاح (بياناتك آمنة في السجل)"})}catch(c){console.error(c),M({title:"خطأ",description:"حدث خطأ أثناء التصفير",variant:"destructive"})}})},Ea=()=>{gs("إخفاء ملخص الشهر","هل تريد تصفير عدادات الشهر مؤقتاً؟ (لن يتم حذف البيانات من السجل)",async()=>{try{ln(Me),Oa(rt),on(Me,rt),M({title:"تم التصفير",description:"تم تصفير عدادات الشهر مؤقتاً"})}catch(c){console.error(c),M({title:"خطأ",description:"حدث خطأ أثناء تصفير الشهر",variant:"destructive"})}})};return e.jsxs(be,{open:i,onOpenChange:f,children:[e.jsx(ve,{className:"max-w-none w-[100vw] h-[100dvh] p-0 overflow-hidden bg-[#fdfbf7]",children:e.jsxs("div",{className:"flex flex-col h-full",dir:"rtl",children:[e.jsxs("div",{className:"bg-[#fcf9f2] border-b px-3 py-2 flex items-center justify-between shrink-0 z-10 h-14 sm:h-auto",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"bg-primary/10 p-1.5 rounded-full",children:e.jsx(bo,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{className:"flex flex-col justify-center",children:[e.jsx(we,{className:"text-sm font-bold leading-tight",children:"المبيعات والمنتجات"}),e.jsx("p",{className:"text-[10px] text-muted-foreground hidden sm:block leading-none mt-0.5",children:"إدارة عمليات البيع والمخزون"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>mr(),className:"hidden sm:flex h-7 text-[10px] px-2",children:[e.jsx(Li,{className:"h-3 w-3 ml-1.5"}),"مزامنة"]}),e.jsx(x,{variant:"ghost",size:"icon",onClick:f,className:"rounded-full h-8 w-8",children:e.jsx(Kn,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex-1 overflow-hidden flex flex-col md:flex-row",children:[e.jsx("div",{className:"w-full md:w-80 bg-[#fcf9f2] border-l flex flex-col shrink-0 order-2 md:order-1",children:e.jsx("div",{className:"flex-1 overflow-y-auto scrollbar-thin",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs(bt,{className:"hidden md:block",children:[e.jsxs(ns,{className:"p-4 pb-2 flex flex-row items-center justify-between space-y-0",children:[e.jsxs(js,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(is,{className:"h-4 w-4 text-primary"}),"ملخص اليوم"]}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6 text-muted-foreground hover:text-red-600",onClick:cn,title:"تصفير اليوم",children:e.jsx(Mi,{className:"h-3.5 w-3.5"})})]}),e.jsxs(At,{className:"p-4 pt-2 space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center p-3 bg-gray-50 rounded-lg border",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"المبيعات"}),e.jsx("span",{className:"text-lg font-bold text-primary",children:Ft(Math.max(0,j.filter(c=>!c.isDeferred).reduce((c,T)=>c+T.price*T.quantity,0)-zi))})]}),e.jsxs("div",{className:"relative overflow-hidden p-3 bg-emerald-50/50 rounded-lg border border-emerald-100",children:[e.jsxs("div",{className:`flex justify-between items-center ${ee?"blur-sm":""}`,children:[e.jsx("span",{className:"text-sm text-emerald-700",children:"الأرباح"}),e.jsx("span",{className:"text-lg font-bold text-emerald-700",children:Ft(Math.max(0,j.filter(c=>!c.isDeferred).reduce((c,T)=>c+(T.price-(T.wholesalePrice??0))*T.quantity,0)-Pr))})]}),ee&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white/50",children:e.jsxs(x,{size:"sm",variant:"outline",onClick:()=>St(!0),className:"h-7 text-xs bg-white",children:[e.jsx(ba,{className:"h-3 w-3 ml-1"}),"عرض"]})})]})]})]}),e.jsxs(bt,{className:"shadow-none border-none bg-transparent hidden md:block",children:[e.jsxs("div",{className:"flex items-center justify-between w-full p-2",children:[e.jsxs("button",{onClick:()=>Kt(!Jt),className:"flex items-center gap-2 text-sm font-medium text-gray-600 hover:text-primary transition-colors flex-1 text-right",children:[e.jsx(Dr,{className:"h-4 w-4"}),"تقارير الشهر",Jt?e.jsx(zn,{className:"h-4 w-4"}):e.jsx(kd,{className:"h-4 w-4"})]}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6 text-muted-foreground hover:text-red-600",onClick:Ea,title:"تصفير الشهر",children:e.jsx(Mi,{className:"h-3.5 w-3.5"})})]}),!Jt&&e.jsx("div",{className:"mt-2 grid grid-cols-2 gap-2 animate-in slide-in-from-top-2",children:e.jsxs("div",{className:"col-span-2 relative",children:[e.jsxs("div",{className:`grid grid-cols-2 gap-2 ${Z?"blur-sm select-none":""}`,children:[e.jsxs("div",{className:"bg-indigo-50 p-3 rounded-xl border border-indigo-100 text-center",children:[e.jsx("span",{className:"text-[10px] text-indigo-600 block mb-1",children:"المبيعات"}),e.jsx("span",{className:"text-sm font-bold text-indigo-700",children:Ft(Math.max(0,Me-ua))})]}),e.jsxs("div",{className:"bg-pink-50 p-3 rounded-xl border border-pink-100 text-center",children:[e.jsx("span",{className:"text-[10px] text-pink-600 block mb-1",children:"الأرباح"}),e.jsx("span",{className:"text-sm font-bold text-pink-700",children:Ft(Math.max(0,rt-ur))})]})]}),Z&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-10",children:e.jsxs(x,{size:"sm",variant:"outline",onClick:()=>He(!0),className:"h-8 bg-white/80 backdrop-blur-sm",children:[e.jsx(ba,{className:"h-3 w-3 ml-1"}),"فك القفل"]})})]})})]}),e.jsx(Bi,{className:"hidden md:block"}),e.jsxs(x,{variant:"outline",className:"w-full justify-start h-10",onClick:()=>ge(!0),children:[e.jsx(fa,{className:"h-4 w-4 ml-2"}),"أرشيف الإيصالات"]})]})})}),e.jsx("div",{className:"flex-1 overflow-hidden flex flex-col order-1 md:order-2 bg-[#fdfbf7]",children:e.jsxs(Qu,{defaultValue:"products",className:"flex-1 flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"px-2 py-1.5 bg-[#fcf9f2] border-b flex items-center justify-between shrink-0",children:[e.jsxs(Gu,{className:"h-8",children:[e.jsx(cd,{value:"products",className:"text-xs px-2 sm:px-3",children:"المنتجات والبيع"}),e.jsxs(cd,{value:"sales-log",className:"text-xs px-2 sm:px-3",children:["سجل المبيعات",e.jsx(Bt,{variant:"secondary",className:"mr-2 h-5 px-1.5 text-[10px] hidden sm:inline-flex",children:j.filter(c=>!c.isDeferred).length})]})]}),e.jsxs(x,{variant:"ghost",size:"sm",className:"md:hidden text-xs h-8 px-2 bg-white/50 border mr-1 text-primary",onClick:()=>We(!0),children:[e.jsx(fo,{className:"h-3 w-3 ml-1"}),"تفاصيل اليوم"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500 font-mono",dir:"ltr",children:[e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(qa,{className:"h-3.5 w-3.5 text-gray-400"})]})]}),e.jsx(dd,{value:"products",className:"flex-1 p-0 m-0 overflow-hidden h-full relative",children:e.jsx("div",{className:"absolute inset-0 overflow-y-auto scrollbar-thin",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs(bt,{className:"border-dashed border-2 border-gray-200 hover:border-gray-300 transition-all bg-gray-50/30 overflow-hidden",children:[e.jsxs("div",{className:"p-4 flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors",onClick:()=>W(!v),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-emerald-100 p-2 rounded-full",children:e.jsx(Vt,{className:"h-5 w-5 text-emerald-600"})}),e.jsxs("div",{className:"text-right",children:[e.jsx("h3",{className:"font-semibold text-gray-900 text-sm",children:"إضافة منتج جديد"}),e.jsx("p",{className:"text-xs text-gray-500",children:"تسجيل منتج جديد في المخزون"})]})]}),e.jsx(x,{variant:"ghost",size:"sm",className:"rounded-full h-8 w-8 p-0",children:e.jsx(zn,{className:`h-5 w-5 text-gray-400 transition-transform duration-200 ${v?"rotate-180":""}`})})]}),v&&e.jsxs("div",{className:"px-4 pb-4 pt-0 animate-in slide-in-from-top-2",children:[e.jsx("div",{className:"h-px bg-gray-200 mb-4"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs(G,{className:"text-xs font-medium text-gray-700",children:["اسم المنتج ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(q,{value:I.productName,onChange:c=>s(T=>({...T,productName:c.target.value})),className:"h-9 bg-white",placeholder:"مثال: شاحن آيفون أصلي"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs(G,{className:"text-xs font-medium text-gray-700",children:["سعر البيع ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(q,{type:"number",value:I.price,onChange:c=>s(T=>({...T,price:c.target.value})),className:"h-9 bg-white",placeholder:"0.00"})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(G,{className:"text-xs font-medium text-gray-700",children:"سعر الجملة"}),e.jsx(q,{type:"number",value:I.wholesalePrice||"",onChange:c=>s(T=>({...T,wholesalePrice:c.target.value})),className:"h-9 bg-white",placeholder:"0.00"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs(G,{className:"text-xs font-medium text-gray-700",children:["الكمية ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(q,{type:"number",value:I.quantity,onChange:c=>s(T=>({...T,quantity:c.target.value})),className:"h-9 bg-white",placeholder:"1"})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(G,{className:"text-xs font-medium text-gray-700",children:"الباركود (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{value:I.barcode||"",onChange:c=>s(T=>({...T,barcode:c.target.value})),className:"h-9 bg-white pl-8",placeholder:"Scan..."}),e.jsx(uo,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-gray-400"})]})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs(x,{className:"w-full h-9 bg-emerald-600 hover:bg-emerald-700 text-white shadow-sm",onClick:()=>{if(O){M({title:"غير مسموح",description:"لا يمكن إضافة منتج أثناء الوردية",variant:"destructive"});return}gs("إضافة منتج","أدخل الرقم السري للمتابعة",Ha)},children:[e.jsx(Vt,{className:"h-4 w-4 ml-2"}),"حفظ المنتج الجديد"]})})]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 items-stretch sm:items-center justify-between bg-white p-2 rounded-xl border border-gray-100 shadow-sm",children:[e.jsxs("div",{className:"relative flex-1 w-full sm:max-w-md group",children:[e.jsx(Od,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 group-focus-within:text-primary transition-colors"}),e.jsx(q,{value:ma,onChange:c=>ja(c.target.value),placeholder:"بحث عن منتج بالاسم...",className:"pl-3 pr-9 h-10 border-0 bg-transparent focus-visible:ring-0 placeholder:text-gray-400"})]}),e.jsx("div",{className:"h-8 w-px bg-gray-200 hidden sm:block"}),e.jsxs("div",{className:"flex items-center gap-2 w-full sm:w-auto",children:[e.jsxs("div",{className:"relative flex-1 sm:w-48 group",children:[e.jsx(uo,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 group-focus-within:text-primary transition-colors"}),e.jsx(q,{value:de,onChange:c=>ae(c.target.value),onKeyDown:async c=>{c.key==="Enter"&&de.trim()&&(await hr(de.trim()),ae(""))},placeholder:"ماسح الباركود...",className:"pr-9 h-9 bg-gray-50 border-gray-200 focus:bg-white transition-all text-sm"})]}),e.jsxs("div",{className:"flex items-center gap-1 border-r pr-2 mr-1",children:[e.jsx(x,{variant:Le?"default":"ghost",size:"icon",onClick:()=>Qe(!Le),className:`h-9 w-9 shrink-0 transition-all rounded-full ${Le?"bg-primary text-primary-foreground":"text-gray-500 hover:text-primary hover:bg-primary/10"}`,title:"وضع الفاتورة",children:e.jsx(fa,{className:"h-4 w-4"})}),Le&&e.jsx(x,{variant:"outline",size:"icon",onClick:So,disabled:Object.values(ze).every(c=>!c),className:"h-9 w-9 shrink-0 rounded-full border-gray-200",title:"طباعة الفاتورة",children:e.jsx(Ed,{className:"h-4 w-4 text-gray-600"})})]})]})]}),e.jsx("div",{className:"space-y-4",children:Sa.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4 bg-white rounded-xl border border-dashed border-gray-200 text-center shadow-sm",children:[e.jsx("div",{className:"bg-gray-50 p-4 rounded-full mb-4",children:e.jsx(Ld,{className:"h-10 w-10 text-gray-300"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-1",children:"لا توجد منتجات"}),e.jsx("p",{className:"text-gray-500 text-sm max-w-xs mx-auto mb-4",children:"لم يتم العثور على منتجات تطابق بحثك."}),e.jsxs(x,{variant:"outline",onClick:()=>W(!0),className:"gap-2",children:[e.jsx(Vt,{className:"h-4 w-4"}),"إضافة منتج جديد"]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden md:block bg-[#fcf9f2] rounded-xl border border-gray-100 shadow-sm overflow-hidden",children:e.jsxs(io,{children:[e.jsx(lo,{className:"bg-gray-50/80",children:e.jsxs(Kr,{className:"hover:bg-transparent border-gray-100",children:[e.jsx(ss,{className:"text-right h-11 font-semibold text-gray-700",children:"المنتج"}),e.jsx(ss,{className:"text-center h-11 font-semibold text-gray-700 w-28",children:"السعر"}),e.jsx(ss,{className:"text-center h-11 font-semibold text-gray-700 w-28",children:e.jsxs("div",{className:"flex items-center justify-center gap-1.5 cursor-pointer hover:text-primary transition-colors select-none",onClick:()=>{mt?Et(!1):gs("عرض سعر الجملة","أدخل الرقم السري الرئيسي لعرض سعر الجملة",()=>Et(!0))},children:[e.jsx("span",{children:"الجملة"}),mt?e.jsx(ea,{className:"h-3.5 w-3.5"}):e.jsx(Ss,{className:"h-3.5 w-3.5"})]})}),e.jsx(ss,{className:"text-center h-11 font-semibold text-gray-700 w-24",children:"الكمية"}),e.jsx(ss,{className:"text-center h-11 font-semibold text-gray-700 w-[420px]",children:"إجراءات البيع"})]})}),e.jsx(oo,{children:Sa.map(c=>e.jsxs(Kr,{className:"hover:bg-gray-50/60 transition-colors border-gray-100",children:[e.jsxs(as,{className:"font-medium py-3",children:[e.jsx("div",{className:"text-gray-900 font-bold",children:c.name}),c.barcode&&e.jsxs("div",{className:"flex items-center gap-1 text-[11px] text-gray-500 font-mono mt-0.5",children:[e.jsx(uo,{className:"h-3 w-3"}),c.barcode]})]}),e.jsx(as,{className:"text-center py-3",children:e.jsx("span",{className:"font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-md",children:Ft(c.sellingPrice)})}),e.jsx(as,{className:"text-center py-3",children:e.jsx("span",{className:`font-medium text-xs ${mt?"text-gray-600":"blur-sm select-none text-gray-300"}`,children:Ft(c.wholesalePrice)})}),e.jsx(as,{className:"text-center py-3",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(Bt,{variant:c.quantity>0?"outline":"destructive",className:`font-mono ${c.quantity>0?"bg-gray-50 text-gray-700 border-gray-200":""}`,children:c.quantity}),e.jsx(x,{size:"icon",variant:"ghost",className:"h-5 w-5 rounded-full text-emerald-600 hover:bg-emerald-50 hover:text-emerald-700",onClick:()=>Qt(c),title:"إضافة مخزون",children:e.jsx(Vt,{className:"h-3 w-3"})})]})}),e.jsx(as,{className:"py-3",children:e.jsxs("div",{className:"flex items-center gap-2 justify-end",children:[e.jsxs("div",{className:"relative group",children:[e.jsx(q,{type:"number",className:"h-8 w-14 text-center px-1 text-sm bg-white border-gray-200 focus:border-primary/50",placeholder:"1",value:me[c.id]||"",onChange:T=>E(P=>({...P,[c.id]:T.target.value}))}),e.jsx("span",{className:"absolute -top-2 -right-1 text-[9px] bg-white px-0.5 text-gray-400 group-hover:text-primary transition-colors",children:"العدد"})]}),e.jsxs("div",{className:"relative group",children:[e.jsx(q,{type:"number",className:"h-8 w-16 text-center px-1 bg-gray-50 border-gray-200 focus:border-primary/50 text-sm focus:bg-white transition-colors",placeholder:"سعر",value:ps[c.id]||"",onChange:T=>Dt(P=>({...P,[c.id]:T.target.value})),title:"سعر بيع مخصص"}),e.jsx("span",{className:"absolute -top-2 -right-1 text-[9px] bg-white px-0.5 text-gray-400 group-hover:text-primary transition-colors",children:"مخصص"})]}),e.jsx(x,{size:"sm",className:"h-8 bg-indigo-600 hover:bg-indigo-700 text-white shadow-sm px-3 font-medium",onClick:()=>Tr(c),children:"بيع"}),e.jsx(x,{size:"sm",variant:"secondary",className:"h-8 text-amber-700 bg-amber-50 hover:bg-amber-100 border border-amber-200 px-3 font-medium",onClick:()=>{ft(c),k(!0)},children:"أجل"}),Le&&e.jsx(q,{type:"number",className:"h-8 w-12 text-center border-indigo-200 focus:border-indigo-400 bg-indigo-50/30",placeholder:"#",value:ze[c.id]??"",onChange:T=>{const P=parseInt(T.target.value||"0");Ke(K=>({...K,[c.id]:isNaN(P)?0:P}))}}),e.jsx("div",{className:"w-px h-4 bg-gray-200 mx-1"}),e.jsx(x,{size:"icon",variant:"ghost",className:"h-8 w-8 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full",onClick:()=>Ya(c),disabled:O,children:e.jsx(Ns,{className:"h-4 w-4"})})]})})]},c.id))})]})}),e.jsx("div",{className:"md:hidden grid grid-cols-1 gap-3",children:Sa.map(c=>e.jsx(bt,{className:"overflow-hidden border-gray-100 shadow-sm hover:shadow-md transition-shadow bg-[#fcf9f2]",children:e.jsxs(At,{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-gray-900 text-base",children:c.name}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-2",children:[e.jsx(Bt,{variant:"secondary",className:"bg-emerald-50 text-emerald-700 border-emerald-100",children:Ft(c.sellingPrice)}),e.jsxs("span",{className:`text-xs text-gray-500 flex items-center gap-1 ${!mt&&"blur-sm select-none"}`,children:[e.jsx("span",{className:"text-gray-400",children:"جملة:"}),Ft(c.wholesalePrice)]}),e.jsx("span",{className:"text-gray-300",children:"|"}),e.jsxs("span",{className:"text-xs text-gray-600 font-medium flex items-center gap-1",children:["متاح: ",c.quantity,e.jsx(x,{size:"icon",variant:"ghost",className:"h-5 w-5 rounded-full text-emerald-600 hover:bg-emerald-50",onClick:()=>Qt(c),children:e.jsx(Vt,{className:"h-3 w-3"})})]})]})]}),e.jsx(x,{size:"icon",variant:"ghost",className:"h-8 w-8 -mt-1 -ml-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full",onClick:()=>Ya(c),disabled:O,children:e.jsx(Ns,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-gray-50/50 p-2 rounded-lg border border-gray-100",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(q,{type:"number",className:"h-9 w-full bg-white text-center border-gray-200 focus:border-indigo-300",placeholder:"الكمية",value:me[c.id]||"",onChange:T=>E(P=>({...P,[c.id]:T.target.value}))}),e.jsx("span",{className:"absolute inset-y-0 right-2 flex items-center text-[10px] text-gray-400 pointer-events-none",children:"عدد"})]}),e.jsxs("div",{className:"relative w-28",children:[e.jsx(q,{type:"number",className:"h-9 w-full bg-white text-center border-gray-200 focus:border-indigo-300",placeholder:"سعر مخصص",value:ps[c.id]||"",onChange:T=>Dt(P=>({...P,[c.id]:T.target.value}))}),e.jsx("span",{className:"absolute inset-y-0 right-2 flex items-center text-[10px] text-gray-400 pointer-events-none",children:"سعر"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(x,{className:"h-10 bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm font-bold",onClick:()=>Tr(c),children:[e.jsx(is,{className:"h-4 w-4 ml-2"}),"بيع فوري"]}),e.jsxs(x,{variant:"outline",className:"h-10 border-amber-200 text-amber-700 bg-amber-50 hover:bg-amber-100 font-bold",onClick:()=>{ft(c),k(!0)},children:[e.jsx(qa,{className:"h-4 w-4 ml-2"}),"بيع أجل"]})]}),Le&&e.jsx("div",{className:"pt-3 border-t border-dashed border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-xs font-medium text-gray-500",children:"للفاتورة:"}),e.jsx(q,{type:"number",className:"h-8 flex-1 bg-indigo-50/30 border-indigo-100",value:ze[c.id]??"",onChange:T=>{const P=parseInt(T.target.value||"0");Ke(K=>({...K,[c.id]:isNaN(P)?0:P}))},placeholder:"العدد في الفاتورة"})]})})]})},c.id))})]})})]})})}),e.jsx(dd,{value:"sales-log",className:"flex-1 p-0 m-0 overflow-hidden h-full relative",children:e.jsx("div",{className:"absolute inset-0 overflow-y-auto scrollbar-thin",children:e.jsxs("div",{className:"p-4 space-y-4 min-h-full",children:[e.jsx("div",{className:"md:hidden",children:e.jsxs(x,{variant:"outline",className:"w-full justify-between bg-white border-dashed border-2 border-gray-200 h-12 text-gray-700 hover:text-primary hover:border-primary/50 hover:bg-primary/5 shadow-sm",onClick:()=>We(!0),children:[e.jsxs("span",{className:"flex items-center gap-2 font-semibold",children:[e.jsx(fo,{className:"h-4 w-4 text-primary"}),"تفاصيل اليوم"]}),e.jsx("span",{className:"text-xs text-muted-foreground font-normal bg-gray-50 px-2 py-1 rounded-full border",children:"اضغط لعرض التقارير"})]})}),j.length===0?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center py-12 px-4 bg-[#fcf9f2]/50 rounded-xl border border-dashed border-gray-200 text-center",children:[e.jsx("div",{className:"bg-[#fcf9f2] p-4 rounded-full shadow-sm mb-4",children:e.jsx(fa,{className:"h-8 w-8 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-1",children:"لا توجد مبيعات"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"لم يتم تسجيل أي عمليات بيع اليوم."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"hidden md:block bg-[#fcf9f2] rounded-xl border border-gray-100 shadow-sm overflow-hidden",children:e.jsxs(io,{children:[e.jsx(lo,{className:"bg-gray-50/80",children:e.jsxs(Kr,{className:"hover:bg-transparent",children:[e.jsx(ss,{className:"text-right h-11 font-semibold text-gray-700",children:"المنتج"}),e.jsx(ss,{className:"text-center h-11 font-semibold text-gray-700",children:"السعر"}),e.jsx(ss,{className:"text-center h-11 font-semibold text-gray-700",children:"الكمية"}),e.jsx(ss,{className:"text-center h-11 font-semibold text-gray-700",children:"الإجمالي"}),e.jsx(ss,{className:"text-center h-11 font-semibold text-gray-700",children:"الربح"}),e.jsx(ss,{className:"text-center h-11 font-semibold text-gray-700",children:"التاريخ"}),e.jsx(ss,{className:"text-center h-11 font-semibold text-gray-700",children:"الوقت"}),e.jsx(ss,{className:"text-center h-11 font-semibold text-gray-700",children:"إجراءات"})]})}),e.jsx(oo,{children:j.map(c=>e.jsxs(Kr,{className:"hover:bg-gray-50/60 transition-colors",children:[e.jsxs(as,{className:"py-3",children:[e.jsx("div",{className:"font-medium text-gray-900",children:c.productName}),c.isDeferred&&e.jsx(Bt,{variant:"secondary",className:"mt-1 text-[10px] bg-amber-100 text-amber-700 border-amber-200",children:"مؤجل"})]}),e.jsx(as,{className:"text-center py-3",children:Ft(c.price)}),e.jsx(as,{className:"text-center py-3",children:e.jsx(Bt,{variant:"outline",className:"font-mono bg-gray-50",children:c.quantity})}),e.jsx(as,{className:"text-center font-bold text-green-600 py-3",children:Ft(c.price*c.quantity)}),e.jsx(as,{className:"text-center text-indigo-600 py-3",children:e.jsx("span",{className:mt?"":"blur-sm select-none text-gray-300",children:Ft(((c.price??0)-(c.wholesalePrice??0))*c.quantity)})}),e.jsx(as,{className:"text-center text-gray-500 text-xs py-3 font-mono",children:$i(c.date)}),e.jsx(as,{className:"text-center text-gray-500 text-xs py-3 font-mono",children:c.time}),e.jsx(as,{className:"py-3",children:e.jsxs("div",{className:"flex justify-center gap-2",children:[c.isDeferred&&e.jsx(x,{size:"sm",variant:"outline",className:"h-8 text-xs border-amber-200 text-amber-700 bg-amber-50 hover:bg-amber-100",onClick:()=>gs("تأكيد سداد بيع مؤجل","أدخل الرقم السري الرئيسي لتأكيد السداد",()=>sn(c)),children:"سداد"}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-8 w-8 p-0 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-full",onClick:()=>Na(c,"return"),title:"مرتجع",children:e.jsx(dr,{className:"h-4 w-4"})}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-8 w-8 p-0 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full",onClick:()=>Na(c,"delete"),title:"حذف نهائي",children:e.jsx(No,{className:"h-4 w-4"})})]})})]},c.id))})]})}),e.jsx("div",{className:"md:hidden space-y-3",children:j.map(c=>e.jsx(bt,{className:"overflow-hidden border-gray-100 shadow-sm bg-[#fcf9f2]",children:e.jsxs(At,{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-gray-900 text-sm",children:c.productName}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 flex items-center gap-2",children:[e.jsx("span",{className:"bg-gray-100 px-1.5 py-0.5 rounded text-gray-600 font-mono",children:c.time}),e.jsx("span",{className:"text-gray-400",children:"|"}),e.jsx("span",{children:$i(c.date)}),c.isDeferred&&e.jsx(Bt,{variant:"outline",className:"text-[10px] bg-amber-50 text-amber-700 border-amber-100 px-1.5 py-0 h-5",children:"مؤجل"})]})]}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"font-bold text-green-600 text-sm",children:Ft(c.price*c.quantity)}),e.jsxs("div",{className:"text-xs text-gray-400 mt-0.5",children:[c.quantity," × ",Ft(c.price)]})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 pt-3 border-t border-gray-50",children:[c.isDeferred&&e.jsx(x,{size:"sm",variant:"ghost",className:"h-8 text-xs text-amber-600 bg-amber-50 hover:bg-amber-100",onClick:()=>gs("تأكيد سداد بيع مؤجل","أدخل الرقم السري الرئيسي لتأكيد السداد",()=>sn(c)),children:"تسديد"}),e.jsxs(x,{size:"sm",variant:"ghost",className:"h-8 text-xs text-red-600 hover:bg-red-50",onClick:()=>Na(c,"return"),children:[e.jsx(dr,{className:"h-3.5 w-3.5 ml-1.5"}),"مرتجع"]}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-8 w-8 p-0 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full",onClick:()=>Na(c,"delete"),children:e.jsx(Ns,{className:"h-4 w-4"})})]})]})},c.id))})]})]})})})]})})]})]})}),e.jsx(be,{open:Ks,onOpenChange:k,children:e.jsxs(ve,{className:"max-w-sm mx-auto bg-white border border-gray-100 shadow-xl rounded-2xl sm:max-w-md p-6 gap-5",children:[e.jsxs(De,{className:"text-center space-y-2",children:[e.jsx("div",{className:"mx-auto bg-amber-100 p-3 rounded-full w-fit",children:e.jsx(qa,{className:"h-6 w-6 text-amber-600"})}),e.jsx(we,{className:"text-xl font-bold text-gray-900",children:"تسجيل بيع أجل"}),e.jsx(us,{className:"text-gray-500 text-sm",children:"أدخل بيانات العميل لتسجيل عملية البيع الآجل"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-1.5",children:[e.jsx(G,{className:"text-sm font-medium text-gray-700",children:"اختيار عميل (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{className:"flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 appearance-none",value:ne,onChange:c=>{const T=c.target.value;Ee(T);const P=Va.find(K=>K.id===T);P&&(Be(P.name),Q(P.mobile||""))},children:[e.jsx("option",{value:"",children:"-- اختر عميل مسجل --"}),Va.map(c=>e.jsxs("option",{value:c.id,children:[c.name,c.mobile?` - ${c.mobile}`:""]},c.id))]}),e.jsx(zn,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 pointer-events-none"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-1.5",children:[e.jsxs(G,{className:"text-sm font-medium text-gray-700",children:["اسم العميل ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(q,{value:Xe,onChange:c=>Be(c.target.value),placeholder:"أدخل اسم العميل...",className:"h-10"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-1.5",children:[e.jsx(G,{className:"text-sm font-medium text-gray-700",children:"رقم التليفون (اختياري)"}),e.jsx(q,{value:ct,onChange:c=>Q(c.target.value),placeholder:"أدخل رقم التليفون...",className:"h-10"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-2",children:[e.jsx(x,{variant:"outline",className:"flex-1 h-10 border-gray-200",onClick:()=>k(!1),children:"إلغاء"}),e.jsx(x,{className:"flex-1 h-10 bg-amber-600 hover:bg-amber-700 text-white shadow-sm",onClick:async()=>{try{const c=ut;if(!c){k(!1);return}const T=Xe.trim(),P=ct.trim()||void 0,K=ne||void 0;if(!T){M({title:"بيانات مطلوبة",description:"أدخل اسم العميل",variant:"destructive"});return}await Tr(c,!0,{id:K,name:T,mobile:P});try{if(y!=null&&y.uid){const ue=c.sellingPrice*(parseInt(me[c.id]||"0")||0),ce=await Ce.getUserData(y.uid),se=Array.isArray(ce==null?void 0:ce.debts)?ce.debts:[],Te={id:Date.now().toString(),debtorName:T,customerId:K||null,mobile:P||null,amount:ue,reason:`بيع أجل للمنتج ${c.name}`,status:"pending",createdAt:new Date,partialPayments:[]},ie=[Te,...se];Ce.updateUserData(y.uid,{debts:ie}).catch(()=>{});try{const Re=L||(N==null?void 0:N.shopId)||"main";localStorage.setItem(`debts_${y.uid}_${Re}`,JSON.stringify(ie)),localStorage.setItem(`debts_default_${Re}`,JSON.stringify(ie)),localStorage.setItem(`debts_last_write_${y.uid}_${Re}`,Date.now().toString())}catch{}try{window.dispatchEvent(new CustomEvent("debtsUpdated",{detail:{count:ie.length}}))}catch{}try{sr.send(y.uid,`تم إضافة دين على ${Te.debtorName} بمبلغ ${Te.amount} جنيه`).catch(()=>{})}catch{}}}catch{}k(!1),ft(null)}catch{}},children:"تأكيد البيع"})]})]})}),e.jsx(be,{open:B,onOpenChange:ge,children:e.jsxs(ve,{className:"sm:max-w-4xl max-h-[85vh] flex flex-col p-0 overflow-hidden gap-0",children:[e.jsxs("div",{className:"p-4 border-b flex items-center justify-between bg-gray-50/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-white p-2 rounded-full border shadow-sm",children:e.jsx(fa,{className:"h-5 w-5 text-indigo-600"})}),e.jsxs("div",{children:[e.jsx(we,{className:"text-lg font-bold",children:"سجل الإيصالات"}),e.jsx(us,{className:"text-xs",children:"عرض تفاصيل عمليات البيع الفورية"})]})]}),e.jsx(x,{variant:"ghost",size:"icon",onClick:()=>ge(!1),className:"rounded-full",children:e.jsx(Kn,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:j.filter(c=>!c.isDeferred).length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx("div",{className:"bg-gray-50 p-4 rounded-full mb-3",children:e.jsx(fa,{className:"h-8 w-8 text-gray-300"})}),e.jsx("p",{className:"text-gray-500 font-medium",children:"لا توجد إيصالات بيع حتى الآن"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden md:block border rounded-xl overflow-hidden shadow-sm",children:e.jsxs(io,{children:[e.jsx(lo,{className:"bg-gray-50/80",children:e.jsxs(Kr,{className:"hover:bg-transparent",children:[e.jsx(ss,{className:"text-right h-10 font-semibold text-gray-700",children:"المنتج"}),e.jsx(ss,{className:"text-right h-10 font-semibold text-gray-700",children:"سعر البيع"}),e.jsx(ss,{className:"text-right h-10 font-semibold text-gray-700",children:"سعر الجملة"}),e.jsx(ss,{className:"text-right h-10 font-semibold text-gray-700",children:"الكمية"}),e.jsx(ss,{className:"text-right h-10 font-semibold text-gray-700",children:"الإجمالي"}),e.jsx(ss,{className:"text-right h-10 font-semibold text-gray-700",children:"الربح"}),e.jsx(ss,{className:"text-right h-10 font-semibold text-gray-700",children:"التاريخ"}),e.jsx(ss,{className:"text-right h-10 font-semibold text-gray-700",children:"الوقت"}),e.jsx(ss,{className:"text-right h-10 font-semibold text-gray-700",children:"المنفذ"})]})}),e.jsx(oo,{children:j.filter(c=>!c.isDeferred).map(c=>e.jsxs(Kr,{className:"hover:bg-gray-50/60",children:[e.jsx(as,{className:"font-medium text-gray-900 py-3",children:c.productName}),e.jsx(as,{className:"text-gray-700 py-3",children:Ft(c.price)}),e.jsx(as,{className:"text-gray-700 py-3",children:Ft(c.wholesalePrice??0)}),e.jsx(as,{className:"text-gray-700 py-3 font-mono",children:bd(c.quantity)}),e.jsx(as,{className:"text-gray-700 py-3 font-bold text-emerald-600",children:Ft((c.price??0)*(c.quantity??0))}),e.jsx(as,{className:"text-gray-700 py-3 text-indigo-600",children:Ft(((c.price??0)-(c.wholesalePrice??0))*(c.quantity??0))}),e.jsx(as,{className:"text-gray-500 py-3 text-xs",children:$i(c.date)}),e.jsx(as,{className:"text-gray-500 py-3 text-xs font-mono",children:c.time}),e.jsx(as,{className:"text-gray-700 py-3 text-xs",children:c.executedBy||"-"})]},c.id))})]})}),e.jsx("div",{className:"md:hidden space-y-3",children:j.filter(c=>!c.isDeferred).map(c=>e.jsx(bt,{className:"overflow-hidden border-gray-100 shadow-sm",children:e.jsxs(At,{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-gray-900 text-sm",children:c.productName}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 flex items-center gap-2",children:[e.jsx("span",{className:"bg-gray-100 px-1.5 py-0.5 rounded text-gray-600 font-mono",children:c.time}),e.jsx("span",{className:"text-gray-400",children:"|"}),e.jsx("span",{children:$i(c.date)})]})]}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"font-bold text-emerald-600 text-sm",children:Ft((c.price??0)*(c.quantity??0))}),e.jsxs("div",{className:"text-xs text-gray-400 mt-0.5",children:[c.quantity," × ",Ft(c.price)]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 pt-3 border-t border-dashed border-gray-100 text-xs",children:[e.jsxs("div",{className:"bg-gray-50 p-2 rounded flex flex-col items-center justify-center",children:[e.jsx("span",{className:"text-gray-400 mb-1",children:"الربح"}),e.jsx("span",{className:"font-bold text-indigo-600",children:Ft(((c.price??0)-(c.wholesalePrice??0))*(c.quantity??0))})]}),e.jsxs("div",{className:"bg-gray-50 p-2 rounded flex flex-col items-center justify-center",children:[e.jsx("span",{className:"text-gray-400 mb-1",children:"المنفذ"}),e.jsx("span",{className:"font-medium text-gray-700 truncate max-w-full px-1",children:c.executedBy||"-"})]})]})]})},c.id))})]})}),e.jsx("div",{className:"p-4 border-t bg-gray-50/30 flex justify-end",children:e.jsx(x,{variant:"outline",onClick:()=>ge(!1),className:"px-6",children:"إغلاق"})})]})}),e.jsx(be,{open:fs,onOpenChange:ls,children:e.jsxs(ve,{className:"max-w-sm mx-auto bg-white border border-gray-100 shadow-xl rounded-2xl sm:max-w-md p-6 gap-6",children:[e.jsxs("div",{className:"flex flex-col items-center text-center gap-2",children:[e.jsx("div",{className:`p-3 rounded-full ${cs==="return"?"bg-amber-100 text-amber-600":"bg-red-100 text-red-600"}`,children:cs==="return"?e.jsx(dr,{className:"h-6 w-6"}):e.jsx(Ns,{className:"h-6 w-6"})}),e.jsx(we,{className:"text-xl font-bold text-gray-900 mt-2",children:cs==="return"?"تأكيد المرتجع":"تأكيد الحذف"}),e.jsxs("div",{className:"text-sm text-gray-500 space-y-1",children:[e.jsxs("p",{children:["هل أنت متأكد من ",cs==="return"?"إرجاع":"حذف"," المنتج",e.jsx("span",{className:"font-bold text-gray-900 mx-1",children:os==null?void 0:os.productName}),"بكمية",e.jsx("span",{className:"font-bold text-gray-900 mx-1 font-mono",children:bd((os==null?void 0:os.quantity)||0)}),"؟"]}),e.jsx("p",{className:"text-xs text-gray-400",children:"سيتم تحديث المخزون والرصيد تلقائياً."})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(x,{variant:"outline",className:"h-10 border-gray-200",onClick:()=>ls(!1),children:"إلغاء"}),e.jsx(x,{className:`h-10 ${cs==="return"?"bg-amber-600 hover:bg-amber-700":"bg-red-600 hover:bg-red-700"} text-white shadow-sm`,onClick:()=>{const c=os;ls(!1),c&&kr(c)},children:cs==="return"?"تأكيد المرتجع":"تأكيد الحذف"})]})]})}),e.jsx(ks,{open:st,onOpenChange:St,mode:"verify",title:"قفل إجمالي الأرباح",description:"أدخل الرقم السري الرئيسي لعرض إجمالي الأرباح",onSuccess:()=>{Ae(!1),St(!1)}}),e.jsx(ks,{open:Ie,onOpenChange:He,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const c=y==null?void 0:y.uid;if(c){const T=await wo(c),P=(T==null?void 0:T.planType)??(T==null?void 0:T.plan)??null,K=typeof P=="string"?P.toLowerCase():null;if(P===Xs.ZERO||K==="zero"){M({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}ht(!1),He(!1),Ka()}}),e.jsx(ks,{open:dt,onOpenChange:Mt,mode:"verify",title:xs,description:Fs,onSuccess:()=>{const c=wa.current;wa.current=null,Mt(!1),c&&c()}}),e.jsx(be,{open:V,onOpenChange:ke,children:e.jsxs(ve,{className:"sm:max-w-[400px]",children:[e.jsxs(De,{children:[e.jsx(we,{className:"text-center",children:"إضافة مخزون"}),e.jsxs(us,{className:"text-center",children:["إضافة كمية للمنتج: ",e.jsx("span",{className:"font-bold text-black",children:nt==null?void 0:nt.name})]})]}),e.jsx("div",{className:"py-6 flex flex-col items-center gap-4",children:e.jsxs("div",{className:"flex items-center gap-4 w-full justify-center",children:[e.jsx(x,{variant:"outline",size:"icon",onClick:()=>Ds(c=>String(Math.max(1,parseInt(c||"0")-1))),children:e.jsx(dr,{className:"h-4 w-4"})}),e.jsx(q,{id:"qty",type:"number",value:_s,onChange:c=>Ds(c.target.value),className:"w-32 text-center text-2xl font-bold h-12",autoFocus:!0,onKeyDown:c=>{c.key==="Enter"&&Us()}}),e.jsx(x,{variant:"outline",size:"icon",onClick:()=>Ds(c=>String(parseInt(c||"0")+1)),children:e.jsx(qn,{className:"h-4 w-4"})})]})}),e.jsxs(it,{className:"flex gap-2 sm:justify-center",children:[e.jsx(x,{variant:"outline",onClick:()=>ke(!1),className:"flex-1",children:"إلغاء"}),e.jsx(x,{onClick:Us,className:"flex-1 bg-emerald-600 hover:bg-emerald-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(be,{open:Ze,onOpenChange:We,children:e.jsxs(ve,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(De,{children:e.jsx(we,{children:"تقرير اليوم والشهر"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(is,{className:"h-4 w-4 text-primary"}),"ملخص اليوم"]}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6 text-muted-foreground hover:text-red-600",onClick:cn,title:"تصفير اليوم",children:e.jsx(Mi,{className:"h-3.5 w-3.5"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-center p-2 bg-white rounded border",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"المبيعات"}),e.jsx("div",{className:"font-bold text-primary",children:Ft(Math.max(0,j.filter(c=>!c.isDeferred).reduce((c,T)=>c+T.price*T.quantity,0)-zi))})]}),e.jsxs("div",{className:"text-center p-2 bg-white rounded border relative overflow-hidden",children:[e.jsx("div",{className:"text-xs text-emerald-700 mb-1",children:"الأرباح"}),e.jsx("div",{className:`font-bold text-emerald-700 ${ee?"blur-sm":""}`,children:Ft(Math.max(0,j.filter(c=>!c.isDeferred).reduce((c,T)=>c+(T.price-(T.wholesalePrice??0))*T.quantity,0)-Pr))}),ee&&e.jsxs("div",{className:"absolute inset-0 flex items-center justify-center bg-white/50",children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>{We(!1),St(!0)},className:"h-full w-full opacity-0 absolute inset-0"}),e.jsx(ba,{className:"h-3 w-3 text-muted-foreground"})]})]})]})]}),e.jsxs("div",{className:"bg-indigo-50/50 p-4 rounded-lg border border-indigo-100",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2 text-indigo-900",children:[e.jsx(Dr,{className:"h-4 w-4 text-indigo-600"}),"ملخص الشهر"]}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6 text-muted-foreground hover:text-red-600",onClick:Ea,title:"تصفير الشهر",children:e.jsx(Mi,{className:"h-3.5 w-3.5"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 relative",children:[e.jsxs("div",{className:`text-center p-2 bg-white rounded border border-indigo-100 ${Z?"blur-sm":""}`,children:[e.jsx("div",{className:"text-xs text-indigo-600 mb-1",children:"المبيعات"}),e.jsx("div",{className:"font-bold text-indigo-700",children:Ft(Math.max(0,Me-ua))})]}),e.jsxs("div",{className:`text-center p-2 bg-white rounded border border-indigo-100 ${Z?"blur-sm":""}`,children:[e.jsx("div",{className:"text-xs text-pink-600 mb-1",children:"الأرباح"}),e.jsx("div",{className:"font-bold text-pink-700",children:Ft(Math.max(0,rt-ur))})]}),Z&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-10",children:e.jsxs(x,{size:"sm",variant:"outline",onClick:()=>{We(!1),He(!0)},className:"h-8 bg-white/80 backdrop-blur-sm",children:[e.jsx(ba,{className:"h-3 w-3 ml-1"}),"فك القفل"]})})]})]})]}),e.jsx(it,{children:e.jsx(x,{onClick:()=>We(!1),children:"إغلاق"})})]})})]})}const bd=i=>new Intl.NumberFormat("ar-EG").format(Number(i||0)),Ft=i=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(i||0))} ج.م`,$i=i=>{try{const f=new Date(i);return isNaN(f.getTime())?new Date(`${i}T00:00:00`).toLocaleDateString("ar-EG"):f.toLocaleDateString("ar-EG")}catch{return i}},Yx=({open:i,onOpenChange:f,userId:d,cashBalance:j,walletBalances:S,transactions:I})=>{const[s,v]=Ye.useState(0),[W,D]=Ye.useState(0),[$,M]=Ye.useState(0),[y,N]=Ye.useState(0),[O,H]=Ye.useState(j||0),[L,Y]=Ye.useState(!1),[te,me]=Ye.useState(null),{toast:E}=da(),{shopId:F}=qi()||{},{profile:re}=_a(),[_e,Ne]=Ye.useState(!1),[de,ae]=Ye.useState(""),[Le,Qe]=Ye.useState(!1),[ze,Ke]=Ye.useState(!1),[mt,Et]=Ye.useState(""),ee=()=>`cashBalance_${d||"default"}_${F||(re==null?void 0:re.shopId)||"main"}`,Ae=Se=>`${new Intl.NumberFormat("ar-EG").format(Number(Se||0))} جنيه`;Ye.useEffect(()=>{const Se=async()=>{try{if(!d){v(0);return}const Ie=new Date,He=Ie.getFullYear(),Z=String(Ie.getMonth()+1).padStart(2,"0"),ht=String(Ie.getDate()).padStart(2,"0"),Jt=`${He}-${Z}-${ht}`;let Kt;try{const ge=Je(ye(U,"dailySales"),le("userId","==",d),...F?[le("shopId","==",F)]:[],le("date","==",Jt));Kt=await Ue(ge)}catch{const ge=Je(ye(U,"users",d,"dailySales"),...F?[le("shopId","==",F)]:[],le("date","==",Jt));Kt=await Ue(ge)}let B=0;Kt.forEach(ge=>{const Fe=ge.data(),kt=Number(Fe.sellingPrice??0),vt=Number(Fe.quantity??0);kt>0&&vt>0&&(B+=kt*vt)}),v(B)}catch(Ie){console.warn("فشل تحميل مبيعات الإكسسوار لليوم:",Ie)}},Ze=async()=>{try{if(!d){setMaintenanceProfitToday(0);return}const Ie=new Date,He=new Date(Ie.getFullYear(),Ie.getMonth(),Ie.getDate(),0,0,0,0),Z=new Date(Ie.getFullYear(),Ie.getMonth(),Ie.getDate(),23,59,59,999);let ht;try{const Kt=Je(ye(U,"maintenance_items"),le("userId","==",d),le("status","==","completed"));ht=await Ue(Kt)}catch{ht=await Ue(Je(ye(U,"maintenance_items"),le("userId","==",d)))}let Jt=0;ht.forEach(Kt=>{var Fe,kt;const B=Kt.data();if((B.status||"in_progress")!=="completed")return;const ge=(kt=(Fe=B.completedAt)==null?void 0:Fe.toDate)==null?void 0:kt.call(Fe);if(ge&&ge.getTime()>=He.getTime()&&ge.getTime()<=Z.getTime()){const vt=Number(B.repairPrice||0);Number.isFinite(vt)&&vt>0&&(Jt+=vt)}}),M(Math.max(0,Jt))}catch(Ie){console.warn("فشل تحميل إجمالي فلوس الصيانة لليوم:",Ie)}},We=async()=>{var Ie;try{if(!d){D(0);return}const He=await Ce.getUserData(d),Z=new Date().toISOString().slice(0,10),ht=(He==null?void 0:He.dailyReceipts)||{};ht!=null&&ht.date&&String(ht.date).slice(0,10)===Z?(D(Number(ht.accessory||0)),N(Number(ht.maintenance||0))):(D(0),N(0));try{const Jt=F||(re==null?void 0:re.shopId)||"main",Kt=await Ws($e(U,"dashboardData",Jt));if(Kt.exists()){const B=Number(((Ie=Kt.data())==null?void 0:Ie.cashBalance)||0);H(B);try{localStorage.setItem(`cashBalance_${d}`,String(B)),localStorage.setItem(ee(),String(B))}catch{}}else H(Number((He==null?void 0:He.cashBalance)||j||0))}catch{H(Number((He==null?void 0:He.cashBalance)||j||0))}}catch{D(0),N(0)}};i&&(Se(),Ze(),We())},[i,d,I,j,F]),Ye.useEffect(()=>{const Se=Ze=>{var We;try{const Ie=Number((We=Ze==null?void 0:Ze.detail)==null?void 0:We.value);Number.isFinite(Ie)&&H(Ie)}catch{}};return window.addEventListener("cashBalanceChanged",Se),()=>window.removeEventListener("cashBalanceChanged",Se)},[i]),Ye.useEffect(()=>{if(!i||!d)return;const Se=F||(re==null?void 0:re.shopId)||"main";return(async()=>{var We;try{const Ie=await Ws($e(U,"dashboardData",Se));if(Ie.exists()){const He=Number(((We=Ie.data())==null?void 0:We.cashBalance)||0);H(He);try{localStorage.setItem(`cashBalance_${d}`,String(He)),localStorage.setItem(ee(),String(He))}catch{}}}catch(Ie){console.warn("Error fetching dashboard data:",Ie)}})(),()=>{}},[i,d,F]);const st=Math.max(0,Number(s)-Number(W)),St=Math.max(0,Number($)-Number(y)),Tt=async Se=>{if(!d)return;const Ze=new Date().toISOString().slice(0,10);try{const We=Se==="accessory"?st:St;if(We<=0){E({title:"لا يوجد مبلغ لتأكيد استلامه",variant:"default"});return}const Ie=Math.max(0,Number(O)-We);H(Ie),Se==="accessory"?D(He=>He+We):N(He=>He+We),await Ce.updateUserData(d,{cashBalance:Ie,dailyReceipts:{date:Ze,accessory:Se==="accessory"?W+We:W,maintenance:Se==="maintenance"?y+We:y}});try{const He=F||(re==null?void 0:re.shopId)||"main";await Xt($e(U,"dashboardData",He),{cashBalance:Ie,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${d}`,String(Ie)),localStorage.setItem(ee(),String(Ie))}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:Ie}}))}catch{}E({title:"تم الاستلام",description:`تم خصم ${We.toFixed(2)} من الدرج وتصفير بند ${Se==="accessory"?"الإكسسوار":"الصيانة"}`})}catch{E({title:"خطأ",description:"تعذر تنفيذ عملية تم الاستلام",variant:"destructive"})}},pe=()=>{ae(""),Et(""),Ne(!0)},Me=()=>{if(!de.trim()){E({title:"سبب الخصم مطلوب",variant:"destructive"});return}Ne(!1),Qe(!0)},Oe=()=>{Qe(!1),Ke(!0)},rt=async()=>{try{if(!d)return;const Se=Math.max(0,Number(mt||0));if(!Number.isFinite(Se)||Se<=0){E({title:"مبلغ غير صالح",description:"أدخل مبلغ خصم صحيح أكبر من الصفر",variant:"destructive"});return}const Ze=Math.max(0,Number(O)-Se);H(Ze),await Ce.updateUserData(d,{cashBalance:Ze});try{const Ie=F||(re==null?void 0:re.shopId)||"main";await Xt($e(U,"dashboardData",Ie),{cashBalance:Ze,lastUpdated:new Date().toISOString()})}catch{}try{localStorage.setItem(`cashBalance_${d}`,String(Ze))}catch{}try{const Ie=new Date().toISOString();localStorage.setItem(ee(),String(Ze)),localStorage.setItem(ee()+"_lastUpdated",Ie)}catch{}const We={title:"ايصال خصم من الفلوس النقديه",type:"cash_deduction",amount:Se,status:"completed",createdAt:new Date,note:de,cashierName:"الحساب الرئيسي"};try{await Ce.saveUserTransaction(d,We)}catch{}E({title:"تم الخصم",description:`تم خصم ${Se.toFixed(2)} من الدرج`}),Ke(!1),Et(""),ae("")}catch{E({title:"فشل الخصم",description:"تعذر تنفيذ عملية الخصم",variant:"destructive"})}};return e.jsx(be,{open:i,onOpenChange:f,children:e.jsxs(ve,{className:"sm:max-w-lg animate-in fade-in-90 zoom-in-95 slide-in-from-top-4",dir:"rtl",children:[e.jsx(De,{children:e.jsxs(we,{className:"flex items-center gap-2 text-right",children:[e.jsx(is,{className:"h-5 w-5 text-emerald-600"}),"تفاصيل الفلوس النقدية"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between bg-amber-50 border border-amber-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 font-bold text-sm",children:[e.jsx(is,{className:"h-4 w-4"}),"مجموع الفلوس النقدية (الدرج)"]}),e.jsx("div",{className:"text-amber-700 font-extrabold text-sm",children:Ae(O)})]}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 font-bold text-sm",children:[e.jsx(Ld,{className:"h-4 w-4"}),"فلوس الاكسسوار"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-blue-700 font-extrabold text-sm",children:Ae(st)}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800",onClick:()=>{me("accessory"),Y(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-emerald-50 border border-emerald-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-800 font-bold text-sm",children:[e.jsx(jo,{className:"h-4 w-4"}),"فلوس الصيانة"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-emerald-700 font-extrabold text-sm",children:Ae(St)}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800",onClick:()=>{me("maintenance"),Y(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-red-800 font-bold text-sm",children:"خصم فلوس من الفلوس النقديه"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(x,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800",onClick:pe,children:"خصم"})})]})]}),e.jsx(ks,{open:L,onOpenChange:Y,mode:"verify",title:"تأكيد الرقم السري لعملية تم الاستلام",description:"يرجى إدخال الرقم السري الرئيسي لتأكيد استلام المبلغ",onSuccess:()=>{te&&(Tt(te),me(null)),Y(!1)}}),e.jsx(be,{open:_e,onOpenChange:Ne,children:e.jsxs(ve,{className:"sm:max-w-sm",children:[e.jsx(De,{children:e.jsx(we,{children:"سبب الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"deduct-reason",children:"اكتب سبب الخصم"}),e.jsx(q,{id:"deduct-reason",value:de,onChange:Se=>ae(Se.target.value),placeholder:"سبب الخصم"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(x,{variant:"outline",onClick:()=>Ne(!1),children:"إلغاء"}),e.jsx(x,{onClick:Me,className:"bg-red-600 hover:bg-red-700",children:"متابعة"})]})]})}),e.jsx(ks,{open:Le,onOpenChange:Qe,mode:"verify",title:"تأكيد الرقم السري لعملية الخصم",description:"يرجى إدخال الرقم السري الرئيسي لمتابعة الخصم",onSuccess:Oe}),e.jsx(be,{open:ze,onOpenChange:Ke,children:e.jsxs(ve,{className:"sm:max-w-sm",children:[e.jsx(De,{children:e.jsx(we,{children:"مبلغ الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"deduct-amount",children:"أدخل مبلغ الخصم"}),e.jsx(q,{id:"deduct-amount",type:"number",value:mt,onChange:Se=>Et(Se.target.value),placeholder:"0.00"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(x,{variant:"outline",onClick:()=>Ke(!1),children:"إلغاء"}),e.jsx(x,{onClick:rt,className:"bg-red-600 hover:bg-red-700",children:"تأكيد الخصم"})]})]})})]})})};function Fd({size:i=24,className:f,...d}){return e.jsxs("svg",{width:i,height:i,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:f,...d,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}var Bd="AlertDialog",[Hx]=vu(Bd,[Id]),za=Id(),Rd=i=>{const{__scopeAlertDialog:f,...d}=i,j=za(f);return e.jsx(fu,{...j,...d,modal:!0})};Rd.displayName=Bd;var Qx="AlertDialogTrigger",Gx=n.forwardRef((i,f)=>{const{__scopeAlertDialog:d,...j}=i,S=za(d);return e.jsx(Cu,{...S,...j,ref:f})});Gx.displayName=Qx;var Zx="AlertDialogPortal",Ud=i=>{const{__scopeAlertDialog:f,...d}=i,j=za(f);return e.jsx(yu,{...j,...d})};Ud.displayName=Zx;var Xx="AlertDialogOverlay",qd=n.forwardRef((i,f)=>{const{__scopeAlertDialog:d,...j}=i,S=za(d);return e.jsx(Iu,{...S,...j,ref:f})});qd.displayName=Xx;var Xr="AlertDialogContent",[ep,tp]=Hx(Xr),sp=ju("AlertDialogContent"),zd=n.forwardRef((i,f)=>{const{__scopeAlertDialog:d,children:j,...S}=i,I=za(d),s=n.useRef(null),v=Cd(f,s),W=n.useRef(null);return e.jsx(bu,{contentName:Xr,titleName:Vd,docsSlug:"alert-dialog",children:e.jsx(ep,{scope:d,cancelRef:W,children:e.jsxs(wu,{role:"alertdialog",...I,...S,ref:v,onOpenAutoFocus:Nu(S.onOpenAutoFocus,D=>{var $;D.preventDefault(),($=W.current)==null||$.focus({preventScroll:!0})}),onPointerDownOutside:D=>D.preventDefault(),onInteractOutside:D=>D.preventDefault(),children:[e.jsx(sp,{children:j}),e.jsx(rp,{contentRef:s})]})})})});zd.displayName=Xr;var Vd="AlertDialogTitle",Jd=n.forwardRef((i,f)=>{const{__scopeAlertDialog:d,...j}=i,S=za(d);return e.jsx(Su,{...S,...j,ref:f})});Jd.displayName=Vd;var Kd="AlertDialogDescription",Yd=n.forwardRef((i,f)=>{const{__scopeAlertDialog:d,...j}=i,S=za(d);return e.jsx(Du,{...S,...j,ref:f})});Yd.displayName=Kd;var ap="AlertDialogAction",Hd=n.forwardRef((i,f)=>{const{__scopeAlertDialog:d,...j}=i,S=za(d);return e.jsx(Ad,{...S,...j,ref:f})});Hd.displayName=ap;var Qd="AlertDialogCancel",Gd=n.forwardRef((i,f)=>{const{__scopeAlertDialog:d,...j}=i,{cancelRef:S}=tp(Qd,d),I=za(d),s=Cd(f,S);return e.jsx(Ad,{...I,...j,ref:s})});Gd.displayName=Qd;var rp=({contentRef:i})=>{const f=`\`${Xr}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${Xr}\` by passing a \`${Kd}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${Xr}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return n.useEffect(()=>{var j;document.getElementById((j=i.current)==null?void 0:j.getAttribute("aria-describedby"))||console.warn(f)},[f,i]),null},np=Rd,ip=Ud,Zd=qd,Xd=zd,em=Hd,tm=Gd,sm=Jd,am=Yd;const lp=np,op=ip,rm=n.forwardRef(({className:i,...f},d)=>e.jsx(Zd,{className:va("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",i),...f,ref:d}));rm.displayName=Zd.displayName;const nm=n.forwardRef(({className:i,...f},d)=>e.jsxs(op,{children:[e.jsx(rm,{}),e.jsx(Xd,{ref:d,className:va("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg rounded-2xl duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",i),...f})]}));nm.displayName=Xd.displayName;const im=({className:i,...f})=>e.jsx("div",{className:va("flex flex-col space-y-2 text-center sm:text-left",i),...f});im.displayName="AlertDialogHeader";const lm=n.forwardRef(({className:i,...f},d)=>e.jsx(sm,{ref:d,className:va("text-lg font-semibold",i),...f}));lm.displayName=sm.displayName;const om=n.forwardRef(({className:i,...f},d)=>e.jsx(am,{ref:d,className:va("text-sm text-muted-foreground",i),...f}));om.displayName=am.displayName;const vo=n.forwardRef(({className:i,...f},d)=>e.jsx(em,{ref:d,className:va(Td(),i),...f}));vo.displayName=em.displayName;const cm=n.forwardRef(({className:i,...f},d)=>e.jsx(tm,{ref:d,className:va(Td({variant:"outline"}),"mt-2 sm:mt-0",i),...f}));cm.displayName=tm.displayName;const zt=i=>{try{return i.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(i)}},vd=i=>{try{return(i?new Date(i):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},Ra="machine_daily_opening_values",Ua="machine_daily_opening_snapshot";function cp({open:i,onOpenChange:f}){const{toast:d}=da(),{shiftUser:j}=Yn(),{shopId:S,shopName:I}=qi(),s=()=>{try{const k=Object.keys(localStorage||{}).filter(ne=>ne.startsWith("selectedShopId_"));for(const ne of k){const Ee=localStorage.getItem(ne);if(Ee)return Ee}return null}catch{return null}};n.useEffect(()=>{try{if(i){const k=document.body.style.overflow;document.body.setAttribute("data-prev-overflow",k),document.body.style.overflow="hidden"}else{const k=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=k,document.body.removeAttribute("data-prev-overflow")}}catch{}return()=>{try{const k=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=k,document.body.removeAttribute("data-prev-overflow")}catch{}}},[i]);const[v,W]=n.useState(""),[D,$]=n.useState(""),[M,y]=n.useState(""),[N,O]=n.useState(null),[H,L]=n.useState(null),[Y,te]=n.useState(null),[me,E]=n.useState(null),[F,re]=n.useState(!1),[_e,Ne]=n.useState(!1),[de,ae]=n.useState(""),[Le,Qe]=n.useState(""),[ze,Ke]=n.useState(null),[mt,Et]=n.useState([]),[ee,Ae]=n.useState([]),[st,St]=n.useState(!1),[Tt,pe]=n.useState(""),[Me,Oe]=n.useState(""),[rt,Se]=n.useState(!1),[Ze,We]=n.useState(null),[Ie,He]=n.useState([]),[Z,ht]=n.useState(null),[Jt,Kt]=n.useState(""),[B,ge]=n.useState(!1),[Fe,kt]=n.useState(!1);n.useEffect(()=>{if(i)try{const k=Z?`${Ra}_${Z}`:Ra,ne=Z?`${Ua}_${Z}`:Ua,Ee=localStorage.getItem(k);if(Ee){const Be=JSON.parse(Ee);typeof(Be==null?void 0:Be.openingBase)=="number"&&O(Be.openingBase),typeof(Be==null?void 0:Be.openingAir)=="number"&&L(Be.openingAir),typeof(Be==null?void 0:Be.drawerCash)=="number"&&te(Be.drawerCash)}else O(null),L(null),te(null);const Xe=localStorage.getItem(ne);if(Xe){const Be=JSON.parse(Xe);typeof(Be==null?void 0:Be.openingBase)=="number"&&typeof(Be==null?void 0:Be.openingAir)=="number"?E({openingBase:Be.openingBase,openingAir:Be.openingAir,drawerCash:Be.drawerCash||0}):E(null)}else E(null)}catch{}},[i,Z]),n.useEffect(()=>{(async()=>{try{const k=S||s();if(!i||!k)return;const{getDocs:ne}=await yt(async()=>{const{getDocs:ct}=await import("./index-DCCNgGPW.js").then(Q=>Q.ck);return{getDocs:ct}},__vite__mapDeps([0,1]),import.meta.url),Ee=ye(U,"shops",k,"machines"),Be=(await ne(Je(Ee))).docs.map(ct=>({id:ct.id,name:String(ct.data().name||"ماكينة")}));He(Be);try{const ct=localStorage.getItem(`machineDaily_selected_${k}`);ct&&Be.some(ut=>ut.id===ct)?ht(ct):!Z&&Be.length>0&&(ht(Be[0].id),localStorage.setItem(`machineDaily_selected_${k}`,Be[0].id))}catch{}}catch(k){console.error("Load machines error:",k)}})()},[i,S]);const vt=n.useMemo(()=>(j==null?void 0:j.displayName)||(j==null?void 0:j.name)||(j==null?void 0:j.username)||void 0,[j]),_t=n.useMemo(()=>ee.reduce((k,ne)=>k+(ne.profit||0),0),[ee]),ps=n.useMemo(()=>ee.reduce((k,ne)=>k+(ne.wholesalePrice||0),0),[ee]),Dt=async()=>{try{const k=S||s();if(k&&Z){const ne=ye(U,"shops",k,"machines",Z,"transfers"),Ee=await Ue(Je(ne));await Promise.all(Ee.docs.map(Xe=>ya(Xe.ref)));try{localStorage.setItem(`machineDaily_transfers_${k}_${Z}`,JSON.stringify([]))}catch{}}}catch{}Ae([]),d({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."})},dt=async()=>{try{const k=S||s();if(k&&Z){const ne=ye(U,"shops",k,"machines",Z,"deliveries"),Ee=await Ue(Je(ne));await Promise.all(Ee.docs.map(Xe=>ya(Xe.ref)));try{localStorage.setItem(`machineDaily_deliveries_${k}_${Z}`,JSON.stringify([]))}catch{}}}catch{}Et([]),d({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."})},Mt=k=>{Et(ne=>ne.filter(Ee=>Ee.id!==k)),d({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},xs=()=>{O(null),L(null),te(null),E(null),W(""),$(""),y("");try{const k=Z?`${Ra}_${Z}`:Ra,ne=Z?`${Ua}_${Z}`:Ua;localStorage.removeItem(k),localStorage.removeItem(ne)}catch{}d({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},Ot=async()=>{var Xe;const k=parseFloat(v||"0"),ne=parseFloat(D||"0"),Ee=parseFloat(M||"0");if(isNaN(k)||isNaN(ne)||isNaN(Ee)){d({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(k<0||ne<0||Ee<0){d({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}O(k),L(ne),te(Ee);try{const Be=Z?`${Ra}_${Z}`:Ra,ct=Z?`${Ua}_${Z}`:Ua;localStorage.setItem(Be,JSON.stringify({openingBase:k,openingAir:ne,drawerCash:Ee})),localStorage.setItem(ct,JSON.stringify({openingBase:k,openingAir:ne,drawerCash:Ee})),E({openingBase:k,openingAir:ne,drawerCash:Ee});const Q=S||s();if(Q&&Z){const ut=$e(U,"shops",Q,"machines",Z);await Ps(ut,{name:((Xe=Ie.find(ft=>ft.id===Z))==null?void 0:Xe.name)||"ماكينة",openingBase:k,openingAir:ne,drawerCash:Ee,cashierName:vt,shopName:I||null,updatedAt:gt()},{merge:!0})}}catch{}d({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${zt(k)}، الهواء: ${zt(ne)}، فلوس الدرج: ${zt(Ee)}`})},Fs=()=>{if(N==null||H==null){d({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}Ne(!0)},ta=()=>{const k=parseFloat(de||"0"),ne=parseFloat(Le||"0");if(isNaN(k)||isNaN(ne)){d({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(k<0||ne<0){d({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const Ee=(me==null?void 0:me.openingBase)??(N||0),Xe=(me==null?void 0:me.openingAir)??(H||0),Be=Ee+Xe,Q=k+ne-Be;Ke(Q);const ut={id:`${Date.now()}`,openingBase:Ee,openingAir:Xe,deliveryBase:k,deliveryAir:ne,netResult:Q,createdAt:new Date().toISOString(),cashierName:vt,requiredDrawerNoProfit:Q<0?Math.round(-Q*100)/100:0};(async()=>{try{const ft=S||s();ft&&Z&&(await ka(ye(U,"shops",ft,"machines",Z,"deliveries"),{cashierName:vt,openingBase:Ee,openingAir:Xe,deliveryBase:k,deliveryAir:ne,netResult:Q,createdAt:gt()}),await Ps($e(U,"shops",ft,"machines",Z),{lastDeliveryAt:gt(),updatedAt:gt()},{merge:!0}))}catch(ft){console.error("Persist delivery error:",ft)}})(),Et(ft=>[ut,...ft]);try{const ft=S||s(),fs=ft&&Z?`machineDaily_deliveries_${ft}_${Z}`:`machineDaily_deliveries_${Z}`,ls=localStorage.getItem(fs),os=ls?JSON.parse(ls):[],J=[ut,...Array.isArray(os)?os:[]];localStorage.setItem(fs,JSON.stringify(J))}catch{}d({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${zt(Q)}`})},wa=()=>{const k=parseFloat(Tt||"0"),ne=parseFloat(Me||"0");if(!Number.isFinite(k)||!Number.isFinite(ne)){d({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if(k<0||ne<0){d({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(N==null||H==null){d({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const Ee=Math.round((ne-k)*100)/100;We({wholesalePrice:k,retailPrice:ne,profit:Ee}),Se(!0)},gs=async k=>{if(!Ze)return;const ne={id:`transfer_${Date.now()}`,wholesalePrice:Ze.wholesalePrice,retailPrice:Ze.retailPrice,profit:Ze.profit,createdAt:new Date().toISOString(),cashierName:vt,deductFrom:k},Ee=Ze.wholesalePrice,Xe=N??0,Be=H??0,ct=Y??0;if(Ee>(k==="base"?Xe:Be)){d({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const ut=k==="base"?Math.round((Xe-Ee)*100)/100:Xe,ft=k==="air"?Math.round((Be-Ee)*100)/100:Be,fs=Ze.retailPrice,ls=Math.round((ct+fs)*100)/100;O(ut),L(ft),te(ls);try{const os=Z?`${Ra}_${Z}`:Ra,J=Z?`${Ua}_${Z}`:Ua;localStorage.setItem(os,JSON.stringify({openingBase:ut,openingAir:ft,drawerCash:ls})),localStorage.setItem(J,JSON.stringify({openingBase:ut,openingAir:ft,drawerCash:ls}));const cs=S||s();if(cs&&Z){const oa=$e(U,"shops",cs,"machines",Z);await Ps(oa,{openingBase:ut,openingAir:ft,drawerCash:ls,cashierName:vt,updatedAt:gt()},{merge:!0}),await ka(ye(U,"shops",cs,"machines",Z,"transfers"),{wholesalePrice:Ze.wholesalePrice,retailPrice:Ze.retailPrice,profit:Ze.profit,deductFrom:k,cashierName:vt,createdAt:gt()})}}catch{}Ae(os=>[ne,...os]);try{const os=S||s(),J=os&&Z?`machineDaily_transfers_${os}_${Z}`:"machineDaily_transfers",cs=localStorage.getItem(J),oa=cs?JSON.parse(cs):[],Na=[ne,...Array.isArray(oa)?oa:[]];localStorage.setItem(J,JSON.stringify(Na))}catch{}St(!1),pe(""),Oe(""),We(null),Se(!1),d({title:"تم تسجيل تحويل",description:`الربح الفوري: ${zt(ne.profit)} | خصم المخزون: -${zt(Ee)} (${k==="base"?"الأساسي":"الهواء"}) | درج (المباع فقط): +${zt(fs)}`})},Va=()=>{W(""),$(""),Ne(!1),ae(""),Qe(""),Ke(null)},sa=async()=>{if(!i||!Z)return;const k=S||s();if(k){try{const ne=ye(U,"shops",k,"machines",Z,"deliveries"),Be=[...(await Ue(Je(ne))).docs.map(ct=>{var ft,fs;const Q=ct.data(),ut=(fs=(ft=Q==null?void 0:Q.createdAt)==null?void 0:ft.toDate)!=null&&fs.call(ft)?Q.createdAt.toDate():new Date;return{id:ct.id,openingBase:Number((Q==null?void 0:Q.openingBase)||0),openingAir:Number((Q==null?void 0:Q.openingAir)||0),deliveryBase:Number((Q==null?void 0:Q.deliveryBase)||0),deliveryAir:Number((Q==null?void 0:Q.deliveryAir)||0),netResult:typeof(Q==null?void 0:Q.netResult)=="number"?Number(Q.netResult):Math.round((Number((Q==null?void 0:Q.deliveryBase)||0)+Number((Q==null?void 0:Q.deliveryAir)||0)-(Number((Q==null?void 0:Q.openingBase)||0)+Number((Q==null?void 0:Q.openingAir)||0)))*100)/100,createdAt:ut.toISOString(),cashierName:(Q==null?void 0:Q.cashierName)||void 0,requiredDrawerNoProfit:typeof(Q==null?void 0:Q.requiredDrawerNoProfit)=="number"?Q.requiredDrawerNoProfit:void 0}})].sort((ct,Q)=>new Date(Q.createdAt).getTime()-new Date(ct.createdAt).getTime());Et(Be);try{localStorage.setItem(`machineDaily_deliveries_${k}_${Z}`,JSON.stringify(Be))}catch{}}catch(ne){console.error("Error fetching deliveries:",ne)}try{const ne=ye(U,"shops",k,"machines",Z,"transfers"),Be=[...(await Ue(Je(ne))).docs.map(ct=>{var fs,ls;const Q=ct.data(),ut=(ls=(fs=Q==null?void 0:Q.createdAt)==null?void 0:fs.toDate)!=null&&ls.call(fs)?Q.createdAt.toDate():new Date,ft=Q==null?void 0:Q.deductFrom;return{id:ct.id,wholesalePrice:Number((Q==null?void 0:Q.wholesalePrice)||0),retailPrice:Number((Q==null?void 0:Q.retailPrice)||0),profit:Number((Q==null?void 0:Q.profit)??(Number((Q==null?void 0:Q.retailPrice)||0)-Number((Q==null?void 0:Q.wholesalePrice)||0)||0)),createdAt:ut.toISOString(),cashierName:(Q==null?void 0:Q.cashierName)||void 0,deductFrom:ft==="base"||ft==="air"?ft:void 0}})].sort((ct,Q)=>new Date(Q.createdAt).getTime()-new Date(ct.createdAt).getTime());Ae(Be);try{localStorage.setItem(`machineDaily_transfers_${k}_${Z}`,JSON.stringify(Be))}catch{}}catch(ne){console.error("Error fetching transfers:",ne)}d({title:"تم التحديث",description:"تم جلب أحدث البيانات."})}};n.useEffect(()=>{if(!i||!Z)return;const k=S||s();try{const ne=k?`machineDaily_deliveries_${k}_${Z}`:`machineDaily_deliveries_${Z}`,Ee=localStorage.getItem(ne);if(Ee){const ct=JSON.parse(Ee);Array.isArray(ct)&&Et(ct)}const Xe=k?`machineDaily_transfers_${k}_${Z}`:`machineDaily_transfers_${Z}`,Be=localStorage.getItem(Xe);if(Be){const ct=JSON.parse(Be);Array.isArray(ct)&&Ae(ct)}}catch{}sa()},[i,S,Z]);const Ks=k=>{k||Va(),f(k)};return e.jsxs(be,{open:i,onOpenChange:Ks,children:[e.jsxs(ve,{className:"w-screen h-[100vh] overflow-hidden rounded-none p-0 flex flex-col dark:bg-[#121212]",children:[e.jsxs(De,{className:"sticky top-0 bg-white dark:bg-[#0F0F0F] z-20 border-b border-gray-200 dark:border-[#333] px-4 py-3",children:[e.jsx(we,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Fd,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(us,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"px-4 py-3 overflow-y-auto flex-1 grid grid-cols-1 gap-6",children:[e.jsxs(bt,{children:[e.jsx(ns,{className:"pb-2",children:e.jsxs(js,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"اختيار ماكينة"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(x,{variant:"destructive",onClick:async()=>{try{if(!S||!Z)return;const k=$e(U,"shops",S,"machines",Z);try{const Ee=await Ue(ye(U,"shops",S,"machines",Z,"transfers"));await Promise.all(Ee.docs.map(Xe=>ya(Xe.ref)))}catch{}try{const Ee=await Ue(ye(U,"shops",S,"machines",Z,"deliveries"));await Promise.all(Ee.docs.map(Xe=>ya(Xe.ref)))}catch{}await ya(k),He(Ee=>Ee.filter(Xe=>Xe.id!==Z));const ne=Ie.find(Ee=>Ee.id!==Z);ht(ne?ne.id:null);try{const Ee=`${Ra}_${Z}`,Xe=`${Ua}_${Z}`;localStorage.removeItem(Ee),localStorage.removeItem(Xe)}catch{}d({title:"تم حذف الماكينة",description:"تمت الإزالة نهائيًا."})}catch{d({title:"فشل الحذف",description:"تعذر حذف الماكينة.",variant:"destructive"})}},disabled:!Z,title:"حذف الماكينة",children:e.jsx(Ns,{className:"h-4 w-4"})})})]})}),e.jsx(At,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الماكينة الحالية"}),e.jsxs(rr,{value:Z??"",onValueChange:k=>{ht(k);try{const ne=S||s();ne&&localStorage.setItem(`machineDaily_selected_${ne}`,k)}catch{}},children:[e.jsx(nr,{className:"text-right",children:e.jsx(ir,{placeholder:"اختر ماكينة"})}),e.jsx(lr,{children:Ie.map(k=>e.jsx(pa,{value:k.id,children:k.name},k.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"إنشاء ماكينة جديدة"}),e.jsx(q,{value:Jt,onChange:k=>Kt(k.target.value),placeholder:"اسم الماكينة",className:"text-right"})]}),e.jsx("div",{className:"flex justify-end md:justify-start",children:e.jsx(x,{onClick:async()=>{try{if(!S){d({title:"لا يوجد محل",description:"يرجى التأكد من تحميل بيانات المحل.",variant:"destructive"});return}const k=(Jt||"").trim();if(!k){d({title:"اسم الماكينة مطلوب",description:"أدخل اسم للماكينة الجديدة.",variant:"destructive"});return}const ne=await ka(ye(U,"shops",S,"machines"),{name:k,shopId:S,createdAt:gt(),updatedAt:gt(),isActive:!0}),Ee={id:ne.id,name:k};He(Xe=>[Ee,...Xe]),ht(ne.id),Kt(""),d({title:"تم إنشاء ماكينة",description:`تمت إضافة ${k}`})}catch(k){console.error("Create machine error:",k),d({title:"خطأ في الإنشاء",description:"تعذر إنشاء الماكينة.",variant:"destructive"})}},className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})})]})]})})]}),e.jsxs(bt,{children:[e.jsx(ns,{className:"pb-2",children:e.jsxs(js,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>re(k=>!k),className:"flex items-center gap-1",children:e.jsx(zn,{className:`h-4 w-4 transition-transform ${F?"rotate-180":""}`})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(x,{variant:"outline",onClick:()=>St(!0),disabled:N==null||H==null,className:"border-violet-300 text-violet-700",children:"تحويل"})}),N!=null&&H!=null&&e.jsxs(Bt,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",zt(N)," | هواء ",zt(H)," | درج ",zt(Y??0)]})]}),e.jsxs(At,{className:`space-y-4 ${F?"":"hidden"}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:v,onChange:k=>W(k.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:D,onChange:k=>$(k.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:M,onChange:k=>y(k.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(x,{variant:"outline",className:"mr-2",onClick:xs,children:"تصفير"}),e.jsx(x,{onClick:Ot,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),e.jsxs(bt,{children:[e.jsx(ns,{className:"pb-2",children:e.jsxs(js,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات تحويل"}),e.jsxs(Bt,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",zt(_t)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:Dt,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(fa,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(At,{className:"space-y-3",children:ee.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-3 max-h-52 overflow-y-auto pr-1",children:ee.map(k=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر الجملة"}),e.jsx("p",{className:"text-sm",children:zt(k.wholesalePrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر التجزئة"}),e.jsx("p",{className:"text-sm",children:zt(k.retailPrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الربح الفوري"}),e.jsx("p",{className:"text-sm text-green-700",children:zt(k.profit)}),k.deductFrom&&e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"text-[11px] bg-violet-100 text-violet-700 border border-violet-200 rounded px-2 py-0.5",children:["الخصم من: ",k.deductFrom==="base"?"الأساسي":"الهواء"]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(Dr,{className:"h-3 w-3"}),e.jsx("span",{children:vd(k.createdAt)}),k.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Bi,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",k.cashierName]})]})]})]})]},k.id))})})]}),e.jsxs(bt,{children:[e.jsx(ns,{className:"pb-2",children:e.jsx(js,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(At,{className:"space-y-4",children:_e?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:de,onChange:k=>ae(k.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Le,onChange:k=>Qe(k.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>Ne(!1),children:"إلغاء"}),e.jsx(x,{onClick:ta,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),ze!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(Bt,{className:ze>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",zt(ze)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(Bt,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",zt(parseFloat(de||"0")+parseFloat(Le||"0"))]}),e.jsxs(Bt,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",zt(ps)]})]})]})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(x,{variant:"outline",onClick:Fs,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs(bt,{children:[e.jsx(ns,{className:"pb-2",children:e.jsxs(js,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:dt,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(fa,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(At,{className:"space-y-3",children:mt.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:mt.map(k=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",zt(k.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",zt(k.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",zt(k.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",zt(k.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>Mt(k.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(Ns,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${k.netResult>=0?"text-green-700":"text-red-700"}`,children:zt(k.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",zt(k.deliveryBase+k.deliveryAir)]}),typeof k.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",zt(k.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(Dr,{className:"h-3 w-3"}),e.jsx("span",{children:vd(k.createdAt)}),k.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Bi,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",k.cashierName]})]})]})]})]},k.id))})})]})]}),e.jsxs(it,{className:"sticky bottom-0 bg-white dark:bg-[#0F0F0F] z-20 border-t border-gray-200 dark:border-[#333] px-4 py-3 flex items-center justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>Ks(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(qa,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(be,{open:st,onOpenChange:St,children:e.jsxs(ve,{className:"sm:max-w-sm",children:[e.jsx(De,{children:e.jsx(we,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Tt,onChange:k=>pe(k.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(q,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Me,onChange:k=>Oe(k.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(Bt,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",zt(parseFloat(Me||"0")-parseFloat(Tt||"0")||0)]})})]}),e.jsxs(it,{className:"flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>St(!1),children:"إلغاء"}),e.jsx(x,{onClick:wa,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(lp,{open:rt,onOpenChange:Se,children:e.jsxs(nm,{children:[e.jsxs(im,{children:[e.jsx(lm,{children:"اختيار مصدر الخصم"}),e.jsx(om,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(cm,{onClick:()=>Se(!1),children:"رجوع"}),e.jsx(vo,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>gs("base"),children:"خصم من الأساسي"}),e.jsx(vo,{className:"bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>gs("air"),children:"خصم من الهواء"})]})]})})]})}function dp(i,f=300){const[d,j]=Ye.useState(i);return Ye.useEffect(()=>{const S=setTimeout(()=>j(i),f);return()=>clearTimeout(S)},[i,f]),d}const mp=({userId:i,transactions:f})=>{const[d,j]=n.useState(!1),[S,I]=n.useState(!1),[s,v]=n.useState(!1),[W,D]=n.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:$}=_a();n.useEffect(()=>{i&&d&&s&&M()},[i,d,s]);const M=async()=>{if(i)try{if(Array.isArray(f)&&f.length>0){const Y=new Date,te=Y.getMonth(),me=Y.getFullYear(),E=Rs.filterVisibleTransactions(f,"monthly",i);let F=0,re=0;E.forEach(_e=>{const Ne=new Date(_e.createdAt),de=String(_e.status||"confirmed").toLowerCase();if(Ne.getMonth()!==te||Ne.getFullYear()!==me||de!=="completed"&&de!=="confirmed")return;const ae=(_e.type||_e.txnType||"").toLowerCase(),Le={type:ae==="withdrawal"?"withdraw":ae,amount:Number(_e.amount||0),commission:_e.commission};Le.type==="withdraw"?F+=cr.calculateProfitFromTransaction(Le):(Le.type==="send"||Le.type==="receive"||Le.type==="transfer")&&(re+=cr.calculateProfitFromTransaction(Le))}),D({monthlyWithdrawalProfit:Math.round(F*100)/100,monthlyTransferProfit:Math.round(re*100)/100,lastUpdated:new Date});return}const L=cr.getWithdrawTransferProfits(i);D({monthlyWithdrawalProfit:L.monthlyWithdrawProfit||0,monthlyTransferProfit:L.monthlyTransferProfit||0,lastUpdated:new Date})}catch(L){console.error("Error loading profit data:",L)}},y=L=>`${L.toFixed(2)} ج.م`,N=async()=>{try{const L=($==null?void 0:$.subscription)||null,Y=(L==null?void 0:L.planType)??(L==null?void 0:L.plan)??null,te=typeof Y=="string"?Y.toLowerCase():null;if(Y===Xs.ZERO||te==="zero"||te==="0"||Y===0)return!0}catch{}try{if(i){const L=await wo(i),Y=(L==null?void 0:L.planType)??(L==null?void 0:L.plan)??null,te=typeof Y=="string"?Y.toLowerCase():null;if(Y===Xs.ZERO||te==="zero"||te==="0"||Y===0)return!0}}catch{}return!1},O=async()=>{try{if(await N()){rd({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}I(!0)},H=async()=>{try{if(await N()){rd({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),I(!1);return}}catch{}v(!0),j(!0),I(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:O,className:"h-6 w-6 p-0 text-gray-400 hover:text-purple-600 hover:bg-purple-50 rounded-full transition-colors duration-200",title:"عرض الأرباح الشهرية",children:e.jsx(Ss,{className:"h-4 w-4"})}),e.jsx(be,{open:d,onOpenChange:j,children:e.jsxs(ve,{className:"max-w-[280px] sm:max-w-[320px] mx-auto bg-white border border-gray-200 shadow-xl rounded-xl p-0 overflow-hidden",children:[e.jsx(De,{className:"bg-gray-50 px-4 py-3 border-b border-gray-100",children:e.jsxs(we,{className:"text-sm font-bold text-gray-900 flex items-center justify-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-white rounded-full border border-gray-200",children:e.jsx(Dr,{className:"h-4 w-4 text-purple-600"})}),"أرباح الشهر"]})}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg border border-gray-100 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-red-50 rounded-md",children:e.jsx(Qr,{className:"h-3.5 w-3.5 text-red-600"})}),e.jsx("span",{className:"font-medium text-gray-700 text-sm",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-gray-900",children:y(W.monthlyWithdrawalProfit)})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg border border-gray-100 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-green-50 rounded-md",children:e.jsx(jo,{className:"h-3.5 w-3.5 text-green-600"})}),e.jsx("span",{className:"font-medium text-gray-700 text-sm",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-gray-900",children:y(W.monthlyTransferProfit)})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-purple-50 rounded-lg border border-purple-100 mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-white rounded-md shadow-sm",children:e.jsx(is,{className:"h-3.5 w-3.5 text-purple-600"})}),e.jsx("span",{className:"font-bold text-purple-900 text-sm",children:"الإجمالي"})]}),e.jsx("span",{className:"font-bold text-base text-purple-700",children:y(W.monthlyWithdrawalProfit+W.monthlyTransferProfit)})]})]}),e.jsx("div",{className:"bg-gray-50 px-4 py-3 border-t border-gray-100 flex justify-center",children:e.jsx(x,{onClick:()=>j(!1),className:"bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 hover:text-gray-900 w-full sm:w-auto px-8 rounded-lg text-sm font-medium shadow-sm",children:"إغلاق"})})]})}),e.jsx(ks,{open:S,onOpenChange:I,onSuccess:H,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},hp=i=>e.jsx(mp,{...i});function up({open:i,onOpenChange:f,onSuccess:d,userId:j}){const[S,I]=n.useState(""),[s,v]=n.useState(""),[W,D]=n.useState(!1),[$,M]=n.useState(!1),[y,N]=n.useState(""),[O,H]=n.useState(!1),[L,Y]=n.useState(!1),{toast:te}=da();n.useEffect(()=>{let F=!0;return(async()=>{const re=await Ls.hasMasterPin(j);F&&Y(re)})(),()=>{F=!1}},[j,i]);const me=()=>{I(""),v(""),N(""),D(!1),M(!1),f(!1)},E=async F=>{F.preventDefault(),N(""),H(!0);try{if(L){if(!await Ls.verifyMasterPin(S,j)){N("الرقم السري غير صحيح"),H(!1);return}}else{if(S.length<4){N("يجب أن يكون الرقم السري 4 أرقام على الأقل"),H(!1);return}if(S!==s){N("الرقم السري غير متطابق"),H(!1);return}if(!await Ls.createMasterPin(S,j)){N("تعذر إنشاء الرقم السري الرئيسي"),H(!1);return}}te({title:"نجح العملية",description:L?"تم التحقق من الرقم السري الرئيسي بنجاح":"تم إنشاء الرقم السري الرئيسي بنجاح"}),d(),me()}catch{N("حدث خطأ أثناء معالجة الرقم السري")}finally{H(!1)}};return e.jsx(be,{open:i,onOpenChange:f,children:e.jsxs(ve,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(De,{children:e.jsxs(we,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(ba,{className:"h-5 w-5 text-green-600"}),L?"أدخل الرقم السري الرئيسي":"إنشاء الرقم السري الرئيسي"]})}),e.jsxs("form",{onSubmit:E,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:L?"أدخل الرقم السري الرئيسي لعرض بيانات الأرباح":"قم بإنشاء الرقم السري الرئيسي لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"pin",children:L?"الرقم السري الرئيسي":"الرقم السري الرئيسي الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"pin",type:W?"text":"password",value:S,onChange:F=>I(F.target.value),placeholder:L?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>D(!W),children:W?e.jsx(ea,{className:"h-4 w-4"}):e.jsx(Ss,{className:"h-4 w-4"})})]})]}),!L&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"confirmPin",type:$?"text":"password",value:s,onChange:F=>v(F.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>M(!$),children:$?e.jsx(ea,{className:"h-4 w-4"}):e.jsx(Ss,{className:"h-4 w-4"})})]})]}),y&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ir,{className:"h-4 w-4"}),y]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(x,{type:"submit",disabled:O,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(ba,{className:"h-4 w-4 mr-2"}),O?"جاري المعالجة...":L?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(x,{type:"button",variant:"outline",onClick:me,disabled:O,children:"إلغاء"})]})]})]})})}const xp=({userId:i,transactions:f})=>{const[d,j]=n.useState(!1),[S,I]=n.useState(!1),[s,v]=n.useState(!1),[W,D]=n.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});n.useEffect(()=>{i&&d&&s&&$()},[i,d,s,f]);const $=async()=>{if(i)try{if(Array.isArray(f)&&f.length>0){const H=new Date,L=Rs.filterVisibleTransactions(f,"daily",i);let Y=0,te=0;L.forEach(me=>{const E=new Date(me.createdAt),F=String(me.status||"confirmed").toLowerCase();if(E.toDateString()!==H.toDateString())return;const re=(me.type||me.txnType||"").toLowerCase(),_e=String(me.title||"");if(re==="cash_addition"||_e.includes("إيصال إضافة نقدية"))return;const Ne={type:re==="withdrawal"?"withdraw":re,amount:Number(me.amount||0),commission:me.commission};Ne.type==="withdraw"?Y+=cr.calculateProfitFromTransaction(Ne):(Ne.type==="send"||Ne.type==="receive"||Ne.type==="transfer")&&(te+=cr.calculateProfitFromTransaction(Ne))}),D({dailyWithdrawalProfit:Math.round(Y*100)/100,dailyTransferProfit:Math.round(te*100)/100,lastUpdated:new Date});try{cr.updateProfitsFromTransactions(f,i)}catch{}return}const O=cr.getWithdrawTransferProfits(i);D({dailyWithdrawalProfit:O.dailyWithdrawProfit||0,dailyTransferProfit:O.dailyTransferProfit||0,lastUpdated:new Date})}catch(O){console.error("Error loading profit data:",O)}},M=O=>`${O.toFixed(2)} ج.م`,y=()=>{cr.hasProfitPin(i),I(!0)},N=()=>{v(!0),j(!0),I(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:y,className:"h-6 w-6 p-0 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors duration-200",title:"عرض الأرباح اليومية",children:e.jsx(Ss,{className:"h-4 w-4"})}),e.jsx(be,{open:d,onOpenChange:j,children:e.jsxs(ve,{className:"max-w-[280px] sm:max-w-[320px] mx-auto bg-white border border-gray-200 shadow-xl rounded-xl p-0 overflow-hidden",children:[e.jsx(De,{className:"bg-gray-50 px-4 py-3 border-b border-gray-100",children:e.jsxs(we,{className:"text-sm font-bold text-gray-900 flex items-center justify-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-white rounded-full border border-gray-200",children:e.jsx(is,{className:"h-4 w-4 text-blue-600"})}),"أرباح اليوم"]})}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg border border-gray-100 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-red-50 rounded-md",children:e.jsx(Qr,{className:"h-3.5 w-3.5 text-red-600"})}),e.jsx("span",{className:"font-medium text-gray-700 text-sm",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-gray-900",children:M(W.dailyWithdrawalProfit)})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg border border-gray-100 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-green-50 rounded-md",children:e.jsx(jo,{className:"h-3.5 w-3.5 text-green-600"})}),e.jsx("span",{className:"font-medium text-gray-700 text-sm",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-gray-900",children:M(W.dailyTransferProfit)})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-100 mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-white rounded-md shadow-sm",children:e.jsx(is,{className:"h-3.5 w-3.5 text-blue-600"})}),e.jsx("span",{className:"font-bold text-blue-900 text-sm",children:"الإجمالي"})]}),e.jsx("span",{className:"font-bold text-base text-blue-700",children:M(W.dailyWithdrawalProfit+W.dailyTransferProfit)})]})]}),e.jsx("div",{className:"bg-gray-50 px-4 py-3 border-t border-gray-100 flex justify-center",children:e.jsx(x,{onClick:()=>j(!1),className:"bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 hover:text-gray-900 w-full sm:w-auto px-8 rounded-lg text-sm font-medium shadow-sm",children:"إغلاق"})})]})}),e.jsx(up,{open:S,onOpenChange:I,onSuccess:N,userId:i})]})},pp=i=>e.jsx(xp,{...i});function gp({isOpen:i,onClose:f,wallets:d,walletBalances:j,onSelectWallet:S,selectedWalletId:I}){const s=W=>{S(W),f()},v=Object.values(j).reduce((W,D)=>W+(Number(D)||0),0);return e.jsx(be,{open:i,onOpenChange:f,children:e.jsxs(ve,{className:"sm:max-w-md bg-gradient-to-br from-white to-gray-50 border-0 shadow-2xl",children:[e.jsx(De,{className:"space-y-4 pb-4 border-b border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-blue-100 rounded-full",children:e.jsx(ia,{className:"w-6 h-6 text-blue-600"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(we,{className:"text-xl font-bold text-gray-900",children:"المحافظ المتاحة"}),e.jsxs("p",{className:"text-sm text-gray-500 font-medium",children:["إجمالي الرصيد: ",e.jsxs("span",{className:"text-blue-600 font-bold text-base",children:[v.toLocaleString("en-US")," جنيه"]})]})]})]})}),e.jsx(Ku,{className:"max-h-[60vh] pr-4 -mr-4",children:e.jsx("div",{className:"grid gap-3 py-2",children:d.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200",children:e.jsx("p",{children:"لا توجد محافظ مضافة"})}):d.map(W=>{const D=j[W.id]||0,$=I===W.id;return e.jsxs("button",{onClick:()=>s(W.id),className:va("w-full group relative flex items-center justify-between p-4 rounded-xl border-2 transition-all duration-200",$?"border-blue-500 bg-blue-50/50 shadow-md ring-1 ring-blue-200":"border-transparent bg-white hover:bg-gray-50 hover:border-gray-200 shadow-sm hover:shadow-md"),children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:va("w-12 h-12 rounded-full flex items-center justify-center transition-colors",$?"bg-blue-100 text-blue-600":"bg-gray-100 text-gray-500 group-hover:bg-gray-200"),children:e.jsx(ia,{className:"w-6 h-6"})}),e.jsxs("div",{className:"flex flex-col items-start gap-1",children:[e.jsx("span",{className:va("font-bold text-lg",$?"text-blue-900":"text-gray-900"),children:W.name}),e.jsxs("div",{className:"flex items-center gap-1.5 text-gray-500",children:[e.jsx(Pa,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"text-sm font-medium dir-ltr",children:W.phone})]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsxs("span",{className:va("font-extrabold text-lg",D>0?"text-emerald-600":"text-gray-400"),children:[D.toLocaleString("en-US"),e.jsx("span",{className:"text-xs mr-1 font-medium text-gray-400",children:"جنيه"})]}),$&&e.jsxs("div",{className:"flex items-center gap-1 text-xs font-bold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full",children:[e.jsx(Un,{className:"w-3 h-3"}),"مختار"]})]})]},W.id)})})})]})})}const fp=({open:i,onOpenChange:f})=>{var Sa;const{shiftUser:d,isShiftActive:j,shiftStartAt:S,setShiftUser:I,startShift:s,endShift:v}=Yn(),{userSubscription:W,user:D,signIn:$,profile:M}=_a(),{toast:y}=da(),[N,O]=n.useState((d==null?void 0:d.name)||""),[H,L]=n.useState((d==null?void 0:d.username)||""),[Y,te]=n.useState(""),[me,E]=n.useState(!1),[F,re]=n.useState(null),[_e,Ne]=n.useState(""),[de,ae]=n.useState(""),[Le,Qe]=n.useState(!1),[ze,Ke]=n.useState(null),[mt,Et]=n.useState(""),[ee,Ae]=n.useState(""),[st,St]=n.useState(!1),[Tt,pe]=n.useState(!1),[Me,Oe]=n.useState({totalTransfers:0,totalWithdrawals:0}),[rt,Se]=n.useState(null),[Ze,We]=n.useState(""),[Ie,He]=n.useState(""),[Z,ht]=n.useState(0),[Jt,Kt]=n.useState({}),[B,ge]=n.useState(0),[Fe,kt]=n.useState(0),[vt,_t]=n.useState({}),[ps,Dt]=n.useState(""),[dt,Mt]=n.useState(!1),xs=V=>{const ke={"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9","۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9","٫":".","،":".","٬":"."," ":""};return V.split("").map(nt=>ke[nt]??nt).join("")},Ot=()=>`cashierUsers_${(D==null?void 0:D.uid)||"default"}`,[Fs,ta]=n.useState(()=>{try{let V=localStorage.getItem(Ot());if(!V){const ke=localStorage.getItem("cashierUsers");ke&&(V=ke)}return V?JSON.parse(V):[]}catch{return[]}});n.useEffect(()=>{(async()=>{try{if(!(D!=null&&D.uid))return;const V=$e(U,"profiles",D.uid,"cashierUsers","list"),ke=await Ws(V);if(ke.exists()){const nt=ke.data(),Nt=Array.isArray(nt==null?void 0:nt.users)?nt.users:[];Nt&&Nt.length>0&&ta(Nt)}}catch{}})()},[D==null?void 0:D.uid]),n.useEffect(()=>{if(!(D!=null&&D.uid))return;(async()=>{try{const ke=$e(U,"profiles",D.uid,"cashierUsers","list"),nt=await Ws(ke);if(nt.exists()){const Nt=nt.data(),_s=Array.isArray(Nt==null?void 0:Nt.users)?Nt.users:[];if(_s&&_s.length>0)ta(_s);else try{const Ds=localStorage.getItem(Ot()),Qt=Ds?JSON.parse(Ds):[];ta(Qt)}catch{ta([])}}}catch(ke){console.warn("Failed to fetch cashierUsers:",ke)}})()},[D==null?void 0:D.uid]);const wa=(Sa=W==null?void 0:W.subscription)==null?void 0:Sa.planType,gs=wa==="yearly"?2:wa==="lifetime"?4:Number.POSITIVE_INFINITY;n.useEffect(()=>{try{localStorage.setItem(Ot(),JSON.stringify(Fs));try{localStorage.removeItem("cashierUsers")}catch{}}catch{}(async()=>{try{if(!(D!=null&&D.uid))return;const V=$e(U,"profiles",D.uid,"cashierUsers","list");await Ps(V,{users:Fs},{merge:!0})}catch{}})()},[Fs]);const[Va,sa]=n.useState(!1),[Ks,k]=n.useState(""),[ne,Ee]=n.useState(null),[Xe,Be]=n.useState([]),[ct,Q]=n.useState(!1),[ut,ft]=n.useState(null),[fs,ls]=n.useState(!1),[os,J]=n.useState(!1),cs=V=>{const ke=(d==null?void 0:d.username)===V;let nt=!1;try{nt=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(ke&&!(ke&&!j&&(ps==="الأدمن الرئيسي"||nt))){y({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const Ds=`هل أنت متأكد من حذف المستخدم ${V}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(Ds)&&(ta(Qt=>Qt.filter(Us=>Us.username!==V)),ke&&I(null),y({title:"تم حذف المستخدم",description:V}))},oa=()=>{if(!N.trim()||!H.trim()||!Y.trim())return;if(Fs.length>=gs){y({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(gs)?gs:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const V={name:N.trim(),username:H.trim(),password:Y.trim()};ta(ke=>[V,...ke]),O(""),L(""),te("")},Na=()=>{E(!0),re(null),Ke(null),Et(""),Ae("")},ma=async()=>{try{let V=[];try{D!=null&&D.uid&&(V=await Ce.getUserTransactions(D.uid))}catch{}if(!V||V.length===0)try{const tt=await Wd({merchantUserId:D==null?void 0:D.uid,limit:200});V=(tt==null?void 0:tt.transactions)||[]}catch{}const ke=S?new Date(S):null,nt=new Date,Nt=tt=>{const $t=tt.type,qs=tt.txnType;return $t==="withdraw"||$t==="withdrawal"||$t==="receive"||qs==="receive"},_s=tt=>{const $t=tt.type,qs=tt.txnType;return $t==="send"||$t==="transfer"||qs==="send"},Ds=tt=>{if(!tt)return null;if(tt instanceof Date)return tt;try{const $t=new Date(tt);return Number.isNaN($t.getTime())?null:$t}catch{return null}},Qt=tt=>{const $t=Ds(tt.createdAt||tt.created_at||tt.timestamp);return!$t||ke&&$t<ke?!1:$t<=nt},Us=tt=>tt==="completed"||tt==="confirmed",Ja=V.filter(tt=>Us(tt.status)&&Qt(tt)),ha=Ja.filter(tt=>Nt(tt)).reduce((tt,$t)=>{const qs=$t.withdrawnAmount??$t.receivedAmount??$t.amount??0;return tt+(Number(qs)||0)},0);return{totalTransfers:Ja.filter(tt=>_s(tt)).reduce((tt,$t)=>{const qs=$t.sentAmount??$t.transferredAmount??$t.amount??0;return tt+(Number(qs)||0)},0),totalWithdrawals:ha}}catch{return{totalTransfers:0,totalWithdrawals:0}}};n.useEffect(()=>{if(Tt){try{const V=localStorage.getItem("shiftInitialReceivedDrawerFunds");V!==null&&He(V)}catch{}try{const V=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(V!==null){const ke=parseFloat(V);ht(Number.isFinite(ke)?ke:0)}}catch{}}},[Tt]),n.useEffect(()=>{me&&(async()=>{try{const V=await ma();Oe(V)}catch{}})()},[me]),n.useEffect(()=>{if(!i&&!ct)return;(async()=>{try{const nt=((D!=null&&D.uid?await Ce.getUserTransactions(D.uid):[])||[]).filter(Nt=>(Nt==null?void 0:Nt.type)==="report"||((Nt==null?void 0:Nt.title)||"").includes("إيصال تسليم وردية"));nt.sort((Nt,_s)=>{const Ds=new Date(Nt.createdAt||0).getTime();return new Date(_s.createdAt||0).getTime()-Ds}),Be(nt)}catch{Be([])}})()},[i,Tt,ct,D==null?void 0:D.uid]);const ja=async(V,ke,nt)=>{try{let Nt=0,_s=0;try{const Qt=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");Nt=Number.isFinite(Qt)?Qt:0}catch{}try{const Qt=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");_s=Number.isFinite(Qt)?Qt:0}catch{}const Ds={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(d==null?void 0:d.username)||"cashier",receiverPhone:ps||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(d==null?void 0:d.name)||(d==null?void 0:d.username)||null,deficit:ke,deficitAmount:ke?nt:0,shiftStartAt:S,receivedDrawerFunds:Nt,receivedWalletBalancesTotal:_s,receivedWalletBalances:Jt,deliveredDrawerFunds:B||0,deliveredWalletBalancesTotal:Fe||0,deliveredWalletBalances:vt,shiftProfit:Math.round(((B||0)+(Fe||0)-(Nt+_s))*100)/100};D!=null&&D.uid&&await Ce.saveUserTransaction(D.uid,Ds),Be(Qt=>[Ds,...Qt||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(be,{open:i,onOpenChange:f,children:e.jsxs(ve,{className:"sm:max-w-md",children:[e.jsx(De,{children:e.jsx(we,{children:j?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),j?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[d==null?void 0:d.name," (",d==null?void 0:d.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),Fs.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:Fs.map((V,ke)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:V.name}),e.jsx("div",{className:"text-xs text-gray-500",children:V.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(x,{size:"sm",className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>{Ee(V),sa(!0)},children:"دخول"}),e.jsx(x,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>cs(V.username),children:"حذف"})]})]},ke))})]})]}),e.jsx(it,{className:"flex flex-wrap gap-2 justify-between",children:j?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(x,{className:"w-full sm:w-auto",variant:"destructive",onClick:Na,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(x,{className:"w-full sm:w-auto bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>J(!0),children:"إضافة مستخدم جديد"}),e.jsx(x,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>Q(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(be,{open:os,onOpenChange:J,children:e.jsxs(ve,{className:"sm:max-w-md",children:[e.jsx(De,{children:e.jsx(we,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(G,{className:"mb-1 block",children:"الاسم"}),e.jsx(q,{value:N,onChange:V=>O(V.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(G,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(q,{value:H,onChange:V=>L(V.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(G,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(q,{type:"password",autoComplete:"new-password",value:Y,onChange:V=>te(V.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(it,{className:"flex gap-2 justify-between",children:[e.jsx(x,{variant:"secondary",onClick:()=>{J(!1)},children:"إلغاء"}),e.jsx(x,{onClick:()=>{!N.trim()||!H.trim()||!Y.trim()||(oa(),J(!1))},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"حفظ المستخدم"})]})]})}),e.jsx(be,{open:ct,onOpenChange:Q,children:e.jsxs(ve,{className:"sm:max-w-lg",children:[e.jsx(De,{children:e.jsx(we,{children:"إيصالات التسليم"})}),Xe.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:Xe.map(V=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{ft(V),ls(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(V.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",V.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",V.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",V.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",V.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",V.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",V.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",V.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",V.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",V.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(V.shiftProfit??(V.deliveredDrawerFunds??0)+(V.deliveredWalletBalancesTotal??0)-(V.receivedDrawerFunds??0)-(V.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",V.shiftProfit??(V.deliveredDrawerFunds??0)+(V.deliveredWalletBalancesTotal??0)-(V.receivedDrawerFunds??0)-(V.receivedWalletBalancesTotal??0)]})]}),V.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",V.deficitAmount??0]})]},V.id))}),e.jsx(it,{className:"flex gap-2 justify-between",children:e.jsx(x,{variant:"secondary",onClick:()=>Q(!1),children:"إغلاق"})})]})}),e.jsx(be,{open:fs,onOpenChange:ls,children:e.jsxs(ve,{className:"sm:max-w-md",children:[e.jsx(De,{children:e.jsx(we,{children:"إيصال تسليم وردية"})}),ut?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(ut.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",ut.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",ut.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",ut.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",ut.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",ut.deliveredWalletBalancesTotal??0]})]})]}),ut.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",ut.deficitAmount??0]})]}),ut.receivedWalletBalances&&Object.keys(ut.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(ut.receivedWalletBalances).map(([V,ke])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:V}),e.jsx("span",{className:"font-semibold",children:ke})]},V))})]}),ut.deliveredWalletBalances&&Object.keys(ut.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(ut.deliveredWalletBalances).map(([V,ke])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:V}),e.jsx("span",{className:"font-semibold",children:ke})]},V))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(it,{className:"flex gap-2 justify-between",children:e.jsx(x,{variant:"secondary",onClick:()=>ls(!1),children:"إغلاق"})})]})}),e.jsx(be,{open:Va,onOpenChange:sa,children:e.jsxs(ve,{className:"sm:max-w-md",children:[e.jsx(De,{children:e.jsx(we,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:ne?`${ne.name} (${ne.username})`:""}),e.jsx(q,{type:"password",autoComplete:"off",value:Ks,onChange:V=>k(V.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(it,{className:"flex gap-2 justify-between",children:[e.jsx(x,{variant:"secondary",onClick:()=>{k(""),Ee(null),sa(!1)},children:"إلغاء"}),e.jsx(x,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{if(ne){if(Ks.trim()!==ne.password){y({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}I({name:ne.name,username:ne.username}),k(""),sa(!1),f(!1),s(),Mt(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(be,{open:dt,onOpenChange:Mt,children:e.jsxs(ve,{className:"sm:max-w-md",children:[e.jsx(De,{children:e.jsx(we,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(G,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(q,{type:"text",inputMode:"decimal",value:Ie,onChange:V=>He(xs(V.target.value)),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(G,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(q,{type:"text",inputMode:"decimal",value:Number.isFinite(Z)?Z:0,onChange:V=>{const ke=parseFloat(xs(V.target.value));ht(Number.isFinite(ke)?ke:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(it,{className:"flex gap-2 justify-between",children:e.jsx(x,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{const V=parseFloat(Ie),ke=Z,nt=Number.isFinite(V)&&V>=0,Nt=Number.isFinite(ke)&&ke>=0;if(!nt||!Nt){y({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(V)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(ke))}catch{}y({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),Mt(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(be,{open:me,onOpenChange:V=>{V&&E(!0)},children:e.jsxs(ve,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(De,{children:e.jsx(we,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:F==="toUser"?"default":"secondary",onClick:()=>re("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(x,{variant:F==="toAdmin"?"default":"secondary",onClick:()=>re("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),F==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[Fs.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:Fs.map((V,ke)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(ze==null?void 0:ze.username)===V.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>Ke(V),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:V.name}),e.jsx("div",{className:"text-xs text-gray-500",children:V.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},ke))})]}),e.jsxs("div",{children:[e.jsx(G,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(q,{type:"password",autoComplete:"off",value:mt,onChange:V=>Et(V.target.value),placeholder:"أدخل كلمة السر"})]}),ee&&e.jsx("div",{className:"text-xs text-red-600",children:ee})]}),F==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(q,{type:"password",autoComplete:"off",value:_e,onChange:V=>Ne(V.target.value),placeholder:"كلمة المرور"}),de&&e.jsx("div",{className:"text-xs text-red-600",children:de})]})]}),e.jsx(it,{className:"flex gap-2 justify-between",children:e.jsx(x,{disabled:st||!F,onClick:async()=>{if(F){St(!0);try{const V=Me;if(ma().then(Oe).catch(()=>{}),F==="toUser"){if(!ze){Ae("يرجى اختيار المستخدم أولاً"),St(!1);return}if(mt.trim()!==ze.password){Ae("كلمة السر غير صحيحة"),St(!1);return}v(),I({name:ze.name,username:ze.username}),s(),Dt(`${ze.name} (${ze.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}E(!1),re(null),Ke(null),Et(""),Ae(""),f(!1),Oe(V),Se(null),We(""),pe(!0)}else if(F==="toAdmin"){ae("");const ke=(D==null?void 0:D.email)||"";if(!ke){ae("لا يوجد بريد للمستخدم الرئيسي للتحقق"),St(!1);return}const{error:nt}=await $(ke,_e);if(nt){ae("كلمة المرور غير صحيحة"),St(!1);return}v(),I(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}Ne(""),E(!1),f(!1),Dt("الأدمن الرئيسي"),Oe(V),Se(null),We(""),pe(!0)}}catch{Ae("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{St(!1)}}},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"تأكيد التسليم"})})]})}),e.jsx(be,{open:Tt,onOpenChange:pe,children:e.jsxs(ve,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(De,{children:e.jsx(we,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:ps})]}),S&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(S).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(G,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(q,{type:"number",value:Ie,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(G,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(q,{type:"number",value:Z,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(G,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(q,{type:"text",inputMode:"decimal",value:B,onChange:V=>{const ke=parseFloat(xs(V.target.value));ge(Number.isFinite(ke)?ke:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(G,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(q,{type:"text",inputMode:"decimal",value:Fe,onChange:V=>{const ke=parseFloat(xs(V.target.value));kt(Number.isFinite(ke)?ke:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(B??0)+(Fe??0)-((parseFloat(Ie||"0")||0)+(Z??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((B??0)+(Fe??0)-((parseFloat(Ie||"0")||0)+(Z??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"}),e.jsx("div",{className:"mt-2 grid grid-cols-1 gap-2",children:e.jsxs("div",{className:"rounded border p-2 bg-gray-50",children:[e.jsx("div",{className:"text-xs text-gray-700",children:"مطلوب من الدرج (بدون أرباح)"}),e.jsx("div",{className:"text-sm font-semibold text-gray-900",children:Math.round(((B??0)-(parseFloat(Ie||"0")||0))*100)/100})]})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:rt==="no"?"default":"secondary",onClick:()=>Se("no"),children:"لا"}),e.jsx(x,{variant:rt==="yes"?"default":"secondary",onClick:()=>Se("yes"),children:"نعم"})]}),rt==="yes"&&e.jsxs("div",{children:[e.jsx(G,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(q,{type:"number",value:Ze,onChange:V=>We(V.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(it,{className:"flex gap-2 justify-between",children:e.jsx(x,{onClick:()=>{const V=rt==="yes",ke=parseFloat(Ze)||0;(async()=>await ja(Me,V,ke))(),y({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),pe(!1)},className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:"تأكيد وحفظ الإيصال"})})]})})]})},yp=({open:i,onOpenChange:f})=>{const{shiftUser:d,endShift:j,setShiftUser:S}=Yn(),[I,s]=n.useState(""),[v,W]=n.useState(""),[D,$]=n.useState([]),{user:M}=_a();n.useEffect(()=>{(async()=>{try{if(M!=null&&M.uid){const N=$e(U,"profiles",M.uid,"cashierUsers","list"),O=await Ws(N);if(O.exists()){const H=O.data(),L=Array.isArray(H==null?void 0:H.users)?H.users:[];if(L&&L.length>0){$(L);return}}}}catch{}try{const N=`cashierUsers_${(M==null?void 0:M.uid)||"default"}`;let O=localStorage.getItem(N);if(!O){const H=localStorage.getItem("cashierUsers");H&&(O=H)}$(O?JSON.parse(O):[])}catch{$([])}})()},[i,M==null?void 0:M.uid]),n.useEffect(()=>{if(!i||!(M!=null&&M.uid))return;const N=async()=>{try{const H=$e(U,"profiles",M.uid,"cashierUsers","list"),L=await Ws(H);if(L.exists()){const Y=L.data(),te=Array.isArray(Y==null?void 0:Y.users)?Y.users:[];te&&te.length>0?$(te):O()}else O()}catch(H){console.warn("ShiftProfileDialog cashierUsers fetch error:",H),O()}},O=()=>{try{const H=`cashierUsers_${(M==null?void 0:M.uid)||"default"}`;let L=localStorage.getItem(H);if(!L){const Y=localStorage.getItem("cashierUsers");Y&&(L=Y)}$(L?JSON.parse(L):[])}catch{$([])}};N()},[i,M==null?void 0:M.uid]);const y=async()=>{if(W(""),!d)return;const N=D.find(O=>O.username===d.username);if(!N){W("لا يوجد مستخدم مطابق لهذه الوردية");return}if(I.trim()!==N.password){W("الرقم السري غير صحيح");return}j(),S(null),s(""),f(!1)};return e.jsx(be,{open:i,onOpenChange:N=>{s(""),W(""),f(N)},children:e.jsxs(ve,{className:"sm:max-w-md",children:[e.jsx(De,{children:e.jsx(we,{children:"بروفيل الوردية"})}),d?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:d.name}),e.jsx("div",{className:"text-xs text-gray-600",children:d.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx(q,{type:"password",value:I,onChange:N=>s(N.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),v&&e.jsx("div",{className:"text-red-600 text-xs",children:v})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(it,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>f(!1),children:"إغلاق"}),e.jsx(x,{onClick:y,disabled:!d,children:"تسليم الوردية"})]})]})})},bp=({open:i,onOpenChange:f})=>e.jsx(be,{open:i,onOpenChange:f,children:e.jsxs(ve,{className:"sm:max-w-lg rounded-2xl",children:[e.jsxs(De,{children:[e.jsxs(we,{className:"text-right flex items-center gap-2 justify-end",children:[e.jsx(ho,{className:"w-5 h-5"}),"سجل التغييرات الأخيرة"]}),e.jsx(us,{className:"text-right",children:"هذه أبرز التحسينات التي تمت مؤخرًا في الواجهة."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(yo,{className:"w-5 h-5 text-amber-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحسين نافذة تعديل المديونية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"استبدال نافذة الإدخال القديمة (prompt) بحوار أنيق لإدخال المبلغ مع تأكيد."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Hu,{className:"w-5 h-5 text-violet-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحديث شاشة التحميل"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:'تغيير النص إلى "صلي علي النبي" مع خط عربي جميل ونبض لطيف.'})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ho,{className:"w-5 h-5 text-green-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"بطاقات الأرباح وعدد العمليات"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"إضافة بطاقات عرض أرباح الفترة الحالية وعدد العمليات في تفاصيل المحفظة."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ho,{className:"w-5 h-5 text-blue-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"إصلاح تمرير نافذة اليومية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"منع تمرير الصفحة الخلفية عند فتح نافذة اليومية لراحة الاستخدام."})]})]})]}),e.jsx("div",{className:"flex justify-end gap-2 mt-6",children:e.jsx(x,{variant:"secondary",onClick:()=>f(!1),children:"إغلاق"})})]})});class Gr{static async processTransfer(f){const{amount:d,currentCashBalance:j,currentWalletBalances:S,wallets:I,selectedWalletId:s}=f;if(d<=0)return{success:!1,newCashBalance:j,newWalletBalances:S,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!f.skipRemoteLimitsCheck)try{const $=await Ta.canPerformOperation(s,d,"transfer");if(!$.canPerform)return{success:!1,newCashBalance:j,newWalletBalances:S,message:$.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch($){return console.error("خطأ في التحقق من حدود التحويل:",$),{success:!1,newCashBalance:j,newWalletBalances:S,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(d<=0)return{success:!1,newCashBalance:j,newWalletBalances:S,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s){const $=Math.max(S[s]||0,0);if($<d){const M=I.find(y=>y.id===s);return{success:!1,newCashBalance:j,newWalletBalances:S,message:`رصيد غير كافي في المحفظة${M?` ${M.name}`:""}. المتاح: ${$} جنيه، المطلوب: ${d} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const $=Gr.calculateTotalWalletBalance(S);if($<d)return{success:!1,newCashBalance:j,newWalletBalances:S,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${$} جنيه، المبلغ المطلوب: ${d} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const v={...S};if(s){const $=v[s]||0;v[s]=$-d}else{let $=d;for(const M of I){if($<=0)break;const y=Math.max(v[M.id]||0,0),N=Math.min(y,$);N>0&&(v[M.id]=(v[M.id]||0)-N,$-=N)}}const W=j+d;let D="تم التحويل بنجاح";if(s){const $=v[s]||0;$<0&&(D=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${s} أصبح ${$} جنيه.`)}return{success:!0,newCashBalance:W,newWalletBalances:v,message:D}}static processDeposit(f){const{amount:d,currentCashBalance:j,currentWalletBalances:S,wallets:I}=f;if(d<=0)return{success:!1,newCashBalance:j,newWalletBalances:S,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const s=this.calculateTotalWalletBalance(S);if(s<d)return{success:!1,newCashBalance:j,newWalletBalances:S,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${s} جنيه، المبلغ المطلوب: ${d} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const v=j+d,W={...S};let D=d;const $=I.find(y=>y.isDefault);if($&&W[$.id]>=D)W[$.id]-=D,D=0;else for(const y of I){if(D<=0)break;const N=W[y.id]||0;if(N>0){const O=Math.min(N,D);W[y.id]=N-O,D-=O}}const M=D>0?`تم الإيداع جزئياً. تم إيداع ${d-D} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${d} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:v,newWalletBalances:W,message:M}}static async processWithdraw(f){const{amount:d,currentCashBalance:j,currentWalletBalances:S,wallets:I,selectedWalletId:s}=f;if(d<=0)return{success:!1,newCashBalance:j,newWalletBalances:S,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!f.skipRemoteLimitsCheck)try{const $=await Ta.canPerformOperation(s,d,"withdraw");if(!$.canPerform)return{success:!1,newCashBalance:j,newWalletBalances:S,message:$.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch($){return console.error("خطأ في التحقق من حدود السحب:",$),{success:!1,newCashBalance:j,newWalletBalances:S,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(j<d)return{success:!1,newCashBalance:j,newWalletBalances:S,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${j} جنيه، المبلغ المطلوب: ${d} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const v=j-d,W={...S},D=s?I.find($=>$.id===s):I.find($=>$.isDefault)||I[0];if(D){const $=W[D.id]||0;W[D.id]=$+d}else return{success:!1,newCashBalance:j,newWalletBalances:S,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};return{success:!0,newCashBalance:v,newWalletBalances:W,message:`تم السحب بنجاح. تم إضافة ${d} جنيه إلى محفظة ${(D==null?void 0:D.name)||""}`}}static validateOperation(f,d){return f<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!d||d.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(f){return Object.values(f).reduce((d,j)=>d+Math.max(j,0),0)}static deductFromWalletsAddToCash(f,d,j,S){return this.processTransfer({amount:f,currentCashBalance:d,currentWalletBalances:j,wallets:S})}static deductFromWalletsAddToCashDeposit(f,d,j,S){return this.processDeposit({amount:f,currentCashBalance:d,currentWalletBalances:j,wallets:S})}static deductFromCashAddToWallets(f,d,j,S){return this.processWithdraw({amount:f,currentCashBalance:d,currentWalletBalances:j,wallets:S})}static applyTransactionResult(f,d,j){f.success&&(d(f.newCashBalance),j(f.newWalletBalances))}static validateTransaction(f,d,j,S){if(f<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(d==="transfer"){const I=this.calculateTotalWalletBalance(S);if(I<f)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${I} جنيه) غير كافي للمبلغ المطلوب (${f} جنيه)`}}else if(d==="withdraw"){if(j<f)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${j} جنيه) غير كافي للمبلغ المطلوب (${f} جنيه)`}}else if(d==="deposit"){const I=this.calculateTotalWalletBalance(S);if(I<f)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${I} جنيه) غير كافي للمبلغ المطلوب (${f} جنيه)`}}return{isValid:!0}}static getDeductionPreview(f,d,j){const S=[];let I=f;for(const s of j){if(I<=0)break;const v=d[s.id]||0,W=Math.min(Math.max(v,0),I);W>0&&(S.push({walletId:s.id,walletName:s.name,currentBalance:v,deductedAmount:W,newBalance:v-W}),I-=W)}return S}}let Bn=null;function vp(){const i=window;if(!Bn){const f=i.AudioContext||i.webkitAudioContext;Bn=new f}return Bn.state==="suspended"&&Bn.resume(),Bn}function wp(i,f,d){const j=d/1e3,S=Math.floor(i.sampleRate*j),I=i.createBuffer(1,S,i.sampleRate),s=I.getChannelData(0);for(let $=0;$<S;$++)s[$]=(Math.random()*2-1)*.6;const v=i.createBufferSource();v.buffer=I;const W=i.createBiquadFilter();W.type="highpass",W.frequency.value=1500,W.Q.value=.7;const D=i.createGain();D.gain.setValueAtTime(1e-4,f),D.gain.exponentialRampToValueAtTime(.4,f+.015),D.gain.exponentialRampToValueAtTime(1e-4,f+j),v.connect(W),W.connect(D),D.connect(i.destination),v.start(f),v.stop(f+j+.01)}function Np(i,f,d,j,S,I="triangle"){const s=i.createOscillator(),v=i.createGain();s.type=I;const W=S/1e3;s.frequency.setValueAtTime(d,f),s.frequency.linearRampToValueAtTime(j,f+W),v.gain.setValueAtTime(1e-4,f),v.gain.exponentialRampToValueAtTime(.25,f+.02),v.gain.exponentialRampToValueAtTime(1e-4,f+W),s.connect(v),v.connect(i.destination),s.start(f),s.stop(f+W+.02)}function jp(){try{const i=vp(),f=i.currentTime;wp(i,f,90),Np(i,f+.12,1900,1100,180,"sawtooth")}catch{}}function Sp(i){if(!i)return!1;const d=i.replace(/[^0-9٠-٩]/g,"").replace(/[٠-٩]/g,j=>"0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(j)]);return/^(010|011|012|015)[0-9]{8}$/.test(d)}function Dp({userId:i}){const[f,d]=Ye.useState(null),[j,S]=Ye.useState("");return null}const jg=()=>{var Zc,Xc,ed,td,sd;console.log("🔥 UserDashboardPage component is loading...");const{toast:i}=da(),f=n.useRef(null),[d,j]=n.useState(0),S=async()=>{var r,l,o;const t="alkaptin678678@gmail.com",a=(l=(r=Hr.currentUser)==null?void 0:r.email)==null?void 0:l.toLowerCase();if(!a||a!==t){i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}if(!pi||!gi||!fi){i({title:"بيانات ناقصة",description:"أدخل رقم الموبايل، الشركة والمبلغ",variant:"destructive"});return}try{Cc(!0);const h=await((o=Hr.currentUser)==null?void 0:o.getIdToken()),m=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...h?{Authorization:`Bearer ${h}`}:{}},body:JSON.stringify({phone:pi,countryCode:"EG",operator:gi,amount:Number(fi),useLocalAmount:!0})}),u=await m.json().catch(()=>({}));m.ok&&(u!=null&&u.success)?(i({title:"تم الشحن",description:(u==null?void 0:u.message)||"تم تنفيذ عملية الشحن بنجاح"}),$l(!1),jc(""),Sc(""),Dc("")):i({title:"فشل الشحن",description:(u==null?void 0:u.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(h){console.error("Topup request error:",h),i({title:"خطأ غير متوقع",description:"تعذّر تنفيذ عملية الشحن. حاول لاحقاً.",variant:"destructive"})}finally{Cc(!1)}},{signOut:I,user:s,profile:v}=_a(),W=((s==null?void 0:s.email)||"").toLowerCase()==="vodafonecash00@gmail.com",D=Dd(),$=jd(),M=Au(),{isShiftActive:y,shiftUser:N}=Yn(),{shopId:O,shopName:H}=qi(),L=Tu(),Y=ku();(()=>{try{return!!window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:"}catch{return!1}})();const[te,me]=n.useState(!1),[E,F]=n.useState(!1),[re,_e]=n.useState(!1),[Ne,de]=n.useState(!1),[ae,Le]=n.useState(!1),[Qe,ze]=n.useState(!1),[Ke,mt]=n.useState([]),[Et,ee]=n.useState(""),[Ae,st]=n.useState(""),[St,Tt]=n.useState(""),[pe,Me]=n.useState(""),[Oe,rt]=n.useState(!1),[Se,Ze]=n.useState(!1),[We,Ie]=n.useState(null),[He,Z]=n.useState(""),[ht,Jt]=n.useState(""),[Kt,B]=n.useState(!1),[ge,Fe]=n.useState(!1),[kt,vt]=n.useState(!1),[_t,ps]=n.useState(null),[Dt,dt]=n.useState(!1),[Mt,xs]=n.useState(!1),[Ot,Fs]=n.useState(null);n.useEffect(()=>{Pu().then(Fs).catch(()=>{})},[]);const[ta,wa]=n.useState(void 0);n.useEffect(()=>{try{const t=window.electronAPI;t&&typeof t.appVersion=="function"&&t.appVersion().then(a=>{typeof a=="string"&&!a.startsWith("err:")&&wa(a)}).catch(()=>{})}catch{}},[]);const gs=(()=>{var r,l;const t=(l=(r=import.meta)==null?void 0:r.env)==null?void 0:l.VITE_APP_VERSION,a=typeof window<"u"&&(window.electronAPI||window.location.protocol==="file:"||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron"));if(a&&(v!=null&&v.desktopInstalledVersion))return v==null?void 0:v.desktopInstalledVersion;if(a&&ta)return ta;if(t)return t;if(!(!Ot&&!v))return Y?(v==null?void 0:v.androidInstalledVersion)||(v==null?void 0:v.lastAckAndroidVersion)||(Ot==null?void 0:Ot.androidVersion)||(Ot==null?void 0:Ot.pcVersion):(Ot==null?void 0:Ot.pcVersion)||(Ot==null?void 0:Ot.androidVersion)})();n.useEffect(()=>{ae&&(s!=null&&s.uid)&&!Mt&&(async()=>{rt(!0);try{let a=[],r=[];try{const m=ye(U,"users",s.uid,"branches");a=(await Ue(m)).docs.map(b=>({id:b.id,...b.data(),source:"sub"}))}catch(m){console.warn("Failed to fetch subcollection branches:",m)}try{const m=Je(ye(U,"branches"),le("ownerId","==",s.uid));r=(await Ue(m)).docs.map(b=>({id:b.id,...b.data(),source:"root"}))}catch(m){console.warn("Failed to fetch root branches:",m)}const l=[...a,...r],o=new Map;l.forEach(m=>{const u=m.branchUserId||m.id;(!o.has(u)||m.source==="sub")&&o.set(u,m)});const h=Array.from(o.values());console.log("Loaded branches:",h),mt(h),xs(!0)}catch(a){console.error("Error in branch loading process:",a),i({title:"تنبيه",description:"حدث خطأ أثناء تحديث القائمة",variant:"destructive"})}finally{rt(!1)}})()},[ae,s==null?void 0:s.uid,Mt]),n.useEffect(()=>{ae||dt(!1)},[ae]);const[Va,sa]=n.useState(!1),[Ks,k]=n.useState(null),[ne,Ee]=n.useState(""),[Xe,Be]=n.useState(""),[ct,Q]=n.useState(""),[ut,ft]=n.useState(!1),fs=t=>{k(t),Ee(t.branchName||""),Be(t.managerName||""),Q(t.loginUsername||t.email||t.username||""),sa(!0)},ls=async()=>{if(!(!Ks||!ne||!Xe)){ft(!0);try{const t={branchName:ne,managerName:Xe,updatedAt:new Date};if(Ks.branchUserId)try{await Ps($e(U,"users",(s==null?void 0:s.uid)||"","branches",String(Ks.branchUserId)),t,{merge:!0});try{await Xt($e(U,"users",Ks.branchUserId),{displayName:ne,managerName:Xe})}catch(a){console.warn("Could not update branch root user doc",a)}}catch(a){console.warn("Sub branch update failed:",a)}try{await Xt($e(U,"branches",Ks.id),t)}catch{}mt(a=>a.map(r=>r.id===Ks.id?{...r,...t}:r)),i({title:"تم تحديث بيانات الفرع بنجاح"}),sa(!1)}catch(t){console.error("Error updating branch:",t),i({title:"فشل تحديث البيانات",description:t.message,variant:"destructive"})}finally{ft(!1)}}},os=async t=>{if(!(t!=null&&t.branchUserId)){i({title:"خطأ",description:"بيانات الفرع غير مكتملة",variant:"destructive"});return}vt(!0),Fe(!0);try{const a=t.branchUserId;if(s!=null&&s.uid&&t.branchUserId&&t.source!=="sub")try{await Ps($e(U,"users",s.uid,"branches",t.branchUserId),{branchUserId:t.branchUserId,branchName:t.branchName||"Unknown Branch",managerName:t.managerName||"",active:!0,lastSynced:gt()},{merge:!0}),console.log("✅ Branch link synced successfully"),await new Promise(xt=>setTimeout(xt,500))}catch(xt){console.error("❌ Failed to sync branch link:",xt)}const[r,l,o,h]=await Promise.all([Ws($e(U,"users",a)),(async()=>{try{const xt=Je(ye(U,"merchantWallets"),le("merchantUserId","==",a)),Ct=await Ue(xt);if(!Ct.empty)return Ct;const ws=await Ue(ye(U,"users",a,"wallets"));return ws.empty?await Ue(Je(ye(U,"wallets"),le("userId","==",a))):ws}catch(xt){console.error("Error fetching wallets",xt);try{return await Ue(Je(ye(U,"wallets"),le("userId","==",a)))}catch{return{docs:[]}}}})(),(async()=>{try{return await Ue(Je(ye(U,"debts"),le("userId","==",a)))}catch{return await Ue(ye(U,"users",a,"debts"))}})(),(async()=>{try{const xt=Je(ye(U,"dailySales"),le("userId","==",a)),Ct=await Ue(xt);return Ct.empty?await Ue(ye(U,"users",a,"dailySales")):Ct}catch(xt){return console.error("Error fetching sales",xt),await Ue(ye(U,"users",a,"dailySales"))}})()]),m=r.exists()?r.data():{},u=Number(m.cashBalance||0),b=m.reportsData||{},p=Number(b.dailyProfit||0),g=Number(b.monthlyProfit||0),w=m.walletBalances||{};let C=Object.values(w).reduce((xt,Ct)=>xt+Number(Ct||0),0);C===0&&!l.empty&&(C=l.docs.reduce((xt,Ct)=>xt+Number(Ct.data().balance||Ct.data().amount||0),0));let A=0;o.forEach(xt=>{const Ct=xt.data();if(Ct.type!=="debtor"){const ws=Number(Ct.paidAmount||0),As=Math.max(0,Number(Ct.amount||0)-ws);A+=As}});const oe=new Date().toISOString().split("T")[0],_=oe.slice(0,7);let z=0,xe=0,qe=p,qt=g,Cs=0;console.log(`Branch Details - UID: ${a}, Wallets: ${l.size}, Sales: ${h.size}, ReportsDaily: ${p}`),h.forEach(xt=>{const Ct=xt.data(),ws=String(Ct.date||""),As=Number(Ct.sellingPrice||0)*Number(Ct.quantity||1),er=Number(Ct.profit||0);Cs+=As,ws===oe&&(z+=As,qe+=er),ws.startsWith(_)&&(xe+=As,qt+=er)}),ps({branchName:t.branchName,managerName:t.managerName,todaySales:z,monthSales:xe,todayProfit:qe,monthProfit:qt,walletsTotal:C,cashBalance:u,totalSalesSection:Cs,debtsTotal:A})}catch(a){console.error("Error fetching branch details:",a),i({title:"تعذر تحميل بيانات الفرع",description:a.message,variant:"destructive"}),Fe(!1)}finally{vt(!1)}},[J,cs]=n.useState("");n.useEffect(()=>{const t=M==null?void 0:M.shopId;if(t&&(s!=null&&s.uid))try{const a=`selectedShopId_${s.uid}`;localStorage.setItem(a,String(t)),window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}},[M==null?void 0:M.shopId,s==null?void 0:s.uid]);const[oa,Na]=n.useState([]),[ma,ja]=n.useState(()=>{try{return localStorage.getItem("cashySelectedDevice")||null}catch{return null}});n.useEffect(()=>{},[]),n.useEffect(()=>{(async()=>{if(J)try{await $n.set({key:"selected_wallet_id",value:J}),console.log("📱 Synced selected_wallet_id to Native:",J)}catch(a){console.error("Failed to sync wallet to native:",a)}else await $n.remove({key:"selected_wallet_id"})})()},[J]),n.useEffect(()=>{(async()=>{if(O)try{await $n.set({key:"shopId",value:O}),console.log("📱 Synced shopId to Native:",O)}catch(a){console.error("Failed to sync shopId to native:",a)}})()},[O]);const Sa=t=>!!(t&&oa.some(a=>a.id===t));async function V(){const t=window.electronAPI,a=ma||"";if(!t||typeof t.sendUssd!="function")return null;if(!a)return i({title:"الجهاز غير محدد",description:"اتصل بالموبايل أولاً ثم اختر الجهاز من القائمة",variant:"destructive"}),null;if(Sa(a))return a;try{const h=oa.find(m=>m&&m.id&&!String(m.id).includes(":"));if(h&&h.id)return ja(h.id),h.id}catch{}const r=a.includes(":")?a.split(":").slice(0,2).join(":"):"";if(r&&typeof t.connectWifi=="function"){try{const h=await t.connectWifi(r);if(typeof h=="string"&&(h.includes("✅")||h.toLowerCase().includes("connected")))return a}catch{}if(typeof t.refreshAdbDevices=="function")try{await t.refreshAdbDevices()}catch{}await new Promise(h=>setTimeout(h,250))}const l=a.split(":")[0],o=oa.find(h=>(h.id.startsWith(l)||h.id.includes(l))&&h.id.includes(":"));if(o!=null&&o.id){const h=o.id.split(":").slice(0,2).join(":");if(!Sa(o.id)&&typeof t.connectWifi=="function"){try{const m=await t.connectWifi(h);if(typeof m=="string"&&(m.includes("✅")||m.toLowerCase().includes("connected")))return ja(o.id),o.id}catch{}await new Promise(m=>setTimeout(m,250))}if(Sa(o.id))return ja(o.id),o.id}return a&&r?a:(i({title:"الجهاز غير متصل",description:"فعّل Wireless debugging أو استخدم اتصال Wi‑Fi ثم أعد المحاولة",variant:"destructive"}),null)}n.useEffect(()=>{const t=window.electronAPI;t&&typeof t.onAdbDevices=="function"&&t.onAdbDevices(a=>{var o;const r=Array.isArray(a)?a:[];Na(r);const l=(()=>{try{return localStorage.getItem("cashySelectedDevice")||""}catch{return""}})();l?ja(l):(o=r[0])!=null&&o.id?ja(h=>h||r[0].id):ja(null)})},[]);function ke(t,a){try{const r=Is==null?void 0:Is(),l=(r==null?void 0:r.phone)||"";if(!l){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"});return}Ju(l,t,a),i({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),fr(!1),$r(!1)}catch(r){const l=(r==null?void 0:r.message)||"تعذر إرسال الكود — تحقق من البيانات";throw i({title:"فشل الإرسال",description:l,variant:"destructive"}),r}}const[nt,Nt]=n.useState(null),_s=async()=>{var r;if(!Qs||!Qs.receiver||!Qs.amount){i({title:"بيانات غير مكتملة",description:"تأكد من إدخال رقم المستقبل والمبلغ قبل الإرسال",variant:"destructive"});return}const t=String(Qs.receiver),a=Math.round(Number(Qs.amount));yr(!0);try{if((r=Wi)!=null&&r.isNativePlatform&&Wi.getPlatform()==="android"){const o=Is==null?void 0:Is(),h=(o==null?void 0:o.phone)||"";if(!h){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),yr(!1);return}const m=ld(h,t,a);if(!m){i({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),yr(!1);return}Vu(m),i({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),fr(!1),$r(!1);return}const l=window.electronAPI;if(l&&typeof l.sendUssd=="function"&&ma){const o=Is==null?void 0:Is(),h=(o==null?void 0:o.phone)||"";if(!h){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),yr(!1);return}const m=await V();if(!m){yr(!1);return}const u=ld(h,t,a);if(!u){i({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),yr(!1);return}try{let b="";if(nt!==null)b=`${m}:sim${nt}`;else{const p=typeof l.pickSimAutomatically=="function"?await l.pickSimAutomatically(m,h):{deviceId:m,slot:0};b=`${p.deviceId}:sim${p.slot}`}Bm(b),await l.sendUssd(b,u)}catch{try{await l.sendUssd(m,u)}catch(p){const g=m.includes(":")?m.split(":").slice(0,2).join(":"):"";if(g&&typeof l.connectWifi=="function")await l.connectWifi(g),await l.sendUssd(m,u);else throw p}}i({title:"تم إرسال كود التحويل",description:"تم التنفيذ بنجاح"}),fr(!1),$r(!0)}else ke(t,a)}catch(l){const o=l&&l.message?l.message:"حدث خطأ غير متوقع أثناء الإرسال";i({title:"خطأ أثناء الإرسال",description:`الجهاز: ${Vo||ma||"غير معروف"} — ${o}`,variant:"destructive"})}finally{yr(!1)}},Ds=async(t,a)=>{const r=window.electronAPI;try{if(r&&typeof r.enterPin=="function"&&t){await r.enterPin(t,a),$r(!1);return}const l=String((v==null?void 0:v.bridgeLink)||"").trim(),o=String((v==null?void 0:v.bridgeDeviceId)||"").trim()||void 0;if(!l){i({title:"الرابط غير مُعدّ",description:"احفظ رابط الجسر أولاً",variant:"destructive"});return}const h=String((Qs==null?void 0:Qs.receiver)||Rt||"").replace(/\D/g,""),m=Math.max(1,Math.round(Number((Qs==null?void 0:Qs.amount)||Gt||0))||0),u=String(a||"").replace(/\D/g,""),p=(g=>{let w=(g||"").trim();return w=w.replace(/\/+$/,""),/^https?:\/\//i.test(w)||(w=`https://${w}`),w})(l);$r(!1)}catch(l){const o=(l==null?void 0:l.message)||"حدث خطأ أثناء إدخال الرقم السري";i({title:"فشل الإدخال",description:o,variant:"destructive"})}};console.log("🔥 UserDashboardPage - user:",s?"exists":"null");const[Qt,Us]=n.useState(!0),[Ja,ha]=n.useState(!0),[Da,tt]=n.useState(!1),[$t,qs]=n.useState(!1),[Cr,Ka]=n.useState(""),[Ar,en]=n.useState(""),[tn,sn]=n.useState(""),[mr,an]=n.useState([]),[Tr,kr]=n.useState(!1),[ys,Ya]=n.useState(null),[Ha,hr]=n.useState(""),[So,zi]=n.useState(!1),[rn,Pr]=n.useState(!1),[nn,ua]=n.useState(!1),[ln,ur]=n.useState(!1),[Oa,xr]=n.useState(""),[Hn,on]=n.useState(""),[cn,Ea]=n.useState([]),[c,T]=n.useState(!1),[P,K]=n.useState(0),[ue,ce]=n.useState(!1),[se,Te]=n.useState(null),[ie,Re]=n.useState(null),[je,jt]=n.useState(!1),[Lt,bs]=n.useState(""),[Rt,Ys]=n.useState(""),[Gt,ds]=n.useState(""),[Hs,dn]=n.useState(""),[_r,pr]=n.useState(""),[mn,Ma]=n.useState(!1),[Or,hn]=n.useState(""),[gr,$a]=n.useState(""),[Do,Io]=n.useState(""),[Vi,dm]=n.useState(""),[xa,Ji]=n.useState(null),[mm,Co]=n.useState(!1),[hm,Ao]=n.useState(!1),[um,Qn]=n.useState(!1),[xm,Ki]=n.useState(!1),[To,Yi]=n.useState(null),[Os,Hi]=n.useState(""),[Es,Qi]=n.useState(""),[ko,pm]=n.useState(""),[gm,Po]=n.useState(!1),[Ip,Cp]=n.useState(null),[Gi,_o]=n.useState(null),[fm,Zi]=n.useState(!1);n.useEffect(()=>{(async()=>{try{const a=s!=null&&s.uid?`withdrawSenderNameInputEnabled_${s==null?void 0:s.uid}`:"withdrawSenderNameInputEnabled";let r=null;try{r=localStorage.getItem(a)??localStorage.getItem("withdrawSenderNameInputEnabled")}catch{}if(s!=null&&s.uid)try{const l=await Ur(()=>Ce.getUserData(s.uid)),o=l==null?void 0:l.withdrawSenderNameInputEnabled;if(typeof o=="boolean"){Zi(o);try{localStorage.setItem(a,o?"true":"false")}catch{}return}}catch{}Zi(r==="true")}catch{Zi(!1)}})()},[s==null?void 0:s.uid]);const Gn=t=>{const a="٠١٢٣٤٥٦٧٨٩",r="۰۱۲۳۴۵۶۷۸۹";return(t||"").split("").map(l=>{const o=a.indexOf(l);if(o>-1)return String(o);const h=r.indexOf(l);return h>-1?String(h):l}).join("")},[Pt,Xi]=n.useState(()=>{try{const t=localStorage.getItem("commissionMode")||localStorage.getItem("commissionMode_default");return t?t==="add":!0}catch{return!0}}),[fe,Oo]=n.useState("transfer"),[Ge,aa]=n.useState([]),[La,el]=n.useState("all"),[wt,Ms]=n.useState([]),Wa=n.useRef([]),un=Fn({enabled:!!(s!=null&&s.uid),queryKey:["recentTransactions",s==null?void 0:s.uid,O||"main"],queryFn:async()=>{const{collection:t,query:a,where:r,orderBy:l,limit:o,getDocs:h}=await yt(async()=>{const{collection:_,query:z,where:xe,orderBy:qe,limit:qt,getDocs:Cs}=await import("./index-DCCNgGPW.js").then(xt=>xt.ck);return{collection:_,query:z,where:xe,orderBy:qe,limit:qt,getDocs:Cs}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await yt(async()=>{const{db:_}=await import("./index-DCCNgGPW.js").then(z=>z.cl);return{db:_}},__vite__mapDeps([0,1]),import.meta.url),u=a(t(m,"userTransactions"),r("userId","==",String((s==null?void 0:s.uid)||"")),l("createdAt","desc"),o(100)),g=(await h(u)).docs.map(_=>{var As;const z=_.data(),xe=(As=z.createdAt)!=null&&As.toDate?z.createdAt.toDate():new Date(z.createdAt),qe=String(z.transactionType||z.txnType||z.type||"").toLowerCase(),qt=qe==="withdraw"||qe==="receive"?"withdraw":"send",Cs=z.status==="confirmed"?"completed":z.status||"completed",xt=z.senderMsisdn||z.senderPhone||"",Ct=z.receiverMsisdn||z.receiverPhone||"",ws=Number(z.amount??z.transferredAmount??z.withdrawnAmount??0);return{id:_.id,...z,type:qt,status:Cs,senderPhone:xt,receiverPhone:Ct,amount:ws,createdAt:xe}}).filter(_=>!((_==null?void 0:_.type)==="report"||String((_==null?void 0:_.title)||"").includes("إيصال تسليم وردية"))),w=new Set((gn||[]).map(_=>String(_.id||_.originalTransactionId||""))),C=g.filter(_=>!w.has(String(_.id||""))),A=_=>{var z;return String(_.transactionId||_.id||_.reference||((z=_.receipt)==null?void 0:z.reference)||`${new Date(_.createdAt).getTime()}`)},R=new Set,oe=[];for(const _ of C){const z=A(_);R.has(z)||(R.add(z),oe.push(_))}return oe},staleTime:6e4,gcTime:3e5,refetchOnWindowFocus:!1,refetchOnReconnect:!0});n.useEffect(()=>{const t=()=>{try{un.refetch()}catch{}};return window.addEventListener("transaction-created",t),()=>{window.removeEventListener("transaction-created",t)}},[un]),n.useEffect(()=>{const t=un.data;if(t&&Array.isArray(t)){const a=Wa.current,r=Date.now(),l=a.filter(u=>{const b=t.some(w=>w.id===u.id),p=u.reference?t.some(w=>w.reference===u.reference):!1,g=r-new Date(u.createdAt).getTime()>3e5;return!b&&!p&&!g});Wa.current=l;const o=[...l,...t].sort((u,b)=>new Date(b.createdAt).getTime()-new Date(u.createdAt).getTime()),h=new Set,m=[];for(const u of o)h.has(u.id)||(h.add(u.id),m.push(u));aa(m)}},[un.data]),n.useEffect(()=>{try{if(localStorage.setItem("commissionMode",Pt?"add":"deduct"),s!=null&&s.uid){const t=`commissionMode_${s.uid}`;localStorage.setItem(t,Pt?"add":"deduct")}}catch{}},[Pt,s==null?void 0:s.uid]),n.useEffect(()=>{try{const t=new Set((Ge||[]).filter(l=>String((l==null?void 0:l.status)||"")==="completed"&&(l==null?void 0:l.linkedDebtId)).map(l=>String(l.linkedDebtId)));if(t.size===0)return;const a=wt.map(l=>{if(t.has(String(l.id))){const o=Number(l.amount||0),h=Number(l.paidAmount||0);if(l.status!=="paid"||h<o)return{...l,status:"paid",paidAmount:o}}return l});if(a.some((l,o)=>l!==wt[o])){Ms(a),(async()=>await ca(a))();try{s!=null&&s.uid&&a.filter((o,h)=>o!==wt[h]&&o.status==="paid").forEach(o=>{try{sr.send(s.uid,`تم سداد الدين بالكامل للعميل ${o.debtorName}: المدفوع ${Number(o.paidAmount||o.amount||0)} جنيه`)}catch{}})}catch{}}}catch{}},[Ge,wt,s==null?void 0:s.uid]),n.useEffect(()=>{try{const t=s!=null&&s.uid?localStorage.getItem(`commissionMode_${s.uid}`):null,a=localStorage.getItem("commissionMode"),r=localStorage.getItem("commissionMode_default"),l=t??a??r;l&&Xi(l==="add")}catch{}},[s==null?void 0:s.uid]);const[tl,xn]=n.useState(!1),[ym,bm]=n.useState(null),Zn=Ye.useRef(""),Eo=Ye.useRef(0);n.useEffect(()=>{const t=a=>{var l;if(tl)return;try{const o=document.activeElement;if(o){const h=(l=o.tagName)==null?void 0:l.toLowerCase();if(h==="input"||h==="textarea"||h==="select"||h==="button"||o.isContentEditable===!0)return}}catch{}const r=Date.now();if(a.key==="Enter"){const o=(Zn.current||"").trim();Zn.current="",o&&(bm(o),xn(!0));return}a.key.length===1&&(r-(Eo.current||0)>100&&(Zn.current=""),Zn.current+=a.key,Eo.current=r)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[tl]);const[vm,wm]=n.useState(!1),[Nm,sl]=n.useState(!1),[jm,Ap]=n.useState(null);n.useEffect(()=>{if(!mn)return;const t=Is(),a=parseFloat(Gt||"0")||0;let r=0;if(fe==="transfer"){if((t==null?void 0:t.defaultTransferCommission)!=null){const o=Number(t.defaultTransferCommission)||0;r=Math.round(o*a/1e3*100)/100}else{const o=Es&&Es.trim()!==""?parseFloat(Es):0;r=Math.max(0,o)}const l=a+r;$a((l||0).toString())}else{if((t==null?void 0:t.defaultWithdrawCommission)!=null){const o=Number(t.defaultWithdrawCommission)||0;r=Math.round(o*a/1e3*100)/100}else{const o=Os&&Os.trim()!==""?parseFloat(Os):Math.round(a*.01*100)/100;r=Math.max(0,o)}const l=Pt?a:Math.max(0,Math.round((a-r)*100)/100);$a((l||0).toString())}},[mn,Gt,Es,Os,J,Pt,fe]);const Is=()=>{var a,r;let t=Ve.find(l=>l.id===J);if(!t)try{const l=localStorage.getItem(Vl());if(l){const o=JSON.parse(l);if(Array.isArray(o)&&o.length>0){const m=localStorage.getItem(Nr())||((a=o.find(u=>u.isDefault))==null?void 0:a.id)||((r=o[0])==null?void 0:r.id);t=o.find(u=>u.id===m)}}}catch{}return t};n.useLayoutEffect(()=>{try{const t=`wallets_${(s==null?void 0:s.uid)||"default"}`;let a=localStorage.getItem(t);if(!a){const r=Object.keys(localStorage).find(l=>l.startsWith("wallets_"));r&&(a=localStorage.getItem(r)||null)}if(a){const r=JSON.parse(a);if(Array.isArray(r)&&r.length>0){Er(r);const l=localStorage.getItem(Nr()),o=l&&r.find(h=>h.id===l)||r.find(h=>h.isDefault)||r[0];o&&(cs(o.id),bs(o.phone))}}}catch(t){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",t)}},[]),n.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",J)},[J]),n.useEffect(()=>{kc()},[s==null?void 0:s.uid]),n.useEffect(()=>{Oh()},[]);const[Ve,Er]=n.useState(()=>{try{const t=Object.keys(localStorage).find(r=>r.startsWith("wallets_")),a=t?localStorage.getItem(t):null;if(a){const r=JSON.parse(a);if(Array.isArray(r))return r}}catch{}return[]}),Xn=Fn({enabled:!!(s!=null&&s.uid),queryKey:["wallets",s==null?void 0:s.uid],queryFn:async()=>{const{merchantWalletService:t}=await yt(async()=>{const{merchantWalletService:l}=await import("./index-DCCNgGPW.js").then(o=>o.cm);return{merchantWalletService:l}},__vite__mapDeps([0,1]),import.meta.url),a=await t.getByMerchantId(String((s==null?void 0:s.uid)||""));return(Array.isArray(a)?a:[]).filter(l=>l.isActive===!0).map(l=>({id:l.id,name:l.label||"محفظة بدون اسم",phone:l.msisdn,isDefault:!!l.isDefault,monthlyWithdrawalLimit:l.monthlyWithdrawalLimit??l.withdrawLimit??2e5,monthlyTransferLimit:l.monthlyTransferLimit??l.transferLimit??2e5,defaultTransferCommission:l.defaultTransferCommission!=null?Number(l.defaultTransferCommission):null,defaultWithdrawCommission:l.defaultWithdrawCommission!=null?Number(l.defaultWithdrawCommission):null}))},staleTime:6e4,gcTime:3e5,refetchOnReconnect:!0});n.useEffect(()=>{var a;const t=Xn.data;if(t&&Array.isArray(t)){Er(t);const r=localStorage.getItem(Nr());if(!!!(J&&t.find(o=>o.id===J))){const o=r&&t.find(h=>h.id===r)?r:((a=t[0])==null?void 0:a.id)||"";if(o){cs(o);const h=t.find(m=>m.id===o);bs(String((h==null?void 0:h.phone)||""))}}}},[Xn.data]),n.useEffect(()=>{const t=a=>{const{cashBalance:r,walletBalances:l,newTransaction:o,limitUpdate:h,delta:m}=a.detail||{};if(m){const{amount:u,type:b,walletId:p,commission:g}=m,w=Number(u||0),C=Number(g||0);hs(A=>{let R=0;b==="withdraw"?R=-w+C:(b==="send"||b==="transfer")&&(R=w+C);const oe=A+R;try{const _=Yt();localStorage.setItem(_,String(oe));const z=new Date().toISOString();if(localStorage.setItem(_+"_lastUpdated",z),s!=null&&s.uid){const xe=`userData_${s.uid}`,qe=localStorage.getItem(xe),Cs={...qe?JSON.parse(qe):{},cashBalance:oe,lastUpdated:z};localStorage.setItem(xe,JSON.stringify(Cs)),et(!0)}}catch{}return oe}),p&&vs(A=>{const R=Number(A[p]||0);let oe=0;b==="withdraw"?oe=w:(b==="send"||b==="transfer")&&(oe=-w);const _=R+oe,z={...A,[p]:_};try{const xe=ts();localStorage.setItem(xe,JSON.stringify(z));const qe=new Date().toISOString();if(localStorage.setItem(xe+"_lastUpdated",qe),s!=null&&s.uid){const qt=`userData_${s.uid}`,Cs=localStorage.getItem(qt),Ct={...Cs?JSON.parse(Cs):{},walletBalances:z,lastUpdated:qe};localStorage.setItem(qt,JSON.stringify(Ct)),et(!0)}}catch{}return z})}if(typeof r=="number"){hs(r);try{const u=Yt();localStorage.setItem(u,String(r));const b=new Date().toISOString();if(localStorage.setItem(u+"_lastUpdated",b),s!=null&&s.uid){const p=`userData_${s.uid}`,g=localStorage.getItem(p),C={...g?JSON.parse(g):{},cashBalance:r,lastUpdated:b};localStorage.setItem(p,JSON.stringify(C)),et(!0)}}catch{}}if(l&&typeof l=="object"){vs(l);try{const u=ts();localStorage.setItem(u,JSON.stringify(l));const b=new Date().toISOString();if(localStorage.setItem(u+"_lastUpdated",b),s!=null&&s.uid){const p=`userData_${s.uid}`,g=localStorage.getItem(p),C={...g?JSON.parse(g):{},walletBalances:l,lastUpdated:b};localStorage.setItem(p,JSON.stringify(C)),et(!0)}}catch{}}if(h&&h.walletId===J&&Rr(u=>{if(!u)return u;const b=Number(h.amount||0),p=h.type==="transfer",g={...u};return p?(g.dailyTransferUsed=(g.dailyTransferUsed||0)+b,g.monthlyTransferUsed=(g.monthlyTransferUsed||0)+b):(g.dailyWithdrawUsed=(g.dailyWithdrawUsed||0)+b,g.monthlyWithdrawUsed=(g.monthlyWithdrawUsed||0)+b),g}),o){try{Wa.current&&(Wa.current.some(u=>u.id===o.id)||Wa.current.push(o))}catch{}aa(u=>u.some(b=>b.id===o.id)?u:[o,...u]),i({title:"تم تسجيل عملية خارجية",description:"تم تحديث الأرصدة والسجلات بنجاح"});try{un.refetch()}catch{}}};return window.addEventListener("dashboard:external-update",t),()=>window.removeEventListener("dashboard:external-update",t)},[J]);const[Mo,Sm]=n.useState(""),$o=(()=>{const t=Mo.replace(/\D/g,"");return t?Ve.filter(a=>(a.phone||"").replace(/\D/g,"").includes(t)):Ve})(),[Dm,Tp]=n.useState(null),[Im,Lo]=n.useState(!1),[Cm,ei]=n.useState(!1),[Am,Tm]=n.useState(null),[kp,km]=n.useState([]),[Pp,_p]=n.useState([]),[Pm,pn]=n.useState(!1),[al,Wo]=n.useState("daily"),[gn,fn]=n.useState([]),[_m,Op]=n.useState(!1),Ia=Ye.useRef(new Set);Ye.useRef(new Set);const Om=Ye.useRef([]);n.useEffect(()=>{Om.current=Ge},[Ge]);const rl=async t=>{try{if(!s)return;const a=Yt(),r=ts(),l=localStorage.getItem(a),o=localStorage.getItem(r);let h=l?parseFloat(l):Wt,m=o?JSON.parse(o):{...lt};const u=Number(t.withdrawnAmount??t.sentAmount??t.transferredAmount??t.amount??0);if(t.type==="send"&&(t.fromWallet||J)){h-=u;const w=t.fromWallet||J;m[w]=(m[w]||0)+u}else if(t.type==="withdraw"&&(t.fromWallet||J)){h+=u;const w=t.fromWallet||J;m[w]=Math.max(0,(m[w]||0)-u)}hs(h),vs(m);const b=new Date().toISOString();localStorage.setItem(a,h.toString()),localStorage.setItem(a+"_lastUpdated",b),localStorage.setItem(r,JSON.stringify(m)),localStorage.setItem(r+"_lastUpdated",b);const p={cashBalance:h,walletBalances:m,lastUpdated:new Date().toISOString()},g=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(g,JSON.stringify(p));try{await Ce.updateUserData(s.uid,p),localStorage.removeItem(g),et(!1)}catch(w){console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف (مزامنة تلقائية):",w),et(!0)}try{const w=t.fromWallet||J,C=t.type==="send"?"transfer":"withdraw";await Ta.rollbackUsage(w,u,C,t.createdAt)}catch(w){console.warn("تعذر تحديث حدود المحفظة بعد الحذف (مزامنة):",w)}try{Rs.removeTransactionEffects(t,s.uid)}catch(w){console.warn("تعذر تحديث التقارير بعد الحذف (مزامنة):",w)}}catch(a){console.warn("خطأ أثناء تطبيق تأثيرات الحذف محليًا:",a)}},Em=async t=>{try{const a=Ge.find(m=>m.id===t);if(!a||!s)return;const r=String(t),l=String((a==null?void 0:a.transactionId)||(a==null?void 0:a.reference)||""),o=Ia.current.has(r)||l&&Ia.current.has(l),h=Ge.filter(m=>m.id!==t);aa(h);try{await Ce.removeUserTransaction(s.uid,t),await Wn.permanentlyDeleteTransaction(t,s.uid)}catch(m){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",m)}if(!o){Ia.current.add(r),l&&Ia.current.add(l),await rl(a);try{s!=null&&s.uid&&Ce.removeLocalReceiptById(s.uid,t)}catch{}}i({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),ei(!1)}catch(a){console.error("خطأ أثناء حذف الإيصال:",a),i({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},Mm=async t=>{try{const a=Ge.find(r=>r.id===t);if(!a||!s)return;try{const r=se==null?void 0:se.planType;if(r===Xs.ZERO){const{dailyOperationCountService:l}=await yt(async()=>{const{dailyOperationCountService:m}=await import("./dailyOperationCountService-Br8p3Ou7.js");return{dailyOperationCountService:m}},__vite__mapDeps([2,0,1]),import.meta.url),o=a.type==="send"?"transfer":"withdraw";if(!(await l.checkAndIncrement(s.uid,o,5)).allowed){i({title:"تم بلوغ حد باقة الزيرو",description:"مسموح بحد أقصى 5 تأكيدات يوميًا للتحويل/السحب. جرّب غدًا أو قم بالترقية.",variant:"destructive"});return}}else if(r===Xs.TAHWEELA){const{dailyOperationCountService:l}=await yt(async()=>{const{dailyOperationCountService:m}=await import("./dailyOperationCountService-Br8p3Ou7.js");return{dailyOperationCountService:m}},__vite__mapDeps([2,0,1]),import.meta.url),o=a.type==="send"?"transfer":"withdraw";if(!(await l.checkAndIncrementCombined(s.uid,o,40)).allowed){i({title:"تم بلوغ حد باقة تحويله",description:"هذه الباقة تسمح بحد أقصى 40 عملية تحويل/سحب يومياً.",variant:"destructive"});return}}}catch(r){console.warn("تعذر التحقق من حد التأكيد اليومي:",r)}await Xt($e(U,"userTransactions",t),{status:"completed",confirmedAt:new Date}),aa(r=>r.map(l=>l.id===t?{...l,status:"completed"}:l)),i({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),ei(!1)}catch(a){console.error("خطأ أثناء إكمال الإيصال:",a),i({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}};n.useEffect(()=>{if(!s)return;(async()=>{try{const a=Je(ye(U,"deletedTransactions"),le("userId","==",s.uid),zu("createdAt","desc"),Yr(50));(await Ue(a)).docs.forEach(l=>{const o=l.data(),h=String((o==null?void 0:o.originalTransactionId)||""),m=String((o==null?void 0:o.transactionId)||""),u=String((o==null?void 0:o.reference)||""),b=h||m||u||String(l.id);b&&(Ia.current.has(b)||(Ia.current.add(b),aa(p=>{const g=p.find(w=>w.id===h);return g?((async()=>await rl(g))(),p.filter(w=>w.id!==h)):p})))})}catch(a){console.warn("تعذر جلب المعاملات المحذوفة:",a)}})()},[s==null?void 0:s.uid]),n.useEffect(()=>{if(!s)return;(async()=>{try{const a=$e(U,"users",s.uid),r=await Ws(a);if(!r.exists())return;const l=r.data();if(!(l!=null&&l.reportsData))return;try{await Rs.syncReportsDataFromFirebase(s.uid),km(On())}catch(o){console.warn("تعذر مزامنة reportsData من السحابة:",o)}}catch(a){console.warn("تعذر جلب users.reportsData:",a)}})()},[s==null?void 0:s.uid]);const[Fo,$m]=n.useState(""),Bo=dp(Fo,300),[ti,Ro]=n.useState(""),[si,Uo]=n.useState(""),[Fa,Ep]=n.useState(""),[nl,Mr]=n.useState(!1),[qo,yn]=n.useState(!1),[Lm,fr]=n.useState(!1),[ms,il]=n.useState(null),[Qs,Wm]=n.useState(null),[zo,yr]=n.useState(!1),[Fm,$r]=n.useState(!1),[Vo,Bm]=n.useState(""),[Rm,ll]=n.useState(!1),Jo=!1,[Um,ai]=n.useState(!1),[qm,Ko]=n.useState(!1),[zm,ri]=n.useState(!1),[Vm,ni]=n.useState(!1),[Jm,ii]=n.useState(!1),[Km,Yo]=n.useState(!0),[bn,Ym]=n.useState(!1),[Hm,li]=n.useState(!1),[Qm,Ho]=n.useState(!1),[oi,Gm]=n.useState(""),[Qo,Zm]=n.useState(!1),[Xm,ol]=n.useState(!1),[eh,Go]=n.useState(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[th,cl]=n.useState(!1);n.useEffect(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled",a=localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled");Go(a==="true")}catch{}},[s==null?void 0:s.uid]);const[sh,Lr]=n.useState(!1),[ah,dl]=n.useState(!1),[rh,Zo]=n.useState(()=>{try{const t=s==null?void 0:s.uid,a=t?`debtsPinRequired_${t}`:"debtsPinRequired";return(localStorage.getItem(a)??localStorage.getItem("debtsPinRequired"))==="true"}catch{return!1}}),[nh,Xo]=n.useState(!1),[ec,ih]=n.useState(null),[ml,tc]=n.useState(""),[hl,sc]=n.useState(""),[ul,ac]=n.useState(""),[Ca,rc]=n.useState(null),[X,Qa]=n.useState(null),[lh,Ga]=n.useState(!1),[oh,vn]=n.useState(!1),[br,nc]=n.useState(null),[ic,xl]=n.useState(""),[es,lc]=n.useState(null),[Mp,$p]=n.useState(!1),[ch,pl]=n.useState(!1),[oc,gl]=n.useState(""),[fl,vr]=n.useState(!1),[cc,yl]=n.useState(1),dh=Y?10:20,bl=Ye.useMemo(()=>wt.slice(0,cc*dh),[wt,cc]);n.useEffect(()=>{fl&&yl(1)},[fl]);const vl=async()=>{if(It){i({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}try{const t=await Ls.hasMasterPin(s==null?void 0:s.uid);rh&&t?dl(!0):Lr(!0)}catch{Lr(!0)}};n.useEffect(()=>{try{const t=s==null?void 0:s.uid,a=t?`debtsPinRequired_${t}`:"debtsPinRequired",r=localStorage.getItem(a)??localStorage.getItem("debtsPinRequired");(r==="true"||r==="false")&&Zo(r==="true")}catch{}},[s==null?void 0:s.uid]),n.useEffect(()=>{const t=()=>{try{Pl()}catch{}};try{window.addEventListener("debtsUpdated",t)}catch{}return()=>{try{window.removeEventListener("debtsUpdated",t)}catch{}}},[s==null?void 0:s.uid,O,v==null?void 0:v.shopId]);const[mh,wl]=n.useState(!1),[Gs,Nl]=n.useState([]),[jl,dc]=n.useState(""),[Sl,mc]=n.useState(""),[Wr,hc]=n.useState(""),[uc,hh]=n.useState(""),[uh,ci]=n.useState(!1),[xh,xc]=n.useState(""),[pc,Dl]=n.useState(""),[gc,Il]=n.useState(""),[ph,di]=n.useState(!1),[gh,Cl]=n.useState(""),[fc,Al]=n.useState(""),[fh,Fr]=n.useState(!1),[wr,wn]=n.useState(null),[zs,Nn]=n.useState(null),[jn,Tl]=n.useState(""),[yh,Br]=n.useState(!1),[yc,mi]=n.useState(0),[ra,Za]=n.useState(null),[Xa,kl]=n.useState(""),[at,Rr]=n.useState(null),[bh,bc]=n.useState(""),ca=async t=>{try{const a=JSON.stringify(t);localStorage.setItem(Dn(),a);try{localStorage.setItem(Fl(),a)}catch{}try{localStorage.setItem(Bl(),Date.now().toString())}catch{}if(s!=null&&s.uid){try{localStorage.setItem(`debts_unsynced_${s.uid}`,"true")}catch{}const r=[];r.push(Ce.updateUserData(s.uid,{debts:t,debtsDeletedAt:null})),Promise.all(r).then(()=>{try{localStorage.removeItem(`debts_unsynced_${s.uid}`)}catch{}}).catch(l=>{console.error("فشل مزامنة الديون:",l),et(!0)})}}catch(a){console.error("خطأ في حفظ الديون:",a)}},Pl=async()=>{try{const t=Dn(),a=Fl(),r=Bl(),l=localStorage.getItem(t),o=localStorage.getItem(a),h=localStorage.getItem(r),m=h?Number(h):0,u=p=>{if(!p)return null;try{const g=JSON.parse(p);return Array.isArray(g)?g.map(w=>{var C;return{...w,createdAt:(C=w.createdAt)!=null&&C.toDate?w.createdAt.toDate():new Date(w.createdAt),partialPayments:Array.isArray(w.partialPayments)?w.partialPayments.map(A=>{var R;return{amount:Number(A.amount)||0,paidAt:(R=A.paidAt)!=null&&R.toDate?A.paidAt.toDate():new Date(A.paidAt)}}):[]}}):[]}catch(g){return console.warn("فشل في تحليل ديون localStorage:",g),null}};let b=u(l);if(!b||b.length===0){const p=u(o);if(p&&p.length>0){b=p,Ms(p);try{localStorage.setItem(Dn(),JSON.stringify(p)),localStorage.removeItem(a)}catch(g){console.warn("تعذر ترحيل الديون محلياً من المفتاح الافتراضي:",g)}}}if(b&&b.length>0&&Ms(b),s!=null&&s.uid)try{const p=`debts_unsynced_${s.uid}`,g=localStorage.getItem(p)==="true",w=await Ws($e(U,"users",s.uid)),C=[];try{const A=query(ye(U,"debts"),le("userId","==",s.uid));(await Ue(A)).forEach(oe=>{var z;const _=oe.data();C.push({id:oe.id,..._,amount:Number(_.amount||0),paidAmount:Number(_.paidAmount||0),createdAt:(z=_.createdAt)!=null&&z.toDate?_.createdAt.toDate():new Date(_.createdAt||Date.now()),partialPayments:Array.isArray(_.partialPayments)?_.partialPayments:[]})})}catch(A){console.warn("Failed to fetch from debts collection:",A)}if(w.exists()){const A=w.data();let R=A.debts&&Array.isArray(A.debts)?A.debts.map(z=>{var xe;return{...z,amount:Number(z.amount||0),paidAmount:Number(z.paidAmount||0),createdAt:(xe=z.createdAt)!=null&&xe.toDate?z.createdAt.toDate():new Date(z.createdAt),partialPayments:Array.isArray(z.partialPayments)?z.partialPayments.map(qe=>{var qt;return{amount:Number(qe.amount)||0,paidAt:(qt=qe.paidAt)!=null&&qt.toDate?qe.paidAt.toDate():new Date(qe.paidAt)}}):[]}}):[];if(!!A.debtsDeletedAt){Ms([]);try{localStorage.setItem(t,JSON.stringify([])),localStorage.setItem(a,JSON.stringify([]))}catch{}return}if(((R==null?void 0:R.length)||0)>0)if(g)console.log("⚠️ تم اكتشاف ديون غير متزامنة محلياً، سيتم تجاهل نسخة السحابة مؤقتاً للحفاظ على البيانات الجديدة.");else{Ms(R);try{localStorage.setItem(t,JSON.stringify(R))}catch{}}}else if(C.length>0){Ms(C);try{localStorage.setItem(t,JSON.stringify(C))}catch{}}else b&&b.length>0}catch(p){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",p)}}catch(t){console.error("خطأ في تحميل الديون:",t)}};n.useEffect(()=>{try{window.exportDebts=()=>{try{return JSON.stringify(wt||[])}catch{return"[]"}},window.importDebts=async t=>{try{const a=JSON.parse(t);if(!Array.isArray(a))throw new Error("صيغة غير صحيحة — يجب أن تكون مصفوفة");return await ca(a),{ok:!0,count:a.length}}catch(a){return console.error("فشل استيراد الديون:",a),{ok:!1,error:String(a)}}},window.fixWalletsForCurrentUser=async t=>{try{if(!(s!=null&&s.uid))throw new Error("يجب تسجيل الدخول أولاً");return await(await yt(async()=>{const{merchantWalletService:r}=await import("./index-DCCNgGPW.js").then(l=>l.cm);return{merchantWalletService:r}},__vite__mapDeps([0,1]),import.meta.url)).merchantWalletService.reassignByMsisdns(t,s.uid)}catch(a){return console.error("فشل إصلاح المحافظ للمستخدم الحالي:",a),{updated:0,failed:(t==null?void 0:t.length)||0,error:String(a)}}}}catch{}},[wt,s==null?void 0:s.uid]),n.useEffect(()=>{s!=null&&s.uid&&Pl()},[s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;const t=_u($e(U,"users",s.uid),async a=>{var r;if(a.exists()){const l=a.data(),o=l.isActive===!0;l.subscription&&Te(l.subscription),Re(l.branchPackage||null);const h=await hd.checkTrialValidity(s.uid),m=h.isValid&&!h.isExpired;Us(o||m),T(m),K(h.hoursRemaining),ce(h.hasUsedTrial);const u=!o&&!m;ua(u),u&&(console.log("⛔ User not active, redirecting to pending approval..."),$("/user/pending-approval",{replace:!0})),console.log("🔄 تحديث فوري لحالة المستخدم (Real-time):",{isActive:o,isOnTrial:m,plan:(r=l.subscription)==null?void 0:r.planType,showModal:u})}});return()=>t()},[s==null?void 0:s.uid]);const vh=async()=>{if(s!=null&&s.uid)try{jt(!0);const t=await wo(s.uid);Te(t)}catch(t){console.error("خطأ في جلب بيانات الاشتراك:",t)}finally{jt(!1)}},[Lp,Wp]=n.useState(!1),[wh,_l]=n.useState(!1),[Wt,hs]=n.useState(0),[lt,vs]=n.useState({}),[Nh,vc]=n.useState(!1),[jh,wc]=n.useState(!1),[Sh,Ol]=n.useState(!1),[Dh,hi]=n.useState(!1),[Nc,El]=n.useState(""),[Ih,Sn]=n.useState(!1),[Ch,ui]=n.useState(!1),[Ml,xi]=n.useState(""),[Ah,$l]=n.useState(!1),[pi,jc]=n.useState(""),[gi,Sc]=n.useState(""),[fi,Dc]=n.useState(""),[Ic,Cc]=n.useState(!1),[Ll,Wl]=n.useState(!1),[Th,Ac]=n.useState(!1),[Tc,kh]=n.useState([]);n.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid)||!Ll)return;try{await Mn.trimToMaxCount(s.uid,30)}catch{}const t=await Mn.getByUser(s.uid,30);kh(t)}catch{}})()},[s==null?void 0:s.uid,Ll]);const ts=()=>{const t=O||(v==null?void 0:v.shopId)||"main";return`walletBalances_${(s==null?void 0:s.uid)||"default"}_${t}`},Yt=()=>{const t=O||(v==null?void 0:v.shopId)||"main";return`cashBalance_${(s==null?void 0:s.uid)||"default"}_${t}`},Dn=()=>{const t=O||(v==null?void 0:v.shopId)||"main";return`debts_${(s==null?void 0:s.uid)||"default"}_${t}`},Ph=()=>{const t=O||(v==null?void 0:v.shopId)||"main";return`customers_${(s==null?void 0:s.uid)||"default"}_${t}`},Fl=()=>`debts_default_${O||(v==null?void 0:v.shopId)||"main"}`,Bl=()=>{const t=O||(v==null?void 0:v.shopId)||"main";return`debts_last_write_${(s==null?void 0:s.uid)||"default"}_${t}`},Rl=()=>`shopExpenses_${O||(v==null?void 0:v.shopId)||(s==null?void 0:s.uid)||"default"}`,kc=()=>{try{const t=localStorage.getItem(Rl());if(t){const a=JSON.parse(t);an(a.map(r=>({...r,createdAt:new Date(r.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",t)}},Pc=async t=>{try{localStorage.setItem(Rl(),JSON.stringify(t)),an(t)}catch(a){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",a)}},_h=async t=>{try{const a=mr.filter(r=>r.id!==t);await Pc(a);try{if(s!=null&&s.uid&&t){const{doc:r,deleteDoc:l}=await yt(async()=>{const{doc:m,deleteDoc:u}=await import("./index-DCCNgGPW.js").then(b=>b.ck);return{doc:m,deleteDoc:u}},__vite__mapDeps([0,1]),import.meta.url),{db:o}=await yt(async()=>{const{db:m}=await import("./index-DCCNgGPW.js").then(u=>u.cl);return{db:m}},__vite__mapDeps([0,1]),import.meta.url),h=r(o,"shop_expenses",t);await l(h)}}catch(r){console.warn("تعذر حذف المصروف من السحابة الآن، تم الحذف محليًا وسيبقى مخزّنًا دون هذا الإيصال:",r)}i({title:"تم الحذف",description:"تم حذف إيصال المصروف نهائيًا."})}catch(a){console.error("خطأ أثناء الحذف النهائي لإيصال المصروف:",a),i({title:"فشل الحذف",description:"تعذر حذف الإيصال. حاول مرة أخرى.",variant:"destructive"})}};Ye.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid)){kc();return}const{collection:a,query:r,where:l,getDocs:o}=await yt(async()=>{const{collection:w,query:C,where:A,getDocs:R}=await import("./index-DCCNgGPW.js").then(oe=>oe.ck);return{collection:w,query:C,where:A,getDocs:R}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await yt(async()=>{const{db:w}=await import("./index-DCCNgGPW.js").then(C=>C.cl);return{db:w}},__vite__mapDeps([0,1]),import.meta.url),m=O||(v==null?void 0:v.shopId),u=m?r(a(h,"shop_expenses"),l("shopId","==",m)):r(a(h,"shop_expenses"),l("userId","==",s.uid)),g=(await o(u)).docs.map(w=>{var R;const C=w.data(),A=(R=C.createdAt)!=null&&R.toDate?C.createdAt.toDate():C.createdAt?new Date(C.createdAt):new Date;return{id:w.id,name:String(C.name||""),amount:Number(C.amount||0),notes:C.notes?String(C.notes):void 0,source:C.source==="wallet"?"wallet":"cash",walletId:C.walletId?String(C.walletId):void 0,createdAt:A}}).sort((w,C)=>{const A=w.createdAt instanceof Date?w.createdAt.getTime():0;return(C.createdAt instanceof Date?C.createdAt.getTime():0)-A});an(g);try{localStorage.setItem(Rl(),JSON.stringify(g))}catch{}}catch(a){console.error("خطأ في مزامنة مصروفات المحل من Firestore:",a)}})(),()=>t==null?void 0:t()},[s==null?void 0:s.uid,v==null?void 0:v.shopId,O]);const yi=()=>`deficiencies_${O||(v==null?void 0:v.shopId)||(s==null?void 0:s.uid)||"default-shop"}`,Oh=()=>{try{const t=yi(),a=`deficiencies_${(s==null?void 0:s.uid)||"default"}`;if(a!==t){const l=localStorage.getItem(a),o=localStorage.getItem(t);if(l)try{const h=JSON.parse(l)||[],m=o?JSON.parse(o):[],u=Array.isArray(m)?[...m]:[],b=(p,g)=>p.some(w=>(w==null?void 0:w.id)&&(g==null?void 0:g.id)&&String(w.id)===String(g.id)||String((w==null?void 0:w.name)||"")===String((g==null?void 0:g.name)||"")&&String((w==null?void 0:w.status)||"pending")===String((g==null?void 0:g.status)||"pending"));if(Array.isArray(h))for(const p of h)b(u,p)||u.push(p);localStorage.setItem(t,JSON.stringify(u));try{localStorage.removeItem(a)}catch{}}catch{}}const r=localStorage.getItem(t);if(r){const l=JSON.parse(r);Ea(l.map(o=>({...o,createdAt:new Date(o.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل النواقص من التخزين:",t)}},Ul=async t=>{try{localStorage.setItem(yi(),JSON.stringify(t)),Ea(t)}catch(a){console.error("خطأ أثناء حفظ النواقص في التخزين:",a)}};Ye.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid))return;const{collection:a,query:r,where:l,orderBy:o,getDocs:h}=await yt(async()=>{const{collection:w,query:C,where:A,orderBy:R,getDocs:oe}=await import("./index-DCCNgGPW.js").then(_=>_.ck);return{collection:w,query:C,where:A,orderBy:R,getDocs:oe}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await yt(async()=>{const{db:w}=await import("./index-DCCNgGPW.js").then(C=>C.cl);return{db:w}},__vite__mapDeps([0,1]),import.meta.url),u=O||(v==null?void 0:v.shopId)||s.uid||"default-shop",b=r(a(m,"deficiencies"),l("shopId","==",u),o("createdAt","desc")),g=(await h(b)).docs.map(w=>{var R;const C=w.data(),A=(R=C.createdAt)!=null&&R.toDate?C.createdAt.toDate():C.createdAt?new Date(C.createdAt):new Date;return{id:w.id,name:String(C.name||""),quantity:Number(C.quantity||1),status:C.status==="purchased"?"purchased":"pending",createdAt:A}});Ea(g);try{localStorage.setItem(yi(),JSON.stringify(g))}catch{}}catch(a){console.warn("فشل جلب النواقص من Firestore:",a)}})()},[s==null?void 0:s.uid,v==null?void 0:v.shopId,O]);const ql=async t=>{try{localStorage.setItem(Ph(),JSON.stringify(t)),Nl(t),s!=null&&s.uid&&await Ce.updateUserData(s.uid,{customers:t})}catch(a){console.error("خطأ أثناء حفظ العملاء في التخزين:",a)}},Eh=async()=>{try{if(s!=null&&s.uid){const t=await Ws($e(U,"users",s.uid));if(t.exists()){const a=t.data();if(a.customers&&Array.isArray(a.customers)){const r=a.customers.map(l=>{var o;return{...l,createdAt:(o=l.createdAt)!=null&&o.toDate?l.createdAt.toDate():new Date(l.createdAt)}});Nl(r);return}}}Nl([])}catch(t){console.error("خطأ أثناء تحميل العملاء من Firestore:",t)}},zl=()=>{const t=O||(v==null?void 0:v.shopId)||"main";return`transactions_${(s==null?void 0:s.uid)||"default"}_${t}`},Vl=()=>{const t=O||(v==null?void 0:v.shopId)||"main";return`wallets_${(s==null?void 0:s.uid)||"default"}_${t}`},Nr=()=>{const t=O||(v==null?void 0:v.shopId)||"main";return`selectedWallet_${(s==null?void 0:s.uid)||"default"}_${t}`},_c=t=>{var o;const a=String((t==null?void 0:t.transactionId)||(t==null?void 0:t.id)||""),r=String((t==null?void 0:t.reference)||(t==null?void 0:t.transactionReference)||((o=t==null?void 0:t.receipt)==null?void 0:o.reference)||""),l=new Date((t==null?void 0:t.createdAt)||0).getTime();return a||r||`${r||"ref"}-${l}`},{data:Jl,refetch:Fp}=Fn({queryKey:["userTransactions",s==null?void 0:s.uid],queryFn:async()=>{if(!(s!=null&&s.uid))return[];const{collection:t,query:a,where:r,orderBy:l,limit:o,getDocs:h}=await yt(async()=>{const{collection:p,query:g,where:w,orderBy:C,limit:A,getDocs:R}=await import("./index-DCCNgGPW.js").then(oe=>oe.ck);return{collection:p,query:g,where:w,orderBy:C,limit:A,getDocs:R}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await yt(async()=>{const{db:p}=await import("./index-DCCNgGPW.js").then(g=>g.cl);return{db:p}},__vite__mapDeps([0,1]),import.meta.url),u=a(t(m,"userTransactions"),r("userId","==",s.uid),l("createdAt","desc"),o(100));return(await h(u)).docs.map(p=>{var z;const g=p.data(),w=(z=g.createdAt)!=null&&z.toDate?g.createdAt.toDate():new Date(g.createdAt),C=g.txnType==="send"?"send":g.txnType==="receive"?"withdraw":g.type||"withdraw",A=g.status==="confirmed"?"completed":g.status||"completed",R=g.senderMsisdn||g.senderPhone||"",oe=g.receiverMsisdn||g.receiverPhone||"",_=Number(g.amount??g.transferredAmount??g.withdrawnAmount??0);return{id:p.id,...g,type:C,status:A,senderPhone:R,receiverPhone:oe,amount:_,createdAt:w,provider:g.provider||void 0}})},enabled:!!(s!=null&&s.uid),staleTime:1e3*60*5,gcTime:1e3*60*10});n.useEffect(()=>{if(Jl){const a=Jl.filter(m=>!((m==null?void 0:m.type)==="report"||String((m==null?void 0:m.title)||"").includes("إيصال تسليم وردية"))),r=new Set((gn||[]).map(m=>String(m.id||m.originalTransactionId||""))),l=a.filter(m=>!r.has(String(m.id||""))),o=new Set,h=[];for(const m of l){const u=_c(m);o.has(u)||(o.add(u),h.push(m))}aa(h)}},[Jl,gn]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;let t=!0;return(async()=>{try{const{collection:r,query:l,where:o,getDocs:h,orderBy:m,limit:u}=await yt(async()=>{const{collection:w,query:C,where:A,getDocs:R,orderBy:oe,limit:_}=await import("./index-DCCNgGPW.js").then(z=>z.ck);return{collection:w,query:C,where:A,getDocs:R,orderBy:oe,limit:_}},__vite__mapDeps([0,1]),import.meta.url),{db:b}=await yt(async()=>{const{db:w}=await import("./index-DCCNgGPW.js").then(C=>C.cl);return{db:w}},__vite__mapDeps([0,1]),import.meta.url),p=l(r(b,"deletedTransactions"),o("userId","==",s.uid),m("createdAt","desc"),u(50)),g=await h(p);if(!t)return;g.docs.forEach(w=>{const C=w.data(),A=String((C==null?void 0:C.originalTransactionId)||""),R=String((C==null?void 0:C.transactionId)||""),oe=String((C==null?void 0:C.reference)||""),_=A||R||oe||String(w.id);_&&(Ia.current.has(_)||(Ia.current.add(_),aa(z=>{const xe=z.find(qe=>qe.id===A);return xe?((async()=>await rl(xe))(),z.filter(qe=>qe.id!==A)):z})))})}catch(r){console.warn("تعذر جلب المعاملات المحذوفة:",r)}})(),()=>{t=!1}},[s==null?void 0:s.uid]);const[Kl,bi]=n.useState(""),[Zs,Oc]=n.useState(""),Aa=Ye.useMemo(()=>{const t=se;if(!t)return!1;const a=Ou(t),r=t.planType??t.plan??null,l=typeof r=="string"?r.toLowerCase():null,o=l==="monthly"||l==="quarterly"||l==="yearly"||l==="lifetime"||r===Xs.MONTHLY||r===Xs.QUARTERLY||r===Xs.YEARLY||r===Xs.LIFETIME;return a&&o},[se]),It=Ye.useMemo(()=>{var l,o;const t=se;if(!t)return!1;const a=((l=t.subscription)==null?void 0:l.planType)??((o=t.subscription)==null?void 0:o.plan)??t.planType??t.plan??null,r=typeof a=="string"?a.toLowerCase():null;return a===Xs.ZERO||r==="zero"},[se]),Ut=Ye.useMemo(()=>{var l,o;const t=se;if(!t)return!1;const a=((l=t.subscription)==null?void 0:l.planType)??((o=t.subscription)==null?void 0:o.plan)??t.planType??t.plan??null,r=typeof a=="string"?String(a).trim().toLowerCase():null;return a===Xs.TAHWEELA||r==="tahweela"||r==="تحويله"},[se]),Mh=()=>{if(!Aa){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}me(!0)},[Bp,Rp]=n.useState(!1),[$h,Lh]=n.useState(!1),[Wh,Fh]=n.useState(!1),[Bh,Rh]=n.useState(!1),[Uh,In]=n.useState(!1),[jr,vi]=n.useState(""),[Cn,wi]=n.useState(""),[Ec,Ni]=n.useState(!1),[An,Tn]=n.useState(null),[Yl,ji]=n.useState(""),[qh,Mc]=n.useState(!1),[Up,qp]=n.useState(!1),[zh,Si]=n.useState(!1),[$c,Hl]=n.useState(""),[Lc,Ql]=n.useState(""),[Wc,Fc]=n.useState(!1),Bc=async()=>{var t;if(s!=null&&s.uid)try{const a=`userData_${s.uid}`,r=localStorage.getItem(a),l=`debts_unsynced_${s.uid}`,o=localStorage.getItem(Dn()),h=localStorage.getItem(l)==="true";if(r){const m=JSON.parse(r);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",m);const u={lastSynced:new Date().toISOString()};typeof m.cashBalance=="number"&&(u.cashBalance=m.cashBalance),m.walletBalances&&typeof m.walletBalances=="object"&&(u.walletBalances=m.walletBalances),await Ce.updateUserData(s.uid,u),localStorage.removeItem(a),et(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة");if(h&&o)try{const m=JSON.parse(o)||[],u=_=>_ instanceof Date?_:typeof(_==null?void 0:_.toDate)=="function"?_.toDate():_?new Date(String(_)):new Date,b=_=>(Array.isArray(_)?_:[]).map(z=>({...z,amount:Number(z.amount||0),paidAmount:Number(z.paidAmount||0),createdAt:u(z.createdAt),partialPayments:Array.isArray(z.partialPayments)?z.partialPayments.map(xe=>({amount:Number(xe.amount||0),paidAt:u(xe.paidAt)})):[]})),p=await Ws($e(U,"users",s.uid)),g=p.exists()?((t=p.data())==null?void 0:t.debts)||[]:[],w=b(g),C=b(m),A={};for(const _ of w)A[String(_.id||"")]=_;const R=[],oe=new Set;for(const _ of C){const z=String(_.id||""),xe=A[z];if(xe){const qe=Number(xe.paidAmount||0)+(Array.isArray(xe.partialPayments)?xe.partialPayments.reduce((ws,As)=>ws+Number(As.amount||0),0):0),qt=Number(_.paidAmount||0)+(Array.isArray(_.partialPayments)?_.partialPayments.reduce((ws,As)=>ws+Number(As.amount||0),0):0),Cs=String(xe.status||"pending"),xt=String(_.status||"pending"),Ct=Cs==="paid"||qe>=Number(xe.amount||0)?xe:xt==="paid"?{...xe,paidAmount:Number(_.paidAmount||0),partialPayments:_.partialPayments,status:"paid"}:qt>qe?{...xe,paidAmount:Number(_.paidAmount||0),partialPayments:_.partialPayments,status:qt>=Number(xe.amount||0)?"paid":"pending"}:xe;R.push(Ct),oe.add(z)}else R.push(_),oe.add(z)}for(const _ of w){const z=String(_.id||"");oe.has(z)||R.push(_)}await Ce.updateUserData(s.uid,{debts:R});try{localStorage.removeItem(l)}catch{}et(!1)}catch{et(!0)}}catch(a){console.error("❌ فشل في مزامنة البيانات:",a),i({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},[Rc,Di]=n.useState({keepLastCount:30,intervalDays:7,lastResetAt:null});n.useEffect(()=>{(async()=>{if(s!=null&&s.uid)try{const a=await Ce.getUserData(s.uid),r=(a==null?void 0:a.recentReset)||{},l=Number(r==null?void 0:r.keepLastCount)>0?Number(r.keepLastCount):30,o=Number(r==null?void 0:r.intervalDays)>0?Number(r.intervalDays):7,h=p=>p instanceof Date?p:typeof(p==null?void 0:p.toDate)=="function"?p.toDate():p?new Date(String(p)):null,m=r!=null&&r.lastResetAt?h(r.lastResetAt):null,u=new Date;!m||u.getTime()-m.getTime()>=o*24*60*60*1e3?(await Ce.updateUserData(s.uid,{recentReset:{keepLastCount:l,intervalDays:o,lastResetAt:u}}),Di({keepLastCount:l,intervalDays:o,lastResetAt:u})):Di({keepLastCount:l,intervalDays:o,lastResetAt:m})}catch{Di({keepLastCount:30,intervalDays:7,lastResetAt:null})}})()},[s==null?void 0:s.uid]);const Uc=Ye.useMemo(()=>{const t=Ge||[],a=m=>m instanceof Date?m:typeof(m==null?void 0:m.toDate)=="function"?m.toDate():new Date(String(m)),r=new Date,l=new Date(r.getFullYear(),r.getMonth(),1),o=new Date(r.getFullYear(),r.getMonth()+1,1);return[...t].sort((m,u)=>a(u.createdAt).getTime()-a(m.createdAt).getTime()).filter(m=>{const u=a(m.createdAt);return u>=l&&u<o})},[Ge]),Vh=Ye.useMemo(()=>{const t=Ge||[],a=m=>m instanceof Date?m:typeof(m==null?void 0:m.toDate)=="function"?m.toDate():new Date(String(m)),r=new Date,l=new Date(r.getFullYear(),r.getMonth(),1),o=new Date(r.getFullYear(),r.getMonth()+1,1),h=t.filter(m=>{const u=a(m.createdAt);return u>=l&&u<o}).length;return Math.max(0,((Ge==null?void 0:Ge.length)||0)-h)},[Ge==null?void 0:Ge.length]),Ii=Ye.useMemo(()=>{const t=new Date,a=new Date(t.getFullYear(),t.getMonth(),1),r=new Date(t.getFullYear(),t.getMonth()+1,1),l={};for(const h of Ge){const m=new Date(h.createdAt||0);if(!(m>=a&&m<r))continue;const u=String(h.type||h.txnType||"").toLowerCase();if(!(u==="send"||u==="withdraw"||u==="transfer"))continue;const b=String(h.receiverPhone||h.senderPhone||"").trim();if(!b)continue;const p=rs(b),g=Number(h.amount||h.withdrawnAmount||h.sentAmount||0)||0;l[p]||(l[p]={phone:p,count:0,total:0}),l[p].count+=1,l[p].total+=g}return Object.values(l).sort((h,m)=>m.count!==h.count?m.count-h.count:m.total-h.total).slice(0,10)},[Ge]),Jh=t=>{const a=rs(String(t));return a.startsWith("+20")?"20"+a.slice(3):a.startsWith("0")?"20"+a.slice(1):a.replace(/[^0-9]/g,"")},Kh=t=>{const a=Jh(t.phone),r=`عميل VIP هذا الشهر
عدد العمليات: ${t.count}
الإجمالي: ${t.total} جنيه`,l=`https://wa.me/${a}?text=${encodeURIComponent(r)}`;try{window.open(l,"_blank")}catch{}};n.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid))return;const t=`${new Date().getFullYear()}-${new Date().getMonth()+1}`;await Ce.updateUserData(s.uid,{vipTop10:Ii,vipMonthTag:t})}catch{}})()},[s==null?void 0:s.uid,Ii]);async function qc(){const t=new Date,a=new Intl.DateTimeFormat("ar-EG",{timeZone:"Africa/Cairo",year:"numeric",month:"2-digit",day:"2-digit"}).format(t),r=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0,0),l=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59,999),o=(Ge||[]).filter(A=>{const R=new Date(A.createdAt||0);return R>=r&&R<=l}),h=o.length,m=o.filter(A=>String(A.type||A.txnType||"").toLowerCase()==="withdraw"||String(A.type||"").toLowerCase()==="receive").reduce((A,R)=>A+(R.withdrawnAmount!=null?Number(R.withdrawnAmount):Number(R.amount||0)),0),u=o.filter(A=>String(A.type||A.txnType||"").toLowerCase()==="send"||String(A.type||"").toLowerCase()==="transfer").reduce((A,R)=>A+(R.sentAmount!=null?Number(R.sentAmount):Number(R.amount||0)),0);let b=0;try{b=o.reduce((A,R)=>A+Rs.calculateTransactionProfit(R),0)}catch{}let p=0;try{const A=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(t),R=Je(ye(U,"dailySales"),le("userId","==",(s==null?void 0:s.uid)||""));p=(await Ue(R)).docs.map(z=>z.data()).filter(z=>String(z.date||A)===A).reduce((z,xe)=>z+Number(xe.sellingPrice||xe.price||0)*Number(xe.quantity||1),0)}catch{}let g=0;try{g=(wt||[]).filter(R=>String(R.status||"")==="pending").reduce((R,oe)=>{const _=Number(oe.paidAmount||0)+(Array.isArray(oe.partialPayments)?oe.partialPayments:[]).reduce((z,xe)=>z+Number(xe.amount||0),0);return R+Math.max(0,Number(oe.amount||0)-_)},0)}catch{}let w="";try{const A=O||(v==null?void 0:v.shopId)||null,R=A?Je(ye(U,"deficiencies"),le("shopId","==",A)):Je(ye(U,"deficiencies"),le("userId","==",(s==null?void 0:s.uid)||""));w=(await Ue(R)).docs.map(xe=>xe.data()).filter(xe=>String(xe.status||"pending")==="pending").slice(0,10).map((xe,qe)=>`${qe+1}- ${String(xe.name||xe.productName||"عنصر")} × ${Number(xe.quantity||xe.qty||0)}`).join(`
`)}catch{}return[`تقرير يومي - ${a}`,`عدد العمليات: ${h}`,`إجمالي المسحوبات: ${m} جنيه`,`إجمالي الإرسال: ${u} جنيه`,`الأرباح: ${b} جنيه`,`إجمالي مبيعات الاكسسوار: ${p} جنيه`,`إجمالي الديون: ${g} جنيه`,"نواقص الاكسسوار:",w||"لا توجد عناصر مسجلة"].join(`
`)}const zc=Ye.useCallback(()=>{let t=Uc;const a=Bo.trim();if(a&&(t=t.filter(r=>{const l=r;return String(l.type||"").toLowerCase()==="cash_addition"||String(l.txnType||"").toLowerCase()==="cash_addition"||String(l.title||"").includes("إيصال إضافة نقدية")?!0:r.senderPhone&&r.senderPhone.includes(a)||r.receiverPhone&&r.receiverPhone.includes(a)})),ti){const r=new Date(ti);t=t.filter(l=>{const o=new Date(l.createdAt);if(si){const[h,m]=si.split(":"),u=new Date(r);u.setHours(parseInt(h),parseInt(m),0,0);const b=new Date(u);return b.setHours(b.getHours()+1),o>=u&&o<b}else return o.toDateString()===r.toDateString()})}try{t=[...t].sort((r,l)=>{const o=new Date(r.createdAt||0).getTime();return new Date(l.createdAt||0).getTime()-o})}catch{}return t},[Uc,Bo,ti,si]),Vc=async()=>{if(It||Ut){i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"});return}if(!(s!=null&&s.uid)){i({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}try{const t=await qc(),a=s!=null&&s.uid?`tg_daily_report_last_${s.uid}`:"tg_daily_report_last",r=Date.now();let l=!0;try{const o=localStorage.getItem(a);if(o){const h=JSON.parse(o),m=Number((h==null?void 0:h.at)||0);r-m<3e4&&(l=!1)}}catch{}if(l){await sr.send(s.uid,t);try{localStorage.setItem(a,JSON.stringify({at:r}))}catch{}}i({title:"تم الإرسال",description:"تم إرسال التقرير اليومي إلى تليجرام",variant:"default"})}catch{i({title:"فشل الإرسال",description:"تعذّر إرسال التقرير اليومي إلى تليجرام",variant:"destructive"})}},[Yh,Ci]=n.useState(!1),[Jc,Ai]=n.useState(""),[Hh,Ti]=n.useState(!1),[Gl,Zl]=n.useState(""),[Qh,et]=n.useState(!1),[Gh,Xl]=n.useState(!1),Ur=async(t,a=2,r=700)=>{let l;for(let o=0;o<=a;o++)try{return await t()}catch(h){if(l=h,o===a)break;await new Promise(m=>setTimeout(m,r*Math.pow(2,o)))}throw l};Ve.reduce((t,a)=>t+(lt[a.id]||0),0);const Zh=async t=>await Ls.verifyMasterPin(t,s==null?void 0:s.uid),ki=async t=>await Ls.verifyMasterPin(t,s==null?void 0:s.uid);n.useEffect(()=>{if(s!=null&&s.uid){try{const t=ts(),a=`walletBalances_${s.uid}`,r=localStorage.getItem(t)??localStorage.getItem(a);if(r){const l=JSON.parse(r);vs(l&&typeof l=="object"?l:{});try{localStorage.setItem(t,JSON.stringify(l||{}))}catch{}}}catch{}try{const t=Yt(),a=`cashBalance_${s.uid}`,r=`userCashBalance_${s.uid}`;let l=localStorage.getItem(t)??localStorage.getItem(a)??localStorage.getItem(r);if(l!=null){const o=parseFloat(l);hs(Number.isFinite(o)?o:0);try{localStorage.setItem(t,String(Number.isFinite(o)?o:0)),localStorage.removeItem(a),localStorage.removeItem(r)}catch{}}}catch{}}},[s==null?void 0:s.uid,O,v==null?void 0:v.shopId]),n.useEffect(()=>{const t=a=>{var r;try{const l=Number((r=a==null?void 0:a.detail)==null?void 0:r.value);if(Number.isFinite(l))hs(l);else{const o=localStorage.getItem(Yt());o!=null&&hs(parseFloat(o)||0)}}catch{const l=localStorage.getItem(Yt());l!=null&&hs(parseFloat(l)||0)}};return window.addEventListener("cashBalanceChanged",t),()=>window.removeEventListener("cashBalanceChanged",t)},[s==null?void 0:s.uid,O,v==null?void 0:v.shopId]);const{data:eo}=Fn({queryKey:["dashboardData",O||(v==null?void 0:v.shopId)],queryFn:async()=>{const t=O||(v==null?void 0:v.shopId);if(!t)return null;const a=$e(U,"dashboardData",t),r=await Ws(a);return r.exists()?r.data():null},enabled:!!(s!=null&&s.uid&&(O||v!=null&&v.shopId)),staleTime:1e3*60*5,refetchInterval:1e3*60*5});n.useEffect(()=>{if(eo){const t=eo,a=Number((t==null?void 0:t.cashBalance)||0),r=t!=null&&t.walletBalances&&typeof t.walletBalances=="object"?t.walletBalances:{};try{const l=t!=null&&t.lastUpdated?new Date(t.lastUpdated).getTime():0,o=localStorage.getItem(Yt()+"_lastUpdated"),h=o?new Date(o).getTime():0;l>=h&&(hs(a),vs(r),localStorage.setItem(Yt(),String(a)),localStorage.setItem(ts(),JSON.stringify(r)),t!=null&&t.lastUpdated&&(localStorage.setItem(Yt()+"_lastUpdated",t.lastUpdated),localStorage.setItem(ts()+"_lastUpdated",t.lastUpdated)))}catch{}}},[eo]);const Kc=t=>`walletLimits_${(s==null?void 0:s.uid)||"default"}_${t||"none"}`,{data:Pi}=Fn({queryKey:["walletLimits",J],queryFn:async()=>{if(!J)return null;const t=$e(U,"walletLimits",String(J)),a=await Ws(t);return a.exists()?a.data():null},enabled:!!J,staleTime:1e3*60*5});n.useEffect(()=>{if(J)try{const t=Kc(J),a=localStorage.getItem(t);if(a&&!Pi){const r=JSON.parse(a);Rr(r)}if(Pi){const r=Pi,l={walletId:J,dailyTransferLimit:r.dailyTransferLimit??6e4,dailyWithdrawLimit:r.dailyWithdrawLimit??1e5,dailyTransferUsed:r.dailyTransferUsed??0,dailyWithdrawUsed:r.dailyWithdrawUsed??0,monthlyTransferLimit:r.monthlyTransferLimit??2e5,monthlyWithdrawLimit:r.monthlyWithdrawLimit??2e5,monthlyTransferUsed:r.monthlyTransferUsed??0,monthlyWithdrawUsed:r.monthlyWithdrawUsed??0};Rr(l);try{localStorage.setItem(Kc(J),JSON.stringify(l))}catch{}}}catch{}},[J,Pi]),n.useEffect(()=>{if(!J)return;const t=Ve.find(a=>a.id===J);if(t!=null&&t.name){bc(String(t.name));try{localStorage.setItem(`walletName_${(s==null?void 0:s.uid)||"default"}_${J}`,String(t.name))}catch{}return}try{const a=localStorage.getItem(`walletName_${(s==null?void 0:s.uid)||"default"}_${J}`);a&&bc(String(a))}catch{}},[J,Ve]);const to=async()=>{try{if(!J)return;const t=await Ta.autoResetLimitsIfNeeded(J);Rr(t)}catch(t){console.error("خطأ في جلب حدود المحفظة المختارة:",t)}};n.useEffect(()=>{to()},[J]),n.useEffect(()=>{const t=a=>{var r;(r=a==null?void 0:a.detail)!=null&&r.walletId&&a.detail.walletId===J&&to()};return window.addEventListener("walletLimitsUpdated",t),()=>window.removeEventListener("walletLimitsUpdated",t)},[J]),n.useEffect(()=>{const t=a=>{var r;try{const l=String(((r=a==null?void 0:a.detail)==null?void 0:r.walletId)||"");l&&kn(l,"sms:auto")}catch{}};return window.addEventListener("walletSelection:update",t),()=>window.removeEventListener("walletSelection:update",t)},[Ve]),n.useEffect(()=>{if(D.state){if(console.log("Location state:",D.state),D.state.openDebtDialog&&(vl(),window.history.replaceState({},document.title)),D.state.openSalesDialog&&(It||Ut?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):xn(!0),window.history.replaceState({},document.title)),D.state.openMaintenanceDialog&&(It||Ut?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ni(!0),window.history.replaceState({},document.title)),D.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),It||Ut?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ri(!0),window.history.replaceState({},document.title)),D.state.openShopExpensesDialog&&(It||Ut?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ls.hasMasterPin()?qs(!0):tt(!0),window.history.replaceState({},document.title)),D.state.openDeficienciesDialog&&(It||Ut?i({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ur(!0),window.history.replaceState({},document.title)),D.state.openInstallment&&(It||Ut?i({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"}):ai(!0),window.history.replaceState({},document.title)),D.state.openTransactionSection){const t=document.getElementById("transaction-section");t&&t.scrollIntoView({behavior:"smooth"}),D.state.transactionType&&Oo(D.state.transactionType),D.state.startNewTransaction&&(Ys(""),ds(""),Hi(""),Qi(""),console.log("🔒 Starting new transaction without changing wallet selection")),D.state.focusWalletSelection&&setTimeout(()=>{const a=document.querySelector('[data-testid="wallet-select"]');a&&a.focus()},500),window.history.replaceState({},document.title)}D.state.openCashierShiftModal&&(!Aa||Ut?i({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):me(!0),window.history.replaceState({},document.title)),D.state.openMachineDailyDialog&&(!Aa||Ut?i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):ii(!0),window.history.replaceState({},document.title)),D.state.openBranchManagement&&((ie==null?void 0:ie.status)==="active"?Le(!0):ze(!0),window.history.replaceState({},document.title))}},[D.state,Ve,Ut,ie]),n.useEffect(()=>{D.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),so(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",D.pathname)},[D.pathname,s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;(async()=>{try{const a=$e(U,"users",s.uid),r=await Ws(a);if(r.exists()){const o=r.data().isActive===!0;o&&!Qt?(Us(!0),ua(!1),ha(!1)):!o&&Qt&&(Us(!1),ua(!0))}}catch(a){console.error("Check user status error",a)}})()},[s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;const t=r=>{const{userId:l}=r.detail;l===s.uid&&(console.log("🎉 Subscription activation event received for current user!"),Us(!0),ua(!1),ha(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},a=r=>{const{userId:l,isActive:o}=r.detail;l===s.uid&&(console.log("🔄 User subscription update event received:",{userId:l,isActive:o}),o&&!Qt&&(Us(!0),ua(!1),ha(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",t),window.addEventListener("userSubscriptionUpdated",a),()=>{window.removeEventListener("subscriptionActivated",t),window.removeEventListener("userSubscriptionUpdated",a)}},[s==null?void 0:s.uid,Qt]),n.useEffect(()=>{const t=a=>{var h;const r=a.target,l=(h=r==null?void 0:r.tagName)==null?void 0:h.toLowerCase();if(!(l==="input"||l==="textarea"||l==="select"||((r==null?void 0:r.isContentEditable)??!1))&&!(a.ctrlKey||a.altKey||a.metaKey)&&!a.repeat){if((It||Ut)&&a.key>="1"&&a.key<="9"){a.preventDefault();return}switch(a.key){case"1":break;case"2":ll(!0);break;case"3":It||Ut?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ri(!0);break;case"4":Aa?me(!0):i({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"5":It||Ut?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):xn(!0);break;case"6":vl();break;case"7":It||Ut?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ni(!0);break;case"8":Aa?ii(!0):i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"9":It||Ut?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ls.hasMasterPin()?qs(!0):tt(!0);break}}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[It,Ut,Aa]),n.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:s==null?void 0:s.uid,isCheckingActivation:Ja}),(async()=>{try{if(!(s!=null&&s.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),ha(!1);return}try{const h=await Ws($e(U,"users",s.uid));if(h.exists()){const u=h.data().isActive===!0,b=await hd.checkTrialValidity(s.uid),p=b.isValid&&!b.isExpired;Us(u||p),T(p),K(b.hoursRemaining),ce(b.hasUsedTrial),ua(!u&&!p),console.log("📊 حالة المستخدم:",{isActive:u,isOnTrial:p,hoursRemaining:b.hoursRemaining,hasUsedTrial:b.hasUsedTrial})}else Us(!1),ua(!0)}catch(h){console.error("خطأ في فحص حالة تفعيل المستخدم:",h),Us(!1),ua(!0)}finally{ha(!1)}if(console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:s==null?void 0:s.uid}),s!=null&&s.uid){const h=await Ur(()=>Ce.getUserData(s.uid)),m=`userData_${s==null?void 0:s.uid}`;let u=null;try{const b=localStorage.getItem(m);b&&(u=JSON.parse(b))}catch{}if(h){let b=(h==null?void 0:h.walletBalances)||{},p=h==null?void 0:h.cashBalance;const g=h.lastUpdated?new Date(h.lastUpdated).getTime():0;u&&(u.lastUpdated?new Date(u.lastUpdated).getTime():0)>=g&&(u.walletBalances&&(b=u.walletBalances),u.cashBalance!==void 0&&(p=u.cashBalance));try{const w=Yt(),C=ts(),A=localStorage.getItem(w+"_lastUpdated"),R=localStorage.getItem(C+"_lastUpdated"),oe=A?new Date(A).getTime():0,_=R?new Date(R).getTime():0;if(oe>g){const z=localStorage.getItem(w);z!==null&&(p=parseFloat(z))}if(_>g){const z=localStorage.getItem(C);if(z!==null)try{b=JSON.parse(z)}catch{}}}catch(w){console.error("Error checking individual keys fallback:",w)}vs(b),p!==void 0&&hs(p);try{const w=s!=null&&s.uid?await Ur(()=>Wn.getDeletedTransactionsByUser(s.uid)):[];fn(w||[])}catch{fn([])}}else{vs({});try{const b=s!=null&&s.uid?await Wn.getDeletedTransactionsByUser(s.uid):[];fn(b||[])}catch{fn([])}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const h=await Ur(()=>ga.getByMerchantId((s==null?void 0:s.uid)||""));if(h&&h.length>0){console.log("✅ تم العثور على محافظ في Firebase:",h.length);const u=h.filter(g=>g.isActive===!0).map(g=>({id:g.id,name:g.label||"محفظة بدون اسم",phone:g.msisdn,isDefault:!1,monthlyWithdrawalLimit:g.monthlyWithdrawalLimit??g.withdrawLimit??2e5,monthlyTransferLimit:g.monthlyTransferLimit??g.transferLimit??2e5,defaultTransferCommission:g.defaultTransferCommission!=null?Number(g.defaultTransferCommission):null,defaultWithdrawCommission:g.defaultWithdrawCommission!=null?Number(g.defaultWithdrawCommission):null}));Er(u);const b=localStorage.getItem(Nr());let p=null;b&&u.find(g=>g.id===b)?p=u.find(g=>g.id===b):p=u[0],p&&(cs(p.id),bs(p.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else console.log("⚠️ لا توجد محافظ في Firebase. سيتم عرض قائمة فارغة بدون أي استرجاع محلي."),Er([])}catch(h){console.error("خطأ في تحميل المحافظ من Firebase:",h),Er([])}const o=s!=null&&s.uid?await Ur(()=>Ce.getUserTransactions(s.uid)):[];if(o&&o.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",o.length);const h=o.map(g=>({...g,createdAt:new Date(g.createdAt),senderPhone:g.senderMsisdn||g.senderPhone||"",receiverPhone:g.receiverMsisdn||g.receiverPhone||"",type:g.txnType==="send"?"send":g.txnType==="receive"?"withdraw":g.type||"withdraw",status:g.status==="confirmed"?"completed":g.status||"completed"})),m=gn.map(g=>g.id||g.originalTransactionId);let u=[];try{const g=Je(ye(U,"deletedTransactions"),le("userId","==",(s==null?void 0:s.uid)||""),le("permanent","==",!0));u=(await Ue(g)).docs.map(C=>{const A=C.data();return String(A.originalTransactionId||A.transactionId||C.id||"")}).filter(Boolean)}catch{}const b=new Set(u),p=h.filter(g=>{var _;const w=String(g.id||""),C=String(g.transactionId||""),A=String(g.reference||g.transactionReference||((_=g.receipt)==null?void 0:_.reference)||""),R=m.includes(w),oe=b.has(w)||C&&b.has(C);return!R&&!oe});console.log("✅ تم فلترة المعاملات المحذوفة:",{total:o.length,deleted:m.length,active:p.length});{const g=new Set,w=[];for(const C of p){const A=_c(C);g.has(A)||(g.add(A),w.push(C))}_m||aa(w)}}await Bc()}catch(o){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",o)}})().then(async()=>{await l(),await a(),await r()});const a=async()=>{try{if(!(s!=null&&s.uid))return;const o=await ga.getByMerchantId(s.uid);await Promise.all(o.map(h=>qx.autoResetLimitsIfNeeded(h.id)))}catch(o){console.error("خطأ في التصفير التلقائي للحدود:",o)}},r=async()=>{try{await Rs.syncReportsDataFromFirebase(s==null?void 0:s.uid);const o=Rs.getReportsData(s==null?void 0:s.uid);if((o.lastDailyResetDate?Rs.shouldResetDailyReports(o.lastDailyResetDate):!1)&&(s!=null&&s.uid)&&o.lastDailyResetDate){const u=new Date(o.lastDailyResetDate),b=u.toDateString(),p=Ge.filter(_=>new Date(_.createdAt).toDateString()===b&&_.status==="completed"),g=p.length,w=p.reduce((_,z)=>_+z.amount,0),C=p.filter(Pn).reduce((_,z)=>{const xe=z.withdrawnAmount!==void 0?z.withdrawnAmount:z.amount;return _+xe},0),A=p.filter(_n).reduce((_,z)=>{const xe=z.sentAmount!==void 0?z.sentAmount:z.amount;return _+xe},0),R=p.reduce((_,z)=>_+Rs.calculateTransactionProfit(z),0),oe=new Date(u).toISOString().slice(0,10);await Mn.add({userId:s.uid,reportDate:oe,totalTransactions:g,totalAmount:Number(w.toFixed(2)),totalWithdrawn:Number(C.toFixed(2)),totalSent:Number(A.toFixed(2)),profit:Number(R.toFixed(2)),walletId:null})}const m=Rs.autoResetReportsIfNeeded(s==null?void 0:s.uid);(m.dailyReset||m.monthlyReset)&&console.log("تم التصفير التلقائي:",m)}catch(o){console.error("خطأ في التصفير التلقائي للتقارير:",o)}},l=async()=>{try{if(!(s!=null&&s.uid))return;const o=new Date;if(o.getDate()!==1)return;const h=`${o.getFullYear()}-${o.getMonth()+1}`,m=`lastMonthlyDbCleanup:${s.uid}`;if(localStorage.getItem(m)===h)return;const b=new Date(o.getFullYear(),o.getMonth(),1,0,0,0,0),p=C=>C instanceof Date?C:typeof(C==null?void 0:C.toDate)=="function"?C.toDate():new Date(String(C));let g=[];try{const C=Je(ye(U,"userTransactions"),le("userId","==",s.uid),le("createdAt","<",b));g=(await Ue(C)).docs}catch{const C=Je(ye(U,"userTransactions"),le("userId","==",s.uid));g=(await Ue(C)).docs.filter(R=>{var oe;return p((oe=R.data())==null?void 0:oe.createdAt)<b})}await Promise.allSettled(g.map(C=>ya(C.ref)));let w=[];try{const C=Je(ye(U,"transactions"),le("userId","==",s.uid),le("createdAt","<",b));w=(await Ue(C)).docs}catch{const C=Je(ye(U,"transactions"),le("userId","==",s.uid));w=(await Ue(C)).docs.filter(R=>{var oe;return p((oe=R.data())==null?void 0:oe.createdAt)<b})}await Promise.allSettled(w.map(C=>ya(C.ref)));try{localStorage.setItem(m,h)}catch{}console.log("✅ تم تنظيف قاعدة البيانات شهريًا (Firebase فقط):",{userTransactionsDeleted:g.length,globalTransactionsDeleted:w.length,monthStart:b})}catch(o){console.error("فشل التنظيف الشهري التلقائي لقاعدة البيانات:",o)}};vh(),Pl(),Eh(),console.log("🔥 useEffect loadUserData completed")},[s==null?void 0:s.uid]);const so=async()=>{var t;if(s!=null&&s.uid)try{const a=await Ur(()=>ga.getByMerchantId(s.uid));if(a&&a.length>0){const l=a.filter(o=>o.isActive===!0).map(o=>({id:o.id,name:o.label||"محفظة بدون اسم",phone:o.msisdn,isDefault:!1,monthlyWithdrawalLimit:o.monthlyWithdrawalLimit??o.withdrawLimit??2e5,monthlyTransferLimit:o.monthlyTransferLimit??o.transferLimit??2e5,defaultTransferCommission:o.defaultTransferCommission!=null?Number(o.defaultTransferCommission):void 0,defaultWithdrawCommission:o.defaultWithdrawCommission!=null?Number(o.defaultWithdrawCommission):void 0}));if(Er(l),s!=null&&s.uid){const o=localStorage.getItem(Nr());if(!!(J&&l.find(m=>m.id===J)))console.log("🔒 Preserving current wallet selection:",J);else{const u=(o&&l.find(b=>b.id===o)?o:null)||((t=l[0])==null?void 0:t.id);u&&(console.log("🔄 Fixing invalid wallet selection:",u),kn(u))}}console.log("🔄 تم تحديث المحافظ من Firebase:",l.length)}}catch(a){console.error("خطأ في تحميل المحافظ من Firebase:",a)}};n.useEffect(()=>{const t=D.pathname;if(sessionStorage.getItem("previousPath")==="/user/add-wallet"&&t==="/user/dashboard"){L.invalidateQueries({queryKey:["wallets",s==null?void 0:s.uid]});try{Xn.refetch()}catch{}sessionStorage.removeItem("previousPath")}sessionStorage.setItem("previousPath",t)},[D.pathname,s==null?void 0:s.uid]),n.useEffect(()=>{const t=()=>{L.invalidateQueries({queryKey:["wallets",s==null?void 0:s.uid]});try{Xn.refetch()}catch{}};return window.addEventListener("focus",t),()=>{window.removeEventListener("focus",t)}},[s==null?void 0:s.uid,J,Ve]);const kn=async(t,a="unknown")=>{console.log(`🎯 setWalletSelection called from ${a} with walletId:`,t),console.log("🔍 Previous selectedWallet:",J),cs(t);const r=Ve.find(l=>l.id===t);if(r&&(bs(r.phone),console.log("✅ Wallet set successfully:",t,"Phone:",r.phone)),s!=null&&s.uid){localStorage.setItem(Nr(),t),console.log("💾 Saved wallet to localStorage:",t);try{await $n.set({key:"selected_wallet_id",value:t}),await $n.set({key:"current_user_id",value:s.uid}),console.log("📱 Saved wallet and user ID to Capacitor Preferences:",t,s.uid)}catch(l){console.error("❌ Failed to save to Capacitor Preferences:",l)}}};n.useEffect(()=>{const t=()=>{so()};try{window.addEventListener("wallets:activation-updated",t)}catch{}return()=>{try{window.removeEventListener("wallets:activation-updated",t)}catch{}}},[s==null?void 0:s.uid]);const Xh=t=>{if(t==="__add_wallet"){$("/user/add-wallet");return}if(t==="__view_wallets"){Qn(!0);return}xx.isEnabled(s==null?void 0:s.uid)?(Yi(t),Ki(!0)):kn(t,"walletSelectionNoPin")},_i=t=>{console.log("🔄 handleTransactionTypeChange called with type:",t),console.log("🔍 Current selectedWallet before change:",J),console.log("🔍 Available wallets count:",Ve.length),Oo(t),Ys(""),ds(""),Hi(""),Qi(""),console.log("✅ Transaction type changed to:",t,"- Wallet selection preserved:",J),setTimeout(()=>{const a=document.getElementById("transaction-section");a&&a.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)};n.useEffect(()=>{const t=a=>{const r=a.target;if(!!r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"||r.tagName==="SELECT"||r.isContentEditable)||(a.key==="ArrowLeft"?(a.preventDefault(),_i("withdraw")):a.key==="ArrowRight"&&(a.preventDefault(),_i("transfer"))),a.key==="Enter"){const o=fe==="transfer"?"transferSubmitButton":"withdrawSubmitButton",h=document.getElementById(o);h&&!h.disabled&&(a.preventDefault(),h.click())}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[fe]);const Yc=t=>{Tm((r=>({id:r.id,type:r.type==="send"?"transfer":"withdraw",sender_msisdn:r.senderPhone,receiver_msisdn:r.receiverPhone,amount:r.amount,commission:r.commission||0,fee:(r==null?void 0:r.fee)??0,status:r.status==="failed"?"failed":r.status==="completed"?"completed":"pending",createdAt:new Date(r.createdAt).toISOString(),updatedAt:new Date(r.createdAt).toISOString(),shopName:H??(v==null?void 0:v.shopName)??(s==null?void 0:s.displayName)??"المحل",cashierName:(r==null?void 0:r.cashierName)??null,commissionMode:(r==null?void 0:r.commissionMode)??(r.type==="send"||Pt?"add":"deduct"),totalCharged:(r==null?void 0:r.totalCharged)??(r.type==="send"?Number(r.amount||0)+Number(r.commission||0)+Number((r==null?void 0:r.fee)||0):Pt?Number(r.amount||0)+Number(r.commission||0):Number(r.amount||0)),note:(r==null?void 0:r.note)??(r==null?void 0:r.notes)??void 0,senderName:(r==null?void 0:r.senderName)??void 0,provider:(r==null?void 0:r.provider)??void 0,title:(()=>{const l=String((r==null?void 0:r.provider)||"").toLowerCase(),o=l.includes("vodafone")?"vf-cash":l.includes("instapay")?"instapay":"",h=r.type==="send"?"تحويل":"سحب";return r.type==="withdraw"&&o?`${h} ${o}`:h})()}))(t)),ei(!0)},eu=async t=>{var o;if(!(s!=null&&s.uid)){i({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const a=Ge.find(h=>h.id===t);if(!a){i({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}const r=String(t),l=String((a==null?void 0:a.transactionId)||(a==null?void 0:a.reference)||"");Ia.current.add(r),l&&Ia.current.add(l);try{console.log("🗑️ بدء عملية حذف المعاملة:",t),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:a.id,userId:s.uid,transactionData:a}),await Ce.removeUserTransaction(s.uid,a.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await Wn.saveDeletedTransaction({...a,userId:s.uid,originalTransactionId:a.id,transactionId:a.transactionId||a.id,reference:a.reference||a.transactionReference||((o=a.receipt)==null?void 0:o.reference),deletedAt:new Date().toISOString(),permanent:!0}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(u){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",u)}try{await Wn.permanentlyDeleteTransaction(a.id,s.uid)}catch(u){console.warn("⚠️ فشل وسم الحذف النهائي أو التنظيف الإضافي:",u)}const h=[...gn,a],m=Ge.filter(u=>u.id!==t);fn(h),aa(m),Lo(!1),console.log("✅ تم تحديث الحالة بعد الحذف من Firebase (بدون نسخ محلية)");try{const u=a.fromWallet;if(u){const{walletDailyLimitsService:b}=await yt(async()=>{const{walletDailyLimitsService:g}=await import("./index-DCCNgGPW.js").then(w=>w.cq);return{walletDailyLimitsService:g}},__vite__mapDeps([0,1]),import.meta.url),p=await b.getWalletLimits(u);if(p){const g=a.type==="send",w={updatedAt:(await yt(async()=>{const{serverTimestamp:_}=await import("./index-DCCNgGPW.js").then(z=>z.ck);return{serverTimestamp:_}},__vite__mapDeps([0,1]),import.meta.url)).serverTimestamp()};g?(w.dailyTransferUsed=Math.max(0,(p.dailyTransferUsed||0)-a.amount),w.monthlyTransferUsed=Math.max(0,(p.monthlyTransferUsed||0)-a.amount)):(w.dailyWithdrawUsed=Math.max(0,(p.dailyWithdrawUsed||0)-a.amount),w.monthlyWithdrawUsed=Math.max(0,(p.monthlyWithdrawUsed||0)-a.amount));const{doc:C,setDoc:A}=await yt(async()=>{const{doc:_,setDoc:z}=await import("./index-DCCNgGPW.js").then(xe=>xe.ck);return{doc:_,setDoc:z}},__vite__mapDeps([0,1]),import.meta.url),{db:R}=await yt(async()=>{const{db:_}=await import("./index-DCCNgGPW.js").then(z=>z.cl);return{db:_}},__vite__mapDeps([0,1]),import.meta.url),oe=C(R,"walletLimits",u);await A(oe,w,{merge:!0})}}}catch(u){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",u)}try{const{ProfitService:u}=await yt(async()=>{const{ProfitService:C}=await import("./profitService-Bwg-yNfl.js");return{ProfitService:C}},__vite__mapDeps([3,0,1]),import.meta.url),{ReportsService:b}=await yt(async()=>{const{ReportsService:C}=await import("./index-DCCNgGPW.js").then(A=>A.cp);return{ReportsService:C}},__vite__mapDeps([0,1]),import.meta.url),g={txnType:a.type==="send"?"send":"receive",amount:a.amount,commission:a.commission||0,createdAt:a.createdAt,status:"confirmed"},w=u.calculateProfitFromTransaction(g);w>0&&u.addProfit(-w,s.uid);try{b.removeTransactionEffects(a,s.uid)}catch{}}catch(u){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",u)}i({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(h){console.error("❌ خطأ في حذف المعاملة من Firebase:",h);let m="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";h instanceof Error&&(h.message.includes("network")||h.message.includes("offline")?m="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":h.message.includes("permission")||h.message.includes("unauthorized")?m="ليس لديك صلاحية لحذف هذه المعاملة":h.message.includes("not-found")&&(m="المعاملة غير موجودة أو تم حذفها مسبقاً")),i({title:"خطأ في الحذف",description:m,variant:"destructive"})}},Pn=t=>{const a=t.type,r=t.txnType;return a==="withdraw"||a==="withdrawal"||a==="receive"||r==="receive"},_n=t=>{const a=t.type,r=t.txnType;return a==="send"||a==="transfer"||r==="send"},On=(t,a)=>{const r=new Date().toDateString();let l=Ge.filter(p=>{const g=new Date(p.createdAt).toDateString()===r,w=String(p.status||"").toLowerCase();return g&&(w==="completed"||w==="confirmed"||w==="pending")});Fa&&Fa.trim()!==""&&(l=l.filter(p=>p.senderPhone&&p.senderPhone.includes(Fa)||p.receiverPhone&&p.receiverPhone.includes(Fa)));const o=Rs.filterVisibleTransactions(l,"daily",s==null?void 0:s.uid),h=o.length,m=o.reduce((p,g)=>p+g.amount,0),u=o.filter(Pn).reduce((p,g)=>{const w=g.withdrawnAmount!==void 0?g.withdrawnAmount:g.amount;return p+w},0),b=o.filter(_n).reduce((p,g)=>{const w=g.sentAmount!==void 0?g.sentAmount:g.amount;return p+w},0);return{totalTransactions:h,totalAmount:m,totalWithdrawn:u,totalSent:b}},En=t=>{const a=new Date().getMonth(),r=new Date().getFullYear();let l=Ge.filter(p=>{const g=new Date(p.createdAt);return g.getMonth()===a&&g.getFullYear()===r&&p.status==="completed"});Fa&&Fa.trim()!==""&&(l=l.filter(p=>p.senderPhone&&p.senderPhone.includes(Fa)||p.receiverPhone&&p.receiverPhone.includes(Fa)));const o=Rs.filterVisibleTransactions(l,"monthly",s==null?void 0:s.uid),h=o.length,m=o.reduce((p,g)=>p+g.amount,0),u=o.filter(Pn).reduce((p,g)=>{const w=g.withdrawnAmount!==void 0?g.withdrawnAmount:g.amount;return p+w},0),b=o.filter(_n).reduce((p,g)=>{const w=g.sentAmount!==void 0?g.sentAmount:g.amount;return p+w},0);return{totalTransactions:h,totalAmount:m,totalWithdrawn:u,totalSent:b}},tu=t=>{const a=new Date().getMonth(),r=new Date().getFullYear(),l=Ge.filter(m=>{const u=new Date(m.createdAt);return u.getMonth()===a&&u.getFullYear()===r&&m.status==="completed"&&m.fromWallet===t}),o=l.filter(Pn).reduce((m,u)=>{const b=u.withdrawnAmount||u.amount;return m+b},0),h=l.filter(_n).reduce((m,u)=>{const b=u.sentAmount||u.amount;return m+b},0);return{totalWithdrawn:o,totalTransferred:h}},su=t=>{const a=new Date,r=a.getDate(),l=a.getMonth(),o=a.getFullYear(),h=Ge.filter(b=>{const p=new Date(b.createdAt);return p.getDate()===r&&p.getMonth()===l&&p.getFullYear()===o&&b.status==="completed"&&b.fromWallet===t}),m=h.filter(Pn).reduce((b,p)=>{const g=p.withdrawnAmount||p.amount;return b+g},0),u=h.filter(_n).reduce((b,p)=>{const g=p.sentAmount||p.amount;return b+g},0);return{totalWithdrawn:m,totalTransferred:u}},Hc=Ye.useMemo(()=>En(),[Ge,J,Fa]);Hc.totalWithdrawn,Hc.totalSent;const Ba=Ye.useMemo(()=>tu(J),[Ge,J]);n.useEffect(()=>{try{if(!J||Ve.length===0)return;const t=Ve.find(A=>A.id===J);if(!t)return;const a=(at==null?void 0:at.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,r=(at==null?void 0:at.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,l=parseFloat(Gt||"0")||0,o=(Ba==null?void 0:Ba.totalWithdrawn)??(at==null?void 0:at.monthlyWithdrawUsed)??0,h=(Ba==null?void 0:Ba.totalTransferred)??(at==null?void 0:at.monthlyTransferUsed)??0,m=o+(fe==="withdraw"?l:0),u=h+(fe==="transfer"?l:0),b=.85,p=Math.floor(Math.max(a,1)*b),g=Math.floor(Math.max(r,1)*b),w=(()=>{const A=new Date;return`${A.getFullYear()}-${String(A.getMonth()+1).padStart(2,"0")}`})(),C=`monthlyLimitWarnShown:${J}:${w}`;if(m>=p){const A=`${C}:withdraw`;if(!(localStorage.getItem(A)==="true")){_o({type:"withdraw",used:m,limit:a,walletName:t.name}),Po(!0);try{localStorage.setItem(A,"true")}catch{}return}}if(u>=g){const A=`${C}:transfer`;if(!(localStorage.getItem(A)==="true")){_o({type:"transfer",used:u,limit:r,walletName:t.name}),Po(!0);try{localStorage.setItem(A,"true")}catch{}return}}}catch{}},[J,Ve,at,Ba,fe,Gt]);const Qc=async()=>{var ws,As,er,qr;jp(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:Lt,receiverPhone:Rt,amount:Gt,transactionType:fe});const t=()=>{fe==="transfer"?Mr(!0):yn(!0)},a=()=>{fe==="transfer"?Mr(!1):yn(!1)};if(t(),!Lt||!Gt){console.log("❌ خطأ: بيانات ناقصة"),i({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),a();return}if(fe==="transfer"&&!Rt&&!W){console.log("❌ خطأ: رقم المستقبل مفقود"),i({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),a();return}if(fe==="transfer"&&!W&&(String(Rt||"").replace(/[^0-9٠-٩]/g,""),!/[^0-9٠-٩\s]/.test(String(Rt||""))&&!Sp(Rt))){i({title:"رقم المستقبل غير صالح",description:"اكتب رقم صحيح مكون من 11 رقم ويبدأ بـ 015 أو 010 أو 012 أو 011",variant:"destructive"}),a();return}const r=parseFloat(Gt);if(console.log("💰 المبلغ المحول:",r),r<=0){console.log("❌ خطأ: مبلغ غير صحيح"),i({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),a();return}if(It)try{const he=new Date,Pe=he.getFullYear(),ot=String(he.getMonth()+1).padStart(2,"0"),Ht=String(he.getDate()).padStart(2,"0"),Ts=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${Pe}-${ot}-${Ht}`,Vs=localStorage.getItem(Ts);if((Vs&&parseInt(Vs,10)||0)>=10){i({title:"حد التأكيد اليومي",description:"باقة زيرو تسمح بـ 10 تأكيدات تحويل/سحب يومياً فقط.",variant:"destructive"}),a();return}}catch(he){console.warn("فشل قراءة عداد تأكيدات باقة زيرو من التخزين المحلي:",he)}const l=Ve.find(he=>he.id===J);if(!l){i({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),a();return}const o=Ba;if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:J,walletName:l.name,currentWithdrawn:o.totalWithdrawn,currentTransferred:o.totalTransferred,withdrawalLimit:l.monthlyWithdrawalLimit,transferLimit:l.monthlyTransferLimit}),fe==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${o.totalWithdrawn}, المبلغ الجديد: ${r}, الحد الأقصى: ${l.monthlyWithdrawalLimit}`),o.totalWithdrawn+r>l.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),i({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${l.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${o.totalTransferred}, المبلغ الجديد: ${r}, الحد الأقصى: ${l.monthlyTransferLimit}`),o.totalTransferred+r>l.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),i({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${l.monthlyTransferLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}v!=null&&v.shopName||s!=null&&s.displayName,Date.now().toString(),fe==="withdraw"&&_r.trim()!==""&&_r.trim(),l!=null&&l.name,fe==="transfer"||Hs&&Hs.trim()!==""&&Hs.trim(),y&&(N!=null&&N.name||N!=null&&N.username)&&(N!=null&&N.name||(N==null||N.username));const h=Gr.validateTransaction(r,fe,Wt,lt);if(!h.isValid){i({title:"خطأ في العملية",description:h.error,variant:"destructive"}),a();return}h.warning&&i({title:"تحذير",description:h.warning,variant:"destructive"});let m;if(fe==="transfer")if((l==null?void 0:l.defaultTransferCommission)!=null){const he=Number(l.defaultTransferCommission)||0;m=Math.round(he*r/1e3*100)/100}else Es&&Es.trim()!==""?m=Math.max(0,parseFloat(Es)):m=0;else if((l==null?void 0:l.defaultWithdrawCommission)!=null){const he=Number(l.defaultWithdrawCommission)||0;m=Math.round(he*r/1e3*100)/100}else Os&&Os.trim()!==""?m=Math.max(0,parseFloat(Os)):m=Math.round(r*.01*100)/100;if(fe!=="transfer"&&!Pt&&m>=r){i({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),a();return}const u=fe==="transfer"||Pt?r:Math.round((r-m)*100)/100;let b;const p=fe==="transfer"&&!!xa,g=fe==="withdraw"&&!!xa,w=p||g;let C=null;const A=Gn(Lt||"").replace(/\D/g,""),R=Gn(Rt||"").replace(/\D/g,""),oe=fe==="transfer"&&(A.startsWith("010")&&(R.startsWith("011")||R.startsWith("012")||R.startsWith("015"))||A.startsWith("012")&&R.startsWith("010")||A.startsWith("011")&&R.startsWith("010")||A.startsWith("015")&&R.startsWith("010")),_=Math.max(0,parseFloat(ko||"0")),z=Math.round(m*100)/100;if(oe&&!w&&_<=0){i({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"}),a();return}if(fe==="transfer"&&!w){const he=Number(lt[J]||0),Pe=Number(u)+Number(_);if(he<Pe){i({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${he} لا يكفي لخصم ${Pe}`,variant:"destructive"}),a();return}}if(w)if(p){const he=Gr.validateTransaction(u,"transfer",Wt,lt);if(!he.isValid)b={success:!1,newCashBalance:Wt,newWalletBalances:lt,message:he.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"};else{const Pe=J||((ws=Ve.find(pt=>pt.isDefault))==null?void 0:ws.id)||((As=Ve[0])==null?void 0:As.id),ot=at??await Ta.getWalletLimits(Pe),Ht=new Date().toDateString(),Ts=Ge.filter(pt=>pt.type==="send"&&String(pt.status||"").toLowerCase()==="pending"&&pt.fromWallet===Pe&&new Date(pt.createdAt).toDateString()===Ht).reduce((pt,Bs)=>pt+Number(Bs.sentAmount??Bs.transferredAmount??Bs.amount??0),0),Vs=Number((ot==null?void 0:ot.dailyTransferLimit)??6e4),na=Number((ot==null?void 0:ot.dailyTransferUsed)??0);if(na+Ts+Number(u)>Vs){i({title:"تجاوز الحد اليومي للتحويل",description:`المتبقي اليوم: ${(Vs-na-Ts).toLocaleString()} ج.م`,variant:"destructive"}),a();return}const Zt=new Date,$s=Ge.filter(pt=>pt.type==="send"&&String(pt.status||"").toLowerCase()==="pending"&&pt.fromWallet===Pe&&new Date(pt.createdAt).getMonth()===Zt.getMonth()&&new Date(pt.createdAt).getFullYear()===Zt.getFullYear()).reduce((pt,Bs)=>pt+Number(Bs.sentAmount??Bs.transferredAmount??Bs.amount??0),0),Js=Number((ot==null?void 0:ot.monthlyTransferLimit)??2e5),zr=Number((ot==null?void 0:ot.monthlyTransferUsed)??0);if(zr+$s+Number(u)>Js){i({title:"تجاوز الحد الشهري للتحويل",description:`المتبقي هذا الشهر: ${(Js-zr-$s).toLocaleString()} ج.م`,variant:"destructive"}),a();return}b={success:!0,newCashBalance:Wt,newWalletBalances:lt}}}else{const he=J||((er=Ve.find(pt=>pt.isDefault))==null?void 0:er.id)||((qr=Ve[0])==null?void 0:qr.id),Pe=at??await Ta.getWalletLimits(he),ot=new Date().toDateString(),Ht=Ge.filter(pt=>pt.type==="withdraw"&&String(pt.status||"").toLowerCase()==="pending"&&pt.fromWallet===he&&new Date(pt.createdAt).toDateString()===ot).reduce((pt,Bs)=>pt+Number(Bs.withdrawnAmount??Bs.amount??0),0),Ts=Number((Pe==null?void 0:Pe.dailyWithdrawLimit)??1e5),Vs=Number((Pe==null?void 0:Pe.dailyWithdrawUsed)??0);if(Vs+Ht+Number(u)>Ts){i({title:"تجاوز الحد اليومي للسحب",description:`المتبقي اليوم: ${(Ts-Vs-Ht).toLocaleString()} ج.م`,variant:"destructive"}),a();return}const na=new Date,Zt=Ge.filter(pt=>pt.type==="withdraw"&&String(pt.status||"").toLowerCase()==="pending"&&pt.fromWallet===he&&new Date(pt.createdAt).getMonth()===na.getMonth()&&new Date(pt.createdAt).getFullYear()===na.getFullYear()).reduce((pt,Bs)=>pt+Number(Bs.withdrawnAmount??Bs.amount??0),0),$s=Number((Pe==null?void 0:Pe.monthlyWithdrawLimit)??2e5),Js=Number((Pe==null?void 0:Pe.monthlyWithdrawUsed)??0);if(Js+Zt+Number(u)>$s){i({title:"تجاوز الحد الشهري للسحب",description:`المتبقي هذا الشهر: ${($s-Js-Zt).toLocaleString()} ج.م`,variant:"destructive"}),a();return}b={success:!0,newCashBalance:Math.round((Number(Wt)-Number(u))*100)/100,newWalletBalances:lt}}else fe==="transfer"?b=await Gr.processTransfer({amount:u,currentCashBalance:Wt,currentWalletBalances:lt,wallets:Ve,selectedWalletId:J,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0}):b=await Gr.processWithdraw({amount:u,currentCashBalance:Wt,currentWalletBalances:lt,wallets:Ve,selectedWalletId:J,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0});if(!b.success){i({title:"فشل في العملية",description:b.error||b.message,variant:"destructive"}),a();return}let xe=w?g?b.newCashBalance:Wt:b.newCashBalance,qe=w?lt:b.newWalletBalances;if(!w&&fe==="transfer"&&_>0){const he=Number(qe[J]||0);qe={...qe,[J]:Math.round((he-Number(_))*100)/100}}if(w&&p){const he=Ve.find(Ht=>Ht.id===J)??Ve.find(Ht=>Ht.isDefault)??Ve[0],Pe=(he==null?void 0:he.id)||J;if(Pe!==J)try{kn(Pe)}catch{}const ot=Number(lt[Pe]||0);qe={...lt,[Pe]:Math.round((ot-Number(u)-Number(_))*100)/100}}if((p||g)&&xa&&!mm){const he={id:`DEBT-${Date.now()}`,debtorName:xa.debtorName,amount:xa.amount,reason:xa.notes||"",customerId:xa.customerId,mobile:xa.mobile,status:"pending",createdAt:new Date};C=he.id;const Pe=[he,...wt];Ms(Pe);try{if(await ca(Pe),s!=null&&s.uid){const ot=$e(U,"debts",he.id),Ht={...he,userId:s.uid,shopId:O||(v==null?void 0:v.shopId)||null,lastUpdated:new Date().toISOString()};Object.keys(Ht).forEach(Ts=>Ht[Ts]===void 0&&delete Ht[Ts]),await Ps(ot,Ht,{merge:!0})}}catch(ot){console.error("⚠️ فشل حفظ الدين المؤجل محلياً أو سحابياً:",ot)}i({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}if(!w){const he=Math.max(0,Number(m))+Math.max(0,Number(_));he>0&&(xe=Math.round((xe+he)*100)/100,console.log(`💰 تم إضافة عمولة/رسوم ${he} جنيه لدرج النقدية`))}console.log("⚡ تحديث الواجهة فوراً بدون حجب باستخدام startTransition...");const qt="temp_"+Date.now()+"_"+Math.random().toString(36).substring(7),Cs={shopId:O||(v==null?void 0:v.shopId)||(s==null?void 0:s.uid)||"default-shop",lineId:J||"default-line",walletId:J||void 0,merchantUserId:(s==null?void 0:s.uid)||null,provider:"vodafone_cash",txnType:fe==="transfer"?"send":"receive",originType:fe==="transfer"?"transfer":"withdraw",amount:u,commission:z,fee:_,profit:0,senderMsisdn:Lt,receiverMsisdn:fe==="transfer"?Rt:Lt,note:fe==="transfer"?void 0:Hs&&Hs.trim()!==""?Hs.trim():void 0,status:w?"pending":"confirmed",linkedDebtId:C||void 0,createdBy:(s==null?void 0:s.uid)||null,walletEffectAppliedOnCreation:!1,cashEffectAppliedOnCreation:!!(w&&g),limitsReservedOnCreation:!!w,limitReservedType:fe==="transfer"?"transfer":"withdraw",profitAddedOnCreation:!1},xt={...Cs,id:qt,status:w?"pending":"completed",commissionMode:fe==="transfer"||Pt?"add":"deduct",totalCharged:fe==="transfer"?u+z+_:Pt?u+m:u,walletEffectAppliedOnCreation:!1,cashEffectAppliedOnCreation:!!(w&&g),limitsReservedOnCreation:!!w,limitReservedType:fe==="transfer"?"transfer":"withdraw",sentAmount:fe==="transfer"?u:void 0,transferredAmount:fe==="transfer"?u:void 0,withdrawnAmount:fe==="withdraw"?u:void 0,senderName:fe==="withdraw"&&_r.trim()!==""?_r.trim():void 0,createdAt:new Date,type:fe==="transfer"?"send":"withdraw",senderPhone:Lt||"",receiverPhone:Rt||""};try{Wa.current=[xt,...Wa.current],L.setQueryData(["recentTransactions",s==null?void 0:s.uid,O||"main"],he=>!he||!Array.isArray(he)?[xt]:[xt,...he])}catch(he){console.error("Error in optimistic update:",he)}if(J&&at)try{const he=fe==="transfer",Pe={...at};he?(Pe.dailyTransferUsed=(Pe.dailyTransferUsed||0)+u,Pe.monthlyTransferUsed=(Pe.monthlyTransferUsed||0)+u):(Pe.dailyWithdrawUsed=(Pe.dailyWithdrawUsed||0)+u,Pe.monthlyWithdrawUsed=(Pe.monthlyWithdrawUsed||0)+u),Rr(Pe)}catch(he){console.error("Error in optimistic limit update:",he)}const Ct=[xt,...Ge];Ye.startTransition(()=>{hs(xe),vs(qe),aa(Ct)});try{setTimeout(()=>{try{localStorage.setItem(zl(),JSON.stringify(Ct))}catch{}},0)}catch{}if(It)try{const he=new Date,Pe=he.getFullYear(),ot=String(he.getMonth()+1).padStart(2,"0"),Ht=String(he.getDate()).padStart(2,"0"),Ts=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${Pe}-${ot}-${Ht}`,Vs=localStorage.getItem(Ts),na=Vs&&parseInt(Vs,10)||0;localStorage.setItem(Ts,String(na+1))}catch{}setTimeout(()=>{try{const he=new Date().toISOString();localStorage.setItem(Yt(),xe.toString()),localStorage.setItem(Yt()+"_lastUpdated",he),localStorage.setItem(ts(),JSON.stringify(qe)),localStorage.setItem(ts()+"_lastUpdated",he)}catch{}},0);try{if(s!=null&&s.uid){const he=Ve.find(Vr=>Vr.id===J)??Ve.find(Vr=>Vr.isDefault)??Ve[0],Pe=(he==null?void 0:he.id)||J,ot=Number(qe[Pe]||0),Ht=String((he==null?void 0:he.phone)||Lt||"").trim(),Ts=String(Rt||"").trim(),Vs=Number(_)>0,na=fe==="transfer"?"🟢":"🔴",Zt=Number(z)>0?`${Number(z)} جنيه`:"0 جنيه",$s=Vs?` و رسوم ${Number(_)} جنيه`:"",Js=fe==="transfer"?`${na} تم تحويل مبلغ ${Number(u)} جنيه من رقم المحفظة ${Ht} إلى رقم المحفظة ${Ts} وتم أخذ عمولة ${Zt}${$s}. الرصيد المتبقي في المحفظة: ${ot} جنيه. الفلوس النقدية المتبقية: ${Number(xe)} جنيه.`:`${na} تم السحب مبلغ ${Number(u)} جنيه من الدرج إلى رقم المحفظة ${Ht} وتم أخذ عمولة ${Zt}${$s}. الرصيد المتبقي في المحفظة: ${ot} جنيه. الفلوس النقدية المتبقية: ${Number(xe)} جنيه.`,zr=s!=null&&s.uid?`tg_last_msg_${s.uid}`:"tg_last_msg",pt=Date.now();let Bs=!0;try{const Vr=localStorage.getItem(zr);if(Vr){const Jr=JSON.parse(Vr),mu=String((Jr==null?void 0:Jr.text)||""),hu=Number((Jr==null?void 0:Jr.at)||0);mu===Js&&pt-hu<5e3&&(Bs=!1)}}catch{}if(Bs){Promise.resolve(sr.send(s.uid,Js)).catch(()=>{});try{localStorage.setItem(zr,JSON.stringify({text:Js,at:pt}))}catch{}}}}catch{}if((async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const he={...Cs},Pe={...xt},{ProfitService:ot}=await yt(async()=>{const{ProfitService:Zt}=await import("./profitService-Bwg-yNfl.js");return{ProfitService:Zt}},__vite__mapDeps([3,0,1]),import.meta.url),Ht=ot.calculateProfitFromTransaction({...Pe,status:"confirmed"});Ht>0&&(ot.addProfit(Ht,s==null?void 0:s.uid),he.profitAddedOnCreation=!0,Pe.profitAddedOnCreation=!0,console.log("✅ تم إضافة الربح:",Ht,"جنيه"));const Ts=await Ui.create(he);if(J)try{const Zt=await Ta.updateUsage(J,u,fe==="transfer"?"transfer":"withdraw");Zt&&Rr(Zt);try{window.dispatchEvent(new CustomEvent("walletLimitsUpdated",{detail:{walletId:J}}))}catch{}}catch{}await Promise.all([...s!=null&&s.uid?[Ce.updateUserData(s.uid,{cashBalance:xe,walletBalances:qe,lastUpdated:new Date().toISOString()})]:[],...s!=null&&s.uid?[Ce.saveUserTransaction(s.uid,{...Pe,transactionId:Ts,transactionType:fe,fromWallet:J,toWallet:fe==="transfer"?p?null:"cash":null,cashierName:y&&((N==null?void 0:N.name)||(N==null?void 0:N.username))||"الحساب الرئيسي",linkedDebtId:C||void 0,description:`${fe==="transfer"?"تحويل":"سحب"} ${u} من ${J} ${fe==="transfer"?p?"":"إلى الدرج النقدي":""} — عمولة: ${m} (${fe==="transfer"||Pt?"مضافة":"مخصومة"})${_>0?` — رسوم: ${_}`:""}${w?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");try{const Zt={...xt,id:Ts};Wa.current=Wa.current.map($s=>$s.id===qt?Zt:$s),L.setQueryData(["recentTransactions",s==null?void 0:s.uid,O||"main"],$s=>!$s||!Array.isArray($s)?[Zt]:$s.map(Js=>Js.id===qt?Zt:Js)),Ye.startTransition(()=>{aa($s=>$s.map(Js=>Js.id===qt?Zt:Js))})}catch(Zt){console.error("Error updating query cache with real ID:",Zt)}setTimeout(()=>{try{console.log("🔄 تنفيذ التحديث المؤجل (10 ثواني) لضمان تطابق البيانات..."),L.invalidateQueries({queryKey:["recentTransactions",s==null?void 0:s.uid,O||"main"]}),L.invalidateQueries({queryKey:["dashboardData",O||(v==null?void 0:v.shopId)]}),J&&(L.invalidateQueries({queryKey:["walletLimits",J]}),to())}catch(Zt){console.error("Error in delayed refresh:",Zt)}},1e4);const Vs=`userData_${s==null?void 0:s.uid}`,na={cashBalance:xe,walletBalances:qe,lastUpdated:new Date().toISOString()};localStorage.setItem(Vs,JSON.stringify(na))}catch(he){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",he);try{s!=null&&s.uid&&Ce.saveLocalReceipt(s.uid,{...transactionDataForUser,transactionType:fe,fromWallet:J,toWallet:fe==="transfer"?p?null:"cash":null,cashierName:y&&((N==null?void 0:N.name)||(N==null?void 0:N.username))||"الحساب الرئيسي",linkedDebtId:C||void 0,description:`${fe==="transfer"?"تحويل":"سحب"} ${u} من ${J} ${fe==="transfer"?p?"":"إلى الدرج النقدي":""} — عمولة: ${m} (${fe==="transfer"||Pt?"مضافة":"مخصومة"})${_>0?` — رسوم: ${_}`:""}${w?" — دين مؤجل (قيد المراجعة)":""}`})}catch{}i({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),fe==="transfer"){Mr(!0);const he=Number(r)+Number(m)+Math.max(0,Number(_));il({type:"transfer",amount:Math.max(0,Math.round(he*100)/100)}),Wm({receiver:Rt,amount:r}),Nt(null),fr(!0),setTimeout(()=>{Mr(!1)},2e3)}else{yn(!0);const he=Pt?Number(r):Math.max(0,Math.round((Number(r)-Number(m))*100)/100);il({type:"withdraw",amount:Math.max(0,Math.round(he*100)/100)}),fr(!0),setTimeout(()=>{yn(!1)},2e3)}Ys(""),ds(""),dn(""),pr(""),Ji(null),hn(""),$a(""),Io(""),Co(!1)},Oi=Ye.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),Gc=Ye.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),au=Ye.useMemo(()=>{try{return wt.reduce((t,a)=>{if(a.type==="debtor")return t;const r=Number(a.paidAmount||0),l=Math.max(0,Number(a.amount||0)-r);return t+l},0)}catch{return 0}},[wt]),ao=Ye.useMemo(()=>zc().filter(a=>La==="all"?!0:La==="send"?a.type==="send":La==="receive"?a.type==="receive":La==="withdraw"?a.type==="withdraw":La!=="deleted"),[zc,La]),ru=()=>{if(al==="daily"){const t=Rs.resetReportsManually("daily",Ge,s==null?void 0:s.uid);pn(!1),i({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${t.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const t=Rs.resetReportsManually("monthly",Ge,s==null?void 0:s.uid);pn(!1),i({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${t.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},nu=()=>al==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",iu=()=>al==="daily"?"أدخل الرقم السري الرئيسي لتصفير جميع معاملات اليوم":"أدخل الرقم السري الرئيسي لتصفير جميع معاملات الشهر",lu=t=>{Oc(t),Ol(!0)},ou=t=>{const a=Wt,r=Number(t)-Number(a);hs(t);const l=new Date().toISOString();localStorage.setItem(Yt(),t.toString()),localStorage.setItem(Yt()+"_lastUpdated",l),vc(!1);const o={cashBalance:t,lastUpdated:l},h=`userData_${s==null?void 0:s.uid}`;try{localStorage.setItem(h,JSON.stringify(o))}catch{}const m=[];if(s!=null&&s.uid){m.push(Ce.updateUserData(s.uid,o).then(()=>{try{localStorage.removeItem(h)}catch{}}).catch(()=>{}));const u=`${r>0?"CASHADD":"CASHDEDUCT"}-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`,b=r>0?{txnType:"cash_addition",type:"cash_addition",amount:r,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:u,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(v==null?void 0:v.shopId)||void 0}:r<0?{amount:Math.abs(r),status:"completed",title:"ايصال خصم من الفلوس النقديه",merchantUserId:s.uid,createdBy:s.uid,shopId:(v==null?void 0:v.shopId)||void 0}:null;b&&m.push(Ce.saveUserTransaction(s.uid,b));const p=v==null?void 0:v.shopId;if(p){const g=$e(U,"dashboardData",p);m.push(Xt(g,{cashBalance:t}))}}Promise.allSettled(m).then(()=>{}).catch(()=>{}),i({title:r>0?"تم إضافة نقدية":r<0?"تم خصم نقدية":"تم تحديث الرصيد النقدي",description:r!==0?`التغيير: ${Math.abs(r)} جنيه، الرصيد الجديد: ${t} جنيه`:`تم تحديث الرصيد النقدي إلى ${t} جنيه`})},cu=async t=>{var m;if(!Zs){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const a={...lt,[Zs]:t};vs(a);const r=new Date().toISOString(),l={walletBalances:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;try{localStorage.setItem(o,JSON.stringify(l)),localStorage.setItem(ts(),JSON.stringify(a)),localStorage.setItem(ts()+"_lastUpdated",r),localStorage.setItem(`walletBalances_backup_${r}`,JSON.stringify(a))}catch{}try{s!=null&&s.uid&&await Ce.updateUserData(s.uid,l)}catch(u){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",u)}wc(!1);const h=((m=Ve.find(u=>u.id===Zs))==null?void 0:m.name)||"المحفظة";i({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${h} إلى ${t.toLocaleString()} جنيه`})},du=async t=>{var a;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",Zs),console.log("💵 المبلغ المضاف/المخصوم:",t),Zs){const r=lt[Zs]||0;console.log("💰 الرصيد الحالي:",r);const l=r+t;console.log("💰 الرصيد الجديد:",l);const o={...lt,[Zs]:l};console.log("📊 الأرصدة المحدثة:",o),vs(o);const h=new Date().toISOString(),m={walletBalances:o,lastUpdated:h},u=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(u,JSON.stringify(m)),localStorage.setItem(ts(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${h}`,JSON.stringify(o));try{if(s!=null&&s.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await Ce.updateUserData(s.uid,m),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(u),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(w){console.error("❌ فشل في حفظ البيانات في Firebase:",w),et(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(ts(),JSON.stringify(o));const b=((a=Ve.find(w=>w.id===Zs))==null?void 0:a.name)||"المحفظة",p=t>0?"إضافة":"خصم",g=Math.abs(t);i({title:`تم ${p} مبلغ ${p==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${p} ${g} جنيه ${p==="إضافة"?"إلى":"من"} رصيد ${b}. الرصيد الجديد: ${l.toLocaleString()} جنيه`})}catch(b){if(console.error("❌ فشل في حفظ البيانات في Firebase:",b),localStorage.setItem(ts(),JSON.stringify(o)),s!=null&&s.uid){const p=`userData_${s.uid}`,g={walletBalances:o,lastUpdated:new Date().toISOString()};localStorage.setItem(p,JSON.stringify(g)),et(!0)}i({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const l=Object.keys(localStorage).filter(o=>o.startsWith("walletBalances_backup_")).sort();l.length>5&&l.slice(0,l.length-5).forEach(h=>{localStorage.removeItem(h),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",h)})},5e3),Ol(!1),Oc("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:Ja,isUserActive:Qt,showActivationModal:nn}),Ja?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx(Eu,{})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"user-dashboard min-h-screen px-2 sm:px-4 py-2 sm:py-4 relative bg-gray-100 bg-[radial-gradient(140%_140%_at_10%_10%,#e5e7eb_0%,#d1d5db_45%,#9ca3af_100%)]",children:[e.jsx(Dp,{userId:s==null?void 0:s.uid}),e.jsxs("div",{className:"max-w-screen-2xl mx-auto grid grid-cols-1 xl:grid-cols-3 gap-4 xl:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!bn&&e.jsxs(bt,{className:"bg-gray-100 border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-200 relative overflow-hidden",children:[e.jsx(ns,{className:"pb-2 px-3 pt-3 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(js,{className:"text-xs font-bold text-gray-900 flex items-center gap-1.5",children:[e.jsx("div",{className:"p-1 rounded-md bg-gradient-to-br from-gray-100 to-gray-200",children:e.jsx(xd,{className:"h-3.5 w-3.5 text-gray-700"})}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>{Wo("monthly"),pn(!0)},className:"h-7 w-7 p-0 bg-transparent hover:bg-red-50 text-red-600 hover:text-red-700 rounded-full transition-colors duration-200",title:"تصفير معاملات الشهر",children:e.jsx(Ns,{className:"h-3 w-3"})}),e.jsx("div",{className:"p-1 bg-green-50 rounded-full border border-green-100",children:e.jsx(Ln,{className:"h-3 w-3 text-green-600"})})]})]})}),!bn&&e.jsxs(At,{className:"pt-0 px-2 pb-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-0 rounded-lg overflow-hidden border border-gray-200 divide-x divide-y divide-gray-200 bg-white",children:[e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-blue-600",children:"عدد المعاملات"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-blue-800 mt-0.5 sm:mt-0",children:En().totalTransactions})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-gray-600",children:"إجمالي المبالغ"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-gray-900 mt-0.5 sm:mt-0",children:En().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-red-600",children:"المسحوب"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-red-800 mt-0.5 sm:mt-0",children:En().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-green-600",children:"المرسل"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-green-800 mt-0.5 sm:mt-0",children:En().totalSent.toFixed(2)})]})]}),e.jsxs("div",{className:"mt-2 rounded-lg border border-gray-100 bg-white px-2 py-1.5 flex items-center justify-between",children:[e.jsx("span",{className:"text-[12px] font-bold text-yellow-600",children:"الأرباح"}),e.jsx(hp,{userId:s==null?void 0:s.uid,transactions:Ge})]})]}),Km&&e.jsx("div",{className:"absolute inset-0 z-20 backdrop-blur-sm bg-amber-50/60 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(x,{size:"sm",variant:"ghost",onClick:async()=>{if(It){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}li(!0)},className:"px-4 py-2 rounded-full bg-white border border-gray-100 text-gray-900 shadow-sm hover:bg-gray-50 hover:shadow-md transition-all duration-200 flex items-center gap-2 text-xs font-medium",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(Ss,{className:"h-3.5 w-3.5 text-gray-600"})]})})]}),e.jsx(ks,{open:Hm,onOpenChange:li,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(It){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),li(!1),Yo(!0);return}Yo(!1),li(!1)},userId:s==null?void 0:s.uid}),(se==null?void 0:se.planType)!==Xs.TAHWEELA&&e.jsxs(bt,{className:"bg-gray-50 border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-200 relative overflow-hidden",children:[e.jsx(ns,{className:"pb-2 px-3 pt-3 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(js,{className:"text-sm font-bold text-gray-900 flex items-center gap-2",children:[e.jsx("div",{className:"p-1 rounded-md bg-gradient-to-br from-gray-100 to-gray-200",children:e.jsx(xd,{className:"h-4 w-4 text-gray-700"})}),e.jsx("span",{className:"text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>{Wo("daily"),pn(!0)},className:"h-8 w-8 p-0 bg-transparent hover:bg-red-50 text-red-600 hover:text-red-700 rounded-full transition-colors duration-200",title:"تصفير معاملات اليوم",children:e.jsx(Ns,{className:"h-3.5 w-3.5"})}),e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>Ym(t=>!t),className:"h-8 w-8 p-0 bg-transparent hover:bg-gray-100 text-gray-600 hover:text-blue-600 rounded-full transition-colors duration-200",title:bn?"توسيع اليوم والشهر":"طي اليوم والشهر",children:bn?e.jsx(zn,{className:"h-3.5 w-3.5"}):e.jsx(kd,{className:"h-3.5 w-3.5"})}),e.jsx("div",{className:"p-2 bg-green-50 rounded-full border border-green-100",children:e.jsx(Ln,{className:"h-3.5 w-3.5 text-green-600"})})]})]})}),!bn&&e.jsxs(At,{className:"pt-0 px-2 pb-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-0 rounded-lg overflow-hidden border border-gray-200 divide-x divide-y divide-gray-200 bg-white",children:[e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-blue-600",children:"عدد المعاملات"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-blue-800 mt-0.5 sm:mt-0",children:On().totalTransactions})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-gray-600",children:"إجمالي المبالغ"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-gray-900 mt-0.5 sm:mt-0",children:On().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-red-600",children:"المسحوب"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-red-800 mt-0.5 sm:mt-0",children:On().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"px-2 py-1 flex flex-col sm:flex-row sm:items-center sm:justify-between hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-[12px] font-bold text-green-600",children:"المرسل"}),e.jsx("span",{className:"text-sm sm:text-lg font-bold text-green-800 mt-0.5 sm:mt-0",children:On().totalSent.toFixed(2)})]})]}),e.jsxs("div",{className:"mt-2 rounded-lg border border-gray-100 bg-white px-2 py-1.5 flex items-center justify-between",children:[e.jsx("span",{className:"text-[12px] font-bold text-yellow-600",children:"الأرباح"}),e.jsx(pp,{userId:s==null?void 0:s.uid,transactions:Ge})]})]}),eh&&e.jsx("div",{className:"absolute inset-0 z-20 backdrop-blur-sm bg-white/60 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(x,{size:"sm",variant:"ghost",onClick:()=>cl(!0),className:"px-4 py-2 rounded-full bg-white border border-gray-100 text-gray-900 shadow-sm hover:bg-gray-50 hover:shadow-md transition-all duration-200 flex items-center gap-2 text-xs font-medium",title:"عرض تقارير اليوم (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير اليوم"}),e.jsx(Ss,{className:"h-3.5 w-3.5 text-gray-600"})]})})]}),e.jsx(ks,{open:th,onOpenChange:cl,mode:"verify",title:"الرقم السري لفتح تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Go(!1),cl(!1)},userId:s==null?void 0:s.uid})]}),e.jsxs(bt,{className:"balance-bar bg-gray-200 border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(At,{className:"p-2 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"bg-white border border-gray-200 p-1 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 group/cash relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex flex-col relative z-10 w-full",children:[e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx(is,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsx("span",{className:"text-[11px] font-extrabold text-emerald-800",children:"الفلوس النقدية"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-green-600 hover:bg-green-50 transition-colors",onClick:()=>In(!0),children:e.jsx(Vt,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-emerald-600 hover:bg-emerald-50 transition-colors",onClick:()=>Mc(!0),title:"تفاصيل الفلوس النقدية",children:e.jsx(ud,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-red-600 hover:bg-red-50 transition-colors",onClick:()=>Ti(!0),children:e.jsx(Ns,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"mt-0.5",children:e.jsxs("span",{className:"text-[14px] sm:text-xl font-bold text-emerald-800 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm block w-fit",children:[Wt.toLocaleString("en-US")," جنيه"]})})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 p-1 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 group/wallet relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex flex-col relative z-10 w-full",children:[e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(ia,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsx("span",{className:"text-[11px] font-extrabold text-blue-800",children:"الأرصدة علي المحافظ"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-green-600 hover:bg-green-50 transition-colors",onClick:()=>Si(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(Vt,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-blue-600 hover:bg-blue-50 transition-colors",onClick:()=>sl(!0),title:"عرض المحافظ",children:e.jsx(ia,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-red-600 hover:bg-red-50 transition-colors",onClick:()=>{Ci(!0),Ai("")},title:"تصفير إجمالي المحفظة",children:e.jsx(Ns,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"mt-0.5",children:e.jsxs("span",{className:"text-[14px] sm:text-xl font-bold text-blue-800 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm block w-fit",children:[Object.values(lt).reduce((t,a)=>t+a,0).toLocaleString("en-US")," جنيه"]})})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-white border border-gray-200 p-1 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 group/selwallet relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex flex-col relative z-10 w-full",children:[e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(ia,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsx("span",{className:"text-[11px] font-extrabold text-indigo-800",children:"رصيد المحفظه"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-green-600 hover:bg-green-50 transition-colors",onClick:()=>{if(!J){i({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}lu(J)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(Vt,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 rounded-full text-red-600 hover:bg-red-50 transition-colors",onClick:()=>{if(!J){i({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}hi(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(Ns,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"mt-0.5",children:e.jsxs("span",{className:"text-[14px] sm:text-xl font-bold text-indigo-800 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm block w-fit",children:[(J&&lt[J]||0).toLocaleString("en-US")," جنيه"]})})]})]})]})})]}),e.jsxs(bt,{className:"bg-gray-100 border border-gray-200 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsxs(ns,{className:`pb-2 px-4 pt-4 relative z-10 ${Y?"sticky top-0 z-20 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/60":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(js,{className:"text-sm font-bold flex items-center gap-2 text-gray-900",children:[!Y&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gray-100 rounded-lg",children:e.jsx(Ln,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-700"})}),e.jsx("span",{className:"text-gray-900",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!Y&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-100 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(Od,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx(q,{placeholder:"بحث...",value:Fo,onChange:t=>$m(t.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!Y&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"تقسيط"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{if(It||Ut){i({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"});return}ai(!0)},title:"إدارة التقسيط",children:e.jsx(Mu,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-green-600 mb-1",children:"شحن"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-green-100 text-green-600 hover:bg-green-200 border border-green-200 ring-3 ring-green-300 transition-all duration-200 hover:scale-105 active:bg-green-600 active:text-white active:border-green-600",onClick:()=>{i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."})},title:"شحن الرصيد",children:e.jsx(Jn,{className:"h-5 w-5 text-green-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>ll(!0),title:"آلة حاسبة",children:e.jsx(Md,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{It||Ut?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):ri(!0)},title:"كروت الائتمان",children:e.jsx(Jn,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"تقاريرك"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:()=>{if(It||Ut){i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"});return}Ac(!0)},title:"تقاريرك",children:e.jsx(gd,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-sky-600 mb-1",children:"تلجرام"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-sky-100 text-sky-600 hover:bg-sky-200 border border-sky-200 ring-3 ring-sky-300 transition-all duration-200 hover:scale-105 active:bg-sky-600 active:text-white active:border-sky-600",onClick:()=>{It||Ut?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Ls.hasMasterPin()?Xl(!0):Vc()},title:"إرسال تقرير يومي إلى تليجرام",children:e.jsx(Tx,{className:"h-5 w-5 text-sky-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:Mh,title:y&&(N!=null&&N.name||N!=null&&N.username)?`بروفيل الوردية: ${(N==null?void 0:N.name)||(N==null?void 0:N.username)}`:"وردية الكاشير",children:e.jsx(or,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{It||Ut?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):xn(!0)},title:"بيانات المبيعات",children:e.jsx(co,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),wt.filter(t=>t.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:wt.filter(t=>t.status==="pending").length})]}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{vl()},title:"الديون",children:e.jsx(fo,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-100 text-amber-700 hover:bg-amber-200 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105 active:bg-amber-600 active:text-white active:border-amber-600",onClick:()=>{It||Ut?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):ni(!0)},title:"الصيانة",children:e.jsx(yo,{className:"h-5 w-5 text-amber-700"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-100 text-violet-700 hover:bg-violet-200 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105 active:bg-violet-700 active:text-white active:border-violet-700",onClick:()=>{!Aa||Ut?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):ii(!0)},title:"يومية المكنة",children:e.jsx(Fd,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-100 text-orange-600 hover:bg-orange-200 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105 active:bg-orange-600 active:text-white active:border-orange-600",onClick:()=>{It||Ut?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Ls.hasMasterPin()?qs(!0):tt(!0)},title:"مصروفات المحل",children:e.jsx(fa,{className:"h-5 w-5 text-orange-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-rose-600 mb-1",children:"النواقص"}),e.jsx(x,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-rose-100 text-rose-600 hover:bg-rose-200 border border-rose-200 ring-3 ring-rose-300 transition-all duration-200 hover:scale-105 active:bg-rose-600 active:text-white active:border-rose-600",onClick:()=>{It||Ut?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):ur(!0)},title:"النواقص",children:e.jsx(nd,{className:"h-5 w-5 text-rose-600"})})]})]})]})]}),!Y&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"filters-bar flex items-center justify-center gap-3 bg-gray-100 rounded-md p-3 border border-gray-200",children:[e.jsx(x,{variant:"ghost",size:"sm",className:`btn-filter-send h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${La==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-100"}`,onClick:()=>el("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(x,{variant:"ghost",size:"sm",className:`btn-filter-withdraw h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${La==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-100"}`,onClick:()=>el("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(x,{variant:"ghost",size:"sm",className:`btn-filter-all h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${La==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-100"}`,onClick:()=>el("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(x,{variant:"ghost",size:"sm",className:"h-auto px-2 py-1 text-xs text-red-600 hover:bg-red-50 rounded-md font-medium",onClick:()=>Sn(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(Ns,{className:"h-3 w-3 mr-1"}),"تصفير"]}),Vh>0&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),e.jsx(ks,{open:Um,onOpenChange:ai,mode:"verify",title:"فتح إدارة التقسيط",description:"أدخل الرقم السري الرئيسي للوصول إلى إدارة التقسيط",onSuccess:()=>{ai(!1),Ko(!0)}}),e.jsx(Xu,{open:qm,onOpenChange:Ko}),e.jsx(ks,{open:Gh,onOpenChange:Xl,mode:"verify",title:"إرسال تقرير يومي إلى تليجرام",description:"أدخل الرقم السري الرئيسي لإرسال التقرير اليومي إلى تليجرام",onSuccess:()=>{Xl(!1),Vc()}}),Jo,e.jsxs(At,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:[ao.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Ln,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):Y?e.jsx("div",{className:"overflow-y-auto overscroll-contain scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[310px]",children:e.jsx("div",{className:"space-y-2 pr-2",children:ao.map(t=>e.jsxs("div",{className:"relative flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer",onClick:()=>Yc(t),children:[e.jsx("div",{className:`h-10 w-10 rounded-full flex items-center justify-center shrink-0 ${t.type==="withdraw"?"bg-red-100":"bg-green-100"}`,children:(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return r?e.jsx(fa,{className:"h-5 w-5 text-gray-600"}):l?e.jsx(Vt,{className:"h-5 w-5 text-green-600"}):t.type==="withdraw"?e.jsx(Qr,{className:"h-5 w-5 text-red-600"}):e.jsx(md,{className:"h-5 w-5 text-green-600"})})()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h4",{className:"text-base font-bold truncate",children:(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return r?e.jsx("span",{className:"text-foreground",children:"تسليم وردية"}):l?e.jsx("span",{className:"text-foreground",children:"إضافة نقدية"}):t.type==="send"?e.jsx("span",{className:"text-green-600",children:"تحويل أموال"}):e.jsx("span",{className:"text-red-600",children:"سحب نقدي"})})()}),e.jsxs("span",{className:`text-base font-bold whitespace-nowrap ${t.type==="withdraw"?"text-red-600":"text-green-600"}`,children:[t.type==="withdraw"||t.type==="cash_addition"||t.txnType==="cash_addition"?"+":"-"," ",rs(t.amount)," ج.م"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-0.5",children:[e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية"),o=(a==null?void 0:a.note)||(a==null?void 0:a.notes)||"";return r?`إلى: ${t.receiverPhone}`:l?o||"إضافة يدوية":t.type==="send"?e.jsx("span",{dir:"ltr",children:t.receiverPhone}):e.jsx("span",{dir:"ltr",children:t.senderPhone})})()}),e.jsxs("p",{className:"text-sm font-medium text-gray-500 mt-0.5",children:[Oi.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",Gc.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]}),e.jsxs("div",{className:`px-2 py-0.5 rounded-full text-[10px] font-medium flex items-center gap-1 ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700":"bg-green-100 text-green-700":t.status==="pending"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:[t.status==="completed"&&e.jsx(Un,{className:"h-3 w-3"}),t.status==="pending"&&e.jsx(qa,{className:"h-3 w-3"}),t.status==="failed"&&e.jsx(Kn,{className:"h-3 w-3"}),e.jsx("span",{children:t.status==="completed"?"ناجحة":t.status==="pending"?"معالجة":"فشلت"})]})]})]})]},t.id))})}):e.jsx("div",{className:"overflow-y-auto overscroll-contain scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[calc(100dvh-300px)]",children:e.jsx("div",{className:"space-y-2 pr-2",children:ao.map(t=>e.jsxs("div",{className:"relative flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer",onClick:()=>Yc(t),children:[e.jsx("div",{className:`h-10 w-10 rounded-full flex items-center justify-center shrink-0 ${t.type==="withdraw"?"bg-red-100":"bg-green-100"}`,children:(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return r?e.jsx(fa,{className:"h-5 w-5 text-gray-600"}):l?e.jsx(Vt,{className:"h-5 w-5 text-green-600"}):t.type==="withdraw"?e.jsx(Qr,{className:"h-5 w-5 text-red-600"}):e.jsx(md,{className:"h-5 w-5 text-green-600"})})()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h4",{className:"text-base font-bold truncate",children:(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية");return r?e.jsx("span",{className:"text-foreground",children:"تسليم وردية"}):l?e.jsx("span",{className:"text-foreground",children:"إضافة نقدية"}):t.type==="send"?e.jsx("span",{className:"text-green-600",children:"تحويل أموال"}):e.jsx("span",{className:"text-red-600",children:"سحب نقدي"})})()}),e.jsxs("span",{className:`text-base font-bold whitespace-nowrap ${t.type==="withdraw"?"text-red-600":"text-green-600"}`,children:[t.type==="withdraw"||t.type==="cash_addition"||t.txnType==="cash_addition"?"+":"-"," ",rs(t.amount)," ج.م"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-0.5",children:[e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:(()=>{const a=t,r=(a==null?void 0:a.type)==="report"||String((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية"),l=String((a==null?void 0:a.type)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.type)||"").toLowerCase()==="add"||String((a==null?void 0:a.txnType)||"").toLowerCase()==="cash_addition"||String((a==null?void 0:a.title)||"").includes("إيصال إضافة نقدية"),o=(a==null?void 0:a.note)||(a==null?void 0:a.notes)||"";return r?`إلى: ${t.receiverPhone}`:l?o||"إضافة يدوية":t.type==="send"?e.jsx("span",{dir:"ltr",children:t.receiverPhone}):e.jsx("span",{dir:"ltr",children:t.senderPhone})})()}),e.jsxs("p",{className:"text-sm font-medium text-gray-500 mt-0.5",children:[Oi.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",Gc.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]}),e.jsxs("div",{className:`px-2 py-0.5 rounded-full text-[10px] font-medium flex items-center gap-1 ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700":"bg-green-100 text-green-700":t.status==="pending"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:[t.status==="completed"&&e.jsx(Un,{className:"h-3 w-3"}),t.status==="pending"&&e.jsx(qa,{className:"h-3 w-3"}),t.status==="failed"&&e.jsx(Kn,{className:"h-3 w-3"}),e.jsx("span",{children:t.status==="completed"?"ناجحة":t.status==="pending"?"معالجة":"فشلت"})]})]})]})]},t.id))})}),Y&&e.jsxs("div",{className:"mt-2 flex justify-end",children:[e.jsxs(x,{variant:"ghost",size:"sm",className:"h-7 px-2 text-[11px] rounded-full border bg-red-100 text-red-700 border-red-300 hover:bg-red-200",onClick:()=>Sn(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(Ns,{className:"h-3 w-3 mr-1"}),"تصفير"]}),(s==null?void 0:s.uid)&&localStorage.getItem(`recentTransactionsResetAt:${s.uid}`)&&e.jsx("span",{className:"inline-block h-1.5 w-1.5 rounded-full bg-red-500 ml-1 align-middle"})]})]})]})]}),e.jsx(ex,{isOpen:Cm,onClose:()=>ei(!1),transaction:Am,onPrint:()=>window.print(),onDelete:Em,onComplete:Mm}),e.jsx(be,{open:Ne,onOpenChange:de,children:e.jsxs(ve,{className:"sm:max-w-md",children:[e.jsx(De,{children:e.jsx(we,{children:"معلومات المطور"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"flex flex-col items-center gap-4 bg-gradient-to-br from-indigo-50 to-blue-50 p-6 rounded-xl border border-blue-100 text-center",children:[e.jsx("div",{className:"h-16 w-16 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 shadow-sm",children:e.jsx(hx,{className:"h-8 w-8"})}),e.jsxs("div",{className:"space-y-3 w-full",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"معلومات التطوير"}),e.jsx("p",{className:"text-lg font-bold bg-gradient-to-r from-blue-700 to-indigo-700 bg-clip-text text-transparent leading-relaxed",children:"تم تطوير الابلكيشن بالكامل بواسطة م/أحمد عبد الرحيم محمد"}),e.jsxs("div",{className:"flex flex-col items-center gap-1 mt-4",children:[e.jsx("p",{className:"text-base font-semibold text-gray-800",children:"رقم خدمة العملاء الوحيد لنا"}),e.jsx("a",{href:"tel:01000392539",className:"text-2xl font-black text-blue-600 tracking-wider hover:underline",dir:"ltr",children:"01000392539"})]}),e.jsx("p",{className:"text-sm text-red-600 font-bold bg-red-50 py-1 px-3 rounded-full inline-block mt-2",children:"ليس لنا اي ارقام اخري"})]})]}),e.jsx("div",{className:"text-center text-xs text-gray-400 mt-2",children:gs?`v${gs}`:"v1.0.0"})]}),e.jsx(it,{children:e.jsx(x,{onClick:()=>de(!1),children:"إغلاق"})})]})}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full",children:[e.jsxs(bt,{id:"transaction-section",className:"bg-gray-100 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx(ns,{className:"sticky top-0 z-20 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(js,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Zr,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("div",{className:"top-icons-bar hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:[e.jsx(Vx,{}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"VIP",onClick:()=>ol(!0),children:e.jsx(px,{className:"h-5 w-5 text-yellow-500"})}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"إدارة الفروع",onClick:()=>(ie==null?void 0:ie.status)==="active"?Le(!0):ze(!0),children:e.jsx(Rn,{className:"h-5 w-5"})}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"معلومات المطور",onClick:()=>de(!0),children:e.jsx(yo,{className:"h-5 w-5 text-gray-600"})}),e.jsx(Zu,{})]})}),Qh&&e.jsxs(x,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:Bc,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx(Li,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsx(be,{open:Xm,onOpenChange:ol,children:e.jsxs(ve,{className:"sm:max-w-md",children:[e.jsx(De,{children:e.jsx(we,{children:"أفضل 10 عملاء هذا الشهر"})}),e.jsx("div",{className:"space-y-2",children:Ii.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا توجد بيانات لهذا الشهر"}):Ii.map((t,a)=>e.jsxs("div",{className:`flex items-center justify-between border rounded-md px-3 py-2 bg-white ${a===0?"bg-yellow-50 border-yellow-300":""}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Bt,{variant:"outline",className:`min-w-[28px] justify-center ${a===0?"border-yellow-300 text-yellow-700 bg-yellow-50":""}`,children:a+1}),e.jsx("span",{className:`font-semibold ${a===0?"text-yellow-700":""}`,children:t.phone})]}),e.jsxs("div",{className:"text-sm text-gray-700 flex items-center gap-3",children:[e.jsxs("span",{children:["عدد: ",t.count]}),e.jsxs("span",{children:["إجمالي: ",t.total]}),e.jsx(x,{variant:"outline",size:"sm",className:"h-8",onClick:()=>Kh(t),title:"إرسال واتساب",children:e.jsx(no,{className:"h-4 w-4"})})]})]},t.phone+a))}),e.jsx(it,{children:e.jsx(x,{onClick:()=>ol(!1),children:"إغلاق"})})]})}),e.jsx(be,{open:Qm,onOpenChange:Ho,children:e.jsxs(ve,{className:"sm:max-w-md",children:[e.jsx(De,{children:e.jsx(we,{children:"ربط بوت التلجرام"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(G,{children:"Telegram Chat ID"}),e.jsx(q,{value:oi,onChange:t=>Gm(t.target.value),placeholder:"اكتب رقم المحادثة"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(G,{children:"إرسال يومي 12 صباحاً"}),e.jsx(ax,{checked:Qo,onCheckedChange:t=>Zm(!!t)})]})]}),e.jsxs(it,{children:[e.jsx(x,{variant:"outline",onClick:()=>Ho(!1),children:"إغلاق"}),e.jsx(x,{onClick:async()=>{s!=null&&s.uid&&(await Ce.updateUserData(s.uid,{telegramChatId:oi,telegramDailyEnabled:Qo}),i({title:"تم الحفظ"}))},children:"حفظ"}),e.jsx(x,{onClick:async()=>{if(!(s!=null&&s.uid)||!oi){i({title:"أدخل Chat ID"});return}const t=await qc();try{const{sendTelegramMessage:a}=await yt(async()=>{const{sendTelegramMessage:r}=await Promise.resolve().then(()=>_x);return{sendTelegramMessage:r}},void 0,import.meta.url);await a({chatId:oi,text:t}),i({title:"تم الإرسال"})}catch{i({title:"تعذر الإرسال",description:"تحقق من ربط البوت",variant:"destructive"})}},children:"إرسال الآن"})]})]})}),e.jsx(be,{open:ae,onOpenChange:Le,children:e.jsxs(ve,{className:"sm:max-w-2xl bg-gray-50/80 backdrop-blur-sm",children:[e.jsx(De,{className:"border-b pb-4 mb-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-indigo-100 rounded-lg",children:e.jsx(Rn,{className:"w-6 h-6 text-indigo-600"})}),e.jsxs("div",{children:[e.jsx(we,{className:"text-xl font-bold text-gray-900",children:"إدارة الفروع"}),e.jsx(us,{className:"text-gray-500 mt-1",children:"أضف فروعاً جديدة وتابع أداء كل فرع بسهولة"})]})]}),e.jsx(x,{size:"icon",variant:Dt?"destructive":"default",className:`rounded-full transition-all duration-300 ${Dt?"bg-red-50 text-red-600 hover:bg-red-100 border border-red-200":"bg-indigo-600 hover:bg-indigo-700 text-white shadow-lg hover:shadow-indigo-200"}`,onClick:()=>dt(!Dt),title:Dt?"إلغاء الإضافة":"إضافة فرع جديد",children:Dt?e.jsx(ar,{className:"w-6 h-6"}):e.jsx(Vt,{className:"w-6 h-6"})})]})}),e.jsxs("div",{className:"space-y-6",children:[Dt&&e.jsxs("div",{className:"bg-white p-5 rounded-xl border shadow-sm space-y-4 animate-in slide-in-from-top-4 fade-in duration-300",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-indigo-700 font-semibold",children:[e.jsx(Vt,{className:"w-5 h-5"}),e.jsx("h3",{children:"إضافة فرع جديد"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{onClick:()=>checkSubscriptionStatus(!0).then(()=>i({title:"تم تحديث البيانات"})),variant:"ghost",size:"icon",title:"تحديث بيانات الاشتراك",children:e.jsx(Li,{className:"w-4 h-4 text-gray-500"})}),e.jsxs(x,{onClick:()=>ze(!0),variant:"outline",size:"sm",className:"gap-2",children:[e.jsx(vx,{className:"w-4 h-4"}),"طلب زيادة فرع"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{className:"text-gray-700",children:"اسم المدير"}),e.jsxs("div",{className:"relative",children:[e.jsx(or,{className:"absolute right-3 top-2.5 h-4 w-4 text-gray-400"}),e.jsx(q,{className:"pr-9",value:Et,onChange:t=>ee(t.target.value),placeholder:"مثال: أحمد محمد"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{className:"text-gray-700",children:"اسم الفرع"}),e.jsxs("div",{className:"relative",children:[e.jsx(Rn,{className:"absolute right-3 top-2.5 h-4 w-4 text-gray-400"}),e.jsx(q,{className:"pr-9",value:Ae,onChange:t=>st(t.target.value),placeholder:"مثال: فرع وسط البلد"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{className:"text-gray-700",children:"البريد الإلكتروني للدخول"}),e.jsxs("div",{className:"relative",children:[e.jsx(no,{className:"absolute right-3 top-2.5 h-4 w-4 text-gray-400"}),e.jsx(q,{className:"pr-9",value:St,onChange:t=>Tt(t.target.value),placeholder:"branch@example.com"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{className:"text-gray-700",children:"كلمة المرور"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute right-3 top-2.5 h-4 w-4 text-gray-400",children:"🔒"}),e.jsx(q,{type:"password",className:"pr-9",value:pe,onChange:t=>Me(t.target.value),placeholder:"••••••"})]})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 pt-2",children:[e.jsx(x,{variant:"ghost",onClick:()=>{ee(""),st(""),Tt(""),Me("")},className:"text-gray-500 hover:text-gray-700",children:"مسح الحقول"}),e.jsx(x,{className:"bg-indigo-600 hover:bg-indigo-700 text-white min-w-[120px]",disabled:Oe,onClick:async()=>{if(!(s!=null&&s.uid))return;const t=Et.trim(),a=Ae.trim(),r=St.trim(),l=pe.trim();if(!t||!a||!r||!l){i({title:"يرجى ملء جميع الحقول المطلوبة"});return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r)){i({title:"البريد الإلكتروني غير صالح",variant:"destructive"});return}if(l.length<6){i({title:"كلمة السر يجب أن تكون 6 أحرف على الأقل",variant:"destructive"});return}const h=(ie==null?void 0:ie.limit)||0;if(Ke.length>=h){i({title:"عفواً",description:`لقد وصلت للحد الأقصى من الفروع (${h} فروع)`,variant:"destructive"});return}try{rt(!0);let m="",u="";const b=`tempApp_${Date.now()}`,p=$u(Lu,b),g=Wu(p),w=Fu(p);try{m=(await Bu(g,r,l)).user.uid;try{await Ps($e(w,"users",m),{email:r,isActive:!0,isBranch:!0,ownerId:s.uid,createdAt:gt(),updatedAt:gt(),role:"branch",isActive:!1,subscription:{isActive:!1,planType:null,startDate:null,endDate:null}})}catch(R){console.error("Error creating branch user document:",R)}try{u=(await ka(ye(w,"shops"),{name:a,ownerId:m,managerName:t,createdAt:gt(),updatedAt:gt(),isActive:!0})).id}catch(R){console.error("Error creating shop as new user:",R);try{u=(await ka(ye(w,"users",m,"shops"),{name:a,ownerId:m,managerName:t,createdAt:gt(),updatedAt:gt(),isActive:!0})).id}catch(oe){throw console.error("Error creating shop in subcollection:",oe),R}}await Ru(g)}catch(A){console.error("Registration/Shop Creation Error:",A);let R="تعذر إنشاء المستخدم أو المتجر";A.code==="auth/email-already-in-use"&&(R="البريد الإلكتروني مستخدم بالفعل"),A.code==="auth/invalid-email"&&(R="البريد الإلكتروني غير صالح"),A.code==="auth/weak-password"&&(R="كلمة المرور ضعيفة"),A.code==="permission-denied"&&(R="ليس لديك صلاحية لإنشاء متجر لهذا المستخدم"),i({title:R,description:A.message,variant:"destructive"});try{await id(p)}catch{}return}finally{try{await id(p)}catch(A){console.warn("Error deleting temp app:",A)}}if(!m||!u)return;const C=A=>{try{return btoa(unescape(encodeURIComponent(A)))}catch{return btoa(A)}};try{const A={ownerId:s.uid,shopId:u,branchUserId:m,branchName:a,managerName:t,loginUsername:r,passwordEncoded:C(l),createdAt:gt()};await Ps($e(U,"users",s.uid,"branches",m),A);try{await ka(ye(U,"branches"),A)}catch(oe){console.warn("Branch ref creation error in root collection (non-fatal):",oe)}const R={id:m,branchUserId:m,branchName:a,managerName:t,source:"sub",...A};mt(oe=>[...oe,R])}catch(A){console.error("Branch ref creation error:",A),i({title:"خطأ في حفظ بيانات الفرع",description:"تم إنشاء المستخدم ولكن فشل حفظ البيانات",variant:"destructive"})}ee(""),st(""),Tt(""),Me(""),i({title:"تم إضافة الفرع وإنشاء المستخدم بنجاح"})}catch(m){console.error("General Error adding branch:",m),i({title:"تعذّر إضافة الفرع",description:m.message||"حدث خطأ غير متوقع"})}finally{rt(!1)}},children:Oe?"جارٍ الإضافة...":"إضافة فرع"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx("div",{className:"w-1.5 h-6 bg-indigo-500 rounded-full"}),"الفروع الحالية",e.jsxs(Bt,{variant:"secondary",className:"mr-auto",children:[Ke.length," / ",(ie==null?void 0:ie.limit)||0]})]}),Oe&&Ke.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-8 text-gray-500",children:[e.jsx(Li,{className:"w-8 h-8 animate-spin mb-2 text-indigo-400"}),e.jsx("p",{children:"جارٍ تحميل الفروع..."})]}):Ke.length===0?e.jsxs("div",{className:"text-center py-8 border-2 border-dashed rounded-xl bg-gray-50",children:[e.jsx(Rn,{className:"w-12 h-12 text-gray-300 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-500",children:"لا يوجد فروع مضافة حالياً"})]}):e.jsx("div",{className:"grid grid-cols-1 gap-3",children:Ke.map(t=>{var a;return e.jsx("div",{className:"group relative bg-white border rounded-xl p-4 shadow-sm hover:shadow-md transition-all duration-200",children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-lg",children:((a=t.branchName)==null?void 0:a.charAt(0))||"B"}),e.jsxs("div",{children:[e.jsx("h5",{className:"font-bold text-gray-900 text-lg",children:t.branchName}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(or,{className:"w-3 h-3"}),e.jsxs("span",{children:["المدير: ",t.managerName]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 w-full sm:w-auto mt-2 sm:mt-0",children:[e.jsxs(x,{className:"flex-1 sm:flex-none bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>os(t),children:[e.jsx(co,{className:"w-4 h-4 ml-2"}),"عرض البيانات"]}),e.jsx(x,{variant:"ghost",size:"icon",className:"text-blue-500 hover:text-blue-700 hover:bg-blue-50",title:"تعديل بيانات الفرع",onClick:()=>fs(t),children:e.jsx(Fi,{className:"w-4 h-4"})})]})]})},t.id)})})]})]})]})}),e.jsx(be,{open:Se,onOpenChange:Ze,children:e.jsxs(ve,{className:"sm:max-w-md",children:[e.jsxs(De,{children:[e.jsx(we,{children:"دخول الفرع"}),e.jsx(us,{children:"أدخل بيانات الدخول للفرع المحدد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(G,{children:"اسم المستخدم (البريد الإلكتروني)"}),e.jsx(q,{value:He,onChange:t=>Z(t.target.value),placeholder:"example@email.com"})]}),e.jsxs("div",{children:[e.jsx(G,{children:"كلمة السر"}),e.jsx(q,{type:"password",value:ht,onChange:t=>Jt(t.target.value),placeholder:"••••••"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{Z(""),Jt("")},children:"مسح"}),e.jsx(x,{className:"bg-blue-600 hover:bg-blue-700",disabled:Kt,onClick:async()=>{const t=We;if(!t){Ze(!1);return}const a=String(t.loginUsername||"");let r="";try{const h=String(t.passwordEncoded||"");r=h?decodeURIComponent(escape(atob(h))):""}catch{try{r=t.passwordEncoded?atob(String(t.passwordEncoded)):""}catch{r=""}}const l=He.trim(),o=ht.trim();if(!l||!o){i({title:"يرجى إدخال اسم المستخدم وكلمة السر"});return}if(l!==a||o!==r){i({title:"بيانات الدخول غير صحيحة",variant:"destructive"});return}try{B(!0);const h=s!=null&&s.uid?`selectedShopId_${s.uid}`:"selectedShopId";localStorage.setItem(h,String(t.shopId)),i({title:"تم الدخول إلى الفرع",description:String(t.branchName||"")}),Ze(!1),Le(!1),$("/user/dashboard")}catch{}B(!1)},children:"دخول"})]})]})]})}),e.jsx(be,{open:ge,onOpenChange:Fe,children:e.jsxs(ve,{className:"sm:max-w-2xl",children:[e.jsxs(De,{children:[e.jsxs(we,{children:["بيانات فرع ",_t==null?void 0:_t.branchName]}),e.jsxs(us,{children:["مدير الفرع: ",_t==null?void 0:_t.managerName]})]}),kt?e.jsx("div",{className:"py-8 flex justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):_t?e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 py-4",children:[e.jsxs("div",{className:"p-4 border rounded-xl bg-green-50",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-1",children:"مبيعات اليوم"}),e.jsxs("div",{className:"text-xl font-bold text-green-700",children:[rs(_t.todaySales)," ج.م"]})]}),e.jsxs("div",{className:"p-4 border rounded-xl bg-blue-50",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-1",children:"مبيعات الشهر"}),e.jsxs("div",{className:"text-xl font-bold text-blue-700",children:[rs(_t.monthSales)," ج.م"]})]}),e.jsxs("div",{className:"p-4 border rounded-xl bg-emerald-50",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-1",children:"ارباح اليوم"}),e.jsxs("div",{className:"text-xl font-bold text-emerald-700",children:[rs(_t.todayProfit)," ج.م"]})]}),e.jsxs("div",{className:"p-4 border rounded-xl bg-cyan-50",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-1",children:"ارباح الشهر"}),e.jsxs("div",{className:"text-xl font-bold text-cyan-700",children:[rs(_t.monthProfit)," ج.م"]})]}),e.jsxs("div",{className:"p-4 border rounded-xl bg-purple-50",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-1",children:"أرصدة المحافظ"}),e.jsxs("div",{className:"text-xl font-bold text-purple-700",children:[rs(_t.walletsTotal)," ج.م"]})]}),e.jsxs("div",{className:"p-4 border rounded-xl bg-yellow-50",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-1",children:"نقدية الدرج"}),e.jsxs("div",{className:"text-xl font-bold text-yellow-700",children:[rs(_t.cashBalance)," ج.م"]})]}),e.jsxs("div",{className:"p-4 border rounded-xl bg-indigo-50",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-1",children:"مبيعات قسم المبيعات"}),e.jsxs("div",{className:"text-xl font-bold text-indigo-700",children:[rs(_t.totalSalesSection)," ج.م"]})]}),e.jsxs("div",{className:"p-4 border rounded-xl bg-red-50",children:[e.jsx("div",{className:"text-sm text-gray-500 mb-1",children:"مجموع الديون"}),e.jsxs("div",{className:"text-xl font-bold text-red-700",children:[rs(_t.debtsTotal)," ج.م"]})]})]}):null,e.jsx(it,{children:e.jsx(x,{onClick:()=>Fe(!1),children:"إغلاق"})})]})}),e.jsx(be,{open:Va,onOpenChange:sa,children:e.jsxs(ve,{className:"sm:max-w-md",children:[e.jsxs(De,{children:[e.jsx(we,{children:"تعديل بيانات الفرع"}),e.jsx(us,{children:"تعديل اسم الفرع واسم المدير"})]}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{children:"البريد الإلكتروني (اسم المستخدم)"}),e.jsx(q,{value:ct,readOnly:!0,disabled:!0,placeholder:"لا يوجد بريد مسجل",className:"bg-gray-100 text-black opacity-100 font-medium"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{children:"اسم الفرع"}),e.jsx(q,{value:ne,onChange:t=>Ee(t.target.value),placeholder:"مثال: فرع القاهرة"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{children:"اسم المدير"}),e.jsx(q,{value:Xe,onChange:t=>Be(t.target.value),placeholder:"مثال: أحمد محمد"})]})]}),e.jsxs(it,{children:[e.jsx(x,{variant:"outline",onClick:()=>sa(!1),children:"إلغاء"}),e.jsx(x,{onClick:ls,disabled:ut,children:ut?"جارٍ الحفظ...":"حفظ التعديلات"})]})]})}),e.jsxs(At,{ref:f,className:"space-y-1 px-2 pb-2 relative z-10 transition-transform duration-200 ease-out will-change-transform",style:{transform:d?`translateY(${d}px)`:void 0},onFocusCapture:t=>{const a=t.target;if(!((a==null?void 0:a.id)==="transferExtraFeeInput")){j(0);return}const l=document.getElementById("transferSubmitButton");if(l){const o=l.getBoundingClientRect(),h=window.innerHeight;if(o.bottom>h){const m=o.bottom-h,u=Math.min(m,220);j(-u)}else j(0)}else j(0)},onBlurCapture:t=>{t.currentTarget.contains(t.relatedTarget)||j(0)},children:[e.jsxs("div",{className:"transaction-type-tabs flex w-full rounded-full border border-gray-300 overflow-hidden bg-surface fade-in-up",children:[e.jsxs("button",{type:"button",onClick:()=>_i("transfer"),className:`flex-1 h-10 text-sm font-medium transition-colors duration-200 flex items-center justify-center gap-2 ${fe==="transfer"?"bg-blue-100 text-blue-900":"bg-transparent text-gray-600 hover:bg-gray-50"}`,children:[fe==="transfer"&&e.jsx(Un,{className:"h-4 w-4"}),e.jsx(Ln,{className:"h-4 w-4"}),"تحويل"]}),e.jsx("div",{className:"w-[1px] bg-gray-300"}),e.jsxs("button",{type:"button",onClick:()=>_i("withdraw"),className:`flex-1 h-10 text-sm font-medium transition-colors duration-200 flex items-center justify-center gap-2 ${fe==="withdraw"?"bg-red-100 text-red-900":"bg-transparent text-gray-600 hover:bg-gray-50"}`,children:[fe==="withdraw"&&e.jsx(Un,{className:"h-4 w-4"}),e.jsx(Qr,{className:"h-4 w-4"}),"سحب"]})]}),e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(ia,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(x,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>$("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(Vt,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(x,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>{Qn(!0)},title:"المحافظ",children:[e.jsx(ia,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),Ve.length>0?e.jsxs(rr,{value:J,onValueChange:Xh,children:[e.jsx(nr,{"data-testid":"wallet-select",className:"w-full h-14 text-base bg-surface border border-gray-400 hover:border-gray-800 focus:border-primary rounded-xl transition-colors duration-200 flex items-center",children:e.jsx(ir,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-700"})}),e.jsxs(lr,{className:"rounded-xl border border-gray-200 shadow-md z-[9999] bg-white dark:bg-gray-900",children:[e.jsx("div",{"data-fixed-header":"true",className:"sticky top-0 z-10 bg-white dark:bg-gray-900 p-2 border-b border-gray-100 dark:border-gray-800",children:e.jsx(q,{value:Mo,onChange:t=>Sm(t.target.value),placeholder:"ابحث برقم المحفظة",className:"h-10 text-sm border-gray-300 rounded-lg"})}),e.jsx("div",{className:"p-1",children:$o.length===0?e.jsx("div",{className:"text-sm text-gray-500 p-3 text-center",children:"لا توجد نتائج مطابقة"}):$o.map(t=>e.jsx(pa,{value:t.id,className:"rounded-lg my-1 cursor-pointer hover:bg-gray-100 focus:bg-blue-50 transition-colors duration-200",children:e.jsxs("div",{className:"flex items-center gap-3 py-2 w-full",children:[e.jsx(ia,{className:"h-5 w-5 text-gray-500"}),e.jsxs("div",{className:"flex items-center gap-2 text-right",children:[e.jsx("span",{className:"text-base font-medium text-gray-900",children:t.name}),e.jsx("span",{className:"text-sm font-bold text-red-600",children:t.phone})]}),t.isDefault&&e.jsx("span",{className:"mr-auto text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full border border-gray-200",children:"افتراضي"})]})},t.id))})]})]}):e.jsx("div",{className:"rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 px-3 py-3 text-xs text-gray-600",children:"لا توجد محافظ حتى الآن. اضغط “إضافة محفظة” لإضافة أول محفظة."})]}),e.jsx(be,{open:hm,onOpenChange:Ao,children:e.jsxs(ve,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(De,{children:e.jsx(we,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(mx,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),e.jsx(ks,{open:um,onOpenChange:Qn,mode:"verify",title:"الرقم السري لفتح المحافظ",description:"أدخل الرقم السري الرئيسي لعرض وإدارة المحافظ",onSuccess:()=>{Qn(!1),Ao(!0)},userId:s==null?void 0:s.uid}),e.jsx(ks,{open:xm,onOpenChange:t=>{Ki(t),t||Yi(null)},mode:"verify",title:"تأكيد تغيير المحفظة",description:"أدخل الرقم السري الرئيسي لتغيير المحفظة المختارة",onSuccess:()=>{To&&(kn(To,"walletSelectionPin"),Yi(null)),Ki(!1)},userId:s==null?void 0:s.uid}),J&&Ve.length>0&&(()=>{var z;const t=Ve.find(xe=>xe.id===J),a=Ba,r=su(J),l=(at==null?void 0:at.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,o=(at==null?void 0:at.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,h=(at==null?void 0:at.monthlyWithdrawUsed)??a.totalWithdrawn??0,m=(at==null?void 0:at.monthlyTransferUsed)??a.totalTransferred??0,u=((z=se==null?void 0:se.subscription)==null?void 0:z.planType)===Xs.TAHWEELA,b=u?0:(at==null?void 0:at.dailyWithdrawLimit)??1e5,p=u?0:(at==null?void 0:at.dailyTransferLimit)??6e4,g=u?0:(at==null?void 0:at.dailyWithdrawUsed)??r.totalWithdrawn??0,w=u?0:(at==null?void 0:at.dailyTransferUsed)??r.totalTransferred??0,C=parseFloat(Gt||"0")||0,A=h+(fe==="withdraw"?C:0),R=m+(fe==="transfer"?C:0),oe=g+(fe==="withdraw"?C:0),_=w+(fe==="transfer"?C:0);return t?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2 p-2 bg-gray-50 rounded-xl border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-gray-200 pb-1",children:[e.jsx("span",{className:"text-sm font-bold text-gray-800",children:"الحدود الشهرية"}),e.jsx("span",{className:"text-xs font-medium text-gray-500 bg-white px-2 py-0.5 rounded-full border border-gray-200",children:bh||(t==null?void 0:t.name)})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-1 font-medium",children:[e.jsx("span",{className:"text-gray-700",children:"سحب شهري"}),e.jsxs("span",{className:"text-gray-600 dir-ltr",children:[Math.max(l-A,0).toLocaleString("en-US",{maximumFractionDigits:0})," متبقي"]})]}),e.jsx("div",{className:"h-1.5 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner ring-1 ring-gray-200/50",children:e.jsx("div",{className:"h-full bg-gradient-to-l from-red-500 to-red-600 rounded-full transition-all duration-500 ease-out shadow-sm",style:{width:`${Math.min(A/Math.max(l,1)*100,100)}%`}})}),e.jsxs("div",{className:"flex justify-between mt-0.5",children:[e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["المستخدم: ",A.toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["الحد: ",l.toLocaleString("en-US",{maximumFractionDigits:0})]})]})]}),e.jsx("div",{className:"w-[1px] bg-gray-200 self-stretch"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-1 font-medium",children:[e.jsx("span",{className:"text-gray-700",children:"تحويل شهري"}),e.jsxs("span",{className:"text-gray-600 dir-ltr",children:[Math.max(o-R,0).toLocaleString("en-US",{maximumFractionDigits:0})," متبقي"]})]}),e.jsx("div",{className:"h-1.5 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner ring-1 ring-gray-200/50",children:e.jsx("div",{className:"h-full bg-gradient-to-l from-blue-500 to-blue-600 rounded-full transition-all duration-500 ease-out shadow-sm",style:{width:`${Math.min(R/Math.max(o,1)*100,100)}%`}})}),e.jsxs("div",{className:"flex justify-between mt-0.5",children:[e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["المستخدم: ",R.toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["الحد: ",o.toLocaleString("en-US",{maximumFractionDigits:0})]})]})]})]})]}),e.jsxs("div",{className:"space-y-1 pt-1.5 border-t border-gray-200",children:[e.jsx("div",{className:"flex items-center justify-between mb-0.5",children:e.jsx("span",{className:"text-sm font-bold text-gray-800",children:"الحدود اليومية"})}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-1 font-medium",children:[e.jsx("span",{className:"text-gray-700",children:"سحب يومي"}),e.jsxs("span",{className:"text-gray-600 dir-ltr",children:[Math.max(b-oe,0).toLocaleString("en-US",{maximumFractionDigits:0})," متبقي"]})]}),e.jsx("div",{className:"h-1.5 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner ring-1 ring-gray-200/50",children:e.jsx("div",{className:"h-full bg-gradient-to-l from-orange-400 to-orange-500 rounded-full transition-all duration-500 ease-out",style:{width:`${Math.min(oe/Math.max(b,1)*100,100)}%`}})}),e.jsxs("div",{className:"flex justify-between mt-0.5",children:[e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["المستخدم: ",oe.toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["الحد: ",b.toLocaleString("en-US",{maximumFractionDigits:0})]})]})]}),e.jsx("div",{className:"w-[1px] bg-gray-200 self-stretch"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-1 font-medium",children:[e.jsx("span",{className:"text-gray-700",children:"تحويل يومي"}),e.jsxs("span",{className:"text-gray-600 dir-ltr",children:[Math.max(p-_,0).toLocaleString("en-US",{maximumFractionDigits:0})," متبقي"]})]}),e.jsx("div",{className:"h-1.5 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner ring-1 ring-gray-200/50",children:e.jsx("div",{className:"h-full bg-gradient-to-l from-green-500 to-green-600 rounded-full transition-all duration-500 ease-out",style:{width:`${Math.min(_/Math.max(p,1)*100,100)}%`}})}),e.jsxs("div",{className:"flex justify-between mt-0.5",children:[e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["المستخدم: ",_.toLocaleString("en-US",{maximumFractionDigits:0})]}),e.jsxs("span",{className:"text-[10px] text-gray-900 font-medium",children:["الحد: ",p.toLocaleString("en-US",{maximumFractionDigits:0})]})]})]})]})]})]}):null})(),fe==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative group",children:[e.jsx(Pa,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-green-600 group-focus-within:text-green-700 transition-colors"}),e.jsx(q,{value:Lt,onChange:t=>bs(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("receiverPhoneInput");if(a)a.focus();else{const r=document.getElementById("amountInput");r==null||r.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-blue-600 focus:ring-1 focus:ring-blue-600 transition-all duration-200"})]})]}),!W&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative group",children:[e.jsx(Pa,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-green-600 group-focus-within:text-green-700 transition-colors"}),e.jsx(q,{id:"receiverPhoneInput",value:Rt,onChange:t=>{Ys(t.target.value),nl&&Mr(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("amountInput");a==null||a.focus()}},inputMode:"numeric",maxLength:11,placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-blue-600 focus:ring-1 focus:ring-blue-600 transition-all duration-200"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Pa,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(q,{value:J&&((Zc=Ve.find(t=>t.id===J))==null?void 0:Zc.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 text-sm lg:text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl transition-all duration-300"})]})]}),fe==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2 group",children:[e.jsx(is,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-yellow-600 group-focus-within:text-yellow-700 transition-colors"}),e.jsx(q,{id:"amountInput",value:Gt,onChange:t=>{ds(t.target.value),nl&&Mr(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("transferCommissionInput");if(a)a.focus();else{const r=document.getElementById("quickDebtButton");r==null||r.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-blue-600 focus:ring-1 focus:ring-blue-600 transition-all duration-200"})]}),xa?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",xa.debtorName," بمبلغ ",xa.amount," جنيه"]}),e.jsx(x,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>Ji(null),children:"إلغاء"})]}):null]}),(()=>{if(W)return null;const t=Is();return t&&t.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",t==null?void 0:t.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(x,{id:"quickDebtButton",type:"button",variant:"destructive",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-medium",onClick:()=>{const r=Is(),l=(r==null?void 0:r.defaultTransferCommission)!=null?Number(r.defaultTransferCommission):0,o=parseFloat(Gt||"0")||0,h=Math.round((l||0)*o/1e3*100)/100,m=o+h;$a((m||0).toString()),It?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ma(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",className:"hidden",title:Pt?"العمولة تُضاف":"العمولة تُخصم",children:Pt?e.jsx(Vt,{className:"h-4 w-4 text-green-600"}):e.jsx(ar,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:Pt?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1 group",children:[e.jsx(is,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-yellow-600 group-focus-within:text-yellow-700 transition-colors"}),e.jsx(q,{id:"transferCommissionInput",value:Es,onChange:r=>Qi(r.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-all duration-200"})]}),e.jsx(x,{type:"button",variant:"destructive",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-medium",onClick:()=>{const r=Is(),l=parseFloat(Gt||"0")||0;let o=0;if((r==null?void 0:r.defaultTransferCommission)!=null){const m=Number(r.defaultTransferCommission)||0;o=Math.round(m*l/1e3*100)/100}else{const m=Es&&Es.trim()!==""?parseFloat(Es):0;o=Math.max(0,m)}const h=l+o;$a((h||0).toString()),It?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ma(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",className:"hidden",title:Pt?"العمولة تُضاف":"العمولة تُخصم",children:Pt?e.jsx(Vt,{className:"h-4 w-4 text-green-600"}):e.jsx(ar,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:Pt?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),(()=>{const t=Gn(Lt||"").replace(/\D/g,""),a=Gn(Rt||"").replace(/\D/g,"");return fe==="transfer"&&(t.startsWith("010")&&a.startsWith("010")||t.startsWith("010")&&(a.startsWith("011")||a.startsWith("012")||a.startsWith("015"))||t.startsWith("012")&&a.startsWith("010")||t.startsWith("011")&&a.startsWith("010")||t.startsWith("015")&&a.startsWith("010"))?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رسوم التحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(is,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-yellow-600"}),e.jsx(q,{id:"transferExtraFeeInput",value:ko,onChange:l=>pm(l.target.value),placeholder:"أدخل رسوم التحويل",type:"number",className:"pl-10 h-10 text-sm lg:text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"hidden",children:"تُخصم من المحفظة وتضاف للدرج — لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010"})]}):null})(),e.jsxs("div",{className:"sticky bottom-0 z-20 pt-2 pb-2 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 backdrop-blur supports-[backdrop-filter]:bg-white/90 dark:supports-[backdrop-filter]:bg-gray-900/90",children:[e.jsx(x,{id:"transferSubmitButton",onClick:Qc,className:"w-full h-12 text-base font-medium rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-none hover:shadow-md transition-all duration-200",children:nl?"تم التحويل بنجاح":"تأكيد التحويل"}),gm&&e.jsxs("div",{className:"flex items-start gap-2 mt-2 px-1 animate-in fade-in slide-in-from-bottom-2",children:[e.jsx(nd,{className:"h-4 w-4 text-amber-500 shrink-0 mt-0.5"}),e.jsxs("p",{className:"text-xs text-gray-500 leading-tight",children:["تم الوصول إلى 85% من الحد الشهري للمحفظة ",Gi==null?void 0:Gi.walletName]})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative group",children:[e.jsx(Qr,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400 group-focus-within:text-primary transition-colors"}),e.jsx(q,{id:"amountInput",value:Gt,onChange:t=>{ds(t.target.value),qo&&yn(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("manualWithdrawCommissionInput");if(a)a.focus();else{const r=document.getElementById("withdrawSubmitButton");r==null||r.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white focus:border-primary focus:ring-1 focus:ring-primary transition-all duration-200"})]})]}),fm&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"اسم الراسل (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsx(or,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-500"}),e.jsx(q,{id:"withdrawSenderNameInput",value:_r,onChange:t=>pr(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("manualWithdrawCommissionInput");a==null||a.focus()}},placeholder:"أدخل اسم الراسل إن وجد",className:"pl-10 h-10 text-sm lg:text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white transition-all duration-300 hover:border-blue-400 focus:border-blue-500",type:"text"})]})]}),(()=>{const t=Is();return t&&t.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",t==null?void 0:t.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(x,{type:"button",variant:"destructive",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-medium",onClick:()=>{const r=Is(),l=parseFloat(Gt||"0")||0,o=(r==null?void 0:r.defaultWithdrawCommission)!=null&&Number(r.defaultWithdrawCommission)||0,h=Math.round(o*l/1e3*100)/100,m=Pt?l+h:l;$a((m||0).toString()),It?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ma(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>Xi(r=>!r),title:Pt?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:Pt?e.jsx(Vt,{className:"h-4 w-4"}):e.jsx(ar,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:Pt?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(is,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-yellow-600"}),e.jsx(q,{id:"manualWithdrawCommissionInput",value:Os,onChange:r=>Hi(r.target.value),onKeyDown:r=>{if(r.key==="Enter"){const l=document.getElementById("withdrawSubmitButton");l==null||l.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base bg-gray-50 border-gray-200 shadow-inner rounded-xl focus:bg-white transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(x,{type:"button",variant:"destructive",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-medium",onClick:()=>{const r=Is(),l=parseFloat(Gt||"0")||0;let o=0;if((r==null?void 0:r.defaultWithdrawCommission)!=null){const m=Number(r.defaultWithdrawCommission)||0;o=Math.round(m*l/1e3*100)/100}else{const m=Os&&Os.trim()!==""?parseFloat(Os):Math.round(l*.01*100)/100;o=Math.max(0,m)}const h=Pt?l+o:l;$a((h||0).toString()),It?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ma(!0)},children:"أجل"}),e.jsx(x,{type:"button",variant:"outline",size:"icon",title:Pt?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>Xi(r=>!r),children:Pt?e.jsx(Vt,{className:"h-4 w-4 text-green-600"}):e.jsx(ar,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:Pt?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),(v==null?void 0:v.showWithdrawNote)&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"ملاحظة السحب (اختياري)"}),e.jsxs("div",{className:"relative group",children:[e.jsx(no,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400 group-focus-within:text-primary transition-colors"}),e.jsx(q,{id:"withdrawNoteInput",value:Hs,onChange:t=>dn(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("withdrawSubmitButton");a==null||a.focus()}},placeholder:"أدخل ملاحظة للسحب (اختياري)",className:"pl-10 h-10 text-base border-gray-400 rounded-xl focus:border-primary focus:ring-1 focus:ring-primary transition-all duration-200"})]})]}),e.jsx("div",{className:"sticky bottom-0 z-20 pt-2 pb-2 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 backdrop-blur supports-[backdrop-filter]:bg-white/90 dark:supports-[backdrop-filter]:bg-gray-900/90",children:e.jsx(x,{id:"withdrawSubmitButton",onClick:Qc,className:"w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:qo?"تم السحب بنجاح":"تأكيد السحب"})})]}),e.jsx(be,{open:mn,onOpenChange:Ma,children:e.jsxs(ve,{children:[e.jsxs(De,{children:[e.jsx(we,{children:"تحويل مؤجل"}),e.jsx(us,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[Gs&&Gs.length>0?e.jsxs("div",{children:[e.jsx(G,{children:"اختيار عميل"}),e.jsxs(rr,{value:Vi,onValueChange:t=>{dm(t);const a=Gs.find(r=>r.id===t);a&&hn(a.name)},children:[e.jsx(nr,{className:"w-full",children:e.jsx(ir,{placeholder:"اختر عميل"})}),e.jsx(lr,{children:Gs.map(t=>e.jsxs(pa,{value:t.id,children:[t.name,t.mobile?` — ${t.mobile}`:""]},t.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(G,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx(q,{id:"quickDebtName",value:Or,onChange:t=>hn(t.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(G,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx(q,{id:"quickDebtAmount",type:"number",value:gr,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(G,{htmlFor:"quickDebtCommission",children:"العمولة (محسوبة تلقائياً)"}),e.jsx(q,{id:"quickDebtCommission",type:"number",value:function(){const t=Is(),a=parseFloat((Gt||"0").toString())||0;let r=0;if(fe==="transfer")if((t==null?void 0:t.defaultTransferCommission)!=null){const l=Number(t.defaultTransferCommission)||0;r=Math.round(l*a/1e3*100)/100}else{const l=Es&&Es.trim()!==""?parseFloat(Es):0;r=Math.max(0,l)}else if((t==null?void 0:t.defaultWithdrawCommission)!=null){const l=Number(t.defaultWithdrawCommission)||0;r=Math.round(l*a/1e3*100)/100}else{const l=Os&&Os.trim()!==""?parseFloat(Os):Math.round(a*.01*100)/100;r=Math.max(0,l)}return String(r||0)}(),readOnly:!0,placeholder:"قيمة العمولة"})]}),e.jsxs("div",{children:[e.jsx(G,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx(q,{id:"quickDebtNotes",value:Do,onChange:t=>Io(t.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(it,{children:e.jsx(x,{type:"button",variant:"default",className:"bg-green-600 text-white hover:bg-green-700",onClick:()=>{const t=Is(),a=parseFloat((Gt||"").toString())||0;let r=0;if(fe==="transfer")if((t==null?void 0:t.defaultTransferCommission)!=null){const h=Number(t.defaultTransferCommission)||0;r=Math.round(h*a/1e3*100)/100}else{const h=Es&&Es.trim()!==""?parseFloat(Es):0;r=Math.max(0,h)}else if((t==null?void 0:t.defaultWithdrawCommission)!=null){const h=Number(t.defaultWithdrawCommission)||0;r=Math.round(h*a/1e3*100)/100}else{const h=Os&&Os.trim()!==""?parseFloat(Os):Math.round(a*.01*100)/100;r=Math.max(0,h)}let l=0;if(fe==="withdraw"?l=Pt?a:Math.max(0,Math.round((a-r)*100)/100):l=Math.max(0,Math.round((a+r)*100)/100),!Or||isNaN(l)||l<=0){i({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const o=Gs.find(h=>h.id===Vi);Ji({debtorName:Or,amount:l,notes:Do,customerId:Vi||void 0,mobile:o==null?void 0:o.mobile}),Co(!1),Ma(!1),i({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx(bt,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(At,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(Lx,{isOpen:vm,onClose:()=>wm(!1),initialEditingWallet:jm,onWalletUpdate:async()=>{try{await so()}catch(t){console.error("Error reloading wallets after update:",t)}}}),e.jsx(Wx,{isOpen:Im,onClose:()=>Lo(!1),transaction:Dm,onDelete:eu}),e.jsx(ks,{open:Pm,onOpenChange:pn,onSuccess:ru,title:nu(),description:iu(),mode:"verify"}),e.jsx(fd,{open:Nh,onOpenChange:vc,onSuccess:ou,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:Wt,balanceLabel:"الرصيد النقدي",userId:s==null?void 0:s.uid}),e.jsx(fd,{open:jh,onOpenChange:wc,onSuccess:cu,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:Zs&&lt[Zs]||0,balanceLabel:`رصيد ${((Xc=Ve.find(t=>t.id===Zs))==null?void 0:Xc.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(Ux,{open:Sh,onOpenChange:Ol,onSuccess:du,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:Zs&&lt[Zs]||0,balanceLabel:`رصيد ${((ed=Ve.find(t=>t.id===Zs))==null?void 0:ed.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(Fx,{open:$h,onOpenChange:Lh,userId:s==null?void 0:s.uid}),e.jsx(Bx,{open:Wh,onOpenChange:Fh,userId:s==null?void 0:s.uid}),e.jsx(Rx,{open:Bh,onOpenChange:Rh}),e.jsx(be,{open:Ch,onOpenChange:ui,children:e.jsxs(ve,{className:"sm:max-w-md",children:[e.jsx(De,{children:e.jsx(we,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(G,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(q,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:Ml,onChange:t=>xi(t.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(x,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:async()=>{if(!await ki(Kl)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(Ml);if(isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Wt+t;hs(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?Ce.updateUserData(s.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),et(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),et(!0)}):et(!0),i({title:"تم بنجاح",description:`تم إضافة ${t} جنيه إلى الدرج النقدية وحفظه في السحابة`}),ui(!1),xi(""),bi("")},children:[e.jsx(Vt,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(x,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:async()=>{if(!await ki(Kl)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(Ml);if(isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Wt-t;hs(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?Ce.updateUserData(s.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),et(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),et(!0)}):et(!0),i({title:"تم بنجاح",description:`تم خصم ${t} جنيه من الدرج النقدية وحفظه في السحابة`}),ui(!1),xi(""),bi("")},children:[e.jsx(ar,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",Wt.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(G,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx(q,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:Kl,onChange:t=>bi(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(it,{className:"flex gap-2",children:e.jsx(x,{variant:"outline",onClick:()=>{ui(!1),xi(""),bi("")},children:"إلغاء"})})]})}),e.jsx(be,{open:Yh,onOpenChange:Ci,children:e.jsxs(ve,{className:"sm:max-w-md",children:[e.jsx(De,{children:e.jsx(we,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(lt).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(G,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(q,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل الرقم السري الرئيسي",value:Jc,onChange:t=>Ai(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(it,{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{Ci(!1),Ai("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",onClick:async()=>{if(!await Ls.verifyMasterPin(Jc,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const a={};Object.keys(lt).forEach(h=>{a[h]=0}),vs(a),localStorage.setItem(ts(),JSON.stringify(a)),Ci(!1),Ai("");const r=new Date().toISOString(),l={walletBalances:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(o,JSON.stringify(l)),s!=null&&s.uid?Ce.updateUserData(s.uid,l).then(()=>{localStorage.removeItem(o),et(!1)}).catch(h=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",h),et(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):et(!0),setTimeout(()=>{vs({...a})},100)}catch(a){console.error("خطأ في تصفير أرصدة المحافظ:",a),i({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(be,{open:Dh,onOpenChange:hi,children:e.jsxs(ve,{className:"sm:max-w-md",children:[e.jsx(De,{children:e.jsx(we,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((td=Ve.find(t=>t.id===J))==null?void 0:td.name)||J]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(J&&lt[J]?lt[J]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(G,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(q,{id:"resetSelectedWalletPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:Nc,onChange:t=>El(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(it,{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{hi(!1),El("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",onClick:async()=>{var a;if(!J){i({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await Ls.verifyMasterPin(Nc,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const r={...lt};r[J]=0,vs(r),localStorage.setItem(ts(),JSON.stringify(r)),hi(!1),El("");const l=new Date().toISOString(),o={walletBalances:r,lastUpdated:l},h=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(h,JSON.stringify(o)),s!=null&&s.uid?Ce.updateUserData(s.uid,o).then(()=>{localStorage.removeItem(h),et(!1)}).catch(m=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",m),et(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):et(!0),i({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((a=Ve.find(m=>m.id===J))==null?void 0:a.name)||J}`})}catch(r){console.error("خطأ في تصفير رصيد المحفظة المختارة:",r),i({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(be,{open:zh,onOpenChange:Si,children:e.jsxs(ve,{className:"sm:max-w-md",children:[e.jsx(De,{children:e.jsxs(we,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(Vt,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(lt).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx(q,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:$c,onChange:t=>Hl(t.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx(q,{id:"addWalletTotalPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري",value:Lc,onChange:t=>Ql(t.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(it,{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{Si(!1),Hl(""),Ql("")},children:"إلغاء"}),e.jsx(x,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:Wc,onClick:async()=>{const t=parseFloat($c);if(!t||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!await Zh(Lc)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}Fc(!0);try{const a=Object.values(lt).reduce((r,l)=>r+l,0);if(a===0){const r=Object.keys(lt),l=t/r.length,o={};r.forEach(h=>{o[h]=l}),vs(o),localStorage.setItem(ts(),JSON.stringify(o)),s!=null&&s.uid?await Ce.updateUserData(s.uid,{walletBalances:o,lastUpdated:new Date().toISOString()}):et(!0)}else{const r={};Object.entries(lt).forEach(([l,o])=>{const h=o/a,m=t*h;r[l]=o+m}),vs(r),localStorage.setItem(ts(),JSON.stringify(r)),s!=null&&s.uid?await Ce.updateUserData(s.uid,{walletBalances:r,lastUpdated:new Date().toISOString()}):et(!0)}setTimeout(()=>{vs(r=>({...r}))},100),Si(!1),Hl(""),Ql("")}catch(a){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",a),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{Fc(!1)}},children:Wc?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(be,{open:Hh,onOpenChange:Ti,children:e.jsxs(ve,{className:"sm:max-w-[425px]",children:[e.jsx(De,{children:e.jsxs(we,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(Ns,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(G,{htmlFor:"resetCashPin",children:"الرقم السري الرئيسي"}),e.jsx(q,{id:"resetCashPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:Gl,onChange:t=>Zl(t.target.value)})]})]}),e.jsxs(it,{children:[e.jsx(x,{variant:"outline",onClick:()=>{Ti(!1),Zl("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",onClick:async()=>{if(!Gl){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await Ls.verifyMasterPin(Gl,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{hs(0),Ti(!1),Zl("");const a={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem(Yt(),"0"),localStorage.setItem(Yt()+"_lastUpdated",a.lastUpdated);const r=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(r,JSON.stringify(a)),s!=null&&s.uid?Ce.updateUserData(s.uid,a).then(()=>{localStorage.removeItem(r),et(!1)}).catch(l=>{console.error("خطأ في حفظ الرصيد في Firebase:",l),et(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):et(!0)}catch(a){console.error("خطأ في تصفير الرصيد النقدي:",a),i({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(Yx,{open:qh,onOpenChange:Mc,userId:s==null?void 0:s.uid,cashBalance:Wt,walletBalances:lt,transactions:Ge}),e.jsx(be,{open:Uh,onOpenChange:In,children:e.jsxs(ve,{className:"sm:max-w-[425px]",children:[e.jsx(De,{children:e.jsxs(we,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(Vt,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx(q,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:jr,onChange:t=>vi(t.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{className:"text-right",children:"هل تريد إضافة ملاحظة؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{type:"button",variant:An==="yes"?"default":"outline",onClick:()=>Tn("yes"),className:"flex-1",children:"نعم"}),e.jsx(x,{type:"button",variant:An==="no"?"default":"outline",onClick:async()=>{if(Tn("no"),!jr||parseFloat(jr)<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!Cn){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await ki(Cn)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}Ni(!0);try{const t=parseFloat(jr),a=Wt+t;hs(a);const r=new Date().toISOString();localStorage.setItem(Yt(),a.toString()),localStorage.setItem(Yt()+"_lastUpdated",r);const l={cashBalance:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(o,JSON.stringify(l));const h=`CASHADD-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`;In(!1),vi(""),wi(""),Tn(null),ji("");const m=[];if(s!=null&&s.uid){m.push(Ce.updateUserData(s.uid,l).then(()=>{localStorage.removeItem(o),et(!1)}).catch(()=>{et(!0)}));const u={txnType:"cash_addition",type:"cash_addition",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:h,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(v==null?void 0:v.shopId)||void 0};m.push(Ce.saveUserTransaction(s.uid,u));const b=v==null?void 0:v.shopId;if(b){const p=$e(U,"dashboardData",b);m.push(Xt(p,{cashBalance:a}))}}Promise.allSettled(m).then(()=>{}).catch(()=>{})}catch{hs(Wt),localStorage.setItem("cashBalance",Wt.toString()),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{Ni(!1)}},className:"flex-1",children:"لا"})]})]}),An==="yes"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"addCashNote",children:"الملاحظة"}),e.jsx(q,{id:"addCashNote",type:"text",placeholder:"اكتب الملاحظة",value:Yl,onChange:t=>ji(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx(q,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:Cn,onChange:t=>wi(t.target.value)})]})]}),e.jsxs(it,{children:[e.jsx(x,{variant:"outline",onClick:()=>{In(!1),vi(""),wi(""),Tn(null),ji("")},children:"إلغاء"}),e.jsx(x,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:Ec,onClick:async()=>{if(!jr||parseFloat(jr)<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!Cn){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await ki(Cn)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}if(An==="yes"&&Yl.trim().length===0){i({title:"تنبيه",description:"أدخل الملاحظة أو اختر لا",variant:"destructive"});return}Ni(!0);try{const t=parseFloat(jr),a=Wt+t;hs(a);const r=new Date().toISOString();localStorage.setItem(Yt(),a.toString()),localStorage.setItem(Yt()+"_lastUpdated",r);const l={cashBalance:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(o,JSON.stringify(l));const h=`CASHADD-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`;In(!1),vi(""),wi(""),Tn(null),ji("");const m=[];if(s!=null&&s.uid){m.push(Ce.updateUserData(s.uid,l).then(()=>{localStorage.removeItem(o),et(!1)}).catch(()=>{et(!0)}));const u={txnType:"cash_addition",type:"cash_addition",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:h,note:An==="yes"?Yl.trim():void 0,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(v==null?void 0:v.shopId)||void 0};m.push(Ce.saveUserTransaction(s.uid,u));const b=v==null?void 0:v.shopId;if(b){const p=$e(U,"dashboardData",b);m.push(Xt(p,{cashBalance:a}))}}Promise.allSettled(m).then(()=>{}).catch(()=>{})}catch{hs(Wt),localStorage.setItem("cashBalance",Wt.toString()),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{Ni(!1)}},children:Ec?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(be,{open:wh,onOpenChange:_l,children:e.jsxs(ve,{className:"sm:max-w-md",children:[e.jsx(De,{children:e.jsx(we,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(G,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx(q,{id:"search-date",type:"date",value:ti,onChange:t=>Ro(t.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(G,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx(q,{id:"search-time",type:"time",value:si,onChange:t=>Uo(t.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(it,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>{Ro(""),Uo(""),_l(!1)},children:"مسح"}),e.jsx(x,{onClick:()=>_l(!1),children:"تطبيق"})]})]})}),e.jsx(Jx,{isOpen:Rm,onClose:()=>ll(!1)}),e.jsx(Kx,{isOpen:tl,onClose:()=>xn(!1),initialBarcode:ym}),e.jsx(tx,{isOpen:zm,onClose:()=>ri(!1)}),e.jsx(sx,{open:Vm,onOpenChange:ni}),e.jsx(cp,{open:Jm,onOpenChange:t=>{if(t&&!Aa){i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}ii(t)}}),e.jsx(fp,{open:te,onOpenChange:t=>{if(t&&!Aa){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}me(t)}}),e.jsx(yp,{open:E,onOpenChange:t=>{if(t&&!Aa){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}F(t)}}),e.jsx(ks,{open:Th,onOpenChange:Ac,onSuccess:()=>Wl(!0),title:"تقاريرك",description:"أدخل الرقم السري الرئيسي للوصول إلى تقاريرك",mode:"verify"}),e.jsx(be,{open:Ll,onOpenChange:Wl,children:e.jsxs(ve,{className:"sm:max-w-xl",children:[e.jsxs(De,{children:[e.jsxs(we,{className:"flex items-center gap-2",children:[e.jsx(co,{className:"h-4 w-4 text-blue-600"}),"تقارير اليوم"]}),e.jsx(us,{children:"ملخص معاملات اليوم محفوظ لآخر 30 يومًا مع أرشفة في السحابة"})]}),e.jsxs("div",{className:"space-y-4",children:[(()=>{const t=new Date().toDateString(),a=Ge.filter(u=>{const b=new Date(u.createdAt).toDateString(),p=String(u.status||"completed").toLowerCase();return b===t&&(p==="completed"||p==="confirmed")}),r=a.length,l=a.reduce((u,b)=>u+Number(b.amount||0),0),o=a.filter(u=>u.type==="withdraw").reduce((u,b)=>u+Number(b.amount||0),0),h=a.filter(u=>u.type==="send").reduce((u,b)=>u+Number(b.amount||0),0),m=a.reduce((u,b)=>u+Number(Rs.calculateTransactionProfit(b)||0),0);return e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-blue-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-blue-700",children:"عدد المعاملات"}),e.jsx("div",{className:"text-lg font-bold text-blue-800",children:r})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-indigo-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-indigo-700",children:"إجمالي المبالغ"}),e.jsx("div",{className:"text-lg font-bold text-indigo-800",children:Number(l).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-red-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-red-700",children:"المبالغ المسحوبة"}),e.jsx("div",{className:"text-lg font-bold text-red-800",children:Number(o).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-green-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-green-700",children:"المبالغ المرسلة"}),e.jsx("div",{className:"text-lg font-bold text-green-800",children:Number(h).toFixed(2)})]}),e.jsxs("div",{className:"col-span-2 rounded-lg p-3 bg-gradient-to-r from-amber-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-amber-700",children:"الأرباح"}),e.jsx("div",{className:"text-lg font-bold text-amber-800",children:Number(m).toFixed(2)})]})]})})(),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(x,{variant:"default",onClick:async()=>{try{if(!(s!=null&&s.uid))return;const t=new Date,a=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0"),o=`${a}-${r}-${l}`,h=t.toDateString(),m=Ge.filter(C=>{const A=new Date(C.createdAt).toDateString(),R=String(C.status||"completed").toLowerCase();return A===h&&(R==="completed"||R==="confirmed")}),u=m.length,b=m.reduce((C,A)=>C+Number(A.amount||0),0),p=m.filter(C=>C.type==="withdraw").reduce((C,A)=>C+Number(A.amount||0),0),g=m.filter(C=>C.type==="send").reduce((C,A)=>C+Number(A.amount||0),0),w=m.reduce((C,A)=>C+Number(Rs.calculateTransactionProfit(A)||0),0);await Mn.add({userId:s.uid,reportDate:o,totalTransactions:u,totalAmount:Number(b.toFixed(2)),totalWithdrawn:Number(p.toFixed(2)),totalSent:Number(g.toFixed(2)),profit:Number(w.toFixed(2)),walletId:null});try{await Mn.trimToMaxCount(s.uid,30)}catch{}i({title:"تم الأرشفة",description:`تم حفظ تقرير ${o}`})}catch{i({title:"فشل الأرشفة",description:"تعذر حفظ التقرير",variant:"destructive"})}},children:"أرشفة اليوم"}),e.jsx(x,{variant:"outline",onClick:()=>Wl(!1),children:"إغلاق"})]}),e.jsx("div",{className:"mt-2 border-t pt-2",children:e.jsx("div",{className:"space-y-2 max-h-[40vh] overflow-auto",children:Tc.length===0?e.jsx("div",{className:"text-xs text-muted-foreground",children:"لا توجد تقارير محفوظة"}):Tc.map(t=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:t.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",t.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalAmount).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalWithdrawn).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalSent).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:Number(t.profit??0).toFixed(2)})]})]})]},t.id||`${t.userId}-${t.reportDate}`))})})]})]})}),e.jsx(be,{open:Ah,onOpenChange:t=>{if(t){i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}$l(!1)},children:e.jsxs(ve,{dir:"rtl",className:"sm:max-w-md w-[95vw] sm:w-auto rounded-2xl border border-emerald-200 shadow-xl bg-gradient-to-br from-white via-green-50 to-emerald-50 backdrop-blur-md data-[state=open]:animate-in data-[state=open]:fade-in-0 data-[state=open]:zoom-in-90 data-[state=open]:slide-in-from-bottom-8 duration-300",children:[e.jsxs(De,{children:[e.jsx(we,{className:"text-right text-green-700",children:"شحن رصيد الموبايل"}),e.jsx(us,{className:"text-right text-gray-600",children:"أدخل البيانات ثم اضغط تأكيد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(G,{htmlFor:"topupPhone",className:"text-right block",children:"رقم الموبايل"}),e.jsx(q,{id:"topupPhone",value:pi,onChange:t=>jc(t.target.value),placeholder:"010xxxxxxx",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx(G,{className:"text-right block",children:"شركة التشغيل"}),e.jsxs(rr,{value:gi,onValueChange:Sc,children:[e.jsx(nr,{className:"text-right",children:e.jsx(ir,{placeholder:"اختر الشركة"})}),e.jsxs(lr,{children:[e.jsx(pa,{value:"vodafone",children:"فودافون"}),e.jsx(pa,{value:"orange",children:"أورنج"}),e.jsx(pa,{value:"etisalat",children:"اتصالات"}),e.jsx(pa,{value:"we",children:"WE"})]})]})]}),e.jsxs("div",{children:[e.jsx(G,{htmlFor:"topupAmount",className:"text-right block",children:"المبلغ بالجنيه"}),e.jsx(q,{id:"topupAmount",type:"number",value:fi,onChange:t=>Dc(t.target.value?Number(t.target.value):""),placeholder:"50",className:"text-right"})]})]}),e.jsxs(it,{className:"flex gap-2 justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>$l(!1),className:"border-gray-300",children:"إلغاء"}),e.jsx(x,{onClick:S,disabled:Ic||!pi||!gi||!fi,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:Ic?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})}),e.jsx(ks,{open:ah,onOpenChange:dl,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{dl(!1),Lr(!0)}}),e.jsx(ks,{open:nh,onOpenChange:Xo,mode:"verify",title:"تأكيد تغيير طلب الرقم السري للديون",description:"أدخل الرقم السري الرئيسي لتفعيل أو إلغاء طلب الرقم السري عند فتح الديون",onSuccess:async()=>{if(ec!==null){const t=ec;Zo(t);try{const a=s==null?void 0:s.uid,r=a?`debtsPinRequired_${a}`:"debtsPinRequired";localStorage.setItem(r,String(t)),a&&await Ce.updateUserData(a,{debtsPinRequired:t})}catch{}i({title:t?"تم تفعيل طلب الرقم السري للديون":"تم إلغاء طلب الرقم السري للديون",description:t?"سيُطلب الرقم السري الرئيسي عند فتح نافذة الديون.":"يمكن فتح نافذة الديون بدون طلب الرقم السري."})}ih(null),Xo(!1)}}),e.jsx(Yu,{open:Ih,onOpenChange:Sn,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"سيتم حذف كل المعاملات السابقة نهائيًا من حسابك وFirebase.",onSuccess:async()=>{try{if(!(s!=null&&s.uid)){Sn(!1);return}const t=new Date,a=l=>l instanceof Date?l:typeof(l==null?void 0:l.toDate)=="function"?l.toDate():new Date(String(l)),r=Ge.filter(l=>a(l.createdAt)<t);await Ce.updateUserData(s.uid,{recentReset:{keepLastCount:Rc.keepLastCount??30,intervalDays:Rc.intervalDays??7,lastResetAt:t}}),Di(l=>({...l,lastResetAt:t})),i({title:"تم إخفاء المعاملات السابقة",description:"تم إخفاء كل الإيصالات الأقدم من وقت التصفير من العرض بدون التأثير على تقارير اليوم/الشهر أو الحدود."})}catch(t){console.error("فشل تنفيذ التصفير النهائي:",t),i({title:"فشل التصفير",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}finally{Sn(!1)}}}),e.jsx(ks,{open:$t,onOpenChange:qs,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{qs(!1),tt(!0)}}),e.jsx(be,{open:sh,onOpenChange:Lr,children:e.jsxs(ve,{className:"sm:max-w-[425px]",children:[e.jsxs(De,{className:"flex items-center justify-between",children:[e.jsx(we,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx(ud,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[au," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(x,{variant:Ca==="debtor"?"default":"outline",onClick:()=>rc("debtor"),children:"مدين"}),e.jsx(x,{variant:Ca==="creditor"?"default":"outline",onClick:()=>rc("creditor"),children:"دائن"})]}),(Ca==="creditor"||Ca==="debtor")&&e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(G,{htmlFor:"debtorName",className:"text-right col-span-1",children:Ca==="creditor"?"اسم المديون":"اسم الدائن"}),e.jsx(q,{id:"debtorName",value:ml,onChange:t=>tc(t.target.value),className:"col-span-3 text-right",placeholder:Ca==="creditor"?"أدخل اسم المديون":"أدخل اسم الدائن"})]}),Ca&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(G,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(q,{id:"debtAmount",type:"number",value:hl,onChange:t=>sc(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(G,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx(q,{id:"debtReason",value:ul,onChange:t=>ac(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]})]}),e.jsx(it,{children:e.jsx(x,{onClick:()=>{if(!(Ca==="debtor")&&!(Ca==="creditor")){i({title:"اختر نوع الدين",description:"يرجى اختيار مدين أو دائن أولاً",variant:"destructive"});return}if(!hl||!ul||!ml){i({title:"بيانات غير مكتملة",description:"يرجى إدخال الاسم والمبلغ والسبب",variant:"destructive"});return}const r={id:Date.now().toString(),debtorName:ml,amount:parseFloat(hl),reason:ul,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[],type:Ca||"creditor"};wn(r),Fr(!0)},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(x,{variant:"outline",className:"w-full",onClick:()=>vr(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(x,{variant:"outline",className:"w-full",onClick:()=>wl(!0),children:"إضافة عميل"})})]})}),e.jsx(be,{open:fl,onOpenChange:vr,children:e.jsxs(ve,{className:"w-[95vw] sm:w-auto sm:max-w-[520px] rounded-2xl",children:[e.jsxs(De,{children:[e.jsx(we,{className:"text-right",children:"إيصالات الديون"}),e.jsx(us,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),wt.length>0?e.jsxs("div",{className:"max-h-[70vh] overflow-y-auto overscroll-contain scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 space-y-2 px-1 -mx-1 sm:mx-0 sm:px-0",style:{contain:"layout paint"},onScroll:t=>{const a=t.currentTarget;bl.length<wt.length&&a.scrollTop+a.clientHeight>=a.scrollHeight-50&&yl(r=>r+1)},children:[bl.map(t=>e.jsx("div",{onClick:()=>{Qa(t),Ga(!0),vr(!1),Lr(!1)},className:`p-4 sm:p-3 border rounded-xl cursor-pointer hover:bg-gray-50 transition-colors min-h-[64px] ${t.type==="debtor"?"border-r-4 border-r-red-500 bg-red-50/10":"border-r-4 border-r-emerald-500"}`,children:e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:justify-between sm:items-center",children:[e.jsxs("div",{className:"text-right space-y-0.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"font-medium text-[14px] sm:text-sm",children:t.debtorName}),t.type==="debtor"&&e.jsx(Bt,{variant:"destructive",className:"h-5 text-[10px] px-1",children:"علينا"}),(!t.type||t.type==="creditor")&&e.jsx(Bt,{variant:"outline",className:"h-5 text-[10px] px-1 text-emerald-700 border-emerald-200 bg-emerald-50",children:"لنا"})]}),e.jsx("p",{className:"text-[13px] sm:text-sm text-gray-600",children:t.reason}),e.jsx("p",{className:"text-[12px] sm:text-sm text-gray-500",children:Oi.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-xl sm:text-lg",children:[t.amount," جنيه"]}),e.jsx(Bt,{variant:t.status==="paid"?"default":"secondary",className:`${t.status==="paid"?"bg-green-500":"bg-yellow-500"} text-[12px] sm:text-xs`,children:t.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},t.id)),bl.length<wt.length&&e.jsx("div",{className:"flex justify-center pt-1",children:e.jsx(x,{variant:"outline",size:"sm",onClick:()=>yl(t=>t+1),children:"تحميل المزيد"})})]}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"}),e.jsxs(it,{className:"flex justify-between mt-3",children:[e.jsx(x,{variant:"destructive",onClick:async()=>{try{if(!wt||wt.length===0){i({title:"لا توجد ديون",description:"القائمة فارغة بالفعل."});return}if(!window.confirm("هل تريد حذف كل إيصالات الديون؟ هذا الإجراء لا يمكن التراجع عنه."))return;const a=[];if(Ms(a),Qa(null),await ca(a),s!=null&&s.uid)try{await Ce.updateUserData(s.uid,{debts:[],debtsDeletedAt:gt()});try{localStorage.removeItem(`debts_unsynced_${s.uid}`)}catch{}}catch(r){console.error("تعذر حذف الديون من Firebase:",r),i({title:"فشل الحذف من السحابة",description:"تعذر حذف الإيصالات من Firebase، حاول مرة أخرى.",variant:"destructive"});return}i({title:"تم حذف كل إيصالات الديون",description:"تم تفريغ القائمة بالكامل."}),vr(!1)}catch(t){console.error("تعذر حذف كل إيصالات الديون:",t),i({title:"فشل الحذف",description:"حدث خطأ أثناء الحذف، حاول مرة أخرى.",variant:"destructive"})}},children:"حذف كل الإيصالات"}),e.jsx(x,{variant:"outline",onClick:()=>vr(!1),children:"إغلاق"})]})]})}),e.jsx(be,{open:mh,onOpenChange:wl,children:e.jsxs(ve,{className:"sm:max-w-[500px] w-full max-h-[90vh] overflow-hidden flex flex-col p-0 gap-0 bg-gray-50/50",children:[e.jsx("div",{className:"p-4 border-b bg-white",children:e.jsxs(De,{children:[e.jsxs(we,{className:"text-right flex items-center justify-end gap-2",children:[e.jsx(or,{className:"w-5 h-5 text-primary"}),"إدارة العملاء والديون"]}),e.jsx(us,{className:"text-right",children:"سجل بيانات العملاء والديون بسهولة"})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[e.jsxs(bt,{className:"border shadow-sm bg-white",children:[e.jsx(ns,{className:"pb-2 pt-4 px-4",children:e.jsxs(js,{className:"text-sm font-medium text-right text-gray-700 flex items-center justify-end gap-2",children:[e.jsx(Vt,{className:"w-4 h-4"}),"إضافة عميل جديد"]})}),e.jsxs(At,{className:"p-4 pt-2 space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(G,{className:"text-right block text-xs text-gray-500",children:"اسم العميل"}),e.jsx(q,{value:jl,onChange:t=>dc(t.target.value),className:"text-right h-9",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(G,{className:"text-right block text-xs text-gray-500",children:"رقم الموبايل"}),e.jsx(q,{value:Sl,onChange:t=>mc(t.target.value),className:"text-right h-9",placeholder:"اكتب رقم الموبايل"})]}),e.jsxs(x,{className:"w-full bg-emerald-600 hover:bg-emerald-700 text-white h-9 mt-2",onClick:async()=>{if(!jl||!Sl){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const t={id:Date.now().toString(),name:jl.trim(),mobile:Sl.trim(),createdAt:new Date},a=[t,...Gs];await ql(a),dc(""),mc(""),i({title:"تمت إضافة العميل",description:`تم إضافة ${t.name}`})},children:[e.jsx(Vt,{className:"w-4 h-4 mr-2"}),"إضافة العميل"]})]})]}),e.jsxs(bt,{className:"border shadow-sm bg-white",children:[e.jsx(ns,{className:"pb-2 pt-4 px-4",children:e.jsxs(js,{className:"text-sm font-medium text-right text-gray-700 flex items-center justify-end gap-2",children:[e.jsx(is,{className:"w-4 h-4 text-orange-600"}),"تسجيل مبلغ دين"]})}),e.jsx(At,{className:"p-4 pt-2 space-y-3",children:Gs.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(G,{className:"text-right block text-xs text-gray-500",children:"اختر العميل"}),e.jsxs(rr,{value:Wr,onValueChange:hc,children:[e.jsx(nr,{className:"w-full h-9 text-right",dir:"rtl",children:e.jsx(ir,{placeholder:"اختر عميل"})}),e.jsx(lr,{children:Gs.map(t=>e.jsxs(pa,{value:t.id,className:"text-right justify-end",children:[t.name," — ",t.mobile]},t.id))})]}),Wr&&(()=>{const t=wt.filter(a=>a.customerId===Wr&&a.status==="pending").reduce((a,r)=>a+(r.amount-(r.paidAmount||0)),0);return t>0?e.jsxs("div",{className:"text-xs text-red-600 font-semibold mt-1 text-right",children:["إجمالي الديون الحالية: ",t.toFixed(2)," جنيه"]}):null})()]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(G,{className:"text-right block text-xs text-gray-500",children:"المبلغ"}),e.jsx(q,{type:"number",value:uc,onChange:t=>hh(t.target.value),className:"text-right h-9",placeholder:"0.00"})]}),e.jsx(x,{className:"w-full bg-orange-600 hover:bg-orange-700 text-white h-9 mt-2",onClick:async()=>{const t=parseFloat(uc);if(!Wr){i({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(t)||t<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Gs.find(l=>l.id===Wr);if(!a)return;const r={id:Date.now().toString(),debtorName:a.name,customerId:a.id,mobile:a.mobile,amount:Number(t.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};wn(r),Fr(!0)},children:"متابعة وإضافة المبلغ"})]}):e.jsx("div",{className:"text-center py-4 text-gray-500 text-sm bg-gray-50 rounded border border-dashed",children:"لا يوجد عملاء مسجلين. أضف عميلاً أولاً."})})]}),e.jsxs(bt,{className:"border shadow-sm bg-white",children:[e.jsx(ns,{className:"pb-2 pt-4 px-4",children:e.jsxs(js,{className:"text-sm font-medium text-right text-gray-700 flex items-center justify-end gap-2",children:[e.jsx(gd,{className:"w-4 h-4"}),"العملاء المسجلين (",Gs.length,")"]})}),e.jsx(At,{className:"p-4 pt-2",children:Gs.length>0?e.jsx("div",{className:"space-y-2",children:Gs.map(t=>e.jsxs("div",{className:"p-3 border rounded-lg flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition-colors",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8 text-blue-600 hover:text-blue-700 hover:bg-blue-50",onClick:()=>{xc(t.id),Dl(t.name||""),Il(t.mobile||""),ci(!0)},children:e.jsx(Fi,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8 text-red-600 hover:text-red-700 hover:bg-red-50",onClick:()=>{Cl(t.id),Al(t.name||""),di(!0)},children:e.jsx(Ns,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium text-sm text-gray-900",children:t.name}),e.jsx("div",{className:"text-xs text-gray-500 font-mono",children:t.mobile})]})]},t.id))}):e.jsx("div",{className:"text-center py-4 text-gray-400 text-sm",children:"لا توجد بيانات لعرضها"})})]})]}),e.jsx(it,{className:"p-4 border-t bg-white",children:e.jsx(x,{variant:"outline",className:"w-full sm:w-auto",onClick:()=>wl(!1),children:"إغلاق"})})]})}),e.jsx(be,{open:ph,onOpenChange:di,children:e.jsxs(ve,{hideClose:!0,className:"sm:max-w-[420px] rounded-2xl bg-gradient-to-br from-white via-rose-50 to-red-50 shadow-2xl border border-red-100 text-center",children:[e.jsxs(De,{children:[e.jsx(we,{className:"text-center text-xl font-bold text-red-700",children:"تأكيد حذف العميل"}),e.jsxs(us,{className:"text-center text-gray-600",children:["سيتم حذف العميل نهائيًا: ",fc]})]}),e.jsx("div",{className:"py-2 text-sm text-gray-700",children:"لا يمكن التراجع عن هذا الإجراء."}),e.jsxs(it,{className:"flex justify-center gap-3",children:[e.jsx(x,{variant:"outline",onClick:()=>{di(!1),Cl(""),Al("")},children:"إلغاء"}),e.jsx(x,{variant:"destructive",className:"bg-red-600 hover:bg-red-700",onClick:async()=>{const t=gh,a=Gs.filter(r=>r.id!==t);await ql(a),Wr===t&&hc(""),di(!1),Cl(""),Al(""),i({title:"تم حذف العميل",description:fc})},children:"حذف نهائي"})]})]})}),e.jsx(be,{open:uh,onOpenChange:ci,children:e.jsxs(ve,{className:"sm:max-w-[420px]",children:[e.jsx(De,{children:e.jsx(we,{className:"text-right",children:"تعديل بيانات العميل"})}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(G,{htmlFor:"editCustomerName",className:"text-right col-span-1",children:"الاسم"}),e.jsx(q,{id:"editCustomerName",value:pc,onChange:t=>Dl(t.target.value),className:"col-span-3 text-right"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(G,{htmlFor:"editCustomerMobile",className:"text-right col-span-1",children:"الموبايل"}),e.jsx(q,{id:"editCustomerMobile",value:gc,onChange:t=>Il(t.target.value),className:"col-span-3 text-right"})]})]}),e.jsxs(it,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>ci(!1),children:"إلغاء"}),e.jsx(x,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=xh,a=pc.trim(),r=gc.trim();if(!t||!a||!r){i({title:"بيانات غير مكتملة",description:"أدخل الاسم ورقم الموبايل",variant:"destructive"});return}const l=Gs.map(h=>h.id===t?{...h,name:a,mobile:r}:h);await ql(l);const o=wt.map(h=>h.customerId===t?{...h,debtorName:a,mobile:r}:h);o!==wt&&(Ms(o),await ca(o)),ci(!1),xc(""),Dl(""),Il(""),i({title:"تم تحديث العميل",description:a})},children:"حفظ"})]})]})}),e.jsx(be,{open:Da,onOpenChange:tt,children:e.jsxs(ve,{className:"sm:max-w-[520px]",children:[e.jsxs(De,{children:[e.jsx(we,{className:"text-right",children:"مصروفات المحل"}),e.jsx(us,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(G,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx(q,{id:"expenseName",value:Cr,onChange:t=>Ka(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(G,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx(q,{id:"expenseAmount",type:"number",value:Ar,onChange:t=>en(t.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(G,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx(q,{id:"expenseNotes",value:tn,onChange:t=>sn(t.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(it,{className:"flex justify-between",children:[e.jsx(x,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!Cr||!Ar){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}kr(!0)},children:"إضافة مصروف"}),e.jsx(x,{variant:"outline",onClick:()=>Pr(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(be,{open:rn,onOpenChange:Pr,children:e.jsxs(ve,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(De,{children:[e.jsx(we,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(us,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),mr.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:mr.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:t.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left flex items-start gap-2",children:[e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[t.amount," جنيه"]}),e.jsx(Bt,{variant:"secondary",className:t.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:t.source==="cash"?"من النقدية":`من المحفظة${t.walletId?` (${t.walletId})`:""}`})]}),e.jsxs(x,{variant:"destructive",size:"sm",className:"shrink-0",onClick:()=>_h(t.id),title:"حذف نهائي",children:[e.jsx(Ns,{className:"w-4 h-4 ml-1"}),"حذف"]})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(be,{open:Tr,onOpenChange:kr,children:e.jsxs(ve,{className:"sm:max-w-[480px]",children:[e.jsx(De,{children:e.jsx(we,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(x,{variant:ys==="cash"?"default":"outline",className:ys==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>Ya("cash"),children:"الفلوس النقدية"}),e.jsx(x,{variant:ys==="wallet"?"default":"outline",className:ys==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>Ya("wallet"),children:"أرصدة المحافظ"}),e.jsx(x,{variant:ys==="fawry"?"default":"outline",className:ys==="fawry"?"bg-amber-600 hover:bg-amber-700 text-white":"",onClick:()=>Ya("fawry"),children:"فوري"})]}),ys==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(rr,{value:Ha,onValueChange:hr,children:[e.jsx(nr,{className:"w-full",children:e.jsx(ir,{placeholder:"اختر محفظة"})}),e.jsx(lr,{children:Ve.map(t=>e.jsx(pa,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(it,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>{kr(!1),Ya(null),hr("")},children:"إلغاء"}),e.jsx(x,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=Number(Ar);if(isNaN(t)||t<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!ys){i({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(ys==="cash"){const o=Number((Wt-t).toFixed(2));hs(o),localStorage.setItem(Yt(),o.toString());const h={cashBalance:o,lastUpdated:new Date().toISOString()},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(h)),s!=null&&s.uid?(await Ce.updateUserData(s.uid,h),localStorage.removeItem(m),et(!1)):et(!0)}else if(ys==="wallet"){if(!Ha){i({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const o=lt[Ha]||0,h=Number((o-t).toFixed(2)),m={...lt,[Ha]:h};vs(m);const u=new Date().toISOString(),b={walletBalances:m,lastUpdated:u},p=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(p,JSON.stringify(b)),localStorage.setItem(ts(),JSON.stringify(m)),localStorage.setItem(`walletBalances_backup_${u}`,JSON.stringify(m)),s!=null&&s.uid&&Ce.updateUserData(s.uid,b).catch(()=>{})}}catch(o){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",o)}let a=Date.now().toString();try{if(s!=null&&s.uid){const{addDoc:o,collection:h,serverTimestamp:m}=await yt(async()=>{const{addDoc:p,collection:g,serverTimestamp:w}=await import("./index-DCCNgGPW.js").then(C=>C.ck);return{addDoc:p,collection:g,serverTimestamp:w}},__vite__mapDeps([0,1]),import.meta.url),{db:u}=await yt(async()=>{const{db:p}=await import("./index-DCCNgGPW.js").then(g=>g.cl);return{db:p}},__vite__mapDeps([0,1]),import.meta.url);a=(await o(h(u,"shop_expenses"),{userId:s.uid,shopId:O||(v==null?void 0:v.shopId)||s.uid||"default-shop",name:Cr,amount:t,notes:tn||"",source:ys,walletId:ys==="wallet"?Ha:null,createdAt:m()})).id}}catch(o){console.error("خطأ أثناء حفظ المصروف في Firestore:",o)}const r={id:a,name:Cr,amount:t,notes:tn,source:ys,walletId:ys==="wallet"?Ha:void 0,createdAt:new Date},l=[...mr,r];await Pc(l),Ka(""),en(""),sn(""),Ya(null),hr(""),kr(!1),tt(!0),Pr(!0),i({title:"تم إضافة المصروف",description:ys==="cash"?"تم الخصم من النقدية":ys==="wallet"?"تم الخصم من أرصدة المحافظ":"تم تسجيل الدفع عبر فوري"})},children:"تأكيد الخصم"})]})]})}),e.jsx(be,{open:ln,onOpenChange:ur,children:e.jsxs(ve,{className:"sm:max-w-[520px]",children:[e.jsxs(De,{children:[e.jsx(we,{className:"text-right",children:"النواقص"}),e.jsx(us,{className:"text-right",children:"سجل العناصر الناقصة التي تحتاج شراء وتابع حالتها."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(G,{htmlFor:"deficiencyName",className:"text-right col-span-1",children:"اسم العنصر"}),e.jsx(q,{id:"deficiencyName",value:Oa,onChange:t=>xr(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: سكر، زيت، مناديل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(G,{htmlFor:"deficiencyQuantity",className:"text-right col-span-1",children:"الكمية"}),e.jsx(q,{id:"deficiencyQuantity",type:"number",value:Hn,onChange:t=>on(t.target.value),className:"col-span-3 text-right",placeholder:"1"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(x,{className:"bg-rose-600 hover:bg-rose-700",onClick:()=>{if(It){i({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}const t=parseInt(Hn||"1",10);if(!Oa){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العنصر",variant:"destructive"});return}if(isNaN(t)||t<=0){i({title:"كمية غير صحيحة",description:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}(async()=>{if(s!=null&&s.uid)try{const{collection:r,addDoc:l,serverTimestamp:o}=await yt(async()=>{const{collection:u,addDoc:b,serverTimestamp:p}=await import("./index-DCCNgGPW.js").then(g=>g.ck);return{collection:u,addDoc:b,serverTimestamp:p}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await yt(async()=>{const{db:u}=await import("./index-DCCNgGPW.js").then(b=>b.cl);return{db:u}},__vite__mapDeps([0,1]),import.meta.url),m=await l(r(h,"deficiencies"),{userId:s.uid,shopId:O||(v==null?void 0:v.shopId)||s.uid||"default-shop",name:Oa,quantity:t,status:"pending",createdAt:o()});try{const u=yi(),b=localStorage.getItem(u),p=b?JSON.parse(b):[],g=Array.isArray(p)?p:[],w=g.some(R=>String((R==null?void 0:R.id)||"")===m.id),C={id:m.id,name:Oa,quantity:t,status:"pending",createdAt:new Date().toISOString()},A=w?g:[...g,C];localStorage.setItem(u,JSON.stringify(A))}catch{}xr(""),on(""),i({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"});return}catch(r){console.warn("فشل حفظ النواقص إلى Firestore، سيُستخدم التخزين المحلي:",r)}const a={id:Date.now().toString(),name:Oa,quantity:t,status:"pending",createdAt:new Date};Ea(r=>{const l=[...r,a];return Ul(l),l}),xr(""),on(""),i({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"})})()},children:"إضافة للنواقص"})}),cn.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:cn.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["الكمية: ",t.quantity]}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Bt,{variant:"secondary",className:t.status==="pending"?"bg-rose-100 text-rose-700":"bg-green-100 text-green-700",children:t.status==="pending"?"قيد الشراء":"تم الشراء"}),e.jsx(x,{variant:"outline",className:t.status==="pending"?"text-green-700 border-green-300 hover:bg-green-50":"text-rose-700 border-rose-300 hover:bg-rose-50",onClick:()=>{(async()=>{const a=t.status==="pending"?"purchased":"pending";if(s!=null&&s.uid)try{const{doc:r,updateDoc:l,serverTimestamp:o}=await yt(async()=>{const{doc:m,updateDoc:u,serverTimestamp:b}=await import("./index-DCCNgGPW.js").then(p=>p.ck);return{doc:m,updateDoc:u,serverTimestamp:b}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await yt(async()=>{const{db:m}=await import("./index-DCCNgGPW.js").then(u=>u.cl);return{db:m}},__vite__mapDeps([0,1]),import.meta.url);await l(r(h,"deficiencies",t.id),{status:a,updatedAt:o()});return}catch(r){console.warn("فشل تحديث حالة النواقص على Firestore، استخدام التخزين المحلي:",r)}Ea(r=>{const l=r.map(o=>o.id===t.id?{...o,status:a}:o);return Ul(l),l})})()},title:t.status==="pending"?"تم الشراء":"إلغاء الشراء",children:t.status==="pending"?"تم الشراء":"إلغاء الشراء"}),e.jsx(x,{variant:"outline",className:"text-red-700 border-red-300 hover:bg-red-50",onClick:()=>{(async()=>{if(s!=null&&s.uid)try{const{doc:a,deleteDoc:r}=await yt(async()=>{const{doc:o,deleteDoc:h}=await import("./index-DCCNgGPW.js").then(m=>m.ck);return{doc:o,deleteDoc:h}},__vite__mapDeps([0,1]),import.meta.url),{db:l}=await yt(async()=>{const{db:o}=await import("./index-DCCNgGPW.js").then(h=>h.cl);return{db:o}},__vite__mapDeps([0,1]),import.meta.url);await r(a(l,"deficiencies",t.id));return}catch(a){console.warn("فشل حذف عنصر النواقص من Firestore، استخدام التخزين المحلي:",a)}Ea(a=>{const r=a.filter(l=>l.id!==t.id);return Ul(r),r})})()},title:"حذف",children:"حذف"})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد عناصر مسجلة في النواقص"})]}),e.jsx(it,{className:"flex justify-end",children:e.jsx(x,{variant:"outline",onClick:()=>ur(!1),children:"إغلاق"})})]})}),e.jsx(be,{open:fh,onOpenChange:Fr,children:e.jsxs(ve,{className:"sm:max-w-[480px]",children:[e.jsx(De,{children:e.jsx(we,{className:"text-right",children:(es==null?void 0:es.type)==="decrease"?"اختيار مكان إضافة مبلغ السداد":"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:(es==null?void 0:es.type)==="decrease"?"اختر هل تريد إضافة مبلغ السداد إلى الرصيد النقدي أم إلى إحدى المحافظ أو تسجيله بدون خصم.":"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(x,{variant:zs==="cash"?"default":"outline",className:zs==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>Nn("cash"),children:"الفلوس النقدية"}),e.jsx(x,{variant:zs==="wallet"?"default":"outline",className:zs==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>Nn("wallet"),children:"أرصدة المحافظ"}),e.jsx(x,{variant:zs==="none"?"default":"outline",className:zs==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>Nn("none"),children:(es==null?void 0:es.type)==="decrease"?"بدون إضافة":"بدون خصم"})]}),zs==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{className:"text-right block",children:(es==null?void 0:es.type)==="decrease"?"اختر المحفظة للإضافة":"اختر المحفظة للخصم"}),e.jsxs(rr,{value:jn,onValueChange:Tl,children:[e.jsx(nr,{className:"w-full",children:e.jsx(ir,{placeholder:"اختر محفظة"})}),e.jsx(lr,{children:Ve.map(t=>e.jsx(pa,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(it,{className:"flex justify-between",children:[e.jsx(x,{variant:"outline",onClick:()=>{Fr(!1),wn(null),Nn(null),Tl("")},children:"إلغاء"}),e.jsx(x,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=!!es,a=t&&(es==null?void 0:es.type)==="decrease",r=Number(t?es.delta:(wr==null?void 0:wr.amount)||0);if(!zs){i({title:a?"اختر مكان الإضافة":"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}const l=new Date().toISOString();let o=Wt,h=lt,m=!1,u=!1;try{if(zs==="cash")o=Number(a?(Wt+r).toFixed(2):(Wt-r).toFixed(2)),m=!0;else if(zs==="wallet"){if(!jn){i({title:"اختر محفظة",description:a?"يرجى اختيار محفظة للإضافة":"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const A=lt[jn]||0,R=Number(a?(A+r).toFixed(2):(A-r).toFixed(2));h={...lt,[jn]:R},u=!0}}catch(A){console.error("Error calculating balances:",A);return}let b=[...wt],p=X,g=!1;if(t){if(!X)return;const A=Number(X.amount||0),R=Number(X.paidAmount||0),oe=Number(es.delta||0);if(es.type==="decrease"){const _=Number((A-oe).toFixed(2)),z=R>=_,xe={...X,amount:_,status:z?"paid":"pending"};if(b=wt.map(qe=>qe.id===X.id?xe:qe),p=xe,g=!0,z&&(s!=null&&s.uid)&&(async()=>{try{const[qe,qt,Cs]=[Je(ye(U,"userTransactions"),le("userId","==",s.uid),le("linkedDebtId","==",X.id),le("status","==","pending")),Je(ye(U,"transactions"),le("userId","==",s.uid),le("linkedDebtId","==",X.id),le("status","==","pending")),Je(ye(U,"transactions"),le("merchantUserId","==",s.uid),le("linkedDebtId","==",X.id),le("status","==","pending"))],[xt,Ct,ws]=await Promise.all([Ue(qe),Ue(qt),Ue(Cs)]),As=Uu(U);let er=0;const qr=he=>{he.docs.forEach(Pe=>{As.update(Pe.ref,{status:"completed",confirmedAt:new Date}),er++})};qr(xt),qr(Ct),qr(ws),er>0&&await As.commit(),s!=null&&s.uid&&[...xt.docs.map(Pe=>{var ot;return String(((ot=Pe.data())==null?void 0:ot.transactionId)||"")}),...Ct.docs.map(Pe=>{var ot;return String(Pe.id||((ot=Pe.data())==null?void 0:ot.transactionId)||"")}),...ws.docs.map(Pe=>{var ot;return String(Pe.id||((ot=Pe.data())==null?void 0:ot.transactionId)||"")})].filter(Boolean).forEach(Pe=>Ce.removeLocalReceiptById(s.uid,Pe))}catch(qe){console.error("Batch update failed for linked transactions:",qe)}})().catch(qe=>{console.error("Transaction update error:",qe)}),s!=null&&s.uid&&zs!=="none")try{const qt={transactionId:$e(ye(U,"dummy_collection")).id,amount:oe,transactionType:"cash_addition",type:"cash_addition",status:"completed",createdAt:new Date,senderName:X.debtorName,receiverName:"المحل",description:`سداد دين من العميل ${X.debtorName}`,paymentMethod:zs,walletId:zs==="wallet"?jn:null,linkedDebtId:X.id,isDebtRepayment:!0};await Ce.saveUserTransaction(s.uid,qt);try{L.invalidateQueries({queryKey:["recentTransactions",s==null?void 0:s.uid]})}catch{}}catch(qe){console.error("Failed to create repayment receipt:",qe)}i({title:"تم إنقاص المبلغ",description:`المبلغ الجديد: ${_} جنيه`})}else{const _=A+oe,z=R>=_,xe={...X,amount:Number(_.toFixed(2)),status:z?"paid":"pending"};b=wt.map(qe=>qe.id===X.id?xe:qe),p=xe,g=!0,i({title:"تم زيادة المبلغ",description:`المبلغ الجديد: ${_} جنيه`})}}else if(wr){b=[{...wr,userId:s==null?void 0:s.uid,shopId:O||(v==null?void 0:v.shopId)||null},...wt],g=!0;try{s!=null&&s.uid&&sr.send(s.uid,`تم إضافة دين على ${wr.debtorName} بمبلغ ${wr.amount} جنيه`).catch(()=>{})}catch{}}m&&hs(o),u&&vs(h),g&&(Ms(b),t&&Qa(p)),tc(""),sc(""),ac(""),Lr(!1),Fr(!1),!t&&g&&vr(!0),wn(null),lc(null),Nn(null),Tl(""),i({title:t?"تم تعديل الدين":"تم حفظ الدين",description:zs==="none"?"لم يتم تعديل الأرصدة":zs==="cash"?a?`تمت إضافة ${r} إلى الرصيد النقدي`:`تم خصم ${r} من الرصيد النقدي`:a?`تمت إضافة ${r} إلى رصيد المحفظة`:`تم خصم ${r} من رصيد المحفظة`});const w={lastUpdated:l};if(m&&(w.cashBalance=o),u&&(w.walletBalances=h),g&&(w.debts=b,w.debtsDeletedAt=null),m&&(localStorage.setItem(Yt(),o.toString()),localStorage.setItem(Yt()+"_lastUpdated",l)),u&&(localStorage.setItem(ts(),JSON.stringify(h)),localStorage.setItem(ts()+"_lastUpdated",l)),g){localStorage.setItem(Dn(),JSON.stringify(b));try{localStorage.setItem(Fl(),JSON.stringify(b))}catch{}try{localStorage.setItem(Bl(),Date.now().toString())}catch{}}const C=`userData_${s==null?void 0:s.uid}`;if(localStorage.setItem(C,JSON.stringify(w)),s!=null&&s.uid){if(g)try{localStorage.setItem(`debts_unsynced_${s.uid}`,"true")}catch{}const A=[];A.push(Ce.updateUserData(s.uid,w).then(()=>{(m||u)&&(localStorage.removeItem(C),et(!1))}));const R=O||(v==null?void 0:v.shopId);if(R&&(m||u)){const oe={lastUpdated:l};m&&(oe.cashBalance=o),u&&(oe.walletBalances=h),A.push(Ps($e(U,"dashboardData",R),oe,{merge:!0}).catch(_=>console.error("Failed to sync to dashboardData",_)))}Promise.all(A).then(()=>{if(g)try{localStorage.removeItem(`debts_unsynced_${s.uid}`)}catch{}}).catch(oe=>{console.error("Sync error:",oe),et(!0)})}},children:(es==null?void 0:es.type)==="decrease"?"تأكيد الإضافة":"تأكيد الخصم"})]})]})}),e.jsx(be,{open:lh,onOpenChange:Ga,children:e.jsxs(ve,{className:"w-[95vw] sm:w-auto sm:max-w-[425px] rounded-2xl",children:[e.jsx(De,{children:e.jsx(we,{className:"text-right",children:"إيصال الدين"})}),X&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:Oi.format(X.createdAt instanceof Date?X.createdAt:new Date(X.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:X.debtorName})]}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:justify-between sm:items-center",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"outline",className:"h-10 w-10 sm:h-8 sm:w-8 p-0","aria-label":"إنقاص الدين",onClick:()=>{nc("decrease"),xl(""),Ga(!1),vn(!0)},children:"−"}),e.jsxs("span",{className:"font-bold text-xl sm:text-lg",children:[X.amount," جنيه"]}),e.jsx(x,{variant:"outline",className:"h-10 w-10 sm:h-8 sm:w-8 p-0","aria-label":"زيادة الدين",onClick:()=>{nc("increase"),xl(""),Ga(!1),vn(!0)},children:"+"})]})]}),(()=>{try{const t=(Ge||[]).filter(a=>String((a==null?void 0:a.linkedDebtId)||"")===String(X.id)).reduce((a,r)=>a+Math.max(0,Number((r==null?void 0:r.commission)||0)),0);return t>0?e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"الربح:"}),e.jsxs("span",{className:"text-green-700 font-semibold",children:[t," جنيه"]})]}):null}catch{return null}})(),e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:X.reason})]}),e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(Bt,{variant:X.status==="paid"?"default":"secondary",className:`${X.status==="paid"?"bg-green-500":"bg-yellow-500"} w-fit text-[12px] sm:text-xs`,children:X.status==="paid"?"مدفوع":"مؤجل"})]}),(()=>{try{const t=(Ge||[]).filter(b=>String((b==null?void 0:b.linkedDebtId)||"")===String(X.id)),a=t.reduce((b,p)=>b+Math.max(0,Number((p==null?void 0:p.commission)||0)),0),r=t.reduce((b,p)=>b+Math.max(0,Number(((p==null?void 0:p.sentAmount)??(p==null?void 0:p.transferredAmount)??(p==null?void 0:p.withdrawnAmount)??(p==null?void 0:p.amount))||0)),0),l=Number(X.amount||0),o=Number(X.paidAmount||0),m=l<r+a?l+a:l,u=Math.max(0,Number(m)-o);return e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-xl sm:text-lg",children:[u," جنيه"]})]})}catch{return e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-xl sm:text-lg",children:[Number(X.amount||0)-Number(X.paidAmount||0)," جنيه"]})]})}})(),X.paidAmount?e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[X.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-4 border rounded-xl bg-gray-50",children:[ch?e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx(q,{id:"partialAmount",type:"number",value:oc,onChange:t=>gl(t.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{pl(!1),gl("")},children:"إلغاء"}),e.jsx(x,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const t=parseFloat(oc);if(!X||isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Math.max(0,Number(X.amount||0)-Number(X.paidAmount||0));if(t>a){i({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const r=Number(((X.paidAmount||0)+t).toFixed(2)),l=r>=Number(X.amount||0),o={...X,amount:Number(X.amount||0),paidAmount:r,status:l?"paid":"pending",partialPayments:[...X.partialPayments||[],{amount:t,paidAt:new Date}]},h=wt.map(m=>m.id===X.id?o:m);Ms(h),Qa(o),await ca(h);try{if(s!=null&&s.uid){const m=Math.max(0,Number(o.amount||0)-Number(o.paidAmount||0));await sr.send(s.uid,`تم سداد جزء من دين ${o.debtorName}: المدفوع ${t} جنيه، المتبقي ${m} جنيه`)}}catch{}try{o.status==="paid"&&(s!=null&&s.uid)&&(async()=>{const m=Je(ye(U,"userTransactions"),le("userId","==",s.uid),le("linkedDebtId","==",X.id),le("status","==","pending")),u=await Ue(m);await Promise.allSettled(u.docs.map(C=>Xt(C.ref,{status:"completed",confirmedAt:new Date})));try{const C=u.docs.map(A=>{var R;return String(((R=A.data())==null?void 0:R.transactionId)||"")});s!=null&&s.uid&&C.forEach(A=>A&&Ce.removeLocalReceiptById(s.uid,A))}catch{}const b=Je(ye(U,"transactions"),le("userId","==",s.uid),le("linkedDebtId","==",X.id),le("status","==","pending")),p=await Ue(b);await Promise.allSettled(p.docs.map(C=>Xt(C.ref,{status:"completed",confirmedAt:new Date})));try{const C=p.docs.map(A=>{var R;return String(A.id||((R=A.data())==null?void 0:R.transactionId)||"")});s!=null&&s.uid&&C.forEach(A=>A&&Ce.removeLocalReceiptById(s.uid,A))}catch{}const g=Je(ye(U,"transactions"),le("merchantUserId","==",s.uid),le("linkedDebtId","==",X.id),le("status","==","pending")),w=await Ue(g);await Promise.allSettled(w.docs.map(C=>Xt(C.ref,{status:"completed",confirmedAt:new Date})));try{const C=w.docs.map(A=>{var R;return String(A.id||((R=A.data())==null?void 0:R.transactionId)||"")});s!=null&&s.uid&&C.forEach(A=>A&&Ce.removeLocalReceiptById(s.uid,A))}catch{}})().catch(m=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",m),i({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(m){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",m)}try{const m=zl(),u=localStorage.getItem(m);if(u){const p=(JSON.parse(u)||[]).map(g=>(g==null?void 0:g.linkedDebtId)===X.id&&(g==null?void 0:g.status)==="pending"?{...g,status:"completed",confirmedAt:new Date}:g);localStorage.setItem(m,JSON.stringify(p)),aa(g=>g.map(w=>(w==null?void 0:w.linkedDebtId)===X.id&&(w==null?void 0:w.status)==="pending"?{...w,status:"completed",confirmedAt:new Date}:w))}}catch(m){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",m)}mi(t),Za("none"),Br(!0),pl(!1),gl(""),i({title:"تم تسجيل دفع جزء",description:`تم دفع ${t} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(x,{variant:"outline",className:"w-full",onClick:()=>pl(!0),children:"دفع جزء"}),X.partialPayments&&X.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-[12px] sm:text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-[30vh] sm:max-h-24 overflow-y-auto",children:X.partialPayments.map((t,a)=>e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:justify-between",children:[e.jsxs("span",{children:["دفع: ",t.amount," جنيه"]}),e.jsx("span",{children:new Date(t.paidAt).toLocaleString("ar-EG")})]},a))})]})]})]})]}),e.jsxs(it,{className:"flex gap-2 justify-center",children:[e.jsx(x,{onClick:async()=>{if(X){const t=wt.map(a=>a.id===X.id?{...a,status:"pending"}:a);Ms(t),await ca(t);try{if(s!=null&&s.uid){const a=computedRemaining;await sr.send(s.uid,`تم سداد الدين بالكامل للعميل ${X.debtorName}: المدفوع ${a} جنيه`)}}catch{}Ga(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(x,{onClick:async()=>{if(X){const t=Number(X.amount||0),a=Number(X.paidAmount||0);let r=Math.max(0,t-a);try{const h=(Ge||[]).filter(g=>String((g==null?void 0:g.linkedDebtId)||"")===String(X.id)),m=h.reduce((g,w)=>g+Math.max(0,Number((w==null?void 0:w.commission)||0)),0),u=h.reduce((g,w)=>g+Math.max(0,Number(((w==null?void 0:w.sentAmount)??(w==null?void 0:w.transferredAmount)??(w==null?void 0:w.withdrawnAmount)??(w==null?void 0:w.amount))||0)),0),p=t<u+m?t+m:t;r=Math.max(0,Number(p)-a)}catch{}const l=r,o=wt.map(h=>{if(h.id!==X.id)return h;const m=Number(h.amount||0),u=Number(h.paidAmount||0),b=Number((u+l).toFixed(2)),p=b>=m;return{...h,amount:m,paidAmount:p?m:b,status:"paid",partialPayments:[...h.partialPayments||[],...l>0?[{amount:l,paidAt:new Date}]:[]]}});Ms(o);try{Qa(o.find(h=>h.id===X.id)||null)}catch{}mi(l),Za("none"),Br(!0),await ca(o);try{s!=null&&s.uid&&(X!=null&&X.id)&&(async()=>{const h=Je(ye(U,"userTransactions"),le("userId","==",s.uid),le("linkedDebtId","==",X.id),le("status","==","pending")),m=await Ue(h);await Promise.allSettled(m.docs.map(w=>Xt(w.ref,{status:"completed",confirmedAt:new Date})));try{const w=m.docs.map(C=>{var A;return String(((A=C.data())==null?void 0:A.transactionId)||"")});s!=null&&s.uid&&w.forEach(C=>C&&Ce.removeLocalReceiptById(s.uid,C))}catch{}const u=Je(ye(U,"transactions"),le("userId","==",s.uid),le("linkedDebtId","==",X.id),le("status","==","pending")),b=await Ue(u);await Promise.allSettled(b.docs.map(w=>Xt(w.ref,{status:"completed",confirmedAt:new Date})));try{const w=b.docs.map(C=>{var A;return String(C.id||((A=C.data())==null?void 0:A.transactionId)||"")});s!=null&&s.uid&&w.forEach(C=>C&&Ce.removeLocalReceiptById(s.uid,C))}catch{}const p=Je(ye(U,"transactions"),le("merchantUserId","==",s.uid),le("linkedDebtId","==",X.id),le("status","==","pending")),g=await Ue(p);await Promise.allSettled(g.docs.map(w=>Xt(w.ref,{status:"completed",confirmedAt:new Date})));try{const w=g.docs.map(C=>{var A;return String(C.id||((A=C.data())==null?void 0:A.transactionId)||"")});s!=null&&s.uid&&w.forEach(C=>C&&Ce.removeLocalReceiptById(s.uid,C))}catch{}})().catch(h=>{console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",h),i({title:"فشل تحديث حالة المعاملة",description:"تعذر تحديث حالة المعاملات المرتبطة بالدين",variant:"destructive"})})}catch(h){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",h)}try{const h=zl(),m=localStorage.getItem(h);if(m){const b=(JSON.parse(m)||[]).map(p=>(p==null?void 0:p.linkedDebtId)===X.id&&(p==null?void 0:p.status)==="pending"?{...p,status:"completed",confirmedAt:new Date}:p);localStorage.setItem(h,JSON.stringify(b)),aa(p=>p.map(g=>(g==null?void 0:g.linkedDebtId)===X.id&&(g==null?void 0:g.status)==="pending"?{...g,status:"completed",confirmedAt:new Date}:g))}}catch(h){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",h)}Ga(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(x,{onClick:async()=>{if(X){const t=wt.filter(a=>a.id!==X.id);Ms(t),await ca(t),Ga(!1),i({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(be,{open:oh,onOpenChange:vn,children:e.jsxs(ve,{className:"sm:max-w-md rounded-2xl shadow-elegant border border-gray-200",children:[e.jsxs(De,{children:[e.jsx(we,{className:`text-right ${br==="decrease"?"text-red-600":"text-green-600"}`,children:br==="decrease"?"إنقاص مبلغ الدين":br==="increase"?"زيادة مبلغ الدين":"تعديل مبلغ الدين"}),e.jsxs(us,{className:"text-right",children:["أدخل المبلغ ثم اضغط تأكيد لإتمام ",br==="decrease"?"الإنقاص":"الزيادة","."]})]}),e.jsxs("div",{className:"grid gap-4 py-2",children:[e.jsx(G,{htmlFor:"debtAdjustAmount",className:"text-right",children:"المبلغ (جنيه)"}),e.jsx(q,{id:"debtAdjustAmount",type:"number",placeholder:"0.00",value:ic,onChange:t=>xl(t.target.value)}),X&&e.jsxs("div",{className:"text-right text-sm text-muted-foreground",children:["المبلغ الحالي: ",e.jsx("span",{className:"font-semibold",children:Number(X.amount||0).toFixed(2)})," جنيه"]})]}),e.jsxs(it,{className:"flex gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>{vn(!1),Ga(!0)},children:"إلغاء"}),e.jsx(x,{className:br==="decrease"?"bg-red-600 hover:bg-red-700":"bg-green-600 hover:bg-green-700",onClick:async()=>{try{if(!X||!br)return;const t=Number(parseFloat(ic||"0").toFixed(2));if(!t||isNaN(t)||t<=0){i({title:"قيمة غير صالحة",description:"يرجى إدخال مبلغ أكبر من صفر",variant:"destructive"});return}wn(null),lc({debtId:X.id,delta:t,type:br}),vn(!1),Fr(!0)}catch(t){console.error("فشل تجهيز تعديل مبلغ الدين:",t),i({title:"خطأ",description:"تعذّر تجهيز تعديل مبلغ الدين",variant:"destructive"})}},children:"تأكيد"})]})]})}),e.jsx(be,{open:yh,onOpenChange:Br,children:e.jsxs(ve,{className:"sm:max-w-[480px]",children:[e.jsxs(De,{children:[e.jsx(we,{className:"text-right",children:"اختيار مكان إضافة مبلغ السداد"}),e.jsx(us,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 justify-center",children:[e.jsx(x,{variant:ra==="cash"?"default":"outline",className:ra==="cash"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>Za("cash"),children:"الفلوس النقدية"}),e.jsx(x,{variant:ra==="wallet"?"default":"outline",className:ra==="wallet"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>Za("wallet"),children:"أرصدة المحافظ"}),e.jsx(x,{variant:ra==="fawry"?"default":"outline",className:ra==="fawry"?"bg-amber-600 text-white":"",size:"sm",onClick:()=>Za("fawry"),children:"فوري"}),e.jsx(x,{variant:ra==="none"?"default":"outline",className:ra==="none"?"bg-gray-600 text-white":"",size:"sm",onClick:()=>Za("none"),children:"بدون إضافة"})]}),ra==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة للإضافة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:Xa,onChange:t=>kl(t.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),Ve&&Ve.length>0?Ve.map(t=>e.jsx("option",{value:t.id,children:t.phone||t.name||t.id},t.id)):Object.keys(lt||{}).map(t=>{var a,r,l,o,h,m;return e.jsx("option",{value:t,children:((a=Ve.find(u=>u.id===t))==null?void 0:a.phone)||((l=(r=JSON.parse(localStorage.getItem(Vl())||"[]"))==null?void 0:r.find(u=>u.id===t))==null?void 0:l.phone)||((h=(o=JSON.parse(localStorage.getItem(Vl())||"[]"))==null?void 0:o.find(u=>u.id===t))==null?void 0:h.name)||((m=Ve.find(u=>u.id===t))==null?void 0:m.name)||t},t)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[yc," جنيه"]})]})]}),e.jsxs(it,{className:"flex flex-wrap justify-between gap-2",children:[e.jsx(x,{variant:"outline",onClick:()=>{Br(!1),mi(0),Za(null),kl("")},children:"إلغاء"}),e.jsx(x,{onClick:async()=>{var t,a;try{const r=yc;if(!r||r<=0){Br(!1);return}const l=async(o,h)=>{if(s!=null&&s.uid&&X)try{const u={transactionId:$e(ye(U,"dummy_collection")).id,amount:r,transactionType:"cash_addition",type:"cash_addition",status:"completed",createdAt:new Date,senderName:X.debtorName,receiverName:"المحل",description:`سداد دين من العميل ${X.debtorName}`,paymentMethod:o,walletId:h||null,linkedDebtId:X.id,isDebtRepayment:!0};await Ce.saveUserTransaction(s.uid,u);try{L.invalidateQueries({queryKey:["recentTransactions",s==null?void 0:s.uid]})}catch{}}catch(m){console.error("Failed to create repayment receipt:",m)}};if(ra==="cash"){const o=Wt+r;hs(o),localStorage.setItem(Yt(),o.toString());const h={cashBalance:o,lastUpdated:new Date().toISOString()},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(h)),s!=null&&s.uid?(Ce.updateUserData(s.uid,h).catch(()=>et(!0)),localStorage.removeItem(m),et(!1)):et(!0),i({title:"تم إضافة مبلغ السداد",description:`تم إضافة ${r} جنيه إلى الفلوس النقدية`}),await l("cash");try{if(X){const u=wt.map(b=>b.id===X.id?{...b,status:"paid",paidAmount:Math.max(Number(b.paidAmount||0),Number(b.amount||0))}:b);Ms(u);try{Qa(u.find(b=>b.id===X.id)||null)}catch{}try{await ca(u)}catch{}}}catch{}}else if(ra==="wallet"){if(!Xa){i({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const o={...lt,[Xa]:(lt[Xa]||0)+r};vs(o);const h=new Date().toISOString(),m={walletBalances:o,lastUpdated:h},u=`userData_${s==null?void 0:s.uid}`;if(localStorage.setItem(u,JSON.stringify(m)),localStorage.setItem(ts(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${h}`,JSON.stringify(o)),s!=null&&s.uid){Ce.updateUserData(s.uid,m).catch(()=>et(!0));try{localStorage.removeItem(u)}catch{}et(!1)}else et(!0);i({title:"تم إضافة مبلغ السداد",description:`تم إضافة ${r} جنيه إلى المحفظة ${((t=Ve.find(b=>b.id===Xa))==null?void 0:t.phone)||((a=Ve.find(b=>b.id===Xa))==null?void 0:a.name)||Xa}`}),await l("wallet",Xa);try{if(X){const b=wt.map(p=>p.id===X.id?{...p,status:"paid",paidAmount:Math.max(Number(p.paidAmount||0),Number(p.amount||0))}:p);Ms(b);try{Qa(b.find(p=>p.id===X.id)||null)}catch{}try{await ca(b)}catch{}}}catch{}}else if(ra==="none"){i({title:"تم تسجيل السداد",description:`تم تسجيل ${r} جنيه بدون تعديل الأرصدة`});try{if(X){const o=wt.map(h=>h.id===X.id?{...h,status:"paid",paidAmount:Math.max(Number(h.paidAmount||0),Number(h.amount||0))}:h);Ms(o);try{Qa(o.find(h=>h.id===X.id)||null)}catch{}try{await ca(o)}catch{}}}catch{}}else if(ra==="fawry")i({title:"تم تسجيل سداد عبر فوري",description:`تم تسجيل ${r} جنيه كسداد عبر فوري بدون تعديل الأرصدة`}),await l("fawry");else{i({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}try{const o=r>0?r:Number((X==null?void 0:X.amount)||0);s!=null&&s.uid&&X&&await sr.send(s.uid,`تم سداد الدين بالكامل للعميل ${X.debtorName}: المدفوع ${o} جنيه`)}catch{}}catch(r){console.error("خطأ أثناء إضافة مبلغ السداد:",r),i({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{Br(!1),mi(0),Za(null),kl("");try{vr(!0)}catch{}}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(be,{open:Lm,onOpenChange:fr,children:e.jsxs(ve,{hideClose:!0,className:"post-confirm-card sm:max-w-[420px] w-[90vw] rounded-2xl bg-gradient-to-br from-white via-indigo-50 to-blue-50 shadow-2xl border border-indigo-100",children:[e.jsxs(De,{children:[e.jsx(we,{className:"text-right text-2xl font-bold",children:(ms==null?void 0:ms.type)==="transfer"?"مبلغ يجب استلامه":"مبلغ يجب تسليمه"}),e.jsx(us,{className:"text-right text-gray-600",children:(ms==null?void 0:ms.type)==="transfer"?"هذا هو المبلغ الواجب استلامه من العميل بعد التأكيد.":"هذا هو المبلغ الواجب تسليمه للعميل بعد التأكيد."})]}),e.jsxs("div",{className:"py-3 flex flex-col items-center gap-1.5",children:[e.jsxs("div",{className:"text-xl sm:text-2xl font-bold text-blue-700 tracking-wide",children:[rs((ms==null?void 0:ms.amount)||0)," جنيه"]}),e.jsx("div",{className:"text-sm text-gray-500 text-right w-full",children:(ms==null?void 0:ms.type)==="transfer"?"المبلغ المعروض شامل عمولة التحويل.":Pt?"العمولة مضافة ولا تؤثر على قيمة التسليم.":"العمولة مخصومة من المبلغ المسلّم للعميل."})]}),e.jsxs(it,{className:"flex justify-end gap-2",children:[(ms==null?void 0:ms.type)==="transfer"&&e.jsx(x,{variant:"outline",id:"sendCodeBtn",onClick:_s,disabled:zo,className:"btn-transfer-confirm",children:zo?"جارٍ الإرسال...":"إرسال كود التحويل"}),e.jsx(x,{onClick:()=>{fr(!1),il(null)},className:"bg-green-600 hover:bg-green-700 text-white",children:(ms==null?void 0:ms.type)==="transfer"?"تم الاستلام":"تم التسليم"})]}),(ms==null?void 0:ms.type)==="transfer"&&e.jsx("div",{className:"mt-4 border-t pt-4 w-full",children:e.jsxs("div",{className:"flex justify-center gap-4",children:[e.jsx(x,{variant:nt===0?"default":"outline",size:"sm",onClick:()=>Nt(0),className:`flex-1 h-10 ${nt===0?"bg-blue-600 hover:bg-blue-700 text-white":"border-blue-200 text-blue-700 hover:bg-blue-50"}`,children:"SIM 1"}),e.jsx(x,{variant:nt===1?"default":"outline",size:"sm",onClick:()=>Nt(1),className:`flex-1 h-10 ${nt===1?"bg-blue-600 hover:bg-blue-700 text-white":"border-blue-200 text-blue-700 hover:bg-blue-50"}`,children:"SIM 2"})]})})]})}),e.jsx(ux,{open:Fm,onClose:()=>$r(!1),onSubmit:Ds,deviceId:Vo||ma||"",recipientMsisdn:String(fe==="transfer"?(Qs==null?void 0:Qs.receiver)||Rt||"":((sd=Ve.find(t=>t.id===J))==null?void 0:sd.phone)||"").replace(/\D/g,"")}),e.jsx(gp,{isOpen:Nm,onClose:()=>sl(!1),wallets:Ve,walletBalances:lt,onSelectWallet:t=>{cs(t);const a=Ve.find(r=>r.id===t);if(a){bs(a.phone);try{localStorage.setItem(Nr(),t)}catch{}}sl(!1)},selectedWalletId:J||void 0}),e.jsx(bp,{open:re,onOpenChange:_e}),e.jsx(qu,{open:Qe,onOpenChange:ze}),Jo]}))};export{jg as default};
//# sourceMappingURL=UserDashboardPage-1AkkOoGQ.js.map
