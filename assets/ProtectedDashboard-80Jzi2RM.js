import{$ as Re,c as _e,u as Me,af as $e,ag as ze,ah as se,r as a,j as e,B as H,ai as Ke,aj as Ue,w as De,I as N,Q as Ve,ae,y as ne,i as ie,ak as He,K as Je,H as Qe,z as Xe,al as Te,O as qe,a as Ge,am as Ie}from"./index-B_ABn6sw.js";import{C as S,a as D,b as T,d as I}from"./card-Ds81yHx3.js";import{B as Ye}from"./badge-CdTOh09B.js";import{S as re,a as le,b as oe,c as ce,d as x}from"./select-D3VXBbDd.js";import{M as Ze}from"./MasterPinDialog-Bo2AgpmT.js";import{ProfitService as We}from"./profitService-B9mhlsx2.js";import{D as Ce}from"./dollar-sign-C1TjfEjp.js";import{W as et}from"./wallet-Bao42OtN.js";import{C as tt}from"./circle-check-big-Ca0-WW0v.js";import{C as st}from"./circle-x-DEv3tFL4.js";import"./label-OIPO3k__.js";import"./shield-B6eXqFiO.js";import"./circle-alert-BX-uo7Jt.js";const at=()=>{const j=Re(),{toast:m}=_e(),{signOut:J,user:i,profile:f}=Me(),{isShiftActive:ke,shiftUser:de}=$e(),W=ze(),Q=(typeof se<"u"&&typeof se.getPlatform=="function"?se.getPlatform():"web")==="android"||/Android/i.test(typeof navigator<"u"?navigator.userAgent:""),[c,C]=a.useState("01030302038"),[X,me]=a.useState(""),[h,q]=a.useState(""),[k,L]=a.useState(""),[p,he]=a.useState("transfer"),[G,ue]=a.useState("vodafone_cash"),[Y,xe]=a.useState("vodafone_cash"),[pe,Z]=a.useState(""),[g,R]=a.useState([]),[nt,it]=a.useState("all"),[rt,lt]=a.useState(!1),[fe,ot]=a.useState(""),[_,ct]=a.useState([]),[dt,mt]=a.useState(null),[ht,ut]=a.useState(!1),[xt,pt]=a.useState([]),[ft,gt]=a.useState([]),[bt,jt]=a.useState(!1),[vt,yt]=a.useState("daily"),[wt,B]=a.useState([]),[ee,v]=a.useState(0),[y,w]=a.useState({}),[Nt,St]=a.useState(!1),[Dt,Tt]=a.useState(!1),[It,Wt]=a.useState(!1),[Ct,kt]=a.useState(!1),[Bt,Et]=a.useState(!1),[At,Pt]=a.useState(""),[Ot,Ft]=a.useState(!1),[Be,te]=a.useState(!1),[M,ge]=a.useState(()=>{try{const t=i!=null&&i.uid?`dailyReportsLockEnabled_${i==null?void 0:i.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[Ee,$]=a.useState(!1),[Ae,Pe]=a.useState(!1),d=t=>{const s="٠١٢٣٤٥٦٧٨٩",n="۰۱۲۳۴۵۶۷۸۹";return(t||"").split("").map(l=>{const r=s.indexOf(l);if(r>-1)return String(r);const o=n.indexOf(l);return o>-1?String(o):l}).join("")},be=t=>{const s=d(t).replace(/\D/g,"");return s.startsWith("010")?"vodafone_cash":s.startsWith("011")?"etisalat_cash":s.startsWith("012")?"orange_cash":null};a.useEffect(()=>{const t=be(c);t&&t!==G&&ue(t)},[c]),a.useEffect(()=>{const t=be(h);t&&t!==Y&&xe(t)},[h]),a.useEffect(()=>{try{const t=i!=null&&i.uid?`dailyReportsLockEnabled_${i==null?void 0:i.uid}`:"dailyReportsLockEnabled",s=localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled");ge(s==="true")}catch{}},[i==null?void 0:i.uid]),a.useEffect(()=>{const t=j.state||{};t!=null&&t.openTransactionSection&&(((t==null?void 0:t.transactionType)==="withdraw"||(t==null?void 0:t.transactionType)==="transfer")&&he(t.transactionType),Pe(!0),t!=null&&t.startNewTransaction&&(C("01030302038"),q(""),L(""),Z("")),setTimeout(()=>{window.scrollTo({top:0,behavior:"smooth"})},50))},[j.state]);const z=async t=>{if(i)try{const s=await ae.getById(i.uid);if(s!=null&&s.shopId){const n=ne(ie,"dashboardData",s.shopId);await qe(n,t)}}catch(s){console.error("Error saving to Firebase:",s),m({title:"خطأ في الحفظ",description:"حدث خطأ أثناء حفظ البيانات في Firebase",variant:"destructive"})}};a.useEffect(()=>{if(!i)return;(async()=>{te(!0);try{const s=await ae.getById(i.uid);if(s!=null&&s.shopId){const n=ne(ie,"dashboardData",s.shopId);try{const r=await He(n);if(r.exists()){const o=r.data();v(o.cashBalance||0),w(o.walletBalances||{}),B(o.deletedTransactions||[]),te(!1)}}catch{}const l=await Je(n);if(l.exists()){const r=l.data();v(r.cashBalance||0),w(r.walletBalances||{}),B(r.deletedTransactions||[])}else{const r={walletBalances:{},deletedTransactions:[]};await Qe(n,r),v(0),w(r.walletBalances),B(r.deletedTransactions)}}}catch(s){console.error("Error loading data from Firebase:",s),v(0),w({}),B([])}finally{te(!1)}})()},[i]),a.useEffect(()=>{if(!i)return;let t=null;return(async()=>{try{const n=await ae.getById(i.uid);if(n!=null&&n.shopId){const l=ne(ie,"dashboardData",n.shopId);t=Xe(l,{includeMetadataChanges:!0},r=>{if(r.exists()){const o=r.data();v(o.cashBalance||0),w(o.walletBalances||{}),B(o.deletedTransactions||[])}},r=>{console.error("Error subscribing to dashboardData:",r)})}}catch(n){console.error("Error initializing realtime dashboard subscription:",n)}})(),()=>{t&&t()}},[i==null?void 0:i.uid]);const Oe=async t=>{if(t.preventDefault(),p==="transfer"){if(!c||!h||!k){m({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}const s=(f==null?void 0:f.shopName)||(i==null?void 0:i.displayName)||"محل كاشي لينك",n=_.find(V=>V.id===fe)||_.find(V=>V.isDefault),l=d(c||"").replace(/\D/g,""),r=d(h||"").replace(/\D/g,""),o=G===Y,E=l.startsWith("010")&&(r.startsWith("011")||r.startsWith("012")||r.startsWith("015"))||l.startsWith("012")&&r.startsWith("010")||l.startsWith("011")&&r.startsWith("010")||l.startsWith("015")&&r.startsWith("010"),u=o?1:E?parseFloat(pe||"0"):0;if(E&&(Number.isNaN(u)||u<=0)){m({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"});return}if(!n){m({title:"لا توجد محفظة",description:"يرجى اختيار محفظة لإتمام التحويل",variant:"destructive"});return}const b=parseFloat(k),A=b+u,K=y[n.id]||0;if(K<A){m({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${K} لا يكفي لخصم ${A}`,variant:"destructive"});return}const P=Te(b,"send"),O={id:Date.now().toString(),type:"send",senderPhone:c,receiverPhone:h,amount:b,status:"pending",createdAt:new Date,withdrawnAmount:0,sentAmount:b,merchantShopName:s,shopName:(n==null?void 0:n.name)||"المحفظة الرئيسية",commission:P,fee:u,fromWallet:n.id},je=[O,...g];R(je);const Fe=b+u,U=n==null?void 0:n.id,Le=U&&y[U]||0,ve=U?{...y,[U]:Le-Fe}:y;w(ve),await z({transactions:je,walletBalances:ve}),m({title:"تم إرسال التحويل",description:"جاري معالجة التحويل..."}),setTimeout(async()=>{const ye=[{...O,status:"completed"},...g];R(ye);const we=u,Ne=Math.max(0,P)+(Number.isFinite(we)?we:0),Se=ee+Ne;v(Se),await z({transactions:ye,cashBalance:Se}),We.addProfit(Ne)},2e3),C("01030302038"),q(""),L(""),Z("")}else if(p==="withdraw"){if(!c||!k){m({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}const s=(f==null?void 0:f.shopName)||(i==null?void 0:i.displayName)||"محل كاشي لينك",n=_.find(u=>u.id===fe)||_.find(u=>u.isDefault);if(!n){m({title:"لا توجد محفظة",description:"يرجى اختيار محفظة لإتمام السحب",variant:"destructive"});return}const l=parseFloat(k);if(!Number.isFinite(l)||l<=0){m({title:"خطأ",description:"أدخل مبلغًا صحيحًا للسحب",variant:"destructive"});return}const r=Te(l,"receive"),o={id:Date.now().toString(),type:"withdraw",senderPhone:c,receiverPhone:"",amount:l,status:"pending",createdAt:new Date,withdrawnAmount:l,sentAmount:0,merchantShopName:s,shopName:(n==null?void 0:n.name)||"المحفظة الرئيسية",commission:r,fromWallet:n.id,senderName:X||void 0},E=[o,...g];R(E),await z({transactions:E}),m({title:"تم إنشاء عملية السحب",description:"جاري معالجة السحب..."}),setTimeout(async()=>{const b=[{...o,status:"completed"},...g];R(b);const A=n.id,K=y[A]||0,P={...y,[A]:K+l};w(P);const O=ee-l+Math.max(0,r);v(O),await z({transactions:b,walletBalances:P,cashBalance:O}),We.addProfit(Math.max(0,r))},2e3),C("01030302038"),L("")}};return e.jsxs("div",{className:"min-h-screen bg-background p-4",children:[Be&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-center",children:"جاري تحميل البيانات..."})]})}),e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"لوحة تحكم الإدارة"}),e.jsxs(H,{onClick:J,variant:"outline",className:"flex items-center gap-2",children:[e.jsx(Ke,{className:"h-4 w-4"}),"تسجيل الخروج"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsxs(S,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(T,{className:"text-sm font-medium",children:"الرصيد النقدي"}),e.jsx(Ce,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(I,{children:e.jsxs("div",{className:"text-2xl font-bold",children:[ee.toLocaleString()," جنيه"]})})]}),e.jsxs(S,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(T,{className:"text-sm font-medium",children:"الأرصدة علي المحافظ"}),e.jsx(et,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(I,{children:e.jsxs("div",{className:"text-2xl font-bold",children:[Object.values(y).reduce((t,s)=>t+s,0).toLocaleString()," جنيه"]})})]}),e.jsxs(S,{className:"relative",children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(T,{className:"text-sm font-medium",children:"المعاملات اليوم"}),e.jsx(Ue,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(I,{className:M?"filter blur-sm pointer-events-none":"",children:e.jsx("div",{className:"text-2xl font-bold",children:g.length})}),M&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(H,{size:"sm",variant:"ghost",onClick:()=>$(!0),className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير اليوم",children:[e.jsx(De,{className:"h-5 w-5"}),e.jsx("span",{className:"text-xs",children:"عرض تقارير اليوم"})]})})]}),e.jsxs(S,{className:"relative",children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(T,{className:"text-sm font-medium",children:"إجمالي اليوم"}),e.jsx(Ce,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(I,{className:M?"filter blur-sm pointer-events-none":"",children:e.jsxs("div",{className:"text-2xl font-bold",children:[g.reduce((t,s)=>t+s.amount,0).toLocaleString()," جنيه"]})}),M&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(H,{size:"sm",variant:"ghost",onClick:()=>$(!0),className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير اليوم",children:[e.jsx(De,{className:"h-5 w-5"}),e.jsx("span",{className:"text-xs",children:"عرض تقارير اليوم"})]})})]}),e.jsx(Ze,{open:Ee,onOpenChange:$,mode:"verify",title:"قفل تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{ge(!1),$(!1)}})]}),e.jsxs(S,{className:W&&Ae?"sticky top-0 z-40 shadow-lg bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/70":"",children:[e.jsx(D,{children:e.jsx(T,{children:"إجراء معاملة جديدة"})}),e.jsx(I,{children:e.jsxs("form",{onSubmit:Oe,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"نوع المعاملة"}),e.jsxs(re,{value:p,onValueChange:t=>he(t),children:[e.jsx(le,{children:e.jsx(oe,{})}),e.jsxs(ce,{children:[e.jsx(x,{value:"transfer",children:"تحويل"}),e.jsx(x,{value:"withdraw",children:"سحب"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رقم المرسل"}),e.jsx(N,{type:"tel",value:c,onChange:t=>C(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const s=document.getElementById("receiverPhoneInput");if(s)s.focus();else{const n=document.getElementById("amountInput");n==null||n.focus()}}},placeholder:"01xxxxxxxxx"})]}),p==="transfer"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رقم المستقبل"}),e.jsx(N,{id:"receiverPhoneInput",type:"tel",value:h,onChange:t=>q(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const s=document.getElementById("amountInput");s==null||s.focus()}},placeholder:"01xxxxxxxxx"})]}),p==="withdraw"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"اسم الراسل (اختياري)"}),e.jsx(N,{id:"senderNameInput",type:"text",value:X,onChange:t=>me(t.target.value),placeholder:"مثال: أحمد عبد الرحمن"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"شركة المرسل"}),e.jsxs(re,{value:G,onValueChange:t=>ue(t),children:[e.jsx(le,{children:e.jsx(oe,{})}),e.jsxs(ce,{children:[e.jsx(x,{value:"vodafone_cash",children:"فودافون"}),e.jsx(x,{value:"etisalat_cash",children:"اتصالات"}),e.jsx(x,{value:"orange_cash",children:"أورانج"}),e.jsx(x,{value:"instapay",children:"إنستاباي"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"شركة المستقبل"}),e.jsxs(re,{value:Y,onValueChange:t=>xe(t),children:[e.jsx(le,{children:e.jsx(oe,{})}),e.jsxs(ce,{children:[e.jsx(x,{value:"vodafone_cash",children:"فودافون"}),e.jsx(x,{value:"etisalat_cash",children:"اتصالات"}),e.jsx(x,{value:"orange_cash",children:"أورانج"}),e.jsx(x,{value:"instapay",children:"إنستاباي"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"المبلغ"}),e.jsx(N,{id:"amountInput",type:"number",value:k,onChange:t=>L(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const s=document.getElementById("txSubmitButton");s==null||s.focus()}},placeholder:"0.00"})]}),p==="withdraw"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"اسم الراسل (اختياري)"}),e.jsx(N,{id:"senderNameInput",type:"text",value:X,onChange:t=>me(t.target.value),placeholder:"مثال: أحمد عبد الرحمن"})]}),p==="transfer"&&(d(c||"").replace(/\D/g,"").startsWith("010")&&(d(h||"").replace(/\D/g,"").startsWith("011")||d(h||"").replace(/\D/g,"").startsWith("012")||d(h||"").replace(/\D/g,"").startsWith("015"))||d(c||"").replace(/\D/g,"").startsWith("012")&&d(h||"").replace(/\D/g,"").startsWith("010")||d(c||"").replace(/\D/g,"").startsWith("011")&&d(h||"").replace(/\D/g,"").startsWith("010")||d(c||"").replace(/\D/g,"").startsWith("015")&&d(h||"").replace(/\D/g,"").startsWith("010"))&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رسوم التحويل"}),e.jsx(N,{type:"number",value:pe,onChange:t=>Z(t.target.value),placeholder:"0.00"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"تُخصم من المحفظة وتضاف للدرج"})]})]}),e.jsx(H,{id:"txSubmitButton",type:"submit",className:`w-full ${p==="transfer"?"btn-transfer-confirm":"btn-withdraw-confirm"}`,children:p==="transfer"?"إرسال التحويل":"تنفيذ السحب"})]})})]}),e.jsxs(S,{children:[e.jsx(D,{children:e.jsx(T,{children:"المعاملات الأخيرة"})}),e.jsx(I,{children:g.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"لا توجد معاملات حديثة."}):e.jsx("div",{className:W||Q?"receipts-list space-y-4 max-h-[310px] overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400":"receipts-list space-y-4",children:g.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(tt,{className:`h-5 w-5 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(Ve,{className:"h-5 w-5 text-yellow-500"}),t.status==="failed"&&e.jsx(st,{className:"h-5 w-5 text-red-500"})]}),e.jsxs("div",{children:[e.jsxs("p",{className:`font-medium ${t.type==="send"?"text-green-700":"text-red-700"}`,children:[t.type==="send"?"تحويل":"سحب"," - ",t.amount.toLocaleString()," جنيه"]}),t.type==="send"?e.jsxs("p",{className:"text-sm text-green-600",children:["من ",t.senderPhone," إلى ",t.receiverPhone]}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-sm text-red-500",children:["من ",t.senderPhone]}),t.senderName&&e.jsxs("p",{className:"text-xs text-red-400",children:["اسم الراسل: ",t.senderName]})]})]})]}),e.jsx(Ye,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})})]})]})]})},qt=()=>{const j=Ge(),[m,J]=a.useState(!1),[i,f]=a.useState(!0);return a.useEffect(()=>{(()=>{const de=localStorage.getItem("dashboardAuth"),W=localStorage.getItem("dashboardUser");if(de==="true"&&W)try{const F=JSON.parse(W),Q=new Date(F.loginTime);(new Date().getTime()-Q.getTime())/(1e3*60*60)<24?J(!0):(localStorage.removeItem("dashboardAuth"),localStorage.removeItem("dashboardUser"),j("/dashboard/login"))}catch(F){console.error("Error parsing user data:",F),j("/dashboard/login")}else j("/dashboard/login");f(!1)})()},[j]),i?e.jsx(Ie,{}):m?e.jsx(at,{}):e.jsx(Ie,{})};export{qt as default};
//# sourceMappingURL=ProtectedDashboard-80Jzi2RM.js.map
