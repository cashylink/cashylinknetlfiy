const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./dailyOperationCountService-Cggs5ihI.js","./index-BajlLdY5.js","./index-u-rmA3qJ.css","./profitService-BsJiOlFZ.js"])))=>i.map(i=>d[i]);
import{J as Lt,r as d,a8 as Rs,j as t,a2 as Ps,a4 as Os,a5 as Ee,a6 as $e,aK as ks,T as Ke,u as Mt,a0 as St,B as S,v as Rt,W as Re,X as Pe,Y as Oe,Z as ke,Q as xe,D as G,at as Ve,b5 as w,a as Es,R as ue,b6 as Is,af as _s,x as J,i as W,y as te,q as se,h as ae,av as Y,a1 as U,k as Pt,b7 as Ls,o as Ms,l as Ws,b8 as pe,$ as Bs,ae as Ge,K as re,I as qe,b9 as Fs,as as Ot,ba as Us,bb as zs,aW as kt,aw as Et,f as He,aC as $s,ad as V,O as De}from"./index-BajlLdY5.js";import{C as Vs,a as Gs,b as qs,d as Hs}from"./card-D2hJhqI-.js";import{u as Xs,S as Ys,a as Ks,b as Zs,c as Js,d as Se}from"./select-cRpGVzzV.js";import{B as Qs}from"./badge-BqG4iaD_.js";import{c as Wt,R as ea,I as ta}from"./index-B1OW4tWd.js";import{A as It,C as sa,a as aa,f as q,b as na,M as ra,c as ia,R as oa,I as la}from"./MaintenanceDialog-DW_e-0_t.js";import{M as Xe,P as ca}from"./MasterPinDialog-Dzu-23pe.js";import{ProfitService as he}from"./profitService-BsJiOlFZ.js";import{D as da,A as Ye}from"./dollar-sign-BDqmtM9Z.js";import{C as Bt,S as ma}from"./separator-DOqIUub8.js";import{A as ua}from"./arrow-left-BVUbpV8M.js";import{T as _t}from"./progress-uLjsq_1U.js";import{C as pa}from"./circle-x-keELdqKL.js";import{C as ha}from"./circle-check-big-BvPzvsqn.js";import"./whatsappService--qyt9eIV.js";import"./download-D_3I9CMV.js";import"./label-CgY5njAZ.js";import"./circle-alert-Cbz1KT_L.js";/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xa=[["path",{d:"m11 7-3 5h4l-3 5",key:"b4a64w"}],["path",{d:"M14.856 6H16a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.935",key:"lre1cr"}],["path",{d:"M22 14v-4",key:"14q9d5"}],["path",{d:"M5.14 18H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2.936",key:"13q5k0"}]],fa=Lt("battery-charging",xa);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ga=[["path",{d:"M9 9.003a1 1 0 0 1 1.517-.859l4.997 2.997a1 1 0 0 1 0 1.718l-4.997 2.997A1 1 0 0 1 9 14.996z",key:"kmsa83"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],va=Lt("circle-play",ga);var Ie="Tabs",[ba]=Ps(Ie,[Wt]),Ft=Wt(),[ya,Ze]=ba(Ie),Ut=d.forwardRef((y,a)=>{const{__scopeTabs:g,value:u,onValueChange:O,defaultValue:E,orientation:P="horizontal",dir:z,activationMode:L="automatic",...R}=y,C=Xs(z),[D,B]=Rs({prop:u,onChange:O,defaultProp:E??"",caller:Ie});return t.jsx(ya,{scope:g,baseId:Os(),value:D,onValueChange:B,orientation:P,dir:C,activationMode:L,children:t.jsx(Ee.div,{dir:C,"data-orientation":P,...R,ref:a})})});Ut.displayName=Ie;var zt="TabsList",$t=d.forwardRef((y,a)=>{const{__scopeTabs:g,loop:u=!0,...O}=y,E=Ze(zt,g),P=Ft(g);return t.jsx(ea,{asChild:!0,...P,orientation:E.orientation,dir:E.dir,loop:u,children:t.jsx(Ee.div,{role:"tablist","aria-orientation":E.orientation,...O,ref:a})})});$t.displayName=zt;var Vt="TabsTrigger",Gt=d.forwardRef((y,a)=>{const{__scopeTabs:g,value:u,disabled:O=!1,...E}=y,P=Ze(Vt,g),z=Ft(g),L=Xt(P.baseId,u),R=Yt(P.baseId,u),C=u===P.value;return t.jsx(ta,{asChild:!0,...z,focusable:!O,active:C,children:t.jsx(Ee.button,{type:"button",role:"tab","aria-selected":C,"aria-controls":R,"data-state":C?"active":"inactive","data-disabled":O?"":void 0,disabled:O,id:L,...E,ref:a,onMouseDown:$e(y.onMouseDown,D=>{!O&&D.button===0&&D.ctrlKey===!1?P.onValueChange(u):D.preventDefault()}),onKeyDown:$e(y.onKeyDown,D=>{[" ","Enter"].includes(D.key)&&P.onValueChange(u)}),onFocus:$e(y.onFocus,()=>{const D=P.activationMode!=="manual";!C&&!O&&D&&P.onValueChange(u)})})})});Gt.displayName=Vt;var qt="TabsContent",Ht=d.forwardRef((y,a)=>{const{__scopeTabs:g,value:u,forceMount:O,children:E,...P}=y,z=Ze(qt,g),L=Xt(z.baseId,u),R=Yt(z.baseId,u),C=u===z.value,D=d.useRef(C);return d.useEffect(()=>{const B=requestAnimationFrame(()=>D.current=!1);return()=>cancelAnimationFrame(B)},[]),t.jsx(ks,{present:O||C,children:({present:B})=>t.jsx(Ee.div,{"data-state":C?"active":"inactive","data-orientation":z.orientation,role:"tabpanel","aria-labelledby":L,hidden:!B,id:R,tabIndex:0,...P,ref:a,style:{...y.style,animationDuration:D.current?"0s":void 0},children:B&&E})})});Ht.displayName=qt;function Xt(y,a){return`${y}-trigger-${a}`}function Yt(y,a){return`${y}-content-${a}`}var ja=Ut,Kt=$t,Zt=Gt,Jt=Ht;const Na=ja,Qt=d.forwardRef(({className:y,...a},g)=>t.jsx(Kt,{ref:g,className:Ke("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",y),...a}));Qt.displayName=Kt.displayName;const fe=d.forwardRef(({className:y,...a},g)=>t.jsx(Zt,{ref:g,className:Ke("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",y),...a}));fe.displayName=Zt.displayName;const ge=d.forwardRef(({className:y,...a},g)=>t.jsx(Jt,{ref:g,className:Ke("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",y),...a}));ge.displayName=Jt.displayName;const wa=({userId:y,transactions:a=[]})=>{const[g,u]=d.useState(!1),[O,E]=d.useState(!1),[P,z]=d.useState(!1),[L,R]=d.useState({dailyWithdraw:0,dailyTransfer:0,monthlyWithdraw:0,monthlyTransfer:0,lastUpdated:new Date}),{userSubscription:C}=Mt();d.useEffect(()=>{y&&g&&P&&_e()},[y,g,P]);const D=T=>`${T.toFixed(2)} ج.م`,B=async()=>{try{const T=(C==null?void 0:C.subscription)||null,p=(T==null?void 0:T.planType)??(T==null?void 0:T.plan)??null,A=typeof p=="string"?p.toLowerCase():null;if(p===G.ZERO||A==="zero"||A==="0"||p===0)return!0}catch{}try{if(y){const T=await Ve(y),p=(T==null?void 0:T.planType)??(T==null?void 0:T.plan)??null,A=typeof p=="string"?p.toLowerCase():null;if(p===G.ZERO||A==="zero"||A==="0"||p===0)return!0}}catch{}return!1},ie=async()=>{try{const T=await(async()=>{try{const p=(C==null?void 0:C.subscription)||null,A=(p==null?void 0:p.planType)??(p==null?void 0:p.plan)??null,$=typeof A=="string"?A.toLowerCase():null;if(A===G.TAHWEELA||$==="tahweela")return!0}catch{}try{if(y){const p=await Ve(y),A=(p==null?void 0:p.planType)??(p==null?void 0:p.plan)??null,$=typeof A=="string"?A.toLowerCase():null;if(A===G.TAHWEELA||$==="tahweela")return!0}}catch{}return!1})();if(await B()||T){w({title:"غير متاح لاشتراكك",description:"عرض إجمالي الأرباح غير متاح في هذه الخطة.",variant:"destructive"});return}}catch{}E(!0)},ne=async()=>{try{const T=await(async()=>{try{const p=(C==null?void 0:C.subscription)||null,A=(p==null?void 0:p.planType)??(p==null?void 0:p.plan)??null,$=typeof A=="string"?A.toLowerCase():null;if(A===G.TAHWEELA||$==="tahweela")return!0}catch{}try{if(y){const p=await Ve(y),A=(p==null?void 0:p.planType)??(p==null?void 0:p.plan)??null,$=typeof A=="string"?A.toLowerCase():null;if(A===G.TAHWEELA||$==="tahweela")return!0}}catch{}return!1})();if(await B()||T){w({title:"غير متاح لاشتراكك",description:"عرض إجمالي الأرباح غير متاح في هذه الخطة.",variant:"destructive"}),E(!1);return}}catch{}z(!0),u(!0),E(!1)},_e=async()=>{if(y)try{if(Array.isArray(a)&&a.length>0){const p=new Date,A=p.getMonth(),$=p.getFullYear(),Le=St.filterVisibleTransactions(a,"daily",y),Q=St.filterVisibleTransactions(a,"monthly",y);let oe=0,K=0,ve=0,Z=0;Le.forEach(M=>{const le=new Date(M.createdAt),H=String(M.status||"confirmed").toLowerCase();if(le.toDateString()!==p.toDateString()||H!=="completed"&&H!=="confirmed"&&H!=="pending")return;const ee=(M.type||M.txnType||"").toLowerCase(),I={type:ee==="withdrawal"?"withdraw":ee,amount:Number(M.amount||0),commission:M.commission};I.type==="withdraw"?oe+=he.calculateProfitFromTransaction(I):(I.type==="send"||I.type==="receive"||I.type==="transfer")&&(K+=he.calculateProfitFromTransaction(I))}),Q.forEach(M=>{const le=new Date(M.createdAt),H=String(M.status||"confirmed").toLowerCase();if(le.getMonth()!==A||le.getFullYear()!==$||H!=="completed"&&H!=="confirmed"&&H!=="pending")return;const ee=(M.type||M.txnType||"").toLowerCase(),I={type:ee==="withdrawal"?"withdraw":ee,amount:Number(M.amount||0),commission:M.commission};I.type==="withdraw"?ve+=he.calculateProfitFromTransaction(I):(I.type==="send"||I.type==="receive"||I.type==="transfer")&&(Z+=he.calculateProfitFromTransaction(I))}),R({dailyWithdraw:Math.round(oe*100)/100,dailyTransfer:Math.round(K*100)/100,monthlyWithdraw:Math.round(ve*100)/100,monthlyTransfer:Math.round(Z*100)/100,lastUpdated:new Date});return}const T=he.getWithdrawTransferProfits(y);R({dailyWithdraw:T.dailyWithdrawProfit||0,dailyTransfer:T.dailyTransferProfit||0,monthlyWithdraw:T.monthlyWithdrawProfit||0,monthlyTransfer:T.monthlyTransferProfit||0,lastUpdated:new Date})}catch(T){console.error("Error loading total profits:",T)}};return t.jsxs(t.Fragment,{children:[t.jsx(S,{size:"sm",variant:"ghost",onClick:ie,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-purple-200 text-purple-700 hover:from-blue-200 hover:to-purple-300 hover:text-purple-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض إجمالي الأرباح",children:t.jsx(Rt,{className:"h-1.5 w-1.5"})}),t.jsx(Re,{open:g,onOpenChange:u,children:t.jsxs(Pe,{className:"max-w-[240px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[220px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[t.jsx(Oe,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:t.jsxs(ke,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-1 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[t.jsx(da,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"إجمالي الأرباح (فوري)"]})}),t.jsxs("div",{className:"space-y-1 py-1 sm:space-y-2 sm:py-2",children:[t.jsxs("div",{className:"bg-blue-50 p-1 rounded border border-blue-200 sm:bg-gradient-to-r sm:from-blue-50 sm:to-blue-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(xe,{className:"h-2 w-2 text-blue-600"}),t.jsx("span",{className:"text-[10px] font-semibold text-blue-800",children:"يومي"})]}),t.jsx("span",{className:"text-[10px] font-bold text-blue-900",children:D((L.dailyWithdraw??0)+(L.dailyTransfer??0))})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-1",children:[t.jsxs("div",{className:"flex items-center justify-between bg-red-50 p-0.5 rounded border border-red-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Ye,{className:"h-2 w-2 text-red-600"}),t.jsx("span",{className:"text-[10px] text-red-800",children:"سحب"})]}),t.jsx("span",{className:"text-[10px] font-bold text-red-700",children:D(L.dailyWithdraw)})]}),t.jsxs("div",{className:"flex items-center justify-between bg-green-50 p-0.5 rounded border border-green-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(It,{className:"h-2 w-2 text-green-600"}),t.jsx("span",{className:"text-[10px] text-green-800",children:"تحويل"})]}),t.jsx("span",{className:"text-[10px] font-bold text-green-700",children:D(L.dailyTransfer)})]})]})]}),t.jsxs("div",{className:"bg-purple-50 p-1 rounded border border-purple-200 sm:bg-gradient-to-r sm:from-purple-50 sm:to-purple-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Bt,{className:"h-2 w-2 text-purple-600"}),t.jsx("span",{className:"text-[10px] font-semibold text-purple-800",children:"شهري"})]}),t.jsx("span",{className:"text-[10px] font-bold text-purple-900",children:D((L.monthlyWithdraw??0)+(L.monthlyTransfer??0))})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-1",children:[t.jsxs("div",{className:"flex items-center justify-between bg-red-50 p-0.5 rounded border border-red-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Ye,{className:"h-2 w-2 text-red-600"}),t.jsx("span",{className:"text-[10px] text-red-800",children:"سحب"})]}),t.jsx("span",{className:"text-[10px] font-bold text-red-700",children:D(L.monthlyWithdraw)})]}),t.jsxs("div",{className:"flex items-center justify-between bg-blue-50 p-0.5 rounded border border-blue-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(It,{className:"h-2 w-2 text-blue-600"}),t.jsx("span",{className:"text-[10px] text-blue-800",children:"تحويل"})]}),t.jsx("span",{className:"text-[10px] font-bold text-blue-700",children:D(L.monthlyTransfer)})]})]})]})]}),!P&&t.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:t.jsx(S,{size:"sm",variant:"ghost",onClick:()=>E(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:t.jsx(Rt,{className:"h-4 w-4"})})}),t.jsx("div",{className:"flex justify-center pt-1 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:t.jsx(S,{onClick:()=>u(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-4 py-1 rounded-xl text-xs sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),t.jsx(Xe,{open:O,onOpenChange:E,onSuccess:ne,description:"لا يمكن الاطلاع على إجمالي الأرباح إلا بإدخال الرقم السري الرئيسي"})]})},Ta=y=>t.jsx(wa,{...y}),Xa=()=>{var bt,yt,jt,Nt,wt,Tt,Ct,At,Dt;const y=Es(),{user:a,profile:g,userSubscription:u}=Mt(),O=ue.useMemo(()=>{var i,o,n,s;const e=((i=u==null?void 0:u.subscription)==null?void 0:i.planType)??((o=u==null?void 0:u.subscription)==null?void 0:o.plan)??((n=g==null?void 0:g.subscription)==null?void 0:n.planType)??((s=g==null?void 0:g.subscription)==null?void 0:s.plan)??null;return e===G.ZERO||String(e).toLowerCase()==="zero"},[(bt=u==null?void 0:u.subscription)==null?void 0:bt.planType,(yt=u==null?void 0:u.subscription)==null?void 0:yt.plan,(jt=g==null?void 0:g.subscription)==null?void 0:jt.planType,(Nt=g==null?void 0:g.subscription)==null?void 0:Nt.plan]),E=ue.useMemo(()=>{var i,o,n,s;const e=((i=u==null?void 0:u.subscription)==null?void 0:i.planType)??((o=u==null?void 0:u.subscription)==null?void 0:o.plan)??((n=g==null?void 0:g.subscription)==null?void 0:n.planType)??((s=g==null?void 0:g.subscription)==null?void 0:s.plan)??null;return e===G.TAHWEELA||String(e).toLowerCase()==="tahweela"},[(wt=u==null?void 0:u.subscription)==null?void 0:wt.planType,(Tt=u==null?void 0:u.subscription)==null?void 0:Tt.plan,(Ct=g==null?void 0:g.subscription)==null?void 0:Ct.planType,(At=g==null?void 0:g.subscription)==null?void 0:At.plan]),{shopName:P}=Is(),{isShiftActive:z,shiftUser:L}=_s(),[R,C]=d.useState([]),[D,B]=d.useState([]),[ie,ne]=d.useState(new Set),[_e,T]=d.useState(!1),[p,A]=d.useState(null),[$,Le]=d.useState("all"),[Q,oe]=d.useState(""),[K,ve]=d.useState(""),[Z,M]=d.useState(""),[le,H]=d.useState(!1),[ee,I]=d.useState(!1),[es,Je]=d.useState(!1),[ts,Qe]=d.useState(!1),[et,tt]=d.useState(""),[ss,st]=d.useState("شرح التطبيق"),[Ca,at]=d.useState(null),[ce,as]=d.useState(null),[ns,be]=d.useState(!1);ue.useEffect(()=>{var i;((i=u==null?void 0:u.subscription)==null?void 0:i.planType)===G.TAHWEELA&&(w({title:"غير متاح لاشتراكك",description:"صفحة المعاملات غير متاحة في باقة تحويله. استخدم لوحة المستخدم للتحويل/السحب فقط.",variant:"destructive"}),y("/user/dashboard"))},[(Dt=u==null?void 0:u.subscription)==null?void 0:Dt.planType]);const[Aa,rs]=d.useState(!1),[Da,is]=d.useState(!1),[Sa,Ra]=d.useState(!1),[os,Me]=d.useState(!1),[ls,nt]=d.useState(!1),[cs,rt]=d.useState(!1),[ds,We]=d.useState(!1),[ms,us]=d.useState(null),[ps,ye]=d.useState(!1),[it,je]=d.useState({keepLastCount:30,intervalDays:7,lastResetAt:null});d.useEffect(()=>{(async()=>{if(a!=null&&a.uid)try{const i=await U.getUserData(a.uid),o=(i==null?void 0:i.recentReset)||{},n=Number(o==null?void 0:o.keepLastCount)>0?Number(o.keepLastCount):30,s=Number(o==null?void 0:o.intervalDays)>0?Number(o.intervalDays):7,r=x=>x instanceof Date?x:typeof(x==null?void 0:x.toDate)=="function"?x.toDate():x?new Date(String(x)):null,m=o!=null&&o.lastResetAt?r(o.lastResetAt):null,h=new Date;!m||h.getTime()-m.getTime()>=s*24*60*60*1e3?(await U.updateUserData(a.uid,{recentReset:{keepLastCount:n,intervalDays:s,lastResetAt:h}}),je({keepLastCount:n,intervalDays:s,lastResetAt:h})):je({keepLastCount:n,intervalDays:s,lastResetAt:m})}catch{je({keepLastCount:30,intervalDays:7,lastResetAt:null})}})()},[a==null?void 0:a.uid]),d.useEffect(()=>{if(!(a!=null&&a.uid))return;const e=J(W,"users",a.uid),i=te(e,o=>{try{const n=o.exists()?o.data():{},s=n==null?void 0:n.tutorialSeenAt,r=s!=null&&s.toDate?s.toDate():s?new Date(s):null;as(r)}catch{}});return()=>i()},[a==null?void 0:a.uid]),d.useEffect(()=>{const e=te(J(W,"app_guides","latest"),i=>{try{const o=i.exists()?i.data():null;if(!o){tt(""),st(""),at(null),be(!1);return}const n=String(o.url||""),s=String(o.title||"شرح التطبيق"),r=o.publishedAt,m=r!=null&&r.toDate?r.toDate():r?new Date(r):new Date;tt(n),st(s),at(m),be(m?!ce||m.getTime()>((ce==null?void 0:ce.getTime())||0):!1)}catch{be(!1)}},i=>{console.warn("فشل الاشتراك في دليل التطبيق:",i)});return()=>e()},[ce]);const hs=e=>{try{const i=new URL(e);let o="";return i.hostname.includes("youtube.com")?i.pathname==="/watch"?o=i.searchParams.get("v")||"":(i.pathname.startsWith("/embed/")||i.pathname.startsWith("/shorts/"))&&(o=i.pathname.split("/").pop()||""):i.hostname==="youtu.be"&&(o=i.pathname.replace(/^\//,"")),o?`https://www.youtube.com/embed/${o}?autoplay=1&rel=0`:e}catch{return e}},xs=async()=>{Qe(!0);try{a!=null&&a.uid&&await U.updateUserData(a.uid,{tutorialSeenAt:new Date}),be(!1)}catch{}},[fs,Ne]=d.useState(!1),[we,ot]=d.useState(""),[de,lt]=d.useState(""),[Te,ct]=d.useState(""),[dt,mt]=d.useState(!1),[ut,Ce]=d.useState(0);d.useEffect(()=>{if(!(a!=null&&a.uid)){Ce(0);return}const e=J(W,"users",a.uid),i=te(e,o=>{try{const n=o.exists()?o.data():{},r=(Array.isArray(n==null?void 0:n.debts)?n.debts:[]).filter(m=>(m==null?void 0:m.status)==="pending"&&(Number(m==null?void 0:m.amount)||0)>0).length;Ce(r)}catch{Ce(0)}},o=>{console.warn("فشل الاشتراك في ديون المستخدم من Firestore:",o),Ce(0)});return()=>i()},[a==null?void 0:a.uid]),d.useEffect(()=>{gs(),vs()},[a]),d.useEffect(()=>{if(!(a!=null&&a.uid))return;let e=null,i=null;try{const o=se(ae(W,"deletedTransactions"),Y("userId","==",a.uid));e=te(o,n=>{try{const s=[];n.docChanges().forEach(r=>{const m=r.doc.data(),h=[m.originalTransactionId,m.transactionId,m.reference,r.doc.id].filter(Boolean).map(b=>String(b));s.push(...h)}),s.length>0&&(ne(r=>{const m=new Set(r);return s.forEach(h=>m.add(h)),m}),C(r=>r.filter(m=>{const h=String(m.id||""),b=String(m.transactionId||""),x=String(m.reference||"");return!(s.includes(h)||s.includes(b)||s.includes(x))})))}catch(s){console.warn("deletedTransactions snapshot handling failed:",s)}},n=>{console.warn("deletedTransactions subscription error:",n)});try{i=U.subscribeDeletedTransactionsLocalSync(a.uid)}catch{}}catch{}return()=>{try{e&&e()}catch{}try{i&&i()}catch{}}},[a==null?void 0:a.uid]),d.useEffect(()=>{(async()=>{try{if(!(a!=null&&a.uid)){ne(new Set);return}const e=se(ae(W,"deletedTransactions"),Y("userId","==",a.uid),Y("permanent","==",!0)),o=(await Pt(e)).docs.flatMap(n=>{const s=n.data();return[s.originalTransactionId,s.transactionId,s.reference,n.id].filter(Boolean).map(String)});ne(new Set(o))}catch{ne(new Set)}})()},[a==null?void 0:a.uid]),d.useEffect(()=>{if(!(a!=null&&a.uid))return;let e=null,i=!1;const o=s=>{const m=s.map(l=>{const c=l.data(),v=c==null?void 0:c.createdAt,f=v!=null&&v.toDate?v.toDate():v instanceof Date?v:new Date(v);return{id:l.id,...c,createdAt:f}}).filter(l=>(l==null?void 0:l.status)!=="cancelled"&&!(l!=null&&l.isDeleted)).filter(l=>!((l==null?void 0:l.type)==="report"||((l==null?void 0:l.title)||"").includes("إيصال تسليم وردية"))).sort((l,c)=>{const v=l.createdAt?new Date(l.createdAt).getTime():0;return(c.createdAt?new Date(c.createdAt).getTime():0)-v}).filter(l=>{const c=String(l.id||""),v=String(l.transactionId||""),f=String(l.reference||l.transactionReference||"");return!ie.has(c)&&(!v||!ie.has(v))&&(!f||!ie.has(f))}),h=a!=null&&a.uid?U.getLocalReceipts(a.uid):[],b=[...m,...Array.isArray(h)?h:[]],x=l=>{var c;return String((l==null?void 0:l.transactionId)||(l==null?void 0:l.id)||(l==null?void 0:l.reference)||(l==null?void 0:l.transactionReference)||((c=l==null?void 0:l.receipt)==null?void 0:c.reference)||`${new Date((l==null?void 0:l.createdAt)||Date.now()).getTime()}`)},N=new Set,k=b.filter(l=>{const c=x(l);return N.has(c)?!1:(N.add(c),!0)});C(k.map(Fe))},n=()=>{const s=se(ae(W,"userTransactions"),Y("userId","==",a.uid));e=te(s,r=>{try{o(r.docs)}catch(m){console.error("خطأ في معالجة بيانات الاشتراك الاحتياطي:",m)}},r=>{console.error("خطأ في الاشتراك الاحتياطي لمعاملات المستخدم:",r)})};(async()=>{try{const s=se(ae(W,"userTransactions"),Y("userId","==",a.uid)),r=await Ls(s);if(r&&r.docs&&r.docs.length>0)try{o(r.docs)}catch{}}catch{}})();try{const s=se(ae(W,"userTransactions"),Y("userId","==",a.uid),Ms("createdAt","desc"),Ws(200));try{e=te(s,{includeMetadataChanges:!0},r=>{try{o(r.docs)}catch(m){console.error("خطأ في معالجة بيانات الاشتراك:",m)}},r=>{if(console.error("خطأ في الاشتراك لمعاملات المستخدم:",r),!i){i=!0;try{e&&e()}catch{}n()}})}catch{const m=se(ae(W,"userTransactions"),Y("userId","==",a.uid));e=te(m,h=>{try{o(h.docs)}catch{}},h=>{console.error("خطأ في الاشتراك البسيط لمعاملات المستخدم:",h),i||(i=!0,n())})}}catch(s){console.error("فشل إعداد الاشتراك الفوري لمعاملات المستخدم، بدء السقوط الاحتياطي:",s),n()}return()=>{try{e&&e()}catch{}}},[a==null?void 0:a.uid]);const gs=async()=>{try{if(!a)return;const e=se(ae(W,"deletedTransactions"),Y("userId","==",a.uid),Y("permanent","==",!0)),[i,o,n]=await Promise.all([U.getUserTransactions(a.uid).catch(()=>[]),U.getByUserId(a.uid).catch(()=>[]),Pt(e).then(c=>c.docs.flatMap(v=>{const f=v.data();return[f.originalTransactionId,f.transactionId,f.reference,v.id].filter(Boolean).map(String)})).catch(()=>[])]),s=Array.isArray(i)&&i.length>0?i:Array.isArray(o)?o:[],r=new Set(n),h=(s||[]).map(c=>({...c,createdAt:c.createdAt instanceof Date?c.createdAt:new Date(c.createdAt)})).filter(c=>!((c==null?void 0:c.type)==="report"||((c==null?void 0:c.title)||"").includes("إيصال تسليم وردية"))).filter(c=>{const v=String(c.id||""),f=String(c.transactionId||""),j=String(c.reference||c.transactionReference||"");return!r.has(v)&&(!f||!r.has(f))&&(!j||!r.has(j))}),b=a!=null&&a.uid?U.getLocalReceipts(a.uid):[],x=[...h,...Array.isArray(b)?b:[]],N=c=>{var v;return String((c==null?void 0:c.transactionId)||(c==null?void 0:c.id)||(c==null?void 0:c.reference)||(c==null?void 0:c.transactionReference)||((v=c==null?void 0:c.receipt)==null?void 0:v.reference)||`${new Date((c==null?void 0:c.createdAt)||Date.now()).getTime()}`)},k=new Set,l=x.filter(c=>{const v=N(c);return k.has(v)?!1:(k.add(v),!0)});C(l.map(Fe))}catch(e){console.error("خطأ في تحميل معاملات المستخدم من Firestore:",e),w({title:"فشل جلب معاملات المستخدم",description:"قد تكون المشكلة صلاحيات Firestore أو اتصال الشبكة. سيتم عرض المتاح محليًا إن وُجد. جرّب تسجيل الدخول مجددًا أو افتح صفحة اختبار المصادقة.",variant:"destructive"})}},vs=async()=>{try{if(!a)return;const i=(await pe.getDeletedTransactionsByUser(a.uid)).map(o=>({...o,createdAt:o.createdAt instanceof Date?o.createdAt:new Date(o.createdAt)}));B(i.map(Fe))}catch(e){console.error("خطأ في تحميل المعاملات المحذوفة من Firestore:",e),w({title:"فشل جلب المعاملات المحذوفة",description:"تحقق من الصلاحيات والاتصال. يمكن مراجعة صفحة اختبار المصادقة للتشخيص.",variant:"destructive"})}},me=ue.useMemo(()=>{const e=new Date,i=new Date(e.getFullYear(),e.getMonth(),1),o=new Date(e.getFullYear(),e.getMonth()+1,1);return[...R].sort((s,r)=>r.createdAt.getTime()-s.createdAt.getTime()).filter(s=>s.createdAt>=i&&s.createdAt<o)},[R]),bs=ue.useMemo(()=>{const e=new Date,i=new Date(e.getFullYear(),e.getMonth(),1),o=new Date(e.getFullYear(),e.getMonth()+1,1);return Math.max(0,((R==null?void 0:R.length)||0)-(R||[]).filter(n=>n.createdAt>=i&&n.createdAt<o).length)},[R==null?void 0:R.length]),pt=me.filter(e=>{const i=!Q||e.senderPhone.includes(Q)||e.receiverPhone.includes(Q),o=!K||e.createdAt.toDateString()===new Date(K).toDateString(),n=!Z||e.createdAt.toTimeString().startsWith(Z);return i&&o&&n}),ht=(e,i)=>{switch(e){case"completed":return t.jsx(ha,{className:`h-4 w-4 ${i==="withdraw"?"text-red-500":"text-green-500"}`});case"pending":return t.jsx(xe,{className:"h-4 w-4 text-yellow-500"});case"cancelled":return t.jsx(pa,{className:"h-4 w-4 text-red-500"});default:return t.jsx(xe,{className:"h-4 w-4 text-gray-500"})}},Be=e=>{switch(e){case"completed":return"مكتمل";case"pending":return"قيد المراجعة";case"cancelled":return"ملغي";default:return"غير معروف"}},Fe=e=>{const i=((e==null?void 0:e.status)??"").toString().toLowerCase(),o=i==="confirmed"||i==="success"||i==="completed"?"completed":i==="failed"||i==="error"||i==="cancelled"||i==="canceled"?"cancelled":"pending",s=((e==null?void 0:e.type)??(e==null?void 0:e.txnType)??"").toString().toLowerCase()==="withdraw"?"withdraw":"send",r=(e==null?void 0:e.senderPhone)??(e==null?void 0:e.senderMsisdn)??(e==null?void 0:e.sender_msisdn)??(e==null?void 0:e.sender)??(e==null?void 0:e.from)??"",m=(e==null?void 0:e.receiverPhone)??(e==null?void 0:e.receiverMsisdn)??(e==null?void 0:e.receiver_msisdn)??(e==null?void 0:e.receiver)??(e==null?void 0:e.to)??"",h=e==null?void 0:e.createdAt,b=h instanceof Date?h:h!=null&&h.toDate?h.toDate():new Date(h);return{id:e==null?void 0:e.id,senderPhone:r||"غير معروف",receiverPhone:m||"غير معروف",amount:Number((e==null?void 0:e.amount)??0),status:o,type:s,createdAt:b,provider:(e==null?void 0:e.provider)??void 0,commission:(e==null?void 0:e.commission)??void 0,withdrawnAmount:(e==null?void 0:e.withdrawnAmount)??void 0,sentAmount:(e==null?void 0:e.sentAmount)??void 0,fromWallet:(e==null?void 0:e.fromWallet)??(e==null?void 0:e.walletId)??void 0,cashierName:(e==null?void 0:e.cashierName)??(e==null?void 0:e.createdByName)??(e==null?void 0:e.cashier)??void 0,commissionMode:(e==null?void 0:e.commissionMode)??(e==null?void 0:e.commission_mode)??void 0,totalCharged:(e==null?void 0:e.totalCharged)??void 0,walletEffectAppliedOnCreation:(e==null?void 0:e.walletEffectAppliedOnCreation)??(e==null?void 0:e.effectsAppliedOnCreation)??(e==null?void 0:e.effectAppliedOnCreation)??!1,cashEffectAppliedOnCreation:(e==null?void 0:e.cashEffectAppliedOnCreation)??!1,fee:(e==null?void 0:e.fee)??void 0,senderName:(e==null?void 0:e.senderName)??(e==null?void 0:e.customerName)??void 0}},ys=e=>{const i=String((e==null?void 0:e.provider)||"").toLowerCase(),o=i.includes("vodafone")?"vf-cash":i.includes("instapay")?"instapay":"",n=e.type==="send"?"تحويل":"سحب",s=e.type==="withdraw"&&o?`${n} ${o}`:n;return{id:e.id,type:e.type==="send"?"transfer":"withdraw",sender_msisdn:e.senderPhone,receiver_msisdn:e.receiverPhone,amount:e.amount,commission:e.commission||0,status:e.status==="cancelled"?"failed":e.status,createdAt:e.createdAt.toISOString(),updatedAt:e.createdAt.toISOString(),shopName:P??(g==null?void 0:g.shopName)??(a==null?void 0:a.displayName)??"المحل",cashierName:(e==null?void 0:e.cashierName)??null,commissionMode:(e==null?void 0:e.commissionMode)??void 0,totalCharged:(e==null?void 0:e.totalCharged)??void 0,fee:(e==null?void 0:e.fee)??void 0,note:(e==null?void 0:e.note)??(e==null?void 0:e.notes)??void 0,senderName:(e==null?void 0:e.senderName)??void 0,provider:(e==null?void 0:e.provider)??void 0,title:s}},Ue=e=>{const i=ys(e);us(i),We(!0)},js=e=>{A(e),T(!0)},Ns=async()=>{p&&(await ws(p.id),T(!1),A(null))},ws=async e=>{try{const i=D.find(s=>s.id===e);if(!i||!a)return;const o=await U.saveUserTransaction(a.uid,{...i,userId:a.uid,status:"completed",cashierName:i.cashierName??"الحساب الرئيسي"});await pe.permanentlyDeleteTransaction(e,a.uid);const n={...i,id:o};C(s=>[...s,n]),B(s=>s.filter(r=>r.id!==e)),w({title:"تم الاسترجاع",description:"تم استرجاع الإيصال إلى حسابك."})}catch(i){console.error("خطأ في استرجاع المعاملة من Firestore:",i),w({title:"فشل الاسترجاع",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}},Ts=async e=>{try{if(!a)return;B(i=>i.filter(o=>o.id!==e)),await pe.permanentlyDeleteTransaction(e,a.uid),await U.removeUserTransaction(a.uid,e),w({title:"تم الحذف نهائيًا",description:"الإيصال لن يعود بعد التحديث."})}catch(i){console.error("فشل الحذف النهائي للمعاملة:",i),w({title:"خطأ في الحذف النهائي",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}},xt=async e=>{var i,o,n;try{const s=R.find(f=>f.id===e);if(!s||!a)return;try{const f=(i=u==null?void 0:u.subscription)==null?void 0:i.planType;if(f===G.ZERO){const{dailyOperationCountService:j}=await V(async()=>{const{dailyOperationCountService:X}=await import("./dailyOperationCountService-Cggs5ihI.js");return{dailyOperationCountService:X}},__vite__mapDeps([0,1,2]),import.meta.url),_=s.type==="send"?"transfer":"withdraw";if(!(await j.checkAndIncrement(a.uid,_,5)).allowed){w({title:"تم بلوغ حد باقة الزيرو",description:"مسموح بحد أقصى 5 تأكيدات يوميًا للتحويل/السحب. جرّب غدًا أو قم بالترقية.",variant:"destructive"});return}}else if(f===G.TAHWEELA){const{dailyOperationCountService:j}=await V(async()=>{const{dailyOperationCountService:X}=await import("./dailyOperationCountService-Cggs5ihI.js");return{dailyOperationCountService:X}},__vite__mapDeps([0,1,2]),import.meta.url),_=s.type==="send"?"transfer":"withdraw";if(!(await j.checkAndIncrementCombined(a.uid,_,40)).allowed){w({title:"تم بلوغ حد باقة تحويله",description:"هذه الباقة تسمح بحد أقصى 40 عملية تحويل/سحب يومياً.",variant:"destructive"});return}}}catch(f){console.warn("تعذر التحقق من حد التأكيد اليومي:",f)}const r=await Ge.getById(a.uid);if(!(r!=null&&r.shopId))throw new Error("لا يمكن تحديد معرف المتجر (shopId) للمستخدم");const m=J(W,"dashboardData",r.shopId),h=await re(m);let b=h.exists()?Number(((o=h.data())==null?void 0:o.cashBalance)||0):0;const x=h.exists()?((n=h.data())==null?void 0:n.walletBalances)||{}:{},N=s.fromWallet||Object.keys(x)[0],k=!!(s!=null&&s.limitsReservedOnCreation),l=Number(s.withdrawnAmount??s.sentAmount??s.amount??0),c=s.type==="send"?"transfer":"withdraw";try{const{walletDailyLimitsService:f}=await V(async()=>{const{walletDailyLimitsService:_}=await import("./index-BajlLdY5.js").then(F=>F.ca);return{walletDailyLimitsService:_}},__vite__mapDeps([1,2]),import.meta.url),j=await f.canPerformOperation(N,l,c);if(!k&&!j.canPerform){w({title:"تجاوز الحدود",description:String(j.message||"لا يمكن الإكمال لتجاوز الحد اليومي/الشهري"),variant:"destructive"});return}}catch{w({title:"فشل التحقق من الحدود",description:"حاول مجددًا بعد قليل",variant:"destructive"});return}let v=!1;if(s.type==="withdraw"){const f=s.fromWallet||Object.keys(x)[0],j=Number(s.withdrawnAmount??s.amount??0),_=Number(s.commission??0),F=!!(s!=null&&s.walletEffectAppliedOnCreation),X=!!(s!=null&&s.cashEffectAppliedOnCreation);if(!F&&f&&j>0){const ze=x[f]||0;x[f]=ze+j}X?b=b+j:b=b-j,v=!0,await De(m,{cashBalance:b,walletBalances:x})}else if(s.type==="send"){const f=Number(s.commission??0),j=Number((s==null?void 0:s.fee)??0),_=Number((s==null?void 0:s.sentAmount)??(s==null?void 0:s.transferredAmount)??s.amount??0),F=Math.max(0,_)+Math.max(0,j);F>0&&(b=b+F,await De(m,{cashBalance:b}),v=!0)}await De(J(W,"userTransactions",e),{status:"completed",confirmedAt:new Date});try{const f=s.fromWallet||Object.keys(x)[0],j=Number(s.withdrawnAmount??s.sentAmount??s.amount??0);if(f&&j>0&&!k){const{walletDailyLimitsService:_}=await V(async()=>{const{walletDailyLimitsService:F}=await import("./index-BajlLdY5.js").then(X=>X.ca);return{walletDailyLimitsService:F}},__vite__mapDeps([1,2]),import.meta.url);await _.updateUsage(f,j,s.type==="send"?"transfer":"withdraw")}}catch{w({title:"فشل تحديث الحدود",description:"تجاوز حد اليوم/الشهر يمنع الإكمال",variant:"destructive"});return}try{const{ProfitService:f}=await V(async()=>{const{ProfitService:F}=await import("./profitService-BsJiOlFZ.js");return{ProfitService:F}},__vite__mapDeps([3,1,2]),import.meta.url),j=f.calculateProfitFromTransaction({type:s.type==="send"?"transfer":"withdraw",amount:Number(s.amount||0),commission:Number(s.commission||0),fee:Number((s==null?void 0:s.fee)||0)});!!!(s!=null&&s.profitAddedOnCreation)&&j>0&&f.addProfit(j,a==null?void 0:a.uid)}catch{}C(f=>f.map(j=>j.id===e?{...j,status:"completed"}:j)),w({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),We(!1)}catch(s){console.error("خطأ في إكمال المعاملة:",s),w({title:"فشل الإكمال",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}},ft=async e=>{var i,o;try{const n=R.find(r=>r.id===e);if(!n||!a)return;C(r=>r.filter(m=>m.id!==e)),B(r=>[{...n},...r]);let s=n.status;try{let r={};try{const x=await re(J(W,"userTransactions",e));if(r=x.exists()?x.data():{},r!=null&&r.status){const N=String(r.status).toLowerCase();N==="completed"||N==="confirmed"||N==="success"?s="completed":N==="pending"?s="pending":(N==="cancelled"||N==="failed")&&(s="cancelled")}}catch{}const m=e,h=String((r==null?void 0:r.transactionId)||(n==null?void 0:n.transactionId)||m),b=String((r==null?void 0:r.reference)||(r==null?void 0:r.transactionReference)||(n==null?void 0:n.reference)||(n==null?void 0:n.transactionReference)||"");await U.removeUserTransaction(a.uid,e),await pe.saveDeletedTransaction({...n,userId:a.uid,originalTransactionId:e,transactionId:h,reference:b||void 0,permanent:!0});try{await pe.permanentlyDeleteTransaction(e,a.uid)}catch{}}catch(r){console.warn("تعذر الحذف النهائي من قواعد البيانات في هذه الخطوة، سيتم الحذف من لائحة المحذوفات عند التنفيذ اليدوي للحذف النهائي:",r)}try{const r=await Ge.getById(a.uid);if(!(r!=null&&r.shopId))throw new Error("لا يمكن تحديد معرف المتجر (shopId) للمستخدم");const m=J(W,"dashboardData",r.shopId),h=await re(m);let b=h.exists()?Number(((i=h.data())==null?void 0:i.cashBalance)||0):0;const x=h.exists()?((o=h.data())==null?void 0:o.walletBalances)||{}:{},N=Number(n.withdrawnAmount??n.amount??0),k=Number(n.commission??0),l=n.fromWallet||Object.keys(x)[0],c=!!(n!=null&&n.walletEffectAppliedOnCreation);if(n.type==="send"){const v=Number(n.fee??0),f=Number((n==null?void 0:n.sentAmount)??(n==null?void 0:n.transferredAmount)??n.amount??0);if(s==="completed"&&(b=b-(f+v)),l&&f>0){const j=x[l]||0;x[l]=j+f}}else if(n.type==="withdraw"){if(s==="completed"){if(b=b+N,l&&N>0){const v=x[l]||0;x[l]=v-N}}else if(l&&c&&N>0){const v=x[l]||0;x[l]=v-N}}await De(m,{cashBalance:b,walletBalances:x})}catch(r){console.warn("فشل عكس تأثير الأرصدة محليًا:",r)}try{const r=n.fromWallet;if(r){const{walletDailyLimitsService:m}=await V(async()=>{const{walletDailyLimitsService:b}=await import("./index-BajlLdY5.js").then(x=>x.ca);return{walletDailyLimitsService:b}},__vite__mapDeps([1,2]),import.meta.url),h=await m.getWalletLimits(r);if(h){const b=n.type==="send",x={updatedAt:(await V(async()=>{const{serverTimestamp:v}=await import("./index-BajlLdY5.js").then(f=>f.c4);return{serverTimestamp:v}},__vite__mapDeps([1,2]),import.meta.url)).serverTimestamp()};b?(x.dailyTransferUsed=Math.max(0,(h.dailyTransferUsed||0)-n.amount),x.monthlyTransferUsed=Math.max(0,(h.monthlyTransferUsed||0)-n.amount)):(x.dailyWithdrawUsed=Math.max(0,(h.dailyWithdrawUsed||0)-n.amount),x.monthlyWithdrawUsed=Math.max(0,(h.monthlyWithdrawUsed||0)-n.amount));const{doc:N,setDoc:k}=await V(async()=>{const{doc:v,setDoc:f}=await import("./index-BajlLdY5.js").then(j=>j.c4);return{doc:v,setDoc:f}},__vite__mapDeps([1,2]),import.meta.url),{db:l}=await V(async()=>{const{db:v}=await import("./index-BajlLdY5.js").then(f=>f.c5);return{db:v}},__vite__mapDeps([1,2]),import.meta.url),c=N(l,"walletLimits",r);await k(c,x,{merge:!0})}}}catch(r){console.warn("فشل استرجاع حدود المحفظة:",r)}try{const{ProfitService:r}=await V(async()=>{const{ProfitService:N}=await import("./profitService-BsJiOlFZ.js");return{ProfitService:N}},__vite__mapDeps([3,1,2]),import.meta.url),{ReportsService:m}=await V(async()=>{const{ReportsService:N}=await import("./index-BajlLdY5.js").then(k=>k.c9);return{ReportsService:N}},__vite__mapDeps([1,2]),import.meta.url),b={txnType:n.type==="send"?"send":"receive",amount:n.amount,commission:n.commission||0,createdAt:n.createdAt,status:"confirmed"},x=r.calculateProfitFromTransaction(b);x>0&&r.addProfit(-x,a.uid);try{m.removeTransactionEffects(n,a.uid)}catch{}}catch(r){console.warn("فشل تحديث التقارير/الأرباح بعد الحذف:",r)}}catch(n){console.error("خطأ أثناء حذف الإيصال:",n)}},gt=d.useRef(!1),vt=Bs();d.useEffect(()=>{!(new URLSearchParams(vt.search).get("autoTestBalances")==="1")||gt.current||(gt.current=!0,(async()=>{var o,n,s,r,m,h;try{if(!a)return;const b=await Ge.getById(a.uid);if(!(b!=null&&b.shopId)){console.warn("autoTest: لا يوجد shopId للمستخدم، سيتم إيقاف الاختبار.");return}const x=J(W,"dashboardData",b.shopId),N=await re(x),k=N.exists()?Number(((o=N.data())==null?void 0:o.cashBalance)||0):0,l=N.exists()?((n=N.data())==null?void 0:n.walletBalances)||{}:{},c=Object.keys(l)[0]||void 0,v=100,f=5,j=await U.saveUserTransaction(a.uid,{senderPhone:"auto-test-sender",receiverPhone:"auto-test-receiver",amount:v,status:"pending",type:"withdraw",createdAt:new Date,reference:`AUTO-${Date.now()}`,commission:f,withdrawnAmount:v,fromWallet:c,cashierName:"AutoTest",commissionMode:"add",totalCharged:v+f,walletEffectAppliedOnCreation:!1});console.log("autoTest: تم إنشاء إيصال سحب تجريبي:",j),await xt(j);const _=await re(x),F=_.exists()?Number(((s=_.data())==null?void 0:s.cashBalance)||0):0,X=_.exists()?((r=_.data())==null?void 0:r.walletBalances)||{}:{},ze=k-v+f,As=c?Number(l[c]||0)+v:void 0;console.log("autoTest: توقع الدرج بعد الإكمال:",ze,"فعلي:",F),c&&console.log("autoTest: توقع المحفظة بعد الإكمال:",As,"فعلي:",X[c]),await ft(j);const Ae=await re(x),Ds=Ae.exists()?Number(((m=Ae.data())==null?void 0:m.cashBalance)||0):0,Ss=Ae.exists()?((h=Ae.data())==null?void 0:h.walletBalances)||{}:{};console.log("autoTest: تحقق نهائي — الدرج قبل/بعد الحذف:",k,Ds),c&&console.log("autoTest: تحقق نهائي — المحفظة قبل/بعد الحذف:",l[c]||0,Ss[c]||0),w({title:"اختبار الأرصدة (Firestore فقط)",description:"تم إنشاء/إكمال/حذف إيصال تجريبي والتحقق من الأرصدة.",variant:"default"})}catch(b){console.error("autoTest: فشل اختبار الأرصدة:",b),w({title:"فشل اختبار الأرصدة",description:"تحقق من الاتصال ووجود shopId والمحافظ في Firestore.",variant:"destructive"})}})())},[vt.search,a]);const Cs=async()=>{var o,n,s;const e="alkaptin678678@gmail.com",i=(n=(o=He.currentUser)==null?void 0:o.email)==null?void 0:n.toLowerCase();if(!i||i!==e){w({title:"قيد الإنشاء",description:"ميزة الشحن متاحة لهذا الحساب فقط حالياً."});return}if(!we||!de||!Te){w({title:"بيانات ناقصة",description:"يرجى إدخال رقم وشركة والمبلغ",variant:"destructive"});return}mt(!0);try{const m={vodafone_eg:"Vodafone",orange_eg:"Orange",etisalat_eg:"Etisalat",we_eg:"WE"}[de]??de,h=new AbortController,b=setTimeout(()=>h.abort(),15e3),x=await((s=He.currentUser)==null?void 0:s.getIdToken()),N=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...x?{Authorization:`Bearer ${x}`}:{}},body:JSON.stringify({phone:we,countryCode:"EG",operator:m,amount:Number(Te),useLocalAmount:!0}),signal:h.signal});clearTimeout(b);const k=await N.text();let l;try{l=JSON.parse(k)}catch{l={success:!1,message:k||"فشل قراءة استجابة الخادم"}}N.ok&&(l!=null&&l.success)?(w({title:"تم الشحن",description:(l==null?void 0:l.message)||"تم تنفيذ عملية الشحن بنجاح"}),Ne(!1),ot(""),lt(""),ct("")):w({title:"فشل الشحن",description:(l==null?void 0:l.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(r){console.error("Topup request error:",r),(r==null?void 0:r.name)==="AbortError"?w({title:"انتهت المهلة",description:"الخادم لم يستجب في الوقت المحدد. تأكد أن السيرفر يعمل.",variant:"destructive"}):w({title:"خطأ في الاتصال",description:"تعذر الاتصال بالخادم. حاول لاحقاً.",variant:"destructive"})}finally{mt(!1)}};return t.jsxs("div",{className:"fixed inset-0 overscroll-y-none overflow-y-auto bg-background p-4",children:[t.jsxs("div",{className:"max-w-4xl mx-auto",children:[t.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[t.jsxs(S,{variant:"ghost",size:"sm",onClick:()=>y("/user/dashboard"),className:"flex items-center gap-2 text-gray-600 hover:text-gray-800",children:[t.jsx(ua,{className:"h-4 w-4"}),"العودة"]}),t.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"المعاملات"})]}),t.jsxs(Vs,{className:"card-modern fade-in-up",children:[t.jsxs(Gs,{className:"pb-2 px-3 pt-3",children:[t.jsx(qs,{className:"text-sm font-bold",children:"المعاملات الأخيرة"}),t.jsxs("div",{className:"flex items-center gap-0.5 mt-1 relative",children:[t.jsxs("div",{className:"flex items-center gap-0.5 flex-1 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[t.jsx(ma,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),t.jsx(qe,{placeholder:"بحث...",value:Q,onChange:e=>oe(e.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),t.jsxs("div",{className:"hidden md:flex items-center gap-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"relative h-5 w-5 p-0 rounded bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 hover:border-red-300 transition-all duration-200 hover:scale-105",onClick:xs,title:"شرح التطبيق",children:t.jsxs("div",{className:"relative inline-flex items-center justify-center h-full w-full",children:[t.jsx(va,{className:"h-2.5 w-2.5"}),ns&&t.jsx("div",{className:"absolute -top-0.5 -right-0.5 h-1 w-1 bg-red-600 rounded-full"})]})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"شرح"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 hover:border-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(O||E){w({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"});return}I(!0)},title:"إدارة التقسيط",children:t.jsx(Fs,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"تقسيط"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Ta,{userId:a==null?void 0:a.uid,transactions:R}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"أرباح"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-emerald-50 text-emerald-600 hover:bg-emerald-100 border border-emerald-200 hover:border-emerald-300 transition-all duration-200 hover:scale-105",onClick:()=>{w({title:"قيد الإنشاء",description:"هذه الميزة قيد الإنشاء حالياً."})},title:"نافذة شحن سريعة",children:t.jsx(Ot,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"شحن"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 hover:border-blue-300 transition-all duration-200 hover:scale-105",onClick:()=>H(!0),title:"آلة حاسبة",children:t.jsx(sa,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"حاسبة"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 hover:border-green-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(O){w({title:"الخطة الحالية لا تسمح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية."});return}rs(!0)},title:"بيانات المبيعات",children:t.jsx(aa,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"مبيعات"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsxs(S,{variant:"ghost",size:"sm",className:`h-5 w-5 p-0 rounded border transition-all duration-200 hover:scale-105 ${K||Z?"bg-purple-100 text-purple-600 border-purple-300":"bg-purple-50 text-purple-600 hover:bg-purple-100 border-purple-200 hover:border-purple-300"}`,onClick:()=>is(!0),title:"اختيار التاريخ",children:[t.jsx(Bt,{className:"h-2.5 w-2.5"}),(K||Z)&&t.jsx("div",{className:"absolute -top-0.5 -right-0.5 h-1 w-1 bg-purple-500 rounded-full"})]}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"تاريخ"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"relative h-5 w-5 p-0 rounded bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 hover:border-orange-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(O){w({title:"الخطة الحالية لا تسمح",description:"إدارة الديون غير متاحة في خطة زيرو. قم بالترقية."});return}Me(!0)},title:"إدارة الديون",children:t.jsxs("div",{className:"relative inline-flex items-center justify-center h-full w-full",children:[t.jsx(Us,{className:"h-2.5 w-2.5"}),ut>0&&t.jsx("div",{className:"absolute -top-1 -right-1 z-10 min-w-[12px] h-[12px] px-[2px] bg-red-600 text-white rounded-full text-[8px] leading-[12px] flex items-center justify-center pointer-events-none ring-1 ring-white",children:ut})]})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"ديون"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 hover:border-amber-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(O){w({title:"الخطة الحالية لا تسمح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية."});return}rt(!0)},title:"الصيانة",children:t.jsx(zs,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"صيانه"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-violet-50 text-violet-600 hover:bg-violet-100 border border-violet-200 hover:border-violet-300 transition-all duration-200 hover:scale-105",onClick:()=>{y("/user/dashboard",{state:{openCashierShiftModal:!0}})},title:"يومية المكنة",children:t.jsx(fa,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"المكنة"})]}),t.jsxs("div",{className:"hidden sm:flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border border-indigo-200 hover:border-indigo-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(O){w({title:"الخطة الحالية لا تسمح",description:"الفيز الائتمانية غير متاحة في خطة زيرو. قم بالترقية."});return}nt(!0)},title:"الفيز الائتمانية",children:t.jsx(Ot,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"فيز"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsxs(S,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 hover:border-red-300 transition-all duration-200 hover:scale-105 relative",onClick:()=>{ye(!0)},title:"تصفير المعاملات الأخيرة",children:[t.jsx(_t,{className:"h-2.5 w-2.5"}),bs>0&&t.jsx("div",{className:"absolute -top-0.5 -right-0.5 h-1 w-1 bg-red-500 rounded-full"})]}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"تصفير"})]}),(Q||K||Z)&&t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(S,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-red-50 text-red-500 hover:bg-red-100 border border-red-200 hover:border-red-300 transition-all duration-200 hover:scale-105",onClick:()=>{oe(""),ve(""),M("")},title:"مسح",children:t.jsx("span",{className:"text-[10px] font-bold",children:"×"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"مسح"})]})]})]})]}),t.jsx(Hs,{className:"px-3 pb-3",children:t.jsxs(Na,{value:$,onValueChange:Le,className:"w-full",children:[t.jsxs(Qt,{className:"hidden sm:grid w-full grid-cols-4 h-10 text-sm bg-gradient-to-r from-gray-50 via-blue-50/30 to-purple-50/30 border border-gray-200/60 rounded-md p-1 shadow-sm relative overflow-hidden",children:[t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-500/5 via-purple-500/5 to-pink-500/5 opacity-0 hover:opacity-100 transition-all duration-200"}),t.jsxs(fe,{value:"all",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-blue-500 data-[state=active]:to-blue-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-blue-200/50 hover:bg-blue-50/80 hover:text-blue-700 group",children:[t.jsx("span",{className:"relative z-10",children:"الكل"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-500/10 to-purple-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]}),t.jsxs(fe,{value:"send",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-green-500 data-[state=active]:to-emerald-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-green-200/50 hover:bg-green-50/80 hover:text-green-700 group",children:[t.jsx("span",{className:"relative z-10",children:"مرسل"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-green-500/10 to-emerald-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]}),t.jsxs(fe,{value:"withdraw",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-orange-500 data-[state=active]:to-amber-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-orange-200/50 hover:bg-orange-50/80 hover:text-orange-700 group",children:[t.jsx("span",{className:"relative z-10",children:"سحب"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-orange-500/10 to-amber-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]}),t.jsxs(fe,{value:"deleted",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-red-500 data-[state=active]:to-rose-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-red-200/50 hover:bg-red-50/80 hover:text-red-700 group",children:[t.jsx("span",{className:"relative z-10",children:"محذوف"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-red-500/10 to-rose-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]})]}),t.jsx(ge,{value:"all",className:"mt-2 receipts-list",children:pt.length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات محفوظة بعد"}):t.jsx("div",{className:"space-y-1 fade-in-up tab-content-smooth max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:pt.map((e,i)=>t.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 bg-white rounded-lg border hover:shadow-md cursor-pointer transition-all duration-200",onClick:()=>Ue(e),children:[t.jsxs("div",{className:"flex items-center gap-1",children:[ht(e.status,e.type),t.jsxs("div",{children:[t.jsx("p",{className:`font-medium text-sm ${e.type==="withdraw"?"text-red-700":"text-green-700"}`,children:e.type==="withdraw"?e.receiverPhone:`${e.senderPhone} → ${e.receiverPhone}`}),e.type==="withdraw"&&t.jsxs(t.Fragment,{children:[t.jsxs("p",{className:"text-sm font-semibold text-red-600",children:[q(e.amount)," جنيه"]}),t.jsxs("p",{className:"text-xs text-red-600",children:["عمولة: ",q(e.commission||0)," جنيه"]})]}),t.jsxs("p",{className:`text-[10px] ${e.type==="withdraw"?"text-red-700":"text-green-700"}`,children:["تمت بواسطة: ",e.cashierName??"الحساب الرئيسي"]}),t.jsx("p",{className:`text-sm ${e.type==="withdraw"?"text-red-500":"text-green-600"}`,children:e.createdAt.toLocaleString("en-GB")})]})]}),t.jsxs("div",{className:"text-right",children:[e.type!=="withdraw"&&t.jsxs("p",{className:"font-bold text-sm text-green-700",children:[q(e.amount)," جنيه"]}),e.withdrawnAmount&&t.jsxs("p",{className:"text-sm text-red-600",children:["مسحوب: ",q(e.withdrawnAmount)," جنيه"]}),e.sentAmount&&t.jsxs("p",{className:"text-sm text-green-600",children:["مرسل: ",q(e.sentAmount)," جنيه"]}),t.jsx(Qs,{variant:e.status==="completed"?"default":"secondary",className:`text-sm ${e.status==="completed"?e.type==="withdraw"?"bg-red-100 text-red-800 border-red-300":e.type==="send"?"bg-green-100 text-green-800 border-green-300":"":e.type==="withdraw"?"bg-red-100 text-red-800":""}`,children:e.type==="withdraw"?"سحب":Be(e.status)})]})]},e.id))})}),t.jsx(ge,{value:"send",className:"mt-2 receipts-list",children:me.filter(e=>e.type==="send").length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات إرسال محفوظة بعد"}):t.jsx("div",{className:"space-y-1 fade-in-up tab-content-smooth max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:me.filter(e=>e.type==="send").map((e,i)=>t.jsxs("div",{className:"relative flex items-center gap-4 p-4 rounded-xl bg-card border border-gray-100 shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer",onClick:()=>Ue(e),children:[t.jsx("div",{className:"h-12 w-12 rounded-full flex items-center justify-center shrink-0 bg-green-50",children:t.jsx(na,{className:"h-6 w-6 text-green-600"})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsx("h4",{className:"text-base font-bold text-foreground truncate",children:e.receiverPhone}),t.jsxs("span",{className:"text-base font-bold text-green-600 whitespace-nowrap",children:["- ",q(e.amount)," ج.م"]})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex flex-col gap-0.5",children:[t.jsxs("p",{className:"text-sm text-muted-foreground truncate",children:["إلى: ",e.receiverPhone]}),t.jsx("p",{className:"text-sm font-medium text-gray-500 mt-0.5",children:e.createdAt.toLocaleString("ar-EG",{day:"numeric",month:"short",hour:"numeric",minute:"numeric",hour12:!0})})]}),t.jsxs("div",{className:`px-2.5 py-1 rounded-full text-xs font-medium flex items-center gap-1 ${e.status==="completed"?"bg-green-50 text-green-700":e.status==="pending"?"bg-yellow-50 text-yellow-700":"bg-red-50 text-red-700"}`,children:[e.status==="completed"&&t.jsx(kt,{className:"h-3 w-3"}),e.status==="pending"&&t.jsx(xe,{className:"h-3 w-3"}),e.status==="failed"&&t.jsx(Et,{className:"h-3 w-3"}),t.jsx("span",{children:Be(e.status)})]})]})]})]},e.id))})}),t.jsx(ge,{value:"withdraw",className:"mt-2 receipts-list",children:me.filter(e=>e.type==="withdraw").length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات سحب محفوظة بعد"}):t.jsx("div",{className:"space-y-1 max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:me.filter(e=>e.type==="withdraw").map((e,i)=>t.jsxs("div",{className:"relative flex items-center gap-4 p-4 rounded-xl bg-card border border-gray-100 shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer",onClick:()=>Ue(e),children:[t.jsx("div",{className:"h-12 w-12 rounded-full flex items-center justify-center shrink-0 bg-red-50",children:t.jsx(Ye,{className:"h-6 w-6 text-red-600"})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsx("h4",{className:"text-base font-bold text-foreground truncate",children:e.receiverPhone}),t.jsxs("span",{className:"text-base font-bold text-red-600 whitespace-nowrap",children:["+ ",q(e.amount)," ج.م"]})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex flex-col gap-0.5",children:[t.jsxs("p",{className:"text-sm text-muted-foreground truncate",children:["من: ",e.senderPhone]}),t.jsx("p",{className:"text-sm font-medium text-gray-500 mt-0.5",children:e.createdAt.toLocaleString("ar-EG",{day:"numeric",month:"short",hour:"numeric",minute:"numeric",hour12:!0})})]}),t.jsxs("div",{className:`px-2.5 py-1 rounded-full text-xs font-medium flex items-center gap-1 ${e.status==="completed"?"bg-red-50 text-red-700":e.status==="pending"?"bg-yellow-50 text-yellow-700":"bg-red-50 text-red-700"}`,children:[e.status==="completed"&&t.jsx(kt,{className:"h-3 w-3"}),e.status==="pending"&&t.jsx(xe,{className:"h-3 w-3"}),e.status==="failed"&&t.jsx(Et,{className:"h-3 w-3"}),t.jsx("span",{children:Be(e.status)})]})]})]})]},e.id))})}),t.jsx(ge,{value:"deleted",className:"mt-2",children:D.length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات محذوفة"}):t.jsx("div",{className:"space-y-1 max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:D.map((e,i)=>t.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[ht(e.status,e.type),t.jsxs("div",{children:[t.jsx("p",{className:"font-medium text-sm text-red-700",children:e.type==="withdraw"?e.receiverPhone:`${e.senderPhone} → ${e.receiverPhone}`}),e.type==="withdraw"&&t.jsxs(t.Fragment,{children:[t.jsxs("p",{className:"text-sm font-semibold text-red-600",children:[q(e.amount)," جنيه"]}),t.jsxs("p",{className:"text-xs text-orange-500",children:["عمولة: ",q(e.commission||0)," جنيه"]})]}),t.jsxs("p",{className:"text-[10px] text-red-700",children:["تمت بواسطة: ",e.cashierName??"الحساب الرئيسي"]}),t.jsx("p",{className:"text-sm text-red-500",children:e.createdAt.toLocaleString("ar-EG")})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("div",{className:"text-right mr-2",children:[e.type!=="withdraw"&&t.jsxs("p",{className:"font-bold text-sm text-red-700",children:[q(e.amount)," جنيه"]}),t.jsx(StatusChip,{variant:"error",text:"محذوف"})]}),t.jsx(S,{variant:"ghost",size:"sm",className:"text-green-600 hover:bg-green-100 h-10 sm:h-12 px-4 sm:px-5 min-w-[44px] touch-manipulation",onClick:()=>js(e),children:t.jsx("span",{className:"text-xs sm:text-sm",children:"استرجاع"})}),t.jsx(S,{variant:"ghost",size:"sm",className:"text-red-600 hover:bg-red-100 h-10 sm:h-12 px-3 sm:px-4 min-w-[44px] touch-manipulation",onClick:()=>Ts(e.id),children:t.jsx(_t,{className:"h-4 w-4 sm:h-5 sm:w-5"})})]})]},e.id))})})]})})]}),t.jsx(Re,{open:ts,onOpenChange:Qe,children:t.jsxs(Pe,{className:"dialog-modern max-w-3xl w-full p-0 overflow-hidden border-0 shadow-2xl",children:[t.jsx(Oe,{className:"px-4 pt-4",children:t.jsx(ke,{className:"text-lg font-bold",children:ss||"شرح التطبيق"})}),t.jsx("div",{className:"aspect-video w-full bg-black",children:et?t.jsx("iframe",{src:hs(et),title:"Application Guide",className:"w-full h-full",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",allowFullScreen:!0}):t.jsx("div",{className:"flex items-center justify-center h-full text-white/80",children:"لا يوجد فيديو متاح حالياً"})})]})}),t.jsx(ra,{open:cs,onOpenChange:rt})]}),t.jsx(ia,{isOpen:ls,onClose:()=>nt(!1)}),t.jsx(Xe,{open:os,onOpenChange:Me,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{Me(!1),y("/user",{state:{openDebtDialog:!0}})}}),t.jsx(ca,{open:ps,onOpenChange:ye,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"سيتم حذف كل المعاملات السابقة نهائيًا من حسابك وFirebase.",onSuccess:async()=>{try{if(!(a!=null&&a.uid)){ye(!1);return}const e=new Date,i=o=>o instanceof Date?o:typeof(o==null?void 0:o.toDate)=="function"?o.toDate():new Date(String(o));await U.updateUserData(a.uid,{recentReset:{keepLastCount:it.keepLastCount??30,intervalDays:it.intervalDays??7,lastResetAt:e}}),je(o=>({...o,lastResetAt:e})),w({title:"تم إخفاء المعاملات السابقة",description:"تم إخفاء كل الإيصالات الأقدم من وقت التصفير من العرض بدون التأثير على التقارير اليومية/الشهرية أو الحدود."})}catch(e){console.error("فشل تنفيذ التصفير النهائي:",e),w({title:"فشل التصفير",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}finally{ye(!1)}}}),t.jsx(Re,{open:fs,onOpenChange:e=>{var i,o;if(e){const n="alkaptin678678@gmail.com",s=(o=(i=He.currentUser)==null?void 0:i.email)==null?void 0:o.toLowerCase();if(!s||s!==n){w({title:"قيد الإنشاء",description:"هذه الميزة قيد الإنشاء حالياً."});return}Ne(!0)}else Ne(!1)},children:t.jsxs(Pe,{dir:"rtl",className:"sm:max-w-md",children:[t.jsx(Oe,{children:t.jsx(ke,{children:"شحن رصيد الموبايل"})}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-right mb-1",children:"رقم الموبايل"}),t.jsx(qe,{value:we,onChange:e=>ot(e.target.value),placeholder:"01XXXXXXXXX",dir:"ltr"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-right mb-1",children:"الشركة"}),t.jsxs(Ys,{value:de,onValueChange:lt,children:[t.jsx(Ks,{className:"w-full",children:t.jsx(Zs,{placeholder:"اختر الشركة"})}),t.jsxs(Js,{children:[t.jsx(Se,{value:"vodafone_eg",children:"فودافون"}),t.jsx(Se,{value:"orange_eg",children:"أورنج"}),t.jsx(Se,{value:"etisalat_eg",children:"اتصالات"}),t.jsx(Se,{value:"we_eg",children:"WE"})]})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-right mb-1",children:"المبلغ بالجنيه"}),t.jsx(qe,{type:"number",min:1,value:Te,onChange:e=>ct(e.target.value?Number(e.target.value):""),placeholder:"50"})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 pt-2",children:[t.jsx(S,{variant:"outline",onClick:()=>Ne(!1),children:"إلغاء"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(S,{variant:"secondary",onClick:()=>y("/topup"),children:"صفحة الشحن الكاملة"}),t.jsx(S,{onClick:Cs,disabled:dt||!we||!de||!Te,children:dt?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})]})]})}),t.jsx(Re,{open:_e,onOpenChange:T,children:t.jsxs(Pe,{className:"sm:max-w-[460px]",children:[t.jsxs(Oe,{children:[t.jsx(ke,{children:"تأكيد استرجاع الإيصال"}),t.jsx($s,{children:"سيتم إعادة الإيصال إلى قائمة المعاملات الحالية."})]}),p&&t.jsxs("div",{className:"mt-2 space-y-2 text-sm",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"المبلغ"}),t.jsxs("span",{className:"font-bold",children:[p.amount," جنيه"]})]}),p.type==="withdraw"?t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"العميل"}),t.jsx("span",{className:"font-medium",children:p.receiverPhone})]}):t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"من → إلى"}),t.jsxs("span",{className:"font-medium",children:[p.senderPhone," → ",p.receiverPhone]})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"الكاشير"}),t.jsx("span",{className:"font-medium",children:p.cashierName??"الحساب الرئيسي"})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"التاريخ"}),t.jsx("span",{className:"font-medium",children:p.createdAt.toLocaleString("ar-EG")})]})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 pt-3",children:[t.jsx(S,{variant:"outline",onClick:()=>{T(!1),A(null)},children:"إلغاء"}),t.jsx(S,{onClick:Ns,children:"تأكيد الاسترجاع"})]})]})}),t.jsx(oa,{isOpen:ds,onClose:()=>We(!1),transaction:ms,onPrint:()=>window.print(),onDelete:ft,onComplete:xt}),t.jsx(Xe,{open:ee,onOpenChange:I,mode:"verify",title:"فتح إدارة التقسيط",description:"أدخل الرقم السري الرئيسي للوصول إلى إدارة التقسيط",onSuccess:()=>{I(!1),Je(!0)}}),t.jsx(la,{open:es,onOpenChange:Je})]})};export{Xa as default};
//# sourceMappingURL=TransactionsPage-C6VBiazI.js.map
