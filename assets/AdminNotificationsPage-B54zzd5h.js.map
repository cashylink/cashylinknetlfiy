{"version":3,"file":"AdminNotificationsPage-B54zzd5h.js","sources":["../../src/pages/AdminNotificationsPage.tsx"],"sourcesContent":["import React, { useState } from 'react';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Textarea } from '@/components/ui/textarea';\r\nimport { db, auth, functions } from '@/firebase';\r\nimport { collection, addDoc, serverTimestamp } from 'firebase/firestore';\r\nimport { httpsCallable } from 'firebase/functions';\r\nimport { useToast } from '@/hooks/use-toast';\r\nimport { Link as LinkIcon, Bell } from 'lucide-react';\r\n\r\nconst AdminNotificationsPage: React.FC = () => {\r\n  const { toast } = useToast();\r\n  const [title, setTitle] = useState('');\r\n  const [body, setBody] = useState('');\r\n  const [link, setLink] = useState('');\r\n  const [loading, setLoading] = useState(false);\r\n  const [userId, setUserId] = useState('');\r\n\r\n  const handleSend = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!title.trim() || !body.trim()) {\r\n      toast({ title: 'خطأ', description: 'العنوان والنص مطلوبان', variant: 'destructive' });\r\n      return;\r\n    }\r\n    try {\r\n      setLoading(true);\r\n      const payload = { title: title.trim(), body: body.trim(), link: link.trim() || '' };\r\n\r\n      if (userId.trim()) {\r\n        const fn = httpsCallable(functions, 'sendFcmToUser');\r\n        const data: Record<string, string> = {};\r\n        if (payload.link) data.link = payload.link;\r\n        const res: any = await fn({ userId: userId.trim(), title: payload.title, body: payload.body, data });\r\n        const ok = !!(res?.data?.ok);\r\n        toast({ title: ok ? 'تم الإرسال' : 'تحذير', description: ok ? `أُرسل إلى المستخدم ${userId}` : 'لا توجد أجهزة مسجلة لهذا المستخدم', variant: ok ? undefined : 'destructive' });\r\n      } else {\r\n        await addDoc(collection(db, 'broadcasts'), {\r\n          title: payload.title,\r\n          message: payload.body,\r\n          linkUrl: payload.link || undefined,\r\n          audienceKey: 'global',\r\n          active: true,\r\n          createdAt: serverTimestamp()\r\n        });\r\n        toast({ title: 'تم الإرسال', description: 'تم إنشاء بث عام وسيتم إرسال الإشعار' });\r\n      }\r\n      setTitle('');\r\n      setBody('');\r\n      setLink('');\r\n      setUserId('');\r\n    } catch (err: any) {\r\n      toast({ title: 'فشل الإرسال', description: String(err?.message || err), variant: 'destructive' });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleSendTestToMe = async () => {\r\n    try {\r\n      const uid = auth.currentUser?.uid || '';\r\n      if (!uid) {\r\n        toast({ title: 'غير مسجل', description: 'سجّل الدخول كأدمن لإرسال اختبار', variant: 'destructive' });\r\n        return;\r\n      }\r\n      setLoading(true);\r\n      const fn = httpsCallable(functions, 'sendFcmToUser');\r\n      const res: any = await fn({ userId: uid, title: 'إشعار اختبار', body: 'تم إرسال إشعار تجريبي بنجاح', data: { type: 'test' } });\r\n      const ok = !!(res?.data?.ok);\r\n      toast({ title: ok ? 'تم إرسال الاختبار' : 'فشل الاختبار', description: ok ? 'تفقد هاتفك الآن' : 'تحقق من حفظ توكن الجهاز', variant: ok ? undefined : 'destructive' });\r\n    } catch (err: any) {\r\n      toast({ title: 'فشل الاختبار', description: String(err?.message || err), variant: 'destructive' });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"min-h-screen p-4\">\r\n      <Card className=\"max-w-xl mx-auto\">\r\n        <CardHeader>\r\n          <CardTitle className=\"flex items-center gap-2 text-base\">\r\n            <Bell className=\"h-4 w-4\" />\r\n            إرسال إشعار خارجي\r\n          </CardTitle>\r\n        </CardHeader>\r\n        <CardContent className=\"space-y-4\">\r\n          <form onSubmit={handleSend} className=\"space-y-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"userId\">إرسال لمستخدم محدد (اختياري)</Label>\r\n              <Input id=\"userId\" value={userId} onChange={(e) => setUserId(e.target.value)} placeholder=\"أدخل معرف المستخدم (UID)\" />\r\n              <p className=\"text-xs text-gray-500\">إذا تركته فارغاً سيتم إرسال إشعار عام للجميع.</p>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"title\">العنوان</Label>\r\n              <Input id=\"title\" value={title} onChange={(e) => setTitle(e.target.value)} placeholder=\"عنوان الإشعار\" />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"body\">النص</Label>\r\n              <Textarea id=\"body\" value={body} onChange={(e) => setBody(e.target.value)} placeholder=\"نص الإشعار\" className=\"min-h-[120px]\" />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"link\" className=\"flex items-center gap-1\"><LinkIcon className=\"h-3 w-3\" /> رابط اختياري</Label>\r\n              <Input id=\"link\" value={link} onChange={(e) => setLink(e.target.value)} placeholder=\"https://example.com أو cashy://...\" />\r\n            </div>\r\n            <div className=\"flex justify-between\">\r\n              <Button type=\"button\" onClick={handleSendTestToMe} disabled={loading} variant=\"outline\">{loading ? '...' : 'إرسال اختبار لنفسي'}</Button>\r\n              <Button type=\"submit\" disabled={loading} className=\"px-6\">{loading ? 'جاري الإرسال...' : 'إرسال'}</Button>\r\n            </div>\r\n          </form>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default AdminNotificationsPage;\r\n"],"names":["AdminNotificationsPage","toast","useToast","title","setTitle","useState","body","setBody","link","setLink","loading","setLoading","userId","setUserId","handleSend","e","payload","fn","httpsCallable","functions","data","res","ok","_a","addDoc","collection","db","serverTimestamp","err","handleSendTestToMe","uid","auth","_b","jsxs","Card","jsx","CardHeader","CardTitle","Bell","CardContent","Label","Input","Textarea","LinkIcon","Button"],"mappings":"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"}