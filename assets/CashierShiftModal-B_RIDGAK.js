import{aK as Rs,u as Ps,l as Ms,r as l,a4 as H,j as e,af as p,ag as f,ah as g,ai as y,B as c,aP as N,x as h,I as u,T as cs,s as ke,$ as Us,Z as Ls,ad as Te,A as Hs,p as $s,D as qs}from"./index-CzMrJEuC.js";import{S as Vs,a as zs,b as Ys,c as Gs,d as ie}from"./select-DHMtOuee.js";import{getLastTransactions as _s}from"./functions-B25VVZyV.js";const na=({open:R,onOpenChange:$})=>{var ls,rs,ns;const{shiftUser:i,isShiftActive:q,shiftStartAt:P,setShiftUser:M,startShift:Ae,endShift:Oe}=Rs(),{userSubscription:D,user:t,signIn:Fe,profile:Js,checkSubscriptionStatus:ce}=Ps(),{toast:S}=Ms(),[V,We]=l.useState((i==null?void 0:i.name)||""),[z,Ie]=l.useState((i==null?void 0:i.username)||""),[Y,Be]=l.useState(""),[de,G]=l.useState(!1),[k,_]=l.useState(null),[Ee,Re]=l.useState(""),[Pe,oe]=l.useState(""),[Ks,Qs]=l.useState(!1),[C,me]=l.useState(null),[Me,xe]=l.useState(""),[Ue,U]=l.useState(""),[ds,F]=l.useState(!1),[J,K]=l.useState(!1),[Le,Q]=l.useState({totalTransfers:0,totalWithdrawals:0}),[Z,X]=l.useState(null),[He,he]=l.useState(""),[W,$e]=l.useState(""),[I,qe]=l.useState(0),[os,Zs]=l.useState({}),[B,ms]=l.useState(0),[L,xs]=l.useState(0),[hs,Xs]=l.useState({}),[ue,Ve]=l.useState(""),[us,ve]=l.useState(!1);l.useEffect(()=>{R&&ce&&ce(!0)},[R,ce]);const ee=s=>{const a={"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9","۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9","٫":".","،":".","٬":"."," ":""};return s.split("").map(n=>a[n]??n).join("")},je=()=>`cashierUsers_${(t==null?void 0:t.uid)||"default"}`,[b,E]=l.useState(()=>{try{let s=localStorage.getItem(je());if(!s){const a=localStorage.getItem("cashierUsers");a&&(s=a)}return s?JSON.parse(s):[]}catch{return[]}}),[ze,vs]=l.useState(!1);l.useEffect(()=>{if(!(t!=null&&t.uid))return;(async()=>{let a=!1;try{const n=cs(ke,"profiles",t.uid,"cashierUsers","list"),d=await Us(n);if(d.exists()){const v=d.data(),w=Array.isArray(v==null?void 0:v.users)?v.users:[];w.length>0&&(E(w),a=!0)}}catch(n){console.warn("Failed to fetch cashierUsers from Firestore:",n)}if(!a)try{const n=localStorage.getItem(je()),d=n?JSON.parse(n):[];d.length>0?E(d):b.length>0&&E([])}catch{}vs(!0)})()},[t==null?void 0:t.uid]);const pe=(ls=D==null?void 0:D.subscription)==null?void 0:ls.planType,Ye=((rs=D==null?void 0:D.subscription)==null?void 0:rs.extraCashiers)||0,se=(ns=D==null?void 0:D.subscription)==null?void 0:ns.extraCashiersEndsAt;let Ge=!1;Ye>0&&se&&(se.seconds?new Date(se.seconds*1e3):new Date(se))>new Date&&(Ge=!0);const A=(pe==="quarterly"||pe==="yearly"||pe==="lifetime"?2:1)+(Ge?Ye:0);l.useEffect(()=>{try{localStorage.setItem(je(),JSON.stringify(b));try{localStorage.removeItem("cashierUsers")}catch{}}catch{}(async()=>{try{if(!(t!=null&&t.uid)||b.length===0&&!ze)return;const a=cs(ke,"profiles",t.uid,"cashierUsers","list");await Ls(a,{users:b},{merge:!0})}catch(a){console.warn("Failed to save cashierUsers to Cloud:",a)}})()},[b,ze,t==null?void 0:t.uid]);const[js,ae]=l.useState(!1),[_e,fe]=l.useState(""),[T,Je]=l.useState(null),[Ke,ge]=l.useState([]),[ye,Ne]=l.useState(!1),[m,ps]=l.useState(null),[fs,be]=l.useState(!1),[gs,te]=l.useState(!1),[ys,le]=l.useState(!1),[Ns,re]=l.useState(!1),[Qe,bs]=l.useState("1"),[Ze,ws]=l.useState(H.MONTHLY),Ss=async()=>{if(t!=null&&t.uid)try{await Hs($s(ke,"cashierRequests"),{userId:t.uid,userName:t.displayName||t.email,userEmail:t.email,requestedCount:parseInt(Qe),planType:Ze,status:"pending",createdAt:qs()}),S({title:"تم إرسال الطلب بنجاح",description:"سيتم مراجعة طلبك من قبل الإدارة"}),re(!1)}catch(s){console.error(s),S({title:"خطأ",description:"حدث خطأ أثناء إرسال الطلب",variant:"destructive"})}},[Cs,we]=l.useState(!1),[x,Se]=l.useState(null),[Ds,ne]=l.useState(!1),[Xe,es]=l.useState(""),[ss,Ce]=l.useState(""),ks=s=>{Se(s),ne(!0),es(""),Ce("")},Ts=async()=>{if(!(t!=null&&t.email)){Ce("لا يوجد بريد إلكتروني مسجل");return}const{error:s}=await Fe(t.email,Xe);if(s){Ce("كلمة المرور غير صحيحة");return}ne(!1),we(!0)},As=s=>{x&&(E(a=>a.map(n=>n.username===x.username?{...n,permissions:s}:n)),(i==null?void 0:i.username)===x.username&&M({...i,permissions:s}),we(!1),Se(null),S({title:"تم تحديث الصلاحيات بنجاح"}))},Os=()=>{b.length>=A?le(!0):te(!0)},Fs=s=>{const a=(i==null?void 0:i.username)===s;let n=!1;try{n=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(a&&!(a&&!q&&(ue==="الأدمن الرئيسي"||n))){S({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const w=`هل أنت متأكد من حذف المستخدم ${s}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(w)&&(E(j=>j.filter(De=>De.username!==s)),a&&M(null),S({title:"تم حذف المستخدم",description:s}))},Ws=()=>{if(!V.trim()||!z.trim()||!Y.trim())return;if(b.length>=A){S({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(A)?A:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const s={name:V.trim(),username:z.trim(),password:Y.trim()};E(a=>[s,...a]),We(""),Ie(""),Be("")},Is=()=>{G(!0),_(null),me(null),xe(""),U("")},as=async()=>{try{let s=[];try{t!=null&&t.uid&&(s=await Te.getUserTransactions(t.uid))}catch{}if(!s||s.length===0)try{const r=await _s({merchantUserId:t==null?void 0:t.uid,limit:200});s=(r==null?void 0:r.transactions)||[]}catch{}const a=P?new Date(P):null,n=new Date,d=r=>{const o=r.type,O=r.txnType;return o==="withdraw"||o==="withdrawal"||o==="receive"||O==="receive"},v=r=>{const o=r.type,O=r.txnType;return o==="send"||o==="transfer"||O==="send"},w=r=>{if(!r)return null;if(r instanceof Date)return r;try{const o=new Date(r);return Number.isNaN(o.getTime())?null:o}catch{return null}},j=r=>{const o=w(r.createdAt||r.created_at||r.timestamp);return!o||a&&o<a?!1:o<=n},De=r=>r==="completed"||r==="confirmed",is=s.filter(r=>De(r.status)&&j(r)),Es=is.filter(r=>d(r)).reduce((r,o)=>{const O=o.withdrawnAmount??o.receivedAmount??o.amount??0;return r+(Number(O)||0)},0);return{totalTransfers:is.filter(r=>v(r)).reduce((r,o)=>{const O=o.sentAmount??o.transferredAmount??o.amount??0;return r+(Number(O)||0)},0),totalWithdrawals:Es}}catch{return{totalTransfers:0,totalWithdrawals:0}}};l.useEffect(()=>{if(J){try{const s=localStorage.getItem("shiftInitialReceivedDrawerFunds");s!==null&&$e(s)}catch{}try{const s=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(s!==null){const a=parseFloat(s);qe(Number.isFinite(a)?a:0)}}catch{}}},[J]),l.useEffect(()=>{de&&(async()=>{try{const s=await as();Q(s)}catch{}})()},[de]),l.useEffect(()=>{if(!R&&!ye)return;(async()=>{try{const n=((t!=null&&t.uid?await Te.getUserTransactions(t.uid):[])||[]).filter(d=>(d==null?void 0:d.type)==="report"||((d==null?void 0:d.title)||"").includes("إيصال تسليم وردية"));n.sort((d,v)=>{const w=new Date(d.createdAt||0).getTime();return new Date(v.createdAt||0).getTime()-w}),ge(n)}catch{ge([])}})()},[R,J,ye,t==null?void 0:t.uid]);const Bs=async(s,a,n)=>{try{let d=0,v=0;try{const j=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");d=Number.isFinite(j)?j:0}catch{}try{const j=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");v=Number.isFinite(j)?j:0}catch{}const w={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(i==null?void 0:i.username)||"cashier",receiverPhone:ue||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(i==null?void 0:i.name)||(i==null?void 0:i.username)||null,deficit:a,deficitAmount:a?n:0,shiftStartAt:P,receivedDrawerFunds:d,receivedWalletBalancesTotal:v,receivedWalletBalances:os,deliveredDrawerFunds:B||0,deliveredWalletBalancesTotal:L||0,deliveredWalletBalances:hs,shiftProfit:Math.round(((B||0)+(L||0)-(d+v))*100)/100};t!=null&&t.uid&&await Te.saveUserTransaction(t.uid,w),ge(j=>[w,...j||[]])}catch{}},ts=b.slice(Math.max(0,b.length-A));return e.jsxs(e.Fragment,{children:[e.jsx(p,{open:R,onOpenChange:$,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:q?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),q?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[i==null?void 0:i.name," (",i==null?void 0:i.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),b.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:ts.map((s,a)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:s.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(c,{size:"sm",className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>{Je(s),ae(!0)},children:"دخول"}),e.jsx(c,{size:"sm",className:"w-full sm:w-auto",variant:"outline",onClick:()=>ks(s),children:"الصلاحيات"}),e.jsx(c,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>Fs(s.username),children:"حذف"})]})]},a))})]})]}),e.jsx(N,{className:"flex flex-wrap gap-2 justify-between",children:q?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(c,{className:"w-full sm:w-auto",variant:"destructive",onClick:Is,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(c,{className:"w-full sm:w-auto bg-emerald-600 hover:bg-emerald-700 text-white",onClick:Os,children:"إضافة مستخدم جديد"}),e.jsx(c,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>Ne(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(p,{open:ys,onOpenChange:le,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsxs(y,{className:"text-red-600 flex items-center gap-2",children:[e.jsx("span",{className:"text-xl",children:"⚠️"})," تنبيه: الحد الأقصى للمستخدمين"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("p",{className:"text-sm text-gray-700 leading-relaxed",children:["عفواً، لا يمكنك إضافة المزيد من مستخدمي الوردية. ",e.jsx("br",{}),"الحد المسموح به لباقة اشتراكك هو ",e.jsx("strong",{children:A})," ",A===1?"مستخدم":"مستخدمين","."]}),e.jsx("p",{className:"text-sm text-gray-600",children:"لزيادة عدد المستخدمين، يرجى التواصل مع خدمة العملاء لترقية الباقة أو طلب زيادة العدد."})]}),e.jsxs(N,{className:"flex flex-col sm:flex-row gap-2 justify-end",children:[e.jsx(c,{className:"w-full sm:w-auto",onClick:()=>le(!1),variant:"secondary",children:"حسناً، فهمت"}),e.jsx(c,{className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>{le(!1),re(!0)},children:"طلب إضافة كاشير"})]})]})}),e.jsx(p,{open:Ns,onOpenChange:re,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:"طلب زيادة عدد الكاشير"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"يمكنك طلب زيادة عدد الكاشير المسموح به. سيتم مراجعة الطلب من قبل الإدارة."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"عدد الكاشير المطلوب إضافتهم"}),e.jsx(u,{type:"number",min:"1",max:"10",value:Qe,onChange:s=>bs(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"نظام الاشتراك للكاشير الإضافي"}),e.jsxs(Vs,{value:Ze,onValueChange:s=>ws(s),children:[e.jsx(zs,{children:e.jsx(Ys,{placeholder:"اختر الباقة"})}),e.jsxs(Gs,{children:[e.jsx(ie,{value:H.MONTHLY,children:"شهري"}),e.jsx(ie,{value:H.QUARTERLY,children:"ربع سنوي"}),e.jsx(ie,{value:H.YEARLY,children:"سنوي"}),e.jsx(ie,{value:H.LIFETIME,children:"مدى الحياة"})]})]})]})]}),e.jsxs(N,{children:[e.jsx(c,{variant:"secondary",onClick:()=>re(!1),children:"إلغاء"}),e.jsx(c,{className:"bg-blue-600 hover:bg-blue-700 text-white",onClick:Ss,children:"إرسال الطلب"})]})]})}),e.jsx(p,{open:gs,onOpenChange:te,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(h,{className:"mb-1 block",children:"الاسم"}),e.jsx(u,{value:V,onChange:s=>We(s.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(h,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(u,{value:z,onChange:s=>Ie(s.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(h,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(u,{type:"password",autoComplete:"new-password",value:Y,onChange:s=>Be(s.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(N,{className:"flex gap-2 justify-between",children:[e.jsx(c,{variant:"secondary",onClick:()=>{te(!1)},children:"إلغاء"}),e.jsx(c,{onClick:()=>{!V.trim()||!z.trim()||!Y.trim()||(Ws(),te(!1))},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"حفظ المستخدم"})]})]})}),e.jsx(p,{open:Ds,onOpenChange:ne,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:"تأكيد هوية المدير"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"يرجى إدخال الرقم السري الرئيسي (كلمة مرور حسابك) لفتح إعدادات الصلاحيات."}),e.jsxs("div",{children:[e.jsx(h,{className:"mb-1 block",children:"كلمة المرور"}),e.jsx(u,{type:"password",value:Xe,onChange:s=>es(s.target.value),placeholder:"أدخل كلمة المرور"}),ss&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:ss})]})]}),e.jsxs(N,{children:[e.jsx(c,{variant:"outline",onClick:()=>ne(!1),children:"إلغاء"}),e.jsx(c,{onClick:Ts,className:"bg-blue-600 hover:bg-blue-700 text-white",children:"تأكيد"})]})]})}),e.jsx(p,{open:Cs,onOpenChange:we,children:e.jsxs(f,{className:"sm:max-w-lg max-h-[90vh] overflow-y-auto",children:[e.jsx(g,{children:e.jsxs(y,{children:["صلاحيات المستخدم: ",x==null?void 0:x.name]})}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 py-4",children:[{key:"sales",label:"المبيعات"},{key:"debts",label:"الديون"},{key:"deficiencies",label:"النواقص"},{key:"cards",label:"البطاقات"},{key:"lines",label:"الخطوط"},{key:"myNumbers",label:"أرقامي"},{key:"installments",label:"تقسيط"},{key:"maintenance",label:"صيانة"},{key:"machines",label:"المكنة"},{key:"expenses",label:"المصروفات"},{key:"settings",label:"الإعدادات"},{key:"branches",label:"الفروع"},{key:"transfers",label:"التحويل"},{key:"withdrawals",label:"السحب"}].map(s=>{var n;const a=((n=x==null?void 0:x.permissions)==null?void 0:n[s.key])!==!1;return e.jsxs("div",{className:"flex items-center justify-between border p-3 rounded bg-gray-50 dark:bg-gray-800",children:[e.jsx(h,{htmlFor:`perm-${s.key}`,className:"cursor-pointer font-medium",children:s.label}),e.jsx(c,{id:`perm-${s.key}`,size:"sm",onClick:()=>{x&&Se({...x,permissions:{...x.permissions,[s.key]:!a}})},className:`w-24 font-bold text-white transition-colors ${a?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:a?"مفعل":"معطل"})]},s.key)})}),e.jsx(N,{children:e.jsx(c,{onClick:()=>As(x==null?void 0:x.permissions),className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",children:"حفظ الصلاحيات"})})]})}),e.jsx(p,{open:ye,onOpenChange:Ne,children:e.jsxs(f,{className:"sm:max-w-lg",children:[e.jsx(g,{children:e.jsx(y,{children:"إيصالات التسليم"})}),Ke.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:Ke.map(s=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{ps(s),be(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(s.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",s.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",s.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",s.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",s.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",s.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",s.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",s.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",s.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",s.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(s.shiftProfit??(s.deliveredDrawerFunds??0)+(s.deliveredWalletBalancesTotal??0)-(s.receivedDrawerFunds??0)-(s.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",s.shiftProfit??(s.deliveredDrawerFunds??0)+(s.deliveredWalletBalancesTotal??0)-(s.receivedDrawerFunds??0)-(s.receivedWalletBalancesTotal??0)]})]}),s.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",s.deficitAmount??0]})]},s.id))}),e.jsx(N,{className:"flex gap-2 justify-between",children:e.jsx(c,{variant:"secondary",onClick:()=>Ne(!1),children:"إغلاق"})})]})}),e.jsx(p,{open:fs,onOpenChange:be,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:"إيصال تسليم وردية"})}),m?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(m.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",m.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",m.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",m.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",m.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",m.deliveredWalletBalancesTotal??0]})]})]}),m.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",m.deficitAmount??0]})]}),m.receivedWalletBalances&&Object.keys(m.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(m.receivedWalletBalances).map(([s,a])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:s}),e.jsx("span",{className:"font-semibold",children:a})]},s))})]}),m.deliveredWalletBalances&&Object.keys(m.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(m.deliveredWalletBalances).map(([s,a])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:s}),e.jsx("span",{className:"font-semibold",children:a})]},s))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(N,{className:"flex gap-2 justify-between",children:e.jsx(c,{variant:"secondary",onClick:()=>be(!1),children:"إغلاق"})})]})}),e.jsx(p,{open:js,onOpenChange:ae,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:T?`${T.name} (${T.username})`:""}),e.jsx(u,{type:"password",autoComplete:"off",value:_e,onChange:s=>fe(s.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(N,{className:"flex gap-2 justify-between",children:[e.jsx(c,{variant:"secondary",onClick:()=>{fe(""),Je(null),ae(!1)},children:"إلغاء"}),e.jsx(c,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{if(T){if(_e.trim()!==T.password){S({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}M({name:T.name,username:T.username,permissions:T.permissions}),fe(""),ae(!1),$(!1),Ae(),ve(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(p,{open:us,onOpenChange:ve,children:e.jsxs(f,{className:"sm:max-w-md",children:[e.jsx(g,{children:e.jsx(y,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(h,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(u,{type:"text",inputMode:"decimal",value:W,onChange:s=>$e(ee(s.target.value)),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(h,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(u,{type:"text",inputMode:"decimal",value:Number.isFinite(I)?I:0,onChange:s=>{const a=parseFloat(ee(s.target.value));qe(Number.isFinite(a)?a:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(N,{className:"flex gap-2 justify-between",children:e.jsx(c,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>{const s=parseFloat(W),a=I,n=Number.isFinite(s)&&s>=0,d=Number.isFinite(a)&&a>=0;if(!n||!d){S({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(s)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(a))}catch{}S({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),ve(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(p,{open:de,onOpenChange:s=>{s&&G(!0)},children:e.jsxs(f,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(g,{children:e.jsx(y,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{variant:k==="toUser"?"default":"secondary",onClick:()=>_("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(c,{variant:k==="toAdmin"?"default":"secondary",onClick:()=>_("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),k==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[b.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:ts.map((s,a)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(C==null?void 0:C.username)===s.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>me(s),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:s.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},a))})]}),e.jsxs("div",{children:[e.jsx(h,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(u,{type:"password",autoComplete:"off",value:Me,onChange:s=>xe(s.target.value),placeholder:"أدخل كلمة السر"})]}),Ue&&e.jsx("div",{className:"text-xs text-red-600",children:Ue})]}),k==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(u,{type:"password",autoComplete:"off",value:Ee,onChange:s=>Re(s.target.value),placeholder:"كلمة المرور"}),Pe&&e.jsx("div",{className:"text-xs text-red-600",children:Pe})]})]}),e.jsx(N,{className:"flex gap-2 justify-between",children:e.jsx(c,{disabled:ds||!k,onClick:async()=>{if(k){F(!0);try{const s=Le;if(as().then(Q).catch(()=>{}),k==="toUser"){if(!C){U("يرجى اختيار المستخدم أولاً"),F(!1);return}if(Me.trim()!==C.password){U("كلمة السر غير صحيحة"),F(!1);return}Oe(),M({name:C.name,username:C.username,permissions:C.permissions}),Ae(),Ve(`${C.name} (${C.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}G(!1),_(null),me(null),xe(""),U(""),$(!1),Q(s),X(null),he(""),K(!0)}else if(k==="toAdmin"){oe("");const a=(t==null?void 0:t.email)||"";if(!a){oe("لا يوجد بريد للمستخدم الرئيسي للتحقق"),F(!1);return}const{error:n}=await Fe(a,Ee);if(n){oe("كلمة المرور غير صحيحة"),F(!1);return}Oe(),M(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}Re(""),G(!1),$(!1),Ve("الأدمن الرئيسي"),Q(s),X(null),he(""),K(!0)}}catch{U("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{F(!1)}}},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"تأكيد التسليم"})})]})}),e.jsx(p,{open:J,onOpenChange:K,children:e.jsxs(f,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(g,{children:e.jsx(y,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:ue})]}),P&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(P).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(h,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(u,{type:"number",value:W,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(h,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(u,{type:"number",value:I,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(h,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(u,{type:"text",inputMode:"decimal",value:B,onChange:s=>{const a=parseFloat(ee(s.target.value));ms(Number.isFinite(a)?a:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(h,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(u,{type:"text",inputMode:"decimal",value:L,onChange:s=>{const a=parseFloat(ee(s.target.value));xs(Number.isFinite(a)?a:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(B??0)+(L??0)-((parseFloat(W||"0")||0)+(I??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((B??0)+(L??0)-((parseFloat(W||"0")||0)+(I??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"}),e.jsx("div",{className:"mt-2 grid grid-cols-1 gap-2",children:e.jsxs("div",{className:"rounded border p-2 bg-gray-50",children:[e.jsx("div",{className:"text-xs text-gray-700",children:"مطلوب من الدرج (بدون أرباح)"}),e.jsx("div",{className:"text-sm font-semibold text-gray-900",children:Math.round(((B??0)-(parseFloat(W||"0")||0))*100)/100})]})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{variant:Z==="no"?"default":"secondary",onClick:()=>X("no"),children:"لا"}),e.jsx(c,{variant:Z==="yes"?"default":"secondary",onClick:()=>X("yes"),children:"نعم"})]}),Z==="yes"&&e.jsxs("div",{children:[e.jsx(h,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(u,{type:"number",value:He,onChange:s=>he(s.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(N,{className:"flex gap-2 justify-between",children:e.jsx(c,{onClick:()=>{const s=Z==="yes",a=parseFloat(He)||0;(async()=>await Bs(Le,s,a))(),S({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),K(!1)},className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:"تأكيد وحفظ الإيصال"})})]})})]})};export{na as default};
//# sourceMappingURL=CashierShiftModal-B_RIDGAK.js.map
